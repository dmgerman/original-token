multiline_comment|/*&n; *  History:&n; *  Started: Aug 9 by Lawrence Foard (entropy@world.std.com),&n; *           to allow user process control of SCSI devices.&n; *  Development Sponsored by Killy Corp. NY NY&n; *&n; * Original driver (sg.c):&n; *        Copyright (C) 1992 Lawrence Foard&n; * Version 2 and 3 extensions to driver:&n; *        Copyright (C) 1998 - 2000 Douglas Gilbert&n; *&n; *  Modified  19-JAN-1998  Richard Gooch &lt;rgooch@atnf.csiro.au&gt;  Devfs support&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|sg_version_str
r_static
r_char
op_star
id|sg_version_str
op_assign
l_string|&quot;Version: 3.1.17 (20001002)&quot;
suffix:semicolon
macro_line|#endif
DECL|variable|sg_version_num
r_static
r_int
id|sg_version_num
op_assign
l_int|30117
suffix:semicolon
multiline_comment|/* 2 digits for each component */
multiline_comment|/*&n; *  D. P. Gilbert (dgilbert@interlog.com, dougg@triode.net.au), notes:&n; *      - scsi logging is available via SCSI_LOG_TIMEOUT macros. First&n; *        the kernel/module needs to be built with CONFIG_SCSI_LOGGING&n; *        (otherwise the macros compile to empty statements).&n; *        Then before running the program to be debugged enter:&n; *          # echo &quot;scsi log timeout 7&quot; &gt; /proc/scsi/scsi&n; *        This will send copious output to the console and the log which&n; *        is usually /var/log/messages. To turn off debugging enter:&n; *          # echo &quot;scsi log timeout 0&quot; &gt; /proc/scsi/scsi&n; *        The &squot;timeout&squot; token was chosen because it is relatively unused.&n; *        The token &squot;hlcomplete&squot; should be used but that triggers too&n; *        much output from the sd device driver. To dump the current&n; *        state of the SCSI mid level data structures enter:&n; *          # echo &quot;scsi dump 1&quot; &gt; /proc/scsi/scsi&n; *        To dump the state of sg&squot;s data structures use:&n; *          # cat /proc/scsi/sg/debug&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mtio.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &lt;scsi/scsi_ioctl.h&gt;
macro_line|#include &lt;scsi/sg.h&gt;
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#include &lt;linux/proc_fs.h&gt;
r_static
r_int
id|sg_proc_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|sg_proc_cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef LINUX_VERSION_CODE
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif /* LINUX_VERSION_CODE */
multiline_comment|/* #define SG_ALLOW_DIO */
macro_line|#ifdef SG_ALLOW_DIO
macro_line|#include &lt;linux/iobuf.h&gt;
macro_line|#endif
DECL|variable|sg_big_buff
r_int
id|sg_big_buff
op_assign
id|SG_DEF_RESERVED_SIZE
suffix:semicolon
multiline_comment|/* N.B. This variable is readable and writeable via&n;   /proc/scsi/sg/def_reserved_size . Each time sg_open() is called a buffer&n;   of this size (or less if there is not enough memory) will be reserved&n;   for use by this file descriptor. [Deprecated usage: this variable is also&n;   readable via /proc/sys/kernel/sg-big-buff if the sg driver is built into&n;   the kernel (i.e. it is not a module).] */
DECL|variable|def_reserved_size
r_static
r_int
id|def_reserved_size
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* picks up init parameter */
DECL|macro|SG_SECTOR_SZ
mdefine_line|#define SG_SECTOR_SZ 512
DECL|macro|SG_SECTOR_MSK
mdefine_line|#define SG_SECTOR_MSK (SG_SECTOR_SZ - 1)
DECL|macro|SG_LOW_POOL_THRESHHOLD
mdefine_line|#define SG_LOW_POOL_THRESHHOLD 30
DECL|macro|SG_MAX_POOL_SECTORS
mdefine_line|#define SG_MAX_POOL_SECTORS 320  /* Max. number of pool sectors to take */
DECL|variable|sg_pool_secs_avail
r_static
r_int
id|sg_pool_secs_avail
op_assign
id|SG_MAX_POOL_SECTORS
suffix:semicolon
DECL|macro|SG_HEAP_PAGE
mdefine_line|#define SG_HEAP_PAGE 1  /* heap from kernel via get_free_pages() */
DECL|macro|SG_HEAP_KMAL
mdefine_line|#define SG_HEAP_KMAL 2  /* heap from kernel via kmalloc() */
DECL|macro|SG_HEAP_POOL
mdefine_line|#define SG_HEAP_POOL 3  /* heap from scsi dma pool (mid-level) */
DECL|macro|SG_USER_MEM
mdefine_line|#define SG_USER_MEM 4   /* memory belongs to user space */
DECL|macro|SG_DEV_ARR_LUMP
mdefine_line|#define SG_DEV_ARR_LUMP 6 /* amount to over allocate sg_dev_arr by */
r_static
r_int
id|sg_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sg_attach
c_func
(paren
id|Scsi_Device
op_star
)paren
suffix:semicolon
r_static
r_void
id|sg_finish
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sg_detect
c_func
(paren
id|Scsi_Device
op_star
)paren
suffix:semicolon
r_static
r_void
id|sg_detach
c_func
(paren
id|Scsi_Device
op_star
)paren
suffix:semicolon
DECL|variable|dummy_cmdp
r_static
id|Scsi_Request
op_star
id|dummy_cmdp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* only used for sizeof */
DECL|variable|sg_dev_arr_lock
r_static
id|rwlock_t
id|sg_dev_arr_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* Also used to lock&n;&t;&t;&t;file descriptor list for device */
DECL|variable|sg_template
r_static
r_struct
id|Scsi_Device_Template
id|sg_template
op_assign
(brace
id|tag
suffix:colon
l_string|&quot;sg&quot;
comma
id|scsi_type
suffix:colon
l_int|0xff
comma
id|major
suffix:colon
id|SCSI_GENERIC_MAJOR
comma
id|detect
suffix:colon
id|sg_detect
comma
id|init
suffix:colon
id|sg_init
comma
id|finish
suffix:colon
id|sg_finish
comma
id|attach
suffix:colon
id|sg_attach
comma
id|detach
suffix:colon
id|sg_detach
)brace
suffix:semicolon
DECL|struct|sg_scatter_hold
r_typedef
r_struct
id|sg_scatter_hold
multiline_comment|/* holding area for scsi scatter gather info */
(brace
DECL|member|k_use_sg
r_int
r_int
id|k_use_sg
suffix:semicolon
multiline_comment|/* Count of kernel scatter-gather pieces */
DECL|member|sglist_len
r_int
r_int
id|sglist_len
suffix:semicolon
multiline_comment|/* size of malloc&squot;d scatter-gather list */
DECL|member|bufflen
r_int
id|bufflen
suffix:semicolon
multiline_comment|/* Size of (aggregate) data buffer */
DECL|member|b_malloc_len
r_int
id|b_malloc_len
suffix:semicolon
multiline_comment|/* actual len malloc&squot;ed in buffer */
DECL|member|buffer
r_void
op_star
id|buffer
suffix:semicolon
multiline_comment|/* Data buffer or scatter list,12 bytes each*/
DECL|member|kiobp
r_struct
id|kiobuf
op_star
id|kiobp
suffix:semicolon
multiline_comment|/* for direct IO information */
DECL|member|mapped
r_char
id|mapped
suffix:semicolon
multiline_comment|/* indicates kiobp has locked pages */
DECL|member|buffer_mem_src
r_char
id|buffer_mem_src
suffix:semicolon
multiline_comment|/* heap whereabouts of &squot;buffer&squot; */
DECL|member|cmd_opcode
r_int
r_char
id|cmd_opcode
suffix:semicolon
multiline_comment|/* first byte of command */
DECL|typedef|Sg_scatter_hold
)brace
id|Sg_scatter_hold
suffix:semicolon
multiline_comment|/* 24 bytes long on i386 */
r_struct
id|sg_device
suffix:semicolon
multiline_comment|/* forward declarations */
r_struct
id|sg_fd
suffix:semicolon
DECL|struct|sg_request
r_typedef
r_struct
id|sg_request
multiline_comment|/* SG_MAX_QUEUE requests outstanding per file */
(brace
DECL|member|my_cmdp
id|Scsi_Request
op_star
id|my_cmdp
suffix:semicolon
multiline_comment|/* != 0  when request with lower levels */
DECL|member|nextrp
r_struct
id|sg_request
op_star
id|nextrp
suffix:semicolon
multiline_comment|/* NULL -&gt; tail request (slist) */
DECL|member|parentfp
r_struct
id|sg_fd
op_star
id|parentfp
suffix:semicolon
multiline_comment|/* NULL -&gt; not in use */
DECL|member|data
id|Sg_scatter_hold
id|data
suffix:semicolon
multiline_comment|/* hold buffer, perhaps scatter list */
DECL|member|header
id|sg_io_hdr_t
id|header
suffix:semicolon
multiline_comment|/* scsi command+info, see &lt;scsi/sg.h&gt; */
DECL|member|sense_b
r_int
r_char
id|sense_b
(braket
r_sizeof
(paren
id|dummy_cmdp-&gt;sr_sense_buffer
)paren
)braket
suffix:semicolon
DECL|member|res_used
r_char
id|res_used
suffix:semicolon
multiline_comment|/* 1 -&gt; using reserve buffer, 0 -&gt; not ... */
DECL|member|orphan
r_char
id|orphan
suffix:semicolon
multiline_comment|/* 1 -&gt; drop on sight, 0 -&gt; normal */
DECL|member|sg_io_owned
r_char
id|sg_io_owned
suffix:semicolon
multiline_comment|/* 1 -&gt; packet belongs to SG_IO */
DECL|member|done
r_char
id|done
suffix:semicolon
multiline_comment|/* 0-&gt;before bh, 1-&gt;before read, 2-&gt;read */
DECL|typedef|Sg_request
)brace
id|Sg_request
suffix:semicolon
multiline_comment|/* 168 bytes long on i386 */
DECL|struct|sg_fd
r_typedef
r_struct
id|sg_fd
multiline_comment|/* holds the state of a file descriptor */
(brace
DECL|member|nextfp
r_struct
id|sg_fd
op_star
id|nextfp
suffix:semicolon
multiline_comment|/* NULL when last opened fd on this device */
DECL|member|parentdp
r_struct
id|sg_device
op_star
id|parentdp
suffix:semicolon
multiline_comment|/* owning device */
DECL|member|read_wait
id|wait_queue_head_t
id|read_wait
suffix:semicolon
multiline_comment|/* queue read until command done */
DECL|member|rq_list_lock
id|rwlock_t
id|rq_list_lock
suffix:semicolon
multiline_comment|/* protect access to list in req_arr */
DECL|member|timeout
r_int
id|timeout
suffix:semicolon
multiline_comment|/* defaults to SG_DEFAULT_TIMEOUT */
DECL|member|reserve
id|Sg_scatter_hold
id|reserve
suffix:semicolon
multiline_comment|/* buffer held for this file descriptor */
DECL|member|save_scat_len
r_int
id|save_scat_len
suffix:semicolon
multiline_comment|/* original length of trunc. scat. element */
DECL|member|headrp
id|Sg_request
op_star
id|headrp
suffix:semicolon
multiline_comment|/* head of request slist, NULL-&gt;empty */
DECL|member|async_qp
r_struct
id|fasync_struct
op_star
id|async_qp
suffix:semicolon
multiline_comment|/* used by asynchronous notification */
DECL|member|req_arr
id|Sg_request
id|req_arr
(braket
id|SG_MAX_QUEUE
)braket
suffix:semicolon
multiline_comment|/* used as singly-linked list */
DECL|member|low_dma
r_char
id|low_dma
suffix:semicolon
multiline_comment|/* as in parent but possibly overridden to 1 */
DECL|member|force_packid
r_char
id|force_packid
suffix:semicolon
multiline_comment|/* 1 -&gt; pack_id input to read(), 0 -&gt; ignored */
DECL|member|closed
r_char
id|closed
suffix:semicolon
multiline_comment|/* 1 -&gt; fd closed but request(s) outstanding */
DECL|member|fd_mem_src
r_char
id|fd_mem_src
suffix:semicolon
multiline_comment|/* heap whereabouts of this Sg_fd object */
DECL|member|cmd_q
r_char
id|cmd_q
suffix:semicolon
multiline_comment|/* 1 -&gt; allow command queuing, 0 -&gt; don&squot;t */
DECL|member|next_cmd_len
r_char
id|next_cmd_len
suffix:semicolon
multiline_comment|/* 0 -&gt; automatic (def), &gt;0 -&gt; use on next write() */
DECL|member|keep_orphan
r_char
id|keep_orphan
suffix:semicolon
multiline_comment|/* 0 -&gt; drop orphan (def), 1 -&gt; keep for read() */
DECL|typedef|Sg_fd
)brace
id|Sg_fd
suffix:semicolon
multiline_comment|/* 2768 bytes long on i386 */
DECL|struct|sg_device
r_typedef
r_struct
id|sg_device
multiline_comment|/* holds the state of each scsi generic device */
(brace
DECL|member|device
id|Scsi_Device
op_star
id|device
suffix:semicolon
DECL|member|o_excl_wait
id|wait_queue_head_t
id|o_excl_wait
suffix:semicolon
multiline_comment|/* queue open() when O_EXCL in use */
DECL|member|sg_tablesize
r_int
id|sg_tablesize
suffix:semicolon
multiline_comment|/* adapter&squot;s max scatter-gather table size */
DECL|member|headfp
id|Sg_fd
op_star
id|headfp
suffix:semicolon
multiline_comment|/* first open fd belonging to this device */
DECL|member|de
id|devfs_handle_t
id|de
suffix:semicolon
DECL|member|i_rdev
id|kdev_t
id|i_rdev
suffix:semicolon
multiline_comment|/* holds device major+minor number */
DECL|member|exclude
r_char
id|exclude
suffix:semicolon
multiline_comment|/* opened for exclusive access */
DECL|member|sgdebug
r_char
id|sgdebug
suffix:semicolon
multiline_comment|/* 0-&gt;off, 1-&gt;sense, 9-&gt;dump dev, 10-&gt; all devs */
DECL|member|detached
r_char
id|detached
suffix:semicolon
multiline_comment|/* 0-&gt;attached, 1-&gt;detached pending removal */
DECL|typedef|Sg_device
)brace
id|Sg_device
suffix:semicolon
multiline_comment|/* 44 bytes long on i386 */
r_static
r_int
id|sg_fasync
c_func
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|sg_cmd_done_bh
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
r_static
r_int
id|sg_start_req
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_void
id|sg_finish_rem_req
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_int
id|sg_build_indi
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
id|Sg_fd
op_star
id|sfp
comma
r_int
id|buff_size
)paren
suffix:semicolon
r_static
r_int
id|sg_build_sgat
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
r_const
id|Sg_fd
op_star
id|sfp
)paren
suffix:semicolon
r_static
id|ssize_t
id|sg_new_read
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
id|ssize_t
id|sg_new_write
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|blocking
comma
r_int
id|read_only
comma
id|Sg_request
op_star
op_star
id|o_srp
)paren
suffix:semicolon
r_static
r_int
id|sg_common_write
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
comma
r_int
r_char
op_star
id|cmnd
comma
r_int
id|timeout
comma
r_int
id|blocking
)paren
suffix:semicolon
r_static
r_int
id|sg_u_iovec
c_func
(paren
id|sg_io_hdr_t
op_star
id|hp
comma
r_int
id|sg_num
comma
r_int
id|ind
comma
r_int
id|wr_xf
comma
r_int
op_star
id|countp
comma
r_int
r_char
op_star
op_star
id|up
)paren
suffix:semicolon
r_static
r_int
id|sg_write_xfer
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_int
id|sg_read_xfer
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_void
id|sg_read_oxfer
c_func
(paren
id|Sg_request
op_star
id|srp
comma
r_char
op_star
id|outp
comma
r_int
id|num_read_xfer
)paren
suffix:semicolon
r_static
r_void
id|sg_remove_scat
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
)paren
suffix:semicolon
r_static
r_char
op_star
id|sg_get_sgat_msa
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
)paren
suffix:semicolon
r_static
r_void
id|sg_build_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|req_size
)paren
suffix:semicolon
r_static
r_void
id|sg_link_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_void
id|sg_unlink_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_char
op_star
id|sg_malloc
c_func
(paren
r_const
id|Sg_fd
op_star
id|sfp
comma
r_int
id|size
comma
r_int
op_star
id|retSzp
comma
r_int
op_star
id|mem_srcp
)paren
suffix:semicolon
r_static
r_void
id|sg_free
c_func
(paren
r_char
op_star
id|buff
comma
r_int
id|size
comma
r_int
id|mem_src
)paren
suffix:semicolon
r_static
r_char
op_star
id|sg_low_malloc
c_func
(paren
r_int
id|rqSz
comma
r_int
id|lowDma
comma
r_int
id|mem_src
comma
r_int
op_star
id|retSzp
)paren
suffix:semicolon
r_static
r_void
id|sg_low_free
c_func
(paren
r_char
op_star
id|buff
comma
r_int
id|size
comma
r_int
id|mem_src
)paren
suffix:semicolon
r_static
id|Sg_fd
op_star
id|sg_add_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
r_int
id|dev
)paren
suffix:semicolon
r_static
r_int
id|sg_remove_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
id|Sg_fd
op_star
id|sfp
)paren
suffix:semicolon
r_static
id|Sg_request
op_star
id|sg_get_rq_mark
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|pack_id
)paren
suffix:semicolon
r_static
id|Sg_request
op_star
id|sg_add_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
suffix:semicolon
r_static
r_int
id|sg_remove_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
)paren
suffix:semicolon
r_static
r_int
id|sg_res_in_use
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
suffix:semicolon
r_static
r_int
id|sg_dio_in_use
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
suffix:semicolon
r_static
r_void
id|sg_clr_srpnt
c_func
(paren
id|Scsi_Request
op_star
id|SRpnt
)paren
suffix:semicolon
r_static
r_void
id|sg_shorten_timeout
c_func
(paren
id|Scsi_Request
op_star
id|srpnt
)paren
suffix:semicolon
r_static
r_int
id|sg_ms_to_jif
c_func
(paren
r_int
r_int
id|msecs
)paren
suffix:semicolon
r_static
r_int
id|sg_jif_to_ms
c_func
(paren
r_int
id|jifs
)paren
suffix:semicolon
r_static
r_int
id|sg_allow_access
c_func
(paren
r_int
r_char
id|opcode
comma
r_char
id|dev_type
)paren
suffix:semicolon
r_static
r_int
id|sg_build_dir
c_func
(paren
id|Sg_request
op_star
id|srp
comma
id|Sg_fd
op_star
id|sfp
comma
r_int
id|dxfer_len
)paren
suffix:semicolon
r_static
r_void
id|sg_unmap_and
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
r_int
id|free_also
)paren
suffix:semicolon
r_static
id|Sg_device
op_star
id|sg_get_dev
c_func
(paren
r_int
id|dev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_static
r_int
id|sg_last_dev
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|sg_dev_arr
r_static
id|Sg_device
op_star
op_star
id|sg_dev_arr
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|size_sg_header
r_static
r_const
r_int
id|size_sg_header
op_assign
r_sizeof
(paren
r_struct
id|sg_header
)paren
suffix:semicolon
DECL|variable|size_sg_io_hdr
r_static
r_const
r_int
id|size_sg_io_hdr
op_assign
r_sizeof
(paren
id|sg_io_hdr_t
)paren
suffix:semicolon
DECL|variable|size_sg_iovec
r_static
r_const
r_int
id|size_sg_iovec
op_assign
r_sizeof
(paren
id|sg_iovec_t
)paren
suffix:semicolon
DECL|variable|size_sg_req_info
r_static
r_const
r_int
id|size_sg_req_info
op_assign
r_sizeof
(paren
id|sg_req_info_t
)paren
suffix:semicolon
DECL|function|sg_open
r_static
r_int
id|sg_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_int
id|flags
op_assign
id|filp-&gt;f_flags
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
r_int
id|res
suffix:semicolon
id|sdp
op_assign
id|sg_get_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|sdp
)paren
op_logical_or
(paren
op_logical_neg
id|sdp-&gt;device
)paren
op_logical_or
(paren
op_logical_neg
id|sdp-&gt;device-&gt;host
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;i_rdev
op_ne
id|inode-&gt;i_rdev
)paren
id|printk
c_func
(paren
l_string|&quot;sg_open: inode maj=%d, min=%d   sdp maj=%d, min=%d&bslash;n&quot;
comma
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
comma
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
comma
id|MAJOR
c_func
(paren
id|sdp-&gt;i_rdev
)paren
comma
id|MINOR
c_func
(paren
id|sdp-&gt;i_rdev
)paren
)paren
suffix:semicolon
multiline_comment|/* If we are in the middle of error recovery, don&squot;t let anyone&n;     * else try and use this device.  Also, if error recovery fails, it&n;     * may try and take the device offline, in which case all further&n;     * access to the device is prohibited.  */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
op_logical_or
id|scsi_block_when_processing_errors
c_func
(paren
id|sdp-&gt;device
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_open: dev=%d, flags=0x%x&bslash;n&quot;
comma
id|dev
comma
id|flags
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|O_EXCL
)paren
(brace
r_if
c_cond
(paren
id|O_RDONLY
op_eq
(paren
id|flags
op_amp
id|O_ACCMODE
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/* Can&squot;t lock it with read only access */
r_if
c_cond
(paren
id|sdp-&gt;headfp
op_logical_and
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* following is a macro that beats race condition */
id|__wait_event_interruptible
c_func
(paren
id|sdp-&gt;o_excl_wait
comma
(paren
(paren
id|sdp-&gt;headfp
op_logical_or
id|sdp-&gt;exclude
)paren
ques
c_cond
l_int|0
suffix:colon
(paren
id|sdp-&gt;exclude
op_assign
l_int|1
)paren
)paren
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
multiline_comment|/* -ERESTARTSYS because signal hit process */
)brace
r_else
r_if
c_cond
(paren
id|sdp-&gt;exclude
)paren
(brace
multiline_comment|/* some other fd has an exclusive lock on dev */
r_if
c_cond
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* following is a macro that beats race condition */
id|__wait_event_interruptible
c_func
(paren
id|sdp-&gt;o_excl_wait
comma
(paren
op_logical_neg
id|sdp-&gt;exclude
)paren
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
multiline_comment|/* -ERESTARTSYS because signal hit process */
)brace
r_if
c_cond
(paren
op_logical_neg
id|sdp-&gt;headfp
)paren
(brace
multiline_comment|/* no existing opens on this device */
id|sdp-&gt;sgdebug
op_assign
l_int|0
suffix:semicolon
id|sdp-&gt;sg_tablesize
op_assign
id|sdp-&gt;device-&gt;host-&gt;sg_tablesize
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sfp
op_assign
id|sg_add_sfp
c_func
(paren
id|sdp
comma
id|dev
)paren
)paren
)paren
id|filp-&gt;private_data
op_assign
id|sfp
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_EXCL
)paren
id|sdp-&gt;exclude
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* undo if error */
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sdp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
id|__MOD_INC_USE_COUNT
c_func
(paren
id|sdp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Following function was formerly called &squot;sg_close&squot; */
DECL|function|sg_release
r_static
r_int
id|sg_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_release: dev=%d&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|sdp-&gt;i_rdev
)paren
)paren
)paren
suffix:semicolon
id|sg_fasync
c_func
(paren
op_minus
l_int|1
comma
id|filp
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* remove filp from async notification list */
id|sg_remove_sfp
c_func
(paren
id|sdp
comma
id|sfp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sdp-&gt;headfp
)paren
id|filp-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
id|__MOD_DEC_USE_COUNT
c_func
(paren
id|sdp-&gt;device-&gt;host-&gt;hostt-&gt;module
)paren
suffix:semicolon
id|sdp-&gt;exclude
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|sdp-&gt;o_excl_wait
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_read
r_static
id|ssize_t
id|sg_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|k
comma
id|res
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
id|req_pack_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_struct
id|sg_header
id|old_hdr
suffix:semicolon
id|sg_io_hdr_t
id|new_hdr
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_read: dev=%d, count=%d&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|sdp-&gt;i_rdev
)paren
comma
(paren
r_int
)paren
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|filp-&gt;f_pos
)paren
suffix:semicolon
multiline_comment|/* FIXME: Hmm.  Seek to the right place, or fail?  */
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|buf
comma
id|count
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;force_packid
op_logical_and
(paren
id|count
op_ge
id|size_sg_header
)paren
)paren
(brace
id|__copy_from_user
c_func
(paren
op_amp
id|old_hdr
comma
id|buf
comma
id|size_sg_header
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_hdr.reply_len
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|count
op_ge
id|size_sg_io_hdr
)paren
(brace
id|__copy_from_user
c_func
(paren
op_amp
id|new_hdr
comma
id|buf
comma
id|size_sg_io_hdr
)paren
suffix:semicolon
id|req_pack_id
op_assign
id|new_hdr.pack_id
suffix:semicolon
)brace
)brace
r_else
id|req_pack_id
op_assign
id|old_hdr.pack_id
suffix:semicolon
)brace
id|srp
op_assign
id|sg_get_rq_mark
c_func
(paren
id|sfp
comma
id|req_pack_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|srp
)paren
(brace
multiline_comment|/* now wait on packet to arrive */
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
id|dio
op_assign
id|sg_dio_in_use
c_func
(paren
id|sfp
)paren
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* following is a macro that beats race condition */
id|__wait_event_interruptible
c_func
(paren
id|sfp-&gt;read_wait
comma
(paren
id|srp
op_assign
id|sg_get_rq_mark
c_func
(paren
id|sfp
comma
id|req_pack_id
)paren
)paren
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|res
)paren
r_break
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|dio
)paren
multiline_comment|/* only let signal out if no dio */
r_return
id|res
suffix:semicolon
multiline_comment|/* -ERESTARTSYS because signal hit process */
)brace
)brace
r_if
c_cond
(paren
id|srp-&gt;header.interface_id
op_ne
l_char|&squot;&bslash;0&squot;
)paren
r_return
id|sg_new_read
c_func
(paren
id|sfp
comma
id|buf
comma
id|count
comma
id|srp
)paren
suffix:semicolon
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|old_hdr
comma
l_int|0
comma
id|size_sg_header
)paren
suffix:semicolon
id|old_hdr.reply_len
op_assign
(paren
r_int
)paren
id|hp-&gt;timeout
suffix:semicolon
id|old_hdr.pack_len
op_assign
id|old_hdr.reply_len
suffix:semicolon
multiline_comment|/* very old, strange behaviour */
id|old_hdr.pack_id
op_assign
id|hp-&gt;pack_id
suffix:semicolon
id|old_hdr.twelve_byte
op_assign
(paren
(paren
id|srp-&gt;data.cmd_opcode
op_ge
l_int|0xc0
)paren
op_logical_and
(paren
l_int|12
op_eq
id|hp-&gt;cmd_len
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|old_hdr.target_status
op_assign
id|hp-&gt;masked_status
suffix:semicolon
id|old_hdr.host_status
op_assign
id|hp-&gt;host_status
suffix:semicolon
id|old_hdr.driver_status
op_assign
id|hp-&gt;driver_status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|CHECK_CONDITION
op_amp
id|hp-&gt;masked_status
)paren
op_logical_or
(paren
id|DRIVER_SENSE
op_amp
id|hp-&gt;driver_status
)paren
)paren
id|memcpy
c_func
(paren
id|old_hdr.sense_buffer
comma
id|srp-&gt;sense_b
comma
r_sizeof
(paren
id|old_hdr.sense_buffer
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;host_status
)paren
(brace
multiline_comment|/* This setup of &squot;result&squot; is for backward compatibility and is best&n;&t; ignored by the user who should use target, host + driver status */
r_case
id|DID_OK
suffix:colon
r_case
id|DID_PASSTHROUGH
suffix:colon
r_case
id|DID_SOFT_ERROR
suffix:colon
id|old_hdr.result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_NO_CONNECT
suffix:colon
r_case
id|DID_BUS_BUSY
suffix:colon
r_case
id|DID_TIME_OUT
suffix:colon
id|old_hdr.result
op_assign
id|EBUSY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_BAD_TARGET
suffix:colon
r_case
id|DID_ABORT
suffix:colon
r_case
id|DID_PARITY
suffix:colon
r_case
id|DID_RESET
suffix:colon
r_case
id|DID_BAD_INTR
suffix:colon
id|old_hdr.result
op_assign
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DID_ERROR
suffix:colon
id|old_hdr.result
op_assign
(paren
id|srp-&gt;sense_b
(braket
l_int|0
)braket
op_eq
l_int|0
op_logical_and
id|hp-&gt;masked_status
op_eq
id|GOOD
)paren
ques
c_cond
l_int|0
suffix:colon
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|old_hdr.result
op_assign
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Now copy the result back to the user buffer.  */
r_if
c_cond
(paren
id|count
op_ge
id|size_sg_header
)paren
(brace
id|__copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|old_hdr
comma
id|size_sg_header
)paren
suffix:semicolon
id|buf
op_add_assign
id|size_sg_header
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|old_hdr.reply_len
)paren
id|count
op_assign
id|old_hdr.reply_len
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|size_sg_header
)paren
id|sg_read_oxfer
c_func
(paren
id|srp
comma
id|buf
comma
id|count
op_minus
id|size_sg_header
)paren
suffix:semicolon
)brace
r_else
id|count
op_assign
(paren
id|old_hdr.result
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|sg_new_read
r_static
id|ssize_t
id|sg_new_read
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|Sg_request
op_star
id|srp
)paren
(brace
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
r_int
id|k
comma
id|len
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|size_sg_io_hdr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|hp-&gt;sb_len_wr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hp-&gt;mx_sb_len
OG
l_int|0
)paren
op_logical_and
id|hp-&gt;sbp
)paren
(brace
r_if
c_cond
(paren
(paren
id|CHECK_CONDITION
op_amp
id|hp-&gt;masked_status
)paren
op_logical_or
(paren
id|DRIVER_SENSE
op_amp
id|hp-&gt;driver_status
)paren
)paren
(brace
r_int
id|sb_len
op_assign
r_sizeof
(paren
id|dummy_cmdp-&gt;sr_sense_buffer
)paren
suffix:semicolon
id|sb_len
op_assign
(paren
id|hp-&gt;mx_sb_len
OG
id|sb_len
)paren
ques
c_cond
id|sb_len
suffix:colon
id|hp-&gt;mx_sb_len
suffix:semicolon
id|len
op_assign
l_int|8
op_plus
(paren
r_int
)paren
id|srp-&gt;sense_b
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* Additional sense length field */
id|len
op_assign
(paren
id|len
OG
id|sb_len
)paren
ques
c_cond
id|sb_len
suffix:colon
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|hp-&gt;sbp
comma
id|len
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
id|__copy_to_user
c_func
(paren
id|hp-&gt;sbp
comma
id|srp-&gt;sense_b
comma
id|len
)paren
suffix:semicolon
id|hp-&gt;sb_len_wr
op_assign
id|len
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hp-&gt;masked_status
op_logical_or
id|hp-&gt;host_status
op_logical_or
id|hp-&gt;driver_status
)paren
id|hp-&gt;info
op_or_assign
id|SG_INFO_CHECK
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buf
comma
id|hp
comma
id|size_sg_io_hdr
)paren
suffix:semicolon
id|k
op_assign
id|sg_read_xfer
c_func
(paren
id|srp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
)paren
r_return
id|k
suffix:semicolon
multiline_comment|/* probably -EFAULT, bad addr in dxferp or iovec list */
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|sg_write
r_static
id|ssize_t
id|sg_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|mxsize
comma
id|cmd_size
comma
id|k
suffix:semicolon
r_int
id|input_size
comma
id|blocking
suffix:semicolon
r_int
r_char
id|opcode
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_struct
id|sg_header
id|old_hdr
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
suffix:semicolon
r_int
r_char
id|cmnd
(braket
r_sizeof
(paren
id|dummy_cmdp-&gt;sr_cmnd
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: dev=%d, count=%d&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|sdp-&gt;i_rdev
)paren
comma
(paren
r_int
)paren
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_logical_or
id|scsi_block_when_processing_errors
c_func
(paren
id|sdp-&gt;device
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|filp-&gt;f_pos
)paren
suffix:semicolon
multiline_comment|/* FIXME: Hmm.  Seek to the right place, or fail?  */
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|buf
comma
id|count
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
multiline_comment|/* protects following copy_from_user()s + get_user()s */
r_if
c_cond
(paren
id|count
OL
id|size_sg_header
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|__copy_from_user
c_func
(paren
op_amp
id|old_hdr
comma
id|buf
comma
id|size_sg_header
)paren
suffix:semicolon
id|blocking
op_assign
op_logical_neg
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_hdr.reply_len
OL
l_int|0
)paren
r_return
id|sg_new_write
c_func
(paren
id|sfp
comma
id|buf
comma
id|count
comma
id|blocking
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
(paren
id|size_sg_header
op_plus
l_int|6
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* The minimum scsi command length is 6 bytes. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|srp
op_assign
id|sg_add_request
c_func
(paren
id|sfp
)paren
)paren
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: queue full&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EDOM
suffix:semicolon
)brace
id|buf
op_add_assign
id|size_sg_header
suffix:semicolon
id|__get_user
c_func
(paren
id|opcode
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;next_cmd_len
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sfp-&gt;next_cmd_len
OG
id|MAX_COMMAND_SIZE
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: command length too long&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sfp-&gt;next_cmd_len
op_assign
l_int|0
suffix:semicolon
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|cmd_size
op_assign
id|sfp-&gt;next_cmd_len
suffix:semicolon
id|sfp-&gt;next_cmd_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset so only this write() effected */
)brace
r_else
(brace
id|cmd_size
op_assign
id|COMMAND_SIZE
c_func
(paren
id|opcode
)paren
suffix:semicolon
multiline_comment|/* based on SCSI command group */
r_if
c_cond
(paren
(paren
id|opcode
op_ge
l_int|0xc0
)paren
op_logical_and
id|old_hdr.twelve_byte
)paren
id|cmd_size
op_assign
l_int|12
suffix:semicolon
)brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_write:   scsi opcode=0x%02x, cmd_size=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|opcode
comma
id|cmd_size
)paren
)paren
suffix:semicolon
multiline_comment|/* Determine buffer size.  */
id|input_size
op_assign
id|count
op_minus
id|cmd_size
suffix:semicolon
id|mxsize
op_assign
(paren
id|input_size
OG
id|old_hdr.reply_len
)paren
ques
c_cond
id|input_size
suffix:colon
id|old_hdr.reply_len
suffix:semicolon
id|mxsize
op_sub_assign
id|size_sg_header
suffix:semicolon
id|input_size
op_sub_assign
id|size_sg_header
suffix:semicolon
r_if
c_cond
(paren
id|input_size
OL
l_int|0
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* User did not pass enough bytes for this command. */
)brace
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|hp-&gt;interface_id
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* indicator of old interface tunnelled */
id|hp-&gt;cmd_len
op_assign
(paren
r_int
r_char
)paren
id|cmd_size
suffix:semicolon
id|hp-&gt;iovec_count
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;mx_sb_len
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|hp-&gt;dxfer_direction
op_assign
id|SG_DXFER_UNKNOWN
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|input_size
OG
l_int|0
)paren
id|hp-&gt;dxfer_direction
op_assign
(paren
(paren
id|old_hdr.reply_len
op_minus
id|size_sg_header
)paren
OG
l_int|0
)paren
ques
c_cond
id|SG_DXFER_TO_FROM_DEV
suffix:colon
id|SG_DXFER_TO_DEV
suffix:semicolon
r_else
id|hp-&gt;dxfer_direction
op_assign
(paren
id|mxsize
OG
l_int|0
)paren
ques
c_cond
id|SG_DXFER_FROM_DEV
suffix:colon
id|SG_DXFER_NONE
suffix:semicolon
macro_line|#endif
id|hp-&gt;dxfer_len
op_assign
id|mxsize
suffix:semicolon
id|hp-&gt;dxferp
op_assign
(paren
r_int
r_char
op_star
)paren
id|buf
op_plus
id|cmd_size
suffix:semicolon
id|hp-&gt;sbp
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;timeout
op_assign
id|old_hdr.reply_len
suffix:semicolon
multiline_comment|/* structure abuse ... */
id|hp-&gt;flags
op_assign
id|input_size
suffix:semicolon
multiline_comment|/* structure abuse ... */
id|hp-&gt;pack_id
op_assign
id|old_hdr.pack_id
suffix:semicolon
id|hp-&gt;usr_ptr
op_assign
l_int|NULL
suffix:semicolon
id|__copy_from_user
c_func
(paren
id|cmnd
comma
id|buf
comma
id|cmd_size
)paren
suffix:semicolon
id|k
op_assign
id|sg_common_write
c_func
(paren
id|sfp
comma
id|srp
comma
id|cmnd
comma
id|sfp-&gt;timeout
comma
id|blocking
)paren
suffix:semicolon
r_return
(paren
id|k
OL
l_int|0
)paren
ques
c_cond
id|k
suffix:colon
id|count
suffix:semicolon
)brace
DECL|function|sg_new_write
r_static
id|ssize_t
id|sg_new_write
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|blocking
comma
r_int
id|read_only
comma
id|Sg_request
op_star
op_star
id|o_srp
)paren
(brace
r_int
id|k
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
suffix:semicolon
r_int
r_char
id|cmnd
(braket
r_sizeof
(paren
id|dummy_cmdp-&gt;sr_cmnd
)paren
)braket
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|size_sg_io_hdr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|buf
comma
id|count
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
multiline_comment|/* protects following copy_from_user()s + get_user()s */
id|sfp-&gt;cmd_q
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* when sg_io_hdr seen, set command queuing on */
r_if
c_cond
(paren
op_logical_neg
(paren
id|srp
op_assign
id|sg_add_request
c_func
(paren
id|sfp
)paren
)paren
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_new_write: queue full&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EDOM
suffix:semicolon
)brace
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|__copy_from_user
c_func
(paren
id|hp
comma
id|buf
comma
id|size_sg_io_hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;interface_id
op_ne
l_char|&squot;S&squot;
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
id|timeout
op_assign
id|sg_ms_to_jif
c_func
(paren
id|srp-&gt;header.timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|hp-&gt;cmdp
)paren
op_logical_or
(paren
id|hp-&gt;cmd_len
OL
l_int|6
)paren
op_logical_or
(paren
id|hp-&gt;cmd_len
OG
r_sizeof
(paren
id|cmnd
)paren
)paren
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|hp-&gt;cmdp
comma
id|hp-&gt;cmd_len
)paren
)paren
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
id|k
suffix:semicolon
multiline_comment|/* protects following copy_from_user()s + get_user()s */
)brace
id|__copy_from_user
c_func
(paren
id|cmnd
comma
id|hp-&gt;cmdp
comma
id|hp-&gt;cmd_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_only
op_logical_and
(paren
op_logical_neg
id|sg_allow_access
c_func
(paren
id|cmnd
(braket
l_int|0
)braket
comma
id|sfp-&gt;parentdp-&gt;device-&gt;type
)paren
)paren
)paren
(brace
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
id|k
op_assign
id|sg_common_write
c_func
(paren
id|sfp
comma
id|srp
comma
id|cmnd
comma
id|timeout
comma
id|blocking
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
OL
l_int|0
)paren
r_return
id|k
suffix:semicolon
r_if
c_cond
(paren
id|o_srp
)paren
op_star
id|o_srp
op_assign
id|srp
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|sg_common_write
r_static
r_int
id|sg_common_write
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
comma
r_int
r_char
op_star
id|cmnd
comma
r_int
id|timeout
comma
r_int
id|blocking
)paren
(brace
r_int
id|k
suffix:semicolon
id|Scsi_Request
op_star
id|SRpnt
suffix:semicolon
id|Sg_device
op_star
id|sdp
op_assign
id|sfp-&gt;parentdp
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|srp-&gt;data.cmd_opcode
op_assign
id|cmnd
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* hold opcode of command */
id|hp-&gt;status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;masked_status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;msg_status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;info
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;host_status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;driver_status
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;resid
op_assign
l_int|0
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_common_write:  scsi opcode=0x%02x, cmd_size=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmnd
(braket
l_int|0
)braket
comma
(paren
r_int
)paren
id|hp-&gt;cmd_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|sg_start_req
c_func
(paren
id|srp
)paren
)paren
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: start_req err=%d&bslash;n&quot;
comma
id|k
)paren
)paren
suffix:semicolon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
id|k
suffix:semicolon
multiline_comment|/* probably out of space --&gt; ENOMEM */
)brace
r_if
c_cond
(paren
(paren
id|k
op_assign
id|sg_write_xfer
c_func
(paren
id|srp
)paren
)paren
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: write_xfer, bad address&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
id|k
suffix:semicolon
)brace
multiline_comment|/*  SCSI_LOG_TIMEOUT(7, printk(&quot;sg_write: allocating device&bslash;n&quot;)); */
id|SRpnt
op_assign
id|scsi_allocate_request
c_func
(paren
id|sdp-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SRpnt
op_eq
l_int|NULL
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_write: no mem&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*  SCSI_LOG_TIMEOUT(7, printk(&quot;sg_write: device allocated&bslash;n&quot;)); */
id|srp-&gt;my_cmdp
op_assign
id|SRpnt
suffix:semicolon
id|SRpnt-&gt;sr_request.rq_dev
op_assign
id|sdp-&gt;i_rdev
suffix:semicolon
id|SRpnt-&gt;sr_request.rq_status
op_assign
id|RQ_ACTIVE
suffix:semicolon
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_cmd_len
op_assign
id|hp-&gt;cmd_len
suffix:semicolon
multiline_comment|/* Set the LUN field in the command structure, overriding user input  */
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;flags
op_amp
id|SG_FLAG_LUN_INHIBIT
)paren
)paren
id|cmnd
(braket
l_int|1
)braket
op_assign
(paren
id|cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
op_or
(paren
id|sdp-&gt;device-&gt;lun
op_lshift
l_int|5
)paren
suffix:semicolon
multiline_comment|/*  SCSI_LOG_TIMEOUT(7, printk(&quot;sg_write: do cmd&bslash;n&quot;)); */
id|SRpnt-&gt;sr_use_sg
op_assign
id|srp-&gt;data.k_use_sg
suffix:semicolon
id|SRpnt-&gt;sr_sglist_len
op_assign
id|srp-&gt;data.sglist_len
suffix:semicolon
id|SRpnt-&gt;sr_bufflen
op_assign
id|srp-&gt;data.bufflen
suffix:semicolon
id|SRpnt-&gt;sr_underflow
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_buffer
op_assign
id|srp-&gt;data.buffer
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;dxfer_direction
)paren
(brace
r_case
id|SG_DXFER_TO_FROM_DEV
suffix:colon
r_case
id|SG_DXFER_FROM_DEV
suffix:colon
id|SRpnt-&gt;sr_data_direction
op_assign
id|SCSI_DATA_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SG_DXFER_TO_DEV
suffix:colon
id|SRpnt-&gt;sr_data_direction
op_assign
id|SCSI_DATA_WRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SG_DXFER_UNKNOWN
suffix:colon
id|SRpnt-&gt;sr_data_direction
op_assign
id|SCSI_DATA_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SRpnt-&gt;sr_data_direction
op_assign
id|SCSI_DATA_NONE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|srp-&gt;data.k_use_sg
op_assign
l_int|0
suffix:semicolon
id|srp-&gt;data.sglist_len
op_assign
l_int|0
suffix:semicolon
id|srp-&gt;data.bufflen
op_assign
l_int|0
suffix:semicolon
id|srp-&gt;data.buffer
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;duration
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* unit jiffies now, millisecs after done */
multiline_comment|/* Now send everything of to mid-level. The next time we hear about this&n;   packet is when sg_cmd_done_bh() is called (i.e. a callback). */
id|scsi_do_req
c_func
(paren
id|SRpnt
comma
(paren
r_void
op_star
)paren
id|cmnd
comma
(paren
r_void
op_star
)paren
id|SRpnt-&gt;sr_buffer
comma
id|hp-&gt;dxfer_len
comma
id|sg_cmd_done_bh
comma
id|timeout
comma
id|SG_DEFAULT_RETRIES
)paren
suffix:semicolon
multiline_comment|/* dxfer_len overwrites SRpnt-&gt;sr_bufflen, hence need for b_malloc_len */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_ioctl
r_static
r_int
id|sg_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd_in
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|result
comma
id|val
comma
id|read_only
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_ioctl: dev=%d, cmd=0x%x&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|sdp-&gt;i_rdev
)paren
comma
(paren
r_int
)paren
id|cmd_in
)paren
)paren
suffix:semicolon
id|read_only
op_assign
(paren
id|O_RDWR
op_ne
(paren
id|filp-&gt;f_flags
op_amp
id|O_ACCMODE
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_in
)paren
(brace
r_case
id|SG_IO
suffix:colon
(brace
r_int
id|blocking
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ignore O_NONBLOCK flag */
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|sdp-&gt;device
)paren
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|result
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
id|size_sg_io_hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
id|sg_new_write
c_func
(paren
id|sfp
comma
(paren
r_const
r_char
op_star
)paren
id|arg
comma
id|size_sg_io_hdr
comma
id|blocking
comma
id|read_only
comma
op_amp
id|srp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|srp-&gt;sg_io_owned
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
id|dio
op_assign
id|sg_dio_in_use
c_func
(paren
id|sfp
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* following macro to beat race condition */
id|__wait_event_interruptible
c_func
(paren
id|sfp-&gt;read_wait
comma
(paren
id|sfp-&gt;closed
op_logical_or
id|srp-&gt;done
)paren
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;closed
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* request packet dropped already */
r_if
c_cond
(paren
l_int|0
op_eq
id|result
)paren
r_break
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|dio
)paren
(brace
multiline_comment|/* only let signal out if no dio */
id|srp-&gt;orphan
op_assign
l_int|1
suffix:semicolon
r_return
id|result
suffix:semicolon
multiline_comment|/* -ERESTARTSYS because signal hit process */
)brace
)brace
id|srp-&gt;done
op_assign
l_int|2
suffix:semicolon
id|result
op_assign
id|sg_new_read
c_func
(paren
id|sfp
comma
(paren
r_char
op_star
)paren
id|arg
comma
id|size_sg_io_hdr
comma
id|srp
)paren
suffix:semicolon
r_return
(paren
id|result
OL
l_int|0
)paren
ques
c_cond
id|result
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|SG_SET_TIMEOUT
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|sfp-&gt;timeout
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_TIMEOUT
suffix:colon
multiline_comment|/* N.B. User receives timeout as return value */
r_return
id|sfp-&gt;timeout
suffix:semicolon
multiline_comment|/* strange ..., for backward compatibility */
r_case
id|SG_SET_FORCE_LOW_DMA
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|sfp-&gt;low_dma
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|0
op_eq
id|sfp-&gt;low_dma
)paren
op_logical_and
(paren
l_int|0
op_eq
id|sg_res_in_use
c_func
(paren
id|sfp
)paren
)paren
)paren
(brace
id|val
op_assign
(paren
r_int
)paren
id|sfp-&gt;reserve.bufflen
suffix:semicolon
id|sg_remove_scat
c_func
(paren
op_amp
id|sfp-&gt;reserve
)paren
suffix:semicolon
id|sg_build_reserve
c_func
(paren
id|sfp
comma
id|val
)paren
suffix:semicolon
)brace
)brace
r_else
id|sfp-&gt;low_dma
op_assign
id|sdp-&gt;device-&gt;host-&gt;unchecked_isa_dma
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_LOW_DMA
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
r_int
)paren
id|sfp-&gt;low_dma
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SG_GET_SCSI_ID
suffix:colon
id|result
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|sg_scsi_id_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_else
(brace
id|sg_scsi_id_t
op_star
id|sg_idp
op_assign
(paren
id|sg_scsi_id_t
op_star
)paren
id|arg
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;host-&gt;host_no
comma
op_amp
id|sg_idp-&gt;host_no
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;channel
comma
op_amp
id|sg_idp-&gt;channel
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;id
comma
op_amp
id|sg_idp-&gt;scsi_id
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;lun
comma
op_amp
id|sg_idp-&gt;lun
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;type
comma
op_amp
id|sg_idp-&gt;scsi_type
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;host-&gt;cmd_per_lun
comma
op_amp
id|sg_idp-&gt;h_cmd_per_lun
)paren
suffix:semicolon
id|__put_user
c_func
(paren
(paren
r_int
)paren
id|sdp-&gt;device-&gt;queue_depth
comma
op_amp
id|sg_idp-&gt;d_queue_depth
)paren
suffix:semicolon
id|__put_user
c_func
(paren
l_int|0
comma
op_amp
id|sg_idp-&gt;unused
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|__put_user
c_func
(paren
l_int|0
comma
op_amp
id|sg_idp-&gt;unused
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SG_SET_FORCE_PACK_ID
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sfp-&gt;force_packid
op_assign
id|val
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_PACK_ID
suffix:colon
id|result
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1
op_eq
id|srp-&gt;done
)paren
op_logical_and
(paren
op_logical_neg
id|srp-&gt;sg_io_owned
)paren
)paren
(brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|__put_user
c_func
(paren
id|srp-&gt;header.pack_id
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|__put_user
c_func
(paren
op_minus
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_NUM_WAITING
suffix:colon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|val
op_assign
l_int|0
comma
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1
op_eq
id|srp-&gt;done
)paren
op_logical_and
(paren
op_logical_neg
id|srp-&gt;sg_io_owned
)paren
)paren
op_increment
id|val
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SG_GET_SG_TABLESIZE
suffix:colon
r_return
id|put_user
c_func
(paren
id|sdp-&gt;sg_tablesize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SG_SET_RESERVED_SIZE
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|sfp-&gt;reserve.bufflen
)paren
(brace
r_if
c_cond
(paren
id|sg_res_in_use
c_func
(paren
id|sfp
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|sg_remove_scat
c_func
(paren
op_amp
id|sfp-&gt;reserve
)paren
suffix:semicolon
id|sg_build_reserve
c_func
(paren
id|sfp
comma
id|val
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_RESERVED_SIZE
suffix:colon
id|val
op_assign
(paren
r_int
)paren
id|sfp-&gt;reserve.bufflen
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SG_SET_COMMAND_Q
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sfp-&gt;cmd_q
op_assign
id|val
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_COMMAND_Q
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
r_int
)paren
id|sfp-&gt;cmd_q
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SG_SET_KEEP_ORPHAN
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sfp-&gt;keep_orphan
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_KEEP_ORPHAN
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
r_int
)paren
id|sfp-&gt;keep_orphan
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SG_NEXT_CMD_LEN
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sfp-&gt;next_cmd_len
op_assign
(paren
id|val
OG
l_int|0
)paren
ques
c_cond
id|val
suffix:colon
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SG_GET_VERSION_NUM
suffix:colon
r_return
id|put_user
c_func
(paren
id|sg_version_num
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SG_GET_REQUEST_TABLE
suffix:colon
id|result
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
id|size_sg_req_info
op_star
id|SG_MAX_QUEUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_else
(brace
id|sg_req_info_t
id|rinfo
(braket
id|SG_MAX_QUEUE
)braket
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
comma
id|val
op_assign
l_int|0
suffix:semicolon
id|val
OL
id|SG_MAX_QUEUE
suffix:semicolon
op_increment
id|val
comma
id|srp
op_assign
id|srp
ques
c_cond
id|srp-&gt;nextrp
suffix:colon
id|srp
)paren
(brace
id|memset
c_func
(paren
op_amp
id|rinfo
(braket
id|val
)braket
comma
l_int|0
comma
id|size_sg_req_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srp
)paren
(brace
id|rinfo
(braket
id|val
)braket
dot
id|req_state
op_assign
id|srp-&gt;done
op_plus
l_int|1
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|problem
op_assign
id|srp-&gt;header.masked_status
op_amp
id|srp-&gt;header.host_status
op_amp
id|srp-&gt;header.driver_status
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|duration
op_assign
id|srp-&gt;done
ques
c_cond
id|srp-&gt;header.duration
suffix:colon
id|sg_jif_to_ms
c_func
(paren
id|jiffies
op_minus
id|srp-&gt;header.duration
)paren
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|orphan
op_assign
id|srp-&gt;orphan
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|sg_io_owned
op_assign
id|srp-&gt;sg_io_owned
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|pack_id
op_assign
id|srp-&gt;header.pack_id
suffix:semicolon
id|rinfo
(braket
id|val
)braket
dot
id|usr_ptr
op_assign
id|srp-&gt;header.usr_ptr
suffix:semicolon
)brace
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|__copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|rinfo
comma
id|size_sg_req_info
op_star
id|SG_MAX_QUEUE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SG_EMULATED_HOST
suffix:colon
r_return
id|put_user
c_func
(paren
id|sdp-&gt;device-&gt;host-&gt;hostt-&gt;emulated
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SG_SCSI_RESET
suffix:colon
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|sdp-&gt;device-&gt;host-&gt;in_recovery
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|scsi_block_when_processing_errors
c_func
(paren
id|sdp-&gt;device
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
id|SG_SCSI_RESET_NOTHING
op_eq
id|val
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef SCSI_TRY_RESET_DEVICE
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|SG_SCSI_RESET_DEVICE
suffix:colon
id|val
op_assign
id|SCSI_TRY_RESET_DEVICE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SG_SCSI_RESET_BUS
suffix:colon
id|val
op_assign
id|SCSI_TRY_RESET_BUS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SG_SCSI_RESET_HOST
suffix:colon
id|val
op_assign
id|SCSI_TRY_RESET_HOST
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
r_return
(paren
id|scsi_reset_provider
c_func
(paren
id|sdp-&gt;device
comma
id|val
)paren
op_eq
id|SUCCESS
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
macro_line|#else
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_ioctl: SG_RESET_SCSI not supported&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
r_case
id|SCSI_IOCTL_SEND_COMMAND
suffix:colon
r_if
c_cond
(paren
id|read_only
)paren
(brace
r_int
r_char
id|opcode
op_assign
id|WRITE_6
suffix:semicolon
id|Scsi_Ioctl_Command
op_star
id|siocp
op_assign
(paren
r_void
op_star
)paren
id|arg
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|opcode
comma
id|siocp-&gt;data
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sg_allow_access
c_func
(paren
id|opcode
comma
id|sdp-&gt;device-&gt;type
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
r_return
id|scsi_ioctl_send_command
c_func
(paren
id|sdp-&gt;device
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SG_SET_DEBUG
suffix:colon
id|result
op_assign
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|sdp-&gt;sgdebug
op_assign
(paren
r_char
)paren
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SCSI_IOCTL_GET_IDLUN
suffix:colon
r_case
id|SCSI_IOCTL_GET_BUS_NUMBER
suffix:colon
r_case
id|SCSI_IOCTL_PROBE_HOST
suffix:colon
r_case
id|SG_GET_TRANSFORM
suffix:colon
r_return
id|scsi_ioctl
c_func
(paren
id|sdp-&gt;device
comma
id|cmd_in
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|read_only
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/* don&squot;t know so take safe approach */
r_return
id|scsi_ioctl
c_func
(paren
id|sdp-&gt;device
comma
id|cmd_in
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
)brace
DECL|function|sg_poll
r_static
r_int
r_int
id|sg_poll
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_int
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
id|POLLERR
suffix:semicolon
id|poll_wait
c_func
(paren
id|filp
comma
op_amp
id|sfp-&gt;read_wait
comma
id|wait
)paren
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
(brace
multiline_comment|/* if any read waiting, flag it */
r_if
c_cond
(paren
(paren
l_int|0
op_eq
id|res
)paren
op_logical_and
(paren
l_int|1
op_eq
id|srp-&gt;done
)paren
op_logical_and
(paren
op_logical_neg
id|srp-&gt;sg_io_owned
)paren
)paren
id|res
op_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
op_increment
id|count
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sfp-&gt;cmd_q
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|count
)paren
id|res
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|count
OL
id|SG_MAX_QUEUE
)paren
id|res
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_poll: dev=%d, res=0x%x&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|sdp-&gt;i_rdev
)paren
comma
(paren
r_int
)paren
id|res
)paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|sg_fasync
r_static
r_int
id|sg_fasync
c_func
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|mode
)paren
(brace
r_int
id|retval
suffix:semicolon
id|Sg_device
op_star
id|sdp
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|filp-&gt;private_data
)paren
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sdp
op_assign
id|sfp-&gt;parentdp
)paren
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_fasync: dev=%d, mode=%d&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|sdp-&gt;i_rdev
)paren
comma
id|mode
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|fasync_helper
c_func
(paren
id|fd
comma
id|filp
comma
id|mode
comma
op_amp
id|sfp-&gt;async_qp
)paren
suffix:semicolon
r_return
(paren
id|retval
OL
l_int|0
)paren
ques
c_cond
id|retval
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This function is a &quot;bottom half&quot; handler that is called by the&n; * mid level when a command is completed (or has failed). */
DECL|function|sg_cmd_done_bh
r_static
r_void
id|sg_cmd_done_bh
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|Scsi_Request
op_star
id|SRpnt
op_assign
id|SCpnt-&gt;sc_request
suffix:semicolon
r_int
id|dev
op_assign
id|MINOR
c_func
(paren
id|SRpnt-&gt;sr_request.rq_dev
)paren
suffix:semicolon
id|Sg_device
op_star
id|sdp
op_assign
l_int|NULL
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
op_assign
l_int|NULL
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|sg_dev_arr_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_dev_arr
op_logical_and
(paren
id|dev
op_ge
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|dev
OL
id|sg_template.dev_max
)paren
id|sdp
op_assign
id|sg_dev_arr
(braket
id|dev
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sdp
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|sg_dev_arr_lock
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg...bh: bad args dev=%d&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sfp
op_assign
id|sdp-&gt;headfp
suffix:semicolon
r_while
c_loop
(paren
id|sfp
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
(brace
r_if
c_cond
(paren
id|SRpnt
op_eq
id|srp-&gt;my_cmdp
)paren
r_break
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srp
)paren
r_break
suffix:semicolon
id|sfp
op_assign
id|sfp-&gt;nextfp
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|sg_dev_arr_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|srp
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg...bh: req missing, dev=%d&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* First transfer ownership of data buffers to sg_device object. */
id|srp-&gt;data.k_use_sg
op_assign
id|SRpnt-&gt;sr_use_sg
suffix:semicolon
id|srp-&gt;data.sglist_len
op_assign
id|SRpnt-&gt;sr_sglist_len
suffix:semicolon
id|srp-&gt;data.bufflen
op_assign
id|SRpnt-&gt;sr_bufflen
suffix:semicolon
id|srp-&gt;data.buffer
op_assign
id|SRpnt-&gt;sr_buffer
suffix:semicolon
id|sg_clr_srpnt
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|srp-&gt;my_cmdp
op_assign
l_int|NULL
suffix:semicolon
id|srp-&gt;done
op_assign
l_int|1
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg...bh: dev=%d, pack_id=%d, res=0x%x&bslash;n&quot;
comma
id|dev
comma
id|srp-&gt;header.pack_id
comma
(paren
r_int
)paren
id|SRpnt-&gt;sr_result
)paren
)paren
suffix:semicolon
id|srp-&gt;header.resid
op_assign
id|SCpnt-&gt;resid
suffix:semicolon
multiline_comment|/* sg_unmap_and(&amp;srp-&gt;data, 0); */
multiline_comment|/* unmap locked pages a.s.a.p. */
multiline_comment|/* N.B. unit of duration changes here from jiffies to millisecs */
id|srp-&gt;header.duration
op_assign
id|sg_jif_to_ms
c_func
(paren
id|jiffies
op_minus
(paren
r_int
)paren
id|srp-&gt;header.duration
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|SRpnt-&gt;sr_result
)paren
(brace
id|memcpy
c_func
(paren
id|srp-&gt;sense_b
comma
id|SRpnt-&gt;sr_sense_buffer
comma
r_sizeof
(paren
id|srp-&gt;sense_b
)paren
)paren
suffix:semicolon
id|srp-&gt;header.status
op_assign
l_int|0xff
op_amp
id|SRpnt-&gt;sr_result
suffix:semicolon
id|srp-&gt;header.masked_status
op_assign
id|status_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
suffix:semicolon
id|srp-&gt;header.msg_status
op_assign
id|msg_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
suffix:semicolon
id|srp-&gt;header.host_status
op_assign
id|host_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
suffix:semicolon
id|srp-&gt;header.driver_status
op_assign
id|driver_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sdp-&gt;sgdebug
OG
l_int|0
)paren
op_logical_and
(paren
(paren
id|CHECK_CONDITION
op_eq
id|srp-&gt;header.masked_status
)paren
op_logical_or
(paren
id|COMMAND_TERMINATED
op_eq
id|srp-&gt;header.masked_status
)paren
)paren
)paren
id|print_req_sense
c_func
(paren
l_string|&quot;sg_cmd_done_bh&quot;
comma
id|SRpnt
)paren
suffix:semicolon
multiline_comment|/* Following if statement is a patch supplied by Eric Youngdale */
r_if
c_cond
(paren
id|driver_byte
c_func
(paren
id|SRpnt-&gt;sr_result
)paren
op_ne
l_int|0
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x7f
)paren
op_eq
l_int|0x70
op_logical_and
(paren
id|SRpnt-&gt;sr_sense_buffer
(braket
l_int|2
)braket
op_amp
l_int|0xf
)paren
op_eq
id|UNIT_ATTENTION
op_logical_and
id|sdp-&gt;device-&gt;removable
)paren
(brace
multiline_comment|/* Detected disc change. Set the bit - this may be used if */
multiline_comment|/* there are filesystems using this device. */
id|sdp-&gt;device-&gt;changed
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Rely on write phase to clean out srp status values, so no &quot;else&quot; */
id|scsi_release_request
c_func
(paren
id|SRpnt
)paren
suffix:semicolon
id|SRpnt
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;closed
)paren
(brace
multiline_comment|/* whoops this fd already released, cleanup */
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg...bh: already closed, freeing ...&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* should check if module is unloaded &lt;&lt;&lt;&lt;&lt;&lt;&lt; */
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
id|srp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sfp-&gt;headrp
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg...bh: already closed, final cleanup&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sg_remove_sfp
c_func
(paren
id|sdp
comma
id|sfp
)paren
suffix:semicolon
id|sfp
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|srp
op_logical_and
id|srp-&gt;orphan
)paren
(brace
r_if
c_cond
(paren
id|sfp-&gt;keep_orphan
)paren
id|srp-&gt;sg_io_owned
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
id|srp
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sfp
op_logical_and
id|srp
)paren
(brace
multiline_comment|/* Now wake up any sg_read() that is waiting for this packet. */
id|wake_up_interruptible
c_func
(paren
op_amp
id|sfp-&gt;read_wait
)paren
suffix:semicolon
id|kill_fasync
c_func
(paren
op_amp
id|sfp-&gt;async_qp
comma
id|SIGPOLL
comma
id|POLL_IN
)paren
suffix:semicolon
)brace
)brace
DECL|variable|sg_fops
r_static
r_struct
id|file_operations
id|sg_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|read
suffix:colon
id|sg_read
comma
id|write
suffix:colon
id|sg_write
comma
id|poll
suffix:colon
id|sg_poll
comma
id|ioctl
suffix:colon
id|sg_ioctl
comma
id|open
suffix:colon
id|sg_open
comma
id|release
suffix:colon
id|sg_release
comma
id|fasync
suffix:colon
id|sg_fasync
comma
)brace
suffix:semicolon
DECL|function|sg_detect
r_static
r_int
id|sg_detect
c_func
(paren
id|Scsi_Device
op_star
id|scsidp
)paren
(brace
r_switch
c_cond
(paren
id|scsidp-&gt;type
)paren
(brace
r_case
id|TYPE_DISK
suffix:colon
r_case
id|TYPE_MOD
suffix:colon
r_case
id|TYPE_ROM
suffix:colon
r_case
id|TYPE_WORM
suffix:colon
r_case
id|TYPE_TAPE
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Detected scsi generic sg%d at scsi%d,&quot;
l_string|&quot; channel %d, id %d, lun %d, type %d&bslash;n&quot;
comma
id|sg_template.dev_noticed
comma
id|scsidp-&gt;host-&gt;host_no
comma
id|scsidp-&gt;channel
comma
id|scsidp-&gt;id
comma
id|scsidp-&gt;lun
comma
id|scsidp-&gt;type
)paren
suffix:semicolon
)brace
id|sg_template.dev_noticed
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Driver initialization */
DECL|function|sg_init
r_static
r_int
id|sg_init
c_func
(paren
)paren
(brace
r_static
r_int
id|sg_registered
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sg_template.dev_noticed
op_eq
l_int|0
)paren
op_logical_or
id|sg_dev_arr
)paren
r_return
l_int|0
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sg_registered
)paren
(brace
r_if
c_cond
(paren
id|devfs_register_chrdev
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
l_string|&quot;sg&quot;
comma
op_amp
id|sg_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to get major %d for generic SCSI device&bslash;n&quot;
comma
id|SCSI_GENERIC_MAJOR
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|sg_registered
op_increment
suffix:semicolon
)brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_init&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sg_template.dev_max
op_assign
id|sg_template.dev_noticed
op_plus
id|SG_DEV_ARR_LUMP
suffix:semicolon
id|sg_dev_arr
op_assign
(paren
id|Sg_device
op_star
op_star
)paren
id|kmalloc
c_func
(paren
id|sg_template.dev_max
op_star
r_sizeof
(paren
id|Sg_device
op_star
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sg_dev_arr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;sg_init: no space for sg_dev_arr&bslash;n&quot;
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sg_dev_arr
comma
l_int|0
comma
id|sg_template.dev_max
op_star
r_sizeof
(paren
id|Sg_device
op_star
)paren
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|sg_proc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif  /* CONFIG_PROC_FS */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|sg_def_reserved_size_setup
r_static
r_int
id|__init
id|sg_def_reserved_size_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|tmp
)paren
op_eq
l_int|1
)paren
(brace
id|def_reserved_size
op_assign
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ge
l_int|0
)paren
id|sg_big_buff
op_assign
id|tmp
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;sg_def_reserved_size : usage sg_def_reserved_size=n &quot;
l_string|&quot;(n could be 65536, 131072 or 262144)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|__setup
c_func
(paren
l_string|&quot;sg_def_reserved_size=&quot;
comma
id|sg_def_reserved_size_setup
)paren
suffix:semicolon
macro_line|#endif
DECL|function|sg_attach
r_static
r_int
id|sg_attach
c_func
(paren
id|Scsi_Device
op_star
id|scsidp
)paren
(brace
id|Sg_device
op_star
id|sdp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_int
id|k
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_template.nr_dev
op_ge
id|sg_template.dev_max
)paren
(brace
multiline_comment|/* try to resize */
id|Sg_device
op_star
op_star
id|tmp_da
suffix:semicolon
r_int
id|tmp_dev_max
op_assign
id|sg_template.nr_dev
op_plus
id|SG_DEV_ARR_LUMP
suffix:semicolon
id|tmp_da
op_assign
(paren
id|Sg_device
op_star
op_star
)paren
id|kmalloc
c_func
(paren
id|tmp_dev_max
op_star
r_sizeof
(paren
id|Sg_device
op_star
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|tmp_da
)paren
(brace
id|scsidp-&gt;attached
op_decrement
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sg_attach: device array cannot be resized&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tmp_da
comma
l_int|0
comma
id|tmp_dev_max
op_star
r_sizeof
(paren
id|Sg_device
op_star
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tmp_da
comma
id|sg_dev_arr
comma
id|sg_template.dev_max
op_star
r_sizeof
(paren
id|Sg_device
op_star
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_char
op_star
)paren
id|sg_dev_arr
)paren
suffix:semicolon
id|sg_dev_arr
op_assign
id|tmp_da
suffix:semicolon
id|sg_template.dev_max
op_assign
id|tmp_dev_max
suffix:semicolon
)brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|sg_template.dev_max
suffix:semicolon
id|k
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|sg_dev_arr
(braket
id|k
)braket
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
OL
id|sg_template.dev_max
)paren
(brace
id|sdp
op_assign
(paren
id|Sg_device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|Sg_device
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
r_else
id|sdp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sdp
)paren
(brace
id|scsidp-&gt;attached
op_decrement
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sg_attach: Sg_device cannot be allocated&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_attach: dev=%d &bslash;n&quot;
comma
id|k
)paren
)paren
suffix:semicolon
id|sdp-&gt;device
op_assign
id|scsidp
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sdp-&gt;o_excl_wait
)paren
suffix:semicolon
id|sdp-&gt;headfp
op_assign
l_int|NULL
suffix:semicolon
id|sdp-&gt;exclude
op_assign
l_int|0
suffix:semicolon
id|sdp-&gt;sgdebug
op_assign
l_int|0
suffix:semicolon
id|sdp-&gt;detached
op_assign
l_int|0
suffix:semicolon
id|sdp-&gt;sg_tablesize
op_assign
id|scsidp-&gt;host
ques
c_cond
id|scsidp-&gt;host-&gt;sg_tablesize
suffix:colon
l_int|0
suffix:semicolon
id|sdp-&gt;i_rdev
op_assign
id|MKDEV
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
id|k
)paren
suffix:semicolon
id|sdp-&gt;de
op_assign
id|devfs_register
(paren
id|scsidp-&gt;de
comma
l_string|&quot;generic&quot;
comma
id|DEVFS_FL_DEFAULT
comma
id|SCSI_GENERIC_MAJOR
comma
id|k
comma
id|S_IFCHR
op_or
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
comma
op_amp
id|sg_fops
comma
l_int|NULL
)paren
suffix:semicolon
id|sg_template.nr_dev
op_increment
suffix:semicolon
id|sg_dev_arr
(braket
id|k
)braket
op_assign
id|sdp
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called at &squot;finish&squot; of init process, after all attaches */
DECL|function|sg_finish
r_static
r_void
id|sg_finish
c_func
(paren
r_void
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_finish: dma_free_sectors=%u&bslash;n&quot;
comma
id|scsi_dma_free_sectors
)paren
)paren
suffix:semicolon
)brace
DECL|function|sg_detach
r_static
r_void
id|sg_detach
c_func
(paren
id|Scsi_Device
op_star
id|scsidp
)paren
(brace
id|Sg_device
op_star
id|sdp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|Sg_fd
op_star
id|sfp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
id|k
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sg_dev_arr
)paren
r_return
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|sg_template.dev_max
suffix:semicolon
id|k
op_increment
)paren
(brace
id|sdp
op_assign
id|sg_dev_arr
(braket
id|k
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|NULL
op_eq
id|sdp
)paren
op_logical_or
(paren
id|sdp-&gt;device
op_ne
id|scsidp
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* dirty but lowers nesting */
r_if
c_cond
(paren
id|sdp-&gt;headfp
)paren
(brace
r_for
c_loop
(paren
id|sfp
op_assign
id|sdp-&gt;headfp
suffix:semicolon
id|sfp
suffix:semicolon
id|sfp
op_assign
id|sfp-&gt;nextfp
)paren
(brace
multiline_comment|/* no lock on request list here */
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|srp-&gt;done
)paren
(brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|sg_shorten_timeout
c_func
(paren
id|srp-&gt;my_cmdp
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
)brace
)brace
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_detach: dev=%d, dirty, sleep(3)&bslash;n&quot;
comma
id|k
)paren
)paren
suffix:semicolon
id|scsi_sleep
c_func
(paren
l_int|3
)paren
suffix:semicolon
multiline_comment|/* sleep 3 jiffies, hoping for timeout to go off */
id|devfs_unregister
(paren
id|sdp-&gt;de
)paren
suffix:semicolon
id|sdp-&gt;de
op_assign
l_int|NULL
suffix:semicolon
id|sdp-&gt;detached
op_assign
l_int|1
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
)brace
r_else
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_detach: dev=%d&bslash;n&quot;
comma
id|k
)paren
)paren
suffix:semicolon
id|devfs_unregister
(paren
id|sdp-&gt;de
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_char
op_star
)paren
id|sdp
)paren
suffix:semicolon
id|sg_dev_arr
(braket
id|k
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|scsidp-&gt;attached
op_decrement
suffix:semicolon
id|sg_template.nr_dev
op_decrement
suffix:semicolon
multiline_comment|/* avoid associated device /dev/sg? being incremented&n; * each time module is inserted/removed , &lt;dan@lectra.fr&gt; */
id|sg_template.dev_noticed
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Douglas Gilbert&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SCSI generic (sg) driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|def_reserved_size
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|def_reserved_size
comma
l_string|&quot;size of buffer reserved for each fd&quot;
)paren
suffix:semicolon
DECL|function|init_sg
r_static
r_int
id|__init
id|init_sg
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|def_reserved_size
op_ge
l_int|0
)paren
id|sg_big_buff
op_assign
id|def_reserved_size
suffix:semicolon
id|sg_template.module
op_assign
id|THIS_MODULE
suffix:semicolon
r_return
id|scsi_register_module
c_func
(paren
id|MODULE_SCSI_DEV
comma
op_amp
id|sg_template
)paren
suffix:semicolon
)brace
DECL|function|exit_sg
r_static
r_void
id|__exit
id|exit_sg
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS
id|sg_proc_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif  /* CONFIG_PROC_FS */
id|scsi_unregister_module
c_func
(paren
id|MODULE_SCSI_DEV
comma
op_amp
id|sg_template
)paren
suffix:semicolon
id|devfs_unregister_chrdev
c_func
(paren
id|SCSI_GENERIC_MAJOR
comma
l_string|&quot;sg&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_dev_arr
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Really worrying situation of writes still pending and get here */
multiline_comment|/* Strategy: shorten timeout on release + wait on detach ... */
id|kfree
c_func
(paren
(paren
r_char
op_star
)paren
id|sg_dev_arr
)paren
suffix:semicolon
id|sg_dev_arr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|sg_template.dev_max
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
r_extern
r_void
id|scsi_times_out
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
r_extern
r_void
id|scsi_old_times_out
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Can&squot;t see clean way to abort a command so shorten timeout to 1 jiffy */
DECL|function|sg_shorten_timeout
r_static
r_void
id|sg_shorten_timeout
c_func
(paren
id|Scsi_Request
op_star
id|srpnt
)paren
(brace
macro_line|#if 0 /* scsi_syms.c is very miserly about exported functions */
id|scsi_delete_timer
c_func
(paren
id|scpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scpnt
)paren
r_return
suffix:semicolon
id|scpnt-&gt;timeout_per_command
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* try 1 jiffy (perhaps 0 jiffies) */
r_if
c_cond
(paren
id|scpnt-&gt;host-&gt;hostt-&gt;use_new_eh_code
)paren
id|scsi_add_timer
c_func
(paren
id|scpnt
comma
id|scpnt-&gt;timeout_per_command
comma
id|scsi_times_out
)paren
suffix:semicolon
r_else
id|scsi_add_timer
c_func
(paren
id|scpnt
comma
id|scpnt-&gt;timeout_per_command
comma
id|scsi_old_times_out
)paren
suffix:semicolon
macro_line|#else
id|scsi_sleep
c_func
(paren
id|HZ
)paren
suffix:semicolon
multiline_comment|/* just sleep 1 second and hope ... */
macro_line|#endif
)brace
DECL|function|sg_start_req
r_static
r_int
id|sg_start_req
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
(brace
r_int
id|res
suffix:semicolon
id|Sg_fd
op_star
id|sfp
op_assign
id|srp-&gt;parentfp
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
r_int
id|dxfer_len
op_assign
(paren
r_int
)paren
id|hp-&gt;dxfer_len
suffix:semicolon
r_int
id|dxfer_dir
op_assign
id|hp-&gt;dxfer_direction
suffix:semicolon
id|Sg_scatter_hold
op_star
id|req_schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|Sg_scatter_hold
op_star
id|rsv_schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_start_req: dxfer_len=%d&bslash;n&quot;
comma
id|dxfer_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dxfer_len
op_le
l_int|0
)paren
op_logical_or
(paren
id|dxfer_dir
op_eq
id|SG_DXFER_NONE
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hp-&gt;flags
op_amp
id|SG_FLAG_DIRECT_IO
)paren
op_logical_and
(paren
id|dxfer_dir
op_ne
id|SG_DXFER_UNKNOWN
)paren
op_logical_and
(paren
l_int|0
op_eq
id|hp-&gt;iovec_count
)paren
op_logical_and
(paren
op_logical_neg
id|sfp-&gt;parentdp-&gt;device-&gt;host-&gt;unchecked_isa_dma
)paren
)paren
(brace
id|res
op_assign
id|sg_build_dir
c_func
(paren
id|srp
comma
id|sfp
comma
id|dxfer_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_le
l_int|0
)paren
multiline_comment|/* -ve -&gt; error, 0 -&gt; done, 1 -&gt; try indirect */
r_return
id|res
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|sg_res_in_use
c_func
(paren
id|sfp
)paren
)paren
op_logical_and
(paren
id|dxfer_len
op_le
id|rsv_schp-&gt;bufflen
)paren
)paren
(brace
id|sg_link_reserve
c_func
(paren
id|sfp
comma
id|srp
comma
id|dxfer_len
)paren
suffix:semicolon
)brace
r_else
(brace
id|res
op_assign
id|sg_build_indi
c_func
(paren
id|req_schp
comma
id|sfp
comma
id|dxfer_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|sg_remove_scat
c_func
(paren
id|req_schp
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_finish_rem_req
r_static
r_void
id|sg_finish_rem_req
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
(brace
id|Sg_fd
op_star
id|sfp
op_assign
id|srp-&gt;parentfp
suffix:semicolon
id|Sg_scatter_hold
op_star
id|req_schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_finish_rem_req: res_used=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|srp-&gt;res_used
)paren
)paren
suffix:semicolon
id|sg_unmap_and
c_func
(paren
op_amp
id|srp-&gt;data
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srp-&gt;res_used
)paren
id|sg_unlink_reserve
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
r_else
id|sg_remove_scat
c_func
(paren
id|req_schp
)paren
suffix:semicolon
id|sg_remove_request
c_func
(paren
id|sfp
comma
id|srp
)paren
suffix:semicolon
)brace
DECL|function|sg_build_sgat
r_static
r_int
id|sg_build_sgat
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
r_const
id|Sg_fd
op_star
id|sfp
)paren
(brace
r_int
id|mem_src
comma
id|ret_sz
suffix:semicolon
r_int
id|sg_bufflen
op_assign
id|PAGE_SIZE
suffix:semicolon
r_int
id|elem_sz
op_assign
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_plus
r_sizeof
(paren
r_char
)paren
suffix:semicolon
r_int
id|mx_sc_elems
op_assign
(paren
id|sg_bufflen
op_div
id|elem_sz
)paren
op_minus
l_int|1
suffix:semicolon
id|mem_src
op_assign
id|SG_HEAP_KMAL
suffix:semicolon
id|schp-&gt;buffer
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|sg_malloc
c_func
(paren
id|sfp
comma
id|sg_bufflen
comma
op_amp
id|ret_sz
comma
op_amp
id|mem_src
)paren
suffix:semicolon
id|schp-&gt;buffer_mem_src
op_assign
(paren
r_char
)paren
id|mem_src
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schp-&gt;buffer
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ret_sz
op_ne
id|sg_bufflen
)paren
(brace
id|sg_bufflen
op_assign
id|ret_sz
suffix:semicolon
id|mx_sc_elems
op_assign
(paren
id|sg_bufflen
op_div
id|elem_sz
)paren
op_minus
l_int|1
suffix:semicolon
)brace
id|schp-&gt;sglist_len
op_assign
id|sg_bufflen
suffix:semicolon
id|memset
c_func
(paren
id|schp-&gt;buffer
comma
l_int|0
comma
id|sg_bufflen
)paren
suffix:semicolon
r_return
id|mx_sc_elems
suffix:semicolon
multiline_comment|/* number of scat_gath elements allocated */
)brace
DECL|function|sg_unmap_and
r_static
r_void
id|sg_unmap_and
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
r_int
id|free_also
)paren
(brace
macro_line|#ifdef SG_ALLOW_DIO
r_if
c_cond
(paren
id|schp
op_logical_and
id|schp-&gt;kiobp
)paren
(brace
r_if
c_cond
(paren
id|schp-&gt;mapped
)paren
(brace
id|unmap_kiobuf
c_func
(paren
id|schp-&gt;kiobp
)paren
suffix:semicolon
id|schp-&gt;mapped
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|free_also
)paren
(brace
id|free_kiovec
c_func
(paren
l_int|1
comma
op_amp
id|schp-&gt;kiobp
)paren
suffix:semicolon
id|schp-&gt;kiobp
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
DECL|function|sg_build_dir
r_static
r_int
id|sg_build_dir
c_func
(paren
id|Sg_request
op_star
id|srp
comma
id|Sg_fd
op_star
id|sfp
comma
r_int
id|dxfer_len
)paren
(brace
macro_line|#ifdef SG_ALLOW_DIO
r_int
id|res
comma
id|k
comma
id|split
comma
id|offset
comma
id|num
comma
id|mx_sc_elems
comma
id|rem_sz
suffix:semicolon
r_struct
id|kiobuf
op_star
id|kp
suffix:semicolon
r_char
op_star
id|mem_src_arr
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sclp
suffix:semicolon
r_int
r_int
id|addr
comma
id|prev_addr
suffix:semicolon
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
r_int
id|sg_tablesize
op_assign
id|sfp-&gt;parentdp-&gt;sg_tablesize
suffix:semicolon
id|res
op_assign
id|alloc_kiovec
c_func
(paren
l_int|1
comma
op_amp
id|schp-&gt;kiobp
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|res
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_dir: alloc_kiovec res=%d&bslash;n&quot;
comma
id|res
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|res
op_assign
id|map_user_kiobuf
c_func
(paren
(paren
id|SG_DXFER_TO_DEV
op_eq
id|hp-&gt;dxfer_direction
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
id|schp-&gt;kiobp
comma
(paren
r_int
r_int
)paren
id|hp-&gt;dxferp
comma
id|dxfer_len
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|res
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_dir: map_user_kiobuf res=%d&bslash;n&quot;
comma
id|res
)paren
)paren
suffix:semicolon
id|sg_unmap_and
c_func
(paren
id|schp
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|schp-&gt;mapped
op_assign
l_int|1
suffix:semicolon
id|kp
op_assign
id|schp-&gt;kiobp
suffix:semicolon
id|prev_addr
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|kp-&gt;maplist
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|1
comma
id|split
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|kp-&gt;nr_pages
suffix:semicolon
op_increment
id|k
comma
id|prev_addr
op_assign
id|addr
)paren
(brace
id|addr
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|kp-&gt;maplist
(braket
id|k
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|prev_addr
op_plus
id|PAGE_SIZE
)paren
op_ne
id|addr
)paren
(brace
id|split
op_assign
id|k
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|split
)paren
(brace
id|schp-&gt;k_use_sg
op_assign
l_int|0
suffix:semicolon
id|schp-&gt;buffer
op_assign
id|page_address
c_func
(paren
id|kp-&gt;maplist
(braket
l_int|0
)braket
)paren
op_plus
id|kp-&gt;offset
suffix:semicolon
id|schp-&gt;bufflen
op_assign
id|dxfer_len
suffix:semicolon
id|schp-&gt;buffer_mem_src
op_assign
id|SG_USER_MEM
suffix:semicolon
id|schp-&gt;b_malloc_len
op_assign
id|dxfer_len
suffix:semicolon
id|hp-&gt;info
op_or_assign
id|SG_INFO_DIRECT_IO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mx_sc_elems
op_assign
id|sg_build_sgat
c_func
(paren
id|schp
comma
id|sfp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mx_sc_elems
op_le
l_int|1
)paren
(brace
id|sg_unmap_and
c_func
(paren
id|schp
comma
l_int|1
)paren
suffix:semicolon
id|sg_remove_scat
c_func
(paren
id|schp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mem_src_arr
op_assign
id|schp-&gt;buffer
op_plus
(paren
id|mx_sc_elems
op_star
r_sizeof
(paren
r_struct
id|scatterlist
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
comma
id|sclp
op_assign
id|schp-&gt;buffer
comma
id|rem_sz
op_assign
id|dxfer_len
suffix:semicolon
(paren
id|k
OL
id|sg_tablesize
)paren
op_logical_and
(paren
id|rem_sz
OG
l_int|0
)paren
op_logical_and
(paren
id|k
OL
id|mx_sc_elems
)paren
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
id|offset
op_assign
(paren
l_int|0
op_eq
id|k
)paren
ques
c_cond
id|kp-&gt;offset
suffix:colon
l_int|0
suffix:semicolon
id|num
op_assign
(paren
id|rem_sz
OG
(paren
id|PAGE_SIZE
op_minus
id|offset
)paren
)paren
ques
c_cond
(paren
id|PAGE_SIZE
op_minus
id|offset
)paren
suffix:colon
id|rem_sz
suffix:semicolon
id|sclp-&gt;address
op_assign
id|page_address
c_func
(paren
id|kp-&gt;maplist
(braket
id|k
)braket
)paren
op_plus
id|offset
suffix:semicolon
id|sclp-&gt;length
op_assign
id|num
suffix:semicolon
id|mem_src_arr
(braket
id|k
)braket
op_assign
id|SG_USER_MEM
suffix:semicolon
id|rem_sz
op_sub_assign
id|num
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_dir: k=%d, a=0x%p, len=%d, ms=%d&bslash;n&quot;
comma
id|k
comma
id|sclp-&gt;address
comma
id|num
comma
id|mem_src_arr
(braket
id|k
)braket
)paren
)paren
suffix:semicolon
)brace
id|schp-&gt;k_use_sg
op_assign
id|k
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_dir: k_use_sg=%d, rem_sz=%d&bslash;n&quot;
comma
id|k
comma
id|rem_sz
)paren
)paren
suffix:semicolon
id|schp-&gt;bufflen
op_assign
id|dxfer_len
suffix:semicolon
r_if
c_cond
(paren
id|rem_sz
OG
l_int|0
)paren
(brace
multiline_comment|/* must have failed */
id|sg_unmap_and
c_func
(paren
id|schp
comma
l_int|1
)paren
suffix:semicolon
id|sg_remove_scat
c_func
(paren
id|schp
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* out of scatter gather elements, try indirect */
)brace
id|hp-&gt;info
op_or_assign
id|SG_INFO_DIRECT_IO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
l_int|1
suffix:semicolon
macro_line|#endif /* SG_ALLOW_DIO */
)brace
DECL|function|sg_build_indi
r_static
r_int
id|sg_build_indi
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
comma
id|Sg_fd
op_star
id|sfp
comma
r_int
id|buff_size
)paren
(brace
r_int
id|ret_sz
comma
id|mem_src
suffix:semicolon
r_int
id|blk_size
op_assign
id|buff_size
suffix:semicolon
r_char
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|blk_size
OL
l_int|0
)paren
op_logical_or
(paren
op_logical_neg
id|sfp
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|blk_size
)paren
op_increment
id|blk_size
suffix:semicolon
multiline_comment|/* don&squot;t know why */
multiline_comment|/* round request up to next highest SG_SECTOR_SZ byte boundary */
id|blk_size
op_assign
(paren
id|blk_size
op_plus
id|SG_SECTOR_MSK
)paren
op_amp
(paren
op_complement
id|SG_SECTOR_MSK
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_indi: buff_size=%d, blk_size=%d&bslash;n&quot;
comma
id|buff_size
comma
id|blk_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blk_size
op_le
id|SG_SCATTER_SZ
)paren
(brace
id|mem_src
op_assign
id|SG_HEAP_PAGE
suffix:semicolon
id|p
op_assign
id|sg_malloc
c_func
(paren
id|sfp
comma
id|blk_size
comma
op_amp
id|ret_sz
comma
op_amp
id|mem_src
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|blk_size
op_eq
id|ret_sz
)paren
(brace
multiline_comment|/* got it on the first attempt */
id|schp-&gt;k_use_sg
op_assign
l_int|0
suffix:semicolon
id|schp-&gt;buffer
op_assign
id|p
suffix:semicolon
id|schp-&gt;bufflen
op_assign
id|blk_size
suffix:semicolon
id|schp-&gt;buffer_mem_src
op_assign
(paren
r_char
)paren
id|mem_src
suffix:semicolon
id|schp-&gt;b_malloc_len
op_assign
id|blk_size
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|mem_src
op_assign
id|SG_HEAP_PAGE
suffix:semicolon
id|p
op_assign
id|sg_malloc
c_func
(paren
id|sfp
comma
id|SG_SCATTER_SZ
comma
op_amp
id|ret_sz
comma
op_amp
id|mem_src
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Want some local declarations, so start new block ... */
(brace
multiline_comment|/* lets try and build a scatter gather list */
r_struct
id|scatterlist
op_star
id|sclp
suffix:semicolon
r_int
id|k
comma
id|rem_sz
comma
id|num
suffix:semicolon
r_int
id|mx_sc_elems
suffix:semicolon
r_int
id|sg_tablesize
op_assign
id|sfp-&gt;parentdp-&gt;sg_tablesize
suffix:semicolon
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_char
op_star
id|mem_src_arr
suffix:semicolon
multiline_comment|/* N.B. ret_sz and mem_src carried into this block ... */
id|mx_sc_elems
op_assign
id|sg_build_sgat
c_func
(paren
id|schp
comma
id|sfp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mx_sc_elems
OL
l_int|0
)paren
r_return
id|mx_sc_elems
suffix:semicolon
multiline_comment|/* most likely -ENOMEM */
id|mem_src_arr
op_assign
id|schp-&gt;buffer
op_plus
(paren
id|mx_sc_elems
op_star
r_sizeof
(paren
r_struct
id|scatterlist
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
comma
id|sclp
op_assign
id|schp-&gt;buffer
comma
id|rem_sz
op_assign
id|blk_size
suffix:semicolon
(paren
id|k
OL
id|sg_tablesize
)paren
op_logical_and
(paren
id|rem_sz
OG
l_int|0
)paren
op_logical_and
(paren
id|k
OL
id|mx_sc_elems
)paren
suffix:semicolon
op_increment
id|k
comma
id|rem_sz
op_sub_assign
id|ret_sz
comma
op_increment
id|sclp
)paren
(brace
r_if
c_cond
(paren
id|first
)paren
id|first
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|num
op_assign
(paren
id|rem_sz
OG
id|SG_SCATTER_SZ
)paren
ques
c_cond
id|SG_SCATTER_SZ
suffix:colon
id|rem_sz
suffix:semicolon
id|mem_src
op_assign
id|SG_HEAP_PAGE
suffix:semicolon
id|p
op_assign
id|sg_malloc
c_func
(paren
id|sfp
comma
id|num
comma
op_amp
id|ret_sz
comma
op_amp
id|mem_src
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_break
suffix:semicolon
)brace
id|sclp-&gt;address
op_assign
id|p
suffix:semicolon
id|sclp-&gt;length
op_assign
id|ret_sz
suffix:semicolon
id|mem_src_arr
(braket
id|k
)braket
op_assign
id|mem_src
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_build: k=%d, a=0x%p, len=%d, ms=%d&bslash;n&quot;
comma
id|k
comma
id|sclp-&gt;address
comma
id|ret_sz
comma
id|mem_src
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end of for loop */
id|schp-&gt;k_use_sg
op_assign
id|k
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_indi: k_use_sg=%d, rem_sz=%d&bslash;n&quot;
comma
id|k
comma
id|rem_sz
)paren
)paren
suffix:semicolon
id|schp-&gt;bufflen
op_assign
id|blk_size
suffix:semicolon
r_if
c_cond
(paren
id|rem_sz
OG
l_int|0
)paren
multiline_comment|/* must have failed */
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_write_xfer
r_static
r_int
id|sg_write_xfer
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
(brace
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
r_int
id|num_xfer
op_assign
l_int|0
suffix:semicolon
r_int
id|j
comma
id|k
comma
id|onum
comma
id|usglen
comma
id|ksglen
comma
id|res
comma
id|ok
suffix:semicolon
r_int
id|iovec_count
op_assign
(paren
r_int
)paren
id|hp-&gt;iovec_count
suffix:semicolon
r_int
id|dxfer_dir
op_assign
id|hp-&gt;dxfer_direction
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
r_char
op_star
id|up
suffix:semicolon
r_int
id|new_interface
op_assign
(paren
l_char|&squot;&bslash;0&squot;
op_eq
id|hp-&gt;interface_id
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SG_DXFER_UNKNOWN
op_eq
id|dxfer_dir
)paren
op_logical_or
(paren
id|SG_DXFER_TO_DEV
op_eq
id|dxfer_dir
)paren
op_logical_or
(paren
id|SG_DXFER_TO_FROM_DEV
op_eq
id|dxfer_dir
)paren
)paren
(brace
id|num_xfer
op_assign
(paren
r_int
)paren
(paren
id|new_interface
ques
c_cond
id|hp-&gt;dxfer_len
suffix:colon
id|hp-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|schp-&gt;bufflen
OL
id|num_xfer
)paren
id|num_xfer
op_assign
id|schp-&gt;bufflen
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|num_xfer
op_le
l_int|0
)paren
op_logical_or
(paren
id|new_interface
op_logical_and
(paren
id|SG_FLAG_NO_DXFER
op_amp
id|hp-&gt;flags
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_write_xfer: num_xfer=%d, iovec_count=%d, k_use_sg=%d&bslash;n&quot;
comma
id|num_xfer
comma
id|iovec_count
comma
id|schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iovec_count
)paren
(brace
id|onum
op_assign
id|iovec_count
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|hp-&gt;dxferp
comma
id|size_sg_iovec
op_star
id|onum
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
)brace
r_else
id|onum
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|schp-&gt;k_use_sg
)paren
(brace
multiline_comment|/* kernel has single buffer */
r_if
c_cond
(paren
id|SG_USER_MEM
op_ne
id|schp-&gt;buffer_mem_src
)paren
(brace
multiline_comment|/* else nothing to do */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|p
op_assign
id|schp-&gt;buffer
suffix:semicolon
id|j
OL
id|onum
suffix:semicolon
op_increment
id|j
)paren
(brace
id|res
op_assign
id|sg_u_iovec
c_func
(paren
id|hp
comma
id|iovec_count
comma
id|j
comma
l_int|1
comma
op_amp
id|usglen
comma
op_amp
id|up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
id|usglen
op_assign
(paren
id|num_xfer
OG
id|usglen
)paren
ques
c_cond
id|usglen
suffix:colon
id|num_xfer
suffix:semicolon
id|__copy_from_user
c_func
(paren
id|p
comma
id|up
comma
id|usglen
)paren
suffix:semicolon
id|p
op_add_assign
id|usglen
suffix:semicolon
id|num_xfer
op_sub_assign
id|usglen
suffix:semicolon
r_if
c_cond
(paren
id|num_xfer
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* kernel using scatter gather list */
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|schp-&gt;buffer
suffix:semicolon
r_char
op_star
id|mem_src_arr
op_assign
id|sg_get_sgat_msa
c_func
(paren
id|schp
)paren
suffix:semicolon
id|ksglen
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
suffix:semicolon
id|p
op_assign
id|sclp-&gt;address
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|k
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|onum
suffix:semicolon
op_increment
id|j
)paren
(brace
id|res
op_assign
id|sg_u_iovec
c_func
(paren
id|hp
comma
id|iovec_count
comma
id|j
comma
l_int|1
comma
op_amp
id|usglen
comma
op_amp
id|up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|k
OL
id|schp-&gt;k_use_sg
)paren
op_logical_and
id|p
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
comma
id|ksglen
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
comma
id|p
op_assign
id|sclp-&gt;address
)paren
(brace
id|ok
op_assign
(paren
id|SG_USER_MEM
op_ne
id|mem_src_arr
(braket
id|k
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usglen
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ksglen
OG
id|usglen
)paren
(brace
r_if
c_cond
(paren
id|usglen
op_ge
id|num_xfer
)paren
(brace
r_if
c_cond
(paren
id|ok
)paren
id|__copy_from_user
c_func
(paren
id|p
comma
id|up
comma
id|num_xfer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ok
)paren
id|__copy_from_user
c_func
(paren
id|p
comma
id|up
comma
id|usglen
)paren
suffix:semicolon
id|p
op_add_assign
id|usglen
suffix:semicolon
id|ksglen
op_sub_assign
id|usglen
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ksglen
op_ge
id|num_xfer
)paren
(brace
r_if
c_cond
(paren
id|ok
)paren
id|__copy_from_user
c_func
(paren
id|p
comma
id|up
comma
id|num_xfer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ok
)paren
id|__copy_from_user
c_func
(paren
id|p
comma
id|up
comma
id|ksglen
)paren
suffix:semicolon
id|up
op_add_assign
id|ksglen
suffix:semicolon
id|usglen
op_sub_assign
id|ksglen
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_u_iovec
r_static
r_int
id|sg_u_iovec
c_func
(paren
id|sg_io_hdr_t
op_star
id|hp
comma
r_int
id|sg_num
comma
r_int
id|ind
comma
r_int
id|wr_xf
comma
r_int
op_star
id|countp
comma
r_int
r_char
op_star
op_star
id|up
)paren
(brace
r_int
id|num_xfer
op_assign
(paren
r_int
)paren
id|hp-&gt;dxfer_len
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
id|count
comma
id|k
suffix:semicolon
id|sg_iovec_t
id|u_iovec
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|sg_num
)paren
(brace
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
id|hp-&gt;dxferp
suffix:semicolon
r_if
c_cond
(paren
id|wr_xf
op_logical_and
(paren
l_char|&squot;&bslash;0&squot;
op_eq
id|hp-&gt;interface_id
)paren
)paren
id|count
op_assign
(paren
r_int
)paren
id|hp-&gt;flags
suffix:semicolon
multiline_comment|/* holds &quot;old&quot; input_size */
r_else
id|count
op_assign
id|num_xfer
suffix:semicolon
)brace
r_else
(brace
id|__copy_from_user
c_func
(paren
op_amp
id|u_iovec
comma
(paren
r_int
r_char
op_star
)paren
id|hp-&gt;dxferp
op_plus
(paren
id|ind
op_star
id|size_sg_iovec
)paren
comma
id|size_sg_iovec
)paren
suffix:semicolon
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
id|u_iovec.iov_base
suffix:semicolon
id|count
op_assign
(paren
r_int
)paren
id|u_iovec.iov_len
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|wr_xf
ques
c_cond
id|VERIFY_READ
suffix:colon
id|VERIFY_WRITE
comma
id|p
comma
id|count
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
op_star
id|up
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
id|countp
)paren
op_star
id|countp
op_assign
id|count
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_get_sgat_msa
r_static
r_char
op_star
id|sg_get_sgat_msa
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
)paren
(brace
r_int
id|elem_sz
op_assign
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_plus
r_sizeof
(paren
r_char
)paren
suffix:semicolon
r_int
id|mx_sc_elems
op_assign
(paren
id|schp-&gt;sglist_len
op_div
id|elem_sz
)paren
op_minus
l_int|1
suffix:semicolon
r_return
id|schp-&gt;buffer
op_plus
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
id|mx_sc_elems
)paren
suffix:semicolon
)brace
DECL|function|sg_remove_scat
r_static
r_void
id|sg_remove_scat
c_func
(paren
id|Sg_scatter_hold
op_star
id|schp
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_remove_scat: k_use_sg=%d&bslash;n&quot;
comma
id|schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|schp-&gt;buffer
op_logical_and
id|schp-&gt;sglist_len
)paren
(brace
r_int
id|k
comma
id|mem_src
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|schp-&gt;buffer
suffix:semicolon
r_char
op_star
id|mem_src_arr
op_assign
id|sg_get_sgat_msa
c_func
(paren
id|schp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|k
OL
id|schp-&gt;k_use_sg
)paren
op_logical_and
id|sclp-&gt;address
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
id|mem_src
op_assign
id|mem_src_arr
(braket
id|k
)braket
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|5
comma
id|printk
c_func
(paren
l_string|&quot;sg_remove_scat: k=%d, a=0x%p, len=%d, ms=%d&bslash;n&quot;
comma
id|k
comma
id|sclp-&gt;address
comma
id|sclp-&gt;length
comma
id|mem_src
)paren
)paren
suffix:semicolon
id|sg_free
c_func
(paren
id|sclp-&gt;address
comma
id|sclp-&gt;length
comma
id|mem_src
)paren
suffix:semicolon
id|sclp-&gt;address
op_assign
l_int|NULL
suffix:semicolon
id|sclp-&gt;length
op_assign
l_int|0
suffix:semicolon
)brace
id|sg_free
c_func
(paren
id|schp-&gt;buffer
comma
id|schp-&gt;sglist_len
comma
id|schp-&gt;buffer_mem_src
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|schp-&gt;buffer
)paren
id|sg_free
c_func
(paren
id|schp-&gt;buffer
comma
id|schp-&gt;b_malloc_len
comma
id|schp-&gt;buffer_mem_src
)paren
suffix:semicolon
id|memset
c_func
(paren
id|schp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|schp
)paren
)paren
suffix:semicolon
)brace
DECL|function|sg_read_xfer
r_static
r_int
id|sg_read_xfer
c_func
(paren
id|Sg_request
op_star
id|srp
)paren
(brace
id|sg_io_hdr_t
op_star
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
r_int
id|num_xfer
op_assign
l_int|0
suffix:semicolon
r_int
id|j
comma
id|k
comma
id|onum
comma
id|usglen
comma
id|ksglen
comma
id|res
comma
id|ok
suffix:semicolon
r_int
id|iovec_count
op_assign
(paren
r_int
)paren
id|hp-&gt;iovec_count
suffix:semicolon
r_int
id|dxfer_dir
op_assign
id|hp-&gt;dxfer_direction
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
r_char
op_star
id|up
suffix:semicolon
r_int
id|new_interface
op_assign
(paren
l_char|&squot;&bslash;0&squot;
op_eq
id|hp-&gt;interface_id
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SG_DXFER_UNKNOWN
op_eq
id|dxfer_dir
)paren
op_logical_or
(paren
id|SG_DXFER_FROM_DEV
op_eq
id|dxfer_dir
)paren
op_logical_or
(paren
id|SG_DXFER_TO_FROM_DEV
op_eq
id|dxfer_dir
)paren
)paren
(brace
id|num_xfer
op_assign
id|hp-&gt;dxfer_len
suffix:semicolon
r_if
c_cond
(paren
id|schp-&gt;bufflen
OL
id|num_xfer
)paren
id|num_xfer
op_assign
id|schp-&gt;bufflen
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|num_xfer
op_le
l_int|0
)paren
op_logical_or
(paren
id|new_interface
op_logical_and
(paren
id|SG_FLAG_NO_DXFER
op_amp
id|hp-&gt;flags
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_read_xfer: num_xfer=%d, iovec_count=%d, k_use_sg=%d&bslash;n&quot;
comma
id|num_xfer
comma
id|iovec_count
comma
id|schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iovec_count
)paren
(brace
id|onum
op_assign
id|iovec_count
suffix:semicolon
r_if
c_cond
(paren
(paren
id|k
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|hp-&gt;dxferp
comma
id|size_sg_iovec
op_star
id|onum
)paren
)paren
)paren
r_return
id|k
suffix:semicolon
)brace
r_else
id|onum
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|schp-&gt;k_use_sg
)paren
(brace
multiline_comment|/* kernel has single buffer */
r_if
c_cond
(paren
id|SG_USER_MEM
op_ne
id|schp-&gt;buffer_mem_src
)paren
(brace
multiline_comment|/* else nothing to do */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|p
op_assign
id|schp-&gt;buffer
suffix:semicolon
id|j
OL
id|onum
suffix:semicolon
op_increment
id|j
)paren
(brace
id|res
op_assign
id|sg_u_iovec
c_func
(paren
id|hp
comma
id|iovec_count
comma
id|j
comma
l_int|0
comma
op_amp
id|usglen
comma
op_amp
id|up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
id|usglen
op_assign
(paren
id|num_xfer
OG
id|usglen
)paren
ques
c_cond
id|usglen
suffix:colon
id|num_xfer
suffix:semicolon
id|__copy_to_user
c_func
(paren
id|up
comma
id|p
comma
id|usglen
)paren
suffix:semicolon
id|p
op_add_assign
id|usglen
suffix:semicolon
id|num_xfer
op_sub_assign
id|usglen
suffix:semicolon
r_if
c_cond
(paren
id|num_xfer
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* kernel using scatter gather list */
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|schp-&gt;buffer
suffix:semicolon
r_char
op_star
id|mem_src_arr
op_assign
id|sg_get_sgat_msa
c_func
(paren
id|schp
)paren
suffix:semicolon
id|ksglen
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
suffix:semicolon
id|p
op_assign
id|sclp-&gt;address
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|k
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|onum
suffix:semicolon
op_increment
id|j
)paren
(brace
id|res
op_assign
id|sg_u_iovec
c_func
(paren
id|hp
comma
id|iovec_count
comma
id|j
comma
l_int|0
comma
op_amp
id|usglen
comma
op_amp
id|up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|k
OL
id|schp-&gt;k_use_sg
)paren
op_logical_and
id|p
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
comma
id|ksglen
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
comma
id|p
op_assign
id|sclp-&gt;address
)paren
(brace
id|ok
op_assign
(paren
id|SG_USER_MEM
op_ne
id|mem_src_arr
(braket
id|k
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usglen
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ksglen
OG
id|usglen
)paren
(brace
r_if
c_cond
(paren
id|usglen
op_ge
id|num_xfer
)paren
(brace
r_if
c_cond
(paren
id|ok
)paren
id|__copy_to_user
c_func
(paren
id|up
comma
id|p
comma
id|num_xfer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ok
)paren
id|__copy_to_user
c_func
(paren
id|up
comma
id|p
comma
id|usglen
)paren
suffix:semicolon
id|p
op_add_assign
id|usglen
suffix:semicolon
id|ksglen
op_sub_assign
id|usglen
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ksglen
op_ge
id|num_xfer
)paren
(brace
r_if
c_cond
(paren
id|ok
)paren
id|__copy_to_user
c_func
(paren
id|up
comma
id|p
comma
id|num_xfer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ok
)paren
id|__copy_to_user
c_func
(paren
id|up
comma
id|p
comma
id|ksglen
)paren
suffix:semicolon
id|up
op_add_assign
id|ksglen
suffix:semicolon
id|usglen
op_sub_assign
id|ksglen
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_read_oxfer
r_static
r_void
id|sg_read_oxfer
c_func
(paren
id|Sg_request
op_star
id|srp
comma
r_char
op_star
id|outp
comma
r_int
id|num_read_xfer
)paren
(brace
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_read_oxfer: num_read_xfer=%d&bslash;n&quot;
comma
id|num_read_xfer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|outp
)paren
op_logical_or
(paren
id|num_read_xfer
op_le
l_int|0
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|schp-&gt;k_use_sg
OG
l_int|0
)paren
(brace
r_int
id|k
comma
id|num
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|schp-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|k
OL
id|schp-&gt;k_use_sg
)paren
op_logical_and
id|sclp-&gt;address
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
id|num
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
suffix:semicolon
r_if
c_cond
(paren
id|num
OG
id|num_read_xfer
)paren
(brace
id|__copy_to_user
c_func
(paren
id|outp
comma
id|sclp-&gt;address
comma
id|num_read_xfer
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|__copy_to_user
c_func
(paren
id|outp
comma
id|sclp-&gt;address
comma
id|num
)paren
suffix:semicolon
id|num_read_xfer
op_sub_assign
id|num
suffix:semicolon
r_if
c_cond
(paren
id|num_read_xfer
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|outp
op_add_assign
id|num
suffix:semicolon
)brace
)brace
)brace
r_else
id|__copy_to_user
c_func
(paren
id|outp
comma
id|schp-&gt;buffer
comma
id|num_read_xfer
)paren
suffix:semicolon
)brace
DECL|function|sg_build_reserve
r_static
r_void
id|sg_build_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|req_size
)paren
(brace
id|Sg_scatter_hold
op_star
id|schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_build_reserve: req_size=%d&bslash;n&quot;
comma
id|req_size
)paren
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|req_size
OL
id|PAGE_SIZE
)paren
id|req_size
op_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|sg_build_indi
c_func
(paren
id|schp
comma
id|sfp
comma
id|req_size
)paren
)paren
r_return
suffix:semicolon
r_else
id|sg_remove_scat
c_func
(paren
id|schp
)paren
suffix:semicolon
id|req_size
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* divide by 2 */
)brace
r_while
c_loop
(paren
id|req_size
OG
(paren
id|PAGE_SIZE
op_div
l_int|2
)paren
)paren
suffix:semicolon
)brace
DECL|function|sg_link_reserve
r_static
r_void
id|sg_link_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
comma
r_int
id|size
)paren
(brace
id|Sg_scatter_hold
op_star
id|req_schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|Sg_scatter_hold
op_star
id|rsv_schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
id|srp-&gt;res_used
op_assign
l_int|1
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_link_reserve: size=%d&bslash;n&quot;
comma
id|size
)paren
)paren
suffix:semicolon
id|size
op_assign
(paren
id|size
op_plus
l_int|1
)paren
op_amp
(paren
op_complement
l_int|1
)paren
suffix:semicolon
multiline_comment|/* round to even for aha1542 */
r_if
c_cond
(paren
id|rsv_schp-&gt;k_use_sg
OG
l_int|0
)paren
(brace
r_int
id|k
comma
id|num
suffix:semicolon
r_int
id|rem
op_assign
id|size
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|rsv_schp-&gt;buffer
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|rsv_schp-&gt;k_use_sg
suffix:semicolon
op_increment
id|k
comma
op_increment
id|sclp
)paren
(brace
id|num
op_assign
(paren
r_int
)paren
id|sclp-&gt;length
suffix:semicolon
r_if
c_cond
(paren
id|rem
op_le
id|num
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|k
)paren
(brace
id|req_schp-&gt;k_use_sg
op_assign
l_int|0
suffix:semicolon
id|req_schp-&gt;buffer
op_assign
id|sclp-&gt;address
suffix:semicolon
)brace
r_else
(brace
id|sfp-&gt;save_scat_len
op_assign
id|num
suffix:semicolon
id|sclp-&gt;length
op_assign
(paren
r_int
)paren
id|rem
suffix:semicolon
id|req_schp-&gt;k_use_sg
op_assign
id|k
op_plus
l_int|1
suffix:semicolon
id|req_schp-&gt;sglist_len
op_assign
id|rsv_schp-&gt;sglist_len
suffix:semicolon
id|req_schp-&gt;buffer
op_assign
id|rsv_schp-&gt;buffer
suffix:semicolon
)brace
id|req_schp-&gt;bufflen
op_assign
id|size
suffix:semicolon
id|req_schp-&gt;buffer_mem_src
op_assign
id|rsv_schp-&gt;buffer_mem_src
suffix:semicolon
id|req_schp-&gt;b_malloc_len
op_assign
id|rsv_schp-&gt;b_malloc_len
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|rem
op_sub_assign
id|num
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
op_ge
id|rsv_schp-&gt;k_use_sg
)paren
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_link_reserve: BAD size&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|req_schp-&gt;k_use_sg
op_assign
l_int|0
suffix:semicolon
id|req_schp-&gt;bufflen
op_assign
id|size
suffix:semicolon
id|req_schp-&gt;buffer
op_assign
id|rsv_schp-&gt;buffer
suffix:semicolon
id|req_schp-&gt;buffer_mem_src
op_assign
id|rsv_schp-&gt;buffer_mem_src
suffix:semicolon
id|req_schp-&gt;b_malloc_len
op_assign
id|rsv_schp-&gt;b_malloc_len
suffix:semicolon
)brace
)brace
DECL|function|sg_unlink_reserve
r_static
r_void
id|sg_unlink_reserve
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
)paren
(brace
id|Sg_scatter_hold
op_star
id|req_schp
op_assign
op_amp
id|srp-&gt;data
suffix:semicolon
id|Sg_scatter_hold
op_star
id|rsv_schp
op_assign
op_amp
id|sfp-&gt;reserve
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|4
comma
id|printk
c_func
(paren
l_string|&quot;sg_unlink_reserve: req-&gt;k_use_sg=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|req_schp-&gt;k_use_sg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rsv_schp-&gt;k_use_sg
OG
l_int|0
)paren
op_logical_and
(paren
id|req_schp-&gt;k_use_sg
OG
l_int|0
)paren
)paren
(brace
r_struct
id|scatterlist
op_star
id|sclp
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|rsv_schp-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;save_scat_len
OG
l_int|0
)paren
(paren
id|sclp
op_plus
(paren
id|req_schp-&gt;k_use_sg
op_minus
l_int|1
)paren
)paren
op_member_access_from_pointer
id|length
op_assign
(paren
r_int
)paren
id|sfp-&gt;save_scat_len
suffix:semicolon
r_else
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_unlink_reserve: BAD save_scat_len&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|req_schp-&gt;k_use_sg
op_assign
l_int|0
suffix:semicolon
id|req_schp-&gt;bufflen
op_assign
l_int|0
suffix:semicolon
id|req_schp-&gt;buffer
op_assign
l_int|NULL
suffix:semicolon
id|req_schp-&gt;sglist_len
op_assign
l_int|0
suffix:semicolon
id|sfp-&gt;save_scat_len
op_assign
l_int|0
suffix:semicolon
id|srp-&gt;res_used
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|sg_get_rq_mark
r_static
id|Sg_request
op_star
id|sg_get_rq_mark
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|pack_id
)paren
(brace
id|Sg_request
op_star
id|resp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|resp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|resp
suffix:semicolon
id|resp
op_assign
id|resp-&gt;nextrp
)paren
(brace
multiline_comment|/* look for requests that are ready + not SG_IO owned */
r_if
c_cond
(paren
(paren
l_int|1
op_eq
id|resp-&gt;done
)paren
op_logical_and
(paren
op_logical_neg
id|resp-&gt;sg_io_owned
)paren
op_logical_and
(paren
(paren
op_minus
l_int|1
op_eq
id|pack_id
)paren
op_logical_or
(paren
id|resp-&gt;header.pack_id
op_eq
id|pack_id
)paren
)paren
)paren
(brace
id|resp-&gt;done
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* guard against other readers */
r_break
suffix:semicolon
)brace
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|sg_get_nth_request
r_static
id|Sg_request
op_star
id|sg_get_nth_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
r_int
id|nth
)paren
(brace
id|Sg_request
op_star
id|resp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_int
id|k
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
comma
id|resp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|resp
op_logical_and
(paren
id|k
OL
id|nth
)paren
suffix:semicolon
op_increment
id|k
comma
id|resp
op_assign
id|resp-&gt;nextrp
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* always adds to end of list */
DECL|function|sg_add_request
r_static
id|Sg_request
op_star
id|sg_add_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
(brace
r_int
id|k
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|Sg_request
op_star
id|resp
suffix:semicolon
id|Sg_request
op_star
id|rp
op_assign
id|sfp-&gt;req_arr
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|resp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|resp
)paren
(brace
id|memset
c_func
(paren
id|rp
comma
l_int|0
comma
r_sizeof
(paren
id|Sg_request
)paren
)paren
suffix:semicolon
id|rp-&gt;parentfp
op_assign
id|sfp
suffix:semicolon
id|resp
op_assign
id|rp
suffix:semicolon
id|sfp-&gt;headrp
op_assign
id|resp
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|sfp-&gt;cmd_q
)paren
id|resp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* command queuing disallowed */
r_else
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|SG_MAX_QUEUE
suffix:semicolon
op_increment
id|k
comma
op_increment
id|rp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rp-&gt;parentfp
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
OL
id|SG_MAX_QUEUE
)paren
(brace
id|memset
c_func
(paren
id|rp
comma
l_int|0
comma
r_sizeof
(paren
id|Sg_request
)paren
)paren
suffix:semicolon
id|rp-&gt;parentfp
op_assign
id|sfp
suffix:semicolon
r_while
c_loop
(paren
id|resp-&gt;nextrp
)paren
id|resp
op_assign
id|resp-&gt;nextrp
suffix:semicolon
id|resp-&gt;nextrp
op_assign
id|rp
suffix:semicolon
id|resp
op_assign
id|rp
suffix:semicolon
)brace
r_else
id|resp
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|resp
)paren
(brace
id|resp-&gt;nextrp
op_assign
l_int|NULL
suffix:semicolon
id|resp-&gt;header.duration
op_assign
id|jiffies
suffix:semicolon
id|resp-&gt;my_cmdp
op_assign
l_int|NULL
suffix:semicolon
id|resp-&gt;data.kiobp
op_assign
l_int|NULL
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
multiline_comment|/* Return of 1 for found; 0 for not found */
DECL|function|sg_remove_request
r_static
r_int
id|sg_remove_request
c_func
(paren
id|Sg_fd
op_star
id|sfp
comma
id|Sg_request
op_star
id|srp
)paren
(brace
id|Sg_request
op_star
id|prev_rp
suffix:semicolon
id|Sg_request
op_star
id|rp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|sfp
)paren
op_logical_or
(paren
op_logical_neg
id|srp
)paren
op_logical_or
(paren
op_logical_neg
id|sfp-&gt;headrp
)paren
)paren
r_return
id|res
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
id|prev_rp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
r_if
c_cond
(paren
id|srp
op_eq
id|prev_rp
)paren
(brace
id|sfp-&gt;headrp
op_assign
id|prev_rp-&gt;nextrp
suffix:semicolon
id|prev_rp-&gt;parentfp
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
(paren
id|rp
op_assign
id|prev_rp-&gt;nextrp
)paren
)paren
(brace
r_if
c_cond
(paren
id|srp
op_eq
id|rp
)paren
(brace
id|prev_rp-&gt;nextrp
op_assign
id|rp-&gt;nextrp
suffix:semicolon
id|rp-&gt;parentfp
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|prev_rp
op_assign
id|rp
suffix:semicolon
)brace
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|sg_get_nth_sfp
r_static
id|Sg_fd
op_star
id|sg_get_nth_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
r_int
id|nth
)paren
(brace
id|Sg_fd
op_star
id|resp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_int
id|k
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
comma
id|resp
op_assign
id|sdp-&gt;headfp
suffix:semicolon
id|resp
op_logical_and
(paren
id|k
OL
id|nth
)paren
suffix:semicolon
op_increment
id|k
comma
id|resp
op_assign
id|resp-&gt;nextfp
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
macro_line|#endif
DECL|function|sg_add_sfp
r_static
id|Sg_fd
op_star
id|sg_add_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
r_int
id|dev
)paren
(brace
id|Sg_fd
op_star
id|sfp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|sfp
op_assign
(paren
id|Sg_fd
op_star
)paren
id|sg_low_malloc
c_func
(paren
r_sizeof
(paren
id|Sg_fd
)paren
comma
l_int|0
comma
id|SG_HEAP_KMAL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sfp
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|sfp
comma
l_int|0
comma
r_sizeof
(paren
id|Sg_fd
)paren
)paren
suffix:semicolon
id|sfp-&gt;fd_mem_src
op_assign
id|SG_HEAP_KMAL
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sfp-&gt;read_wait
)paren
suffix:semicolon
id|sfp-&gt;rq_list_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
id|sfp-&gt;timeout
op_assign
id|SG_DEFAULT_TIMEOUT
suffix:semicolon
id|sfp-&gt;force_packid
op_assign
id|SG_DEF_FORCE_PACK_ID
suffix:semicolon
id|sfp-&gt;low_dma
op_assign
(paren
id|SG_DEF_FORCE_LOW_DMA
op_eq
l_int|0
)paren
ques
c_cond
id|sdp-&gt;device-&gt;host-&gt;unchecked_isa_dma
suffix:colon
l_int|1
suffix:semicolon
id|sfp-&gt;cmd_q
op_assign
id|SG_DEF_COMMAND_Q
suffix:semicolon
id|sfp-&gt;keep_orphan
op_assign
id|SG_DEF_KEEP_ORPHAN
suffix:semicolon
id|sfp-&gt;parentdp
op_assign
id|sdp
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sdp-&gt;headfp
)paren
id|sdp-&gt;headfp
op_assign
id|sfp
suffix:semicolon
r_else
(brace
multiline_comment|/* add to tail of existing list */
id|Sg_fd
op_star
id|pfp
op_assign
id|sdp-&gt;headfp
suffix:semicolon
r_while
c_loop
(paren
id|pfp-&gt;nextfp
)paren
id|pfp
op_assign
id|pfp-&gt;nextfp
suffix:semicolon
id|pfp-&gt;nextfp
op_assign
id|sfp
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_add_sfp: sfp=0x%p, m_s=%d&bslash;n&quot;
comma
id|sfp
comma
(paren
r_int
)paren
id|sfp-&gt;fd_mem_src
)paren
)paren
suffix:semicolon
id|sg_build_reserve
c_func
(paren
id|sfp
comma
id|sg_big_buff
)paren
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;sg_add_sfp:   bufflen=%d, k_use_sg=%d&bslash;n&quot;
comma
id|sfp-&gt;reserve.bufflen
comma
id|sfp-&gt;reserve.k_use_sg
)paren
)paren
suffix:semicolon
r_return
id|sfp
suffix:semicolon
)brace
DECL|function|sg_remove_sfp
r_static
r_int
id|sg_remove_sfp
c_func
(paren
id|Sg_device
op_star
id|sdp
comma
id|Sg_fd
op_star
id|sfp
)paren
(brace
id|Sg_request
op_star
id|srp
suffix:semicolon
id|Sg_request
op_star
id|tsrp
suffix:semicolon
r_int
id|dirty
op_assign
l_int|0
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
r_if
c_cond
(paren
id|srp
)paren
(brace
r_while
c_loop
(paren
id|srp
)paren
(brace
id|tsrp
op_assign
id|srp-&gt;nextrp
suffix:semicolon
r_if
c_cond
(paren
id|srp-&gt;done
)paren
id|sg_finish_rem_req
c_func
(paren
id|srp
)paren
suffix:semicolon
r_else
op_increment
id|dirty
suffix:semicolon
id|srp
op_assign
id|tsrp
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|dirty
)paren
(brace
id|Sg_fd
op_star
id|fp
suffix:semicolon
id|Sg_fd
op_star
id|prev_fp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
id|prev_fp
op_assign
id|sdp-&gt;headfp
suffix:semicolon
r_if
c_cond
(paren
id|sfp
op_eq
id|prev_fp
)paren
id|sdp-&gt;headfp
op_assign
id|prev_fp-&gt;nextfp
suffix:semicolon
r_else
(brace
r_while
c_loop
(paren
(paren
id|fp
op_assign
id|prev_fp-&gt;nextfp
)paren
)paren
(brace
r_if
c_cond
(paren
id|sfp
op_eq
id|fp
)paren
(brace
id|prev_fp-&gt;nextfp
op_assign
id|fp-&gt;nextfp
suffix:semicolon
r_break
suffix:semicolon
)brace
id|prev_fp
op_assign
id|fp
suffix:semicolon
)brace
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sfp-&gt;reserve.bufflen
OG
l_int|0
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|6
comma
id|printk
c_func
(paren
l_string|&quot;sg_remove_sfp:    bufflen=%d, k_use_sg=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|sfp-&gt;reserve.bufflen
comma
(paren
r_int
)paren
id|sfp-&gt;reserve.k_use_sg
)paren
)paren
suffix:semicolon
id|sg_remove_scat
c_func
(paren
op_amp
id|sfp-&gt;reserve
)paren
suffix:semicolon
)brace
id|sfp-&gt;parentdp
op_assign
l_int|NULL
suffix:semicolon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|6
comma
id|printk
c_func
(paren
l_string|&quot;sg_remove_sfp:    sfp=0x%p&bslash;n&quot;
comma
id|sfp
)paren
)paren
suffix:semicolon
id|sg_low_free
c_func
(paren
(paren
r_char
op_star
)paren
id|sfp
comma
r_sizeof
(paren
id|Sg_fd
)paren
comma
id|sfp-&gt;fd_mem_src
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp-&gt;detached
op_logical_and
(paren
l_int|NULL
op_eq
id|sdp-&gt;headfp
)paren
)paren
(brace
r_int
id|k
comma
id|maxd
suffix:semicolon
id|maxd
op_assign
id|sg_template.dev_max
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|maxd
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
id|sdp
op_eq
id|sg_dev_arr
(braket
id|k
)braket
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
OL
id|maxd
)paren
id|sg_dev_arr
(braket
id|k
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_char
op_star
)paren
id|sdp
)paren
suffix:semicolon
)brace
id|res
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|sfp-&gt;closed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* flag dirty state on this fd */
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_remove_sfp: worrisome, %d writes pending&bslash;n&quot;
comma
id|dirty
)paren
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|sg_res_in_use
r_static
r_int
id|sg_res_in_use
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
(brace
r_const
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
r_if
c_cond
(paren
id|srp-&gt;res_used
)paren
r_break
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|srp
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|sg_dio_in_use
r_static
r_int
id|sg_dio_in_use
c_func
(paren
id|Sg_fd
op_star
id|sfp
)paren
(brace
r_const
id|Sg_request
op_star
id|srp
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|srp
op_assign
id|sfp-&gt;headrp
suffix:semicolon
id|srp
suffix:semicolon
id|srp
op_assign
id|srp-&gt;nextrp
)paren
r_if
c_cond
(paren
(paren
op_logical_neg
id|srp-&gt;done
)paren
op_logical_and
id|srp-&gt;data.kiobp
)paren
r_break
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sfp-&gt;rq_list_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|srp
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* If retSzp==NULL want exact size or fail */
multiline_comment|/* sg_low_malloc() should always be called from a process context allowing&n;   GFP_KERNEL to be used instead of GFP_ATOMIC */
DECL|function|sg_low_malloc
r_static
r_char
op_star
id|sg_low_malloc
c_func
(paren
r_int
id|rqSz
comma
r_int
id|lowDma
comma
r_int
id|mem_src
comma
r_int
op_star
id|retSzp
)paren
(brace
r_char
op_star
id|resp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|page_mask
op_assign
id|lowDma
ques
c_cond
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:colon
id|GFP_KERNEL
suffix:semicolon
r_if
c_cond
(paren
id|rqSz
op_le
l_int|0
)paren
r_return
id|resp
suffix:semicolon
r_if
c_cond
(paren
id|SG_HEAP_KMAL
op_eq
id|mem_src
)paren
(brace
id|page_mask
op_assign
id|lowDma
ques
c_cond
(paren
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:colon
id|GFP_ATOMIC
suffix:semicolon
multiline_comment|/* Seen kmalloc(..,GFP_KERNEL) hang for 40 secs! */
id|resp
op_assign
id|kmalloc
c_func
(paren
id|rqSz
comma
id|page_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resp
op_logical_and
id|retSzp
)paren
op_star
id|retSzp
op_assign
id|rqSz
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SG_HEAP_POOL
op_eq
id|mem_src
)paren
(brace
r_int
id|num_sect
op_assign
id|rqSz
op_div
id|SG_SECTOR_SZ
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|rqSz
op_amp
id|SG_SECTOR_MSK
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|retSzp
)paren
r_return
id|resp
suffix:semicolon
op_increment
id|num_sect
suffix:semicolon
id|rqSz
op_assign
id|num_sect
op_star
id|SG_SECTOR_SZ
suffix:semicolon
)brace
r_while
c_loop
(paren
id|num_sect
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|num_sect
op_le
id|sg_pool_secs_avail
)paren
op_logical_and
(paren
id|scsi_dma_free_sectors
OG
(paren
id|SG_LOW_POOL_THRESHHOLD
op_plus
id|num_sect
)paren
)paren
)paren
(brace
id|resp
op_assign
id|scsi_malloc
c_func
(paren
id|rqSz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resp
)paren
(brace
r_if
c_cond
(paren
id|retSzp
)paren
op_star
id|retSzp
op_assign
id|rqSz
suffix:semicolon
id|sg_pool_secs_avail
op_sub_assign
id|num_sect
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|retSzp
)paren
r_return
id|resp
suffix:semicolon
id|num_sect
op_div_assign
l_int|2
suffix:semicolon
multiline_comment|/* try half as many */
id|rqSz
op_assign
id|num_sect
op_star
id|SG_SECTOR_SZ
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|SG_HEAP_PAGE
op_eq
id|mem_src
)paren
(brace
r_int
id|order
comma
id|a_size
suffix:semicolon
r_int
id|resSz
op_assign
id|rqSz
suffix:semicolon
r_for
c_loop
(paren
id|order
op_assign
l_int|0
comma
id|a_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|a_size
OL
id|rqSz
suffix:semicolon
id|order
op_increment
comma
id|a_size
op_lshift_assign
l_int|1
)paren
suffix:semicolon
id|resp
op_assign
(paren
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|page_mask
comma
id|order
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
id|resp
)paren
op_logical_and
id|order
op_logical_and
id|retSzp
)paren
(brace
op_decrement
id|order
suffix:semicolon
id|a_size
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* divide by 2, until PAGE_SIZE */
id|resp
op_assign
(paren
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|page_mask
comma
id|order
)paren
suffix:semicolon
multiline_comment|/* try half */
id|resSz
op_assign
id|a_size
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retSzp
)paren
op_star
id|retSzp
op_assign
id|resSz
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;sg_low_malloc: bad mem_src=%d, rqSz=%df&bslash;n&quot;
comma
id|mem_src
comma
id|rqSz
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
DECL|function|sg_malloc
r_static
r_char
op_star
id|sg_malloc
c_func
(paren
r_const
id|Sg_fd
op_star
id|sfp
comma
r_int
id|size
comma
r_int
op_star
id|retSzp
comma
r_int
op_star
id|mem_srcp
)paren
(brace
r_char
op_star
id|resp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|retSzp
)paren
op_star
id|retSzp
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
)paren
suffix:semicolon
r_else
(brace
r_int
id|low_dma
op_assign
id|sfp-&gt;low_dma
suffix:semicolon
r_int
id|l_ms
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* invalid value */
r_switch
c_cond
(paren
op_star
id|mem_srcp
)paren
(brace
r_case
id|SG_HEAP_PAGE
suffix:colon
id|l_ms
op_assign
(paren
id|size
OL
id|PAGE_SIZE
)paren
ques
c_cond
id|SG_HEAP_POOL
suffix:colon
id|SG_HEAP_PAGE
suffix:semicolon
id|resp
op_assign
id|sg_low_malloc
c_func
(paren
id|size
comma
id|low_dma
comma
id|l_ms
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resp
)paren
r_break
suffix:semicolon
id|resp
op_assign
id|sg_low_malloc
c_func
(paren
id|size
comma
id|low_dma
comma
id|l_ms
comma
op_amp
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|resp
)paren
(brace
id|l_ms
op_assign
(paren
id|SG_HEAP_POOL
op_eq
id|l_ms
)paren
ques
c_cond
id|SG_HEAP_PAGE
suffix:colon
id|SG_HEAP_POOL
suffix:semicolon
id|resp
op_assign
id|sg_low_malloc
c_func
(paren
id|size
comma
id|low_dma
comma
id|l_ms
comma
op_amp
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|resp
)paren
(brace
id|l_ms
op_assign
id|SG_HEAP_KMAL
suffix:semicolon
id|resp
op_assign
id|sg_low_malloc
c_func
(paren
id|size
comma
id|low_dma
comma
id|l_ms
comma
op_amp
id|size
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|resp
op_logical_and
id|retSzp
)paren
op_star
id|retSzp
op_assign
id|size
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SG_HEAP_KMAL
suffix:colon
id|l_ms
op_assign
id|SG_HEAP_PAGE
suffix:semicolon
id|resp
op_assign
id|sg_low_malloc
c_func
(paren
id|size
comma
id|low_dma
comma
id|l_ms
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resp
)paren
r_break
suffix:semicolon
id|l_ms
op_assign
id|SG_HEAP_POOL
suffix:semicolon
id|resp
op_assign
id|sg_low_malloc
c_func
(paren
id|size
comma
id|low_dma
comma
id|l_ms
comma
op_amp
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resp
op_logical_and
id|retSzp
)paren
op_star
id|retSzp
op_assign
id|size
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;sg_malloc: bad ms=%d&bslash;n&quot;
comma
op_star
id|mem_srcp
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|resp
)paren
op_star
id|mem_srcp
op_assign
id|l_ms
suffix:semicolon
)brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|6
comma
id|printk
c_func
(paren
l_string|&quot;sg_malloc: size=%d, ms=%d, ret=0x%p&bslash;n&quot;
comma
id|size
comma
op_star
id|mem_srcp
comma
id|resp
)paren
)paren
suffix:semicolon
r_return
id|resp
suffix:semicolon
)brace
DECL|function|sg_low_free
r_static
r_void
id|sg_low_free
c_func
(paren
r_char
op_star
id|buff
comma
r_int
id|size
comma
r_int
id|mem_src
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|buff
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|mem_src
)paren
(brace
r_case
id|SG_HEAP_POOL
suffix:colon
(brace
r_int
id|num_sect
op_assign
id|size
op_div
id|SG_SECTOR_SZ
suffix:semicolon
id|scsi_free
c_func
(paren
id|buff
comma
id|size
)paren
suffix:semicolon
id|sg_pool_secs_avail
op_add_assign
id|num_sect
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SG_HEAP_KMAL
suffix:colon
id|kfree
c_func
(paren
id|buff
)paren
suffix:semicolon
multiline_comment|/* size not used */
r_break
suffix:semicolon
r_case
id|SG_HEAP_PAGE
suffix:colon
(brace
r_int
id|order
comma
id|a_size
suffix:semicolon
r_for
c_loop
(paren
id|order
op_assign
l_int|0
comma
id|a_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|a_size
OL
id|size
suffix:semicolon
id|order
op_increment
comma
id|a_size
op_lshift_assign
l_int|1
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|buff
comma
id|order
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SG_USER_MEM
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* nothing to do */
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;sg_low_free: bad mem_src=%d, buff=0x%p, rqSz=%df&bslash;n&quot;
comma
id|mem_src
comma
id|buff
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|sg_free
r_static
r_void
id|sg_free
c_func
(paren
r_char
op_star
id|buff
comma
r_int
id|size
comma
r_int
id|mem_src
)paren
(brace
id|SCSI_LOG_TIMEOUT
c_func
(paren
l_int|6
comma
id|printk
c_func
(paren
l_string|&quot;sg_free: buff=0x%p, size=%d&bslash;n&quot;
comma
id|buff
comma
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|buff
)paren
op_logical_or
(paren
id|size
op_le
l_int|0
)paren
)paren
suffix:semicolon
r_else
id|sg_low_free
c_func
(paren
id|buff
comma
id|size
comma
id|mem_src
)paren
suffix:semicolon
)brace
DECL|function|sg_clr_srpnt
r_static
r_void
id|sg_clr_srpnt
c_func
(paren
id|Scsi_Request
op_star
id|SRpnt
)paren
(brace
id|SRpnt-&gt;sr_use_sg
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_sglist_len
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_bufflen
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_buffer
op_assign
l_int|NULL
suffix:semicolon
id|SRpnt-&gt;sr_underflow
op_assign
l_int|0
suffix:semicolon
id|SRpnt-&gt;sr_request.rq_dev
op_assign
id|MKDEV
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* &quot;sg&quot; _disowns_ command blk */
)brace
DECL|function|sg_ms_to_jif
r_static
r_int
id|sg_ms_to_jif
c_func
(paren
r_int
r_int
id|msecs
)paren
(brace
r_if
c_cond
(paren
(paren
id|UINT_MAX
op_div
l_int|2U
)paren
OL
id|msecs
)paren
r_return
id|INT_MAX
suffix:semicolon
multiline_comment|/* special case, set largest possible */
r_else
r_return
(paren
(paren
r_int
)paren
id|msecs
OL
(paren
id|INT_MAX
op_div
l_int|1000
)paren
)paren
ques
c_cond
(paren
(paren
(paren
r_int
)paren
id|msecs
op_star
id|HZ
)paren
op_div
l_int|1000
)paren
suffix:colon
(paren
(paren
(paren
r_int
)paren
id|msecs
op_div
l_int|1000
)paren
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|sg_jif_to_ms
r_static
r_int
id|sg_jif_to_ms
c_func
(paren
r_int
id|jifs
)paren
(brace
r_if
c_cond
(paren
id|jifs
op_le
l_int|0
)paren
r_return
l_int|0U
suffix:semicolon
r_else
(brace
r_int
r_int
id|j
op_assign
(paren
r_int
r_int
)paren
id|jifs
suffix:semicolon
r_return
(paren
id|j
OL
(paren
id|UINT_MAX
op_div
l_int|1000
)paren
)paren
ques
c_cond
(paren
(paren
id|j
op_star
l_int|1000
)paren
op_div
id|HZ
)paren
suffix:colon
(paren
(paren
id|j
op_div
id|HZ
)paren
op_star
l_int|1000
)paren
suffix:semicolon
)brace
)brace
DECL|variable|allow_ops
r_static
r_int
r_char
id|allow_ops
(braket
)braket
op_assign
(brace
id|TEST_UNIT_READY
comma
id|INQUIRY
comma
id|READ_CAPACITY
comma
id|READ_BUFFER
comma
id|READ_6
comma
id|READ_10
comma
id|READ_12
comma
id|MODE_SENSE
comma
id|MODE_SENSE_10
)brace
suffix:semicolon
DECL|function|sg_allow_access
r_static
r_int
id|sg_allow_access
c_func
(paren
r_int
r_char
id|opcode
comma
r_char
id|dev_type
)paren
(brace
r_int
id|k
suffix:semicolon
r_if
c_cond
(paren
id|TYPE_SCANNER
op_eq
id|dev_type
)paren
multiline_comment|/* TYPE_ROM maybe burner */
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
r_sizeof
(paren
id|allow_ops
)paren
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
id|opcode
op_eq
id|allow_ops
(braket
id|k
)braket
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|sg_last_dev
r_static
r_int
id|sg_last_dev
c_func
(paren
)paren
(brace
r_int
id|k
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
id|sg_template.dev_max
op_minus
l_int|1
suffix:semicolon
id|k
op_ge
l_int|0
suffix:semicolon
op_decrement
id|k
)paren
r_if
c_cond
(paren
id|sg_dev_arr
(braket
id|k
)braket
op_logical_and
id|sg_dev_arr
(braket
id|k
)braket
op_member_access_from_pointer
id|device
)paren
r_break
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
id|k
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* origin 1 */
)brace
macro_line|#endif
DECL|function|sg_get_dev
r_static
id|Sg_device
op_star
id|sg_get_dev
c_func
(paren
r_int
id|dev
)paren
(brace
id|Sg_device
op_star
id|sdp
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
id|sg_dev_arr
op_logical_and
(paren
id|dev
op_ge
l_int|0
)paren
)paren
(brace
id|read_lock_irqsave
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
id|sg_template.dev_max
)paren
id|sdp
op_assign
id|sg_dev_arr
(braket
id|dev
)braket
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sg_dev_arr_lock
comma
id|iflags
)paren
suffix:semicolon
)brace
r_return
id|sdp
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|sg_proc_sgp
r_static
r_struct
id|proc_dir_entry
op_star
id|sg_proc_sgp
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|sg_proc_sg_dirname
r_static
r_const
r_char
op_star
id|sg_proc_sg_dirname
op_assign
l_string|&quot;sg&quot;
suffix:semicolon
DECL|variable|sg_proc_leaf_names
r_static
r_const
r_char
op_star
id|sg_proc_leaf_names
(braket
)braket
op_assign
(brace
l_string|&quot;def_reserved_size&quot;
comma
l_string|&quot;debug&quot;
comma
l_string|&quot;devices&quot;
comma
l_string|&quot;device_hdr&quot;
comma
l_string|&quot;device_strs&quot;
comma
l_string|&quot;hosts&quot;
comma
l_string|&quot;host_hdr&quot;
comma
l_string|&quot;host_strs&quot;
comma
l_string|&quot;version&quot;
)brace
suffix:semicolon
r_static
r_int
id|sg_proc_dressz_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_dressz_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_dressz_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_debug_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_debug_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_dev_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_dev_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_devhdr_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_devhdr_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_devstrs_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_devstrs_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_host_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_host_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_hosthdr_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_hosthdr_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_hoststrs_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_hoststrs_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_version_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|sg_proc_version_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
suffix:semicolon
DECL|variable|sg_proc_leaf_reads
r_static
id|read_proc_t
op_star
id|sg_proc_leaf_reads
(braket
)braket
op_assign
(brace
id|sg_proc_dressz_read
comma
id|sg_proc_debug_read
comma
id|sg_proc_dev_read
comma
id|sg_proc_devhdr_read
comma
id|sg_proc_devstrs_read
comma
id|sg_proc_host_read
comma
id|sg_proc_hosthdr_read
comma
id|sg_proc_hoststrs_read
comma
id|sg_proc_version_read
)brace
suffix:semicolon
DECL|variable|sg_proc_leaf_writes
r_static
id|write_proc_t
op_star
id|sg_proc_leaf_writes
(braket
)braket
op_assign
(brace
id|sg_proc_dressz_write
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|PRINT_PROC
mdefine_line|#define PRINT_PROC(fmt,args...)                                 &bslash;&n;    do {                                                        &bslash;&n;&t;*len += sprintf(buffer + *len, fmt, ##args);            &bslash;&n;&t;if (*begin + *len &gt; offset + size)                      &bslash;&n;&t;    return 0;                                           &bslash;&n;&t;if (*begin + *len &lt; offset) {                           &bslash;&n;&t;    *begin += *len;                                     &bslash;&n;&t;    *len = 0;                                           &bslash;&n;&t;}                                                       &bslash;&n;    } while(0)
DECL|macro|SG_PROC_READ_FN
mdefine_line|#define SG_PROC_READ_FN(infofp)                                 &bslash;&n;    do {                                                        &bslash;&n;&t;int len = 0;                                            &bslash;&n;&t;off_t begin = 0;                                        &bslash;&n;&t;*eof = infofp(buffer, &amp;len, &amp;begin, offset, size);      &bslash;&n;&t;if (offset &gt;= (begin + len))                            &bslash;&n;&t;    return 0;                                           &bslash;&n;&t;*start = buffer + offset - begin;&t;&t;&t;&bslash;&n;&t;return (size &lt; (begin + len - offset)) ?                &bslash;&n;&t;&t;&t;&t;size : begin + len - offset;    &bslash;&n;    } while(0)
DECL|function|sg_proc_init
r_static
r_int
id|sg_proc_init
c_func
(paren
)paren
(brace
r_int
id|k
comma
id|mask
suffix:semicolon
r_int
id|leaves
op_assign
r_sizeof
(paren
id|sg_proc_leaf_names
)paren
op_div
r_sizeof
(paren
id|sg_proc_leaf_names
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|pdep
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_scsi
)paren
r_return
l_int|1
suffix:semicolon
id|sg_proc_sgp
op_assign
id|create_proc_entry
c_func
(paren
id|sg_proc_sg_dirname
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
id|proc_scsi
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sg_proc_sgp
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|leaves
suffix:semicolon
op_increment
id|k
)paren
(brace
id|mask
op_assign
id|sg_proc_leaf_writes
(braket
id|k
)braket
ques
c_cond
id|S_IRUGO
op_or
id|S_IWUSR
suffix:colon
id|S_IRUGO
suffix:semicolon
id|pdep
op_assign
id|create_proc_entry
c_func
(paren
id|sg_proc_leaf_names
(braket
id|k
)braket
comma
id|mask
comma
id|sg_proc_sgp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdep
)paren
(brace
id|pdep-&gt;read_proc
op_assign
id|sg_proc_leaf_reads
(braket
id|k
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sg_proc_leaf_writes
(braket
id|k
)braket
)paren
id|pdep-&gt;write_proc
op_assign
id|sg_proc_leaf_writes
(braket
id|k
)braket
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sg_proc_cleanup
r_static
r_void
id|sg_proc_cleanup
c_func
(paren
)paren
(brace
r_int
id|k
suffix:semicolon
r_int
id|leaves
op_assign
r_sizeof
(paren
id|sg_proc_leaf_names
)paren
op_div
r_sizeof
(paren
id|sg_proc_leaf_names
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|proc_scsi
)paren
op_logical_or
(paren
op_logical_neg
id|sg_proc_sgp
)paren
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|leaves
suffix:semicolon
op_increment
id|k
)paren
id|remove_proc_entry
c_func
(paren
id|sg_proc_leaf_names
(braket
id|k
)braket
comma
id|sg_proc_sgp
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|sg_proc_sg_dirname
comma
id|proc_scsi
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_dressz_read
r_static
r_int
id|sg_proc_dressz_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|SG_PROC_READ_FN
c_func
(paren
id|sg_proc_dressz_info
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_dressz_info
r_static
r_int
id|sg_proc_dressz_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
(brace
id|PRINT_PROC
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|sg_big_buff
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sg_proc_dressz_write
r_static
r_int
id|sg_proc_dressz_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|num
suffix:semicolon
r_int
r_int
id|k
op_assign
id|ULONG_MAX
suffix:semicolon
r_char
id|buff
(braket
l_int|11
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|num
op_assign
(paren
id|count
OL
l_int|10
)paren
ques
c_cond
id|count
suffix:colon
l_int|10
suffix:semicolon
id|copy_from_user
c_func
(paren
id|buff
comma
id|buffer
comma
id|num
)paren
suffix:semicolon
id|buff
(braket
id|num
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|k
op_assign
id|simple_strtoul
c_func
(paren
id|buff
comma
l_int|0
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
op_le
l_int|1048576
)paren
(brace
id|sg_big_buff
op_assign
id|k
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_return
op_minus
id|ERANGE
suffix:semicolon
)brace
DECL|function|sg_proc_debug_read
r_static
r_int
id|sg_proc_debug_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|SG_PROC_READ_FN
c_func
(paren
id|sg_proc_debug_info
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_debug_info
r_static
r_int
id|sg_proc_debug_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
(brace
id|Sg_device
op_star
id|sdp
suffix:semicolon
r_const
id|sg_io_hdr_t
op_star
id|hp
suffix:semicolon
r_int
id|j
comma
id|max_dev
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sg_dev_arr
)paren
(brace
id|PRINT_PROC
c_func
(paren
l_string|&quot;sg_dev_arr NULL, driver not initialized&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|max_dev
op_assign
id|sg_last_dev
c_func
(paren
)paren
suffix:semicolon
id|PRINT_PROC
c_func
(paren
l_string|&quot;dev_max(currently)=%d max_active_device=%d (origin 1)&bslash;n&quot;
comma
id|sg_template.dev_max
comma
id|max_dev
)paren
suffix:semicolon
id|PRINT_PROC
c_func
(paren
l_string|&quot; scsi_dma_free_sectors=%u sg_pool_secs_aval=%d &quot;
l_string|&quot;def_reserved_size=%d&bslash;n&quot;
comma
id|scsi_dma_free_sectors
comma
id|sg_pool_secs_avail
comma
id|sg_big_buff
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|max_dev
suffix:semicolon
op_increment
id|j
)paren
(brace
r_if
c_cond
(paren
(paren
id|sdp
op_assign
id|sg_get_dev
c_func
(paren
id|j
)paren
)paren
)paren
(brace
id|Sg_fd
op_star
id|fp
suffix:semicolon
id|Sg_request
op_star
id|srp
suffix:semicolon
r_struct
id|scsi_device
op_star
id|scsidp
suffix:semicolon
r_int
id|dev
comma
id|k
comma
id|m
comma
id|blen
comma
id|usg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|scsidp
op_assign
id|sdp-&gt;device
)paren
)paren
(brace
id|PRINT_PROC
c_func
(paren
l_string|&quot;device %d detached ??&bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dev
op_assign
id|MINOR
c_func
(paren
id|sdp-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_get_nth_sfp
c_func
(paren
id|sdp
comma
l_int|0
)paren
)paren
(brace
id|PRINT_PROC
c_func
(paren
l_string|&quot; &gt;&gt;&gt; device=sg%d &quot;
comma
id|dev
)paren
suffix:semicolon
id|PRINT_PROC
c_func
(paren
l_string|&quot;scsi%d chan=%d id=%d lun=%d   em=%d sg_tablesize=%d&quot;
l_string|&quot; excl=%d&bslash;n&quot;
comma
id|scsidp-&gt;host-&gt;host_no
comma
id|scsidp-&gt;channel
comma
id|scsidp-&gt;id
comma
id|scsidp-&gt;lun
comma
id|scsidp-&gt;host-&gt;hostt-&gt;emulated
comma
id|sdp-&gt;sg_tablesize
comma
id|sdp-&gt;exclude
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
(paren
id|fp
op_assign
id|sg_get_nth_sfp
c_func
(paren
id|sdp
comma
id|k
)paren
)paren
suffix:semicolon
op_increment
id|k
)paren
(brace
id|PRINT_PROC
c_func
(paren
l_string|&quot;   FD(%d): timeout=%dms bufflen=%d &quot;
l_string|&quot;(res)sgat=%d low_dma=%d&bslash;n&quot;
comma
id|k
op_plus
l_int|1
comma
id|sg_jif_to_ms
c_func
(paren
id|fp-&gt;timeout
)paren
comma
id|fp-&gt;reserve.bufflen
comma
(paren
r_int
)paren
id|fp-&gt;reserve.k_use_sg
comma
(paren
r_int
)paren
id|fp-&gt;low_dma
)paren
suffix:semicolon
id|PRINT_PROC
c_func
(paren
l_string|&quot;   cmd_q=%d f_packid=%d k_orphan=%d closed=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|fp-&gt;cmd_q
comma
(paren
r_int
)paren
id|fp-&gt;force_packid
comma
(paren
r_int
)paren
id|fp-&gt;keep_orphan
comma
(paren
r_int
)paren
id|fp-&gt;closed
)paren
suffix:semicolon
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
(paren
id|srp
op_assign
id|sg_get_nth_request
c_func
(paren
id|fp
comma
id|m
)paren
)paren
suffix:semicolon
op_increment
id|m
)paren
(brace
id|hp
op_assign
op_amp
id|srp-&gt;header
suffix:semicolon
multiline_comment|/* stop indenting so far ... */
id|PRINT_PROC
c_func
(paren
id|srp-&gt;res_used
ques
c_cond
l_string|&quot;     rb&gt;&gt; &quot;
suffix:colon
(paren
(paren
id|SG_INFO_DIRECT_IO_MASK
op_amp
id|hp-&gt;info
)paren
ques
c_cond
l_string|&quot;     dio&gt;&gt; &quot;
suffix:colon
l_string|&quot;     &quot;
)paren
)paren
suffix:semicolon
id|blen
op_assign
id|srp-&gt;my_cmdp
ques
c_cond
id|srp-&gt;my_cmdp-&gt;sr_bufflen
suffix:colon
id|srp-&gt;data.bufflen
suffix:semicolon
id|usg
op_assign
id|srp-&gt;my_cmdp
ques
c_cond
id|srp-&gt;my_cmdp-&gt;sr_use_sg
suffix:colon
id|srp-&gt;data.k_use_sg
suffix:semicolon
id|PRINT_PROC
c_func
(paren
id|srp-&gt;done
ques
c_cond
(paren
(paren
l_int|1
op_eq
id|srp-&gt;done
)paren
ques
c_cond
l_string|&quot;rcv:&quot;
suffix:colon
l_string|&quot;fin:&quot;
)paren
suffix:colon
(paren
id|srp-&gt;my_cmdp
ques
c_cond
l_string|&quot;act:&quot;
suffix:colon
l_string|&quot;prior:&quot;
)paren
)paren
suffix:semicolon
id|PRINT_PROC
c_func
(paren
l_string|&quot; id=%d blen=%d&quot;
comma
id|srp-&gt;header.pack_id
comma
id|blen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srp-&gt;done
)paren
id|PRINT_PROC
c_func
(paren
l_string|&quot; dur=%d&quot;
comma
id|hp-&gt;duration
)paren
suffix:semicolon
r_else
id|PRINT_PROC
c_func
(paren
l_string|&quot; t_o/elap=%d/%d&quot;
comma
(paren
(paren
id|hp-&gt;interface_id
op_eq
l_char|&squot;&bslash;0&squot;
)paren
ques
c_cond
id|sg_jif_to_ms
c_func
(paren
id|fp-&gt;timeout
)paren
suffix:colon
id|hp-&gt;timeout
)paren
comma
id|sg_jif_to_ms
c_func
(paren
id|hp-&gt;duration
ques
c_cond
(paren
id|jiffies
op_minus
id|hp-&gt;duration
)paren
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|PRINT_PROC
c_func
(paren
l_string|&quot;ms sgat=%d op=0x%02x&bslash;n&quot;
comma
id|usg
comma
(paren
r_int
)paren
id|srp-&gt;data.cmd_opcode
)paren
suffix:semicolon
multiline_comment|/* reset indenting */
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|m
)paren
id|PRINT_PROC
c_func
(paren
l_string|&quot;     No requests active&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sg_proc_dev_read
r_static
r_int
id|sg_proc_dev_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|SG_PROC_READ_FN
c_func
(paren
id|sg_proc_dev_info
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_dev_info
r_static
r_int
id|sg_proc_dev_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
(brace
id|Sg_device
op_star
id|sdp
suffix:semicolon
r_int
id|j
comma
id|max_dev
suffix:semicolon
r_struct
id|scsi_device
op_star
id|scsidp
suffix:semicolon
id|max_dev
op_assign
id|sg_last_dev
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|max_dev
suffix:semicolon
op_increment
id|j
)paren
(brace
id|sdp
op_assign
id|sg_get_dev
c_func
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp
op_logical_and
(paren
id|scsidp
op_assign
id|sdp-&gt;device
)paren
)paren
id|PRINT_PROC
c_func
(paren
l_string|&quot;%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;t%d&bslash;n&quot;
comma
id|scsidp-&gt;host-&gt;host_no
comma
id|scsidp-&gt;channel
comma
id|scsidp-&gt;id
comma
id|scsidp-&gt;lun
comma
(paren
r_int
)paren
id|scsidp-&gt;type
comma
(paren
r_int
)paren
id|scsidp-&gt;access_count
comma
(paren
r_int
)paren
id|scsidp-&gt;queue_depth
comma
(paren
r_int
)paren
id|scsidp-&gt;device_busy
)paren
suffix:semicolon
r_else
id|PRINT_PROC
c_func
(paren
l_string|&quot;-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sg_proc_devhdr_read
r_static
r_int
id|sg_proc_devhdr_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|SG_PROC_READ_FN
c_func
(paren
id|sg_proc_devhdr_info
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_devhdr_info
r_static
r_int
id|sg_proc_devhdr_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
(brace
id|PRINT_PROC
c_func
(paren
l_string|&quot;host&bslash;tchan&bslash;tid&bslash;tlun&bslash;ttype&bslash;tbopens&bslash;tqdepth&bslash;tbusy&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sg_proc_devstrs_read
r_static
r_int
id|sg_proc_devstrs_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|SG_PROC_READ_FN
c_func
(paren
id|sg_proc_devstrs_info
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_devstrs_info
r_static
r_int
id|sg_proc_devstrs_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
(brace
id|Sg_device
op_star
id|sdp
suffix:semicolon
r_int
id|j
comma
id|max_dev
suffix:semicolon
r_struct
id|scsi_device
op_star
id|scsidp
suffix:semicolon
id|max_dev
op_assign
id|sg_last_dev
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|max_dev
suffix:semicolon
op_increment
id|j
)paren
(brace
id|sdp
op_assign
id|sg_get_dev
c_func
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sdp
op_logical_and
(paren
id|scsidp
op_assign
id|sdp-&gt;device
)paren
)paren
id|PRINT_PROC
c_func
(paren
l_string|&quot;%8.8s&bslash;t%16.16s&bslash;t%4.4s&bslash;n&quot;
comma
id|scsidp-&gt;vendor
comma
id|scsidp-&gt;model
comma
id|scsidp-&gt;rev
)paren
suffix:semicolon
r_else
id|PRINT_PROC
c_func
(paren
l_string|&quot;&lt;no active device&gt;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sg_proc_host_read
r_static
r_int
id|sg_proc_host_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|SG_PROC_READ_FN
c_func
(paren
id|sg_proc_host_info
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_host_info
r_static
r_int
id|sg_proc_host_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shp
suffix:semicolon
r_int
id|k
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
comma
id|shp
op_assign
id|scsi_hostlist
suffix:semicolon
id|shp
suffix:semicolon
id|shp
op_assign
id|shp-&gt;next
comma
op_increment
id|k
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|k
OL
id|shp-&gt;host_no
suffix:semicolon
op_increment
id|k
)paren
id|PRINT_PROC
c_func
(paren
l_string|&quot;-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;t-1&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_PROC
c_func
(paren
l_string|&quot;%u&bslash;t%hu&bslash;t%hd&bslash;t%hu&bslash;t%d&bslash;t%d&bslash;n&quot;
comma
id|shp-&gt;unique_id
comma
id|shp-&gt;host_busy
comma
id|shp-&gt;cmd_per_lun
comma
id|shp-&gt;sg_tablesize
comma
(paren
r_int
)paren
id|shp-&gt;unchecked_isa_dma
comma
(paren
r_int
)paren
id|shp-&gt;hostt-&gt;emulated
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sg_proc_hosthdr_read
r_static
r_int
id|sg_proc_hosthdr_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|SG_PROC_READ_FN
c_func
(paren
id|sg_proc_hosthdr_info
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_hosthdr_info
r_static
r_int
id|sg_proc_hosthdr_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
(brace
id|PRINT_PROC
c_func
(paren
l_string|&quot;uid&bslash;tbusy&bslash;tcpl&bslash;tscatg&bslash;tisa&bslash;temul&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sg_proc_hoststrs_read
r_static
r_int
id|sg_proc_hoststrs_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|SG_PROC_READ_FN
c_func
(paren
id|sg_proc_hoststrs_info
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_hoststrs_info
r_static
r_int
id|sg_proc_hoststrs_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shp
suffix:semicolon
r_int
id|k
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
comma
id|shp
op_assign
id|scsi_hostlist
suffix:semicolon
id|shp
suffix:semicolon
id|shp
op_assign
id|shp-&gt;next
comma
op_increment
id|k
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|k
OL
id|shp-&gt;host_no
suffix:semicolon
op_increment
id|k
)paren
id|PRINT_PROC
c_func
(paren
l_string|&quot;&lt;no active host&gt;&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_PROC
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|shp-&gt;hostt-&gt;info
ques
c_cond
id|shp-&gt;hostt
op_member_access_from_pointer
id|info
c_func
(paren
id|shp
)paren
suffix:colon
(paren
id|shp-&gt;hostt-&gt;name
ques
c_cond
id|shp-&gt;hostt-&gt;name
suffix:colon
l_string|&quot;&lt;no name&gt;&quot;
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sg_proc_version_read
r_static
r_int
id|sg_proc_version_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|size
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|SG_PROC_READ_FN
c_func
(paren
id|sg_proc_version_info
)paren
suffix:semicolon
)brace
DECL|function|sg_proc_version_info
r_static
r_int
id|sg_proc_version_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_int
op_star
id|len
comma
id|off_t
op_star
id|begin
comma
id|off_t
id|offset
comma
r_int
id|size
)paren
(brace
id|PRINT_PROC
c_func
(paren
l_string|&quot;%d&bslash;t%s&bslash;n&quot;
comma
id|sg_version_num
comma
id|sg_version_str
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif  /* CONFIG_PROC_FS */
DECL|variable|init_sg
id|module_init
c_func
(paren
id|init_sg
)paren
suffix:semicolon
DECL|variable|exit_sg
id|module_exit
c_func
(paren
id|exit_sg
)paren
suffix:semicolon
eof
