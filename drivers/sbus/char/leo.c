multiline_comment|/* $Id: leo.c,v 1.25 1997/08/22 17:33:58 jj Exp $&n; * leo.c: SUNW,leo 24/8bit frame buffer driver&n; *&n; * Copyright (C) 1996,1997 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; * Copyright (C) 1997 Michal Rehacek (Michal.Rehacek@st.mff.cuni.cz)&n; */
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/* These must be included after asm/fbio.h */
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
macro_line|#include &quot;fb.h&quot;
macro_line|#include &quot;cg_common.h&quot;
DECL|macro|LEO_OFF_LC_SS0_KRN
mdefine_line|#define LEO_OFF_LC_SS0_KRN&t;0x00200000
DECL|macro|LEO_OFF_LC_SS0_USR
mdefine_line|#define LEO_OFF_LC_SS0_USR&t;0x00201000
DECL|macro|LEO_OFF_LC_SS1_KRN
mdefine_line|#define LEO_OFF_LC_SS1_KRN&t;0x01200000
DECL|macro|LEO_OFF_LC_SS1_USR
mdefine_line|#define LEO_OFF_LC_SS1_USR&t;0x01201000
DECL|macro|LEO_OFF_LD_SS0
mdefine_line|#define LEO_OFF_LD_SS0&t;&t;0x00400000
DECL|macro|LEO_OFF_LD_SS1
mdefine_line|#define LEO_OFF_LD_SS1&t;&t;0x01400000
DECL|macro|LEO_OFF_LD_GBL
mdefine_line|#define LEO_OFF_LD_GBL&t;&t;0x00401000
DECL|macro|LEO_OFF_LX_KRN
mdefine_line|#define LEO_OFF_LX_KRN&t;&t;0x00600000
DECL|macro|LEO_OFF_LX_CURSOR
mdefine_line|#define LEO_OFF_LX_CURSOR&t;0x00601000
DECL|macro|LEO_OFF_SS0
mdefine_line|#define LEO_OFF_SS0&t;&t;0x00800000
DECL|macro|LEO_OFF_SS1
mdefine_line|#define LEO_OFF_SS1&t;&t;0x01800000
DECL|macro|LEO_OFF_UNK
mdefine_line|#define LEO_OFF_UNK&t;&t;0x00602000
DECL|macro|LEO_OFF_UNK2
mdefine_line|#define LEO_OFF_UNK2&t;&t;0x00000000
DECL|macro|LEO_CUR_ENABLE
mdefine_line|#define LEO_CUR_ENABLE&t;&t;0x00000080
DECL|macro|LEO_CUR_UPDATE
mdefine_line|#define LEO_CUR_UPDATE&t;&t;0x00000030
DECL|macro|LEO_CUR_PROGRESS
mdefine_line|#define LEO_CUR_PROGRESS&t;0x00000006
DECL|macro|LEO_CUR_UPDATECMAP
mdefine_line|#define LEO_CUR_UPDATECMAP&t;0x00000003
DECL|macro|LEO_CUR_TYPE_MASK
mdefine_line|#define LEO_CUR_TYPE_MASK&t;0x00000000
DECL|macro|LEO_CUR_TYPE_IMAGE
mdefine_line|#define LEO_CUR_TYPE_IMAGE&t;0x00000020
DECL|macro|LEO_CUR_TYPE_CMAP
mdefine_line|#define LEO_CUR_TYPE_CMAP&t;0x00000050
DECL|struct|leo_cursor
r_struct
id|leo_cursor
(brace
DECL|member|xxx0
id|u8
id|xxx0
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|cur_type
r_volatile
id|u32
id|cur_type
suffix:semicolon
DECL|member|cur_misc
r_volatile
id|u32
id|cur_misc
suffix:semicolon
DECL|member|cur_cursxy
r_volatile
id|u32
id|cur_cursxy
suffix:semicolon
DECL|member|cur_data
r_volatile
id|u32
id|cur_data
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|LEO_KRN_TYPE_CLUT0
mdefine_line|#define LEO_KRN_TYPE_CLUT0&t;0x00001000
DECL|macro|LEO_KRN_TYPE_CLUT1
mdefine_line|#define LEO_KRN_TYPE_CLUT1&t;0x00001001
DECL|macro|LEO_KRN_TYPE_CLUT2
mdefine_line|#define LEO_KRN_TYPE_CLUT2&t;0x00001002
DECL|macro|LEO_KRN_TYPE_WID
mdefine_line|#define LEO_KRN_TYPE_WID&t;0x00001003
DECL|macro|LEO_KRN_TYPE_UNK
mdefine_line|#define LEO_KRN_TYPE_UNK&t;0x00001006
DECL|macro|LEO_KRN_TYPE_VIDEO
mdefine_line|#define LEO_KRN_TYPE_VIDEO&t;0x00002003
DECL|macro|LEO_KRN_TYPE_CLUTDATA
mdefine_line|#define LEO_KRN_TYPE_CLUTDATA&t;0x00004000
DECL|macro|LEO_KRN_CSR_ENABLE
mdefine_line|#define LEO_KRN_CSR_ENABLE&t;0x00000008
DECL|macro|LEO_KRN_CSR_PROGRESS
mdefine_line|#define LEO_KRN_CSR_PROGRESS&t;0x00000004
DECL|macro|LEO_KRN_CSR_UNK
mdefine_line|#define LEO_KRN_CSR_UNK&t;&t;0x00000002
DECL|macro|LEO_KRN_CSR_UNK2
mdefine_line|#define LEO_KRN_CSR_UNK2&t;0x00000001
DECL|struct|leo_lx_krn
r_struct
id|leo_lx_krn
(brace
DECL|member|krn_type
r_volatile
id|u32
id|krn_type
suffix:semicolon
DECL|member|krn_csr
r_volatile
id|u32
id|krn_csr
suffix:semicolon
DECL|member|krn_value
r_volatile
id|u32
id|krn_value
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|leo_lc_ss0_krn
r_struct
id|leo_lc_ss0_krn
(brace
DECL|member|misc
r_volatile
id|u32
id|misc
suffix:semicolon
DECL|member|xxx0
id|u8
id|xxx0
(braket
l_int|0x800
op_minus
l_int|4
)braket
suffix:semicolon
DECL|member|rev
r_volatile
id|u32
id|rev
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|leo_lc_ss0_usr
r_struct
id|leo_lc_ss0_usr
(brace
DECL|member|csr
r_volatile
id|u32
id|csr
suffix:semicolon
DECL|member|attrs
r_volatile
id|u32
id|attrs
suffix:semicolon
DECL|member|fontc
r_volatile
id|u32
id|fontc
suffix:semicolon
DECL|member|fontc2
r_volatile
id|u32
id|fontc2
suffix:semicolon
DECL|member|extent
r_volatile
id|u32
id|extent
suffix:semicolon
DECL|member|src
r_volatile
id|u32
id|src
suffix:semicolon
DECL|member|xxx1
id|u32
id|xxx1
(braket
l_int|1
)braket
suffix:semicolon
DECL|member|copy
r_volatile
id|u32
id|copy
suffix:semicolon
DECL|member|fill
r_volatile
id|u32
id|fill
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|leo_lc_ss1_krn
r_struct
id|leo_lc_ss1_krn
(brace
DECL|member|unknown
id|u8
id|unknown
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|leo_lc_ss1_usr
r_struct
id|leo_lc_ss1_usr
(brace
DECL|member|unknown
id|u8
id|unknown
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|leo_ld_ss0
r_struct
id|leo_ld_ss0
(brace
DECL|member|xxx0
id|u8
id|xxx0
(braket
l_int|0xe00
)braket
suffix:semicolon
DECL|member|xxx1
id|u32
id|xxx1
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|unk
r_volatile
id|u32
id|unk
suffix:semicolon
DECL|member|xxx2
id|u32
id|xxx2
(braket
l_int|1
)braket
suffix:semicolon
DECL|member|unk2
r_volatile
id|u32
id|unk2
suffix:semicolon
DECL|member|unk3
r_volatile
id|u32
id|unk3
suffix:semicolon
DECL|member|xxx3
id|u32
id|xxx3
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|fg
r_volatile
id|u32
id|fg
suffix:semicolon
DECL|member|bg
r_volatile
id|u32
id|bg
suffix:semicolon
DECL|member|xxx4
id|u8
id|xxx4
(braket
l_int|0x05c
)braket
suffix:semicolon
DECL|member|planemask
r_volatile
id|u32
id|planemask
suffix:semicolon
DECL|member|rop
r_volatile
id|u32
id|rop
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|LEO_SS1_MISC_ENABLE
mdefine_line|#define LEO_SS1_MISC_ENABLE&t;0x00000001
DECL|macro|LEO_SS1_MISC_STEREO
mdefine_line|#define LEO_SS1_MISC_STEREO&t;0x00000002
DECL|struct|leo_ld_ss1
r_struct
id|leo_ld_ss1
(brace
DECL|member|xxx0
id|u8
id|xxx0
(braket
l_int|0xef4
)braket
suffix:semicolon
DECL|member|ss1_misc
r_volatile
id|u32
id|ss1_misc
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|leo_ld_gbl
r_struct
id|leo_ld_gbl
(brace
DECL|member|unknown
id|u8
id|unknown
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|leo_blitc
c_func
(paren
r_int
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|leo_setw
c_func
(paren
r_int
comma
r_int
comma
r_int
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|leo_cpyw
c_func
(paren
r_int
comma
r_int
comma
r_int
r_int
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|leo_fill
c_func
(paren
r_int
comma
r_int
comma
r_int
op_star
)paren
suffix:semicolon
r_static
r_void
id|leo_penguin
c_func
(paren
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
DECL|function|leo_restore_palette
id|leo_restore_palette
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|fb-&gt;info.leo.ld_ss1-&gt;ss1_misc
op_and_assign
op_complement
(paren
id|LEO_SS1_MISC_ENABLE
)paren
suffix:semicolon
)brace
multiline_comment|/* Ugh: X wants to mmap a bunch of cute stuff at the same time :-( */
multiline_comment|/* So, we just mmap the things that are being asked for */
r_static
r_int
DECL|function|leo_mmap
id|leo_mmap
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
id|base
comma
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|uint
id|size
comma
id|page
comma
id|r
comma
id|map_size
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|map_offset
op_assign
l_int|0
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_amp
op_complement
id|PAGE_MASK
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* To stop the swapper from even considering these pages */
id|vma-&gt;vm_flags
op_or_assign
id|FB_MMAP_VM_FLAGS
suffix:semicolon
multiline_comment|/* Each page, see which map applies */
r_for
c_loop
(paren
id|page
op_assign
l_int|0
suffix:semicolon
id|page
OL
id|size
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
id|vma-&gt;vm_offset
op_plus
id|page
)paren
(brace
r_case
id|LEO_SS0_MAP
suffix:colon
id|map_size
op_assign
l_int|0x800000
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_LC_SS0_USR_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.leo.lc_ss0_usr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_LD_SS0_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.leo.ld_ss0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_LX_CURSOR_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.leo.cursor
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_SS1_MAP
suffix:colon
id|map_size
op_assign
l_int|0x800000
suffix:semicolon
id|map_offset
op_assign
id|fb-&gt;info.leo.offset
op_plus
id|LEO_OFF_SS1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_LC_SS1_USR_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.leo.lc_ss1_usr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_LD_SS1_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.leo.ld_ss1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_UNK_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|fb-&gt;info.leo.offset
op_plus
id|LEO_OFF_UNK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_LX_KRN_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.leo.lx_krn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_LC_SS0_KRN_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.leo.lc_ss0_krn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_LC_SS1_KRN_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.leo.lc_ss1_krn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_LD_GBL_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.leo.ld_gbl
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LEO_UNK2_MAP
suffix:colon
id|map_size
op_assign
l_int|0x100000
suffix:semicolon
id|map_offset
op_assign
id|fb-&gt;info.leo.offset
op_plus
id|LEO_OFF_UNK2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|map_size
)paren
(brace
id|page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|page
op_plus
id|map_size
OG
id|size
)paren
id|map_size
op_assign
id|size
op_minus
id|page
suffix:semicolon
id|r
op_assign
id|io_remap_page_range
(paren
id|vma-&gt;vm_start
op_plus
id|page
comma
id|map_offset
comma
id|map_size
comma
id|vma-&gt;vm_page_prot
comma
id|fb-&gt;space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|page
op_add_assign
id|map_size
suffix:semicolon
)brace
id|vma-&gt;vm_dentry
op_assign
id|dget
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|leo_setcursormap
id|leo_setcursormap
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
r_char
op_star
id|red
comma
r_int
r_char
op_star
id|green
comma
r_int
r_char
op_star
id|blue
)paren
(brace
r_struct
id|leo_cursor
op_star
id|l
op_assign
id|fb-&gt;info.leo.cursor
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|l-&gt;cur_misc
op_amp
id|LEO_CUR_PROGRESS
)paren
op_logical_and
id|i
OL
l_int|300000
suffix:semicolon
id|i
op_increment
)paren
id|udelay
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Busy wait at most 0.3 sec */
r_if
c_cond
(paren
id|i
op_eq
l_int|300000
)paren
r_return
suffix:semicolon
multiline_comment|/* Timed out - should we print some message? */
id|l-&gt;cur_type
op_assign
id|LEO_CUR_TYPE_CMAP
suffix:semicolon
id|l-&gt;cur_data
op_assign
(paren
id|red
(braket
l_int|0
)braket
op_or
(paren
id|green
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|blue
(braket
l_int|0
)braket
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|l-&gt;cur_data
op_assign
(paren
id|red
(braket
l_int|1
)braket
op_or
(paren
id|green
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|blue
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|l-&gt;cur_misc
op_assign
id|LEO_CUR_UPDATECMAP
suffix:semicolon
)brace
multiline_comment|/* Load cursor information */
r_static
r_void
DECL|function|leo_setcursor
id|leo_setcursor
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_struct
id|cg_cursor
op_star
id|c
op_assign
op_amp
id|fb-&gt;cursor
suffix:semicolon
r_struct
id|leo_cursor
op_star
id|l
op_assign
id|fb-&gt;info.leo.cursor
suffix:semicolon
id|l-&gt;cur_misc
op_and_assign
op_complement
id|LEO_CUR_ENABLE
suffix:semicolon
id|l-&gt;cur_cursxy
op_assign
(paren
(paren
id|c-&gt;cpos.fbx
op_minus
id|c-&gt;chot.fbx
)paren
op_amp
l_int|0x7ff
)paren
op_or
(paren
(paren
(paren
id|c-&gt;cpos.fby
op_minus
id|c-&gt;chot.fby
)paren
op_amp
l_int|0x7ff
)paren
op_lshift
l_int|11
)paren
suffix:semicolon
id|l-&gt;cur_misc
op_or_assign
id|LEO_CUR_UPDATE
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;enable
)paren
id|l-&gt;cur_misc
op_or_assign
id|LEO_CUR_ENABLE
suffix:semicolon
)brace
multiline_comment|/* Set cursor shape */
r_static
r_void
DECL|function|leo_setcurshape
id|leo_setcurshape
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|u32
id|m
comma
id|n
comma
id|mask
suffix:semicolon
r_struct
id|leo_cursor
op_star
id|l
op_assign
id|fb-&gt;info.leo.cursor
suffix:semicolon
id|l-&gt;cur_misc
op_and_assign
op_complement
id|LEO_CUR_ENABLE
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|2
suffix:semicolon
id|k
op_increment
)paren
(brace
id|l-&gt;cur_type
op_assign
(paren
id|k
op_star
id|LEO_CUR_TYPE_IMAGE
)paren
suffix:semicolon
multiline_comment|/* LEO_CUR_TYPE_MASK is 0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mask
op_assign
l_int|0
suffix:semicolon
id|m
op_assign
id|fb-&gt;cursor.bits
(braket
id|k
)braket
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* mask = m with reversed bit order */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
comma
id|n
op_assign
l_int|1
suffix:semicolon
id|j
OL
l_int|32
suffix:semicolon
id|j
op_increment
comma
id|n
op_lshift_assign
l_int|1
)paren
r_if
c_cond
(paren
id|m
op_amp
id|n
)paren
id|mask
op_or_assign
(paren
l_int|0x80000000
op_rshift
id|j
)paren
suffix:semicolon
id|l-&gt;cur_data
op_assign
id|mask
suffix:semicolon
)brace
)brace
id|l-&gt;cur_misc
op_or_assign
id|LEO_CUR_ENABLE
suffix:semicolon
)brace
r_static
r_void
DECL|function|leo_blank
id|leo_blank
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|fb-&gt;info.leo.lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_VIDEO
suffix:semicolon
id|fb-&gt;info.leo.lx_krn-&gt;krn_csr
op_and_assign
op_complement
id|LEO_KRN_CSR_ENABLE
suffix:semicolon
)brace
r_static
r_void
DECL|function|leo_unblank
id|leo_unblank
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|fb-&gt;info.leo.lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_VIDEO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fb-&gt;info.leo.lx_krn-&gt;krn_csr
op_amp
id|LEO_KRN_CSR_ENABLE
)paren
)paren
id|fb-&gt;info.leo.lx_krn-&gt;krn_csr
op_or_assign
id|LEO_KRN_CSR_ENABLE
suffix:semicolon
)brace
DECL|function|leo_wait
r_static
r_int
id|leo_wait
(paren
r_struct
id|leo_lx_krn
op_star
id|lx_krn
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|lx_krn-&gt;krn_csr
op_amp
id|LEO_KRN_CSR_PROGRESS
)paren
op_logical_and
id|i
OL
l_int|300000
suffix:semicolon
id|i
op_increment
)paren
id|udelay
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Busy wait at most 0.3 sec */
r_if
c_cond
(paren
id|i
op_eq
l_int|300000
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Timed out - should we print some message? */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|leo_wid_get
id|leo_wid_get
(paren
id|fbinfo_t
op_star
id|fb
comma
r_struct
id|fb_wid_list
op_star
id|wl
)paren
(brace
r_struct
id|leo_lx_krn
op_star
id|lx_krn
op_assign
id|fb-&gt;info.leo.lx_krn
suffix:semicolon
r_struct
id|fb_wid_item
op_star
id|wi
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|u32
id|l
suffix:semicolon
id|lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_WID
suffix:semicolon
id|i
op_assign
id|leo_wait
(paren
id|lx_krn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|lx_krn-&gt;krn_csr
op_and_assign
op_complement
id|LEO_KRN_CSR_UNK2
suffix:semicolon
id|lx_krn-&gt;krn_csr
op_or_assign
id|LEO_KRN_CSR_UNK
suffix:semicolon
id|lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_WID
suffix:semicolon
id|i
op_assign
id|leo_wait
(paren
id|lx_krn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|wi
op_assign
id|wl-&gt;wl_list
suffix:semicolon
id|i
OL
id|wl-&gt;wl_count
suffix:semicolon
id|i
op_increment
comma
id|wi
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|wi-&gt;wi_type
)paren
(brace
r_case
id|FB_WID_DBL_8
suffix:colon
id|j
op_assign
(paren
id|wi-&gt;wi_index
op_amp
l_int|0xf
)paren
op_plus
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_WID_DBL_24
suffix:colon
id|j
op_assign
id|wi-&gt;wi_index
op_amp
l_int|0x3f
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|wi-&gt;wi_attrs
op_assign
l_int|0xffff
suffix:semicolon
id|lx_krn-&gt;krn_type
op_assign
l_int|0x5800
op_plus
id|j
suffix:semicolon
id|l
op_assign
id|lx_krn-&gt;krn_value
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|32
suffix:semicolon
id|j
op_increment
)paren
id|wi-&gt;wi_values
(braket
id|j
)braket
op_assign
id|l
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|leo_wid_put
id|leo_wid_put
(paren
id|fbinfo_t
op_star
id|fb
comma
r_struct
id|fb_wid_list
op_star
id|wl
)paren
(brace
r_struct
id|leo_lx_krn
op_star
id|lx_krn
op_assign
id|fb-&gt;info.leo.lx_krn
suffix:semicolon
r_struct
id|fb_wid_item
op_star
id|wi
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_WID
suffix:semicolon
id|i
op_assign
id|leo_wait
(paren
id|lx_krn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|wi
op_assign
id|wl-&gt;wl_list
suffix:semicolon
id|i
OL
id|wl-&gt;wl_count
suffix:semicolon
id|i
op_increment
comma
id|wi
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|wi-&gt;wi_type
)paren
(brace
r_case
id|FB_WID_DBL_8
suffix:colon
id|j
op_assign
(paren
id|wi-&gt;wi_index
op_amp
l_int|0xf
)paren
op_plus
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_WID_DBL_24
suffix:colon
id|j
op_assign
id|wi-&gt;wi_index
op_amp
l_int|0x3f
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|lx_krn-&gt;krn_type
op_assign
l_int|0x5800
op_plus
id|j
suffix:semicolon
id|lx_krn-&gt;krn_value
op_assign
id|wi-&gt;wi_values
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|leo_clutstore
r_static
r_int
id|leo_clutstore
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|clutid
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
op_star
id|clut
op_assign
id|fb-&gt;info.leo.cluts
(braket
id|clutid
)braket
suffix:semicolon
r_struct
id|leo_lx_krn
op_star
id|lx_krn
op_assign
id|fb-&gt;info.leo.lx_krn
suffix:semicolon
id|lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_CLUT0
op_plus
id|clutid
suffix:semicolon
id|i
op_assign
id|leo_wait
(paren
id|lx_krn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_CLUTDATA
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
id|lx_krn-&gt;krn_value
op_assign
op_star
id|clut
op_increment
suffix:semicolon
multiline_comment|/* Throw colors there :)) */
id|lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_CLUT0
op_plus
id|clutid
suffix:semicolon
id|lx_krn-&gt;krn_csr
op_or_assign
(paren
id|LEO_KRN_CSR_UNK
op_or
id|LEO_KRN_CSR_UNK2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|leo_clutpost
r_static
r_int
id|leo_clutpost
(paren
id|fbinfo_t
op_star
id|fb
comma
r_struct
id|fb_clut
op_star
id|lc
)paren
(brace
r_int
id|xlate
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|u32
op_star
id|clut
suffix:semicolon
id|u8
op_star
id|xlut
op_assign
id|fb-&gt;info.leo.xlut
suffix:semicolon
r_switch
c_cond
(paren
id|lc-&gt;clutid
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|1
suffix:colon
r_case
l_int|2
suffix:colon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* gamma clut - not yet implemented */
r_case
l_int|4
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* degamma clut - not yet implemented */
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|clut
op_assign
id|fb-&gt;info.leo.cluts
(braket
id|lc-&gt;clutid
)braket
op_plus
id|lc-&gt;offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lc-&gt;count
suffix:semicolon
id|i
op_increment
)paren
op_star
id|clut
op_increment
op_assign
id|xlate
ques
c_cond
(paren
(paren
id|xlut
(braket
(paren
id|u8
)paren
(paren
id|lc-&gt;red
(braket
id|i
)braket
)paren
)braket
)paren
op_or
(paren
id|xlut
(braket
(paren
id|u8
)paren
(paren
id|lc-&gt;green
(braket
id|i
)braket
)paren
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|xlut
(braket
(paren
id|u8
)paren
(paren
id|lc-&gt;blue
(braket
id|i
)braket
)paren
)braket
op_lshift
l_int|16
)paren
)paren
suffix:colon
(paren
(paren
(paren
id|u8
)paren
(paren
id|lc-&gt;red
(braket
id|i
)braket
)paren
)paren
op_or
(paren
(paren
(paren
id|u8
)paren
(paren
id|lc-&gt;green
(braket
id|i
)braket
)paren
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|u8
)paren
(paren
id|lc-&gt;blue
(braket
id|i
)braket
)paren
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
r_return
id|leo_clutstore
(paren
id|fb
comma
id|lc-&gt;clutid
)paren
suffix:semicolon
)brace
DECL|function|leo_clutread
r_static
r_int
id|leo_clutread
(paren
id|fbinfo_t
op_star
id|fb
comma
r_struct
id|fb_clut
op_star
id|lc
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
id|u
suffix:semicolon
r_struct
id|leo_lx_krn
op_star
id|lx_krn
op_assign
id|fb-&gt;info.leo.lx_krn
suffix:semicolon
r_if
c_cond
(paren
id|lc-&gt;clutid
op_ge
l_int|3
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_CLUT0
op_plus
id|lc-&gt;clutid
suffix:semicolon
id|i
op_assign
id|leo_wait
(paren
id|lx_krn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|lx_krn-&gt;krn_csr
op_and_assign
op_complement
id|LEO_KRN_CSR_UNK2
suffix:semicolon
id|lx_krn-&gt;krn_csr
op_or_assign
id|LEO_KRN_CSR_UNK
suffix:semicolon
id|i
op_assign
id|leo_wait
(paren
id|lx_krn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|lx_krn-&gt;krn_type
op_assign
id|LEO_KRN_TYPE_CLUTDATA
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lc-&gt;offset
suffix:semicolon
id|i
op_increment
)paren
id|u
op_assign
id|lx_krn-&gt;krn_value
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|lc-&gt;count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u
op_assign
id|lx_krn-&gt;krn_value
suffix:semicolon
id|lc-&gt;red
(braket
id|i
)braket
op_assign
id|u
suffix:semicolon
id|lc-&gt;green
(braket
id|i
)braket
op_assign
(paren
id|u
op_rshift
l_int|8
)paren
suffix:semicolon
id|lc-&gt;blue
(braket
id|i
)braket
op_assign
(paren
id|u
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|leo_loadcmap
id|leo_loadcmap
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|index
comma
r_int
id|count
)paren
(brace
id|u32
op_star
id|clut
op_assign
(paren
(paren
id|u32
op_star
)paren
id|fb-&gt;info.leo.cluts
(braket
l_int|0
)braket
)paren
op_plus
id|index
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|index
suffix:semicolon
id|count
op_decrement
suffix:semicolon
id|i
op_increment
)paren
op_star
id|clut
op_increment
op_assign
(paren
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|0
)paren
)paren
)paren
op_or
(paren
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|1
)paren
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|2
)paren
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|leo_clutstore
(paren
id|fb
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle leo-specific ioctls */
r_static
r_int
DECL|function|leo_ioctl
id|leo_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|FBIO_WID_GET
suffix:colon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|fb_wid_list
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|wl_count
op_ne
l_int|1
op_logical_or
op_logical_neg
(paren
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|wl_list
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|wl_list
)paren
comma
(paren
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|wl_count
op_star
r_sizeof
(paren
r_struct
id|fb_wid_item
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_return
id|leo_wid_get
(paren
id|fb
comma
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|FBIO_WID_PUT
suffix:colon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|fb_wid_list
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|wl_count
op_ne
l_int|1
op_logical_or
op_logical_neg
(paren
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|wl_list
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|wl_list
)paren
comma
(paren
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|wl_count
op_star
r_sizeof
(paren
r_struct
id|fb_wid_item
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_return
id|leo_wid_put
(paren
id|fb
comma
(paren
r_struct
id|fb_wid_list
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|LEO_CLUTPOST
suffix:colon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|fb_clut
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|offset
op_plus
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|count
suffix:semicolon
r_if
c_cond
(paren
id|i
op_le
l_int|0
op_logical_or
id|i
OG
l_int|256
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|red
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|green
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|blue
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_return
id|leo_clutpost
(paren
id|fb
comma
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|LEO_CLUTREAD
suffix:colon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|fb_clut
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|offset
op_plus
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|count
suffix:semicolon
r_if
c_cond
(paren
id|i
op_le
l_int|0
op_logical_or
id|i
OG
l_int|256
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|red
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|green
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|blue
comma
(paren
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_return
id|leo_clutread
(paren
id|fb
comma
(paren
r_struct
id|fb_clut
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|leo_reset
id|leo_reset
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_if
c_cond
(paren
id|fb
op_eq
op_amp
id|fbinfo
(braket
l_int|0
)braket
)paren
id|sbus_hw_hide_cursor
(paren
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
r_int
id|leo_postsetup
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
r_int
id|memory_start
)paren
)paren
(brace
id|fb-&gt;info.leo.cluts
(braket
l_int|0
)braket
op_assign
(paren
id|u32
op_star
)paren
(paren
id|memory_start
)paren
suffix:semicolon
id|fb-&gt;info.leo.cluts
(braket
l_int|1
)braket
op_assign
(paren
id|u32
op_star
)paren
(paren
id|memory_start
op_plus
l_int|256
op_star
l_int|4
)paren
suffix:semicolon
id|fb-&gt;info.leo.cluts
(braket
l_int|2
)braket
op_assign
(paren
id|u32
op_star
)paren
(paren
id|memory_start
op_plus
l_int|256
op_star
l_int|4
op_star
l_int|2
)paren
suffix:semicolon
id|fb-&gt;info.leo.xlut
op_assign
(paren
id|u8
op_star
)paren
(paren
id|memory_start
op_plus
l_int|256
op_star
l_int|4
op_star
l_int|3
)paren
suffix:semicolon
id|fb-&gt;color_map
op_assign
(paren
id|u8
op_star
)paren
(paren
id|memory_start
op_plus
l_int|256
op_star
l_int|4
op_star
l_int|3
op_plus
l_int|256
)paren
suffix:semicolon
r_return
id|memory_start
op_plus
(paren
l_int|256
op_star
l_int|4
op_star
l_int|3
)paren
op_plus
l_int|256
op_plus
l_int|256
op_star
l_int|3
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|leo_setup
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|slot
comma
id|u32
id|leo
comma
r_int
id|leo_io
)paren
)paren
(brace
r_struct
id|leo_info
op_star
id|leoinfo
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|fb_wid_item
id|wi
suffix:semicolon
r_struct
id|fb_wid_list
id|wl
suffix:semicolon
id|printk
(paren
l_string|&quot;leo%d at 0x%8.8x &quot;
comma
id|slot
comma
id|leo
)paren
suffix:semicolon
multiline_comment|/* Fill in parameters we left out */
id|fb-&gt;type.fb_size
op_assign
l_int|0x800000
suffix:semicolon
multiline_comment|/* 8MB */
id|fb-&gt;type.fb_cmsize
op_assign
l_int|256
suffix:semicolon
id|fb-&gt;mmap
op_assign
id|leo_mmap
suffix:semicolon
id|fb-&gt;loadcmap
op_assign
id|leo_loadcmap
suffix:semicolon
id|fb-&gt;postsetup
op_assign
id|leo_postsetup
suffix:semicolon
id|fb-&gt;ioctl
op_assign
(paren
r_void
op_star
)paren
id|leo_ioctl
suffix:semicolon
id|fb-&gt;reset
op_assign
id|leo_reset
suffix:semicolon
id|fb-&gt;blank
op_assign
id|leo_blank
suffix:semicolon
id|fb-&gt;unblank
op_assign
id|leo_unblank
suffix:semicolon
id|fb-&gt;setcursor
op_assign
id|leo_setcursor
suffix:semicolon
id|fb-&gt;setcursormap
op_assign
id|leo_setcursormap
suffix:semicolon
id|fb-&gt;setcurshape
op_assign
id|leo_setcurshape
suffix:semicolon
id|fb-&gt;blitc
op_assign
id|leo_blitc
suffix:semicolon
id|fb-&gt;setw
op_assign
id|leo_setw
suffix:semicolon
id|fb-&gt;cpyw
op_assign
id|leo_cpyw
suffix:semicolon
id|fb-&gt;fill
op_assign
id|leo_fill
suffix:semicolon
id|fb-&gt;draw_penguin
op_assign
id|leo_penguin
suffix:semicolon
id|fb-&gt;base_depth
op_assign
l_int|0
suffix:semicolon
id|leoinfo
op_assign
(paren
r_struct
id|leo_info
op_star
)paren
op_amp
id|fb-&gt;info.leo
suffix:semicolon
id|memset
(paren
id|leoinfo
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|leo_info
)paren
)paren
suffix:semicolon
id|leoinfo-&gt;offset
op_assign
id|leo
suffix:semicolon
multiline_comment|/* Map the hardware registers */
id|leoinfo-&gt;lc_ss0_krn
op_assign
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_LC_SS0_KRN
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;leo_lc_ss0_krn&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|leoinfo-&gt;lc_ss0_usr
op_assign
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_LC_SS0_USR
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;leo_lc_ss0_usr&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|leoinfo-&gt;lc_ss1_krn
op_assign
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_LC_SS1_KRN
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;leo_lc_ss1_krn&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|leoinfo-&gt;lc_ss1_usr
op_assign
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_LC_SS1_USR
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;leo_lc_ss1_usr&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|leoinfo-&gt;ld_ss0
op_assign
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_LD_SS0
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;leo_ld_ss0&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|leoinfo-&gt;ld_ss1
op_assign
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_LD_SS1
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;leo_ld_ss1&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|leoinfo-&gt;ld_gbl
op_assign
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_LD_GBL
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;leo_ld_gbl&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|leoinfo-&gt;lx_krn
op_assign
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_LX_KRN
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;leo_lx_krn&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|leoinfo-&gt;cursor
op_assign
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_LX_CURSOR
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|leo_cursor
)paren
comma
l_string|&quot;leo_lx_crsr&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|fb-&gt;base
op_assign
(paren
r_int
)paren
id|sparc_alloc_io
c_func
(paren
id|leo
op_plus
id|LEO_OFF_SS0
comma
l_int|0
comma
l_int|0x800000
comma
l_string|&quot;leo_ss0&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|leoinfo-&gt;ld_ss0-&gt;unk
op_assign
l_int|0xffff
suffix:semicolon
id|leoinfo-&gt;ld_ss0-&gt;unk2
op_assign
l_int|0
suffix:semicolon
id|leoinfo-&gt;ld_ss0-&gt;unk3
op_assign
(paren
id|fb-&gt;type.fb_width
op_minus
l_int|1
)paren
op_or
(paren
(paren
id|fb-&gt;type.fb_height
op_minus
l_int|1
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|wl.wl_count
op_assign
l_int|1
suffix:semicolon
id|wl.wl_list
op_assign
op_amp
id|wi
suffix:semicolon
id|wi.wi_type
op_assign
id|FB_WID_DBL_8
suffix:semicolon
id|wi.wi_index
op_assign
l_int|0
suffix:semicolon
id|wi.wi_values
(braket
l_int|0
)braket
op_assign
l_int|0x2c0
suffix:semicolon
id|leo_wid_put
(paren
id|fb
comma
op_amp
id|wl
)paren
suffix:semicolon
id|wi.wi_index
op_assign
l_int|1
suffix:semicolon
id|wi.wi_values
(braket
l_int|0
)braket
op_assign
l_int|0x30
suffix:semicolon
id|leo_wid_put
(paren
id|fb
comma
op_amp
id|wl
)paren
suffix:semicolon
id|wi.wi_index
op_assign
l_int|2
suffix:semicolon
id|wi.wi_values
(braket
l_int|0
)braket
op_assign
l_int|0x20
suffix:semicolon
id|leo_wid_put
(paren
id|fb
comma
op_amp
id|wl
)paren
suffix:semicolon
id|leoinfo-&gt;ld_ss1-&gt;ss1_misc
op_or_assign
id|LEO_SS1_MISC_ENABLE
suffix:semicolon
id|leoinfo-&gt;ld_ss0-&gt;fg
op_assign
l_int|0x30703
suffix:semicolon
id|leoinfo-&gt;ld_ss0-&gt;planemask
op_assign
l_int|0xff000000
suffix:semicolon
id|leoinfo-&gt;ld_ss0-&gt;rop
op_assign
l_int|0xd0840
suffix:semicolon
id|leoinfo-&gt;lc_ss0_usr-&gt;extent
op_assign
(paren
id|fb-&gt;type.fb_width
op_minus
l_int|1
)paren
op_or
(paren
(paren
id|fb-&gt;type.fb_height
op_minus
l_int|1
)paren
op_lshift
l_int|11
)paren
suffix:semicolon
id|i
op_assign
id|leoinfo-&gt;lc_ss0_usr-&gt;attrs
suffix:semicolon
id|leoinfo-&gt;lc_ss0_usr-&gt;fill
op_assign
(paren
l_int|0
)paren
op_or
(paren
(paren
l_int|0
)paren
op_lshift
l_int|11
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|3
)paren
op_lshift
l_int|29
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|8
)paren
ques
c_cond
l_int|0x80000000
suffix:colon
l_int|0
)paren
suffix:semicolon
r_do
(brace
id|i
op_assign
id|leoinfo-&gt;lc_ss0_usr-&gt;csr
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_amp
l_int|0x20000000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot
op_eq
id|sun_prom_console_id
)paren
id|fb_restore_palette
op_assign
id|leo_restore_palette
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cmd Rev %d&bslash;n&quot;
comma
(paren
id|leoinfo-&gt;lc_ss0_krn-&gt;rev
op_rshift
l_int|28
)paren
)paren
suffix:semicolon
multiline_comment|/* Reset the leo */
id|leo_reset
c_func
(paren
id|fb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
multiline_comment|/* Enable Video */
id|leo_unblank
(paren
id|fb
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|slot
op_ne
id|sun_prom_console_id
)paren
id|leo_blank
(paren
id|fb
)paren
suffix:semicolon
)brace
r_extern
r_int
r_char
id|vga_font
(braket
)braket
suffix:semicolon
DECL|macro|GX_BLITC_START
mdefine_line|#define GX_BLITC_START(attr,x,y,count) &bslash;&n;&t;{ &bslash;&n;&t;&t;register struct leo_lc_ss0_usr *us = fbinfo[0].info.leo.lc_ss0_usr; &bslash;&n;&t;&t;register struct leo_ld_ss0 *ss = fbinfo[0].info.leo.ld_ss0; &bslash;&n;&t;&t;register u32 i; &bslash;&n;&t;&t;do { &bslash;&n;&t;&t;&t;i = us-&gt;csr; &bslash;&n;&t;&t;} while (i &amp; 0x20000000); &bslash;&n;&t;&t;ss-&gt;fg = (attr &amp; 0xf) &lt;&lt; 24; &bslash;&n;&t;&t;ss-&gt;bg = (attr &gt;&gt; 4) &lt;&lt; 24; &bslash;&n;&t;&t;ss-&gt;rop = 0x310040; &bslash;&n;&t;&t;ss-&gt;planemask = 0xff000000; &bslash;&n;&t;&t;us-&gt;fontc2 = 0xFFFFFFFE; &bslash;&n;&t;&t;us-&gt;attrs = 4; &bslash;&n;&t;&t;us-&gt;fontc = 0xFF000000;
DECL|macro|GX_BLITC_END
mdefine_line|#define GX_BLITC_END &bslash;&n;&t;}
DECL|function|leo_blitc
r_static
r_void
id|leo_blitc
c_func
(paren
r_int
r_int
id|charattr
comma
r_int
id|xoff
comma
r_int
id|yoff
)paren
(brace
r_int
r_char
id|attrib
op_assign
id|CHARATTR_TO_SUNCOLOR
c_func
(paren
id|charattr
)paren
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
op_amp
id|vga_font
(braket
(paren
(paren
r_int
r_char
)paren
id|charattr
)paren
op_lshift
l_int|4
)braket
suffix:semicolon
id|u32
op_star
id|u
op_assign
(paren
(paren
id|u32
op_star
)paren
id|fbinfo
(braket
l_int|0
)braket
dot
id|base
)paren
op_plus
(paren
id|yoff
op_lshift
l_int|11
)paren
op_plus
id|xoff
suffix:semicolon
id|GX_BLITC_START
c_func
(paren
id|attrib
comma
id|xoff
comma
id|yoff
comma
l_int|1
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CHAR_HEIGHT
suffix:semicolon
id|i
op_increment
comma
id|u
op_add_assign
l_int|2048
)paren
op_star
id|u
op_assign
(paren
op_star
id|p
op_increment
)paren
op_lshift
l_int|24
suffix:semicolon
id|GX_BLITC_END
)brace
DECL|function|leo_setw
r_static
r_void
id|leo_setw
c_func
(paren
r_int
id|xoff
comma
r_int
id|yoff
comma
r_int
r_int
id|c
comma
r_int
id|count
)paren
(brace
r_int
r_char
id|attrib
op_assign
id|CHARATTR_TO_SUNCOLOR
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
op_amp
id|vga_font
(braket
(paren
(paren
r_int
r_char
)paren
id|c
)paren
op_lshift
l_int|4
)braket
suffix:semicolon
r_register
r_int
r_char
op_star
id|q
suffix:semicolon
id|u32
op_star
id|u
op_assign
(paren
(paren
id|u32
op_star
)paren
id|fbinfo
(braket
l_int|0
)braket
dot
id|base
)paren
op_plus
(paren
id|yoff
op_lshift
l_int|11
)paren
op_plus
id|xoff
suffix:semicolon
id|GX_BLITC_START
c_func
(paren
id|attrib
comma
id|xoff
comma
id|yoff
comma
id|count
)paren
r_while
c_loop
(paren
id|count
op_decrement
OG
l_int|0
)paren
(brace
id|q
op_assign
id|p
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CHAR_HEIGHT
suffix:semicolon
id|i
op_increment
comma
id|u
op_add_assign
l_int|2048
)paren
op_star
id|u
op_assign
(paren
op_star
id|q
op_increment
)paren
op_lshift
l_int|24
suffix:semicolon
id|u
op_add_assign
l_int|8
op_minus
(paren
id|CHAR_HEIGHT
op_star
l_int|2048
)paren
suffix:semicolon
)brace
id|GX_BLITC_END
)brace
DECL|function|leo_cpyw
r_static
r_void
id|leo_cpyw
c_func
(paren
r_int
id|xoff
comma
r_int
id|yoff
comma
r_int
r_int
op_star
id|p
comma
r_int
id|count
)paren
(brace
r_int
r_char
id|attrib
op_assign
id|CHARATTR_TO_SUNCOLOR
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
r_register
r_int
r_char
op_star
id|q
suffix:semicolon
id|u32
op_star
id|u
op_assign
(paren
(paren
id|u32
op_star
)paren
id|fbinfo
(braket
l_int|0
)braket
dot
id|base
)paren
op_plus
(paren
id|yoff
op_lshift
l_int|11
)paren
op_plus
id|xoff
suffix:semicolon
id|GX_BLITC_START
c_func
(paren
id|attrib
comma
id|xoff
comma
id|yoff
comma
id|count
)paren
r_while
c_loop
(paren
id|count
op_decrement
OG
l_int|0
)paren
(brace
id|q
op_assign
op_amp
id|vga_font
(braket
(paren
(paren
r_int
r_char
)paren
op_star
id|p
op_increment
)paren
op_lshift
l_int|4
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CHAR_HEIGHT
suffix:semicolon
id|i
op_increment
comma
id|u
op_add_assign
l_int|2048
)paren
op_star
id|u
op_assign
(paren
op_star
id|q
op_increment
)paren
op_lshift
l_int|24
suffix:semicolon
id|u
op_add_assign
l_int|8
op_minus
(paren
id|CHAR_HEIGHT
op_star
l_int|2048
)paren
suffix:semicolon
)brace
id|GX_BLITC_END
)brace
DECL|function|leo_fill
r_static
r_void
id|leo_fill
c_func
(paren
r_int
id|attrib
comma
r_int
id|count
comma
r_int
op_star
id|boxes
)paren
(brace
r_register
r_struct
id|leo_lc_ss0_usr
op_star
id|us
op_assign
id|fbinfo
(braket
l_int|0
)braket
dot
id|info.leo.lc_ss0_usr
suffix:semicolon
r_register
r_struct
id|leo_ld_ss0
op_star
id|ss
op_assign
id|fbinfo
(braket
l_int|0
)braket
dot
id|info.leo.ld_ss0
suffix:semicolon
r_register
id|u32
id|i
suffix:semicolon
r_do
(brace
id|i
op_assign
id|us-&gt;csr
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_amp
l_int|0x20000000
)paren
suffix:semicolon
id|ss-&gt;unk
op_assign
l_int|0xffff
suffix:semicolon
id|ss-&gt;unk2
op_assign
l_int|0
suffix:semicolon
id|ss-&gt;unk3
op_assign
(paren
id|fbinfo
(braket
l_int|0
)braket
dot
id|type.fb_width
op_minus
l_int|1
)paren
op_or
(paren
(paren
id|fbinfo
(braket
l_int|0
)braket
dot
id|type.fb_height
op_minus
l_int|1
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|ss-&gt;fg
op_assign
(paren
(paren
id|attrib
op_amp
l_int|0xf
)paren
op_lshift
l_int|24
)paren
op_or
l_int|0x030703
suffix:semicolon
id|ss-&gt;planemask
op_assign
l_int|0xff000000
suffix:semicolon
id|ss-&gt;rop
op_assign
l_int|0xd0840
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
OG
l_int|0
)paren
(brace
id|us-&gt;extent
op_assign
(paren
(paren
id|boxes
(braket
l_int|2
)braket
op_minus
id|boxes
(braket
l_int|0
)braket
op_minus
l_int|1
)paren
op_amp
l_int|0x7ff
)paren
op_or
(paren
(paren
(paren
id|boxes
(braket
l_int|3
)braket
op_minus
id|boxes
(braket
l_int|1
)braket
op_minus
l_int|1
)paren
op_amp
l_int|0x7ff
)paren
op_lshift
l_int|11
)paren
suffix:semicolon
id|i
op_assign
id|us-&gt;attrs
suffix:semicolon
id|us-&gt;fill
op_assign
(paren
id|boxes
(braket
l_int|0
)braket
op_amp
l_int|0x7ff
)paren
op_or
(paren
(paren
id|boxes
(braket
l_int|1
)braket
op_amp
l_int|0x7ff
)paren
op_lshift
l_int|11
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|3
)paren
op_lshift
l_int|29
)paren
op_or
(paren
(paren
id|i
op_amp
l_int|8
)paren
ques
c_cond
l_int|0x80000000
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|leo_penguin
c_func
(paren
r_int
id|x_margin
comma
r_int
id|y_margin
comma
r_int
id|ncpus
)paren
)paren
(brace
id|suncons_ops
dot
id|clear_screen
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* FIXME: Write this */
)brace
eof
