multiline_comment|/* $Id: pcikbd.c,v 1.49 2000/07/13 08:06:40 davem Exp $&n; * pcikbd.c: Ultra/AX PC keyboard support.&n; *&n; * Copyright (C) 1997  Eddie C. Dost  (ecd@skynet.be)&n; * JavaStation support by Pete A. Zaitcev.&n; *&n; * This code is mainly put together from various places in&n; * drivers/char, please refer to these sources for credits&n; * to the original authors.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/kbd_ll.h&gt;
macro_line|#include &lt;linux/kbd_kern.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/ebus.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/*&n; * Different platforms provide different permutations of names.&n; * AXi - kb_ps2, kdmouse.&n; * MrCoffee - keyboard, mouse.&n; * Espresso - keyboard, kdmouse.&n; */
DECL|macro|PCI_KB_NAME1
mdefine_line|#define&t;PCI_KB_NAME1&t;&quot;kb_ps2&quot;
DECL|macro|PCI_KB_NAME2
mdefine_line|#define PCI_KB_NAME2&t;&quot;keyboard&quot;
DECL|macro|PCI_MS_NAME1
mdefine_line|#define PCI_MS_NAME1&t;&quot;kdmouse&quot;
DECL|macro|PCI_MS_NAME2
mdefine_line|#define PCI_MS_NAME2&t;&quot;mouse&quot;
macro_line|#include &quot;pcikbd.h&quot;
macro_line|#include &quot;sunserial.h&quot;
macro_line|#ifndef __sparc_v9__
DECL|variable|pcikbd_mrcoffee
r_static
r_int
id|pcikbd_mrcoffee
op_assign
l_int|0
suffix:semicolon
macro_line|#else
DECL|macro|pcikbd_mrcoffee
mdefine_line|#define pcikbd_mrcoffee 0
macro_line|#endif
DECL|variable|pcikbd_iobase
r_static
r_int
r_int
id|pcikbd_iobase
op_assign
l_int|0
suffix:semicolon
DECL|variable|pcikbd_irq
r_static
r_int
r_int
id|pcikbd_irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* used only by send_data - set by keyboard_interrupt */
DECL|variable|reply_expected
r_static
r_volatile
r_int
r_char
id|reply_expected
op_assign
l_int|0
suffix:semicolon
DECL|variable|acknowledge
r_static
r_volatile
r_int
r_char
id|acknowledge
op_assign
l_int|0
suffix:semicolon
DECL|variable|resend
r_static
r_volatile
r_int
r_char
id|resend
op_assign
l_int|0
suffix:semicolon
DECL|variable|pcikbd_lock
r_static
id|spinlock_t
id|pcikbd_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|pckbd_read_mask
r_int
r_char
id|pckbd_read_mask
op_assign
id|KBD_STAT_OBF
suffix:semicolon
r_extern
r_int
id|pcikbd_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|pci_compute_shiftstate
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|pci_setkeycode
c_func
(paren
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|pci_getkeycode
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_void
id|pci_setledstate
c_func
(paren
r_struct
id|kbd_struct
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
r_char
id|pci_getledstate
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|macro|pcikbd_inb
mdefine_line|#define pcikbd_inb(x)     inb(x)
DECL|macro|pcikbd_outb
mdefine_line|#define pcikbd_outb(v,x)  outb(v,x)
multiline_comment|/* Wait for keyboard controller input buffer to drain.&n; * Must be invoked under the pcikbd_lock.&n; */
DECL|function|kb_wait
r_static
r_void
id|kb_wait
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|timeout
op_assign
l_int|250
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcikbd_inb
c_func
(paren
id|pcikbd_iobase
op_plus
id|KBD_STATUS_REG
)paren
op_amp
id|KBD_STAT_IBF
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|timeout
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Translation of escaped scancodes to keycodes.&n; * This is now user-settable.&n; * The keycodes 1-88,96-111,119 are fairly standard, and&n; * should probably not be changed - changing might confuse X.&n; * X also interprets scancode 0x5d (KEY_Begin).&n; *&n; * For 1-88 keycode equals scancode.&n; */
DECL|macro|E0_KPENTER
mdefine_line|#define E0_KPENTER 96
DECL|macro|E0_RCTRL
mdefine_line|#define E0_RCTRL   97
DECL|macro|E0_KPSLASH
mdefine_line|#define E0_KPSLASH 98
DECL|macro|E0_PRSCR
mdefine_line|#define E0_PRSCR   99
DECL|macro|E0_RALT
mdefine_line|#define E0_RALT    100
DECL|macro|E0_BREAK
mdefine_line|#define E0_BREAK   101  /* (control-pause) */
DECL|macro|E0_HOME
mdefine_line|#define E0_HOME    102
DECL|macro|E0_UP
mdefine_line|#define E0_UP      103
DECL|macro|E0_PGUP
mdefine_line|#define E0_PGUP    104
DECL|macro|E0_LEFT
mdefine_line|#define E0_LEFT    105
DECL|macro|E0_RIGHT
mdefine_line|#define E0_RIGHT   106
DECL|macro|E0_END
mdefine_line|#define E0_END     107
DECL|macro|E0_DOWN
mdefine_line|#define E0_DOWN    108
DECL|macro|E0_PGDN
mdefine_line|#define E0_PGDN    109
DECL|macro|E0_INS
mdefine_line|#define E0_INS     110
DECL|macro|E0_DEL
mdefine_line|#define E0_DEL     111
DECL|macro|E1_PAUSE
mdefine_line|#define E1_PAUSE   119
multiline_comment|/*&n; * The keycodes below are randomly located in 89-95,112-118,120-127.&n; * They could be thrown away (and all occurrences below replaced by 0),&n; * but that would force many users to use the `setkeycodes&squot; utility, where&n; * they needed not before. It does not matter that there are duplicates, as&n; * long as no duplication occurs for any single keyboard.&n; */
DECL|macro|SC_LIM
mdefine_line|#define SC_LIM 89
DECL|macro|FOCUS_PF1
mdefine_line|#define FOCUS_PF1 85           /* actual code! */
DECL|macro|FOCUS_PF2
mdefine_line|#define FOCUS_PF2 89
DECL|macro|FOCUS_PF3
mdefine_line|#define FOCUS_PF3 90
DECL|macro|FOCUS_PF4
mdefine_line|#define FOCUS_PF4 91
DECL|macro|FOCUS_PF5
mdefine_line|#define FOCUS_PF5 92
DECL|macro|FOCUS_PF6
mdefine_line|#define FOCUS_PF6 93
DECL|macro|FOCUS_PF7
mdefine_line|#define FOCUS_PF7 94
DECL|macro|FOCUS_PF8
mdefine_line|#define FOCUS_PF8 95
DECL|macro|FOCUS_PF9
mdefine_line|#define FOCUS_PF9 120
DECL|macro|FOCUS_PF10
mdefine_line|#define FOCUS_PF10 121
DECL|macro|FOCUS_PF11
mdefine_line|#define FOCUS_PF11 122
DECL|macro|FOCUS_PF12
mdefine_line|#define FOCUS_PF12 123
DECL|macro|JAP_86
mdefine_line|#define JAP_86     124
multiline_comment|/* tfj@olivia.ping.dk:&n; * The four keys are located over the numeric keypad, and are&n; * labelled A1-A4. It&squot;s an rc930 keyboard, from&n; * Regnecentralen/RC International, Now ICL.&n; * Scancodes: 59, 5a, 5b, 5c.&n; */
DECL|macro|RGN1
mdefine_line|#define RGN1 124
DECL|macro|RGN2
mdefine_line|#define RGN2 125
DECL|macro|RGN3
mdefine_line|#define RGN3 126
DECL|macro|RGN4
mdefine_line|#define RGN4 127
DECL|variable|high_keys
r_static
r_int
r_char
id|high_keys
(braket
l_int|128
op_minus
id|SC_LIM
)braket
op_assign
(brace
id|RGN1
comma
id|RGN2
comma
id|RGN3
comma
id|RGN4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x59-0x5f */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x60-0x67 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|FOCUS_PF11
comma
l_int|0
comma
id|FOCUS_PF12
comma
multiline_comment|/* 0x68-0x6f */
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|FOCUS_PF2
comma
id|FOCUS_PF9
comma
l_int|0
comma
l_int|0
comma
id|FOCUS_PF3
comma
multiline_comment|/* 0x70-0x77 */
id|FOCUS_PF4
comma
id|FOCUS_PF5
comma
id|FOCUS_PF6
comma
id|FOCUS_PF7
comma
multiline_comment|/* 0x78-0x7b */
id|FOCUS_PF8
comma
id|JAP_86
comma
id|FOCUS_PF10
comma
l_int|0
multiline_comment|/* 0x7c-0x7f */
)brace
suffix:semicolon
multiline_comment|/* BTC */
DECL|macro|E0_MACRO
mdefine_line|#define E0_MACRO   112
multiline_comment|/* LK450 */
DECL|macro|E0_F13
mdefine_line|#define E0_F13     113
DECL|macro|E0_F14
mdefine_line|#define E0_F14     114
DECL|macro|E0_HELP
mdefine_line|#define E0_HELP    115
DECL|macro|E0_DO
mdefine_line|#define E0_DO      116
DECL|macro|E0_F17
mdefine_line|#define E0_F17     117
DECL|macro|E0_KPMINPLUS
mdefine_line|#define E0_KPMINPLUS 118
multiline_comment|/*&n; * My OmniKey generates e0 4c for  the &quot;OMNI&quot; key and the&n; * right alt key does nada. [kkoller@nyx10.cs.du.edu]&n; */
DECL|macro|E0_OK
mdefine_line|#define E0_OK&t;124
multiline_comment|/*&n; * New microsoft keyboard is rumoured to have&n; * e0 5b (left window button), e0 5c (right window button),&n; * e0 5d (menu button). [or: LBANNER, RBANNER, RMENU]&n; * [or: Windows_L, Windows_R, TaskMan]&n; */
DECL|macro|E0_MSLW
mdefine_line|#define E0_MSLW&t;125
DECL|macro|E0_MSRW
mdefine_line|#define E0_MSRW&t;126
DECL|macro|E0_MSTM
mdefine_line|#define E0_MSTM&t;127
DECL|variable|e0_keys
r_static
r_int
r_char
id|e0_keys
(braket
l_int|128
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x00-0x07 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x08-0x0f */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x10-0x17 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|E0_KPENTER
comma
id|E0_RCTRL
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x18-0x1f */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x20-0x27 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x28-0x2f */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|E0_KPSLASH
comma
l_int|0
comma
id|E0_PRSCR
comma
multiline_comment|/* 0x30-0x37 */
id|E0_RALT
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|E0_F13
comma
id|E0_F14
comma
id|E0_HELP
comma
multiline_comment|/* 0x38-0x3f */
id|E0_DO
comma
id|E0_F17
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|E0_BREAK
comma
id|E0_HOME
comma
multiline_comment|/* 0x40-0x47 */
id|E0_UP
comma
id|E0_PGUP
comma
l_int|0
comma
id|E0_LEFT
comma
id|E0_OK
comma
id|E0_RIGHT
comma
id|E0_KPMINPLUS
comma
id|E0_END
comma
multiline_comment|/* 0x48-0x4f */
id|E0_DOWN
comma
id|E0_PGDN
comma
id|E0_INS
comma
id|E0_DEL
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x50-0x57 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|E0_MSLW
comma
id|E0_MSRW
comma
id|E0_MSTM
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x58-0x5f */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x60-0x67 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|E0_MACRO
comma
multiline_comment|/* 0x68-0x6f */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0x70-0x77 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
multiline_comment|/* 0x78-0x7f */
)brace
suffix:semicolon
multiline_comment|/* Simple translation table for the SysRq keys */
macro_line|#ifdef CONFIG_MAGIC_SYSRQ
DECL|variable|pcikbd_sysrq_xlate
r_int
r_char
id|pcikbd_sysrq_xlate
(braket
l_int|128
)braket
op_assign
l_string|&quot;&bslash;000&bslash;0331234567890-=&bslash;177&bslash;t&quot;
multiline_comment|/* 0x00 - 0x0f */
l_string|&quot;qwertyuiop[]&bslash;r&bslash;000as&quot;
multiline_comment|/* 0x10 - 0x1f */
l_string|&quot;dfghjkl;&squot;`&bslash;000&bslash;&bslash;zxcv&quot;
multiline_comment|/* 0x20 - 0x2f */
l_string|&quot;bnm,./&bslash;000*&bslash;000 &bslash;000&bslash;201&bslash;202&bslash;203&bslash;204&bslash;205&quot;
multiline_comment|/* 0x30 - 0x3f */
l_string|&quot;&bslash;206&bslash;207&bslash;210&bslash;211&bslash;212&bslash;000&bslash;000789-456+1&quot;
multiline_comment|/* 0x40 - 0x4f */
l_string|&quot;230&bslash;177&bslash;000&bslash;000&bslash;213&bslash;214&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&quot;
multiline_comment|/* 0x50 - 0x5f */
l_string|&quot;&bslash;r&bslash;000/&quot;
suffix:semicolon
multiline_comment|/* 0x60 - 0x6f */
macro_line|#endif
DECL|function|pcikbd_setkeycode
r_int
id|pcikbd_setkeycode
c_func
(paren
r_int
r_int
id|scancode
comma
r_int
r_int
id|keycode
)paren
(brace
r_if
c_cond
(paren
id|scancode
template_param
l_int|255
op_logical_or
id|keycode
OG
l_int|127
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scancode
OL
l_int|128
)paren
(brace
id|high_keys
(braket
id|scancode
op_minus
id|SC_LIM
)braket
op_assign
id|keycode
suffix:semicolon
)brace
r_else
id|e0_keys
(braket
id|scancode
op_minus
l_int|128
)braket
op_assign
id|keycode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcikbd_getkeycode
r_int
id|pcikbd_getkeycode
c_func
(paren
r_int
r_int
id|scancode
)paren
(brace
r_return
(paren
id|scancode
template_param
l_int|255
)paren
ques
c_cond
op_minus
id|EINVAL
suffix:colon
(paren
id|scancode
OL
l_int|128
)paren
ques
c_cond
id|high_keys
(braket
id|scancode
op_minus
id|SC_LIM
)braket
suffix:colon
id|e0_keys
(braket
id|scancode
op_minus
l_int|128
)braket
suffix:semicolon
)brace
DECL|function|do_acknowledge
r_int
id|do_acknowledge
c_func
(paren
r_int
r_char
id|scancode
)paren
(brace
r_if
c_cond
(paren
id|reply_expected
)paren
(brace
r_if
c_cond
(paren
id|scancode
op_eq
id|KBD_REPLY_ACK
)paren
(brace
id|acknowledge
op_assign
l_int|1
suffix:semicolon
id|reply_expected
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scancode
op_eq
id|KBD_REPLY_RESEND
)paren
(brace
id|resend
op_assign
l_int|1
suffix:semicolon
id|reply_expected
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pcikbd_translate
r_int
id|pcikbd_translate
c_func
(paren
r_int
r_char
id|scancode
comma
r_int
r_char
op_star
id|keycode
comma
r_char
id|raw_mode
)paren
(brace
r_static
r_int
id|prev_scancode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scancode
op_eq
l_int|0xe0
op_logical_or
id|scancode
op_eq
l_int|0xe1
)paren
(brace
id|prev_scancode
op_assign
id|scancode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scancode
op_eq
l_int|0x00
op_logical_or
id|scancode
op_eq
l_int|0xff
)paren
(brace
id|prev_scancode
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|scancode
op_and_assign
l_int|0x7f
suffix:semicolon
r_if
c_cond
(paren
id|prev_scancode
)paren
(brace
r_if
c_cond
(paren
id|prev_scancode
op_ne
l_int|0xe0
)paren
(brace
r_if
c_cond
(paren
id|prev_scancode
op_eq
l_int|0xe1
op_logical_and
id|scancode
op_eq
l_int|0x1d
)paren
(brace
id|prev_scancode
op_assign
l_int|0x100
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|prev_scancode
op_eq
l_int|0x100
op_logical_and
id|scancode
op_eq
l_int|0x45
)paren
(brace
op_star
id|keycode
op_assign
id|E1_PAUSE
suffix:semicolon
id|prev_scancode
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|prev_scancode
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|prev_scancode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scancode
op_eq
l_int|0x2a
op_logical_or
id|scancode
op_eq
l_int|0x36
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e0_keys
(braket
id|scancode
)braket
)paren
(brace
op_star
id|keycode
op_assign
id|e0_keys
(braket
id|scancode
)braket
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|scancode
op_ge
id|SC_LIM
)paren
(brace
op_star
id|keycode
op_assign
id|high_keys
(braket
id|scancode
op_minus
id|SC_LIM
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|keycode
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
op_star
id|keycode
op_assign
id|scancode
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pcikbd_unexpected_up
r_char
id|pcikbd_unexpected_up
c_func
(paren
r_int
r_char
id|keycode
)paren
(brace
r_if
c_cond
(paren
id|keycode
op_ge
id|SC_LIM
op_logical_or
id|keycode
op_eq
l_int|85
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
l_int|0200
suffix:semicolon
)brace
r_static
r_void
DECL|function|pcikbd_interrupt
id|pcikbd_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
id|kbd_pt_regs
op_assign
id|regs
suffix:semicolon
id|status
op_assign
id|pcikbd_inb
c_func
(paren
id|pcikbd_iobase
op_plus
id|KBD_STATUS_REG
)paren
suffix:semicolon
r_do
(brace
r_int
r_char
id|scancode
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|pckbd_read_mask
op_amp
id|KBD_STAT_MOUSE_OBF
)paren
(brace
r_break
suffix:semicolon
)brace
id|scancode
op_assign
id|pcikbd_inb
c_func
(paren
id|pcikbd_iobase
op_plus
id|KBD_DATA_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|KBD_STAT_OBF
)paren
op_logical_and
id|do_acknowledge
c_func
(paren
id|scancode
)paren
)paren
(brace
id|handle_scancode
c_func
(paren
id|scancode
comma
op_logical_neg
(paren
id|scancode
op_amp
l_int|0x80
)paren
)paren
suffix:semicolon
)brace
id|status
op_assign
id|pcikbd_inb
c_func
(paren
id|pcikbd_iobase
op_plus
id|KBD_STATUS_REG
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
op_amp
id|KBD_STAT_OBF
)paren
(brace
suffix:semicolon
)brace
id|tasklet_schedule
c_func
(paren
op_amp
id|keyboard_tasklet
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|send_data
r_static
r_int
id|send_data
c_func
(paren
r_int
r_char
id|data
)paren
(brace
r_int
id|retries
op_assign
l_int|3
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_do
(brace
r_int
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
id|kb_wait
c_func
(paren
)paren
suffix:semicolon
id|acknowledge
op_assign
l_int|0
suffix:semicolon
id|resend
op_assign
l_int|0
suffix:semicolon
id|reply_expected
op_assign
l_int|1
suffix:semicolon
id|pcikbd_outb
c_func
(paren
id|data
comma
id|pcikbd_iobase
op_plus
id|KBD_DATA_REG
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|acknowledge
)paren
r_goto
id|out_ack
suffix:semicolon
r_if
c_cond
(paren
id|resend
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
r_goto
id|out_timeout
suffix:semicolon
)brace
r_while
c_loop
(paren
id|retries
op_decrement
OG
l_int|0
)paren
suffix:semicolon
id|out_timeout
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_ack
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pcikbd_leds
r_void
id|pcikbd_leds
c_func
(paren
r_int
r_char
id|leds
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|send_data
c_func
(paren
id|KBD_CMD_SET_LEDS
)paren
op_logical_or
op_logical_neg
id|send_data
c_func
(paren
id|leds
)paren
)paren
(brace
id|send_data
c_func
(paren
id|KBD_CMD_ENABLE
)paren
suffix:semicolon
)brace
)brace
DECL|function|pcikbd_wait_for_input
r_static
r_int
id|__init
id|pcikbd_wait_for_input
c_func
(paren
r_void
)paren
(brace
r_int
id|status
comma
id|data
suffix:semicolon
r_int
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_do
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|status
op_assign
id|pcikbd_inb
c_func
(paren
id|pcikbd_iobase
op_plus
id|KBD_STATUS_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|KBD_STAT_OBF
)paren
)paren
r_continue
suffix:semicolon
id|data
op_assign
id|pcikbd_inb
c_func
(paren
id|pcikbd_iobase
op_plus
id|KBD_DATA_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|KBD_STAT_GTO
op_or
id|KBD_STAT_PERR
)paren
)paren
r_continue
suffix:semicolon
r_return
(paren
id|data
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|timeout
OG
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|pcikbd_write
r_static
r_void
id|__init
id|pcikbd_write
c_func
(paren
r_int
id|address
comma
r_int
id|data
)paren
(brace
r_int
id|status
suffix:semicolon
r_do
(brace
id|status
op_assign
id|pcikbd_inb
c_func
(paren
id|pcikbd_iobase
op_plus
id|KBD_STATUS_REG
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
op_amp
id|KBD_STAT_IBF
)paren
suffix:semicolon
id|pcikbd_outb
c_func
(paren
id|data
comma
id|pcikbd_iobase
op_plus
id|address
)paren
suffix:semicolon
)brace
macro_line|#ifdef __sparc_v9__
DECL|variable|pcibeep_iobase
r_static
r_int
r_int
id|pcibeep_iobase
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Timer routine to turn off the beep after the interval expires. */
DECL|function|pcikbd_kd_nosound
r_static
r_void
id|pcikbd_kd_nosound
c_func
(paren
r_int
r_int
id|__unused
)paren
(brace
id|outl
c_func
(paren
l_int|0
comma
id|pcibeep_iobase
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initiate a keyboard beep. If the frequency is zero, then we stop&n; * the beep. Any other frequency will start a monotone beep. The beep&n; * will be stopped by a timer after &quot;ticks&quot; jiffies. If ticks is 0,&n; * then we do not start a timer.&n; */
DECL|function|pcikbd_kd_mksound
r_static
r_void
id|pcikbd_kd_mksound
c_func
(paren
r_int
r_int
id|hz
comma
r_int
r_int
id|ticks
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_static
r_struct
id|timer_list
id|sound_timer
op_assign
(brace
id|function
suffix:colon
id|pcikbd_kd_nosound
)brace
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|sound_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hz
)paren
(brace
id|outl
c_func
(paren
l_int|1
comma
id|pcibeep_iobase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ticks
)paren
(brace
id|sound_timer.expires
op_assign
id|jiffies
op_plus
id|ticks
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sound_timer
)paren
suffix:semicolon
)brace
)brace
r_else
id|outl
c_func
(paren
l_int|0
comma
id|pcibeep_iobase
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|nop_kd_mksound
r_static
r_void
id|nop_kd_mksound
c_func
(paren
r_int
r_int
id|hz
comma
r_int
r_int
id|ticks
)paren
(brace
)brace
r_extern
r_void
(paren
op_star
id|kd_mksound
)paren
(paren
r_int
r_int
id|hz
comma
r_int
r_int
id|ticks
)paren
suffix:semicolon
DECL|function|do_pcikbd_init_hw
r_static
r_char
op_star
id|__init
id|do_pcikbd_init_hw
c_func
(paren
r_void
)paren
(brace
r_while
c_loop
(paren
id|pcikbd_wait_for_input
c_func
(paren
)paren
op_ne
op_minus
l_int|1
)paren
(brace
suffix:semicolon
)brace
id|pcikbd_write
c_func
(paren
id|KBD_CNTL_REG
comma
id|KBD_CCMD_SELF_TEST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcikbd_wait_for_input
c_func
(paren
)paren
op_ne
l_int|0x55
)paren
(brace
r_return
l_string|&quot;Keyboard failed self test&quot;
suffix:semicolon
)brace
id|pcikbd_write
c_func
(paren
id|KBD_CNTL_REG
comma
id|KBD_CCMD_KBD_TEST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcikbd_wait_for_input
c_func
(paren
)paren
op_ne
l_int|0x00
)paren
(brace
r_return
l_string|&quot;Keyboard interface failed self test&quot;
suffix:semicolon
)brace
id|pcikbd_write
c_func
(paren
id|KBD_CNTL_REG
comma
id|KBD_CCMD_KBD_ENABLE
)paren
suffix:semicolon
id|pcikbd_write
c_func
(paren
id|KBD_DATA_REG
comma
id|KBD_CMD_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcikbd_wait_for_input
c_func
(paren
)paren
op_ne
id|KBD_REPLY_ACK
)paren
(brace
r_return
l_string|&quot;Keyboard reset failed, no ACK&quot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcikbd_wait_for_input
c_func
(paren
)paren
op_ne
id|KBD_REPLY_POR
)paren
(brace
r_return
l_string|&quot;Keyboard reset failed, no ACK&quot;
suffix:semicolon
)brace
id|pcikbd_write
c_func
(paren
id|KBD_DATA_REG
comma
id|KBD_CMD_DISABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcikbd_wait_for_input
c_func
(paren
)paren
op_ne
id|KBD_REPLY_ACK
)paren
(brace
r_return
l_string|&quot;Disable keyboard: no ACK&quot;
suffix:semicolon
)brace
id|pcikbd_write
c_func
(paren
id|KBD_CNTL_REG
comma
id|KBD_CCMD_WRITE_MODE
)paren
suffix:semicolon
id|pcikbd_write
c_func
(paren
id|KBD_DATA_REG
comma
(paren
id|KBD_MODE_KBD_INT
op_or
id|KBD_MODE_SYS
op_or
id|KBD_MODE_DISABLE_MOUSE
op_or
id|KBD_MODE_KCC
)paren
)paren
suffix:semicolon
id|pcikbd_write
c_func
(paren
id|KBD_DATA_REG
comma
id|KBD_CMD_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcikbd_wait_for_input
c_func
(paren
)paren
op_ne
id|KBD_REPLY_ACK
)paren
(brace
r_return
l_string|&quot;Enable keyboard: no ACK&quot;
suffix:semicolon
)brace
id|pcikbd_write
c_func
(paren
id|KBD_DATA_REG
comma
id|KBD_CMD_SET_RATE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcikbd_wait_for_input
c_func
(paren
)paren
op_ne
id|KBD_REPLY_ACK
)paren
(brace
r_return
l_string|&quot;Set rate: no ACK&quot;
suffix:semicolon
)brace
id|pcikbd_write
c_func
(paren
id|KBD_DATA_REG
comma
l_int|0x00
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcikbd_wait_for_input
c_func
(paren
)paren
op_ne
id|KBD_REPLY_ACK
)paren
(brace
r_return
l_string|&quot;Set rate: no ACK&quot;
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* success */
)brace
DECL|function|pcikbd_init_hw
r_void
id|__init
id|pcikbd_init_hw
c_func
(paren
r_void
)paren
(brace
r_struct
id|linux_ebus
op_star
id|ebus
suffix:semicolon
r_struct
id|linux_ebus_device
op_star
id|edev
suffix:semicolon
r_struct
id|linux_ebus_child
op_star
id|child
suffix:semicolon
r_char
op_star
id|msg
suffix:semicolon
r_if
c_cond
(paren
id|pcikbd_mrcoffee
)paren
(brace
r_if
c_cond
(paren
(paren
id|pcikbd_iobase
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
l_int|0x71300060
comma
l_int|8
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;pcikbd_init_hw: cannot map&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pcikbd_irq
op_assign
l_int|13
op_or
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pcikbd_irq
comma
op_amp
id|pcikbd_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;keyboard&quot;
comma
(paren
r_void
op_star
)paren
id|pcikbd_iobase
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;8042: cannot register IRQ %x&bslash;n&quot;
comma
id|pcikbd_irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;8042(kbd): iobase[%x] irq[%x]&bslash;n&quot;
comma
(paren
r_int
)paren
id|pcikbd_iobase
comma
id|pcikbd_irq
)paren
suffix:semicolon
)brace
r_else
(brace
id|for_each_ebus
c_func
(paren
id|ebus
)paren
(brace
id|for_each_ebusdev
c_func
(paren
id|edev
comma
id|ebus
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|edev-&gt;prom_name
comma
l_string|&quot;8042&quot;
)paren
)paren
(brace
id|for_each_edevchild
c_func
(paren
id|edev
comma
id|child
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|child-&gt;prom_name
comma
id|PCI_KB_NAME1
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
c_func
(paren
id|child-&gt;prom_name
comma
id|PCI_KB_NAME2
)paren
op_eq
l_int|0
)paren
r_goto
id|found
suffix:semicolon
)brace
)brace
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;pcikbd_init_hw: no 8042 found&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
id|found
suffix:colon
id|pcikbd_iobase
op_assign
id|child-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|pcikbd_irq
op_assign
id|child-&gt;irqs
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pcikbd_irq
comma
op_amp
id|pcikbd_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;keyboard&quot;
comma
(paren
r_void
op_star
)paren
id|pcikbd_iobase
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;8042: cannot register IRQ %s&bslash;n&quot;
comma
id|__irq_itoa
c_func
(paren
id|pcikbd_irq
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;8042(kbd) at 0x%lx (irq %s)&bslash;n&quot;
comma
id|pcikbd_iobase
comma
id|__irq_itoa
c_func
(paren
id|pcikbd_irq
)paren
)paren
suffix:semicolon
)brace
id|kd_mksound
op_assign
id|nop_kd_mksound
suffix:semicolon
macro_line|#ifdef __sparc_v9__
id|edev
op_assign
l_int|0
suffix:semicolon
id|for_each_ebus
c_func
(paren
id|ebus
)paren
(brace
id|for_each_ebusdev
c_func
(paren
id|edev
comma
id|ebus
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|edev-&gt;prom_name
comma
l_string|&quot;beeper&quot;
)paren
)paren
(brace
r_goto
id|ebus_done
suffix:semicolon
)brace
)brace
)brace
id|ebus_done
suffix:colon
multiline_comment|/*&n;&t; * XXX: my 3.1.3 PROM does not give me the beeper node for the audio&n;&t; *      auxio register, though I know it is there... (ecd)&n;&t; *&n;&t; * JavaStations appear not to have beeper. --zaitcev&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|edev
)paren
id|pcibeep_iobase
op_assign
(paren
id|pcikbd_iobase
op_amp
op_complement
(paren
l_int|0xffffff
)paren
)paren
op_or
l_int|0x722000
suffix:semicolon
r_else
id|pcibeep_iobase
op_assign
id|edev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|kd_mksound
op_assign
id|pcikbd_kd_mksound
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;8042(speaker): iobase[%016lx]%s&bslash;n&quot;
comma
id|pcibeep_iobase
comma
id|edev
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot; (forced)&quot;
)paren
suffix:semicolon
macro_line|#endif
id|disable_irq
c_func
(paren
id|pcikbd_irq
)paren
suffix:semicolon
id|msg
op_assign
id|do_pcikbd_init_hw
c_func
(paren
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|pcikbd_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;8042: keyboard init failure [%s]&bslash;n&quot;
comma
id|msg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Here begins the Mouse Driver.&n; */
DECL|variable|pcimouse_iobase
r_static
r_int
r_int
id|pcimouse_iobase
op_assign
l_int|0
suffix:semicolon
DECL|variable|pcimouse_irq
r_static
r_int
r_int
id|pcimouse_irq
suffix:semicolon
DECL|macro|AUX_BUF_SIZE
mdefine_line|#define AUX_BUF_SIZE&t;2048
DECL|struct|aux_queue
r_struct
id|aux_queue
(brace
DECL|member|head
r_int
r_int
id|head
suffix:semicolon
DECL|member|tail
r_int
r_int
id|tail
suffix:semicolon
DECL|member|proc_list
id|wait_queue_head_t
id|proc_list
suffix:semicolon
DECL|member|fasync
r_struct
id|fasync_struct
op_star
id|fasync
suffix:semicolon
DECL|member|buf
r_int
r_char
id|buf
(braket
id|AUX_BUF_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|queue
r_static
r_struct
id|aux_queue
op_star
id|queue
suffix:semicolon
DECL|variable|aux_count
r_static
r_int
id|aux_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|aux_present
r_static
r_int
id|aux_present
op_assign
l_int|0
suffix:semicolon
DECL|macro|pcimouse_inb
mdefine_line|#define pcimouse_inb(x)     inb(x)
DECL|macro|pcimouse_outb
mdefine_line|#define pcimouse_outb(v,x)  outb(v,x)
multiline_comment|/*&n; *&t;Shared subroutines&n; */
DECL|function|get_from_queue
r_static
r_int
r_int
id|get_from_queue
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
id|result
op_assign
id|queue-&gt;buf
(braket
id|queue-&gt;tail
)braket
suffix:semicolon
id|queue-&gt;tail
op_assign
(paren
id|queue-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|AUX_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|queue_empty
r_static
r_inline
r_int
id|queue_empty
c_func
(paren
r_void
)paren
(brace
r_return
id|queue-&gt;head
op_eq
id|queue-&gt;tail
suffix:semicolon
)brace
DECL|function|aux_fasync
r_static
r_int
id|aux_fasync
c_func
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|on
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|fasync_helper
c_func
(paren
id|fd
comma
id|filp
comma
id|on
comma
op_amp
id|queue-&gt;fasync
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;PS/2 Aux Device&n; */
DECL|macro|AUX_INTS_OFF
mdefine_line|#define AUX_INTS_OFF&t;(KBD_MODE_KCC | KBD_MODE_DISABLE_MOUSE | &bslash;&n;&t;&t;&t; KBD_MODE_SYS | KBD_MODE_KBD_INT)
DECL|macro|AUX_INTS_ON
mdefine_line|#define AUX_INTS_ON&t;(KBD_MODE_KCC | KBD_MODE_SYS | &bslash;&n;&t;&t;&t; KBD_MODE_MOUSE_INT | KBD_MODE_KBD_INT)
DECL|macro|MAX_RETRIES
mdefine_line|#define MAX_RETRIES&t;60&t;&t;/* some aux operations take long time*/
multiline_comment|/*&n; *&t;Status polling&n; */
DECL|function|poll_aux_status
r_static
r_int
id|poll_aux_status
c_func
(paren
r_void
)paren
(brace
r_int
id|retries
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pcimouse_inb
c_func
(paren
id|pcimouse_iobase
op_plus
id|KBD_STATUS_REG
)paren
op_amp
(paren
id|KBD_STAT_IBF
op_or
id|KBD_STAT_OBF
)paren
)paren
op_logical_and
id|retries
OL
id|MAX_RETRIES
)paren
(brace
r_if
c_cond
(paren
(paren
id|pcimouse_inb
c_func
(paren
id|pcimouse_iobase
op_plus
id|KBD_STATUS_REG
)paren
op_amp
id|AUX_STAT_OBF
)paren
op_eq
id|AUX_STAT_OBF
)paren
id|pcimouse_inb
c_func
(paren
id|pcimouse_iobase
op_plus
id|KBD_DATA_REG
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|retries
op_increment
suffix:semicolon
)brace
r_return
(paren
id|retries
OL
id|MAX_RETRIES
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Write to aux device&n; */
DECL|function|aux_write_dev
r_static
r_void
id|aux_write_dev
c_func
(paren
r_int
id|val
)paren
(brace
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|KBD_CCMD_WRITE_MOUSE
comma
id|pcimouse_iobase
op_plus
id|KBD_CNTL_REG
)paren
suffix:semicolon
multiline_comment|/* Write magic cookie */
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|val
comma
id|pcimouse_iobase
op_plus
id|KBD_DATA_REG
)paren
suffix:semicolon
multiline_comment|/* Write data */
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Write to device &amp; handle returned ack&n; */
DECL|function|aux_write_ack
r_static
r_int
id|__init
id|aux_write_ack
c_func
(paren
r_int
id|val
)paren
(brace
id|aux_write_dev
c_func
(paren
id|val
)paren
suffix:semicolon
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pcimouse_inb
c_func
(paren
id|pcimouse_iobase
op_plus
id|KBD_STATUS_REG
)paren
op_amp
id|AUX_STAT_OBF
)paren
op_eq
id|AUX_STAT_OBF
)paren
r_return
(paren
id|pcimouse_inb
c_func
(paren
id|pcimouse_iobase
op_plus
id|KBD_DATA_REG
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Write aux device command&n; */
DECL|function|aux_write_cmd
r_static
r_void
id|aux_write_cmd
c_func
(paren
r_int
id|val
)paren
(brace
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|KBD_CCMD_WRITE_MODE
comma
id|pcimouse_iobase
op_plus
id|KBD_CNTL_REG
)paren
suffix:semicolon
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|val
comma
id|pcimouse_iobase
op_plus
id|KBD_DATA_REG
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupt from the auxiliary device: a character&n; * is waiting in the keyboard/aux controller.&n; */
DECL|function|pcimouse_interrupt
r_void
id|pcimouse_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|head
comma
id|maxhead
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
id|head
op_assign
id|queue-&gt;head
suffix:semicolon
id|maxhead
op_assign
(paren
id|queue-&gt;tail
op_minus
l_int|1
)paren
op_amp
(paren
id|AUX_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pcimouse_inb
c_func
(paren
id|pcimouse_iobase
op_plus
id|KBD_STATUS_REG
)paren
op_amp
id|AUX_STAT_OBF
)paren
op_ne
id|AUX_STAT_OBF
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|val
op_assign
id|pcimouse_inb
c_func
(paren
id|pcimouse_iobase
op_plus
id|KBD_DATA_REG
)paren
suffix:semicolon
id|queue-&gt;buf
(braket
id|head
)braket
op_assign
id|val
suffix:semicolon
id|add_mouse_randomness
c_func
(paren
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ne
id|maxhead
)paren
(brace
id|head
op_increment
suffix:semicolon
id|head
op_and_assign
id|AUX_BUF_SIZE
op_minus
l_int|1
suffix:semicolon
)brace
id|queue-&gt;head
op_assign
id|head
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
id|kill_fasync
c_func
(paren
op_amp
id|queue-&gt;fasync
comma
id|SIGIO
comma
id|POLL_IN
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|queue-&gt;proc_list
)paren
suffix:semicolon
)brace
DECL|function|aux_release
r_static
r_int
id|aux_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|aux_fasync
c_func
(paren
op_minus
l_int|1
comma
id|file
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|aux_count
)paren
r_goto
id|out
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Disable controller ints */
id|aux_write_cmd
c_func
(paren
id|AUX_INTS_OFF
)paren
suffix:semicolon
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Disable Aux device */
id|pcimouse_outb
c_func
(paren
id|KBD_CCMD_MOUSE_DISABLE
comma
id|pcimouse_iobase
op_plus
id|KBD_CNTL_REG
)paren
suffix:semicolon
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Install interrupt handler.&n; * Enable auxiliary device.&n; */
DECL|function|aux_open
r_static
r_int
id|aux_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aux_present
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|aux_count
op_increment
)paren
r_return
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|poll_aux_status
c_func
(paren
)paren
)paren
(brace
id|aux_count
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|queue-&gt;head
op_assign
id|queue-&gt;tail
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Flush input queue */
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|KBD_CCMD_MOUSE_ENABLE
comma
id|pcimouse_iobase
op_plus
id|KBD_CNTL_REG
)paren
suffix:semicolon
multiline_comment|/* Enable Aux */
id|aux_write_dev
c_func
(paren
id|AUX_ENABLE_DEV
)paren
suffix:semicolon
multiline_comment|/* Enable aux device */
id|aux_write_cmd
c_func
(paren
id|AUX_INTS_ON
)paren
suffix:semicolon
multiline_comment|/* Enable controller ints */
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Write to the aux device.&n; */
DECL|function|aux_write
r_static
id|ssize_t
id|aux_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|count
)paren
(brace
id|ssize_t
id|written
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_do
(brace
r_char
id|c
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
id|get_user
c_func
(paren
id|c
comma
id|buffer
op_increment
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|poll_aux_status
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|KBD_CCMD_WRITE_MOUSE
comma
id|pcimouse_iobase
op_plus
id|KBD_CNTL_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|poll_aux_status
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|c
comma
id|pcimouse_iobase
op_plus
id|KBD_DATA_REG
)paren
suffix:semicolon
id|written
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|count
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcikbd_lock
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|written
)paren
(brace
id|retval
op_assign
id|written
suffix:semicolon
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Generic part continues...&n; */
multiline_comment|/*&n; * Put bytes from input queue to buffer.&n; */
DECL|function|aux_read
r_static
id|ssize_t
id|aux_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|ssize_t
id|i
op_assign
id|count
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|queue_empty
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|queue-&gt;proc_list
comma
op_amp
id|wait
)paren
suffix:semicolon
id|repeat
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|queue_empty
c_func
(paren
)paren
op_logical_and
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|queue-&gt;proc_list
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OG
l_int|0
op_logical_and
op_logical_neg
id|queue_empty
c_func
(paren
)paren
)paren
(brace
id|c
op_assign
id|get_from_queue
c_func
(paren
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|c
comma
id|buffer
op_increment
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_minus
id|i
)paren
(brace
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_return
id|count
op_minus
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aux_poll
r_static
r_int
r_int
id|aux_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|queue-&gt;proc_list
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue_empty
c_func
(paren
)paren
)paren
r_return
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|psaux_fops
r_struct
id|file_operations
id|psaux_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|read
suffix:colon
id|aux_read
comma
id|write
suffix:colon
id|aux_write
comma
id|poll
suffix:colon
id|aux_poll
comma
id|open
suffix:colon
id|aux_open
comma
id|release
suffix:colon
id|aux_release
comma
id|fasync
suffix:colon
id|aux_fasync
comma
)brace
suffix:semicolon
DECL|function|aux_no_open
r_static
r_int
id|aux_no_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|variable|psaux_no_fops
r_struct
id|file_operations
id|psaux_no_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|open
suffix:colon
id|aux_no_open
comma
)brace
suffix:semicolon
DECL|variable|psaux_mouse
r_static
r_struct
id|miscdevice
id|psaux_mouse
op_assign
(brace
id|PSMOUSE_MINOR
comma
l_string|&quot;ps2aux&quot;
comma
op_amp
id|psaux_fops
)brace
suffix:semicolon
DECL|variable|psaux_no_mouse
r_static
r_struct
id|miscdevice
id|psaux_no_mouse
op_assign
(brace
id|PSMOUSE_MINOR
comma
l_string|&quot;ps2aux&quot;
comma
op_amp
id|psaux_no_fops
)brace
suffix:semicolon
DECL|function|pcimouse_init
r_int
id|__init
id|pcimouse_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|linux_ebus
op_star
id|ebus
suffix:semicolon
r_struct
id|linux_ebus_device
op_star
id|edev
suffix:semicolon
r_struct
id|linux_ebus_child
op_star
id|child
suffix:semicolon
r_if
c_cond
(paren
id|pcikbd_mrcoffee
)paren
(brace
r_if
c_cond
(paren
(paren
id|pcimouse_iobase
op_assign
id|pcikbd_iobase
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcimouse_init: no 8042 given&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|do_enodev
suffix:semicolon
)brace
id|pcimouse_irq
op_assign
id|pcikbd_irq
suffix:semicolon
)brace
r_else
(brace
id|for_each_ebus
c_func
(paren
id|ebus
)paren
(brace
id|for_each_ebusdev
c_func
(paren
id|edev
comma
id|ebus
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|edev-&gt;prom_name
comma
l_string|&quot;8042&quot;
)paren
)paren
(brace
id|for_each_edevchild
c_func
(paren
id|edev
comma
id|child
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|child-&gt;prom_name
comma
id|PCI_MS_NAME1
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
c_func
(paren
id|child-&gt;prom_name
comma
id|PCI_MS_NAME2
)paren
op_eq
l_int|0
)paren
r_goto
id|found
suffix:semicolon
)brace
)brace
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;pcimouse_init: no 8042 found&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|do_enodev
suffix:semicolon
id|found
suffix:colon
id|pcimouse_iobase
op_assign
id|child-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|pcimouse_irq
op_assign
id|child-&gt;irqs
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|queue
op_assign
(paren
r_struct
id|aux_queue
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|queue
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcimouse_init: kmalloc(aux_queue) failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|queue
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|queue
)paren
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|queue-&gt;proc_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pcimouse_irq
comma
op_amp
id|pcimouse_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;mouse&quot;
comma
(paren
r_void
op_star
)paren
id|pcimouse_iobase
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;8042: Cannot register IRQ %s&bslash;n&quot;
comma
id|__irq_itoa
c_func
(paren
id|pcimouse_irq
)paren
)paren
suffix:semicolon
r_goto
id|do_enodev
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;8042(mouse) at %lx (irq %s)&bslash;n&quot;
comma
id|pcimouse_iobase
comma
id|__irq_itoa
c_func
(paren
id|pcimouse_irq
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;8042: PS/2 auxiliary pointing device detected.&bslash;n&quot;
)paren
suffix:semicolon
id|aux_present
op_assign
l_int|1
suffix:semicolon
id|pckbd_read_mask
op_assign
id|AUX_STAT_OBF
suffix:semicolon
id|misc_register
c_func
(paren
op_amp
id|psaux_mouse
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|pcikbd_lock
)paren
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|KBD_CCMD_MOUSE_ENABLE
comma
id|pcimouse_iobase
op_plus
id|KBD_CNTL_REG
)paren
suffix:semicolon
id|aux_write_ack
c_func
(paren
id|AUX_RESET
)paren
suffix:semicolon
id|aux_write_ack
c_func
(paren
id|AUX_SET_SAMPLE
)paren
suffix:semicolon
id|aux_write_ack
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|aux_write_ack
c_func
(paren
id|AUX_SET_RES
)paren
suffix:semicolon
id|aux_write_ack
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|aux_write_ack
c_func
(paren
id|AUX_SET_SCALE21
)paren
suffix:semicolon
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|KBD_CCMD_MOUSE_DISABLE
comma
id|pcimouse_iobase
op_plus
id|KBD_CNTL_REG
)paren
suffix:semicolon
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|KBD_CCMD_WRITE_MODE
comma
id|pcimouse_iobase
op_plus
id|KBD_CNTL_REG
)paren
suffix:semicolon
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|pcimouse_outb
c_func
(paren
id|AUX_INTS_OFF
comma
id|pcimouse_iobase
op_plus
id|KBD_DATA_REG
)paren
suffix:semicolon
id|poll_aux_status
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|pcikbd_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|do_enodev
suffix:colon
id|misc_register
c_func
(paren
op_amp
id|psaux_no_mouse
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|pcimouse_no_init
r_int
id|__init
id|pcimouse_no_init
c_func
(paren
r_void
)paren
(brace
id|misc_register
c_func
(paren
op_amp
id|psaux_no_mouse
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|ps2kbd_probe
r_int
id|__init
id|ps2kbd_probe
c_func
(paren
r_void
)paren
(brace
r_int
id|pnode
comma
id|enode
comma
id|node
comma
id|dnode
comma
id|xnode
suffix:semicolon
r_int
id|kbnode
op_assign
l_int|0
comma
id|msnode
op_assign
l_int|0
comma
id|bnode
op_assign
l_int|0
suffix:semicolon
r_int
id|devices
op_assign
l_int|0
suffix:semicolon
r_char
id|prop
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
macro_line|#ifndef __sparc_v9__
multiline_comment|/*&n;&t; * MrCoffee has hardware but has no PROM nodes whatsoever.&n;&t; */
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|prom_root_node
comma
l_string|&quot;name&quot;
comma
id|prop
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ps2kbd_probe: no name of root node&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|do_enodev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|prop
comma
l_string|&quot;SUNW,JavaStation-1&quot;
comma
id|len
)paren
op_eq
l_int|0
)paren
(brace
id|pcikbd_mrcoffee
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Brain damage detected */
r_goto
id|found
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Get the nodes for keyboard and mouse from aliases on normal systems.&n;&t; */
id|node
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;aliases&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_goto
id|do_enodev
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;keyboard&quot;
comma
id|prop
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|prop
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|kbnode
op_assign
id|prom_finddevice
c_func
(paren
id|prop
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|kbnode
)paren
r_goto
id|do_enodev
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;mouse&quot;
comma
id|prop
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|prop
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|msnode
op_assign
id|prom_finddevice
c_func
(paren
id|prop
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|msnode
)paren
r_goto
id|do_enodev
suffix:semicolon
multiline_comment|/*&n;&t; * Find matching EBus nodes...&n;&t; */
id|node
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|pnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;pci&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check for SUNW,sabre on Ultra5/10/AXi.&n;&t; */
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|pnode
comma
l_string|&quot;model&quot;
comma
id|prop
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
OG
l_int|0
)paren
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|prop
comma
l_string|&quot;SUNW,sabre&quot;
comma
id|len
)paren
)paren
(brace
id|pnode
op_assign
id|prom_getchild
c_func
(paren
id|pnode
)paren
suffix:semicolon
id|pnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|pnode
comma
l_string|&quot;pci&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * For each PCI bus...&n;&t; */
r_while
c_loop
(paren
id|pnode
)paren
(brace
id|enode
op_assign
id|prom_getchild
c_func
(paren
id|pnode
)paren
suffix:semicolon
id|enode
op_assign
id|prom_searchsiblings
c_func
(paren
id|enode
comma
l_string|&quot;ebus&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * For each EBus on this PCI...&n;&t;&t; */
r_while
c_loop
(paren
id|enode
)paren
(brace
id|node
op_assign
id|prom_getchild
c_func
(paren
id|enode
)paren
suffix:semicolon
id|bnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;beeper&quot;
)paren
suffix:semicolon
id|node
op_assign
id|prom_getchild
c_func
(paren
id|enode
)paren
suffix:semicolon
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;8042&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * For each &squot;8042&squot; on this EBus...&n;&t;&t;&t; */
r_while
c_loop
(paren
id|node
)paren
(brace
id|dnode
op_assign
id|prom_getchild
c_func
(paren
id|node
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Does it match?&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|xnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|dnode
comma
id|PCI_KB_NAME1
)paren
)paren
op_eq
id|kbnode
)paren
(brace
op_increment
id|devices
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|xnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|dnode
comma
id|PCI_KB_NAME2
)paren
)paren
op_eq
id|kbnode
)paren
(brace
op_increment
id|devices
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|xnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|dnode
comma
id|PCI_MS_NAME1
)paren
)paren
op_eq
id|msnode
)paren
(brace
op_increment
id|devices
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|xnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|dnode
comma
id|PCI_MS_NAME2
)paren
)paren
op_eq
id|msnode
)paren
(brace
op_increment
id|devices
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * Found everything we need?&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|devices
op_eq
l_int|2
)paren
r_goto
id|found
suffix:semicolon
id|node
op_assign
id|prom_getsibling
c_func
(paren
id|node
)paren
suffix:semicolon
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;8042&quot;
)paren
suffix:semicolon
)brace
id|enode
op_assign
id|prom_getsibling
c_func
(paren
id|enode
)paren
suffix:semicolon
id|enode
op_assign
id|prom_searchsiblings
c_func
(paren
id|enode
comma
l_string|&quot;ebus&quot;
)paren
suffix:semicolon
)brace
id|pnode
op_assign
id|prom_getsibling
c_func
(paren
id|pnode
)paren
suffix:semicolon
id|pnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|pnode
comma
l_string|&quot;pci&quot;
)paren
suffix:semicolon
)brace
id|do_enodev
suffix:colon
id|sunkbd_setinitfunc
c_func
(paren
id|pcimouse_no_init
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
id|found
suffix:colon
id|sunkbd_setinitfunc
c_func
(paren
id|pcimouse_init
)paren
suffix:semicolon
id|sunkbd_setinitfunc
c_func
(paren
id|pcikbd_init
)paren
suffix:semicolon
id|kbd_ops.compute_shiftstate
op_assign
id|pci_compute_shiftstate
suffix:semicolon
id|kbd_ops.setledstate
op_assign
id|pci_setledstate
suffix:semicolon
id|kbd_ops.getledstate
op_assign
id|pci_getledstate
suffix:semicolon
id|kbd_ops.setkeycode
op_assign
id|pci_setkeycode
suffix:semicolon
id|kbd_ops.getkeycode
op_assign
id|pci_getkeycode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
