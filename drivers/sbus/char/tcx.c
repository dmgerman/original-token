multiline_comment|/* $Id: tcx.c,v 1.17 1997/07/17 02:21:50 davem Exp $&n; * tcx.c: SUNW,tcx 24/8bit frame buffer driver&n; *&n; * Copyright (C) 1996 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; * Copyright (C) 1996 Miguel de Icaza (miguel@nuclecu.unam.mx)&n; * Copyright (C) 1996 Eddie C. Dost (ecd@skynet.be)&n; */
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
multiline_comment|/* These must be included after asm/fbio.h */
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
macro_line|#include &quot;fb.h&quot;
macro_line|#include &quot;cg_common.h&quot;
multiline_comment|/* Offset of interesting structures in the tcx registers */
DECL|macro|TCX_RAM8BIT_OFFSET
mdefine_line|#define TCX_RAM8BIT_OFFSET&t;0
DECL|macro|TCX_CONTROLPLANE_OFFSET
mdefine_line|#define TCX_CONTROLPLANE_OFFSET 4
DECL|macro|TCX_BROOKTREE_OFFSET
mdefine_line|#define TCX_BROOKTREE_OFFSET &t;8
DECL|macro|TCX_THC_OFFSET
mdefine_line|#define TCX_THC_OFFSET&t;&t;9
DECL|macro|TCX_TEC_OFFSET
mdefine_line|#define TCX_TEC_OFFSET&t;&t;7
multiline_comment|/* THC definitions */
DECL|macro|TCX_THC_MISC_REV_SHIFT
mdefine_line|#define TCX_THC_MISC_REV_SHIFT       16
DECL|macro|TCX_THC_MISC_REV_MASK
mdefine_line|#define TCX_THC_MISC_REV_MASK        15
DECL|macro|TCX_THC_MISC_RESET
mdefine_line|#define TCX_THC_MISC_RESET           (1 &lt;&lt; 12)
DECL|macro|TCX_THC_MISC_VIDEO
mdefine_line|#define TCX_THC_MISC_VIDEO           (1 &lt;&lt; 10)
DECL|macro|TCX_THC_MISC_SYNC
mdefine_line|#define TCX_THC_MISC_SYNC            (1 &lt;&lt; 9)
DECL|macro|TCX_THC_MISC_VSYNC
mdefine_line|#define TCX_THC_MISC_VSYNC           (1 &lt;&lt; 8)
DECL|macro|TCX_THC_MISC_SYNC_ENAB
mdefine_line|#define TCX_THC_MISC_SYNC_ENAB       (1 &lt;&lt; 7)
DECL|macro|TCX_THC_MISC_CURS_RES
mdefine_line|#define TCX_THC_MISC_CURS_RES        (1 &lt;&lt; 6)
DECL|macro|TCX_THC_MISC_INT_ENAB
mdefine_line|#define TCX_THC_MISC_INT_ENAB        (1 &lt;&lt; 5)
DECL|macro|TCX_THC_MISC_INT
mdefine_line|#define TCX_THC_MISC_INT             (1 &lt;&lt; 4)
DECL|macro|TCX_THC_MISC_INIT
mdefine_line|#define TCX_THC_MISC_INIT            0x9f
DECL|macro|TCX_THC_REV_REV_SHIFT
mdefine_line|#define TCX_THC_REV_REV_SHIFT        20
DECL|macro|TCX_THC_REV_REV_MASK
mdefine_line|#define TCX_THC_REV_REV_MASK         15
DECL|macro|TCX_THC_REV_MINREV_SHIFT
mdefine_line|#define TCX_THC_REV_MINREV_SHIFT     28
DECL|macro|TCX_THC_REV_MINREV_MASK
mdefine_line|#define TCX_THC_REV_MINREV_MASK      15
multiline_comment|/* The contents are unknown */
DECL|struct|tcx_tec
r_struct
id|tcx_tec
(brace
DECL|member|tec_matrix
r_volatile
r_int
id|tec_matrix
suffix:semicolon
DECL|member|tec_clip
r_volatile
r_int
id|tec_clip
suffix:semicolon
DECL|member|tec_vdc
r_volatile
r_int
id|tec_vdc
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tcx_thc
r_struct
id|tcx_thc
(brace
DECL|member|thc_rev
r_volatile
id|uint
id|thc_rev
suffix:semicolon
DECL|member|thc_pad0
id|uint
id|thc_pad0
(braket
l_int|511
)braket
suffix:semicolon
DECL|member|thc_hs
r_volatile
id|uint
id|thc_hs
suffix:semicolon
multiline_comment|/* hsync timing */
DECL|member|thc_hsdvs
r_volatile
id|uint
id|thc_hsdvs
suffix:semicolon
DECL|member|thc_hd
r_volatile
id|uint
id|thc_hd
suffix:semicolon
DECL|member|thc_vs
r_volatile
id|uint
id|thc_vs
suffix:semicolon
multiline_comment|/* vsync timing */
DECL|member|thc_vd
r_volatile
id|uint
id|thc_vd
suffix:semicolon
DECL|member|thc_refresh
r_volatile
id|uint
id|thc_refresh
suffix:semicolon
DECL|member|thc_misc
r_volatile
id|uint
id|thc_misc
suffix:semicolon
DECL|member|thc_pad1
id|uint
id|thc_pad1
(braket
l_int|56
)braket
suffix:semicolon
DECL|member|thc_cursxy
r_volatile
id|uint
id|thc_cursxy
suffix:semicolon
multiline_comment|/* cursor x,y position (16 bits each) */
DECL|member|thc_cursmask
r_volatile
id|uint
id|thc_cursmask
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* cursor mask bits */
DECL|member|thc_cursbits
r_volatile
id|uint
id|thc_cursbits
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* what to show where mask enabled */
)brace
suffix:semicolon
r_static
r_void
DECL|function|tcx_restore_palette
id|tcx_restore_palette
(paren
id|fbinfo_t
op_star
id|fbinfo
)paren
(brace
r_volatile
r_struct
id|bt_regs
op_star
id|bt
suffix:semicolon
id|bt
op_assign
id|fbinfo-&gt;info.tcx.bt
suffix:semicolon
id|bt-&gt;addr
op_assign
l_int|0
suffix:semicolon
id|bt-&gt;color_map
op_assign
l_int|0xffffffff
suffix:semicolon
id|bt-&gt;color_map
op_assign
l_int|0xffffffff
suffix:semicolon
id|bt-&gt;color_map
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
r_static
r_void
DECL|function|tcx_set_control_plane
id|tcx_set_control_plane
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_register
id|uint
op_star
id|p
comma
op_star
id|pend
suffix:semicolon
id|p
op_assign
id|fb-&gt;info.tcx.tcx_cplane
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|pend
op_assign
id|p
op_plus
(paren
id|fb-&gt;info.tcx.tcx_sizes
(braket
id|TCX_CONTROLPLANE_OFFSET
)braket
op_rshift
l_int|2
)paren
suffix:semicolon
id|p
OL
id|pend
suffix:semicolon
id|p
op_increment
)paren
op_star
id|p
op_and_assign
l_int|0xffffff
suffix:semicolon
)brace
r_static
r_void
DECL|function|tcx_switch_from_graph
id|tcx_switch_from_graph
(paren
r_void
)paren
(brace
id|fbinfo_t
op_star
id|fb
op_assign
op_amp
(paren
id|fbinfo
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Reset control plane to 8bit mode if necessary */
r_if
c_cond
(paren
id|fb-&gt;open
op_logical_and
id|fb-&gt;mmaped
)paren
id|tcx_set_control_plane
(paren
id|fb
)paren
suffix:semicolon
)brace
multiline_comment|/* Ugh: X wants to mmap a bunch of cute stuff at the same time :-( */
multiline_comment|/* So, we just mmap the things that are being asked for */
r_static
r_int
DECL|function|tcx_mmap
id|tcx_mmap
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
id|base
comma
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|uint
id|size
comma
id|page
comma
id|r
comma
id|map_size
suffix:semicolon
r_int
r_int
id|map_offset
op_assign
l_int|0
suffix:semicolon
id|uint
id|i
suffix:semicolon
r_int
id|offsets
(braket
l_int|13
)braket
op_assign
(brace
op_minus
l_int|1
comma
id|TCX_RAM24BIT
comma
id|TCX_UNK3
comma
id|TCX_UNK4
comma
op_minus
l_int|1
comma
id|TCX_UNK6
comma
id|TCX_UNK7
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|TCX_UNK2
comma
id|TCX_DHC
comma
id|TCX_ALT
)brace
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_amp
op_complement
id|PAGE_MASK
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* To stop the swapper from even considering these pages */
id|vma-&gt;vm_flags
op_or_assign
id|FB_MMAP_VM_FLAGS
suffix:semicolon
multiline_comment|/* Each page, see which map applies */
r_for
c_loop
(paren
id|page
op_assign
l_int|0
suffix:semicolon
id|page
OL
id|size
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
id|vma-&gt;vm_offset
op_plus
id|page
)paren
(brace
r_case
id|TCX_RAM8BIT
suffix:colon
id|map_size
op_assign
id|fb-&gt;type.fb_size
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCX_TEC
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.tcx.tec
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCX_BTREGS
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.tcx.bt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCX_THC
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.tcx.thc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCX_CONTROLPLANE
suffix:colon
r_if
c_cond
(paren
id|fb-&gt;info.tcx.tcx_cplane
)paren
(brace
id|map_size
op_assign
id|fb-&gt;info.tcx.tcx_sizes
(braket
id|TCX_CONTROLPLANE_OFFSET
)braket
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.tcx.tcx_cplane
)paren
suffix:semicolon
)brace
r_else
id|map_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|map_size
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|offsets
(braket
id|i
)braket
op_eq
id|vma-&gt;vm_offset
op_plus
id|page
)paren
(brace
r_if
c_cond
(paren
(paren
id|map_size
op_assign
id|fb-&gt;info.tcx.tcx_sizes
(braket
id|i
)braket
)paren
)paren
id|map_offset
op_assign
id|fb-&gt;info.tcx.tcx_offsets
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|map_size
)paren
(brace
id|page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|page
op_plus
id|map_size
OG
id|size
)paren
id|map_size
op_assign
id|size
op_minus
id|page
suffix:semicolon
id|r
op_assign
id|io_remap_page_range
(paren
id|vma-&gt;vm_start
op_plus
id|page
comma
id|map_offset
comma
id|map_size
comma
id|vma-&gt;vm_page_prot
comma
id|fb-&gt;space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|page
op_add_assign
id|map_size
suffix:semicolon
)brace
id|vma-&gt;vm_dentry
op_assign
id|dget
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|tcx_loadcmap
id|tcx_loadcmap
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|index
comma
r_int
id|count
)paren
(brace
r_struct
id|bt_regs
op_star
id|bt
op_assign
id|fb-&gt;info.tcx.bt
suffix:semicolon
r_int
id|i
suffix:semicolon
id|bt-&gt;addr
op_assign
id|index
op_lshift
l_int|24
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|index
suffix:semicolon
id|count
op_decrement
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bt-&gt;color_map
op_assign
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|0
)paren
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;color_map
op_assign
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|1
)paren
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;color_map
op_assign
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|2
)paren
op_lshift
l_int|24
suffix:semicolon
)brace
id|bt-&gt;addr
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|tcx_setcursormap
id|tcx_setcursormap
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
r_char
op_star
id|red
comma
r_int
r_char
op_star
id|green
comma
r_int
r_char
op_star
id|blue
)paren
(brace
r_struct
id|bt_regs
op_star
id|bt
op_assign
id|fb-&gt;info.tcx.bt
suffix:semicolon
multiline_comment|/* Note the 2 &lt;&lt; 24 is different from cg6&squot;s 1 &lt;&lt; 24 */
id|bt-&gt;addr
op_assign
l_int|2
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;cursor
op_assign
id|red
(braket
l_int|0
)braket
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;cursor
op_assign
id|green
(braket
l_int|0
)braket
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;cursor
op_assign
id|blue
(braket
l_int|0
)braket
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;addr
op_assign
l_int|3
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;cursor
op_assign
id|red
(braket
l_int|1
)braket
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;cursor
op_assign
id|green
(braket
l_int|1
)braket
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;cursor
op_assign
id|blue
(braket
l_int|1
)braket
op_lshift
l_int|24
suffix:semicolon
id|bt-&gt;addr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Load cursor information */
r_static
r_void
DECL|function|tcx_setcursor
id|tcx_setcursor
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|uint
id|v
suffix:semicolon
r_struct
id|cg_cursor
op_star
id|c
op_assign
op_amp
id|fb-&gt;cursor
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;enable
)paren
(brace
id|v
op_assign
(paren
(paren
id|c-&gt;cpos.fbx
op_minus
id|c-&gt;chot.fbx
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|c-&gt;cpos.fby
op_minus
id|c-&gt;chot.fby
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Magic constant to turn off the cursor */
id|v
op_assign
(paren
(paren
l_int|65536
op_minus
l_int|32
)paren
op_lshift
l_int|16
)paren
op_or
(paren
l_int|65536
op_minus
l_int|32
)paren
suffix:semicolon
)brace
id|fb-&gt;info.tcx.thc-&gt;thc_cursxy
op_assign
id|v
suffix:semicolon
)brace
multiline_comment|/* Set cursor shape */
r_static
r_void
DECL|function|tcx_setcurshape
id|tcx_setcurshape
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_struct
id|tcx_thc
op_star
id|thc
op_assign
id|fb-&gt;info.tcx.thc
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|thc-&gt;thc_cursmask
(braket
id|i
)braket
op_assign
id|fb-&gt;cursor.bits
(braket
l_int|0
)braket
(braket
id|i
)braket
suffix:semicolon
id|thc-&gt;thc_cursbits
(braket
id|i
)braket
op_assign
id|fb-&gt;cursor.bits
(braket
l_int|1
)braket
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|tcx_blank
id|tcx_blank
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|fb-&gt;info.tcx.thc-&gt;thc_misc
op_and_assign
op_complement
id|TCX_THC_MISC_VIDEO
suffix:semicolon
)brace
r_static
r_void
DECL|function|tcx_unblank
id|tcx_unblank
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|fb-&gt;info.tcx.thc-&gt;thc_misc
op_or_assign
id|TCX_THC_MISC_VIDEO
suffix:semicolon
)brace
r_void
DECL|function|tcx_reset
id|tcx_reset
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_struct
id|tcx_info
op_star
id|tcx
op_assign
op_amp
(paren
id|fb-&gt;info.tcx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb-&gt;setcursor
)paren
id|sun_hw_hide_cursor
(paren
)paren
suffix:semicolon
multiline_comment|/* Reset control plane to 8bit mode if necessary */
r_if
c_cond
(paren
id|fb-&gt;open
op_logical_and
id|fb-&gt;mmaped
)paren
id|tcx_set_control_plane
(paren
id|fb
)paren
suffix:semicolon
multiline_comment|/* Turn off stuff in the Transform Engine. */
id|tcx-&gt;tec-&gt;tec_matrix
op_assign
l_int|0
suffix:semicolon
id|tcx-&gt;tec-&gt;tec_clip
op_assign
l_int|0
suffix:semicolon
id|tcx-&gt;tec-&gt;tec_vdc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Enable cursor in Brooktree DAC. */
id|tcx-&gt;bt-&gt;addr
op_assign
l_int|0x06
op_lshift
l_int|24
suffix:semicolon
id|tcx-&gt;bt-&gt;control
op_or_assign
l_int|0x03
op_lshift
l_int|24
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|tcx_setup
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|slot
comma
r_int
id|node
comma
id|u32
id|tcx
comma
r_struct
id|linux_sbus_device
op_star
id|sbdp
)paren
)paren
(brace
r_struct
id|tcx_info
op_star
id|tcxinfo
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
(paren
l_string|&quot;tcx%d at 0x%8.8x &quot;
comma
id|slot
comma
id|tcx
)paren
suffix:semicolon
multiline_comment|/* Fill in parameters we left out */
id|fb-&gt;type.fb_cmsize
op_assign
l_int|256
suffix:semicolon
id|fb-&gt;mmap
op_assign
id|tcx_mmap
suffix:semicolon
id|fb-&gt;loadcmap
op_assign
id|tcx_loadcmap
suffix:semicolon
id|fb-&gt;reset
op_assign
id|tcx_reset
suffix:semicolon
id|fb-&gt;blank
op_assign
id|tcx_blank
suffix:semicolon
id|fb-&gt;unblank
op_assign
id|tcx_unblank
suffix:semicolon
id|fb-&gt;emulations
(braket
l_int|1
)braket
op_assign
id|FBTYPE_SUN3COLOR
suffix:semicolon
id|fb-&gt;emulations
(braket
l_int|2
)braket
op_assign
id|FBTYPE_MEMCOLOR
suffix:semicolon
id|fb-&gt;switch_from_graph
op_assign
id|tcx_switch_from_graph
suffix:semicolon
id|fb-&gt;postsetup
op_assign
id|sun_cg_postsetup
suffix:semicolon
id|tcxinfo
op_assign
(paren
r_struct
id|tcx_info
op_star
)paren
op_amp
id|fb-&gt;info.tcx
suffix:semicolon
id|memset
(paren
id|tcxinfo
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tcx_info
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
id|tcxinfo-&gt;tcx_offsets
(braket
id|i
)braket
op_assign
(paren
r_int
)paren
(paren
id|sbdp-&gt;reg_addrs
(braket
id|i
)braket
dot
id|phys_addr
)paren
suffix:semicolon
multiline_comment|/* Map the hardware registers */
id|tcxinfo-&gt;bt
op_assign
id|sparc_alloc_io
c_func
(paren
(paren
id|u32
)paren
id|tcxinfo-&gt;tcx_offsets
(braket
id|TCX_BROOKTREE_OFFSET
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|bt_regs
)paren
comma
l_string|&quot;tcx_dac&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|tcxinfo-&gt;thc
op_assign
id|sparc_alloc_io
c_func
(paren
(paren
id|u32
)paren
id|tcxinfo-&gt;tcx_offsets
(braket
id|TCX_THC_OFFSET
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tcx_thc
)paren
comma
l_string|&quot;tcx_thc&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
id|tcxinfo-&gt;tec
op_assign
id|sparc_alloc_io
c_func
(paren
(paren
id|u32
)paren
id|tcxinfo-&gt;tcx_offsets
(braket
id|TCX_TEC_OFFSET
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tcx_tec
)paren
comma
l_string|&quot;tcx_tec&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;base
)paren
(brace
id|fb-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|sparc_alloc_io
c_func
(paren
(paren
id|u32
)paren
id|tcxinfo-&gt;tcx_offsets
(braket
id|TCX_RAM8BIT_OFFSET
)braket
comma
l_int|0
comma
id|fb-&gt;type.fb_size
comma
l_string|&quot;tcx_ram&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|prom_getbool
(paren
id|node
comma
l_string|&quot;hw-cursor&quot;
)paren
)paren
(brace
id|fb-&gt;setcursor
op_assign
id|tcx_setcursor
suffix:semicolon
id|fb-&gt;setcursormap
op_assign
id|tcx_setcursormap
suffix:semicolon
id|fb-&gt;setcurshape
op_assign
id|tcx_setcurshape
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
(brace
id|fb_restore_palette
op_assign
id|tcx_restore_palette
suffix:semicolon
)brace
id|i
op_assign
id|fb-&gt;type.fb_size
suffix:semicolon
id|tcxinfo-&gt;tcx_sizes
(braket
l_int|2
)braket
op_assign
id|i
op_lshift
l_int|3
suffix:semicolon
id|tcxinfo-&gt;tcx_sizes
(braket
l_int|3
)braket
op_assign
id|i
op_lshift
l_int|3
suffix:semicolon
id|tcxinfo-&gt;tcx_sizes
(braket
l_int|10
)braket
op_assign
l_int|0x20000
suffix:semicolon
id|tcxinfo-&gt;tcx_sizes
(braket
l_int|11
)braket
op_assign
id|PAGE_SIZE
suffix:semicolon
id|tcxinfo-&gt;tcx_sizes
(braket
l_int|12
)braket
op_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|prom_getbool
(paren
id|node
comma
l_string|&quot;tcx-8-bit&quot;
)paren
)paren
id|tcxinfo-&gt;lowdepth
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tcxinfo-&gt;lowdepth
)paren
(brace
id|tcxinfo-&gt;tcx_sizes
(braket
l_int|1
)braket
op_assign
id|i
op_lshift
l_int|2
suffix:semicolon
id|tcxinfo-&gt;tcx_sizes
(braket
l_int|4
)braket
op_assign
id|i
op_lshift
l_int|2
suffix:semicolon
id|tcxinfo-&gt;tcx_sizes
(braket
l_int|5
)braket
op_assign
id|i
op_lshift
l_int|3
suffix:semicolon
id|tcxinfo-&gt;tcx_sizes
(braket
l_int|6
)braket
op_assign
id|i
op_lshift
l_int|3
suffix:semicolon
id|fb-&gt;type.fb_depth
op_assign
l_int|24
suffix:semicolon
id|tcxinfo-&gt;tcx_cplane
op_assign
id|sparc_alloc_io
c_func
(paren
(paren
id|u32
)paren
id|tcxinfo-&gt;tcx_offsets
(braket
id|TCX_CONTROLPLANE_OFFSET
)braket
comma
l_int|0
comma
id|tcxinfo-&gt;tcx_sizes
(braket
id|TCX_CONTROLPLANE_OFFSET
)braket
comma
l_string|&quot;tcx_cplane&quot;
comma
id|fb-&gt;space
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize Brooktree DAC */
id|tcxinfo-&gt;bt-&gt;addr
op_assign
l_int|0x04
op_lshift
l_int|24
suffix:semicolon
multiline_comment|/* color planes */
id|tcxinfo-&gt;bt-&gt;control
op_assign
l_int|0xff
op_lshift
l_int|24
suffix:semicolon
id|tcxinfo-&gt;bt-&gt;addr
op_assign
l_int|0x05
op_lshift
l_int|24
suffix:semicolon
id|tcxinfo-&gt;bt-&gt;control
op_assign
l_int|0x00
op_lshift
l_int|24
suffix:semicolon
id|tcxinfo-&gt;bt-&gt;addr
op_assign
l_int|0x06
op_lshift
l_int|24
suffix:semicolon
multiline_comment|/* overlay plane */
id|tcxinfo-&gt;bt-&gt;control
op_assign
l_int|0x73
op_lshift
l_int|24
suffix:semicolon
id|tcxinfo-&gt;bt-&gt;addr
op_assign
l_int|0x07
op_lshift
l_int|24
suffix:semicolon
id|tcxinfo-&gt;bt-&gt;control
op_assign
l_int|0x00
op_lshift
l_int|24
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Rev %d.%d %s&bslash;n&quot;
comma
(paren
id|tcxinfo-&gt;thc-&gt;thc_rev
op_rshift
id|TCX_THC_REV_REV_SHIFT
)paren
op_amp
id|TCX_THC_REV_REV_MASK
comma
(paren
id|tcxinfo-&gt;thc-&gt;thc_rev
op_rshift
id|TCX_THC_REV_MINREV_SHIFT
)paren
op_amp
id|TCX_THC_REV_MINREV_MASK
comma
id|tcxinfo-&gt;lowdepth
ques
c_cond
l_string|&quot;8-bit only&quot;
suffix:colon
l_string|&quot;24-bit depth&quot;
)paren
suffix:semicolon
multiline_comment|/* Reset the tcx */
id|tcx_reset
c_func
(paren
id|fb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slot
)paren
multiline_comment|/* Enable Video */
id|tcx_unblank
(paren
id|fb
)paren
suffix:semicolon
r_else
id|tcx_blank
(paren
id|fb
)paren
suffix:semicolon
)brace
eof
