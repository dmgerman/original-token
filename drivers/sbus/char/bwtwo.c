multiline_comment|/* $Id: bwtwo.c,v 1.9 1996/12/23 10:15:57 ecd Exp $&n; * bwtwo.c: bwtwo console driver&n; *&n; * Copyright (C) 1996 Miguel de Icaza (miguel@nuclecu.unam.mx)&n; */
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;../../char/vt_kern.h&quot;
macro_line|#include &quot;../../char/selection.h&quot;
macro_line|#include &quot;../../char/console_struct.h&quot;
macro_line|#include &quot;fb.h&quot;
macro_line|#include &quot;cg_common.h&quot;
multiline_comment|/* OBio addresses for the bwtwo registers */
DECL|macro|BWTWO_REGISTER_OFFSET
mdefine_line|#define BWTWO_REGISTER_OFFSET 0x400000
DECL|struct|bwtwo_regs
r_struct
id|bwtwo_regs
(brace
DECL|member|bt
id|__volatile__
r_struct
id|bt_regs
id|bt
suffix:semicolon
DECL|member|control
id|__volatile__
id|__u8
id|control
suffix:semicolon
DECL|member|status
id|__volatile__
id|__u8
id|status
suffix:semicolon
DECL|member|cursor_start
id|__volatile__
id|__u8
id|cursor_start
suffix:semicolon
DECL|member|cursor_end
id|__volatile__
id|__u8
id|cursor_end
suffix:semicolon
DECL|member|vcontrol
id|__volatile__
id|__u8
id|vcontrol
(braket
l_int|12
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Control Register Constants */
DECL|macro|BWTWO_CTL_ENABLE_INTS
mdefine_line|#define BWTWO_CTL_ENABLE_INTS   0x80
DECL|macro|BWTWO_CTL_ENABLE_VIDEO
mdefine_line|#define BWTWO_CTL_ENABLE_VIDEO  0x40
DECL|macro|BWTWO_CTL_ENABLE_TIMING
mdefine_line|#define BWTWO_CTL_ENABLE_TIMING 0x20
DECL|macro|BWTWO_CTL_ENABLE_CURCMP
mdefine_line|#define BWTWO_CTL_ENABLE_CURCMP 0x10
DECL|macro|BWTWO_CTL_XTAL_MASK
mdefine_line|#define BWTWO_CTL_XTAL_MASK     0x0C
DECL|macro|BWTWO_CTL_DIVISOR_MASK
mdefine_line|#define BWTWO_CTL_DIVISOR_MASK  0x03
multiline_comment|/* Status Register Constants */
DECL|macro|BWTWO_STAT_PENDING_INT
mdefine_line|#define BWTWO_STAT_PENDING_INT  0x80
DECL|macro|BWTWO_STAT_MSENSE_MASK
mdefine_line|#define BWTWO_STAT_MSENSE_MASK  0x70
DECL|macro|BWTWO_STAT_ID_MASK
mdefine_line|#define BWTWO_STAT_ID_MASK      0x0f
r_static
r_int
DECL|function|bwtwo_mmap
id|bwtwo_mmap
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
id|base
comma
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|uint
id|size
comma
id|map_offset
comma
id|r
suffix:semicolon
r_int
id|map_size
suffix:semicolon
id|map_size
op_assign
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_amp
op_complement
id|PAGE_MASK
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* To stop the swapper from even considering these pages */
id|vma-&gt;vm_flags
op_or_assign
id|FB_MMAP_VM_FLAGS
suffix:semicolon
multiline_comment|/* This routine should also map the register if asked for,&n;&t; * but we don&squot;t do that yet.&n;&t; */
id|map_offset
op_assign
id|get_phys
(paren
(paren
id|uint
)paren
id|fb-&gt;base
)paren
suffix:semicolon
id|r
op_assign
id|io_remap_page_range
(paren
id|vma-&gt;vm_start
comma
id|map_offset
comma
id|map_size
comma
id|vma-&gt;vm_page_prot
comma
id|fb-&gt;space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|vma-&gt;vm_inode
op_assign
id|inode
suffix:semicolon
id|inode-&gt;i_count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|bwtwo_blank
id|bwtwo_blank
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|fb-&gt;info.bwtwo.regs-&gt;control
op_and_assign
op_complement
id|BWTWO_CTL_ENABLE_VIDEO
suffix:semicolon
)brace
r_static
r_void
DECL|function|bwtwo_unblank
id|bwtwo_unblank
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|fb-&gt;info.bwtwo.regs-&gt;control
op_or_assign
id|BWTWO_CTL_ENABLE_VIDEO
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|bwtwo_setup
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|slot
comma
id|uint
id|bwtwo
comma
r_int
id|bw2_io
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;bwtwo%d at 0x%8.8x&bslash;n&quot;
comma
id|slot
comma
id|bwtwo
)paren
suffix:semicolon
id|fb-&gt;type.fb_cmsize
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;mmap
op_assign
id|bwtwo_mmap
suffix:semicolon
id|fb-&gt;loadcmap
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;ioctl
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;reset
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;blank
op_assign
id|bwtwo_blank
suffix:semicolon
id|fb-&gt;unblank
op_assign
id|bwtwo_unblank
suffix:semicolon
id|fb-&gt;info.bwtwo.regs
op_assign
id|sparc_alloc_io
(paren
(paren
r_void
op_star
)paren
id|bwtwo
op_plus
id|BWTWO_REGISTER_OFFSET
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|bwtwo_regs
)paren
comma
l_string|&quot;bwtwo_regs&quot;
comma
id|bw2_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;base
)paren
(brace
id|fb-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|sparc_alloc_io
c_func
(paren
(paren
r_void
op_star
)paren
id|bwtwo
comma
l_int|0
comma
(paren
(paren
id|fb-&gt;type.fb_depth
op_star
id|fb-&gt;type.fb_height
op_star
id|fb-&gt;type.fb_width
)paren
op_div
l_int|8
)paren
comma
l_string|&quot;bwtwo_fbase&quot;
comma
id|bw2_io
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot
op_logical_and
id|sun_prom_console_id
op_ne
id|slot
)paren
id|bwtwo_blank
(paren
id|fb
)paren
suffix:semicolon
)brace
eof
