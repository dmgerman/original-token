multiline_comment|/* $Id: bwtwo.c,v 1.21 1998/04/24 12:29:53 davem Exp $&n; * bwtwo.c: bwtwo console driver&n; *&n; * Copyright (C) 1996 Miguel de Icaza (miguel@nuclecu.unam.mx)&n; * Copyright (C) 1997 Eddie C. Dost   (ecd@skynet.be)&n; * Copyright (C) 1998 Pavel Machek    (pavel@ucw.cz)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
multiline_comment|/* These must be included after asm/fbio.h */
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
macro_line|#include &quot;fb.h&quot;
macro_line|#include &quot;cg_common.h&quot;
multiline_comment|/* OBio addresses for the bwtwo registers */
DECL|macro|BWTWO_REGISTER_OFFSET
mdefine_line|#define BWTWO_REGISTER_OFFSET 0x400000
DECL|struct|bwtwo_regs
r_struct
id|bwtwo_regs
(brace
DECL|member|bt
id|__volatile__
r_struct
id|bt_regs
id|bt
suffix:semicolon
DECL|member|control
id|__volatile__
id|__u8
id|control
suffix:semicolon
DECL|member|status
id|__volatile__
id|__u8
id|status
suffix:semicolon
DECL|member|cursor_start
id|__volatile__
id|__u8
id|cursor_start
suffix:semicolon
DECL|member|cursor_end
id|__volatile__
id|__u8
id|cursor_end
suffix:semicolon
DECL|member|h_blank_start
id|__volatile__
id|__u8
id|h_blank_start
suffix:semicolon
DECL|member|h_blank_end
id|__volatile__
id|__u8
id|h_blank_end
suffix:semicolon
DECL|member|h_sync_start
id|__volatile__
id|__u8
id|h_sync_start
suffix:semicolon
DECL|member|h_sync_end
id|__volatile__
id|__u8
id|h_sync_end
suffix:semicolon
DECL|member|comp_sync_end
id|__volatile__
id|__u8
id|comp_sync_end
suffix:semicolon
DECL|member|v_blank_start_high
id|__volatile__
id|__u8
id|v_blank_start_high
suffix:semicolon
DECL|member|v_blank_start_low
id|__volatile__
id|__u8
id|v_blank_start_low
suffix:semicolon
DECL|member|v_blank_end
id|__volatile__
id|__u8
id|v_blank_end
suffix:semicolon
DECL|member|v_sync_start
id|__volatile__
id|__u8
id|v_sync_start
suffix:semicolon
DECL|member|v_sync_end
id|__volatile__
id|__u8
id|v_sync_end
suffix:semicolon
DECL|member|xfer_holdoff_start
id|__volatile__
id|__u8
id|xfer_holdoff_start
suffix:semicolon
DECL|member|xfer_holdoff_end
id|__volatile__
id|__u8
id|xfer_holdoff_end
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Status Register Constants */
DECL|macro|BWTWO_SR_RES_MASK
mdefine_line|#define BWTWO_SR_RES_MASK&t;0x70
DECL|macro|BWTWO_SR_1600_1280
mdefine_line|#define BWTWO_SR_1600_1280&t;0x50
DECL|macro|BWTWO_SR_1152_900_76_A
mdefine_line|#define BWTWO_SR_1152_900_76_A&t;0x40
DECL|macro|BWTWO_SR_1152_900_76_B
mdefine_line|#define BWTWO_SR_1152_900_76_B&t;0x60
DECL|macro|BWTWO_SR_ID_MASK
mdefine_line|#define BWTWO_SR_ID_MASK&t;0x0f
DECL|macro|BWTWO_SR_ID_MONO
mdefine_line|#define BWTWO_SR_ID_MONO&t;0x02
DECL|macro|BWTWO_SR_ID_MONO_ECL
mdefine_line|#define BWTWO_SR_ID_MONO_ECL&t;0x03
DECL|macro|BWTWO_SR_ID_MSYNC
mdefine_line|#define BWTWO_SR_ID_MSYNC&t;0x04
multiline_comment|/* Control Register Constants */
DECL|macro|BWTWO_CTL_ENABLE_INTS
mdefine_line|#define BWTWO_CTL_ENABLE_INTS   0x80
DECL|macro|BWTWO_CTL_ENABLE_VIDEO
mdefine_line|#define BWTWO_CTL_ENABLE_VIDEO  0x40
DECL|macro|BWTWO_CTL_ENABLE_TIMING
mdefine_line|#define BWTWO_CTL_ENABLE_TIMING 0x20
DECL|macro|BWTWO_CTL_ENABLE_CURCMP
mdefine_line|#define BWTWO_CTL_ENABLE_CURCMP 0x10
DECL|macro|BWTWO_CTL_XTAL_MASK
mdefine_line|#define BWTWO_CTL_XTAL_MASK     0x0C
DECL|macro|BWTWO_CTL_DIVISOR_MASK
mdefine_line|#define BWTWO_CTL_DIVISOR_MASK  0x03
multiline_comment|/* Status Register Constants */
DECL|macro|BWTWO_STAT_PENDING_INT
mdefine_line|#define BWTWO_STAT_PENDING_INT  0x80
DECL|macro|BWTWO_STAT_MSENSE_MASK
mdefine_line|#define BWTWO_STAT_MSENSE_MASK  0x70
DECL|macro|BWTWO_STAT_ID_MASK
mdefine_line|#define BWTWO_STAT_ID_MASK      0x0f
r_static
r_int
DECL|function|bwtwo_mmap
id|bwtwo_mmap
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
id|base
comma
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|uint
id|size
comma
id|r
suffix:semicolon
r_int
r_int
id|map_offset
suffix:semicolon
r_int
id|map_size
suffix:semicolon
id|map_size
op_assign
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_amp
op_complement
id|PAGE_MASK
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* To stop the swapper from even considering these pages */
id|vma-&gt;vm_flags
op_or_assign
id|FB_MMAP_VM_FLAGS
suffix:semicolon
multiline_comment|/* This routine should also map the register if asked for,&n;&t; * but we don&squot;t do that yet.&n;&t; */
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
suffix:semicolon
id|r
op_assign
id|io_remap_page_range
(paren
id|vma-&gt;vm_start
comma
id|map_offset
comma
id|map_size
comma
id|vma-&gt;vm_page_prot
comma
id|fb-&gt;space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|vma-&gt;vm_file
op_assign
id|file
suffix:semicolon
id|file-&gt;f_count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|bwtwo_blank
id|bwtwo_blank
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|fb-&gt;info.bwtwo.regs-&gt;control
op_and_assign
op_complement
id|BWTWO_CTL_ENABLE_VIDEO
suffix:semicolon
)brace
r_static
r_void
DECL|function|bwtwo_unblank
id|bwtwo_unblank
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|fb-&gt;info.bwtwo.regs-&gt;control
op_or_assign
id|BWTWO_CTL_ENABLE_VIDEO
suffix:semicolon
)brace
DECL|variable|__initdata
r_static
id|u8
id|bw2regs_1600
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0x14
comma
l_int|0x8b
comma
l_int|0x15
comma
l_int|0x28
comma
l_int|0x16
comma
l_int|0x03
comma
l_int|0x17
comma
l_int|0x13
comma
l_int|0x18
comma
l_int|0x7b
comma
l_int|0x19
comma
l_int|0x05
comma
l_int|0x1a
comma
l_int|0x34
comma
l_int|0x1b
comma
l_int|0x2e
comma
l_int|0x1c
comma
l_int|0x00
comma
l_int|0x1d
comma
l_int|0x0a
comma
l_int|0x1e
comma
l_int|0xff
comma
l_int|0x1f
comma
l_int|0x01
comma
l_int|0x10
comma
l_int|0x21
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|u8
id|bw2regs_ecl
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0x14
comma
l_int|0x65
comma
l_int|0x15
comma
l_int|0x1e
comma
l_int|0x16
comma
l_int|0x04
comma
l_int|0x17
comma
l_int|0x0c
comma
l_int|0x18
comma
l_int|0x5e
comma
l_int|0x19
comma
l_int|0x03
comma
l_int|0x1a
comma
l_int|0xa7
comma
l_int|0x1b
comma
l_int|0x23
comma
l_int|0x1c
comma
l_int|0x00
comma
l_int|0x1d
comma
l_int|0x08
comma
l_int|0x1e
comma
l_int|0xff
comma
l_int|0x1f
comma
l_int|0x01
comma
l_int|0x10
comma
l_int|0x20
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|u8
id|bw2regs_analog
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0x14
comma
l_int|0xbb
comma
l_int|0x15
comma
l_int|0x2b
comma
l_int|0x16
comma
l_int|0x03
comma
l_int|0x17
comma
l_int|0x13
comma
l_int|0x18
comma
l_int|0xb0
comma
l_int|0x19
comma
l_int|0x03
comma
l_int|0x1a
comma
l_int|0xa6
comma
l_int|0x1b
comma
l_int|0x22
comma
l_int|0x1c
comma
l_int|0x01
comma
l_int|0x1d
comma
l_int|0x05
comma
l_int|0x1e
comma
l_int|0xff
comma
l_int|0x1f
comma
l_int|0x01
comma
l_int|0x10
comma
l_int|0x20
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|u8
id|bw2regs_76hz
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0x14
comma
l_int|0xb7
comma
l_int|0x15
comma
l_int|0x27
comma
l_int|0x16
comma
l_int|0x03
comma
l_int|0x17
comma
l_int|0x0f
comma
l_int|0x18
comma
l_int|0xae
comma
l_int|0x19
comma
l_int|0x03
comma
l_int|0x1a
comma
l_int|0xae
comma
l_int|0x1b
comma
l_int|0x2a
comma
l_int|0x1c
comma
l_int|0x01
comma
l_int|0x1d
comma
l_int|0x09
comma
l_int|0x1e
comma
l_int|0xff
comma
l_int|0x1f
comma
l_int|0x01
comma
l_int|0x10
comma
l_int|0x24
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|u8
id|bw2regs_66hz
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0x14
comma
l_int|0xbb
comma
l_int|0x15
comma
l_int|0x2b
comma
l_int|0x16
comma
l_int|0x04
comma
l_int|0x17
comma
l_int|0x14
comma
l_int|0x18
comma
l_int|0xae
comma
l_int|0x19
comma
l_int|0x03
comma
l_int|0x1a
comma
l_int|0xa8
comma
l_int|0x1b
comma
l_int|0x24
comma
l_int|0x1c
comma
l_int|0x01
comma
l_int|0x1d
comma
l_int|0x05
comma
l_int|0x1e
comma
l_int|0xff
comma
l_int|0x1f
comma
l_int|0x01
comma
l_int|0x10
comma
l_int|0x20
comma
l_int|0
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|bwtwo_setup
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|slot
comma
id|u32
id|bwtwo
comma
r_int
id|bw2_io
comma
r_struct
id|linux_sbus_device
op_star
id|sbdp
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;bwtwo%d at 0x%8.8x&bslash;n&quot;
comma
id|slot
comma
id|bwtwo
)paren
suffix:semicolon
id|fb-&gt;type.fb_cmsize
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;mmap
op_assign
id|bwtwo_mmap
suffix:semicolon
id|fb-&gt;loadcmap
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;ioctl
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;reset
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef CONFIG_SUN4&t;
id|fb-&gt;blank
op_assign
id|bwtwo_blank
suffix:semicolon
id|fb-&gt;unblank
op_assign
id|bwtwo_unblank
suffix:semicolon
macro_line|#endif
id|fb-&gt;info.bwtwo.regs
op_assign
id|sparc_alloc_io
(paren
id|bwtwo
op_plus
id|BWTWO_REGISTER_OFFSET
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|bwtwo_regs
)paren
comma
l_string|&quot;bwtwo_regs&quot;
comma
id|bw2_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbdp
op_logical_and
op_logical_neg
id|prom_getbool
c_func
(paren
id|sbdp-&gt;prom_node
comma
l_string|&quot;width&quot;
)paren
)paren
(brace
multiline_comment|/* Ugh, broken PROM didn&squot;t initialize us.&n;&t;&t; * Let&squot;s deal with this ourselves.&n;&t;&t; */
id|u8
id|status
comma
id|mon
suffix:semicolon
id|u8
op_star
id|p
suffix:semicolon
id|status
op_assign
id|fb-&gt;info.bwtwo.regs-&gt;status
suffix:semicolon
id|mon
op_assign
id|status
op_amp
id|BWTWO_SR_RES_MASK
suffix:semicolon
r_switch
c_cond
(paren
id|status
op_amp
id|BWTWO_SR_ID_MASK
)paren
(brace
r_case
id|BWTWO_SR_ID_MONO_ECL
suffix:colon
r_if
c_cond
(paren
id|mon
op_eq
id|BWTWO_SR_1600_1280
)paren
(brace
id|p
op_assign
id|bw2regs_1600
suffix:semicolon
id|fb-&gt;type.fb_width
op_assign
l_int|1600
suffix:semicolon
id|fb-&gt;type.fb_height
op_assign
l_int|1280
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|bw2regs_ecl
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BWTWO_SR_ID_MONO
suffix:colon
id|p
op_assign
id|bw2regs_analog
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BWTWO_SR_ID_MSYNC
suffix:colon
r_if
c_cond
(paren
id|mon
op_eq
id|BWTWO_SR_1152_900_76_A
op_logical_or
id|mon
op_eq
id|BWTWO_SR_1152_900_76_B
)paren
(brace
id|p
op_assign
id|bw2regs_76hz
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|bw2regs_66hz
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|prom_printf
c_func
(paren
l_string|&quot;bwtwo: can&squot;t handle SR %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* fool gcc. */
)brace
r_for
c_loop
(paren
suffix:semicolon
op_star
id|p
suffix:semicolon
id|p
op_add_assign
l_int|2
)paren
(paren
(paren
id|u8
op_star
)paren
id|fb-&gt;info.bwtwo.regs
)paren
(braket
id|p
(braket
l_int|0
)braket
)braket
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;base
)paren
(brace
id|fb-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|sparc_alloc_io
c_func
(paren
id|bwtwo
comma
l_int|0
comma
(paren
(paren
id|fb-&gt;type.fb_depth
op_star
id|fb-&gt;type.fb_height
op_star
id|fb-&gt;type.fb_width
)paren
op_div
l_int|8
)paren
comma
l_string|&quot;bwtwo_fbase&quot;
comma
id|bw2_io
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot
op_logical_and
id|sun_prom_console_id
op_ne
id|slot
)paren
id|bwtwo_blank
(paren
id|fb
)paren
suffix:semicolon
)brace
eof
