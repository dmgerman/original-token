multiline_comment|/* $Id: cgfourteen.c,v 1.25 1997/08/20 07:38:36 davem Exp $&n; * cgfourteen.c: Sun SparcStation console support.&n; *&n; * Copyright (C) 1995 Miguel de Icaza (miguel@nuclecu.unam.mx)&n; * Copyright (C) 1996 Jakub Jelinek (jj@sunsite.mff.cuni.cz)&n; *&n; * TODO:&n; *&n; * Add the ioctls for CLUT manipulation.&n; * Map only the amount requested, not a constant amount.&n; * XBGR mapping.&n; * Add the interrupt handler.&n;*/
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/* These must be included after asm/fbio.h */
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
macro_line|#include &quot;fb.h&quot;
DECL|macro|CG14_MCR_INTENABLE_SHIFT
mdefine_line|#define CG14_MCR_INTENABLE_SHIFT&t;7
DECL|macro|CG14_MCR_INTENABLE_MASK
mdefine_line|#define CG14_MCR_INTENABLE_MASK&t;&t;0x80
DECL|macro|CG14_MCR_VIDENABLE_SHIFT
mdefine_line|#define CG14_MCR_VIDENABLE_SHIFT&t;6
DECL|macro|CG14_MCR_VIDENABLE_MASK
mdefine_line|#define CG14_MCR_VIDENABLE_MASK&t;&t;0x40
DECL|macro|CG14_MCR_PIXMODE_SHIFT
mdefine_line|#define CG14_MCR_PIXMODE_SHIFT&t;&t;4
DECL|macro|CG14_MCR_PIXMODE_MASK
mdefine_line|#define CG14_MCR_PIXMODE_MASK&t;&t;0x30
DECL|macro|CG14_MCR_TMR_SHIFT
mdefine_line|#define CG14_MCR_TMR_SHIFT&t;&t;2
DECL|macro|CG14_MCR_TMR_MASK
mdefine_line|#define CG14_MCR_TMR_MASK&t;&t;0x0c
DECL|macro|CG14_MCR_TMENABLE_SHIFT
mdefine_line|#define CG14_MCR_TMENABLE_SHIFT&t;&t;1
DECL|macro|CG14_MCR_TMENABLE_MASK
mdefine_line|#define CG14_MCR_TMENABLE_MASK&t;&t;0x02
DECL|macro|CG14_MCR_RESET_SHIFT
mdefine_line|#define CG14_MCR_RESET_SHIFT&t;&t;0
DECL|macro|CG14_MCR_RESET_MASK
mdefine_line|#define CG14_MCR_RESET_MASK&t;&t;0x01
DECL|macro|CG14_REV_REVISION_SHIFT
mdefine_line|#define CG14_REV_REVISION_SHIFT&t;&t;4
DECL|macro|CG14_REV_REVISION_MASK
mdefine_line|#define CG14_REV_REVISION_MASK&t;&t;0xf0
DECL|macro|CG14_REV_IMPL_SHIFT
mdefine_line|#define CG14_REV_IMPL_SHIFT&t;&t;0
DECL|macro|CG14_REV_IMPL_MASK
mdefine_line|#define CG14_REV_IMPL_MASK&t;&t;0x0f
DECL|macro|CG14_VBR_FRAMEBASE_SHIFT
mdefine_line|#define CG14_VBR_FRAMEBASE_SHIFT&t;12
DECL|macro|CG14_VBR_FRAMEBASE_MASK
mdefine_line|#define CG14_VBR_FRAMEBASE_MASK&t;&t;0x00fff000
DECL|macro|CG14_VMCR1_SETUP_SHIFT
mdefine_line|#define CG14_VMCR1_SETUP_SHIFT&t;&t;0
DECL|macro|CG14_VMCR1_SETUP_MASK
mdefine_line|#define CG14_VMCR1_SETUP_MASK&t;&t;0x000001ff
DECL|macro|CG14_VMCR1_VCONFIG_SHIFT
mdefine_line|#define CG14_VMCR1_VCONFIG_SHIFT&t;9
DECL|macro|CG14_VMCR1_VCONFIG_MASK
mdefine_line|#define CG14_VMCR1_VCONFIG_MASK&t;&t;0x00000e00
DECL|macro|CG14_VMCR2_REFRESH_SHIFT
mdefine_line|#define CG14_VMCR2_REFRESH_SHIFT&t;0
DECL|macro|CG14_VMCR2_REFRESH_MASK
mdefine_line|#define CG14_VMCR2_REFRESH_MASK&t;&t;0x00000001
DECL|macro|CG14_VMCR2_TESTROWCNT_SHIFT
mdefine_line|#define CG14_VMCR2_TESTROWCNT_SHIFT&t;1
DECL|macro|CG14_VMCR2_TESTROWCNT_MASK
mdefine_line|#define CG14_VMCR2_TESTROWCNT_MASK&t;0x00000002
DECL|macro|CG14_VMCR2_FBCONFIG_SHIFT
mdefine_line|#define CG14_VMCR2_FBCONFIG_SHIFT&t;2
DECL|macro|CG14_VMCR2_FBCONFIG_MASK
mdefine_line|#define CG14_VMCR2_FBCONFIG_MASK&t;0x0000000c
DECL|macro|CG14_VCR_REFRESHREQ_SHIFT
mdefine_line|#define CG14_VCR_REFRESHREQ_SHIFT&t;0
DECL|macro|CG14_VCR_REFRESHREQ_MASK
mdefine_line|#define CG14_VCR_REFRESHREQ_MASK&t;0x000003ff
DECL|macro|CG14_VCR1_REFRESHENA_SHIFT
mdefine_line|#define CG14_VCR1_REFRESHENA_SHIFT&t;10
DECL|macro|CG14_VCR1_REFRESHENA_MASK
mdefine_line|#define CG14_VCR1_REFRESHENA_MASK&t;0x00000400
DECL|macro|CG14_VCA_CAD_SHIFT
mdefine_line|#define CG14_VCA_CAD_SHIFT&t;&t;0
DECL|macro|CG14_VCA_CAD_MASK
mdefine_line|#define CG14_VCA_CAD_MASK&t;&t;0x000003ff
DECL|macro|CG14_VCA_VERS_SHIFT
mdefine_line|#define CG14_VCA_VERS_SHIFT&t;&t;10
DECL|macro|CG14_VCA_VERS_MASK
mdefine_line|#define CG14_VCA_VERS_MASK&t;&t;0x00000c00
DECL|macro|CG14_VCA_RAMSPEED_SHIFT
mdefine_line|#define CG14_VCA_RAMSPEED_SHIFT&t;&t;12
DECL|macro|CG14_VCA_RAMSPEED_MASK
mdefine_line|#define CG14_VCA_RAMSPEED_MASK&t;&t;0x00001000
DECL|macro|CG14_VCA_8MB_SHIFT
mdefine_line|#define CG14_VCA_8MB_SHIFT&t;&t;13
DECL|macro|CG14_VCA_8MB_MASK
mdefine_line|#define CG14_VCA_8MB_MASK&t;&t;0x00002000
DECL|macro|CG14_MCR_PIXMODE_8
mdefine_line|#define CG14_MCR_PIXMODE_8&t;&t;0
DECL|macro|CG14_MCR_PIXMODE_16
mdefine_line|#define CG14_MCR_PIXMODE_16&t;&t;2
DECL|macro|CG14_MCR_PIXMODE_32
mdefine_line|#define CG14_MCR_PIXMODE_32&t;&t;3
DECL|struct|cg14_regs
r_struct
id|cg14_regs
(brace
DECL|member|mcr
r_volatile
id|u8
id|mcr
suffix:semicolon
multiline_comment|/* Master Control Reg */
DECL|member|ppr
r_volatile
id|u8
id|ppr
suffix:semicolon
multiline_comment|/* Packed Pixel Reg */
DECL|member|tms
r_volatile
id|u8
id|tms
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Test Mode Status Regs */
DECL|member|msr
r_volatile
id|u8
id|msr
suffix:semicolon
multiline_comment|/* Master Status Reg */
DECL|member|fsr
r_volatile
id|u8
id|fsr
suffix:semicolon
multiline_comment|/* Fault Status Reg */
DECL|member|rev
r_volatile
id|u8
id|rev
suffix:semicolon
multiline_comment|/* Revision &amp; Impl */
DECL|member|ccr
r_volatile
id|u8
id|ccr
suffix:semicolon
multiline_comment|/* Clock Control Reg */
DECL|member|tmr
r_volatile
id|u32
id|tmr
suffix:semicolon
multiline_comment|/* Test Mode Read Back */
DECL|member|mod
r_volatile
id|u8
id|mod
suffix:semicolon
multiline_comment|/* Monitor Operation Data Reg */
DECL|member|acr
r_volatile
id|u8
id|acr
suffix:semicolon
multiline_comment|/* Aux Control */
DECL|member|xxx0
id|u8
id|xxx0
(braket
l_int|6
)braket
suffix:semicolon
DECL|member|hct
r_volatile
id|u16
id|hct
suffix:semicolon
multiline_comment|/* Hor Counter */
DECL|member|vct
r_volatile
id|u16
id|vct
suffix:semicolon
multiline_comment|/* Vert Counter */
DECL|member|hbs
r_volatile
id|u16
id|hbs
suffix:semicolon
multiline_comment|/* Hor Blank Start */
DECL|member|hbc
r_volatile
id|u16
id|hbc
suffix:semicolon
multiline_comment|/* Hor Blank Clear */
DECL|member|hss
r_volatile
id|u16
id|hss
suffix:semicolon
multiline_comment|/* Hor Sync Start */
DECL|member|hsc
r_volatile
id|u16
id|hsc
suffix:semicolon
multiline_comment|/* Hor Sync Clear */
DECL|member|csc
r_volatile
id|u16
id|csc
suffix:semicolon
multiline_comment|/* Composite Sync Clear */
DECL|member|vbs
r_volatile
id|u16
id|vbs
suffix:semicolon
multiline_comment|/* Vert Blank Start */
DECL|member|vbc
r_volatile
id|u16
id|vbc
suffix:semicolon
multiline_comment|/* Vert Blank Clear */
DECL|member|vss
r_volatile
id|u16
id|vss
suffix:semicolon
multiline_comment|/* Vert Sync Start */
DECL|member|vsc
r_volatile
id|u16
id|vsc
suffix:semicolon
multiline_comment|/* Vert Sync Clear */
DECL|member|xcs
r_volatile
id|u16
id|xcs
suffix:semicolon
DECL|member|xcc
r_volatile
id|u16
id|xcc
suffix:semicolon
DECL|member|fsa
r_volatile
id|u16
id|fsa
suffix:semicolon
multiline_comment|/* Fault Status Address */
DECL|member|adr
r_volatile
id|u16
id|adr
suffix:semicolon
multiline_comment|/* Address Registers */
DECL|member|xxx1
id|u8
id|xxx1
(braket
l_int|0xce
)braket
suffix:semicolon
DECL|member|pcg
r_volatile
id|u8
id|pcg
(braket
l_int|0x100
)braket
suffix:semicolon
multiline_comment|/* Pixel Clock Generator */
DECL|member|vbr
r_volatile
id|u32
id|vbr
suffix:semicolon
multiline_comment|/* Frame Base Row */
DECL|member|vmcr
r_volatile
id|u32
id|vmcr
suffix:semicolon
multiline_comment|/* VBC Master Control */
DECL|member|vcr
r_volatile
id|u32
id|vcr
suffix:semicolon
multiline_comment|/* VBC refresh */
DECL|member|vca
r_volatile
id|u32
id|vca
suffix:semicolon
multiline_comment|/* VBC Config */
)brace
suffix:semicolon
DECL|macro|CG14_CCR_ENABLE
mdefine_line|#define CG14_CCR_ENABLE&t;0x04
DECL|macro|CG14_CCR_SELECT
mdefine_line|#define CG14_CCR_SELECT 0x02&t;/* HW/Full screen */
DECL|struct|cg14_cursor
r_struct
id|cg14_cursor
(brace
DECL|member|cpl0
r_volatile
id|u32
id|cpl0
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* Enable plane 0 */
DECL|member|cpl1
r_volatile
id|u32
id|cpl1
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* Color selection plane */
DECL|member|ccr
r_volatile
id|u8
id|ccr
suffix:semicolon
multiline_comment|/* Cursor Control Reg */
DECL|member|xxx0
id|u8
id|xxx0
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|cursx
r_volatile
id|u16
id|cursx
suffix:semicolon
multiline_comment|/* Cursor x,y position */
DECL|member|cursy
r_volatile
id|u16
id|cursy
suffix:semicolon
multiline_comment|/* Cursor x,y position */
DECL|member|color0
r_volatile
id|u32
id|color0
suffix:semicolon
DECL|member|color1
r_volatile
id|u32
id|color1
suffix:semicolon
DECL|member|xxx1
id|u32
id|xxx1
(braket
l_int|0x1bc
)braket
suffix:semicolon
DECL|member|cpl0i
r_volatile
id|u32
id|cpl0i
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* Enable plane 0 autoinc */
DECL|member|cpl1i
r_volatile
id|u32
id|cpl1i
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* Color selection autoinc */
)brace
suffix:semicolon
DECL|struct|cg14_dac
r_struct
id|cg14_dac
(brace
DECL|member|addr
r_volatile
id|u8
id|addr
suffix:semicolon
multiline_comment|/* Address Register */
DECL|member|xxx0
id|u8
id|xxx0
(braket
l_int|255
)braket
suffix:semicolon
DECL|member|glut
r_volatile
id|u8
id|glut
suffix:semicolon
multiline_comment|/* Gamma table */
DECL|member|xxx1
id|u8
id|xxx1
(braket
l_int|255
)braket
suffix:semicolon
DECL|member|select
r_volatile
id|u8
id|select
suffix:semicolon
multiline_comment|/* Register Select */
DECL|member|xxx2
id|u8
id|xxx2
(braket
l_int|255
)braket
suffix:semicolon
DECL|member|mode
r_volatile
id|u8
id|mode
suffix:semicolon
multiline_comment|/* Mode Register */
)brace
suffix:semicolon
DECL|struct|cg14_xlut
r_struct
id|cg14_xlut
(brace
DECL|member|x_xlut
r_volatile
id|u8
id|x_xlut
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|x_xlutd
r_volatile
id|u8
id|x_xlutd
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|xxx0
id|u8
id|xxx0
(braket
l_int|0x600
)braket
suffix:semicolon
DECL|member|x_xlut_inc
r_volatile
id|u8
id|x_xlut_inc
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|x_xlutd_inc
r_volatile
id|u8
id|x_xlutd_inc
(braket
l_int|256
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Color look up table (clut) */
multiline_comment|/* Each one of these arrays hold the color lookup table (for 256&n; * colors) for each MDI page (I assume then there should be 4 MDI&n; * pages, I still wonder what they are.  I have seen NeXTStep split&n; * the screen in four parts, while operating in 24 bits mode.  Each&n; * integer holds 4 values: alpha value (transparency channel, thanks&n; * go to John Stone (johns@umr.edu) from OpenBSD), red, green and blue&n; *&n; * I currently use the clut instead of the Xlut&n; */
DECL|struct|cg14_clut
r_struct
id|cg14_clut
(brace
DECL|member|c_clut
r_int
r_int
id|c_clut
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|c_clutd
r_int
r_int
id|c_clutd
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* i wonder what the &squot;d&squot; is for */
DECL|member|c_clut_inc
r_int
r_int
id|c_clut_inc
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|c_clutd_inc
r_int
r_int
id|c_clutd_inc
(braket
l_int|256
)braket
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|cg14_mmap
id|cg14_mmap
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
id|base
comma
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|uint
id|size
comma
id|page
comma
id|r
comma
id|map_size
suffix:semicolon
r_int
r_int
id|map_offset
op_assign
l_int|0
suffix:semicolon
id|uint
id|ram_size
op_assign
id|fb-&gt;info.cg14.ramsize
suffix:semicolon
id|printk
(paren
l_string|&quot;RAMSIZE=%d&bslash;n&quot;
comma
id|ram_size
)paren
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_amp
op_complement
id|PAGE_MASK
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* To stop the swapper from even considering these pages */
id|vma-&gt;vm_flags
op_or_assign
id|FB_MMAP_VM_FLAGS
suffix:semicolon
multiline_comment|/* Each page, see which map applies */
r_for
c_loop
(paren
id|page
op_assign
l_int|0
suffix:semicolon
id|page
OL
id|size
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
id|vma-&gt;vm_offset
op_plus
id|page
)paren
(brace
r_case
id|CG3_MMAP_OFFSET
op_minus
l_int|0x7000
suffix:colon
id|printk
(paren
l_string|&quot;Wee!  They are mapping the register, report this to miguel@gnu.ai.mit.edu&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Mapping fb-&gt;info.regs!&bslash;n&quot;
)paren
suffix:semicolon
id|map_size
op_assign
l_int|0x7000
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.cg14.regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CG3_MMAP_OFFSET
suffix:colon
id|map_size
op_assign
id|size
op_minus
id|page
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_PLANAR_X16_MAP
suffix:colon
id|map_size
op_assign
id|ram_size
op_div
l_int|2
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
op_or
l_int|0x2000000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_PLANAR_C16_MAP
suffix:colon
id|map_size
op_assign
id|ram_size
op_div
l_int|2
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
op_or
l_int|0x2800000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_CHUNKY_XBGR_MAP
suffix:colon
id|map_size
op_assign
l_int|0
suffix:semicolon
id|printk
(paren
l_string|&quot;Woo Woo: XBGR not there yet&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_CHUNKY_BGR_MAP
suffix:colon
id|map_size
op_assign
id|ram_size
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
op_or
l_int|0x1000000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_PLANAR_X32_MAP
suffix:colon
id|map_size
op_assign
id|ram_size
op_div
l_int|4
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
op_or
l_int|0x3000000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_PLANAR_B32_MAP
suffix:colon
id|map_size
op_assign
id|ram_size
op_div
l_int|4
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
op_or
l_int|0x3400000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_PLANAR_G32_MAP
suffix:colon
id|map_size
op_assign
id|ram_size
op_div
l_int|4
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
op_or
l_int|0x3800000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_PLANAR_R32_MAP
suffix:colon
id|map_size
op_assign
id|ram_size
op_div
l_int|4
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;base
)paren
op_or
l_int|0x3c00000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_CURSOR_MAP
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.cg14.cursor_regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CG14_REGS
suffix:colon
id|printk
(paren
l_string|&quot;Wee!  They are mapping the register, report this to miguel@gnu.ai.mit.edu&bslash;n&quot;
)paren
suffix:semicolon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.cg14.regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CG14_XLUT
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.cg14.regs
op_plus
l_int|0x3000
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CG14_CLUT1
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.cg14.regs
op_plus
l_int|0x4000
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CG14_CLUT2
suffix:colon
id|map_size
op_assign
id|PAGE_SIZE
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
r_int
r_int
)paren
id|fb-&gt;info.cg14.regs
op_plus
l_int|0x5000
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|map_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|map_size
)paren
(brace
id|page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|page
op_plus
id|map_size
OG
id|size
)paren
id|map_size
op_assign
id|size
op_minus
id|page
suffix:semicolon
id|r
op_assign
id|io_remap_page_range
(paren
id|vma-&gt;vm_start
op_plus
id|page
comma
id|map_offset
comma
id|map_size
comma
id|vma-&gt;vm_page_prot
comma
id|fb-&gt;space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|page
op_add_assign
id|map_size
suffix:semicolon
)brace
id|vma-&gt;vm_dentry
op_assign
id|dget
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|cg14_cmap
id|cg14_cmap
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|index
comma
r_int
id|count
)paren
(brace
r_struct
id|cg14_clut
op_star
id|clut
op_assign
id|fb-&gt;info.cg14.clut
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|index
suffix:semicolon
id|count
op_decrement
suffix:semicolon
id|i
op_increment
)paren
(brace
id|clut-&gt;c_clut
(braket
id|i
)braket
op_assign
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|2
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|1
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|cg14_setcursormap
id|cg14_setcursormap
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
r_char
op_star
id|red
comma
r_int
r_char
op_star
id|green
comma
r_int
r_char
op_star
id|blue
)paren
(brace
r_struct
id|cg14_cursor
op_star
id|cur
op_assign
id|fb-&gt;info.cg14.cursor_regs
suffix:semicolon
id|cur-&gt;color0
op_assign
(paren
(paren
id|red
(braket
l_int|0
)braket
)paren
op_or
(paren
id|green
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|blue
(braket
l_int|0
)braket
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|cur-&gt;color1
op_assign
(paren
(paren
id|red
(braket
l_int|1
)braket
)paren
op_or
(paren
id|green
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|blue
(braket
l_int|1
)braket
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Load cursor information */
r_static
r_void
DECL|function|cg14_setcursor
id|cg14_setcursor
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_struct
id|cg_cursor
op_star
id|c
op_assign
op_amp
id|fb-&gt;cursor
suffix:semicolon
r_struct
id|cg14_cursor
op_star
id|cur
op_assign
id|fb-&gt;info.cg14.cursor_regs
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;enable
)paren
id|cur-&gt;ccr
op_or_assign
id|CG14_CCR_ENABLE
suffix:semicolon
id|cur-&gt;cursx
op_assign
(paren
(paren
id|c-&gt;cpos.fbx
op_minus
id|c-&gt;chot.fbx
)paren
op_amp
l_int|0xfff
)paren
suffix:semicolon
id|cur-&gt;cursy
op_assign
(paren
(paren
id|c-&gt;cpos.fby
op_minus
id|c-&gt;chot.fby
)paren
op_amp
l_int|0xfff
)paren
suffix:semicolon
)brace
multiline_comment|/* Set cursor shape */
r_static
r_void
DECL|function|cg14_setcurshape
id|cg14_setcurshape
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_struct
id|cg14_cursor
op_star
id|cur
op_assign
id|fb-&gt;info.cg14.cursor_regs
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cur-&gt;cpl0
(braket
id|i
)braket
op_assign
id|fb-&gt;cursor.bits
(braket
l_int|0
)braket
(braket
id|i
)braket
suffix:semicolon
id|cur-&gt;cpl1
(braket
id|i
)braket
op_assign
id|fb-&gt;cursor.bits
(braket
l_int|1
)braket
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/* These ones are for putting the video card on 16/32 bpp */
r_static
r_int
DECL|function|cg14_ioctl
id|cg14_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MDI_RESET
suffix:colon
(brace
r_volatile
r_int
r_char
op_star
id|control
op_assign
op_amp
(paren
id|fb-&gt;info.cg14.regs-&gt;mcr
)paren
suffix:semicolon
op_star
id|control
op_assign
(paren
op_star
id|control
op_amp
op_complement
id|CG14_MCR_PIXMODE_MASK
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MDI_GET_CFGINFO
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|mdi_cfginfo
op_star
id|mdii
suffix:semicolon
id|error
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mdi_cfginfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|mdii
op_assign
(paren
r_struct
id|mdi_cfginfo
op_star
)paren
id|arg
suffix:semicolon
macro_line|#if 0
id|__put_user_ret
c_func
(paren
l_int|2
comma
op_amp
id|mdii-&gt;mdi_ncluts
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fb-&gt;info.cg14.regs-&gt;rev
op_amp
id|CG14_REV_IMPL_MASK
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|2
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|3
suffix:colon
id|__put_user_ret
c_func
(paren
l_int|3
comma
op_amp
id|mdii-&gt;mdi_ncluts
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;Unknown implementation number&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|__put_user_ret
c_func
(paren
id|FBTYPE_MDICOLOR
comma
op_amp
id|mdii-&gt;mdi_type
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
id|fb-&gt;type.fb_height
comma
op_amp
id|mdii-&gt;mdi_height
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
id|fb-&gt;type.fb_width
comma
op_amp
id|mdii-&gt;mdi_width
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
id|fb-&gt;info.cg14.video_mode
comma
op_amp
id|mdii-&gt;mdi_mode
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
l_int|72
comma
op_amp
id|mdii-&gt;mdi_pixfreq
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
multiline_comment|/* FIXME */
id|__put_user_ret
c_func
(paren
id|fb-&gt;info.cg14.ramsize
comma
op_amp
id|mdii-&gt;mdi_size
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MDI_SET_PIXELMODE
suffix:colon
(brace
r_int
id|newmode
suffix:semicolon
r_volatile
id|u8
op_star
id|control
suffix:semicolon
id|get_user_ret
c_func
(paren
id|newmode
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|control
op_assign
op_amp
(paren
id|fb-&gt;info.cg14.regs-&gt;mcr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|newmode
)paren
(brace
r_case
id|MDI_32_PIX
suffix:colon
op_star
id|control
op_assign
(paren
op_star
id|control
op_amp
op_complement
id|CG14_MCR_PIXMODE_MASK
)paren
op_or
(paren
id|CG14_MCR_PIXMODE_32
op_lshift
id|CG14_MCR_PIXMODE_SHIFT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_16_PIX
suffix:colon
op_star
id|control
op_assign
(paren
op_star
id|control
op_amp
op_complement
id|CG14_MCR_PIXMODE_MASK
)paren
op_or
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDI_8_PIX
suffix:colon
op_star
id|control
op_assign
(paren
op_star
id|control
op_amp
op_complement
id|CG14_MCR_PIXMODE_MASK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
id|fb-&gt;info.cg14.video_mode
op_assign
id|newmode
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* switch */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|cg14_switch_from_graph
id|cg14_switch_from_graph
(paren
r_void
)paren
(brace
id|fbinfo_t
op_star
id|fb
op_assign
op_amp
(paren
id|fbinfo
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_struct
id|cg14_info
op_star
id|cg14info
op_assign
(paren
r_struct
id|cg14_info
op_star
)paren
op_amp
id|fb-&gt;info.cg14
suffix:semicolon
multiline_comment|/* Set the 8-bpp mode */
r_if
c_cond
(paren
id|fb-&gt;open
op_logical_and
id|fb-&gt;mmaped
)paren
(brace
r_volatile
r_char
op_star
id|mcr
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|cg14info-&gt;regs-&gt;mcr
)paren
suffix:semicolon
id|fb-&gt;info.cg14.video_mode
op_assign
l_int|8
suffix:semicolon
op_star
id|mcr
op_assign
(paren
op_star
id|mcr
op_amp
op_complement
(paren
id|CG14_MCR_PIXMODE_MASK
)paren
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|cg14_reset
id|cg14_reset
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_volatile
r_char
op_star
id|mcr
op_assign
op_amp
(paren
id|fb-&gt;info.cg14.regs-&gt;mcr
)paren
suffix:semicolon
op_star
id|mcr
op_assign
(paren
op_star
id|mcr
op_amp
op_complement
(paren
id|CG14_MCR_PIXMODE_MASK
)paren
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|cg14_setup
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|slot
comma
r_int
id|con_node
comma
id|u32
id|cg14
comma
r_int
id|cg14_io
)paren
)paren
(brace
r_struct
id|cg14_info
op_star
id|cg14info
suffix:semicolon
id|uint
id|bases
(braket
l_int|2
)braket
suffix:semicolon
r_int
r_int
id|cg14regs
op_assign
l_int|0
suffix:semicolon
r_struct
id|cg14_regs
op_star
id|regs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cg14
)paren
(brace
id|prom_getproperty
(paren
id|con_node
comma
l_string|&quot;address&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|bases
(braket
l_int|0
)braket
comma
l_int|8
)paren
suffix:semicolon
id|cg14
op_assign
id|bases
(braket
l_int|1
)braket
suffix:semicolon
id|cg14regs
op_assign
id|bases
(braket
l_int|0
)braket
suffix:semicolon
id|fb-&gt;base
op_assign
id|cg14
suffix:semicolon
id|fb-&gt;info.cg14.regs
op_assign
(paren
r_struct
id|cg14_regs
op_star
)paren
id|cg14regs
suffix:semicolon
id|regs
op_assign
(paren
r_struct
id|cg14_regs
op_star
)paren
id|cg14regs
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cg14regs
)paren
(brace
id|printk
(paren
l_string|&quot;The PROM does not have mapped the frame buffer or the registers&bslash;n&quot;
l_string|&quot;Mr. Penguin can&squot;t use that&quot;
)paren
suffix:semicolon
id|prom_halt
(paren
)paren
suffix:semicolon
)brace
id|fb-&gt;type.fb_cmsize
op_assign
l_int|256
suffix:semicolon
id|fb-&gt;mmap
op_assign
id|cg14_mmap
suffix:semicolon
id|fb-&gt;loadcmap
op_assign
id|cg14_cmap
suffix:semicolon
id|fb-&gt;setcursor
op_assign
id|cg14_setcursor
suffix:semicolon
id|fb-&gt;setcursormap
op_assign
id|cg14_setcursormap
suffix:semicolon
id|fb-&gt;setcurshape
op_assign
id|cg14_setcurshape
suffix:semicolon
id|fb-&gt;ioctl
op_assign
id|cg14_ioctl
suffix:semicolon
id|fb-&gt;switch_from_graph
op_assign
id|cg14_switch_from_graph
suffix:semicolon
id|fb-&gt;postsetup
op_assign
id|cg_postsetup
suffix:semicolon
id|fb-&gt;reset
op_assign
id|cg14_reset
suffix:semicolon
id|fb-&gt;blank
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;unblank
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;info.cg14.video_mode
op_assign
l_int|8
suffix:semicolon
id|fb-&gt;emulations
(braket
l_int|1
)braket
op_assign
id|FBTYPE_SUN3COLOR
suffix:semicolon
id|fb-&gt;type.fb_depth
op_assign
l_int|24
suffix:semicolon
id|cg14info
op_assign
(paren
r_struct
id|cg14_info
op_star
)paren
op_amp
id|fb-&gt;info.cg14
suffix:semicolon
id|cg14info-&gt;clut
op_assign
(paren
r_void
op_star
)paren
(paren
id|cg14regs
op_plus
id|CG14_CLUT1
)paren
suffix:semicolon
id|cg14info-&gt;cursor_regs
op_assign
(paren
r_void
op_star
)paren
(paren
id|cg14regs
op_plus
id|CG14_CURSORREGS
)paren
suffix:semicolon
multiline_comment|/* If the bit is turned on, the card has 8 mb of ram, otherwise just 4 */
id|cg14info-&gt;ramsize
op_assign
(paren
id|regs-&gt;vca
op_amp
id|CG14_VCA_8MB_MASK
ques
c_cond
l_int|8
suffix:colon
l_int|4
)paren
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
id|printk
(paren
l_string|&quot;cgfourteen%d at 0x%8.8x with %d megs of RAM rev=%d, impl=%d&bslash;n&quot;
comma
id|slot
comma
id|cg14
comma
id|cg14info-&gt;ramsize
op_div
(paren
l_int|1024
op_star
l_int|1024
)paren
comma
id|regs-&gt;rev
op_rshift
l_int|4
comma
id|regs-&gt;rev
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
eof
