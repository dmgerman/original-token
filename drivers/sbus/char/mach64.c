multiline_comment|/* $Id: mach64.c,v 1.11 1997/10/17 04:13:35 davem Exp $&n; * mach64.c: Ultra/PCI Mach64 console driver.&n; *&n; * Just about all of this is from the PPC/mac driver, see that for&n; * author info.  I&squot;m only responsible for grafting it into working&n; * on PCI Ultra&squot;s.  The two drivers should be merged.&n; *&n; * Copyright (C) 1997 David S. Miller (davem@caip.rutgers.edu)&n; */
macro_line|#include &lt;linux/config.h&gt; /* for CONFIG_CHIP_ID */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/pbm.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;pcicons.h&quot;
macro_line|#include &quot;mach64.h&quot;
macro_line|#include &quot;fb.h&quot;
DECL|variable|mach64_pci_membase
r_static
r_int
r_int
id|mach64_pci_membase
suffix:semicolon
DECL|variable|mach64_pci_iobase
r_static
r_int
r_int
id|mach64_pci_iobase
suffix:semicolon
DECL|macro|MACH64_LE_FBOFF
mdefine_line|#define MACH64_LE_FBOFF&t;0x000000
DECL|macro|MACH64_REGOFF
mdefine_line|#define MACH64_REGOFF&t;0x7ffc00
DECL|macro|MACH64_BE_FBOFF
mdefine_line|#define MACH64_BE_FBOFF&t;0x800000
DECL|function|mach64_waitq
r_static
r_inline
r_void
id|mach64_waitq
c_func
(paren
r_int
id|entries
)paren
(brace
r_int
r_int
id|base
op_assign
(paren
l_int|0x8000
op_rshift
id|entries
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pcivga_readl
c_func
(paren
id|MACH64_REGOFF
op_plus
id|FIFO_STAT
)paren
op_amp
l_int|0xffff
)paren
OG
id|base
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|mach64_idle
r_static
r_inline
r_void
id|mach64_idle
c_func
(paren
r_void
)paren
(brace
id|mach64_waitq
c_func
(paren
l_int|16
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pcivga_readl
c_func
(paren
id|MACH64_REGOFF
op_plus
id|GUI_STAT
)paren
op_amp
l_int|1
)paren
(brace
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0&t;/* not used yet */
r_static
r_void
id|mach64_st_514
c_func
(paren
r_int
id|offset
comma
r_char
id|val
)paren
(brace
id|mach64_waitq
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
l_int|1
comma
id|MACH64_REGOFF
op_plus
id|DAC_CNTL
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
(paren
id|offset
op_amp
l_int|0xff
)paren
comma
id|MACH64_REGOFF
op_plus
id|DAC_W_INDEX
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
(paren
(paren
id|offset
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
comma
id|MACH64_REGOFF
op_plus
id|DAC_DATA
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
id|val
comma
id|MACH64_REGOFF
op_plus
id|DAC_MASK
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
l_int|0
comma
id|MACH64_REGOFF
op_plus
id|DAC_CNTL
)paren
suffix:semicolon
)brace
r_static
r_void
id|mach64_st_pll
c_func
(paren
r_int
id|offset
comma
r_char
id|val
)paren
(brace
id|mach64_waitq
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
(paren
(paren
id|offset
op_lshift
l_int|2
)paren
op_or
id|PLL_WR_EN
)paren
comma
id|MACH64_REGOFF
op_plus
id|CLOCK_CNTL
op_plus
l_int|1
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
id|val
comma
id|MACH64_REGOFF
op_plus
id|CLOCK_CNTL
op_plus
l_int|2
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
(paren
(paren
id|offset
op_lshift
l_int|2
)paren
op_amp
op_complement
id|PLL_WR_EN
)paren
comma
id|MACH64_REGOFF
op_plus
id|CLOCK_CNTL
op_plus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|mach64_mmap
id|mach64_mmap
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
id|base
comma
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_int
r_int
id|addr
comma
id|size
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_amp
op_complement
id|PAGE_MASK
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_eq
id|mach64_pci_iobase
)paren
(brace
id|addr
op_assign
id|__pa
c_func
(paren
id|pcivga_iobase
)paren
suffix:semicolon
id|size
op_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_ge
(paren
id|mach64_pci_membase
op_plus
l_int|0x800000
)paren
)paren
(brace
id|addr
op_assign
id|__pa
c_func
(paren
id|pcivga_membase
)paren
op_minus
id|mach64_pci_membase
op_plus
id|vma-&gt;vm_offset
suffix:semicolon
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
op_or_assign
id|_PAGE_IE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_ge
id|mach64_pci_membase
)paren
(brace
id|addr
op_assign
id|__pa
c_func
(paren
id|pcivga_membase
)paren
op_minus
id|mach64_pci_membase
op_plus
id|vma-&gt;vm_offset
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
op_and_assign
op_complement
(paren
id|_PAGE_CACHE
)paren
suffix:semicolon
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
op_or_assign
id|_PAGE_E
suffix:semicolon
id|vma-&gt;vm_flags
op_or_assign
(paren
id|VM_SHM
op_or
id|VM_LOCKED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma-&gt;vm_start
comma
id|addr
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|vma-&gt;vm_dentry
op_assign
id|dget
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|mach64_loadcmap
id|mach64_loadcmap
c_func
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|index
comma
r_int
id|count
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|mach64_waitq
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|tmp
op_assign
id|pcivga_readb
c_func
(paren
id|MACH64_REGOFF
op_plus
id|DAC_CNTL
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
id|tmp
op_amp
l_int|0xfc
comma
id|MACH64_REGOFF
op_plus
id|DAC_CNTL
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
l_int|0xff
comma
id|MACH64_REGOFF
op_plus
id|DAC_MASK
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|index
suffix:semicolon
id|count
op_decrement
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mach64_waitq
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
id|i
comma
id|MACH64_REGOFF
op_plus
id|DAC_W_INDEX
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|0
)paren
comma
id|MACH64_REGOFF
op_plus
id|DAC_DATA
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|1
)paren
comma
id|MACH64_REGOFF
op_plus
id|DAC_DATA
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|2
)paren
comma
id|MACH64_REGOFF
op_plus
id|DAC_DATA
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|mach64_blank
id|mach64_blank
c_func
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_int
r_char
id|gen_cntl
suffix:semicolon
id|gen_cntl
op_assign
id|pcivga_readb
c_func
(paren
id|MACH64_REGOFF
op_plus
id|CRTC_GEN_CNTL
)paren
suffix:semicolon
id|gen_cntl
op_or_assign
l_int|0x40
suffix:semicolon
id|pcivga_writeb
c_func
(paren
id|gen_cntl
comma
id|MACH64_REGOFF
op_plus
id|CRTC_GEN_CNTL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|mach64_unblank
id|mach64_unblank
c_func
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_int
r_char
id|gen_cntl
suffix:semicolon
id|gen_cntl
op_assign
id|pcivga_readb
c_func
(paren
id|MACH64_REGOFF
op_plus
id|CRTC_GEN_CNTL
)paren
suffix:semicolon
id|gen_cntl
op_and_assign
op_complement
(paren
l_int|0x4c
)paren
suffix:semicolon
id|pcivga_writeb
c_func
(paren
id|gen_cntl
comma
id|MACH64_REGOFF
op_plus
id|CRTC_GEN_CNTL
)paren
suffix:semicolon
)brace
DECL|variable|mach64
r_static
r_struct
id|mach64_info
id|mach64
suffix:semicolon
DECL|function|mach64_test
r_void
id|mach64_test
c_func
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_int
r_int
id|x
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mach64.total_vram
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
id|writel
c_func
(paren
id|i
comma
id|pcivga_membase
op_plus
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mach64.total_vram
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
r_if
c_cond
(paren
(paren
id|x
op_assign
id|readl
c_func
(paren
id|pcivga_membase
op_plus
id|i
)paren
)paren
op_ne
id|i
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;vga mem read error @ %08x: exp %x, rd %x&bslash;n&quot;
comma
id|i
comma
id|i
comma
id|x
)paren
suffix:semicolon
id|i
op_assign
(paren
id|i
op_amp
op_complement
(paren
l_int|0xffff
)paren
)paren
op_plus
l_int|0x10000
suffix:semicolon
)brace
)brace
DECL|function|mach64_init
r_int
id|mach64_init
c_func
(paren
id|fbinfo_t
op_star
id|fb
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_struct
id|pcidev_cookie
op_star
id|cookie
suffix:semicolon
r_struct
id|linux_pbm_info
op_star
id|pbm
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mach64
comma
l_int|0
comma
r_sizeof
(paren
id|mach64
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pdev
op_assign
id|pci_devices
suffix:semicolon
id|pdev
suffix:semicolon
id|pdev
op_assign
id|pdev-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|pdev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_ATI
)paren
op_logical_and
(paren
id|pdev-&gt;device
op_eq
id|PCI_DEVICE_ID_ATI_264VT
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|addr
op_assign
id|pdev-&gt;base_address
(braket
l_int|0
)braket
suffix:semicolon
id|pcivga_iobase
op_assign
id|pcivga_membase
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
op_amp
id|PCI_BASE_ADDRESS_SPACE
)paren
op_eq
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
id|pcivga_iobase
op_assign
id|addr
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
)brace
r_else
id|pcivga_membase
op_assign
id|addr
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|addr
op_assign
id|pdev-&gt;base_address
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
op_amp
id|PCI_BASE_ADDRESS_SPACE
)paren
op_eq
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
id|pcivga_iobase
op_assign
id|addr
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
)brace
r_else
id|pcivga_membase
op_assign
id|addr
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcivga_iobase
op_logical_or
op_logical_neg
id|pcivga_membase
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;mach64_init: I/O or MEM baseaddr is missing&bslash;n&quot;
)paren
suffix:semicolon
id|prom_printf
c_func
(paren
l_string|&quot;mach64_init: ba[0]=%016lx ba[1]=%016lx&bslash;n&quot;
comma
id|pdev-&gt;base_address
(braket
l_int|0
)braket
comma
id|pdev-&gt;base_address
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|pcibios_read_config_dword
c_func
(paren
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|mach64_pci_membase
)paren
suffix:semicolon
id|mach64_pci_membase
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
comma
id|PCI_BASE_ADDRESS_1
comma
op_amp
id|mach64_pci_iobase
)paren
suffix:semicolon
id|mach64_pci_iobase
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mach64_init: IOBASE[%016lx] MEMBASE[%016lx]&bslash;n&quot;
comma
id|pcivga_iobase
comma
id|pcivga_membase
)paren
suffix:semicolon
id|cookie
op_assign
id|pdev-&gt;sysdata
suffix:semicolon
id|pbm
op_assign
id|cookie-&gt;pbm
suffix:semicolon
id|fb-&gt;prom_node
op_assign
id|cookie-&gt;prom_node
suffix:semicolon
id|fb-&gt;proc_entry.node
op_assign
id|pbm-&gt;prom_node
suffix:semicolon
id|fb-&gt;type.fb_type
op_assign
id|FBTYPE_PCI_MACH64
suffix:semicolon
id|fb-&gt;type.fb_cmsize
op_assign
l_int|256
suffix:semicolon
id|fb-&gt;info
dot
r_private
op_assign
(paren
r_void
op_star
)paren
op_amp
id|mach64
suffix:semicolon
id|fb-&gt;base
op_assign
id|pcivga_membase
op_plus
id|MACH64_BE_FBOFF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pcivga_readl
c_func
(paren
id|MACH64_REGOFF
op_plus
id|CONFIG_CHIP_ID
)paren
op_amp
id|CFG_CHIP_TYPE
)paren
op_eq
id|MACH64_VT_ID
)paren
id|mach64.flags
op_or_assign
id|MACH64_MASK_VT
suffix:semicolon
multiline_comment|/*&n;&t; * Fix the PROM&squot;s idea of MEM_CNTL settings...&n;&t; */
id|tmp
op_assign
id|pcivga_readl
c_func
(paren
id|MACH64_REGOFF
op_plus
id|MEM_CNTL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|tmp
op_amp
l_int|0xf
)paren
(brace
r_case
l_int|3
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
op_complement
(paren
l_int|0xf
)paren
)paren
op_or
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
op_complement
(paren
l_int|0xf
)paren
)paren
op_or
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
op_complement
(paren
l_int|0xf
)paren
)paren
op_or
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
op_complement
(paren
l_int|0xf
)paren
)paren
op_or
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|tmp
op_and_assign
op_complement
(paren
l_int|0x00f00000
)paren
suffix:semicolon
id|pcivga_writel
c_func
(paren
id|tmp
comma
id|MACH64_REGOFF
op_plus
id|MEM_CNTL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|tmp
op_amp
id|MEM_SIZE_ALIAS
)paren
(brace
r_case
id|MEM_SIZE_512K
suffix:colon
id|mach64.total_vram
op_assign
l_int|0x80000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_1M
suffix:colon
id|mach64.total_vram
op_assign
l_int|0x100000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_2M
suffix:colon
id|mach64.total_vram
op_assign
l_int|0x200000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_4M
suffix:colon
id|mach64.total_vram
op_assign
l_int|0x400000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_6M
suffix:colon
id|mach64.total_vram
op_assign
l_int|0x600000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_SIZE_8M
suffix:colon
id|mach64.total_vram
op_assign
l_int|0x800000
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mach64.total_vram
op_assign
l_int|0x80000
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;mach64_init: total_vram[%08x] is_vt_chip[%d]&bslash;n&quot;
comma
id|mach64.total_vram
comma
id|mach64.flags
op_amp
id|MACH64_MASK_VT
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
macro_line|#if 0
id|mach64_test
c_func
(paren
id|fb
)paren
suffix:semicolon
macro_line|#endif
id|fb-&gt;mmap
op_assign
id|mach64_mmap
suffix:semicolon
id|fb-&gt;loadcmap
op_assign
id|mach64_loadcmap
suffix:semicolon
id|fb-&gt;ioctl
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;reset
op_assign
l_int|0
suffix:semicolon
id|fb-&gt;blank
op_assign
id|mach64_blank
suffix:semicolon
id|fb-&gt;unblank
op_assign
id|mach64_unblank
suffix:semicolon
id|fb-&gt;setcursor
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
