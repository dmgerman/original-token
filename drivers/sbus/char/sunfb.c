multiline_comment|/* $Id: sunfb.c,v 1.26 1997/07/17 02:21:48 davem Exp $&n; * sunfb.c: Sun generic frame buffer support.&n; *&n; * Copyright (C) 1995, 1996 Miguel de Icaza (miguel@nuclecu.unam.mx)&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; * &n; * Added getcmap ioctl, may, 96&n; * Support for multiple fbs, sep, 96&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/kbd_kern.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/consolemap.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
macro_line|#include &quot;fb.h&quot;
r_extern
r_void
id|set_other_palette
(paren
r_int
)paren
suffix:semicolon
r_extern
r_void
id|sun_clear_fb
c_func
(paren
r_int
)paren
suffix:semicolon
r_extern
r_void
id|set_cursor
(paren
r_int
)paren
suffix:semicolon
DECL|macro|FB_SETUP
mdefine_line|#define FB_SETUP(err) &bslash;&n;&t;int minor = FB_DEV (inode-&gt;i_rdev); &bslash;&n;&bslash;&n;&t;if (minor &gt;= fbinfos || &bslash;&n;&t;    fbinfo [minor].type.fb_type == FBTYPE_NOTYPE) &bslash;&n;&t;&t;return -(err);
r_static
r_int
DECL|function|fb_open
id|fb_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|FB_SETUP
c_func
(paren
id|EBADF
)paren
r_if
c_cond
(paren
id|fbinfo
(braket
id|minor
)braket
dot
id|open
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|fbinfo
(braket
id|minor
)braket
dot
id|mmaped
op_assign
l_int|0
suffix:semicolon
id|fbinfo
(braket
id|minor
)braket
dot
id|open
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|fb_ioctl
id|fb_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|uint
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|fbinfo_t
op_star
id|fb
suffix:semicolon
r_struct
id|fbcmap
op_star
id|cmap
suffix:semicolon
r_int
id|i
suffix:semicolon
id|FB_SETUP
c_func
(paren
id|EBADF
)paren
id|fb
op_assign
op_amp
id|fbinfo
(braket
id|minor
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|FBIOGTYPE
suffix:colon
multiline_comment|/* return frame buffer type */
id|copy_to_user_ret
c_func
(paren
(paren
r_struct
id|fbtype
op_star
)paren
id|arg
comma
op_amp
id|fb-&gt;type
comma
r_sizeof
(paren
r_struct
id|fbtype
)paren
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIOGATTR
suffix:colon
(brace
r_struct
id|fbgattr
op_star
id|fba
op_assign
(paren
r_struct
id|fbgattr
op_star
)paren
id|arg
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|fbgattr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|__put_user_ret
c_func
(paren
id|fb-&gt;real_type
comma
op_amp
id|fba-&gt;real_type
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
l_int|0
comma
op_amp
id|fba-&gt;owner
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__copy_to_user_ret
c_func
(paren
op_amp
id|fba-&gt;fbtype
comma
op_amp
id|fb-&gt;type
comma
r_sizeof
(paren
r_struct
id|fbtype
)paren
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
l_int|0
comma
op_amp
id|fba-&gt;sattr.flags
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
id|fb-&gt;type.fb_type
comma
op_amp
id|fba-&gt;sattr.emu_type
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
op_minus
l_int|1
comma
op_amp
id|fba-&gt;sattr.dev_specific
(braket
l_int|0
)braket
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
id|fb-&gt;type.fb_type
comma
op_amp
id|fba-&gt;emu_types
(braket
l_int|0
)braket
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|put_user_ret
c_func
(paren
id|fb-&gt;emulations
(braket
id|i
)braket
comma
op_amp
id|fba-&gt;emu_types
(braket
id|i
)braket
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|FBIOSATTR
suffix:colon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|fbsattr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|FBIOSVIDEO
suffix:colon
r_if
c_cond
(paren
id|fb
op_eq
id|fbinfo
op_logical_and
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_TEXT
)paren
r_break
suffix:semicolon
id|get_user_ret
c_func
(paren
id|i
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;blanked
op_logical_or
op_logical_neg
id|fb-&gt;unblank
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|minor
op_logical_or
(paren
id|fb-&gt;open
op_logical_and
id|fb-&gt;mmaped
)paren
)paren
(paren
op_star
id|fb-&gt;unblank
)paren
(paren
id|fb
)paren
suffix:semicolon
id|fb-&gt;blanked
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|fb-&gt;blanked
op_logical_or
op_logical_neg
id|fb-&gt;blank
)paren
r_break
suffix:semicolon
(paren
op_star
id|fb-&gt;blank
)paren
(paren
id|fb
)paren
suffix:semicolon
id|fb-&gt;blanked
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FBIOGVIDEO
suffix:colon
id|put_user_ret
c_func
(paren
id|fb-&gt;blanked
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FBIOGETCMAP
suffix:colon
(brace
r_char
op_star
id|rp
comma
op_star
id|gp
comma
op_star
id|bp
suffix:semicolon
r_int
id|end
comma
id|count
comma
id|index
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;loadcmap
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|fbcmap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|cmap
op_assign
(paren
r_struct
id|fbcmap
op_star
)paren
id|arg
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|count
comma
op_amp
id|cmap-&gt;count
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|index
comma
op_amp
id|cmap-&gt;index
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|index
OL
l_int|0
)paren
op_logical_or
(paren
id|index
OG
l_int|255
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|index
op_plus
id|count
OG
l_int|256
)paren
id|count
op_assign
l_int|256
op_minus
id|index
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|rp
comma
op_amp
id|cmap-&gt;red
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|gp
comma
op_amp
id|cmap-&gt;green
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|bp
comma
op_amp
id|cmap-&gt;blue
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|rp
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|gp
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|bp
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|end
op_assign
id|index
op_plus
id|count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|index
suffix:semicolon
id|i
OL
id|end
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__put_user_ret
c_func
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|0
)paren
comma
id|rp
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|1
)paren
comma
id|gp
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|2
)paren
comma
id|bp
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|rp
op_increment
suffix:semicolon
id|gp
op_increment
suffix:semicolon
id|bp
op_increment
suffix:semicolon
)brace
(paren
op_star
id|fb-&gt;loadcmap
)paren
(paren
id|fb
comma
id|index
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|FBIOPUTCMAP
suffix:colon
(brace
multiline_comment|/* load color map entries */
r_char
op_star
id|rp
comma
op_star
id|gp
comma
op_star
id|bp
suffix:semicolon
r_int
id|end
comma
id|count
comma
id|index
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;loadcmap
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|fbcmap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|cmap
op_assign
(paren
r_struct
id|fbcmap
op_star
)paren
id|arg
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|count
comma
op_amp
id|cmap-&gt;count
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|index
comma
op_amp
id|cmap-&gt;index
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|index
OL
l_int|0
)paren
op_logical_or
(paren
id|index
OG
l_int|255
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|index
op_plus
id|count
OG
l_int|256
)paren
id|count
op_assign
l_int|256
op_minus
id|index
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|rp
comma
op_amp
id|cmap-&gt;red
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|gp
comma
op_amp
id|cmap-&gt;green
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|bp
comma
op_amp
id|cmap-&gt;blue
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
(paren
id|VERIFY_READ
comma
id|rp
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verify_area
(paren
id|VERIFY_READ
comma
id|gp
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verify_area
(paren
id|VERIFY_READ
comma
id|bp
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|end
op_assign
id|index
op_plus
id|count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|index
suffix:semicolon
id|i
OL
id|end
suffix:semicolon
id|i
op_increment
)paren
(brace
id|__get_user_ret
c_func
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|0
)paren
comma
id|rp
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|1
)paren
comma
id|gp
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__get_user_ret
c_func
(paren
id|fb-&gt;color_map
id|CM
c_func
(paren
id|i
comma
l_int|2
)paren
comma
id|bp
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|rp
op_increment
suffix:semicolon
id|gp
op_increment
suffix:semicolon
id|bp
op_increment
suffix:semicolon
)brace
(paren
op_star
id|fb-&gt;loadcmap
)paren
(paren
id|fb
comma
id|index
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|FBIOGCURMAX
suffix:colon
(brace
r_struct
id|fbcurpos
op_star
id|p
op_assign
(paren
r_struct
id|fbcurpos
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;setcursor
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
(paren
id|VERIFY_WRITE
comma
id|p
comma
r_sizeof
(paren
r_struct
id|fbcurpos
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|__put_user_ret
c_func
(paren
id|fb-&gt;cursor.hwsize.fbx
comma
op_amp
id|p-&gt;fbx
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|__put_user_ret
c_func
(paren
id|fb-&gt;cursor.hwsize.fby
comma
op_amp
id|p-&gt;fby
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|FBIOSCURSOR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;setcursor
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|fb
op_eq
id|fbinfo
)paren
(brace
r_if
c_cond
(paren
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_TEXT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Don&squot;t let graphics programs hide our nice text cursor */
id|sun_hw_cursor_shown
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Forget state of our text cursor */
)brace
r_return
id|sun_hw_scursor
(paren
(paren
r_struct
id|fbcursor
op_star
)paren
id|arg
comma
id|fb
)paren
suffix:semicolon
r_case
id|FBIOSCURPOS
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;setcursor
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Don&squot;t let graphics programs move our nice text cursor */
r_if
c_cond
(paren
id|fb
op_eq
id|fbinfo
)paren
(brace
r_if
c_cond
(paren
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_TEXT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Don&squot;t let graphics programs move our nice text cursor */
)brace
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|fbcurpos
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|fb-&gt;cursor.cpos
op_assign
op_star
(paren
r_struct
id|fbcurpos
op_star
)paren
id|arg
suffix:semicolon
(paren
op_star
id|fb-&gt;setcursor
)paren
(paren
id|fb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|fb-&gt;ioctl
)paren
(brace
id|i
op_assign
id|fb-&gt;ioctl
(paren
id|inode
comma
id|file
comma
id|cmd
comma
id|arg
comma
id|fb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
id|ENOSYS
)paren
(brace
id|printk
(paren
l_string|&quot;[[FBIO: %8.8x]]&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;[[FBIO: %8.8x]]&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|fb_close
id|fb_close
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|fbinfo_t
op_star
id|fb
suffix:semicolon
r_struct
id|fbcursor
id|cursor
suffix:semicolon
id|FB_SETUP
c_func
(paren
id|EBADF
)paren
id|fb
op_assign
op_amp
id|fbinfo
(braket
id|minor
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|minor
)paren
id|vt_cons
(braket
id|fb-&gt;vtconsole
)braket
op_member_access_from_pointer
id|vc_mode
op_assign
id|KD_TEXT
suffix:semicolon
multiline_comment|/* Leaving graphics mode, turn off the cursor */
r_if
c_cond
(paren
id|fb-&gt;mmaped
)paren
id|sun_clear_fb
(paren
id|minor
)paren
suffix:semicolon
id|cursor.set
op_assign
id|FB_CUR_SETCUR
suffix:semicolon
id|cursor.enable
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset the driver */
r_if
c_cond
(paren
id|fb-&gt;reset
)paren
id|fb
op_member_access_from_pointer
id|reset
c_func
(paren
id|fb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb-&gt;open
)paren
id|fb-&gt;open
op_assign
l_int|0
suffix:semicolon
id|fb_ioctl
(paren
id|inode
comma
id|filp
comma
id|FBIOSCURPOS
comma
(paren
r_int
r_int
)paren
op_amp
id|cursor
)paren
suffix:semicolon
id|set_other_palette
(paren
id|minor
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|minor
)paren
(brace
id|render_screen
(paren
)paren
suffix:semicolon
id|set_cursor
(paren
id|fg_console
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fb-&gt;blank
)paren
(paren
op_star
id|fb-&gt;blank
)paren
(paren
id|fb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|fb_mmap
id|fb_mmap
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
id|fbinfo_t
op_star
id|fb
suffix:semicolon
id|FB_SETUP
c_func
(paren
id|ENXIO
)paren
id|fb
op_assign
op_amp
id|fbinfo
(braket
id|minor
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fb-&gt;mmap
)paren
(brace
r_int
id|v
suffix:semicolon
id|v
op_assign
(paren
op_star
id|fb-&gt;mmap
)paren
(paren
id|inode
comma
id|file
comma
id|vma
comma
id|fb-&gt;base
comma
id|fb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v
)paren
r_return
id|v
suffix:semicolon
id|vma-&gt;vm_flags
op_or_assign
id|VM_IO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;mmaped
)paren
(brace
id|fb-&gt;mmaped
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|minor
)paren
(brace
id|fb-&gt;vtconsole
op_assign
id|fg_console
suffix:semicolon
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_assign
id|KD_GRAPHICS
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|fb-&gt;unblank
op_logical_and
op_logical_neg
id|fb-&gt;blanked
)paren
(paren
op_star
id|fb-&gt;unblank
)paren
(paren
id|fb
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
DECL|variable|graphdev_fops
r_static
r_struct
id|file_operations
id|graphdev_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek */
l_int|NULL
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll */
id|fb_ioctl
comma
id|fb_mmap
comma
id|fb_open
comma
multiline_comment|/* open */
id|fb_close
comma
multiline_comment|/* close */
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|fb_init
(paren
r_void
)paren
)paren
(brace
multiline_comment|/* Register the frame buffer device */
r_if
c_cond
(paren
id|register_chrdev
(paren
id|GRAPHDEV_MAJOR
comma
l_string|&quot;graphics&quot;
comma
op_amp
id|graphdev_fops
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;Could not register graphics device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* success */
)brace
eof
