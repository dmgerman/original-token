multiline_comment|/*&n; * drivers/sbus/char/vfc_i2c.c&n; *&n; * Driver for the Videopix Frame Grabber.&n; * &n; * Functions that support the Phillips i2c(I squared C) bus on the vfc&n; *  Documentation for the Phillips I2C bus can be found on the &n; *  phillips home page&n; *&n; * Copyright (C) 1996 Manish Vachharajani (mvachhar@noc.rutgers.edu)&n; *&n; */
multiline_comment|/* NOTE: It seems to me that the documentation regarding the&n;pcd8584t/pcf8584 does not show the correct way to address the i2c bus.&n;Based on the information on the I2C bus itself and the remainder of&n;the Phillips docs the following algorithims apper to be correct.  I am&n;fairly certain that the flowcharts in the phillips docs are wrong. */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#if 0 
mdefine_line|#define VFC_I2C_DEBUG
macro_line|#endif
macro_line|#include &quot;vfc.h&quot;
macro_line|#include &quot;vfc_i2c.h&quot;
DECL|macro|WRITE_S1
mdefine_line|#define WRITE_S1(__val) &bslash;&n;&t;sbus_writel(__val, &amp;dev-&gt;regs-&gt;i2c_s1)
DECL|macro|WRITE_REG
mdefine_line|#define WRITE_REG(__val) &bslash;&n;&t;sbus_writel(__val, &amp;dev-&gt;regs-&gt;i2c_reg)
DECL|macro|VFC_I2C_READ
mdefine_line|#define VFC_I2C_READ (0x1)
DECL|macro|VFC_I2C_WRITE
mdefine_line|#define VFC_I2C_WRITE (0x0)
multiline_comment|/****** &n;  The i2c bus controller chip on the VFC is a pcd8584t, but&n;  phillips claims it doesn&squot;t exist.  As far as I can tell it is&n;  identical to the PCF8584 so I treat it like it is the pcf8584.&n;  &n;  NOTE: The pcf8584 only cares&n;  about the msb of the word you feed it &n;*****/
DECL|function|vfc_pcf8584_init
r_int
id|vfc_pcf8584_init
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
)paren
(brace
multiline_comment|/* This will also choose register S0_OWN so we can set it. */
id|WRITE_S1
c_func
(paren
id|RESET
)paren
suffix:semicolon
multiline_comment|/* The pcf8584 shifts this value left one bit and uses&n;&t; * it as its i2c bus address.&n;&t; */
id|WRITE_REG
c_func
(paren
l_int|0x55000000
)paren
suffix:semicolon
multiline_comment|/* This will set the i2c bus at the same speed sun uses,&n;&t; * and set another magic bit.&n;&t; */
id|WRITE_S1
c_func
(paren
id|SELECT
c_func
(paren
id|S2
)paren
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
l_int|0x14000000
)paren
suffix:semicolon
multiline_comment|/* Enable the serial port, idle the i2c bus and set&n;&t; * the data reg to s0.&n;&t; */
id|WRITE_S1
c_func
(paren
id|CLEAR_I2C_BUS
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfc_i2c_delay_wakeup
r_void
id|vfc_i2c_delay_wakeup
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
)paren
(brace
multiline_comment|/* Used to profile code and eliminate too many delays */
id|VFC_I2C_DEBUG_PRINTK
c_func
(paren
(paren
l_string|&quot;vfc%d: Delaying&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dev-&gt;poll_wait
)paren
suffix:semicolon
)brace
DECL|function|vfc_i2c_delay_no_busy
r_void
id|vfc_i2c_delay_no_busy
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
comma
r_int
r_int
id|usecs
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|dev-&gt;poll_timer
)paren
suffix:semicolon
id|dev-&gt;poll_timer.expires
op_assign
id|jiffies
op_plus
(paren
(paren
r_int
r_int
)paren
id|usecs
op_star
(paren
id|HZ
)paren
)paren
op_div
l_int|1000000
suffix:semicolon
id|dev-&gt;poll_timer.data
op_assign
(paren
r_int
r_int
)paren
id|dev
suffix:semicolon
id|dev-&gt;poll_timer.function
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|vfc_i2c_delay_wakeup
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|dev-&gt;poll_timer
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|dev-&gt;poll_wait
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|dev-&gt;poll_timer
)paren
suffix:semicolon
)brace
DECL|function|vfc_i2c_delay
r_void
r_inline
id|vfc_i2c_delay
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
)paren
(brace
id|vfc_i2c_delay_no_busy
c_func
(paren
id|dev
comma
l_int|100
)paren
suffix:semicolon
)brace
DECL|function|vfc_init_i2c_bus
r_int
id|vfc_init_i2c_bus
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
)paren
(brace
id|WRITE_S1
c_func
(paren
id|ENABLE_SERIAL
op_or
id|SELECT
c_func
(paren
id|S0
)paren
op_or
id|ACK
)paren
suffix:semicolon
id|vfc_i2c_reset_bus
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfc_i2c_reset_bus
r_int
id|vfc_i2c_reset_bus
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
)paren
(brace
id|VFC_I2C_DEBUG_PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;vfc%d: Resetting the i2c bus&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;regs
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|WRITE_S1
c_func
(paren
id|SEND_I2C_STOP
)paren
suffix:semicolon
id|WRITE_S1
c_func
(paren
id|SEND_I2C_STOP
op_or
id|ACK
)paren
suffix:semicolon
id|vfc_i2c_delay
c_func
(paren
id|dev
)paren
suffix:semicolon
id|WRITE_S1
c_func
(paren
id|CLEAR_I2C_BUS
)paren
suffix:semicolon
id|VFC_I2C_DEBUG_PRINTK
c_func
(paren
(paren
id|KERN_DEBUG
l_string|&quot;vfc%d: I2C status %x&bslash;n&quot;
comma
id|dev-&gt;instance
comma
id|sbus_readl
c_func
(paren
op_amp
id|dev-&gt;regs-&gt;i2c_s1
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfc_i2c_wait_for_bus
r_int
id|vfc_i2c_wait_for_bus
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
)paren
(brace
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|sbus_readl
c_func
(paren
op_amp
id|dev-&gt;regs-&gt;i2c_s1
)paren
op_amp
id|BB
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|timeout
op_decrement
)paren
)paren
(brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
id|vfc_i2c_delay
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfc_i2c_wait_for_pin
r_int
id|vfc_i2c_wait_for_pin
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
comma
r_int
id|ack
)paren
(brace
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_int
id|s1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|s1
op_assign
id|sbus_readl
c_func
(paren
op_amp
id|dev-&gt;regs-&gt;i2c_s1
)paren
)paren
op_amp
id|PIN
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|timeout
op_decrement
)paren
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|vfc_i2c_delay
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ack
op_eq
id|VFC_I2C_ACK_CHECK
)paren
(brace
r_if
c_cond
(paren
id|s1
op_amp
id|LRB
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|SHIFT
mdefine_line|#define SHIFT(a) ((a) &lt;&lt; 24)
DECL|function|vfc_i2c_xmit_addr
r_int
id|vfc_i2c_xmit_addr
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
comma
r_int
r_char
id|addr
comma
r_char
id|mode
)paren
(brace
r_int
id|ret
comma
id|raddr
suffix:semicolon
macro_line|#if 1
id|WRITE_S1
c_func
(paren
id|SEND_I2C_STOP
op_or
id|ACK
)paren
suffix:semicolon
id|WRITE_S1
c_func
(paren
id|SELECT
c_func
(paren
id|S0
)paren
op_or
id|ENABLE_SERIAL
)paren
suffix:semicolon
id|vfc_i2c_delay
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|VFC_I2C_READ
suffix:colon
id|raddr
op_assign
id|SHIFT
c_func
(paren
(paren
(paren
r_int
r_int
)paren
id|addr
op_or
l_int|0x1
)paren
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|raddr
)paren
suffix:semicolon
id|VFC_I2C_DEBUG_PRINTK
c_func
(paren
(paren
l_string|&quot;vfc%d: receiving from i2c addr 0x%x&bslash;n&quot;
comma
id|dev-&gt;instance
comma
id|addr
op_or
l_int|0x1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VFC_I2C_WRITE
suffix:colon
id|raddr
op_assign
id|SHIFT
c_func
(paren
(paren
r_int
r_int
)paren
id|addr
op_amp
op_complement
l_int|0x1
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|raddr
)paren
suffix:semicolon
id|VFC_I2C_DEBUG_PRINTK
c_func
(paren
(paren
l_string|&quot;vfc%d: sending to i2c addr 0x%x&bslash;n&quot;
comma
id|dev-&gt;instance
comma
id|addr
op_amp
op_complement
l_int|0x1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
id|WRITE_S1
c_func
(paren
id|SEND_I2C_START
)paren
suffix:semicolon
id|vfc_i2c_delay
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ret
op_assign
id|vfc_i2c_wait_for_pin
c_func
(paren
id|dev
comma
id|VFC_I2C_ACK_CHECK
)paren
suffix:semicolon
multiline_comment|/* We wait&n;&t;&t;&t;&t;&t;&t;&t;      for the&n;&t;&t;&t;&t;&t;&t;&t;      i2c send&n;&t;&t;&t;&t;&t;&t;&t;      to finish&n;&t;&t;&t;&t;&t;&t;&t;      here but&n;&t;&t;&t;&t;&t;&t;&t;      Sun&n;&t;&t;&t;&t;&t;&t;&t;      doesn&squot;t,&n;&t;&t;&t;&t;&t;&t;&t;      hmm */
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vfc%d: VFC xmit addr timed out or no ack&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mode
op_eq
id|VFC_I2C_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|sbus_readl
c_func
(paren
op_amp
id|dev-&gt;regs-&gt;i2c_reg
)paren
op_amp
l_int|0xff000000
)paren
op_ne
id|raddr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;vfc%d: returned slave address &quot;
l_string|&quot;mismatch(%x,%x)&bslash;n&quot;
comma
id|dev-&gt;instance
comma
id|raddr
comma
id|ret
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfc_i2c_xmit_byte
r_int
id|vfc_i2c_xmit_byte
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
comma
r_int
r_char
op_star
id|byte
)paren
(brace
r_int
id|ret
suffix:semicolon
id|u32
id|val
op_assign
id|SHIFT
c_func
(paren
(paren
r_int
r_int
)paren
op_star
id|byte
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|val
)paren
suffix:semicolon
id|ret
op_assign
id|vfc_i2c_wait_for_pin
c_func
(paren
id|dev
comma
id|VFC_I2C_ACK_CHECK
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
op_minus
id|ETIMEDOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vfc%d: VFC xmit byte timed out or no ack&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EIO
suffix:colon
id|ret
op_assign
id|XMIT_LAST_BYTE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vfc_i2c_recv_byte
r_int
id|vfc_i2c_recv_byte
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
comma
r_int
r_char
op_star
id|byte
comma
r_int
id|last
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|last
)paren
(brace
id|WRITE_REG
c_func
(paren
id|NEGATIVE_ACK
)paren
suffix:semicolon
id|VFC_I2C_DEBUG_PRINTK
c_func
(paren
(paren
l_string|&quot;vfc%d: sending negative ack&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|WRITE_S1
c_func
(paren
id|ACK
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|vfc_i2c_wait_for_pin
c_func
(paren
id|dev
comma
id|VFC_I2C_NO_ACK_CHECK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vfc%d: &quot;
l_string|&quot;VFC recv byte timed out&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
suffix:semicolon
)brace
op_star
id|byte
op_assign
(paren
id|sbus_readl
c_func
(paren
op_amp
id|dev-&gt;regs-&gt;i2c_reg
)paren
)paren
op_rshift
l_int|24
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vfc_i2c_recvbuf
r_int
id|vfc_i2c_recvbuf
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
comma
r_int
r_char
id|addr
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|ret
comma
id|last
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|count
op_logical_and
id|buf
op_logical_and
id|dev
op_logical_and
id|dev-&gt;regs
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|vfc_i2c_wait_for_bus
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vfc%d: VFC I2C bus busy&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|vfc_i2c_xmit_addr
c_func
(paren
id|dev
comma
id|addr
comma
id|VFC_I2C_READ
)paren
)paren
)paren
(brace
id|WRITE_S1
c_func
(paren
id|SEND_I2C_STOP
)paren
suffix:semicolon
id|vfc_i2c_delay
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|last
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
id|last
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|vfc_i2c_recv_byte
c_func
(paren
id|dev
comma
id|buf
comma
id|last
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vfc%d: &quot;
l_string|&quot;VFC error while receiving byte&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
suffix:semicolon
id|WRITE_S1
c_func
(paren
id|SEND_I2C_STOP
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf
op_increment
suffix:semicolon
)brace
id|WRITE_S1
c_func
(paren
id|SEND_I2C_STOP
op_or
id|ACK
)paren
suffix:semicolon
id|vfc_i2c_delay
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vfc_i2c_sendbuf
r_int
id|vfc_i2c_sendbuf
c_func
(paren
r_struct
id|vfc_dev
op_star
id|dev
comma
r_int
r_char
id|addr
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
op_logical_and
id|dev
op_logical_and
id|dev-&gt;regs
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|vfc_i2c_wait_for_bus
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vfc%d: VFC I2C bus busy&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|vfc_i2c_xmit_addr
c_func
(paren
id|dev
comma
id|addr
comma
id|VFC_I2C_WRITE
)paren
)paren
)paren
(brace
id|WRITE_S1
c_func
(paren
id|SEND_I2C_STOP
)paren
suffix:semicolon
id|vfc_i2c_delay
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|ret
op_assign
id|vfc_i2c_xmit_byte
c_func
(paren
id|dev
comma
id|buf
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|XMIT_LAST_BYTE
suffix:colon
id|VFC_I2C_DEBUG_PRINTK
c_func
(paren
(paren
l_string|&quot;vfc%d: &quot;
l_string|&quot;Reciever ended transmission with &quot;
l_string|&quot; %d bytes remaining&bslash;n&quot;
comma
id|dev-&gt;instance
comma
id|count
)paren
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|done
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vfc%d: &quot;
l_string|&quot;VFC error while sending byte&bslash;n&quot;
comma
id|dev-&gt;instance
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|buf
op_increment
suffix:semicolon
)brace
id|done
suffix:colon
id|WRITE_S1
c_func
(paren
id|SEND_I2C_STOP
op_or
id|ACK
)paren
suffix:semicolon
id|vfc_i2c_delay
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
