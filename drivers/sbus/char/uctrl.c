multiline_comment|/* $Id: uctrl.c,v 1.2 1999/09/07 23:11:08 shadow Exp $&n; * uctrl.c: TS102 Microcontroller interface on Tadpole Sparcbook 3&n; *&n; * Copyright 1999 Derrick J Brashear (shadow@dementia.org)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
DECL|macro|UCTRL_MINOR
mdefine_line|#define UCTRL_MINOR&t;174
DECL|struct|uctrl_driver
r_struct
id|uctrl_driver
(brace
DECL|member|regs
r_volatile
id|u32
op_star
id|regs
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|drv
r_static
r_struct
id|uctrl_driver
id|drv
suffix:semicolon
r_static
id|loff_t
DECL|function|uctrl_llseek
id|uctrl_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|type
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
r_static
r_int
DECL|function|uctrl_ioctl
id|uctrl_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|uctrl_open
id|uctrl_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|uctrl_release
id|uctrl_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uctrl_interrupt
r_void
id|uctrl_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uctrl_driver
op_star
id|driver
op_assign
(paren
r_struct
id|uctrl_driver
op_star
)paren
id|dev_id
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;in uctrl_interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|uctrl_fops
r_static
r_struct
id|file_operations
id|uctrl_fops
op_assign
(brace
id|uctrl_llseek
comma
l_int|NULL
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll */
id|uctrl_ioctl
comma
l_int|NULL
comma
multiline_comment|/* mmap */
id|uctrl_open
comma
l_int|NULL
comma
multiline_comment|/* flush */
id|uctrl_release
)brace
suffix:semicolon
DECL|variable|uctrl_dev
r_static
r_struct
id|miscdevice
id|uctrl_dev
op_assign
(brace
id|UCTRL_MINOR
comma
l_string|&quot;uctrl&quot;
comma
op_amp
id|uctrl_fops
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_int
id|uctrl_init
c_func
(paren
r_void
)paren
)paren
macro_line|#endif
(brace
r_struct
id|uctrl_driver
op_star
id|driver
op_assign
op_amp
id|drv
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|linux_prom_irqs
id|tmp_irq
(braket
l_int|2
)braket
suffix:semicolon
r_int
r_int
id|vaddr
(braket
l_int|2
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|tmpnode
comma
id|uctrlnode
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|tmpnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|uctrlnode
comma
l_string|&quot;obio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmpnode
)paren
id|uctrlnode
op_assign
id|prom_getchild
c_func
(paren
id|tmpnode
)paren
suffix:semicolon
id|uctrlnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|uctrlnode
comma
l_string|&quot;uctrl&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uctrlnode
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* the prom mapped it for us */
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|uctrlnode
comma
l_string|&quot;address&quot;
comma
(paren
r_void
op_star
)paren
id|vaddr
comma
r_sizeof
(paren
id|vaddr
)paren
)paren
suffix:semicolon
id|driver-&gt;regs
op_assign
id|vaddr
(braket
l_int|0
)braket
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|uctrlnode
comma
l_string|&quot;intr&quot;
comma
(paren
r_char
op_star
)paren
id|tmp_irq
comma
r_sizeof
(paren
id|tmp_irq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver-&gt;irq
)paren
(brace
id|driver-&gt;irq
op_assign
id|tmp_irq
(braket
l_int|0
)braket
dot
id|pri
suffix:semicolon
)brace
id|request_irq
c_func
(paren
id|driver-&gt;irq
comma
id|uctrl_interrupt
comma
l_int|0
comma
l_string|&quot;uctrl&quot;
comma
id|driver
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|driver-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|uctrl_dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to get misc minor %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|uctrl_dev.minor
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|driver-&gt;irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|driver-&gt;irq
comma
id|driver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;uctrl: 0x%x (irq %d)&bslash;n&quot;
comma
id|driver-&gt;regs
comma
id|__irq_itoa
c_func
(paren
id|driver-&gt;irq
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|uctrl_driver
op_star
id|driver
op_assign
op_amp
id|drv
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|uctrl_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;irq
)paren
(brace
id|disable_irq
c_func
(paren
id|driver-&gt;irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|driver-&gt;irq
comma
id|driver
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|driver-&gt;regs
)paren
id|driver-&gt;regs
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
eof
