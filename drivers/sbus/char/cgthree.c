multiline_comment|/* $Id: cgthree.c,v 1.10 1996/12/23 10:16:07 ecd Exp $&n; * cgtree.c: cg3 frame buffer driver&n; *&n; * Copyright (C) 1996 Miguel de Icaza (miguel@nuclecu.unam.mx)&n; *&n; * Support for cgRDI added, Nov/96, jj.&n; */
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/fbio.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;../../char/vt_kern.h&quot;
macro_line|#include &quot;../../char/selection.h&quot;
macro_line|#include &quot;../../char/console_struct.h&quot;
macro_line|#include &quot;fb.h&quot;
macro_line|#include &quot;cg_common.h&quot;
multiline_comment|/* The cg3 palette is loaded with 4 color values at each time  */
multiline_comment|/* so you end up with: (rgb)(r), (gb)(rg), (b)(rgb), and so on */
r_static
r_void
DECL|function|cg3_loadcmap
id|cg3_loadcmap
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|index
comma
r_int
id|count
)paren
(brace
r_struct
id|bt_regs
op_star
id|bt
op_assign
id|fb-&gt;info.cg3.bt
suffix:semicolon
r_int
op_star
id|i
comma
id|steps
suffix:semicolon
id|i
op_assign
(paren
(paren
(paren
r_int
op_star
)paren
id|fb-&gt;color_map
)paren
op_plus
id|D4M3
c_func
(paren
id|index
)paren
)paren
suffix:semicolon
id|steps
op_assign
id|D4M3
c_func
(paren
id|index
op_plus
id|count
op_minus
l_int|1
)paren
op_minus
id|D4M3
c_func
(paren
id|index
)paren
op_plus
l_int|3
suffix:semicolon
macro_line|#if 0&t;
r_if
c_cond
(paren
id|fb-&gt;info.cg3.cgrdi
)paren
(brace
op_star
(paren
r_volatile
id|u8
op_star
)paren
id|bt-&gt;addr
op_assign
(paren
id|u8
)paren
(paren
id|D4M4
c_func
(paren
id|index
)paren
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif&t;
id|bt-&gt;addr
op_assign
id|D4M4
c_func
(paren
id|index
)paren
suffix:semicolon
r_while
c_loop
(paren
id|steps
op_decrement
)paren
id|bt-&gt;color_map
op_assign
op_star
id|i
op_increment
suffix:semicolon
)brace
multiline_comment|/* The cg3 is presumed to emulate a cg4, I guess older programs will want that&n; * addresses above 0x4000000 are for cg3, below that it&squot;s cg4 emulation.&n; */
r_static
r_int
DECL|function|cg3_mmap
id|cg3_mmap
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
id|base
comma
id|fbinfo_t
op_star
id|fb
)paren
(brace
id|uint
id|size
comma
id|page
comma
id|r
comma
id|map_size
suffix:semicolon
id|uint
id|map_offset
op_assign
l_int|0
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_amp
op_complement
id|PAGE_MASK
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* To stop the swapper from even considering these pages */
id|vma-&gt;vm_flags
op_or_assign
id|FB_MMAP_VM_FLAGS
suffix:semicolon
multiline_comment|/* Each page, see which map applies */
r_for
c_loop
(paren
id|page
op_assign
l_int|0
suffix:semicolon
id|page
OL
id|size
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
id|vma-&gt;vm_offset
op_plus
id|page
)paren
(brace
r_case
id|CG3_MMAP_OFFSET
suffix:colon
id|map_size
op_assign
id|size
op_minus
id|page
suffix:semicolon
id|map_offset
op_assign
id|get_phys
(paren
(paren
id|uint
)paren
id|fb-&gt;base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map_size
OG
id|fb-&gt;type.fb_size
)paren
id|map_size
op_assign
id|fb-&gt;type.fb_size
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|map_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|map_size
)paren
(brace
id|page
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|page
op_plus
id|map_size
OG
id|size
)paren
id|map_size
op_assign
id|size
op_minus
id|page
suffix:semicolon
id|r
op_assign
id|io_remap_page_range
(paren
id|vma-&gt;vm_start
op_plus
id|page
comma
id|map_offset
comma
id|map_size
comma
id|vma-&gt;vm_page_prot
comma
id|fb-&gt;space
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|page
op_add_assign
id|map_size
suffix:semicolon
)brace
id|vma-&gt;vm_inode
op_assign
id|inode
suffix:semicolon
id|inode-&gt;i_count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|cg3_setup
(paren
id|fbinfo_t
op_star
id|fb
comma
r_int
id|slot
comma
id|uint
id|cg3
comma
r_int
id|cg3_io
comma
r_struct
id|linux_sbus_device
op_star
id|sbdp
)paren
)paren
(brace
r_struct
id|cg3_info
op_star
id|cg3info
op_assign
(paren
r_struct
id|cg3_info
op_star
)paren
op_amp
id|fb-&gt;info.cg3
suffix:semicolon
r_if
c_cond
(paren
id|strstr
(paren
id|sbdp-&gt;prom_name
comma
l_string|&quot;cgRDI&quot;
)paren
)paren
(brace
r_char
id|buffer
(braket
l_int|40
)braket
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|w
comma
id|h
suffix:semicolon
id|prom_getstring
(paren
id|sbdp-&gt;prom_node
comma
l_string|&quot;params&quot;
comma
id|buffer
comma
r_sizeof
(paren
id|buffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|buffer
)paren
(brace
id|w
op_assign
id|simple_strtoul
(paren
id|buffer
comma
op_amp
id|p
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w
op_logical_and
op_star
id|p
op_eq
l_char|&squot;x&squot;
)paren
(brace
id|h
op_assign
id|simple_strtoul
(paren
id|p
op_plus
l_int|1
comma
op_amp
id|p
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h
op_logical_and
op_star
id|p
op_eq
l_char|&squot;-&squot;
)paren
(brace
id|fb-&gt;type.fb_width
op_assign
id|w
suffix:semicolon
id|fb-&gt;type.fb_height
op_assign
id|h
suffix:semicolon
)brace
)brace
)brace
id|printk
(paren
l_string|&quot;cgRDI%d at 0x%8.8x&bslash;n&quot;
comma
id|slot
comma
id|cg3
)paren
suffix:semicolon
id|cg3info-&gt;cgrdi
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;cgthree%d at 0x%8.8x&bslash;n&quot;
comma
id|slot
comma
id|cg3
)paren
suffix:semicolon
id|cg3info-&gt;cgrdi
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fill in parameters we left out */
id|fb-&gt;type.fb_cmsize
op_assign
l_int|256
suffix:semicolon
id|fb-&gt;mmap
op_assign
id|cg3_mmap
suffix:semicolon
id|fb-&gt;loadcmap
op_assign
id|cg3_loadcmap
suffix:semicolon
id|fb-&gt;postsetup
op_assign
id|sun_cg_postsetup
suffix:semicolon
id|fb-&gt;ioctl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no special ioctls */
id|fb-&gt;reset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Map the card registers */
id|cg3info-&gt;bt
op_assign
id|sparc_alloc_io
(paren
(paren
r_void
op_star
)paren
id|cg3
op_plus
id|CG3_REGS
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|bt_regs
)paren
comma
l_string|&quot;cg3_bt&quot;
comma
id|cg3_io
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* cgRDI actually has 32 bytes of regs, but I don&squot;t understand&n;&t;   those bitfields yet (guess it is some interrupt stuff etc. */
r_if
c_cond
(paren
op_logical_neg
id|fb-&gt;base
)paren
(brace
id|fb-&gt;base
op_assign
(paren
id|uint
)paren
id|sparc_alloc_io
(paren
(paren
r_void
op_star
)paren
id|cg3
op_plus
id|CG3_RAM
comma
l_int|0
comma
id|fb-&gt;type.fb_size
comma
l_string|&quot;cg3_ram&quot;
comma
id|cg3_io
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
eof
