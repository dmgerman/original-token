multiline_comment|/* $Id: envctrl.c,v 1.19 2000/11/03 00:37:40 davem Exp $&n; * envctrl.c: Temperature and Fan monitoring on Machines providing it.&n; *&n; * Copyright (C) 1998  Eddie C. Dost  (ecd@skynet.be)&n; * Copyright (C) 2000  Vinh Truong    (vinh.truong@eng.sun.com)&n; * VT - The implementation is to support Sun Microelectronics (SME) platform&n; *      environment monitoring.  SME platforms use pcf8584 as the i2c bus &n; *      controller to access pcf8591 (8-bit A/D and D/A converter) and &n; *      pcf8571 (256 x 8-bit static low-voltage RAM with I2C-bus interface).&n; *      At board level, it follows SME Firmware I2C Specification. Reference:&n; * &t;http://www-eu2.semiconductors.com/pip/PCF8584P&n; * &t;http://www-eu2.semiconductors.com/pip/PCF8574AP&n; * &t;http://www-eu2.semiconductors.com/pip/PCF8591P&n; *&n; * EB - Added support for CP1500 Global Address and PS/Voltage monitoring.&n; * &t;&t;Eric Brower &lt;ebrower@usa.net&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/ebus.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/envctrl.h&gt;
DECL|macro|ENVCTRL_MINOR
mdefine_line|#define ENVCTRL_MINOR&t;162
DECL|macro|PCF8584_ADDRESS
mdefine_line|#define PCF8584_ADDRESS&t;0x55
DECL|macro|CONTROL_PIN
mdefine_line|#define CONTROL_PIN&t;0x80
DECL|macro|CONTROL_ES0
mdefine_line|#define CONTROL_ES0&t;0x40
DECL|macro|CONTROL_ES1
mdefine_line|#define CONTROL_ES1&t;0x20
DECL|macro|CONTROL_ES2
mdefine_line|#define CONTROL_ES2&t;0x10
DECL|macro|CONTROL_ENI
mdefine_line|#define CONTROL_ENI&t;0x08
DECL|macro|CONTROL_STA
mdefine_line|#define CONTROL_STA&t;0x04
DECL|macro|CONTROL_STO
mdefine_line|#define CONTROL_STO&t;0x02
DECL|macro|CONTROL_ACK
mdefine_line|#define CONTROL_ACK&t;0x01
DECL|macro|STATUS_PIN
mdefine_line|#define STATUS_PIN&t;0x80
DECL|macro|STATUS_STS
mdefine_line|#define STATUS_STS&t;0x20
DECL|macro|STATUS_BER
mdefine_line|#define STATUS_BER&t;0x10
DECL|macro|STATUS_LRB
mdefine_line|#define STATUS_LRB&t;0x08
DECL|macro|STATUS_AD0
mdefine_line|#define STATUS_AD0&t;0x08
DECL|macro|STATUS_AAB
mdefine_line|#define STATUS_AAB&t;0x04
DECL|macro|STATUS_LAB
mdefine_line|#define STATUS_LAB&t;0x02
DECL|macro|STATUS_BB
mdefine_line|#define STATUS_BB&t;0x01
multiline_comment|/*&n; * CLK Mode Register.&n; */
DECL|macro|BUS_CLK_90
mdefine_line|#define BUS_CLK_90&t;0x00
DECL|macro|BUS_CLK_45
mdefine_line|#define BUS_CLK_45&t;0x01
DECL|macro|BUS_CLK_11
mdefine_line|#define BUS_CLK_11&t;0x02
DECL|macro|BUS_CLK_1_5
mdefine_line|#define BUS_CLK_1_5&t;0x03
DECL|macro|CLK_3
mdefine_line|#define CLK_3&t;&t;0x00
DECL|macro|CLK_4_43
mdefine_line|#define CLK_4_43&t;0x10
DECL|macro|CLK_6
mdefine_line|#define CLK_6&t;&t;0x14
DECL|macro|CLK_8
mdefine_line|#define CLK_8&t;&t;0x18
DECL|macro|CLK_12
mdefine_line|#define CLK_12&t;&t;0x1c
DECL|macro|OBD_SEND_START
mdefine_line|#define OBD_SEND_START&t;0xc5    /* value to generate I2c_bus START condition */
DECL|macro|OBD_SEND_STOP
mdefine_line|#define OBD_SEND_STOP &t;0xc3    /* value to generate I2c_bus STOP condition */
multiline_comment|/* Monitor type of i2c child device.&n; * Firmware definitions.&n; */
DECL|macro|PCF8584_MAX_CHANNELS
mdefine_line|#define PCF8584_MAX_CHANNELS            8
DECL|macro|PCF8584_GLOBALADDR_TYPE
mdefine_line|#define PCF8584_GLOBALADDR_TYPE&t;&t;&t;6  /* global address monitor */
DECL|macro|PCF8584_FANSTAT_TYPE
mdefine_line|#define PCF8584_FANSTAT_TYPE            3  /* fan status monitor */
DECL|macro|PCF8584_VOLTAGE_TYPE
mdefine_line|#define PCF8584_VOLTAGE_TYPE            2  /* voltage monitor    */
DECL|macro|PCF8584_TEMP_TYPE
mdefine_line|#define PCF8584_TEMP_TYPE&t;        &t;1  /* temperature monitor*/
multiline_comment|/* Monitor type of i2c child device.&n; * Driver definitions.&n; */
DECL|macro|ENVCTRL_NOMON
mdefine_line|#define ENVCTRL_NOMON&t;&t;&t;&t;0
DECL|macro|ENVCTRL_CPUTEMP_MON
mdefine_line|#define ENVCTRL_CPUTEMP_MON&t;&t;&t;1    /* cpu temperature monitor */
DECL|macro|ENVCTRL_CPUVOLTAGE_MON
mdefine_line|#define ENVCTRL_CPUVOLTAGE_MON&t;  &t;2    /* voltage monitor         */
DECL|macro|ENVCTRL_FANSTAT_MON
mdefine_line|#define ENVCTRL_FANSTAT_MON  &t;&t;3    /* fan status monitor      */
DECL|macro|ENVCTRL_ETHERTEMP_MON
mdefine_line|#define ENVCTRL_ETHERTEMP_MON&t;&t;4    /* ethernet temperarture */
multiline_comment|/* monitor                     */
DECL|macro|ENVCTRL_VOLTAGESTAT_MON
mdefine_line|#define ENVCTRL_VOLTAGESTAT_MON&t;  &t;5    /* voltage status monitor  */
DECL|macro|ENVCTRL_MTHRBDTEMP_MON
mdefine_line|#define ENVCTRL_MTHRBDTEMP_MON&t;&t;6    /* motherboard temperature */
DECL|macro|ENVCTRL_SCSITEMP_MON
mdefine_line|#define ENVCTRL_SCSITEMP_MON&t;&t;7    /* scsi temperarture */
DECL|macro|ENVCTRL_GLOBALADDR_MON
mdefine_line|#define ENVCTRL_GLOBALADDR_MON&t;&t;8    /* global address */
multiline_comment|/* Child device type.&n; * Driver definitions.&n; */
DECL|macro|I2C_ADC
mdefine_line|#define I2C_ADC&t;&t;&t;&t;0    /* pcf8591 */
DECL|macro|I2C_GPIO
mdefine_line|#define I2C_GPIO&t;&t;&t;1    /* pcf8571 */
multiline_comment|/* Data read from child device may need to decode&n; * through a data table and a scale.&n; * Translation type as defined by firmware.&n; */
DECL|macro|ENVCTRL_TRANSLATE_NO
mdefine_line|#define ENVCTRL_TRANSLATE_NO&t;&t;0
DECL|macro|ENVCTRL_TRANSLATE_PARTIAL
mdefine_line|#define ENVCTRL_TRANSLATE_PARTIAL&t;1
DECL|macro|ENVCTRL_TRANSLATE_COMBINED
mdefine_line|#define ENVCTRL_TRANSLATE_COMBINED&t;2
DECL|macro|ENVCTRL_TRANSLATE_FULL
mdefine_line|#define ENVCTRL_TRANSLATE_FULL&t;&t;3     /* table[data] */
DECL|macro|ENVCTRL_TRANSLATE_SCALE
mdefine_line|#define ENVCTRL_TRANSLATE_SCALE&t;&t;4     /* table[data]/scale */
multiline_comment|/* Driver miscellaneous definitions. */
DECL|macro|ENVCTRL_MAX_CPU
mdefine_line|#define ENVCTRL_MAX_CPU&t;&t;&t;4
DECL|macro|CHANNEL_DESC_SZ
mdefine_line|#define CHANNEL_DESC_SZ&t;&t;&t;256
multiline_comment|/* Mask values for combined GlobalAddress/PowerStatus node */
DECL|macro|ENVCTRL_GLOBALADDR_ADDR_MASK
mdefine_line|#define ENVCTRL_GLOBALADDR_ADDR_MASK &t;0x1F
DECL|macro|ENVCTRL_GLOBALADDR_PSTAT_MASK
mdefine_line|#define ENVCTRL_GLOBALADDR_PSTAT_MASK&t;0x60
multiline_comment|/* Node 0x70 ignored on CompactPCI CP1400/1500 platforms &n; * (see envctrl_init_i2c_child)&n; */
DECL|macro|ENVCTRL_CPCI_IGNORED_NODE
mdefine_line|#define ENVCTRL_CPCI_IGNORED_NODE&t;&t;0x70
DECL|struct|pcf8584_reg
r_struct
id|pcf8584_reg
(brace
DECL|member|data
r_int
r_char
id|data
suffix:semicolon
DECL|member|csr
r_int
r_char
id|csr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Each child device can be monitored by up to PCF8584_MAX_CHANNELS.&n; * Property of a port or channel as defined by the firmware.&n; */
DECL|struct|pcf8584_channel
r_struct
id|pcf8584_channel
(brace
DECL|member|chnl_no
r_int
r_char
id|chnl_no
suffix:semicolon
DECL|member|io_direction
r_int
r_char
id|io_direction
suffix:semicolon
DECL|member|type
r_int
r_char
id|type
suffix:semicolon
DECL|member|last
r_int
r_char
id|last
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Each child device may have one or more tables of bytes to help decode&n; * data. Table property as defined by the firmware.&n; */
DECL|struct|pcf8584_tblprop
r_struct
id|pcf8584_tblprop
(brace
DECL|member|type
r_int
r_int
id|type
suffix:semicolon
DECL|member|scale
r_int
r_int
id|scale
suffix:semicolon
DECL|member|offset
r_int
r_int
id|offset
suffix:semicolon
multiline_comment|/* offset from the beginning of the table */
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* i2c child */
DECL|struct|i2c_child_t
r_struct
id|i2c_child_t
(brace
multiline_comment|/* Either ADC or GPIO. */
DECL|member|i2ctype
r_int
r_char
id|i2ctype
suffix:semicolon
DECL|member|addr
r_int
r_int
id|addr
suffix:semicolon
DECL|member|chnl_array
r_struct
id|pcf8584_channel
id|chnl_array
(braket
id|PCF8584_MAX_CHANNELS
)braket
suffix:semicolon
multiline_comment|/* Channel info. */
DECL|member|total_chnls
r_int
r_int
id|total_chnls
suffix:semicolon
multiline_comment|/* Number of monitor channels. */
DECL|member|fan_mask
r_int
r_char
id|fan_mask
suffix:semicolon
multiline_comment|/* Byte mask for fan status channels. */
DECL|member|voltage_mask
r_int
r_char
id|voltage_mask
suffix:semicolon
multiline_comment|/* Byte mask for voltage status channels. */
DECL|member|tblprop_array
r_struct
id|pcf8584_tblprop
id|tblprop_array
(braket
id|PCF8584_MAX_CHANNELS
)braket
suffix:semicolon
multiline_comment|/* Properties of all monitor channels. */
DECL|member|total_tbls
r_int
r_int
id|total_tbls
suffix:semicolon
multiline_comment|/* Number of monitor tables. */
DECL|member|tables
r_char
op_star
id|tables
suffix:semicolon
multiline_comment|/* Pointer to table(s). */
DECL|member|chnls_desc
r_char
id|chnls_desc
(braket
id|CHANNEL_DESC_SZ
)braket
suffix:semicolon
multiline_comment|/* Channel description. */
DECL|member|mon_type
r_char
id|mon_type
(braket
id|PCF8584_MAX_CHANNELS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|i2c
r_volatile
r_static
r_struct
id|pcf8584_reg
op_star
id|i2c
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|i2c_childlist
r_static
r_struct
id|i2c_child_t
id|i2c_childlist
(braket
id|ENVCTRL_MAX_CPU
op_star
l_int|2
)braket
suffix:semicolon
DECL|variable|chnls_mask
r_static
r_int
r_char
id|chnls_mask
(braket
)braket
op_assign
(brace
l_int|0x01
comma
l_int|0x02
comma
l_int|0x04
comma
l_int|0x08
comma
l_int|0x10
comma
l_int|0x20
comma
l_int|0x40
comma
l_int|0x80
)brace
suffix:semicolon
DECL|variable|warning_temperature
r_static
r_int
r_int
id|warning_temperature
op_assign
l_int|0
suffix:semicolon
DECL|variable|shutdown_temperature
r_static
r_int
r_int
id|shutdown_temperature
op_assign
l_int|0
suffix:semicolon
DECL|variable|read_cpu
r_static
r_char
id|read_cpu
suffix:semicolon
multiline_comment|/* Forward declarations. */
r_static
r_struct
id|i2c_child_t
op_star
id|envctrl_get_i2c_child
c_func
(paren
r_int
r_char
)paren
suffix:semicolon
multiline_comment|/* Function description: Read a byte from an i2c controller register.&n; * Return: A byte from the passed in address.&n; */
DECL|function|envctrl_readb
r_static
r_inline
r_int
r_char
id|envctrl_readb
c_func
(paren
r_volatile
r_int
r_char
op_star
id|p
)paren
(brace
r_return
id|readb
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* Function description: Write a byte to an i2c controller register.&n; * Return: Nothing.&n; */
DECL|function|envctrl_writeb
r_static
r_inline
r_void
id|envctrl_writeb
c_func
(paren
r_int
r_char
id|val
comma
r_volatile
r_int
r_char
op_star
id|p
)paren
(brace
id|writeb
c_func
(paren
id|val
comma
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Test the PIN bit (Pending Interrupt Not) &n; * &t;&t;&t; to test when serial transmission is completed .&n; * Return : None.&n; */
DECL|function|envtrl_i2c_test_pin
r_static
r_void
id|envtrl_i2c_test_pin
c_func
(paren
r_void
)paren
(brace
r_int
id|limit
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|limit
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|envctrl_readb
c_func
(paren
op_amp
id|i2c-&gt;csr
)paren
op_amp
id|STATUS_PIN
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|limit
op_le
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;envctrl: Pin status will not clear.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Test busy bit.&n; * Return : None.&n; */
DECL|function|envctrl_i2c_test_bb
r_static
r_void
id|envctrl_i2c_test_bb
c_func
(paren
r_void
)paren
(brace
r_int
id|limit
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|limit
OG
l_int|0
)paren
(brace
multiline_comment|/* Busy bit 0 means busy. */
r_if
c_cond
(paren
id|envctrl_readb
c_func
(paren
op_amp
id|i2c-&gt;csr
)paren
op_amp
id|STATUS_BB
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|limit
op_le
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;envctrl: Busy bit will not clear.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Send the adress for a read access.&n; * Return : 0 if not acknowledged, otherwise acknowledged.&n; */
DECL|function|envctrl_i2c_read_addr
r_static
r_int
id|envctrl_i2c_read_addr
c_func
(paren
r_int
r_char
id|addr
)paren
(brace
id|envctrl_i2c_test_bb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Load address. */
id|envctrl_writeb
c_func
(paren
id|addr
op_plus
l_int|1
comma
op_amp
id|i2c-&gt;data
)paren
suffix:semicolon
id|envctrl_i2c_test_bb
c_func
(paren
)paren
suffix:semicolon
id|envctrl_writeb
c_func
(paren
id|OBD_SEND_START
comma
op_amp
id|i2c-&gt;csr
)paren
suffix:semicolon
multiline_comment|/* Wait for PIN. */
id|envtrl_i2c_test_pin
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* CSR 0 means acknowledged. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|envctrl_readb
c_func
(paren
op_amp
id|i2c-&gt;csr
)paren
op_amp
id|STATUS_LRB
)paren
)paren
(brace
r_return
id|envctrl_readb
c_func
(paren
op_amp
id|i2c-&gt;data
)paren
suffix:semicolon
)brace
r_else
(brace
id|envctrl_writeb
c_func
(paren
id|OBD_SEND_STOP
comma
op_amp
id|i2c-&gt;csr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Function Description: Send the adress for write mode.  &n; * Return : None.&n; */
DECL|function|envctrl_i2c_write_addr
r_static
r_void
id|envctrl_i2c_write_addr
c_func
(paren
r_int
r_char
id|addr
)paren
(brace
id|envctrl_i2c_test_bb
c_func
(paren
)paren
suffix:semicolon
id|envctrl_writeb
c_func
(paren
id|addr
comma
op_amp
id|i2c-&gt;data
)paren
suffix:semicolon
multiline_comment|/* Generate Start condition. */
id|envctrl_writeb
c_func
(paren
id|OBD_SEND_START
comma
op_amp
id|i2c-&gt;csr
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Read 1 byte of data from addr &n; *&t;&t;&t; set by envctrl_i2c_read_addr() &n; * Return : Data from address set by envctrl_i2c_read_addr().&n; */
DECL|function|envctrl_i2c_read_data
r_static
r_int
r_char
id|envctrl_i2c_read_data
c_func
(paren
r_void
)paren
(brace
id|envtrl_i2c_test_pin
c_func
(paren
)paren
suffix:semicolon
id|envctrl_writeb
c_func
(paren
id|CONTROL_ES0
comma
op_amp
id|i2c-&gt;csr
)paren
suffix:semicolon
multiline_comment|/* Send neg ack. */
r_return
id|envctrl_readb
c_func
(paren
op_amp
id|i2c-&gt;data
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Instruct the device which port to read data from.  &n; * Return : None.&n; */
DECL|function|envctrl_i2c_write_data
r_static
r_void
id|envctrl_i2c_write_data
c_func
(paren
r_int
r_char
id|port
)paren
(brace
id|envtrl_i2c_test_pin
c_func
(paren
)paren
suffix:semicolon
id|envctrl_writeb
c_func
(paren
id|port
comma
op_amp
id|i2c-&gt;data
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Generate Stop condition after last byte is sent.&n; * Return : None.&n; */
DECL|function|envctrl_i2c_stop
r_static
r_void
id|envctrl_i2c_stop
c_func
(paren
r_void
)paren
(brace
id|envtrl_i2c_test_pin
c_func
(paren
)paren
suffix:semicolon
id|envctrl_writeb
c_func
(paren
id|OBD_SEND_STOP
comma
op_amp
id|i2c-&gt;csr
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Read adc device.&n; * Return : Data at address and port.&n; */
DECL|function|envctrl_i2c_read_8591
r_static
r_int
r_char
id|envctrl_i2c_read_8591
c_func
(paren
r_int
r_char
id|addr
comma
r_int
r_char
id|port
)paren
(brace
multiline_comment|/* Send address. */
id|envctrl_i2c_write_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
multiline_comment|/* Setup port to read. */
id|envctrl_i2c_write_data
c_func
(paren
id|port
)paren
suffix:semicolon
id|envctrl_i2c_stop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Read port. */
id|envctrl_i2c_read_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
multiline_comment|/* Do a single byte read and send stop. */
id|envctrl_i2c_read_data
c_func
(paren
)paren
suffix:semicolon
id|envctrl_i2c_stop
c_func
(paren
)paren
suffix:semicolon
r_return
id|envctrl_readb
c_func
(paren
op_amp
id|i2c-&gt;data
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Read gpio device.&n; * Return : Data at address.&n; */
DECL|function|envctrl_i2c_read_8574
r_static
r_int
r_char
id|envctrl_i2c_read_8574
c_func
(paren
r_int
r_char
id|addr
)paren
(brace
r_int
r_char
id|rd
suffix:semicolon
id|envctrl_i2c_read_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
multiline_comment|/* Do a single byte read and send stop. */
id|rd
op_assign
id|envctrl_i2c_read_data
c_func
(paren
)paren
suffix:semicolon
id|envctrl_i2c_stop
c_func
(paren
)paren
suffix:semicolon
r_return
id|rd
suffix:semicolon
)brace
multiline_comment|/* Function Description: Decode data read from an adc device using firmware&n; *                       table.&n; * Return: Number of read bytes. Data is stored in bufdata in ascii format.&n; */
DECL|function|envctrl_i2c_data_translate
r_static
r_int
id|envctrl_i2c_data_translate
c_func
(paren
r_int
r_char
id|data
comma
r_int
id|translate_type
comma
r_int
id|scale
comma
r_char
op_star
id|tbl
comma
r_char
op_star
id|bufdata
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|translate_type
)paren
(brace
r_case
id|ENVCTRL_TRANSLATE_NO
suffix:colon
multiline_comment|/* No decode necessary. */
id|len
op_assign
l_int|1
suffix:semicolon
id|bufdata
(braket
l_int|0
)braket
op_assign
id|data
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_TRANSLATE_FULL
suffix:colon
multiline_comment|/* Decode this way: data = table[data]. */
id|len
op_assign
l_int|1
suffix:semicolon
id|bufdata
(braket
l_int|0
)braket
op_assign
id|tbl
(braket
id|data
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_TRANSLATE_SCALE
suffix:colon
multiline_comment|/* Decode this way: data = table[data]/scale */
id|sprintf
c_func
(paren
id|bufdata
comma
l_string|&quot;%d &quot;
comma
(paren
id|tbl
(braket
id|data
)braket
op_star
l_int|10
)paren
op_div
(paren
id|scale
)paren
)paren
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|bufdata
)paren
suffix:semicolon
id|bufdata
(braket
id|len
op_minus
l_int|1
)braket
op_assign
id|bufdata
(braket
id|len
op_minus
l_int|2
)braket
suffix:semicolon
id|bufdata
(braket
id|len
op_minus
l_int|2
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Function Description: Read cpu-related data such as cpu temperature, voltage.&n; * Return: Number of read bytes. Data is stored in bufdata in ascii format.&n; */
DECL|function|envctrl_read_cpu_info
r_static
r_int
id|envctrl_read_cpu_info
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
comma
r_char
id|mon_type
comma
r_int
r_char
op_star
id|bufdata
)paren
(brace
r_int
r_char
id|data
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|tbl
comma
id|j
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Find the right monitor type and channel. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCF8584_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pchild-&gt;mon_type
(braket
id|i
)braket
op_eq
id|mon_type
)paren
(brace
r_if
c_cond
(paren
op_increment
id|j
op_eq
id|read_cpu
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|j
op_ne
id|read_cpu
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Read data from address and port. */
id|data
op_assign
id|envctrl_i2c_read_8591
c_func
(paren
(paren
r_int
r_char
)paren
id|pchild-&gt;addr
comma
(paren
r_int
r_char
)paren
id|pchild-&gt;chnl_array
(braket
id|i
)braket
dot
id|chnl_no
)paren
suffix:semicolon
multiline_comment|/* Find decoding table. */
id|tbl
op_assign
id|pchild-&gt;tables
op_plus
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
r_return
id|envctrl_i2c_data_translate
c_func
(paren
id|data
comma
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|type
comma
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|scale
comma
id|tbl
comma
id|bufdata
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Read noncpu-related data such as motherboard &n; *                       temperature.&n; * Return: Number of read bytes. Data is stored in bufdata in ascii format.&n; */
DECL|function|envctrl_read_noncpu_info
r_static
r_int
id|envctrl_read_noncpu_info
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
comma
r_char
id|mon_type
comma
r_int
r_char
op_star
id|bufdata
)paren
(brace
r_int
r_char
id|data
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|tbl
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCF8584_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pchild-&gt;mon_type
(braket
id|i
)braket
op_eq
id|mon_type
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|PCF8584_MAX_CHANNELS
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Read data from address and port. */
id|data
op_assign
id|envctrl_i2c_read_8591
c_func
(paren
(paren
r_int
r_char
)paren
id|pchild-&gt;addr
comma
(paren
r_int
r_char
)paren
id|pchild-&gt;chnl_array
(braket
id|i
)braket
dot
id|chnl_no
)paren
suffix:semicolon
multiline_comment|/* Find decoding table. */
id|tbl
op_assign
id|pchild-&gt;tables
op_plus
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
r_return
id|envctrl_i2c_data_translate
c_func
(paren
id|data
comma
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|type
comma
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|scale
comma
id|tbl
comma
id|bufdata
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Read fan status.&n; * Return : Always 1 byte. Status stored in bufdata.&n; */
DECL|function|envctrl_i2c_fan_status
r_static
r_int
id|envctrl_i2c_fan_status
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
comma
r_int
r_char
id|data
comma
r_char
op_star
id|bufdata
)paren
(brace
r_int
r_char
id|tmp
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|tmp
op_assign
id|data
op_amp
id|pchild-&gt;fan_mask
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
id|pchild-&gt;fan_mask
)paren
(brace
multiline_comment|/* All bits are on. All fans are functioning. */
id|ret
op_assign
id|ENVCTRL_ALL_FANS_GOOD
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0
)paren
(brace
multiline_comment|/* No bits are on. No fans are functioning. */
id|ret
op_assign
id|ENVCTRL_ALL_FANS_BAD
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Go through all channels, mark &squot;on&squot; the matched bits.&n;&t;&t; * Notice that fan_mask may have discontiguous bits but&n;&t;&t; * return mask are always contiguous. For example if we&n;&t;&t; * monitor 4 fans at channels 0,1,2,4, the return mask&n;&t;&t; * should be 00010000 if only fan at channel 4 is working.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCF8584_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pchild-&gt;fan_mask
op_amp
id|chnls_mask
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|chnls_mask
(braket
id|i
)braket
op_amp
id|tmp
)paren
)paren
id|ret
op_or_assign
id|chnls_mask
(braket
id|j
)braket
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
)brace
)brace
id|bufdata
(braket
l_int|0
)braket
op_assign
id|ret
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Function Description: Read global addressing line.&n; * Return : Always 1 byte. Status stored in bufdata.&n; */
DECL|function|envctrl_i2c_globaladdr
r_static
r_int
id|envctrl_i2c_globaladdr
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
comma
r_int
r_char
id|data
comma
r_char
op_star
id|bufdata
)paren
(brace
multiline_comment|/* Translatation table is not necessary, as global&n;&t; * addr is the integer value of the GA# bits.&n;&t; *&n;&t; * NOTE: MSB is documented as zero, but I see it as &squot;1&squot; always....&n;&t; *&n;&t; * -----------------------------------------------&n;&t; * | 0 | FAL | DEG | GA4 | GA3 | GA2 | GA1 | GA0 |&n;&t; * -----------------------------------------------&n;&t; * GA0 - GA4&t;integer value of Global Address (backplane slot#)&n;&t; * DEG&t;&t;&t;0 = cPCI Power supply output is starting to degrade&n;&t; * &t;&t;&t;&t;1 = cPCI Power supply output is OK&n;&t; * FAL&t;&t;&t;0 = cPCI Power supply has failed&n;&t; * &t;&t;&t;&t;1 = cPCI Power supply output is OK&n;&t; */
id|bufdata
(braket
l_int|0
)braket
op_assign
(paren
id|data
op_amp
id|ENVCTRL_GLOBALADDR_ADDR_MASK
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Function Description: Read standard voltage and power supply status.&n; * Return : Always 1 byte. Status stored in bufdata.&n; */
DECL|function|envctrl_i2c_voltage_status
r_static
r_int
r_char
id|envctrl_i2c_voltage_status
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
comma
r_int
r_char
id|data
comma
r_char
op_star
id|bufdata
)paren
(brace
r_int
r_char
id|tmp
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|tmp
op_assign
id|data
op_amp
id|pchild-&gt;voltage_mask
suffix:semicolon
multiline_comment|/* Two channels are used to monitor voltage and power supply. */
r_if
c_cond
(paren
id|tmp
op_eq
id|pchild-&gt;voltage_mask
)paren
(brace
multiline_comment|/* All bits are on. Voltage and power supply are okay. */
id|ret
op_assign
id|ENVCTRL_VOLTAGE_POWERSUPPLY_GOOD
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0
)paren
(brace
multiline_comment|/* All bits are off. Voltage and power supply are bad */
id|ret
op_assign
id|ENVCTRL_VOLTAGE_POWERSUPPLY_BAD
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Either voltage or power supply has problem. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCF8584_MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pchild-&gt;voltage_mask
op_amp
id|chnls_mask
(braket
id|i
)braket
)paren
(brace
id|j
op_increment
suffix:semicolon
multiline_comment|/* Break out when there is a mismatch. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|chnls_mask
(braket
id|i
)braket
op_amp
id|tmp
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Make a wish that hardware will always use the&n;&t;&t; * first channel for voltage and the second for&n;&t;&t; * power supply.&n;&t;&t; */
r_if
c_cond
(paren
id|j
op_eq
l_int|1
)paren
id|ret
op_assign
id|ENVCTRL_VOLTAGE_BAD
suffix:semicolon
r_else
id|ret
op_assign
id|ENVCTRL_POWERSUPPLY_BAD
suffix:semicolon
)brace
id|bufdata
(braket
l_int|0
)braket
op_assign
id|ret
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Function Description: Read a byte from /dev/envctrl. Mapped to user read().&n; * Return: Number of read bytes. 0 for error.&n; */
r_static
id|ssize_t
DECL|function|envctrl_read
id|envctrl_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|i2c_child_t
op_star
id|pchild
suffix:semicolon
r_int
r_char
id|data
(braket
l_int|10
)braket
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Get the type of read as decided in ioctl() call.&n;&t; * Find the appropriate i2c child.&n;&t; * Get the data and put back to the user buffer.&n;&t; */
r_switch
c_cond
(paren
(paren
r_int
)paren
(paren
r_int
)paren
id|file-&gt;private_data
)paren
(brace
r_case
id|ENVCTRL_RD_WARNING_TEMPERATURE
suffix:colon
r_if
c_cond
(paren
id|warning_temperature
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|warning_temperature
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_SHUTDOWN_TEMPERATURE
suffix:colon
r_if
c_cond
(paren
id|shutdown_temperature
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|shutdown_temperature
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_MTHRBD_TEMPERATURE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pchild
op_assign
id|envctrl_get_i2c_child
c_func
(paren
id|ENVCTRL_MTHRBDTEMP_MON
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
id|envctrl_read_noncpu_info
c_func
(paren
id|pchild
comma
id|ENVCTRL_MTHRBDTEMP_MON
comma
id|data
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_CPU_TEMPERATURE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pchild
op_assign
id|envctrl_get_i2c_child
c_func
(paren
id|ENVCTRL_CPUTEMP_MON
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
id|envctrl_read_cpu_info
c_func
(paren
id|pchild
comma
id|ENVCTRL_CPUTEMP_MON
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Reset cpu to the default cpu0. */
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_CPU_VOLTAGE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pchild
op_assign
id|envctrl_get_i2c_child
c_func
(paren
id|ENVCTRL_CPUVOLTAGE_MON
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
id|envctrl_read_cpu_info
c_func
(paren
id|pchild
comma
id|ENVCTRL_CPUVOLTAGE_MON
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Reset cpu to the default cpu0. */
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_SCSI_TEMPERATURE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pchild
op_assign
id|envctrl_get_i2c_child
c_func
(paren
id|ENVCTRL_SCSITEMP_MON
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
id|envctrl_read_noncpu_info
c_func
(paren
id|pchild
comma
id|ENVCTRL_SCSITEMP_MON
comma
id|data
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_ETHERNET_TEMPERATURE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pchild
op_assign
id|envctrl_get_i2c_child
c_func
(paren
id|ENVCTRL_ETHERTEMP_MON
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
id|envctrl_read_noncpu_info
c_func
(paren
id|pchild
comma
id|ENVCTRL_ETHERTEMP_MON
comma
id|data
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_FAN_STATUS
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pchild
op_assign
id|envctrl_get_i2c_child
c_func
(paren
id|ENVCTRL_FANSTAT_MON
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|envctrl_i2c_read_8574
c_func
(paren
id|pchild-&gt;addr
)paren
suffix:semicolon
id|ret
op_assign
id|envctrl_i2c_fan_status
c_func
(paren
id|pchild
comma
id|data
(braket
l_int|0
)braket
comma
id|data
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_GLOBALADDRESS
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pchild
op_assign
id|envctrl_get_i2c_child
c_func
(paren
id|ENVCTRL_GLOBALADDR_MON
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|envctrl_i2c_read_8574
c_func
(paren
id|pchild-&gt;addr
)paren
suffix:semicolon
id|ret
op_assign
id|envctrl_i2c_globaladdr
c_func
(paren
id|pchild
comma
id|data
(braket
l_int|0
)braket
comma
id|data
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_VOLTAGE_STATUS
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pchild
op_assign
id|envctrl_get_i2c_child
c_func
(paren
id|ENVCTRL_VOLTAGESTAT_MON
)paren
)paren
)paren
multiline_comment|/* If voltage monitor not present, check for CPCI equivalent */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pchild
op_assign
id|envctrl_get_i2c_child
c_func
(paren
id|ENVCTRL_GLOBALADDR_MON
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|envctrl_i2c_read_8574
c_func
(paren
id|pchild-&gt;addr
)paren
suffix:semicolon
id|ret
op_assign
id|envctrl_i2c_voltage_status
c_func
(paren
id|pchild
comma
id|data
(braket
l_int|0
)braket
comma
id|data
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|buf
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Function Description: Command what to read.  Mapped to user ioctl().&n; * Return: Gives 0 for implemented commands, -EINVAL otherwise.&n; */
r_static
r_int
DECL|function|envctrl_ioctl
id|envctrl_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_char
op_star
id|infobuf
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ENVCTRL_RD_WARNING_TEMPERATURE
suffix:colon
r_case
id|ENVCTRL_RD_SHUTDOWN_TEMPERATURE
suffix:colon
r_case
id|ENVCTRL_RD_MTHRBD_TEMPERATURE
suffix:colon
r_case
id|ENVCTRL_RD_FAN_STATUS
suffix:colon
r_case
id|ENVCTRL_RD_VOLTAGE_STATUS
suffix:colon
r_case
id|ENVCTRL_RD_ETHERNET_TEMPERATURE
suffix:colon
r_case
id|ENVCTRL_RD_SCSI_TEMPERATURE
suffix:colon
r_case
id|ENVCTRL_RD_GLOBALADDRESS
suffix:colon
id|file-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|cmd
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENVCTRL_RD_CPU_TEMPERATURE
suffix:colon
r_case
id|ENVCTRL_RD_CPU_VOLTAGE
suffix:colon
multiline_comment|/* Check to see if application passes in any cpu number,&n;&t;&t; * the default is cpu0.&n;&t;&t; */
id|infobuf
op_assign
(paren
r_char
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|infobuf
op_eq
l_int|NULL
)paren
(brace
id|read_cpu
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|get_user
c_func
(paren
id|read_cpu
comma
id|infobuf
)paren
suffix:semicolon
)brace
multiline_comment|/* Save the command for use when reading. */
id|file-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|cmd
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Function Description: open device. Mapped to user open().&n; * Return: Always 0.&n; */
r_static
r_int
DECL|function|envctrl_open
id|envctrl_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|file-&gt;private_data
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Function Description: Open device. Mapped to user close().&n; * Return: Always 0.&n; */
r_static
r_int
DECL|function|envctrl_release
id|envctrl_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|envctrl_fops
r_static
r_struct
id|file_operations
id|envctrl_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|read
suffix:colon
id|envctrl_read
comma
id|ioctl
suffix:colon
id|envctrl_ioctl
comma
id|open
suffix:colon
id|envctrl_open
comma
id|release
suffix:colon
id|envctrl_release
comma
)brace
suffix:semicolon
DECL|variable|envctrl_dev
r_static
r_struct
id|miscdevice
id|envctrl_dev
op_assign
(brace
id|ENVCTRL_MINOR
comma
l_string|&quot;envctrl&quot;
comma
op_amp
id|envctrl_fops
)brace
suffix:semicolon
multiline_comment|/* Function Description: Set monitor type based on firmware description.&n; * Return: None.&n; */
DECL|function|envctrl_set_mon
r_static
r_void
id|envctrl_set_mon
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
comma
r_char
op_star
id|chnl_desc
comma
r_int
id|chnl_no
)paren
(brace
multiline_comment|/* Firmware only has temperature type.  It does not distinguish&n;&t; * different kinds of temperatures.  We use channel description&n;&t; * to disinguish them.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;temp,cpu&quot;
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;temp,cpu0&quot;
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;temp,cpu1&quot;
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;temp,cpu2&quot;
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;temp,cpu3&quot;
)paren
)paren
)paren
id|pchild-&gt;mon_type
(braket
id|chnl_no
)braket
op_assign
id|ENVCTRL_CPUTEMP_MON
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;vddcore,cpu0&quot;
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;vddcore,cpu1&quot;
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;vddcore,cpu2&quot;
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;vddcore,cpu3&quot;
)paren
)paren
)paren
id|pchild-&gt;mon_type
(braket
id|chnl_no
)braket
op_assign
id|ENVCTRL_CPUVOLTAGE_MON
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;temp,motherboard&quot;
)paren
)paren
)paren
id|pchild-&gt;mon_type
(braket
id|chnl_no
)braket
op_assign
id|ENVCTRL_MTHRBDTEMP_MON
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;temp,scsi&quot;
)paren
)paren
)paren
id|pchild-&gt;mon_type
(braket
id|chnl_no
)braket
op_assign
id|ENVCTRL_SCSITEMP_MON
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|strcmp
c_func
(paren
id|chnl_desc
comma
l_string|&quot;temp,ethernet&quot;
)paren
)paren
)paren
id|pchild-&gt;mon_type
(braket
id|chnl_no
)braket
op_assign
id|ENVCTRL_ETHERTEMP_MON
suffix:semicolon
)brace
multiline_comment|/* Function Description: Initialize monitor channel with channel desc,&n; *                       decoding tables, monitor type, optional properties.&n; * Return: None.&n; */
DECL|function|envctrl_init_adc
r_static
r_void
id|envctrl_init_adc
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
comma
r_int
id|node
)paren
(brace
r_char
id|chnls_desc
(braket
id|CHANNEL_DESC_SZ
)braket
suffix:semicolon
r_int
id|i
comma
id|len
comma
id|j
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|ptr
suffix:semicolon
multiline_comment|/* Firmware describe channels into a stream separated by a &squot;&bslash;0&squot;.&n;&t; * Replace all &squot;&bslash;0&squot; with a space.&n;&t; */
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;channels-description&quot;
comma
id|chnls_desc
comma
id|CHANNEL_DESC_SZ
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|chnls_desc
(braket
id|i
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
id|chnls_desc
(braket
id|i
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
)brace
id|ptr
op_assign
id|strtok
c_func
(paren
id|chnls_desc
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ptr
op_ne
l_int|NULL
)paren
(brace
id|envctrl_set_mon
c_func
(paren
id|pchild
comma
id|ptr
comma
id|j
)paren
suffix:semicolon
id|ptr
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
multiline_comment|/* Get optional properties. */
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;warning-temp&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|warning_temperature
comma
r_sizeof
(paren
id|warning_temperature
)paren
)paren
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;shutdown-temp&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|shutdown_temperature
comma
r_sizeof
(paren
id|shutdown_temperature
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Function Description: Initialize child device monitoring fan status.&n; * Return: None.&n; */
DECL|function|envctrl_init_fanstat
r_static
r_void
id|envctrl_init_fanstat
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Go through all channels and set up the mask. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pchild-&gt;total_chnls
suffix:semicolon
id|i
op_increment
)paren
id|pchild-&gt;fan_mask
op_or_assign
id|chnls_mask
(braket
(paren
id|pchild-&gt;chnl_array
(braket
id|i
)braket
)paren
dot
id|chnl_no
)braket
suffix:semicolon
multiline_comment|/* We only need to know if this child has fan status monitored.&n;&t; * We dont care which channels since we have the mask already.&n;&t; */
id|pchild-&gt;mon_type
(braket
l_int|0
)braket
op_assign
id|ENVCTRL_FANSTAT_MON
suffix:semicolon
)brace
multiline_comment|/* Function Description: Initialize child device for global addressing line.&n; * Return: None.&n; */
DECL|function|envctrl_init_globaladdr
r_static
r_void
id|envctrl_init_globaladdr
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Voltage/PowerSupply monitoring is piggybacked &n;&t; * with Global Address on CompactPCI.  See comments&n;&t; * within envctrl_i2c_globaladdr for bit assignments.&n;&t; *&n;&t; * The mask is created here by assigning mask bits to each&n;&t; * bit position that represents PCF8584_VOLTAGE_TYPE data.&n;&t; * Channel numbers are not consecutive within the globaladdr&n;&t; * node (why?), so we use the actual counter value as chnls_mask&n;&t; * index instead of the chnl_array[x].chnl_no value.&n;&t; *&n;&t; * NOTE: This loop could be replaced with a constant representing&n;&t; * a mask of bits 5&amp;6 (ENVCTRL_GLOBALADDR_PSTAT_MASK).&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pchild-&gt;total_chnls
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|PCF8584_VOLTAGE_TYPE
op_eq
id|pchild-&gt;chnl_array
(braket
id|i
)braket
dot
id|type
)paren
(brace
id|pchild-&gt;voltage_mask
op_or_assign
id|chnls_mask
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/* We only need to know if this child has global addressing &n;&t; * line monitored.  We dont care which channels since we know &n;&t; * the mask already (ENVCTRL_GLOBALADDR_ADDR_MASK).&n;&t; */
id|pchild-&gt;mon_type
(braket
l_int|0
)braket
op_assign
id|ENVCTRL_GLOBALADDR_MON
suffix:semicolon
)brace
multiline_comment|/* Initialize child device monitoring voltage status. */
DECL|function|envctrl_init_voltage_status
r_static
r_void
id|envctrl_init_voltage_status
c_func
(paren
r_struct
id|i2c_child_t
op_star
id|pchild
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Go through all channels and set up the mask. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pchild-&gt;total_chnls
suffix:semicolon
id|i
op_increment
)paren
id|pchild-&gt;voltage_mask
op_or_assign
id|chnls_mask
(braket
(paren
id|pchild-&gt;chnl_array
(braket
id|i
)braket
)paren
dot
id|chnl_no
)braket
suffix:semicolon
multiline_comment|/* We only need to know if this child has voltage status monitored.&n;&t; * We dont care which channels since we have the mask already.&n;&t; */
id|pchild-&gt;mon_type
(braket
l_int|0
)braket
op_assign
id|ENVCTRL_VOLTAGESTAT_MON
suffix:semicolon
)brace
multiline_comment|/* Function Description: Initialize i2c child device.&n; * Return: None.&n; */
DECL|function|envctrl_init_i2c_child
r_static
r_void
id|envctrl_init_i2c_child
c_func
(paren
r_struct
id|linux_ebus_child
op_star
id|edev_child
comma
r_struct
id|i2c_child_t
op_star
id|pchild
)paren
(brace
r_int
id|node
comma
id|len
comma
id|i
comma
id|tbls_size
op_assign
l_int|0
suffix:semicolon
id|node
op_assign
id|edev_child-&gt;prom_node
suffix:semicolon
multiline_comment|/* Get device address. */
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
(paren
id|pchild-&gt;addr
)paren
comma
r_sizeof
(paren
id|pchild-&gt;addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Get tables property.  Read firmware temperature tables. */
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;translation&quot;
comma
(paren
r_char
op_star
)paren
id|pchild-&gt;tblprop_array
comma
(paren
id|PCF8584_MAX_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|pcf8584_tblprop
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|pchild-&gt;total_tbls
op_assign
id|len
op_div
r_sizeof
(paren
r_struct
id|pcf8584_tblprop
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pchild-&gt;total_tbls
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|size
op_plus
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|offset
)paren
OG
id|tbls_size
)paren
(brace
id|tbls_size
op_assign
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|size
op_plus
id|pchild-&gt;tblprop_array
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
)brace
)brace
id|pchild-&gt;tables
op_assign
id|kmalloc
c_func
(paren
id|tbls_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;tables&quot;
comma
(paren
r_char
op_star
)paren
id|pchild-&gt;tables
comma
id|tbls_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;envctrl: Failed to get table.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* SPARCengine ASM Reference Manual (ref. SMI doc 805-7581-04)&n;&t; * sections 2.5, 3.5, 4.5 state node 0x70 for CP1400/1500 is&n;&t; * &quot;For Factory Use Only.&quot;&n;&t; *&n;&t; * We ignore the node on these platforms by assigning the&n;&t; * &squot;NULL&squot; monitor type.&n;&t; */
r_if
c_cond
(paren
id|ENVCTRL_CPCI_IGNORED_NODE
op_eq
id|pchild-&gt;addr
)paren
(brace
r_int
id|len
suffix:semicolon
r_char
id|prop
(braket
l_int|56
)braket
suffix:semicolon
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|prom_root_node
comma
l_string|&quot;name&quot;
comma
id|prop
comma
r_sizeof
(paren
id|prop
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OL
id|len
op_logical_and
(paren
l_int|0
op_eq
id|strncmp
c_func
(paren
id|prop
comma
l_string|&quot;SUNW,UltraSPARC-IIi-cEngine&quot;
comma
id|len
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|len
op_assign
l_int|0
suffix:semicolon
id|len
OL
id|PCF8584_MAX_CHANNELS
suffix:semicolon
op_increment
id|len
)paren
(brace
id|pchild-&gt;mon_type
(braket
id|len
)braket
op_assign
id|ENVCTRL_NOMON
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Get the monitor channels. */
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;channels-in-use&quot;
comma
(paren
r_char
op_star
)paren
id|pchild-&gt;chnl_array
comma
(paren
id|PCF8584_MAX_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|pcf8584_channel
)paren
)paren
)paren
suffix:semicolon
id|pchild-&gt;total_chnls
op_assign
id|len
op_div
r_sizeof
(paren
r_struct
id|pcf8584_channel
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pchild-&gt;total_chnls
suffix:semicolon
id|i
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|pchild-&gt;chnl_array
(braket
id|i
)braket
dot
id|type
)paren
(brace
r_case
id|PCF8584_TEMP_TYPE
suffix:colon
id|envctrl_init_adc
c_func
(paren
id|pchild
comma
id|node
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCF8584_GLOBALADDR_TYPE
suffix:colon
id|envctrl_init_globaladdr
c_func
(paren
id|pchild
)paren
suffix:semicolon
id|i
op_assign
id|pchild-&gt;total_chnls
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCF8584_FANSTAT_TYPE
suffix:colon
id|envctrl_init_fanstat
c_func
(paren
id|pchild
)paren
suffix:semicolon
id|i
op_assign
id|pchild-&gt;total_chnls
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCF8584_VOLTAGE_TYPE
suffix:colon
r_if
c_cond
(paren
id|pchild-&gt;i2ctype
op_eq
id|I2C_ADC
)paren
(brace
id|envctrl_init_adc
c_func
(paren
id|pchild
comma
id|node
)paren
suffix:semicolon
)brace
r_else
(brace
id|envctrl_init_voltage_status
c_func
(paren
id|pchild
)paren
suffix:semicolon
)brace
id|i
op_assign
id|pchild-&gt;total_chnls
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
)brace
multiline_comment|/* Function Description: Search the child device list for a device.&n; * Return : The i2c child if found. NULL otherwise.&n; */
DECL|function|envctrl_get_i2c_child
r_static
r_struct
id|i2c_child_t
op_star
id|envctrl_get_i2c_child
c_func
(paren
r_int
r_char
id|mon_type
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ENVCTRL_MAX_CPU
op_star
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|PCF8584_MAX_CHANNELS
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i2c_childlist
(braket
id|i
)braket
dot
id|mon_type
(braket
id|j
)braket
op_eq
id|mon_type
)paren
(brace
r_return
(paren
r_struct
id|i2c_child_t
op_star
)paren
(paren
op_amp
(paren
id|i2c_childlist
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|envctrl_init
r_static
r_int
id|__init
id|envctrl_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PCI
r_struct
id|linux_ebus
op_star
id|ebus
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|linux_ebus_device
op_star
id|edev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|linux_ebus_child
op_star
id|edev_child
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Traverse through ebus and ebus device list for i2c device and&n;&t; * adc and gpio nodes.&n;&t; */
id|for_each_ebus
c_func
(paren
id|ebus
)paren
(brace
id|for_each_ebusdev
c_func
(paren
id|edev
comma
id|ebus
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|edev-&gt;prom_name
comma
l_string|&quot;i2c&quot;
)paren
)paren
(brace
id|i2c
op_assign
id|ioremap
c_func
(paren
id|edev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
r_sizeof
(paren
r_struct
id|pcf8584_reg
)paren
)paren
suffix:semicolon
id|for_each_edevchild
c_func
(paren
id|edev
comma
id|edev_child
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;gpio&quot;
comma
id|edev_child-&gt;prom_name
)paren
)paren
(brace
id|i2c_childlist
(braket
id|i
)braket
dot
id|i2ctype
op_assign
id|I2C_GPIO
suffix:semicolon
id|envctrl_init_i2c_child
c_func
(paren
id|edev_child
comma
op_amp
(paren
id|i2c_childlist
(braket
id|i
op_increment
)braket
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
l_string|&quot;adc&quot;
comma
id|edev_child-&gt;prom_name
)paren
)paren
(brace
id|i2c_childlist
(braket
id|i
)braket
dot
id|i2ctype
op_assign
id|I2C_ADC
suffix:semicolon
id|envctrl_init_i2c_child
c_func
(paren
id|edev_child
comma
op_amp
(paren
id|i2c_childlist
(braket
id|i
op_increment
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
r_goto
id|done
suffix:semicolon
)brace
)brace
)brace
id|done
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|edev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;envctrl: I2C device not found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Set device address. */
id|envctrl_writeb
c_func
(paren
id|CONTROL_PIN
comma
op_amp
id|i2c-&gt;csr
)paren
suffix:semicolon
id|envctrl_writeb
c_func
(paren
id|PCF8584_ADDRESS
comma
op_amp
id|i2c-&gt;data
)paren
suffix:semicolon
multiline_comment|/* Set system clock and SCL frequencies. */
id|envctrl_writeb
c_func
(paren
id|CONTROL_PIN
op_or
id|CONTROL_ES1
comma
op_amp
id|i2c-&gt;csr
)paren
suffix:semicolon
id|envctrl_writeb
c_func
(paren
id|CLK_4_43
op_or
id|BUS_CLK_90
comma
op_amp
id|i2c-&gt;data
)paren
suffix:semicolon
multiline_comment|/* Enable serial interface. */
id|envctrl_writeb
c_func
(paren
id|CONTROL_PIN
op_or
id|CONTROL_ES0
op_or
id|CONTROL_ACK
comma
op_amp
id|i2c-&gt;csr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* Register the device as a minor miscellaneous device. */
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|envctrl_dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;envctrl: Unable to get misc minor %d&bslash;n&quot;
comma
id|envctrl_dev.minor
)paren
suffix:semicolon
)brace
multiline_comment|/* Note above traversal routine post-incremented &squot;i&squot; to accomodate &n;&t; * a next child device, so we decrement before reverse-traversal of&n;&t; * child devices.&n;&t; */
id|printk
c_func
(paren
l_string|&quot;envctrl: initialized &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
op_decrement
id|i
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;[%s 0x%lx]%s&quot;
comma
(paren
id|I2C_ADC
op_eq
id|i2c_childlist
(braket
id|i
)braket
dot
id|i2ctype
)paren
ques
c_cond
(paren
l_string|&quot;adc&quot;
)paren
suffix:colon
(paren
(paren
id|I2C_GPIO
op_eq
id|i2c_childlist
(braket
id|i
)braket
dot
id|i2ctype
)paren
ques
c_cond
(paren
l_string|&quot;gpio&quot;
)paren
suffix:colon
(paren
l_string|&quot;unknown&quot;
)paren
)paren
comma
id|i2c_childlist
(braket
id|i
)braket
dot
id|addr
comma
(paren
l_int|0
op_eq
id|i
)paren
ques
c_cond
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:colon
(paren
l_string|&quot; &quot;
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif
)brace
DECL|function|envctrl_cleanup
r_static
r_void
id|__exit
id|envctrl_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|iounmap
c_func
(paren
id|i2c
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|envctrl_dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ENVCTRL_MAX_CPU
op_star
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i2c_childlist
(braket
id|i
)braket
dot
id|tables
)paren
id|kfree
c_func
(paren
id|i2c_childlist
(braket
id|i
)braket
dot
id|tables
)paren
suffix:semicolon
)brace
)brace
DECL|variable|envctrl_init
id|module_init
c_func
(paren
id|envctrl_init
)paren
suffix:semicolon
DECL|variable|envctrl_cleanup
id|module_exit
c_func
(paren
id|envctrl_cleanup
)paren
suffix:semicolon
eof
