multiline_comment|/* dvma.c:  Routines that are used to access DMA on the Sparc SBus.&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
DECL|variable|dma_chain
r_struct
id|Linux_SBus_DMA
op_star
id|dma_chain
suffix:semicolon
multiline_comment|/* Print out the current values in the DMA control registers */
r_static
id|__inline__
r_void
DECL|function|dump_dma_regs
id|dump_dma_regs
c_func
(paren
r_struct
id|sparc_dma_registers
op_star
id|dregs
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DMA CONTROL&lt;%08lx&gt;  ADDR&lt;%08lx&gt; CNT&lt;%08lx&gt; TEST&lt;%08lx&gt;&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|dregs-&gt;cond_reg
comma
(paren
r_int
r_int
)paren
id|dregs-&gt;st_addr
comma
(paren
r_int
r_int
)paren
id|dregs-&gt;cnt
comma
(paren
r_int
r_int
)paren
id|dregs-&gt;dma_test
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Probe this SBus DMA module(s) */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
r_int
id|dvma_init
c_func
(paren
r_struct
id|linux_sbus
op_star
id|sbus
comma
r_int
r_int
id|memory_start
)paren
)paren
(brace
r_struct
id|linux_sbus_device
op_star
id|this_dev
suffix:semicolon
r_struct
id|Linux_SBus_DMA
op_star
id|dma
suffix:semicolon
r_struct
id|Linux_SBus_DMA
op_star
id|dchain
suffix:semicolon
r_static
r_int
id|num_dma
op_assign
l_int|0
suffix:semicolon
id|for_each_sbusdev
c_func
(paren
id|this_dev
comma
id|sbus
)paren
(brace
r_int
id|hme
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_dev-&gt;prom_name
comma
l_string|&quot;SUNW,fas&quot;
)paren
)paren
(brace
id|hme
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|this_dev-&gt;prom_name
comma
l_string|&quot;dma&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|this_dev-&gt;prom_name
comma
l_string|&quot;ledma&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|this_dev-&gt;prom_name
comma
l_string|&quot;espdma&quot;
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* Found one... */
id|dma
op_assign
(paren
r_struct
id|Linux_SBus_DMA
op_star
)paren
id|memory_start
suffix:semicolon
id|memory_start
op_add_assign
r_sizeof
(paren
r_struct
id|Linux_SBus_DMA
)paren
suffix:semicolon
id|dma-&gt;SBus_dev
op_assign
id|this_dev
suffix:semicolon
multiline_comment|/* Put at end of dma chain */
id|dchain
op_assign
id|dma_chain
suffix:semicolon
r_if
c_cond
(paren
id|dchain
)paren
(brace
r_while
c_loop
(paren
id|dchain-&gt;next
)paren
(brace
id|dchain
op_assign
id|dchain-&gt;next
suffix:semicolon
)brace
id|dchain-&gt;next
op_assign
id|dma
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We&squot;re the first in line */
id|dma_chain
op_assign
id|dma
suffix:semicolon
)brace
id|dma-&gt;next
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dma%d: &quot;
comma
id|num_dma
)paren
suffix:semicolon
id|num_dma
op_increment
suffix:semicolon
multiline_comment|/* The constant PAGE_SIZE that is passed to sparc_alloc_io makes the&n;&t;&t; * routine only alloc 1 page, that was what the original code did&n;&t;&t; */
r_if
c_cond
(paren
id|hme
)paren
(brace
multiline_comment|/* On HME cards, dvma lives with esp, 2 reg sets. */
id|prom_apply_sbus_ranges
c_func
(paren
id|sbus
comma
id|dma-&gt;SBus_dev-&gt;reg_addrs
comma
l_int|0x2
comma
id|dma-&gt;SBus_dev
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* All others have only 1 reg set. */
id|prom_apply_sbus_ranges
c_func
(paren
id|sbus
comma
id|dma-&gt;SBus_dev-&gt;reg_addrs
comma
l_int|0x1
comma
id|dma-&gt;SBus_dev
)paren
suffix:semicolon
id|dma-&gt;regs
op_assign
(paren
r_struct
id|sparc_dma_registers
op_star
)paren
id|sparc_alloc_io
(paren
id|dma-&gt;SBus_dev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;dma&quot;
comma
id|dma-&gt;SBus_dev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0x0
)paren
suffix:semicolon
id|dma-&gt;node
op_assign
id|dma-&gt;SBus_dev-&gt;prom_node
suffix:semicolon
id|dma-&gt;running
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No transfers going on as of yet */
id|dma-&gt;allocated
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No one has allocated us yet */
r_switch
c_cond
(paren
(paren
id|dma-&gt;regs-&gt;cond_reg
)paren
op_amp
id|DMA_DEVICE_ID
)paren
(brace
r_case
id|DMA_VERS0
suffix:colon
id|dma-&gt;revision
op_assign
id|dvmarev0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Revision 0 &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_ESCV1
suffix:colon
id|dma-&gt;revision
op_assign
id|dvmaesc1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ESC Revision 1 &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_VERS1
suffix:colon
id|dma-&gt;revision
op_assign
id|dvmarev1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Revision 1 &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_VERS2
suffix:colon
id|dma-&gt;revision
op_assign
id|dvmarev2
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Revision 2 &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_VERHME
suffix:colon
id|dma-&gt;revision
op_assign
id|dvmahme
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HME DVMA gate array &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_VERSPLUS
suffix:colon
id|dma-&gt;revision
op_assign
id|dvmarevplus
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Revision 1 PLUS &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;unknown dma version %x&quot;
comma
(paren
id|dma-&gt;regs-&gt;cond_reg
)paren
op_amp
id|DMA_DEVICE_ID
)paren
suffix:semicolon
id|dma-&gt;allocated
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0 /* Clutters up the screen */
id|dump_dma_regs
c_func
(paren
id|dma-&gt;regs
)paren
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/* while(this_dev) */
r_return
id|memory_start
suffix:semicolon
)brace
eof
