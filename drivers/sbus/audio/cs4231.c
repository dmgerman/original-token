multiline_comment|/*&n; * drivers/sbus/audio/cs4231.c&n; *&n; * Copyright (C) 1996 Thomas K. Dyas (tdyas@noc.rutgers.edu)&n; * Copyright (C) 1996 Derrick J Brashear (shadow@andrew.cmu.edu)&n; *&n; * This is the lowlevel driver for the CS4231 audio chip found on some&n; * sun4m machines.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/auxio.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &quot;audio.h&quot;
macro_line|#include &quot;cs4231.h&quot;
multiline_comment|/* Stolen for now from compat.h */
macro_line|#ifndef MAX                             /* Usually found in &lt;sys/param.h&gt;. */
DECL|macro|MAX
mdefine_line|#define MAX(_a,_b)      ((_a)&lt;(_b)?(_b):(_a))
macro_line|#endif
macro_line|#ifndef MIN                             /* Usually found in &lt;sys/param.h&gt;. */
DECL|macro|MIN
mdefine_line|#define MIN(_a,_b)      ((_a)&lt;(_b)?(_a):(_b))
macro_line|#endif
DECL|variable|cs4231_node
DECL|variable|cs4231_irq
DECL|variable|cs4231_is_revision_a
DECL|variable|cs4231_ints_on
r_static
r_int
id|cs4231_node
comma
id|cs4231_irq
comma
id|cs4231_is_revision_a
comma
id|cs4231_ints_on
op_assign
l_int|0
suffix:semicolon
DECL|variable|cs4231_monitor_gain_value
r_static
r_int
r_int
id|cs4231_monitor_gain_value
suffix:semicolon
id|cs4231_regs_size
DECL|variable|cs4231_output_muted_value
r_static
r_int
id|cs4231_output_muted_value
suffix:semicolon
DECL|variable|cs4231_input
r_static
r_struct
id|cs4231_stream_info
id|cs4231_input
suffix:semicolon
DECL|variable|cs4231_output
r_static
r_struct
id|cs4231_stream_info
id|cs4231_output
suffix:semicolon
DECL|variable|cs4231_busy
DECL|variable|cs4231_need_init
r_static
r_int
id|cs4231_busy
op_assign
l_int|0
comma
id|cs4231_need_init
op_assign
l_int|0
suffix:semicolon
DECL|variable|cs4231_chip
r_static
r_volatile
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|ptr
r_static
id|__u8
op_star
id|ptr
suffix:semicolon
DECL|variable|count
r_static
r_int
id|count
suffix:semicolon
DECL|macro|CHIP_BUG
mdefine_line|#define CHIP_BUG udelay(100); cs4231_ready(); udelay(1000);
DECL|function|cs4231_ready
r_static
r_void
id|cs4231_ready
c_func
(paren
r_void
)paren
(brace
r_register
r_int
r_int
id|x
op_assign
l_int|0
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
(paren
id|u_char
)paren
id|IAR_AUTOCAL_END
suffix:semicolon
r_while
c_loop
(paren
id|cs4231_chip-&gt;pioregs.iar
op_eq
id|IAR_NOT_READY
op_logical_and
id|x
op_le
id|CS_TIMEOUT
)paren
(brace
id|x
op_increment
suffix:semicolon
)brace
id|x
op_assign
l_int|0
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x0b
suffix:semicolon
r_while
c_loop
(paren
id|cs4231_chip-&gt;pioregs.idr
op_eq
id|AUTOCAL_IN_PROGRESS
op_logical_and
id|x
op_le
id|CS_TIMEOUT
)paren
(brace
id|x
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Enable cs4231 interrupts atomically. */
DECL|function|cs4231_enable_ints
r_static
id|__inline__
r_void
id|cs4231_enable_ints
c_func
(paren
r_void
)paren
(brace
r_register
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_ints_on
)paren
r_return
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* do init here&n;&t;amd7930_regs-&gt;cr = AMR_INIT;&n;&t;amd7930_regs-&gt;dr = AM_INIT_ACTIVE;&n;&t;*/
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cs4231_ints_on
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Disable cs4231 interrupts atomically. */
DECL|function|cs4231_disable_ints
r_static
id|__inline__
r_void
id|cs4231_disable_ints
c_func
(paren
r_void
)paren
(brace
r_register
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs4231_ints_on
)paren
r_return
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;amd7930_regs-&gt;cr = AMR_INIT;&n;&t;amd7930_regs-&gt;dr = AM_INIT_ACTIVE | AM_INIT_DISABLE_INTS;&n;*/
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cs4231_ints_on
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Audio interrupt handler. */
DECL|function|cs4231_interrupt
r_static
r_void
id|cs4231_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|__u8
id|dummy
suffix:semicolon
multiline_comment|/* Clear the interrupt. */
id|dummy
op_assign
id|cs4231_chip-&gt;dmaregs.dmacsr
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_assign
id|dummy
suffix:semicolon
)brace
DECL|function|cs4231_output_muted
r_static
r_int
r_int
id|cs4231_output_muted
c_func
(paren
r_int
r_int
id|value
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
(brace
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x7
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_and_assign
id|OUTCR_UNMUTE
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x6
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_and_assign
id|OUTCR_UNMUTE
suffix:semicolon
id|cs4231_output_muted_value
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x7
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_or_assign
id|OUTCR_MUTE
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x6
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_or_assign
id|OUTCR_MUTE
suffix:semicolon
id|cs4231_output_muted_value
op_assign
l_int|1
suffix:semicolon
)brace
r_return
(paren
id|cs4231_output_muted_value
)paren
suffix:semicolon
)brace
DECL|function|cs4231_out_port
r_static
r_int
r_int
id|cs4231_out_port
c_func
(paren
r_int
r_int
id|value
)paren
(brace
r_int
r_int
id|r
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* You can have any combo you want. Just don&squot;t tell anyone. */
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x1a
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_or_assign
id|MONO_IOCR_MUTE
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x0a
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_or_assign
id|PINCR_LINE_MUTE
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_or_assign
id|PINCR_HDPH_MUTE
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_SPEAKER
)paren
(brace
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x1a
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_and_assign
op_complement
id|MONO_IOCR_MUTE
suffix:semicolon
id|r
op_or_assign
id|AUDIO_SPEAKER
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_HEADPHONE
)paren
(brace
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x0a
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_and_assign
op_complement
id|PINCR_HDPH_MUTE
suffix:semicolon
id|r
op_or_assign
id|AUDIO_HEADPHONE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_LINE_OUT
)paren
(brace
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x0a
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_and_assign
op_complement
id|PINCR_LINE_MUTE
suffix:semicolon
id|r
op_or_assign
id|AUDIO_LINE_OUT
suffix:semicolon
)brace
r_return
(paren
id|r
)paren
suffix:semicolon
)brace
DECL|function|cs4231_in_port
r_static
r_int
r_int
id|cs4231_in_port
c_func
(paren
r_int
r_int
id|value
)paren
(brace
r_int
r_int
id|r
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The order of these seems to matter. Can&squot;t tell yet why. */
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_INTERNAL_CD_IN
)paren
(brace
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x1
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|CDROM_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs.idr
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x0
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|CDROM_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs.idr
)paren
suffix:semicolon
id|r
op_assign
id|AUDIO_INTERNAL_CD_IN
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|value
op_amp
id|AUDIO_LINE_IN
)paren
)paren
(brace
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x1
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|LINE_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs.idr
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x0
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|LINE_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs.idr
)paren
suffix:semicolon
id|r
op_assign
id|AUDIO_LINE_IN
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_MICROPHONE
)paren
(brace
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x1
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|MIC_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs.idr
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x0
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|MIC_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs.idr
)paren
suffix:semicolon
id|r
op_assign
id|AUDIO_MICROPHONE
suffix:semicolon
)brace
r_return
(paren
id|r
)paren
suffix:semicolon
)brace
DECL|function|cs4231_monitor_gain
r_static
r_int
r_int
id|cs4231_monitor_gain
c_func
(paren
r_int
r_int
id|value
)paren
(brace
r_int
id|a
op_assign
l_int|0
suffix:semicolon
id|a
op_assign
id|CS4231_MON_MAX_ATEN
op_minus
(paren
id|value
op_star
(paren
id|CS4231_MON_MAX_ATEN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x0d
suffix:semicolon
r_if
c_cond
(paren
id|a
op_ge
id|CS4231_MON_MAX_ATEN
)paren
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|LOOPB_OFF
suffix:semicolon
r_else
id|cs4231_chip-&gt;pioregs.idr
op_assign
(paren
(paren
id|a
op_lshift
l_int|2
)paren
op_or
id|LOOPB_ON
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
id|AUDIO_MAX_GAIN
)paren
r_return
id|AUDIO_MAX_GAIN
suffix:semicolon
r_return
(paren
(paren
id|CS4231_MAX_DEV_ATEN
op_minus
id|a
)paren
op_star
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|CS4231_MAX_DEV_ATEN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Set record gain */
DECL|function|cs4231_record_gain
r_static
r_int
r_int
id|cs4231_record_gain
c_func
(paren
r_int
r_int
id|value
comma
r_int
r_char
id|balance
)paren
(brace
r_int
r_int
id|tmp
op_assign
l_int|0
comma
id|r
comma
id|l
comma
id|ra
comma
id|la
suffix:semicolon
r_int
r_char
id|old_gain
suffix:semicolon
id|r
op_assign
id|l
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|balance
OL
id|AUDIO_MID_BALANCE
)paren
(brace
id|r
op_assign
id|MAX
c_func
(paren
l_int|0
comma
(paren
r_int
)paren
(paren
id|value
op_minus
(paren
(paren
id|AUDIO_MID_BALANCE
op_minus
id|balance
)paren
op_lshift
id|AUDIO_BALANCE_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|balance
OG
id|AUDIO_MID_BALANCE
)paren
(brace
id|l
op_assign
id|MAX
c_func
(paren
l_int|0
comma
(paren
r_int
)paren
(paren
id|value
op_minus
(paren
(paren
id|balance
op_minus
id|AUDIO_MID_BALANCE
)paren
op_lshift
id|AUDIO_BALANCE_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
id|la
op_assign
id|l
op_star
(paren
id|CS4231_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
suffix:semicolon
id|ra
op_assign
id|r
op_star
(paren
id|CS4231_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x0
suffix:semicolon
id|old_gain
op_assign
id|cs4231_chip-&gt;pioregs.idr
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|RECGAIN_SET
c_func
(paren
id|old_gain
comma
id|la
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x1
suffix:semicolon
id|old_gain
op_assign
id|cs4231_chip-&gt;pioregs.idr
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|RECGAIN_SET
c_func
(paren
id|old_gain
comma
id|ra
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
op_eq
id|value
)paren
(brace
(paren
id|l
op_eq
l_int|0
)paren
ques
c_cond
(paren
id|tmp
op_assign
l_int|0
)paren
suffix:colon
(paren
id|tmp
op_assign
(paren
(paren
id|la
op_plus
l_int|1
)paren
op_star
id|AUDIO_MAX_GAIN
)paren
op_div
(paren
id|CS4231_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|r
op_eq
id|value
)paren
(brace
(paren
id|r
op_eq
l_int|0
)paren
ques
c_cond
(paren
id|tmp
op_assign
l_int|0
)paren
suffix:colon
(paren
id|tmp
op_assign
(paren
(paren
id|ra
op_plus
l_int|1
)paren
op_star
id|AUDIO_MAX_GAIN
)paren
op_div
(paren
id|CS4231_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/* Set play gain */
DECL|function|cs4231_play_gain
r_static
r_int
r_int
id|cs4231_play_gain
c_func
(paren
r_int
r_int
id|value
comma
r_int
r_char
id|balance
)paren
(brace
r_int
r_int
id|tmp
op_assign
l_int|0
comma
id|r
comma
id|l
comma
id|ra
comma
id|la
suffix:semicolon
r_int
r_char
id|old_gain
suffix:semicolon
id|r
op_assign
id|l
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|balance
OL
id|AUDIO_MID_BALANCE
)paren
(brace
id|r
op_assign
id|MAX
c_func
(paren
l_int|0
comma
(paren
r_int
)paren
(paren
id|value
op_minus
(paren
(paren
id|AUDIO_MID_BALANCE
op_minus
id|balance
)paren
op_lshift
id|AUDIO_BALANCE_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|balance
OG
id|AUDIO_MID_BALANCE
)paren
(brace
id|l
op_assign
id|MAX
c_func
(paren
l_int|0
comma
(paren
r_int
)paren
(paren
id|value
op_minus
(paren
(paren
id|balance
op_minus
id|AUDIO_MID_BALANCE
)paren
op_lshift
id|AUDIO_BALANCE_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|l
op_eq
l_int|0
)paren
(brace
id|la
op_assign
id|CS4231_MAX_DEV_ATEN
suffix:semicolon
)brace
r_else
(brace
id|la
op_assign
id|CS4231_MAX_ATEN
op_minus
(paren
id|l
op_star
(paren
id|CS4231_MAX_ATEN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r
op_eq
l_int|0
)paren
(brace
id|ra
op_assign
id|CS4231_MAX_DEV_ATEN
suffix:semicolon
)brace
r_else
(brace
id|ra
op_assign
id|CS4231_MAX_ATEN
op_minus
(paren
id|r
op_star
(paren
id|CS4231_MAX_ATEN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x6
suffix:semicolon
id|old_gain
op_assign
id|cs4231_chip-&gt;pioregs.idr
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|GAIN_SET
c_func
(paren
id|old_gain
comma
id|la
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x7
suffix:semicolon
id|old_gain
op_assign
id|cs4231_chip-&gt;pioregs.idr
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|GAIN_SET
c_func
(paren
id|old_gain
comma
id|ra
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value
op_eq
l_int|0
)paren
op_logical_or
(paren
id|value
op_eq
id|AUDIO_MAX_GAIN
)paren
)paren
(brace
id|tmp
op_assign
id|value
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|l
op_eq
id|value
)paren
(brace
id|tmp
op_assign
(paren
(paren
id|CS4231_MAX_ATEN
op_minus
id|la
)paren
op_star
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|CS4231_MAX_ATEN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|r
op_eq
id|value
)paren
(brace
id|tmp
op_assign
(paren
(paren
id|CS4231_MAX_ATEN
op_minus
id|ra
)paren
op_star
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|CS4231_MAX_ATEN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset the audio chip to a sane state. */
DECL|function|cs4231_reset
r_static
r_void
id|cs4231_reset
c_func
(paren
r_void
)paren
(brace
id|cs4231_chip-&gt;dmaregs.dmacsr
op_assign
id|APC_RESET
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_assign
l_int|0x00
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_or_assign
id|APC_CODEC_PDN
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_and_assign
op_complement
(paren
id|APC_CODEC_PDN
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_or_assign
id|IAR_AUTOCAL_BEGIN
suffix:semicolon
id|CHIP_BUG
id|cs4231_chip-&gt;pioregs.iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x0c
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|MISC_IR_MODE2
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x08
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
id|CHIP_BUG
id|cs4231_chip-&gt;pioregs.iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x1c
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
id|CHIP_BUG
id|cs4231_chip-&gt;pioregs.iar
op_assign
l_int|0x19
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_chip-&gt;pioregs.idr
op_amp
id|CS4231A
)paren
id|cs4231_is_revision_a
op_assign
l_int|1
suffix:semicolon
r_else
id|cs4231_is_revision_a
op_assign
l_int|0
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x10
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
(paren
id|u_char
)paren
id|OLB_ENABLE
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x11
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_is_revision_a
)paren
id|cs4231_chip-&gt;pioregs.idr
op_assign
(paren
id|HPF_ON
op_or
id|XTALE_ON
)paren
suffix:semicolon
r_else
id|cs4231_chip-&gt;pioregs.idr
op_assign
(paren
id|HPF_ON
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x1a
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
l_int|0x00
suffix:semicolon
id|cs4231_output.gain
op_assign
id|cs4231_play_gain
c_func
(paren
id|CS4231_DEFAULT_PLAYGAIN
comma
id|AUDIO_MID_BALANCE
)paren
suffix:semicolon
id|cs4231_input.gain
op_assign
id|cs4231_record_gain
c_func
(paren
id|CS4231_DEFAULT_RECGAIN
comma
id|AUDIO_MID_BALANCE
)paren
suffix:semicolon
id|cs4231_output.port
op_assign
id|cs4231_out_port
c_func
(paren
id|AUDIO_SPEAKER
)paren
suffix:semicolon
id|cs4231_input.port
op_assign
id|cs4231_in_port
c_func
(paren
id|AUDIO_MICROPHONE
)paren
suffix:semicolon
id|cs4231_monitor_gain_value
op_assign
id|cs4231_monitor_gain
c_func
(paren
id|LOOPB_OFF
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
(paren
id|u_char
)paren
id|IAR_AUTOCAL_END
suffix:semicolon
id|cs4231_ready
c_func
(paren
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x09
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_and_assign
id|ACAL_DISABLE
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
(paren
id|u_char
)paren
id|IAR_AUTOCAL_END
suffix:semicolon
id|cs4231_ready
c_func
(paren
)paren
suffix:semicolon
id|cs4231_output_muted_value
op_assign
id|cs4231_output_muted
c_func
(paren
l_int|0x0
)paren
suffix:semicolon
)brace
DECL|function|cs4231_open
r_static
r_int
id|cs4231_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_int
id|level
suffix:semicolon
multiline_comment|/* Set the default audio parameters. */
id|cs4231_output.sample_rate
op_assign
id|CS4231_RATE
suffix:semicolon
id|cs4231_output.channels
op_assign
id|CS4231_CHANNELS
suffix:semicolon
id|cs4231_output.precision
op_assign
id|CS4231_PRECISION
suffix:semicolon
id|cs4231_output.encoding
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|cs4231_input.sample_rate
op_assign
id|CS4231_RATE
suffix:semicolon
id|cs4231_input.channels
op_assign
id|CS4231_CHANNELS
suffix:semicolon
id|cs4231_input.precision
op_assign
id|CS4231_PRECISION
suffix:semicolon
id|cs4231_input.encoding
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|cs4231_ready
c_func
(paren
)paren
suffix:semicolon
id|cs4231_need_init
op_assign
l_int|1
suffix:semicolon
macro_line|#if 1
multiline_comment|/* Arguably this should only happen once. I need to play around &n;         * on a Solaris box and see what happens&n;         */
id|cs4231_chip-&gt;pioregs.iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x08
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
id|cs4231_chip-&gt;pioregs.iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x1c
suffix:semicolon
id|cs4231_chip-&gt;pioregs.idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
macro_line|#endif
id|CHIP_BUG
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cs4231_release
r_static
r_void
id|cs4231_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
id|cs4231_disable_ints
c_func
(paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|cs4231_start_output
r_static
r_void
id|cs4231_start_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
id|the_count
)paren
(brace
id|count
op_assign
id|the_count
suffix:semicolon
id|ptr
op_assign
id|buffer
suffix:semicolon
id|cs4231_enable_ints
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cs4231_stop_output
r_static
r_void
id|cs4231_stop_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
id|cs4231_disable_ints
c_func
(paren
)paren
suffix:semicolon
id|ptr
op_assign
l_int|NULL
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
)brace
DECL|variable|cs4231_ops
r_static
r_struct
id|sparcaudio_operations
id|cs4231_ops
op_assign
(brace
id|cs4231_open
comma
id|cs4231_release
comma
l_int|NULL
comma
multiline_comment|/* cs4231_ioctl */
id|cs4231_start_output
comma
id|cs4231_stop_output
comma
)brace
suffix:semicolon
DECL|variable|cs4231_drv
r_static
r_struct
id|sparcaudio_driver
id|cs4231_drv
op_assign
(brace
l_string|&quot;cs4231&quot;
comma
op_amp
id|cs4231_ops
comma
)brace
suffix:semicolon
multiline_comment|/* Probe for the cs4231 chip and then attach the driver. */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_int
id|cs4231_init
c_func
(paren
r_void
)paren
)paren
macro_line|#endif
(brace
r_struct
id|linux_prom_registers
id|regs
(braket
l_int|1
)braket
suffix:semicolon
r_struct
id|linux_prom_irqs
id|irq
suffix:semicolon
r_int
id|err
suffix:semicolon
macro_line|#ifdef MODULE
id|register_symtab
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Find the PROM CS4231 node. */
id|cs4231_node
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_searchsiblings
c_func
(paren
id|cs4231_node
comma
l_string|&quot;iommu&quot;
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_getchild
c_func
(paren
id|cs4231_node
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_searchsiblings
c_func
(paren
id|cs4231_node
comma
l_string|&quot;sbus&quot;
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_getchild
c_func
(paren
id|cs4231_node
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_searchsiblings
c_func
(paren
id|cs4231_node
comma
l_string|&quot;SUNW,CS4231&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs4231_node
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* XXX Add for_each_sbus() search as well for LX and friends. */
multiline_comment|/* XXX Copy out for prom_apply_sbus_ranges. */
multiline_comment|/* Map the registers into memory. */
id|prom_getproperty
c_func
(paren
id|cs4231_node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
suffix:semicolon
id|cs4231_regs_size
op_assign
id|regs
(braket
l_int|0
)braket
dot
id|reg_size
suffix:semicolon
id|cs4231_regs
op_assign
id|sparc_alloc_io
c_func
(paren
id|regs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
id|regs
(braket
l_int|0
)braket
dot
id|reg_size
comma
l_string|&quot;cs4231&quot;
comma
id|regs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs4231_regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cs4231: could not allocate registers&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Disable cs4231 interrupt generation. */
id|cs4231_disable_ints
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Reset the audio chip. */
id|cs4231_reset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Attach the interrupt handler to the audio interrupt. */
id|prom_getproperty
c_func
(paren
id|cs4231_node
comma
l_string|&quot;intr&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irq
comma
r_sizeof
(paren
id|irq
)paren
)paren
suffix:semicolon
id|cs4231_irq
op_assign
id|irq.pri
suffix:semicolon
id|request_irq
c_func
(paren
id|cs4231_irq
comma
id|cs4231_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;cs4231&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|cs4231_irq
)paren
suffix:semicolon
multiline_comment|/* Register ourselves with the midlevel audio driver. */
id|err
op_assign
id|register_sparcaudio_driver
c_func
(paren
op_amp
id|cs4231_drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
multiline_comment|/* XXX We should do something. Complain for now. */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cs4231: really screwed now&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_sparcaudio_driver
c_func
(paren
op_amp
id|cs4231_drv
)paren
suffix:semicolon
id|cs4231_disable_ints
c_func
(paren
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|cs4231_irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|cs4231_irq
comma
l_int|NULL
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|cs4231_regs
comma
id|cs4231_regs_size
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
