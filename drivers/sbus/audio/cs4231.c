multiline_comment|/*&n; * drivers/sbus/audio/cs4231.c&n; *&n; * Copyright (C) 1996 Thomas K. Dyas (tdyas@noc.rutgers.edu)&n; * Copyright (C) 1996 Derrick J Brashear (shadow@andrew.cmu.edu)&n; *&n; * This is the lowlevel driver for the CS4231 audio chip found on some&n; * sun4m machines.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &quot;audio.h&quot;
macro_line|#include &quot;cs4231.h&quot;
multiline_comment|/* Stolen for now from compat.h */
macro_line|#ifndef MAX                             /* Usually found in &lt;sys/param.h&gt;. */
DECL|macro|MAX
mdefine_line|#define MAX(_a,_b)      ((_a)&lt;(_b)?(_b):(_a))
macro_line|#endif
macro_line|#ifndef MIN                             /* Usually found in &lt;sys/param.h&gt;. */
DECL|macro|MIN
mdefine_line|#define MIN(_a,_b)      ((_a)&lt;(_b)?(_a):(_b))
macro_line|#endif
DECL|macro|MAX_DRIVERS
mdefine_line|#define MAX_DRIVERS 1
DECL|variable|drivers
r_static
r_struct
id|sparcaudio_driver
id|drivers
(braket
id|MAX_DRIVERS
)braket
suffix:semicolon
DECL|variable|num_drivers
r_static
r_int
id|num_drivers
suffix:semicolon
r_static
r_int
id|cs4231_playintr
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
suffix:semicolon
r_static
r_int
id|cs4231_recintr
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
suffix:semicolon
r_static
r_void
id|cs4231_output_muted
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
r_int
id|value
)paren
suffix:semicolon
r_static
r_void
id|cs4231_mute
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
suffix:semicolon
r_static
r_void
id|cs4231_pollinput
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
suffix:semicolon
r_static
r_int
id|cs4231_attach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|node
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
suffix:semicolon
DECL|macro|CHIP_BUG
mdefine_line|#define CHIP_BUG udelay(100); cs4231_ready(drv); udelay(1000);
multiline_comment|/* Disable mode change, let chip auto-calibrate */
DECL|function|cs4231_ready
r_static
r_void
id|cs4231_ready
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|x
op_assign
l_int|0
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
(paren
id|u_char
)paren
id|IAR_AUTOCAL_END
suffix:semicolon
r_while
c_loop
(paren
id|cs4231_chip-&gt;pioregs-&gt;iar
op_eq
id|IAR_NOT_READY
op_logical_and
id|x
op_le
id|CS_TIMEOUT
)paren
(brace
id|x
op_increment
suffix:semicolon
)brace
id|x
op_assign
l_int|0
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x0b
suffix:semicolon
r_while
c_loop
(paren
id|cs4231_chip-&gt;pioregs-&gt;idr
op_eq
id|AUTOCAL_IN_PROGRESS
op_logical_and
id|x
op_le
id|CS_TIMEOUT
)paren
(brace
id|x
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Audio interrupt handler. */
DECL|function|cs4231_interrupt
r_static
r_void
id|cs4231_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sparcaudio_driver
op_star
id|drv
op_assign
(paren
r_struct
id|sparcaudio_driver
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|__u8
id|dummy
suffix:semicolon
r_int
id|ic
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Clear the interrupt. */
id|dummy
op_assign
id|cs4231_chip-&gt;dmaregs.dmacsr
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_assign
id|dummy
suffix:semicolon
multiline_comment|/* now go through and figure out what gets to claim the interrupt */
r_if
c_cond
(paren
id|dummy
op_amp
id|CS_PLAY_INT
)paren
(brace
r_if
c_cond
(paren
id|dummy
op_amp
id|CS_XINT_PNVA
)paren
(brace
multiline_comment|/* recalculate number of samples */
id|cs4231_playintr
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
id|ic
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dummy
op_amp
id|CS_CAPT_INT
)paren
(brace
r_if
c_cond
(paren
id|dummy
op_amp
id|CS_XINT_CNVA
)paren
(brace
multiline_comment|/* recalculate number of samples */
id|cs4231_recintr
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
id|ic
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dummy
op_amp
id|CS_XINT_CEMP
)paren
op_logical_and
(paren
id|cs4231_chip-&gt;perchip_info.record.active
op_eq
l_int|0
)paren
)paren
(brace
id|ic
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dummy
op_amp
id|CS_XINT_EMPT
)paren
op_logical_and
(paren
id|cs4231_chip-&gt;perchip_info.play.active
op_eq
l_int|0
)paren
)paren
(brace
id|cs4231_chip-&gt;dmaregs.dmacsr
op_or_assign
(paren
id|CS_PPAUSE
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x9
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_and_assign
id|PEN_DISABLE
suffix:semicolon
id|cs4231_mute
c_func
(paren
id|drv
)paren
suffix:semicolon
multiline_comment|/* recalculate number of samples */
multiline_comment|/* cleanup DMA */
id|ic
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dummy
op_amp
id|CS_GENL_INT
)paren
(brace
id|ic
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Set output mute */
DECL|function|cs4231_output_muted
r_static
r_void
id|cs4231_output_muted
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
r_int
id|value
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x7
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_and_assign
id|OUTCR_UNMUTE
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x6
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_and_assign
id|OUTCR_UNMUTE
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.output_muted
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x7
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_or_assign
id|OUTCR_MUTE
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x6
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_or_assign
id|OUTCR_MUTE
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.output_muted
op_assign
l_int|1
suffix:semicolon
)brace
r_return
multiline_comment|/*(cs4231_chip-&gt;perchip_info.output_muted)*/
suffix:semicolon
)brace
multiline_comment|/* Set chip &quot;output&quot; port */
DECL|function|cs4231_out_port
r_static
r_int
r_int
id|cs4231_out_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
r_int
id|value
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|r
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* You can have any combo you want. Just don&squot;t tell anyone. */
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x1a
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_or_assign
id|MONO_IOCR_MUTE
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x0a
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_or_assign
id|PINCR_LINE_MUTE
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_or_assign
id|PINCR_HDPH_MUTE
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_SPEAKER
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x1a
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_and_assign
op_complement
id|MONO_IOCR_MUTE
suffix:semicolon
id|r
op_or_assign
id|AUDIO_SPEAKER
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_HEADPHONE
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x0a
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_and_assign
op_complement
id|PINCR_HDPH_MUTE
suffix:semicolon
id|r
op_or_assign
id|AUDIO_HEADPHONE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_LINE_OUT
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x0a
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_and_assign
op_complement
id|PINCR_LINE_MUTE
suffix:semicolon
id|r
op_or_assign
id|AUDIO_LINE_OUT
suffix:semicolon
)brace
r_return
(paren
id|r
)paren
suffix:semicolon
)brace
multiline_comment|/* Set chip &quot;input&quot; port */
DECL|function|cs4231_in_port
r_static
r_int
r_int
id|cs4231_in_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
r_int
id|value
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|r
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The order of these seems to matter. Can&squot;t tell yet why. */
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_INTERNAL_CD_IN
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x1
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|CDROM_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs-&gt;idr
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x0
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|CDROM_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs-&gt;idr
)paren
suffix:semicolon
id|r
op_assign
id|AUDIO_INTERNAL_CD_IN
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|value
op_amp
id|AUDIO_LINE_IN
)paren
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x1
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|LINE_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs-&gt;idr
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x0
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|LINE_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs-&gt;idr
)paren
suffix:semicolon
id|r
op_assign
id|AUDIO_LINE_IN
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|value
op_amp
id|AUDIO_MICROPHONE
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x1
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|MIC_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs-&gt;idr
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x0
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|MIC_ENABLE
c_func
(paren
id|cs4231_chip-&gt;pioregs-&gt;idr
)paren
suffix:semicolon
id|r
op_assign
id|AUDIO_MICROPHONE
suffix:semicolon
)brace
r_return
(paren
id|r
)paren
suffix:semicolon
)brace
multiline_comment|/* Set chip &quot;monitor&quot; gain */
DECL|function|cs4231_monitor_gain
r_static
r_int
r_int
id|cs4231_monitor_gain
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
r_int
id|value
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|a
op_assign
l_int|0
suffix:semicolon
id|a
op_assign
id|CS4231_MON_MAX_ATEN
op_minus
(paren
id|value
op_star
(paren
id|CS4231_MON_MAX_ATEN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x0d
suffix:semicolon
r_if
c_cond
(paren
id|a
op_ge
id|CS4231_MON_MAX_ATEN
)paren
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|LOOPB_OFF
suffix:semicolon
r_else
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
(paren
(paren
id|a
op_lshift
l_int|2
)paren
op_or
id|LOOPB_ON
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
id|AUDIO_MAX_GAIN
)paren
r_return
id|AUDIO_MAX_GAIN
suffix:semicolon
r_return
(paren
(paren
id|CS4231_MAX_DEV_ATEN
op_minus
id|a
)paren
op_star
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|CS4231_MAX_DEV_ATEN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Set chip record gain */
DECL|function|cs4231_record_gain
r_static
r_int
r_int
id|cs4231_record_gain
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
r_int
id|value
comma
r_int
r_char
id|balance
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|tmp
op_assign
l_int|0
comma
id|r
comma
id|l
comma
id|ra
comma
id|la
suffix:semicolon
r_int
r_char
id|old_gain
suffix:semicolon
id|r
op_assign
id|l
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|balance
OL
id|AUDIO_MID_BALANCE
)paren
(brace
id|r
op_assign
id|MAX
c_func
(paren
l_int|0
comma
(paren
r_int
)paren
(paren
id|value
op_minus
(paren
(paren
id|AUDIO_MID_BALANCE
op_minus
id|balance
)paren
op_lshift
id|AUDIO_BALANCE_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|balance
OG
id|AUDIO_MID_BALANCE
)paren
(brace
id|l
op_assign
id|MAX
c_func
(paren
l_int|0
comma
(paren
r_int
)paren
(paren
id|value
op_minus
(paren
(paren
id|balance
op_minus
id|AUDIO_MID_BALANCE
)paren
op_lshift
id|AUDIO_BALANCE_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
id|la
op_assign
id|l
op_star
(paren
id|CS4231_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
suffix:semicolon
id|ra
op_assign
id|r
op_star
(paren
id|CS4231_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x0
suffix:semicolon
id|old_gain
op_assign
id|cs4231_chip-&gt;pioregs-&gt;idr
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|RECGAIN_SET
c_func
(paren
id|old_gain
comma
id|la
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x1
suffix:semicolon
id|old_gain
op_assign
id|cs4231_chip-&gt;pioregs-&gt;idr
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|RECGAIN_SET
c_func
(paren
id|old_gain
comma
id|ra
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l
op_eq
id|value
)paren
(brace
(paren
id|l
op_eq
l_int|0
)paren
ques
c_cond
(paren
id|tmp
op_assign
l_int|0
)paren
suffix:colon
(paren
id|tmp
op_assign
(paren
(paren
id|la
op_plus
l_int|1
)paren
op_star
id|AUDIO_MAX_GAIN
)paren
op_div
(paren
id|CS4231_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|r
op_eq
id|value
)paren
(brace
(paren
id|r
op_eq
l_int|0
)paren
ques
c_cond
(paren
id|tmp
op_assign
l_int|0
)paren
suffix:colon
(paren
id|tmp
op_assign
(paren
(paren
id|ra
op_plus
l_int|1
)paren
op_star
id|AUDIO_MAX_GAIN
)paren
op_div
(paren
id|CS4231_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/* Set chip play gain */
DECL|function|cs4231_play_gain
r_static
r_int
r_int
id|cs4231_play_gain
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
r_int
id|value
comma
r_int
r_char
id|balance
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|tmp
op_assign
l_int|0
comma
id|r
comma
id|l
comma
id|ra
comma
id|la
suffix:semicolon
r_int
r_char
id|old_gain
suffix:semicolon
id|r
op_assign
id|l
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|balance
OL
id|AUDIO_MID_BALANCE
)paren
(brace
id|r
op_assign
id|MAX
c_func
(paren
l_int|0
comma
(paren
r_int
)paren
(paren
id|value
op_minus
(paren
(paren
id|AUDIO_MID_BALANCE
op_minus
id|balance
)paren
op_lshift
id|AUDIO_BALANCE_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|balance
OG
id|AUDIO_MID_BALANCE
)paren
(brace
id|l
op_assign
id|MAX
c_func
(paren
l_int|0
comma
(paren
r_int
)paren
(paren
id|value
op_minus
(paren
(paren
id|balance
op_minus
id|AUDIO_MID_BALANCE
)paren
op_lshift
id|AUDIO_BALANCE_SHIFT
)paren
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|l
op_eq
l_int|0
)paren
(brace
id|la
op_assign
id|CS4231_MAX_DEV_ATEN
suffix:semicolon
)brace
r_else
(brace
id|la
op_assign
id|CS4231_MAX_ATEN
op_minus
(paren
id|l
op_star
(paren
id|CS4231_MAX_ATEN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r
op_eq
l_int|0
)paren
(brace
id|ra
op_assign
id|CS4231_MAX_DEV_ATEN
suffix:semicolon
)brace
r_else
(brace
id|ra
op_assign
id|CS4231_MAX_ATEN
op_minus
(paren
id|r
op_star
(paren
id|CS4231_MAX_ATEN
op_plus
l_int|1
)paren
op_div
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x6
suffix:semicolon
id|old_gain
op_assign
id|cs4231_chip-&gt;pioregs-&gt;idr
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|GAIN_SET
c_func
(paren
id|old_gain
comma
id|la
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x7
suffix:semicolon
id|old_gain
op_assign
id|cs4231_chip-&gt;pioregs-&gt;idr
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|GAIN_SET
c_func
(paren
id|old_gain
comma
id|ra
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value
op_eq
l_int|0
)paren
op_logical_or
(paren
id|value
op_eq
id|AUDIO_MAX_GAIN
)paren
)paren
(brace
id|tmp
op_assign
id|value
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|l
op_eq
id|value
)paren
(brace
id|tmp
op_assign
(paren
(paren
id|CS4231_MAX_ATEN
op_minus
id|la
)paren
op_star
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|CS4231_MAX_ATEN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|r
op_eq
id|value
)paren
(brace
id|tmp
op_assign
(paren
(paren
id|CS4231_MAX_ATEN
op_minus
id|ra
)paren
op_star
(paren
id|AUDIO_MAX_GAIN
op_plus
l_int|1
)paren
op_div
(paren
id|CS4231_MAX_ATEN
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset the audio chip to a sane state. */
DECL|function|cs4231_reset
r_static
r_void
id|cs4231_reset
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_assign
id|CS_CHIP_RESET
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_assign
l_int|0x00
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_or_assign
id|CS_CDC_RESET
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_and_assign
op_complement
(paren
id|CS_CDC_RESET
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_or_assign
id|IAR_AUTOCAL_BEGIN
suffix:semicolon
id|CHIP_BUG
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x0c
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|MISC_IR_MODE2
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x08
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
multiline_comment|/* Ulaw */
id|CHIP_BUG
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x1c
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
multiline_comment|/* Ulaw */
id|CHIP_BUG
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x19
suffix:semicolon
multiline_comment|/* see what we can turn on */
r_if
c_cond
(paren
id|cs4231_chip-&gt;pioregs-&gt;idr
op_amp
id|CS4231A
)paren
id|cs4231_chip-&gt;status
op_or_assign
id|CS_STATUS_REV_A
suffix:semicolon
r_else
id|cs4231_chip-&gt;status
op_and_assign
op_complement
id|CS_STATUS_REV_A
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x10
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|OLB_ENABLE
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x11
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_chip-&gt;status
op_amp
id|CS_STATUS_REV_A
)paren
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
(paren
id|HPF_ON
op_or
id|XTALE_ON
)paren
suffix:semicolon
r_else
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
(paren
id|HPF_ON
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x1a
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Now set things up for defaults */
id|cs4231_chip-&gt;perchip_info.play.port
op_assign
id|cs4231_out_port
c_func
(paren
id|drv
comma
id|AUDIO_SPEAKER
)paren
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.record.port
op_assign
id|cs4231_in_port
c_func
(paren
id|drv
comma
id|AUDIO_MICROPHONE
)paren
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.play.gain
op_assign
id|cs4231_play_gain
c_func
(paren
id|drv
comma
id|CS4231_DEFAULT_PLAYGAIN
comma
id|AUDIO_MID_BALANCE
)paren
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.record.gain
op_assign
id|cs4231_record_gain
c_func
(paren
id|drv
comma
id|CS4231_DEFAULT_RECGAIN
comma
id|AUDIO_MID_BALANCE
)paren
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.monitor_gain
op_assign
id|cs4231_monitor_gain
c_func
(paren
id|drv
comma
id|LOOPB_OFF
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
(paren
id|u_char
)paren
id|IAR_AUTOCAL_END
suffix:semicolon
id|cs4231_ready
c_func
(paren
id|drv
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x09
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_and_assign
id|ACAL_DISABLE
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
(paren
id|u_char
)paren
id|IAR_AUTOCAL_END
suffix:semicolon
id|cs4231_ready
c_func
(paren
id|drv
)paren
suffix:semicolon
id|cs4231_output_muted
c_func
(paren
id|drv
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|cs4231_mute
r_static
r_void
id|cs4231_mute
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cs4231_chip-&gt;status
op_amp
id|CS_STATUS_REV_A
)paren
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_END
suffix:semicolon
id|CHIP_BUG
)brace
)brace
multiline_comment|/* Not yet useful */
macro_line|#if 0
r_static
r_int
id|cs4231_len_to_sample
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|length
comma
r_int
id|direction
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|sample
suffix:semicolon
r_if
c_cond
(paren
multiline_comment|/* number of channels == 2*/
l_int|0
)paren
(brace
id|sample
op_assign
(paren
id|length
op_div
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|sample
op_assign
id|length
suffix:semicolon
)brace
r_if
c_cond
(paren
multiline_comment|/*encoding == AUDIO_ENCODING_LINEAR*/
l_int|0
)paren
(brace
id|sample
op_assign
id|sample
op_div
l_int|2
suffix:semicolon
)brace
r_return
(paren
id|sample
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|cs4231_open
r_static
r_int
id|cs4231_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
multiline_comment|/* Set the default audio parameters. */
id|cs4231_chip-&gt;perchip_info.play.sample_rate
op_assign
id|CS4231_RATE
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.play.channels
op_assign
id|CS4231_CHANNELS
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.play.precision
op_assign
id|CS4231_PRECISION
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.play.encoding
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.record.sample_rate
op_assign
id|CS4231_RATE
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.record.channels
op_assign
id|CS4231_CHANNELS
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.record.precision
op_assign
id|CS4231_PRECISION
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.record.encoding
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|cs4231_ready
c_func
(paren
id|drv
)paren
suffix:semicolon
id|cs4231_chip-&gt;status
op_or_assign
id|CS_STATUS_NEED_INIT
suffix:semicolon
id|CHIP_BUG
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cs4231_release
r_static
r_void
id|cs4231_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
multiline_comment|/* zero out any info about what data we have as well */
multiline_comment|/* should insert init on close variable optionally calling cs4231_reset() */
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|cs4231_playintr
r_static
r_int
id|cs4231_playintr
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
multiline_comment|/* Send the next byte of outgoing data. */
macro_line|#if 0
r_if
c_cond
(paren
id|cs4231_chip-&gt;output_ptr
op_logical_and
id|cs4231_chip-&gt;output_count
OG
l_int|0
)paren
(brace
id|cs4231_chip-&gt;dmaregs.dmapnva
op_assign
id|dma_handle
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmapnc
op_assign
id|length
suffix:semicolon
id|cs4231_chip-&gt;output_ptr
op_increment
suffix:semicolon
id|cs4231_chip-&gt;output_count
op_decrement
suffix:semicolon
multiline_comment|/* Done with the buffer? Notify the midlevel driver. */
r_if
c_cond
(paren
id|cs4231_chip-&gt;output_count
op_eq
l_int|0
)paren
(brace
id|cs4231_chip-&gt;output_ptr
op_assign
l_int|NULL
suffix:semicolon
id|cs4231_chip-&gt;output_count
op_assign
l_int|0
suffix:semicolon
id|sparcaudio_output_done
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
DECL|function|cs4231_recmute
r_static
r_void
id|cs4231_recmute
c_func
(paren
r_int
id|fmt
)paren
(brace
r_switch
c_cond
(paren
id|fmt
)paren
(brace
r_case
id|AUDIO_ENCODING_LINEAR
suffix:colon
multiline_comment|/* Insert 0x00 from &quot;here&quot; to end of data stream */
r_break
suffix:semicolon
r_case
id|AUDIO_ENCODING_ALAW
suffix:colon
multiline_comment|/* Insert 0xd5 from &quot;here&quot; to end of data stream */
r_break
suffix:semicolon
r_case
id|AUDIO_ENCODING_ULAW
suffix:colon
multiline_comment|/* Insert 0xff from &quot;here&quot; to end of data stream */
r_break
suffix:semicolon
)brace
)brace
DECL|function|cs4231_recintr
r_static
r_int
id|cs4231_recintr
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|cs4231_recmute
c_func
(paren
id|cs4231_chip-&gt;perchip_info.record.encoding
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_chip-&gt;perchip_info.record.active
op_eq
l_int|0
)paren
(brace
id|cs4231_pollinput
c_func
(paren
id|drv
)paren
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x9
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_and_assign
id|CEN_DISABLE
suffix:semicolon
)brace
multiline_comment|/* Read the next byte of incoming data. */
macro_line|#if 0
r_if
c_cond
(paren
id|cs4231_chip-&gt;input_ptr
op_logical_and
id|cs4231_chip-&gt;input_count
OG
l_int|0
)paren
(brace
id|cs4231_chip-&gt;dmaregs.dmacnva
op_assign
id|dma_handle
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacnc
op_assign
id|length
suffix:semicolon
id|cs4231_chip-&gt;input_ptr
op_increment
suffix:semicolon
id|cs4231_chip-&gt;input_count
op_decrement
suffix:semicolon
multiline_comment|/* Done with the buffer? Notify the midlevel driver. */
r_if
c_cond
(paren
id|cs4231_chip-&gt;input_count
op_eq
l_int|0
)paren
(brace
id|cs4231_chip-&gt;input_ptr
op_assign
l_int|NULL
suffix:semicolon
id|cs4231_chip-&gt;input_count
op_assign
l_int|0
suffix:semicolon
id|sparcaudio_input_done
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
DECL|function|cs4231_start_output
r_static
r_void
id|cs4231_start_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_chip-&gt;perchip_info.play.active
op_logical_or
(paren
id|cs4231_chip-&gt;perchip_info.play.pause
)paren
)paren
r_return
suffix:semicolon
id|cs4231_ready
c_func
(paren
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_chip-&gt;status
op_amp
id|CS_STATUS_NEED_INIT
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x08
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x1c
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
id|CHIP_BUG
id|cs4231_chip-&gt;status
op_and_assign
op_complement
id|CS_STATUS_NEED_INIT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cs4231_chip-&gt;perchip_info.play.pause
)paren
(brace
multiline_comment|/* init dma foo here */
id|cs4231_chip-&gt;dmaregs.dmacsr
op_and_assign
op_complement
id|CS_XINT_PLAY
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_and_assign
op_complement
id|CS_PPAUSE
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_playintr
c_func
(paren
id|drv
)paren
)paren
(brace
id|cs4231_chip-&gt;dmaregs.dmacsr
op_or_assign
id|CS_PLAY_SETUP
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x9
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_or_assign
id|PEN_ENABLE
suffix:semicolon
)brace
)brace
id|cs4231_chip-&gt;perchip_info.play.active
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|cs4231_stop_output
r_static
r_void
id|cs4231_stop_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.play.active
op_assign
l_int|0
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_or_assign
(paren
id|CS_PPAUSE
)paren
suffix:semicolon
)brace
DECL|function|cs4231_pollinput
r_static
r_void
id|cs4231_pollinput
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|x
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|cs4231_chip-&gt;dmaregs.dmacsr
op_amp
id|CS_XINT_COVF
)paren
op_logical_and
id|x
op_le
id|CS_TIMEOUT
)paren
(brace
id|x
op_increment
suffix:semicolon
)brace
id|cs4231_chip-&gt;dmaregs.dmacsr
op_or_assign
id|CS_XINT_CEMP
suffix:semicolon
)brace
DECL|function|cs4231_start_input
r_static
r_void
id|cs4231_start_input
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_chip-&gt;perchip_info.record.active
op_logical_or
(paren
id|cs4231_chip-&gt;perchip_info.record.pause
)paren
)paren
r_return
suffix:semicolon
id|cs4231_ready
c_func
(paren
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_chip-&gt;status
op_amp
id|CS_STATUS_NEED_INIT
)paren
(brace
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x08
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
id|IAR_AUTOCAL_BEGIN
op_or
l_int|0x1c
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_assign
id|DEFAULT_DATA_FMAT
suffix:semicolon
id|CHIP_BUG
id|cs4231_chip-&gt;status
op_and_assign
op_complement
id|CS_STATUS_NEED_INIT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cs4231_chip-&gt;perchip_info.record.pause
)paren
(brace
multiline_comment|/* init dma foo here */
id|cs4231_chip-&gt;dmaregs.dmacsr
op_and_assign
op_complement
id|CS_XINT_CAPT
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_and_assign
op_complement
id|CS_CPAUSE
suffix:semicolon
id|cs4231_recintr
c_func
(paren
id|drv
)paren
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_or_assign
id|CS_CAPT_SETUP
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x9
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_or_assign
id|CEN_ENABLE
suffix:semicolon
)brace
id|cs4231_chip-&gt;perchip_info.record.active
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|cs4231_stop_input
r_static
r_void
id|cs4231_stop_input
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|cs4231_chip-&gt;perchip_info.record.active
op_assign
l_int|0
suffix:semicolon
id|cs4231_chip-&gt;dmaregs.dmacsr
op_or_assign
(paren
id|CS_CPAUSE
)paren
suffix:semicolon
id|cs4231_pollinput
c_func
(paren
id|drv
)paren
suffix:semicolon
multiline_comment|/* need adjust the end pointer, process the input, and clean up the dma */
id|cs4231_chip-&gt;pioregs-&gt;iar
op_assign
l_int|0x09
suffix:semicolon
id|cs4231_chip-&gt;pioregs-&gt;idr
op_and_assign
id|CEN_DISABLE
suffix:semicolon
)brace
DECL|function|cs4231_audio_getdev
r_static
r_void
id|cs4231_audio_getdev
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|audio_device_t
op_star
id|audinfo
)paren
(brace
id|strncpy
c_func
(paren
id|audinfo-&gt;name
comma
l_string|&quot;cs4231&quot;
comma
r_sizeof
(paren
id|audinfo-&gt;name
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|audinfo-&gt;version
comma
l_string|&quot;x&quot;
comma
r_sizeof
(paren
id|audinfo-&gt;version
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|audinfo-&gt;config
comma
l_string|&quot;audio&quot;
comma
r_sizeof
(paren
id|audinfo-&gt;config
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* The ioctl handler should be expected to identify itself and handle loopback&n;   mode */
multiline_comment|/* There will also be a handler for getinfo and setinfo */
DECL|variable|cs4231_ops
r_static
r_struct
id|sparcaudio_operations
id|cs4231_ops
op_assign
(brace
id|cs4231_open
comma
id|cs4231_release
comma
l_int|NULL
comma
multiline_comment|/* cs4231_ioctl */
id|cs4231_start_output
comma
id|cs4231_stop_output
comma
id|cs4231_start_input
comma
id|cs4231_stop_input
comma
id|cs4231_audio_getdev
comma
)brace
suffix:semicolon
multiline_comment|/* Probe for the cs4231 chip and then attach the driver. */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_int
id|cs4231_init
c_func
(paren
r_void
)paren
)paren
macro_line|#endif
(brace
r_struct
id|linux_sbus
op_star
id|bus
suffix:semicolon
r_struct
id|linux_sbus_device
op_star
id|sdev
suffix:semicolon
r_int
id|cs4231_node
suffix:semicolon
multiline_comment|/* Find the PROM CS4231 node. */
multiline_comment|/* There&squot;s an easier way, and I should FIXME */
id|cs4231_node
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_searchsiblings
c_func
(paren
id|cs4231_node
comma
l_string|&quot;iommu&quot;
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_getchild
c_func
(paren
id|cs4231_node
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_searchsiblings
c_func
(paren
id|cs4231_node
comma
l_string|&quot;sbus&quot;
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_getchild
c_func
(paren
id|cs4231_node
)paren
suffix:semicolon
id|cs4231_node
op_assign
id|prom_searchsiblings
c_func
(paren
id|cs4231_node
comma
l_string|&quot;SUNW,CS4231&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_node
op_logical_and
id|cs4231_attach
c_func
(paren
op_amp
id|drivers
(braket
l_int|0
)braket
comma
id|cs4231_node
comma
l_int|NULL
)paren
op_eq
l_int|0
)paren
id|num_drivers
op_assign
l_int|1
suffix:semicolon
r_else
id|num_drivers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Probe each SBUS for cs4231 chips. */
id|for_all_sbusdev
c_func
(paren
id|sdev
comma
id|bus
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;SUNW,CS4231&quot;
)paren
)paren
(brace
multiline_comment|/* Don&squot;t go over the max number of drivers. */
r_if
c_cond
(paren
id|num_drivers
op_ge
id|MAX_DRIVERS
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|cs4231_attach
c_func
(paren
op_amp
id|drivers
(braket
id|num_drivers
)braket
comma
id|sdev-&gt;prom_node
comma
id|sdev-&gt;my_bus
)paren
op_eq
l_int|0
)paren
id|num_drivers
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Only return success if we found some cs4231 chips. */
r_return
(paren
id|num_drivers
OG
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Attach to an cs4231 chip given its PROM node. */
DECL|function|cs4231_attach
r_static
r_int
id|cs4231_attach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|node
comma
r_struct
id|linux_sbus
op_star
id|sbus
)paren
(brace
r_struct
id|linux_prom_registers
id|regs
suffix:semicolon
r_struct
id|linux_prom_irqs
id|irq
suffix:semicolon
r_struct
id|cs4231_chip
op_star
id|cs4231_chip
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Allocate our private information structure. */
id|drv
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|cs4231_chip
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drv
op_member_access_from_pointer
r_private
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Point at the information structure and initialize it. */
id|drv-&gt;ops
op_assign
op_amp
id|cs4231_ops
suffix:semicolon
id|cs4231_chip
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
macro_line|#if 0
id|cs4231_chip-&gt;input_ptr
op_assign
l_int|NULL
suffix:semicolon
id|cs4231_chip-&gt;input_count
op_assign
l_int|0
suffix:semicolon
id|cs4231_chip-&gt;output_ptr
op_assign
l_int|NULL
suffix:semicolon
id|cs4231_chip-&gt;output_count
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Map the registers into memory. */
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbus
)paren
id|prom_apply_sbus_ranges
c_func
(paren
id|sbus
comma
op_amp
id|regs
comma
l_int|1
)paren
suffix:semicolon
id|cs4231_chip-&gt;regs_size
op_assign
id|regs.reg_size
suffix:semicolon
id|cs4231_chip-&gt;pioregs
op_assign
id|sparc_alloc_io
c_func
(paren
id|regs.phys_addr
comma
l_int|0
comma
id|regs.reg_size
comma
l_string|&quot;cs4231&quot;
comma
id|regs.which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs4231_chip-&gt;pioregs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cs4231: could not allocate registers&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Reset the audio chip. */
id|cs4231_reset
c_func
(paren
id|drv
)paren
suffix:semicolon
multiline_comment|/* Attach the interrupt handler to the audio interrupt. */
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;intr&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irq
comma
r_sizeof
(paren
id|irq
)paren
)paren
suffix:semicolon
id|cs4231_chip-&gt;irq
op_assign
id|irq.pri
suffix:semicolon
id|request_irq
c_func
(paren
id|cs4231_chip-&gt;irq
comma
id|cs4231_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;cs4231&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|cs4231_chip-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Register ourselves with the midlevel audio driver. */
id|err
op_assign
id|register_sparcaudio_driver
c_func
(paren
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cs4231: unable to register&bslash;n&quot;
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|cs4231_chip-&gt;irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|cs4231_chip-&gt;irq
comma
id|drv
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|cs4231_chip-&gt;pioregs
comma
id|cs4231_chip-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Announce the hardware to the user. */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cs4231 at 0x%lx irq %d&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|cs4231_chip-&gt;pioregs
comma
id|cs4231_chip-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Success! */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* Detach from an cs4231 chip given the device structure. */
DECL|function|cs4231_detach
r_static
r_void
id|cs4231_detach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|cs4231_chip
op_star
id|info
op_assign
(paren
r_struct
id|cs4231_chip
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|unregister_sparcaudio_driver
c_func
(paren
id|drv
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|info-&gt;irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|info-&gt;irq
comma
id|drv
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|info-&gt;pioregs
comma
id|info-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_drivers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cs4231_detach
c_func
(paren
op_amp
id|drivers
(braket
id|i
)braket
)paren
suffix:semicolon
id|num_drivers
op_decrement
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
