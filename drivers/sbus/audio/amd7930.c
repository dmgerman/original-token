multiline_comment|/* $Id: amd7930.c,v 1.24 2000/01/22 05:10:27 anton Exp $&n; * drivers/sbus/audio/amd7930.c&n; *&n; * Copyright (C) 1996,1997 Thomas K. Dyas (tdyas@eden.rutgers.edu)&n; *&n; * This is the lowlevel driver for the AMD7930 audio chip found on all&n; * sun4c machines and some sun4m machines.&n; *&n; * The amd7930 is actually an ISDN chip which has a very simple&n; * integrated audio encoder/decoder. When Sun decided on what chip to&n; * use for audio, they had the brilliant idea of using the amd7930 and&n; * only connecting the audio encoder/decoder pins.&n; *&n; * Thanks to the AMD engineer who was able to get us the AMD79C30&n; * databook which has all the programming information and gain tables.&n; *&n; * Advanced Micro Devices&squot; Am79C30A is an ISDN/audio chip used in the&n; * SparcStation 1+.  The chip provides microphone and speaker interfaces&n; * which provide mono-channel audio at 8K samples per second via either&n; * 8-bit A-law or 8-bit mu-law encoding.  Also, the chip features an&n; * ISDN BRI Line Interface Unit (LIU), I.430 S/T physical interface,&n; * which performs basic D channel LAPD processing and provides raw&n; * B channel data.  The digital audio channel, the two ISDN B channels,&n; * and two 64 Kbps channels to the microprocessor are all interconnected&n; * via a multiplexer.&n; *&n; * This driver interfaces to the Linux HiSax ISDN driver, which performs&n; * all high-level Q.921 and Q.931 ISDN functions.  The file is not&n; * itself a hardware driver; rather it uses functions exported by&n; * the AMD7930 driver in the sparcaudio subsystem (drivers/sbus/audio),&n; * allowing the chip to be simultaneously used for both audio and ISDN data.&n; * The hardware driver does _no_ buffering, but provides several callbacks&n; * which are called during interrupt service and should therefore run quickly.&n; *&n; * D channel transmission is performed by passing the hardware driver the&n; * address and size of an skb&squot;s data area, then waiting for a callback&n; * to signal successful transmission of the packet.  A task is then&n; * queued to notify the HiSax driver that another packet may be transmitted.&n; *&n; * D channel reception is quite simple, mainly because of:&n; *   1) the slow speed of the D channel - 16 kbps, and&n; *   2) the presence of an 8- or 32-byte (depending on chip version) FIFO&n; *      to buffer the D channel data on the chip&n; * Worst case scenario of back-to-back packets with the 8 byte buffer&n; * at 16 kbps yields an service time of 4 ms - long enough to preclude&n; * the need for fancy buffering.  We queue a background task that copies&n; * data out of the receive buffer into an skb, and the hardware driver&n; * simply does nothing until we&squot;re done with the receive buffer and&n; * reset it for a new packet.&n; *&n; * B channel processing is more complex, because of:&n; *   1) the faster speed - 64 kbps,&n; *   2) the lack of any on-chip buffering (it interrupts for every byte), and&n; *   3) the lack of any chip support for HDLC encapsulation&n; *&n; * The HiSax driver can put each B channel into one of three modes -&n; * L1_MODE_NULL (channel disabled), L1_MODE_TRANS (transparent data relay),&n; * and L1_MODE_HDLC (HDLC encapsulation by low-level driver).&n; * L1_MODE_HDLC is the most common, used for almost all &quot;pure&quot; digital&n; * data sessions.  L1_MODE_TRANS is used for ISDN audio.&n; *&n; * HDLC B channel transmission is performed via a large buffer into&n; * which the skb is copied while performing HDLC bit-stuffing.  A CRC&n; * is computed and attached to the end of the buffer, which is then&n; * passed to the low-level routines for raw transmission.  Once&n; * transmission is complete, the hardware driver is set to enter HDLC&n; * idle by successive transmission of mark (all 1) bytes, waiting for&n; * the ISDN driver to prepare another packet for transmission and&n; * deliver it.&n; *&n; * HDLC B channel reception is performed via an X-byte ring buffer&n; * divided into N sections of X/N bytes each.  Defaults: X=256 bytes, N=4.&n; * As the hardware driver notifies us that each section is full, we&n; * hand it the next section and schedule a background task to peruse&n; * the received section, bit-by-bit, with an HDLC decoder.  As&n; * packets are detected, they are copied into a large buffer while&n; * decoding HDLC bit-stuffing.  The ending CRC is verified, and if&n; * it is correct, we alloc a new skb of the correct length (which we&n; * now know), copy the packet into it, and hand it to the upper layers.&n; * Optimization: for large packets, we hand the buffer (which also&n; * happens to be an skb) directly to the upper layer after an skb_trim,&n; * and alloc a new large buffer for future packets, thus avoiding a copy.&n; * Then we return to HDLC processing; state is saved between calls.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/audioio.h&gt;
macro_line|#include &quot;amd7930.h&quot;
r_static
id|__u8
id|bilinear2mulaw
c_func
(paren
id|__u8
id|data
)paren
suffix:semicolon
r_static
id|__u8
id|mulaw2bilinear
c_func
(paren
id|__u8
id|data
)paren
suffix:semicolon
r_static
id|__u8
id|linear2mulaw
c_func
(paren
id|__u16
id|data
)paren
suffix:semicolon
r_static
id|__u16
id|mulaw2linear
c_func
(paren
id|__u8
id|data
)paren
suffix:semicolon
macro_line|#if defined (AMD79C30_ISDN) || defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x200ff 
macro_line|#include &quot;../../isdn/hisax/hisax.h&quot;
macro_line|#include &quot;../../isdn/hisax/isdnl1.h&quot;
macro_line|#include &quot;../../isdn/hisax/foreign.h&quot;
macro_line|#endif
DECL|macro|MAX_DRIVERS
mdefine_line|#define MAX_DRIVERS 1
DECL|variable|drivers
r_static
r_struct
id|sparcaudio_driver
id|drivers
(braket
id|MAX_DRIVERS
)braket
suffix:semicolon
DECL|variable|num_drivers
r_static
r_int
id|num_drivers
suffix:semicolon
multiline_comment|/* Each amd7930 chip has two bi-directional B channels and a D&n; * channel available to the uproc.  This structure handles all&n; * the buffering needed to transmit and receive via a single channel.&n; */
DECL|macro|CHANNEL_AVAILABLE
mdefine_line|#define CHANNEL_AVAILABLE&t;0x00
DECL|macro|CHANNEL_INUSE_AUDIO_IN
mdefine_line|#define CHANNEL_INUSE_AUDIO_IN&t;0x01
DECL|macro|CHANNEL_INUSE_AUDIO_OUT
mdefine_line|#define CHANNEL_INUSE_AUDIO_OUT&t;0x02
DECL|macro|CHANNEL_INUSE_ISDN_B1
mdefine_line|#define CHANNEL_INUSE_ISDN_B1&t;0x04
DECL|macro|CHANNEL_INUSE_ISDN_B2
mdefine_line|#define CHANNEL_INUSE_ISDN_B2&t;0x08
DECL|macro|CHANNEL_INUSE
mdefine_line|#define CHANNEL_INUSE&t;&t;0xff
DECL|struct|amd7930_channel
r_struct
id|amd7930_channel
(brace
multiline_comment|/* Channel status */
DECL|member|channel_status
id|u8
id|channel_status
suffix:semicolon
multiline_comment|/* Current buffer that the driver is playing on channel */
DECL|member|output_ptr
r_volatile
id|__u8
op_star
id|output_ptr
suffix:semicolon
DECL|member|output_count
r_volatile
id|u32
id|output_count
suffix:semicolon
DECL|member|xmit_idle_char
id|u8
id|xmit_idle_char
suffix:semicolon
multiline_comment|/* Callback routine (and argument) when output is done on */
DECL|member|output_callback
r_void
(paren
op_star
id|output_callback
)paren
(paren
r_void
op_star
comma
r_int
r_char
)paren
suffix:semicolon
DECL|member|output_callback_arg
r_void
op_star
id|output_callback_arg
suffix:semicolon
multiline_comment|/* Current buffer that the driver is recording on channel */
DECL|member|input_ptr
r_volatile
id|__u8
op_star
id|input_ptr
suffix:semicolon
DECL|member|input_count
r_volatile
id|u32
id|input_count
suffix:semicolon
DECL|member|input_limit
r_volatile
id|u32
id|input_limit
suffix:semicolon
multiline_comment|/* Callback routine (and argument) when input is done on */
DECL|member|input_callback
r_void
(paren
op_star
id|input_callback
)paren
(paren
r_void
op_star
comma
r_int
r_char
comma
r_int
r_int
)paren
suffix:semicolon
DECL|member|input_callback_arg
r_void
op_star
id|input_callback_arg
suffix:semicolon
DECL|member|input_format
r_int
id|input_format
suffix:semicolon
DECL|member|output_format
r_int
id|output_format
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Private information we store for each amd7930 chip. */
DECL|struct|amd7930_info
r_struct
id|amd7930_info
(brace
DECL|member|D
r_struct
id|amd7930_channel
id|D
suffix:semicolon
DECL|member|Bb
r_struct
id|amd7930_channel
id|Bb
suffix:semicolon
DECL|member|Bc
r_struct
id|amd7930_channel
id|Bc
suffix:semicolon
multiline_comment|/* Pointers to which B channels are being used for what&n;&t; * These three fields (Baudio, Bisdn[0], and Bisdn[1]) will either&n;&t; * be NULL or point to one of the Bb/Bc structures above.&n;&t; */
DECL|member|Baudio
r_struct
id|amd7930_channel
op_star
id|Baudio
suffix:semicolon
DECL|member|Bisdn
r_struct
id|amd7930_channel
op_star
id|Bisdn
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Device registers information. */
DECL|member|regs
r_int
r_int
id|regs
suffix:semicolon
DECL|member|regs_size
r_int
r_int
id|regs_size
suffix:semicolon
DECL|member|map
r_struct
id|amd7930_map
id|map
suffix:semicolon
multiline_comment|/* Volume information. */
DECL|member|pgain
DECL|member|rgain
DECL|member|mgain
r_int
id|pgain
comma
id|rgain
comma
id|mgain
suffix:semicolon
multiline_comment|/* Device interrupt information. */
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|ints_on
r_volatile
r_int
id|ints_on
suffix:semicolon
multiline_comment|/* Format type */
DECL|member|format_type
r_int
id|format_type
suffix:semicolon
multiline_comment|/* Someone to signal when the ISDN LIU state changes */
DECL|member|liu_state
r_int
id|liu_state
suffix:semicolon
DECL|member|liu_callback
r_void
(paren
op_star
id|liu_callback
)paren
(paren
r_void
op_star
)paren
suffix:semicolon
DECL|member|liu_callback_arg
r_void
op_star
id|liu_callback_arg
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Output a 16-bit quantity in the order that the amd7930 expects. */
DECL|function|amd7930_out16
r_static
id|__inline__
r_void
id|amd7930_out16
c_func
(paren
r_int
r_int
id|regs
comma
id|u16
id|val
)paren
(brace
id|sbus_writeb
c_func
(paren
id|val
op_amp
l_int|0xff
comma
id|regs
op_plus
id|DR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|val
op_rshift
l_int|8
comma
id|regs
op_plus
id|DR
)paren
suffix:semicolon
)brace
multiline_comment|/* gx, gr &amp; stg gains.  this table must contain 256 elements with&n; * the 0th being &quot;infinity&quot; (the magic value 9008).  The remaining&n; * elements match sun&squot;s gain curve (but with higher resolution):&n; * -18 to 0dB in .16dB steps then 0 to 12dB in .08dB steps.&n; */
DECL|variable|gx_coeff
r_static
id|__const__
id|__u16
id|gx_coeff
(braket
l_int|256
)braket
op_assign
(brace
l_int|0x9008
comma
l_int|0x8b7c
comma
l_int|0x8b51
comma
l_int|0x8b45
comma
l_int|0x8b42
comma
l_int|0x8b3b
comma
l_int|0x8b36
comma
l_int|0x8b33
comma
l_int|0x8b32
comma
l_int|0x8b2a
comma
l_int|0x8b2b
comma
l_int|0x8b2c
comma
l_int|0x8b25
comma
l_int|0x8b23
comma
l_int|0x8b22
comma
l_int|0x8b22
comma
l_int|0x9122
comma
l_int|0x8b1a
comma
l_int|0x8aa3
comma
l_int|0x8aa3
comma
l_int|0x8b1c
comma
l_int|0x8aa6
comma
l_int|0x912d
comma
l_int|0x912b
comma
l_int|0x8aab
comma
l_int|0x8b12
comma
l_int|0x8aaa
comma
l_int|0x8ab2
comma
l_int|0x9132
comma
l_int|0x8ab4
comma
l_int|0x913c
comma
l_int|0x8abb
comma
l_int|0x9142
comma
l_int|0x9144
comma
l_int|0x9151
comma
l_int|0x8ad5
comma
l_int|0x8aeb
comma
l_int|0x8a79
comma
l_int|0x8a5a
comma
l_int|0x8a4a
comma
l_int|0x8b03
comma
l_int|0x91c2
comma
l_int|0x91bb
comma
l_int|0x8a3f
comma
l_int|0x8a33
comma
l_int|0x91b2
comma
l_int|0x9212
comma
l_int|0x9213
comma
l_int|0x8a2c
comma
l_int|0x921d
comma
l_int|0x8a23
comma
l_int|0x921a
comma
l_int|0x9222
comma
l_int|0x9223
comma
l_int|0x922d
comma
l_int|0x9231
comma
l_int|0x9234
comma
l_int|0x9242
comma
l_int|0x925b
comma
l_int|0x92dd
comma
l_int|0x92c1
comma
l_int|0x92b3
comma
l_int|0x92ab
comma
l_int|0x92a4
comma
l_int|0x92a2
comma
l_int|0x932b
comma
l_int|0x9341
comma
l_int|0x93d3
comma
l_int|0x93b2
comma
l_int|0x93a2
comma
l_int|0x943c
comma
l_int|0x94b2
comma
l_int|0x953a
comma
l_int|0x9653
comma
l_int|0x9782
comma
l_int|0x9e21
comma
l_int|0x9d23
comma
l_int|0x9cd2
comma
l_int|0x9c23
comma
l_int|0x9baa
comma
l_int|0x9bde
comma
l_int|0x9b33
comma
l_int|0x9b22
comma
l_int|0x9b1d
comma
l_int|0x9ab2
comma
l_int|0xa142
comma
l_int|0xa1e5
comma
l_int|0x9a3b
comma
l_int|0xa213
comma
l_int|0xa1a2
comma
l_int|0xa231
comma
l_int|0xa2eb
comma
l_int|0xa313
comma
l_int|0xa334
comma
l_int|0xa421
comma
l_int|0xa54b
comma
l_int|0xada4
comma
l_int|0xac23
comma
l_int|0xab3b
comma
l_int|0xaaab
comma
l_int|0xaa5c
comma
l_int|0xb1a3
comma
l_int|0xb2ca
comma
l_int|0xb3bd
comma
l_int|0xbe24
comma
l_int|0xbb2b
comma
l_int|0xba33
comma
l_int|0xc32b
comma
l_int|0xcb5a
comma
l_int|0xd2a2
comma
l_int|0xe31d
comma
l_int|0x0808
comma
l_int|0x72ba
comma
l_int|0x62c2
comma
l_int|0x5c32
comma
l_int|0x52db
comma
l_int|0x513e
comma
l_int|0x4cce
comma
l_int|0x43b2
comma
l_int|0x4243
comma
l_int|0x41b4
comma
l_int|0x3b12
comma
l_int|0x3bc3
comma
l_int|0x3df2
comma
l_int|0x34bd
comma
l_int|0x3334
comma
l_int|0x32c2
comma
l_int|0x3224
comma
l_int|0x31aa
comma
l_int|0x2a7b
comma
l_int|0x2aaa
comma
l_int|0x2b23
comma
l_int|0x2bba
comma
l_int|0x2c42
comma
l_int|0x2e23
comma
l_int|0x25bb
comma
l_int|0x242b
comma
l_int|0x240f
comma
l_int|0x231a
comma
l_int|0x22bb
comma
l_int|0x2241
comma
l_int|0x2223
comma
l_int|0x221f
comma
l_int|0x1a33
comma
l_int|0x1a4a
comma
l_int|0x1acd
comma
l_int|0x2132
comma
l_int|0x1b1b
comma
l_int|0x1b2c
comma
l_int|0x1b62
comma
l_int|0x1c12
comma
l_int|0x1c32
comma
l_int|0x1d1b
comma
l_int|0x1e71
comma
l_int|0x16b1
comma
l_int|0x1522
comma
l_int|0x1434
comma
l_int|0x1412
comma
l_int|0x1352
comma
l_int|0x1323
comma
l_int|0x1315
comma
l_int|0x12bc
comma
l_int|0x127a
comma
l_int|0x1235
comma
l_int|0x1226
comma
l_int|0x11a2
comma
l_int|0x1216
comma
l_int|0x0a2a
comma
l_int|0x11bc
comma
l_int|0x11d1
comma
l_int|0x1163
comma
l_int|0x0ac2
comma
l_int|0x0ab2
comma
l_int|0x0aab
comma
l_int|0x0b1b
comma
l_int|0x0b23
comma
l_int|0x0b33
comma
l_int|0x0c0f
comma
l_int|0x0bb3
comma
l_int|0x0c1b
comma
l_int|0x0c3e
comma
l_int|0x0cb1
comma
l_int|0x0d4c
comma
l_int|0x0ec1
comma
l_int|0x079a
comma
l_int|0x0614
comma
l_int|0x0521
comma
l_int|0x047c
comma
l_int|0x0422
comma
l_int|0x03b1
comma
l_int|0x03e3
comma
l_int|0x0333
comma
l_int|0x0322
comma
l_int|0x031c
comma
l_int|0x02aa
comma
l_int|0x02ba
comma
l_int|0x02f2
comma
l_int|0x0242
comma
l_int|0x0232
comma
l_int|0x0227
comma
l_int|0x0222
comma
l_int|0x021b
comma
l_int|0x01ad
comma
l_int|0x0212
comma
l_int|0x01b2
comma
l_int|0x01bb
comma
l_int|0x01cb
comma
l_int|0x01f6
comma
l_int|0x0152
comma
l_int|0x013a
comma
l_int|0x0133
comma
l_int|0x0131
comma
l_int|0x012c
comma
l_int|0x0123
comma
l_int|0x0122
comma
l_int|0x00a2
comma
l_int|0x011b
comma
l_int|0x011e
comma
l_int|0x0114
comma
l_int|0x00b1
comma
l_int|0x00aa
comma
l_int|0x00b3
comma
l_int|0x00bd
comma
l_int|0x00ba
comma
l_int|0x00c5
comma
l_int|0x00d3
comma
l_int|0x00f3
comma
l_int|0x0062
comma
l_int|0x0051
comma
l_int|0x0042
comma
l_int|0x003b
comma
l_int|0x0033
comma
l_int|0x0032
comma
l_int|0x002a
comma
l_int|0x002c
comma
l_int|0x0025
comma
l_int|0x0023
comma
l_int|0x0022
comma
l_int|0x001a
comma
l_int|0x0021
comma
l_int|0x001b
comma
l_int|0x001b
comma
l_int|0x001d
comma
l_int|0x0015
comma
l_int|0x0013
comma
l_int|0x0013
comma
l_int|0x0012
comma
l_int|0x0012
comma
l_int|0x000a
comma
l_int|0x000a
comma
l_int|0x0011
comma
l_int|0x0011
comma
l_int|0x000b
comma
l_int|0x000b
comma
l_int|0x000c
comma
l_int|0x000e
comma
)brace
suffix:semicolon
DECL|variable|ger_coeff
r_static
id|__const__
id|__u16
id|ger_coeff
(braket
)braket
op_assign
(brace
l_int|0x431f
comma
multiline_comment|/* 5. dB */
l_int|0x331f
comma
multiline_comment|/* 5.5 dB */
l_int|0x40dd
comma
multiline_comment|/* 6. dB */
l_int|0x11dd
comma
multiline_comment|/* 6.5 dB */
l_int|0x440f
comma
multiline_comment|/* 7. dB */
l_int|0x411f
comma
multiline_comment|/* 7.5 dB */
l_int|0x311f
comma
multiline_comment|/* 8. dB */
l_int|0x5520
comma
multiline_comment|/* 8.5 dB */
l_int|0x10dd
comma
multiline_comment|/* 9. dB */
l_int|0x4211
comma
multiline_comment|/* 9.5 dB */
l_int|0x410f
comma
multiline_comment|/* 10. dB */
l_int|0x111f
comma
multiline_comment|/* 10.5 dB */
l_int|0x600b
comma
multiline_comment|/* 11. dB */
l_int|0x00dd
comma
multiline_comment|/* 11.5 dB */
l_int|0x4210
comma
multiline_comment|/* 12. dB */
l_int|0x110f
comma
multiline_comment|/* 13. dB */
l_int|0x7200
comma
multiline_comment|/* 14. dB */
l_int|0x2110
comma
multiline_comment|/* 15. dB */
l_int|0x2200
comma
multiline_comment|/* 15.9 dB */
l_int|0x000b
comma
multiline_comment|/* 16.9 dB */
l_int|0x000f
multiline_comment|/* 18. dB */
)brace
suffix:semicolon
DECL|macro|NR_GER_COEFFS
mdefine_line|#define NR_GER_COEFFS (sizeof(ger_coeff) / sizeof(ger_coeff[0]))
multiline_comment|/* Enable amd7930 interrupts atomically. */
DECL|function|amd7930_enable_ints
r_static
r_void
id|amd7930_enable_ints
c_func
(paren
r_struct
id|amd7930_info
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;ints_on
)paren
(brace
id|sbus_writeb
c_func
(paren
id|AMR_INIT
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_INIT_ACTIVE
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|info-&gt;ints_on
op_assign
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable amd7930 interrupts atomically. */
DECL|function|amd7930_disable_ints
r_static
id|__inline__
r_void
id|amd7930_disable_ints
c_func
(paren
r_struct
id|amd7930_info
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;ints_on
)paren
(brace
id|sbus_writeb
c_func
(paren
id|AMR_INIT
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_INIT_ACTIVE
op_or
id|AM_INIT_DISABLE_INTS
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|info-&gt;ints_on
op_assign
l_int|0
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Idle amd7930 (no interrupts, no audio, no data) */
DECL|function|amd7930_idle
r_static
id|__inline__
r_void
id|amd7930_idle
c_func
(paren
r_struct
id|amd7930_info
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;ints_on
)paren
(brace
id|sbus_writeb
c_func
(paren
id|AMR_INIT
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|info-&gt;ints_on
op_assign
l_int|0
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Commit the local copy of the MAP registers to the amd7930. */
DECL|function|amd7930_write_map
r_static
r_void
id|amd7930_write_map
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|regs
op_assign
id|info-&gt;regs
suffix:semicolon
r_struct
id|amd7930_map
op_star
id|map
op_assign
op_amp
id|info-&gt;map
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_MAP_GX
comma
id|regs
op_plus
id|CR
)paren
suffix:semicolon
id|amd7930_out16
c_func
(paren
id|regs
comma
id|map-&gt;gx
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_MAP_GR
comma
id|regs
op_plus
id|CR
)paren
suffix:semicolon
id|amd7930_out16
c_func
(paren
id|regs
comma
id|map-&gt;gr
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_MAP_STGR
comma
id|regs
op_plus
id|CR
)paren
suffix:semicolon
id|amd7930_out16
c_func
(paren
id|regs
comma
id|map-&gt;stgr
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_MAP_GER
comma
id|regs
op_plus
id|CR
)paren
suffix:semicolon
id|amd7930_out16
c_func
(paren
id|regs
comma
id|map-&gt;ger
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_MAP_MMR1
comma
id|regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|map-&gt;mmr1
comma
id|regs
op_plus
id|DR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_MAP_MMR2
comma
id|regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|map-&gt;mmr2
comma
id|regs
op_plus
id|DR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Update the MAP registers with new settings. */
DECL|function|amd7930_update_map
r_static
r_void
id|amd7930_update_map
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|amd7930_map
op_star
id|map
op_assign
op_amp
id|info-&gt;map
suffix:semicolon
r_int
id|level
suffix:semicolon
id|map-&gt;gx
op_assign
id|gx_coeff
(braket
id|info-&gt;rgain
)braket
suffix:semicolon
id|map-&gt;stgr
op_assign
id|gx_coeff
(braket
id|info-&gt;mgain
)braket
suffix:semicolon
id|level
op_assign
(paren
id|info-&gt;pgain
op_star
(paren
l_int|256
op_plus
id|NR_GER_COEFFS
)paren
)paren
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|level
op_ge
l_int|256
)paren
(brace
id|map-&gt;ger
op_assign
id|ger_coeff
(braket
id|level
op_minus
l_int|256
)braket
suffix:semicolon
id|map-&gt;gr
op_assign
id|gx_coeff
(braket
l_int|255
)braket
suffix:semicolon
)brace
r_else
(brace
id|map-&gt;ger
op_assign
id|ger_coeff
(braket
l_int|0
)braket
suffix:semicolon
id|map-&gt;gr
op_assign
id|gx_coeff
(braket
id|level
)braket
suffix:semicolon
)brace
id|amd7930_write_map
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
multiline_comment|/* Bit of a hack here - if the HISAX ISDN driver has got INTSTAT debugging&n; * turned on, we send debugging characters to the ISDN driver:&n; *&n; *   i# - Interrupt received - number from 0 to 7 is low three bits of IR&n; *   &gt;  - Loaded a single char into the Dchan xmit FIFO&n; *   +  - Finished loading an xmit packet into the Dchan xmit FIFO&n; *   &lt;  - Read a single char from the Dchan recv FIFO&n; *   !  - Finished reading a packet from the Dchan recv FIFO&n; *&n; * This code needs to be removed if anything other than HISAX uses the ISDN&n; * driver, since D.output_callback_arg is assumed to be a certain struct ptr&n; */
macro_line|#ifdef L2FRAME_DEBUG
DECL|function|debug_info
r_inline
r_void
id|debug_info
c_func
(paren
r_struct
id|amd7930_info
op_star
id|info
comma
r_char
id|c
)paren
(brace
r_struct
id|IsdnCardState
op_star
id|cs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|info-&gt;D.output_callback_arg
)paren
r_return
suffix:semicolon
id|cs
op_assign
(paren
r_struct
id|IsdnCardState
op_star
)paren
id|info-&gt;D.output_callback_arg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cs
op_logical_or
op_logical_neg
id|cs-&gt;status_write
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;debug
op_amp
id|L1_DEB_INTSTAT
)paren
(brace
op_star
(paren
id|cs-&gt;status_write
op_increment
)paren
op_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|cs-&gt;status_write
OG
id|cs-&gt;status_end
)paren
id|cs-&gt;status_write
op_assign
id|cs-&gt;status_buf
suffix:semicolon
)brace
)brace
macro_line|#else
DECL|macro|debug_info
mdefine_line|#define debug_info(info,c)
macro_line|#endif
DECL|function|fill_D_xmit_fifo
r_static
r_void
id|fill_D_xmit_fifo
c_func
(paren
r_struct
id|amd7930_info
op_star
id|info
)paren
(brace
multiline_comment|/* Send next byte(s) of outgoing data. */
r_while
c_loop
(paren
id|info-&gt;D.output_ptr
op_logical_and
id|info-&gt;D.output_count
OG
l_int|0
op_logical_and
(paren
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DSR2
)paren
op_amp
id|AMR_DSR2_TBE
)paren
)paren
(brace
id|u8
id|byte
op_assign
op_star
(paren
id|info-&gt;D.output_ptr
)paren
suffix:semicolon
multiline_comment|/* Send the next byte and advance buffer pointer. */
id|sbus_writeb
c_func
(paren
id|byte
comma
id|info-&gt;regs
op_plus
id|DCTB
)paren
suffix:semicolon
id|info-&gt;D.output_ptr
op_increment
suffix:semicolon
id|info-&gt;D.output_count
op_decrement
suffix:semicolon
id|debug_info
c_func
(paren
id|info
comma
l_char|&squot;&gt;&squot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|transceive_Dchannel
r_static
r_void
id|transceive_Dchannel
c_func
(paren
r_struct
id|amd7930_info
op_star
id|info
)paren
(brace
id|__u8
id|dummy
suffix:semicolon
DECL|macro|D_XMIT_ERRORS
mdefine_line|#define D_XMIT_ERRORS (AMR_DER_COLLISION | AMR_DER_UNRN)
DECL|macro|D_RECV_ERRORS
mdefine_line|#define D_RECV_ERRORS (AMR_DER_RABRT | AMR_DER_RFRAME | AMR_DER_FCS | &bslash;&n;&t;&t;&t;AMR_DER_OVFL | AMR_DER_UNFL | AMR_DER_OVRN)
multiline_comment|/* Transmit if we can */
id|fill_D_xmit_fifo
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* Done with the xmit buffer? Notify the midlevel driver. */
r_if
c_cond
(paren
id|info-&gt;D.output_ptr
op_ne
l_int|NULL
op_logical_and
id|info-&gt;D.output_count
op_eq
l_int|0
)paren
(brace
id|info-&gt;D.output_ptr
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;D.output_count
op_assign
l_int|0
suffix:semicolon
id|debug_info
c_func
(paren
id|info
comma
l_char|&squot;+&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;D.output_callback
)paren
(paren
op_star
id|info-&gt;D.output_callback
)paren
(paren
id|info-&gt;D.output_callback_arg
comma
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DER
)paren
)paren
suffix:semicolon
multiline_comment|/* sbus_readb(info-&gt;regs + DER) &amp; D_XMIT_ERRORS); */
)brace
multiline_comment|/* Read the next byte(s) of incoming data. */
r_while
c_loop
(paren
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DSR2
)paren
op_amp
id|AMR_DSR2_RBA
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;D.input_ptr
op_logical_and
(paren
id|info-&gt;D.input_count
OL
id|info-&gt;D.input_limit
)paren
)paren
(brace
multiline_comment|/* Get the next byte and advance buffer pointer. */
op_star
(paren
id|info-&gt;D.input_ptr
)paren
op_assign
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DCRB
)paren
suffix:semicolon
id|info-&gt;D.input_ptr
op_increment
suffix:semicolon
id|info-&gt;D.input_count
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Overflow - should be detected by chip via RBLR&n;&t;&t;&t; * so we&squot;ll just consume data until we see LBRP&n;&t;&t;&t; */
id|dummy
op_assign
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DCRB
)paren
suffix:semicolon
)brace
id|debug_info
c_func
(paren
id|info
comma
l_char|&squot;&lt;&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DSR2
)paren
op_amp
id|AMR_DSR2_LBRP
)paren
(brace
id|__u8
id|der
suffix:semicolon
multiline_comment|/* End of recv packet? Notify the midlevel driver. */
id|debug_info
c_func
(paren
id|info
comma
l_char|&squot;!&squot;
)paren
suffix:semicolon
id|info-&gt;D.input_ptr
op_assign
l_int|NULL
suffix:semicolon
id|der
op_assign
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DER
)paren
op_amp
id|D_RECV_ERRORS
suffix:semicolon
multiline_comment|/* Read receive byte count - advances FIFOs */
id|sbus_writeb
c_func
(paren
id|AMR_DLC_DRCR
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|dummy
op_assign
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|dummy
op_assign
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;D.input_callback
)paren
(paren
op_star
id|info-&gt;D.input_callback
)paren
(paren
id|info-&gt;D.input_callback_arg
comma
id|der
comma
id|info-&gt;D.input_count
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|amd7930_xmit_idles
r_int
id|amd7930_xmit_idles
op_assign
l_int|0
suffix:semicolon
DECL|function|transceive_Bchannel
r_static
r_void
id|transceive_Bchannel
c_func
(paren
r_struct
id|amd7930_channel
op_star
id|channel
comma
r_int
r_int
id|reg
)paren
(brace
multiline_comment|/* Send the next byte of outgoing data. */
r_if
c_cond
(paren
id|channel-&gt;output_ptr
op_logical_and
id|channel-&gt;output_count
OG
l_int|0
)paren
(brace
id|u8
id|byte
suffix:semicolon
multiline_comment|/* Send the next byte and advance buffer pointer. */
r_switch
c_cond
(paren
id|channel-&gt;output_format
)paren
(brace
r_case
id|AUDIO_ENCODING_ULAW
suffix:colon
r_case
id|AUDIO_ENCODING_ALAW
suffix:colon
id|byte
op_assign
op_star
(paren
id|channel-&gt;output_ptr
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|byte
comma
id|reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_ENCODING_LINEAR8
suffix:colon
id|byte
op_assign
id|bilinear2mulaw
c_func
(paren
op_star
(paren
id|channel-&gt;output_ptr
)paren
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|byte
comma
id|reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_ENCODING_LINEAR
suffix:colon
r_if
c_cond
(paren
id|channel-&gt;output_count
op_ge
l_int|2
)paren
(brace
id|u16
id|val
op_assign
id|channel-&gt;output_ptr
(braket
l_int|0
)braket
op_lshift
l_int|8
suffix:semicolon
id|val
op_or_assign
id|channel-&gt;output_ptr
(braket
l_int|1
)braket
suffix:semicolon
id|byte
op_assign
id|linear2mulaw
c_func
(paren
id|val
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|byte
comma
id|reg
)paren
suffix:semicolon
id|channel-&gt;output_ptr
op_increment
suffix:semicolon
id|channel-&gt;output_count
op_decrement
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
id|channel-&gt;output_ptr
op_increment
suffix:semicolon
id|channel-&gt;output_count
op_decrement
suffix:semicolon
multiline_comment|/* Done with the buffer? Notify the midlevel driver. */
r_if
c_cond
(paren
id|channel-&gt;output_count
op_eq
l_int|0
)paren
(brace
id|channel-&gt;output_ptr
op_assign
l_int|NULL
suffix:semicolon
id|channel-&gt;output_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;output_callback
)paren
(paren
op_star
id|channel-&gt;output_callback
)paren
(paren
id|channel-&gt;output_callback_arg
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|sbus_writeb
c_func
(paren
id|channel-&gt;xmit_idle_char
comma
id|reg
)paren
suffix:semicolon
id|amd7930_xmit_idles
op_increment
suffix:semicolon
)brace
multiline_comment|/* Read the next byte of incoming data. */
r_if
c_cond
(paren
id|channel-&gt;input_ptr
op_logical_and
id|channel-&gt;input_count
OG
l_int|0
)paren
(brace
multiline_comment|/* Get the next byte and advance buffer pointer. */
r_switch
c_cond
(paren
id|channel-&gt;input_format
)paren
(brace
r_case
id|AUDIO_ENCODING_ULAW
suffix:colon
r_case
id|AUDIO_ENCODING_ALAW
suffix:colon
op_star
(paren
id|channel-&gt;input_ptr
)paren
op_assign
id|sbus_readb
c_func
(paren
id|reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_ENCODING_LINEAR8
suffix:colon
op_star
(paren
id|channel-&gt;input_ptr
)paren
op_assign
id|mulaw2bilinear
c_func
(paren
id|sbus_readb
c_func
(paren
id|reg
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_ENCODING_LINEAR
suffix:colon
r_if
c_cond
(paren
id|channel-&gt;input_count
op_ge
l_int|2
)paren
(brace
id|u16
id|val
op_assign
id|mulaw2linear
c_func
(paren
id|sbus_readb
c_func
(paren
id|reg
)paren
)paren
suffix:semicolon
id|channel-&gt;input_ptr
(braket
l_int|0
)braket
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
id|channel-&gt;input_ptr
(braket
l_int|1
)braket
op_assign
id|val
op_amp
l_int|0xff
suffix:semicolon
id|channel-&gt;input_ptr
op_increment
suffix:semicolon
id|channel-&gt;input_count
op_decrement
suffix:semicolon
)brace
r_else
(brace
op_star
(paren
id|channel-&gt;input_ptr
)paren
op_assign
l_int|0
suffix:semicolon
)brace
)brace
suffix:semicolon
id|channel-&gt;input_ptr
op_increment
suffix:semicolon
id|channel-&gt;input_count
op_decrement
suffix:semicolon
multiline_comment|/* Done with the buffer? Notify the midlevel driver. */
r_if
c_cond
(paren
id|channel-&gt;input_count
op_eq
l_int|0
)paren
(brace
id|channel-&gt;input_ptr
op_assign
l_int|NULL
suffix:semicolon
id|channel-&gt;input_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;input_callback
)paren
(paren
op_star
id|channel-&gt;input_callback
)paren
(paren
id|channel-&gt;input_callback_arg
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Interrupt handler (The chip takes only one byte per interrupt. Grrr!) */
DECL|function|amd7930_interrupt
r_static
r_void
id|amd7930_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|intr_regs
)paren
(brace
r_struct
id|sparcaudio_driver
op_star
id|drv
op_assign
(paren
r_struct
id|sparcaudio_driver
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|regs
op_assign
id|info-&gt;regs
suffix:semicolon
id|__u8
id|ir
suffix:semicolon
multiline_comment|/* Clear the interrupt. */
id|ir
op_assign
id|sbus_readb
c_func
(paren
id|regs
op_plus
id|IR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ir
op_amp
id|AMR_IR_BBUF
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;Bb.channel_status
op_eq
id|CHANNEL_INUSE
)paren
id|transceive_Bchannel
c_func
(paren
op_amp
id|info-&gt;Bb
comma
id|info-&gt;regs
op_plus
id|BBTB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;Bc.channel_status
op_eq
id|CHANNEL_INUSE
)paren
id|transceive_Bchannel
c_func
(paren
op_amp
id|info-&gt;Bc
comma
id|info-&gt;regs
op_plus
id|BCTB
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ir
op_amp
(paren
id|AMR_IR_DRTHRSH
op_or
id|AMR_IR_DTTHRSH
op_or
id|AMR_IR_DSRI
)paren
)paren
(brace
id|debug_info
c_func
(paren
id|info
comma
l_char|&squot;i&squot;
)paren
suffix:semicolon
id|debug_info
c_func
(paren
id|info
comma
l_char|&squot;0&squot;
op_plus
(paren
id|ir
op_amp
l_int|7
)paren
)paren
suffix:semicolon
id|transceive_Dchannel
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ir
op_amp
id|AMR_IR_LSRI
)paren
(brace
id|__u8
id|lsr
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_LIU_LSR
comma
id|regs
op_plus
id|CR
)paren
suffix:semicolon
id|lsr
op_assign
id|sbus_readb
c_func
(paren
id|regs
op_plus
id|DR
)paren
suffix:semicolon
id|info-&gt;liu_state
op_assign
(paren
id|lsr
op_amp
l_int|0x7
)paren
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;liu_callback
)paren
(paren
op_star
id|info-&gt;liu_callback
)paren
(paren
id|info-&gt;liu_callback_arg
)paren
suffix:semicolon
)brace
)brace
DECL|function|amd7930_open
r_static
r_int
id|amd7930_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_switch
c_cond
(paren
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_amp
l_int|0xf
)paren
(brace
r_case
id|SPARCAUDIO_AUDIO_MINOR
suffix:colon
id|info-&gt;format_type
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPARCAUDIO_DSP_MINOR
suffix:colon
id|info-&gt;format_type
op_assign
id|AUDIO_ENCODING_LINEAR8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPARCAUDIO_DSP16_MINOR
suffix:colon
id|info-&gt;format_type
op_assign
id|AUDIO_ENCODING_LINEAR
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd7930_release
r_static
r_void
id|amd7930_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
multiline_comment|/* amd7930_disable_ints(drv-&gt;private); */
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|request_Baudio
r_static
r_void
id|request_Baudio
c_func
(paren
r_struct
id|amd7930_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;Bb.channel_status
op_eq
id|CHANNEL_AVAILABLE
)paren
(brace
id|info-&gt;Bb.channel_status
op_assign
id|CHANNEL_INUSE
suffix:semicolon
id|info-&gt;Baudio
op_assign
op_amp
id|info-&gt;Bb
suffix:semicolon
multiline_comment|/* Multiplexor map - audio (Ba) to Bb */
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_MUX_CHANNEL_Ba
op_or
(paren
id|AM_MUX_CHANNEL_Bb
op_lshift
l_int|4
)paren
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* Enable B channel interrupts */
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR4
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_MUX_MCR4_ENABLE_INTS
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;Bc.channel_status
op_eq
id|CHANNEL_AVAILABLE
)paren
(brace
id|info-&gt;Bc.channel_status
op_assign
id|CHANNEL_INUSE
suffix:semicolon
id|info-&gt;Baudio
op_assign
op_amp
id|info-&gt;Bc
suffix:semicolon
multiline_comment|/* Multiplexor map - audio (Ba) to Bc */
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_MUX_CHANNEL_Ba
op_or
(paren
id|AM_MUX_CHANNEL_Bc
op_lshift
l_int|4
)paren
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* Enable B channel interrupts */
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR4
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_MUX_MCR4_ENABLE_INTS
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
)brace
)brace
DECL|function|release_Baudio
r_static
r_void
id|release_Baudio
c_func
(paren
r_struct
id|amd7930_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;Baudio
)paren
(brace
id|info-&gt;Baudio-&gt;channel_status
op_assign
id|CHANNEL_AVAILABLE
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|info-&gt;Baudio
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;Bb.channel_status
op_eq
id|CHANNEL_AVAILABLE
op_logical_and
id|info-&gt;Bc.channel_status
op_eq
id|CHANNEL_AVAILABLE
)paren
(brace
multiline_comment|/* Disable B channel interrupts */
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR4
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|amd7930_start_output
r_static
r_void
id|amd7930_start_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;Baudio
)paren
id|request_Baudio
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;Baudio
)paren
(brace
id|info-&gt;Baudio-&gt;output_ptr
op_assign
id|buffer
suffix:semicolon
id|info-&gt;Baudio-&gt;output_count
op_assign
id|count
suffix:semicolon
id|info-&gt;Baudio-&gt;output_format
op_assign
id|info-&gt;format_type
suffix:semicolon
id|info-&gt;Baudio-&gt;output_callback
op_assign
(paren
r_void
op_star
)paren
op_amp
id|sparcaudio_output_done
suffix:semicolon
id|info-&gt;Baudio-&gt;output_callback_arg
op_assign
(paren
r_void
op_star
)paren
id|drv
suffix:semicolon
id|info-&gt;Baudio-&gt;xmit_idle_char
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|amd7930_stop_output
r_static
r_void
id|amd7930_stop_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;Baudio
)paren
(brace
id|info-&gt;Baudio-&gt;output_ptr
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;Baudio-&gt;output_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;Baudio-&gt;input_ptr
)paren
id|release_Baudio
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
DECL|function|amd7930_start_input
r_static
r_void
id|amd7930_start_input
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;Baudio
)paren
id|request_Baudio
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;Baudio
)paren
(brace
id|info-&gt;Baudio-&gt;input_ptr
op_assign
id|buffer
suffix:semicolon
id|info-&gt;Baudio-&gt;input_count
op_assign
id|count
suffix:semicolon
id|info-&gt;Baudio-&gt;input_format
op_assign
id|info-&gt;format_type
suffix:semicolon
id|info-&gt;Baudio-&gt;input_callback
op_assign
(paren
r_void
op_star
)paren
op_amp
id|sparcaudio_input_done
suffix:semicolon
id|info-&gt;Baudio-&gt;input_callback_arg
op_assign
(paren
r_void
op_star
)paren
id|drv
suffix:semicolon
)brace
)brace
DECL|function|amd7930_stop_input
r_static
r_void
id|amd7930_stop_input
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;Baudio
)paren
(brace
id|info-&gt;Baudio-&gt;input_ptr
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;Baudio-&gt;input_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;Baudio-&gt;output_ptr
)paren
id|release_Baudio
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
DECL|function|amd7930_sunaudio_getdev
r_static
r_void
id|amd7930_sunaudio_getdev
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|audio_device_t
op_star
id|audinfo
)paren
(brace
id|strncpy
c_func
(paren
id|audinfo-&gt;name
comma
l_string|&quot;SUNW,am79c30&quot;
comma
r_sizeof
(paren
id|audinfo-&gt;name
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|audinfo-&gt;version
comma
l_string|&quot;a&quot;
comma
r_sizeof
(paren
id|audinfo-&gt;version
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|audinfo-&gt;config
comma
l_string|&quot;onboard1&quot;
comma
r_sizeof
(paren
id|audinfo-&gt;config
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|amd7930_sunaudio_getdev_sunos
r_static
r_int
id|amd7930_sunaudio_getdev_sunos
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AUDIO_DEV_AMD
suffix:semicolon
)brace
DECL|function|amd7930_get_formats
r_static
r_int
id|amd7930_get_formats
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
(paren
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_U8
op_or
id|AFMT_S16_BE
)paren
suffix:semicolon
)brace
DECL|function|amd7930_get_output_ports
r_static
r_int
id|amd7930_get_output_ports
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
(paren
id|AUDIO_SPEAKER
op_or
id|AUDIO_HEADPHONE
)paren
suffix:semicolon
)brace
DECL|function|amd7930_get_input_ports
r_static
r_int
id|amd7930_get_input_ports
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
(paren
id|AUDIO_MICROPHONE
)paren
suffix:semicolon
)brace
DECL|function|amd7930_set_output_volume
r_static
r_int
id|amd7930_set_output_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|vol
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|info-&gt;pgain
op_assign
id|vol
suffix:semicolon
id|amd7930_update_map
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd7930_get_output_volume
r_static
r_int
id|amd7930_get_output_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|info-&gt;pgain
suffix:semicolon
)brace
DECL|function|amd7930_set_input_volume
r_static
r_int
id|amd7930_set_input_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|vol
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|info-&gt;rgain
op_assign
id|vol
suffix:semicolon
id|amd7930_update_map
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd7930_get_input_volume
r_static
r_int
id|amd7930_get_input_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|info-&gt;rgain
suffix:semicolon
)brace
DECL|function|amd7930_set_monitor_volume
r_static
r_int
id|amd7930_set_monitor_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|vol
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|info-&gt;mgain
op_assign
id|vol
suffix:semicolon
id|amd7930_update_map
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd7930_get_monitor_volume
r_static
r_int
id|amd7930_get_monitor_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|info-&gt;mgain
suffix:semicolon
)brace
multiline_comment|/* Cheats. The amd has the minimum capabilities we support */
DECL|function|amd7930_get_output_balance
r_static
r_int
id|amd7930_get_output_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AUDIO_MID_BALANCE
suffix:semicolon
)brace
DECL|function|amd7930_get_input_balance
r_static
r_int
id|amd7930_get_input_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AUDIO_MID_BALANCE
suffix:semicolon
)brace
DECL|function|amd7930_get_output_channels
r_static
r_int
id|amd7930_get_output_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AUDIO_MIN_PLAY_CHANNELS
suffix:semicolon
)brace
DECL|function|amd7930_set_output_channels
r_static
r_int
id|amd7930_set_output_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|value
)paren
(brace
r_return
(paren
id|value
op_eq
id|AUDIO_MIN_PLAY_CHANNELS
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amd7930_get_input_channels
r_static
r_int
id|amd7930_get_input_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AUDIO_MIN_REC_CHANNELS
suffix:semicolon
)brace
r_static
r_int
DECL|function|amd7930_set_input_channels
id|amd7930_set_input_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|value
)paren
(brace
r_return
(paren
id|value
op_eq
id|AUDIO_MIN_REC_CHANNELS
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amd7930_get_output_precision
r_static
r_int
id|amd7930_get_output_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AUDIO_MIN_PLAY_PRECISION
suffix:semicolon
)brace
r_static
r_int
DECL|function|amd7930_set_output_precision
id|amd7930_set_output_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|value
)paren
(brace
r_return
(paren
id|value
op_eq
id|AUDIO_MIN_PLAY_PRECISION
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amd7930_get_input_precision
r_static
r_int
id|amd7930_get_input_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AUDIO_MIN_REC_PRECISION
suffix:semicolon
)brace
r_static
r_int
DECL|function|amd7930_set_input_precision
id|amd7930_set_input_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|value
)paren
(brace
r_return
(paren
id|value
op_eq
id|AUDIO_MIN_REC_PRECISION
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amd7930_get_output_port
r_static
r_int
id|amd7930_get_output_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;map.mmr2
op_amp
id|AM_MAP_MMR2_LS
)paren
r_return
id|AUDIO_SPEAKER
suffix:semicolon
r_return
id|AUDIO_HEADPHONE
suffix:semicolon
)brace
DECL|function|amd7930_set_output_port
r_static
r_int
id|amd7930_set_output_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|value
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
id|AUDIO_HEADPHONE
suffix:colon
id|info-&gt;map.mmr2
op_and_assign
op_complement
id|AM_MAP_MMR2_LS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_SPEAKER
suffix:colon
id|info-&gt;map.mmr2
op_or_assign
id|AM_MAP_MMR2_LS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
id|amd7930_update_map
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Only a microphone here, so no troubles */
DECL|function|amd7930_get_input_port
r_static
r_int
id|amd7930_get_input_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AUDIO_MICROPHONE
suffix:semicolon
)brace
DECL|function|amd7930_get_encoding
r_static
r_int
id|amd7930_get_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;map.mmr1
op_amp
id|AM_MAP_MMR1_ALAW
)paren
op_logical_and
(paren
id|info-&gt;format_type
op_eq
id|AUDIO_ENCODING_ALAW
)paren
)paren
r_return
id|AUDIO_ENCODING_ALAW
suffix:semicolon
r_return
id|info-&gt;format_type
suffix:semicolon
)brace
r_static
r_int
DECL|function|amd7930_set_encoding
id|amd7930_set_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|value
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_switch
c_cond
(paren
id|value
)paren
(brace
r_case
id|AUDIO_ENCODING_ALAW
suffix:colon
id|info-&gt;map.mmr1
op_or_assign
id|AM_MAP_MMR1_ALAW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_ENCODING_LINEAR8
suffix:colon
r_case
id|AUDIO_ENCODING_LINEAR
suffix:colon
r_case
id|AUDIO_ENCODING_ULAW
suffix:colon
id|info-&gt;map.mmr1
op_and_assign
op_complement
id|AM_MAP_MMR1_ALAW
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
id|info-&gt;format_type
op_assign
id|value
suffix:semicolon
id|amd7930_update_map
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is what you get. Take it or leave it */
DECL|function|amd7930_get_output_rate
r_static
r_int
id|amd7930_get_output_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AMD7930_RATE
suffix:semicolon
)brace
r_static
r_int
DECL|function|amd7930_set_output_rate
id|amd7930_set_output_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|value
)paren
(brace
r_return
(paren
id|value
op_eq
id|AMD7930_RATE
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amd7930_get_input_rate
r_static
r_int
id|amd7930_get_input_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AMD7930_RATE
suffix:semicolon
)brace
r_static
r_int
DECL|function|amd7930_set_input_rate
id|amd7930_set_input_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|value
)paren
(brace
r_return
(paren
id|value
op_eq
id|AMD7930_RATE
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|amd7930_get_output_muted
r_static
r_int
id|amd7930_get_output_muted
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd7930_loopback
r_static
r_void
id|amd7930_loopback
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
r_int
id|value
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
id|info-&gt;map.mmr1
op_or_assign
id|AM_MAP_MMR1_LOOPBACK
suffix:semicolon
r_else
id|info-&gt;map.mmr1
op_and_assign
op_complement
id|AM_MAP_MMR1_LOOPBACK
suffix:semicolon
id|amd7930_update_map
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
DECL|function|amd7930_ioctl
r_static
r_int
id|amd7930_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AUDIO_DIAG_LOOPBACK
suffix:colon
id|amd7930_loopback
c_func
(paren
id|drv
comma
(paren
r_int
r_int
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; *       ISDN operations&n; *&n; * Many of these routines take an &quot;int dev&quot; argument, which is simply&n; * an index into the drivers[] array.  Currently, we only support a&n; * single AMD 7930 chip, so the value should always be 0.  B channel&n; * operations require an &quot;int chan&quot;, which should be 0 for channel B1&n; * and 1 for channel B2&n; *&n; * int amd7930_get_irqnum(int dev)&n; *&n; *   returns the interrupt number being used by the chip.  ISDN4linux&n; *   uses this number to watch the interrupt during initialization and&n; *   make sure something is happening.&n; *&n; * int amd7930_get_liu_state(int dev)&n; *&n; *   returns the current state of the ISDN Line Interface Unit (LIU)&n; *   as a number between 2 (state F2) and 7 (state F7).  0 may also be&n; *   returned if the chip doesn&squot;t exist or the LIU hasn&squot;t been&n; *   activated.  The meanings of the states are defined in I.430, ISDN&n; *   BRI Physical Layer Interface.  The most important two states are&n; *   F3 (shutdown) and F7 (syncronized).&n; *&n; * void amd7930_liu_init(int dev, void (*callback)(), void *callback_arg)&n; *&n; *   initializes the LIU and optionally registers a callback to be&n; *   signaled upon a change of LIU state.  The callback will be called&n; *   with a single opaque callback_arg Once the callback has been&n; *   triggered, amd7930_get_liu_state can be used to determine the LIU&n; *   current state.&n; *&n; * void amd7930_liu_activate(int dev, int priority)&n; *&n; *   requests LIU activation at a given D-channel priority.&n; *   Successful activatation is achieved upon entering state F7, which&n; *   will trigger any callback previously registered with&n; *   amd7930_liu_init.&n; *&n; * void amd7930_liu_deactivate(int dev)&n; *&n; *   deactivates LIU.  Outstanding D and B channel transactions are&n; *   terminated rudely and without callback notification.  LIU change&n; *   of state callback will be triggered, however.&n; *&n; * void amd7930_dxmit(int dev, __u8 *buffer, unsigned int count,&n; *               void (*callback)(void *, int), void *callback_arg)&n; *&n; *   transmits a packet - specified with buffer, count - over the D-channel&n; *   interface.  Buffer should begin with the LAPD address field and&n; *   end with the information field.  FCS and flag sequences should not&n; *   be included, nor is bit-stuffing required - all these functions are&n; *   performed by the chip.  The callback function will be called&n; *   DURING THE TOP HALF OF AN INTERRUPT HANDLER and will be passed&n; *   both the arbitrary callback_arg and an integer error indication:&n; *&n; *       0 - successful transmission; ready for next packet&n; *   non-0 - error value from chip&squot;s DER (D-Channel Error Register):&n; *       4 - collision detect&n; *     128 - underrun; irq routine didn&squot;t service chip fast enough&n; *&n; *   The callback routine should defer any time-consuming operations&n; *   to a bottom-half handler; however, amd7930_dxmit may be called&n; *   from within the callback to request back-to-back transmission of&n; *   a second packet (without repeating the priority/collision mechanism)&n; *&n; *   A comment about the &quot;collision detect&quot; error, which is signalled&n; *   whenever the echoed D-channel data didn&squot;t match the transmitted&n; *   data.  This is part of ISDN&squot;s normal multi-drop T-interface&n; *   operation, indicating that another device has attempted simultaneous&n; *   transmission, but can also result from line noise.  An immediate&n; *   requeue via amd7930_dxmit is suggested, but repeated collision&n; *   errors may indicate a more serious problem.&n; *&n; * void amd7930_drecv(int dev, __u8 *buffer, unsigned int size,&n; *               void (*callback)(void *, int, unsigned int),&n; *               void *callback_arg)&n; *&n; *   register a buffer - buffer, size - into which a D-channel packet&n; *   can be received.  The callback function will be called DURING&n; *   THE TOP HALF OF AN INTERRUPT HANDLER and will be passed an&n; *   arbitrary callback_arg, an integer error indication and the length&n; *   of the received packet, which will start with the address field,&n; *   end with the information field, and not contain flag or FCS&n; *   bytes.  Bit-stuffing will already have been corrected for.&n; *   Possible values of second callback argument &quot;error&quot;:&n; *&n; *       0 - successful reception&n; *   non-0 - error value from chip&squot;s DER (D-Channel Error Register):&n; *       1 - received packet abort&n; *       2 - framing error; non-integer number of bytes received&n; *       8 - FCS error; CRC sequence indicated corrupted data&n; *      16 - overflow error; packet exceeded size of buffer&n; *      32 - underflow error; packet smaller than required five bytes&n; *      64 - overrun error; irq routine didn&squot;t service chip fast enough&n; *&n; * int amd7930_bopen(int dev, int chan, u_char xmit_idle_char)&n; *&n; *   This function should be called before any other operations on a B&n; *   channel.  In addition to arranging for interrupt handling and&n; *   channel multiplexing, it sets the xmit_idle_char which is&n; *   transmitted on the interface when no data buffer is available.&n; *   Suggested values are: 0 for ISDN audio; FF for HDLC mark idle; 7E&n; *   for HDLC flag idle.  Returns 0 on a successful open; -1 on error,&n; *   which is quite possible if audio and the other ISDN channel are&n; *   already in use, since the Am7930 can only send two of the three&n; *   channels to the processor&n; *&n; * void amd7930_bclose(int dev, int chan)&n; *&n; *   Shuts down a B channel when no longer in use.&n; *&n; * void amd7930_bxmit(int dev, int chan, __u8 *buffer, unsigned int count,&n; *               void (*callback)(void *), void *callback_arg)&n; *&n; *   transmits a raw data block - specified with buffer, count - over&n; *   the B channel interface specified by dev/chan.  The callback&n; *   function will be called DURING THE TOP HALF OF AN INTERRUPT&n; *   HANDLER and will be passed the arbitrary callback_arg&n; *&n; *   The callback routine should defer any time-consuming operations&n; *   to a bottom-half handler; however, amd7930_bxmit may be called&n; *   from within the callback to request back-to-back transmission of&n; *   another data block&n; *&n; * void amd7930_brecv(int dev, int chan, __u8 *buffer, unsigned int size,&n; *               void (*callback)(void *), void *callback_arg)&n; *&n; *   receive a raw data block - specified with buffer, size - over the&n; *   B channel interface specified by dev/chan.  The callback function&n; *   will be called DURING THE TOP HALF OF AN INTERRUPT HANDLER and&n; *   will be passed the arbitrary callback_arg&n; *&n; *   The callback routine should defer any time-consuming operations&n; *   to a bottom-half handler; however, amd7930_brecv may be called&n; *   from within the callback to register another buffer and ensure&n; *   continuous B channel reception without loss of data&n; *&n; */
macro_line|#if defined (AMD79C30_ISDN) || defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x200ff 
DECL|function|amd7930_get_irqnum
r_static
r_int
id|amd7930_get_irqnum
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
r_return
l_int|0
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_return
id|info-&gt;irq
suffix:semicolon
)brace
DECL|function|amd7930_get_liu_state
r_static
r_int
id|amd7930_get_liu_state
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
r_return
l_int|0
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_return
id|info-&gt;liu_state
suffix:semicolon
)brace
DECL|function|amd7930_liu_init
r_static
r_void
id|amd7930_liu_init
c_func
(paren
r_int
id|dev
comma
r_void
(paren
op_star
id|callback
)paren
(paren
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
r_return
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Set callback for LIU state change */
id|info-&gt;liu_callback
op_assign
id|callback
suffix:semicolon
id|info-&gt;liu_callback_arg
op_assign
id|callback_arg
suffix:semicolon
multiline_comment|/* De-activate the ISDN Line Interface Unit (LIU) */
id|sbus_writeb
c_func
(paren
id|AMR_LIU_LMR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* Request interrupt when LIU changes state from/to F3/F7/F8 */
id|sbus_writeb
c_func
(paren
id|AMR_LIU_LMR2
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_LIU_LMR2_EN_F3_INT
op_or
id|AM_LIU_LMR2_EN_F7_INT
op_or
id|AM_LIU_LMR2_EN_F8_INT
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* amd7930_enable_ints(info); */
multiline_comment|/* Activate the ISDN Line Interface Unit (LIU) */
id|sbus_writeb
c_func
(paren
id|AMR_LIU_LMR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_LIU_LMR1_LIU_ENABL
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|amd7930_liu_activate
r_static
r_void
id|amd7930_liu_activate
c_func
(paren
r_int
id|dev
comma
r_int
id|priority
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
r_return
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Set D-channel access priority&n;         *&n;         * I.430 defines a priority mechanism based on counting 1s&n;         * in the echo channel before transmitting&n;         *&n;         * Priority 0 is eight 1s; priority 1 is ten 1s; etc&n;         */
id|sbus_writeb
c_func
(paren
id|AMR_LIU_LPR
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|priority
op_amp
l_int|0x0f
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* request LIU activation */
id|sbus_writeb
c_func
(paren
id|AMR_LIU_LMR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_LIU_LMR1_LIU_ENABL
op_or
id|AM_LIU_LMR1_REQ_ACTIV
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|amd7930_liu_deactivate
r_static
r_void
id|amd7930_liu_deactivate
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
r_return
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* deactivate LIU */
id|sbus_writeb
c_func
(paren
id|AMR_LIU_LMR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|amd7930_dxmit
r_static
r_void
id|amd7930_dxmit
c_func
(paren
r_int
id|dev
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__u8
id|dmr1
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
r_return
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;D.output_ptr
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;amd7930_dxmit: transmitter in use&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|info-&gt;D.output_ptr
op_assign
id|buffer
suffix:semicolon
id|info-&gt;D.output_count
op_assign
id|count
suffix:semicolon
id|info-&gt;D.output_callback
op_assign
id|callback
suffix:semicolon
id|info-&gt;D.output_callback_arg
op_assign
id|callback_arg
suffix:semicolon
multiline_comment|/* Enable D-channel Transmit Threshold interrupt; disable addressing */
id|sbus_writeb
c_func
(paren
id|AMR_DLC_DMR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|dmr1
op_assign
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|dmr1
op_or_assign
id|AMR_DLC_DMR1_DTTHRSH_INT
suffix:semicolon
id|dmr1
op_and_assign
op_complement
id|AMR_DLC_DMR1_EN_ADDRS
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|dmr1
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* Begin xmit by setting D-channel Transmit Byte Count Reg (DTCR) */
id|sbus_writeb
c_func
(paren
id|AMR_DLC_DTCR
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|count
op_amp
l_int|0xff
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* Prime xmit FIFO */
multiline_comment|/* fill_D_xmit_fifo(info); */
id|transceive_Dchannel
c_func
(paren
id|info
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|amd7930_drecv
r_static
r_void
id|amd7930_drecv
c_func
(paren
r_int
id|dev
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|size
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__u8
id|dmr1
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
r_return
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;D.input_ptr
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;amd7930_drecv: receiver already has buffer!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|info-&gt;D.input_ptr
op_assign
id|buffer
suffix:semicolon
id|info-&gt;D.input_count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;D.input_limit
op_assign
id|size
suffix:semicolon
id|info-&gt;D.input_callback
op_assign
id|callback
suffix:semicolon
id|info-&gt;D.input_callback_arg
op_assign
id|callback_arg
suffix:semicolon
multiline_comment|/* Enable D-channel Receive Threshold interrupt;&n;&t; * Enable D-channel End of Receive Packet interrupt;&n;&t; * Disable address recognition&n;&t; */
id|sbus_writeb
c_func
(paren
id|AMR_DLC_DMR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|dmr1
op_assign
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|dmr1
op_or_assign
id|AMR_DLC_DMR1_DRTHRSH_INT
op_or
id|AMR_DLC_DMR1_EORP_INT
suffix:semicolon
id|dmr1
op_and_assign
op_complement
id|AMR_DLC_DMR1_EN_ADDRS
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|dmr1
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* Set D-channel Receive Byte Count Limit Register */
id|sbus_writeb
c_func
(paren
id|AMR_DLC_DRCR
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|size
op_amp
l_int|0xff
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
(paren
id|size
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|amd7930_bopen
r_static
r_int
id|amd7930_bopen
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
r_int
id|mode
comma
id|u_char
id|xmit_idle_char
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
op_logical_or
id|chan
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|L1_MODE_HDLC
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;Bb.channel_status
op_eq
id|CHANNEL_AVAILABLE
)paren
(brace
id|info-&gt;Bb.channel_status
op_assign
id|CHANNEL_INUSE
suffix:semicolon
id|info-&gt;Bb.xmit_idle_char
op_assign
id|xmit_idle_char
suffix:semicolon
id|info-&gt;Bisdn
(braket
id|chan
)braket
op_assign
op_amp
id|info-&gt;Bb
suffix:semicolon
multiline_comment|/* Multiplexor map - isdn (B1/2) to Bb */
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR2
op_plus
id|chan
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
(paren
id|AM_MUX_CHANNEL_B1
op_plus
id|chan
)paren
op_or
(paren
id|AM_MUX_CHANNEL_Bb
op_lshift
l_int|4
)paren
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;Bc.channel_status
op_eq
id|CHANNEL_AVAILABLE
)paren
(brace
id|info-&gt;Bc.channel_status
op_assign
id|CHANNEL_INUSE
suffix:semicolon
id|info-&gt;Bc.xmit_idle_char
op_assign
id|xmit_idle_char
suffix:semicolon
id|info-&gt;Bisdn
(braket
id|chan
)braket
op_assign
op_amp
id|info-&gt;Bc
suffix:semicolon
multiline_comment|/* Multiplexor map - isdn (B1/2) to Bc */
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR2
op_plus
id|chan
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
(paren
id|AM_MUX_CHANNEL_B1
op_plus
id|chan
)paren
op_or
(paren
id|AM_MUX_CHANNEL_Bc
op_lshift
l_int|4
)paren
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
)brace
r_else
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable B channel transmit */
id|sbus_writeb
c_func
(paren
id|AMR_LIU_LMR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|tmp
op_assign
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|tmp
op_or_assign
id|AM_LIU_LMR1_B1_ENABL
op_plus
id|chan
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|tmp
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* Enable B channel interrupts */
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR4
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AM_MUX_MCR4_ENABLE_INTS
op_or
id|AM_MUX_MCR4_REVERSE_Bb
op_or
id|AM_MUX_MCR4_REVERSE_Bc
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd7930_bclose
r_static
r_void
id|amd7930_bclose
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
op_logical_or
id|chan
l_int|1
)paren
r_return
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;Bisdn
(braket
id|chan
)braket
)paren
(brace
id|u8
id|tmp
suffix:semicolon
id|info-&gt;Bisdn
(braket
id|chan
)braket
op_member_access_from_pointer
id|channel_status
op_assign
id|CHANNEL_AVAILABLE
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR2
op_plus
id|chan
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|info-&gt;Bisdn
(braket
id|chan
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Disable B channel transmit */
id|sbus_writeb
c_func
(paren
id|AMR_LIU_LMR1
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|tmp
op_assign
id|sbus_readb
c_func
(paren
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|AM_LIU_LMR1_B1_ENABL
op_plus
id|chan
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|tmp
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;Bb.channel_status
op_eq
id|CHANNEL_AVAILABLE
op_logical_and
id|info-&gt;Bc.channel_status
op_eq
id|CHANNEL_AVAILABLE
)paren
(brace
multiline_comment|/* Disable B channel interrupts */
id|sbus_writeb
c_func
(paren
id|AMR_MUX_MCR4
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
l_int|0
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|amd7930_bxmit
r_static
r_void
id|amd7930_bxmit
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_struct
id|amd7930_channel
op_star
id|Bchan
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
r_return
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|Bchan
op_assign
id|info-&gt;Bisdn
(braket
id|chan
)braket
suffix:semicolon
r_if
c_cond
(paren
id|Bchan
)paren
(brace
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|Bchan-&gt;output_ptr
op_assign
id|buffer
suffix:semicolon
id|Bchan-&gt;output_count
op_assign
id|count
suffix:semicolon
id|Bchan-&gt;output_format
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|Bchan-&gt;output_callback
op_assign
(paren
r_void
op_star
)paren
id|callback
suffix:semicolon
id|Bchan-&gt;output_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|amd7930_brecv
r_static
r_void
id|amd7930_brecv
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|size
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_struct
id|amd7930_channel
op_star
id|Bchan
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
r_return
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|Bchan
op_assign
id|info-&gt;Bisdn
(braket
id|chan
)braket
suffix:semicolon
r_if
c_cond
(paren
id|Bchan
)paren
(brace
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|Bchan-&gt;input_ptr
op_assign
id|buffer
suffix:semicolon
id|Bchan-&gt;input_count
op_assign
id|size
suffix:semicolon
id|Bchan-&gt;input_format
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|Bchan-&gt;input_callback
op_assign
(paren
r_void
op_star
)paren
id|callback
suffix:semicolon
id|Bchan-&gt;input_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|variable|amd7930_foreign_interface
r_struct
id|foreign_interface
id|amd7930_foreign_interface
op_assign
(brace
id|amd7930_get_irqnum
comma
id|amd7930_get_liu_state
comma
id|amd7930_liu_init
comma
id|amd7930_liu_activate
comma
id|amd7930_liu_deactivate
comma
id|amd7930_dxmit
comma
id|amd7930_drecv
comma
id|amd7930_bopen
comma
id|amd7930_bclose
comma
id|amd7930_bxmit
comma
id|amd7930_brecv
)brace
suffix:semicolon
DECL|variable|amd7930_foreign_interface
id|EXPORT_SYMBOL
c_func
(paren
id|amd7930_foreign_interface
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;Device detection and initialization.&n; */
DECL|variable|amd7930_ops
r_static
r_struct
id|sparcaudio_operations
id|amd7930_ops
op_assign
(brace
id|amd7930_open
comma
id|amd7930_release
comma
id|amd7930_ioctl
comma
id|amd7930_start_output
comma
id|amd7930_stop_output
comma
id|amd7930_start_input
comma
id|amd7930_stop_input
comma
id|amd7930_sunaudio_getdev
comma
id|amd7930_set_output_volume
comma
id|amd7930_get_output_volume
comma
id|amd7930_set_input_volume
comma
id|amd7930_get_input_volume
comma
id|amd7930_set_monitor_volume
comma
id|amd7930_get_monitor_volume
comma
l_int|NULL
comma
multiline_comment|/* amd7930_set_output_balance */
id|amd7930_get_output_balance
comma
l_int|NULL
comma
multiline_comment|/* amd7930_set_input_balance */
id|amd7930_get_input_balance
comma
id|amd7930_set_output_channels
comma
id|amd7930_get_output_channels
comma
id|amd7930_set_input_channels
comma
id|amd7930_get_input_channels
comma
id|amd7930_set_output_precision
comma
id|amd7930_get_output_precision
comma
id|amd7930_set_input_precision
comma
id|amd7930_get_input_precision
comma
id|amd7930_set_output_port
comma
id|amd7930_get_output_port
comma
l_int|NULL
comma
multiline_comment|/* amd7930_set_input_port */
id|amd7930_get_input_port
comma
id|amd7930_set_encoding
comma
id|amd7930_get_encoding
comma
id|amd7930_set_encoding
comma
id|amd7930_get_encoding
comma
id|amd7930_set_output_rate
comma
id|amd7930_get_output_rate
comma
id|amd7930_set_input_rate
comma
id|amd7930_get_input_rate
comma
id|amd7930_sunaudio_getdev_sunos
comma
id|amd7930_get_output_ports
comma
id|amd7930_get_input_ports
comma
l_int|NULL
comma
multiline_comment|/* amd7930_set_output_muted */
id|amd7930_get_output_muted
comma
l_int|NULL
comma
multiline_comment|/* amd7930_set_output_pause */
l_int|NULL
comma
multiline_comment|/* amd7930_get_output_pause */
l_int|NULL
comma
multiline_comment|/* amd7930_set_input_pause */
l_int|NULL
comma
multiline_comment|/* amd7930_get_input_pause */
l_int|NULL
comma
multiline_comment|/* amd7930_set_output_samples */
l_int|NULL
comma
multiline_comment|/* amd7930_get_output_samples */
l_int|NULL
comma
multiline_comment|/* amd7930_set_input_samples */
l_int|NULL
comma
multiline_comment|/* amd7930_get_input_samples */
l_int|NULL
comma
multiline_comment|/* amd7930_set_output_error */
l_int|NULL
comma
multiline_comment|/* amd7930_get_output_error */
l_int|NULL
comma
multiline_comment|/* amd7930_set_input_error */
l_int|NULL
comma
multiline_comment|/* amd7930_get_input_error */
id|amd7930_get_formats
comma
)brace
suffix:semicolon
multiline_comment|/* Attach to an amd7930 chip given its PROM node. */
DECL|function|amd7930_attach
r_static
r_int
id|amd7930_attach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|node
comma
r_struct
id|sbus_bus
op_star
id|sbus
comma
r_struct
id|sbus_dev
op_star
id|sdev
)paren
(brace
r_struct
id|linux_prom_registers
id|regs
suffix:semicolon
r_struct
id|linux_prom_irqs
id|irq
suffix:semicolon
r_struct
id|resource
id|res
comma
op_star
id|resp
suffix:semicolon
r_struct
id|amd7930_info
op_star
id|info
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Allocate our private information structure. */
id|drv
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|amd7930_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Point at the information structure and initialize it. */
id|drv-&gt;ops
op_assign
op_amp
id|amd7930_ops
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;ints_on
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* force disable below */
id|drv-&gt;dev
op_assign
id|sdev
suffix:semicolon
multiline_comment|/* Map the registers into memory. */
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbus
op_logical_and
id|sdev
)paren
(brace
id|resp
op_assign
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
id|resp
op_assign
op_amp
id|res
suffix:semicolon
id|res.start
op_assign
id|regs.phys_addr
suffix:semicolon
id|res.end
op_assign
id|res.start
op_plus
id|regs.reg_size
op_minus
l_int|1
suffix:semicolon
id|res.flags
op_assign
id|IORESOURCE_IO
op_or
(paren
id|regs.which_io
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
id|info-&gt;regs_size
op_assign
id|regs.reg_size
suffix:semicolon
id|info-&gt;regs
op_assign
id|sbus_ioremap
c_func
(paren
id|resp
comma
l_int|0
comma
id|regs.reg_size
comma
l_string|&quot;amd7930&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;amd7930: could not remap registers&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Put amd7930 in idle mode (interrupts disabled) */
id|amd7930_idle
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* Enable extended FIFO operation on D-channel */
id|sbus_writeb
c_func
(paren
id|AMR_DLC_EFCR
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_DLC_EFCR_EXTEND_FIFO
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|AMR_DLC_DMR4
comma
id|info-&gt;regs
op_plus
id|CR
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
multiline_comment|/* AMR_DLC_DMR4_RCV_30 | */
id|AMR_DLC_DMR4_XMT_14
comma
id|info-&gt;regs
op_plus
id|DR
)paren
suffix:semicolon
multiline_comment|/* Attach the interrupt handler to the audio interrupt. */
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;intr&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irq
comma
r_sizeof
(paren
id|irq
)paren
)paren
suffix:semicolon
id|info-&gt;irq
op_assign
id|irq.pri
suffix:semicolon
id|request_irq
c_func
(paren
id|info-&gt;irq
comma
id|amd7930_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;amd7930&quot;
comma
id|drv
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|info-&gt;irq
)paren
suffix:semicolon
id|amd7930_enable_ints
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* Initalize the local copy of the MAP registers. */
id|memset
c_func
(paren
op_amp
id|info-&gt;map
comma
l_int|0
comma
r_sizeof
(paren
id|info-&gt;map
)paren
)paren
suffix:semicolon
id|info-&gt;map.mmr1
op_assign
id|AM_MAP_MMR1_GX
op_or
id|AM_MAP_MMR1_GER
op_or
id|AM_MAP_MMR1_GR
op_or
id|AM_MAP_MMR1_STG
suffix:semicolon
multiline_comment|/* Start out with speaker, microphone */
id|info-&gt;map.mmr2
op_or_assign
(paren
id|AM_MAP_MMR2_LS
op_or
id|AM_MAP_MMR2_AINB
)paren
suffix:semicolon
multiline_comment|/* Set the default audio parameters. */
id|info-&gt;rgain
op_assign
l_int|128
suffix:semicolon
id|info-&gt;pgain
op_assign
l_int|200
suffix:semicolon
id|info-&gt;mgain
op_assign
l_int|0
suffix:semicolon
id|info-&gt;format_type
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|info-&gt;Bb.input_format
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|info-&gt;Bb.output_format
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|info-&gt;Bc.input_format
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|info-&gt;Bc.output_format
op_assign
id|AUDIO_ENCODING_ULAW
suffix:semicolon
id|amd7930_update_map
c_func
(paren
id|drv
)paren
suffix:semicolon
multiline_comment|/* Register the amd7930 with the midlevel audio driver. */
id|err
op_assign
id|register_sparcaudio_driver
c_func
(paren
id|drv
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;amd7930: unable to register&bslash;n&quot;
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|info-&gt;irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|info-&gt;irq
comma
id|drv
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|info-&gt;regs
comma
id|info-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Announce the hardware to the user. */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;amd7930 at %lx irq %d&bslash;n&quot;
comma
id|info-&gt;regs
comma
id|info-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Success! */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* Detach from an amd7930 chip given the device structure. */
DECL|function|amd7930_detach
r_static
r_void
id|amd7930_detach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|amd7930_info
op_star
id|info
op_assign
(paren
r_struct
id|amd7930_info
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|unregister_sparcaudio_driver
c_func
(paren
id|drv
comma
l_int|1
)paren
suffix:semicolon
id|amd7930_idle
c_func
(paren
id|info
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|info-&gt;irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|info-&gt;irq
comma
id|drv
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|info-&gt;regs
comma
id|info-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Probe for the amd7930 chip and then attach the driver. */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|amd7930_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
r_struct
id|sbus_bus
op_star
id|sbus
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
suffix:semicolon
r_int
id|node
suffix:semicolon
multiline_comment|/* Try to find the sun4c &quot;audio&quot; node first. */
id|node
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;audio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_logical_and
id|amd7930_attach
c_func
(paren
op_amp
id|drivers
(braket
l_int|0
)braket
comma
id|node
comma
l_int|NULL
comma
l_int|NULL
)paren
op_eq
l_int|0
)paren
id|num_drivers
op_assign
l_int|1
suffix:semicolon
r_else
id|num_drivers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Probe each SBUS for amd7930 chips. */
id|for_all_sbusdev
c_func
(paren
id|sdev
comma
id|sbus
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;audio&quot;
)paren
)paren
(brace
multiline_comment|/* Don&squot;t go over the max number of drivers. */
r_if
c_cond
(paren
id|num_drivers
op_ge
id|MAX_DRIVERS
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|amd7930_attach
c_func
(paren
op_amp
id|drivers
(braket
id|num_drivers
)braket
comma
id|sdev-&gt;prom_node
comma
id|sdev-&gt;bus
comma
id|sdev
)paren
op_eq
l_int|0
)paren
id|num_drivers
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Only return success if we found some amd7930 chips. */
r_return
(paren
id|num_drivers
OG
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_drivers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|amd7930_detach
c_func
(paren
op_amp
id|drivers
(braket
id|i
)braket
)paren
suffix:semicolon
id|num_drivers
op_decrement
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*************************************************************/
multiline_comment|/*                 Audio format conversion                   */
multiline_comment|/*************************************************************/
multiline_comment|/* Translation tables */
DECL|variable|ulaw
r_static
r_int
r_char
id|ulaw
(braket
)braket
op_assign
(brace
l_int|3
comma
l_int|7
comma
l_int|11
comma
l_int|15
comma
l_int|19
comma
l_int|23
comma
l_int|27
comma
l_int|31
comma
l_int|35
comma
l_int|39
comma
l_int|43
comma
l_int|47
comma
l_int|51
comma
l_int|55
comma
l_int|59
comma
l_int|63
comma
l_int|66
comma
l_int|68
comma
l_int|70
comma
l_int|72
comma
l_int|74
comma
l_int|76
comma
l_int|78
comma
l_int|80
comma
l_int|82
comma
l_int|84
comma
l_int|86
comma
l_int|88
comma
l_int|90
comma
l_int|92
comma
l_int|94
comma
l_int|96
comma
l_int|98
comma
l_int|99
comma
l_int|100
comma
l_int|101
comma
l_int|102
comma
l_int|103
comma
l_int|104
comma
l_int|105
comma
l_int|106
comma
l_int|107
comma
l_int|108
comma
l_int|109
comma
l_int|110
comma
l_int|111
comma
l_int|112
comma
l_int|113
comma
l_int|113
comma
l_int|114
comma
l_int|114
comma
l_int|115
comma
l_int|115
comma
l_int|116
comma
l_int|116
comma
l_int|117
comma
l_int|117
comma
l_int|118
comma
l_int|118
comma
l_int|119
comma
l_int|119
comma
l_int|120
comma
l_int|120
comma
l_int|121
comma
l_int|121
comma
l_int|121
comma
l_int|122
comma
l_int|122
comma
l_int|122
comma
l_int|122
comma
l_int|123
comma
l_int|123
comma
l_int|123
comma
l_int|123
comma
l_int|124
comma
l_int|124
comma
l_int|124
comma
l_int|124
comma
l_int|125
comma
l_int|125
comma
l_int|125
comma
l_int|125
comma
l_int|125
comma
l_int|125
comma
l_int|126
comma
l_int|126
comma
l_int|126
comma
l_int|126
comma
l_int|126
comma
l_int|126
comma
l_int|126
comma
l_int|126
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|127
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|253
comma
l_int|249
comma
l_int|245
comma
l_int|241
comma
l_int|237
comma
l_int|233
comma
l_int|229
comma
l_int|225
comma
l_int|221
comma
l_int|217
comma
l_int|213
comma
l_int|209
comma
l_int|205
comma
l_int|201
comma
l_int|197
comma
l_int|193
comma
l_int|190
comma
l_int|188
comma
l_int|186
comma
l_int|184
comma
l_int|182
comma
l_int|180
comma
l_int|178
comma
l_int|176
comma
l_int|174
comma
l_int|172
comma
l_int|170
comma
l_int|168
comma
l_int|166
comma
l_int|164
comma
l_int|162
comma
l_int|160
comma
l_int|158
comma
l_int|157
comma
l_int|156
comma
l_int|155
comma
l_int|154
comma
l_int|153
comma
l_int|152
comma
l_int|151
comma
l_int|150
comma
l_int|149
comma
l_int|148
comma
l_int|147
comma
l_int|146
comma
l_int|145
comma
l_int|144
comma
l_int|143
comma
l_int|143
comma
l_int|142
comma
l_int|142
comma
l_int|141
comma
l_int|141
comma
l_int|140
comma
l_int|140
comma
l_int|139
comma
l_int|139
comma
l_int|138
comma
l_int|138
comma
l_int|137
comma
l_int|137
comma
l_int|136
comma
l_int|136
comma
l_int|135
comma
l_int|135
comma
l_int|135
comma
l_int|134
comma
l_int|134
comma
l_int|134
comma
l_int|134
comma
l_int|133
comma
l_int|133
comma
l_int|133
comma
l_int|133
comma
l_int|132
comma
l_int|132
comma
l_int|132
comma
l_int|132
comma
l_int|131
comma
l_int|131
comma
l_int|131
comma
l_int|131
comma
l_int|131
comma
l_int|131
comma
l_int|130
comma
l_int|130
comma
l_int|130
comma
l_int|130
comma
l_int|130
comma
l_int|130
comma
l_int|130
comma
l_int|130
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|129
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
comma
l_int|128
)brace
suffix:semicolon
DECL|function|mulaw2bilinear
r_static
id|__u8
id|mulaw2bilinear
c_func
(paren
id|__u8
id|data
)paren
(brace
r_return
id|ulaw
(braket
id|data
)braket
suffix:semicolon
)brace
DECL|variable|linear
r_static
r_int
r_char
id|linear
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|5
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|6
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|7
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|9
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|10
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|11
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|12
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|13
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|14
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|15
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
l_int|17
comma
l_int|0
comma
l_int|18
comma
l_int|0
comma
l_int|19
comma
l_int|0
comma
l_int|20
comma
l_int|0
comma
l_int|21
comma
l_int|0
comma
l_int|22
comma
l_int|0
comma
l_int|23
comma
l_int|0
comma
l_int|24
comma
l_int|0
comma
l_int|25
comma
l_int|0
comma
l_int|26
comma
l_int|0
comma
l_int|27
comma
l_int|0
comma
l_int|28
comma
l_int|0
comma
l_int|29
comma
l_int|0
comma
l_int|30
comma
l_int|0
comma
l_int|31
comma
l_int|0
comma
l_int|32
comma
l_int|33
comma
l_int|34
comma
l_int|35
comma
l_int|36
comma
l_int|37
comma
l_int|38
comma
l_int|39
comma
l_int|40
comma
l_int|41
comma
l_int|42
comma
l_int|43
comma
l_int|44
comma
l_int|45
comma
l_int|46
comma
l_int|48
comma
l_int|50
comma
l_int|52
comma
l_int|54
comma
l_int|56
comma
l_int|58
comma
l_int|60
comma
l_int|62
comma
l_int|65
comma
l_int|69
comma
l_int|73
comma
l_int|77
comma
l_int|83
comma
l_int|91
comma
l_int|103
comma
l_int|255
comma
l_int|231
comma
l_int|219
comma
l_int|211
comma
l_int|205
comma
l_int|201
comma
l_int|197
comma
l_int|193
comma
l_int|190
comma
l_int|188
comma
l_int|186
comma
l_int|184
comma
l_int|182
comma
l_int|180
comma
l_int|178
comma
l_int|176
comma
l_int|174
comma
l_int|173
comma
l_int|172
comma
l_int|171
comma
l_int|170
comma
l_int|169
comma
l_int|168
comma
l_int|167
comma
l_int|166
comma
l_int|165
comma
l_int|164
comma
l_int|163
comma
l_int|162
comma
l_int|161
comma
l_int|160
comma
l_int|0
comma
l_int|159
comma
l_int|0
comma
l_int|158
comma
l_int|0
comma
l_int|157
comma
l_int|0
comma
l_int|156
comma
l_int|0
comma
l_int|155
comma
l_int|0
comma
l_int|154
comma
l_int|0
comma
l_int|153
comma
l_int|0
comma
l_int|152
comma
l_int|0
comma
l_int|151
comma
l_int|0
comma
l_int|150
comma
l_int|0
comma
l_int|149
comma
l_int|0
comma
l_int|148
comma
l_int|0
comma
l_int|147
comma
l_int|0
comma
l_int|146
comma
l_int|0
comma
l_int|145
comma
l_int|0
comma
l_int|144
comma
l_int|0
comma
l_int|0
comma
l_int|143
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|142
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|141
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|140
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|139
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|138
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|137
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|136
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|135
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|134
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|133
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|132
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|131
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|130
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|129
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|128
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|function|bilinear2mulaw
r_static
id|__u8
id|bilinear2mulaw
c_func
(paren
id|__u8
id|data
)paren
(brace
r_return
id|linear
(braket
id|data
)braket
suffix:semicolon
)brace
DECL|variable|exp_lut
r_static
r_int
id|exp_lut
(braket
l_int|256
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
)brace
suffix:semicolon
DECL|macro|BIAS
mdefine_line|#define BIAS 0x84
DECL|macro|CLIP
mdefine_line|#define CLIP 32635
DECL|macro|SWAP_ENDIAN
mdefine_line|#define SWAP_ENDIAN(x) ((x &gt;&gt; 8) | ((x &amp; 0xff) &lt;&lt; 8))
DECL|function|linear2mulaw
r_static
id|__u8
id|linear2mulaw
c_func
(paren
id|__u16
id|data
)paren
(brace
r_static
r_int
id|sign
comma
id|exponent
comma
id|mantissa
suffix:semicolon
multiline_comment|/* not really sure, if swapping is ok - comment next line to disable it */
id|data
op_assign
id|SWAP_ENDIAN
c_func
(paren
id|data
)paren
suffix:semicolon
id|sign
op_assign
(paren
id|data
op_rshift
l_int|8
)paren
op_amp
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|sign
op_ne
l_int|0
)paren
id|data
op_assign
op_minus
id|data
suffix:semicolon
r_if
c_cond
(paren
id|data
OG
id|CLIP
)paren
id|data
op_assign
id|CLIP
suffix:semicolon
id|data
op_add_assign
id|BIAS
suffix:semicolon
id|exponent
op_assign
id|exp_lut
(braket
(paren
id|data
op_rshift
l_int|7
)paren
op_amp
l_int|0xFF
)braket
suffix:semicolon
id|mantissa
op_assign
(paren
id|data
op_rshift
(paren
id|exponent
op_plus
l_int|3
)paren
)paren
op_amp
l_int|0x0F
suffix:semicolon
r_return
(paren
op_complement
(paren
id|sign
op_or
(paren
id|exponent
op_lshift
l_int|4
)paren
op_or
id|mantissa
)paren
)paren
suffix:semicolon
)brace
DECL|function|mulaw2linear
r_static
id|__u16
id|mulaw2linear
c_func
(paren
id|__u8
id|data
)paren
(brace
multiline_comment|/* this conversion is not working */
r_return
id|data
suffix:semicolon
)brace
macro_line|#if 0
mdefine_line|#define INOUT(x,y) (((x) &lt;&lt; 16) | (y))
r_static
r_int
id|convert_audio
c_func
(paren
r_int
id|in_format
comma
r_int
id|out_format
comma
id|__u8
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_static
r_int
id|i
comma
id|sign
comma
id|exponent
suffix:semicolon
r_static
id|__u16
id|data
suffix:semicolon
r_if
c_cond
(paren
id|in_format
op_eq
id|out_format
)paren
r_return
id|count
suffix:semicolon
r_switch
c_cond
(paren
id|INOUT
c_func
(paren
id|in_format
comma
id|out_format
)paren
)paren
(brace
r_case
id|INOUT
c_func
(paren
id|AUDIO_ENCODING_ULAW
comma
id|AUDIO_ENCODING_LINEAR8
)paren
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buffer
(braket
id|i
)braket
op_assign
id|ulaw
(braket
id|buffer
(braket
id|i
)braket
)braket
suffix:semicolon
)brace
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INOUT
c_func
(paren
id|AUDIO_ENCODING_ULAW
comma
id|AUDIO_ENCODING_LINEAR
)paren
suffix:colon
r_break
suffix:semicolon
r_case
id|INOUT
c_func
(paren
id|AUDIO_ENCODING_LINEAR
comma
id|AUDIO_ENCODING_ULAW
)paren
suffix:colon
multiline_comment|/* buffer is two-byte =&gt; convert to first */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
op_assign
(paren
(paren
id|__u16
op_star
)paren
id|buffer
)paren
(braket
id|i
)braket
suffix:semicolon
id|sign
op_assign
(paren
id|data
op_rshift
l_int|8
)paren
op_amp
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|data
OG
id|CLIP
)paren
id|data
op_assign
id|CLIP
suffix:semicolon
id|data
op_add_assign
id|BIAS
suffix:semicolon
id|exponent
op_assign
id|exp_lut
(braket
(paren
id|data
op_rshift
l_int|7
)paren
op_amp
l_int|0xFF
)braket
suffix:semicolon
id|buffer
(braket
id|i
)braket
op_assign
op_complement
(paren
id|sign
op_or
(paren
id|exponent
op_lshift
l_int|4
)paren
op_or
(paren
(paren
id|data
op_rshift
(paren
id|exponent
op_plus
l_int|3
)paren
)paren
op_amp
l_int|0x0F
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INOUT
c_func
(paren
id|AUDIO_ENCODING_LINEAR8
comma
id|AUDIO_ENCODING_ULAW
)paren
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buffer
(braket
id|i
)braket
op_assign
id|linear
(braket
id|buffer
(braket
id|i
)braket
)braket
suffix:semicolon
)brace
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
macro_line|#undef INOUT
macro_line|#endif
DECL|macro|BIAS
macro_line|#undef BIAS
DECL|macro|CLIP
macro_line|#undef CLIP
DECL|macro|SWAP_ENDIAN
macro_line|#undef SWAP_ENDIAN
eof
