multiline_comment|/* $Id: dbri.c,v 1.22 2000/10/27 07:01:38 uzi Exp $&n; * drivers/sbus/audio/dbri.c&n; *&n; * Copyright (C) 1997 Rudolf Koenig (rfkoenig@immd4.informatik.uni-erlangen.de)&n; * Copyright (C) 1998, 1999 Brent Baccala (baccala@freesoft.org)&n; *&n; * This is the lowlevel driver for the DBRI &amp; MMCODEC duo used for ISDN &amp; AUDIO&n; * on Sun SPARCstation 10, 20, LX and Voyager models.&n; *&n; * - DBRI: AT&amp;T T5900FX Dual Basic Rates ISDN Interface. It is a 32 channel&n; *   data time multiplexer with ISDN support (aka T7259)&n; *   Interfaces: SBus,ISDN NT &amp; TE, CHI, 4 bits parallel.&n; *   CHI: (spelled ki) Concentration Highway Interface (AT&amp;T or Intel bus ?).&n; *   Documentation:&n; *   - &quot;STP 4000SBus Dual Basic Rate ISDN (DBRI) Tranceiver&quot; from&n; *     Sparc Technology Business (courtesy of Sun Support)&n; *   - Data sheet of the T7903, a newer but very similar ISA bus equivalent&n; *     available from the Lucent (formarly AT&amp;T microelectronics) home&n; *     page.&n; * - MMCODEC: Crystal Semiconductor CS4215 16 bit Multimedia Audio Codec&n; *   Interfaces: CHI, Audio In &amp; Out, 2 bits parallel&n; *   Documentation: from the Crystal Semiconductor home page.&n; *&n; * The DBRI is a 32 pipe machine, each pipe can transfer some bits between&n; * memory and a serial device (long pipes, nr 0-15) or between two serial&n; * devices (short pipes, nr 16-31), or simply send a fixed data to a serial&n; * device (short pipes).&n; * A timeslot defines the bit-offset and nr of bits read from a serial device.&n; * The timeslots are linked to 6 circular lists, one for each direction for&n; * each serial device (NT,TE,CHI). A timeslot is associated to 1 or 2 pipes&n; * (the second one is a monitor/tee pipe, valid only for serial input).&n; *&n; * The mmcodec is connected via the CHI bus and needs the data &amp; some&n; * parameters (volume, balance, output selection) timemultiplexed in 8 byte&n; * chunks. It also has a control mode, which serves for audio format setting.&n; *&n; * Looking at the CS4215 data sheet it is easy to set up 2 or 4 codecs on&n; * the same CHI bus, so I thought perhaps it is possible to use the onboard&n; * &amp; the speakerbox codec simultanously, giving 2 (not very independent :-)&n; * audio devices. But the SUN HW group decided against it, at least on my&n; * LX the speakerbox connector has at least 1 pin missing and 1 wrongly&n; * connected.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/audioio.h&gt;
macro_line|#include &quot;dbri.h&quot;
macro_line|#if defined(DBRI_ISDN) || defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x200ff
macro_line|#include &quot;../../isdn/hisax/hisax.h&quot;
macro_line|#include &quot;../../isdn/hisax/isdnl1.h&quot;
macro_line|#include &quot;../../isdn/hisax/foreign.h&quot;
macro_line|#endif
DECL|macro|DBRI_DEBUG
mdefine_line|#define DBRI_DEBUG
macro_line|#ifdef DBRI_DEBUG
DECL|macro|dprintk
mdefine_line|#define dprintk(a, x) if(dbri_debug &amp; a) printk x
DECL|macro|D_GEN
mdefine_line|#define D_GEN&t;(1&lt;&lt;0)
DECL|macro|D_INT
mdefine_line|#define D_INT&t;(1&lt;&lt;1)
DECL|macro|D_CMD
mdefine_line|#define D_CMD&t;(1&lt;&lt;2)
DECL|macro|D_MM
mdefine_line|#define D_MM&t;(1&lt;&lt;3)
DECL|macro|D_USR
mdefine_line|#define D_USR&t;(1&lt;&lt;4)
DECL|macro|D_DESC
mdefine_line|#define D_DESC&t;(1&lt;&lt;5)
DECL|variable|dbri_debug
r_static
r_int
id|dbri_debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dbri_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|dbri_trace
r_static
r_int
id|dbri_trace
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dbri_trace
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|tprintk
mdefine_line|#define tprintk(x) if(dbri_trace) printk x
DECL|variable|cmds
r_static
r_char
op_star
id|cmds
(braket
)braket
op_assign
(brace
l_string|&quot;WAIT&quot;
comma
l_string|&quot;PAUSE&quot;
comma
l_string|&quot;JUMP&quot;
comma
l_string|&quot;IIQ&quot;
comma
l_string|&quot;REX&quot;
comma
l_string|&quot;SDP&quot;
comma
l_string|&quot;CDP&quot;
comma
l_string|&quot;DTS&quot;
comma
l_string|&quot;SSP&quot;
comma
l_string|&quot;CHI&quot;
comma
l_string|&quot;NT&quot;
comma
l_string|&quot;TE&quot;
comma
l_string|&quot;CDEC&quot;
comma
l_string|&quot;TEST&quot;
comma
l_string|&quot;CDM&quot;
comma
l_string|&quot;RESRV&quot;
)brace
suffix:semicolon
DECL|macro|DBRI_CMD
mdefine_line|#define DBRI_CMD(cmd, intr, value) ((cmd &lt;&lt; 28) | (1 &lt;&lt; 27) | value)
macro_line|#else
DECL|macro|dprintk
mdefine_line|#define dprintk(a, x)
DECL|macro|DBRI_CMD
mdefine_line|#define DBRI_CMD(cmd, intr, value) ((cmd &lt;&lt; 28) | (intr &lt;&lt; 27) | value)
macro_line|#endif&t;/* DBRI_DEBUG */
DECL|macro|MAX_DRIVERS
mdefine_line|#define MAX_DRIVERS&t;2&t;/* Increase this if need more than 2 DBRI&squot;s */
DECL|variable|drivers
r_static
r_struct
id|sparcaudio_driver
id|drivers
(braket
id|MAX_DRIVERS
)braket
suffix:semicolon
DECL|variable|num_drivers
r_static
r_int
id|num_drivers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;****************************************************************************&n;************** DBRI initialization and command synchronization *************&n;****************************************************************************&n;&n;Commands are sent to the DBRI by building a list of them in memory,&n;then writing the address of the first list item to DBRI register 8.&n;The list is terminated with a WAIT command, which can generate a&n;CPU interrupt if required.&n;&n;Since the DBRI can run in parallel with the CPU, several means of&n;synchronization present themselves.  The original scheme (Rudolf&squot;s)&n;was to set a flag when we &quot;cmdlock&quot;ed the DBRI, clear the flag when&n;an interrupt signaled completion, and wait on a wait_queue if a routine&n;attempted to cmdlock while the flag was set.  The problems arose when&n;we tried to cmdlock from inside an interrupt handler, which might&n;cause scheduling in an interrupt (if we waited), etc, etc&n;&n;A more sophisticated scheme might involve a circular command buffer&n;or an array of command buffers.  A routine could fill one with&n;commands and link it onto a list.  When a interrupt signaled&n;completion of the current command buffer, look on the list for&n;the next one.&n;&n;I&squot;ve decided to implement something much simpler - after each command,&n;the CPU waits for the DBRI to finish the command by polling the P bit&n;in DBRI register 0.  I&squot;ve tried to implement this in such a way&n;that might make implementing a more sophisticated scheme easier.&n;&n;Every time a routine wants to write commands to the DBRI, it must&n;first call dbri_cmdlock() and get an initial pointer into dbri-&gt;dma-&gt;cmd&n;in return.  After the commands have been writen, dbri_cmdsend() is&n;called with the final pointer value.&n;&n;Something a little more clever is required if this code is ever run&n;on an SMP machine.&n;&n;*/
DECL|variable|dbri_locked
r_static
r_int
id|dbri_locked
op_assign
l_int|0
suffix:semicolon
DECL|function|dbri_cmdlock
r_static
r_volatile
id|s32
op_star
id|dbri_cmdlock
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_if
c_cond
(paren
id|dbri_locked
)paren
id|printk
c_func
(paren
l_string|&quot;DBRI: Command buffer locked! (bug in driver)&bslash;n&quot;
)paren
suffix:semicolon
id|dbri_locked
op_increment
suffix:semicolon
r_return
op_amp
id|dbri-&gt;dma-&gt;cmd
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_static
r_void
id|dbri_process_interrupt_buffer
c_func
(paren
r_struct
id|dbri
op_star
)paren
suffix:semicolon
DECL|function|dbri_cmdsend
r_static
r_void
id|dbri_cmdsend
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_volatile
id|s32
op_star
id|cmd
)paren
(brace
r_int
id|MAXLOOPS
op_assign
l_int|1000000
suffix:semicolon
r_int
id|maxloops
op_assign
id|MAXLOOPS
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_volatile
id|s32
op_star
id|ptr
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
op_amp
id|dbri-&gt;dma-&gt;cmd
(braket
l_int|0
)braket
suffix:semicolon
id|ptr
OL
id|cmd
suffix:semicolon
id|ptr
op_increment
)paren
(brace
id|dprintk
c_func
(paren
id|D_CMD
comma
(paren
l_string|&quot;DBRI cmd: %lx:%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ptr
comma
op_star
id|ptr
)paren
)paren
suffix:semicolon
)brace
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|dbri_locked
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|dbri_locked
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Command buffer improperly locked! (bug in driver)&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|cmd
op_minus
op_amp
id|dbri-&gt;dma-&gt;cmd
(braket
l_int|0
)braket
)paren
op_ge
id|DBRI_NO_CMDS
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Command buffer overflow! (bug in driver)&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_WAIT
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|dbri-&gt;wait_seen
op_assign
l_int|0
suffix:semicolon
id|sbus_writel
c_func
(paren
id|dbri-&gt;dma_dvma
comma
id|dbri-&gt;regs
op_plus
id|REG8
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_decrement
id|maxloops
)paren
OG
l_int|0
op_logical_and
(paren
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
op_amp
id|D_P
)paren
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maxloops
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Chip never completed command buffer&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
(paren
op_decrement
id|maxloops
)paren
OG
l_int|0
op_logical_and
(paren
op_logical_neg
id|dbri-&gt;wait_seen
)paren
)paren
id|dbri_process_interrupt_buffer
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maxloops
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Chip never acked WAIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: Chip completed command &quot;
l_string|&quot;buffer (%d)&bslash;n&quot;
comma
id|MAXLOOPS
op_minus
id|maxloops
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|dbri_reset
r_static
r_void
id|dbri_reset
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: reset 0:%x 2:%x 8:%x 9:%x&bslash;n&quot;
comma
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
comma
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG2
)paren
comma
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG8
)paren
comma
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG9
)paren
)paren
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|D_R
comma
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
multiline_comment|/* Soft Reset */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
op_amp
id|D_R
)paren
op_logical_and
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
DECL|function|dbri_detach
r_static
r_void
id|dbri_detach
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
id|dbri_reset
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dbri-&gt;irq
comma
id|dbri
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|dbri-&gt;regs
comma
id|dbri-&gt;regs_size
)paren
suffix:semicolon
id|sbus_free_consistent
c_func
(paren
id|dbri-&gt;sdev
comma
r_sizeof
(paren
r_struct
id|dbri_dma
)paren
comma
(paren
r_void
op_star
)paren
id|dbri-&gt;dma
comma
id|dbri-&gt;dma_dvma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dbri
)paren
suffix:semicolon
)brace
DECL|function|dbri_initialize
r_static
r_void
id|dbri_initialize
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_volatile
id|s32
op_star
id|cmd
suffix:semicolon
id|u32
id|dma_addr
comma
id|tmp
suffix:semicolon
r_int
id|n
suffix:semicolon
id|dbri_reset
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: init: cmd: %p, int: %p&bslash;n&quot;
comma
op_amp
id|dbri-&gt;dma-&gt;cmd
(braket
l_int|0
)braket
comma
op_amp
id|dbri-&gt;dma-&gt;intr
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the interrupt ringbuffer.&n;&t; */
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|DBRI_NO_INTS
op_minus
l_int|1
suffix:semicolon
id|n
op_increment
)paren
(brace
id|dma_addr
op_assign
id|dbri-&gt;dma_dvma
suffix:semicolon
id|dma_addr
op_add_assign
id|dbri_dma_off
c_func
(paren
id|intr
comma
(paren
(paren
id|n
op_plus
l_int|1
)paren
op_amp
id|DBRI_INT_BLK
)paren
)paren
suffix:semicolon
id|dbri-&gt;dma-&gt;intr
(braket
id|n
op_star
id|DBRI_INT_BLK
)braket
op_assign
id|dma_addr
suffix:semicolon
)brace
id|dma_addr
op_assign
id|dbri-&gt;dma_dvma
op_plus
id|dbri_dma_off
c_func
(paren
id|intr
comma
l_int|0
)paren
suffix:semicolon
id|dbri-&gt;dma-&gt;intr
(braket
id|n
op_star
id|DBRI_INT_BLK
)braket
op_assign
id|dma_addr
suffix:semicolon
id|dbri-&gt;dbri_irqp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* We should query the openprom to see what burst sizes this&n;         * SBus supports.  For now, just disable all SBus bursts */
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|D_G
op_or
id|D_S
op_or
id|D_E
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|tmp
comma
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set up the interrupt queue&n;&t; */
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|dma_addr
op_assign
id|dbri-&gt;dma_dvma
op_plus
id|dbri_dma_off
c_func
(paren
id|intr
comma
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_IIQ
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|dma_addr
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;****************************************************************************&n;*************************** DBRI interrupt handler *************************&n;****************************************************************************&n;&n;The DBRI communicates with the CPU mainly via a circular interrupt&n;buffer.  When an interrupt is signaled, the CPU walks through the&n;buffer and calls dbri_process_one_interrupt() for each interrupt word.&n;Complicated interrupts are handled by dedicated functions (which&n;appear first in this file).  Any pending interrupts can be serviced by&n;calling dbri_process_interrupt_buffer(), which works even if the CPU&squot;s&n;interrupts are disabled.  This function is used by dbri_cmdsend()&n;to make sure we&squot;re synced up with the chip after each command sequence,&n;even if we&squot;re running cli&squot;ed.&n;&n;*/
multiline_comment|/*&n; * Short data pipes transmit LSB first. The CS4215 receives MSB first. Grrr.&n; * So we have to reverse the bits. Note: not all bit lengths are supported&n; */
DECL|function|reverse_bytes
r_static
id|__u32
id|reverse_bytes
c_func
(paren
id|__u32
id|b
comma
r_int
id|len
)paren
(brace
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|32
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xffff0000
)paren
op_rshift
l_int|16
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x0000ffff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_case
l_int|16
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xff00ff00
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x00ff00ff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_case
l_int|8
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xf0f0f0f0
)paren
op_rshift
l_int|4
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x0f0f0f0f
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
r_case
l_int|4
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xcccccccc
)paren
op_rshift
l_int|2
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x33333333
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xaaaaaaaa
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x55555555
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DBRI reverse_bytes: unsupported length&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
r_return
id|b
suffix:semicolon
)brace
multiline_comment|/* transmission_complete_intr()&n; *&n; * Called by main interrupt handler when DBRI signals transmission complete&n; * on a pipe (interrupt triggered by the B bit in a transmit descriptor).&n; *&n; * Walks through the pipe&squot;s list of transmit buffer descriptors, releasing&n; * each one&squot;s DMA buffer (if present), flagging the descriptor available,&n; * and signaling its callback routine (if present), before proceeding&n; * to the next one.  Stops when the first descriptor is found without&n; * TBC (Transmit Buffer Complete) set, or we&squot;ve run through them all.&n; */
DECL|function|transmission_complete_intr
r_static
r_void
id|transmission_complete_intr
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
)paren
(brace
r_int
id|td
suffix:semicolon
r_int
id|status
suffix:semicolon
r_void
op_star
id|buffer
suffix:semicolon
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
suffix:semicolon
r_void
op_star
id|callback_arg
suffix:semicolon
id|td
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
suffix:semicolon
r_while
c_loop
(paren
id|td
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|td
op_ge
id|DBRI_NO_DESCS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: invalid td on pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|status
op_assign
id|DBRI_TD_STATUS
c_func
(paren
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|word4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|DBRI_TD_TBC
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: TD %d, status 0x%02x&bslash;n&quot;
comma
id|td
comma
id|status
)paren
)paren
suffix:semicolon
id|buffer
op_assign
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|buffer
)paren
id|sbus_unmap_single
c_func
(paren
id|dbri-&gt;sdev
comma
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|buffer_dvma
comma
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|len
comma
id|SBUS_DMA_TODEVICE
)paren
suffix:semicolon
id|callback
op_assign
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|output_callback
suffix:semicolon
id|callback_arg
op_assign
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|output_callback_arg
suffix:semicolon
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|inuse
op_assign
l_int|0
suffix:semicolon
id|td
op_assign
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|next
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
id|td
suffix:semicolon
r_if
c_cond
(paren
id|callback
op_ne
l_int|NULL
)paren
id|callback
c_func
(paren
id|callback_arg
comma
id|status
op_amp
l_int|0xe
)paren
suffix:semicolon
)brace
)brace
DECL|function|reception_complete_intr
r_static
r_void
id|reception_complete_intr
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
)paren
(brace
r_int
id|rd
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
suffix:semicolon
id|s32
id|status
suffix:semicolon
r_void
op_star
id|buffer
suffix:semicolon
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
OL
l_int|0
op_logical_or
id|rd
op_ge
id|DBRI_NO_DESCS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: invalid rd on pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|inuse
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|next
suffix:semicolon
id|status
op_assign
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|word1
suffix:semicolon
id|buffer
op_assign
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|buffer
)paren
id|sbus_unmap_single
c_func
(paren
id|dbri-&gt;sdev
comma
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|buffer_dvma
comma
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|len
comma
id|SBUS_DMA_FROMDEVICE
)paren
suffix:semicolon
id|callback
op_assign
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|input_callback
suffix:semicolon
r_if
c_cond
(paren
id|callback
op_ne
l_int|NULL
)paren
id|callback
c_func
(paren
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|input_callback_arg
comma
id|DBRI_RD_STATUS
c_func
(paren
id|status
)paren
comma
id|DBRI_RD_CNT
c_func
(paren
id|status
)paren
op_minus
l_int|2
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: Recv RD %d, status 0x%02x, len %d&bslash;n&quot;
comma
id|rd
comma
id|DBRI_RD_STATUS
c_func
(paren
id|status
)paren
comma
id|DBRI_RD_CNT
c_func
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|dbri_process_one_interrupt
r_static
r_void
id|dbri_process_one_interrupt
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|x
)paren
(brace
r_int
id|val
op_assign
id|D_INTR_GETVAL
c_func
(paren
id|x
)paren
suffix:semicolon
r_int
id|channel
op_assign
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
suffix:semicolon
r_int
id|command
op_assign
id|D_INTR_GETCMD
c_func
(paren
id|x
)paren
suffix:semicolon
r_int
id|code
op_assign
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
suffix:semicolon
r_int
id|rval
op_assign
id|D_INTR_GETRVAL
c_func
(paren
id|x
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_eq
id|D_INTR_CMD
)paren
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: INTR: Command: %-5s  Value:%d&bslash;n&quot;
comma
id|cmds
(braket
id|command
)braket
comma
id|val
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: INTR: Chan:%d Code:%d Val:%#x&bslash;n&quot;
comma
id|channel
comma
id|code
comma
id|rval
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|channel
op_eq
id|D_INTR_CMD
op_logical_and
id|command
op_eq
id|D_WAIT
)paren
id|dbri-&gt;wait_seen
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|D_INTR_SBRI
)paren
(brace
multiline_comment|/* SBRI - BRI status change */
r_const
r_int
id|liu_states
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|0
comma
l_int|8
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
)brace
suffix:semicolon
id|dbri-&gt;liu_state
op_assign
id|liu_states
(braket
id|val
op_amp
l_int|0x7
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;liu_callback
)paren
id|dbri
op_member_access_from_pointer
id|liu_callback
c_func
(paren
id|dbri-&gt;liu_callback_arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|code
op_eq
id|D_INTR_BRDY
)paren
id|reception_complete_intr
c_func
(paren
id|dbri
comma
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|D_INTR_XCMP
)paren
id|transmission_complete_intr
c_func
(paren
id|dbri
comma
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
id|D_INTR_UNDR
)paren
(brace
multiline_comment|/* UNDR - Transmission underrun&n;&t;&t; * resend SDP command with clear pipe bit (C) set&n;&t;&t; */
r_volatile
id|s32
op_star
id|cmd
suffix:semicolon
r_int
id|pipe
op_assign
id|channel
suffix:semicolon
r_int
id|td
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|word4
op_assign
l_int|0
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_or
id|D_SDP_P
op_or
id|D_SDP_C
op_or
id|D_SDP_2SAME
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|dbri-&gt;dma_dvma
op_plus
id|dbri_dma_off
c_func
(paren
id|desc
comma
id|td
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|code
op_eq
id|D_INTR_FXDT
)paren
(brace
multiline_comment|/* FXDT - Fixed data change */
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|channel
)braket
dot
id|sdp
op_amp
id|D_SDP_MSB
)paren
id|val
op_assign
id|reverse_bytes
c_func
(paren
id|val
comma
id|dbri-&gt;pipes
(braket
id|channel
)braket
dot
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|channel
)braket
dot
id|recv_fixed_ptr
)paren
op_star
(paren
id|dbri-&gt;pipes
(braket
id|channel
)braket
dot
id|recv_fixed_ptr
)paren
op_assign
id|val
suffix:semicolon
)brace
)brace
multiline_comment|/* dbri_process_interrupt_buffer advances through the DBRI&squot;s interrupt&n; * buffer until it finds a zero word (indicating nothing more to do&n; * right now).  Non-zero words require processing and are handed off&n; * to dbri_process_one_interrupt AFTER advancing the pointer.  This&n; * order is important since we might recurse back into this function&n; * and need to make sure the pointer has been advanced first.&n; */
DECL|function|dbri_process_interrupt_buffer
r_static
r_void
id|dbri_process_interrupt_buffer
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
id|s32
id|x
suffix:semicolon
r_while
c_loop
(paren
(paren
id|x
op_assign
id|dbri-&gt;dma-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
)paren
op_ne
l_int|0
)paren
(brace
id|dbri-&gt;dma-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;dbri_irqp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;dbri_irqp
op_eq
(paren
id|DBRI_NO_INTS
op_star
id|DBRI_INT_BLK
)paren
)paren
id|dbri-&gt;dbri_irqp
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|dbri-&gt;dbri_irqp
op_amp
(paren
id|DBRI_INT_BLK
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
id|dbri-&gt;dbri_irqp
op_increment
suffix:semicolon
id|tprintk
c_func
(paren
(paren
l_string|&quot;dbri-&gt;dbri_irqp == %d&bslash;n&quot;
comma
id|dbri-&gt;dbri_irqp
)paren
)paren
suffix:semicolon
id|dbri_process_one_interrupt
c_func
(paren
id|dbri
comma
id|x
)paren
suffix:semicolon
)brace
)brace
DECL|function|dbri_intr
r_static
r_void
id|dbri_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|opaque
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|opaque
suffix:semicolon
r_int
id|x
suffix:semicolon
multiline_comment|/*&n;&t; * Read it, so the interrupt goes away.&n;&t; */
id|x
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG1
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: Interrupt!  (reg1=0x%08x)&bslash;n&quot;
comma
id|x
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_amp
(paren
id|D_MRR
op_or
id|D_MLE
op_or
id|D_LBG
op_or
id|D_MBE
)paren
)paren
(brace
id|u32
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|x
op_amp
id|D_MRR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Multiple Error Ack on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_MLE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Multiple Late Error on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_LBG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Lost Bus Grant on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_MBE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Burst Error on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Some of these SBus errors cause the chip&squot;s SBus circuitry&n;&t;&t; * to be disabled, so just re-enable and try to keep going.&n;&t;&t; *&n;&t;&t; * The only one I&squot;ve seen is MRR, which will be triggered&n;&t;&t; * if you let a transmit pipe underrun, then try to CDP it.&n;&t;&t; *&n;&t;&t; * If these things persist, we should probably reset&n;&t;&t; * and re-init the chip.&n;&t;&t; */
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|D_D
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|tmp
comma
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
(paren
id|x
op_amp
id|D_IR
)paren
)paren
multiline_comment|/* Not for us */
r_return
suffix:semicolon
macro_line|#endif
id|dbri_process_interrupt_buffer
c_func
(paren
id|dbri
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;****************************************************************************&n;************************** DBRI data pipe management ***********************&n;****************************************************************************&n;&n;While DBRI control functions use the command and interrupt buffers, the&n;main data path takes the form of data pipes, which can be short (command&n;and interrupt driven), or long (attached to DMA buffers).  These functions&n;provide a rudimentary means of setting up and managing the DBRI&squot;s pipes,&n;but the calling functions have to make sure they respect the pipes&squot; linked&n;list ordering, among other things.  The transmit and receive functions&n;here interface closely with the transmit and receive interrupt code.&n;&n;*/
DECL|function|pipe_active
r_static
r_int
id|pipe_active
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
)paren
(brace
r_return
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_ne
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* reset_pipe(dbri, pipe)&n; *&n; * Called on an in-use pipe to clear anything being transmitted or received&n; */
DECL|function|reset_pipe
r_static
r_void
id|reset_pipe
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
)paren
(brace
r_int
id|sdp
suffix:semicolon
r_int
id|desc
suffix:semicolon
r_volatile
r_int
op_star
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: reset_pipe called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sdp
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
suffix:semicolon
r_if
c_cond
(paren
id|sdp
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: reset_pipe called on uninitialized pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|sdp
op_or
id|D_SDP_C
op_or
id|D_SDP_P
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
id|desc
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
suffix:semicolon
r_while
c_loop
(paren
id|desc
op_ne
op_minus
l_int|1
)paren
(brace
r_void
op_star
id|buffer
op_assign
id|dbri-&gt;descs
(braket
id|desc
)braket
dot
id|buffer
suffix:semicolon
r_void
(paren
op_star
id|output_callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
op_assign
id|dbri-&gt;descs
(braket
id|desc
)braket
dot
id|output_callback
suffix:semicolon
r_void
op_star
id|output_callback_arg
op_assign
id|dbri-&gt;descs
(braket
id|desc
)braket
dot
id|output_callback_arg
suffix:semicolon
r_void
(paren
op_star
id|input_callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
op_assign
id|dbri-&gt;descs
(braket
id|desc
)braket
dot
id|input_callback
suffix:semicolon
r_void
op_star
id|input_callback_arg
op_assign
id|dbri-&gt;descs
(braket
id|desc
)braket
dot
id|input_callback_arg
suffix:semicolon
r_if
c_cond
(paren
id|buffer
)paren
id|sbus_unmap_single
c_func
(paren
id|dbri-&gt;sdev
comma
id|dbri-&gt;descs
(braket
id|desc
)braket
dot
id|buffer_dvma
comma
id|dbri-&gt;descs
(braket
id|desc
)braket
dot
id|len
comma
id|output_callback
op_ne
l_int|NULL
ques
c_cond
id|SBUS_DMA_TODEVICE
suffix:colon
id|SBUS_DMA_FROMDEVICE
)paren
suffix:semicolon
id|dbri-&gt;descs
(braket
id|desc
)braket
dot
id|inuse
op_assign
l_int|0
suffix:semicolon
id|desc
op_assign
id|dbri-&gt;descs
(braket
id|desc
)braket
dot
id|next
suffix:semicolon
r_if
c_cond
(paren
id|output_callback
)paren
id|output_callback
c_func
(paren
id|output_callback_arg
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input_callback
)paren
id|input_callback
c_func
(paren
id|input_callback_arg
comma
op_minus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|setup_pipe
r_static
r_void
id|setup_pipe
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_int
id|sdp
)paren
(brace
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: setup_pipe called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sdp
op_amp
l_int|0xf800
)paren
op_ne
id|sdp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: setup_pipe called with strange SDP value&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* sdp &amp;= 0xf800; */
)brace
multiline_comment|/* If this is a fixed receive pipe, arrange for an interrupt&n;&t; * every time its data changes&n;&t; */
r_if
c_cond
(paren
id|D_SDP_MODE
c_func
(paren
id|sdp
)paren
op_eq
id|D_SDP_FIXED
op_logical_and
op_logical_neg
(paren
id|sdp
op_amp
id|D_SDP_TO_SER
)paren
)paren
id|sdp
op_or_assign
id|D_SDP_CHANGE
suffix:semicolon
id|sdp
op_or_assign
id|D_PIPE
c_func
(paren
id|pipe
)paren
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_assign
id|sdp
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
op_minus
l_int|1
suffix:semicolon
id|reset_pipe
c_func
(paren
id|dbri
comma
id|pipe
)paren
suffix:semicolon
)brace
DECL|function|link_time_slot
r_static
r_void
id|link_time_slot
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_enum
id|in_or_out
id|direction
comma
r_int
id|basepipe
comma
r_int
id|length
comma
r_int
id|cycle
)paren
(brace
r_volatile
id|s32
op_star
id|cmd
suffix:semicolon
r_int
id|val
suffix:semicolon
r_int
id|prevpipe
suffix:semicolon
r_int
id|nextpipe
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
op_logical_or
id|basepipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: link_time_slot called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_eq
l_int|0
op_logical_or
id|dbri-&gt;pipes
(braket
id|basepipe
)braket
dot
id|sdp
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: link_time_slot called on uninitialized pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Deal with CHI special case:&n;&t; * &quot;If transmission on edges 0 or 1 is desired, then cycle n&n;&t; *  (where n = # of bit times per frame...) must be used.&quot;&n;&t; *                  - DBRI data sheet, page 11&n;&t; */
r_if
c_cond
(paren
id|basepipe
op_eq
l_int|16
op_logical_and
id|direction
op_eq
id|PIPEoutput
op_logical_and
id|cycle
op_eq
l_int|0
)paren
id|cycle
op_assign
id|dbri-&gt;chi_bpf
suffix:semicolon
r_if
c_cond
(paren
id|basepipe
op_eq
id|pipe
)paren
(brace
id|prevpipe
op_assign
id|pipe
suffix:semicolon
id|nextpipe
op_assign
id|pipe
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We&squot;re not initializing a new linked list (basepipe != pipe),&n;&t;&t; * so run through the linked list and find where this pipe&n;&t;&t; * should be sloted in, based on its cycle.  CHI confuses&n;&t;&t; * things a bit, since it has a single anchor for both its&n;&t;&t; * transmit and receive lists.&n;                 */
r_if
c_cond
(paren
id|basepipe
op_eq
l_int|16
)paren
(brace
r_if
c_cond
(paren
id|direction
op_eq
id|PIPEinput
)paren
(brace
id|prevpipe
op_assign
id|dbri-&gt;chi_in_pipe
suffix:semicolon
)brace
r_else
(brace
id|prevpipe
op_assign
id|dbri-&gt;chi_out_pipe
suffix:semicolon
)brace
)brace
r_else
(brace
id|prevpipe
op_assign
id|basepipe
suffix:semicolon
)brace
id|nextpipe
op_assign
id|dbri-&gt;pipes
(braket
id|prevpipe
)braket
dot
id|nextpipe
suffix:semicolon
r_while
c_loop
(paren
id|dbri-&gt;pipes
(braket
id|nextpipe
)braket
dot
id|cycle
OL
id|cycle
op_logical_and
id|dbri-&gt;pipes
(braket
id|nextpipe
)braket
dot
id|nextpipe
op_ne
id|basepipe
)paren
(brace
id|prevpipe
op_assign
id|nextpipe
suffix:semicolon
id|nextpipe
op_assign
id|dbri-&gt;pipes
(braket
id|nextpipe
)braket
dot
id|nextpipe
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|prevpipe
op_eq
l_int|16
)paren
(brace
r_if
c_cond
(paren
id|direction
op_eq
id|PIPEinput
)paren
(brace
id|dbri-&gt;chi_in_pipe
op_assign
id|pipe
suffix:semicolon
)brace
r_else
(brace
id|dbri-&gt;chi_out_pipe
op_assign
id|pipe
suffix:semicolon
)brace
)brace
r_else
(brace
id|dbri-&gt;pipes
(braket
id|prevpipe
)braket
dot
id|nextpipe
op_assign
id|pipe
suffix:semicolon
)brace
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|nextpipe
op_assign
id|nextpipe
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|cycle
op_assign
id|cycle
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|length
op_assign
id|length
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|PIPEinput
)paren
(brace
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|prevpipe
)paren
op_or
id|pipe
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_LEN
c_func
(paren
id|length
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
id|cycle
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|nextpipe
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|prevpipe
)paren
op_or
id|pipe
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_LEN
c_func
(paren
id|length
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
id|cycle
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|nextpipe
)paren
suffix:semicolon
)brace
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* I don&squot;t use this function, so it&squot;s basically untested. */
DECL|function|unlink_time_slot
r_static
r_void
id|unlink_time_slot
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_enum
id|in_or_out
id|direction
comma
r_int
id|prevpipe
comma
r_int
id|nextpipe
)paren
(brace
r_volatile
id|s32
op_star
id|cmd
suffix:semicolon
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
op_logical_or
id|prevpipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: unlink_time_slot called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|PIPEinput
)paren
(brace
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_DEL
op_or
id|D_DTS_PRVIN
c_func
(paren
id|prevpipe
)paren
op_or
id|pipe
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_NEXT
c_func
(paren
id|nextpipe
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_DEL
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|prevpipe
)paren
op_or
id|pipe
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_NEXT
c_func
(paren
id|nextpipe
)paren
suffix:semicolon
)brace
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* xmit_fixed() / recv_fixed()&n; *&n; * Transmit/receive data on a &quot;fixed&quot; pipe - i.e, one whose contents are not&n; * expected to change much, and which we don&squot;t need to buffer.&n; * The DBRI only interrupts us when the data changes (receive pipes),&n; * or only changes the data when this function is called (transmit pipes).&n; * Only short pipes (numbers 16-31) can be used in fixed data mode.&n; *&n; * These function operate on a 32-bit field, no matter how large&n; * the actual time slot is.  The interrupt handler takes care of bit&n; * ordering and alignment.  An 8-bit time slot will always end up&n; * in the low-order 8 bits, filled either MSB-first or LSB-first,&n; * depending on the settings passed to setup_pipe()&n; */
DECL|function|xmit_fixed
r_static
r_void
id|xmit_fixed
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_int
r_int
id|data
)paren
(brace
r_volatile
id|s32
op_star
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_fixed: Illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_SDP_MODE
c_func
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_fixed: Uninitialized pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_SDP_MODE
c_func
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
)paren
op_ne
id|D_SDP_FIXED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_fixed: Non-fixed pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_TO_SER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_fixed: Called on receive pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* DBRI short pipes always transmit LSB first */
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_MSB
)paren
id|data
op_assign
id|reverse_bytes
c_func
(paren
id|data
comma
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|length
)paren
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SSP
comma
l_int|0
comma
id|pipe
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|data
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
DECL|function|recv_fixed
r_static
r_void
id|recv_fixed
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_volatile
id|__u32
op_star
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_fixed called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_SDP_MODE
c_func
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
)paren
op_ne
id|D_SDP_FIXED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_fixed called on non-fixed pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_TO_SER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_fixed called on transmit pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|recv_fixed_ptr
op_assign
id|ptr
suffix:semicolon
)brace
multiline_comment|/* xmit_on_pipe() / recv_on_pipe()&n; *&n; * Transmit/receive data on a &quot;long&quot; pipe - i.e, one associated&n; * with a DMA buffer.&n; *&n; * Only pipe numbers 0-15 can be used in this mode.&n; *&n; * Both functions take pointer/len arguments pointing to a data buffer,&n; * and both provide callback functions (may be NULL) to notify higher&n; * level code when transmission/reception is complete.&n; *&n; * Both work by building chains of descriptors which identify the&n; * data buffers.  Buffers too large for a single descriptor will&n; * be spread across multiple descriptors.&n; */
DECL|function|xmit_on_pipe
r_static
r_void
id|xmit_on_pipe
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_void
op_star
id|buffer
comma
r_int
r_int
id|len
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_volatile
id|s32
op_star
id|cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|td
op_assign
l_int|0
suffix:semicolon
r_int
id|first_td
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|last_td
op_assign
op_minus
l_int|1
suffix:semicolon
id|__u32
id|dvma_buffer
comma
id|dvma_buffer_base
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|15
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_on_pipe: Illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_on_pipe: Uninitialized pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_TO_SER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_on_pipe: Called on receive pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dvma_buffer_base
op_assign
id|dvma_buffer
op_assign
id|sbus_map_single
c_func
(paren
id|dbri-&gt;sdev
comma
id|buffer
comma
id|len
comma
id|SBUS_DMA_TODEVICE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|mylen
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|td
OL
id|DBRI_NO_DESCS
suffix:semicolon
id|td
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|inuse
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|td
op_eq
id|DBRI_NO_DESCS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_on_pipe: No descriptors&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
(paren
(paren
l_int|1
op_lshift
l_int|13
)paren
op_minus
l_int|1
)paren
)paren
(brace
id|mylen
op_assign
(paren
l_int|1
op_lshift
l_int|13
)paren
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|mylen
op_assign
id|len
suffix:semicolon
)brace
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|inuse
op_assign
l_int|1
suffix:semicolon
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|next
op_assign
op_minus
l_int|1
suffix:semicolon
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|buffer
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|output_callback
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|input_callback
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|word1
op_assign
id|DBRI_TD_CNT
c_func
(paren
id|mylen
)paren
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|ba
op_assign
id|dvma_buffer
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|nda
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|word4
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|first_td
op_eq
op_minus
l_int|1
)paren
(brace
id|first_td
op_assign
id|td
suffix:semicolon
)brace
r_else
(brace
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|next
op_assign
id|td
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|last_td
)braket
dot
id|nda
op_assign
id|dbri-&gt;dma_dvma
op_plus
id|dbri_dma_off
c_func
(paren
id|desc
comma
id|td
)paren
suffix:semicolon
)brace
id|last_td
op_assign
id|td
suffix:semicolon
id|dvma_buffer
op_add_assign
id|mylen
suffix:semicolon
id|len
op_sub_assign
id|mylen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|first_td
op_eq
op_minus
l_int|1
op_logical_or
id|last_td
op_eq
op_minus
l_int|1
)paren
(brace
id|sbus_unmap_single
c_func
(paren
id|dbri-&gt;sdev
comma
id|dvma_buffer_base
comma
id|dvma_buffer
op_minus
id|dvma_buffer_base
op_plus
id|len
comma
id|SBUS_DMA_TODEVICE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbri-&gt;dma-&gt;desc
(braket
id|last_td
)braket
dot
id|word1
op_or_assign
id|DBRI_TD_I
op_or
id|DBRI_TD_F
op_or
id|DBRI_TD_B
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|buffer
op_assign
id|buffer
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|buffer_dvma
op_assign
id|dvma_buffer_base
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|len
op_assign
id|dvma_buffer
op_minus
id|dvma_buffer_base
op_plus
id|len
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|output_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|output_callback_arg
op_assign
id|callback_arg
suffix:semicolon
r_for
c_loop
(paren
id|td
op_assign
id|first_td
suffix:semicolon
id|td
op_ne
op_minus
l_int|1
suffix:semicolon
id|td
op_assign
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|next
)paren
(brace
id|dprintk
c_func
(paren
id|D_DESC
comma
(paren
l_string|&quot;DBRI TD %d: %08x %08x %08x %08x&bslash;n&quot;
comma
id|td
comma
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|word1
comma
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|ba
comma
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|nda
comma
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|word4
)paren
)paren
suffix:semicolon
)brace
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pipe_active
c_func
(paren
id|dbri
comma
id|pipe
)paren
)paren
(brace
multiline_comment|/* Pipe is already active - find last TD in use&n;&t;&t; * and link our first TD onto its end.  Then issue&n;&t;&t; * a CDP command to let the DBRI know there&squot;s more data.&n;&t;&t; */
id|last_td
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
suffix:semicolon
r_while
c_loop
(paren
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|next
op_ne
op_minus
l_int|1
)paren
id|last_td
op_assign
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|next
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|next
op_assign
id|first_td
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|last_td
)braket
dot
id|nda
op_assign
id|dbri-&gt;dma_dvma
op_plus
id|dbri_dma_off
c_func
(paren
id|desc
comma
id|first_td
)paren
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CDP
comma
l_int|0
comma
id|pipe
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Pipe isn&squot;t active - issue an SDP command to start&n;&t;&t; * our chain of TDs running.&n;&t;&t; */
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
id|first_td
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_or
id|D_SDP_P
op_or
id|D_SDP_EVERY
op_or
id|D_SDP_C
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|dbri-&gt;dma_dvma
op_plus
id|dbri_dma_off
c_func
(paren
id|desc
comma
id|first_td
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|recv_on_pipe
r_static
r_void
id|recv_on_pipe
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_void
op_star
id|buffer
comma
r_int
r_int
id|len
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_volatile
id|s32
op_star
id|cmd
suffix:semicolon
r_int
id|first_rd
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|last_rd
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|rd
suffix:semicolon
id|__u32
id|bus_buffer
comma
id|bus_buffer_base
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|15
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_on_pipe: Illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_on_pipe: Uninitialized pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_TO_SER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_on_pipe: Called on transmit pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* XXX Fix this XXX&n;&t; * Should be able to queue multiple buffers to receive on a pipe&n;         */
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_ne
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_on_pipe: Called on active pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Make sure buffer size is multiple of four */
id|len
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|bus_buffer_base
op_assign
id|bus_buffer
op_assign
id|sbus_map_single
c_func
(paren
id|dbri-&gt;sdev
comma
id|buffer
comma
id|len
comma
id|SBUS_DMA_FROMDEVICE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|rd
comma
id|mylen
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
(paren
(paren
l_int|1
op_lshift
l_int|13
)paren
op_minus
l_int|4
)paren
)paren
(brace
id|mylen
op_assign
(paren
l_int|1
op_lshift
l_int|13
)paren
op_minus
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|mylen
op_assign
id|len
suffix:semicolon
)brace
r_for
c_loop
(paren
id|rd
op_assign
l_int|0
suffix:semicolon
id|rd
OL
id|DBRI_NO_DESCS
suffix:semicolon
id|rd
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|inuse
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rd
op_eq
id|DBRI_NO_DESCS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI recv_on_pipe: No descriptors&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|word1
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|ba
op_assign
id|bus_buffer
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|nda
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|word4
op_assign
id|DBRI_RD_B
op_or
id|DBRI_RD_BCNT
c_func
(paren
id|mylen
)paren
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|buffer
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|input_callback
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|output_callback
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|next
op_assign
op_minus
l_int|1
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|inuse
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|first_rd
op_eq
op_minus
l_int|1
)paren
id|first_rd
op_assign
id|rd
suffix:semicolon
r_if
c_cond
(paren
id|last_rd
op_ne
op_minus
l_int|1
)paren
(brace
id|dbri-&gt;dma-&gt;desc
(braket
id|last_rd
)braket
dot
id|nda
op_assign
id|dbri-&gt;dma_dvma
op_plus
id|dbri_dma_off
c_func
(paren
id|desc
comma
id|rd
)paren
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_rd
)braket
dot
id|next
op_assign
id|rd
suffix:semicolon
)brace
id|last_rd
op_assign
id|rd
suffix:semicolon
id|bus_buffer
op_add_assign
id|mylen
suffix:semicolon
id|len
op_sub_assign
id|mylen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|last_rd
op_eq
op_minus
l_int|1
op_logical_or
id|first_rd
op_eq
op_minus
l_int|1
)paren
(brace
id|sbus_unmap_single
c_func
(paren
id|dbri-&gt;sdev
comma
id|bus_buffer_base
comma
id|bus_buffer
op_minus
id|bus_buffer_base
op_plus
id|len
comma
id|SBUS_DMA_FROMDEVICE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|rd
op_assign
id|first_rd
suffix:semicolon
id|rd
op_ne
op_minus
l_int|1
suffix:semicolon
id|rd
op_assign
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|next
)paren
(brace
id|dprintk
c_func
(paren
id|D_DESC
comma
(paren
l_string|&quot;DBRI RD %d: %08x %08x %08x %08x&bslash;n&quot;
comma
id|rd
comma
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|word1
comma
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|ba
comma
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|nda
comma
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|word4
)paren
)paren
suffix:semicolon
)brace
id|dbri-&gt;descs
(braket
id|last_rd
)braket
dot
id|buffer
op_assign
id|buffer
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_rd
)braket
dot
id|buffer_dvma
op_assign
id|bus_buffer_base
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_rd
)braket
dot
id|len
op_assign
id|bus_buffer
op_minus
id|bus_buffer_base
op_plus
id|len
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_rd
)braket
dot
id|input_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_rd
)braket
dot
id|input_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
id|first_rd
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_or
id|D_SDP_P
op_or
id|D_SDP_C
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|dbri-&gt;dma_dvma
op_plus
id|dbri_dma_off
c_func
(paren
id|desc
comma
id|first_rd
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;****************************************************************************&n;************************** DBRI - CHI interface ****************************&n;****************************************************************************&n;&n;The CHI is a four-wire (clock, frame sync, data in, data out) time-division&n;multiplexed serial interface which the DBRI can operate in either master&n;(give clock/frame sync) or slave (take clock/frame sync) mode.&n;&n;*/
DECL|enum|master_or_slave
DECL|enumerator|CHImaster
DECL|enumerator|CHIslave
r_enum
id|master_or_slave
(brace
id|CHImaster
comma
id|CHIslave
)brace
suffix:semicolon
DECL|function|reset_chi
r_static
r_void
id|reset_chi
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_enum
id|master_or_slave
id|master_or_slave
comma
r_int
id|bits_per_frame
)paren
(brace
r_volatile
id|s32
op_star
id|cmd
suffix:semicolon
r_int
id|val
suffix:semicolon
r_static
r_int
id|chi_initialized
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chi_initialized
)paren
(brace
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* Set CHI Anchor: Pipe 16 */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
l_int|16
)paren
op_or
id|D_PIPE
c_func
(paren
l_int|16
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
l_int|16
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
l_int|16
)paren
op_or
id|D_PIPE
c_func
(paren
l_int|16
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
l_int|16
)paren
suffix:semicolon
id|dbri-&gt;pipes
(braket
l_int|16
)braket
dot
id|sdp
op_assign
l_int|1
suffix:semicolon
id|dbri-&gt;pipes
(braket
l_int|16
)braket
dot
id|nextpipe
op_assign
l_int|16
suffix:semicolon
id|dbri-&gt;chi_in_pipe
op_assign
l_int|16
suffix:semicolon
id|dbri-&gt;chi_out_pipe
op_assign
l_int|16
suffix:semicolon
macro_line|#if 0
id|chi_initialized
op_increment
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_int
id|pipe
suffix:semicolon
r_for
c_loop
(paren
id|pipe
op_assign
id|dbri-&gt;chi_in_pipe
suffix:semicolon
id|pipe
op_ne
l_int|16
suffix:semicolon
id|pipe
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|nextpipe
)paren
(brace
id|unlink_time_slot
c_func
(paren
id|dbri
comma
id|pipe
comma
id|PIPEinput
comma
l_int|16
comma
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|nextpipe
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|pipe
op_assign
id|dbri-&gt;chi_out_pipe
suffix:semicolon
id|pipe
op_ne
l_int|16
suffix:semicolon
id|pipe
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|nextpipe
)paren
(brace
id|unlink_time_slot
c_func
(paren
id|dbri
comma
id|pipe
comma
id|PIPEoutput
comma
l_int|16
comma
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|nextpipe
)paren
suffix:semicolon
)brace
id|dbri-&gt;chi_in_pipe
op_assign
l_int|16
suffix:semicolon
id|dbri-&gt;chi_out_pipe
op_assign
l_int|16
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|master_or_slave
op_eq
id|CHIslave
)paren
(brace
multiline_comment|/* Setup DBRI for CHI Slave - receive clock, frame sync (FS)&n;&t;&t; *&n;&t;&t; * CHICM  = 0 (slave mode, 8 kHz frame rate)&n;&t;&t; * IR     = give immediate CHI status interrupt&n;&t;&t; * EN     = give CHI status interrupt upon change&n;&t;&t; */
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CHI
comma
l_int|0
comma
id|D_CHI_CHICM
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Setup DBRI for CHI Master - generate clock, FS&n;&t;&t; *&n;&t;&t; * BPF&t;&t;&t;&t;=  bits per 8 kHz frame&n;&t;&t; * 12.288 MHz / CHICM_divisor&t;= clock rate&n;&t;&t; * FD  =  1 - drive CHIFS on rising edge of CHICK&n;&t;&t; */
r_int
id|clockrate
op_assign
id|bits_per_frame
op_star
l_int|8
suffix:semicolon
r_int
id|divisor
op_assign
l_int|12288
op_div
id|clockrate
suffix:semicolon
r_if
c_cond
(paren
id|divisor
OG
l_int|255
op_logical_or
id|divisor
op_star
id|clockrate
op_ne
l_int|12288
)paren
id|printk
c_func
(paren
l_string|&quot;DBRI: illegal bits_per_frame in setup_chi&bslash;n&quot;
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CHI
comma
l_int|0
comma
id|D_CHI_CHICM
c_func
(paren
id|divisor
)paren
op_or
id|D_CHI_FD
op_or
id|D_CHI_BPF
c_func
(paren
id|bits_per_frame
)paren
)paren
suffix:semicolon
)brace
id|dbri-&gt;chi_bpf
op_assign
id|bits_per_frame
suffix:semicolon
multiline_comment|/* CHI Data Mode&n;&t; *&n;&t; * RCE   =  0 - receive on falling edge of CHICK&n;&t; * XCE   =  1 - transmit on rising edge of CHICK&n;&t; * XEN   =  1 - enable transmitter&n;&t; * REN   =  1 - enable receiver&n;&t; */
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CDM
comma
l_int|0
comma
id|D_CDM_XCE
op_or
id|D_CDM_XEN
op_or
id|D_CDM_REN
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;****************************************************************************&n;*********************** CS4215 audio codec management **********************&n;****************************************************************************&n;&n;In the standard SPARC audio configuration, the CS4215 codec is attached&n;to the DBRI via the CHI interface and few of the DBRI&squot;s PIO pins.&n;&n;*/
DECL|function|mmcodec_default
r_static
r_void
id|mmcodec_default
c_func
(paren
r_struct
id|cs4215
op_star
id|mm
)paren
(brace
multiline_comment|/*&n;&t; * No action, memory resetting only.&n;&t; *&n;&t; * Data Time Slot 5-8&n;&t; * Speaker,Line and Headphone enable. Gain set to the half.&n;&t; * Input is mike.&n;&t; */
id|mm-&gt;data
(braket
l_int|0
)braket
op_assign
id|CS4215_LO
c_func
(paren
l_int|0x20
)paren
op_or
id|CS4215_HE
op_or
id|CS4215_LE
suffix:semicolon
id|mm-&gt;data
(braket
l_int|1
)braket
op_assign
id|CS4215_RO
c_func
(paren
l_int|0x20
)paren
op_or
id|CS4215_SE
suffix:semicolon
id|mm-&gt;data
(braket
l_int|2
)braket
op_assign
id|CS4215_LG
c_func
(paren
l_int|0x8
)paren
op_or
id|CS4215_IS
op_or
id|CS4215_PIO0
op_or
id|CS4215_PIO1
suffix:semicolon
id|mm-&gt;data
(braket
l_int|3
)braket
op_assign
id|CS4215_RG
c_func
(paren
l_int|0x8
)paren
op_or
id|CS4215_MA
c_func
(paren
l_int|0xf
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Control Time Slot 1-4&n;&t; * 0: Default I/O voltage scale&n;&t; * 1: 8 bit ulaw, 8kHz, mono, high pass filter disabled&n;&t; * 2: Serial enable, CHI master, 128 bits per frame, clock 1&n;&t; * 3: Tests disabled&n;&t; */
id|mm-&gt;ctrl
(braket
l_int|0
)braket
op_assign
id|CS4215_RSRVD_1
op_or
id|CS4215_MLB
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|1
)braket
op_assign
id|CS4215_DFR_ULAW
op_or
id|CS4215_FREQ
(braket
l_int|0
)braket
dot
id|csval
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|2
)braket
op_assign
id|CS4215_XCLK
op_or
id|CS4215_BSEL_128
op_or
id|CS4215_FREQ
(braket
l_int|0
)braket
dot
id|xtal
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|mmcodec_setup_pipes
r_static
r_void
id|mmcodec_setup_pipes
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
multiline_comment|/*&n;&t; * Data mode:&n;&t; * Pipe  4: Send timeslots 1-4 (audio data)&n;&t; * Pipe 20: Send timeslots 5-8 (part of ctrl data)&n;&t; * Pipe  6: Receive timeslots 1-4 (audio data)&n;&t; * Pipe 21: Receive timeslots 6-7. We can only receive 20 bits via&n;&t; *          interrupt, and the rest of the data (slot 5 and 8) is&n;&t; *&t;    not relevant for us (only for doublechecking).&n;&t; *&n;&t; * Control mode:&n;&t; * Pipe 17: Send timeslots 1-4 (slots 5-8 are readonly)&n;&t; * Pipe 18: Receive timeslot 1 (clb).&n;&t; * Pipe 19: Receive timeslot 7 (version). &n;&t; */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|4
comma
id|D_SDP_MEM
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|20
comma
id|D_SDP_FIXED
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|6
comma
id|D_SDP_MEM
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|21
comma
id|D_SDP_FIXED
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|17
comma
id|D_SDP_FIXED
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|18
comma
id|D_SDP_FIXED
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|19
comma
id|D_SDP_FIXED
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|dbri-&gt;mm.status
op_assign
l_int|0
suffix:semicolon
id|recv_fixed
c_func
(paren
id|dbri
comma
l_int|18
comma
op_amp
id|dbri-&gt;mm.status
)paren
suffix:semicolon
id|recv_fixed
c_func
(paren
id|dbri
comma
l_int|19
comma
op_amp
id|dbri-&gt;mm.version
)paren
suffix:semicolon
)brace
DECL|function|mmcodec_setgain
r_static
r_void
id|mmcodec_setgain
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|muted
)paren
(brace
r_if
c_cond
(paren
id|muted
op_logical_or
id|dbri-&gt;perchip_info.output_muted
)paren
(brace
id|dbri-&gt;mm.data
(braket
l_int|0
)braket
op_assign
l_int|63
suffix:semicolon
id|dbri-&gt;mm.data
(braket
l_int|1
)braket
op_assign
l_int|63
suffix:semicolon
)brace
r_else
(brace
r_int
id|left_gain
op_assign
(paren
id|dbri-&gt;perchip_info.play.gain
op_div
l_int|4
)paren
op_mod
l_int|64
suffix:semicolon
r_int
id|right_gain
op_assign
(paren
id|dbri-&gt;perchip_info.play.gain
op_div
l_int|4
)paren
op_mod
l_int|64
suffix:semicolon
r_int
id|outport
op_assign
id|dbri-&gt;perchip_info.play.port
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;perchip_info.play.balance
OL
id|AUDIO_MID_BALANCE
)paren
(brace
id|right_gain
op_mul_assign
id|dbri-&gt;perchip_info.play.balance
suffix:semicolon
id|right_gain
op_div_assign
id|AUDIO_MID_BALANCE
suffix:semicolon
)brace
r_else
(brace
id|left_gain
op_mul_assign
id|AUDIO_RIGHT_BALANCE
op_minus
id|dbri-&gt;perchip_info.play.balance
suffix:semicolon
id|left_gain
op_div_assign
id|AUDIO_MID_BALANCE
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Setting codec gain left: %d right: %d&bslash;n&quot;
comma
id|left_gain
comma
id|right_gain
)paren
)paren
suffix:semicolon
id|dbri-&gt;mm.data
(braket
l_int|0
)braket
op_assign
(paren
l_int|63
op_minus
id|left_gain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outport
op_amp
id|AUDIO_HEADPHONE
)paren
id|dbri-&gt;mm.data
(braket
l_int|0
)braket
op_or_assign
id|CS4215_HE
suffix:semicolon
r_if
c_cond
(paren
id|outport
op_amp
id|AUDIO_LINE_OUT
)paren
id|dbri-&gt;mm.data
(braket
l_int|0
)braket
op_or_assign
id|CS4215_LE
suffix:semicolon
id|dbri-&gt;mm.data
(braket
l_int|1
)braket
op_assign
(paren
l_int|63
op_minus
id|right_gain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outport
op_amp
id|AUDIO_SPEAKER
)paren
id|dbri-&gt;mm.data
(braket
l_int|1
)braket
op_or_assign
id|CS4215_SE
suffix:semicolon
)brace
id|xmit_fixed
c_func
(paren
id|dbri
comma
l_int|20
comma
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.data
)paren
suffix:semicolon
)brace
DECL|function|mmcodec_init_data
r_static
r_void
id|mmcodec_init_data
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|data_width
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
multiline_comment|/*&n;&t; * Data mode:&n;&t; * Pipe  4: Send timeslots 1-4 (audio data)&n;&t; * Pipe 20: Send timeslots 5-8 (part of ctrl data)&n;&t; * Pipe  6: Receive timeslots 1-4 (audio data)&n;&t; * Pipe 21: Receive timeslots 6-7. We can only receive 20 bits via&n;&t; *          interrupt, and the rest of the data (slot 5 and 8) is&n;&t; *&t;    not relevant for us (only for doublechecking).&n;         *&n;         * Just like in control mode, the time slots are all offset by eight&n;         * bits.  The CS4215, it seems, observes TSIN (the delayed signal)&n;         * even if it&squot;s the CHI master.  Don&squot;t ask me...&n;&t; */
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|D_C
)paren
suffix:semicolon
multiline_comment|/* Disable CHI */
id|sbus_writel
c_func
(paren
id|tmp
comma
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
multiline_comment|/* Switch CS4215 to data mode - set PIO3 to 1 */
id|sbus_writel
c_func
(paren
id|D_ENPIO
op_or
id|D_PIO1
op_or
id|D_PIO3
op_or
(paren
id|dbri-&gt;mm.onboard
ques
c_cond
id|D_PIO0
suffix:colon
id|D_PIO2
)paren
comma
id|dbri-&gt;regs
op_plus
id|REG2
)paren
suffix:semicolon
id|reset_chi
c_func
(paren
id|dbri
comma
id|CHIslave
comma
l_int|128
)paren
suffix:semicolon
multiline_comment|/* Note: this next doesn&squot;t work for 8-bit stereo, because the two&n;&t; * channels would be on timeslots 1 and 3, with 2 and 4 idle.&n;&t; * (See CS4215 datasheet Fig 15)&n;&t; *&n;&t; * DBRI non-contiguous mode would be required to make this work.&n;&t; */
id|data_width
op_assign
id|dbri-&gt;perchip_info.play.channels
op_star
id|dbri-&gt;perchip_info.play.precision
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|20
comma
id|PIPEoutput
comma
l_int|16
comma
l_int|32
comma
id|dbri-&gt;mm.offset
op_plus
l_int|32
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|4
comma
id|PIPEoutput
comma
l_int|16
comma
id|data_width
comma
id|dbri-&gt;mm.offset
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|6
comma
id|PIPEinput
comma
l_int|16
comma
id|data_width
comma
id|dbri-&gt;mm.offset
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|21
comma
id|PIPEinput
comma
l_int|16
comma
l_int|16
comma
id|dbri-&gt;mm.offset
op_plus
l_int|40
)paren
suffix:semicolon
id|mmcodec_setgain
c_func
(paren
id|dbri
comma
l_int|0
)paren
suffix:semicolon
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|tmp
op_or_assign
id|D_C
suffix:semicolon
multiline_comment|/* Enable CHI */
id|sbus_writel
c_func
(paren
id|tmp
comma
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Send the control information (i.e. audio format)&n; */
DECL|function|mmcodec_setctrl
r_static
r_int
id|mmcodec_setctrl
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|i
comma
id|val
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
multiline_comment|/* XXX - let the CPU do something useful during these delays */
multiline_comment|/* Temporarily mute outputs, and wait 1/8000 sec (125 us)&n;&t; * to make sure this takes.  This avoids clicking noises.&n;&t; */
id|mmcodec_setgain
c_func
(paren
id|dbri
comma
l_int|1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|125
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Enable Control mode: Set DBRI&squot;s PIO3 (4215&squot;s D/~C) to 0, then wait&n;&t; * 12 cycles &lt;= 12/(5512.5*64) sec = 34.01 usec&n;&t; */
id|val
op_assign
id|D_ENPIO
op_or
id|D_PIO1
op_or
(paren
id|dbri-&gt;mm.onboard
ques
c_cond
id|D_PIO0
suffix:colon
id|D_PIO2
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|val
comma
id|dbri-&gt;regs
op_plus
id|REG2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|34
)paren
suffix:semicolon
multiline_comment|/* In Control mode, the CS4215 is a slave device, so the DBRI must&n;         * operate as CHI master, supplying clocking and frame synchronization.&n;         *&n;         * In Data mode, however, the CS4215 must be CHI master to insure&n;         * that its data stream is synchronous with its codec.&n;         *&n;         * The upshot of all this?  We start by putting the DBRI into master&n;         * mode, program the CS4215 in Control mode, then switch the CS4215&n;         * into Data mode and put the DBRI into slave mode.  Various timing&n;         * requirements must be observed along the way.&n;         *&n;         * Oh, and one more thing, on a SPARCStation 20 (and maybe&n;         * others?), the addressing of the CS4215&squot;s time slots is&n;         * offset by eight bits, so we add eight to all the &quot;cycle&quot;&n;         * values in the Define Time Slot (DTS) commands.  This is&n;         * done in hardware by a TI 248 that delays the DBRI-&gt;4215&n;         * frame sync signal by eight clock cycles.  Anybody know why?&n;         */
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|D_C
suffix:semicolon
multiline_comment|/* Disable CHI */
id|sbus_writel
c_func
(paren
id|tmp
comma
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|reset_chi
c_func
(paren
id|dbri
comma
id|CHImaster
comma
l_int|128
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Control mode:&n;&t; * Pipe 17: Send timeslots 1-4 (slots 5-8 are readonly)&n;&t; * Pipe 18: Receive timeslot 1 (clb).&n;&t; * Pipe 19: Receive timeslot 7 (version). &n;&t; */
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|17
comma
id|PIPEoutput
comma
l_int|16
comma
l_int|32
comma
id|dbri-&gt;mm.offset
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|18
comma
id|PIPEinput
comma
l_int|16
comma
l_int|8
comma
id|dbri-&gt;mm.offset
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|19
comma
id|PIPEinput
comma
l_int|16
comma
l_int|8
comma
id|dbri-&gt;mm.offset
op_plus
l_int|48
)paren
suffix:semicolon
multiline_comment|/* Wait for the chip to echo back CLB (Control Latch Bit) as zero */
id|dbri-&gt;mm.ctrl
(braket
l_int|0
)braket
op_and_assign
op_complement
id|CS4215_CLB
suffix:semicolon
id|xmit_fixed
c_func
(paren
id|dbri
comma
l_int|17
comma
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
)paren
suffix:semicolon
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|tmp
op_or_assign
id|D_C
suffix:semicolon
multiline_comment|/* Enable CHI */
id|sbus_writel
c_func
(paren
id|tmp
comma
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|i
op_assign
l_int|64
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|dbri-&gt;mm.status
op_amp
l_int|0xe4
)paren
op_ne
l_int|0x20
)paren
op_logical_and
op_decrement
id|i
)paren
id|udelay
c_func
(paren
l_int|125
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: CS4215 didn&squot;t respond to CLB (0x%02x)&bslash;n&quot;
comma
id|dbri-&gt;mm.status
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Terminate CS4215 control mode - data sheet says&n;         * &quot;Set CLB=1 and send two more frames of valid control info&quot;&n;         */
id|dbri-&gt;mm.ctrl
(braket
l_int|0
)braket
op_or_assign
id|CS4215_CLB
suffix:semicolon
id|xmit_fixed
c_func
(paren
id|dbri
comma
l_int|17
comma
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
)paren
suffix:semicolon
multiline_comment|/* Two frames of control info @ 8kHz frame rate = 250 us delay */
id|udelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|mmcodec_setgain
c_func
(paren
id|dbri
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mmcodec_init
r_static
r_int
id|mmcodec_init
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|u32
id|reg2
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG2
)paren
suffix:semicolon
multiline_comment|/* Look for the cs4215 chips */
r_if
c_cond
(paren
id|reg2
op_amp
id|D_PIO2
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Onboard CS4215 detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg2
op_amp
id|D_PIO0
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Speakerbox detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Using the Speakerbox, if both are attached.  */
r_if
c_cond
(paren
(paren
id|reg2
op_amp
id|D_PIO2
)paren
op_logical_and
(paren
id|reg2
op_amp
id|D_PIO0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Using speakerbox / ignoring onboard mmcodec.&bslash;n&quot;
)paren
suffix:semicolon
id|sbus_writel
c_func
(paren
id|D_ENPIO2
comma
id|dbri-&gt;regs
op_plus
id|REG2
)paren
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg2
op_amp
(paren
id|D_PIO0
op_or
id|D_PIO2
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: no mmcodec found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|mmcodec_setup_pipes
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|mmcodec_default
c_func
(paren
op_amp
id|dbri-&gt;mm
)paren
suffix:semicolon
id|dbri-&gt;mm.version
op_assign
l_int|0xff
suffix:semicolon
id|dbri-&gt;mm.offset
op_assign
id|dbri-&gt;mm.onboard
ques
c_cond
l_int|0
suffix:colon
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|mmcodec_setctrl
c_func
(paren
id|dbri
)paren
op_eq
op_minus
l_int|1
op_logical_or
id|dbri-&gt;mm.version
op_eq
l_int|0xff
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: CS4215 failed probe at offset %d&bslash;n&quot;
comma
id|dbri-&gt;mm.offset
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Found CS4215 at offset %d&bslash;n&quot;
comma
id|dbri-&gt;mm.offset
)paren
)paren
suffix:semicolon
id|dbri-&gt;perchip_info.play.channels
op_assign
l_int|1
suffix:semicolon
id|dbri-&gt;perchip_info.play.precision
op_assign
l_int|8
suffix:semicolon
id|dbri-&gt;perchip_info.play.gain
op_assign
(paren
id|AUDIO_MAX_GAIN
op_star
l_int|7
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* 70% */
id|dbri-&gt;perchip_info.play.balance
op_assign
id|AUDIO_MID_BALANCE
suffix:semicolon
id|dbri-&gt;perchip_info.play.port
op_assign
id|dbri-&gt;perchip_info.play.avail_ports
op_assign
id|AUDIO_SPEAKER
op_or
id|AUDIO_HEADPHONE
op_or
id|AUDIO_LINE_OUT
suffix:semicolon
id|dbri-&gt;perchip_info.record.port
op_assign
id|AUDIO_MICROPHONE
suffix:semicolon
id|dbri-&gt;perchip_info.record.avail_ports
op_assign
id|AUDIO_MICROPHONE
op_or
id|AUDIO_LINE_IN
suffix:semicolon
id|mmcodec_init_data
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;****************************************************************************&n;******************** Interface with sparcaudio midlevel ********************&n;****************************************************************************&n;&n;The sparcaudio midlevel is contained in the file audio.c.  It interfaces&n;to the user process and performs buffering, intercepts SunOS-style ioctl&squot;s,&n;etc.  It interfaces to a abstract audio device via a struct sparcaudio_driver.&n;This code presents such an interface for the DBRI with an attached CS4215.&n;All our routines are defined, and then comes our struct sparcaudio_driver.&n;&n;*/
multiline_comment|/******************* sparcaudio midlevel - audio output *******************/
DECL|function|dbri_audio_output_callback
r_static
r_void
id|dbri_audio_output_callback
c_func
(paren
r_void
op_star
id|callback_arg
comma
r_int
id|status
)paren
(brace
r_struct
id|sparcaudio_driver
op_star
id|drv
op_assign
id|callback_arg
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
op_minus
l_int|1
)paren
id|sparcaudio_output_done
c_func
(paren
id|drv
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|dbri_start_output
r_static
r_void
id|dbri_start_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|dprintk
c_func
(paren
id|D_USR
comma
(paren
l_string|&quot;DBRI: start audio output buf=%p/%ld&bslash;n&quot;
comma
id|buffer
comma
id|count
)paren
)paren
suffix:semicolon
multiline_comment|/* Pipe 4 is audio transmit */
id|xmit_on_pipe
c_func
(paren
id|dbri
comma
l_int|4
comma
id|buffer
comma
id|count
comma
op_amp
id|dbri_audio_output_callback
comma
id|drv
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Notify midlevel that we&squot;re a DMA-capable driver that&n;&t; * can accept another buffer immediately.  We should probably&n;&t; * check that we&squot;ve got enough resources (i.e, descriptors)&n;&t; * available before doing this, but the default midlevel&n;&t; * settings only buffer 64KB, which we can handle with 16&n;&t; * of our DBRI_NO_DESCS (64) descriptors.&n;&t; *&n;&t; * This code is #ifdef&squot;ed out because it&squot;s caused me more&n;&t; * problems than it solved.  It&squot;d be nice to provide the&n;&t; * DBRI with a chain of buffers, but the midlevel code is&n;&t; * so tricky that I really don&squot;t want to deal with it.&n;&t; */
id|sparcaudio_output_done
c_func
(paren
id|drv
comma
l_int|2
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|dbri_stop_output
r_static
r_void
id|dbri_stop_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|reset_pipe
c_func
(paren
id|dbri
comma
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/******************* sparcaudio midlevel - audio input ********************/
DECL|function|dbri_audio_input_callback
r_static
r_void
id|dbri_audio_input_callback
c_func
(paren
r_void
op_star
id|callback_arg
comma
r_int
id|status
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|sparcaudio_driver
op_star
id|drv
op_assign
(paren
r_struct
id|sparcaudio_driver
op_star
)paren
id|callback_arg
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
op_minus
l_int|1
)paren
id|sparcaudio_input_done
c_func
(paren
id|drv
comma
l_int|3
)paren
suffix:semicolon
)brace
DECL|function|dbri_start_input
r_static
r_void
id|dbri_start_input
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
multiline_comment|/* Pipe 6 is audio receive */
id|recv_on_pipe
c_func
(paren
id|dbri
comma
l_int|6
comma
id|buffer
comma
id|len
comma
op_amp
id|dbri_audio_input_callback
comma
(paren
r_void
op_star
)paren
id|drv
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|D_USR
comma
(paren
l_string|&quot;DBRI: start audio input buf=%p/%ld&bslash;n&quot;
comma
id|buffer
comma
id|len
)paren
)paren
suffix:semicolon
)brace
DECL|function|dbri_stop_input
r_static
r_void
id|dbri_stop_input
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|reset_pipe
c_func
(paren
id|dbri
comma
l_int|6
)paren
suffix:semicolon
)brace
multiline_comment|/******************* sparcaudio midlevel - volume &amp; balance ***************/
DECL|function|dbri_set_output_volume
r_static
r_int
id|dbri_set_output_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|volume
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|dbri-&gt;perchip_info.play.gain
op_assign
id|volume
suffix:semicolon
id|mmcodec_setgain
c_func
(paren
id|dbri
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_volume
r_static
r_int
id|dbri_get_output_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.play.gain
suffix:semicolon
)brace
DECL|function|dbri_set_input_volume
r_static
r_int
id|dbri_set_input_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|volume
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_volume
r_static
r_int
id|dbri_get_input_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_monitor_volume
r_static
r_int
id|dbri_set_monitor_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|volume
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_monitor_volume
r_static
r_int
id|dbri_get_monitor_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_output_balance
r_static
r_int
id|dbri_set_output_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|balance
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|dbri-&gt;perchip_info.play.balance
op_assign
id|balance
suffix:semicolon
id|mmcodec_setgain
c_func
(paren
id|dbri
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_balance
r_static
r_int
id|dbri_get_output_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.play.balance
suffix:semicolon
)brace
DECL|function|dbri_set_input_balance
r_static
r_int
id|dbri_set_input_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|balance
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_balance
r_static
r_int
id|dbri_get_input_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_output_muted
r_static
r_int
id|dbri_set_output_muted
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|mute
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|dbri-&gt;perchip_info.output_muted
op_assign
id|mute
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_muted
r_static
r_int
id|dbri_get_output_muted
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.output_muted
suffix:semicolon
)brace
multiline_comment|/******************* sparcaudio midlevel - encoding format ****************/
DECL|function|dbri_set_output_channels
r_static
r_int
id|dbri_set_output_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|chan
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_switch
c_cond
(paren
id|chan
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
l_int|1
suffix:colon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_and_assign
op_complement
id|CS4215_DFR_STEREO
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_or_assign
id|CS4215_DFR_STEREO
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dbri-&gt;perchip_info.play.channels
op_assign
id|chan
suffix:semicolon
id|mmcodec_setctrl
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|mmcodec_init_data
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_channels
r_static
r_int
id|dbri_get_output_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.play.channels
suffix:semicolon
)brace
DECL|function|dbri_set_input_channels
r_static
r_int
id|dbri_set_input_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|chan
)paren
(brace
r_return
id|dbri_set_output_channels
c_func
(paren
id|drv
comma
id|chan
)paren
suffix:semicolon
)brace
DECL|function|dbri_get_input_channels
r_static
r_int
id|dbri_get_input_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|dbri_get_output_channels
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
DECL|function|dbri_set_output_precision
r_static
r_int
id|dbri_set_output_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|prec
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_precision
r_static
r_int
id|dbri_get_output_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.play.precision
suffix:semicolon
)brace
DECL|function|dbri_set_input_precision
r_static
r_int
id|dbri_set_input_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|prec
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_precision
r_static
r_int
id|dbri_get_input_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.play.precision
suffix:semicolon
)brace
DECL|function|dbri_set_output_encoding
r_static
r_int
id|dbri_set_output_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|enc
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
multiline_comment|/* For ULAW and ALAW, audio.c enforces precision = 8,&n;&t; * for LINEAR, precision must be 16&n;&t; */
r_switch
c_cond
(paren
id|enc
)paren
(brace
r_case
id|AUDIO_ENCODING_NONE
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|AUDIO_ENCODING_ULAW
suffix:colon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_or_assign
id|CS4215_DFR_ULAW
suffix:semicolon
id|dbri-&gt;perchip_info.play.encoding
op_assign
id|enc
suffix:semicolon
id|dbri-&gt;perchip_info.play.precision
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_ENCODING_ALAW
suffix:colon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_or_assign
id|CS4215_DFR_ALAW
suffix:semicolon
id|dbri-&gt;perchip_info.play.encoding
op_assign
id|enc
suffix:semicolon
id|dbri-&gt;perchip_info.play.precision
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_ENCODING_LINEAR
suffix:colon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_or_assign
id|CS4215_DFR_LINEAR16
suffix:semicolon
id|dbri-&gt;perchip_info.play.encoding
op_assign
id|enc
suffix:semicolon
id|dbri-&gt;perchip_info.play.precision
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
suffix:semicolon
id|mmcodec_setctrl
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|mmcodec_init_data
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_encoding
r_static
r_int
id|dbri_get_output_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.play.encoding
suffix:semicolon
)brace
DECL|function|dbri_set_input_encoding
r_static
r_int
id|dbri_set_input_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|enc
)paren
(brace
r_return
id|dbri_set_output_encoding
c_func
(paren
id|drv
comma
id|enc
)paren
suffix:semicolon
)brace
DECL|function|dbri_get_input_encoding
r_static
r_int
id|dbri_get_input_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|dbri_get_output_encoding
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
DECL|function|dbri_set_output_rate
r_static
r_int
id|dbri_set_output_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|rate
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|rate
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|CS4215_FREQ
(braket
id|i
)braket
dot
id|freq
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|CS4215_FREQ
(braket
id|i
)braket
dot
id|freq
op_eq
id|rate
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CS4215_FREQ
(braket
id|i
)braket
dot
id|freq
op_eq
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_and_assign
op_complement
l_int|0x38
suffix:semicolon
id|dbri-&gt;mm.ctrl
(braket
l_int|1
)braket
op_or_assign
id|CS4215_FREQ
(braket
id|i
)braket
dot
id|csval
suffix:semicolon
id|dbri-&gt;mm.ctrl
(braket
l_int|2
)braket
op_and_assign
op_complement
l_int|0x70
suffix:semicolon
id|dbri-&gt;mm.ctrl
(braket
l_int|2
)braket
op_or_assign
id|CS4215_FREQ
(braket
id|i
)braket
dot
id|xtal
suffix:semicolon
id|dbri-&gt;perchip_info.play.sample_rate
op_assign
id|rate
suffix:semicolon
id|mmcodec_setctrl
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|mmcodec_init_data
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_rate
r_static
r_int
id|dbri_get_output_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.play.sample_rate
suffix:semicolon
)brace
DECL|function|dbri_set_input_rate
r_static
r_int
id|dbri_set_input_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|rate
)paren
(brace
r_return
id|dbri_set_output_rate
c_func
(paren
id|drv
comma
id|rate
)paren
suffix:semicolon
)brace
DECL|function|dbri_get_input_rate
r_static
r_int
id|dbri_get_input_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|dbri_get_output_rate
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
multiline_comment|/******************* sparcaudio midlevel - ports ***********************/
DECL|function|dbri_set_output_port
r_static
r_int
id|dbri_set_output_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|port
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|port
op_and_assign
id|dbri-&gt;perchip_info.play.avail_ports
suffix:semicolon
id|dbri-&gt;perchip_info.play.port
op_assign
id|port
suffix:semicolon
id|mmcodec_setgain
c_func
(paren
id|dbri
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_port
r_static
r_int
id|dbri_get_output_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.play.port
suffix:semicolon
)brace
DECL|function|dbri_set_input_port
r_static
r_int
id|dbri_set_input_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|port
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|port
op_and_assign
id|dbri-&gt;perchip_info.record.avail_ports
suffix:semicolon
id|dbri-&gt;perchip_info.record.port
op_assign
id|port
suffix:semicolon
id|mmcodec_setgain
c_func
(paren
id|dbri
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_port
r_static
r_int
id|dbri_get_input_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.record.port
suffix:semicolon
)brace
DECL|function|dbri_get_output_ports
r_static
r_int
id|dbri_get_output_ports
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.play.avail_ports
suffix:semicolon
)brace
DECL|function|dbri_get_input_ports
r_static
r_int
id|dbri_get_input_ports
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_return
id|dbri-&gt;perchip_info.record.avail_ports
suffix:semicolon
)brace
multiline_comment|/******************* sparcaudio midlevel - driver ID ********************/
DECL|function|dbri_audio_getdev
r_static
r_void
id|dbri_audio_getdev
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|audio_device_t
op_star
id|audinfo
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|strncpy
c_func
(paren
id|audinfo-&gt;name
comma
l_string|&quot;SUNW,DBRI&quot;
comma
r_sizeof
(paren
id|audinfo-&gt;name
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|audinfo-&gt;version
(braket
l_int|0
)braket
op_assign
id|dbri-&gt;dbri_version
suffix:semicolon
id|audinfo-&gt;version
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|audinfo-&gt;config
comma
l_string|&quot;onboard1&quot;
comma
r_sizeof
(paren
id|audinfo-&gt;config
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|dbri_sunaudio_getdev_sunos
r_static
r_int
id|dbri_sunaudio_getdev_sunos
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
id|AUDIO_DEV_CODEC
suffix:semicolon
)brace
multiline_comment|/******************* sparcaudio midlevel - open &amp; close ******************/
DECL|function|dbri_open
r_static
r_int
id|dbri_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_release
r_static
r_void
id|dbri_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|dbri_ioctl
r_static
r_int
id|dbri_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|x
comma
r_int
r_int
id|y
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*********** sparcaudio midlevel - struct sparcaudio_driver ************/
DECL|variable|dbri_ops
r_static
r_struct
id|sparcaudio_operations
id|dbri_ops
op_assign
(brace
id|dbri_open
comma
id|dbri_release
comma
id|dbri_ioctl
comma
id|dbri_start_output
comma
id|dbri_stop_output
comma
id|dbri_start_input
comma
id|dbri_stop_input
comma
id|dbri_audio_getdev
comma
id|dbri_set_output_volume
comma
id|dbri_get_output_volume
comma
id|dbri_set_input_volume
comma
id|dbri_get_input_volume
comma
id|dbri_set_monitor_volume
comma
id|dbri_get_monitor_volume
comma
id|dbri_set_output_balance
comma
id|dbri_get_output_balance
comma
id|dbri_set_input_balance
comma
id|dbri_get_input_balance
comma
id|dbri_set_output_channels
comma
id|dbri_get_output_channels
comma
id|dbri_set_input_channels
comma
id|dbri_get_input_channels
comma
id|dbri_set_output_precision
comma
id|dbri_get_output_precision
comma
id|dbri_set_input_precision
comma
id|dbri_get_input_precision
comma
id|dbri_set_output_port
comma
id|dbri_get_output_port
comma
id|dbri_set_input_port
comma
id|dbri_get_input_port
comma
id|dbri_set_output_encoding
comma
id|dbri_get_output_encoding
comma
id|dbri_set_input_encoding
comma
id|dbri_get_input_encoding
comma
id|dbri_set_output_rate
comma
id|dbri_get_output_rate
comma
id|dbri_set_input_rate
comma
id|dbri_get_input_rate
comma
id|dbri_sunaudio_getdev_sunos
comma
id|dbri_get_output_ports
comma
id|dbri_get_input_ports
comma
id|dbri_set_output_muted
comma
id|dbri_get_output_muted
comma
)brace
suffix:semicolon
multiline_comment|/*&n;****************************************************************************&n;************************** ISDN (Hisax) Interface **************************&n;****************************************************************************&n;*/
DECL|function|dbri_isdn_init
r_void
id|dbri_isdn_init
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
multiline_comment|/* Pipe  0: Receive D channel&n;         * Pipe  8: Receive B1 channel&n;         * Pipe  9: Receive B2 channel&n;         * Pipe  1: Transmit D channel&n;         * Pipe 10: Transmit B1 channel&n;         * Pipe 11: Transmit B2 channel&n;         */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|0
comma
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|8
comma
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|9
comma
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|1
comma
id|D_SDP_HDLC_D
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|10
comma
id|D_SDP_HDLC
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|11
comma
id|D_SDP_HDLC
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|0
comma
id|PIPEinput
comma
l_int|0
comma
l_int|2
comma
l_int|17
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|8
comma
id|PIPEinput
comma
l_int|0
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|9
comma
id|PIPEinput
comma
l_int|8
comma
l_int|8
comma
l_int|8
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|1
comma
id|PIPEoutput
comma
l_int|1
comma
l_int|2
comma
l_int|17
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|10
comma
id|PIPEoutput
comma
l_int|1
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|11
comma
id|PIPEoutput
comma
l_int|10
comma
l_int|8
comma
l_int|8
)paren
suffix:semicolon
)brace
DECL|function|dbri_get_irqnum
r_int
id|dbri_get_irqnum
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
r_return
l_int|0
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|tprintk
c_func
(paren
(paren
l_string|&quot;dbri_get_irqnum()&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* On the sparc, the cpu&squot;s irq number is only part of the &quot;irq&quot; */
r_return
(paren
id|dbri-&gt;irq
op_amp
id|NR_IRQS
)paren
suffix:semicolon
)brace
DECL|function|dbri_get_liu_state
r_int
id|dbri_get_liu_state
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
r_return
l_int|0
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|tprintk
c_func
(paren
(paren
l_string|&quot;dbri_get_liu_state() returns %d&bslash;n&quot;
comma
id|dbri-&gt;liu_state
)paren
)paren
suffix:semicolon
r_return
id|dbri-&gt;liu_state
suffix:semicolon
)brace
r_void
id|dbri_liu_activate
c_func
(paren
r_int
id|dev
comma
r_int
id|priority
)paren
suffix:semicolon
DECL|function|dbri_liu_init
r_void
id|dbri_liu_init
c_func
(paren
r_int
id|dev
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
r_return
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|tprintk
c_func
(paren
(paren
l_string|&quot;dbri_liu_init()&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Set callback for LIU state change */
id|dbri-&gt;liu_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;liu_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|dbri_isdn_init
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|dbri_liu_activate
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|dbri_liu_activate
r_void
id|dbri_liu_activate
c_func
(paren
r_int
id|dev
comma
r_int
id|priority
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_int
id|val
suffix:semicolon
r_volatile
id|s32
op_star
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
r_return
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|tprintk
c_func
(paren
(paren
l_string|&quot;dbri_liu_activate()&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;liu_state
op_le
l_int|3
)paren
(brace
id|u32
id|tmp
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* Turn on the ISDN TE interface and request activation */
id|val
op_assign
id|D_NT_IRM_IMM
op_or
id|D_NT_IRM_EN
op_or
id|D_NT_ACT
suffix:semicolon
macro_line|#ifdef LOOPBACK_D
id|val
op_or_assign
id|D_NT_LLB
c_func
(paren
l_int|4
)paren
suffix:semicolon
macro_line|#endif
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_TE
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Activate the interface */
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|tmp
op_or_assign
id|D_T
suffix:semicolon
id|sbus_writel
c_func
(paren
id|tmp
comma
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
)brace
)brace
DECL|function|dbri_liu_deactivate
r_void
id|dbri_liu_deactivate
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
macro_line|#if 0
id|u32
id|tmp
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
r_return
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|tprintk
c_func
(paren
(paren
l_string|&quot;dbri_liu_deactivate()&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Turn off the ISDN TE interface */
id|tmp
op_assign
id|sbus_readl
c_func
(paren
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|D_T
suffix:semicolon
id|sbus_writel
c_func
(paren
id|tmp
comma
id|dbri-&gt;regs
op_plus
id|REG0
)paren
suffix:semicolon
id|dbri-&gt;liu_state
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
DECL|function|dbri_dxmit
r_void
id|dbri_dxmit
c_func
(paren
r_int
id|dev
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
r_return
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Pipe 1 is D channel transmit */
id|xmit_on_pipe
c_func
(paren
id|dbri
comma
l_int|1
comma
id|buffer
comma
id|count
comma
id|callback
comma
id|callback_arg
)paren
suffix:semicolon
)brace
DECL|function|dbri_drecv
r_void
id|dbri_drecv
c_func
(paren
r_int
id|dev
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|size
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
r_return
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Pipe 0 is D channel receive */
id|recv_on_pipe
c_func
(paren
id|dbri
comma
l_int|0
comma
id|buffer
comma
id|size
comma
id|callback
comma
id|callback_arg
)paren
suffix:semicolon
)brace
DECL|function|dbri_bopen
r_int
id|dbri_bopen
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
r_int
id|hdlcmode
comma
id|u_char
id|xmit_idle_char
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_if
c_cond
(paren
id|hdlcmode
)paren
(brace
multiline_comment|/* return -1; */
multiline_comment|/* Pipe 8/9: receive B1/B2 channel */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|8
op_plus
id|chan
comma
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
multiline_comment|/* Pipe 10/11: transmit B1/B2 channel */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|10
op_plus
id|chan
comma
id|D_SDP_HDLC
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* !hdlcmode means transparent */
multiline_comment|/* Pipe 8/9: receive B1/B2 channel */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|8
op_plus
id|chan
comma
id|D_SDP_MEM
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
multiline_comment|/* Pipe 10/11: transmit B1/B2 channel */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|10
op_plus
id|chan
comma
id|D_SDP_MEM
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_bclose
r_void
id|dbri_bclose
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
r_return
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|reset_pipe
c_func
(paren
id|dbri
comma
l_int|8
op_plus
id|chan
)paren
suffix:semicolon
id|reset_pipe
c_func
(paren
id|dbri
comma
l_int|10
op_plus
id|chan
)paren
suffix:semicolon
)brace
DECL|function|dbri_bxmit
r_void
id|dbri_bxmit
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
r_return
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Pipe 10/11 is B1/B2 channel transmit */
id|xmit_on_pipe
c_func
(paren
id|dbri
comma
l_int|10
op_plus
id|chan
comma
id|buffer
comma
id|count
comma
id|callback
comma
id|callback_arg
)paren
suffix:semicolon
)brace
DECL|function|dbri_brecv
r_void
id|dbri_brecv
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|size
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
r_return
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Pipe 8/9 is B1/B2 channel receive */
id|recv_on_pipe
c_func
(paren
id|dbri
comma
l_int|8
op_plus
id|chan
comma
id|buffer
comma
id|size
comma
id|callback
comma
id|callback_arg
)paren
suffix:semicolon
)brace
macro_line|#if defined(DBRI_ISDN) || defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x200ff
DECL|variable|dbri_foreign_interface
r_struct
id|foreign_interface
id|dbri_foreign_interface
op_assign
(brace
id|dbri_get_irqnum
comma
id|dbri_get_liu_state
comma
id|dbri_liu_init
comma
id|dbri_liu_activate
comma
id|dbri_liu_deactivate
comma
id|dbri_dxmit
comma
id|dbri_drecv
comma
id|dbri_bopen
comma
id|dbri_bclose
comma
id|dbri_bxmit
comma
id|dbri_brecv
)brace
suffix:semicolon
DECL|variable|dbri_foreign_interface
id|EXPORT_SYMBOL
c_func
(paren
id|dbri_foreign_interface
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;****************************************************************************&n;**************************** Initialization ********************************&n;****************************************************************************&n;*/
DECL|function|dbri_attach
r_static
r_int
id|dbri_attach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_struct
id|sbus_dev
op_star
id|sdev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_struct
id|linux_prom_irqs
id|irq
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
OL
l_char|&squot;e&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: unsupported chip version %c found.&bslash;n&quot;
comma
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|drv-&gt;ops
op_assign
op_amp
id|dbri_ops
suffix:semicolon
id|drv
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dbri
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|memset
c_func
(paren
id|dbri
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dbri
)paren
)paren
suffix:semicolon
id|dbri-&gt;dma
op_assign
id|sbus_alloc_consistent
c_func
(paren
id|sdev
comma
r_sizeof
(paren
r_struct
id|dbri_dma
)paren
comma
op_amp
id|dbri-&gt;dma_dvma
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|dbri-&gt;dma
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dbri_dma
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: DMA Cmd Block 0x%p (0x%08x)&bslash;n&quot;
comma
id|dbri-&gt;dma
comma
id|dbri-&gt;dma_dvma
)paren
)paren
suffix:semicolon
id|dbri-&gt;dbri_version
op_assign
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
suffix:semicolon
id|dbri-&gt;sdev
op_assign
id|sdev
suffix:semicolon
multiline_comment|/* Map the registers into memory. */
id|dbri-&gt;regs_size
op_assign
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
suffix:semicolon
id|dbri-&gt;regs
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
comma
l_string|&quot;DBRI Registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: could not allocate registers&bslash;n&quot;
)paren
suffix:semicolon
id|sbus_free_consistent
c_func
(paren
id|sdev
comma
r_sizeof
(paren
r_struct
id|dbri_dma
)paren
comma
(paren
r_void
op_star
)paren
id|dbri-&gt;dma
comma
id|dbri-&gt;dma_dvma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|prom_getproperty
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;intr&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irq
comma
r_sizeof
(paren
id|irq
)paren
)paren
suffix:semicolon
id|dbri-&gt;irq
op_assign
id|irq.pri
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|dbri-&gt;irq
comma
id|dbri_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;DBRI audio/ISDN&quot;
comma
id|dbri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dbri-&gt;irq
)paren
suffix:semicolon
id|sbus_iounmap
c_func
(paren
id|dbri-&gt;regs
comma
id|dbri-&gt;regs_size
)paren
suffix:semicolon
id|sbus_free_consistent
c_func
(paren
id|sdev
comma
r_sizeof
(paren
r_struct
id|dbri_dma
)paren
comma
(paren
r_void
op_star
)paren
id|dbri-&gt;dma
comma
id|dbri-&gt;dma_dvma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dbri_initialize
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|err
op_assign
id|mmcodec_init
c_func
(paren
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dbri_detach
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Register ourselves with the midlevel audio driver. */
id|err
op_assign
id|register_sparcaudio_driver
c_func
(paren
id|drv
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: unable to register audio&bslash;n&quot;
)paren
suffix:semicolon
id|dbri_detach
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dbri-&gt;perchip_info.play.active
op_assign
id|dbri-&gt;perchip_info.play.pause
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;perchip_info.record.active
op_assign
id|dbri-&gt;perchip_info.record.pause
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;audio%d at 0x%lx (irq %d) is DBRI(%c)+CS4215(%d)&bslash;n&quot;
comma
id|num_drivers
comma
id|dbri-&gt;regs
comma
id|dbri-&gt;irq
comma
id|dbri-&gt;dbri_version
comma
id|dbri-&gt;mm.version
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Probe for the dbri chip and then attach the driver. */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|dbri_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
r_struct
id|sbus_bus
op_star
id|sbus
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
suffix:semicolon
id|num_drivers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Probe each SBUS for the DBRI chip(s). */
id|for_all_sbusdev
c_func
(paren
id|sdev
comma
id|sbus
)paren
(brace
multiline_comment|/*&n;&t;&t; * The version is coded in the last character&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;SUNW,DBRI&quot;
comma
l_int|9
)paren
)paren
(brace
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: Found %s in SBUS slot %d&bslash;n&quot;
comma
id|sdev-&gt;prom_name
comma
id|sdev-&gt;slot
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_drivers
op_ge
id|MAX_DRIVERS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Ignoring slot %d&bslash;n&quot;
comma
id|sdev-&gt;slot
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri_attach
c_func
(paren
op_amp
id|drivers
(braket
id|num_drivers
)braket
comma
id|sdev
)paren
op_eq
l_int|0
)paren
id|num_drivers
op_increment
suffix:semicolon
)brace
)brace
r_return
(paren
id|num_drivers
OG
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_drivers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dbri_detach
c_func
(paren
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|i
)braket
dot
r_private
)paren
suffix:semicolon
id|unregister_sparcaudio_driver
c_func
(paren
op_amp
id|drivers
(braket
id|i
)braket
comma
l_int|1
)paren
suffix:semicolon
id|num_drivers
op_decrement
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local Variables:&n; * c-indent-level: 8&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -8&n; * c-argdecl-indent: 8&n; * c-label-offset: -8&n; * c-continued-statement-offset: 8&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
