multiline_comment|/*&n; * drivers/sbus/audio/dbri.c&n; *&n; * Copyright (C) 1997 Rudolf Koenig (rfkoenig@immd4.informatik.uni-erlangen.de)&n; * Copyright (C) 1998, 1999 Brent Baccala (baccala@freesoft.org)&n; *&n; * This is the lowlevel driver for the DBRI &amp; MMCODEC duo used for ISDN &amp; AUDIO&n; * on Sun SPARCstation 10, 20, LX and Voyager models.&n; *&n; * - DBRI: AT&amp;T T5900FX Dual Basic Rates ISDN Interface. It is a 32 channel&n; *   data time multiplexer with ISDN support (aka T7259)&n; *   Interfaces: SBus,ISDN NT &amp; TE, CHI, 4 bits parallel.&n; *   CHI: (spelled ki) Concentration Highway Interface (AT&amp;T or Intel bus ?).&n; *   Documentation:&n; *   - &quot;STP 4000SBus Dual Basic Rate ISDN (DBRI) Tranceiver&quot; from&n; *     Sparc Technology Business (courtesy of Sun Support)&n; *   - Data sheet of the T7903, a newer but very similar ISA bus equivalent&n; *     available from the Lucent (formarly AT&amp;T microelectronics) home&n; *     page.&n; * - MMCODEC: Crystal Semiconductor CS4215 16 bit Multimedia Audio Codec&n; *   Interfaces: CHI, Audio In &amp; Out, 2 bits parallel&n; *   Documentation: from the Crystal Semiconductor home page.&n; *&n; * The DBRI is a 32 pipe machine, each pipe can transfer some bits between&n; * memory and a serial device (long pipes, nr 0-15) or between two serial&n; * devices (short pipes, nr 16-31), or simply send a fixed data to a serial&n; * device (short pipes).&n; * A timeslot defines the bit-offset and nr of bits read from a serial device.&n; * The timeslots are linked to 6 circular lists, one for each direction for&n; * each serial device (NT,TE,CHI). A timeslot is associated to 1 or 2 pipes&n; * (the second one is a monitor/tee pipe, valid only for serial input).&n; *&n; * The mmcodec is connected via the CHI bus and needs the data &amp; some&n; * parameters (volume, balance, output selection) timemultiplexed in 8 byte&n; * chunks. It also has a control mode, which serves for audio format setting.&n; *&n; * Looking at the CS4215 data sheet it is easy to set up 2 or 4 codecs on&n; * the same CHI bus, so I thought perhaps it is possible to use the onboard&n; * &amp; the speakerbox codec simultanously, giving 2 (not very independent :-)&n; * audio devices. But the SUN HW group decided against it, at least on my&n; * LX the speakerbox connector has at least 1 pin missing and 1 wrongly&n; * connected.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/audioio.h&gt;
macro_line|#include &quot;dbri.h&quot;
macro_line|#if defined(DBRI_ISDN) || defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x200ff
macro_line|#include &quot;../../isdn/hisax/hisax.h&quot;
macro_line|#include &quot;../../isdn/hisax/isdnl1.h&quot;
macro_line|#include &quot;../../isdn/hisax/foreign.h&quot;
macro_line|#endif
DECL|macro|DBRI_DEBUG
mdefine_line|#define DBRI_DEBUG
macro_line|#ifdef DBRI_DEBUG
DECL|macro|dprintk
mdefine_line|#define dprintk(a, x) if(dbri_debug &amp; a) printk x
DECL|macro|D_GEN
mdefine_line|#define D_GEN&t;(1&lt;&lt;0)
DECL|macro|D_INT
mdefine_line|#define D_INT&t;(1&lt;&lt;1)
DECL|macro|D_CMD
mdefine_line|#define D_CMD&t;(1&lt;&lt;2)
DECL|macro|D_MM
mdefine_line|#define D_MM&t;(1&lt;&lt;3)
DECL|macro|D_USR
mdefine_line|#define D_USR&t;(1&lt;&lt;4)
multiline_comment|/* static int dbri_debug = D_GEN|D_INT|D_CMD|D_MM|D_USR; */
DECL|variable|dbri_debug
r_static
r_int
id|dbri_debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dbri_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|cmds
r_static
r_char
op_star
id|cmds
(braket
)braket
op_assign
(brace
l_string|&quot;WAIT&quot;
comma
l_string|&quot;PAUSE&quot;
comma
l_string|&quot;JUMP&quot;
comma
l_string|&quot;IIQ&quot;
comma
l_string|&quot;REX&quot;
comma
l_string|&quot;SDP&quot;
comma
l_string|&quot;CDP&quot;
comma
l_string|&quot;DTS&quot;
comma
l_string|&quot;SSP&quot;
comma
l_string|&quot;CHI&quot;
comma
l_string|&quot;NT&quot;
comma
l_string|&quot;TE&quot;
comma
l_string|&quot;CDEC&quot;
comma
l_string|&quot;TEST&quot;
comma
l_string|&quot;CDM&quot;
comma
l_string|&quot;RESRV&quot;
)brace
suffix:semicolon
multiline_comment|/* Bit hunting */
DECL|macro|dumpcmd
mdefine_line|#define dumpcmd {int i; for(i=0; i&lt;n; i++) printk(&quot;DBRI: %x&bslash;n&quot;, dbri-&gt;dma-&gt;cmd[i]); }
DECL|macro|DBRI_CMD
mdefine_line|#define DBRI_CMD(cmd, intr, value) ((cmd &lt;&lt; 28) | (1 &lt;&lt; 27) | value)
macro_line|#else
DECL|macro|dprintk
mdefine_line|#define dprintk(a, x)
DECL|macro|dumpcmd
mdefine_line|#define dumpcmd
DECL|macro|DBRI_CMD
mdefine_line|#define DBRI_CMD(cmd, intr, value) ((cmd &lt;&lt; 28) | (intr &lt;&lt; 27) | value)
macro_line|#endif&t;/* DBRI_DEBUG */
DECL|macro|MAX_DRIVERS
mdefine_line|#define MAX_DRIVERS&t;2&t;/* Increase this if need more than 2 DBRI&squot;s */
DECL|variable|drivers
r_static
r_struct
id|sparcaudio_driver
id|drivers
(braket
id|MAX_DRIVERS
)braket
suffix:semicolon
DECL|variable|num_drivers
r_static
r_int
id|num_drivers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;****************************************************************************&n;************** DBRI initialization and command synchronization *************&n;****************************************************************************&n;*/
multiline_comment|/*&n; * Commands are sent to the DBRI by building a list of them in memory,&n; * then writing the address of the first list item to DBRI register 8.&n; * The list is terminated with a WAIT command, which can generate a&n; * CPU interrupt if required.&n; *&n; * Since the DBRI can run asynchronously to the CPU, several means of&n; * synchronization present themselves.  The original scheme (Rudolf&squot;s)&n; * was to set a flag when we &quot;cmdlock&quot;ed the DBRI, clear the flag when&n; * an interrupt signaled completion, and wait on a wait_queue if a routine&n; * attempted to cmdlock while the flag was set.  The problems arose when&n; * we tried to cmdlock from inside an interrupt handler, which might&n; * cause scheduling in an interrupt (if we waited), etc, etc&n; *&n; * A more sophisticated scheme might involve a circular command buffer&n; * or an array of command buffers.  A routine could fill one with&n; * commands and link it onto a list.  When a interrupt signaled&n; * completion of the current command buffer, look on the list for&n; * the next one.&n; *&n; * I&squot;ve decided to implement something much simpler - after each command,&n; * the CPU waits for the DBRI to finish the command by polling the P bit&n; * in DBRI register 0.  I&squot;ve tried to implement this in such a way&n; * that might make implementing a more sophisticated scheme easier.&n; *&n; * Every time a routine wants to write commands to the DBRI, it must&n; * first call dbri_cmdlock() and get an initial pointer into dbri-&gt;dma-&gt;cmd&n; * in return.  After the commands have been writen, dbri_cmdsend() is&n; * called with the final pointer value.&n; */
DECL|variable|dbri_locked
r_static
r_int
id|dbri_locked
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX not SMP safe! XXX */
DECL|function|dbri_cmdlock
r_static
r_volatile
r_int
op_star
id|dbri_cmdlock
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_if
c_cond
(paren
id|dbri_locked
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Command buffer locked! (bug in driver)&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|dbri_locked
op_increment
suffix:semicolon
r_return
id|dbri-&gt;dma-&gt;cmd
suffix:semicolon
)brace
DECL|function|dbri_cmdsend
r_static
r_void
id|dbri_cmdsend
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_volatile
r_int
op_star
id|cmd
)paren
(brace
r_int
id|maxloops
op_assign
l_int|1000000
suffix:semicolon
id|dbri_locked
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|dbri_locked
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Command buffer improperly locked! (bug in driver)&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|cmd
op_minus
id|dbri-&gt;dma-&gt;cmd
)paren
op_ge
id|DBRI_NO_CMDS
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Command buffer overflow! (bug in driver)&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_WAIT
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg8
op_assign
(paren
r_int
)paren
id|dbri-&gt;dma_dvma-&gt;cmd
suffix:semicolon
r_while
c_loop
(paren
(paren
id|maxloops
op_decrement
)paren
OG
l_int|0
op_logical_and
(paren
id|dbri-&gt;regs-&gt;reg0
op_amp
id|D_P
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|maxloops
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Chip never completed command buffer&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|dbri_reset
r_static
r_void
id|dbri_reset
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: reset 0:%x 2:%x 8:%x 9:%x&bslash;n&quot;
comma
id|dbri-&gt;regs-&gt;reg0
comma
id|dbri-&gt;regs-&gt;reg2
comma
id|dbri-&gt;regs-&gt;reg8
comma
id|dbri-&gt;regs-&gt;reg9
)paren
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg0
op_assign
id|D_R
suffix:semicolon
multiline_comment|/* Soft Reset */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|dbri-&gt;regs-&gt;reg0
op_amp
id|D_R
)paren
op_logical_and
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
DECL|function|dbri_detach
r_static
r_void
id|dbri_detach
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
id|dbri_reset
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dbri-&gt;irq
comma
id|dbri
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|dbri-&gt;regs
comma
id|dbri-&gt;regs_size
)paren
suffix:semicolon
multiline_comment|/* Should we release the DMA structure dbri-&gt;dma here? */
id|kfree
c_func
(paren
id|dbri
)paren
suffix:semicolon
)brace
DECL|function|dbri_initialize
r_static
r_void
id|dbri_initialize
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|n
suffix:semicolon
r_volatile
r_int
op_star
id|cmd
suffix:semicolon
id|dbri_reset
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: init: cmd: %x, int: %x&bslash;n&quot;
comma
(paren
r_int
)paren
id|dbri-&gt;dma-&gt;cmd
comma
(paren
r_int
)paren
id|dbri-&gt;dma-&gt;intr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the interrupt ringbuffer.&n;&t; */
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|DBRI_NO_INTS
op_minus
l_int|1
suffix:semicolon
id|n
op_increment
)paren
(brace
id|dbri-&gt;dma-&gt;intr
(braket
id|n
op_star
id|DBRI_INT_BLK
)braket
op_assign
(paren
r_int
)paren
(paren
op_amp
id|dbri-&gt;dma_dvma-&gt;intr
(braket
(paren
id|n
op_plus
l_int|1
)paren
op_star
id|DBRI_INT_BLK
)braket
)paren
suffix:semicolon
)brace
id|dbri-&gt;dma-&gt;intr
(braket
id|n
op_star
id|DBRI_INT_BLK
)braket
op_assign
(paren
r_int
)paren
(paren
id|dbri-&gt;dma_dvma-&gt;intr
)paren
suffix:semicolon
id|dbri-&gt;dbri_irqp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* We should query the openprom to see what burst sizes this&n;         * SBus supports.  For now, just disable all SBus bursts */
id|dbri-&gt;regs-&gt;reg0
op_and_assign
op_complement
(paren
id|D_G
op_or
id|D_S
op_or
id|D_E
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set up the interrupt queue&n;&t; */
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_IIQ
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
(paren
r_int
)paren
(paren
id|dbri-&gt;dma_dvma-&gt;intr
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;****************************************************************************&n;*************************** DBRI interrupt handler *************************&n;****************************************************************************&n;*/
multiline_comment|/*&n; * Short data pipes transmit LSB first. The CS4215 receives MSB first. Grrr.&n; * So we have to reverse the bits. Note: not all bit lengths are supported&n; */
DECL|function|reverse_bytes
r_static
id|__u32
id|reverse_bytes
c_func
(paren
id|__u32
id|b
comma
r_int
id|len
)paren
(brace
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|32
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xffff0000
)paren
op_rshift
l_int|16
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x0000ffff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_case
l_int|16
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xff00ff00
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x00ff00ff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_case
l_int|8
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xf0f0f0f0
)paren
op_rshift
l_int|4
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x0f0f0f0f
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
r_case
l_int|4
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xcccccccc
)paren
op_rshift
l_int|2
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x33333333
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xaaaaaaaa
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x55555555
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;DBRI reverse_bytes: unsupported length&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|b
suffix:semicolon
)brace
multiline_comment|/* transmission_complete_intr()&n; *&n; * Called by main interrupt handler when DBRI signals transmission complete&n; * on a pipe.&n; *&n; * Walks through the pipe&squot;s list of transmit buffer descriptors, releasing&n; * each one&squot;s DMA buffer (if present) and signaling its callback routine&n; * (if present), before flaging the descriptor available and proceeding&n; * to the next one.&n; *&n; * Assumes that only the last in a chain of descriptors will have FINT&n; * sent to signal an interrupt, so that the chain will be completely&n; * transmitted by the time we get here, and there&squot;s no need to save&n; * any of the descriptors.  In particular, use of the DBRI&squot;s CDP command&n; * is precluded, but I&squot;ve not been able to get CDP working reliably anyway.&n; */
DECL|function|transmission_complete_intr
r_static
r_void
id|transmission_complete_intr
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
)paren
(brace
r_int
id|td
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
suffix:semicolon
r_int
id|status
suffix:semicolon
r_void
op_star
id|buffer
suffix:semicolon
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|td
op_ge
l_int|0
suffix:semicolon
id|td
op_assign
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|next
)paren
(brace
r_if
c_cond
(paren
id|td
op_ge
id|DBRI_NO_DESCS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: invalid td on pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|status
op_assign
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|word4
suffix:semicolon
id|buffer
op_assign
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|buffer
)paren
(brace
id|mmu_release_scsi_one
c_func
(paren
id|sbus_dvma_addr
c_func
(paren
id|buffer
)paren
comma
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|len
comma
id|dbri-&gt;sdev-&gt;my_bus
)paren
suffix:semicolon
)brace
id|callback
op_assign
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|output_callback
suffix:semicolon
r_if
c_cond
(paren
id|callback
op_ne
l_int|NULL
)paren
(brace
id|callback
c_func
(paren
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|output_callback_arg
comma
id|DBRI_TD_STATUS
c_func
(paren
id|status
)paren
op_amp
l_int|0xe
)paren
suffix:semicolon
)brace
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|inuse
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|reception_complete_intr
r_static
r_void
id|reception_complete_intr
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
)paren
(brace
r_int
id|rd
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
suffix:semicolon
r_int
id|status
suffix:semicolon
r_void
op_star
id|buffer
suffix:semicolon
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
OL
l_int|0
op_logical_or
id|rd
op_ge
id|DBRI_NO_DESCS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: invalid rd on pipe %d&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|inuse
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
op_minus
l_int|1
suffix:semicolon
id|status
op_assign
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|word1
suffix:semicolon
id|buffer
op_assign
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|buffer
)paren
(brace
id|mmu_release_scsi_one
c_func
(paren
id|sbus_dvma_addr
c_func
(paren
id|buffer
)paren
comma
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|len
comma
id|dbri-&gt;sdev-&gt;my_bus
)paren
suffix:semicolon
)brace
id|callback
op_assign
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|input_callback
suffix:semicolon
r_if
c_cond
(paren
id|callback
op_ne
l_int|NULL
)paren
(brace
id|callback
c_func
(paren
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|input_callback_arg
comma
id|DBRI_RD_STATUS
c_func
(paren
id|status
)paren
comma
id|DBRI_RD_CNT
c_func
(paren
id|status
)paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
)brace
DECL|function|dbri_intr
r_static
r_void
id|dbri_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|opaque
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|opaque
suffix:semicolon
r_int
id|x
suffix:semicolon
multiline_comment|/*&n;&t; * Read it, so the interrupt goes away.&n;&t; */
id|x
op_assign
id|dbri-&gt;regs-&gt;reg1
suffix:semicolon
r_if
c_cond
(paren
id|x
op_amp
(paren
id|D_MRR
op_or
id|D_MLE
op_or
id|D_LBG
op_or
id|D_MBE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * What should I do here ?&n;&t;&t; */
r_if
c_cond
(paren
id|x
op_amp
id|D_MRR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Multiple Error Ack on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_MLE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Multiple Late Error on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_LBG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Lost Bus Grant on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_MBE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Burst Error on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|x
op_amp
id|D_IR
)paren
)paren
multiline_comment|/* Not for us */
r_return
suffix:semicolon
id|x
op_assign
id|dbri-&gt;dma-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
suffix:semicolon
r_while
c_loop
(paren
id|x
op_ne
l_int|0
)paren
(brace
r_int
id|val
op_assign
id|D_INTR_GETVAL
c_func
(paren
id|x
)paren
suffix:semicolon
r_int
id|channel
op_assign
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
suffix:semicolon
id|dbri-&gt;dma-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_CMD
)paren
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: INTR: Command: %-5s  Value:%d&bslash;n&quot;
comma
id|cmds
(braket
id|D_INTR_GETCMD
c_func
(paren
id|x
)paren
)braket
comma
id|D_INTR_GETVAL
c_func
(paren
id|x
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: INTR: Chan:%d Code:%d Val:%#x&bslash;n&quot;
comma
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
comma
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
comma
id|D_INTR_GETRVAL
c_func
(paren
id|x
)paren
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_SBRI
)paren
(brace
multiline_comment|/* SBRI - BRI status change */
r_int
id|liu_states
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|0
comma
l_int|8
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
)brace
suffix:semicolon
id|dbri-&gt;liu_state
op_assign
id|liu_states
(braket
id|val
op_amp
l_int|0x7
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;liu_callback
)paren
id|dbri
op_member_access_from_pointer
id|liu_callback
c_func
(paren
id|dbri-&gt;liu_callback_arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_BRDY
)paren
(brace
id|reception_complete_intr
c_func
(paren
id|dbri
comma
id|channel
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_XCMP
)paren
(brace
id|transmission_complete_intr
c_func
(paren
id|dbri
comma
id|channel
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_FXDT
)paren
(brace
multiline_comment|/* FXDT - Fixed data change */
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
)braket
dot
id|sdp
op_amp
id|D_SDP_MSB
)paren
(brace
id|val
op_assign
id|reverse_bytes
c_func
(paren
id|val
comma
id|dbri-&gt;pipes
(braket
id|channel
)braket
dot
id|length
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
)braket
dot
id|recv_fixed_ptr
)paren
(brace
op_star
id|dbri-&gt;pipes
(braket
id|channel
)braket
dot
id|recv_fixed_ptr
op_assign
id|val
suffix:semicolon
)brace
)brace
id|dbri-&gt;dbri_irqp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;dbri_irqp
op_eq
(paren
id|DBRI_NO_INTS
op_star
id|DBRI_INT_BLK
)paren
)paren
id|dbri-&gt;dbri_irqp
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|dbri-&gt;dbri_irqp
op_amp
(paren
id|DBRI_INT_BLK
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
id|dbri-&gt;dbri_irqp
op_increment
suffix:semicolon
id|x
op_assign
id|dbri-&gt;dma-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;****************************************************************************&n;************************** DBRI data pipe management ***********************&n;****************************************************************************&n;*/
multiline_comment|/* reset_pipe(dbri, pipe)&n; *&n; * Called on an in-use pipe to clear anything being transmitted or received&n; */
DECL|function|reset_pipe
r_static
r_void
id|reset_pipe
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
)paren
(brace
r_int
id|sdp
suffix:semicolon
r_volatile
r_int
op_star
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: reset_pipe called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sdp
op_assign
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
suffix:semicolon
r_if
c_cond
(paren
id|sdp
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: reset_pipe called on uninitialized pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|sdp
op_or
id|D_SDP_C
op_or
id|D_SDP_P
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|setup_pipe
r_static
r_void
id|setup_pipe
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_int
id|sdp
)paren
(brace
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: setup_pipe called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sdp
op_amp
l_int|0xf800
)paren
op_ne
id|sdp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: setup_pipe called with strange SDP value&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* sdp &amp;= 0xf800; */
)brace
id|sdp
op_or_assign
id|D_PIPE
c_func
(paren
id|pipe
)paren
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_assign
id|sdp
suffix:semicolon
id|reset_pipe
c_func
(paren
id|dbri
comma
id|pipe
)paren
suffix:semicolon
)brace
DECL|enum|master_or_slave
DECL|enumerator|CHImaster
DECL|enumerator|CHIslave
r_enum
id|master_or_slave
(brace
id|CHImaster
comma
id|CHIslave
)brace
suffix:semicolon
DECL|function|reset_chi
r_static
r_void
id|reset_chi
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_enum
id|master_or_slave
id|master_or_slave
comma
r_int
id|bits_per_frame
)paren
(brace
r_volatile
r_int
op_star
id|cmd
suffix:semicolon
r_int
id|val
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* Set CHI Anchor: Pipe 16 */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_16
)paren
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;pipes
(braket
l_int|16
)braket
dot
id|sdp
op_assign
l_int|1
suffix:semicolon
id|dbri-&gt;pipes
(braket
l_int|16
)braket
dot
id|nextpipe
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|master_or_slave
op_eq
id|CHIslave
)paren
(brace
multiline_comment|/* Setup DBRI for CHI Slave - receive clock, frame sync (FS)&n;                 *&n;                 * CHICM  = 0 (slave mode, 8 kHz frame rate)&n;                 * IR     = give immediate CHI status interrupt&n;                 * EN     = give CHI status interrupt upon change&n;                 */
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CHI
comma
l_int|0
comma
id|D_CHI_CHICM
c_func
(paren
l_int|0
)paren
op_or
id|D_CHI_IR
op_or
id|D_CHI_EN
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Setup DBRI for CHI Master - generate clock, FS&n;                 *&n;                 * BPF&t;&t;&t;&t;=  bits per 8 kHz frame&n;                 * 12.288 MHz / CHICM_divisor&t;= clock rate&n;                 * FD  =  1 - drive CHIFS on rising edge of CHICK&n;                 */
r_int
id|clockrate
op_assign
id|bits_per_frame
op_star
l_int|8
suffix:semicolon
r_int
id|divisor
op_assign
l_int|12288
op_div
id|clockrate
suffix:semicolon
r_if
c_cond
(paren
id|divisor
OG
l_int|255
op_logical_or
id|divisor
op_star
id|clockrate
op_ne
l_int|12288
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: illegal bits_per_frame in setup_chi&bslash;n&quot;
)paren
suffix:semicolon
)brace
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CHI
comma
l_int|0
comma
id|D_CHI_CHICM
c_func
(paren
id|divisor
)paren
op_or
id|D_CHI_FD
op_or
id|D_CHI_IR
op_or
id|D_CHI_EN
op_or
id|D_CHI_BPF
c_func
(paren
id|bits_per_frame
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* CHI Data Mode&n;         *&n;         * RCE   =  0 - receive on falling edge of CHICK&n;         * XCE   =  1 - transmit on rising edge of CHICK&n;         * XEN   =  1 - enable transmitter&n;         * REN   =  1 - enable receiver&n;         */
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CDM
comma
l_int|0
comma
id|D_CDM_XCE
op_or
id|D_CDM_XEN
op_or
id|D_CDM_REN
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
DECL|enum|in_or_out
DECL|enumerator|PIPEinput
DECL|enumerator|PIPEoutput
r_enum
id|in_or_out
(brace
id|PIPEinput
comma
id|PIPEoutput
)brace
suffix:semicolon
DECL|function|link_time_slot
r_static
r_void
id|link_time_slot
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_enum
id|in_or_out
id|direction
comma
r_int
id|prevpipe
comma
r_int
id|length
comma
r_int
id|cycle
)paren
(brace
r_volatile
r_int
op_star
id|cmd
suffix:semicolon
r_int
id|val
suffix:semicolon
r_int
id|nextpipe
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
op_logical_or
id|prevpipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: link_time_slot called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_eq
l_int|0
op_logical_or
id|dbri-&gt;pipes
(braket
id|prevpipe
)braket
dot
id|sdp
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: link_time_slot called on uninitialized pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pipe
op_eq
id|prevpipe
)paren
(brace
id|nextpipe
op_assign
id|pipe
suffix:semicolon
)brace
r_else
(brace
id|nextpipe
op_assign
id|dbri-&gt;pipes
(braket
id|prevpipe
)braket
dot
id|nextpipe
suffix:semicolon
)brace
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|nextpipe
op_assign
id|nextpipe
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|cycle
op_assign
id|cycle
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|length
op_assign
id|length
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|PIPEinput
)paren
(brace
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|prevpipe
)paren
op_or
id|pipe
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_LEN
c_func
(paren
id|length
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
id|cycle
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|nextpipe
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|prevpipe
)paren
op_or
id|pipe
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|D_TS_LEN
c_func
(paren
id|length
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
id|cycle
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|nextpipe
)paren
suffix:semicolon
)brace
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
DECL|function|xmit_fixed
r_static
r_void
id|xmit_fixed
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_int
r_int
id|data
)paren
(brace
r_volatile
r_int
op_star
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_fixed called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_SDP_MODE
c_func
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
)paren
op_ne
id|D_SDP_FIXED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_fixed called on non-fixed pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_TO_SER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_fixed called on receive pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* DBRI short pipes always transmit LSB first */
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_MSB
)paren
(brace
id|data
op_assign
id|reverse_bytes
c_func
(paren
id|data
comma
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|length
)paren
suffix:semicolon
)brace
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SSP
comma
l_int|0
comma
id|pipe
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|data
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* recv_fixed()&n; *&n; * Receive data on a &quot;fixed&quot; pipe - i.e, one whose contents are not&n; * expected to change much, and which we don&squot;t need to read constantly&n; * into a buffer.  The DBRI only interrupts us when the data changes.&n; * Only short pipes (numbers 16-31) can be used in fixed data mode.&n; *&n; * Pass this function a pointer to a 32-bit field, no matter how large&n; * the actual time slot is.  The interrupt handler takes care of bit&n; * ordering and alignment.  An 8-bit time slot will always end up&n; * in the low-order 8 bits, filled either MSB-first or LSB-first,&n; * depending on the settings passed to setup_pipe()&n; */
DECL|function|recv_fixed
r_static
r_void
id|recv_fixed
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
id|__u32
op_star
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|pipe
template_param
l_int|31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_fixed called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|D_SDP_MODE
c_func
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
)paren
op_ne
id|D_SDP_FIXED
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_fixed called on non-fixed pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_TO_SER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_fixed called on transmit pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|recv_fixed_ptr
op_assign
id|ptr
suffix:semicolon
)brace
DECL|function|xmit_on_pipe
r_static
r_void
id|xmit_on_pipe
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_void
op_star
id|buffer
comma
r_int
r_int
id|len
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_volatile
r_int
op_star
id|cmd
suffix:semicolon
r_int
id|td
op_assign
l_int|0
suffix:semicolon
r_int
id|first_td
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|last_td
suffix:semicolon
id|__u32
id|dvma_buffer
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|15
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_on_pipe called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_on_pipe called on uninitialized pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_TO_SER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_on_pipe called on receive pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* XXX Fix this XXX&n;         * Should be able to queue multiple buffers to send on a pipe&n;         */
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_ne
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: xmit_on_pipe called on active pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dvma_buffer
op_assign
id|mmu_get_scsi_one
c_func
(paren
id|buffer
comma
id|len
comma
id|dbri-&gt;sdev-&gt;my_bus
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|mylen
suffix:semicolon
r_for
c_loop
(paren
id|td
suffix:semicolon
id|td
OL
id|DBRI_NO_DESCS
suffix:semicolon
id|td
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|inuse
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|td
op_eq
id|DBRI_NO_DESCS
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
(paren
l_int|1
op_lshift
l_int|13
)paren
op_minus
l_int|1
)paren
(brace
id|mylen
op_assign
(paren
l_int|1
op_lshift
l_int|13
)paren
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|mylen
op_assign
id|len
suffix:semicolon
)brace
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|inuse
op_assign
l_int|1
suffix:semicolon
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|next
op_assign
op_minus
l_int|1
suffix:semicolon
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|buffer
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|output_callback
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;descs
(braket
id|td
)braket
dot
id|input_callback
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|word1
op_assign
id|DBRI_TD_CNT
c_func
(paren
id|mylen
)paren
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|ba
op_assign
id|dvma_buffer
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|nda
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|td
)braket
dot
id|word4
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|first_td
op_eq
op_minus
l_int|1
)paren
(brace
id|first_td
op_assign
id|td
suffix:semicolon
)brace
r_else
(brace
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|next
op_assign
id|td
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|last_td
)braket
dot
id|nda
op_assign
(paren
r_int
)paren
op_amp
id|dbri-&gt;dma_dvma-&gt;desc
(braket
id|td
)braket
suffix:semicolon
)brace
id|last_td
op_assign
id|td
suffix:semicolon
id|dvma_buffer
op_add_assign
id|mylen
suffix:semicolon
id|len
op_sub_assign
id|mylen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|first_td
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xmit_on_pipe: No descriptors available&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xmit_on_pipe: Insufficient descriptors; data truncated&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|dbri-&gt;dma-&gt;desc
(braket
id|last_td
)braket
dot
id|word1
op_or_assign
id|DBRI_TD_I
op_or
id|DBRI_TD_F
op_or
id|DBRI_TD_B
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|buffer
op_assign
id|buffer
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|output_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;descs
(braket
id|last_td
)braket
dot
id|output_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
id|first_td
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_or
id|D_SDP_P
op_or
id|D_SDP_C
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
(paren
r_int
)paren
op_amp
id|dbri-&gt;dma_dvma-&gt;desc
(braket
id|first_td
)braket
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
DECL|function|recv_on_pipe
r_static
r_void
id|recv_on_pipe
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|pipe
comma
r_void
op_star
id|buffer
comma
r_int
r_int
id|len
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_volatile
r_int
op_star
id|cmd
suffix:semicolon
r_int
id|rd
suffix:semicolon
r_if
c_cond
(paren
id|pipe
template_param
l_int|15
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_on_pipe called with illegal pipe number&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_on_pipe called on uninitialized pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_amp
id|D_SDP_TO_SER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_on_pipe called on transmit pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* XXX Fix this XXX&n;         * Should be able to queue multiple buffers to send on a pipe&n;         */
r_if
c_cond
(paren
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_ne
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: recv_on_pipe called on active pipe&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* XXX Fix this XXX&n;         * Use multiple descriptors, if needed, to fit in all the data&n;         */
r_if
c_cond
(paren
id|len
OG
(paren
l_int|1
op_lshift
l_int|13
)paren
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;recv_on_pipe called with len=%d; truncated&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
id|len
op_assign
(paren
l_int|1
op_lshift
l_int|13
)paren
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Make sure buffer size is multiple of four */
id|len
op_and_assign
op_complement
l_int|3
suffix:semicolon
r_for
c_loop
(paren
id|rd
op_assign
l_int|0
suffix:semicolon
id|rd
OL
id|DBRI_NO_DESCS
suffix:semicolon
id|rd
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|inuse
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rd
op_eq
id|DBRI_NO_DESCS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI xmit_on_pipe: No descriptors available&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|word1
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|ba
op_assign
id|mmu_get_scsi_one
c_func
(paren
id|buffer
comma
id|len
comma
id|dbri-&gt;sdev-&gt;my_bus
)paren
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|nda
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;dma-&gt;desc
(braket
id|rd
)braket
dot
id|word4
op_assign
id|DBRI_RD_B
op_or
id|DBRI_RD_BCNT
c_func
(paren
id|len
)paren
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|buffer
op_assign
id|buffer
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|len
op_assign
id|len
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|input_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;descs
(braket
id|rd
)braket
dot
id|input_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|desc
op_assign
id|rd
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|dbri-&gt;pipes
(braket
id|pipe
)braket
dot
id|sdp
op_or
id|D_SDP_P
)paren
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
(paren
r_int
)paren
op_amp
id|dbri-&gt;dma_dvma-&gt;desc
(braket
id|rd
)braket
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;****************************************************************************&n;*********************** CS4215 audio codec management **********************&n;****************************************************************************&n;*/
DECL|function|mmcodec_default
r_static
r_void
id|mmcodec_default
c_func
(paren
r_struct
id|cs4215
op_star
id|mm
)paren
(brace
multiline_comment|/*&n;&t; * No action, memory resetting only.&n;&t; *&n;&t; * Data Time Slot 5-8&n;&t; * Speaker,Line and Headphone enable. Gain set to the half.&n;&t; * Input is mike.&n;&t; */
id|mm-&gt;data
(braket
l_int|0
)braket
op_assign
id|CS4215_LO
c_func
(paren
l_int|0x20
)paren
op_or
id|CS4215_HE
op_or
id|CS4215_LE
suffix:semicolon
id|mm-&gt;data
(braket
l_int|1
)braket
op_assign
id|CS4215_RO
c_func
(paren
l_int|0x20
)paren
op_or
id|CS4215_SE
suffix:semicolon
id|mm-&gt;data
(braket
l_int|2
)braket
op_assign
id|CS4215_LG
c_func
(paren
l_int|0x8
)paren
op_or
id|CS4215_IS
op_or
id|CS4215_PIO0
op_or
id|CS4215_PIO1
suffix:semicolon
id|mm-&gt;data
(braket
l_int|3
)braket
op_assign
id|CS4215_RG
c_func
(paren
l_int|0x8
)paren
op_or
id|CS4215_MA
c_func
(paren
l_int|0xf
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Control Time Slot 1-4&n;&t; * 0: Default I/O voltage scale&n;&t; * 1: 8 bit ulaw, 8kHz, mono, high pass filter disabled&n;&t; * 2: Serial enable, CHI master, 128 bits per frame, clock 1&n;&t; * 3: Tests disabled&n;&t; */
id|mm-&gt;ctrl
(braket
l_int|0
)braket
op_assign
id|CS4215_RSRVD_1
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|1
)braket
op_assign
id|CS4215_DFR_ULAW
op_or
id|CS4215_FREQ
(braket
l_int|0
)braket
dot
id|csval
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|2
)braket
op_assign
id|CS4215_XCLK
op_or
id|CS4215_BSEL_128
op_or
id|CS4215_FREQ
(braket
l_int|0
)braket
dot
id|xtal
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|mmcodec_init_data
r_static
r_void
id|mmcodec_init_data
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
multiline_comment|/*&n;&t; * Data mode:&n;&t; * Pipe  4: Send timeslots 1-4 (audio data)&n;&t; * Pipe 17: Send timeslots 5-8 (part of ctrl data)&n;&t; * Pipe  6: Receive timeslots 1-4 (audio data)&n;&t; * Pipe 20: Receive timeslots 6-7. We can only receive 20 bits via&n;&t; *          interrupt, and the rest of the data (slot 5 and 8) is&n;&t; *&t;    not relevant for us (only for doublechecking).&n;         *&n;         * Just like in control mode, the time slots are all offset by eight&n;         * bits.  The CS4215, it seems, observes TSIN (the delayed signal)&n;         * even if it&squot;s the CHI master.  Don&squot;t ask me...&n;&t; */
multiline_comment|/* Switch CS4215 to data mode - set PIO3 to 1 */
id|dbri-&gt;regs-&gt;reg2
op_assign
id|D_ENPIO
op_or
id|D_PIO1
op_or
id|D_PIO3
op_or
(paren
id|dbri-&gt;mm.onboard
ques
c_cond
id|D_PIO0
suffix:colon
id|D_PIO2
)paren
suffix:semicolon
id|reset_chi
c_func
(paren
id|dbri
comma
id|CHIslave
comma
l_int|0
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|4
comma
id|D_SDP_MEM
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|17
comma
id|D_SDP_FIXED
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|6
comma
id|D_SDP_MEM
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|20
comma
id|D_SDP_FIXED
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
multiline_comment|/* Pipes 4 and 6 - Single time slot, 8 bit mono */
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|17
comma
id|PIPEoutput
comma
l_int|16
comma
l_int|32
comma
l_int|32
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|4
comma
id|PIPEoutput
comma
l_int|17
comma
l_int|8
comma
l_int|128
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|6
comma
id|PIPEinput
comma
l_int|16
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|20
comma
id|PIPEinput
comma
l_int|6
comma
l_int|16
comma
l_int|40
)paren
suffix:semicolon
id|xmit_fixed
c_func
(paren
id|dbri
comma
l_int|17
comma
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Send the control information (i.e. audio format)&n; */
DECL|function|mmcodec_setctrl
r_static
r_void
id|mmcodec_setctrl
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|i
comma
id|val
suffix:semicolon
multiline_comment|/*&n;&t; * Enable Control mode: Set DBRI&squot;s PIO3 (4215&squot;s D/~C) to 0, then wait&n;&t; * 12 cycles &lt;= 12/(5512.5*64) sec = 34.01 usec&n;&t; */
id|val
op_assign
id|D_ENPIO
op_or
id|D_PIO1
op_or
(paren
id|dbri-&gt;mm.onboard
ques
c_cond
id|D_PIO0
suffix:colon
id|D_PIO2
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg2
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|34
)paren
suffix:semicolon
multiline_comment|/* In Control mode, the CS4215 is a slave device, so the DBRI must&n;         * operate as CHI master, supplying clocking and frame synchronization.&n;         *&n;         * In Data mode, however, the CS4215 must be CHI master to insure&n;         * that its data stream is synchronous with its codec.&n;         *&n;         * The upshot of all this?  We start by putting the DBRI into master&n;         * mode, program the CS4215 in Control mode, then switch the CS4215&n;         * into Data mode and put the DBRI into slave mode.  Various timing&n;         * requirements must be observed along the way.&n;         *&n;         * Oh, and one more thing, on a SPARCStation 20 (and maybe&n;         * others?), the addressing of the CS4215&squot;s time slots is&n;         * offset by eight bits, so we add eight to all the &quot;cycle&quot;&n;         * values in the Define Time Slot (DTS) commands.  This is&n;         * done in hardware by a TI 248 that delays the DBRI-&gt;4215&n;         * frame sync signal by eight clock cycles.  Anybody know why?&n;         */
id|reset_chi
c_func
(paren
id|dbri
comma
id|CHImaster
comma
l_int|128
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Control mode:&n;&t; * Pipe 17: Send timeslots 1-4 (slots 5-8 are readonly)&n;&t; * Pipe 18: Receive timeslot 1 (clb).&n;&t; * Pipe 19: Receive timeslot 7 (version). &n;&t; */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|17
comma
id|D_SDP_FIXED
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|18
comma
id|D_SDP_FIXED
op_or
id|D_SDP_CHANGE
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|19
comma
id|D_SDP_FIXED
op_or
id|D_SDP_CHANGE
op_or
id|D_SDP_MSB
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|17
comma
id|PIPEoutput
comma
l_int|16
comma
l_int|32
comma
l_int|128
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|18
comma
id|PIPEinput
comma
l_int|16
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|19
comma
id|PIPEinput
comma
l_int|18
comma
l_int|8
comma
l_int|48
)paren
suffix:semicolon
id|recv_fixed
c_func
(paren
id|dbri
comma
l_int|18
comma
op_amp
id|dbri-&gt;mm.status
)paren
suffix:semicolon
id|recv_fixed
c_func
(paren
id|dbri
comma
l_int|19
comma
op_amp
id|dbri-&gt;mm.version
)paren
suffix:semicolon
multiline_comment|/* Wait for the chip to echo back CLB (Control Latch Bit) as zero */
id|dbri-&gt;mm.ctrl
(braket
l_int|0
)braket
op_and_assign
op_complement
id|CS4215_CLB
suffix:semicolon
id|xmit_fixed
c_func
(paren
id|dbri
comma
l_int|17
comma
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
)paren
suffix:semicolon
id|i
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
id|dbri-&gt;mm.status
op_amp
id|CS4215_CLB
)paren
op_logical_and
id|i
op_decrement
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;CS4215 didn&squot;t respond to CLB&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Terminate CS4215 control mode - data sheet says&n;         * &quot;Set CLB=1 and send two more frames of valid control info&quot;&n;         */
id|dbri-&gt;mm.ctrl
(braket
l_int|0
)braket
op_or_assign
id|CS4215_CLB
suffix:semicolon
id|xmit_fixed
c_func
(paren
id|dbri
comma
l_int|17
comma
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
)paren
suffix:semicolon
multiline_comment|/* Two frames of control info @ 8kHz frame rate = 250 us delay */
id|udelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
DECL|function|mmcodec_init
r_static
r_int
id|mmcodec_init
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|reg2
op_assign
id|dbri-&gt;regs-&gt;reg2
suffix:semicolon
multiline_comment|/* Look for the cs4215 chips */
r_if
c_cond
(paren
id|reg2
op_amp
id|D_PIO2
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Onboard CS4215 detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg2
op_amp
id|D_PIO0
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Speakerbox detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Using the Speakerbox, if both are attached.  */
r_if
c_cond
(paren
(paren
id|reg2
op_amp
id|D_PIO2
)paren
op_logical_and
(paren
id|reg2
op_amp
id|D_PIO0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Using speakerbox / ignoring onboard mmcodec.&bslash;n&quot;
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg2
op_assign
id|D_ENPIO2
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg2
op_amp
(paren
id|D_PIO0
op_or
id|D_PIO2
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: no mmcodec found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Now talk to our baby */
id|dbri-&gt;regs-&gt;reg0
op_or_assign
id|D_C
suffix:semicolon
multiline_comment|/* Enable CHI */
id|mmcodec_default
c_func
(paren
op_amp
id|dbri-&gt;mm
)paren
suffix:semicolon
id|dbri-&gt;mm.version
op_assign
l_int|0xff
suffix:semicolon
id|mmcodec_setctrl
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;mm.version
op_eq
l_int|0xff
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|mmcodec_init_data
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;****************************************************************************&n;******************** Interface with sparcaudio midlevel ********************&n;****************************************************************************&n;*/
DECL|function|dbri_open
r_static
r_int
id|dbri_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_release
r_static
r_void
id|dbri_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|dbri_ioctl
r_static
r_int
id|dbri_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|x
comma
r_int
r_int
id|y
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_audio_output_callback
r_static
r_void
id|dbri_audio_output_callback
c_func
(paren
r_void
op_star
id|callback_arg
comma
r_int
id|status
)paren
(brace
r_struct
id|sparcaudio_driver
op_star
id|drv
op_assign
id|callback_arg
suffix:semicolon
id|sparcaudio_output_done
c_func
(paren
id|drv
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|dbri_start_output
r_static
r_void
id|dbri_start_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
multiline_comment|/* Pipe 4 is audio transmit */
id|xmit_on_pipe
c_func
(paren
id|dbri
comma
l_int|4
comma
id|buffer
comma
id|count
comma
op_amp
id|dbri_audio_output_callback
comma
id|drv
)paren
suffix:semicolon
)brace
DECL|function|dbri_stop_output
r_static
r_void
id|dbri_stop_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|reset_pipe
c_func
(paren
id|dbri
comma
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|dbri_start_input
r_static
r_void
id|dbri_start_input
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|len
)paren
(brace
)brace
DECL|function|dbri_stop_input
r_static
r_void
id|dbri_stop_input
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
)brace
DECL|function|dbri_audio_getdev
r_static
r_void
id|dbri_audio_getdev
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|audio_device_t
op_star
id|devptr
)paren
(brace
)brace
DECL|function|dbri_set_output_volume
r_static
r_int
id|dbri_set_output_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|volume
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_volume
r_static
r_int
id|dbri_get_output_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_input_volume
r_static
r_int
id|dbri_set_input_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|volume
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_volume
r_static
r_int
id|dbri_get_input_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_monitor_volume
r_static
r_int
id|dbri_set_monitor_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|volume
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_monitor_volume
r_static
r_int
id|dbri_get_monitor_volume
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_output_balance
r_static
r_int
id|dbri_set_output_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|balance
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_balance
r_static
r_int
id|dbri_get_output_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_input_balance
r_static
r_int
id|dbri_set_input_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|balance
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_balance
r_static
r_int
id|dbri_get_input_balance
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_output_channels
r_static
r_int
id|dbri_set_output_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|chan
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_channels
r_static
r_int
id|dbri_get_output_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_input_channels
r_static
r_int
id|dbri_set_input_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|chan
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_channels
r_static
r_int
id|dbri_get_input_channels
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_output_precision
r_static
r_int
id|dbri_set_output_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|prec
)paren
(brace
r_return
l_int|8
suffix:semicolon
)brace
DECL|function|dbri_get_output_precision
r_static
r_int
id|dbri_get_output_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|8
suffix:semicolon
)brace
DECL|function|dbri_set_input_precision
r_static
r_int
id|dbri_set_input_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|prec
)paren
(brace
r_return
l_int|8
suffix:semicolon
)brace
DECL|function|dbri_get_input_precision
r_static
r_int
id|dbri_get_input_precision
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|8
suffix:semicolon
)brace
DECL|function|dbri_set_output_port
r_static
r_int
id|dbri_set_output_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|port
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_port
r_static
r_int
id|dbri_get_output_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_input_port
r_static
r_int
id|dbri_set_input_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|port
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_port
r_static
r_int
id|dbri_get_input_port
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_output_encoding
r_static
r_int
id|dbri_set_output_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|enc
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_encoding
r_static
r_int
id|dbri_get_output_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_input_encoding
r_static
r_int
id|dbri_set_input_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|enc
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_encoding
r_static
r_int
id|dbri_get_input_encoding
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_output_rate
r_static
r_int
id|dbri_set_output_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|rate
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_rate
r_static
r_int
id|dbri_get_output_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_input_rate
r_static
r_int
id|dbri_set_input_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|rate
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_rate
r_static
r_int
id|dbri_get_input_rate
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_sunaudio_getdev_sunos
r_static
r_int
id|dbri_sunaudio_getdev_sunos
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_ports
r_static
r_int
id|dbri_get_output_ports
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_input_ports
r_static
r_int
id|dbri_get_input_ports
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_set_output_muted
r_static
r_int
id|dbri_set_output_muted
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_int
id|mute
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_get_output_muted
r_static
r_int
id|dbri_get_output_muted
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|dbri_ops
r_static
r_struct
id|sparcaudio_operations
id|dbri_ops
op_assign
(brace
id|dbri_open
comma
id|dbri_release
comma
id|dbri_ioctl
comma
id|dbri_start_output
comma
id|dbri_stop_output
comma
id|dbri_start_input
comma
id|dbri_stop_input
comma
id|dbri_audio_getdev
comma
id|dbri_set_output_volume
comma
id|dbri_get_output_volume
comma
id|dbri_set_input_volume
comma
id|dbri_get_input_volume
comma
id|dbri_set_monitor_volume
comma
id|dbri_get_monitor_volume
comma
id|dbri_set_output_balance
comma
id|dbri_get_output_balance
comma
id|dbri_set_input_balance
comma
id|dbri_get_input_balance
comma
id|dbri_set_output_channels
comma
id|dbri_get_output_channels
comma
id|dbri_set_input_channels
comma
id|dbri_get_input_channels
comma
id|dbri_set_output_precision
comma
id|dbri_get_output_precision
comma
id|dbri_set_input_precision
comma
id|dbri_get_input_precision
comma
id|dbri_set_output_port
comma
id|dbri_get_output_port
comma
id|dbri_set_input_port
comma
id|dbri_get_input_port
comma
id|dbri_set_output_encoding
comma
id|dbri_get_output_encoding
comma
id|dbri_set_input_encoding
comma
id|dbri_get_input_encoding
comma
id|dbri_set_output_rate
comma
id|dbri_get_output_rate
comma
id|dbri_set_input_rate
comma
id|dbri_get_input_rate
comma
id|dbri_sunaudio_getdev_sunos
comma
id|dbri_get_output_ports
comma
id|dbri_get_input_ports
comma
id|dbri_set_output_muted
comma
id|dbri_get_output_muted
comma
)brace
suffix:semicolon
multiline_comment|/*&n;****************************************************************************&n;************************** ISDN (Hisax) Interface **************************&n;****************************************************************************&n;*/
DECL|function|dbri_isdn_init
r_void
id|dbri_isdn_init
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
multiline_comment|/* Pipe  0: Receive D channel&n;         * Pipe  8: Receive B1 channel&n;         * Pipe  9: Receive B2 channel&n;         * Pipe  1: Transmit D channel&n;         * Pipe 10: Transmit B1 channel&n;         * Pipe 11: Transmit B2 channel&n;         */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|0
comma
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|8
comma
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|9
comma
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|1
comma
id|D_SDP_HDLC_D
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|10
comma
id|D_SDP_HDLC
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|11
comma
id|D_SDP_HDLC
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|0
comma
id|PIPEinput
comma
l_int|0
comma
l_int|2
comma
l_int|17
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|8
comma
id|PIPEinput
comma
l_int|8
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|9
comma
id|PIPEinput
comma
l_int|9
comma
l_int|8
comma
l_int|8
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|1
comma
id|PIPEoutput
comma
l_int|1
comma
l_int|2
comma
l_int|17
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|10
comma
id|PIPEoutput
comma
l_int|1
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|link_time_slot
c_func
(paren
id|dbri
comma
l_int|11
comma
id|PIPEoutput
comma
l_int|10
comma
l_int|8
comma
l_int|8
)paren
suffix:semicolon
)brace
DECL|function|dbri_get_irqnum
r_int
id|dbri_get_irqnum
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* On the sparc, the cpu&squot;s irq number is only part of the &quot;irq&quot; */
r_return
(paren
id|dbri-&gt;irq
op_amp
id|NR_IRQS
)paren
suffix:semicolon
)brace
DECL|function|dbri_get_liu_state
r_int
id|dbri_get_liu_state
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_return
id|dbri-&gt;liu_state
suffix:semicolon
)brace
r_void
id|dbri_liu_activate
c_func
(paren
r_int
id|dev
comma
r_int
id|priority
)paren
suffix:semicolon
DECL|function|dbri_liu_init
r_void
id|dbri_liu_init
c_func
(paren
r_int
id|dev
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Set callback for LIU state change */
id|dbri-&gt;liu_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;liu_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|dbri_isdn_init
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|dbri_liu_activate
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|dbri_liu_activate
r_void
id|dbri_liu_activate
c_func
(paren
r_int
id|dev
comma
r_int
id|priority
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_int
id|val
suffix:semicolon
r_volatile
r_int
op_star
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|cmd
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* Turn on the ISDN TE interface and request activation */
id|val
op_assign
id|D_NT_IRM_IMM
op_or
id|D_NT_IRM_EN
op_or
id|D_NT_ACT
suffix:semicolon
op_star
(paren
id|cmd
op_increment
)paren
op_assign
id|DBRI_CMD
c_func
(paren
id|D_TE
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Activate the interface */
id|dbri-&gt;regs-&gt;reg0
op_or_assign
id|D_T
suffix:semicolon
)brace
DECL|function|dbri_liu_deactivate
r_void
id|dbri_liu_deactivate
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Turn off the ISDN TE interface */
id|dbri-&gt;regs-&gt;reg0
op_and_assign
op_complement
id|D_T
suffix:semicolon
)brace
DECL|function|dbri_dxmit
r_void
id|dbri_dxmit
c_func
(paren
r_int
id|dev
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Pipe 1 is D channel transmit */
id|xmit_on_pipe
c_func
(paren
id|dbri
comma
l_int|1
comma
id|buffer
comma
id|count
comma
id|callback
comma
id|callback_arg
)paren
suffix:semicolon
)brace
DECL|function|dbri_drecv
r_void
id|dbri_drecv
c_func
(paren
r_int
id|dev
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|size
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Pipe 0 is D channel receive */
id|recv_on_pipe
c_func
(paren
id|dbri
comma
l_int|0
comma
id|buffer
comma
id|size
comma
id|callback
comma
id|callback_arg
)paren
suffix:semicolon
)brace
DECL|function|dbri_bopen
r_int
id|dbri_bopen
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
r_int
id|hdlcmode
comma
id|u_char
id|xmit_idle_char
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_if
c_cond
(paren
id|hdlcmode
)paren
(brace
multiline_comment|/* return -1; */
multiline_comment|/* Pipe 8/9: receive B1/B2 channel */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|8
op_plus
id|chan
comma
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
multiline_comment|/* Pipe 10/11: transmit B1/B2 channel */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|10
op_plus
id|chan
comma
id|D_SDP_HDLC
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* !hdlcmode means transparent */
multiline_comment|/* Pipe 8/9: receive B1/B2 channel */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|8
op_plus
id|chan
comma
id|D_SDP_MEM
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
multiline_comment|/* Pipe 10/11: transmit B1/B2 channel */
id|setup_pipe
c_func
(paren
id|dbri
comma
l_int|10
op_plus
id|chan
comma
id|D_SDP_MEM
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_LSB
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_bclose
r_void
id|dbri_bclose
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|reset_pipe
c_func
(paren
id|dbri
comma
l_int|8
op_plus
id|chan
)paren
suffix:semicolon
id|reset_pipe
c_func
(paren
id|dbri
comma
l_int|10
op_plus
id|chan
)paren
suffix:semicolon
)brace
DECL|function|dbri_bxmit
r_void
id|dbri_bxmit
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Pipe 10/11 is B1/B2 channel transmit */
id|xmit_on_pipe
c_func
(paren
id|dbri
comma
l_int|10
op_plus
id|chan
comma
id|buffer
comma
id|count
comma
id|callback
comma
id|callback_arg
)paren
suffix:semicolon
)brace
DECL|function|dbri_brecv
r_void
id|dbri_brecv
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|size
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Pipe 8/9 is B1/B2 channel receive */
id|recv_on_pipe
c_func
(paren
id|dbri
comma
l_int|8
op_plus
id|chan
comma
id|buffer
comma
id|size
comma
id|callback
comma
id|callback_arg
)paren
suffix:semicolon
)brace
macro_line|#if defined(DBRI_ISDN) || defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x200ff
DECL|variable|dbri_foreign_interface
r_struct
id|foreign_interface
id|dbri_foreign_interface
op_assign
(brace
id|dbri_get_irqnum
comma
id|dbri_get_liu_state
comma
id|dbri_liu_init
comma
id|dbri_liu_activate
comma
id|dbri_liu_deactivate
comma
id|dbri_dxmit
comma
id|dbri_drecv
comma
id|dbri_bopen
comma
id|dbri_bclose
comma
id|dbri_bxmit
comma
id|dbri_brecv
)brace
suffix:semicolon
DECL|variable|dbri_foreign_interface
id|EXPORT_SYMBOL
c_func
(paren
id|dbri_foreign_interface
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;****************************************************************************&n;**************************** Initialization ********************************&n;****************************************************************************&n;*/
DECL|function|dbri_attach
r_static
r_int
id|dbri_attach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_struct
id|linux_sbus_device
op_star
id|sdev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_struct
id|linux_prom_irqs
id|irq
suffix:semicolon
id|__u32
id|dma_dvma
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
OL
l_char|&squot;e&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: unsupported chip version %c found.&bslash;n&quot;
comma
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|drv-&gt;ops
op_assign
op_amp
id|dbri_ops
suffix:semicolon
id|drv
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dbri
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drv
op_member_access_from_pointer
r_private
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|memset
c_func
(paren
id|dbri
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dbri
)paren
)paren
suffix:semicolon
multiline_comment|/* sparc_dvma_malloc() will halt the kernel if the malloc fails */
id|dbri-&gt;dma
op_assign
id|sparc_dvma_malloc
(paren
r_sizeof
(paren
r_struct
id|dbri_dma
)paren
comma
l_string|&quot;DBRI DMA Cmd Block&quot;
comma
op_amp
id|dma_dvma
)paren
suffix:semicolon
id|dbri-&gt;dma_dvma
op_assign
(paren
r_struct
id|dbri_dma
op_star
)paren
id|dma_dvma
suffix:semicolon
id|dbri-&gt;dbri_version
op_assign
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
suffix:semicolon
id|dbri-&gt;sdev
op_assign
id|sdev
suffix:semicolon
multiline_comment|/* Map the registers into memory. */
id|prom_apply_sbus_ranges
c_func
(paren
id|sdev-&gt;my_bus
comma
op_amp
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
comma
id|sdev-&gt;num_registers
comma
id|sdev
)paren
suffix:semicolon
id|dbri-&gt;regs_size
op_assign
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
suffix:semicolon
id|dbri-&gt;regs
op_assign
id|sparc_alloc_io
c_func
(paren
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
comma
l_string|&quot;DBRI Registers&quot;
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: could not allocate registers&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|prom_getproperty
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;intr&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irq
comma
r_sizeof
(paren
id|irq
)paren
)paren
suffix:semicolon
id|dbri-&gt;irq
op_assign
id|irq.pri
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|dbri-&gt;irq
comma
id|dbri_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;DBRI audio/ISDN&quot;
comma
id|dbri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dbri-&gt;irq
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|dbri-&gt;regs
comma
id|dbri-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dbri_initialize
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|err
op_assign
id|mmcodec_init
c_func
(paren
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dbri_detach
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Register ourselves with the midlevel audio driver. */
id|err
op_assign
id|register_sparcaudio_driver
c_func
(paren
id|drv
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: unable to register audio&bslash;n&quot;
)paren
suffix:semicolon
id|dbri_detach
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dbri-&gt;perchip_info.play.active
op_assign
id|dbri-&gt;perchip_info.play.pause
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;perchip_info.record.active
op_assign
id|dbri-&gt;perchip_info.record.pause
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;audio%d at 0x%lx (irq %d) is DBRI(%c)+CS4215(%d)&bslash;n&quot;
comma
id|num_drivers
comma
(paren
r_int
r_int
)paren
id|dbri-&gt;regs
comma
id|dbri-&gt;irq
comma
id|dbri-&gt;dbri_version
comma
id|dbri-&gt;mm.version
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Probe for the dbri chip and then attach the driver. */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_int
id|dbri_init
c_func
(paren
r_void
)paren
)paren
macro_line|#endif
(brace
r_struct
id|linux_sbus
op_star
id|bus
suffix:semicolon
r_struct
id|linux_sbus_device
op_star
id|sdev
suffix:semicolon
id|num_drivers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Probe each SBUS for the DBRI chip(s). */
id|for_all_sbusdev
c_func
(paren
id|sdev
comma
id|bus
)paren
(brace
multiline_comment|/*&n;&t;&t; * The version is coded in the last character&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;SUNW,DBRI&quot;
comma
l_int|9
)paren
)paren
(brace
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: Found %s in SBUS slot %d&bslash;n&quot;
comma
id|sdev-&gt;prom_name
comma
id|sdev-&gt;slot
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_drivers
op_ge
id|MAX_DRIVERS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Ignoring slot %d&bslash;n&quot;
comma
id|sdev-&gt;slot
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri_attach
c_func
(paren
op_amp
id|drivers
(braket
id|num_drivers
)braket
comma
id|sdev
)paren
op_eq
l_int|0
)paren
id|num_drivers
op_increment
suffix:semicolon
)brace
)brace
r_return
(paren
id|num_drivers
OG
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_drivers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dbri_detach
c_func
(paren
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|i
)braket
dot
r_private
)paren
suffix:semicolon
id|unregister_sparcaudio_driver
c_func
(paren
op_amp
id|drivers
(braket
id|i
)braket
comma
l_int|1
)paren
suffix:semicolon
id|num_drivers
op_decrement
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local Variables:&n; * c-indent-level: 8&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -8&n; * c-argdecl-indent: 8&n; * c-label-offset: -8&n; * c-continued-statement-offset: 8&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
