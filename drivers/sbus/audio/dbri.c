multiline_comment|/*&n; * drivers/sbus/audio/dbri.c&n; *&n; * Copyright (C) 1997 Rudolf Koenig (rfkoenig@immd4.informatik.uni-erlangen.de)&n; * The SparcLinux interface was adopted from the CS4231 driver.&n; *&n; * This is the lowlevel driver for the DBRI &amp; MMCODEC duo used for ISDN &amp; AUDIO&n; * on Sun SPARCstation 10, 20, LX and Voyager models.&n; * NOTE: This driver only supports audio for now, there is NO SUPPORT for ISDN.&n; *&n; * - DBRI: AT&amp;T T5900FX Dual Basic Rates ISDN Interface. It is a 32 channel&n; *   data time multiplexer with ISDN support (aka T7259)&n; *   Interfaces: SBus,ISDN NT &amp; TE, CHI, 4 bits parallel.&n; *   CHI: (spelled ki) Concentration Highway Interface (AT&amp;T or Intel bus ?).&n; *   Documentation:&n; *   - &quot;STP 4000SBus Dual Basic Rate ISDN (DBRI) Tranceiver&quot; from&n; *     Sparc Technology Business (courtesy of Sun Support)&n; *   - Data sheet of the T7903, a newer but very similar ISA bus equivalent&n; *     available from the Lucent (formarly AT&amp;T microelectronics) home&n; *     page.&n; * - MMCODEC: Crystal Semiconductor CS4215 16 bit Multimedia Audio Codec&n; *   Interfaces: CHI, Audio In &amp; Out, 2 bits parallel&n; *   Documentation: from the Crystal Semiconductor home page.&n; *&n; * The DBRI is a 32 pipe machine, each pipe can transfer some bits between&n; * memory and a serial device (long pipes, nr 0-15) or between two serial&n; * devices (short pipes, nr 16-31), or simply send a fixed data to a serial&n; * device (short pipes).&n; * A timeslot defines the bit-offset and nr of bits read from a serial device.&n; * The timeslots are linked to 6 circular lists, one for each direction for&n; * each serial device (NT,TE,CHI). A timeslot is associated to 1 or 2 pipes&n; * (the second one is a monitor/tee pipe, valid only for serial input).&n; *&n; * The mmcodec is connected via the CHI bus and needs the data &amp; some&n; * parameters (volume, balance, output selection) timemultiplexed in 8 byte&n; * chunks. It also has a control mode, which serves for audio format setting.&n; *&n; * Looking at the CS4215 data sheet it is easy to set up 2 or 4 codecs on&n; * the same CHI bus, so I thought perhaps it is possible to use the onboard&n; * &amp; the speakerbox codec simultanously, giving 2 (not very independent :-)&n; * audio devices. But the SUN HW group decided against it, at least on my&n; * LX the speakerbox connector has at least 1 pin missing and 1 wrongly&n; * connected.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &quot;audio.h&quot;
macro_line|#include &quot;dbri.h&quot;
DECL|macro|DBRI_DEBUG
mdefine_line|#define DBRI_DEBUG
macro_line|#ifdef DBRI_DEBUG
DECL|macro|dprintk
mdefine_line|#define dprintk(a, x) if(dbri_debug &amp; a) printk x
DECL|macro|D_GEN
mdefine_line|#define D_GEN&t;(1&lt;&lt;0)
DECL|macro|D_INT
mdefine_line|#define D_INT&t;(1&lt;&lt;1)
DECL|macro|D_CMD
mdefine_line|#define D_CMD&t;(1&lt;&lt;2)
DECL|macro|D_MM
mdefine_line|#define D_MM&t;(1&lt;&lt;3)
DECL|macro|D_USR
mdefine_line|#define D_USR&t;(1&lt;&lt;4)
DECL|variable|dbri_debug
r_static
r_int
id|dbri_debug
op_assign
id|D_GEN
op_or
id|D_INT
op_or
id|D_CMD
op_or
id|D_MM
op_or
id|D_USR
suffix:semicolon
DECL|variable|cmds
r_static
r_char
op_star
id|cmds
(braket
)braket
op_assign
(brace
l_string|&quot;WAIT&quot;
comma
l_string|&quot;PAUSE&quot;
comma
l_string|&quot;JUMP&quot;
comma
l_string|&quot;IIQ&quot;
comma
l_string|&quot;REX&quot;
comma
l_string|&quot;SDP&quot;
comma
l_string|&quot;CDP&quot;
comma
l_string|&quot;DTS&quot;
comma
l_string|&quot;SSP&quot;
comma
l_string|&quot;CHI&quot;
comma
l_string|&quot;NT&quot;
comma
l_string|&quot;TE&quot;
comma
l_string|&quot;CDEC&quot;
comma
l_string|&quot;TEST&quot;
comma
l_string|&quot;CDM&quot;
comma
l_string|&quot;RESRV&quot;
)brace
suffix:semicolon
multiline_comment|/* Bit hunting */
DECL|macro|dumpcmd
mdefine_line|#define dumpcmd {int i; for(i=0; i&lt;n; i++) printk(&quot;DBRI: %x&bslash;n&quot;, dbri-&gt;cmd[i]); }
macro_line|#else
DECL|macro|dprintk
mdefine_line|#define dprintk(a, x)
DECL|macro|dumpcmd
mdefine_line|#define dumpcmd
macro_line|#endif&t;/* DBRI_DEBUG */
DECL|macro|MAX_DRIVERS
mdefine_line|#define MAX_DRIVERS&t;2&t;/* Increase this if need more than 2 DBRI&squot;s */
DECL|macro|WAIT_INTR1
mdefine_line|#define WAIT_INTR1&t;0xbe
DECL|macro|WAIT_INTR2
mdefine_line|#define WAIT_INTR2&t;0xbf
DECL|variable|drivers
r_static
r_struct
id|sparcaudio_driver
id|drivers
(braket
id|MAX_DRIVERS
)braket
suffix:semicolon
DECL|variable|drv_name
r_static
r_char
id|drv_name
(braket
)braket
op_assign
l_string|&quot;DBRI/audio&quot;
suffix:semicolon
DECL|variable|num_drivers
r_static
r_int
id|num_drivers
suffix:semicolon
DECL|variable|dbri_cmdlocked
r_static
r_int
id|dbri_cmdlocked
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Make sure, that we can send a command to the dbri&n; */
DECL|function|dbri_cmdlock
r_static
r_int
id|dbri_cmdlock
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|was_sleeping
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dbri_cmdlocked
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|dbri-&gt;wait
)paren
suffix:semicolon
id|was_sleeping
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri_cmdlocked
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|dbri_cmdlocked
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|was_sleeping
)paren
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: Just woke up&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dummy
r_static
r_void
id|dummy
c_func
(paren
)paren
(brace
)brace
DECL|variable|dbri_ops
r_static
r_struct
id|sparcaudio_operations
id|dbri_ops
op_assign
(brace
id|dummy
comma
multiline_comment|/* dbri_open, */
id|dummy
comma
multiline_comment|/* dbri_release, */
id|dummy
comma
multiline_comment|/* dbri_ioctl, */
id|dummy
comma
multiline_comment|/* dbri_start_output, */
id|dummy
comma
multiline_comment|/* dbri_stop_output, */
id|dummy
comma
multiline_comment|/* dbri_start_input, */
id|dummy
comma
multiline_comment|/* dbri_stop_input, */
id|dummy
comma
multiline_comment|/* dbri_audio_getdev, */
)brace
suffix:semicolon
DECL|function|dbri_reset
r_static
r_void
id|dbri_reset
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: reset 0:%x 2:%x 8:%x 9:%x&bslash;n&quot;
comma
id|dbri-&gt;regs-&gt;reg0
comma
id|dbri-&gt;regs-&gt;reg2
comma
id|dbri-&gt;regs-&gt;reg8
comma
id|dbri-&gt;regs-&gt;reg9
)paren
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg0
op_assign
id|D_R
suffix:semicolon
multiline_comment|/* Soft Reset */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|dbri-&gt;regs-&gt;reg0
op_amp
id|D_R
)paren
op_logical_and
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
DECL|function|dbri_detach
r_static
r_void
id|dbri_detach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|info
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|dbri_reset
c_func
(paren
id|drv
)paren
suffix:semicolon
id|unregister_sparcaudio_driver
c_func
(paren
id|drv
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|info-&gt;irq
comma
id|drv
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|info-&gt;regs
comma
id|info-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
)brace
DECL|function|dbri_init
r_static
r_void
id|dbri_init
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|n
suffix:semicolon
id|dbri_reset
c_func
(paren
id|drv
)paren
suffix:semicolon
id|dbri-&gt;wait
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: init: cmd: %x, int: %x&bslash;n&quot;
comma
(paren
r_int
)paren
id|dbri-&gt;cmd
comma
(paren
r_int
)paren
id|dbri-&gt;intr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the interrupt ringbuffer.&n;&t; */
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|DBRI_NO_INTS
op_minus
l_int|1
suffix:semicolon
id|n
op_increment
)paren
(brace
id|dbri-&gt;intr
(braket
id|n
op_star
id|DBRI_INT_BLK
)braket
op_assign
(paren
r_int
)paren
(paren
op_amp
id|dbri-&gt;intr
(braket
(paren
id|n
op_plus
l_int|1
)paren
op_star
id|DBRI_INT_BLK
)braket
)paren
suffix:semicolon
)brace
id|dbri-&gt;intr
(braket
id|n
op_star
id|DBRI_INT_BLK
)braket
op_assign
(paren
r_int
)paren
(paren
id|dbri-&gt;intr
)paren
suffix:semicolon
id|dbri-&gt;dbri_irqp
op_assign
l_int|1
suffix:semicolon
id|dbri-&gt;regs-&gt;reg0
op_or_assign
(paren
id|D_G
op_or
id|D_S
op_or
id|D_E
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set up the interrupt queue&n;&t; */
(paren
r_void
)paren
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|n
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_IIQ
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
(paren
r_int
)paren
(paren
id|dbri-&gt;intr
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_WAIT
comma
l_int|1
comma
id|WAIT_INTR1
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg8
op_assign
(paren
r_int
)paren
id|dbri-&gt;cmd
suffix:semicolon
)brace
multiline_comment|/*&n; * Short data pipes transmit LSB first. The CS4215 receives MSB first. Grrr.&n; * So we have to reverse the bits. Note: only 1, 2 or 4 bytes are supported.&n; */
DECL|function|reverse_bytes
r_static
id|__u32
id|reverse_bytes
c_func
(paren
id|__u32
id|b
comma
r_int
id|len
)paren
(brace
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|4
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xffff0000
)paren
op_rshift
l_int|16
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x0000ffff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xff00ff00
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x00ff00ff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xf0f0f0f0
)paren
op_rshift
l_int|4
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x0f0f0f0f
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xcccccccc
)paren
op_rshift
l_int|2
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x33333333
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xaaaaaaaa
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x55555555
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|b
suffix:semicolon
)brace
DECL|function|mmcodec_default
r_static
r_void
id|mmcodec_default
c_func
(paren
r_struct
id|cs4215
op_star
id|mm
)paren
(brace
multiline_comment|/*&n;&t; * No action, memory resetting only.&n;&t; *&n;&t; * Data Time Slot 5-8&n;&t; * Speaker,Line and Headphone enable. Gain set to the half.&n;&t; * Input is mike.&n;&t; */
id|mm-&gt;data
(braket
l_int|0
)braket
op_assign
id|CS4215_LO
c_func
(paren
l_int|0x20
)paren
op_or
id|CS4215_HE
op_or
id|CS4215_LE
suffix:semicolon
id|mm-&gt;data
(braket
l_int|1
)braket
op_assign
id|CS4215_RO
c_func
(paren
l_int|0x20
)paren
op_or
id|CS4215_SE
suffix:semicolon
id|mm-&gt;data
(braket
l_int|2
)braket
op_assign
id|CS4215_LG
c_func
(paren
l_int|0x8
)paren
op_or
id|CS4215_IS
suffix:semicolon
id|mm-&gt;data
(braket
l_int|3
)braket
op_assign
id|CS4215_RG
c_func
(paren
l_int|0x8
)paren
op_or
id|CS4215_MA
c_func
(paren
l_int|0xf
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Control Time Slot 1-4&n;&t; * 0: Default I/O voltage scale&n;&t; * 1: 8 bit ulaw, 8kHz, mono, high pass filter disabled&n;&t; * 2: Serial enable, CHI master, 1 CHI device (64bit), clock 1&n;&t; * 3: Tests disabled&n;&t; */
id|mm-&gt;ctrl
(braket
l_int|0
)braket
op_assign
id|CS4215_RSRVD_1
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|1
)braket
op_assign
id|CS4215_DFR_ULAW
op_or
id|CS4215_FREQ
(braket
l_int|0
)braket
dot
id|csval
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|2
)braket
op_assign
id|CS4215_XEN
op_or
id|CS4215_XCLK
op_or
id|CS4215_BSEL_128
op_or
id|CS4215_FREQ
(braket
l_int|0
)braket
dot
id|xtal
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|mmcodec_init_data
r_static
r_void
id|mmcodec_init_data
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|val
comma
id|n
op_assign
l_int|0
suffix:semicolon
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Data mode:&n;&t; * Pipe  4: Send timeslots 1-4 (audio data)&n;&t; * Pipe 17: Send timeslots 5-8 (part of ctrl data)&n;&t; * Pipe  6: Receive timeslots 1-4 (audio data)&n;&t; * Pipe 19: Receive timeslots 6-7. We can only receive 20 bits via&n;&t; *          interrupt, and the rest of the data (slot 5 and 8) is&n;&t; *&t;    not relevant for us (only for doublechecking).&n;&t; */
multiline_comment|/* Transmit &amp; Receive Memory setup */
id|dbri-&gt;mm.td.flags
op_assign
id|DBRI_TD_F
op_or
id|DBRI_TD_D
op_or
id|DBRI_TD_CNT
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|dbri-&gt;mm.td.ba
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;mm.td.nda
op_assign
(paren
id|__u32
)paren
op_amp
id|dbri-&gt;mm.td
suffix:semicolon
id|dbri-&gt;mm.td.status
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;mm.td.flags
op_assign
id|DBRI_RD_BCNT
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|dbri-&gt;mm.td.ba
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;mm.td.nda
op_assign
(paren
id|__u32
)paren
op_amp
id|dbri-&gt;mm.rd
suffix:semicolon
id|dbri-&gt;mm.td.status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 4: SDP + DTS */
id|val
op_assign
id|D_SDP_MEM
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_MSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_4
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
(paren
id|__u32
)paren
op_amp
id|dbri-&gt;mm.td
suffix:semicolon
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_4
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|0
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
multiline_comment|/* Pipe 17: SDP + DTS + SSP */
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fixed data */
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_4
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|32
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|32
)paren
op_or
id|D_TS_NONCONTIG
op_or
id|D_TS_MON
c_func
(paren
id|D_P_4
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SSP
comma
l_int|0
comma
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|reverse_bytes
c_func
(paren
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.data
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Pipe 6: SDP + DTS */
id|val
op_assign
id|D_SDP_MEM
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_MSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_6
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
(paren
id|__u32
)paren
op_amp
id|dbri-&gt;mm.rd
suffix:semicolon
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_6
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|0
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 19: SDP + DTS */
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_P
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_19
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fixed data */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_6
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_19
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|16
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|40
)paren
op_or
id|D_TS_NONCONTIG
op_or
id|D_TS_MON
c_func
(paren
id|D_P_6
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_WAIT
comma
l_int|0
comma
id|WAIT_INTR1
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg8
op_assign
(paren
r_int
)paren
id|dbri-&gt;cmd
suffix:semicolon
)brace
multiline_comment|/*&n; * Send the control information (i.e. audio format)&n; */
DECL|function|mmcodec_setctrl
r_static
r_void
id|mmcodec_setctrl
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|n
op_assign
l_int|0
comma
id|val
suffix:semicolon
multiline_comment|/*&n;&t; * Enable Command mode: Set PIO3 to 0, then wait&n;&t; * 12 cycles &lt;= 12/(5512.5*64) sec = 34.01 usec&n;&t; */
id|val
op_assign
id|D_ENPIO
op_or
id|D_PIO1
op_or
(paren
id|dbri-&gt;mm.onboard
ques
c_cond
id|D_PIO0
suffix:colon
id|D_PIO2
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg2
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|34
)paren
suffix:semicolon
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Control mode:&n;&t; * Pipe 17: Send timeslots 1-4 (slots 5-8 are readonly)&n;&t; * Pipe 18: Receive timeslot 1 (clb).&n;&t; * Pipe 19: Receive timeslot 7 (version). &n;&t; */
multiline_comment|/* Set CHI Anchor: Pipe 16. This should take care of the rest. */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_16
)paren
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
multiline_comment|/* Setup the pipes first */
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_P
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_CHANGE
op_or
id|D_SDP_P
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_18
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_CHANGE
op_or
id|D_SDP_P
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_19
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fill in the data to send */
id|dbri-&gt;mm.ctrl
(braket
l_int|0
)braket
op_and_assign
op_complement
id|CS4215_CLB
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SSP
comma
l_int|0
comma
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|reverse_bytes
c_func
(paren
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
comma
l_int|4
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Link the timeslots */
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|32
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|256
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_18
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|16
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|0
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_18
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_19
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|48
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * According to the manual we should also specify &n;&t; * D_TS_NONCONTIG | D_TS_MON(D_P_18), but the machine freezes&n;&t; * if we do that. Can somebody explain me why?&n;&t; */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setup DBRI for CHI Master */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CDM
comma
l_int|0
comma
id|D_CDM_XCE
op_or
id|D_CDM_REN
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CHI
comma
l_int|0
comma
id|D_CHI_CHICM
c_func
(paren
l_int|6
)paren
op_or
id|D_CHI_FD
op_or
id|D_CHI_IR
op_or
id|D_CHI_EN
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CDM
comma
l_int|0
comma
id|D_CDM_XCE
op_or
id|D_CDM_XEN
op_or
id|D_CDM_REN
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_WAIT
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg8
op_assign
(paren
r_int
)paren
id|dbri-&gt;cmd
suffix:semicolon
multiline_comment|/* Wait for the data from the CS4215 */
id|interruptible_sleep_on
c_func
(paren
op_amp
id|dbri-&gt;int_wait
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Woke up (1) reg2: %x&bslash;n&quot;
comma
id|dbri-&gt;regs-&gt;reg2
)paren
suffix:semicolon
multiline_comment|/* Now switch back to data mode */
id|n
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CHI Anchor: Stop Send/Receive */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_16
)paren
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_WAIT
comma
l_int|0
comma
l_int|0x17
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg8
op_assign
(paren
r_int
)paren
id|dbri-&gt;cmd
suffix:semicolon
macro_line|#if 0      
id|dbri-&gt;mm.ctrl
(braket
l_int|0
)braket
op_or_assign
id|CS4215_CLB
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SSP
comma
l_int|1
comma
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|reverse_bytes
c_func
(paren
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Setup DBRI for CHI Slave */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CDM
comma
l_int|1
comma
id|D_CDM_XCE
op_or
id|D_CDM_REN
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CHI
comma
l_int|1
comma
id|D_CHI_CHICM
c_func
(paren
l_int|1
)paren
op_or
id|D_CHI_FD
op_or
id|D_CHI_IR
op_or
id|D_CHI_EN
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|1
comma
l_int|0x16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CDM
comma
l_int|0
comma
id|D_CDM_XCE
op_or
id|D_CDM_XEN
op_or
id|D_CDM_REN
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_WAIT
comma
l_int|1
comma
l_int|0x17
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg8
op_assign
(paren
r_int
)paren
id|dbri-&gt;cmd
suffix:semicolon
id|dbri-&gt;regs-&gt;reg2
op_assign
id|D_ENPIO
op_or
id|D_PIO3
op_or
(paren
id|dbri-&gt;mm.onboard
ques
c_cond
id|D_PIO0
suffix:colon
id|D_PIO2
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* We are ready */
id|dbri_cmdlocked
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dbri-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|mmcodec_init
r_static
r_int
id|mmcodec_init
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|reg2
op_assign
id|dbri-&gt;regs-&gt;reg2
suffix:semicolon
multiline_comment|/* Look for the cs4215 chips */
r_if
c_cond
(paren
id|reg2
op_amp
id|D_PIO2
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Onboard CS4215 detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg2
op_amp
id|D_PIO0
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Speakerbox detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Using the Speakerbox, if both are attached.  */
r_if
c_cond
(paren
(paren
id|reg2
op_amp
id|D_PIO2
)paren
op_logical_and
(paren
id|reg2
op_amp
id|D_PIO0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Using speakerbox / ignoring onboard mmcodec.&bslash;n&quot;
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg2
op_assign
id|D_ENPIO2
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg2
op_amp
(paren
id|D_PIO0
op_or
id|D_PIO2
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: no mmcodec found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Now talk to our baby */
id|dbri-&gt;regs-&gt;reg0
op_or_assign
id|D_C
suffix:semicolon
multiline_comment|/* Enable CHI */
id|mmcodec_default
c_func
(paren
op_amp
id|dbri-&gt;mm
)paren
suffix:semicolon
id|dbri-&gt;mm.version
op_assign
l_int|0xff
suffix:semicolon
id|mmcodec_setctrl
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;mm.version
op_eq
l_int|0xff
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t;mmcodec_init_data(dbri, &amp;n);&n;&t;*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_intr
r_void
id|dbri_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sparcaudio_driver
op_star
id|drv
op_assign
(paren
r_struct
id|sparcaudio_driver
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|x
comma
id|val
suffix:semicolon
r_static
r_int
id|numint
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Read it, so the interrupt goes away.&n;&t; */
id|x
op_assign
id|dbri-&gt;regs-&gt;reg1
suffix:semicolon
r_if
c_cond
(paren
id|numint
op_increment
OG
l_int|20
)paren
(brace
id|dbri-&gt;regs-&gt;reg0
op_assign
id|D_R
suffix:semicolon
multiline_comment|/* Soft Reset */
id|numint
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Soft reset&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
(paren
id|D_MRR
op_or
id|D_MLE
op_or
id|D_LBG
op_or
id|D_MBE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * What should I do here ?&n;&t;&t; */
r_if
c_cond
(paren
id|x
op_amp
id|D_MRR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Multiple Error Ack on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_MLE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Multiple Late Error on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_LBG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Lost Bus Grant on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_MBE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Burst Error on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|x
op_amp
id|D_IR
)paren
)paren
multiline_comment|/* Not for us */
r_return
suffix:semicolon
id|x
op_assign
id|dbri-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
suffix:semicolon
r_while
c_loop
(paren
id|x
op_ne
l_int|0
)paren
(brace
id|dbri-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_CMD
)paren
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: INTR: Command: %-5s  Value:%d&bslash;n&quot;
comma
id|cmds
(braket
id|D_INTR_GETCMD
c_func
(paren
id|x
)paren
)braket
comma
id|D_INTR_GETVAL
c_func
(paren
id|x
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: INTR: Chan:%d Code:%d Val:%#x&bslash;n&quot;
comma
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
comma
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
comma
id|D_INTR_GETRVAL
c_func
(paren
id|x
)paren
)paren
)paren
suffix:semicolon
)brace
id|val
op_assign
id|D_INTR_GETVAL
c_func
(paren
id|x
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
)paren
(brace
r_case
id|D_INTR_CMD
suffix:colon
r_if
c_cond
(paren
id|D_INTR_GETCMD
c_func
(paren
id|x
)paren
op_eq
id|D_WAIT
)paren
r_if
c_cond
(paren
id|val
op_eq
id|WAIT_INTR1
)paren
(brace
id|dbri_cmdlocked
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dbri-&gt;wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_eq
id|WAIT_INTR2
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|dbri-&gt;int_wait
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|D_P_18
suffix:colon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
id|x
op_assign
id|reverse_bytes
c_func
(paren
id|val
comma
l_int|2
)paren
op_amp
id|CS4215_12_MASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Comparing int: %x with hi(%x)&bslash;n&quot;
comma
id|x
comma
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
(paren
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
op_rshift
l_int|16
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Comp ok&bslash;n&quot;
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dbri-&gt;int_wait
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|D_P_19
suffix:colon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
id|dbri-&gt;mm.version
op_assign
id|reverse_bytes
c_func
(paren
id|val
comma
l_int|1
)paren
op_amp
l_int|0xf
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|dbri-&gt;dbri_irqp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;dbri_irqp
op_eq
(paren
id|DBRI_NO_INTS
op_star
id|DBRI_INT_BLK
)paren
)paren
id|dbri-&gt;dbri_irqp
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|dbri-&gt;dbri_irqp
op_amp
(paren
id|DBRI_INT_BLK
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
id|dbri-&gt;dbri_irqp
op_increment
suffix:semicolon
id|x
op_assign
id|dbri-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
suffix:semicolon
)brace
)brace
DECL|function|dbri_attach
r_static
r_int
id|dbri_attach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_struct
id|linux_sbus_device
op_star
id|sdev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_struct
id|linux_prom_irqs
id|irq
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
OL
l_char|&squot;e&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: unsupported chip version %c found.&bslash;n&quot;
comma
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|drv-&gt;ops
op_assign
op_amp
id|dbri_ops
suffix:semicolon
id|drv
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dbri
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drv
op_member_access_from_pointer
r_private
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|memset
c_func
(paren
id|dbri
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dbri
)paren
)paren
suffix:semicolon
id|dbri-&gt;dbri_version
op_assign
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
suffix:semicolon
multiline_comment|/* Map the registers into memory. */
id|prom_apply_sbus_ranges
c_func
(paren
id|sdev-&gt;my_bus
comma
op_amp
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
comma
id|sdev-&gt;num_registers
comma
id|sdev
)paren
suffix:semicolon
id|dbri-&gt;regs_size
op_assign
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
suffix:semicolon
id|dbri-&gt;regs
op_assign
id|sparc_alloc_io
c_func
(paren
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
comma
id|drv_name
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: could not allocate registers&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|prom_getproperty
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;intr&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irq
comma
r_sizeof
(paren
id|irq
)paren
)paren
suffix:semicolon
id|dbri-&gt;irq
op_assign
id|irq.pri
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|dbri-&gt;irq
comma
id|dbri_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;DBRI/audio&quot;
comma
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dbri-&gt;irq
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|dbri-&gt;regs
comma
id|dbri-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Register ourselves with the midlevel audio driver. */
id|err
op_assign
id|register_sparcaudio_driver
c_func
(paren
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: unable to register audio&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dbri-&gt;irq
comma
id|drv
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|dbri-&gt;regs
comma
id|dbri-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dbri_init
c_func
(paren
id|drv
)paren
suffix:semicolon
id|err
op_assign
id|mmcodec_init
c_func
(paren
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dbri_detach
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dbri-&gt;perchip_info.play.active
op_assign
id|dbri-&gt;perchip_info.play.pause
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;perchip_info.record.active
op_assign
id|dbri-&gt;perchip_info.record.pause
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;audio%d at 0x%lx (irq %d) is DBRI(%c)+CS4215(%d)&bslash;n&quot;
comma
id|num_drivers
comma
(paren
r_int
r_int
)paren
id|dbri-&gt;regs
comma
id|dbri-&gt;irq
comma
id|dbri-&gt;dbri_version
comma
id|dbri-&gt;mm.version
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Probe for the dbri chip and then attach the driver. */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_int
id|dbri_init
c_func
(paren
r_void
)paren
)paren
macro_line|#endif
(brace
r_struct
id|linux_sbus
op_star
id|bus
suffix:semicolon
r_struct
id|linux_sbus_device
op_star
id|sdev
suffix:semicolon
id|num_drivers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Probe each SBUS for the DBRI chip(s). */
id|for_all_sbusdev
c_func
(paren
id|sdev
comma
id|bus
)paren
(brace
multiline_comment|/*&n;&t;&t; * The version is coded in the last character&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;SUNW,DBRI&quot;
comma
l_int|9
)paren
)paren
(brace
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: Found %s in SBUS slot %d&bslash;n&quot;
comma
id|sdev-&gt;prom_name
comma
id|sdev-&gt;slot
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_drivers
op_ge
id|MAX_DRIVERS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Ignoring slot %d&bslash;n&quot;
comma
id|sdev-&gt;slot
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri_attach
c_func
(paren
op_amp
id|drivers
(braket
id|num_drivers
)braket
comma
id|sdev
)paren
op_eq
l_int|0
)paren
id|num_drivers
op_increment
suffix:semicolon
)brace
)brace
r_return
(paren
id|num_drivers
OG
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_drivers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dbri_detach
c_func
(paren
op_amp
id|drivers
(braket
id|i
)braket
)paren
suffix:semicolon
id|num_drivers
op_decrement
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
