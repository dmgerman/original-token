multiline_comment|/*&n; * drivers/sbus/audio/dbri.c&n; *&n; * Copyright (C) 1997 Rudolf Koenig (rfkoenig@immd4.informatik.uni-erlangen.de)&n; * The SparcLinux interface was adopted from the CS4231 driver.&n; *&n; * This is the lowlevel driver for the DBRI &amp; MMCODEC duo used for ISDN &amp; AUDIO&n; * on Sun SPARCstation 10, 20, LX and Voyager models.&n; * NOTE: This driver only supports audio for now, there is NO SUPPORT for ISDN.&n; *&n; * - DBRI: AT&amp;T T5900FX Dual Basic Rates ISDN Interface. It is a 32 channel&n; *   data time multiplexer with ISDN support (aka T7259)&n; *   Interfaces: SBus,ISDN NT &amp; TE, CHI, 4 bits parallel.&n; *   CHI: (spelled ki) Concentration Highway Interface (AT&amp;T or Intel bus ?).&n; *   Documentation:&n; *   - &quot;STP 4000SBus Dual Basic Rate ISDN (DBRI) Tranceiver&quot; from&n; *     Sparc Technology Business (courtesy of Sun Support)&n; *   - Data sheet of the T7903, a newer but very similar ISA bus equivalent&n; *     available from the Lucent (formarly AT&amp;T microelectronics) home&n; *     page.&n; * - MMCODEC: Crystal Semiconductor CS4215 16 bit Multimedia Audio Codec&n; *   Interfaces: CHI, Audio In &amp; Out, 2 bits parallel&n; *   Documentation: from the Crystal Semiconductor home page.&n; *&n; * The DBRI is a 32 pipe machine, each pipe can transfer some bits between&n; * memory and a serial device (long pipes, nr 0-15) or between two serial&n; * devices (short pipes, nr 16-31), or simply send a fixed data to a serial&n; * device (short pipes).&n; * A timeslot defines the bit-offset and nr of bits read from a serial device.&n; * The timeslots are linked to 6 circular lists, one for each direction for&n; * each serial device (NT,TE,CHI). A timeslot is associated to 1 or 2 pipes&n; * (the second one is a monitor/tee pipe, valid only for serial input).&n; *&n; * The mmcodec is connected via the CHI bus and needs the data &amp; some&n; * parameters (volume, balance, output selection) timemultiplexed in 8 byte&n; * chunks. It also has a control mode, which serves for audio format setting.&n; *&n; * Looking at the CS4215 data sheet it is easy to set up 2 or 4 codecs on&n; * the same CHI bus, so I thought perhaps it is possible to use the onboard&n; * &amp; the speakerbox codec simultanously, giving 2 (not very independent :-)&n; * audio devices. But the SUN HW group decided against it, at least on my&n; * LX the speakerbox connector has at least 1 pin missing and 1 wrongly&n; * connected.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/openprom.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#include &lt;asm/audioio.h&gt;
macro_line|#include &quot;dbri.h&quot;
macro_line|#if defined(DBRI_ISDN) || defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x200ff
macro_line|#include &quot;../../isdn/hisax/hisax.h&quot;
macro_line|#include &quot;../../isdn/hisax/isdnl1.h&quot;
macro_line|#include &quot;../../isdn/hisax/foreign.h&quot;
macro_line|#endif
multiline_comment|/* #define DBRI_DEBUG */
macro_line|#ifdef DBRI_DEBUG
DECL|macro|dprintk
mdefine_line|#define dprintk(a, x) if(dbri_debug &amp; a) printk x
DECL|macro|D_GEN
mdefine_line|#define D_GEN&t;(1&lt;&lt;0)
DECL|macro|D_INT
mdefine_line|#define D_INT&t;(1&lt;&lt;1)
DECL|macro|D_CMD
mdefine_line|#define D_CMD&t;(1&lt;&lt;2)
DECL|macro|D_MM
mdefine_line|#define D_MM&t;(1&lt;&lt;3)
DECL|macro|D_USR
mdefine_line|#define D_USR&t;(1&lt;&lt;4)
DECL|variable|dbri_debug
r_static
r_int
id|dbri_debug
op_assign
id|D_GEN
op_or
id|D_INT
op_or
id|D_CMD
op_or
id|D_MM
op_or
id|D_USR
suffix:semicolon
DECL|variable|cmds
r_static
r_char
op_star
id|cmds
(braket
)braket
op_assign
(brace
l_string|&quot;WAIT&quot;
comma
l_string|&quot;PAUSE&quot;
comma
l_string|&quot;JUMP&quot;
comma
l_string|&quot;IIQ&quot;
comma
l_string|&quot;REX&quot;
comma
l_string|&quot;SDP&quot;
comma
l_string|&quot;CDP&quot;
comma
l_string|&quot;DTS&quot;
comma
l_string|&quot;SSP&quot;
comma
l_string|&quot;CHI&quot;
comma
l_string|&quot;NT&quot;
comma
l_string|&quot;TE&quot;
comma
l_string|&quot;CDEC&quot;
comma
l_string|&quot;TEST&quot;
comma
l_string|&quot;CDM&quot;
comma
l_string|&quot;RESRV&quot;
)brace
suffix:semicolon
multiline_comment|/* Bit hunting */
DECL|macro|dumpcmd
mdefine_line|#define dumpcmd {int i; for(i=0; i&lt;n; i++) printk(&quot;DBRI: %x&bslash;n&quot;, dbri-&gt;cmd[i]); }
DECL|macro|DBRI_CMD
mdefine_line|#define DBRI_CMD(cmd, intr, value) ((cmd &lt;&lt; 28) | (1 &lt;&lt; 27) | value)
macro_line|#else
DECL|macro|dprintk
mdefine_line|#define dprintk(a, x)
DECL|macro|dumpcmd
mdefine_line|#define dumpcmd
DECL|macro|DBRI_CMD
mdefine_line|#define DBRI_CMD(cmd, intr, value) ((cmd &lt;&lt; 28) | (intr &lt;&lt; 27) | value)
macro_line|#endif&t;/* DBRI_DEBUG */
DECL|macro|MAX_DRIVERS
mdefine_line|#define MAX_DRIVERS&t;2&t;/* Increase this if need more than 2 DBRI&squot;s */
DECL|macro|WAIT_INTR1
mdefine_line|#define WAIT_INTR1&t;0xbe
DECL|macro|WAIT_INTR2
mdefine_line|#define WAIT_INTR2&t;0xbf
DECL|variable|drivers
r_static
r_struct
id|sparcaudio_driver
id|drivers
(braket
id|MAX_DRIVERS
)braket
suffix:semicolon
DECL|variable|drv_name
r_static
r_char
id|drv_name
(braket
)braket
op_assign
l_string|&quot;DBRI/audio&quot;
suffix:semicolon
DECL|variable|num_drivers
r_static
r_int
id|num_drivers
suffix:semicolon
DECL|variable|output_callback_arg
r_static
r_void
op_star
id|output_callback_arg
suffix:semicolon
multiline_comment|/*&n; * Commands are sent to the DBRI by building a list of them in memory,&n; * then writing the address of the first list item to DBRI register 8.&n; * The list is terminated with a WAIT command, which can generate a&n; * CPU interrupt if required.&n; *&n; * Since the DBRI can run asynchronously to the CPU, several means of&n; * synchronization present themselves.  The original scheme (Rudolf&squot;s)&n; * was to set a flag when we &quot;cmdlock&quot;ed the DBRI, clear the flag when&n; * an interrupt signaled completion, and wait on a wait_queue if a routine&n; * attempted to cmdlock while the flag was set.  The problems arose when&n; * we tried to cmdlock from inside an interrupt handler, which might&n; * cause scheduling in an interrupt (if we waited), etc, etc&n; *&n; * A more sophisticated scheme might involve a circular command buffer&n; * or an array of command buffers.  A routine could fill one with&n; * commands and link it onto a list.  When a interrupt signaled&n; * completion of the current command buffer, look on the list for&n; * the next one.&n; *&n; * I&squot;ve decided to implement something much simpler - after each command,&n; * the CPU waits for the DBRI to finish the command by polling the P bit&n; * in DBRI register 0.  I&squot;ve tried to implement this in such a way&n; * that might make implementing a more sophisticated scheme easier.&n; *&n; * Every time a routine wants to write commands to the DBRI, it&n; * must first call dbri_cmdlock() and get an initial index into dbri-&gt;cmd&n; * (currently always 0) in return.  After the commands have been&n; * write (index incremented after each one), dbri_cmdsend() is called&n; * with the final index value.&n; */
DECL|function|dbri_cmdlock
r_static
r_int
id|dbri_cmdlock
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_cmdsend
r_static
r_void
id|dbri_cmdsend
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
comma
r_int
id|n
)paren
(brace
r_int
id|maxloops
op_assign
l_int|1000000
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_WAIT
comma
l_int|0
comma
id|WAIT_INTR1
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg8
op_assign
(paren
r_int
)paren
id|dbri-&gt;cmd
suffix:semicolon
r_while
c_loop
(paren
id|maxloops
OG
l_int|0
op_logical_and
(paren
id|dbri-&gt;regs-&gt;reg0
op_amp
id|D_P
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maxloops
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Maxloops exceeded in dbri_cmdsend&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|dbri_reset
r_static
r_void
id|dbri_reset
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: reset 0:%x 2:%x 8:%x 9:%x&bslash;n&quot;
comma
id|dbri-&gt;regs-&gt;reg0
comma
id|dbri-&gt;regs-&gt;reg2
comma
id|dbri-&gt;regs-&gt;reg8
comma
id|dbri-&gt;regs-&gt;reg9
)paren
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg0
op_assign
id|D_R
suffix:semicolon
multiline_comment|/* Soft Reset */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|dbri-&gt;regs-&gt;reg0
op_amp
id|D_R
)paren
op_logical_and
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
)brace
DECL|function|dbri_detach
r_static
r_void
id|dbri_detach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|info
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|dbri_reset
c_func
(paren
id|drv
)paren
suffix:semicolon
id|unregister_sparcaudio_driver
c_func
(paren
id|drv
comma
l_int|1
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|info-&gt;irq
comma
id|drv
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|info-&gt;regs
comma
id|info-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
)brace
DECL|function|dbri_initialize
r_static
r_void
id|dbri_initialize
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|n
suffix:semicolon
id|dbri_reset
c_func
(paren
id|drv
)paren
suffix:semicolon
id|dbri-&gt;wait
op_assign
l_int|NULL
suffix:semicolon
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: init: cmd: %x, int: %x&bslash;n&quot;
comma
(paren
r_int
)paren
id|dbri-&gt;cmd
comma
(paren
r_int
)paren
id|dbri-&gt;intr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the interrupt ringbuffer.&n;&t; */
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|DBRI_NO_INTS
op_minus
l_int|1
suffix:semicolon
id|n
op_increment
)paren
(brace
id|dbri-&gt;intr
(braket
id|n
op_star
id|DBRI_INT_BLK
)braket
op_assign
(paren
r_int
)paren
(paren
op_amp
id|dbri-&gt;intr
(braket
(paren
id|n
op_plus
l_int|1
)paren
op_star
id|DBRI_INT_BLK
)braket
)paren
suffix:semicolon
)brace
id|dbri-&gt;intr
(braket
id|n
op_star
id|DBRI_INT_BLK
)braket
op_assign
(paren
r_int
)paren
(paren
id|dbri-&gt;intr
)paren
suffix:semicolon
id|dbri-&gt;dbri_irqp
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef USE_SBUS_BURSTS
multiline_comment|/* Enable 4-word, 8-word, and 16-word SBus Bursts */
id|dbri-&gt;regs-&gt;reg0
op_or_assign
(paren
id|D_G
op_or
id|D_S
op_or
id|D_E
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Disable 4-word, 8-word, and 16-word SBus Bursts */
id|dbri-&gt;regs-&gt;reg0
op_and_assign
op_complement
(paren
id|D_G
op_or
id|D_S
op_or
id|D_E
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Set up the interrupt queue&n;&t; */
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_IIQ
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
(paren
r_int
)paren
(paren
id|dbri-&gt;intr
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Short data pipes transmit LSB first. The CS4215 receives MSB first. Grrr.&n; * So we have to reverse the bits. Note: only 1, 2 or 4 bytes are supported.&n; */
DECL|function|reverse_bytes
r_static
id|__u32
id|reverse_bytes
c_func
(paren
id|__u32
id|b
comma
r_int
id|len
)paren
(brace
r_switch
c_cond
(paren
id|len
)paren
(brace
r_case
l_int|4
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xffff0000
)paren
op_rshift
l_int|16
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x0000ffff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xff00ff00
)paren
op_rshift
l_int|8
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x00ff00ff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xf0f0f0f0
)paren
op_rshift
l_int|4
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x0f0f0f0f
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xcccccccc
)paren
op_rshift
l_int|2
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x33333333
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|b
op_assign
(paren
(paren
id|b
op_amp
l_int|0xaaaaaaaa
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0x55555555
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|b
suffix:semicolon
)brace
DECL|function|mmcodec_default
r_static
r_void
id|mmcodec_default
c_func
(paren
r_struct
id|cs4215
op_star
id|mm
)paren
(brace
multiline_comment|/*&n;&t; * No action, memory resetting only.&n;&t; *&n;&t; * Data Time Slot 5-8&n;&t; * Speaker,Line and Headphone enable. Gain set to the half.&n;&t; * Input is mike.&n;&t; */
id|mm-&gt;data
(braket
l_int|0
)braket
op_assign
id|CS4215_LO
c_func
(paren
l_int|0x20
)paren
op_or
id|CS4215_HE
op_or
id|CS4215_LE
suffix:semicolon
id|mm-&gt;data
(braket
l_int|1
)braket
op_assign
id|CS4215_RO
c_func
(paren
l_int|0x20
)paren
op_or
id|CS4215_SE
suffix:semicolon
id|mm-&gt;data
(braket
l_int|2
)braket
op_assign
id|CS4215_LG
c_func
(paren
l_int|0x8
)paren
op_or
id|CS4215_IS
op_or
id|CS4215_PIO0
op_or
id|CS4215_PIO1
suffix:semicolon
id|mm-&gt;data
(braket
l_int|3
)braket
op_assign
id|CS4215_RG
c_func
(paren
l_int|0x8
)paren
op_or
id|CS4215_MA
c_func
(paren
l_int|0xf
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Control Time Slot 1-4&n;&t; * 0: Default I/O voltage scale&n;&t; * 1: 8 bit ulaw, 8kHz, mono, high pass filter disabled&n;&t; * 2: Serial enable, CHI master, 1 CHI device (64bit), clock 1&n;&t; * 3: Tests disabled&n;&t; */
id|mm-&gt;ctrl
(braket
l_int|0
)braket
op_assign
id|CS4215_RSRVD_1
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|1
)braket
op_assign
id|CS4215_DFR_ULAW
op_or
id|CS4215_FREQ
(braket
l_int|0
)braket
dot
id|csval
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|2
)braket
op_assign
id|CS4215_XCLK
op_or
id|CS4215_BSEL_128
op_or
id|CS4215_FREQ
(braket
l_int|0
)braket
dot
id|xtal
suffix:semicolon
id|mm-&gt;ctrl
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|mmcodec_init_data
r_static
r_void
id|mmcodec_init_data
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|val
comma
id|n
suffix:semicolon
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Data mode:&n;&t; * Pipe  4: Send timeslots 1-4 (audio data)&n;&t; * Pipe 17: Send timeslots 5-8 (part of ctrl data)&n;&t; * Pipe  6: Receive timeslots 1-4 (audio data)&n;&t; * Pipe 20: Receive timeslots 6-7. We can only receive 20 bits via&n;&t; *          interrupt, and the rest of the data (slot 5 and 8) is&n;&t; *&t;    not relevant for us (only for doublechecking).&n;         *&n;         * Just like in control mode, the time slots are all offset by eight&n;         * bits.  The CS4215, it seems, observes TSIN (the delayed signal)&n;         * even if it&squot;s the CHI master.  Don&squot;t ask me...&n;&t; */
multiline_comment|/* Pipe 4: SDP */
id|val
op_assign
id|D_SDP_MEM
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_MSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_4
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 17: SDP */
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fixed data */
multiline_comment|/* Pipe 17: SSP */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SSP
comma
l_int|0
comma
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|reverse_bytes
c_func
(paren
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.data
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Pipe 6: SDP */
id|val
op_assign
id|D_SDP_MEM
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_MSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_6
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 20: SDP */
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_CHANGE
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_20
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fixed data */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Pipe 4: DTS */
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_4
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Full blown, four time slots, 16 bit stereo */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|32
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Single time slot, 8 bit mono */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Pipe 17: DTS */
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_4
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|32
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|40
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
multiline_comment|/* Pipe 6: DTS */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_6
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Full blown, four time slots, 16 bit stereo */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|32
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Single time slot, 8 bit mono */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
macro_line|#endif
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 20: DTS */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_6
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_20
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|16
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|48
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CHI: Slave mode; enable interrupts */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CHI
comma
l_int|0
comma
id|D_CHI_CHICM
c_func
(paren
l_int|0
)paren
op_or
id|D_CHI_IR
op_or
id|D_CHI_EN
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Send the control information (i.e. audio format)&n; */
DECL|function|mmcodec_setctrl
r_static
r_void
id|mmcodec_setctrl
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|n
comma
id|val
suffix:semicolon
multiline_comment|/*&n;&t; * Enable Control mode: Set DBRI&squot;s PIO3 (4215&squot;s D/~C) to 0, then wait&n;&t; * 12 cycles &lt;= 12/(5512.5*64) sec = 34.01 usec&n;&t; */
id|val
op_assign
id|D_ENPIO
op_or
id|D_PIO1
op_or
(paren
id|dbri-&gt;mm.onboard
ques
c_cond
id|D_PIO0
suffix:colon
id|D_PIO2
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg2
op_assign
id|val
suffix:semicolon
id|udelay
c_func
(paren
l_int|34
)paren
suffix:semicolon
multiline_comment|/* In Control mode, the CS4215 is a slave device, so the DBRI must&n;         * operate as CHI master, supplying clocking and frame synchronization.&n;         *&n;         * In Data mode, however, the CS4215 must be CHI master to insure&n;         * that its data stream is synchronous with its codec.&n;         *&n;         * The upshot of all this?  We start by putting the DBRI into master&n;         * mode, program the CS4215 in Control mode, then switch the CS4215&n;         * into Data mode and put the DBRI into slave mode.  Various timing&n;         * requirements must be observed along the way.&n;         *&n;         * Oh, and one more thing - when the DBRI is master (and only when&n;         * the DBRI is master), the addressing of the CS4215&squot;s time slots&n;         * is offset by eight bits, so we add eight to all the &quot;cycle&quot;&n;         * values in the Define Time Slot (DTS) commands.  This is done in&n;         * hardware by a TI 248 that delays the DBRI-&gt;4215 frame sync signal&n;         * by eight clock cycles.  Anybody know why?&n;         */
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Control mode:&n;&t; * Pipe 17: Send timeslots 1-4 (slots 5-8 are readonly)&n;&t; * Pipe 18: Receive timeslot 1 (clb).&n;&t; * Pipe 19: Receive timeslot 7 (version). &n;&t; */
multiline_comment|/* Set CHI Anchor: Pipe 16. This should take care of the rest. */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_16
)paren
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
multiline_comment|/* Setup the pipes first */
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_P
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_CHANGE
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_18
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|val
op_assign
id|D_SDP_FIXED
op_or
id|D_SDP_CHANGE
op_or
id|D_SDP_C
op_or
id|D_PIPE
c_func
(paren
id|D_P_19
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fill in the data to send */
id|dbri-&gt;mm.ctrl
(braket
l_int|0
)braket
op_and_assign
op_complement
id|CS4215_CLB
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SSP
comma
l_int|0
comma
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|reverse_bytes
c_func
(paren
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
comma
l_int|4
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Link the timeslots */
multiline_comment|/* Pipe 17 - CS4215 Status, Data Format, Serial Control, Test - output&n;         *           time slots 1, 2, 3 and 4 - 32 bits&n;         */
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|32
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
multiline_comment|/* Pipe 18 - CS4215 Status and Data Format - input&n;         *           time slots 1 &amp; 2 - 16 bits&n;         */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_18
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|16
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 19 - CS4215 Revision - time slot 7, eight bits - input&n;         */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_18
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_19
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|56
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setup DBRI for CHI Master&n;         *&n;         * BPF   =  128 (128 bits per 8 kHz frame = 1.024 MHz clock rate)&n;         * CHICM =  12 (12.288 MHz / 24 = 1.024 MHz clock rate)&n;         * FD    =  1 - drive CHIFS on rising edge of CHICK&n;         *&n;         * RCE   =  0 - receive on falling edge of CHICK&n;         * XCE   =  1 - transmit on rising edge of CHICK&n;         */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CHI
comma
l_int|0
comma
id|D_CHI_CHICM
c_func
(paren
l_int|12
)paren
op_or
id|D_CHI_FD
op_or
id|D_CHI_IR
op_or
id|D_CHI_EN
op_or
id|D_CHI_BPF
c_func
(paren
l_int|128
)paren
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CDM
comma
l_int|0
comma
id|D_CDM_XCE
op_or
id|D_CDM_XEN
op_or
id|D_CDM_REN
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Wait for the command to complete */
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
multiline_comment|/* Switch CS4215 to data mode - data sheet says&n;         * &quot;Set CLB=1 and send two more frames of valid control info&quot;&n;         */
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|dbri-&gt;mm.ctrl
(braket
l_int|0
)braket
op_or_assign
id|CS4215_CLB
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SSP
comma
l_int|0
comma
id|D_PIPE
c_func
(paren
id|D_P_17
)paren
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|reverse_bytes
c_func
(paren
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
comma
l_int|4
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
multiline_comment|/* Two frames of control info @ 8kHz frame rate = 250 us delay */
id|udelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* Now switch back to data mode */
multiline_comment|/* Reset CHI Anchor: Stop Send/Receive */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_16
)paren
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_16
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_ANCHOR
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_16
)paren
suffix:semicolon
multiline_comment|/* Setup DBRI for CHI Slave */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_CHI
comma
l_int|0
comma
id|D_CHI_CHICM
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* dbri-&gt;cmd[n++] = DBRI_CMD(D_CHI, 0, D_CHI_CHICM(0) | D_CHI_IR | D_CHI_EN); */
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0x16
)paren
suffix:semicolon
multiline_comment|/* Wait for command to complete */
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
multiline_comment|/* Switch CS4215 to data mode - set PIO3 to 1 */
id|dbri-&gt;regs-&gt;reg2
op_assign
id|D_ENPIO
op_or
id|D_PIO1
op_or
id|D_PIO3
op_or
(paren
id|dbri-&gt;mm.onboard
ques
c_cond
id|D_PIO0
suffix:colon
id|D_PIO2
)paren
suffix:semicolon
)brace
DECL|function|mmcodec_init
r_static
r_int
id|mmcodec_init
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|reg2
op_assign
id|dbri-&gt;regs-&gt;reg2
suffix:semicolon
multiline_comment|/* Look for the cs4215 chips */
r_if
c_cond
(paren
id|reg2
op_amp
id|D_PIO2
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Onboard CS4215 detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg2
op_amp
id|D_PIO0
)paren
(brace
id|dprintk
c_func
(paren
id|D_MM
comma
(paren
l_string|&quot;DBRI: Speakerbox detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Using the Speakerbox, if both are attached.  */
r_if
c_cond
(paren
(paren
id|reg2
op_amp
id|D_PIO2
)paren
op_logical_and
(paren
id|reg2
op_amp
id|D_PIO0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Using speakerbox / ignoring onboard mmcodec.&bslash;n&quot;
)paren
suffix:semicolon
id|dbri-&gt;regs-&gt;reg2
op_assign
id|D_ENPIO2
suffix:semicolon
id|dbri-&gt;mm.onboard
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg2
op_amp
(paren
id|D_PIO0
op_or
id|D_PIO2
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: no mmcodec found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Now talk to our baby */
id|dbri-&gt;regs-&gt;reg0
op_or_assign
id|D_C
suffix:semicolon
multiline_comment|/* Enable CHI */
id|mmcodec_default
c_func
(paren
op_amp
id|dbri-&gt;mm
)paren
suffix:semicolon
id|dbri-&gt;mm.version
op_assign
l_int|0xff
suffix:semicolon
id|mmcodec_setctrl
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;mm.version
op_eq
l_int|0xff
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|mmcodec_init_data
c_func
(paren
id|dbri
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_isdn_init
r_void
id|dbri_isdn_init
c_func
(paren
r_struct
id|dbri
op_star
id|dbri
)paren
(brace
r_int
id|n
comma
id|val
suffix:semicolon
multiline_comment|/* Pipe  0: Receive D channel&n;         * Pipe  8: Receive B1 channel&n;         * Pipe  9: Receive B2 channel&n;         * Pipe  1: Transmit D channel&n;         * Pipe 10: Transmit B1 channel&n;         * Pipe 11: Transmit B2 channel&n;         */
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* Pipe 0: SDP */
id|val
op_assign
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_0
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 8: SDP */
id|val
op_assign
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_8
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 9: SDP */
id|val
op_assign
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_9
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 1: SDP */
id|val
op_assign
id|D_SDP_HDLC_D
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_1
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 10: SDP */
id|val
op_assign
id|D_SDP_HDLC
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_10
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 11: SDP */
id|val
op_assign
id|D_SDP_HDLC
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_11
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_PAUSE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Pipe 0: DTS */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_0
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_0
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|2
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|17
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_0
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 8: DTS */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_0
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_8
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|0
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_0
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 9: DTS */
id|val
op_assign
id|D_DTS_VI
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVIN
c_func
(paren
id|D_P_8
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_9
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_0
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 1: DTS */
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_1
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_1
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|2
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|17
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_1
)paren
suffix:semicolon
multiline_comment|/* Pipe 10: DTS */
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_1
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_10
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|0
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_1
)paren
suffix:semicolon
multiline_comment|/* Pipe 11: DTS */
id|val
op_assign
id|D_DTS_VO
op_or
id|D_DTS_INS
op_or
id|D_DTS_PRVOUT
c_func
(paren
id|D_P_10
)paren
op_or
id|D_PIPE
c_func
(paren
id|D_P_11
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_DTS
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|D_TS_LEN
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_CYCLE
c_func
(paren
l_int|8
)paren
op_or
id|D_TS_NEXT
c_func
(paren
id|D_P_1
)paren
suffix:semicolon
multiline_comment|/* Wait for command to complete */
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
)brace
DECL|function|dbri_intr
r_void
id|dbri_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sparcaudio_driver
op_star
id|drv
op_assign
(paren
r_struct
id|sparcaudio_driver
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|x
comma
id|val
suffix:semicolon
r_static
r_int
id|numint
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Read it, so the interrupt goes away.&n;&t; */
id|x
op_assign
id|dbri-&gt;regs-&gt;reg1
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|numint
op_increment
OG
l_int|20
)paren
(brace
id|dbri-&gt;regs-&gt;reg0
op_assign
id|D_R
suffix:semicolon
multiline_comment|/* Soft Reset */
id|numint
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Soft reset&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|x
op_amp
(paren
id|D_MRR
op_or
id|D_MLE
op_or
id|D_LBG
op_or
id|D_MBE
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * What should I do here ?&n;&t;&t; */
r_if
c_cond
(paren
id|x
op_amp
id|D_MRR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Multiple Error Ack on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_MLE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Multiple Late Error on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_LBG
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Lost Bus Grant on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_amp
id|D_MBE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Burst Error on SBus&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|x
op_amp
id|D_IR
)paren
)paren
multiline_comment|/* Not for us */
r_return
suffix:semicolon
id|x
op_assign
id|dbri-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
suffix:semicolon
r_while
c_loop
(paren
id|x
op_ne
l_int|0
)paren
(brace
id|dbri-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_CMD
)paren
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: INTR: Command: %-5s  Value:%d&bslash;n&quot;
comma
id|cmds
(braket
id|D_INTR_GETCMD
c_func
(paren
id|x
)paren
)braket
comma
id|D_INTR_GETVAL
c_func
(paren
id|x
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
id|D_INT
comma
(paren
l_string|&quot;DBRI: INTR: Chan:%d Code:%d Val:%#x&bslash;n&quot;
comma
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
comma
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
comma
id|D_INTR_GETRVAL
c_func
(paren
id|x
)paren
)paren
)paren
suffix:semicolon
)brace
id|val
op_assign
id|D_INTR_GETVAL
c_func
(paren
id|x
)paren
suffix:semicolon
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_SBRI
)paren
(brace
r_int
id|liu_states
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|0
comma
l_int|8
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
)brace
suffix:semicolon
id|dbri-&gt;liu_state
op_assign
id|liu_states
(braket
id|val
op_amp
l_int|0x7
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;liu_callback
)paren
id|dbri
op_member_access_from_pointer
id|liu_callback
c_func
(paren
id|dbri-&gt;liu_callback_arg
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|D_INTR_GETCHAN
c_func
(paren
id|x
)paren
)paren
(brace
r_case
id|D_INTR_CMD
suffix:colon
macro_line|#if 0
r_if
c_cond
(paren
id|D_INTR_GETCMD
c_func
(paren
id|x
)paren
op_eq
id|D_WAIT
)paren
r_if
c_cond
(paren
id|val
op_eq
id|WAIT_INTR1
)paren
(brace
id|dbri_cmdlocked
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dbri-&gt;wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_eq
id|WAIT_INTR2
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|dbri-&gt;int_wait
)paren
suffix:semicolon
)brace
macro_line|#endif
r_break
suffix:semicolon
r_case
id|D_P_0
suffix:colon
multiline_comment|/* Pipe 0 - D channel receive */
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_BRDY
op_logical_and
id|dbri-&gt;D.input_callback
)paren
(brace
id|dbri-&gt;D
dot
id|input_callback
c_func
(paren
id|dbri-&gt;D.input_callback_arg
comma
id|DBRI_RD_STATUS
c_func
(paren
id|dbri-&gt;D.rd.flags
)paren
comma
id|DBRI_RD_CNT
c_func
(paren
id|dbri-&gt;D.rd.flags
)paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|D_P_1
suffix:colon
multiline_comment|/* Pipe 1 - D channel transmit */
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_XCMP
op_logical_and
id|dbri-&gt;D.output_callback
)paren
(brace
id|dbri-&gt;D
dot
id|output_callback
c_func
(paren
id|dbri-&gt;D.output_callback_arg
comma
id|DBRI_TD_STATUS
c_func
(paren
id|dbri-&gt;D.rd.flags
)paren
op_amp
l_int|0xe
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|D_P_4
suffix:colon
multiline_comment|/* Pipe 4 - audio transmit */
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_XCMP
)paren
(brace
id|sparcaudio_output_done
c_func
(paren
id|output_callback_arg
comma
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|D_P_8
suffix:colon
multiline_comment|/* Pipe 8 - B1 channel receive */
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_BRDY
op_logical_and
id|dbri-&gt;B
(braket
l_int|0
)braket
dot
id|input_callback
)paren
(brace
id|dbri-&gt;B
(braket
l_int|0
)braket
dot
id|input_callback
c_func
(paren
id|dbri-&gt;B
(braket
l_int|0
)braket
dot
id|input_callback_arg
comma
id|DBRI_RD_STATUS
c_func
(paren
id|dbri-&gt;B
(braket
l_int|0
)braket
dot
id|rd.flags
)paren
comma
id|DBRI_RD_CNT
c_func
(paren
id|dbri-&gt;B
(braket
l_int|0
)braket
dot
id|rd.flags
)paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|D_P_9
suffix:colon
multiline_comment|/* Pipe 9 - B2 channel receive */
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_BRDY
op_logical_and
id|dbri-&gt;B
(braket
l_int|1
)braket
dot
id|input_callback
)paren
(brace
id|dbri-&gt;B
(braket
l_int|1
)braket
dot
id|input_callback
c_func
(paren
id|dbri-&gt;B
(braket
l_int|1
)braket
dot
id|input_callback_arg
comma
id|DBRI_RD_STATUS
c_func
(paren
id|dbri-&gt;B
(braket
l_int|1
)braket
dot
id|rd.flags
)paren
comma
id|DBRI_RD_CNT
c_func
(paren
id|dbri-&gt;B
(braket
l_int|1
)braket
dot
id|rd.flags
)paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|D_P_10
suffix:colon
multiline_comment|/* Pipe 10 - B1 channel transmit */
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_XCMP
op_logical_and
id|dbri-&gt;B
(braket
l_int|0
)braket
dot
id|output_callback
)paren
(brace
id|dbri-&gt;B
(braket
l_int|0
)braket
dot
id|output_callback
c_func
(paren
id|dbri-&gt;B
(braket
l_int|0
)braket
dot
id|output_callback_arg
comma
id|DBRI_TD_STATUS
c_func
(paren
id|dbri-&gt;B
(braket
l_int|0
)braket
dot
id|rd.flags
)paren
op_amp
l_int|0xfe
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|D_P_11
suffix:colon
multiline_comment|/* Pipe 11 - B2 channel transmit */
r_if
c_cond
(paren
id|D_INTR_GETCODE
c_func
(paren
id|x
)paren
op_eq
id|D_INTR_XCMP
op_logical_and
id|dbri-&gt;B
(braket
l_int|1
)braket
dot
id|output_callback
)paren
(brace
id|dbri-&gt;B
(braket
l_int|1
)braket
dot
id|output_callback
c_func
(paren
id|dbri-&gt;B
(braket
l_int|1
)braket
dot
id|output_callback_arg
comma
id|DBRI_TD_STATUS
c_func
(paren
id|dbri-&gt;B
(braket
l_int|1
)braket
dot
id|rd.flags
)paren
op_amp
l_int|0xfe
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|D_P_18
suffix:colon
multiline_comment|/* Pipe 18 - receive CS4215 status */
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
id|x
op_assign
id|reverse_bytes
c_func
(paren
id|val
comma
l_int|2
)paren
op_amp
id|CS4215_12_MASK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Comparing int: %x with hi(%x)&bslash;n&quot;
comma
id|x
comma
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
(paren
op_star
(paren
r_int
op_star
)paren
id|dbri-&gt;mm.ctrl
op_rshift
l_int|16
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Comp ok&bslash;n&quot;
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dbri-&gt;int_wait
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|D_P_19
suffix:colon
multiline_comment|/* Pipe 19 - receive CS4215 version */
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
id|dbri-&gt;mm.version
op_assign
id|reverse_bytes
c_func
(paren
id|val
comma
l_int|1
)paren
op_amp
l_int|0xf
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|dbri-&gt;dbri_irqp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dbri-&gt;dbri_irqp
op_eq
(paren
id|DBRI_NO_INTS
op_star
id|DBRI_INT_BLK
)paren
)paren
id|dbri-&gt;dbri_irqp
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|dbri-&gt;dbri_irqp
op_amp
(paren
id|DBRI_INT_BLK
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
id|dbri-&gt;dbri_irqp
op_increment
suffix:semicolon
id|x
op_assign
id|dbri-&gt;intr
(braket
id|dbri-&gt;dbri_irqp
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;****************************************************************************&n;******************** Interface with sparcaudio midlevel ********************&n;****************************************************************************&n;*/
DECL|function|dummy
r_static
r_void
id|dummy
c_func
(paren
)paren
(brace
)brace
DECL|function|dbri_open
r_static
r_int
id|dbri_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_release
r_static
r_void
id|dbri_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|dbri_start_output
r_static
r_void
id|dbri_start_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|val
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dbri_start_output called with count=%d; truncated&quot;
comma
id|count
)paren
suffix:semicolon
id|count
op_assign
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
suffix:semicolon
)brace
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
id|dbri-&gt;mm.td.flags
op_assign
id|DBRI_TD_F
op_or
id|DBRI_TD_B
op_or
id|DBRI_TD_D
op_or
id|DBRI_TD_CNT
c_func
(paren
id|count
)paren
suffix:semicolon
id|dbri-&gt;mm.td.ba
op_assign
(paren
id|__u32
)paren
id|buffer
suffix:semicolon
id|dbri-&gt;mm.td.nda
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;mm.td.status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 4 is audio transmit */
id|val
op_assign
id|D_SDP_MEM
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_P
op_or
id|D_SDP_MSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_4
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
(paren
id|__u32
)paren
op_amp
id|dbri-&gt;mm.td
suffix:semicolon
id|output_callback_arg
op_assign
id|drv
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
)brace
DECL|function|dbri_stop_output
r_static
r_void
id|dbri_stop_output
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
)brace
DECL|variable|dbri_ops
r_static
r_struct
id|sparcaudio_operations
id|dbri_ops
op_assign
(brace
id|dbri_open
comma
id|dbri_release
comma
id|dummy
comma
multiline_comment|/* dbri_ioctl, */
id|dbri_start_output
comma
id|dbri_stop_output
comma
id|dummy
comma
multiline_comment|/* dbri_start_input, */
id|dummy
comma
multiline_comment|/* dbri_stop_input, */
id|dummy
comma
multiline_comment|/* dbri_audio_getdev, */
id|dummy
comma
multiline_comment|/* dbri_set_output_volume, */
id|dummy
comma
multiline_comment|/* dbri_get_output_volume, */
id|dummy
comma
multiline_comment|/* dbri_set_input_volume, */
id|dummy
comma
multiline_comment|/* dbri_get_input_volume, */
id|dummy
comma
multiline_comment|/* dbri_set_monitor_volume, */
id|dummy
comma
multiline_comment|/* dbri_get_monitor_volume, */
id|dummy
comma
multiline_comment|/* dbri_set_output_balance */
id|dummy
comma
multiline_comment|/* dbri_get_output_balance, */
id|dummy
comma
multiline_comment|/* dbri_set_input_balance */
id|dummy
comma
multiline_comment|/* dbri_get_input_balance, */
id|dummy
comma
multiline_comment|/* dbri_set_output_channels */
id|dummy
comma
multiline_comment|/* dbri_get_output_channels, */
id|dummy
comma
multiline_comment|/* dbri_set_input_channels */
id|dummy
comma
multiline_comment|/* dbri_get_input_channels, */
id|dummy
comma
multiline_comment|/* dbri_set_output_precision */
id|dummy
comma
multiline_comment|/* dbri_get_output_precision, */
id|dummy
comma
multiline_comment|/* dbri_set_input_precision */
id|dummy
comma
multiline_comment|/* dbri_get_input_precision, */
id|dummy
comma
multiline_comment|/* dbri_set_output_port */
id|dummy
comma
multiline_comment|/* dbri_get_output_port, */
id|dummy
comma
multiline_comment|/* dbri_set_input_port */
id|dummy
comma
multiline_comment|/* dbri_get_input_port, */
id|dummy
comma
multiline_comment|/* dbri_set_output_encoding */
id|dummy
comma
multiline_comment|/* dbri_get_output_encoding, */
id|dummy
comma
multiline_comment|/* dbri_set_input_encoding */
id|dummy
comma
multiline_comment|/* dbri_get_input_encoding, */
id|dummy
comma
multiline_comment|/* dbri_set_output_rate */
id|dummy
comma
multiline_comment|/* dbri_get_output_rate, */
id|dummy
comma
multiline_comment|/* dbri_set_input_rate */
id|dummy
comma
multiline_comment|/* dbri_get_input_rate, */
id|dummy
comma
multiline_comment|/* dbri_sunaudio_getdev_sunos, */
id|dummy
comma
multiline_comment|/* dbri_get_output_ports, */
id|dummy
comma
multiline_comment|/* dbri_get_input_ports, */
id|dummy
comma
multiline_comment|/* dbri_set_output_muted */
id|dummy
comma
multiline_comment|/* dbri_get_output_muted, */
)brace
suffix:semicolon
multiline_comment|/*&n;****************************************************************************&n;************************** ISDN (Hisax) Interface **************************&n;****************************************************************************&n;*/
DECL|function|dbri_get_irqnum
r_int
id|dbri_get_irqnum
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* On the sparc, the cpu&squot;s irq number is only part of the &quot;irq&quot; */
r_return
(paren
id|dbri-&gt;irq
op_amp
id|NR_IRQS
)paren
suffix:semicolon
)brace
DECL|function|dbri_get_liu_state
r_int
id|dbri_get_liu_state
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_return
id|dbri-&gt;liu_state
suffix:semicolon
)brace
DECL|function|dbri_liu_init
r_void
id|dbri_liu_init
c_func
(paren
r_int
id|dev
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Set callback for LIU state change */
id|dbri-&gt;liu_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;liu_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|dbri_isdn_init
c_func
(paren
id|dbri
)paren
suffix:semicolon
)brace
DECL|function|dbri_liu_activate
r_void
id|dbri_liu_activate
c_func
(paren
r_int
id|dev
comma
r_int
id|priority
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_int
id|n
comma
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* Turn on the ISDN TE interface and request activation */
id|val
op_assign
id|D_NT_IRM_IMM
op_or
id|D_NT_IRM_EN
op_or
id|D_NT_ACT
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_TE
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
multiline_comment|/* Activate the interface */
id|dbri-&gt;regs-&gt;reg0
op_or_assign
id|D_T
suffix:semicolon
)brace
DECL|function|dbri_liu_deactivate
r_void
id|dbri_liu_deactivate
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
multiline_comment|/* Turn off the ISDN TE interface */
id|dbri-&gt;regs-&gt;reg0
op_and_assign
op_complement
id|D_T
suffix:semicolon
)brace
DECL|function|dbri_dxmit
r_void
id|dbri_dxmit
c_func
(paren
r_int
id|dev
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_int
id|n
comma
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dbri_dxmit called with count=%d; truncated&quot;
comma
id|count
)paren
suffix:semicolon
id|count
op_assign
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
suffix:semicolon
)brace
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* XXX - Shouldn&squot;t I check to make sure D.td isn&squot;t is use? */
id|dbri-&gt;D.td.flags
op_assign
id|DBRI_TD_F
op_or
id|DBRI_TD_B
op_or
id|DBRI_TD_CNT
c_func
(paren
id|count
)paren
op_or
id|DBRI_TD_I
suffix:semicolon
id|dbri-&gt;D.td.ba
op_assign
(paren
id|__u32
)paren
id|buffer
suffix:semicolon
id|dbri-&gt;D.td.nda
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;D.td.status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 1 is D channel transmit */
id|val
op_assign
id|D_SDP_HDLC_D
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_1
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
(paren
id|__u32
)paren
op_amp
id|dbri-&gt;D.td
suffix:semicolon
id|dbri-&gt;D.output_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;D.output_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
)brace
DECL|function|dbri_drecv
r_void
id|dbri_drecv
c_func
(paren
r_int
id|dev
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|size
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_int
id|n
comma
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dbri_drecv called with size=%d; truncated&quot;
comma
id|size
)paren
suffix:semicolon
id|size
op_assign
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Make sure size is a multiple of four */
id|size
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* XXX - Shouldn&squot;t I check to make sure D.rd isn&squot;t is use? */
id|dbri-&gt;D.rd.flags
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;D.rd.ba
op_assign
(paren
id|__u32
)paren
id|buffer
suffix:semicolon
id|dbri-&gt;D.rd.nda
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;D.rd.status
op_assign
id|DBRI_RD_B
op_or
id|DBRI_RD_BCNT
c_func
(paren
id|size
)paren
suffix:semicolon
multiline_comment|/* Pipe 0 is D channel receive */
id|val
op_assign
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_C
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_0
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
(paren
id|__u32
)paren
op_amp
id|dbri-&gt;D.rd
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
id|dbri-&gt;D.input_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;D.input_callback_arg
op_assign
id|callback_arg
suffix:semicolon
)brace
DECL|function|dbri_bopen
r_int
id|dbri_bopen
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
r_int
id|hdlcmode
comma
id|u_char
id|xmit_idle_char
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_int
id|n
comma
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_if
c_cond
(paren
id|hdlcmode
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Pipe 8/9: receive B1/B2 channel */
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|recvSDP
op_assign
id|D_SDP_HDLC
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_8
op_plus
id|chan
)paren
suffix:semicolon
multiline_comment|/* Pipe 10/11: transmit B1/B2 channel */
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|xmitSDP
op_assign
id|D_SDP_HDLC
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_10
op_plus
id|chan
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* !hdlcmode means transparent */
multiline_comment|/* Pipe 8/9: receive B1/B2 channel */
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|recvSDP
op_assign
id|D_SDP_MEM
op_or
id|D_SDP_FROM_SER
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_8
op_plus
id|chan
)paren
suffix:semicolon
multiline_comment|/* Pipe 10/11: transmit B1/B2 channel */
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|xmitSDP
op_assign
id|D_SDP_MEM
op_or
id|D_SDP_TO_SER
op_or
id|D_SDP_P
op_or
id|D_SDP_LSB
op_or
id|D_PIPE
c_func
(paren
id|D_P_10
op_plus
id|chan
)paren
suffix:semicolon
)brace
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* Pipe 8/9: receive B1/B2 channel */
id|val
op_assign
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|recvSDP
op_or
id|D_SDP_C
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 10/11: transmit B1/B2 channel */
id|val
op_assign
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|xmitSDP
op_or
id|D_SDP_C
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|output_callback
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|input_callback
op_assign
l_int|NULL
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dbri_bclose
r_void
id|dbri_bclose
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|output_callback
op_assign
l_int|NULL
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|input_callback
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|dbri_bxmit
r_void
id|dbri_bxmit
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_int
id|n
comma
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dbri_bxmit called with count=%ld; truncated&quot;
comma
id|count
)paren
suffix:semicolon
id|count
op_assign
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
suffix:semicolon
)brace
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* XXX - Shouldn&squot;t I check to make sure td isn&squot;t is use? */
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|td.flags
op_assign
id|DBRI_TD_F
op_or
id|DBRI_TD_B
op_or
id|DBRI_TD_CNT
c_func
(paren
id|count
)paren
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|td.ba
op_assign
(paren
id|__u32
)paren
id|buffer
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|td.nda
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|td.status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pipe 10/11 is B1/B2 channel transmit */
id|val
op_assign
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|xmitSDP
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
(paren
id|__u32
)paren
op_amp
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|td
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|output_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|output_callback_arg
op_assign
id|callback_arg
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
)brace
DECL|function|dbri_brecv
r_void
id|dbri_brecv
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|chan
comma
id|__u8
op_star
id|buffer
comma
r_int
r_int
id|size
comma
r_void
(paren
op_star
id|callback
)paren
(paren
r_void
op_star
comma
r_int
comma
r_int
r_int
)paren
comma
r_void
op_star
id|callback_arg
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_int
id|n
comma
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
id|num_drivers
op_logical_or
id|chan
OG
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drivers
(braket
id|dev
)braket
dot
r_private
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dbri_brecv called with size=%ld; truncated&quot;
comma
id|size
)paren
suffix:semicolon
id|size
op_assign
(paren
l_int|1
op_lshift
l_int|14
)paren
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Make sure size is a multiple of four */
id|size
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|n
op_assign
id|dbri_cmdlock
c_func
(paren
id|dbri
)paren
suffix:semicolon
multiline_comment|/* XXX - Shouldn&squot;t I check to make sure RD isn&squot;t is use? */
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|rd.flags
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|rd.ba
op_assign
(paren
id|__u32
)paren
id|buffer
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|rd.nda
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|rd.status
op_assign
id|DBRI_RD_B
op_or
id|DBRI_RD_BCNT
c_func
(paren
id|size
)paren
suffix:semicolon
multiline_comment|/* Pipe 8/9 is B1/B2 channel receive */
id|val
op_assign
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|recvSDP
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
id|DBRI_CMD
c_func
(paren
id|D_SDP
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|dbri-&gt;cmd
(braket
id|n
op_increment
)braket
op_assign
(paren
id|__u32
)paren
op_amp
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|rd
suffix:semicolon
id|dbri_cmdsend
c_func
(paren
id|dbri
comma
id|n
)paren
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|input_callback
op_assign
id|callback
suffix:semicolon
id|dbri-&gt;B
(braket
id|chan
)braket
dot
id|input_callback_arg
op_assign
id|callback_arg
suffix:semicolon
)brace
macro_line|#if defined(DBRI_ISDN) || defined (LINUX_VERSION_CODE) &amp;&amp; LINUX_VERSION_CODE &gt; 0x200ff
DECL|variable|dbri_foreign_interface
r_struct
id|foreign_interface
id|dbri_foreign_interface
op_assign
(brace
id|dbri_get_irqnum
comma
id|dbri_get_liu_state
comma
id|dbri_liu_init
comma
id|dbri_liu_activate
comma
id|dbri_liu_deactivate
comma
id|dbri_dxmit
comma
id|dbri_drecv
comma
id|dbri_bopen
comma
id|dbri_bclose
comma
id|dbri_bxmit
comma
id|dbri_brecv
)brace
suffix:semicolon
DECL|variable|dbri_foreign_interface
id|EXPORT_SYMBOL
c_func
(paren
id|dbri_foreign_interface
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;****************************************************************************&n;**************************** Initialization ********************************&n;****************************************************************************&n;*/
DECL|function|dbri_attach
r_static
r_int
id|dbri_attach
c_func
(paren
r_struct
id|sparcaudio_driver
op_star
id|drv
comma
r_struct
id|linux_sbus_device
op_star
id|sdev
)paren
(brace
r_struct
id|dbri
op_star
id|dbri
suffix:semicolon
r_struct
id|linux_prom_irqs
id|irq
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
OL
l_char|&squot;e&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: unsupported chip version %c found.&bslash;n&quot;
comma
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|drv-&gt;ops
op_assign
op_amp
id|dbri_ops
suffix:semicolon
id|drv
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dbri
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drv
op_member_access_from_pointer
r_private
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dbri
op_assign
(paren
r_struct
id|dbri
op_star
)paren
id|drv
op_member_access_from_pointer
r_private
suffix:semicolon
id|memset
c_func
(paren
id|dbri
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dbri
)paren
)paren
suffix:semicolon
id|dbri-&gt;dbri_version
op_assign
id|sdev-&gt;prom_name
(braket
l_int|9
)braket
suffix:semicolon
multiline_comment|/* Map the registers into memory. */
id|prom_apply_sbus_ranges
c_func
(paren
id|sdev-&gt;my_bus
comma
op_amp
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
comma
id|sdev-&gt;num_registers
comma
id|sdev
)paren
suffix:semicolon
id|dbri-&gt;regs_size
op_assign
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
suffix:semicolon
id|dbri-&gt;regs
op_assign
id|sparc_alloc_io
c_func
(paren
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|phys_addr
comma
l_int|0
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|reg_size
comma
id|drv_name
comma
id|sdev-&gt;reg_addrs
(braket
l_int|0
)braket
dot
id|which_io
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dbri-&gt;regs
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: could not allocate registers&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|prom_getproperty
c_func
(paren
id|sdev-&gt;prom_node
comma
l_string|&quot;intr&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|irq
comma
r_sizeof
(paren
id|irq
)paren
)paren
suffix:semicolon
id|dbri-&gt;irq
op_assign
id|irq.pri
suffix:semicolon
id|err
op_assign
id|request_irq
c_func
(paren
id|dbri-&gt;irq
comma
id|dbri_intr
comma
id|SA_SHIRQ
comma
l_string|&quot;DBRI/audio&quot;
comma
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: Can&squot;t get irq %d&bslash;n&quot;
comma
id|dbri-&gt;irq
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|dbri-&gt;regs
comma
id|dbri-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Register ourselves with the midlevel audio driver. */
id|err
op_assign
id|register_sparcaudio_driver
c_func
(paren
id|drv
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DBRI: unable to register audio&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dbri-&gt;irq
comma
id|drv
)paren
suffix:semicolon
id|sparc_free_io
c_func
(paren
id|dbri-&gt;regs
comma
id|dbri-&gt;regs_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drv
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dbri_initialize
c_func
(paren
id|drv
)paren
suffix:semicolon
id|err
op_assign
id|mmcodec_init
c_func
(paren
id|drv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|dbri_detach
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dbri-&gt;perchip_info.play.active
op_assign
id|dbri-&gt;perchip_info.play.pause
op_assign
l_int|0
suffix:semicolon
id|dbri-&gt;perchip_info.record.active
op_assign
id|dbri-&gt;perchip_info.record.pause
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;audio%d at 0x%lx (irq %d) is DBRI(%c)+CS4215(%d)&bslash;n&quot;
comma
id|num_drivers
comma
(paren
r_int
r_int
)paren
id|dbri-&gt;regs
comma
id|dbri-&gt;irq
comma
id|dbri-&gt;dbri_version
comma
id|dbri-&gt;mm.version
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Probe for the dbri chip and then attach the driver. */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_int
id|dbri_init
c_func
(paren
r_void
)paren
)paren
macro_line|#endif
(brace
r_struct
id|linux_sbus
op_star
id|bus
suffix:semicolon
r_struct
id|linux_sbus_device
op_star
id|sdev
suffix:semicolon
id|num_drivers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Probe each SBUS for the DBRI chip(s). */
id|for_all_sbusdev
c_func
(paren
id|sdev
comma
id|bus
)paren
(brace
multiline_comment|/*&n;&t;&t; * The version is coded in the last character&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|sdev-&gt;prom_name
comma
l_string|&quot;SUNW,DBRI&quot;
comma
l_int|9
)paren
)paren
(brace
id|dprintk
c_func
(paren
id|D_GEN
comma
(paren
l_string|&quot;DBRI: Found %s in SBUS slot %d&bslash;n&quot;
comma
id|sdev-&gt;prom_name
comma
id|sdev-&gt;slot
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_drivers
op_ge
id|MAX_DRIVERS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DBRI: Ignoring slot %d&bslash;n&quot;
comma
id|sdev-&gt;slot
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dbri_attach
c_func
(paren
op_amp
id|drivers
(braket
id|num_drivers
)braket
comma
id|sdev
)paren
op_eq
l_int|0
)paren
id|num_drivers
op_increment
suffix:semicolon
)brace
)brace
r_return
(paren
id|num_drivers
OG
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_drivers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dbri_detach
c_func
(paren
op_amp
id|drivers
(braket
id|i
)braket
)paren
suffix:semicolon
id|num_drivers
op_decrement
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local Variables:&n; * c-indent-level: 8&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -8&n; * c-argdecl-indent: 8&n; * c-label-offset: -8&n; * c-continued-statement-offset: 8&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
