multiline_comment|/* ps2esdi driver based on assembler code by Arindam Banerji,&n;   written by Peter De Schrijver */
multiline_comment|/* Reassuring note to IBM : This driver was NOT developed by vice-versa&n;   engineering the PS/2&squot;s BIOS */
multiline_comment|/* Dedicated to Wannes, Tofke, Ykke, Godot, Killroy and all those &n;   other lovely fish out there... */
multiline_comment|/* This code was written during the long and boring WINA &n;   elections 1994 */
multiline_comment|/* Thanks to Arindam Banerij for giving me the source of his driver */
multiline_comment|/* This code may be freely distributed and modified in any way, &n;   as long as these notes remain intact */
multiline_comment|/*  Revised: 05/07/94 by Arindam Banerji (axb@cse.nd.edu) */
multiline_comment|/*  Revised: 09/08/94 by Peter De Schrijver (stud11@cc4.kuleuven.ac.be)&n;   Thanks to Arindam Banerij for sending me the docs of the adapter */
multiline_comment|/* BA Modified for ThinkPad 720 by Boris Ashkinazi */
multiline_comment|/*                    (bash@vnet.ibm.com) 08/08/95 */
multiline_comment|/* Modified further for ThinkPad-720C by Uri Blumenthal */
multiline_comment|/*                    (uri@watson.ibm.com) Sep 11, 1995 */
multiline_comment|/* TODO : &n;   + Timeouts&n;   + Get disk parameters&n;   + DMA above 16MB&n;   + reset after read/write error&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#ifdef  CONFIG_BLK_DEV_PS2
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR PS2ESDI_MAJOR
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/ps2esdi.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &lt;linux/mca.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|PS2ESDI_IRQ
mdefine_line|#define PS2ESDI_IRQ 14
DECL|macro|MAX_HD
mdefine_line|#define MAX_HD 1
DECL|macro|MAX_RETRIES
mdefine_line|#define MAX_RETRIES 5
DECL|macro|MAX_16BIT
mdefine_line|#define MAX_16BIT 65536
DECL|macro|ESDI_TIMEOUT
mdefine_line|#define ESDI_TIMEOUT   0xf000
DECL|macro|ESDI_STAT_TIMEOUT
mdefine_line|#define ESDI_STAT_TIMEOUT 4
DECL|macro|TYPE_0_CMD_BLK_LENGTH
mdefine_line|#define TYPE_0_CMD_BLK_LENGTH 2
DECL|macro|TYPE_1_CMD_BLK_LENGTH
mdefine_line|#define TYPE_1_CMD_BLK_LENGTH 4
r_static
r_void
id|reset_ctrl
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|ps2esdi_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ps2esdi_geninit
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_ps2esdi_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
suffix:semicolon
r_static
r_void
id|ps2esdi_readwrite
c_func
(paren
r_int
id|cmd
comma
id|u_char
id|drive
comma
id|u_int
id|block
comma
id|u_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|ps2esdi_fill_cmd_block
c_func
(paren
id|u_short
op_star
id|cmd_blk
comma
id|u_short
id|cmd
comma
id|u_short
id|cyl
comma
id|u_short
id|head
comma
id|u_short
id|sector
comma
id|u_short
id|length
comma
id|u_char
id|drive
)paren
suffix:semicolon
r_static
r_int
id|ps2esdi_out_cmd_blk
c_func
(paren
id|u_short
op_star
id|cmd_blk
)paren
suffix:semicolon
r_static
r_void
id|ps2esdi_prep_dma
c_func
(paren
r_char
op_star
id|buffer
comma
id|u_short
id|length
comma
id|u_char
id|dma_xmode
)paren
suffix:semicolon
r_static
r_void
id|ps2esdi_interrupt_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|variable|current_int_handler
r_static
r_void
(paren
op_star
id|current_int_handler
)paren
(paren
id|u_int
)paren
op_assign
l_int|NULL
suffix:semicolon
r_static
r_void
id|ps2esdi_normal_interrupt_handler
c_func
(paren
id|u_int
)paren
suffix:semicolon
r_static
r_void
id|ps2esdi_initial_reset_int_handler
c_func
(paren
id|u_int
)paren
suffix:semicolon
r_static
r_void
id|ps2esdi_geometry_int_handler
c_func
(paren
id|u_int
)paren
suffix:semicolon
r_static
r_void
id|ps2esdi_continue_request
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|ps2esdi_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|ps2esdi_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|ps2esdi_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ps2esdi_reread_partitions
c_func
(paren
id|kdev_t
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ps2esdi_read_status_words
c_func
(paren
r_int
id|num_words
comma
r_int
id|max_words
comma
id|u_short
op_star
id|buffer
)paren
suffix:semicolon
r_static
r_void
id|dump_cmd_complete_status
c_func
(paren
id|u_int
id|int_ret_code
)paren
suffix:semicolon
r_static
r_void
id|ps2esdi_get_device_cfg
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|ps2esdi_reset_timer
c_func
(paren
r_int
r_int
id|unused
)paren
suffix:semicolon
DECL|variable|dma_arb_level
id|u_int
id|dma_arb_level
suffix:semicolon
multiline_comment|/* DMA arbitration level */
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|ps2esdi_int
)paren
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|ps2esdi_wait_open
)paren
suffix:semicolon
DECL|variable|no_int_yet
r_int
id|no_int_yet
suffix:semicolon
DECL|variable|access_count
r_static
r_int
id|access_count
(braket
id|MAX_HD
)braket
suffix:semicolon
DECL|variable|ps2esdi_valid
r_static
r_char
id|ps2esdi_valid
(braket
id|MAX_HD
)braket
suffix:semicolon
DECL|variable|ps2esdi_sizes
r_static
r_int
id|ps2esdi_sizes
(braket
id|MAX_HD
op_lshift
l_int|6
)braket
suffix:semicolon
DECL|variable|ps2esdi_blocksizes
r_static
r_int
id|ps2esdi_blocksizes
(braket
id|MAX_HD
op_lshift
l_int|6
)braket
suffix:semicolon
DECL|variable|ps2esdi_drives
r_static
r_int
id|ps2esdi_drives
suffix:semicolon
DECL|variable|ps2esdi
r_static
r_struct
id|hd_struct
id|ps2esdi
(braket
id|MAX_HD
op_lshift
l_int|6
)braket
suffix:semicolon
DECL|variable|io_base
r_static
id|u_short
id|io_base
suffix:semicolon
DECL|variable|esdi_timer
r_static
r_struct
id|timer_list
id|esdi_timer
op_assign
(brace
id|function
suffix:colon
id|ps2esdi_reset_timer
)brace
suffix:semicolon
DECL|variable|reset_status
r_static
r_int
id|reset_status
suffix:semicolon
DECL|variable|ps2esdi_slot
r_static
r_int
id|ps2esdi_slot
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|tp720esdi
r_int
id|tp720esdi
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Is it Integrated ESDI of ThinkPad-720? */
DECL|variable|intg_esdi
r_int
id|intg_esdi
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If integrated adapter */
DECL|struct|ps2esdi_i_struct
r_struct
id|ps2esdi_i_struct
(brace
DECL|member|head
DECL|member|sect
DECL|member|cyl
DECL|member|wpcom
DECL|member|lzone
DECL|member|ctl
r_int
r_int
id|head
comma
id|sect
comma
id|cyl
comma
id|wpcom
comma
id|lzone
comma
id|ctl
suffix:semicolon
)brace
suffix:semicolon
macro_line|#if 0
macro_line|#if 0&t;&t;&t;&t;/* try both - I don&squot;t know which one is better... UB */
r_struct
id|ps2esdi_i_struct
id|ps2esdi_info
(braket
)braket
op_assign
(brace
(brace
l_int|4
comma
l_int|48
comma
l_int|1553
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
macro_line|#else
r_struct
id|ps2esdi_i_struct
id|ps2esdi_info
(braket
)braket
op_assign
(brace
(brace
l_int|64
comma
l_int|32
comma
l_int|161
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
macro_line|#endif
macro_line|#endif
DECL|variable|ps2esdi_info
r_struct
id|ps2esdi_i_struct
id|ps2esdi_info
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|ps2esdi_fops
r_static
r_struct
id|block_device_operations
id|ps2esdi_fops
op_assign
(brace
id|open
suffix:colon
id|ps2esdi_open
comma
id|release
suffix:colon
id|ps2esdi_release
comma
id|ioctl
suffix:colon
id|ps2esdi_ioctl
comma
)brace
suffix:semicolon
DECL|variable|ps2esdi_gendisk
r_static
r_struct
id|gendisk
id|ps2esdi_gendisk
op_assign
(brace
id|MAJOR_NR
comma
multiline_comment|/* Major number */
l_string|&quot;ed&quot;
comma
multiline_comment|/* Major name */
l_int|6
comma
multiline_comment|/* Bits to shift to get real from partition */
l_int|1
op_lshift
l_int|6
comma
multiline_comment|/* Number of partitions per real disk */
id|ps2esdi
comma
multiline_comment|/* hd struct */
id|ps2esdi_sizes
comma
multiline_comment|/* block sizes */
l_int|0
comma
multiline_comment|/* number */
(paren
r_void
op_star
)paren
id|ps2esdi_info
comma
multiline_comment|/* internal */
l_int|NULL
comma
multiline_comment|/* next */
op_amp
id|ps2esdi_fops
comma
multiline_comment|/* file operations */
)brace
suffix:semicolon
multiline_comment|/* initialization routine called by ll_rw_blk.c   */
DECL|function|ps2esdi_init
r_int
id|__init
id|ps2esdi_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* register the device - pass the name, major number and operations&n;&t;   vector .                                                 */
r_if
c_cond
(paren
id|devfs_register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;ed&quot;
comma
op_amp
id|ps2esdi_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Unable to get major number %d&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* set up some global information - indicating device specific info */
id|blk_init_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|DEVICE_REQUEST
)paren
suffix:semicolon
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 8 sector (4kB) read ahead */
multiline_comment|/* some minor housekeeping - setup the global gendisk structure */
id|ps2esdi_gendisk.next
op_assign
id|gendisk_head
suffix:semicolon
id|gendisk_head
op_assign
op_amp
id|ps2esdi_gendisk
suffix:semicolon
id|ps2esdi_geninit
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ps2esdi_init */
macro_line|#ifdef MODULE
DECL|variable|cyl
r_int
id|cyl
(braket
l_int|2
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|head
r_int
id|head
(braket
l_int|2
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|sect
r_int
id|sect
(braket
l_int|2
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tp720esdi
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cyl
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|head
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|track
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|drive
suffix:semicolon
r_for
c_loop
(paren
id|drive
op_assign
l_int|0
suffix:semicolon
id|drive
op_le
l_int|1
suffix:semicolon
id|drive
op_increment
)paren
(brace
r_struct
id|ps2_esdi_i_struct
op_star
id|info
op_assign
op_amp
id|ps2esdi_info
(braket
id|drive
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cyl
(braket
id|drive
)braket
op_ne
op_minus
l_int|1
)paren
(brace
id|info-&gt;cyl
op_assign
id|info-&gt;lzone
op_assign
id|cyl
(braket
id|drive
)braket
suffix:semicolon
id|info-&gt;wpcom
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|head
(braket
id|drive
)braket
op_ne
op_minus
l_int|1
)paren
(brace
id|info-&gt;head
op_assign
id|head
(braket
id|drive
)braket
suffix:semicolon
id|info-&gt;ctl
op_assign
(paren
id|head
(braket
id|drive
)braket
OG
l_int|8
ques
c_cond
l_int|8
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sect
(braket
id|drive
)braket
op_ne
op_minus
l_int|1
)paren
id|info-&gt;sect
op_assign
id|sect
(braket
id|drive
)braket
suffix:semicolon
)brace
r_return
id|ps2esdi_init
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ps2esdi_slot
)paren
(brace
id|mca_mark_as_unused
c_func
(paren
id|ps2esdi_slot
)paren
suffix:semicolon
id|mca_set_adapter_procfn
c_func
(paren
id|ps2esdi_slot
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|io_base
comma
l_int|4
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dma_arb_level
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|PS2ESDI_IRQ
comma
l_int|NULL
)paren
id|devfs_unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;ed&quot;
)paren
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/* handles boot time command line parameters */
DECL|function|tp720_setup
r_void
id|__init
id|tp720_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
multiline_comment|/* no params, just sets the tp720esdi flag if it exists */
id|printk
c_func
(paren
l_string|&quot;%s: TP 720 ESDI flag set&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|tp720esdi
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|ed_setup
r_void
id|__init
id|ed_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|hdind
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* handles 3 parameters only - corresponding to&n;&t;   1. Number of cylinders&n;&t;   2. Number of heads&n;&t;   3. Sectors/track&n;&t; */
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_ne
l_int|3
)paren
r_return
suffix:semicolon
multiline_comment|/* print out the information - seen at boot time */
id|printk
c_func
(paren
l_string|&quot;%s: ints[0]=%d ints[1]=%d ints[2]=%d ints[3]=%d&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|ints
(braket
l_int|0
)braket
comma
id|ints
(braket
l_int|1
)braket
comma
id|ints
(braket
l_int|2
)braket
comma
id|ints
(braket
l_int|3
)braket
)paren
suffix:semicolon
multiline_comment|/* set the index into device specific information table */
r_if
c_cond
(paren
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|head
op_ne
l_int|0
)paren
id|hdind
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set up all the device information */
id|ps2esdi_info
(braket
id|hdind
)braket
dot
id|head
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|ps2esdi_info
(braket
id|hdind
)braket
dot
id|sect
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|ps2esdi_info
(braket
id|hdind
)braket
dot
id|cyl
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|ps2esdi_info
(braket
id|hdind
)braket
dot
id|wpcom
op_assign
l_int|0
suffix:semicolon
id|ps2esdi_info
(braket
id|hdind
)braket
dot
id|lzone
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|ps2esdi_info
(braket
id|hdind
)braket
dot
id|ctl
op_assign
(paren
id|ints
(braket
l_int|2
)braket
OG
l_int|8
ques
c_cond
l_int|8
suffix:colon
l_int|0
)paren
suffix:semicolon
macro_line|#if 0&t;&t;&t;&t;/* this may be needed for PS2/Mod.80, but it hurts ThinkPad! */
id|ps2esdi_drives
op_assign
id|hdind
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* increment index for the next time */
macro_line|#endif
)brace
multiline_comment|/* ed_setup */
DECL|function|ps2esdi_getinfo
r_static
r_int
id|ps2esdi_getinfo
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|slot
comma
r_void
op_star
id|d
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;DMA Arbitration Level: %d&bslash;n&quot;
comma
id|dma_arb_level
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;IO Port: %x&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;IRQ: 14&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Drives: %d&bslash;n&quot;
comma
id|ps2esdi_drives
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* ps2 esdi specific initialization - called thru the gendisk chain */
DECL|function|ps2esdi_geninit
r_static
r_void
id|__init
id|ps2esdi_geninit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t;   The first part contains the initialization code&n;&t;   for the ESDI disk subsystem.  All we really do&n;&t;   is search for the POS registers of the controller&n;&t;   to do some simple setup operations.  First, we&n;&t;   must ensure that the controller is installed,&n;&t;   enabled, and configured as PRIMARY.  Then we must&n;&t;   determine the DMA arbitration level being used by&n;&t;   the controller so we can handle data transfer&n;&t;   operations properly.  If all of this works, then&n;&t;   we will set the INIT_FLAG to a non-zero value.&n;&t; */
r_int
id|slot
op_assign
l_int|0
comma
id|i
comma
id|reset_start
comma
id|reset_end
suffix:semicolon
id|u_char
id|status
suffix:semicolon
r_int
r_int
id|adapterID
suffix:semicolon
r_if
c_cond
(paren
(paren
id|slot
op_assign
id|mca_find_adapter
c_func
(paren
id|INTG_ESDI_ID
comma
l_int|0
)paren
)paren
op_ne
id|MCA_NOTFOUND
)paren
(brace
id|adapterID
op_assign
id|INTG_ESDI_ID
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: integrated ESDI adapter found in slot %d&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|slot
op_plus
l_int|1
)paren
suffix:semicolon
macro_line|#ifndef MODULE
id|mca_set_adapter_name
c_func
(paren
id|slot
comma
l_string|&quot;PS/2 Integrated ESDI&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
(paren
id|slot
op_assign
id|mca_find_adapter
c_func
(paren
id|NRML_ESDI_ID
comma
l_int|0
)paren
)paren
op_ne
op_minus
l_int|1
)paren
(brace
id|adapterID
op_assign
id|NRML_ESDI_ID
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: normal ESDI adapter found in slot %d&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|slot
op_plus
l_int|1
)paren
suffix:semicolon
id|mca_set_adapter_name
c_func
(paren
id|slot
comma
l_string|&quot;PS/2 ESDI&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
suffix:semicolon
)brace
id|ps2esdi_slot
op_assign
id|slot
suffix:semicolon
id|mca_mark_as_used
c_func
(paren
id|slot
)paren
suffix:semicolon
id|mca_set_adapter_procfn
c_func
(paren
id|slot
comma
(paren
id|MCA_ProcFn
)paren
id|ps2esdi_getinfo
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Found the slot - read the POS register 2 to get the necessary&n;&t;   configuration and status information.  POS register 2 has the&n;&t;   following information :&n;&t;   Bit           Function&n;&t;   7             reserved = 0&n;&t;   6             arbitration method&n;&t;   0 - fairness enabled&n;&t;   1 - fairness disabled, linear priority assignment&n;&t;   5-2           arbitration level&n;&t;   1             alternate address&n;&t;   1              alternate address&n;&t;   0 - use addresses 0x3510 - 0x3517&n;&t;   0             adapter enable&n;&t; */
id|status
op_assign
id|mca_read_stored_pos
c_func
(paren
id|slot
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* is it enabled ? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|STATUS_ENABLED
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: ESDI adapter disabled&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* try to grab IRQ, and try to grab a slow IRQ if it fails, so we can&n;&t;   share with the SCSI driver */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|PS2ESDI_IRQ
comma
id|ps2esdi_interrupt_handler
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;PS/2 ESDI&quot;
comma
op_amp
id|ps2esdi_gendisk
)paren
op_logical_and
id|request_irq
c_func
(paren
id|PS2ESDI_IRQ
comma
id|ps2esdi_interrupt_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;PS/2 ESDI&quot;
comma
op_amp
id|ps2esdi_gendisk
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Unable to get IRQ %d&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|PS2ESDI_IRQ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|STATUS_ALTERNATE
)paren
id|io_base
op_assign
id|ALT_IO_BASE
suffix:semicolon
r_else
id|io_base
op_assign
id|PRIMARY_IO_BASE
suffix:semicolon
multiline_comment|/* get the dma arbitration level */
id|dma_arb_level
op_assign
(paren
id|status
op_rshift
l_int|2
)paren
op_amp
l_int|0xf
suffix:semicolon
multiline_comment|/* BA */
id|printk
c_func
(paren
l_string|&quot;%s: DMA arbitration level : %d&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|dma_arb_level
)paren
suffix:semicolon
id|LITE_ON
suffix:semicolon
id|current_int_handler
op_assign
id|ps2esdi_initial_reset_int_handler
suffix:semicolon
id|reset_ctrl
c_func
(paren
)paren
suffix:semicolon
id|reset_status
op_assign
l_int|0
suffix:semicolon
id|reset_start
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|reset_status
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|esdi_timer
)paren
suffix:semicolon
id|esdi_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|esdi_timer.data
op_assign
l_int|0
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|esdi_timer
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|ps2esdi_int
)paren
suffix:semicolon
)brace
id|reset_end
op_assign
id|jiffies
suffix:semicolon
id|LITE_OFF
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: reset interrupt after %d jiffies,  %u.%02u secs&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|reset_end
op_minus
id|reset_start
comma
(paren
id|reset_end
op_minus
id|reset_start
)paren
op_div
id|HZ
comma
(paren
id|reset_end
op_minus
id|reset_start
)paren
op_mod
id|HZ
)paren
suffix:semicolon
multiline_comment|/* Integrated ESDI Disk and Controller has only one drive! */
r_if
c_cond
(paren
id|adapterID
op_eq
id|INTG_ESDI_ID
)paren
(brace
multiline_comment|/* if not &quot;normal&quot; PS2 ESDI adapter */
id|ps2esdi_drives
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* then we have only one physical disk! */
id|intg_esdi
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* finally this part sets up some global data structures etc. */
id|ps2esdi_get_device_cfg
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* some annoyance in the above routine returns TWO drives?&n;&t; Is something else happining in the background?&n;&t; Regaurdless we fix the # of drives again. AJK */
multiline_comment|/* Integrated ESDI Disk and Controller has only one drive! */
r_if
c_cond
(paren
id|adapterID
op_eq
id|INTG_ESDI_ID
)paren
multiline_comment|/* if not &quot;normal&quot; PS2 ESDI adapter */
id|ps2esdi_drives
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Not three or two, ONE DAMNIT! */
id|current_int_handler
op_assign
id|ps2esdi_normal_interrupt_handler
suffix:semicolon
id|ps2esdi_gendisk.nr_real
op_assign
id|ps2esdi_drives
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|MAX_HD
op_lshift
l_int|6
)paren
suffix:semicolon
id|i
op_increment
)paren
id|ps2esdi_blocksizes
(braket
id|i
)braket
op_assign
l_int|1024
suffix:semicolon
id|request_dma
c_func
(paren
id|dma_arb_level
comma
l_string|&quot;ed&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|io_base
comma
l_int|4
comma
l_string|&quot;ed&quot;
)paren
suffix:semicolon
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|ps2esdi_blocksizes
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ps2esdi_drives
suffix:semicolon
id|i
op_increment
)paren
(brace
id|register_disk
c_func
(paren
op_amp
id|ps2esdi_gendisk
comma
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|i
op_lshift
l_int|6
)paren
comma
l_int|1
op_lshift
l_int|6
comma
op_amp
id|ps2esdi_fops
comma
id|ps2esdi_info
(braket
id|i
)braket
dot
id|head
op_star
id|ps2esdi_info
(braket
id|i
)braket
dot
id|sect
op_star
id|ps2esdi_info
(braket
id|i
)braket
dot
id|cyl
)paren
suffix:semicolon
id|ps2esdi_valid
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|ps2esdi_get_device_cfg
r_static
r_void
id|__init
id|ps2esdi_get_device_cfg
c_func
(paren
r_void
)paren
(brace
id|u_short
id|cmd_blk
(braket
id|TYPE_0_CMD_BLK_LENGTH
)braket
suffix:semicolon
multiline_comment|/*BA */
id|printk
c_func
(paren
l_string|&quot;%s: Drive 0&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|current_int_handler
op_assign
id|ps2esdi_geometry_int_handler
suffix:semicolon
id|cmd_blk
(braket
l_int|0
)braket
op_assign
id|CMD_GET_DEV_CONFIG
op_or
l_int|0x600
suffix:semicolon
id|cmd_blk
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|no_int_yet
op_assign
id|TRUE
suffix:semicolon
id|ps2esdi_out_cmd_blk
c_func
(paren
id|cmd_blk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|no_int_yet
)paren
id|sleep_on
c_func
(paren
op_amp
id|ps2esdi_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ps2esdi_drives
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Drive 1&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
multiline_comment|/*BA */
id|cmd_blk
(braket
l_int|0
)braket
op_assign
id|CMD_GET_DEV_CONFIG
op_or
(paren
l_int|1
op_lshift
l_int|5
)paren
op_or
l_int|0x600
suffix:semicolon
id|cmd_blk
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|no_int_yet
op_assign
id|TRUE
suffix:semicolon
id|ps2esdi_out_cmd_blk
c_func
(paren
id|cmd_blk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|no_int_yet
)paren
id|sleep_on
c_func
(paren
op_amp
id|ps2esdi_int
)paren
suffix:semicolon
)brace
multiline_comment|/* if second physical drive is present */
r_return
suffix:semicolon
)brace
multiline_comment|/* strategy routine that handles most of the IO requests */
DECL|function|do_ps2esdi_request
r_static
r_void
id|do_ps2esdi_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
id|u_int
id|block
comma
id|count
suffix:semicolon
multiline_comment|/* since, this routine is called with interrupts cleared - they &n;&t;   must be before it finishes  */
id|sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s:got request. device : %d minor : %d command : %d  sector : %ld count : %ld, buffer: %p&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|CURRENT_DEV
comma
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
comma
id|CURRENT-&gt;cmd
comma
id|CURRENT-&gt;sector
comma
id|CURRENT-&gt;nr_sectors
comma
id|CURRENT-&gt;buffer
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* standard macro that ensures that requests are really on the&n;&t;   list + sanity checks.                     */
id|INIT_REQUEST
suffix:semicolon
r_if
c_cond
(paren
id|virt_to_bus
c_func
(paren
id|CURRENT-&gt;buffer
op_plus
id|CURRENT-&gt;nr_sectors
op_star
l_int|512
)paren
OG
l_int|16
op_star
id|MB
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: DMA above 16MB not supported&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|FAIL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|QUEUE_EMPTY
)paren
id|do_ps2esdi_request
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* check for above 16Mb dmas */
r_if
c_cond
(paren
(paren
id|CURRENT_DEV
OL
id|ps2esdi_drives
)paren
op_logical_and
(paren
id|CURRENT-&gt;sector
op_plus
id|CURRENT-&gt;nr_sectors
op_le
id|ps2esdi
(braket
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
)braket
dot
id|nr_sects
)paren
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s:got request. device : %d minor : %d command : %d  sector : %ld count : %ld&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|CURRENT_DEV
comma
id|MINOR
c_func
(paren
id|CURRENT-&gt;dev
)paren
comma
id|CURRENT-&gt;cmd
comma
id|CURRENT-&gt;sector
comma
id|CURRENT-&gt;nr_sectors
)paren
suffix:semicolon
macro_line|#endif
id|block
op_assign
id|CURRENT-&gt;sector
op_plus
id|ps2esdi
(braket
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
)braket
dot
id|start_sect
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s: blocknumber : %d&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|block
)paren
suffix:semicolon
macro_line|#endif
id|count
op_assign
id|CURRENT-&gt;nr_sectors
suffix:semicolon
r_switch
c_cond
(paren
id|CURRENT-&gt;cmd
)paren
(brace
r_case
id|READ
suffix:colon
id|ps2esdi_readwrite
c_func
(paren
id|READ
comma
id|CURRENT_DEV
comma
id|block
comma
id|count
)paren
suffix:semicolon
r_return
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE
suffix:colon
id|ps2esdi_readwrite
c_func
(paren
id|WRITE
comma
id|CURRENT_DEV
comma
id|block
comma
id|count
)paren
suffix:semicolon
r_return
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Unknown command&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|FAIL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|QUEUE_EMPTY
)paren
id|do_ps2esdi_request
c_func
(paren
id|q
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* handle different commands */
)brace
multiline_comment|/* is request is valid */
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Grrr. error. ps2esdi_drives: %d, %lu %lu&bslash;n&quot;
comma
id|ps2esdi_drives
comma
id|CURRENT-&gt;sector
comma
id|ps2esdi
(braket
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
)braket
dot
id|nr_sects
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|FAIL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|QUEUE_EMPTY
)paren
id|do_ps2esdi_request
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* main strategy routine */
multiline_comment|/* resets the ESDI adapter */
DECL|function|reset_ctrl
r_static
r_void
id|reset_ctrl
c_func
(paren
r_void
)paren
(brace
id|u_long
id|expire
suffix:semicolon
id|u_short
id|status
suffix:semicolon
multiline_comment|/* enable interrupts on the controller */
id|status
op_assign
id|inb
c_func
(paren
id|ESDI_INTRPT
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|status
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
multiline_comment|/* to be sure we don&squot;t have&n;&t;&t;&t;&t;&t;&t;&t;   any interrupt pending... */
id|outb_p
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
multiline_comment|/* read the ESDI status port - if the controller is not busy,&n;&t;   simply do a soft reset (fast) - otherwise we&squot;ll have to do a&n;&t;   hard (slow) reset.  */
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb_p
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_BUSY
)paren
)paren
(brace
multiline_comment|/*BA */
id|printk
c_func
(paren
l_string|&quot;%s: soft reset...&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|CTRL_SOFT_RESET
comma
id|ESDI_ATTN
)paren
suffix:semicolon
)brace
multiline_comment|/* soft reset */
r_else
(brace
multiline_comment|/*BA */
id|printk
c_func
(paren
l_string|&quot;%s: hard reset...&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|CTRL_HARD_RESET
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
id|expire
op_assign
id|jiffies
op_plus
l_int|2
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|expire
)paren
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|1
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/* hard reset */
)brace
multiline_comment|/* reset the controller */
multiline_comment|/* called by the strategy routine to handle read and write requests */
DECL|function|ps2esdi_readwrite
r_static
r_void
id|ps2esdi_readwrite
c_func
(paren
r_int
id|cmd
comma
id|u_char
id|drive
comma
id|u_int
id|block
comma
id|u_int
id|count
)paren
(brace
id|u_short
id|track
comma
id|head
comma
id|cylinder
comma
id|sector
suffix:semicolon
id|u_short
id|cmd_blk
(braket
id|TYPE_1_CMD_BLK_LENGTH
)braket
suffix:semicolon
multiline_comment|/* do some relevant arithmatic */
id|CURRENT-&gt;current_nr_sectors
op_assign
(paren
id|count
OL
(paren
l_int|2
op_star
id|MAX_16BIT
op_div
id|SECT_SIZE
)paren
)paren
ques
c_cond
id|count
suffix:colon
(paren
l_int|2
op_star
id|MAX_16BIT
op_div
id|SECT_SIZE
)paren
suffix:semicolon
id|track
op_assign
id|block
op_div
id|ps2esdi_info
(braket
id|drive
)braket
dot
id|sect
suffix:semicolon
id|head
op_assign
id|track
op_mod
id|ps2esdi_info
(braket
id|drive
)braket
dot
id|head
suffix:semicolon
id|cylinder
op_assign
id|track
op_div
id|ps2esdi_info
(braket
id|drive
)braket
dot
id|head
suffix:semicolon
id|sector
op_assign
id|block
op_mod
id|ps2esdi_info
(braket
id|drive
)braket
dot
id|sect
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s: cyl=%d head=%d sect=%d&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|cylinder
comma
id|head
comma
id|sector
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* call the routine that actually fills out a command block */
id|ps2esdi_fill_cmd_block
(paren
id|cmd_blk
comma
(paren
id|cmd
op_eq
id|READ
)paren
ques
c_cond
id|CMD_READ
suffix:colon
id|CMD_WRITE
comma
id|cylinder
comma
id|head
comma
id|sector
comma
id|CURRENT-&gt;current_nr_sectors
comma
id|drive
)paren
suffix:semicolon
multiline_comment|/* send the command block to the controller */
r_if
c_cond
(paren
id|ps2esdi_out_cmd_blk
c_func
(paren
id|cmd_blk
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Controller failed&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_increment
id|CURRENT-&gt;errors
)paren
OL
id|MAX_RETRIES
)paren
r_return
id|do_ps2esdi_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_else
(brace
id|end_request
c_func
(paren
id|FAIL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|QUEUE_EMPTY
)paren
id|do_ps2esdi_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* check for failure to put out the command block */
r_else
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s: waiting for xfer&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* turn disk lights on */
id|LITE_ON
suffix:semicolon
)brace
)brace
multiline_comment|/* ps2esdi_readwrite */
multiline_comment|/* fill out the command block */
DECL|function|ps2esdi_fill_cmd_block
r_static
r_void
id|ps2esdi_fill_cmd_block
c_func
(paren
id|u_short
op_star
id|cmd_blk
comma
id|u_short
id|cmd
comma
id|u_short
id|cyl
comma
id|u_short
id|head
comma
id|u_short
id|sector
comma
id|u_short
id|length
comma
id|u_char
id|drive
)paren
(brace
id|cmd_blk
(braket
l_int|0
)braket
op_assign
(paren
id|drive
op_lshift
l_int|5
)paren
op_or
id|cmd
suffix:semicolon
id|cmd_blk
(braket
l_int|1
)braket
op_assign
id|length
suffix:semicolon
id|cmd_blk
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|cyl
op_amp
l_int|0x1f
)paren
op_lshift
l_int|11
)paren
op_or
(paren
id|head
op_lshift
l_int|5
)paren
op_or
id|sector
suffix:semicolon
id|cmd_blk
(braket
l_int|3
)braket
op_assign
(paren
id|cyl
op_amp
l_int|0x3E0
)paren
op_rshift
l_int|5
suffix:semicolon
)brace
multiline_comment|/* fill out the command block */
multiline_comment|/* write a command block to the controller */
DECL|function|ps2esdi_out_cmd_blk
r_static
r_int
id|ps2esdi_out_cmd_blk
c_func
(paren
id|u_short
op_star
id|cmd_blk
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|u_char
id|status
suffix:semicolon
multiline_comment|/* enable interrupts */
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
multiline_comment|/* do not write to the controller, if it is busy */
r_for
c_loop
(paren
id|i
op_assign
id|jiffies
op_plus
id|ESDI_STAT_TIMEOUT
suffix:semicolon
id|time_after
c_func
(paren
id|i
comma
id|jiffies
)paren
op_logical_and
(paren
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_BUSY
)paren
suffix:semicolon
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s: i(1)=%d&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* if device is still busy - then just time out */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_BUSY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: ps2esdi_out_cmd timed out (1)&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
r_return
id|ERROR
suffix:semicolon
)brace
multiline_comment|/* timeout ??? */
multiline_comment|/* Set up the attention register in the controller */
id|outb
c_func
(paren
(paren
(paren
op_star
id|cmd_blk
)paren
op_amp
l_int|0xE0
)paren
op_or
l_int|1
comma
id|ESDI_ATTN
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s: sending %d words to controller&bslash;n&quot;
comma
id|DEVICE_NAME
comma
(paren
(paren
(paren
op_star
id|cmd_blk
)paren
op_rshift
l_int|14
)paren
op_plus
l_int|1
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* one by one send each word out */
r_for
c_loop
(paren
id|i
op_assign
(paren
(paren
(paren
op_star
id|cmd_blk
)paren
op_rshift
l_int|14
)paren
op_plus
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|status
op_assign
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|jiffies
op_plus
id|ESDI_STAT_TIMEOUT
suffix:semicolon
id|time_after
c_func
(paren
id|j
comma
id|jiffies
)paren
op_logical_and
(paren
id|status
op_amp
id|STATUS_BUSY
)paren
op_logical_and
(paren
id|status
op_amp
id|STATUS_CMD_INF
)paren
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|STATUS_BUSY
op_or
id|STATUS_CMD_INF
)paren
)paren
op_eq
id|STATUS_BUSY
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%s: sending %04X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
op_star
id|cmd_blk
)paren
suffix:semicolon
macro_line|#endif
id|outw
c_func
(paren
op_star
id|cmd_blk
op_increment
comma
id|ESDI_CMD_INT
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: ps2esdi_out_cmd timed out while sending command (status=%02X)&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|status
)paren
suffix:semicolon
r_return
id|ERROR
suffix:semicolon
)brace
)brace
multiline_comment|/* send all words out */
r_return
id|OK
suffix:semicolon
)brace
multiline_comment|/* send out the commands */
multiline_comment|/* prepare for dma - do all the necessary setup */
DECL|function|ps2esdi_prep_dma
r_static
r_void
id|ps2esdi_prep_dma
c_func
(paren
r_char
op_star
id|buffer
comma
id|u_short
id|length
comma
id|u_char
id|dma_xmode
)paren
(brace
id|u_int
id|tc
suffix:semicolon
id|buffer
op_assign
(paren
r_char
op_star
)paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;ps2esdi: b_wait: %p&bslash;n&quot;
comma
id|CURRENT-&gt;bh-&gt;b_wait
)paren
suffix:semicolon
macro_line|#endif
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dma_arb_level
op_or
id|DMA_MASK_CHAN
comma
id|PORT_DMA_FN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dma_arb_level
op_or
id|DMA_WRITE_ADDR
comma
id|PORT_DMA_FN
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|u_int
)paren
id|buffer
op_amp
(paren
id|u_int
)paren
l_int|0xff
comma
id|PORT_DMA_EX
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|u_int
)paren
id|buffer
op_rshift
l_int|8
)paren
op_amp
(paren
id|u_int
)paren
l_int|0xff
comma
id|PORT_DMA_EX
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
id|u_int
)paren
id|buffer
op_rshift
l_int|16
)paren
op_amp
(paren
id|u_int
)paren
l_int|0xff
comma
id|PORT_DMA_EX
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dma_arb_level
op_or
id|DMA_WRITE_TC
comma
id|PORT_DMA_FN
)paren
suffix:semicolon
id|tc
op_assign
(paren
id|length
op_star
id|SECT_SIZE
op_div
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|tc
op_amp
l_int|0xff
comma
id|PORT_DMA_EX
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tc
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|PORT_DMA_EX
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dma_arb_level
op_or
id|DMA_WRITE_MODE
comma
id|PORT_DMA_FN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dma_xmode
comma
id|PORT_DMA_EX
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dma_arb_level
op_or
id|DMA_UNMASK_CHAN
comma
id|PORT_DMA_FN
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* prepare for dma */
DECL|function|ps2esdi_interrupt_handler
r_static
r_void
id|ps2esdi_interrupt_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u_int
id|int_ret_code
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_INTR
)paren
(brace
id|int_ret_code
op_assign
id|inb
c_func
(paren
id|ESDI_INTRPT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_int_handler
)paren
(brace
multiline_comment|/* Disable adapter interrupts till processing is finished */
id|outb
c_func
(paren
id|CTRL_DISABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
id|current_int_handler
c_func
(paren
id|int_ret_code
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: help ! No interrupt handler.&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
suffix:semicolon
)brace
)brace
DECL|function|ps2esdi_initial_reset_int_handler
r_static
r_void
id|ps2esdi_initial_reset_int_handler
c_func
(paren
id|u_int
id|int_ret_code
)paren
(brace
r_switch
c_cond
(paren
id|int_ret_code
op_amp
l_int|0xf
)paren
(brace
r_case
id|INT_RESET
suffix:colon
multiline_comment|/*BA */
id|printk
c_func
(paren
l_string|&quot;%s: initial reset completed.&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|ps2esdi_int
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_ATTN_ERROR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Attention error. interrupt status : %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|int_ret_code
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: status: %02x&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: initial reset handler received interrupt: %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|int_ret_code
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|ps2esdi_geometry_int_handler
r_static
r_void
id|ps2esdi_geometry_int_handler
c_func
(paren
id|u_int
id|int_ret_code
)paren
(brace
id|u_int
id|status
comma
id|drive_num
suffix:semicolon
r_int
r_int
id|rba
suffix:semicolon
r_int
id|i
suffix:semicolon
id|drive_num
op_assign
id|int_ret_code
op_rshift
l_int|5
suffix:semicolon
r_switch
c_cond
(paren
id|int_ret_code
op_amp
l_int|0xf
)paren
(brace
r_case
id|INT_CMD_COMPLETE
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
id|ESDI_TIMEOUT
suffix:semicolon
id|i
op_amp
op_logical_neg
(paren
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_STAT_AVAIL
)paren
suffix:semicolon
id|i
op_decrement
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_STAT_AVAIL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: timeout reading status word&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|status
op_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x1F
)paren
op_eq
id|CMD_GET_DEV_CONFIG
)paren
(brace
DECL|macro|REPLY_WORDS
mdefine_line|#define REPLY_WORDS 5&t;&t;/* we already read word 0 */
id|u_short
id|reply
(braket
id|REPLY_WORDS
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ps2esdi_read_status_words
c_func
(paren
(paren
id|status
op_rshift
l_int|8
)paren
op_minus
l_int|1
comma
id|REPLY_WORDS
comma
id|reply
)paren
)paren
(brace
multiline_comment|/*BA */
id|printk
c_func
(paren
l_string|&quot;%s: Device Configuration Status for drive %u&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|drive_num
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Spares/cyls: %u&quot;
comma
id|DEVICE_NAME
comma
id|reply
(braket
l_int|0
)braket
op_rshift
l_int|8
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Config bits: %s%s%s%s%s&bslash;n&quot;
comma
(paren
id|reply
(braket
l_int|0
)braket
op_amp
id|CONFIG_IS
)paren
ques
c_cond
l_string|&quot;Invalid Secondary, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
(paren
id|reply
(braket
l_int|0
)braket
op_amp
id|CONFIG_ZD
)paren
op_logical_and
op_logical_neg
(paren
id|reply
(braket
l_int|0
)braket
op_amp
id|CONFIG_IS
)paren
)paren
ques
c_cond
l_string|&quot;Zero Defect, &quot;
suffix:colon
l_string|&quot;Defects Present, &quot;
comma
(paren
id|reply
(braket
l_int|0
)braket
op_amp
id|CONFIG_SF
)paren
ques
c_cond
l_string|&quot;Skewed Format, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|reply
(braket
l_int|0
)braket
op_amp
id|CONFIG_FR
)paren
ques
c_cond
l_string|&quot;Removable, &quot;
suffix:colon
l_string|&quot;Non-Removable, &quot;
comma
(paren
id|reply
(braket
l_int|0
)braket
op_amp
id|CONFIG_RT
)paren
ques
c_cond
l_string|&quot;No Retries&quot;
suffix:colon
l_string|&quot;Retries&quot;
)paren
suffix:semicolon
id|rba
op_assign
id|reply
(braket
l_int|1
)braket
op_or
(paren
(paren
r_int
r_int
)paren
id|reply
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Number of RBA&squot;s: %lu&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|rba
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Physical number of cylinders: %u, Sectors/Track: %u, Heads: %u&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|reply
(braket
l_int|3
)braket
comma
id|reply
(braket
l_int|4
)braket
op_rshift
l_int|8
comma
id|reply
(braket
l_int|4
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|head
)paren
(brace
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|head
op_assign
l_int|64
suffix:semicolon
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|sect
op_assign
l_int|32
suffix:semicolon
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|cyl
op_assign
id|rba
op_div
(paren
l_int|64
op_star
l_int|32
)paren
suffix:semicolon
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|wpcom
op_assign
l_int|0
suffix:semicolon
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|lzone
op_assign
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|cyl
suffix:semicolon
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|ctl
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|tp720esdi
)paren
(brace
multiline_comment|/* store the retrieved parameters */
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|head
op_assign
id|reply
(braket
l_int|4
)braket
op_amp
l_int|0Xff
suffix:semicolon
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|sect
op_assign
id|reply
(braket
l_int|4
)braket
op_rshift
l_int|8
suffix:semicolon
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|cyl
op_assign
id|reply
(braket
l_int|3
)braket
suffix:semicolon
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|wpcom
op_assign
l_int|0
suffix:semicolon
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|lzone
op_assign
id|reply
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|intg_esdi
)paren
id|ps2esdi_drives
op_increment
suffix:semicolon
)brace
)brace
macro_line|#ifdef OBSOLETE
r_if
c_cond
(paren
op_logical_neg
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|head
)paren
(brace
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|head
op_assign
id|reply
(braket
l_int|4
)braket
op_amp
l_int|0Xff
suffix:semicolon
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|sect
op_assign
id|reply
(braket
l_int|4
)braket
op_rshift
l_int|8
suffix:semicolon
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|cyl
op_assign
id|reply
(braket
l_int|3
)braket
suffix:semicolon
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|wpcom
op_assign
l_int|0
suffix:semicolon
id|ps2esdi_info
(braket
id|drive_num
)braket
dot
id|lzone
op_assign
id|reply
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tp720esdi
)paren
(brace
multiline_comment|/* store the retrieved parameters */
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|head
op_assign
id|reply
(braket
l_int|4
)braket
op_amp
l_int|0Xff
suffix:semicolon
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|sect
op_assign
id|reply
(braket
l_int|4
)braket
op_rshift
l_int|8
suffix:semicolon
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|cyl
op_assign
id|reply
(braket
l_int|3
)braket
suffix:semicolon
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|wpcom
op_assign
l_int|0
suffix:semicolon
id|ps2esdi_info
(braket
l_int|0
)braket
dot
id|lzone
op_assign
id|reply
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_else
(brace
id|ps2esdi_drives
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: failed while getting device config&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
DECL|macro|REPLY_WORDS
macro_line|#undef REPLY_WORDS
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%s: command %02X unknown by geometry handler&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|status
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_ATTN_ERROR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Attention error. interrupt status : %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|int_ret_code
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Device not available&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_CMD_ECC
suffix:colon
r_case
id|INT_CMD_RETRY
suffix:colon
r_case
id|INT_CMD_ECC_RETRY
suffix:colon
r_case
id|INT_CMD_WARNING
suffix:colon
r_case
id|INT_CMD_ABORT
suffix:colon
r_case
id|INT_CMD_FAILED
suffix:colon
r_case
id|INT_DMA_ERR
suffix:colon
r_case
id|INT_CMD_BLK_ERR
suffix:colon
multiline_comment|/*BA */
id|printk
c_func
(paren
l_string|&quot;%s: Whaa. Error occurred...&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|dump_cmd_complete_status
c_func
(paren
id|int_ret_code
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Unknown interrupt reason: %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|int_ret_code
op_amp
l_int|0xf
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|wake_up
c_func
(paren
op_amp
id|ps2esdi_int
)paren
suffix:semicolon
id|no_int_yet
op_assign
id|FALSE
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|ps2esdi_normal_interrupt_handler
r_static
r_void
id|ps2esdi_normal_interrupt_handler
c_func
(paren
id|u_int
id|int_ret_code
)paren
(brace
id|u_int
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|int_ret_code
op_amp
l_int|0x0f
)paren
(brace
r_case
id|INT_TRANSFER_REQ
suffix:colon
id|ps2esdi_prep_dma
c_func
(paren
id|CURRENT-&gt;buffer
comma
id|CURRENT-&gt;current_nr_sectors
comma
(paren
id|CURRENT-&gt;cmd
op_eq
id|READ
)paren
ques
c_cond
id|DMA_READ_16
suffix:colon
id|DMA_WRITE_16
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_DMA
op_or
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_ATTN_ERROR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Attention error. interrupt status : %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|int_ret_code
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_CMD_COMPLETE
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
id|ESDI_TIMEOUT
suffix:semicolon
id|i
op_amp
op_logical_neg
(paren
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_STAT_AVAIL
)paren
suffix:semicolon
id|i
op_decrement
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_STAT_AVAIL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: timeout reading status word&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_increment
id|CURRENT-&gt;errors
)paren
OL
id|MAX_RETRIES
)paren
id|do_ps2esdi_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_else
(brace
id|end_request
c_func
(paren
id|FAIL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|QUEUE_EMPTY
)paren
id|do_ps2esdi_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|status
op_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
op_amp
l_int|0x1F
)paren
(brace
r_case
(paren
id|CMD_READ
op_amp
l_int|0xff
)paren
suffix:colon
r_case
(paren
id|CMD_WRITE
op_amp
l_int|0xff
)paren
suffix:colon
id|LITE_OFF
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;ps2esdi: cmd_complete b_wait: %p&bslash;n&quot;
comma
id|CURRENT-&gt;bh-&gt;b_wait
)paren
suffix:semicolon
macro_line|#endif
id|ps2esdi_continue_request
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: interrupt for unknown command %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|status
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|INT_CMD_ECC
suffix:colon
r_case
id|INT_CMD_RETRY
suffix:colon
r_case
id|INT_CMD_ECC_RETRY
suffix:colon
id|LITE_OFF
suffix:semicolon
id|dump_cmd_complete_status
c_func
(paren
id|int_ret_code
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
id|ps2esdi_continue_request
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_CMD_WARNING
suffix:colon
r_case
id|INT_CMD_ABORT
suffix:colon
r_case
id|INT_CMD_FAILED
suffix:colon
r_case
id|INT_DMA_ERR
suffix:colon
id|LITE_OFF
suffix:semicolon
id|dump_cmd_complete_status
c_func
(paren
id|int_ret_code
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_increment
id|CURRENT-&gt;errors
)paren
OL
id|MAX_RETRIES
)paren
id|do_ps2esdi_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_else
(brace
id|end_request
c_func
(paren
id|FAIL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|QUEUE_EMPTY
)paren
id|do_ps2esdi_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|INT_CMD_BLK_ERR
suffix:colon
id|dump_cmd_complete_status
c_func
(paren
id|int_ret_code
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|FAIL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|QUEUE_EMPTY
)paren
id|do_ps2esdi_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_CMD_FORMAT
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: huh ? Who issued this format command ?&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_RESET
suffix:colon
multiline_comment|/* BA printk(&quot;%s: reset completed.&bslash;n&quot;, DEVICE_NAME) */
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: Unknown interrupt reason: %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|int_ret_code
op_amp
l_int|0xf
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|int_ret_code
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* handle interrupts */
DECL|function|ps2esdi_continue_request
r_static
r_void
id|ps2esdi_continue_request
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|CURRENT-&gt;nr_sectors
op_sub_assign
id|CURRENT-&gt;current_nr_sectors
)paren
(brace
id|CURRENT-&gt;buffer
op_add_assign
id|CURRENT-&gt;current_nr_sectors
op_star
id|SECT_SIZE
suffix:semicolon
id|CURRENT-&gt;sector
op_add_assign
id|CURRENT-&gt;current_nr_sectors
suffix:semicolon
id|do_ps2esdi_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|end_request
c_func
(paren
id|SUCCES
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|QUEUE_EMPTY
)paren
id|do_ps2esdi_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
DECL|function|ps2esdi_read_status_words
r_static
r_int
id|ps2esdi_read_status_words
c_func
(paren
r_int
id|num_words
comma
r_int
id|max_words
comma
id|u_short
op_star
id|buffer
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|max_words
op_logical_and
id|num_words
suffix:semicolon
id|max_words
op_decrement
comma
id|num_words
op_decrement
comma
id|buffer
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
id|ESDI_TIMEOUT
suffix:semicolon
id|i
op_logical_and
op_logical_neg
(paren
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_STAT_AVAIL
)paren
suffix:semicolon
id|i
op_decrement
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|ESDI_STATUS
)paren
op_amp
id|STATUS_STAT_AVAIL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: timeout reading status word&bslash;n&quot;
comma
id|DEVICE_NAME
)paren
suffix:semicolon
r_return
id|FAIL
suffix:semicolon
)brace
op_star
id|buffer
op_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
suffix:semicolon
)brace
r_return
id|SUCCES
suffix:semicolon
)brace
DECL|function|dump_cmd_complete_status
r_static
r_void
id|dump_cmd_complete_status
c_func
(paren
id|u_int
id|int_ret_code
)paren
(brace
DECL|macro|WAIT_FOR_STATUS
mdefine_line|#define WAIT_FOR_STATUS &bslash;&n;  for(i=ESDI_TIMEOUT;i &amp;&amp; !(inb(ESDI_STATUS) &amp; STATUS_STAT_AVAIL);i--); &bslash;&n;    if(!(inb(ESDI_STATUS) &amp; STATUS_STAT_AVAIL)) { &bslash;&n;    printk(&quot;%s: timeout reading status word&bslash;n&quot;,DEVICE_NAME); &bslash;&n;    return; &bslash;&n;    }
r_int
id|i
comma
id|word_count
suffix:semicolon
id|u_short
id|stat_word
suffix:semicolon
id|u_long
id|rba
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Device: %u, interrupt ID: %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|int_ret_code
op_rshift
l_int|5
comma
id|int_ret_code
op_amp
l_int|0xf
)paren
suffix:semicolon
id|WAIT_FOR_STATUS
suffix:semicolon
id|stat_word
op_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
suffix:semicolon
id|word_count
op_assign
(paren
id|stat_word
op_rshift
l_int|8
)paren
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %u status words, command: %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|word_count
comma
id|stat_word
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|word_count
op_decrement
)paren
(brace
id|WAIT_FOR_STATUS
suffix:semicolon
id|stat_word
op_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: command status code: %02X, command error code: %02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
id|stat_word
op_rshift
l_int|8
comma
id|stat_word
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|word_count
op_decrement
)paren
(brace
id|WAIT_FOR_STATUS
suffix:semicolon
id|stat_word
op_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: device error code: %s%s%s%s%s,%02X&bslash;n&quot;
comma
id|DEVICE_NAME
comma
(paren
id|stat_word
op_amp
l_int|0x1000
)paren
ques
c_cond
l_string|&quot;Ready, &quot;
suffix:colon
l_string|&quot;Not Ready, &quot;
comma
(paren
id|stat_word
op_amp
l_int|0x0800
)paren
ques
c_cond
l_string|&quot;Selected, &quot;
suffix:colon
l_string|&quot;Not Selected, &quot;
comma
(paren
id|stat_word
op_amp
l_int|0x0400
)paren
ques
c_cond
l_string|&quot;Write Fault, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_word
op_amp
l_int|0x0200
)paren
ques
c_cond
l_string|&quot;Track 0, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|stat_word
op_amp
l_int|0x0100
)paren
ques
c_cond
l_string|&quot;Seek or command complete, &quot;
suffix:colon
l_string|&quot;&quot;
comma
id|stat_word
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|word_count
op_decrement
)paren
(brace
id|WAIT_FOR_STATUS
suffix:semicolon
id|stat_word
op_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Blocks to do: %u&quot;
comma
id|DEVICE_NAME
comma
id|stat_word
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|word_count
op_sub_assign
l_int|2
)paren
(brace
id|WAIT_FOR_STATUS
suffix:semicolon
id|rba
op_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
suffix:semicolon
id|WAIT_FOR_STATUS
suffix:semicolon
id|rba
op_or_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
op_lshift
l_int|16
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;, Last Cyl: %u Head: %u Sector: %u&bslash;n&quot;
comma
(paren
id|u_short
)paren
(paren
(paren
id|rba
op_amp
l_int|0x1ff80000
)paren
op_rshift
l_int|11
)paren
comma
(paren
id|u_short
)paren
(paren
(paren
id|rba
op_amp
l_int|0x7E0
)paren
op_rshift
l_int|5
)paren
comma
(paren
id|u_short
)paren
(paren
id|rba
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|word_count
op_decrement
)paren
(brace
id|WAIT_FOR_STATUS
suffix:semicolon
id|stat_word
op_assign
id|inw
c_func
(paren
id|ESDI_STT_INT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Blocks required ECC: %u&quot;
comma
id|DEVICE_NAME
comma
id|stat_word
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
DECL|macro|WAIT_FOR_STATUS
macro_line|#undef WAIT_FOR_STATUS
)brace
DECL|function|ps2esdi_open
r_static
r_int
id|ps2esdi_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|dev
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
id|ps2esdi_drives
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|ps2esdi_valid
(braket
id|dev
)braket
)paren
id|sleep_on
c_func
(paren
op_amp
id|ps2esdi_wait_open
)paren
suffix:semicolon
id|access_count
(braket
id|dev
)braket
op_increment
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_return
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
DECL|function|ps2esdi_release
r_static
r_int
id|ps2esdi_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|dev
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
id|ps2esdi_drives
)paren
(brace
id|access_count
(braket
id|dev
)braket
op_decrement
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ps2esdi_ioctl
r_static
r_int
id|ps2esdi_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
)paren
(brace
r_struct
id|ps2esdi_geometry
op_star
id|geometry
op_assign
(paren
r_struct
id|ps2esdi_geometry
op_star
)paren
id|arg
suffix:semicolon
r_int
id|dev
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|inode
op_logical_and
(paren
id|dev
OL
id|ps2esdi_drives
)paren
)paren
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|HDIO_GETGEO
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|geometry
comma
r_sizeof
(paren
op_star
id|geometry
)paren
)paren
)paren
)paren
r_return
(paren
id|err
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|ps2esdi_info
(braket
id|dev
)braket
dot
id|head
comma
(paren
r_char
op_star
)paren
op_amp
id|geometry-&gt;heads
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|ps2esdi_info
(braket
id|dev
)braket
dot
id|sect
comma
(paren
r_char
op_star
)paren
op_amp
id|geometry-&gt;sectors
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|ps2esdi_info
(braket
id|dev
)braket
dot
id|cyl
comma
(paren
r_int
op_star
)paren
op_amp
id|geometry-&gt;cylinders
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|ps2esdi
(braket
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
dot
id|start_sect
comma
(paren
r_int
op_star
)paren
op_amp
id|geometry-&gt;start
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BLKGETSIZE
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
)paren
r_return
(paren
id|err
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|ps2esdi
(braket
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
dot
id|nr_sects
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BLKRRPART
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_return
(paren
id|ps2esdi_reread_partitions
c_func
(paren
id|inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
r_case
id|BLKROSET
suffix:colon
r_case
id|BLKROGET
suffix:colon
r_case
id|BLKRASET
suffix:colon
r_case
id|BLKRAGET
suffix:colon
r_case
id|BLKFLSBUF
suffix:colon
r_case
id|BLKPG
suffix:colon
r_return
id|blk_ioctl
c_func
(paren
id|inode-&gt;i_rdev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
DECL|function|ps2esdi_reread_partitions
r_static
r_int
id|ps2esdi_reread_partitions
c_func
(paren
id|kdev_t
id|dev
)paren
(brace
r_int
id|target
op_assign
id|DEVICE_NR
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|start
op_assign
id|target
op_lshift
id|ps2esdi_gendisk.minor_shift
suffix:semicolon
r_int
id|partition
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ps2esdi_valid
(braket
id|target
)braket
op_assign
(paren
id|access_count
(braket
id|target
)braket
op_ne
l_int|1
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ps2esdi_valid
(braket
id|target
)braket
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_for
c_loop
(paren
id|partition
op_assign
id|ps2esdi_gendisk.max_p
op_minus
l_int|1
suffix:semicolon
id|partition
op_ge
l_int|0
suffix:semicolon
id|partition
op_decrement
)paren
(brace
r_int
id|minor
op_assign
(paren
id|start
op_or
id|partition
)paren
suffix:semicolon
id|kdev_t
id|devp
op_assign
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|minor
)paren
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
op_assign
id|get_super
c_func
(paren
id|devp
)paren
suffix:semicolon
id|sync_dev
c_func
(paren
id|devp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb
)paren
id|invalidate_inodes
c_func
(paren
id|sb
)paren
suffix:semicolon
id|invalidate_buffers
c_func
(paren
id|devp
)paren
suffix:semicolon
id|ps2esdi_gendisk.part
(braket
id|start
op_plus
id|partition
)braket
dot
id|start_sect
op_assign
l_int|0
suffix:semicolon
id|ps2esdi_gendisk.part
(braket
id|start
op_plus
id|partition
)braket
dot
id|nr_sects
op_assign
l_int|0
suffix:semicolon
)brace
id|grok_partitions
c_func
(paren
op_amp
id|ps2esdi_gendisk
comma
id|target
comma
l_int|1
op_lshift
l_int|6
comma
id|ps2esdi_info
(braket
id|target
)braket
dot
id|head
op_star
id|ps2esdi_info
(braket
id|target
)braket
dot
id|cyl
op_star
id|ps2esdi_info
(braket
id|target
)braket
dot
id|sect
)paren
suffix:semicolon
id|ps2esdi_valid
(braket
id|target
)braket
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|ps2esdi_wait_open
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|ps2esdi_reset_timer
r_void
id|ps2esdi_reset_timer
c_func
(paren
r_int
r_int
id|unused
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|ESDI_INTRPT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xf
)paren
op_eq
id|INT_RESET
)paren
(brace
id|outb
c_func
(paren
(paren
id|status
op_amp
l_int|0xe0
)paren
op_or
id|ATT_EOI
comma
id|ESDI_ATTN
)paren
suffix:semicolon
id|outb
c_func
(paren
id|CTRL_ENABLE_INTR
comma
id|ESDI_CONTROL
)paren
suffix:semicolon
id|reset_status
op_assign
l_int|1
suffix:semicolon
)brace
id|wake_up
c_func
(paren
op_amp
id|ps2esdi_int
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
