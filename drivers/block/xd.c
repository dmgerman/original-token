multiline_comment|/*&n; * This file contains the driver for an XT hard disk controller&n; * (at least the DTC 5150X) for Linux.&n; *&n; * Author: Pat Mackinlay, pat@it.com.au&n; * Date: 29/09/92&n; * &n; * Revised: 01/01/93, ...&n; *&n; * Ref: DTC 5150X Controller Specification (thanks to Kevin Fowler,&n; *   kevinf@agora.rain.com)&n; * Also thanks to: Salvador Abreu, Dave Thaler, Risto Kankkunen and&n; *   Wim Van Dorst.&n; *&n; * Revised: 04/04/94 by Risto Kankkunen&n; *   Moved the detection code from xd_init() to xd_geninit() as it needed&n; *   interrupts enabled and Linus didn&squot;t want to enable them in that first&n; *   phase. xd_geninit() is the place to do these kinds of things anyway,&n; *   he says.&n; *&n; * Modularized: 04/10/96 by Todd Fries, tfries@umr.edu&n; *&n; * Revised: 13/12/97 by Andrzej Krzysztofowicz, ankry@mif.pg.gda.pl&n; *   Fixed some problems with disk initialization and module initiation.&n; *   Added support for manual geometry setting (except Seagate controllers)&n; *   in form:&n; *      xd_geo=&lt;cyl_xda&gt;,&lt;head_xda&gt;,&lt;sec_xda&gt;[,&lt;cyl_xdb&gt;,&lt;head_xdb&gt;,&lt;sec_xdb&gt;]&n; *   Recovered DMA access. Abridged messages. Added support for DTC5051CX,&n; *   WD1002-27X &amp; XEBEC controllers. Driver uses now some jumper settings.&n; *   Extended ioctl() support.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR XT_DISK_MAJOR
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &quot;xd.h&quot;
DECL|macro|XD_DONT_USE_DMA
mdefine_line|#define XD_DONT_USE_DMA&t;&t;0  /* Initial value. may be overriden using&n;&t;&t;&t;&t;      &quot;nodma&quot; module option */
DECL|macro|XD_INIT_DISK_DELAY
mdefine_line|#define XD_INIT_DISK_DELAY&t;(30*HZ/1000)  /* 30 ms delay during disk initialization */
multiline_comment|/* Above may need to be increased if a problem with the 2nd drive detection&n;   (ST11M controller) or resetting a controler (WD) appears */
DECL|variable|xd_info
id|XD_INFO
id|xd_info
(braket
id|XD_MAXDRIVES
)braket
suffix:semicolon
multiline_comment|/* If you try this driver and find that your card is not detected by the driver at bootup, you need to add your BIOS&n;   signature and details to the following list of signatures. A BIOS signature is a string embedded into the first&n;   few bytes of your controller&squot;s on-board ROM BIOS. To find out what yours is, use something like MS-DOS&squot;s DEBUG&n;   command. Run DEBUG, and then you can examine your BIOS signature with:&n;&n;&t;d xxxx:0000&n;&n;   where xxxx is the segment of your controller (like C800 or D000 or something). On the ASCII dump at the right, you should&n;   be able to see a string mentioning the manufacturer&squot;s copyright etc. Add this string into the table below. The parameters&n;   in the table are, in order:&n;&n;&t;offset&t;&t;&t;; this is the offset (in bytes) from the start of your ROM where the signature starts&n;&t;signature&t;&t;; this is the actual text of the signature&n;&t;xd_?_init_controller&t;; this is the controller init routine used by your controller&n;&t;xd_?_init_drive&t;&t;; this is the drive init routine used by your controller&n;&n;   The controllers directly supported at the moment are: DTC 5150x, WD 1004A27X, ST11M/R and override. If your controller is&n;   made by the same manufacturer as one of these, try using the same init routines as they do. If that doesn&squot;t work, your&n;   best bet is to use the &quot;override&quot; routines. These routines use a &quot;portable&quot; method of getting the disk&squot;s geometry, and&n;   may work with your card. If none of these seem to work, try sending me some email and I&squot;ll see what I can do &lt;grin&gt;.&n;&n;   NOTE: You can now specify your XT controller&squot;s parameters from the command line in the form xd=TYPE,IRQ,IO,DMA. The driver&n;   should be able to detect your drive&squot;s geometry from this info. (eg: xd=0,5,0x320,3 is the &quot;standard&quot;). */
macro_line|#include &lt;asm/page.h&gt;
DECL|macro|xd_dma_mem_alloc
mdefine_line|#define xd_dma_mem_alloc(size) __get_dma_pages(GFP_KERNEL,get_order(size))
DECL|macro|xd_dma_mem_free
mdefine_line|#define xd_dma_mem_free(addr, size) free_pages(addr, get_order(size))
DECL|variable|xd_dma_buffer
r_static
r_char
op_star
id|xd_dma_buffer
op_assign
l_int|0
suffix:semicolon
DECL|variable|__initdata
r_static
id|XD_SIGNATURE
id|xd_sigs
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|0x0000
comma
l_string|&quot;Override geometry handler&quot;
comma
l_int|NULL
comma
id|xd_override_init_drive
comma
l_string|&quot;n unknown&quot;
)brace
comma
multiline_comment|/* Pat Mackinlay, pat@it.com.au */
(brace
l_int|0x0008
comma
l_string|&quot;[BXD06 (C) DTC 17-MAY-1985]&quot;
comma
id|xd_dtc_init_controller
comma
id|xd_dtc5150cx_init_drive
comma
l_string|&quot; DTC 5150CX&quot;
)brace
comma
multiline_comment|/* Andrzej Krzysztofowicz, ankry@mif.pg.gda.pl */
(brace
l_int|0x000B
comma
l_string|&quot;CRD18A   Not an IBM rom. (C) Copyright Data Technology Corp. 05/31/88&quot;
comma
id|xd_dtc_init_controller
comma
id|xd_dtc_init_drive
comma
l_string|&quot; DTC 5150X&quot;
)brace
comma
multiline_comment|/* Todd Fries, tfries@umr.edu */
(brace
l_int|0x000B
comma
l_string|&quot;CXD23A Not an IBM ROM (C)Copyright Data Technology Corp 12/03/88&quot;
comma
id|xd_dtc_init_controller
comma
id|xd_dtc_init_drive
comma
l_string|&quot; DTC 5150X&quot;
)brace
comma
multiline_comment|/* Pat Mackinlay, pat@it.com.au */
(brace
l_int|0x0008
comma
l_string|&quot;07/15/86(C) Copyright 1986 Western Digital Corp.&quot;
comma
id|xd_wd_init_controller
comma
id|xd_wd_init_drive
comma
l_string|&quot; Western Dig. 1002-27X&quot;
)brace
comma
multiline_comment|/* Andrzej Krzysztofowicz, ankry@mif.pg.gda.pl */
(brace
l_int|0x0008
comma
l_string|&quot;06/24/88(C) Copyright 1988 Western Digital Corp.&quot;
comma
id|xd_wd_init_controller
comma
id|xd_wd_init_drive
comma
l_string|&quot; Western Dig. WDXT-GEN2&quot;
)brace
comma
multiline_comment|/* Dan Newcombe, newcombe@aa.csc.peachnet.edu */
(brace
l_int|0x0015
comma
l_string|&quot;SEAGATE ST11 BIOS REVISION&quot;
comma
id|xd_seagate_init_controller
comma
id|xd_seagate_init_drive
comma
l_string|&quot; Seagate ST11M/R&quot;
)brace
comma
multiline_comment|/* Salvador Abreu, spa@fct.unl.pt */
(brace
l_int|0x0010
comma
l_string|&quot;ST11R BIOS&quot;
comma
id|xd_seagate_init_controller
comma
id|xd_seagate_init_drive
comma
l_string|&quot; Seagate ST11M/R&quot;
)brace
comma
multiline_comment|/* Risto Kankkunen, risto.kankkunen@cs.helsinki.fi */
(brace
l_int|0x0010
comma
l_string|&quot;ST11 BIOS v1.7&quot;
comma
id|xd_seagate_init_controller
comma
id|xd_seagate_init_drive
comma
l_string|&quot; Seagate ST11R&quot;
)brace
comma
multiline_comment|/* Alan Hourihane, alanh@fairlite.demon.co.uk */
(brace
l_int|0x1000
comma
l_string|&quot;(c)Copyright 1987 SMS&quot;
comma
id|xd_omti_init_controller
comma
id|xd_omti_init_drive
comma
l_string|&quot;n OMTI 5520&quot;
)brace
comma
multiline_comment|/* Dirk Melchers, dirk@merlin.nbg.sub.org */
(brace
l_int|0x0006
comma
l_string|&quot;COPYRIGHT XEBEC (C) 1984&quot;
comma
id|xd_xebec_init_controller
comma
id|xd_xebec_init_drive
comma
l_string|&quot; XEBEC&quot;
)brace
comma
multiline_comment|/* Andrzej Krzysztofowicz, ankry@mif.pg.gda.pl */
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|xd_bases
(braket
)braket
id|__initdata
op_assign
(brace
l_int|0xC8000
comma
l_int|0xCA000
comma
l_int|0xCC000
comma
l_int|0xCE000
comma
l_int|0xD0000
comma
l_int|0xD2000
comma
l_int|0xD4000
comma
l_int|0xD6000
comma
l_int|0xD8000
comma
l_int|0xDA000
comma
l_int|0xDC000
comma
l_int|0xDE000
comma
l_int|0xE0000
)brace
suffix:semicolon
DECL|variable|xd_struct
r_static
r_struct
id|hd_struct
id|xd_struct
(braket
id|XD_MAXDRIVES
op_lshift
l_int|6
)braket
suffix:semicolon
DECL|variable|xd_sizes
DECL|variable|xd_access
r_static
r_int
id|xd_sizes
(braket
id|XD_MAXDRIVES
op_lshift
l_int|6
)braket
comma
id|xd_access
(braket
id|XD_MAXDRIVES
)braket
suffix:semicolon
DECL|variable|xd_blocksizes
r_static
r_int
id|xd_blocksizes
(braket
id|XD_MAXDRIVES
op_lshift
l_int|6
)braket
suffix:semicolon
r_extern
r_struct
id|block_device_operations
id|xd_fops
suffix:semicolon
DECL|variable|xd_gendisk
r_static
r_struct
id|gendisk
id|xd_gendisk
op_assign
(brace
id|MAJOR_NR
comma
multiline_comment|/* Major number */
l_string|&quot;xd&quot;
comma
multiline_comment|/* Major name */
l_int|6
comma
multiline_comment|/* Bits to shift to get real from partition */
l_int|1
op_lshift
l_int|6
comma
multiline_comment|/* Number of partitions per real */
id|xd_struct
comma
multiline_comment|/* hd struct */
id|xd_sizes
comma
multiline_comment|/* block sizes */
l_int|0
comma
multiline_comment|/* number */
(paren
r_void
op_star
)paren
id|xd_info
comma
multiline_comment|/* internal */
l_int|NULL
comma
multiline_comment|/* next */
op_amp
id|xd_fops
comma
multiline_comment|/* file operations */
)brace
suffix:semicolon
DECL|variable|xd_fops
r_static
r_struct
id|block_device_operations
id|xd_fops
op_assign
(brace
id|open
suffix:colon
id|xd_open
comma
id|release
suffix:colon
id|xd_release
comma
id|ioctl
suffix:colon
id|xd_ioctl
comma
)brace
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|xd_wait_int
)paren
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|xd_wait_open
)paren
suffix:semicolon
DECL|variable|xd_valid
r_static
id|u_char
id|xd_valid
(braket
id|XD_MAXDRIVES
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|xd_drives
DECL|variable|xd_irq
DECL|variable|xd_dma
DECL|variable|xd_maxsectors
r_static
id|u_char
id|xd_drives
comma
id|xd_irq
op_assign
l_int|5
comma
id|xd_dma
op_assign
l_int|3
comma
id|xd_maxsectors
suffix:semicolon
DECL|variable|__initdata
DECL|variable|__initdata
r_static
id|u_char
id|xd_override
id|__initdata
op_assign
l_int|0
comma
id|xd_type
id|__initdata
op_assign
l_int|0
suffix:semicolon
DECL|variable|xd_iobase
r_static
id|u_short
id|xd_iobase
op_assign
l_int|0x320
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|xd_geo
(braket
id|XD_MAXDRIVES
op_star
l_int|3
)braket
id|__initdata
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|xdc_busy
r_static
r_volatile
r_int
id|xdc_busy
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|xdc_wait
)paren
suffix:semicolon
DECL|variable|xd_timer
DECL|variable|xd_watchdog_int
r_static
r_struct
id|timer_list
id|xd_timer
comma
id|xd_watchdog_int
suffix:semicolon
DECL|variable|xd_error
r_static
r_volatile
id|u_char
id|xd_error
suffix:semicolon
DECL|variable|nodma
r_static
r_int
id|nodma
op_assign
id|XD_DONT_USE_DMA
suffix:semicolon
DECL|variable|devfs_handle
r_static
id|devfs_handle_t
id|devfs_handle
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* xd_init: register the block device number and set up pointer tables */
DECL|function|xd_init
r_int
id|__init
id|xd_init
(paren
r_void
)paren
(brace
id|init_timer
(paren
op_amp
id|xd_timer
)paren
suffix:semicolon
id|xd_timer.function
op_assign
id|xd_wakeup
suffix:semicolon
id|init_timer
(paren
op_amp
id|xd_watchdog_int
)paren
suffix:semicolon
id|xd_watchdog_int.function
op_assign
id|xd_watchdog
suffix:semicolon
r_if
c_cond
(paren
id|devfs_register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;xd&quot;
comma
op_amp
id|xd_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xd: Unable to get major number %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|devfs_handle
op_assign
id|devfs_mk_dir
(paren
l_int|NULL
comma
id|xd_gendisk.major_name
comma
l_int|NULL
)paren
suffix:semicolon
id|blk_init_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|DEVICE_REQUEST
)paren
suffix:semicolon
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 8 sector (4kB) read ahead */
id|xd_gendisk.next
op_assign
id|gendisk_head
suffix:semicolon
id|gendisk_head
op_assign
op_amp
id|xd_gendisk
suffix:semicolon
id|xd_geninit
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* xd_detect: scan the possible BIOS ROM locations for the signature strings */
DECL|function|xd_detect
r_static
id|u_char
id|__init
id|xd_detect
(paren
id|u_char
op_star
id|controller
comma
r_int
r_int
op_star
id|address
)paren
(brace
id|u_char
id|i
comma
id|j
comma
id|found
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|xd_override
)paren
(brace
op_star
id|controller
op_assign
id|xd_type
suffix:semicolon
op_star
id|address
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|xd_bases
)paren
op_div
r_sizeof
(paren
id|xd_bases
(braket
l_int|0
)braket
)paren
)paren
op_logical_and
op_logical_neg
id|found
suffix:semicolon
id|i
op_increment
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
OL
(paren
r_sizeof
(paren
id|xd_sigs
)paren
op_div
r_sizeof
(paren
id|xd_sigs
(braket
l_int|0
)braket
)paren
)paren
op_logical_and
op_logical_neg
id|found
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|isa_check_signature
c_func
(paren
id|xd_bases
(braket
id|i
)braket
op_plus
id|xd_sigs
(braket
id|j
)braket
dot
id|offset
comma
id|xd_sigs
(braket
id|j
)braket
dot
id|string
comma
id|strlen
c_func
(paren
id|xd_sigs
(braket
id|j
)braket
dot
id|string
)paren
)paren
)paren
(brace
op_star
id|controller
op_assign
id|j
suffix:semicolon
id|xd_type
op_assign
id|j
suffix:semicolon
op_star
id|address
op_assign
id|xd_bases
(braket
id|i
)braket
suffix:semicolon
id|found
op_increment
suffix:semicolon
)brace
r_return
(paren
id|found
)paren
suffix:semicolon
)brace
multiline_comment|/* xd_geninit: grab the IRQ and DMA channel, initialise the drives */
multiline_comment|/* and set up the &quot;raw&quot; device entries in the table */
DECL|function|xd_geninit
r_static
r_void
id|__init
id|xd_geninit
(paren
r_void
)paren
(brace
id|u_char
id|i
comma
id|controller
suffix:semicolon
r_int
r_int
id|address
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|XD_MAXDRIVES
op_lshift
l_int|6
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|xd_blocksizes
(braket
id|i
)braket
op_assign
l_int|1024
suffix:semicolon
)brace
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|xd_blocksizes
suffix:semicolon
r_if
c_cond
(paren
id|xd_detect
c_func
(paren
op_amp
id|controller
comma
op_amp
id|address
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Detected a%s controller (type %d) at address %06x&bslash;n&quot;
comma
id|xd_sigs
(braket
id|controller
)braket
dot
id|name
comma
id|controller
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|xd_iobase
comma
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xd: Ports at 0x%x are not available&bslash;n&quot;
comma
id|xd_iobase
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|xd_iobase
comma
l_int|4
comma
l_string|&quot;xd&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|controller
)paren
id|xd_sigs
(braket
id|controller
)braket
dot
id|init_controller
c_func
(paren
id|address
)paren
suffix:semicolon
id|xd_drives
op_assign
id|xd_initdrives
c_func
(paren
id|xd_sigs
(braket
id|controller
)braket
dot
id|init_drive
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Detected %d hard drive%s (using IRQ%d &amp; DMA%d)&bslash;n&quot;
comma
id|xd_drives
comma
id|xd_drives
op_eq
l_int|1
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;s&quot;
comma
id|xd_irq
comma
id|xd_dma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|xd_drives
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; xd%c: CHS=%d/%d/%d&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|i
comma
id|xd_info
(braket
id|i
)braket
dot
id|cylinders
comma
id|xd_info
(braket
id|i
)braket
dot
id|heads
comma
id|xd_info
(braket
id|i
)braket
dot
id|sectors
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xd_drives
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|xd_irq
comma
id|xd_interrupt_handler
comma
l_int|0
comma
l_string|&quot;XT hard disk&quot;
comma
l_int|NULL
)paren
)paren
(brace
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|xd_dma
comma
l_string|&quot;xd&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xd: unable to get DMA%d&bslash;n&quot;
comma
id|xd_dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|xd_irq
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;xd: unable to get IRQ%d&bslash;n&quot;
comma
id|xd_irq
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|xd_drives
suffix:semicolon
id|i
op_increment
)paren
(brace
id|xd_valid
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
id|register_disk
c_func
(paren
op_amp
id|xd_gendisk
comma
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|i
op_lshift
l_int|6
)paren
comma
l_int|1
op_lshift
l_int|6
comma
op_amp
id|xd_fops
comma
id|xd_info
(braket
id|i
)braket
dot
id|heads
op_star
id|xd_info
(braket
id|i
)braket
dot
id|cylinders
op_star
id|xd_info
(braket
id|i
)braket
dot
id|sectors
)paren
suffix:semicolon
)brace
id|xd_gendisk.nr_real
op_assign
id|xd_drives
suffix:semicolon
)brace
multiline_comment|/* xd_open: open a device */
DECL|function|xd_open
r_static
r_int
id|xd_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|dev
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
id|xd_drives
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|xd_valid
(braket
id|dev
)braket
)paren
id|sleep_on
c_func
(paren
op_amp
id|xd_wait_open
)paren
suffix:semicolon
id|xd_access
(braket
id|dev
)braket
op_increment
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/* do_xd_request: handle an incoming request */
DECL|function|do_xd_request
r_static
r_void
id|do_xd_request
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
id|u_int
id|block
comma
id|count
comma
id|retry
suffix:semicolon
r_int
id|code
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xdc_busy
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|code
op_assign
l_int|0
comma
op_logical_neg
id|QUEUE_EMPTY
)paren
(brace
id|INIT_REQUEST
suffix:semicolon
multiline_comment|/* do some checking on the request structure */
r_if
c_cond
(paren
id|CURRENT_DEV
OL
id|xd_drives
op_logical_and
id|CURRENT-&gt;sector
op_plus
id|CURRENT-&gt;nr_sectors
op_le
id|xd_struct
(braket
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
)braket
dot
id|nr_sects
)paren
(brace
id|block
op_assign
id|CURRENT-&gt;sector
op_plus
id|xd_struct
(braket
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
)braket
dot
id|start_sect
suffix:semicolon
id|count
op_assign
id|CURRENT-&gt;nr_sectors
suffix:semicolon
r_switch
c_cond
(paren
id|CURRENT-&gt;cmd
)paren
(brace
r_case
id|READ
suffix:colon
r_case
id|WRITE
suffix:colon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
(paren
id|retry
OL
id|XD_RETRIES
)paren
op_logical_and
op_logical_neg
id|code
suffix:semicolon
id|retry
op_increment
)paren
id|code
op_assign
id|xd_readwrite
c_func
(paren
id|CURRENT-&gt;cmd
comma
id|CURRENT_DEV
comma
id|CURRENT-&gt;buffer
comma
id|block
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;do_xd_request: unknown request&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|end_request
c_func
(paren
id|code
)paren
suffix:semicolon
multiline_comment|/* wrap up, 0 = fail, 1 = success */
)brace
)brace
multiline_comment|/* xd_ioctl: handle device ioctl&squot;s */
DECL|function|xd_ioctl
r_static
r_int
id|xd_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
)paren
(brace
r_int
id|dev
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|inode
)paren
op_logical_or
op_logical_neg
(paren
id|inode-&gt;i_rdev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|xd_drives
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|HDIO_GETGEO
suffix:colon
(brace
r_struct
id|hd_geometry
id|g
suffix:semicolon
r_struct
id|hd_geometry
op_star
id|geometry
op_assign
(paren
r_struct
id|hd_geometry
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|geometry
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|g.heads
op_assign
id|xd_info
(braket
id|dev
)braket
dot
id|heads
suffix:semicolon
id|g.sectors
op_assign
id|xd_info
(braket
id|dev
)braket
dot
id|sectors
suffix:semicolon
id|g.cylinders
op_assign
id|xd_info
(braket
id|dev
)braket
dot
id|cylinders
suffix:semicolon
id|g.start
op_assign
id|xd_struct
(braket
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
dot
id|start_sect
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|geometry
comma
op_amp
id|g
comma
r_sizeof
id|g
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|BLKGETSIZE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|xd_struct
(braket
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
dot
id|nr_sects
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|HDIO_SET_DMA
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|xdc_busy
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|nodma
op_assign
op_logical_neg
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|nodma
op_logical_and
id|xd_dma_buffer
)paren
(brace
id|xd_dma_mem_free
c_func
(paren
(paren
r_int
r_int
)paren
id|xd_dma_buffer
comma
id|xd_maxsectors
op_star
l_int|0x200
)paren
suffix:semicolon
id|xd_dma_buffer
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GET_DMA
suffix:colon
r_return
id|put_user
c_func
(paren
op_logical_neg
id|nodma
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|HDIO_GET_MULTCOUNT
suffix:colon
r_return
id|put_user
c_func
(paren
id|xd_maxsectors
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|BLKRRPART
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_return
id|xd_reread_partitions
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_case
id|BLKFLSBUF
suffix:colon
r_case
id|BLKROSET
suffix:colon
r_case
id|BLKROGET
suffix:colon
r_case
id|BLKRASET
suffix:colon
r_case
id|BLKRAGET
suffix:colon
r_case
id|BLKPG
suffix:colon
r_return
id|blk_ioctl
c_func
(paren
id|inode-&gt;i_rdev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* xd_release: release the device */
DECL|function|xd_release
r_static
r_int
id|xd_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|target
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|target
OL
id|xd_drives
)paren
(brace
id|xd_access
(braket
id|target
)braket
op_decrement
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif /* MODULE */
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* xd_reread_partitions: rereads the partition table from a drive */
DECL|function|xd_reread_partitions
r_static
r_int
id|xd_reread_partitions
c_func
(paren
id|kdev_t
id|dev
)paren
(brace
r_int
id|target
suffix:semicolon
r_int
id|start
suffix:semicolon
r_int
id|partition
suffix:semicolon
id|target
op_assign
id|DEVICE_NR
c_func
(paren
id|dev
)paren
suffix:semicolon
id|start
op_assign
id|target
op_lshift
id|xd_gendisk.minor_shift
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|xd_valid
(braket
id|target
)braket
op_assign
(paren
id|xd_access
(braket
id|target
)braket
op_ne
l_int|1
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_valid
(braket
id|target
)braket
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_for
c_loop
(paren
id|partition
op_assign
id|xd_gendisk.max_p
op_minus
l_int|1
suffix:semicolon
id|partition
op_ge
l_int|0
suffix:semicolon
id|partition
op_decrement
)paren
(brace
r_int
id|minor
op_assign
(paren
id|start
op_or
id|partition
)paren
suffix:semicolon
id|kdev_t
id|devp
op_assign
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|minor
)paren
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
op_assign
id|get_super
c_func
(paren
id|devp
)paren
suffix:semicolon
id|sync_dev
c_func
(paren
id|devp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb
)paren
id|invalidate_inodes
c_func
(paren
id|sb
)paren
suffix:semicolon
id|invalidate_buffers
c_func
(paren
id|devp
)paren
suffix:semicolon
id|xd_gendisk.part
(braket
id|minor
)braket
dot
id|start_sect
op_assign
l_int|0
suffix:semicolon
id|xd_gendisk.part
(braket
id|minor
)braket
dot
id|nr_sects
op_assign
l_int|0
suffix:semicolon
)brace
suffix:semicolon
id|grok_partitions
c_func
(paren
op_amp
id|xd_gendisk
comma
id|target
comma
l_int|1
op_lshift
l_int|6
comma
id|xd_info
(braket
id|target
)braket
dot
id|heads
op_star
id|xd_info
(braket
id|target
)braket
dot
id|cylinders
op_star
id|xd_info
(braket
id|target
)braket
dot
id|sectors
)paren
suffix:semicolon
id|xd_valid
(braket
id|target
)braket
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|xd_wait_open
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* xd_readwrite: handle a read/write request */
DECL|function|xd_readwrite
r_static
r_int
id|xd_readwrite
(paren
id|u_char
id|operation
comma
id|u_char
id|drive
comma
r_char
op_star
id|buffer
comma
id|u_int
id|block
comma
id|u_int
id|count
)paren
(brace
id|u_char
id|cmdblk
(braket
l_int|6
)braket
comma
id|sense
(braket
l_int|4
)braket
suffix:semicolon
id|u_short
id|track
comma
id|cylinder
suffix:semicolon
id|u_char
id|head
comma
id|sector
comma
id|control
comma
id|mode
op_assign
id|PIO_MODE
comma
id|temp
suffix:semicolon
r_char
op_star
op_star
id|real_buffer
suffix:semicolon
r_register
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUG_READWRITE
id|printk
c_func
(paren
l_string|&quot;xd_readwrite: operation = %s, drive = %d, buffer = 0x%X, block = %d, count = %d&bslash;n&quot;
comma
id|operation
op_eq
id|READ
ques
c_cond
l_string|&quot;read&quot;
suffix:colon
l_string|&quot;write&quot;
comma
id|drive
comma
id|buffer
comma
id|block
comma
id|count
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_READWRITE */
id|control
op_assign
id|xd_info
(braket
id|drive
)braket
dot
id|control
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xd_dma_buffer
)paren
id|xd_dma_buffer
op_assign
(paren
r_char
op_star
)paren
id|xd_dma_mem_alloc
c_func
(paren
id|xd_maxsectors
op_star
l_int|0x200
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
id|temp
op_assign
id|count
OL
id|xd_maxsectors
ques
c_cond
id|count
suffix:colon
id|xd_maxsectors
suffix:semicolon
id|track
op_assign
id|block
op_div
id|xd_info
(braket
id|drive
)braket
dot
id|sectors
suffix:semicolon
id|head
op_assign
id|track
op_mod
id|xd_info
(braket
id|drive
)braket
dot
id|heads
suffix:semicolon
id|cylinder
op_assign
id|track
op_div
id|xd_info
(braket
id|drive
)braket
dot
id|heads
suffix:semicolon
id|sector
op_assign
id|block
op_mod
id|xd_info
(braket
id|drive
)braket
dot
id|sectors
suffix:semicolon
macro_line|#ifdef DEBUG_READWRITE
id|printk
c_func
(paren
l_string|&quot;xd_readwrite: drive = %d, head = %d, cylinder = %d, sector = %d, count = %d&bslash;n&quot;
comma
id|drive
comma
id|head
comma
id|cylinder
comma
id|sector
comma
id|temp
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_READWRITE */
r_if
c_cond
(paren
id|xd_dma_buffer
)paren
(brace
id|mode
op_assign
id|xd_setup_dma
c_func
(paren
id|operation
op_eq
id|READ
ques
c_cond
id|DMA_MODE_READ
suffix:colon
id|DMA_MODE_WRITE
comma
(paren
id|u_char
op_star
)paren
(paren
id|xd_dma_buffer
)paren
comma
id|temp
op_star
l_int|0x200
)paren
suffix:semicolon
id|real_buffer
op_assign
op_amp
id|xd_dma_buffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|temp
op_star
l_int|0x200
)paren
suffix:semicolon
id|i
op_increment
)paren
id|xd_dma_buffer
(braket
id|i
)braket
op_assign
id|buffer
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
id|real_buffer
op_assign
op_amp
id|buffer
suffix:semicolon
id|xd_build
c_func
(paren
id|cmdblk
comma
id|operation
op_eq
id|READ
ques
c_cond
id|CMD_READ
suffix:colon
id|CMD_WRITE
comma
id|drive
comma
id|head
comma
id|cylinder
comma
id|sector
comma
id|temp
op_amp
l_int|0xFF
comma
id|control
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|xd_command
c_func
(paren
id|cmdblk
comma
id|mode
comma
(paren
id|u_char
op_star
)paren
(paren
op_star
id|real_buffer
)paren
comma
(paren
id|u_char
op_star
)paren
(paren
op_star
id|real_buffer
)paren
comma
id|sense
comma
id|XD_TIMEOUT
)paren
)paren
(brace
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
l_string|&quot;xd%c: %s timeout, recalibrating drive&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|drive
comma
(paren
id|operation
op_eq
id|READ
ques
c_cond
l_string|&quot;read&quot;
suffix:colon
l_string|&quot;write&quot;
)paren
)paren
suffix:semicolon
id|xd_recalibrate
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x30
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xd%c: %s - &quot;
comma
l_char|&squot;a&squot;
op_plus
id|drive
comma
(paren
id|operation
op_eq
id|READ
ques
c_cond
l_string|&quot;reading&quot;
suffix:colon
l_string|&quot;writing&quot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x30
)paren
op_rshift
l_int|4
)paren
(brace
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
l_string|&quot;drive error, code = 0x%X&quot;
comma
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x0F
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
l_string|&quot;controller error, code = 0x%X&quot;
comma
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x0F
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|printk
c_func
(paren
l_string|&quot;command error, code = 0x%X&quot;
comma
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x0F
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|printk
c_func
(paren
l_string|&quot;miscellaneous error, code = 0x%X&quot;
comma
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x0F
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
id|printk
c_func
(paren
l_string|&quot; - CHS = %d/%d/%d&bslash;n&quot;
comma
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
l_int|0xC0
)paren
op_lshift
l_int|2
)paren
op_or
id|sense
(braket
l_int|3
)braket
comma
id|sense
(braket
l_int|1
)braket
op_amp
l_int|0x1F
comma
id|sense
(braket
l_int|2
)braket
op_amp
l_int|0x3F
)paren
suffix:semicolon
multiline_comment|/*&t;reported drive number = (sense[1] &amp; 0xE0) &gt;&gt; 5 */
r_else
id|printk
c_func
(paren
l_string|&quot; - no valid disk address&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xd_dma_buffer
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|temp
op_star
l_int|0x200
)paren
suffix:semicolon
id|i
op_increment
)paren
id|buffer
(braket
id|i
)braket
op_assign
id|xd_dma_buffer
(braket
id|i
)braket
suffix:semicolon
id|count
op_sub_assign
id|temp
comma
id|buffer
op_add_assign
id|temp
op_star
l_int|0x200
comma
id|block
op_add_assign
id|temp
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* xd_recalibrate: recalibrate a given drive and reset controller if necessary */
DECL|function|xd_recalibrate
r_static
r_void
id|xd_recalibrate
(paren
id|u_char
id|drive
)paren
(brace
id|u_char
id|cmdblk
(braket
l_int|6
)braket
suffix:semicolon
id|xd_build
c_func
(paren
id|cmdblk
comma
id|CMD_RECALIBRATE
comma
id|drive
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_command
c_func
(paren
id|cmdblk
comma
id|PIO_MODE
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|XD_TIMEOUT
op_star
l_int|8
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;xd%c: warning! error recalibrating, controller may be unstable&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|drive
)paren
suffix:semicolon
)brace
multiline_comment|/* xd_interrupt_handler: interrupt service routine */
DECL|function|xd_interrupt_handler
r_static
r_void
id|xd_interrupt_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|XD_STATUS
)paren
op_amp
id|STAT_INTERRUPT
)paren
(brace
multiline_comment|/* check if it was our device */
macro_line|#ifdef DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot;xd_interrupt_handler: interrupt detected&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_OTHER */
id|outb
c_func
(paren
l_int|0
comma
id|XD_CONTROL
)paren
suffix:semicolon
multiline_comment|/* acknowledge interrupt */
id|wake_up
c_func
(paren
op_amp
id|xd_wait_int
)paren
suffix:semicolon
multiline_comment|/* and wake up sleeping processes */
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;xd: unexpected interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* xd_setup_dma: set up the DMA controller for a data transfer */
DECL|function|xd_setup_dma
r_static
id|u_char
id|xd_setup_dma
(paren
id|u_char
id|mode
comma
id|u_char
op_star
id|buffer
comma
id|u_int
id|count
)paren
(brace
r_int
r_int
id|f
suffix:semicolon
r_if
c_cond
(paren
id|nodma
)paren
r_return
(paren
id|PIO_MODE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_int
)paren
id|buffer
op_amp
l_int|0xFFFF0000
)paren
op_ne
(paren
(paren
(paren
r_int
r_int
)paren
id|buffer
op_plus
id|count
)paren
op_amp
l_int|0xFFFF0000
)paren
)paren
(brace
macro_line|#ifdef DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot;xd_setup_dma: using PIO, transfer overlaps 64k boundary&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_OTHER */
r_return
(paren
id|PIO_MODE
)paren
suffix:semicolon
)brace
id|f
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|xd_dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|xd_dma
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|xd_dma
comma
id|mode
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|xd_dma
comma
(paren
r_int
r_int
)paren
id|buffer
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|xd_dma
comma
id|count
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|f
)paren
suffix:semicolon
r_return
(paren
id|DMA_MODE
)paren
suffix:semicolon
multiline_comment|/* use DMA and INT */
)brace
multiline_comment|/* xd_build: put stuff into an array in a format suitable for the controller */
DECL|function|xd_build
r_static
id|u_char
op_star
id|xd_build
(paren
id|u_char
op_star
id|cmdblk
comma
id|u_char
id|command
comma
id|u_char
id|drive
comma
id|u_char
id|head
comma
id|u_short
id|cylinder
comma
id|u_char
id|sector
comma
id|u_char
id|count
comma
id|u_char
id|control
)paren
(brace
id|cmdblk
(braket
l_int|0
)braket
op_assign
id|command
suffix:semicolon
id|cmdblk
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|drive
op_amp
l_int|0x07
)paren
op_lshift
l_int|5
)paren
op_or
(paren
id|head
op_amp
l_int|0x1F
)paren
suffix:semicolon
id|cmdblk
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|cylinder
op_amp
l_int|0x300
)paren
op_rshift
l_int|2
)paren
op_or
(paren
id|sector
op_amp
l_int|0x3F
)paren
suffix:semicolon
id|cmdblk
(braket
l_int|3
)braket
op_assign
id|cylinder
op_amp
l_int|0xFF
suffix:semicolon
id|cmdblk
(braket
l_int|4
)braket
op_assign
id|count
suffix:semicolon
id|cmdblk
(braket
l_int|5
)braket
op_assign
id|control
suffix:semicolon
r_return
(paren
id|cmdblk
)paren
suffix:semicolon
)brace
multiline_comment|/* xd_wakeup is called from timer interrupt */
DECL|function|xd_wakeup
r_static
r_void
id|xd_wakeup
(paren
r_int
r_int
id|unused
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|xdc_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* xd_wakeup is called from timer interrupt */
DECL|function|xd_watchdog
r_static
r_void
id|xd_watchdog
(paren
r_int
r_int
id|unused
)paren
(brace
id|xd_error
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|xd_wait_int
)paren
suffix:semicolon
)brace
multiline_comment|/* xd_waitport: waits until port &amp; mask == flags or a timeout occurs. return 1 for a timeout */
DECL|function|xd_waitport
r_static
r_inline
id|u_char
id|xd_waitport
(paren
id|u_short
id|port
comma
id|u_char
id|flags
comma
id|u_char
id|mask
comma
id|u_long
id|timeout
)paren
(brace
id|u_long
id|expiry
op_assign
id|jiffies
op_plus
id|timeout
suffix:semicolon
r_int
id|success
suffix:semicolon
id|xdc_busy
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|success
op_assign
(paren
(paren
id|inb
c_func
(paren
id|port
)paren
op_amp
id|mask
)paren
op_ne
id|flags
)paren
)paren
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|expiry
)paren
)paren
(brace
id|xd_timer.expires
op_assign
id|jiffies
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|xd_timer
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|xdc_wait
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|xd_timer
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
id|xdc_busy
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|success
)paren
suffix:semicolon
)brace
DECL|function|xd_wait_for_IRQ
r_static
r_inline
id|u_int
id|xd_wait_for_IRQ
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|xd_watchdog_int.expires
op_assign
id|jiffies
op_plus
l_int|8
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|xd_watchdog_int
)paren
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|xd_dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|xd_wait_int
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|xd_watchdog_int
)paren
suffix:semicolon
id|xdc_busy
op_assign
l_int|0
suffix:semicolon
id|flags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|xd_dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xd: missed IRQ - command aborted&bslash;n&quot;
)paren
suffix:semicolon
id|xd_error
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* xd_command: handle all data transfers necessary for a single command */
DECL|function|xd_command
r_static
id|u_int
id|xd_command
(paren
id|u_char
op_star
id|command
comma
id|u_char
id|mode
comma
id|u_char
op_star
id|indata
comma
id|u_char
op_star
id|outdata
comma
id|u_char
op_star
id|sense
comma
id|u_long
id|timeout
)paren
(brace
id|u_char
id|cmdblk
(braket
l_int|6
)braket
comma
id|csb
comma
id|complete
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG_COMMAND
id|printk
c_func
(paren
l_string|&quot;xd_command: command = 0x%X, mode = 0x%X, indata = 0x%X, outdata = 0x%X, sense = 0x%X&bslash;n&quot;
comma
id|command
comma
id|mode
comma
id|indata
comma
id|outdata
comma
id|sense
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_COMMAND */
id|outb
c_func
(paren
l_int|0
comma
id|XD_SELECT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|mode
comma
id|XD_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_waitport
c_func
(paren
id|XD_STATUS
comma
id|STAT_SELECT
comma
id|STAT_SELECT
comma
id|timeout
)paren
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|complete
)paren
(brace
r_if
c_cond
(paren
id|xd_waitport
c_func
(paren
id|XD_STATUS
comma
id|STAT_READY
comma
id|STAT_READY
comma
id|timeout
)paren
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|inb
c_func
(paren
id|XD_STATUS
)paren
op_amp
(paren
id|STAT_COMMAND
op_or
id|STAT_INPUT
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|mode
op_eq
id|DMA_MODE
)paren
(brace
r_if
c_cond
(paren
id|xd_wait_for_IRQ
c_func
(paren
)paren
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|outb
c_func
(paren
id|outdata
ques
c_cond
op_star
id|outdata
op_increment
suffix:colon
l_int|0
comma
id|XD_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_INPUT
suffix:colon
r_if
c_cond
(paren
id|mode
op_eq
id|DMA_MODE
)paren
(brace
r_if
c_cond
(paren
id|xd_wait_for_IRQ
c_func
(paren
)paren
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|indata
)paren
op_star
id|indata
op_increment
op_assign
id|inb
c_func
(paren
id|XD_DATA
)paren
suffix:semicolon
r_else
id|inb
c_func
(paren
id|XD_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_COMMAND
suffix:colon
id|outb
c_func
(paren
id|command
ques
c_cond
op_star
id|command
op_increment
suffix:colon
l_int|0
comma
id|XD_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_COMMAND
op_or
id|STAT_INPUT
suffix:colon
id|complete
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|csb
op_assign
id|inb
c_func
(paren
id|XD_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_waitport
c_func
(paren
id|XD_STATUS
comma
l_int|0
comma
id|STAT_SELECT
comma
id|timeout
)paren
)paren
multiline_comment|/* wait until deselected */
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csb
op_amp
id|CSB_ERROR
)paren
(brace
multiline_comment|/* read sense data if error */
id|xd_build
c_func
(paren
id|cmdblk
comma
id|CMD_SENSE
comma
(paren
id|csb
op_amp
id|CSB_LUN
)paren
op_rshift
l_int|5
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_command
c_func
(paren
id|cmdblk
comma
l_int|0
comma
id|sense
comma
l_int|0
comma
l_int|0
comma
id|XD_TIMEOUT
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;xd: warning! sense command failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_COMMAND
id|printk
c_func
(paren
l_string|&quot;xd_command: completed with csb = 0x%X&bslash;n&quot;
comma
id|csb
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_COMMAND */
r_return
(paren
id|csb
op_amp
id|CSB_ERROR
)paren
suffix:semicolon
)brace
DECL|function|xd_initdrives
r_static
id|u_char
id|__init
id|xd_initdrives
(paren
r_void
(paren
op_star
id|init_drive
)paren
(paren
id|u_char
id|drive
)paren
)paren
(brace
id|u_char
id|cmdblk
(braket
l_int|6
)braket
comma
id|i
comma
id|count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|XD_MAXDRIVES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|xd_build
c_func
(paren
id|cmdblk
comma
id|CMD_TESTREADY
comma
id|i
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xd_command
c_func
(paren
id|cmdblk
comma
id|PIO_MODE
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|XD_TIMEOUT
op_star
l_int|8
)paren
)paren
(brace
id|xd_timer.expires
op_assign
id|jiffies
op_plus
id|XD_INIT_DISK_DELAY
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|xd_timer
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|xdc_wait
)paren
suffix:semicolon
id|init_drive
c_func
(paren
id|count
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
id|xd_timer.expires
op_assign
id|jiffies
op_plus
id|XD_INIT_DISK_DELAY
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|xd_timer
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|xdc_wait
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|count
)paren
suffix:semicolon
)brace
DECL|function|xd_manual_geo_set
r_static
r_void
id|__init
id|xd_manual_geo_set
(paren
id|u_char
id|drive
)paren
(brace
id|xd_info
(braket
id|drive
)braket
dot
id|heads
op_assign
(paren
id|u_char
)paren
(paren
id|xd_geo
(braket
l_int|3
op_star
id|drive
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_assign
(paren
id|u_short
)paren
(paren
id|xd_geo
(braket
l_int|3
op_star
id|drive
)braket
)paren
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|sectors
op_assign
(paren
id|u_char
)paren
(paren
id|xd_geo
(braket
l_int|3
op_star
id|drive
op_plus
l_int|2
)braket
)paren
suffix:semicolon
)brace
DECL|function|xd_dtc_init_controller
r_static
r_void
id|__init
id|xd_dtc_init_controller
(paren
r_int
r_int
id|address
)paren
(brace
r_switch
c_cond
(paren
id|address
)paren
(brace
r_case
l_int|0x00000
suffix:colon
r_case
l_int|0xC8000
suffix:colon
r_break
suffix:semicolon
multiline_comment|/*initial: 0x320 */
r_case
l_int|0xCA000
suffix:colon
id|xd_iobase
op_assign
l_int|0x324
suffix:semicolon
r_case
l_int|0xD0000
suffix:colon
multiline_comment|/*5150CX*/
r_case
l_int|0xD8000
suffix:colon
r_break
suffix:semicolon
multiline_comment|/*5150CX &amp; 5150XL*/
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;xd_dtc_init_controller: unsupported BIOS address %06x&bslash;n&quot;
comma
id|address
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|xd_maxsectors
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* my card seems to have trouble doing multi-block transfers? */
id|outb
c_func
(paren
l_int|0
comma
id|XD_RESET
)paren
suffix:semicolon
multiline_comment|/* reset the controller */
)brace
DECL|function|xd_dtc5150cx_init_drive
r_static
r_void
id|__init
id|xd_dtc5150cx_init_drive
(paren
id|u_char
id|drive
)paren
(brace
multiline_comment|/* values from controller&squot;s BIOS - BIOS chip may be removed */
r_static
id|u_short
id|geometry_table
(braket
)braket
(braket
l_int|4
)braket
op_assign
(brace
(brace
l_int|0x200
comma
l_int|8
comma
l_int|0x200
comma
l_int|0x100
)brace
comma
(brace
l_int|0x267
comma
l_int|2
comma
l_int|0x267
comma
l_int|0x267
)brace
comma
(brace
l_int|0x264
comma
l_int|4
comma
l_int|0x264
comma
l_int|0x80
)brace
comma
(brace
l_int|0x132
comma
l_int|4
comma
l_int|0x132
comma
l_int|0x0
)brace
comma
(brace
l_int|0x132
comma
l_int|2
comma
l_int|0x80
comma
l_int|0x132
)brace
comma
(brace
l_int|0x177
comma
l_int|8
comma
l_int|0x177
comma
l_int|0x0
)brace
comma
(brace
l_int|0x132
comma
l_int|8
comma
l_int|0x84
comma
l_int|0x0
)brace
comma
(brace
)brace
comma
multiline_comment|/* not used */
(brace
l_int|0x132
comma
l_int|6
comma
l_int|0x80
comma
l_int|0x100
)brace
comma
(brace
l_int|0x200
comma
l_int|6
comma
l_int|0x100
comma
l_int|0x100
)brace
comma
(brace
l_int|0x264
comma
l_int|2
comma
l_int|0x264
comma
l_int|0x80
)brace
comma
(brace
l_int|0x280
comma
l_int|4
comma
l_int|0x280
comma
l_int|0x100
)brace
comma
(brace
l_int|0x2B9
comma
l_int|3
comma
l_int|0x2B9
comma
l_int|0x2B9
)brace
comma
(brace
l_int|0x2B9
comma
l_int|5
comma
l_int|0x2B9
comma
l_int|0x2B9
)brace
comma
(brace
l_int|0x280
comma
l_int|6
comma
l_int|0x280
comma
l_int|0x100
)brace
comma
(brace
l_int|0x132
comma
l_int|4
comma
l_int|0x132
comma
l_int|0x0
)brace
)brace
suffix:semicolon
id|u_char
id|n
suffix:semicolon
id|n
op_assign
id|inb
c_func
(paren
id|XD_JUMPER
)paren
suffix:semicolon
id|n
op_assign
(paren
id|drive
ques
c_cond
id|n
suffix:colon
(paren
id|n
op_rshift
l_int|2
)paren
)paren
op_amp
l_int|0x33
suffix:semicolon
id|n
op_assign
(paren
id|n
op_or
(paren
id|n
op_rshift
l_int|2
)paren
)paren
op_amp
l_int|0x0F
suffix:semicolon
r_if
c_cond
(paren
id|xd_geo
(braket
l_int|3
op_star
id|drive
)braket
)paren
id|xd_manual_geo_set
c_func
(paren
id|drive
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|n
op_ne
l_int|7
)paren
(brace
id|xd_info
(braket
id|drive
)braket
dot
id|heads
op_assign
(paren
id|u_char
)paren
(paren
id|geometry_table
(braket
id|n
)braket
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* heads */
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* cylinders */
id|xd_info
(braket
id|drive
)braket
dot
id|sectors
op_assign
l_int|17
suffix:semicolon
multiline_comment|/* sectors */
macro_line|#if 0
id|xd_info
(braket
id|drive
)braket
dot
id|rwrite
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* reduced write */
id|xd_info
(braket
id|drive
)braket
dot
id|precomp
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|3
)braket
multiline_comment|/* write precomp */
id|xd_info
(braket
id|drive
)braket
dot
id|ecc
op_assign
l_int|0x0B
suffix:semicolon
multiline_comment|/* ecc length */
macro_line|#endif /* 0 */
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;xd%c: undetermined drive geometry&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|drive
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|xd_info
(braket
id|drive
)braket
dot
id|control
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* control byte */
id|xd_setparam
c_func
(paren
id|CMD_DTCSETPARAM
comma
id|drive
comma
id|xd_info
(braket
id|drive
)braket
dot
id|heads
comma
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
comma
id|geometry_table
(braket
id|n
)braket
(braket
l_int|2
)braket
comma
id|geometry_table
(braket
id|n
)braket
(braket
l_int|3
)braket
comma
l_int|0x0B
)paren
suffix:semicolon
id|xd_recalibrate
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
DECL|function|xd_dtc_init_drive
r_static
r_void
id|__init
id|xd_dtc_init_drive
(paren
id|u_char
id|drive
)paren
(brace
id|u_char
id|cmdblk
(braket
l_int|6
)braket
comma
id|buf
(braket
l_int|64
)braket
suffix:semicolon
id|xd_build
c_func
(paren
id|cmdblk
comma
id|CMD_DTCGETGEOM
comma
id|drive
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xd_command
c_func
(paren
id|cmdblk
comma
id|PIO_MODE
comma
id|buf
comma
l_int|0
comma
l_int|0
comma
id|XD_TIMEOUT
op_star
l_int|2
)paren
)paren
(brace
id|xd_info
(braket
id|drive
)braket
dot
id|heads
op_assign
id|buf
(braket
l_int|0x0A
)braket
suffix:semicolon
multiline_comment|/* heads */
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_assign
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
)paren
)paren
(braket
l_int|0x04
)braket
suffix:semicolon
multiline_comment|/* cylinders */
id|xd_info
(braket
id|drive
)braket
dot
id|sectors
op_assign
l_int|17
suffix:semicolon
multiline_comment|/* sectors */
r_if
c_cond
(paren
id|xd_geo
(braket
l_int|3
op_star
id|drive
)braket
)paren
id|xd_manual_geo_set
c_func
(paren
id|drive
)paren
suffix:semicolon
macro_line|#if 0
id|xd_info
(braket
id|drive
)braket
dot
id|rwrite
op_assign
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
op_plus
l_int|1
)paren
)paren
(braket
l_int|0x05
)braket
suffix:semicolon
multiline_comment|/* reduced write */
id|xd_info
(braket
id|drive
)braket
dot
id|precomp
op_assign
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
op_plus
l_int|1
)paren
)paren
(braket
l_int|0x06
)braket
suffix:semicolon
multiline_comment|/* write precomp */
id|xd_info
(braket
id|drive
)braket
dot
id|ecc
op_assign
id|buf
(braket
l_int|0x0F
)braket
suffix:semicolon
multiline_comment|/* ecc length */
macro_line|#endif /* 0 */
id|xd_info
(braket
id|drive
)braket
dot
id|control
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* control byte */
id|xd_setparam
c_func
(paren
id|CMD_DTCSETPARAM
comma
id|drive
comma
id|xd_info
(braket
id|drive
)braket
dot
id|heads
comma
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
comma
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
op_plus
l_int|1
)paren
)paren
(braket
l_int|0x05
)braket
comma
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
op_plus
l_int|1
)paren
)paren
(braket
l_int|0x06
)braket
comma
id|buf
(braket
l_int|0x0F
)braket
)paren
suffix:semicolon
id|xd_build
c_func
(paren
id|cmdblk
comma
id|CMD_DTCSETSTEP
comma
id|drive
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_command
c_func
(paren
id|cmdblk
comma
id|PIO_MODE
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|XD_TIMEOUT
op_star
l_int|2
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;xd_dtc_init_drive: error setting step rate for xd%c&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|drive
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;xd_dtc_init_drive: error reading geometry for xd%c&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|drive
)paren
suffix:semicolon
)brace
DECL|function|xd_wd_init_controller
r_static
r_void
id|__init
id|xd_wd_init_controller
(paren
r_int
r_int
id|address
)paren
(brace
r_switch
c_cond
(paren
id|address
)paren
(brace
r_case
l_int|0x00000
suffix:colon
r_case
l_int|0xC8000
suffix:colon
r_break
suffix:semicolon
multiline_comment|/*initial: 0x320 */
r_case
l_int|0xCA000
suffix:colon
id|xd_iobase
op_assign
l_int|0x324
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xCC000
suffix:colon
id|xd_iobase
op_assign
l_int|0x328
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xCE000
suffix:colon
id|xd_iobase
op_assign
l_int|0x32C
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xD0000
suffix:colon
id|xd_iobase
op_assign
l_int|0x328
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* ? */
r_case
l_int|0xD8000
suffix:colon
id|xd_iobase
op_assign
l_int|0x32C
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* ? */
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;xd_wd_init_controller: unsupported BIOS address %06x&bslash;n&quot;
comma
id|address
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|xd_maxsectors
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* this one doesn&squot;t wrap properly either... */
id|outb
c_func
(paren
l_int|0
comma
id|XD_RESET
)paren
suffix:semicolon
multiline_comment|/* reset the controller */
id|xd_timer.expires
op_assign
id|jiffies
op_plus
id|XD_INIT_DISK_DELAY
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|xd_timer
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|xdc_wait
)paren
suffix:semicolon
)brace
DECL|function|xd_wd_init_drive
r_static
r_void
id|__init
id|xd_wd_init_drive
(paren
id|u_char
id|drive
)paren
(brace
multiline_comment|/* values from controller&squot;s BIOS - BIOS may be disabled */
r_static
id|u_short
id|geometry_table
(braket
)braket
(braket
l_int|4
)braket
op_assign
(brace
(brace
l_int|0x264
comma
l_int|4
comma
l_int|0x1C2
comma
l_int|0x1C2
)brace
comma
multiline_comment|/* common part */
(brace
l_int|0x132
comma
l_int|4
comma
l_int|0x099
comma
l_int|0x0
)brace
comma
(brace
l_int|0x267
comma
l_int|2
comma
l_int|0x1C2
comma
l_int|0x1C2
)brace
comma
(brace
l_int|0x267
comma
l_int|4
comma
l_int|0x1C2
comma
l_int|0x1C2
)brace
comma
(brace
l_int|0x334
comma
l_int|6
comma
l_int|0x335
comma
l_int|0x335
)brace
comma
multiline_comment|/* 1004 series RLL */
(brace
l_int|0x30E
comma
l_int|4
comma
l_int|0x30F
comma
l_int|0x3DC
)brace
comma
(brace
l_int|0x30E
comma
l_int|2
comma
l_int|0x30F
comma
l_int|0x30F
)brace
comma
(brace
l_int|0x267
comma
l_int|4
comma
l_int|0x268
comma
l_int|0x268
)brace
comma
(brace
l_int|0x3D5
comma
l_int|5
comma
l_int|0x3D6
comma
l_int|0x3D6
)brace
comma
multiline_comment|/* 1002 series RLL */
(brace
l_int|0x3DB
comma
l_int|7
comma
l_int|0x3DC
comma
l_int|0x3DC
)brace
comma
(brace
l_int|0x264
comma
l_int|4
comma
l_int|0x265
comma
l_int|0x265
)brace
comma
(brace
l_int|0x267
comma
l_int|4
comma
l_int|0x268
comma
l_int|0x268
)brace
)brace
suffix:semicolon
id|u_char
id|cmdblk
(braket
l_int|6
)braket
comma
id|buf
(braket
l_int|0x200
)braket
suffix:semicolon
id|u_char
id|n
op_assign
l_int|0
comma
id|rll
comma
id|jumper_state
comma
id|use_jumper_geo
suffix:semicolon
id|u_char
id|wd_1002
op_assign
(paren
id|xd_sigs
(braket
id|xd_type
)braket
dot
id|string
(braket
l_int|7
)braket
op_eq
l_char|&squot;6&squot;
)paren
suffix:semicolon
id|jumper_state
op_assign
op_complement
(paren
id|inb
c_func
(paren
l_int|0x322
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jumper_state
op_amp
l_int|0x40
)paren
id|xd_irq
op_assign
l_int|9
suffix:semicolon
id|rll
op_assign
(paren
id|jumper_state
op_amp
l_int|0x30
)paren
ques
c_cond
(paren
l_int|0x04
op_lshift
id|wd_1002
)paren
suffix:colon
l_int|0
suffix:semicolon
id|xd_build
c_func
(paren
id|cmdblk
comma
id|CMD_READ
comma
id|drive
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xd_command
c_func
(paren
id|cmdblk
comma
id|PIO_MODE
comma
id|buf
comma
l_int|0
comma
l_int|0
comma
id|XD_TIMEOUT
op_star
l_int|2
)paren
)paren
(brace
id|xd_info
(braket
id|drive
)braket
dot
id|heads
op_assign
id|buf
(braket
l_int|0x1AF
)braket
suffix:semicolon
multiline_comment|/* heads */
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_assign
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
op_plus
l_int|1
)paren
)paren
(braket
l_int|0xD6
)braket
suffix:semicolon
multiline_comment|/* cylinders */
id|xd_info
(braket
id|drive
)braket
dot
id|sectors
op_assign
l_int|17
suffix:semicolon
multiline_comment|/* sectors */
r_if
c_cond
(paren
id|xd_geo
(braket
l_int|3
op_star
id|drive
)braket
)paren
id|xd_manual_geo_set
c_func
(paren
id|drive
)paren
suffix:semicolon
macro_line|#if 0
id|xd_info
(braket
id|drive
)braket
dot
id|rwrite
op_assign
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
)paren
)paren
(braket
l_int|0xD8
)braket
suffix:semicolon
multiline_comment|/* reduced write */
id|xd_info
(braket
id|drive
)braket
dot
id|wprecomp
op_assign
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
)paren
)paren
(braket
l_int|0xDA
)braket
suffix:semicolon
multiline_comment|/* write precomp */
id|xd_info
(braket
id|drive
)braket
dot
id|ecc
op_assign
id|buf
(braket
l_int|0x1B4
)braket
suffix:semicolon
multiline_comment|/* ecc length */
macro_line|#endif /* 0 */
id|xd_info
(braket
id|drive
)braket
dot
id|control
op_assign
id|buf
(braket
l_int|0x1B5
)braket
suffix:semicolon
multiline_comment|/* control byte */
id|use_jumper_geo
op_assign
op_logical_neg
(paren
id|xd_info
(braket
id|drive
)braket
dot
id|heads
)paren
op_logical_or
op_logical_neg
(paren
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_geo
(braket
l_int|3
op_star
id|drive
)braket
)paren
(brace
id|xd_manual_geo_set
c_func
(paren
id|drive
)paren
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|control
op_assign
id|rll
ques
c_cond
l_int|7
suffix:colon
l_int|5
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|use_jumper_geo
)paren
(brace
id|n
op_assign
(paren
(paren
(paren
id|jumper_state
op_amp
l_int|0x0F
)paren
op_rshift
(paren
id|drive
op_lshift
l_int|1
)paren
)paren
op_amp
l_int|0x03
)paren
op_or
id|rll
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|heads
op_assign
(paren
id|u_char
)paren
(paren
id|geometry_table
(braket
id|n
)braket
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|control
op_assign
id|rll
ques
c_cond
l_int|7
suffix:colon
l_int|5
suffix:semicolon
macro_line|#if 0
id|xd_info
(braket
id|drive
)braket
dot
id|rwrite
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|2
)braket
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|wprecomp
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|3
)braket
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|ecc
op_assign
l_int|0x0B
suffix:semicolon
macro_line|#endif /* 0 */
)brace
r_if
c_cond
(paren
op_logical_neg
id|wd_1002
)paren
(brace
r_if
c_cond
(paren
id|use_jumper_geo
)paren
id|xd_setparam
c_func
(paren
id|CMD_WDSETPARAM
comma
id|drive
comma
id|xd_info
(braket
id|drive
)braket
dot
id|heads
comma
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
comma
id|geometry_table
(braket
id|n
)braket
(braket
l_int|2
)braket
comma
id|geometry_table
(braket
id|n
)braket
(braket
l_int|3
)braket
comma
l_int|0x0B
)paren
suffix:semicolon
r_else
id|xd_setparam
c_func
(paren
id|CMD_WDSETPARAM
comma
id|drive
comma
id|xd_info
(braket
id|drive
)braket
dot
id|heads
comma
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
comma
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
)paren
)paren
(braket
l_int|0xD8
)braket
comma
(paren
(paren
id|u_short
op_star
)paren
(paren
id|buf
)paren
)paren
(braket
l_int|0xDA
)braket
comma
id|buf
(braket
l_int|0x1B4
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* 1002 based RLL controler requests converted addressing, but reports physical &n;&t;   (physical 26 sec., logical 17 sec.) &n;&t;   1004 based ???? */
r_if
c_cond
(paren
id|rll
op_amp
id|wd_1002
)paren
(brace
r_if
c_cond
(paren
(paren
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_mul_assign
l_int|26
comma
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_div_assign
l_int|17
)paren
OG
l_int|1023
)paren
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_assign
l_int|1023
suffix:semicolon
multiline_comment|/* 1024 ? */
macro_line|#if 0
id|xd_info
(braket
id|drive
)braket
dot
id|rwrite
op_mul_assign
l_int|26
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|rwrite
op_div_assign
l_int|17
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|wprecomp
op_mul_assign
l_int|26
id|xd_info
(braket
id|drive
)braket
dot
id|wprecomp
op_div_assign
l_int|17
suffix:semicolon
macro_line|#endif /* 0 */
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;xd_wd_init_drive: error reading geometry for xd%c&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|drive
)paren
suffix:semicolon
)brace
DECL|function|xd_seagate_init_controller
r_static
r_void
id|__init
id|xd_seagate_init_controller
(paren
r_int
r_int
id|address
)paren
(brace
r_switch
c_cond
(paren
id|address
)paren
(brace
r_case
l_int|0x00000
suffix:colon
r_case
l_int|0xC8000
suffix:colon
r_break
suffix:semicolon
multiline_comment|/*initial: 0x320 */
r_case
l_int|0xD0000
suffix:colon
id|xd_iobase
op_assign
l_int|0x324
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xD8000
suffix:colon
id|xd_iobase
op_assign
l_int|0x328
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xE0000
suffix:colon
id|xd_iobase
op_assign
l_int|0x32C
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;xd_seagate_init_controller: unsupported BIOS address %06x&bslash;n&quot;
comma
id|address
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|xd_maxsectors
op_assign
l_int|0x40
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|XD_RESET
)paren
suffix:semicolon
multiline_comment|/* reset the controller */
)brace
DECL|function|xd_seagate_init_drive
r_static
r_void
id|__init
id|xd_seagate_init_drive
(paren
id|u_char
id|drive
)paren
(brace
id|u_char
id|cmdblk
(braket
l_int|6
)braket
comma
id|buf
(braket
l_int|0x200
)braket
suffix:semicolon
id|xd_build
c_func
(paren
id|cmdblk
comma
id|CMD_ST11GETGEOM
comma
id|drive
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xd_command
c_func
(paren
id|cmdblk
comma
id|PIO_MODE
comma
id|buf
comma
l_int|0
comma
l_int|0
comma
id|XD_TIMEOUT
op_star
l_int|2
)paren
)paren
(brace
id|xd_info
(braket
id|drive
)braket
dot
id|heads
op_assign
id|buf
(braket
l_int|0x04
)braket
suffix:semicolon
multiline_comment|/* heads */
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_assign
(paren
id|buf
(braket
l_int|0x02
)braket
op_lshift
l_int|8
)paren
op_or
id|buf
(braket
l_int|0x03
)braket
suffix:semicolon
multiline_comment|/* cylinders */
id|xd_info
(braket
id|drive
)braket
dot
id|sectors
op_assign
id|buf
(braket
l_int|0x05
)braket
suffix:semicolon
multiline_comment|/* sectors */
id|xd_info
(braket
id|drive
)braket
dot
id|control
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* control byte */
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;xd_seagate_init_drive: error reading geometry from xd%c&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|drive
)paren
suffix:semicolon
)brace
multiline_comment|/* Omti support courtesy Dirk Melchers */
DECL|function|xd_omti_init_controller
r_static
r_void
id|__init
id|xd_omti_init_controller
(paren
r_int
r_int
id|address
)paren
(brace
r_switch
c_cond
(paren
id|address
)paren
(brace
r_case
l_int|0x00000
suffix:colon
r_case
l_int|0xC8000
suffix:colon
r_break
suffix:semicolon
multiline_comment|/*initial: 0x320 */
r_case
l_int|0xD0000
suffix:colon
id|xd_iobase
op_assign
l_int|0x324
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xD8000
suffix:colon
id|xd_iobase
op_assign
l_int|0x328
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xE0000
suffix:colon
id|xd_iobase
op_assign
l_int|0x32C
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;xd_omti_init_controller: unsupported BIOS address %06x&bslash;n&quot;
comma
id|address
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|xd_maxsectors
op_assign
l_int|0x40
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|XD_RESET
)paren
suffix:semicolon
multiline_comment|/* reset the controller */
)brace
DECL|function|xd_omti_init_drive
r_static
r_void
id|__init
id|xd_omti_init_drive
(paren
id|u_char
id|drive
)paren
(brace
multiline_comment|/* gets infos from drive */
id|xd_override_init_drive
c_func
(paren
id|drive
)paren
suffix:semicolon
multiline_comment|/* set other parameters, Hardcoded, not that nice :-) */
id|xd_info
(braket
id|drive
)braket
dot
id|control
op_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Xebec support (AK) */
DECL|function|xd_xebec_init_controller
r_static
r_void
id|__init
id|xd_xebec_init_controller
(paren
r_int
r_int
id|address
)paren
(brace
multiline_comment|/* iobase may be set manually in range 0x300 - 0x33C&n;      irq may be set manually to 2(9),3,4,5,6,7&n;      dma may be set manually to 1,2,3&n;&t;(How to detect them ???)&n;BIOS address may be set manually in range 0x0 - 0xF8000&n;If you need non-standard settings use the xd=... command */
r_switch
c_cond
(paren
id|address
)paren
(brace
r_case
l_int|0x00000
suffix:colon
r_case
l_int|0xC8000
suffix:colon
multiline_comment|/* initially: xd_iobase==0x320 */
r_case
l_int|0xD0000
suffix:colon
r_case
l_int|0xD2000
suffix:colon
r_case
l_int|0xD4000
suffix:colon
r_case
l_int|0xD6000
suffix:colon
r_case
l_int|0xD8000
suffix:colon
r_case
l_int|0xDA000
suffix:colon
r_case
l_int|0xDC000
suffix:colon
r_case
l_int|0xDE000
suffix:colon
r_case
l_int|0xE0000
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;xd_xebec_init_controller: unsupported BIOS address %06x&bslash;n&quot;
comma
id|address
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|xd_maxsectors
op_assign
l_int|0x01
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|XD_RESET
)paren
suffix:semicolon
multiline_comment|/* reset the controller */
id|xd_timer.expires
op_assign
id|jiffies
op_plus
id|XD_INIT_DISK_DELAY
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|xd_timer
)paren
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|xdc_wait
)paren
suffix:semicolon
)brace
DECL|function|xd_xebec_init_drive
r_static
r_void
id|__init
id|xd_xebec_init_drive
(paren
id|u_char
id|drive
)paren
(brace
multiline_comment|/* values from controller&squot;s BIOS - BIOS chip may be removed */
r_static
id|u_short
id|geometry_table
(braket
)braket
(braket
l_int|5
)braket
op_assign
(brace
(brace
l_int|0x132
comma
l_int|4
comma
l_int|0x080
comma
l_int|0x080
comma
l_int|0x7
)brace
comma
(brace
l_int|0x132
comma
l_int|4
comma
l_int|0x080
comma
l_int|0x080
comma
l_int|0x17
)brace
comma
(brace
l_int|0x264
comma
l_int|2
comma
l_int|0x100
comma
l_int|0x100
comma
l_int|0x7
)brace
comma
(brace
l_int|0x264
comma
l_int|2
comma
l_int|0x100
comma
l_int|0x100
comma
l_int|0x17
)brace
comma
(brace
l_int|0x132
comma
l_int|8
comma
l_int|0x080
comma
l_int|0x080
comma
l_int|0x7
)brace
comma
(brace
l_int|0x132
comma
l_int|8
comma
l_int|0x080
comma
l_int|0x080
comma
l_int|0x17
)brace
comma
(brace
l_int|0x264
comma
l_int|4
comma
l_int|0x100
comma
l_int|0x100
comma
l_int|0x6
)brace
comma
(brace
l_int|0x264
comma
l_int|4
comma
l_int|0x100
comma
l_int|0x100
comma
l_int|0x17
)brace
comma
(brace
l_int|0x2BC
comma
l_int|5
comma
l_int|0x2BC
comma
l_int|0x12C
comma
l_int|0x6
)brace
comma
(brace
l_int|0x3A5
comma
l_int|4
comma
l_int|0x3A5
comma
l_int|0x3A5
comma
l_int|0x7
)brace
comma
(brace
l_int|0x26C
comma
l_int|6
comma
l_int|0x26C
comma
l_int|0x26C
comma
l_int|0x7
)brace
comma
(brace
l_int|0x200
comma
l_int|8
comma
l_int|0x200
comma
l_int|0x100
comma
l_int|0x17
)brace
comma
(brace
l_int|0x400
comma
l_int|5
comma
l_int|0x400
comma
l_int|0x400
comma
l_int|0x7
)brace
comma
(brace
l_int|0x400
comma
l_int|6
comma
l_int|0x400
comma
l_int|0x400
comma
l_int|0x7
)brace
comma
(brace
l_int|0x264
comma
l_int|8
comma
l_int|0x264
comma
l_int|0x200
comma
l_int|0x17
)brace
comma
(brace
l_int|0x33E
comma
l_int|7
comma
l_int|0x33E
comma
l_int|0x200
comma
l_int|0x7
)brace
)brace
suffix:semicolon
id|u_char
id|n
suffix:semicolon
id|n
op_assign
id|inb
c_func
(paren
id|XD_JUMPER
)paren
op_amp
l_int|0x0F
suffix:semicolon
multiline_comment|/* BIOS&squot;s drive number: same geometry &n;&t;&t;&t;&t;&t;is assumed for BOTH drives */
r_if
c_cond
(paren
id|xd_geo
(braket
l_int|3
op_star
id|drive
)braket
)paren
id|xd_manual_geo_set
c_func
(paren
id|drive
)paren
suffix:semicolon
r_else
(brace
id|xd_info
(braket
id|drive
)braket
dot
id|heads
op_assign
(paren
id|u_char
)paren
(paren
id|geometry_table
(braket
id|n
)braket
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* heads */
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* cylinders */
id|xd_info
(braket
id|drive
)braket
dot
id|sectors
op_assign
l_int|17
suffix:semicolon
multiline_comment|/* sectors */
macro_line|#if 0
id|xd_info
(braket
id|drive
)braket
dot
id|rwrite
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* reduced write */
id|xd_info
(braket
id|drive
)braket
dot
id|precomp
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|3
)braket
multiline_comment|/* write precomp */
id|xd_info
(braket
id|drive
)braket
dot
id|ecc
op_assign
l_int|0x0B
suffix:semicolon
multiline_comment|/* ecc length */
macro_line|#endif /* 0 */
)brace
id|xd_info
(braket
id|drive
)braket
dot
id|control
op_assign
id|geometry_table
(braket
id|n
)braket
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* control byte */
id|xd_setparam
c_func
(paren
id|CMD_XBSETPARAM
comma
id|drive
comma
id|xd_info
(braket
id|drive
)braket
dot
id|heads
comma
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
comma
id|geometry_table
(braket
id|n
)braket
(braket
l_int|2
)braket
comma
id|geometry_table
(braket
id|n
)braket
(braket
l_int|3
)braket
comma
l_int|0x0B
)paren
suffix:semicolon
id|xd_recalibrate
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
multiline_comment|/* xd_override_init_drive: this finds disk geometry in a &quot;binary search&quot; style, narrowing in on the &quot;correct&quot; number of heads&n;   etc. by trying values until it gets the highest successful value. Idea courtesy Salvador Abreu (spa@fct.unl.pt). */
DECL|function|xd_override_init_drive
r_static
r_void
id|__init
id|xd_override_init_drive
(paren
id|u_char
id|drive
)paren
(brace
id|u_short
id|min
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
id|max
(braket
)braket
op_assign
(brace
l_int|16
comma
l_int|1024
comma
l_int|64
)brace
comma
id|test
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|u_char
id|cmdblk
(braket
l_int|6
)braket
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|xd_geo
(braket
l_int|3
op_star
id|drive
)braket
)paren
id|xd_manual_geo_set
c_func
(paren
id|drive
)paren
suffix:semicolon
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
id|min
(braket
id|i
)braket
op_ne
id|max
(braket
id|i
)braket
op_minus
l_int|1
)paren
(brace
id|test
(braket
id|i
)braket
op_assign
(paren
id|min
(braket
id|i
)braket
op_plus
id|max
(braket
id|i
)braket
)paren
op_div
l_int|2
suffix:semicolon
id|xd_build
c_func
(paren
id|cmdblk
comma
id|CMD_SEEK
comma
id|drive
comma
(paren
id|u_char
)paren
id|test
(braket
l_int|0
)braket
comma
(paren
id|u_short
)paren
id|test
(braket
l_int|1
)braket
comma
(paren
id|u_char
)paren
id|test
(braket
l_int|2
)braket
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xd_command
c_func
(paren
id|cmdblk
comma
id|PIO_MODE
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|XD_TIMEOUT
op_star
l_int|2
)paren
)paren
id|min
(braket
id|i
)braket
op_assign
id|test
(braket
id|i
)braket
suffix:semicolon
r_else
id|max
(braket
id|i
)braket
op_assign
id|test
(braket
id|i
)braket
suffix:semicolon
)brace
id|test
(braket
id|i
)braket
op_assign
id|min
(braket
id|i
)braket
suffix:semicolon
)brace
id|xd_info
(braket
id|drive
)braket
dot
id|heads
op_assign
(paren
id|u_char
)paren
id|min
(braket
l_int|0
)braket
op_plus
l_int|1
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|cylinders
op_assign
(paren
id|u_short
)paren
id|min
(braket
l_int|1
)braket
op_plus
l_int|1
suffix:semicolon
id|xd_info
(braket
id|drive
)braket
dot
id|sectors
op_assign
(paren
id|u_char
)paren
id|min
(braket
l_int|2
)braket
op_plus
l_int|1
suffix:semicolon
)brace
id|xd_info
(braket
id|drive
)braket
dot
id|control
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* xd_setup: initialise controler from command line parameters */
DECL|function|do_xd_setup
r_void
id|__init
id|do_xd_setup
(paren
r_int
op_star
id|integers
)paren
(brace
r_switch
c_cond
(paren
id|integers
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|4
suffix:colon
r_if
c_cond
(paren
id|integers
(braket
l_int|4
)braket
OL
l_int|0
)paren
id|nodma
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|integers
(braket
l_int|4
)braket
OL
l_int|8
)paren
id|xd_dma
op_assign
id|integers
(braket
l_int|4
)braket
suffix:semicolon
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
(paren
id|integers
(braket
l_int|3
)braket
OG
l_int|0
)paren
op_logical_and
(paren
id|integers
(braket
l_int|3
)braket
op_le
l_int|0x3FC
)paren
)paren
id|xd_iobase
op_assign
id|integers
(braket
l_int|3
)braket
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
(paren
id|integers
(braket
l_int|2
)braket
OG
l_int|0
)paren
op_logical_and
(paren
id|integers
(braket
l_int|2
)braket
OL
l_int|16
)paren
)paren
id|xd_irq
op_assign
id|integers
(braket
l_int|2
)braket
suffix:semicolon
r_case
l_int|1
suffix:colon
id|xd_override
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|integers
(braket
l_int|1
)braket
op_ge
l_int|0
)paren
op_logical_and
(paren
id|integers
(braket
l_int|1
)braket
OL
(paren
r_sizeof
(paren
id|xd_sigs
)paren
op_div
r_sizeof
(paren
id|xd_sigs
(braket
l_int|0
)braket
)paren
)paren
)paren
)paren
id|xd_type
op_assign
id|integers
(braket
l_int|1
)braket
suffix:semicolon
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;xd: too many parameters for xd&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|xd_maxsectors
op_assign
l_int|0x01
suffix:semicolon
)brace
multiline_comment|/* xd_setparam: set the drive characteristics */
DECL|function|xd_setparam
r_static
r_void
id|__init
id|xd_setparam
(paren
id|u_char
id|command
comma
id|u_char
id|drive
comma
id|u_char
id|heads
comma
id|u_short
id|cylinders
comma
id|u_short
id|rwrite
comma
id|u_short
id|wprecomp
comma
id|u_char
id|ecc
)paren
(brace
id|u_char
id|cmdblk
(braket
l_int|14
)braket
suffix:semicolon
id|xd_build
c_func
(paren
id|cmdblk
comma
id|command
comma
id|drive
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|cmdblk
(braket
l_int|6
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|cylinders
op_rshift
l_int|8
)paren
op_amp
l_int|0x03
suffix:semicolon
id|cmdblk
(braket
l_int|7
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|cylinders
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|cmdblk
(braket
l_int|8
)braket
op_assign
id|heads
op_amp
l_int|0x1F
suffix:semicolon
id|cmdblk
(braket
l_int|9
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|rwrite
op_rshift
l_int|8
)paren
op_amp
l_int|0x03
suffix:semicolon
id|cmdblk
(braket
l_int|10
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|rwrite
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|cmdblk
(braket
l_int|11
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|wprecomp
op_rshift
l_int|8
)paren
op_amp
l_int|0x03
suffix:semicolon
id|cmdblk
(braket
l_int|12
)braket
op_assign
(paren
id|u_char
)paren
(paren
id|wprecomp
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|cmdblk
(braket
l_int|13
)braket
op_assign
id|ecc
suffix:semicolon
multiline_comment|/* Some controllers require geometry info as data, not command */
r_if
c_cond
(paren
id|xd_command
c_func
(paren
id|cmdblk
comma
id|PIO_MODE
comma
l_int|0
comma
op_amp
id|cmdblk
(braket
l_int|6
)braket
comma
l_int|0
comma
id|XD_TIMEOUT
op_star
l_int|2
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;xd: error setting characteristics for xd%c&bslash;n&quot;
comma
l_char|&squot;a&squot;
op_plus
id|drive
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|xd
r_static
r_int
id|xd
(braket
l_int|5
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|xd
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|xd_geo
comma
l_string|&quot;3-6i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|nodma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|xd_done
r_static
r_void
id|xd_done
(paren
r_void
)paren
(brace
r_struct
id|gendisk
op_star
op_star
id|gdp
suffix:semicolon
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
l_int|NULL
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
)paren
suffix:semicolon
id|blk_size
(braket
id|MAJOR_NR
)braket
op_assign
l_int|NULL
suffix:semicolon
id|hardsect_size
(braket
id|MAJOR_NR
)braket
op_assign
l_int|NULL
suffix:semicolon
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|gdp
op_assign
op_amp
id|gendisk_head
suffix:semicolon
op_star
id|gdp
suffix:semicolon
id|gdp
op_assign
op_amp
(paren
(paren
op_star
id|gdp
)paren
op_member_access_from_pointer
id|next
)paren
)paren
r_if
c_cond
(paren
op_star
id|gdp
op_eq
op_amp
id|xd_gendisk
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|gdp
)paren
op_star
id|gdp
op_assign
(paren
op_star
id|gdp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|release_region
c_func
(paren
id|xd_iobase
comma
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|error
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|4
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
(paren
(paren
id|xd
(braket
id|i
)braket
op_assign
id|xd
(braket
id|i
op_minus
l_int|1
)braket
)paren
op_ge
l_int|0
)paren
op_logical_and
op_logical_neg
id|count
)paren
(brace
id|count
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|xd
(braket
l_int|0
)braket
op_assign
id|count
)paren
)paren
(brace
id|do_xd_setup
c_func
(paren
id|xd
)paren
suffix:semicolon
)brace
id|error
op_assign
id|xd_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;XD: Loaded as a module.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xd_drives
)paren
(brace
multiline_comment|/* no drives detected - unload module */
id|devfs_unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;xd&quot;
)paren
suffix:semicolon
id|xd_done
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|partition
comma
id|dev
comma
id|start
suffix:semicolon
id|devfs_unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;xd&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|xd_drives
suffix:semicolon
id|dev
op_increment
)paren
(brace
id|start
op_assign
id|dev
op_lshift
id|xd_gendisk.minor_shift
suffix:semicolon
r_for
c_loop
(paren
id|partition
op_assign
id|xd_gendisk.max_p
op_minus
l_int|1
suffix:semicolon
id|partition
op_ge
l_int|0
suffix:semicolon
id|partition
op_decrement
)paren
(brace
r_int
id|minor
op_assign
(paren
id|start
op_or
id|partition
)paren
suffix:semicolon
id|kdev_t
id|devp
op_assign
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|minor
)paren
suffix:semicolon
id|start
op_assign
id|dev
op_lshift
id|xd_gendisk.minor_shift
suffix:semicolon
id|sync_dev
c_func
(paren
id|devp
)paren
suffix:semicolon
id|invalidate_buffers
c_func
(paren
id|devp
)paren
suffix:semicolon
)brace
)brace
id|xd_done
c_func
(paren
)paren
suffix:semicolon
id|devfs_unregister
(paren
id|devfs_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_drives
)paren
(brace
id|free_irq
c_func
(paren
id|xd_irq
comma
l_int|NULL
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|xd_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xd_dma_buffer
)paren
id|xd_dma_mem_free
c_func
(paren
(paren
r_int
r_int
)paren
id|xd_dma_buffer
comma
id|xd_maxsectors
op_star
l_int|0x200
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
DECL|function|xd_setup
r_static
r_int
id|__init
id|xd_setup
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|5
)braket
suffix:semicolon
id|get_options
(paren
id|str
comma
id|ARRAY_SIZE
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|do_xd_setup
(paren
id|ints
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* xd_manual_geo_init: initialise drive geometry from command line parameters&n;   (used only for WD drives) */
DECL|function|xd_manual_geo_init
r_static
r_int
id|__init
id|xd_manual_geo_init
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|i
comma
id|integers
(braket
l_int|1
op_plus
l_int|3
op_star
id|XD_MAXDRIVES
)braket
suffix:semicolon
id|get_options
(paren
id|str
comma
id|ARRAY_SIZE
(paren
id|integers
)paren
comma
id|integers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|integers
(braket
l_int|0
)braket
op_mod
l_int|3
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;xd: incorrect number of parameters for xd_geo&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|integers
(braket
l_int|0
)braket
)paren
op_logical_and
(paren
id|i
OL
l_int|3
op_star
id|XD_MAXDRIVES
)paren
suffix:semicolon
id|i
op_increment
)paren
id|xd_geo
(braket
id|i
)braket
op_assign
id|integers
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
(paren
l_string|&quot;xd=&quot;
comma
id|xd_setup
)paren
suffix:semicolon
id|__setup
(paren
l_string|&quot;xd_geo=&quot;
comma
id|xd_manual_geo_init
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
eof
