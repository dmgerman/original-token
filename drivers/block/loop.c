multiline_comment|/*&n; *  linux/drivers/block/loop.c&n; *&n; *  Written by Theodore Ts&squot;o, 3/29/93&n; * &n; * Copyright 1993 by Theodore Ts&squot;o.  Redistribution of this file is&n; * permitted under the GNU Public License.&n; *&n; * DES encryption plus some minor changes by Werner Almesberger, 30-MAY-1993&n; * more DES encryption plus IDEA encryption by Nicholas J. Leon, June 20, 1996&n; *&n; * Modularized and updated for 1.1.16 kernel - Mitch Dsouza 28th May 1994&n; * Adapted for 1.3.59 kernel - Andries Brouwer, 1 Feb 1996&n; *&n; * Fixed do_loop_request() re-entrancy - Vincent.Renardias@waw.com Mar 20, 1997&n; *&n; * Added devfs support - Richard Gooch &lt;rgooch@atnf.csiro.au&gt; 16-Jan-1998&n; *&n; * Handle sparse backing files correctly - Kenn Humborg, Jun 28, 1998&n; *&n; * Loadable modules and other fixes by AK, 1998&n; *&n; * Make real block number available to downstream transfer functions, enables&n; * CBC (and relatives) mode encryption requiring unique IVs per data block. &n; * Reed H. Petty, rhp@draper.net&n; *&n; * Maximum number of loop devices now dynamic via max_loop module parameter.&n; * Russell Kroll &lt;rkroll@exploits.org&gt; 19990701&n; * &n; * Maximum number of loop devices when compiled-in now selectable by passing&n; * max_loop=&lt;1-255&gt; to the kernel on boot.&n; * Erik I. Bols&#xfffd;, &lt;eriki@himolde.no&gt;, Oct 31, 1999&n; *&n; * Still To Fix:&n; * - Advisory locking is ignored here. &n; * - Should use an own CAP_* category instead of CAP_SYS_ADMIN &n; * - Should use the underlying filesystems/devices read function if possible&n; *   to support read ahead (and for write)&n; *&n; * WARNING/FIXME:&n; * - The block number as IV passing to low level transfer functions is broken:&n; *   it passes the underlying device&squot;s block number instead of the&n; *   offset. This makes it change for a given block when the file is &n; *   moved/restored/copied and also doesn&squot;t work over NFS. &n; * AV, Feb 12, 2000: we pass the logical block number now. It fixes the&n; *   problem above. Encryption modules that used to rely on the old scheme&n; *   should just call -&gt;i_mapping-&gt;bmap() to calculate the physical block&n; *   number.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/loop.h&gt;&t;&t;
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR LOOP_MAJOR
DECL|macro|DEVICE_NAME
mdefine_line|#define DEVICE_NAME &quot;loop&quot;
DECL|macro|DEVICE_REQUEST
mdefine_line|#define DEVICE_REQUEST do_lo_request
DECL|macro|DEVICE_NR
mdefine_line|#define DEVICE_NR(device) (MINOR(device))
DECL|macro|DEVICE_ON
mdefine_line|#define DEVICE_ON(device)
DECL|macro|DEVICE_OFF
mdefine_line|#define DEVICE_OFF(device)
DECL|macro|DEVICE_NO_RANDOM
mdefine_line|#define DEVICE_NO_RANDOM
DECL|macro|TIMEOUT_VALUE
mdefine_line|#define TIMEOUT_VALUE (6 * HZ)
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
DECL|variable|max_loop
r_static
r_int
id|max_loop
op_assign
l_int|8
suffix:semicolon
DECL|variable|loop_dev
r_static
r_struct
id|loop_device
op_star
id|loop_dev
suffix:semicolon
DECL|variable|loop_sizes
r_static
r_int
op_star
id|loop_sizes
suffix:semicolon
DECL|variable|loop_blksizes
r_static
r_int
op_star
id|loop_blksizes
suffix:semicolon
DECL|variable|devfs_handle
r_static
id|devfs_handle_t
id|devfs_handle
suffix:semicolon
multiline_comment|/*  For the directory */
DECL|macro|FALSE
mdefine_line|#define FALSE 0
DECL|macro|TRUE
mdefine_line|#define TRUE (!FALSE)
multiline_comment|/*&n; * Transfer functions&n; */
DECL|function|transfer_none
r_static
r_int
id|transfer_none
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
id|cmd
comma
r_char
op_star
id|raw_buf
comma
r_char
op_star
id|loop_buf
comma
r_int
id|size
comma
r_int
id|real_block
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|READ
)paren
id|memcpy
c_func
(paren
id|loop_buf
comma
id|raw_buf
comma
id|size
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|raw_buf
comma
id|loop_buf
comma
id|size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|transfer_xor
r_static
r_int
id|transfer_xor
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
id|cmd
comma
r_char
op_star
id|raw_buf
comma
r_char
op_star
id|loop_buf
comma
r_int
id|size
comma
r_int
id|real_block
)paren
(brace
r_char
op_star
id|in
comma
op_star
id|out
comma
op_star
id|key
suffix:semicolon
r_int
id|i
comma
id|keysize
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|READ
)paren
(brace
id|in
op_assign
id|raw_buf
suffix:semicolon
id|out
op_assign
id|loop_buf
suffix:semicolon
)brace
r_else
(brace
id|in
op_assign
id|loop_buf
suffix:semicolon
id|out
op_assign
id|raw_buf
suffix:semicolon
)brace
id|key
op_assign
id|lo-&gt;lo_encrypt_key
suffix:semicolon
id|keysize
op_assign
id|lo-&gt;lo_encrypt_key_size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
op_star
id|out
op_increment
op_assign
op_star
id|in
op_increment
op_xor
id|key
(braket
(paren
id|i
op_amp
l_int|511
)paren
op_mod
id|keysize
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|none_status
r_static
r_int
id|none_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info
op_star
id|info
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|xor_status
r_static
r_int
id|xor_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;lo_encrypt_key_size
op_le
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|none_funcs
r_struct
id|loop_func_table
id|none_funcs
op_assign
(brace
id|number
suffix:colon
id|LO_CRYPT_NONE
comma
id|transfer
suffix:colon
id|transfer_none
comma
id|init
suffix:colon
id|none_status
)brace
suffix:semicolon
DECL|variable|xor_funcs
r_struct
id|loop_func_table
id|xor_funcs
op_assign
(brace
id|number
suffix:colon
id|LO_CRYPT_XOR
comma
id|transfer
suffix:colon
id|transfer_xor
comma
id|init
suffix:colon
id|xor_status
)brace
suffix:semicolon
multiline_comment|/* xfer_funcs[0] is special - its release function is never called */
DECL|variable|xfer_funcs
r_struct
id|loop_func_table
op_star
id|xfer_funcs
(braket
id|MAX_LO_CRYPT
)braket
op_assign
(brace
op_amp
id|none_funcs
comma
op_amp
id|xor_funcs
)brace
suffix:semicolon
DECL|macro|MAX_DISK_SIZE
mdefine_line|#define MAX_DISK_SIZE 1024*1024*1024
DECL|function|figure_loop_size
r_static
r_void
id|figure_loop_size
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
)paren
(brace
r_int
id|size
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|lo-&gt;lo_dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
id|size
op_assign
(paren
id|lo-&gt;lo_dentry-&gt;d_inode-&gt;i_size
op_minus
id|lo-&gt;lo_offset
)paren
op_rshift
id|BLOCK_SIZE_BITS
suffix:semicolon
r_else
(brace
id|kdev_t
id|lodev
op_assign
id|lo-&gt;lo_device
suffix:semicolon
r_if
c_cond
(paren
id|blk_size
(braket
id|MAJOR
c_func
(paren
id|lodev
)paren
)braket
)paren
id|size
op_assign
id|blk_size
(braket
id|MAJOR
c_func
(paren
id|lodev
)paren
)braket
(braket
id|MINOR
c_func
(paren
id|lodev
)paren
)braket
op_minus
(paren
id|lo-&gt;lo_offset
op_rshift
id|BLOCK_SIZE_BITS
)paren
suffix:semicolon
r_else
id|size
op_assign
id|MAX_DISK_SIZE
suffix:semicolon
)brace
id|loop_sizes
(braket
id|lo-&gt;lo_number
)braket
op_assign
id|size
suffix:semicolon
)brace
DECL|function|lo_send
r_static
r_int
id|lo_send
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_char
op_star
id|data
comma
r_int
id|len
comma
id|loff_t
id|pos
comma
r_int
id|blksize
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
multiline_comment|/* kudos to NFsckingS */
r_struct
id|address_space
op_star
id|mapping
op_assign
id|lo-&gt;lo_dentry-&gt;d_inode-&gt;i_mapping
suffix:semicolon
r_struct
id|address_space_operations
op_star
id|aops
op_assign
id|mapping-&gt;a_ops
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_char
op_star
id|kaddr
suffix:semicolon
r_int
r_int
id|index
suffix:semicolon
r_int
id|size
comma
id|offset
suffix:semicolon
id|index
op_assign
id|pos
op_rshift
id|PAGE_CACHE_SHIFT
suffix:semicolon
id|offset
op_assign
id|pos
op_amp
(paren
id|PAGE_CACHE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|IV
op_assign
id|index
op_star
(paren
id|PAGE_CACHE_SIZE
op_div
id|blksize
)paren
op_plus
id|offset
op_div
id|blksize
suffix:semicolon
id|size
op_assign
id|PAGE_CACHE_SIZE
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|len
)paren
id|size
op_assign
id|len
suffix:semicolon
id|page
op_assign
id|grab_cache_page
c_func
(paren
id|mapping
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
id|aops
op_member_access_from_pointer
id|prepare_write
c_func
(paren
id|file
comma
id|page
comma
id|offset
comma
id|offset
op_plus
id|size
)paren
)paren
r_goto
id|unlock
suffix:semicolon
id|kaddr
op_assign
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lo-&gt;transfer
)paren
(paren
id|lo
comma
id|WRITE
comma
id|kaddr
op_plus
id|offset
comma
id|data
comma
id|size
comma
id|IV
)paren
)paren
r_goto
id|write_fail
suffix:semicolon
r_if
c_cond
(paren
id|aops
op_member_access_from_pointer
id|commit_write
c_func
(paren
id|file
comma
id|page
comma
id|offset
comma
id|offset
op_plus
id|size
)paren
)paren
r_goto
id|unlock
suffix:semicolon
id|data
op_add_assign
id|size
suffix:semicolon
id|len
op_sub_assign
id|size
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|index
op_increment
suffix:semicolon
id|pos
op_add_assign
id|size
suffix:semicolon
id|UnlockPage
c_func
(paren
id|page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|write_fail
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: transfer error block %ld&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
id|ClearPageUptodate
c_func
(paren
id|page
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|unlock
suffix:colon
id|UnlockPage
c_func
(paren
id|page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
id|fail
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|struct|lo_read_data
r_struct
id|lo_read_data
(brace
DECL|member|lo
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
DECL|member|data
r_char
op_star
id|data
suffix:semicolon
DECL|member|blksize
r_int
id|blksize
suffix:semicolon
)brace
suffix:semicolon
DECL|function|lo_read_actor
r_static
r_int
id|lo_read_actor
c_func
(paren
id|read_descriptor_t
op_star
id|desc
comma
r_struct
id|page
op_star
id|page
comma
r_int
r_int
id|offset
comma
r_int
r_int
id|size
)paren
(brace
r_char
op_star
id|kaddr
suffix:semicolon
r_int
r_int
id|count
op_assign
id|desc-&gt;count
suffix:semicolon
r_struct
id|lo_read_data
op_star
id|p
op_assign
(paren
r_struct
id|lo_read_data
op_star
)paren
id|desc-&gt;buf
suffix:semicolon
r_struct
id|loop_device
op_star
id|lo
op_assign
id|p-&gt;lo
suffix:semicolon
r_int
id|IV
op_assign
id|page-&gt;index
op_star
(paren
id|PAGE_CACHE_SIZE
op_div
id|p-&gt;blksize
)paren
op_plus
id|offset
op_div
id|p-&gt;blksize
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|count
)paren
id|size
op_assign
id|count
suffix:semicolon
id|kaddr
op_assign
id|kmap
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lo-&gt;transfer
)paren
(paren
id|lo
comma
id|READ
comma
id|kaddr
op_plus
id|offset
comma
id|p-&gt;data
comma
id|size
comma
id|IV
)paren
)paren
(brace
id|size
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: transfer error block %ld&bslash;n&quot;
comma
id|page-&gt;index
)paren
suffix:semicolon
id|desc-&gt;error
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|kunmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|desc-&gt;count
op_assign
id|count
op_minus
id|size
suffix:semicolon
id|desc-&gt;written
op_add_assign
id|size
suffix:semicolon
id|p-&gt;data
op_add_assign
id|size
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
DECL|function|lo_receive
r_static
r_int
id|lo_receive
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_char
op_star
id|data
comma
r_int
id|len
comma
id|loff_t
id|pos
comma
r_int
id|blksize
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
r_struct
id|lo_read_data
id|cookie
suffix:semicolon
id|read_descriptor_t
id|desc
suffix:semicolon
id|cookie.lo
op_assign
id|lo
suffix:semicolon
id|cookie.data
op_assign
id|data
suffix:semicolon
id|cookie.blksize
op_assign
id|blksize
suffix:semicolon
id|desc.written
op_assign
l_int|0
suffix:semicolon
id|desc.count
op_assign
id|len
suffix:semicolon
id|desc.buf
op_assign
(paren
r_char
op_star
)paren
op_amp
id|cookie
suffix:semicolon
id|desc.error
op_assign
l_int|0
suffix:semicolon
id|do_generic_file_read
c_func
(paren
id|file
comma
op_amp
id|pos
comma
op_amp
id|desc
comma
id|lo_read_actor
)paren
suffix:semicolon
r_return
id|desc.error
suffix:semicolon
)brace
DECL|function|do_lo_request
r_static
r_void
id|do_lo_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_int
id|block
comma
id|offset
comma
id|len
comma
id|blksize
comma
id|size
suffix:semicolon
r_char
op_star
id|dest_addr
suffix:semicolon
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|request
op_star
id|current_request
suffix:semicolon
id|loff_t
id|pos
suffix:semicolon
id|repeat
suffix:colon
id|INIT_REQUEST
suffix:semicolon
id|current_request
op_assign
id|CURRENT
suffix:semicolon
id|blkdev_dequeue_request
c_func
(paren
id|current_request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MINOR
c_func
(paren
id|current_request-&gt;rq_dev
)paren
op_ge
id|max_loop
)paren
r_goto
id|error_out
suffix:semicolon
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|MINOR
c_func
(paren
id|current_request-&gt;rq_dev
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lo-&gt;lo_dentry
op_logical_or
op_logical_neg
id|lo-&gt;transfer
)paren
r_goto
id|error_out
suffix:semicolon
r_if
c_cond
(paren
id|current_request-&gt;cmd
op_eq
id|WRITE
)paren
(brace
r_if
c_cond
(paren
id|lo-&gt;lo_flags
op_amp
id|LO_FLAGS_READ_ONLY
)paren
r_goto
id|error_out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|current_request-&gt;cmd
op_ne
id|READ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;unknown loop device command (%d)?!?&quot;
comma
id|current_request-&gt;cmd
)paren
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
id|dest_addr
op_assign
id|current_request-&gt;buffer
suffix:semicolon
id|len
op_assign
id|current_request-&gt;current_nr_sectors
op_lshift
l_int|9
suffix:semicolon
id|blksize
op_assign
id|BLOCK_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|blksize_size
(braket
id|MAJOR
c_func
(paren
id|lo-&gt;lo_device
)paren
)braket
)paren
(brace
id|blksize
op_assign
id|blksize_size
(braket
id|MAJOR
c_func
(paren
id|lo-&gt;lo_device
)paren
)braket
(braket
id|MINOR
c_func
(paren
id|lo-&gt;lo_device
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|blksize
)paren
id|blksize
op_assign
id|BLOCK_SIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lo-&gt;lo_flags
op_amp
id|LO_FLAGS_DO_BMAP
)paren
r_goto
id|file_backed
suffix:semicolon
r_if
c_cond
(paren
id|blksize
OL
l_int|512
)paren
(brace
id|block
op_assign
id|current_request-&gt;sector
op_star
(paren
l_int|512
op_div
id|blksize
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|block
op_assign
id|current_request-&gt;sector
op_div
(paren
id|blksize
op_rshift
l_int|9
)paren
suffix:semicolon
id|offset
op_assign
(paren
id|current_request-&gt;sector
op_mod
(paren
id|blksize
op_rshift
l_int|9
)paren
)paren
op_lshift
l_int|9
suffix:semicolon
)brace
id|block
op_add_assign
id|lo-&gt;lo_offset
op_div
id|blksize
suffix:semicolon
id|offset
op_add_assign
id|lo-&gt;lo_offset
op_mod
id|blksize
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_ge
id|blksize
)paren
(brace
id|block
op_increment
suffix:semicolon
id|offset
op_sub_assign
id|blksize
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
id|size
op_assign
id|blksize
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|len
)paren
id|size
op_assign
id|len
suffix:semicolon
id|bh
op_assign
id|getblk
c_func
(paren
id|lo-&gt;lo_device
comma
id|block
comma
id|blksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: device %s: getblk(-, %d, %d) returned NULL&quot;
comma
id|kdevname
c_func
(paren
id|lo-&gt;lo_device
)paren
comma
id|block
comma
id|blksize
)paren
suffix:semicolon
r_goto
id|error_out_lock
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|buffer_uptodate
c_func
(paren
id|bh
)paren
op_logical_and
(paren
(paren
id|current_request-&gt;cmd
op_eq
id|READ
)paren
op_logical_or
(paren
id|offset
op_logical_or
(paren
id|len
OL
id|blksize
)paren
)paren
)paren
)paren
(brace
id|ll_rw_block
c_func
(paren
id|READ
comma
l_int|1
comma
op_amp
id|bh
)paren
suffix:semicolon
id|wait_on_buffer
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer_uptodate
c_func
(paren
id|bh
)paren
)paren
(brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_goto
id|error_out_lock
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|lo-&gt;transfer
)paren
(paren
id|lo
comma
id|current_request-&gt;cmd
comma
id|bh-&gt;b_data
op_plus
id|offset
comma
id|dest_addr
comma
id|size
comma
id|block
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: transfer error block %d&bslash;n&quot;
comma
id|block
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_goto
id|error_out_lock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|current_request-&gt;cmd
op_eq
id|WRITE
)paren
(brace
id|mark_buffer_uptodate
c_func
(paren
id|bh
comma
l_int|1
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|dest_addr
op_add_assign
id|size
suffix:semicolon
id|len
op_sub_assign
id|size
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|block
op_increment
suffix:semicolon
)brace
r_goto
id|done
suffix:semicolon
id|file_backed
suffix:colon
id|pos
op_assign
(paren
(paren
id|loff_t
)paren
id|current_request-&gt;sector
op_lshift
l_int|9
)paren
op_plus
id|lo-&gt;lo_offset
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_request-&gt;cmd
op_eq
id|WRITE
)paren
(brace
r_if
c_cond
(paren
id|lo_send
c_func
(paren
id|lo
comma
id|dest_addr
comma
id|len
comma
id|pos
comma
id|blksize
)paren
)paren
r_goto
id|error_out_lock
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lo_receive
c_func
(paren
id|lo
comma
id|dest_addr
comma
id|len
comma
id|pos
comma
id|blksize
)paren
)paren
r_goto
id|error_out_lock
suffix:semicolon
)brace
id|done
suffix:colon
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|current_request-&gt;sector
op_add_assign
id|current_request-&gt;current_nr_sectors
suffix:semicolon
id|current_request-&gt;nr_sectors
op_sub_assign
id|current_request-&gt;current_nr_sectors
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|current_request-&gt;queue
comma
op_amp
id|q-&gt;queue_head
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
id|error_out_lock
suffix:colon
id|spin_lock_irq
c_func
(paren
op_amp
id|io_request_lock
)paren
suffix:semicolon
id|error_out
suffix:colon
id|list_add
c_func
(paren
op_amp
id|current_request-&gt;queue
comma
op_amp
id|q-&gt;queue_head
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
DECL|function|loop_set_fd
r_static
r_int
id|loop_set_fd
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
id|kdev_t
id|dev
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|error
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_dentry
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
id|file
op_assign
id|fget
c_func
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|inode
op_assign
id|file-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
id|S_ISBLK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
multiline_comment|/* dentry will be wired, so... */
id|error
op_assign
id|blkdev_get
c_func
(paren
id|inode-&gt;i_bdev
comma
id|file-&gt;f_mode
comma
id|file-&gt;f_flags
comma
id|BDEV_FILE
)paren
suffix:semicolon
id|lo-&gt;lo_device
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
id|lo-&gt;lo_flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Backed by a block device - don&squot;t need to hold onto&n;&t;&t;   a file structure */
id|lo-&gt;lo_backing_file
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_putf
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
r_struct
id|address_space_operations
op_star
id|aops
suffix:semicolon
id|aops
op_assign
id|inode-&gt;i_mapping-&gt;a_ops
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we can&squot;t read - sorry. If we only can&squot;t write - well,&n;&t;&t; * it&squot;s going to be read-only.&n;&t;&t; */
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aops-&gt;readpage
)paren
r_goto
id|out_putf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aops-&gt;prepare_write
op_logical_or
op_logical_neg
id|aops-&gt;commit_write
)paren
id|lo-&gt;lo_flags
op_or_assign
id|LO_FLAGS_READ_ONLY
suffix:semicolon
id|error
op_assign
id|get_write_access
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_putf
suffix:semicolon
multiline_comment|/* Backed by a regular file - we need to hold onto a file&n;&t;&t;   structure for this file.  Friggin&squot; NFS can&squot;t live without&n;&t;&t;   it on write and for reading we use do_generic_file_read(),&n;&t;&t;   so...  We create a new file structure based on the one&n;&t;&t;   passed to us via &squot;arg&squot;.  This is to avoid changing the file&n;&t;&t;   structure that the caller is using */
id|lo-&gt;lo_device
op_assign
id|inode-&gt;i_dev
suffix:semicolon
id|lo-&gt;lo_flags
op_or_assign
id|LO_FLAGS_DO_BMAP
suffix:semicolon
id|error
op_assign
op_minus
id|ENFILE
suffix:semicolon
id|lo-&gt;lo_backing_file
op_assign
id|get_empty_filp
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_backing_file
op_eq
l_int|NULL
)paren
(brace
id|put_write_access
c_func
(paren
id|inode
)paren
suffix:semicolon
r_goto
id|out_putf
suffix:semicolon
)brace
id|lo-&gt;lo_backing_file-&gt;f_mode
op_assign
id|file-&gt;f_mode
suffix:semicolon
id|lo-&gt;lo_backing_file-&gt;f_pos
op_assign
id|file-&gt;f_pos
suffix:semicolon
id|lo-&gt;lo_backing_file-&gt;f_flags
op_assign
id|file-&gt;f_flags
suffix:semicolon
id|lo-&gt;lo_backing_file-&gt;f_owner
op_assign
id|file-&gt;f_owner
suffix:semicolon
id|lo-&gt;lo_backing_file-&gt;f_dentry
op_assign
id|file-&gt;f_dentry
suffix:semicolon
id|lo-&gt;lo_backing_file-&gt;f_vfsmnt
op_assign
id|mntget
c_func
(paren
id|file-&gt;f_vfsmnt
)paren
suffix:semicolon
id|lo-&gt;lo_backing_file-&gt;f_op
op_assign
id|fops_get
c_func
(paren
id|file-&gt;f_op
)paren
suffix:semicolon
id|lo-&gt;lo_backing_file-&gt;private_data
op_assign
id|file-&gt;private_data
suffix:semicolon
id|file_moveto
c_func
(paren
id|lo-&gt;lo_backing_file
comma
id|file
)paren
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IS_RDONLY
(paren
id|inode
)paren
op_logical_or
id|is_read_only
c_func
(paren
id|lo-&gt;lo_device
)paren
)paren
id|lo-&gt;lo_flags
op_or_assign
id|LO_FLAGS_READ_ONLY
suffix:semicolon
id|set_device_ro
c_func
(paren
id|dev
comma
(paren
id|lo-&gt;lo_flags
op_amp
id|LO_FLAGS_READ_ONLY
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|lo-&gt;lo_dentry
op_assign
id|dget
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
id|lo-&gt;transfer
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;ioctl
op_assign
l_int|NULL
suffix:semicolon
id|figure_loop_size
c_func
(paren
id|lo
)paren
suffix:semicolon
id|out_putf
suffix:colon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|error
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|loop_release_xfer
r_static
r_int
id|loop_release_xfer
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_encrypt_type
)paren
(brace
r_struct
id|loop_func_table
op_star
id|xfer
op_assign
id|xfer_funcs
(braket
id|lo-&gt;lo_encrypt_type
)braket
suffix:semicolon
r_if
c_cond
(paren
id|xfer
op_logical_and
id|xfer-&gt;release
)paren
id|err
op_assign
id|xfer
op_member_access_from_pointer
id|release
c_func
(paren
id|lo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xfer
op_logical_and
id|xfer-&gt;unlock
)paren
id|xfer
op_member_access_from_pointer
id|unlock
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;lo_encrypt_type
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|loop_init_xfer
r_static
r_int
id|loop_init_xfer
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
id|type
comma
r_struct
id|loop_info
op_star
id|i
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|type
)paren
(brace
r_struct
id|loop_func_table
op_star
id|xfer
op_assign
id|xfer_funcs
(braket
id|type
)braket
suffix:semicolon
r_if
c_cond
(paren
id|xfer-&gt;init
)paren
id|err
op_assign
id|xfer
op_member_access_from_pointer
id|init
c_func
(paren
id|lo
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|lo-&gt;lo_encrypt_type
op_assign
id|type
suffix:semicolon
r_if
c_cond
(paren
id|xfer-&gt;lock
)paren
id|xfer
op_member_access_from_pointer
id|lock
c_func
(paren
id|lo
)paren
suffix:semicolon
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|loop_clr_fd
r_static
r_int
id|loop_clr_fd
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
id|kdev_t
id|dev
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
op_assign
id|lo-&gt;lo_dentry
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_refcnt
OG
l_int|1
)paren
multiline_comment|/* we needed one fd for the ioctl */
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|S_ISBLK
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
id|blkdev_put
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_bdev
comma
id|BDEV_FILE
)paren
suffix:semicolon
id|lo-&gt;lo_dentry
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_backing_file
op_ne
l_int|NULL
)paren
(brace
r_struct
id|file
op_star
id|filp
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
r_if
c_cond
(paren
(paren
id|filp-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_eq
l_int|0
)paren
id|put_write_access
c_func
(paren
id|filp-&gt;f_dentry-&gt;d_inode
)paren
suffix:semicolon
id|fput
c_func
(paren
id|filp
)paren
suffix:semicolon
id|lo-&gt;lo_backing_file
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
id|loop_release_xfer
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;transfer
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;ioctl
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_device
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_encrypt_type
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_offset
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_encrypt_key_size
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|lo-&gt;lo_encrypt_key
comma
l_int|0
comma
id|LO_KEY_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|lo-&gt;lo_name
comma
l_int|0
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|loop_sizes
(braket
id|lo-&gt;lo_number
)braket
op_assign
l_int|0
suffix:semicolon
id|invalidate_buffers
c_func
(paren
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|loop_set_status
r_static
r_int
id|loop_set_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info
op_star
id|arg
)paren
(brace
r_struct
id|loop_info
id|info
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
r_int
id|type
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_encrypt_key_size
op_logical_and
id|lo-&gt;lo_key_owner
op_ne
id|current-&gt;uid
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lo-&gt;lo_dentry
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|loop_info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|info.lo_encrypt_key_size
OG
id|LO_KEY_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|type
op_assign
id|info.lo_encrypt_type
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ge
id|MAX_LO_CRYPT
op_logical_or
id|xfer_funcs
(braket
id|type
)braket
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|LO_CRYPT_XOR
op_logical_and
id|info.lo_encrypt_key_size
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|loop_release_xfer
c_func
(paren
id|lo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
id|loop_init_xfer
c_func
(paren
id|lo
comma
id|type
comma
op_amp
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|lo-&gt;lo_offset
op_assign
id|info.lo_offset
suffix:semicolon
id|strncpy
c_func
(paren
id|lo-&gt;lo_name
comma
id|info.lo_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|lo-&gt;transfer
op_assign
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|transfer
suffix:semicolon
id|lo-&gt;ioctl
op_assign
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|ioctl
suffix:semicolon
id|lo-&gt;lo_encrypt_key_size
op_assign
id|info.lo_encrypt_key_size
suffix:semicolon
id|lo-&gt;lo_init
(braket
l_int|0
)braket
op_assign
id|info.lo_init
(braket
l_int|0
)braket
suffix:semicolon
id|lo-&gt;lo_init
(braket
l_int|1
)braket
op_assign
id|info.lo_init
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info.lo_encrypt_key_size
)paren
(brace
id|memcpy
c_func
(paren
id|lo-&gt;lo_encrypt_key
comma
id|info.lo_encrypt_key
comma
id|info.lo_encrypt_key_size
)paren
suffix:semicolon
id|lo-&gt;lo_key_owner
op_assign
id|current-&gt;uid
suffix:semicolon
)brace
id|figure_loop_size
c_func
(paren
id|lo
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|loop_get_status
r_static
r_int
id|loop_get_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info
op_star
id|arg
)paren
(brace
r_struct
id|loop_info
id|info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lo-&gt;lo_dentry
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|info.lo_number
op_assign
id|lo-&gt;lo_number
suffix:semicolon
id|info.lo_device
op_assign
id|kdev_t_to_nr
c_func
(paren
id|lo-&gt;lo_dentry-&gt;d_inode-&gt;i_dev
)paren
suffix:semicolon
id|info.lo_inode
op_assign
id|lo-&gt;lo_dentry-&gt;d_inode-&gt;i_ino
suffix:semicolon
id|info.lo_rdevice
op_assign
id|kdev_t_to_nr
c_func
(paren
id|lo-&gt;lo_device
)paren
suffix:semicolon
id|info.lo_offset
op_assign
id|lo-&gt;lo_offset
suffix:semicolon
id|info.lo_flags
op_assign
id|lo-&gt;lo_flags
suffix:semicolon
id|strncpy
c_func
(paren
id|info.lo_name
comma
id|lo-&gt;lo_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|info.lo_encrypt_type
op_assign
id|lo-&gt;lo_encrypt_type
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_encrypt_key_size
op_logical_and
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|info.lo_encrypt_key_size
op_assign
id|lo-&gt;lo_encrypt_key_size
suffix:semicolon
id|memcpy
c_func
(paren
id|info.lo_encrypt_key
comma
id|lo-&gt;lo_encrypt_key
comma
id|lo-&gt;lo_encrypt_key_size
)paren
suffix:semicolon
)brace
r_return
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|lo_ioctl
r_static
r_int
id|lo_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_int
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ne
id|MAJOR_NR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;lo_ioctl: pseudo-major != %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|max_loop
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|dev
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|LOOP_SET_FD
suffix:colon
r_return
id|loop_set_fd
c_func
(paren
id|lo
comma
id|inode-&gt;i_rdev
comma
id|arg
)paren
suffix:semicolon
r_case
id|LOOP_CLR_FD
suffix:colon
r_return
id|loop_clr_fd
c_func
(paren
id|lo
comma
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_case
id|LOOP_SET_STATUS
suffix:colon
r_return
id|loop_set_status
c_func
(paren
id|lo
comma
(paren
r_struct
id|loop_info
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|LOOP_GET_STATUS
suffix:colon
r_return
id|loop_get_status
c_func
(paren
id|lo
comma
(paren
r_struct
id|loop_info
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|BLKGETSIZE
suffix:colon
multiline_comment|/* Return device size */
r_if
c_cond
(paren
op_logical_neg
id|lo-&gt;lo_dentry
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|loop_sizes
(braket
id|lo-&gt;lo_number
)braket
op_lshift
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_return
id|lo-&gt;ioctl
ques
c_cond
id|lo
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|lo
comma
id|cmd
comma
id|arg
)paren
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lo_open
r_static
r_int
id|lo_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_int
id|dev
comma
id|type
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ne
id|MAJOR_NR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;lo_open: pseudo-major != %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|max_loop
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|dev
)braket
suffix:semicolon
id|type
op_assign
id|lo-&gt;lo_encrypt_type
suffix:semicolon
r_if
c_cond
(paren
id|type
op_logical_and
id|xfer_funcs
(braket
id|type
)braket
op_logical_and
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|lock
)paren
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|lock
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;lo_refcnt
op_increment
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lo_release
r_static
r_int
id|lo_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_int
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ne
id|MAJOR_NR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;lo_release: pseudo-major != %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|max_loop
)paren
r_return
l_int|0
suffix:semicolon
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_refcnt
op_le
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;lo_release: refcount(%d) &lt;= 0&bslash;n&quot;
comma
id|lo-&gt;lo_refcnt
)paren
suffix:semicolon
r_else
(brace
r_int
id|type
op_assign
id|lo-&gt;lo_encrypt_type
suffix:semicolon
op_decrement
id|lo-&gt;lo_refcnt
suffix:semicolon
r_if
c_cond
(paren
id|xfer_funcs
(braket
id|type
)braket
op_logical_and
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|unlock
)paren
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|unlock
c_func
(paren
id|lo
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|lo_fops
r_static
r_struct
id|block_device_operations
id|lo_fops
op_assign
(brace
id|open
suffix:colon
id|lo_open
comma
id|release
suffix:colon
id|lo_release
comma
id|ioctl
suffix:colon
id|lo_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * And now the modules code and kernel interface.&n; */
macro_line|#ifdef MODULE
DECL|macro|loop_init
mdefine_line|#define loop_init init_module
id|MODULE_PARM
c_func
(paren
id|max_loop
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_loop
comma
l_string|&quot;Maximum number of loop devices (1-255)&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|function|loop_register_transfer
r_int
id|loop_register_transfer
c_func
(paren
r_struct
id|loop_func_table
op_star
id|funcs
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|funcs-&gt;number
OG
id|MAX_LO_CRYPT
op_logical_or
id|xfer_funcs
(braket
id|funcs-&gt;number
)braket
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|xfer_funcs
(braket
id|funcs-&gt;number
)braket
op_assign
id|funcs
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|loop_unregister_transfer
r_int
id|loop_unregister_transfer
c_func
(paren
r_int
id|number
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|number
op_ge
id|MAX_LO_CRYPT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|lo
op_assign
op_amp
id|loop_dev
(braket
l_int|0
)braket
suffix:semicolon
id|lo
OL
op_amp
id|loop_dev
(braket
id|max_loop
)braket
suffix:semicolon
id|lo
op_increment
)paren
(brace
r_int
id|type
op_assign
id|lo-&gt;lo_encrypt_type
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|number
)paren
(brace
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|release
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;transfer
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_encrypt_type
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|xfer_funcs
(braket
id|number
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|loop_register_transfer
id|EXPORT_SYMBOL
c_func
(paren
id|loop_register_transfer
)paren
suffix:semicolon
DECL|variable|loop_unregister_transfer
id|EXPORT_SYMBOL
c_func
(paren
id|loop_unregister_transfer
)paren
suffix:semicolon
DECL|function|no_plug_device
r_static
r_void
id|no_plug_device
c_func
(paren
id|request_queue_t
op_star
id|q
comma
id|kdev_t
id|device
)paren
(brace
)brace
DECL|function|loop_init
r_int
id|__init
id|loop_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|devfs_register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;loop&quot;
comma
op_amp
id|lo_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unable to get major number %d for loop device&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|devfs_handle
op_assign
id|devfs_mk_dir
(paren
l_int|NULL
comma
l_string|&quot;loop&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|devfs_register_series
(paren
id|devfs_handle
comma
l_string|&quot;%u&quot;
comma
id|max_loop
comma
id|DEVFS_FL_DEFAULT
comma
id|MAJOR_NR
comma
l_int|0
comma
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
comma
op_amp
id|lo_fops
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|max_loop
OL
l_int|1
)paren
op_logical_or
(paren
id|max_loop
OG
l_int|255
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;loop: invalid max_loop (must be between 1 and 255), using default (8)&bslash;n&quot;
)paren
suffix:semicolon
id|max_loop
op_assign
l_int|8
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;loop: enabling %d loop devices&bslash;n&quot;
comma
id|max_loop
)paren
suffix:semicolon
id|loop_dev
op_assign
id|kmalloc
(paren
id|max_loop
op_star
r_sizeof
(paren
r_struct
id|loop_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_dev
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;loop: Unable to create loop_dev&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|loop_sizes
op_assign
id|kmalloc
c_func
(paren
id|max_loop
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_sizes
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;loop: Unable to create loop_sizes&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|loop_dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|loop_blksizes
op_assign
id|kmalloc
(paren
id|max_loop
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_blksizes
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;loop: Unable to create loop_blksizes&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|loop_dev
)paren
suffix:semicolon
id|kfree
(paren
id|loop_sizes
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|blk_init_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|DEVICE_REQUEST
)paren
suffix:semicolon
id|blk_queue_pluggable
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|no_plug_device
)paren
suffix:semicolon
id|blk_queue_headactive
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_loop
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|loop_dev
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|loop_device
)paren
)paren
suffix:semicolon
id|loop_dev
(braket
id|i
)braket
dot
id|lo_number
op_assign
id|i
suffix:semicolon
)brace
id|memset
c_func
(paren
id|loop_sizes
comma
l_int|0
comma
id|max_loop
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|loop_blksizes
comma
l_int|0
comma
id|max_loop
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|blk_size
(braket
id|MAJOR_NR
)braket
op_assign
id|loop_sizes
suffix:semicolon
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|loop_blksizes
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_loop
suffix:semicolon
id|i
op_increment
)paren
id|register_disk
c_func
(paren
l_int|NULL
comma
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|i
)paren
comma
l_int|1
comma
op_amp
id|lo_fops
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|devfs_unregister
(paren
id|devfs_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devfs_unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;loop&quot;
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;loop: cannot unregister blkdev&bslash;n&quot;
)paren
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
)paren
suffix:semicolon
id|kfree
(paren
id|loop_dev
)paren
suffix:semicolon
id|kfree
(paren
id|loop_sizes
)paren
suffix:semicolon
id|kfree
(paren
id|loop_blksizes
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifndef MODULE
DECL|function|max_loop_setup
r_static
r_int
id|__init
id|max_loop_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|max_loop
op_assign
id|simple_strtol
c_func
(paren
id|str
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;max_loop=&quot;
comma
id|max_loop_setup
)paren
suffix:semicolon
macro_line|#endif
eof
