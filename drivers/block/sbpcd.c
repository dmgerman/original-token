multiline_comment|/*&n; *  sbpcd.c   CD-ROM device driver for the whole family of IDE-style&n; *            Kotobuki/Matsushita/Panasonic CR-5xx drives for&n; *            SoundBlaster (&quot;Pro&quot; or &quot;16 ASP&quot; or compatible) cards&n; *            and for &quot;no-sound&quot; interfaces like Lasermate and the&n; *            Panasonic CI-101P.&n; *&n; *  NOTE:     This is release 2.0.&n; *            It works with my SbPro &amp; drive CR-521 V2.11 from 2/92&n; *            and with the new CR-562-B V0.75 on a &quot;naked&quot; Panasonic&n; *            CI-101P interface. And vice versa. &n; *  &n; *&n; *  VERSION HISTORY&n; *&n; *  0.1  initial release, April/May 93, after mcd.c (Martin Harriss)&n; *&n; *  0.2  the &quot;repeat:&quot;-loop in do_sbpcd_request did not check for&n; *       end-of-request_queue (resulting in kernel panic).&n; *       Flow control seems stable, but throughput is not better.  &n; *&n; *  0.3  interrupt locking totally eliminated (maybe &quot;inb&quot; and &quot;outb&quot;&n; *       are still locking) - 0.2 made keyboard-type-ahead losses.&n; *       check_sbpcd_media_change added (to use by isofs/inode.c)&n; *       - but it detects almost nothing.&n; *&n; *  0.4  use MAJOR 25 definitely.&n; *       Almost total re-design to support double-speed drives and&n; *       &quot;naked&quot; (no sound) interface cards.&n; *       Flow control should be exact now (tell me if not).&n; *       Don&squot;t occupy the SbPro IRQ line (not needed either); will&n; *       live together with Hannu Savolainen&squot;s sndkit now.&n; *&t; Speeded up data transfer to 150 kB/sec, with help from Kai&n; *       Makisara, the &quot;provider&quot; of the &quot;mt&quot; tape utility.&n; *       Give &quot;SpinUp&quot; command if necessary.&n; *       First steps to support up to 4 drives (but currently only one).&n; *       Implemented audio capabilities - workman should work, xcdplayer&n; *       gives some problems.&n; *       This version is still consuming too much CPU time, and&n; *       sleeping still has to be worked on.&n; *       During &quot;long&quot; implied seeks, it seems possible that a &n; *       ReadStatus command gets ignored. That gives the message&n; *       &quot;ResponseStatus timed out&quot; (happens about 6 times here during&n; *       a &quot;ls -alR&quot; of the YGGDRASIL LGX-Beta CD). Such a case is&n; *       handled without data error, but it should get done better.&n; *&n; *  0.5  Free CPU during waits (again with help from Kai Makisara).&n; *       Made it work together with the LILO/kernel setup standard.&n; *       Included auto-probing code, as suggested by YGGDRASIL.&n; *       Formal redesign to add DDI debugging.&n; *       There are still flaws in IOCTL (workman with double speed drive).&n; *&n; *  1.0  Added support for all drive ids (0...3, no longer only 0)&n; *       and up to 4 drives on one controller.&n; *       Added &quot;#define MANY_SESSION&quot; for &quot;old&quot; multi session CDs.&n; *&n; *  1.1  Do SpinUp for new drives, too.&n; *       Revised for clean compile under &quot;old&quot; kernels (pl9).&n; *&n; *  1.2  Found the &quot;workman with double-speed drive&quot; bug: use the driver&squot;s&n; *       audio_state, not what the drive is reporting with ReadSubQ.&n; *&n; *  1.3  Minor cleanups.&n; *       Refinements regarding Workman.&n; *&n; *  1.4  Read XA disks (PhotoCDs) with &quot;old&quot; drives, too (but possibly only&n; *       the first session - I could not try a &quot;multi-session&quot; CD yet).&n; *       This currently still is too slow (50 kB/sec) - but possibly&n; *       the old drives won&squot;t do it faster.&n; *       Implemented &quot;door (un)lock&quot; for new drives (still does not work&n; *       as wanted - no lock possible after an unlock).&n; *       Added some debugging printout for the UPC/EAN code - but my drives &n; *       return only zeroes. Is there no UPC/EAN code written?&n; *&n; *  1.5  Laborate with UPC/EAN code (not better yet).&n; *       Adapt to kernel 1.1.8 change (have to explicitely include&n; *       &lt;linux/string.h&gt; now).&n; *&n; *  1.6  Trying to read audio frames as data. Impossible with the current&n; *       drive firmware levels, as it seems. Awaiting any hint. ;-)&n; *       Changed &quot;door unlock&quot;: repeat it until success.&n; *       Changed CDROMSTOP routine (stop somewhat &quot;softer&quot; so that Workman&n; *       won&squot;t get confused).&n; *       Added a third interface type: Sequoia S-1000, as used with the SPEA&n; *       Media FX sound card. This interface (useable for Sony and Mitsumi &n; *       drives, too) needs a special configuration setup and behaves like a &n; *       LaserMate type after that. Still experimental - I do not have such&n; *       an interface.&n; *       Use the &quot;variable BLOCK_SIZE&quot; feature (2048). But it does only work&n; *       if you give the mount option &quot;block=2048&quot;.&n; *       The media_check routine is currently disabled; now that it gets&n; *       called as it should I fear it must get synchronized for not to&n; *       disturb the normal driver&squot;s activity.&n; *&n; *  2.0  Version number bumped - two reasons:&n; *       - reading audio tracks as data works now with CR-562 and CR-563. We&n; *       currently do it by an IOCTL (yet has to get standardized), one frame&n; *       at a time; that is pretty slow. But it works.&n; *       - we are maintaining now up to 4 interfaces (each up to 4 drives):&n; *       did it the easy way - a different MAJOR (25, 26, ...) and a different&n; *       copy of the driver (sbpcd.c, sbpcd2.c, sbpcd3.c, sbpcd4.c - only&n; *       distinguished by the value of SBPCD_ISSUE and the driver&squot;s name),&n; *       and a common sbpcd.h file.&n; *       Bettered the &quot;ReadCapacity error&quot; problem with old CR-52x drives (the&n; *       drives sometimes need a manual &quot;eject/insert&quot; before work): just&n; *       reset the drive and do again. Needs lots of resets here and sometimes&n; *       that does not cure, so this can&squot;t be the solution.&n; *&n; *     special thanks to Kai Makisara (kai.makisara@vtt.fi) for his fine&n; *     elaborated speed-up experiments (and the fabulous results!), for&n; *     the &quot;push&quot; towards load-free wait loops, and for the extensive mail&n; *     thread which brought additional hints and bug fixes.&n; * &n; *&n; *   Copyright (C) 1993, 1994  Eberhard Moenkeberg &lt;emoenke@gwdg.de&gt;&n; *                         or &lt;eberhard_moenkeberg@rollo.central.de&gt;&n; *&n; *                  The FTP-home of this driver is &n; *                  ftp.gwdg.de:/pub/linux/cdrom/drivers/sbpcd/.&n; *&n; *                  If you change this software, you should mail a .diff&n; *                  file with some description lines to emoenke@gwdg.de.&n; *                  I want to know about it.&n; *&n; *                  If you are the editor of a Linux CD, you should&n; *                  enable sbpcd.c within your boot floppy kernel and&n; *                  send me one of your CDs for free.&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2, or (at your option)&n; *   any later version.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   (for example /usr/src/linux/COPYING); if not, write to the Free&n; *   Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
DECL|macro|SBPCD_ISSUE
mdefine_line|#define SBPCD_ISSUE 1 /* change to 2, 3, 4 for multiple interface boards */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
multiline_comment|/* #undef DS */
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/cdrom.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/major.h&gt; 
macro_line|#include &lt;linux/sbpcd.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;stdarg.h&gt;
macro_line|#if !(SBPCD_ISSUE-1)
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR MATSUSHITA_CDROM_MAJOR
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-2)
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR MATSUSHITA_CDROM2_MAJOR /* second driver issue */
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-3)
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR MATSUSHITA_CDROM3_MAJOR /* third driver issue */
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-4)
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR MATSUSHITA_CDROM4_MAJOR /* fourth driver issue */
macro_line|#endif
macro_line|#include &quot;blk.h&quot;
DECL|macro|VERSION
mdefine_line|#define VERSION &quot;2.0 Eberhard Moenkeberg &lt;emoenke@gwdg.de&gt;&quot;
DECL|macro|SBPCD_DEBUG
mdefine_line|#define SBPCD_DEBUG
macro_line|#ifndef CONFIG_ISO9660_FS
macro_line|#error &quot;SBPCD: &bslash;&quot;make config&bslash;&quot; again. File system iso9660 is necessary.&quot;
macro_line|#endif
multiline_comment|/*&n; * This may come back some day..&n; */
DECL|macro|DDIOCSDBG
mdefine_line|#define DDIOCSDBG&t;0x9000
multiline_comment|/*&n; * still testing around...&n; */
DECL|macro|LONG_TIMING
mdefine_line|#define LONG_TIMING 0 /* test against timeouts with &quot;gold&quot; CDs on CR-521 */
DECL|macro|MANY_SESSION
mdefine_line|#define MANY_SESSION 0 /* this will conflict with &quot;true&quot; multi-session! */
DECL|macro|FUTURE
macro_line|#undef  FUTURE
DECL|macro|WORKMAN
mdefine_line|#define WORKMAN 1 /* some testing stuff to make it better */
DECL|macro|CDMKE
mdefine_line|#define CDMKE /* makes timing independent of processor speed */
DECL|macro|XA_TEST1
macro_line|#undef XA_TEST1
DECL|macro|XA_TEST2
mdefine_line|#define XA_TEST2
DECL|macro|TEST_UPC
mdefine_line|#define TEST_UPC 0
DECL|macro|READ_AUDIO
mdefine_line|#define READ_AUDIO 1
DECL|macro|SPEA_TEST
mdefine_line|#define SPEA_TEST 0
DECL|macro|PRINTK_BUG
mdefine_line|#define PRINTK_BUG 0
DECL|macro|TEST_STI
mdefine_line|#define TEST_STI 0
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * provisions for more than 1 driver issues&n; * currently up to 4 drivers, expandable&n; */
macro_line|#if !(SBPCD_ISSUE-1)
DECL|macro|SBPCD_IOCTL_F
mdefine_line|#define SBPCD_IOCTL_F sbpcd_ioctl
DECL|macro|SBPCD_IOCTL
mdefine_line|#define SBPCD_IOCTL(a,b,c,d) sbpcd_ioctl(a,b,c,d)
DECL|macro|DO_SBPCD_REQUEST
mdefine_line|#define DO_SBPCD_REQUEST(a) do_sbpcd_request(a)
DECL|macro|SBPCD_OPEN_F
mdefine_line|#define SBPCD_OPEN_F sbpcd_open
DECL|macro|SBPCD_OPEN
mdefine_line|#define SBPCD_OPEN(a,b) sbpcd_open(a,b)
DECL|macro|SBPCD_RELEASE_F
mdefine_line|#define SBPCD_RELEASE_F sbpcd_release
DECL|macro|SBPCD_RELEASE
mdefine_line|#define SBPCD_RELEASE(a,b) sbpcd_release(a,b)
DECL|macro|SBPCD_SETUP
mdefine_line|#define SBPCD_SETUP(a,b) sbpcd_setup(a,b)
DECL|macro|SBPCD_INIT
mdefine_line|#define SBPCD_INIT(a,b) sbpcd_init(a,b)
DECL|macro|SBPCD_MEDIA_CHANGE
mdefine_line|#define SBPCD_MEDIA_CHANGE(a,b) check_sbpcd_media_change(a,b)
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-2)
DECL|macro|SBPCD_IOCTL_F
mdefine_line|#define SBPCD_IOCTL_F sbpcd2_ioctl
DECL|macro|SBPCD_IOCTL
mdefine_line|#define SBPCD_IOCTL(a,b,c,d) sbpcd2_ioctl(a,b,c,d)
DECL|macro|DO_SBPCD_REQUEST
mdefine_line|#define DO_SBPCD_REQUEST(a) do_sbpcd2_request(a)
DECL|macro|SBPCD_OPEN_F
mdefine_line|#define SBPCD_OPEN_F sbpcd2_open
DECL|macro|SBPCD_OPEN
mdefine_line|#define SBPCD_OPEN(a,b) sbpcd2_open(a,b)
DECL|macro|SBPCD_RELEASE_F
mdefine_line|#define SBPCD_RELEASE_F sbpcd2_release
DECL|macro|SBPCD_RELEASE
mdefine_line|#define SBPCD_RELEASE(a,b) sbpcd2_release(a,b)
DECL|macro|SBPCD_SETUP
mdefine_line|#define SBPCD_SETUP(a,b) sbpcd2_setup(a,b)
DECL|macro|SBPCD_INIT
mdefine_line|#define SBPCD_INIT(a,b) sbpcd2_init(a,b)
DECL|macro|SBPCD_MEDIA_CHANGE
mdefine_line|#define SBPCD_MEDIA_CHANGE(a,b) check_sbpcd2_media_change(a,b)
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-3)
DECL|macro|SBPCD_IOCTL_F
mdefine_line|#define SBPCD_IOCTL_F sbpcd3_ioctl
DECL|macro|SBPCD_IOCTL
mdefine_line|#define SBPCD_IOCTL(a,b,c,d) sbpcd3_ioctl(a,b,c,d)
DECL|macro|DO_SBPCD_REQUEST
mdefine_line|#define DO_SBPCD_REQUEST(a) do_sbpcd3_request(a)
DECL|macro|SBPCD_OPEN_F
mdefine_line|#define SBPCD_OPEN_F sbpcd3_open
DECL|macro|SBPCD_OPEN
mdefine_line|#define SBPCD_OPEN(a,b) sbpcd3_open(a,b)
DECL|macro|SBPCD_RELEASE_F
mdefine_line|#define SBPCD_RELEASE_F sbpcd3_release
DECL|macro|SBPCD_RELEASE
mdefine_line|#define SBPCD_RELEASE(a,b) sbpcd3_release(a,b)
DECL|macro|SBPCD_SETUP
mdefine_line|#define SBPCD_SETUP(a,b) sbpcd3_setup(a,b)
DECL|macro|SBPCD_INIT
mdefine_line|#define SBPCD_INIT(a,b) sbpcd3_init(a,b)
DECL|macro|SBPCD_MEDIA_CHANGE
mdefine_line|#define SBPCD_MEDIA_CHANGE(a,b) check_sbpcd3_media_change(a,b)
macro_line|#endif
macro_line|#if !(SBPCD_ISSUE-4)
DECL|macro|SBPCD_IOCTL_F
mdefine_line|#define SBPCD_IOCTL_F sbpcd4_ioctl
DECL|macro|SBPCD_IOCTL
mdefine_line|#define SBPCD_IOCTL(a,b,c,d) sbpcd4_ioctl(a,b,c,d)
DECL|macro|DO_SBPCD_REQUEST
mdefine_line|#define DO_SBPCD_REQUEST(a) do_sbpcd4_request(a)
DECL|macro|SBPCD_OPEN_F
mdefine_line|#define SBPCD_OPEN_F sbpcd4_open
DECL|macro|SBPCD_OPEN
mdefine_line|#define SBPCD_OPEN(a,b) sbpcd4_open(a,b)
DECL|macro|SBPCD_RELEASE_F
mdefine_line|#define SBPCD_RELEASE_F sbpcd4_release
DECL|macro|SBPCD_RELEASE
mdefine_line|#define SBPCD_RELEASE(a,b) sbpcd4_release(a,b)
DECL|macro|SBPCD_SETUP
mdefine_line|#define SBPCD_SETUP(a,b) sbpcd4_setup(a,b)
DECL|macro|SBPCD_INIT
mdefine_line|#define SBPCD_INIT(a,b) sbpcd4_init(a,b)
DECL|macro|SBPCD_MEDIA_CHANGE
mdefine_line|#define SBPCD_MEDIA_CHANGE(a,b) check_sbpcd4_media_change(a,b)
macro_line|#endif
multiline_comment|/*==========================================================================*/
macro_line|#if MANY_SESSION
DECL|macro|LONG_TIMING
macro_line|#undef LONG_TIMING
DECL|macro|LONG_TIMING
mdefine_line|#define LONG_TIMING 1
macro_line|#endif
multiline_comment|/*==========================================================================*/
macro_line|#if SBPCD_DIS_IRQ
DECL|macro|SBPCD_CLI
mdefine_line|#define SBPCD_CLI cli()
DECL|macro|SBPCD_STI
mdefine_line|#define SBPCD_STI sti()
macro_line|#else
DECL|macro|SBPCD_CLI
mdefine_line|#define SBPCD_CLI
DECL|macro|SBPCD_STI
mdefine_line|#define SBPCD_STI
macro_line|#endif SBPCD_DIS_IRQ
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * auto-probing address list&n; * inspired by Adam J. Richter from Yggdrasil&n; *&n; * still not good enough - can cause a hang.&n; *   example: a NE 2000 ethernet card at 300 will cause a hang probing 310.&n; * if that happens, reboot and use the LILO (kernel) command line.&n; * The possibly conflicting ethernet card addresses get NOT probed &n; * by default - to minimize the hang possibilities. &n; *&n; * The SB Pro addresses get &quot;mirrored&quot; at 0x6xx - to avoid a type error,&n; * the 0x2xx-addresses must get checked before 0x6xx.&n; *&n; * send mail to emoenke@gwdg.de if your interface card is not FULLY&n; * represented here.&n; */
DECL|variable|autoprobe
r_static
r_int
id|autoprobe
(braket
)braket
op_assign
(brace
id|CDROM_PORT
comma
id|SBPRO
comma
multiline_comment|/* probe with user&squot;s setup first */
l_int|0x230
comma
l_int|1
comma
multiline_comment|/* Soundblaster Pro and 16 (default) */
l_int|0x300
comma
l_int|0
comma
multiline_comment|/* CI-101P (default), Galaxy (default), Reveal (one default) */
l_int|0x250
comma
l_int|1
comma
multiline_comment|/* OmniCD default, Soundblaster Pro and 16 */
l_int|0x260
comma
l_int|1
comma
multiline_comment|/* OmniCD */
l_int|0x320
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P, Galaxy, Reveal (other default) */
l_int|0x340
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P */
l_int|0x360
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P */
l_int|0x270
comma
l_int|1
comma
multiline_comment|/* Soundblaster 16 */
l_int|0x670
comma
l_int|0
comma
multiline_comment|/* &quot;sound card #9&quot; */
l_int|0x690
comma
l_int|0
comma
multiline_comment|/* &quot;sound card #9&quot; */
l_int|0x330
comma
l_int|2
comma
multiline_comment|/* SPEA Media FX (default) */
l_int|0x320
comma
l_int|2
comma
multiline_comment|/* SPEA Media FX */
l_int|0x340
comma
l_int|2
comma
multiline_comment|/* SPEA Media FX */
l_int|0x350
comma
l_int|2
comma
multiline_comment|/* SPEA Media FX */
macro_line|#if 0
multiline_comment|/* some &quot;hazardous&quot; locations (ethernet cards) */
l_int|0x330
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P */
l_int|0x350
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P */
l_int|0x370
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P */
l_int|0x290
comma
l_int|1
comma
multiline_comment|/* Soundblaster 16 */
l_int|0x310
comma
l_int|0
comma
multiline_comment|/* Lasermate, CI-101P */
multiline_comment|/* excluded due to incomplete address decoding of the SbPro card */
l_int|0x630
comma
l_int|0
comma
multiline_comment|/* &quot;sound card #9&quot; (default) */
l_int|0x650
comma
l_int|0
comma
multiline_comment|/* &quot;sound card #9&quot; */
macro_line|#endif
)brace
suffix:semicolon
DECL|macro|NUM_AUTOPROBE
mdefine_line|#define NUM_AUTOPROBE  (sizeof(autoprobe) / sizeof(int))
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * the forward references:&n; */
r_static
r_void
id|sbp_read_cmd
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sbp_data
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|cmd_out
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * pattern for printk selection:&n; *&n; * (1&lt;&lt;DBG_INF)  necessary information&n; * (1&lt;&lt;DBG_BSZ)  BLOCK_SIZE trace&n; * (1&lt;&lt;DBG_REA)  &quot;read&quot; status trace&n; * (1&lt;&lt;DBG_CHK)  &quot;media check&quot; trace&n; * (1&lt;&lt;DBG_TIM)  datarate timer test&n; * (1&lt;&lt;DBG_INI)  initialization trace&n; * (1&lt;&lt;DBG_TOC)  tell TocEntry values&n; * (1&lt;&lt;DBG_IOC)  ioctl trace&n; * (1&lt;&lt;DBG_STA)  &quot;ResponseStatus&quot; trace&n; * (1&lt;&lt;DBG_ERR)  &quot;xx_ReadError&quot; trace&n; * (1&lt;&lt;DBG_CMD)  &quot;cmd_out&quot; trace&n; * (1&lt;&lt;DBG_WRN)  give explanation before auto-probing&n; * (1&lt;&lt;DBG_MUL)  multi session code test&n; * (1&lt;&lt;DBG_ID)   &quot;drive_id != 0&quot; test code&n; * (1&lt;&lt;DBG_IOX)  some special information&n; * (1&lt;&lt;DBG_DID)  drive ID test&n; * (1&lt;&lt;DBG_RES)  drive reset info&n; * (1&lt;&lt;DBG_SPI)  SpinUp test info&n; * (1&lt;&lt;DBG_IOS)  ioctl trace: &quot;subchannel&quot;&n; * (1&lt;&lt;DBG_IO2)  ioctl trace: general&n; * (1&lt;&lt;DBG_UPC)  show UPC info&n; * (1&lt;&lt;DBG_XA)   XA mode debugging&n; * (1&lt;&lt;DBG_LCK)  door (un)lock info&n; * (1&lt;&lt;DBG_SQ)   dump SubQ frame&n; * (1&lt;&lt;DBG_AUD)  &quot;read audio&quot; debugging&n; * (1&lt;&lt;DBG_SEQ)  Sequoia interface configuration trace&n; * (1&lt;&lt;DBG_000)  unnecessary information&n; */
macro_line|#if 1
DECL|variable|sbpcd_debug
r_static
r_int
id|sbpcd_debug
op_assign
(paren
l_int|1
op_lshift
id|DBG_INF
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_WRN
)paren
suffix:semicolon
macro_line|#else
macro_line|#if SPEA_TEST
DECL|variable|sbpcd_debug
r_static
r_int
id|sbpcd_debug
op_assign
(paren
l_int|1
op_lshift
id|DBG_INF
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_INI
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_ID
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_SEQ
)paren
suffix:semicolon
macro_line|#else
DECL|variable|sbpcd_debug
r_static
r_int
id|sbpcd_debug
op_assign
(paren
l_int|1
op_lshift
id|DBG_INF
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_TOC
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_UPC
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_TIM
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_LCK
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_CHK
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_AUD
)paren
op_or
(paren
l_int|1
op_lshift
id|DBG_IOX
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
DECL|variable|sbpcd_ioaddr
r_static
r_int
id|sbpcd_ioaddr
op_assign
id|CDROM_PORT
suffix:semicolon
multiline_comment|/* default I/O base address */
DECL|variable|sbpro_type
r_static
r_int
id|sbpro_type
op_assign
id|SBPRO
suffix:semicolon
DECL|variable|CDo_command
DECL|variable|CDo_reset
r_static
r_int
id|CDo_command
comma
id|CDo_reset
suffix:semicolon
DECL|variable|CDo_sel_d_i
DECL|variable|CDo_enable
r_static
r_int
id|CDo_sel_d_i
comma
id|CDo_enable
suffix:semicolon
DECL|variable|CDi_info
DECL|variable|CDi_status
DECL|variable|CDi_data
r_static
r_int
id|CDi_info
comma
id|CDi_status
comma
id|CDi_data
suffix:semicolon
DECL|variable|MIXER_addr
DECL|variable|MIXER_data
r_static
r_int
id|MIXER_addr
comma
id|MIXER_data
suffix:semicolon
DECL|variable|msf
r_static
r_struct
id|cdrom_msf
id|msf
suffix:semicolon
DECL|variable|ti
r_static
r_struct
id|cdrom_ti
id|ti
suffix:semicolon
DECL|variable|tochdr
r_static
r_struct
id|cdrom_tochdr
id|tochdr
suffix:semicolon
DECL|variable|tocentry
r_static
r_struct
id|cdrom_tocentry
id|tocentry
suffix:semicolon
DECL|variable|SC
r_static
r_struct
id|cdrom_subchnl
id|SC
suffix:semicolon
DECL|variable|volctrl
r_static
r_struct
id|cdrom_volctrl
id|volctrl
suffix:semicolon
DECL|variable|read_audio
r_static
r_struct
id|cdrom_read_audio
id|read_audio
suffix:semicolon
DECL|variable|str_sb
r_static
r_char
op_star
id|str_sb
op_assign
l_string|&quot;SoundBlaster&quot;
suffix:semicolon
DECL|variable|str_lm
r_static
r_char
op_star
id|str_lm
op_assign
l_string|&quot;LaserMate&quot;
suffix:semicolon
DECL|variable|str_sp
r_static
r_char
op_star
id|str_sp
op_assign
l_string|&quot;SPEA&quot;
suffix:semicolon
DECL|variable|type
r_char
op_star
id|type
suffix:semicolon
multiline_comment|/*==========================================================================*/
macro_line|#if FUTURE
DECL|variable|sbp_waitq
r_static
r_struct
id|wait_queue
op_star
id|sbp_waitq
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif FUTURE
multiline_comment|/*==========================================================================*/
DECL|macro|SBP_BUFFER_FRAMES
mdefine_line|#define SBP_BUFFER_FRAMES 4 /* driver&squot;s own read_ahead */
multiline_comment|/*==========================================================================*/
DECL|variable|drive_family
r_static
id|u_char
id|drive_family
(braket
)braket
op_assign
l_string|&quot;CR-5&quot;
suffix:semicolon
DECL|variable|drive_vendor
r_static
id|u_char
id|drive_vendor
(braket
)braket
op_assign
l_string|&quot;MATSHITA&quot;
suffix:semicolon
DECL|variable|response_count
r_static
id|u_int
id|response_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|flags_cmd_out
r_static
id|u_int
id|flags_cmd_out
suffix:semicolon
DECL|variable|cmd_type
r_static
id|u_char
id|cmd_type
op_assign
l_int|0
suffix:semicolon
DECL|variable|drvcmd
r_static
id|u_char
id|drvcmd
(braket
l_int|7
)braket
suffix:semicolon
DECL|variable|infobuf
r_static
id|u_char
id|infobuf
(braket
l_int|20
)braket
suffix:semicolon
DECL|variable|xa_head_buf
r_static
id|u_char
id|xa_head_buf
(braket
id|CD_XA_HEAD
)braket
suffix:semicolon
DECL|variable|xa_tail_buf
r_static
id|u_char
id|xa_tail_buf
(braket
id|CD_XA_TAIL
)braket
suffix:semicolon
DECL|variable|timed_out
r_static
id|u_char
id|timed_out
op_assign
l_int|0
suffix:semicolon
DECL|variable|datarate
r_static
id|u_int
id|datarate
op_assign
l_int|1000000
suffix:semicolon
DECL|variable|maxtim16
r_static
id|u_int
id|maxtim16
op_assign
l_int|16000000
suffix:semicolon
DECL|variable|maxtim04
r_static
id|u_int
id|maxtim04
op_assign
l_int|4000000
suffix:semicolon
DECL|variable|maxtim02
r_static
id|u_int
id|maxtim02
op_assign
l_int|2000000
suffix:semicolon
DECL|variable|maxtim_8
r_static
id|u_int
id|maxtim_8
op_assign
l_int|30000
suffix:semicolon
macro_line|#if LONG_TIMING
DECL|variable|maxtim_data
r_static
id|u_int
id|maxtim_data
op_assign
l_int|9000
suffix:semicolon
macro_line|#else
DECL|variable|maxtim_data
r_static
id|u_int
id|maxtim_data
op_assign
l_int|3000
suffix:semicolon
macro_line|#endif LONG_TIMING
multiline_comment|/*==========================================================================*/
DECL|variable|ndrives
r_static
r_int
id|ndrives
op_assign
l_int|0
suffix:semicolon
DECL|variable|drv_pattern
r_static
id|u_char
id|drv_pattern
(braket
l_int|4
)braket
op_assign
initialization_block
suffix:semicolon
multiline_comment|/* auto speed */
multiline_comment|/*  /X:... drv_pattern[0] |= (sax_n1|sax_n2);         */
multiline_comment|/*  /A:... for (i=0;i&lt;4;i++) drv_pattern[i] |= sax_a; */
multiline_comment|/*  /N:... ndrives=i-&squot;0&squot;;                             */
DECL|variable|sbpcd_blocksizes
r_static
r_int
id|sbpcd_blocksizes
(braket
id|NR_SBPCD
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * drive space begins here (needed separate for each unit) &n; */
DECL|variable|d
r_static
r_int
id|d
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DriveStruct index: drive number */
r_static
r_struct
(brace
DECL|member|drv_minor
r_char
id|drv_minor
suffix:semicolon
multiline_comment|/* minor number or -1 */
DECL|member|drive_model
r_char
id|drive_model
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|firmware_version
r_char
id|firmware_version
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|sbp_buf
id|u_char
op_star
id|sbp_buf
suffix:semicolon
multiline_comment|/* Pointer to internal data buffer,&n;                           space allocated during sbpcd_init() */
DECL|member|sbp_first_frame
r_int
id|sbp_first_frame
suffix:semicolon
multiline_comment|/* First frame in buffer */
DECL|member|sbp_last_frame
r_int
id|sbp_last_frame
suffix:semicolon
multiline_comment|/* Last frame in buffer  */
DECL|member|sbp_read_frames
r_int
id|sbp_read_frames
suffix:semicolon
multiline_comment|/* Number of frames being read to buffer */
DECL|member|sbp_current
r_int
id|sbp_current
suffix:semicolon
multiline_comment|/* Frame being currently read */
DECL|member|mode
id|u_char
id|mode
suffix:semicolon
multiline_comment|/* read_mode: READ_M1, READ_M2, READ_SC, READ_AU */
macro_line|#if READ_AUDIO
DECL|member|aud_buf
id|u_char
op_star
id|aud_buf
suffix:semicolon
multiline_comment|/* Pointer to audio data buffer,&n;                                 space allocated during sbpcd_init() */
macro_line|#endif READ_AUDIO
DECL|member|drv_type
id|u_char
id|drv_type
suffix:semicolon
DECL|member|drv_options
id|u_char
id|drv_options
suffix:semicolon
DECL|member|status_byte
id|u_char
id|status_byte
suffix:semicolon
DECL|member|diskstate_flags
id|u_char
id|diskstate_flags
suffix:semicolon
DECL|member|sense_byte
id|u_char
id|sense_byte
suffix:semicolon
DECL|member|CD_changed
id|u_char
id|CD_changed
suffix:semicolon
DECL|member|open_count
id|u_char
id|open_count
suffix:semicolon
DECL|member|error_byte
id|u_char
id|error_byte
suffix:semicolon
DECL|member|f_multisession
id|u_char
id|f_multisession
suffix:semicolon
DECL|member|lba_multi
id|u_int
id|lba_multi
suffix:semicolon
DECL|member|audio_state
id|u_char
id|audio_state
suffix:semicolon
DECL|member|pos_audio_start
id|u_int
id|pos_audio_start
suffix:semicolon
DECL|member|pos_audio_end
id|u_int
id|pos_audio_end
suffix:semicolon
DECL|member|vol_chan0
r_char
id|vol_chan0
suffix:semicolon
DECL|member|vol_ctrl0
id|u_char
id|vol_ctrl0
suffix:semicolon
DECL|member|vol_chan1
r_char
id|vol_chan1
suffix:semicolon
DECL|member|vol_ctrl1
id|u_char
id|vol_ctrl1
suffix:semicolon
macro_line|#if 000
r_char
id|vol_chan2
suffix:semicolon
id|u_char
id|vol_ctrl2
suffix:semicolon
r_char
id|vol_chan3
suffix:semicolon
id|u_char
id|vol_ctrl3
suffix:semicolon
macro_line|#endif 000
DECL|member|SubQ_ctl_adr
id|u_char
id|SubQ_ctl_adr
suffix:semicolon
DECL|member|SubQ_trk
id|u_char
id|SubQ_trk
suffix:semicolon
DECL|member|SubQ_pnt_idx
id|u_char
id|SubQ_pnt_idx
suffix:semicolon
DECL|member|SubQ_run_tot
id|u_int
id|SubQ_run_tot
suffix:semicolon
DECL|member|SubQ_run_trk
id|u_int
id|SubQ_run_trk
suffix:semicolon
DECL|member|SubQ_whatisthis
id|u_char
id|SubQ_whatisthis
suffix:semicolon
DECL|member|UPC_ctl_adr
id|u_char
id|UPC_ctl_adr
suffix:semicolon
DECL|member|UPC_buf
id|u_char
id|UPC_buf
(braket
l_int|7
)braket
suffix:semicolon
DECL|member|CDsize_blk
r_int
id|CDsize_blk
suffix:semicolon
DECL|member|frame_size
r_int
id|frame_size
suffix:semicolon
DECL|member|CDsize_frm
r_int
id|CDsize_frm
suffix:semicolon
DECL|member|xa_byte
id|u_char
id|xa_byte
suffix:semicolon
multiline_comment|/* 0x20: XA capabilities */
DECL|member|n_first_track
id|u_char
id|n_first_track
suffix:semicolon
multiline_comment|/* binary */
DECL|member|n_last_track
id|u_char
id|n_last_track
suffix:semicolon
multiline_comment|/* binary (not bcd), 0x01...0x63 */
DECL|member|size_msf
id|u_int
id|size_msf
suffix:semicolon
multiline_comment|/* time of whole CD, position of LeadOut track */
DECL|member|size_blk
id|u_int
id|size_blk
suffix:semicolon
DECL|member|TocEnt_nixbyte
id|u_char
id|TocEnt_nixbyte
suffix:semicolon
multiline_comment|/* em */
DECL|member|TocEnt_ctl_adr
id|u_char
id|TocEnt_ctl_adr
suffix:semicolon
DECL|member|TocEnt_number
id|u_char
id|TocEnt_number
suffix:semicolon
DECL|member|TocEnt_format
id|u_char
id|TocEnt_format
suffix:semicolon
multiline_comment|/* em */
DECL|member|TocEnt_address
id|u_int
id|TocEnt_address
suffix:semicolon
DECL|member|ored_ctl_adr
id|u_char
id|ored_ctl_adr
suffix:semicolon
multiline_comment|/* to detect if CDROM contains data tracks */
r_struct
(brace
DECL|member|nixbyte
id|u_char
id|nixbyte
suffix:semicolon
multiline_comment|/* em */
DECL|member|ctl_adr
id|u_char
id|ctl_adr
suffix:semicolon
multiline_comment|/* 0x4x: data, 0x0x: audio */
DECL|member|number
id|u_char
id|number
suffix:semicolon
DECL|member|format
id|u_char
id|format
suffix:semicolon
multiline_comment|/* em */
multiline_comment|/* 0x00: lba, 0x01: msf */
DECL|member|address
id|u_int
id|address
suffix:semicolon
DECL|member|TocBuffer
)brace
id|TocBuffer
(braket
id|MAX_TRACKS
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* last entry faked */
DECL|member|in_SpinUp
r_int
id|in_SpinUp
suffix:semicolon
DECL|variable|DriveStruct
)brace
id|DriveStruct
(braket
id|NR_SBPCD
)braket
suffix:semicolon
multiline_comment|/*&n; * drive space ends here (needed separate for each unit)&n; */
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * DDI interface definitions&n; */
macro_line|#ifdef SBPCD_DEBUG
DECL|macro|DPRINTF
macro_line|# define DPRINTF(x)&t;sbpcd_dprintf x
DECL|function|sbpcd_dprintf
r_static
r_void
id|sbpcd_dprintf
c_func
(paren
r_int
id|level
comma
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
r_char
id|buff
(braket
l_int|256
)braket
suffix:semicolon
id|va_list
id|args
suffix:semicolon
r_extern
r_int
id|vsprintf
c_func
(paren
r_char
op_star
id|buf
comma
r_const
r_char
op_star
id|fmt
comma
id|va_list
id|args
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sbpcd_debug
op_amp
(paren
l_int|1
op_lshift
id|level
)paren
)paren
)paren
r_return
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|vsprintf
c_func
(paren
id|buff
comma
id|fmt
comma
id|args
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
id|printk
c_func
(paren
id|buff
)paren
suffix:semicolon
macro_line|#if PRINTK_BUG
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* to avoid possible &quot;printk&quot; bug */
macro_line|#endif
)brace
macro_line|#else
DECL|macro|DPRINTF
macro_line|# define DPRINTF(x)&t;/* nothing */
macro_line|#endif SBPCD_DEBUG
multiline_comment|/*&n; * maintain trace bit pattern&n; */
DECL|function|sbpcd_dbg_ioctl
r_static
r_int
id|sbpcd_dbg_ioctl
c_func
(paren
r_int
r_int
id|arg
comma
r_int
id|level
)paren
(brace
r_int
id|val
suffix:semicolon
id|val
op_assign
id|get_fs_long
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* OFF */
id|sbpcd_debug
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|val
op_ge
l_int|128
)paren
id|sbpcd_debug
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|val
op_minus
l_int|128
)paren
)paren
suffix:semicolon
r_else
id|sbpcd_debug
op_or_assign
(paren
l_int|1
op_lshift
id|val
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * Wait a little while (used for polling the drive).  If in initialization,&n; * setting a timeout doesn&squot;t work, so just loop for a while.&n; */
DECL|function|sbp_sleep
r_static
r_inline
r_void
id|sbp_sleep
c_func
(paren
id|u_int
id|jifs
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|jifs
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  convert logical_block_address to m-s-f_number (3 bytes only)&n; */
DECL|function|lba2msf
r_static
r_void
id|lba2msf
c_func
(paren
r_int
id|lba
comma
id|u_char
op_star
id|msf
)paren
(brace
id|lba
op_add_assign
id|CD_BLOCK_OFFSET
suffix:semicolon
id|msf
(braket
l_int|0
)braket
op_assign
id|lba
op_div
(paren
id|CD_SECS
op_star
id|CD_FRAMES
)paren
suffix:semicolon
id|lba
op_mod_assign
id|CD_SECS
op_star
id|CD_FRAMES
suffix:semicolon
id|msf
(braket
l_int|1
)braket
op_assign
id|lba
op_div
id|CD_FRAMES
suffix:semicolon
id|msf
(braket
l_int|2
)braket
op_assign
id|lba
op_mod
id|CD_FRAMES
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  convert msf-bin to msf-bcd&n; */
DECL|function|bin2bcdx
r_static
r_void
id|bin2bcdx
c_func
(paren
id|u_char
op_star
id|p
)paren
multiline_comment|/* must work only up to 75 or 99 */
(brace
op_star
id|p
op_assign
(paren
(paren
op_star
id|p
op_div
l_int|10
)paren
op_lshift
l_int|4
)paren
op_or
(paren
op_star
id|p
op_mod
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|blk2msf
r_static
id|u_int
id|blk2msf
c_func
(paren
id|u_int
id|blk
)paren
(brace
id|MSF
id|msf
suffix:semicolon
id|u_int
id|mm
suffix:semicolon
id|msf.c
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|msf.c
(braket
l_int|2
)braket
op_assign
(paren
id|blk
op_plus
id|CD_BLOCK_OFFSET
)paren
op_div
(paren
id|CD_SECS
op_star
id|CD_FRAMES
)paren
suffix:semicolon
id|mm
op_assign
(paren
id|blk
op_plus
id|CD_BLOCK_OFFSET
)paren
op_mod
(paren
id|CD_SECS
op_star
id|CD_FRAMES
)paren
suffix:semicolon
id|msf.c
(braket
l_int|1
)braket
op_assign
id|mm
op_div
id|CD_FRAMES
suffix:semicolon
id|msf.c
(braket
l_int|0
)braket
op_assign
id|mm
op_mod
id|CD_FRAMES
suffix:semicolon
r_return
(paren
id|msf.n
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|make16
r_static
id|u_int
id|make16
c_func
(paren
id|u_char
id|rh
comma
id|u_char
id|rl
)paren
(brace
r_return
(paren
(paren
id|rh
op_lshift
l_int|8
)paren
op_or
id|rl
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|make32
r_static
id|u_int
id|make32
c_func
(paren
id|u_int
id|rh
comma
id|u_int
id|rl
)paren
(brace
r_return
(paren
(paren
id|rh
op_lshift
l_int|16
)paren
op_or
id|rl
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|swap_nibbles
r_static
id|u_char
id|swap_nibbles
c_func
(paren
id|u_char
id|i
)paren
(brace
r_return
(paren
(paren
id|i
op_lshift
l_int|4
)paren
op_or
(paren
id|i
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|byt2bcd
r_static
id|u_char
id|byt2bcd
c_func
(paren
id|u_char
id|i
)paren
(brace
r_return
(paren
(paren
(paren
id|i
op_div
l_int|10
)paren
op_lshift
l_int|4
)paren
op_plus
id|i
op_mod
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|bcd2bin
r_static
id|u_char
id|bcd2bin
c_func
(paren
id|u_char
id|bcd
)paren
(brace
r_return
(paren
(paren
id|bcd
op_rshift
l_int|4
)paren
op_star
l_int|10
op_plus
(paren
id|bcd
op_amp
l_int|0x0F
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|msf2blk
r_static
r_int
id|msf2blk
c_func
(paren
r_int
id|msfx
)paren
(brace
id|MSF
id|msf
suffix:semicolon
r_int
id|i
suffix:semicolon
id|msf.n
op_assign
id|msfx
suffix:semicolon
id|i
op_assign
(paren
id|msf.c
(braket
l_int|2
)braket
op_star
id|CD_SECS
op_plus
id|msf.c
(braket
l_int|1
)braket
)paren
op_star
id|CD_FRAMES
op_plus
id|msf.c
(braket
l_int|0
)braket
op_minus
id|CD_BLOCK_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/* evaluate xx_ReadError code (still mysterious) */
DECL|function|sta2err
r_static
r_int
id|sta2err
c_func
(paren
r_int
id|sta
)paren
(brace
r_if
c_cond
(paren
id|sta
op_le
l_int|2
)paren
r_return
(paren
id|sta
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x05
)paren
r_return
(paren
op_minus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x06
)paren
r_return
(paren
op_minus
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x0d
)paren
r_return
(paren
op_minus
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x0e
)paren
r_return
(paren
op_minus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x14
)paren
r_return
(paren
op_minus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x0c
)paren
r_return
(paren
op_minus
l_int|11
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x0f
)paren
r_return
(paren
op_minus
l_int|11
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x10
)paren
r_return
(paren
op_minus
l_int|11
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_ge
l_int|0x16
)paren
r_return
(paren
op_minus
l_int|12
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
id|sta
op_eq
l_int|0x11
)paren
r_return
(paren
op_minus
l_int|15
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|clr_cmdbuf
r_static
r_void
id|clr_cmdbuf
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|drvcmd
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd_type
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|mark_timeout
r_static
r_void
id|mark_timeout
c_func
(paren
r_void
)paren
(brace
id|timed_out
op_assign
l_int|1
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_TIM
comma
l_string|&quot;SBPCD: timer stopped.&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|flush_status
r_static
r_void
id|flush_status
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CDMKE
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|current
op_eq
id|task
(braket
l_int|0
)braket
)paren
r_for
c_loop
(paren
id|i
op_assign
id|maxtim02
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_else
(brace
id|sbp_sleep
c_func
(paren
l_int|150
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|maxtim_data
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
)brace
macro_line|#else
id|timed_out
op_assign
l_int|0
suffix:semicolon
id|SET_TIMER
c_func
(paren
id|mark_timeout
comma
l_int|150
)paren
suffix:semicolon
r_do
(brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|timed_out
)paren
suffix:semicolon
id|CLEAR_TIMER
suffix:semicolon
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
macro_line|#endif CDMKE
)brace
multiline_comment|/*==========================================================================*/
DECL|function|CDi_stat_loop
r_static
r_int
id|CDi_stat_loop
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|u_long
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|current
op_eq
id|task
(braket
l_int|0
)braket
)paren
r_for
c_loop
(paren
id|i
op_assign
id|maxtim16
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_return
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_return
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_return
(paren
id|j
)paren
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|1000
comma
id|i
op_assign
id|maxtim_data
suffix:semicolon
id|timeout
OG
id|jiffies
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_return
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_return
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_return
(paren
id|j
)paren
suffix:semicolon
)brace
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|ResponseInfo
r_static
r_int
id|ResponseInfo
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|st
op_assign
l_int|0
suffix:semicolon
id|u_long
id|timeout
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_000
comma
l_string|&quot;SBPCD: ResponseInfo entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current
op_eq
id|task
(braket
l_int|0
)braket
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|response_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
id|maxtim_8
suffix:semicolon
id|j
op_ne
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|st
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|st
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_SEQ
comma
l_string|&quot;SBPCD: ResponseInfo: not_result_ready (got %d of %d bytes).&bslash;n&quot;
comma
id|i
comma
id|response_count
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|infobuf
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|timeout
op_assign
id|jiffies
op_plus
l_int|100
suffix:semicolon
id|i
OL
id|response_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
id|maxtim_data
suffix:semicolon
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|j
op_ne
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|st
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|st
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_ne
l_int|0
op_logical_or
id|timeout
op_le
id|jiffies
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|j
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeout
op_le
id|jiffies
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|infobuf
(braket
id|i
)braket
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
)brace
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_000
comma
l_string|&quot;SBPCD: ResponseInfo: done.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|EvaluateStatus
r_static
r_int
id|EvaluateStatus
c_func
(paren
r_int
id|st
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_caddin_old
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
op_or_assign
id|p_door_closed
op_or
id|p_caddy_in
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_spinning
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
op_or_assign
id|p_spinning
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_check
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
op_or_assign
id|p_check
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_busy_old
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
op_or_assign
id|p_busy_new
suffix:semicolon
r_if
c_cond
(paren
id|st
op_amp
id|p_disk_ok
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
op_or_assign
id|p_disk_ok
suffix:semicolon
)brace
r_else
(brace
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
op_assign
id|st
suffix:semicolon
id|st
op_assign
id|p_success_old
suffix:semicolon
multiline_comment|/* for new drives: fake &quot;successful&quot; bit of old drives */
)brace
r_return
(paren
id|st
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|ResponseStatus
r_static
r_int
id|ResponseStatus
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|u_long
id|timeout
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_STA
comma
l_string|&quot;SBPCD: doing ResponseStatus...&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current
op_eq
id|task
(braket
l_int|0
)braket
)paren
(brace
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_respo3
)paren
id|j
op_assign
id|maxtim_8
suffix:semicolon
r_else
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_respo2
)paren
id|j
op_assign
id|maxtim16
suffix:semicolon
r_else
id|j
op_assign
id|maxtim04
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|j
op_ne
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_respo3
)paren
id|timeout
op_assign
id|jiffies
suffix:semicolon
r_else
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_respo2
)paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|1600
suffix:semicolon
r_else
id|timeout
op_assign
id|jiffies
op_plus
l_int|400
suffix:semicolon
id|j
op_assign
id|maxtim_8
suffix:semicolon
r_do
(brace
r_for
c_loop
(paren
suffix:semicolon
id|j
op_ne
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_ne
l_int|0
op_logical_or
id|timeout
op_le
id|jiffies
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|j
op_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|flags_cmd_out
op_amp
id|f_respo3
)paren
op_eq
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_STA
comma
l_string|&quot;SBPCD: ResponseStatus: timeout.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|EvaluateStatus
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_info
)paren
suffix:semicolon
id|i
op_assign
id|EvaluateStatus
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_ReadStatus
r_static
r_void
id|xx_ReadStatus
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_STA
comma
l_string|&quot;SBPCD: giving xx_ReadStatus command&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
l_int|0x81
)paren
suffix:semicolon
r_else
(brace
id|SBPCD_CLI
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_command
comma
l_int|0x05
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
l_int|0
)paren
suffix:semicolon
id|SBPCD_STI
suffix:semicolon
)brace
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_ReadError
r_static
r_int
id|xx_ReadError
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ERR
comma
l_string|&quot;SBPCD: giving xx_ReadError command.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x82
suffix:semicolon
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x82
suffix:semicolon
id|response_count
op_assign
l_int|6
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|error_byte
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ERR
comma
l_string|&quot;SBPCD: xx_ReadError: cmd_out(82) returns %d (%02X)&bslash;n&quot;
comma
id|i
comma
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
id|i
op_assign
l_int|2
suffix:semicolon
r_else
id|i
op_assign
l_int|1
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|error_byte
op_assign
id|infobuf
(braket
id|i
)braket
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ERR
comma
l_string|&quot;SBPCD: xx_ReadError: infobuf[%d] is %d (%02X)&bslash;n&quot;
comma
id|i
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|error_byte
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|error_byte
)paren
)paren
suffix:semicolon
id|i
op_assign
id|sta2err
c_func
(paren
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|cmd_out
r_static
r_int
id|cmd_out
c_func
(paren
r_void
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_putcmd
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_CMD
comma
l_string|&quot;SBPCD: cmd_out: put&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_CMD
comma
l_string|&quot; %02X&quot;
comma
id|drvcmd
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_CMD
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SBPCD_CLI
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
id|drvcmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|SBPCD_STI
suffix:semicolon
)brace
r_if
c_cond
(paren
id|response_count
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cmd_type
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_d_i
comma
l_int|0x01
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: misleaded to try ResponseData.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_d_i
comma
l_int|0x00
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|22
)paren
suffix:semicolon
)brace
r_else
id|i
op_assign
id|ResponseInfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|9
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|in_SpinUp
op_ne
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_SPI
comma
l_string|&quot;SBPCD: to CDi_stat_loop.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_lopsta
)paren
(brace
id|i
op_assign
id|CDi_stat_loop
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
op_logical_neg
(paren
id|i
op_amp
id|s_attention
)paren
)paren
r_return
(paren
op_minus
l_int|9
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags_cmd_out
op_amp
id|f_getsta
)paren
)paren
r_goto
id|LOC_229
suffix:semicolon
id|LOC_228
suffix:colon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|in_SpinUp
op_ne
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_SPI
comma
l_string|&quot;SBPCD: to xx_ReadStatus.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|xx_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|LOC_229
suffix:colon
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_ResponseStatus
)paren
(brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|in_SpinUp
op_ne
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_SPI
comma
l_string|&quot;SBPCD: to ResponseStatus.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* builds status_byte, returns orig. status or p_busy_new */
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
(paren
id|f_bit1
op_or
id|f_wait_if_busy
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|st_check
)paren
(brace
r_if
c_cond
(paren
id|flags_cmd_out
op_amp
id|f_bit1
)paren
r_if
c_cond
(paren
id|i
op_amp
id|p_success_old
)paren
r_goto
id|LOC_232
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags_cmd_out
op_amp
id|f_wait_if_busy
)paren
)paren
r_goto
id|LOC_228
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_busy
)paren
r_goto
id|LOC_228
suffix:semicolon
)brace
)brace
)brace
id|LOC_232
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags_cmd_out
op_amp
id|f_obey_p_check
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_check
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|in_SpinUp
op_ne
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_SPI
comma
l_string|&quot;SBPCD: to xx_ReadError.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|i
op_assign
id|xx_ReadError
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|in_SpinUp
op_ne
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_SPI
comma
l_string|&quot;SBPCD: to cmd_out OK.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_Seek
r_static
r_int
id|xx_Seek
c_func
(paren
id|u_int
id|pos
comma
r_char
id|f_blk_msf
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f_blk_msf
OG
l_int|1
)paren
r_return
(paren
op_minus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
r_if
c_cond
(paren
id|f_blk_msf
op_eq
l_int|1
)paren
id|pos
op_assign
id|msf2blk
c_func
(paren
id|pos
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|pos
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
(paren
id|pos
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|pos
op_amp
l_int|0x00FF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|f_blk_msf
op_eq
l_int|0
)paren
id|pos
op_assign
id|blk2msf
c_func
(paren
id|pos
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|pos
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|pos
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|pos
op_amp
l_int|0x00FF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_SpinUp
r_static
r_int
id|xx_SpinUp
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_SPI
comma
l_string|&quot;SBPCD: SpinUp.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|in_SpinUp
op_assign
l_int|1
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x05
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x02
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|in_SpinUp
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|yy_SpinDown
r_static
r_int
id|yy_SpinDown
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_return
(paren
op_minus
l_int|3
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x06
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|yy_SetSpeed
r_static
r_int
id|yy_SetSpeed
c_func
(paren
id|u_char
id|speed
comma
id|u_char
id|x1
comma
id|u_char
id|x2
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_return
(paren
op_minus
l_int|3
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x09
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x03
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
id|speed
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|x1
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|x2
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_SetVolume
r_static
r_int
id|xx_SetVolume
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_char
id|channel0
comma
id|channel1
comma
id|volume0
comma
id|volume1
suffix:semicolon
id|u_char
id|control0
comma
id|value0
comma
id|control1
comma
id|value1
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|volume_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|channel0
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_chan0
suffix:semicolon
id|volume0
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_ctrl0
suffix:semicolon
id|channel1
op_assign
id|control1
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_chan1
suffix:semicolon
id|volume1
op_assign
id|value1
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_ctrl1
suffix:semicolon
id|control0
op_assign
id|value0
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_options
op_amp
id|sax_a
)paren
op_ne
l_int|0
)paren
op_logical_and
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_211
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|volume0
op_ne
l_int|0
)paren
op_logical_and
(paren
id|volume1
op_eq
l_int|0
)paren
)paren
(brace
id|volume1
op_assign
id|volume0
suffix:semicolon
id|channel1
op_assign
id|channel0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|volume0
op_eq
l_int|0
)paren
op_logical_and
(paren
id|volume1
op_ne
l_int|0
)paren
)paren
(brace
id|volume0
op_assign
id|volume1
suffix:semicolon
id|channel0
op_assign
id|channel1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|channel0
OG
l_int|1
)paren
(brace
id|channel0
op_assign
l_int|0
suffix:semicolon
id|volume0
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|channel1
OG
l_int|1
)paren
(brace
id|channel1
op_assign
l_int|1
suffix:semicolon
id|volume1
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|control0
op_assign
id|channel0
op_plus
l_int|1
suffix:semicolon
id|control1
op_assign
id|channel1
op_plus
l_int|1
suffix:semicolon
id|value0
op_assign
(paren
id|volume0
OG
id|volume1
)paren
ques
c_cond
id|volume0
suffix:colon
id|volume1
suffix:semicolon
id|value1
op_assign
id|value0
suffix:semicolon
r_if
c_cond
(paren
id|volume0
op_eq
l_int|0
)paren
id|control0
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|volume1
op_eq
l_int|0
)paren
id|control1
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x09
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x05
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|control0
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|value0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|control1
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|value1
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_300
)paren
(brace
id|control0
op_assign
id|volume0
op_amp
l_int|0xFC
suffix:semicolon
id|value0
op_assign
id|volume1
op_amp
l_int|0xFC
suffix:semicolon
r_if
c_cond
(paren
(paren
id|volume0
op_ne
l_int|0
)paren
op_logical_and
(paren
id|volume0
OL
l_int|4
)paren
)paren
id|control0
op_or_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
(paren
id|volume1
op_ne
l_int|0
)paren
op_logical_and
(paren
id|volume1
OL
l_int|4
)paren
)paren
id|value0
op_or_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
id|channel0
op_ne
l_int|0
)paren
id|control0
op_or_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|channel1
op_eq
l_int|1
)paren
id|value0
op_or_assign
l_int|0x01
suffix:semicolon
)brace
r_else
(brace
id|value0
op_assign
(paren
id|volume0
OG
id|volume1
)paren
ques
c_cond
id|volume0
suffix:colon
id|volume1
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
OL
id|drv_211
)paren
(brace
r_if
c_cond
(paren
id|channel0
op_ne
l_int|0
)paren
(brace
id|i
op_assign
id|channel1
suffix:semicolon
id|channel1
op_assign
id|channel0
suffix:semicolon
id|channel0
op_assign
id|i
suffix:semicolon
id|i
op_assign
id|volume1
suffix:semicolon
id|volume1
op_assign
id|volume0
suffix:semicolon
id|volume0
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|channel0
op_eq
id|channel1
)paren
(brace
r_if
c_cond
(paren
id|channel0
op_eq
l_int|0
)paren
(brace
id|channel1
op_assign
l_int|1
suffix:semicolon
id|volume1
op_assign
l_int|0
suffix:semicolon
id|volume0
op_assign
id|value0
suffix:semicolon
)brace
r_else
(brace
id|channel0
op_assign
l_int|0
suffix:semicolon
id|volume0
op_assign
l_int|0
suffix:semicolon
id|volume1
op_assign
id|value0
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
id|volume0
op_ne
l_int|0
)paren
op_logical_and
(paren
id|volume1
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|volume0
op_eq
l_int|0xFF
)paren
id|volume1
op_assign
l_int|0xFF
suffix:semicolon
r_else
r_if
c_cond
(paren
id|volume1
op_eq
l_int|0xFF
)paren
id|volume0
op_assign
l_int|0xFF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
OL
id|drv_201
)paren
id|volume0
op_assign
id|volume1
op_assign
id|value0
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_201
)paren
(brace
r_if
c_cond
(paren
id|volume0
op_eq
l_int|0
)paren
id|control0
op_or_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|volume1
op_eq
l_int|0
)paren
id|control0
op_or_assign
l_int|0x40
suffix:semicolon
)brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_211
)paren
(brace
r_if
c_cond
(paren
id|channel0
op_ne
l_int|0
)paren
id|control0
op_or_assign
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
id|channel1
op_ne
l_int|1
)paren
id|control0
op_or_assign
l_int|0x10
suffix:semicolon
)brace
)brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x84
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x83
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|control0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|value0
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|volume_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|GetStatus
r_static
r_int
id|GetStatus
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|cmd_type
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xy_DriveReset
r_static
r_int
id|xy_DriveReset
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_RES
comma
l_string|&quot;SBPCD: xy_DriveReset called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
id|OUT
c_func
(paren
id|CDo_reset
comma
l_int|0x00
)paren
suffix:semicolon
r_else
(brace
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x0A
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
)brace
id|flush_status
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|error_byte
op_ne
id|aud_12
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|SetSpeed
r_static
r_int
id|SetSpeed
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|speed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_options
op_amp
(paren
id|speed_auto
op_or
id|speed_300
op_or
id|speed_150
)paren
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|speed
op_assign
id|speed_auto
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_options
op_amp
id|speed_auto
)paren
)paren
(brace
id|speed
op_or_assign
id|speed_300
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_options
op_amp
id|speed_300
)paren
)paren
id|speed
op_assign
l_int|0
suffix:semicolon
)brace
id|i
op_assign
id|yy_SetSpeed
c_func
(paren
id|speed
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|DriveReset
r_static
r_int
id|DriveReset
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|xy_DriveReset
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
r_do
(brace
id|i
op_assign
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_and
(paren
id|i
op_ne
op_minus
l_int|15
)paren
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* i!=-15 is from sta2err */
r_if
c_cond
(paren
op_logical_neg
id|st_caddy_in
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|st_diskok
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|1
suffix:semicolon
id|i
op_assign
id|SetSpeed
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_Pause_Resume
r_static
r_int
id|xx_Pause_Resume
c_func
(paren
r_int
id|pau_res
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x0D
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x8D
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pau_res
op_ne
l_int|1
)paren
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x80
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|yy_LockDoor
r_static
r_int
id|yy_LockDoor
c_func
(paren
r_char
id|lock
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_LCK
comma
l_string|&quot;SBPCD: yy_LockDoor: %d (drive %d)&bslash;n&quot;
comma
id|lock
comma
id|d
)paren
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x0C
suffix:semicolon
r_if
c_cond
(paren
id|lock
op_eq
l_int|1
)paren
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_ReadSubQ
r_static
r_int
id|xx_ReadSubQ
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|subq_bit
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|255
suffix:semicolon
id|j
OG
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x87
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|11
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x89
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|13
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_SQ
comma
l_string|&quot;SBPCD: xx_ReadSubQ:&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|new_drive
ques
c_cond
l_int|11
suffix:colon
l_int|13
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_SQ
comma
l_string|&quot; %02X&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_SQ
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|infobuf
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|st_spinning
)paren
op_logical_or
(paren
id|j
op_eq
l_int|1
)paren
)paren
(brace
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_ctl_adr
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_trk
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_pnt_idx
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_whatisthis
op_assign
l_int|0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_ctl_adr
op_assign
id|swap_nibbles
c_func
(paren
id|infobuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_trk
op_assign
id|byt2bcd
c_func
(paren
id|infobuf
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_pnt_idx
op_assign
id|byt2bcd
c_func
(paren
id|infobuf
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|i
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
id|i
op_assign
l_int|5
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
id|i
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
id|i
op_plus
l_int|1
)braket
comma
id|infobuf
(braket
id|i
op_plus
l_int|2
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* msf-bin */
id|i
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
id|i
op_assign
l_int|9
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
id|i
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
id|i
op_plus
l_int|1
)braket
comma
id|infobuf
(braket
id|i
op_plus
l_int|2
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* msf-bin */
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_whatisthis
op_assign
id|infobuf
(braket
id|i
op_plus
l_int|3
)braket
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|subq_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_ModeSense
r_static
r_int
id|xx_ModeSense
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|frame_size_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x84
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|5
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x85
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|response_count
op_assign
l_int|2
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|sense_byte
op_assign
id|infobuf
(braket
id|i
op_increment
)braket
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|frame_size
op_assign
id|make16
c_func
(paren
id|infobuf
(braket
id|i
)braket
comma
id|infobuf
(braket
id|i
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_XA
comma
l_string|&quot;SBPCD: xx_ModeSense: &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|new_drive
ques
c_cond
l_int|5
suffix:colon
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_XA
comma
l_string|&quot;%02X &quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_XA
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|frame_size_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
DECL|function|xx_ModeSelect
r_static
r_int
id|xx_ModeSelect
c_func
(paren
r_int
id|framesize
)paren
(brace
r_int
id|i
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|frame_size_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|frame_size
op_assign
id|framesize
suffix:semicolon
r_if
c_cond
(paren
id|framesize
op_eq
id|CD_FRAMESIZE_RAW
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|sense_byte
op_assign
l_int|0x82
suffix:semicolon
r_else
id|DriveStruct
(braket
id|d
)braket
dot
id|sense_byte
op_assign
l_int|0x00
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_XA
comma
l_string|&quot;SBPCD: xx_ModeSelect: %02X %04X&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|sense_byte
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|frame_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x09
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|sense_byte
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|frame_size
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|frame_size
op_amp
l_int|0xFF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x84
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|frame_size
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|frame_size
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0x00
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|frame_size_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
macro_line|#if 0000
r_static
r_int
id|xx_TellVolume
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|u_char
id|switches
suffix:semicolon
id|u_char
id|chan0
comma
id|vol0
comma
id|chan1
comma
id|vol1
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|volume_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x84
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x05
suffix:semicolon
id|response_count
op_assign
l_int|5
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x85
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x03
suffix:semicolon
id|response_count
op_assign
l_int|2
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|chan0
op_assign
id|infobuf
(braket
l_int|1
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|vol0
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|chan1
op_assign
id|infobuf
(braket
l_int|3
)braket
op_amp
l_int|0x0F
suffix:semicolon
id|vol1
op_assign
id|infobuf
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|chan0
op_eq
l_int|0
)paren
(brace
id|chan0
op_assign
l_int|1
suffix:semicolon
id|vol0
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan1
op_eq
l_int|0
)paren
(brace
id|chan1
op_assign
l_int|2
suffix:semicolon
id|vol1
op_assign
l_int|0
suffix:semicolon
)brace
id|chan0
op_rshift_assign
l_int|1
suffix:semicolon
id|chan1
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|chan0
op_assign
l_int|0
suffix:semicolon
id|chan1
op_assign
l_int|1
suffix:semicolon
id|vol0
op_assign
id|vol1
op_assign
id|infobuf
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_201
)paren
(brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
OL
id|drv_300
)paren
(brace
id|switches
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
id|vol0
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x40
)paren
op_ne
l_int|0
)paren
id|vol1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_211
)paren
(brace
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x20
)paren
op_ne
l_int|0
)paren
id|chan0
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|switches
op_amp
l_int|0x10
)paren
op_ne
l_int|0
)paren
id|chan1
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|vol0
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vol0
op_amp
l_int|0x01
)paren
op_ne
l_int|0
)paren
id|chan0
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vol1
op_amp
l_int|0x01
)paren
op_eq
l_int|0
)paren
id|chan1
op_assign
l_int|0
suffix:semicolon
id|vol0
op_and_assign
l_int|0xFC
suffix:semicolon
id|vol1
op_and_assign
l_int|0xFC
suffix:semicolon
r_if
c_cond
(paren
id|vol0
op_ne
l_int|0
)paren
id|vol0
op_add_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|vol1
op_ne
l_int|0
)paren
id|vol1
op_add_assign
l_int|3
suffix:semicolon
)brace
)brace
)brace
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_chan0
op_assign
id|chan0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_ctrl0
op_assign
id|vol0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_chan1
op_assign
id|chan1
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_ctrl1
op_assign
id|vol1
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_chan2
op_assign
l_int|2
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_ctrl2
op_assign
l_int|0xFF
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_chan3
op_assign
l_int|3
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_ctrl3
op_assign
l_int|0xFF
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|volume_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*==========================================================================*/
DECL|function|xx_ReadCapacity
r_static
r_int
id|xx_ReadCapacity
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|cd_size_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x85
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x88
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
id|response_count
op_assign
l_int|5
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|CDsize_blk
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|0
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|1
)braket
comma
id|infobuf
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|CDsize_blk
op_assign
id|msf2blk
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|CDsize_blk
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|CDsize_frm
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|CDsize_blk
op_star
id|make16
c_func
(paren
id|infobuf
(braket
l_int|3
)braket
comma
id|infobuf
(braket
l_int|4
)braket
)paren
)paren
op_div
id|CD_FRAMESIZE
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|CDsize_blk
op_add_assign
l_int|151
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|cd_size_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_ReadTocDescr
r_static
r_int
id|xx_ReadTocDescr
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|toc_bit
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x8B
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x8B
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
id|response_count
op_assign
l_int|6
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|xa_byte
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|n_first_track
op_assign
id|infobuf
(braket
l_int|1
)braket
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|n_last_track
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|size_msf
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|3
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|4
)braket
comma
id|infobuf
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|size_blk
op_assign
id|msf2blk
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|size_msf
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|toc_bit
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_TOC
comma
l_string|&quot;SBPCD: TocDesc: %02X %02X %02X %08X&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|xa_byte
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|n_first_track
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|n_last_track
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|size_msf
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_ReadTocEntry
r_static
r_int
id|xx_ReadTocEntry
c_func
(paren
r_int
id|num
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x8C
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x8C
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
id|drvcmd
(braket
l_int|2
)braket
op_assign
id|num
suffix:semicolon
id|response_count
op_assign
l_int|8
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_nixbyte
op_assign
id|infobuf
(braket
l_int|0
)braket
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
op_assign
id|swap_nibbles
c_func
(paren
id|infobuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_number
op_assign
id|infobuf
(braket
l_int|2
)braket
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_format
op_assign
id|infobuf
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
id|i
op_assign
l_int|4
suffix:semicolon
r_else
id|i
op_assign
l_int|5
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_address
op_assign
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
id|i
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
id|i
op_plus
l_int|1
)braket
comma
id|infobuf
(braket
id|i
op_plus
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_TOC
comma
l_string|&quot;SBPCD: TocEntry: %02X %02X %02X %02X %08X&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_nixbyte
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_number
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_format
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_address
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_ReadPacket
r_static
r_int
id|xx_ReadPacket
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x8E
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
id|response_count
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|convert_UPC
r_static
r_int
id|convert_UPC
c_func
(paren
id|u_char
op_star
id|p
)paren
(brace
r_int
id|i
suffix:semicolon
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
id|p
(braket
l_int|13
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|new_drive
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|UPC_buf
(braket
id|i
)braket
op_assign
id|swap_nibbles
c_func
(paren
op_star
id|p
op_increment
)paren
suffix:semicolon
r_else
(brace
id|DriveStruct
(braket
id|d
)braket
dot
id|UPC_buf
(braket
id|i
)braket
op_assign
(paren
(paren
op_star
id|p
op_increment
)paren
op_lshift
l_int|4
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|UPC_buf
(braket
id|i
)braket
op_or_assign
op_star
id|p
op_increment
suffix:semicolon
)brace
)brace
id|DriveStruct
(braket
id|d
)braket
dot
id|UPC_buf
(braket
l_int|6
)braket
op_and_assign
l_int|0xF0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_ReadUPC
r_static
r_int
id|xx_ReadUPC
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#if TEST_UPC
r_int
id|block
comma
id|checksum
suffix:semicolon
macro_line|#endif TEST_UPC
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|upc_bit
suffix:semicolon
macro_line|#if TEST_UPC
r_for
c_loop
(paren
id|block
op_assign
id|CD_BLOCK_OFFSET
op_plus
l_int|1
suffix:semicolon
id|block
OL
id|CD_BLOCK_OFFSET
op_plus
l_int|200
suffix:semicolon
id|block
op_increment
)paren
(brace
macro_line|#endif TEST_UPC
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x88
suffix:semicolon
macro_line|#if TEST_UPC
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|block
op_amp
l_int|0xFF
suffix:semicolon
macro_line|#endif TEST_UPC
id|response_count
op_assign
l_int|8
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x08
suffix:semicolon
macro_line|#if TEST_UPC
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
id|block
op_amp
l_int|0xFF
suffix:semicolon
macro_line|#endif TEST_UPC
id|response_count
op_assign
l_int|0
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_bit1
suffix:semicolon
)brace
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
id|response_count
op_assign
l_int|16
suffix:semicolon
id|i
op_assign
id|xx_ReadPacket
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
macro_line|#if TEST_UPC
id|checksum
op_assign
l_int|0
suffix:semicolon
macro_line|#endif TEST_UPC
id|DPRINTF
c_func
(paren
(paren
id|DBG_UPC
comma
l_string|&quot;SBPCD: UPC info: &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|new_drive
ques
c_cond
l_int|8
suffix:colon
l_int|16
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#if TEST_UPC
id|checksum
op_or_assign
id|infobuf
(braket
id|i
)braket
suffix:semicolon
macro_line|#endif TEST_UPC
id|DPRINTF
c_func
(paren
(paren
id|DBG_UPC
comma
l_string|&quot;%02X &quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_UPC
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if TEST_UPC
r_if
c_cond
(paren
(paren
id|checksum
op_amp
l_int|0x7F
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
macro_line|#endif TEST_UPC
id|DriveStruct
(braket
id|d
)braket
dot
id|UPC_ctl_adr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
id|i
op_assign
l_int|0
suffix:semicolon
r_else
id|i
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|infobuf
(braket
id|i
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
(brace
id|convert_UPC
c_func
(paren
op_amp
id|infobuf
(braket
id|i
)braket
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|UPC_ctl_adr
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
op_amp
l_int|0xF0
)paren
op_or
l_int|0x02
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_UPC
comma
l_string|&quot;SBPCD: UPC code: &quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_UPC
comma
l_string|&quot;(%02X) &quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|UPC_ctl_adr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_UPC
comma
l_string|&quot;%02X &quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|UPC_buf
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_UPC
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|upc_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|yy_CheckMultiSession
r_static
r_int
id|yy_CheckMultiSession
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|multisession_bit
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|f_multisession
op_assign
l_int|0
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x8D
suffix:semicolon
id|response_count
op_assign
l_int|6
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|infobuf
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_MUL
comma
l_string|&quot;SBPCD: MultiSession CD detected: %02X %02X %02X %02X %02X %02X&bslash;n&quot;
comma
id|infobuf
(braket
l_int|0
)braket
comma
id|infobuf
(braket
l_int|1
)braket
comma
id|infobuf
(braket
l_int|2
)braket
comma
id|infobuf
(braket
l_int|3
)braket
comma
id|infobuf
(braket
l_int|4
)braket
comma
id|infobuf
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|f_multisession
op_assign
l_int|1
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|lba_multi
op_assign
id|msf2blk
c_func
(paren
id|make32
c_func
(paren
id|make16
c_func
(paren
l_int|0
comma
id|infobuf
(braket
l_int|1
)braket
)paren
comma
id|make16
c_func
(paren
id|infobuf
(braket
l_int|2
)braket
comma
id|infobuf
(braket
l_int|3
)braket
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|multisession_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
macro_line|#if FUTURE
DECL|function|yy_SubChanInfo
r_static
r_int
id|yy_SubChanInfo
c_func
(paren
r_int
id|frame
comma
r_int
id|count
comma
id|u_char
op_star
id|buffer
)paren
multiline_comment|/* &quot;frame&quot; is a RED BOOK address */
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_return
(paren
op_minus
l_int|3
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_ne
id|audio_playing
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
macro_line|#endif
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x11
suffix:semicolon
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|frame
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|frame
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|frame
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|count
op_amp
l_int|0xFF
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
id|cmd_type
op_assign
id|READ_SC
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|frame_size
op_assign
id|CD_FRAMESIZE_SUB
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* read directly into user&squot;s buffer */
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
macro_line|#endif FUTURE
multiline_comment|/*==========================================================================*/
DECL|function|check_datarate
r_static
r_void
id|check_datarate
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CDMKE
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOX
comma
l_string|&quot;SBPCD: check_datarate entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|timed_out
op_assign
l_int|0
suffix:semicolon
id|datarate
op_assign
l_int|0
suffix:semicolon
macro_line|#if TEST_STI
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* set a timer to make (timed_out!=0) after 1.1 seconds */
id|DPRINTF
c_func
(paren
(paren
id|DBG_TIM
comma
l_string|&quot;SBPCD: timer started (110).&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SET_TIMER
c_func
(paren
id|mark_timeout
comma
l_int|110
)paren
suffix:semicolon
r_do
(brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
id|datarate
op_increment
suffix:semicolon
macro_line|#if 00000
r_if
c_cond
(paren
id|datarate
OG
l_int|0x0FFFFFFF
)paren
r_break
suffix:semicolon
macro_line|#endif 00000
)brace
r_while
c_loop
(paren
op_logical_neg
id|timed_out
)paren
suffix:semicolon
multiline_comment|/* originally looping for 1.1 seconds */
id|CLEAR_TIMER
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_TIM
comma
l_string|&quot;SBPCD: datarate: %d&bslash;n&quot;
comma
id|datarate
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datarate
OL
l_int|65536
)paren
id|datarate
op_assign
l_int|65536
suffix:semicolon
id|maxtim16
op_assign
id|datarate
op_star
l_int|16
suffix:semicolon
id|maxtim04
op_assign
id|datarate
op_star
l_int|4
suffix:semicolon
id|maxtim02
op_assign
id|datarate
op_star
l_int|2
suffix:semicolon
id|maxtim_8
op_assign
id|datarate
op_div
l_int|32
suffix:semicolon
macro_line|#if LONG_TIMING
id|maxtim_data
op_assign
id|datarate
op_div
l_int|100
suffix:semicolon
macro_line|#else
id|maxtim_data
op_assign
id|datarate
op_div
l_int|300
suffix:semicolon
macro_line|#endif LONG_TIMING
id|DPRINTF
c_func
(paren
(paren
id|DBG_TIM
comma
l_string|&quot;SBPCD: maxtim_8 %d, maxtim_data %d.&bslash;n&quot;
comma
id|maxtim_8
comma
id|maxtim_data
)paren
)paren
suffix:semicolon
macro_line|#endif CDMKE
)brace
multiline_comment|/*==========================================================================*/
DECL|function|check_version
r_static
r_int
id|check_version
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: check_version entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* clear any pending error state */
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x82
suffix:semicolon
id|response_count
op_assign
l_int|9
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: cmd_82 returns %d (ok anyway).&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* read drive version */
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|infobuf
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x83
suffix:semicolon
id|response_count
op_assign
l_int|12
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: cmd_83 returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: infobuf = &bslash;&quot;&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;%c&quot;
comma
id|infobuf
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;&bslash;&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|infobuf
(braket
id|i
)braket
op_ne
id|drive_family
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|4
)paren
(brace
id|DriveStruct
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|0
)braket
op_assign
id|infobuf
(braket
id|i
op_increment
)braket
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|1
)braket
op_assign
id|infobuf
(braket
id|i
op_increment
)braket
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|2
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|3
)braket
op_assign
l_char|&squot;x&squot;
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_new
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|infobuf
(braket
id|i
)braket
op_ne
id|drive_vendor
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|8
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: check_version: error.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|DriveStruct
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|0
)braket
op_assign
l_char|&squot;2&squot;
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|1
)braket
op_assign
l_char|&squot;x&squot;
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|2
)braket
op_assign
l_char|&squot;-&squot;
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|drive_model
(braket
l_int|3
)braket
op_assign
l_char|&squot;x&squot;
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_old
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|firmware_version
(braket
id|j
)braket
op_assign
id|infobuf
(braket
id|i
op_plus
id|j
)braket
suffix:semicolon
id|j
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|0
)braket
op_amp
l_int|0x0F
)paren
op_star
l_int|100
op_plus
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|2
)braket
op_amp
l_int|0x0F
)paren
op_star
l_int|10
op_plus
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|firmware_version
(braket
l_int|3
)braket
op_amp
l_int|0x0F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
r_if
c_cond
(paren
id|j
OL
l_int|100
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_099
suffix:semicolon
r_else
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_100
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|j
OL
l_int|200
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_199
suffix:semicolon
r_else
r_if
c_cond
(paren
id|j
OL
l_int|201
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_200
suffix:semicolon
r_else
r_if
c_cond
(paren
id|j
OL
l_int|210
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_201
suffix:semicolon
r_else
r_if
c_cond
(paren
id|j
OL
l_int|211
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_210
suffix:semicolon
r_else
r_if
c_cond
(paren
id|j
OL
l_int|300
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_211
suffix:semicolon
r_else
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_assign
id|drv_300
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: check_version done.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|switch_drive
r_static
r_int
id|switch_drive
c_func
(paren
r_int
id|num
)paren
(brace
r_int
id|i
suffix:semicolon
id|d
op_assign
id|num
suffix:semicolon
id|i
op_assign
id|num
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|i
op_assign
(paren
id|i
op_amp
l_int|0x01
)paren
op_lshift
l_int|1
op_or
(paren
id|i
op_amp
l_int|0x02
)paren
op_rshift
l_int|1
suffix:semicolon
id|OUT
c_func
(paren
id|CDo_enable
comma
id|i
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_DID
comma
l_string|&quot;SBPCD: switch_drive: drive %d activated.&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_minor
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * probe for the presence of drives on the selected controller&n; */
DECL|function|check_drives
r_static
r_int
id|check_drives
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_char
op_star
id|printk_header
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: check_drives entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ndrives
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_SBPCD
suffix:semicolon
id|j
op_increment
)paren
(brace
id|DriveStruct
(braket
id|j
)braket
dot
id|drv_minor
op_assign
id|j
suffix:semicolon
id|switch_drive
c_func
(paren
id|j
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ID
comma
l_string|&quot;SBPCD: check_drives: drive %d activated.&bslash;n&quot;
comma
id|j
)paren
)paren
suffix:semicolon
id|i
op_assign
id|check_version
c_func
(paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_ID
comma
l_string|&quot;SBPCD: check_version returns %d.&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
(brace
id|ndrives
op_increment
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_options
op_assign
id|drv_pattern
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_options
op_and_assign
op_complement
(paren
id|speed_auto
op_or
id|speed_300
op_or
id|speed_150
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%sDrive %d: %s%.4s (%.4s)&bslash;n&quot;
comma
id|printk_header
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_minor
comma
id|drive_family
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|drive_model
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|firmware_version
)paren
suffix:semicolon
id|printk_header
op_assign
l_string|&quot;       - &quot;
suffix:semicolon
)brace
r_else
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_minor
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ndrives
op_eq
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
macro_line|#if 000
r_static
r_void
id|timewait
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|65500
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
)brace
macro_line|#endif 000
multiline_comment|/*==========================================================================*/
macro_line|#if FUTURE
multiline_comment|/*&n; *  obtain if requested service disturbs current audio state&n; */
DECL|function|obey_audio_state
r_static
r_int
id|obey_audio_state
c_func
(paren
id|u_char
id|audio_state
comma
id|u_char
id|func
comma
id|u_char
id|subfunc
)paren
(brace
r_switch
c_cond
(paren
id|audio_state
)paren
multiline_comment|/* audio status from controller  */
(brace
r_case
id|aud_11
suffix:colon
multiline_comment|/* &quot;audio play in progress&quot; */
r_case
id|audx11
suffix:colon
r_switch
c_cond
(paren
id|func
)paren
multiline_comment|/* DOS command code */
(brace
r_case
id|cmd_07
suffix:colon
multiline_comment|/* input flush  */
r_case
id|cmd_0d
suffix:colon
multiline_comment|/* open device  */
r_case
id|cmd_0e
suffix:colon
multiline_comment|/* close device */
r_case
id|cmd_0c
suffix:colon
multiline_comment|/* ioctl output */
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|cmd_03
suffix:colon
multiline_comment|/* ioctl input  */
r_switch
c_cond
(paren
id|subfunc
)paren
multiline_comment|/* DOS ioctl input subfunction */
(brace
r_case
id|cxi_00
suffix:colon
r_case
id|cxi_06
suffix:colon
r_case
id|cxi_09
suffix:colon
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|ERROR15
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
id|ERROR15
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|aud_12
suffix:colon
multiline_comment|/* &quot;audio play paused&quot;      */
r_case
id|audx12
suffix:colon
r_return
(paren
l_int|1
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
l_int|2
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif FUTURE
multiline_comment|/*==========================================================================*/
multiline_comment|/* allowed is only&n; * ioctl_o, flush_input, open_device, close_device, &n; * tell_address, tell_volume, tell_capabiliti,&n; * tell_framesize, tell_CD_changed, tell_audio_posi&n; */
DECL|function|check_allowed1
r_static
r_int
id|check_allowed1
c_func
(paren
id|u_char
id|func1
comma
id|u_char
id|func2
)paren
(brace
macro_line|#if 000
r_if
c_cond
(paren
id|func1
op_eq
id|ioctl_o
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long_prefetch
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|seek
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_play
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_pause
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_resume
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_ne
id|ioctl_i
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_SubQ_run_tot
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_cdsize
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_TocDescrip
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_TocEntry
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_subQ_info
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
r_if
c_cond
(paren
id|func2
op_eq
id|tell_SubChanInfo
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_UPC
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#else
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif 000
)brace
multiline_comment|/*==========================================================================*/
DECL|function|check_allowed2
r_static
r_int
id|check_allowed2
c_func
(paren
id|u_char
id|func1
comma
id|u_char
id|func2
)paren
(brace
macro_line|#if 000
r_if
c_cond
(paren
id|func1
op_eq
id|read_long
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long_prefetch
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|seek
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_play
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_ne
id|ioctl_o
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
r_if
c_cond
(paren
id|func2
op_eq
id|EjectDisk
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|CloseTray
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#else
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif 000
)brace
multiline_comment|/*==========================================================================*/
DECL|function|check_allowed3
r_static
r_int
id|check_allowed3
c_func
(paren
id|u_char
id|func1
comma
id|u_char
id|func2
)paren
(brace
macro_line|#if 000
r_if
c_cond
(paren
id|func1
op_eq
id|ioctl_i
)paren
(brace
r_if
c_cond
(paren
id|func2
op_eq
id|tell_address
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_capabiliti
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|tell_CD_changed
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_if
c_cond
(paren
id|func2
op_eq
id|tell_SubChanInfo
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func1
op_eq
id|ioctl_o
)paren
(brace
r_if
c_cond
(paren
id|func2
op_eq
id|DriveReset
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
r_if
c_cond
(paren
id|func2
op_eq
id|EjectDisk
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|LockDoor
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func2
op_eq
id|CloseTray
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|func1
op_eq
id|flush_input
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|read_long_prefetch
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|seek
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_play
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_pause
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func1
op_eq
id|audio_resume
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#else
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif 000
)brace
multiline_comment|/*==========================================================================*/
DECL|function|seek_pos_audio_end
r_static
r_int
id|seek_pos_audio_end
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|msf2blk
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_assign
id|xx_Seek
c_func
(paren
id|i
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|ReadToC
r_static
r_int
id|ReadToC
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|toc_bit
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|ored_ctl_adr
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|n_first_track
suffix:semicolon
id|j
op_le
id|DriveStruct
(braket
id|d
)braket
dot
id|n_last_track
suffix:semicolon
id|j
op_increment
)paren
(brace
id|i
op_assign
id|xx_ReadTocEntry
c_func
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|nixbyte
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_nixbyte
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|ctl_adr
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|number
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_number
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|format
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_format
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|address
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_address
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|ored_ctl_adr
op_or_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocEnt_ctl_adr
suffix:semicolon
)brace
multiline_comment|/* fake entry for LeadOut Track */
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|nixbyte
op_assign
l_int|0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|ctl_adr
op_assign
l_int|0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|number
op_assign
l_int|0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|format
op_assign
l_int|0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|j
)braket
dot
id|address
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|size_msf
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_or_assign
id|toc_bit
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|DiskInfo
r_static
r_int
id|DiskInfo
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
macro_line|#if READ_AUDIO
id|DriveStruct
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_M1
suffix:semicolon
macro_line|#endif READ_AUDIO
DECL|macro|LOOP_COUNT
macro_line|#undef LOOP_COUNT
DECL|macro|LOOP_COUNT
mdefine_line|#define LOOP_COUNT 20 /* needed for some &quot;old&quot; drives */
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
OL
id|LOOP_COUNT
suffix:semicolon
id|j
op_increment
)paren
(brace
id|i
op_assign
id|SetSpeed
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: DiskInfo: SetSpeed returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|i
op_assign
id|xx_ModeSense
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: DiskInfo: xx_ModeSense returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|i
op_assign
id|xx_ReadCapacity
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
r_break
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: DiskInfo: ReadCapacity #%d returns %d&bslash;n&quot;
comma
id|j
comma
id|i
)paren
)paren
suffix:semicolon
id|i
op_assign
id|DriveReset
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
id|LOOP_COUNT
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* give up */
id|i
op_assign
id|xx_ReadTocDescr
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: DiskInfo: ReadTocDescr returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
id|i
op_assign
id|ReadToC
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: DiskInfo: ReadToC returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
id|i
op_assign
id|yy_CheckMultiSession
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: DiskInfo: yy_CheckMultiSession returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
id|i
op_assign
id|xx_ReadTocEntry
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|n_first_track
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: DiskInfo: xx_ReadTocEntry(1) returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
id|i
op_assign
id|xx_ReadUPC
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: DiskInfo: xx_ReadUPC returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
macro_line|#ifdef XA_TEST2
r_if
c_cond
(paren
(paren
op_logical_neg
id|new_drive
)paren
op_logical_and
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|xa_byte
op_eq
l_int|0x20
)paren
)paren
multiline_comment|/* XA disk with old drive */
(brace
id|xx_ModeSelect
c_func
(paren
id|CD_FRAMESIZE_XA
)paren
suffix:semicolon
id|xx_ModeSense
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif XA_TEST2
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  called always if driver gets entered&n; *  returns 0 or ERROR2 or ERROR15&n; */
DECL|function|prepare
r_static
r_int
id|prepare
c_func
(paren
id|u_char
id|func
comma
id|u_char
id|subfunc
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
id|i
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|s_attention
)paren
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_eq
l_int|0xFF
)paren
(brace
macro_line|#if MANY_SESSION
macro_line|#else
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif MANY_SESSION
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_diskok
)paren
(brace
id|i
op_assign
id|check_allowed1
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|check_allowed3
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|1
suffix:semicolon
r_return
(paren
op_minus
l_int|15
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|st_diskok
)paren
(brace
macro_line|#if MANY_SESSION
macro_line|#else
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif MANY_SESSION
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|check_allowed1
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|st_busy
)paren
(brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_ne
id|audio_pausing
)paren
(brace
id|i
op_assign
id|check_allowed2
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_eq
id|audio_playing
)paren
id|seek_pos_audio_end
c_func
(paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|frame_size_valid
)paren
(brace
id|i
op_assign
id|DiskInfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
macro_line|#if MANY_SESSION
macro_line|#else
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif MANY_SESSION
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|check_allowed1
c_func
(paren
id|func
comma
id|subfunc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
DECL|function|xx_PlayAudioMSF
r_static
r_int
id|xx_PlayAudioMSF
c_func
(paren
r_int
id|pos_audio_start
comma
r_int
id|pos_audio_end
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_eq
id|audio_playing
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|clr_cmdbuf
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x0E
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_wait_if_busy
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x0B
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
op_or
id|f_wait_if_busy
suffix:semicolon
)brace
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|pos_audio_start
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|pos_audio_start
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|pos_audio_start
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
(paren
id|pos_audio_end
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
(paren
id|pos_audio_end
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|pos_audio_end
op_amp
l_int|0x00FF
suffix:semicolon
id|response_count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|cmd_out
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * Called from the timer to check the results of the get-status cmd.&n; */
DECL|function|sbp_status
r_static
r_int
id|sbp_status
c_func
(paren
r_void
)paren
(brace
r_int
id|st
suffix:semicolon
id|st
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: sbp_status: timeout.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_SPI
comma
l_string|&quot;SBPCD: motor got off - ignoring.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_check
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: st_check detected - retrying.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_door_closed
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: door is open - retrying.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_caddy_in
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: disk removed - retrying.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_diskok
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: !st_diskok detected - retrying.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st_busy
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: st_busy detected - retrying.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * ioctl support, adopted from scsi/sr_ioctl.c and mcd.c&n; */
DECL|function|SBPCD_IOCTL
r_static
r_int
id|SBPCD_IOCTL
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
)paren
(brace
r_int
id|i
comma
id|st
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IO2
comma
l_string|&quot;SBPCD: ioctl(%d, 0x%08lX, 0x%08lX)&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
comma
id|cmd
comma
id|arg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|i
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|NR_SBPCD
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: ioctl: bad device: %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
multiline_comment|/* no such drive */
)brace
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
id|st
op_assign
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|toc_valid
)paren
(brace
id|i
op_assign
id|DiskInfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* error reading TOC */
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_IO2
comma
l_string|&quot;SBPCD: ioctl: device %d, request %04X&bslash;n&quot;
comma
id|i
comma
id|cmd
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
multiline_comment|/* Sun-compatible */
(brace
r_case
id|DDIOCSDBG
suffix:colon
multiline_comment|/* DDI Debug */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
id|i
op_assign
id|sbpcd_dbg_ioctl
c_func
(paren
id|arg
comma
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
r_case
id|CDROMPAUSE
suffix:colon
multiline_comment|/* Pause the drive */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMPAUSE entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* pause the drive unit when it is currently in PLAY mode,         */
multiline_comment|/* or reset the starting and ending locations when in PAUSED mode. */
multiline_comment|/* If applicable, at the next stopping point it reaches            */
multiline_comment|/* the drive will discontinue playing.                             */
r_switch
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
)paren
(brace
r_case
id|audio_playing
suffix:colon
id|i
op_assign
id|xx_Pause_Resume
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|audio_pausing
suffix:semicolon
id|i
op_assign
id|xx_ReadSubQ
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_start
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_tot
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|audio_pausing
suffix:colon
id|i
op_assign
id|xx_Seek
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_start
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_case
id|CDROMRESUME
suffix:colon
multiline_comment|/* resume paused audio play */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMRESUME entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* resume playing audio tracks when a previous PLAY AUDIO call has  */
multiline_comment|/* been paused with a PAUSE command.                                */
multiline_comment|/* It will resume playing from the location saved in SubQ_run_tot.  */
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_ne
id|audio_pausing
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|i
op_assign
id|xx_Pause_Resume
c_func
(paren
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|audio_playing
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMPLAYMSF
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMPLAYMSF entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_eq
id|audio_playing
)paren
(brace
id|i
op_assign
id|xx_Pause_Resume
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|i
op_assign
id|xx_ReadSubQ
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_start
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_tot
suffix:semicolon
id|i
op_assign
id|xx_Seek
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_start
comma
l_int|1
)paren
suffix:semicolon
)brace
id|st
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_msf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
r_return
(paren
id|st
)paren
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|msf
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_msf
)paren
)paren
suffix:semicolon
multiline_comment|/* values come as msf-bin */
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_start
op_assign
(paren
id|msf.cdmsf_min0
op_lshift
l_int|16
)paren
op_or
(paren
id|msf.cdmsf_sec0
op_lshift
l_int|8
)paren
op_or
id|msf.cdmsf_frame0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_end
op_assign
(paren
id|msf.cdmsf_min1
op_lshift
l_int|16
)paren
op_or
(paren
id|msf.cdmsf_sec1
op_lshift
l_int|8
)paren
op_or
id|msf.cdmsf_frame1
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOX
comma
l_string|&quot;SBPCD: ioctl: CDROMPLAYMSF %08X %08X&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_start
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
)paren
suffix:semicolon
id|i
op_assign
id|xx_PlayAudioMSF
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_start
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: xx_PlayAudioMSF returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
macro_line|#endif 0
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|audio_playing
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMPLAYTRKIND
suffix:colon
multiline_comment|/* Play a track.  This currently ignores index. */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMPLAYTRKIND entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_eq
id|audio_playing
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOX
comma
l_string|&quot;SBPCD: CDROMPLAYTRKIND: already audio_playing.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|st
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_ti
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOX
comma
l_string|&quot;SBPCD: CDROMPLAYTRKIND: verify_area error.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
id|st
)paren
suffix:semicolon
)brace
id|memcpy_fromfs
c_func
(paren
op_amp
id|ti
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_ti
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOX
comma
l_string|&quot;SBPCD: ioctl: trk0: %d, ind0: %d, trk1:%d, ind1:%d&bslash;n&quot;
comma
id|ti.cdti_trk0
comma
id|ti.cdti_ind0
comma
id|ti.cdti_trk1
comma
id|ti.cdti_ind1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti.cdti_trk0
OL
id|DriveStruct
(braket
id|d
)braket
dot
id|n_first_track
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti.cdti_trk0
OG
id|DriveStruct
(braket
id|d
)braket
dot
id|n_last_track
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti.cdti_trk1
OL
id|ti.cdti_trk0
)paren
id|ti.cdti_trk1
op_assign
id|ti.cdti_trk0
suffix:semicolon
r_if
c_cond
(paren
id|ti.cdti_trk1
OG
id|DriveStruct
(braket
id|d
)braket
dot
id|n_last_track
)paren
id|ti.cdti_trk1
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|n_last_track
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_start
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|ti.cdti_trk0
)braket
dot
id|address
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_end
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|ti.cdti_trk1
op_plus
l_int|1
)braket
dot
id|address
suffix:semicolon
id|i
op_assign
id|xx_PlayAudioMSF
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_start
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|pos_audio_end
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
macro_line|#endif 0
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
id|audio_playing
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMREADTOCHDR
suffix:colon
multiline_comment|/* Read the table of contents header */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMREADTOCHDR entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tochdr.cdth_trk0
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|n_first_track
suffix:semicolon
id|tochdr.cdth_trk1
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|n_last_track
suffix:semicolon
id|st
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_tochdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
r_return
(paren
id|st
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|tochdr
comma
r_sizeof
(paren
r_struct
id|cdrom_tochdr
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMREADTOCENTRY
suffix:colon
multiline_comment|/* Read an entry in the table of contents */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMREADTOCENTRY entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|st
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_tocentry
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
r_return
(paren
id|st
)paren
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|tocentry
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_tocentry
)paren
)paren
suffix:semicolon
id|i
op_assign
id|tocentry.cdte_track
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|CDROM_LEADOUT
)paren
id|i
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|n_last_track
op_plus
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|i
id|DriveStruct
(braket
id|d
)braket
dot
id|n_last_track
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|tocentry.cdte_adr
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|ctl_adr
op_amp
l_int|0x0F
suffix:semicolon
id|tocentry.cdte_ctrl
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|ctl_adr
op_rshift
l_int|4
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|tocentry.cdte_datamode
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|format
suffix:semicolon
r_if
c_cond
(paren
id|tocentry.cdte_format
op_eq
id|CDROM_MSF
)paren
multiline_comment|/* MSF-bin required */
(brace
id|tocentry.cdte_addr.msf.minute
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|address
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|tocentry.cdte_addr.msf.second
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|address
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|tocentry.cdte_addr.msf.frame
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|address
op_amp
l_int|0x00FF
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tocentry.cdte_format
op_eq
id|CDROM_LBA
)paren
multiline_comment|/* blk required */
id|tocentry.cdte_addr.lba
op_assign
id|msf2blk
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|TocBuffer
(braket
id|i
)braket
dot
id|address
)paren
suffix:semicolon
r_else
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|st
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_tocentry
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
r_return
(paren
id|st
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|tocentry
comma
r_sizeof
(paren
r_struct
id|cdrom_tocentry
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMSTOP
suffix:colon
multiline_comment|/* Spin down the drive */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMSTOP entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|i
op_assign
id|xx_Pause_Resume
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMSTART
suffix:colon
multiline_comment|/* Spin up the drive */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMSTART entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|i
op_assign
id|xx_SpinUp
c_func
(paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMEJECT
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMEJECT entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#if WORKMAN
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|0xFF
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif WORKMAN
id|i
op_assign
id|yy_SpinDown
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMVOLCTRL
suffix:colon
multiline_comment|/* Volume control */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMVOLCTRL entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|st
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|volctrl
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
r_return
(paren
id|st
)paren
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|volctrl
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|volctrl
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_chan0
op_assign
l_int|0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_ctrl0
op_assign
id|volctrl.channel0
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_chan1
op_assign
l_int|1
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|vol_ctrl1
op_assign
id|volctrl.channel1
suffix:semicolon
id|i
op_assign
id|xx_SetVolume
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMSUBCHNL
suffix:colon
multiline_comment|/* Get subchannel info */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOS
comma
l_string|&quot;SBPCD: ioctl: CDROMSUBCHNL entered.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|st_spinning
)paren
op_logical_or
(paren
op_logical_neg
id|subq_valid
)paren
)paren
(brace
id|i
op_assign
id|xx_ReadSubQ
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|st
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_subchnl
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
r_return
(paren
id|st
)paren
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|SC
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_subchnl
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|audio_state
)paren
(brace
r_case
id|audio_playing
suffix:colon
id|SC.cdsc_audiostatus
op_assign
id|CDROM_AUDIO_PLAY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|audio_pausing
suffix:colon
id|SC.cdsc_audiostatus
op_assign
id|CDROM_AUDIO_PAUSED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SC.cdsc_audiostatus
op_assign
id|CDROM_AUDIO_NO_STATUS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SC.cdsc_adr
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_ctl_adr
suffix:semicolon
id|SC.cdsc_ctrl
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_ctl_adr
op_rshift
l_int|4
suffix:semicolon
id|SC.cdsc_trk
op_assign
id|bcd2bin
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_trk
)paren
suffix:semicolon
id|SC.cdsc_ind
op_assign
id|bcd2bin
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_pnt_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SC.cdsc_format
op_eq
id|CDROM_LBA
)paren
(brace
id|SC.cdsc_absaddr.lba
op_assign
id|msf2blk
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_tot
)paren
suffix:semicolon
id|SC.cdsc_reladdr.lba
op_assign
id|msf2blk
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_trk
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* not only if (SC.cdsc_format==CDROM_MSF) */
(brace
id|SC.cdsc_absaddr.msf.minute
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_absaddr.msf.second
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_absaddr.msf.frame
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_tot
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_reladdr.msf.minute
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_rshift
l_int|16
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_reladdr.msf.second
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_rshift
l_int|8
)paren
op_amp
l_int|0x00FF
suffix:semicolon
id|SC.cdsc_reladdr.msf.frame
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|SubQ_run_trk
op_amp
l_int|0x00FF
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|SC
comma
r_sizeof
(paren
r_struct
id|cdrom_subchnl
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOS
comma
l_string|&quot;SBPCD: CDROMSUBCHNL: %1X %02X %08X %08X %02X %02X %06X %06X&bslash;n&quot;
comma
id|SC.cdsc_format
comma
id|SC.cdsc_audiostatus
comma
id|SC.cdsc_adr
comma
id|SC.cdsc_ctrl
comma
id|SC.cdsc_trk
comma
id|SC.cdsc_ind
comma
id|SC.cdsc_absaddr
comma
id|SC.cdsc_reladdr
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMREADMODE1
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMREADMODE1 requested.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|xx_ModeSelect
c_func
(paren
id|CD_FRAMESIZE
)paren
suffix:semicolon
id|xx_ModeSense
c_func
(paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_M1
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|CDROMREADMODE2
suffix:colon
multiline_comment|/* not useable at the moment */
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMREADMODE2 requested.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|xx_ModeSelect
c_func
(paren
id|CD_FRAMESIZE_XA
)paren
suffix:semicolon
id|xx_ModeSense
c_func
(paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_M2
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#if READ_AUDIO
r_case
id|CDROMREADAUDIO
suffix:colon
(brace
multiline_comment|/* start of CDROMREADAUDIO */
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
comma
id|frame
comma
id|block
suffix:semicolon
id|u_int
r_try
op_assign
l_int|0
suffix:semicolon
id|u_long
id|timeout
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
id|u_int
id|data_tries
op_assign
l_int|0
suffix:semicolon
id|u_int
id|data_waits
op_assign
l_int|0
suffix:semicolon
id|u_int
id|data_retrying
op_assign
l_int|0
suffix:semicolon
r_int
id|status_tries
suffix:semicolon
r_int
id|error_flag
suffix:semicolon
id|error_flag
op_assign
l_int|0
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: CDROMREADAUDIO requested.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_read_audio
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|read_audio
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|cdrom_read_audio
)paren
)paren
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|read_audio.buf
comma
id|CD_FRAMESIZE_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_audio.addr_format
op_eq
id|CDROM_MSF
)paren
multiline_comment|/* MSF-bin specification of where to start */
id|block
op_assign
id|msf2blk
c_func
(paren
id|read_audio.addr.lba
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|read_audio.addr_format
op_eq
id|CDROM_LBA
)paren
multiline_comment|/* lba specification of where to start */
id|block
op_assign
id|read_audio.addr.lba
suffix:semicolon
r_else
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_audio.nframes
op_ne
l_int|1
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: lba: %d, msf: %06X&bslash;n&quot;
comma
id|block
comma
id|blk2msf
c_func
(paren
id|block
)paren
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: before xx_ReadStatus.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|data_tries
op_assign
l_int|5
suffix:semicolon
id|data_tries
OG
l_int|0
suffix:semicolon
id|data_tries
op_decrement
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: data_tries=%d ...&bslash;n&quot;
comma
id|data_tries
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_AU
suffix:semicolon
id|xx_ModeSelect
c_func
(paren
id|CD_FRAMESIZE_RAW
)paren
suffix:semicolon
id|xx_ModeSense
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|status_tries
op_assign
l_int|3
suffix:semicolon
id|status_tries
OG
l_int|0
suffix:semicolon
id|status_tries
op_decrement
)paren
(brace
id|flags_cmd_out
op_or_assign
id|f_respo3
suffix:semicolon
id|xx_ReadStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbp_status
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wait a bit, try again */
)brace
r_if
c_cond
(paren
id|status_tries
op_eq
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: sbp_status: failed after 3 tries.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: sbp_status: ok.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
id|flags_cmd_out
op_or_assign
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_bit1
suffix:semicolon
id|cmd_type
op_assign
id|READ_M2
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* &quot;read XA frames&quot; command for old drives */
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|block
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* # of frames */
id|drvcmd
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
multiline_comment|/* if new_drive */
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* &quot;read frames&quot; command for new drives */
id|lba2msf
c_func
(paren
id|block
comma
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* msf-bin format required */
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* # of frames */
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: before giving &bslash;&quot;read&bslash;&quot; command.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
id|drvcmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: after giving &bslash;&quot;read&bslash;&quot; command.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|frame
op_assign
l_int|1
suffix:semicolon
id|frame
OL
l_int|2
op_logical_and
op_logical_neg
id|error_flag
suffix:semicolon
id|frame
op_increment
)paren
(brace
r_try
op_assign
id|maxtim_data
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|900
suffix:semicolon
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
r_try
op_ne
l_int|0
suffix:semicolon
r_try
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
r_try
op_ne
l_int|0
op_logical_or
id|timeout
op_le
id|jiffies
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|data_retrying
op_eq
l_int|0
)paren
id|data_waits
op_increment
suffix:semicolon
id|data_retrying
op_assign
l_int|1
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_try
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
r_try
op_eq
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: read_audio: sbp_data: CDi_status timeout.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|error_flag
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: sbp_data: CDi_status ok.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_amp
id|s_not_data_ready
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: read_audio: sbp_data: DATA_READY timeout.&bslash;n&quot;
)paren
suffix:semicolon
id|error_flag
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: before reading data.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|CLEAR_TIMER
suffix:semicolon
id|error_flag
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|aud_buf
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_d_i
comma
l_int|0x01
)paren
suffix:semicolon
id|READ_DATA
c_func
(paren
id|CDi_data
comma
id|p
comma
id|CD_FRAMESIZE_RAW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_d_i
comma
l_int|0x00
)paren
suffix:semicolon
id|data_retrying
op_assign
l_int|0
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: after reading data.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error_flag
)paren
multiline_comment|/* must have been spurious D_RDY or (ATTN&amp;&amp;!D_RDY) */
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: read aborted by drive&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if 0000
id|i
op_assign
id|DriveReset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ugly fix to prevent a hang */
macro_line|#endif 0000
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
id|i
op_assign
id|maxtim_data
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|900
suffix:semicolon
id|timeout
OG
id|jiffies
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
l_int|0
op_logical_or
id|timeout
op_le
id|jiffies
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: STATUS TIMEOUT AFTER READ&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_attention
)paren
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: sbp_data: timeout waiting DRV_ATTN - retrying&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|i
op_assign
id|DriveReset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ugly fix to prevent a hang */
r_continue
suffix:semicolon
)brace
)brace
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
id|xx_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* builds status_byte, returns orig. status (old) or faked p_success_old (new) */
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: xx_ReadStatus error after read: %02X&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* FIXME */
)brace
)brace
r_while
c_loop
(paren
(paren
op_logical_neg
id|new_drive
)paren
op_logical_and
(paren
op_logical_neg
id|st_check
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|i
op_amp
id|p_success_old
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_check
)paren
(brace
id|i
op_assign
id|xx_ReadError
c_func
(paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: xx_ReadError was necessary after read: %02X&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
(paren
id|u_char
op_star
)paren
id|read_audio.buf
comma
(paren
id|u_char
op_star
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|aud_buf
comma
id|CD_FRAMESIZE_RAW
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: memcpy_tofs done.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|xx_ModeSelect
c_func
(paren
id|CD_FRAMESIZE
)paren
suffix:semicolon
id|xx_ModeSense
c_func
(paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|mode
op_assign
id|READ_M1
suffix:semicolon
r_if
c_cond
(paren
id|data_tries
op_eq
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: failed after 5 tries.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|8
)paren
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_AUD
comma
l_string|&quot;SBPCD: read_audio: successful return.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* end of CDROMREADAUDIO */
macro_line|#endif READ_AUDIO
r_case
id|BLKRASET
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_rdev
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
OG
l_int|0xff
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|read_ahead
(braket
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
op_assign
id|arg
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|DPRINTF
c_func
(paren
(paren
id|DBG_IOC
comma
l_string|&quot;SBPCD: ioctl: unknown function request %04X&bslash;n&quot;
comma
id|cmd
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* end switch(cmd) */
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  Take care of the different block sizes between cdrom and Linux.&n; *  When Linux gets variable block sizes this will probably go away.&n; */
DECL|function|sbp_transfer
r_static
r_void
id|sbp_transfer
c_func
(paren
r_void
)paren
(brace
r_int
id|offs
suffix:semicolon
r_while
c_loop
(paren
(paren
id|CURRENT-&gt;nr_sectors
OG
l_int|0
)paren
op_logical_and
(paren
id|CURRENT-&gt;sector
op_div
l_int|4
op_ge
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_first_frame
)paren
op_logical_and
(paren
id|CURRENT-&gt;sector
op_div
l_int|4
op_le
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_last_frame
)paren
)paren
(brace
id|offs
op_assign
(paren
id|CURRENT-&gt;sector
op_minus
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_first_frame
op_star
l_int|4
)paren
op_star
l_int|512
suffix:semicolon
id|memcpy
c_func
(paren
id|CURRENT-&gt;buffer
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_buf
op_plus
id|offs
comma
l_int|512
)paren
suffix:semicolon
id|CURRENT-&gt;nr_sectors
op_decrement
suffix:semicolon
id|CURRENT-&gt;sector
op_increment
suffix:semicolon
id|CURRENT-&gt;buffer
op_add_assign
l_int|512
suffix:semicolon
)brace
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  I/O request routine, called from Linux kernel.&n; */
DECL|function|DO_SBPCD_REQUEST
r_static
r_void
id|DO_SBPCD_REQUEST
c_func
(paren
r_void
)paren
(brace
id|u_int
id|block
suffix:semicolon
r_int
id|dev
suffix:semicolon
id|u_int
id|nsect
suffix:semicolon
r_int
id|i
comma
id|status_tries
comma
id|data_tries
suffix:semicolon
id|request_loop
suffix:colon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|CURRENT
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|CURRENT-&gt;dev
OL
l_int|0
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT
op_member_access_from_pointer
id|sector
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|dev
op_assign
id|MINOR
c_func
(paren
id|CURRENT-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
OL
l_int|0
)paren
op_logical_or
(paren
id|dev
op_ge
id|NR_SBPCD
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: do_request: bad device: %d&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|switch_drive
c_func
(paren
id|dev
)paren
suffix:semicolon
id|INIT_REQUEST
suffix:semicolon
id|block
op_assign
id|CURRENT-&gt;sector
suffix:semicolon
multiline_comment|/* always numbered as 512-byte-pieces */
id|nsect
op_assign
id|CURRENT-&gt;nr_sectors
suffix:semicolon
multiline_comment|/* always counted as 512-byte-pieces */
r_if
c_cond
(paren
id|CURRENT-&gt;cmd
op_ne
id|READ
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: bad cmd %d&bslash;n&quot;
comma
id|CURRENT-&gt;cmd
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_goto
id|request_loop
suffix:semicolon
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_BSZ
comma
l_string|&quot;SBPCD: read sector %d (%d sectors)&bslash;n&quot;
comma
id|block
comma
id|nsect
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_MUL
comma
l_string|&quot;SBPCD: read LBA %d&bslash;n&quot;
comma
id|block
op_div
l_int|4
)paren
)paren
suffix:semicolon
id|sbp_transfer
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* if we satisfied the request from the buffer, we&squot;re done. */
r_if
c_cond
(paren
id|CURRENT-&gt;nr_sectors
op_eq
l_int|0
)paren
(brace
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_goto
id|request_loop
suffix:semicolon
)brace
id|i
op_assign
id|prepare
c_func
(paren
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* at moment not really a hassle check, but ... */
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: &bslash;&quot;prepare&bslash;&quot; tells error %d -- ignored&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|xx_SpinUp
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef XA_TEST1
r_if
c_cond
(paren
(paren
op_logical_neg
id|new_drive
)paren
op_logical_and
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|xa_byte
op_eq
l_int|0x20
)paren
)paren
multiline_comment|/* XA disk with old drive */
(brace
id|xx_ModeSelect
c_func
(paren
id|CD_FRAMESIZE_XA
)paren
suffix:semicolon
id|xx_ModeSense
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif XA_TEST1
r_for
c_loop
(paren
id|data_tries
op_assign
l_int|3
suffix:semicolon
id|data_tries
OG
l_int|0
suffix:semicolon
id|data_tries
op_decrement
)paren
(brace
r_for
c_loop
(paren
id|status_tries
op_assign
l_int|3
suffix:semicolon
id|status_tries
OG
l_int|0
suffix:semicolon
id|status_tries
op_decrement
)paren
(brace
id|flags_cmd_out
op_or_assign
id|f_respo3
suffix:semicolon
id|xx_ReadStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbp_status
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wait a bit, try again */
)brace
r_if
c_cond
(paren
id|status_tries
op_eq
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: sbp_status: failed after 3 tries&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sbp_read_cmd
c_func
(paren
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbp_data
c_func
(paren
)paren
op_ne
l_int|0
)paren
(brace
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_goto
id|request_loop
suffix:semicolon
)brace
)brace
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* wait a bit, try again */
r_goto
id|request_loop
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  build and send the READ command.&n; *  Maybe it would be better to &quot;set mode1&quot; before ...&n; */
DECL|function|sbp_read_cmd
r_static
r_void
id|sbp_read_cmd
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|block
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_first_frame
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_last_frame
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* purge buffer */
id|block
op_assign
id|CURRENT-&gt;sector
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|new_drive
)paren
(brace
macro_line|#if MANY_SESSION
id|DPRINTF
c_func
(paren
(paren
id|DBG_MUL
comma
l_string|&quot;SBPCD: read MSF %08X&bslash;n&quot;
comma
id|blk2msf
c_func
(paren
id|block
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|f_multisession
)paren
op_logical_and
(paren
id|multisession_valid
)paren
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_MUL
comma
l_string|&quot;SBPCD: MultiSession: use %08X for %08X (msf)&bslash;n&quot;
comma
id|blk2msf
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|lba_multi
op_plus
id|block
)paren
comma
id|blk2msf
c_func
(paren
id|block
)paren
)paren
)paren
suffix:semicolon
id|block
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|lba_multi
op_plus
id|block
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
(paren
id|block
op_eq
id|CD_BLOCK_OFFSET
op_plus
l_int|16
)paren
op_logical_and
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|f_multisession
)paren
op_logical_and
(paren
id|multisession_valid
)paren
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_MUL
comma
l_string|&quot;SBPCD: MultiSession: use %08X for %08X (msf)&bslash;n&quot;
comma
id|blk2msf
c_func
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|lba_multi
op_plus
l_int|16
)paren
comma
id|blk2msf
c_func
(paren
id|block
)paren
)paren
)paren
suffix:semicolon
id|block
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|lba_multi
op_plus
l_int|16
suffix:semicolon
)brace
macro_line|#endif MANY_SESSION
)brace
r_if
c_cond
(paren
id|block
op_plus
id|SBP_BUFFER_FRAMES
op_le
id|DriveStruct
(braket
id|d
)braket
dot
id|CDsize_frm
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
op_assign
id|SBP_BUFFER_FRAMES
suffix:semicolon
r_else
(brace
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|CDsize_frm
op_minus
id|block
suffix:semicolon
multiline_comment|/* avoid reading past end of data */
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
OL
l_int|1
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: requested frame %d, CD size %d ???&bslash;n&quot;
comma
id|block
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|CDsize_frm
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_current
op_assign
l_int|0
suffix:semicolon
id|flags_cmd_out
op_assign
id|f_putcmd
op_or
id|f_respo2
op_or
id|f_ResponseStatus
op_or
id|f_obey_p_check
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
id|flags_cmd_out
op_or_assign
id|f_lopsta
op_or
id|f_getsta
op_or
id|f_bit1
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|xa_byte
op_eq
l_int|0x20
)paren
(brace
id|cmd_type
op_assign
id|READ_M2
suffix:semicolon
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* &quot;read XA frames&quot; command for old drives */
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|block
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* &quot;read frames&quot; command for old drives */
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
op_ge
id|drv_201
)paren
(brace
id|lba2msf
c_func
(paren
id|block
comma
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* msf-bcd format required */
id|bin2bcdx
c_func
(paren
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|bin2bcdx
c_func
(paren
op_amp
id|drvcmd
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|bin2bcdx
c_func
(paren
op_amp
id|drvcmd
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|drvcmd
(braket
l_int|1
)braket
op_assign
(paren
id|block
op_rshift
l_int|16
)paren
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|2
)braket
op_assign
(paren
id|block
op_rshift
l_int|8
)paren
op_amp
l_int|0x000000ff
suffix:semicolon
id|drvcmd
(braket
l_int|3
)braket
op_assign
id|block
op_amp
l_int|0x000000ff
suffix:semicolon
)brace
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|drv_type
OL
id|drv_201
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* flag &quot;lba or msf-bcd format&quot; */
)brace
)brace
r_else
multiline_comment|/* if new_drive */
(brace
id|drvcmd
(braket
l_int|0
)braket
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* &quot;read frames&quot; command for new drives */
id|lba2msf
c_func
(paren
id|block
comma
op_amp
id|drvcmd
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* msf-bin format required */
id|drvcmd
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|drvcmd
(braket
l_int|6
)braket
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
suffix:semicolon
)brace
id|SBPCD_CLI
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
id|OUT
c_func
(paren
id|CDo_command
comma
id|drvcmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|SBPCD_STI
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  Check the completion of the read-data command.  On success, read&n; *  the SBP_BUFFER_FRAMES * 2048 bytes of data from the disk into buffer.&n; */
DECL|function|sbp_data
r_static
r_int
id|sbp_data
c_func
(paren
r_void
)paren
(brace
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
comma
id|frame
suffix:semicolon
id|u_int
r_try
op_assign
l_int|0
suffix:semicolon
id|u_long
id|timeout
suffix:semicolon
id|u_char
op_star
id|p
suffix:semicolon
id|u_int
id|data_tries
op_assign
l_int|0
suffix:semicolon
id|u_int
id|data_waits
op_assign
l_int|0
suffix:semicolon
id|u_int
id|data_retrying
op_assign
l_int|0
suffix:semicolon
r_int
id|error_flag
suffix:semicolon
r_int
id|xa_count
suffix:semicolon
id|error_flag
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|frame
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_current
suffix:semicolon
id|frame
OL
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
op_logical_and
op_logical_neg
id|error_flag
suffix:semicolon
id|frame
op_increment
)paren
(brace
id|SBPCD_CLI
suffix:semicolon
r_try
op_assign
id|maxtim_data
suffix:semicolon
macro_line|#if LONG_TIMING
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|900
suffix:semicolon
suffix:semicolon
)paren
macro_line|#else
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|100
suffix:semicolon
suffix:semicolon
)paren
macro_line|#endif
(brace
r_for
c_loop
(paren
suffix:semicolon
r_try
op_ne
l_int|0
suffix:semicolon
r_try
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
r_try
op_ne
l_int|0
op_logical_or
id|timeout
op_le
id|jiffies
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|data_retrying
op_eq
l_int|0
)paren
id|data_waits
op_increment
suffix:semicolon
id|data_retrying
op_assign
l_int|1
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_try
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
r_try
op_eq
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: sbp_data: CDi_status timeout.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|error_flag
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_amp
id|s_not_data_ready
)paren
(brace
r_if
c_cond
(paren
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|ored_ctl_adr
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;SBPCD: CD contains no data tracks.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;SBPCD: sbp_data: DATA_READY timeout.&bslash;n&quot;
)paren
suffix:semicolon
id|error_flag
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SBPCD_STI
suffix:semicolon
id|CLEAR_TIMER
suffix:semicolon
id|error_flag
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_buf
op_plus
id|frame
op_star
id|CD_FRAMESIZE
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_d_i
comma
l_int|0x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|READ_M2
)paren
id|READ_DATA
c_func
(paren
id|CDi_data
comma
id|xa_head_buf
comma
id|CD_XA_HEAD
)paren
suffix:semicolon
id|READ_DATA
c_func
(paren
id|CDi_data
comma
id|p
comma
id|CD_FRAMESIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|READ_M2
)paren
id|READ_DATA
c_func
(paren
id|CDi_data
comma
id|xa_tail_buf
comma
id|CD_XA_TAIL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
id|OUT
c_func
(paren
id|CDo_sel_d_i
comma
l_int|0x00
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_current
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|READ_M2
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_XA
comma
l_string|&quot;SBPCD: xa_head:&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|xa_count
op_assign
l_int|0
suffix:semicolon
id|xa_count
OL
id|CD_XA_HEAD
suffix:semicolon
id|xa_count
op_increment
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_XA
comma
l_string|&quot; %02X&quot;
comma
id|xa_head_buf
(braket
id|xa_count
)braket
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_XA
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|data_tries
op_increment
suffix:semicolon
id|data_retrying
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|data_tries
op_ge
l_int|1000
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: info: %d waits in %d frames.&bslash;n&quot;
comma
id|data_waits
comma
id|data_tries
)paren
)paren
suffix:semicolon
id|data_waits
op_assign
id|data_tries
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|SBPCD_STI
suffix:semicolon
r_if
c_cond
(paren
id|error_flag
)paren
multiline_comment|/* must have been spurious D_RDY or (ATTN&amp;&amp;!D_RDY) */
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: read aborted by drive&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|i
op_assign
id|DriveReset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ugly fix to prevent a hang */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
(brace
id|SBPCD_CLI
suffix:semicolon
id|i
op_assign
id|maxtim_data
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
id|jiffies
op_plus
l_int|100
suffix:semicolon
id|timeout
OG
id|jiffies
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|j
op_assign
id|inb
c_func
(paren
id|CDi_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_data_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_not_result_ready
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|j
op_amp
id|s_attention
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
l_int|0
op_logical_or
id|timeout
op_le
id|jiffies
)paren
r_break
suffix:semicolon
id|sbp_sleep
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: STATUS TIMEOUT AFTER READ&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|j
op_amp
id|s_attention
)paren
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: sbp_data: timeout waiting DRV_ATTN - retrying&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|i
op_assign
id|DriveReset
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* ugly fix to prevent a hang */
id|SBPCD_STI
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|SBPCD_STI
suffix:semicolon
)brace
r_do
(brace
r_if
c_cond
(paren
op_logical_neg
id|new_drive
)paren
id|xx_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* builds status_byte, returns orig. status (old) or faked p_success_old (new) */
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: xx_ReadStatus error after read: %02X&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
op_logical_neg
id|new_drive
)paren
op_logical_and
(paren
op_logical_neg
id|st_check
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|i
op_amp
id|p_success_old
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st_check
)paren
(brace
id|i
op_assign
id|xx_ReadError
c_func
(paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: xx_ReadError was necessary after read: %02X&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_first_frame
op_assign
id|CURRENT
op_member_access_from_pointer
id|sector
op_div
l_int|4
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_last_frame
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_first_frame
op_plus
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
op_minus
l_int|1
suffix:semicolon
id|sbp_transfer
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  Open the device special file.  Check that a disk is in. Read TOC.&n; */
DECL|function|SBPCD_OPEN
r_int
id|SBPCD_OPEN
c_func
(paren
r_struct
id|inode
op_star
id|ip
comma
r_struct
id|file
op_star
id|fp
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ndrives
op_eq
l_int|0
)paren
r_return
(paren
op_minus
id|ENXIO
)paren
suffix:semicolon
multiline_comment|/* no hardware */
id|i
op_assign
id|MINOR
c_func
(paren
id|ip-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|NR_SBPCD
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: open: bad device: %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
multiline_comment|/* no such drive */
)brace
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|xx_SpinUp
c_func
(paren
)paren
suffix:semicolon
id|flags_cmd_out
op_or_assign
id|f_respo2
suffix:semicolon
id|xx_ReadStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* command: give 1-byte status */
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: sbpcd_open: xx_ReadStatus timed out&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* drive doesn&squot;t respond */
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_STA
comma
l_string|&quot;SBPCD: sbpcd_open: status %02X&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_door_closed
op_logical_or
op_logical_neg
id|st_caddy_in
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: sbpcd_open: no disk in drive&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * try to keep an &quot;open&quot; counter here and lock the door if 0-&gt;1.&n; */
id|DPRINTF
c_func
(paren
(paren
id|DBG_LCK
comma
l_string|&quot;SBPCD: open_count: %d -&gt; %d&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|open_count
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|open_count
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|DriveStruct
(braket
id|d
)braket
dot
id|open_count
op_eq
l_int|1
)paren
(brace
r_do
id|i
op_assign
id|yy_LockDoor
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|xx_SpinUp
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|DiskInfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|ored_ctl_adr
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: CD contains no data tracks.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  On close, we flush all sbp blocks from the buffer cache.&n; */
DECL|function|SBPCD_RELEASE
r_static
r_void
id|SBPCD_RELEASE
c_func
(paren
r_struct
id|inode
op_star
id|ip
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|MINOR
c_func
(paren
id|ip-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|NR_SBPCD
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: release: bad device: %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|switch_drive
c_func
(paren
id|i
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_first_frame
op_assign
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_last_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|sync_dev
c_func
(paren
id|ip-&gt;i_rdev
)paren
suffix:semicolon
multiline_comment|/* nonsense if read only device? */
id|invalidate_buffers
c_func
(paren
id|ip-&gt;i_rdev
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|diskstate_flags
op_and_assign
op_complement
id|cd_size_bit
suffix:semicolon
multiline_comment|/*&n; * try to keep an &quot;open&quot; counter here and unlock the door if 1-&gt;0.&n; */
id|DPRINTF
c_func
(paren
(paren
id|DBG_LCK
comma
l_string|&quot;SBPCD: open_count: %d -&gt; %d&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|open_count
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|open_count
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|DriveStruct
(braket
id|d
)braket
dot
id|open_count
op_eq
l_int|0
)paren
(brace
r_do
id|i
op_assign
id|yy_LockDoor
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ne
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *&n; */
DECL|variable|sbpcd_fops
r_static
r_struct
id|file_operations
id|sbpcd_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|block_read
comma
multiline_comment|/* read - general block-dev read */
id|block_write
comma
multiline_comment|/* write - general block-dev write */
l_int|NULL
comma
multiline_comment|/* readdir - bad */
l_int|NULL
comma
multiline_comment|/* select */
id|SBPCD_IOCTL_F
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
id|SBPCD_OPEN_F
comma
multiline_comment|/* open */
id|SBPCD_RELEASE_F
comma
multiline_comment|/* release */
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
multiline_comment|/* fasync */
)brace
suffix:semicolon
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * accept &quot;kernel command line&quot; parameters &n; * (suggested by Peter MacDonald with SLS 1.03)&n; *&n; * use: tell LILO:&n; *                 sbpcd=0x230,SoundBlaster&n; *             or&n; *                 sbpcd=0x300,LaserMate&n; *             or&n; *                 sbpcd=0x330,SPEA&n; *&n; * (upper/lower case sensitive here!!!).&n; *&n; * the address value has to be the TRUE CDROM PORT ADDRESS -&n; * not the soundcard base address.&n; *&n; */
DECL|function|SBPCD_SETUP
r_void
id|SBPCD_SETUP
c_func
(paren
r_char
op_star
id|s
comma
r_int
op_star
id|p
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: sbpcd_setup called with %04X,%s&bslash;n&quot;
comma
id|p
(braket
l_int|1
)braket
comma
id|s
)paren
)paren
suffix:semicolon
id|sbpro_type
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_sb
)paren
)paren
id|sbpro_type
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
id|str_sp
)paren
)paren
id|sbpro_type
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
OG
l_int|0
)paren
id|sbpcd_ioaddr
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
id|CDo_command
op_assign
id|sbpcd_ioaddr
suffix:semicolon
id|CDi_info
op_assign
id|sbpcd_ioaddr
suffix:semicolon
id|CDi_status
op_assign
id|sbpcd_ioaddr
op_plus
l_int|1
suffix:semicolon
id|CDo_reset
op_assign
id|sbpcd_ioaddr
op_plus
l_int|2
suffix:semicolon
id|CDo_enable
op_assign
id|sbpcd_ioaddr
op_plus
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
(brace
id|MIXER_addr
op_assign
id|sbpcd_ioaddr
op_minus
l_int|0x10
op_plus
l_int|0x04
suffix:semicolon
id|MIXER_data
op_assign
id|sbpcd_ioaddr
op_minus
l_int|0x10
op_plus
l_int|0x05
suffix:semicolon
id|CDo_sel_d_i
op_assign
id|sbpcd_ioaddr
op_plus
l_int|1
suffix:semicolon
id|CDi_data
op_assign
id|sbpcd_ioaddr
suffix:semicolon
)brace
r_else
id|CDi_data
op_assign
id|sbpcd_ioaddr
op_plus
l_int|2
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * Sequoia S-1000 CD-ROM Interface Configuration&n; * as used within SPEA Media FX card&n; * The SPEA soundcard has to get jumpered for &n; *     -&gt; interface type &quot;Matsushita/Panasonic&quot; (not Sony or Mitsumi)&n; *     -&gt; I/O base address (0x320, 0x330, 0x340, 0x350)&n; */
DECL|function|config_spea
r_static
r_int
id|config_spea
c_func
(paren
r_void
)paren
(brace
r_int
id|n_ports
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* 2:0x00, 8:0x10, 16:0x20, 32:0x30 */
r_int
id|irq_number
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 2:0x01, 7:0x03, 12:0x05, 15:0x07, OFF:0x00 */
r_int
id|dma_channel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0:0x08, 1:0x18, 3:0x38, 5:0x58, 6:0x68, 7:0x78, OFF: 0x00 */
r_int
id|dack_polarity
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* L:0x00, H:0x80 */
r_int
id|drq_polarity
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* L:0x00, H:0x40 */
r_int
id|i
suffix:semicolon
DECL|macro|SPEA_REG_1
mdefine_line|#define SPEA_REG_1 sbpcd_ioaddr+4
DECL|macro|SPEA_REG_2
mdefine_line|#define SPEA_REG_2 sbpcd_ioaddr+5
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0xFF
)paren
suffix:semicolon
id|i
op_assign
id|inb
c_func
(paren
id|SPEA_REG_1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
l_int|0x0F
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_SEQ
comma
l_string|&quot;SBPCD: no SPEA interface at %04X present.&bslash;n&quot;
comma
id|sbpcd_ioaddr
)paren
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* no interface found */
)brace
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0x04
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
l_int|0xC0
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0x05
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
l_int|0x10
op_or
id|drq_polarity
op_or
id|dack_polarity
)paren
suffix:semicolon
macro_line|#if 1
DECL|macro|SPEA_PATTERN
mdefine_line|#define SPEA_PATTERN 0x80
macro_line|#else
mdefine_line|#define SPEA_PATTERN 0x00
macro_line|#endif
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0x06
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
id|dma_channel
op_or
id|irq_number
op_or
id|SPEA_PATTERN
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
id|dma_channel
op_or
id|irq_number
op_or
id|SPEA_PATTERN
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_1
comma
l_int|0x09
)paren
suffix:semicolon
id|i
op_assign
(paren
id|inb
c_func
(paren
id|SPEA_REG_2
)paren
op_amp
l_int|0xCF
)paren
op_or
id|n_ports
suffix:semicolon
id|OUT
c_func
(paren
id|SPEA_REG_2
comma
id|i
)paren
suffix:semicolon
id|sbpro_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* acts like a LaserMate interface now */
id|DPRINTF
c_func
(paren
(paren
id|DBG_SEQ
comma
l_string|&quot;SBPCD: found SPEA interface at %04X.&bslash;n&quot;
comma
id|sbpcd_ioaddr
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; *  Test for presence of drive and initialize it.  Called at boot time.&n; */
DECL|function|SBPCD_INIT
r_int
r_int
id|SBPCD_INIT
c_func
(paren
id|u_long
id|mem_start
comma
id|u_long
id|mem_end
)paren
(brace
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
r_int
id|addr
(braket
l_int|2
)braket
op_assign
initialization_block
suffix:semicolon
r_int
id|port_index
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* necessary, has consequences for other drivers&squot; init routines */
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD version %s&bslash;n&quot;
comma
id|VERSION
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: Looking for a SoundBlaster/Matsushita CD-ROM drive&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: = = = = = = = = = = W A R N I N G = = = = = = = = = =&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: Auto-Probing can cause a hang (f.e. touching an ethernet card).&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: If that happens, you have to reboot and use the&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: LILO (kernel) command line feature like:&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD:    LILO boot: linux sbpcd=0x230,SoundBlaster&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: or like:&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD:    LILO boot: linux sbpcd=0x300,LaserMate&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: or like:&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD:    LILO boot: linux sbpcd=0x330,SPEA&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: with your REAL address.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: = = = = = = = = = = END of WARNING = = = = = = = = = =&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_WRN
comma
l_string|&quot;SBPCD: &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|autoprobe
(braket
l_int|0
)braket
op_assign
id|sbpcd_ioaddr
suffix:semicolon
multiline_comment|/* possibly changed by kernel command line */
id|autoprobe
(braket
l_int|1
)braket
op_assign
id|sbpro_type
suffix:semicolon
multiline_comment|/* possibly changed by kernel command line */
r_for
c_loop
(paren
id|port_index
op_assign
l_int|0
suffix:semicolon
id|port_index
OL
id|NUM_AUTOPROBE
suffix:semicolon
id|port_index
op_add_assign
l_int|2
)paren
(brace
id|addr
(braket
l_int|1
)braket
op_assign
id|autoprobe
(braket
id|port_index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|addr
(braket
l_int|1
)braket
comma
l_int|4
)paren
)paren
r_continue
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: check_region: free.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|autoprobe
(braket
id|port_index
op_plus
l_int|1
)braket
op_eq
l_int|0
)paren
id|type
op_assign
id|str_lm
suffix:semicolon
r_else
r_if
c_cond
(paren
id|autoprobe
(braket
id|port_index
op_plus
l_int|1
)braket
op_eq
l_int|1
)paren
id|type
op_assign
id|str_sb
suffix:semicolon
r_else
id|type
op_assign
id|str_sp
suffix:semicolon
id|SBPCD_SETUP
c_func
(paren
id|type
comma
id|addr
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: Trying to detect a %s CD-ROM drive at 0x%X.&bslash;n&quot;
comma
id|type
comma
id|CDo_command
)paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: - &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|autoprobe
(braket
id|port_index
op_plus
l_int|1
)braket
op_eq
l_int|2
)paren
(brace
id|i
op_assign
id|config_spea
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
id|i
op_assign
id|check_drives
c_func
(paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: check_drives done.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* drive found */
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* end of cycling through the set of possible I/O port addresses */
r_if
c_cond
(paren
id|ndrives
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: No drive found.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if PRINTK_BUG
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* to avoid possible &quot;printk&quot; bug */
macro_line|#endif
r_return
(paren
id|mem_start
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port_index
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: You should configure sbpcd.h for your hardware.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if PRINTK_BUG
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* to avoid possible &quot;printk&quot; bug */
macro_line|#endif
)brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: %d %s CD-ROM drive(s) at 0x%04X.&bslash;n&quot;
comma
id|ndrives
comma
id|type
comma
id|CDo_command
)paren
suffix:semicolon
macro_line|#if PRINTK_BUG
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* to avoid possible &quot;printk&quot; bug */
macro_line|#endif
id|check_datarate
c_func
(paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: check_datarate done.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_SBPCD
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|j
)braket
dot
id|drv_minor
op_eq
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
id|switch_drive
c_func
(paren
id|j
)paren
suffix:semicolon
id|xy_DriveReset
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|xx_SpinUp
c_func
(paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_first_frame
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* First frame in buffer */
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_last_frame
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Last frame in buffer  */
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_read_frames
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Number of frames being read to buffer */
id|DriveStruct
(braket
id|d
)braket
dot
id|sbp_current
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Frame being currently read */
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|1
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|frame_size
op_assign
id|CD_FRAMESIZE
suffix:semicolon
id|xx_ReadStatus
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* returns orig. status or p_busy_new */
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: init: ResponseStatus returns %02X&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|st_check
)paren
(brace
id|i
op_assign
id|xx_ReadError
c_func
(paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: init: xx_ReadError returns %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
)brace
)brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: init: first GetStatus: %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|error_byte
op_eq
id|aud_12
)paren
(brace
r_do
(brace
id|i
op_assign
id|GetStatus
c_func
(paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INI
comma
l_string|&quot;SBPCD: init: second GetStatus: %02X&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_caddy_in
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|st_diskok
)paren
suffix:semicolon
)brace
id|i
op_assign
id|SetSpeed
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|0
)paren
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbpro_type
op_eq
l_int|1
)paren
(brace
id|OUT
c_func
(paren
id|MIXER_addr
comma
id|MIXER_CD_Volume
)paren
suffix:semicolon
id|OUT
c_func
(paren
id|MIXER_data
comma
l_int|0xCC
)paren
suffix:semicolon
multiline_comment|/* one nibble per channel */
)brace
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;sbpcd&quot;
comma
op_amp
id|sbpcd_fops
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: Can&squot;t get MAJOR %d for Matsushita CDROM&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
macro_line|#if PRINTK_BUG
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* to avoid possible &quot;printk&quot; bug */
macro_line|#endif
r_return
(paren
id|mem_start
)paren
suffix:semicolon
)brace
id|blk_dev
(braket
id|MAJOR_NR
)braket
dot
id|request_fn
op_assign
id|DEVICE_REQUEST
suffix:semicolon
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
id|SBP_BUFFER_FRAMES
op_star
(paren
id|CD_FRAMESIZE
op_div
l_int|512
)paren
suffix:semicolon
id|snarf_region
c_func
(paren
id|CDo_command
comma
l_int|4
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_SBPCD
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|j
)braket
dot
id|drv_minor
op_eq
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n; * allocate memory for the frame buffers&n; */
id|DriveStruct
(braket
id|j
)braket
dot
id|sbp_buf
op_assign
(paren
id|u_char
op_star
)paren
id|mem_start
suffix:semicolon
id|mem_start
op_add_assign
id|SBP_BUFFER_FRAMES
op_star
id|CD_FRAMESIZE
suffix:semicolon
macro_line|#if READ_AUDIO
id|DriveStruct
(braket
id|j
)braket
dot
id|aud_buf
op_assign
(paren
id|u_char
op_star
)paren
id|mem_start
suffix:semicolon
id|mem_start
op_add_assign
id|CD_FRAMESIZE_RAW
suffix:semicolon
macro_line|#endif READ_AUDIO
multiline_comment|/*&n; * set the block size&n; */
id|sbpcd_blocksizes
(braket
id|j
)braket
op_assign
id|CD_FRAMESIZE
suffix:semicolon
)brace
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|sbpcd_blocksizes
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: init done.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
id|mem_start
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
multiline_comment|/*&n; * Check if the media has changed in the CD-ROM drive.&n; * used externally (isofs/inode.c, fs/buffer.c)&n; * Currently disabled (has to get &quot;synchronized&quot;).&n; */
DECL|function|SBPCD_MEDIA_CHANGE
r_int
id|SBPCD_MEDIA_CHANGE
c_func
(paren
r_int
id|full_dev
comma
r_int
id|unused_minor
)paren
(brace
r_int
id|st
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_CHK
comma
l_string|&quot;SBPCD: media_check (%d) called&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|full_dev
)paren
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* &quot;busy&quot; test necessary before we really can check */
r_if
c_cond
(paren
(paren
id|MAJOR
c_func
(paren
id|full_dev
)paren
op_ne
id|MAJOR_NR
)paren
op_logical_or
(paren
id|MINOR
c_func
(paren
id|full_dev
)paren
op_ge
id|NR_SBPCD
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SBPCD: media_check: invalid device %04X.&bslash;n&quot;
comma
id|full_dev
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|switch_drive
c_func
(paren
id|MINOR
c_func
(paren
id|full_dev
)paren
)paren
suffix:semicolon
id|xx_ReadStatus
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* command: give 1-byte status */
id|st
op_assign
id|ResponseStatus
c_func
(paren
)paren
suffix:semicolon
id|DPRINTF
c_func
(paren
(paren
id|DBG_CHK
comma
l_string|&quot;SBPCD: media_check: %02X&bslash;n&quot;
comma
id|DriveStruct
(braket
id|d
)braket
dot
id|status_byte
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
OL
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_INF
comma
l_string|&quot;SBPCD: media_check: ResponseStatus error.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* status not obtainable */
)brace
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_eq
l_int|0xFF
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_CHK
comma
l_string|&quot;SBPCD: media_check: &bslash;&quot;changed&bslash;&quot; assumed.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_spinning
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_CHK
comma
l_string|&quot;SBPCD: media_check: motor off.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|st_door_closed
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_CHK
comma
l_string|&quot;SBPCD: media_check: door open.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|0xFF
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_caddy_in
)paren
(brace
id|DPRINTF
c_func
(paren
(paren
id|DBG_CHK
comma
l_string|&quot;SBPCD: media_check: no disk in drive.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|0xFF
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|st_diskok
)paren
id|DPRINTF
c_func
(paren
(paren
id|DBG_CHK
comma
l_string|&quot;SBPCD: media_check: !st_diskok.&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if 0000
r_if
c_cond
(paren
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_eq
l_int|0xFF
)paren
(brace
id|DriveStruct
(braket
id|d
)braket
dot
id|CD_changed
op_assign
l_int|1
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* driver had a change detected before */
)brace
macro_line|#endif 0000 /* seems to give additional errors at the moment */
r_if
c_cond
(paren
op_logical_neg
id|st_diskok
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* disk not o.k. */
r_if
c_cond
(paren
op_logical_neg
id|st_caddy_in
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* disk removed */
r_if
c_cond
(paren
op_logical_neg
id|st_door_closed
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* door open */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*==========================================================================*/
eof
