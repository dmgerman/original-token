multiline_comment|/*&n; * Driver for the SWIM3 (Super Woz Integrated Machine 3)&n; * floppy controller found on Power Macintoshes.&n; *&n; * Copyright (C) 1996 Paul Mackerras.&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
multiline_comment|/*&n; * TODO:&n; * handle 2 drives&n; * handle GCR disks&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fd.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dbdma.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/mediabay.h&gt;
macro_line|#include &lt;asm/feature.h&gt;
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR&t;FLOPPY_MAJOR
macro_line|#include &lt;linux/blk.h&gt;
DECL|variable|floppy_blocksizes
r_static
r_int
id|floppy_blocksizes
(braket
l_int|2
)braket
op_assign
(brace
l_int|512
comma
l_int|512
)brace
suffix:semicolon
DECL|variable|floppy_sizes
r_static
r_int
id|floppy_sizes
(braket
l_int|2
)braket
op_assign
(brace
l_int|2880
comma
l_int|2880
)brace
suffix:semicolon
DECL|macro|MAX_FLOPPIES
mdefine_line|#define MAX_FLOPPIES&t;2
DECL|enum|swim_state
r_enum
id|swim_state
(brace
DECL|enumerator|idle
id|idle
comma
DECL|enumerator|locating
id|locating
comma
DECL|enumerator|seeking
id|seeking
comma
DECL|enumerator|settling
id|settling
comma
DECL|enumerator|do_transfer
id|do_transfer
comma
DECL|enumerator|jogging
id|jogging
comma
DECL|enumerator|available
id|available
comma
DECL|enumerator|revalidating
id|revalidating
comma
DECL|enumerator|ejecting
id|ejecting
)brace
suffix:semicolon
DECL|macro|REG
mdefine_line|#define REG(x)&t;unsigned char x; char x ## _pad[15];
multiline_comment|/*&n; * The names for these registers mostly represent speculation on my part.&n; * It will be interesting to see how close they are to the names Apple uses.&n; */
DECL|struct|swim3
r_struct
id|swim3
(brace
id|REG
c_func
(paren
id|data
)paren
suffix:semicolon
id|REG
c_func
(paren
id|timer
)paren
suffix:semicolon
multiline_comment|/* counts down at 1MHz */
id|REG
c_func
(paren
id|error
)paren
suffix:semicolon
id|REG
c_func
(paren
id|mode
)paren
suffix:semicolon
id|REG
c_func
(paren
id|select
)paren
suffix:semicolon
multiline_comment|/* controls CA0, CA1, CA2 and LSTRB signals */
id|REG
c_func
(paren
id|setup
)paren
suffix:semicolon
id|REG
c_func
(paren
id|control
)paren
suffix:semicolon
multiline_comment|/* writing bits clears them */
id|REG
c_func
(paren
id|status
)paren
suffix:semicolon
multiline_comment|/* writing bits sets them in control */
id|REG
c_func
(paren
id|intr
)paren
suffix:semicolon
id|REG
c_func
(paren
id|nseek
)paren
suffix:semicolon
multiline_comment|/* # tracks to seek */
id|REG
c_func
(paren
id|ctrack
)paren
suffix:semicolon
multiline_comment|/* current track number */
id|REG
c_func
(paren
id|csect
)paren
suffix:semicolon
multiline_comment|/* current sector number */
id|REG
c_func
(paren
id|gap3
)paren
suffix:semicolon
multiline_comment|/* size of gap 3 in track format */
id|REG
c_func
(paren
id|sector
)paren
suffix:semicolon
multiline_comment|/* sector # to read or write */
id|REG
c_func
(paren
id|nsect
)paren
suffix:semicolon
multiline_comment|/* # sectors to read or write */
id|REG
c_func
(paren
id|intr_enable
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|control_bic
mdefine_line|#define control_bic&t;control
DECL|macro|control_bis
mdefine_line|#define control_bis&t;status
multiline_comment|/* Bits in select register */
DECL|macro|CA_MASK
mdefine_line|#define CA_MASK&t;&t;7
DECL|macro|LSTRB
mdefine_line|#define LSTRB&t;&t;8
multiline_comment|/* Bits in control register */
DECL|macro|DO_SEEK
mdefine_line|#define DO_SEEK&t;&t;0x80
DECL|macro|FORMAT
mdefine_line|#define FORMAT&t;&t;0x40
DECL|macro|SELECT
mdefine_line|#define SELECT&t;&t;0x20
DECL|macro|WRITE_SECTORS
mdefine_line|#define WRITE_SECTORS&t;0x10
DECL|macro|DO_ACTION
mdefine_line|#define DO_ACTION&t;0x08
DECL|macro|DRIVE2_ENABLE
mdefine_line|#define DRIVE2_ENABLE&t;0x04
DECL|macro|DRIVE_ENABLE
mdefine_line|#define DRIVE_ENABLE&t;0x02
DECL|macro|INTR_ENABLE
mdefine_line|#define INTR_ENABLE&t;0x01
multiline_comment|/* Bits in status register */
DECL|macro|FIFO_1BYTE
mdefine_line|#define FIFO_1BYTE&t;0x80
DECL|macro|FIFO_2BYTE
mdefine_line|#define FIFO_2BYTE&t;0x40
DECL|macro|ERROR
mdefine_line|#define ERROR&t;&t;0x20
DECL|macro|DATA
mdefine_line|#define DATA&t;&t;0x08
DECL|macro|RDDATA
mdefine_line|#define RDDATA&t;&t;0x04
DECL|macro|INTR_PENDING
mdefine_line|#define INTR_PENDING&t;0x02
DECL|macro|MARK_BYTE
mdefine_line|#define MARK_BYTE&t;0x01
multiline_comment|/* Bits in intr and intr_enable registers */
DECL|macro|ERROR_INTR
mdefine_line|#define ERROR_INTR&t;0x20
DECL|macro|DATA_CHANGED
mdefine_line|#define DATA_CHANGED&t;0x10
DECL|macro|TRANSFER_DONE
mdefine_line|#define TRANSFER_DONE&t;0x08
DECL|macro|SEEN_SECTOR
mdefine_line|#define SEEN_SECTOR&t;0x04
DECL|macro|SEEK_DONE
mdefine_line|#define SEEK_DONE&t;0x02
DECL|macro|TIMER_DONE
mdefine_line|#define TIMER_DONE&t;0x01
multiline_comment|/* Bits in error register */
DECL|macro|ERR_DATA_CRC
mdefine_line|#define ERR_DATA_CRC&t;0x80
DECL|macro|ERR_ADDR_CRC
mdefine_line|#define ERR_ADDR_CRC&t;0x40
DECL|macro|ERR_OVERRUN
mdefine_line|#define ERR_OVERRUN&t;0x04
DECL|macro|ERR_UNDERRUN
mdefine_line|#define ERR_UNDERRUN&t;0x01
multiline_comment|/* Bits in setup register */
DECL|macro|S_SW_RESET
mdefine_line|#define S_SW_RESET&t;0x80
DECL|macro|S_GCR_WRITE
mdefine_line|#define S_GCR_WRITE&t;0x40
DECL|macro|S_IBM_DRIVE
mdefine_line|#define S_IBM_DRIVE&t;0x20
DECL|macro|S_TEST_MODE
mdefine_line|#define S_TEST_MODE&t;0x10
DECL|macro|S_FCLK_DIV2
mdefine_line|#define S_FCLK_DIV2&t;0x08
DECL|macro|S_GCR
mdefine_line|#define S_GCR&t;&t;0x04
DECL|macro|S_COPY_PROT
mdefine_line|#define S_COPY_PROT&t;0x02
DECL|macro|S_INV_WDATA
mdefine_line|#define S_INV_WDATA&t;0x01
multiline_comment|/* Select values for swim3_action */
DECL|macro|SEEK_POSITIVE
mdefine_line|#define SEEK_POSITIVE&t;0
DECL|macro|SEEK_NEGATIVE
mdefine_line|#define SEEK_NEGATIVE&t;4
DECL|macro|STEP
mdefine_line|#define STEP&t;&t;1
DECL|macro|MOTOR_ON
mdefine_line|#define MOTOR_ON&t;2
DECL|macro|MOTOR_OFF
mdefine_line|#define MOTOR_OFF&t;6
DECL|macro|INDEX
mdefine_line|#define INDEX&t;&t;3
DECL|macro|EJECT
mdefine_line|#define EJECT&t;&t;7
DECL|macro|SETMFM
mdefine_line|#define SETMFM&t;&t;9
DECL|macro|SETGCR
mdefine_line|#define SETGCR&t;&t;13
multiline_comment|/* Select values for swim3_select and swim3_readbit */
DECL|macro|STEP_DIR
mdefine_line|#define STEP_DIR&t;0
DECL|macro|STEPPING
mdefine_line|#define STEPPING&t;1
DECL|macro|MOTOR_ON
mdefine_line|#define MOTOR_ON&t;2
DECL|macro|RELAX
mdefine_line|#define RELAX&t;&t;3&t;/* also eject in progress */
DECL|macro|READ_DATA_0
mdefine_line|#define READ_DATA_0&t;4
DECL|macro|TWOMEG_DRIVE
mdefine_line|#define TWOMEG_DRIVE&t;5
DECL|macro|SINGLE_SIDED
mdefine_line|#define SINGLE_SIDED&t;6
DECL|macro|DRIVE_PRESENT
mdefine_line|#define DRIVE_PRESENT&t;7
DECL|macro|DISK_IN
mdefine_line|#define DISK_IN&t;&t;8
DECL|macro|WRITE_PROT
mdefine_line|#define WRITE_PROT&t;9
DECL|macro|TRACK_ZERO
mdefine_line|#define TRACK_ZERO&t;10
DECL|macro|TACHO
mdefine_line|#define TACHO&t;&t;11
DECL|macro|READ_DATA_1
mdefine_line|#define READ_DATA_1&t;12
DECL|macro|MFM_MODE
mdefine_line|#define MFM_MODE&t;13
DECL|macro|SEEK_COMPLETE
mdefine_line|#define SEEK_COMPLETE&t;14
DECL|macro|ONEMEG_MEDIA
mdefine_line|#define ONEMEG_MEDIA&t;15
multiline_comment|/* Definitions of values used in writing and formatting */
DECL|macro|DATA_ESCAPE
mdefine_line|#define DATA_ESCAPE&t;0x99
DECL|macro|GCR_SYNC_EXC
mdefine_line|#define GCR_SYNC_EXC&t;0x3f
DECL|macro|GCR_SYNC_CONV
mdefine_line|#define GCR_SYNC_CONV&t;0x80
DECL|macro|GCR_FIRST_MARK
mdefine_line|#define GCR_FIRST_MARK&t;0xd5
DECL|macro|GCR_SECOND_MARK
mdefine_line|#define GCR_SECOND_MARK&t;0xaa
DECL|macro|GCR_ADDR_MARK
mdefine_line|#define GCR_ADDR_MARK&t;&quot;&bslash;xd5&bslash;xaa&bslash;x00&quot;
DECL|macro|GCR_DATA_MARK
mdefine_line|#define GCR_DATA_MARK&t;&quot;&bslash;xd5&bslash;xaa&bslash;x0b&quot;
DECL|macro|GCR_SLIP_BYTE
mdefine_line|#define GCR_SLIP_BYTE&t;&quot;&bslash;x27&bslash;xaa&quot;
DECL|macro|GCR_SELF_SYNC
mdefine_line|#define GCR_SELF_SYNC&t;&quot;&bslash;x3f&bslash;xbf&bslash;x1e&bslash;x34&bslash;x3c&bslash;x3f&quot;
DECL|macro|DATA_99
mdefine_line|#define DATA_99&t;&t;&quot;&bslash;x99&bslash;x99&quot;
DECL|macro|MFM_ADDR_MARK
mdefine_line|#define MFM_ADDR_MARK&t;&quot;&bslash;x99&bslash;xa1&bslash;x99&bslash;xa1&bslash;x99&bslash;xa1&bslash;x99&bslash;xfe&quot;
DECL|macro|MFM_INDEX_MARK
mdefine_line|#define MFM_INDEX_MARK&t;&quot;&bslash;x99&bslash;xc2&bslash;x99&bslash;xc2&bslash;x99&bslash;xc2&bslash;x99&bslash;xfc&quot;
DECL|macro|MFM_GAP_LEN
mdefine_line|#define MFM_GAP_LEN&t;12
DECL|struct|floppy_state
r_struct
id|floppy_state
(brace
DECL|member|state
r_enum
id|swim_state
id|state
suffix:semicolon
DECL|member|swim3
r_volatile
r_struct
id|swim3
op_star
id|swim3
suffix:semicolon
multiline_comment|/* hardware registers */
DECL|member|dma
r_struct
id|dbdma_regs
op_star
id|dma
suffix:semicolon
multiline_comment|/* DMA controller registers */
DECL|member|swim3_intr
r_int
id|swim3_intr
suffix:semicolon
multiline_comment|/* interrupt number for SWIM3 */
DECL|member|dma_intr
r_int
id|dma_intr
suffix:semicolon
multiline_comment|/* interrupt number for DMA channel */
DECL|member|cur_cyl
r_int
id|cur_cyl
suffix:semicolon
multiline_comment|/* cylinder head is on, or -1 */
DECL|member|cur_sector
r_int
id|cur_sector
suffix:semicolon
multiline_comment|/* last sector we saw go past */
DECL|member|req_cyl
r_int
id|req_cyl
suffix:semicolon
multiline_comment|/* the cylinder for the current r/w request */
DECL|member|head
r_int
id|head
suffix:semicolon
multiline_comment|/* head number ditto */
DECL|member|req_sector
r_int
id|req_sector
suffix:semicolon
multiline_comment|/* sector number ditto */
DECL|member|scount
r_int
id|scount
suffix:semicolon
multiline_comment|/* # sectors we&squot;re transferring at present */
DECL|member|retries
r_int
id|retries
suffix:semicolon
DECL|member|secpercyl
r_int
id|secpercyl
suffix:semicolon
multiline_comment|/* disk geometry information */
DECL|member|secpertrack
r_int
id|secpertrack
suffix:semicolon
DECL|member|total_secs
r_int
id|total_secs
suffix:semicolon
DECL|member|write_prot
r_int
id|write_prot
suffix:semicolon
multiline_comment|/* 1 if write-protected, 0 if not, -1 dunno */
DECL|member|dma_cmd
r_struct
id|dbdma_cmd
op_star
id|dma_cmd
suffix:semicolon
DECL|member|ref_count
r_int
id|ref_count
suffix:semicolon
DECL|member|expect_cyl
r_int
id|expect_cyl
suffix:semicolon
DECL|member|timeout
r_struct
id|timer_list
id|timeout
suffix:semicolon
DECL|member|timeout_pending
r_int
id|timeout_pending
suffix:semicolon
DECL|member|ejected
r_int
id|ejected
suffix:semicolon
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|wanted
r_int
id|wanted
suffix:semicolon
DECL|member|media_bay
r_struct
id|device_node
op_star
id|media_bay
suffix:semicolon
multiline_comment|/* NULL when not in bay */
DECL|member|dbdma_cmd_space
r_char
id|dbdma_cmd_space
(braket
l_int|5
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|floppy_states
r_static
r_struct
id|floppy_state
id|floppy_states
(braket
id|MAX_FLOPPIES
)braket
suffix:semicolon
DECL|variable|floppy_count
r_static
r_int
id|floppy_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|write_preamble
r_static
r_int
r_int
id|write_preamble
(braket
)braket
op_assign
(brace
l_int|0x4e4e
comma
l_int|0x4e4e
comma
l_int|0x4e4e
comma
l_int|0x4e4e
comma
l_int|0x4e4e
comma
multiline_comment|/* gap field */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* sync field */
l_int|0x99a1
comma
l_int|0x99a1
comma
l_int|0x99a1
comma
l_int|0x99fb
comma
multiline_comment|/* data address mark */
l_int|0x990f
multiline_comment|/* no escape for 512 bytes */
)brace
suffix:semicolon
DECL|variable|write_postamble
r_static
r_int
r_int
id|write_postamble
(braket
)braket
op_assign
(brace
l_int|0x9904
comma
multiline_comment|/* insert CRC */
l_int|0x4e4e
comma
l_int|0x4e4e
comma
l_int|0x9908
comma
multiline_comment|/* stop writing */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_static
r_void
id|swim3_select
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|sel
)paren
suffix:semicolon
r_static
r_void
id|swim3_action
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|action
)paren
suffix:semicolon
r_static
r_int
id|swim3_readbit
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|bit
)paren
suffix:semicolon
r_static
r_void
id|do_fd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
suffix:semicolon
r_static
r_void
id|start_request
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
suffix:semicolon
r_static
r_void
id|set_timeout
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|nticks
comma
r_void
(paren
op_star
id|proc
)paren
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_static
r_void
id|scan_track
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
suffix:semicolon
r_static
r_void
id|seek_track
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|n
)paren
suffix:semicolon
r_static
r_void
id|init_dma
c_func
(paren
r_struct
id|dbdma_cmd
op_star
id|cp
comma
r_int
id|cmd
comma
r_void
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|setup_transfer
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
suffix:semicolon
r_static
r_void
id|act
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
suffix:semicolon
r_static
r_void
id|scan_timeout
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|seek_timeout
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|xfer_timeout
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|swim3_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
multiline_comment|/*static void fd_dma_interrupt(int irq, void *dev_id, struct pt_regs *regs);*/
r_static
r_int
id|grab_drive
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_enum
id|swim_state
id|state
comma
r_int
id|interruptible
)paren
suffix:semicolon
r_static
r_void
id|release_drive
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
suffix:semicolon
r_static
r_int
id|fd_eject
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
suffix:semicolon
r_static
r_int
id|floppy_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|param
)paren
suffix:semicolon
r_static
r_int
id|floppy_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|floppy_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|floppy_check_change
c_func
(paren
id|kdev_t
id|dev
)paren
suffix:semicolon
r_static
r_int
id|floppy_revalidate
c_func
(paren
id|kdev_t
id|dev
)paren
suffix:semicolon
r_static
r_int
id|swim3_add_device
c_func
(paren
r_struct
id|device_node
op_star
id|swims
)paren
suffix:semicolon
r_int
id|swim3_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_PMAC_PBOOK
DECL|function|check_media_bay
r_static
r_inline
r_int
id|check_media_bay
c_func
(paren
r_struct
id|device_node
op_star
id|which_bay
comma
r_int
id|what
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
DECL|function|swim3_select
r_static
r_void
id|swim3_select
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|sel
)paren
(brace
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|RELAX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sel
op_amp
l_int|8
)paren
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bis
comma
id|SELECT
)paren
suffix:semicolon
r_else
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
id|SELECT
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|sel
op_amp
id|CA_MASK
)paren
suffix:semicolon
)brace
DECL|function|swim3_action
r_static
r_void
id|swim3_action
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|action
)paren
(brace
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
id|swim3_select
c_func
(paren
id|fs
comma
id|action
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|sw-&gt;select
op_or
id|LSTRB
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|sw-&gt;select
op_amp
op_complement
id|LSTRB
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|RELAX
)paren
suffix:semicolon
)brace
DECL|function|swim3_readbit
r_static
r_int
id|swim3_readbit
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|bit
)paren
(brace
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
r_int
id|stat
suffix:semicolon
id|swim3_select
c_func
(paren
id|fs
comma
id|bit
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|stat
op_assign
id|in_8
c_func
(paren
op_amp
id|sw-&gt;status
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|RELAX
)paren
suffix:semicolon
r_return
(paren
id|stat
op_amp
id|DATA
)paren
op_eq
l_int|0
suffix:semicolon
)brace
DECL|function|do_fd_request
r_static
r_void
id|do_fd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|floppy_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|floppy_states
(braket
id|i
)braket
dot
id|media_bay
op_logical_and
id|check_media_bay
c_func
(paren
id|floppy_states
(braket
id|i
)braket
dot
id|media_bay
comma
id|MB_FD
)paren
)paren
r_continue
suffix:semicolon
id|start_request
c_func
(paren
op_amp
id|floppy_states
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|start_request
r_static
r_void
id|start_request
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
(brace
r_int
r_int
id|x
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;state
op_eq
id|idle
op_logical_and
id|fs-&gt;wanted
)paren
(brace
id|fs-&gt;state
op_assign
id|available
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|fs-&gt;wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|QUEUE_EMPTY
op_logical_and
id|fs-&gt;state
op_eq
id|idle
)paren
(brace
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
op_ne
id|MAJOR_NR
)paren
id|panic
c_func
(paren
id|DEVICE_NAME
l_string|&quot;: request list destroyed&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT-&gt;bh
op_logical_and
op_logical_neg
id|buffer_locked
c_func
(paren
id|CURRENT-&gt;bh
)paren
)paren
id|panic
c_func
(paren
id|DEVICE_NAME
l_string|&quot;: block not locked&quot;
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;do_fd_req: dev=%x cmd=%d sec=%ld nr_sec=%ld buf=%p&bslash;n&quot;
comma
id|kdev_t_to_nr
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
comma
id|CURRENT-&gt;cmd
comma
id|CURRENT-&gt;sector
comma
id|CURRENT-&gt;nr_sectors
comma
id|CURRENT-&gt;buffer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;           rq_status=%d errors=%d current_nr_sectors=%ld&bslash;n&quot;
comma
id|CURRENT-&gt;rq_status
comma
id|CURRENT-&gt;errors
comma
id|CURRENT-&gt;current_nr_sectors
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|CURRENT-&gt;sector
OL
l_int|0
op_logical_or
id|CURRENT-&gt;sector
op_ge
id|fs-&gt;total_secs
)paren
(brace
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CURRENT-&gt;current_nr_sectors
op_eq
l_int|0
)paren
(brace
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fs-&gt;ejected
)paren
(brace
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CURRENT-&gt;cmd
op_eq
id|WRITE
)paren
(brace
r_if
c_cond
(paren
id|fs-&gt;write_prot
OL
l_int|0
)paren
id|fs-&gt;write_prot
op_assign
id|swim3_readbit
c_func
(paren
id|fs
comma
id|WRITE_PROT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;write_prot
)paren
(brace
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
id|fs-&gt;req_cyl
op_assign
id|CURRENT-&gt;sector
op_div
id|fs-&gt;secpercyl
suffix:semicolon
id|x
op_assign
id|CURRENT-&gt;sector
op_mod
id|fs-&gt;secpercyl
suffix:semicolon
id|fs-&gt;head
op_assign
id|x
op_div
id|fs-&gt;secpertrack
suffix:semicolon
id|fs-&gt;req_sector
op_assign
id|x
op_mod
id|fs-&gt;secpertrack
op_plus
l_int|1
suffix:semicolon
id|fs-&gt;state
op_assign
id|do_transfer
suffix:semicolon
id|fs-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|act
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
)brace
DECL|function|set_timeout
r_static
r_void
id|set_timeout
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|nticks
comma
r_void
(paren
op_star
id|proc
)paren
(paren
r_int
r_int
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;timeout_pending
)paren
id|del_timer
c_func
(paren
op_amp
id|fs-&gt;timeout
)paren
suffix:semicolon
id|fs-&gt;timeout.expires
op_assign
id|jiffies
op_plus
id|nticks
suffix:semicolon
id|fs-&gt;timeout.function
op_assign
id|proc
suffix:semicolon
id|fs-&gt;timeout.data
op_assign
(paren
r_int
r_int
)paren
id|fs
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|fs-&gt;timeout
)paren
suffix:semicolon
id|fs-&gt;timeout_pending
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|scan_track
r_static
r_inline
r_void
id|scan_track
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
(brace
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
r_int
id|xx
suffix:semicolon
id|swim3_select
c_func
(paren
id|fs
comma
id|READ_DATA_0
)paren
suffix:semicolon
id|xx
op_assign
id|sw-&gt;intr
suffix:semicolon
multiline_comment|/* clear SEEN_SECTOR bit */
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bis
comma
id|DO_ACTION
)paren
suffix:semicolon
multiline_comment|/* enable intr when track found */
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
id|ERROR_INTR
op_or
id|SEEN_SECTOR
)paren
suffix:semicolon
id|set_timeout
c_func
(paren
id|fs
comma
id|HZ
comma
id|scan_timeout
)paren
suffix:semicolon
multiline_comment|/* enable timeout */
)brace
DECL|function|seek_track
r_static
r_inline
r_void
id|seek_track
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_int
id|n
)paren
(brace
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ge
l_int|0
)paren
(brace
id|swim3_action
c_func
(paren
id|fs
comma
id|SEEK_POSITIVE
)paren
suffix:semicolon
id|sw-&gt;nseek
op_assign
id|n
suffix:semicolon
)brace
r_else
(brace
id|swim3_action
c_func
(paren
id|fs
comma
id|SEEK_NEGATIVE
)paren
suffix:semicolon
id|sw-&gt;nseek
op_assign
op_minus
id|n
suffix:semicolon
)brace
id|fs-&gt;expect_cyl
op_assign
(paren
id|fs-&gt;cur_cyl
OG
l_int|0
)paren
ques
c_cond
id|fs-&gt;cur_cyl
op_plus
id|n
suffix:colon
op_minus
l_int|1
suffix:semicolon
id|swim3_select
c_func
(paren
id|fs
comma
id|STEP
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bis
comma
id|DO_SEEK
)paren
suffix:semicolon
multiline_comment|/* enable intr when seek finished */
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
id|ERROR_INTR
op_or
id|SEEK_DONE
)paren
suffix:semicolon
id|set_timeout
c_func
(paren
id|fs
comma
id|HZ
op_div
l_int|2
comma
id|seek_timeout
)paren
suffix:semicolon
multiline_comment|/* enable timeout */
)brace
DECL|function|init_dma
r_static
r_inline
r_void
id|init_dma
c_func
(paren
r_struct
id|dbdma_cmd
op_star
id|cp
comma
r_int
id|cmd
comma
r_void
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;req_count
comma
id|count
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|cmd
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|cp-&gt;phy_addr
comma
id|virt_to_bus
c_func
(paren
id|buf
)paren
)paren
suffix:semicolon
id|cp-&gt;xfer_status
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|setup_transfer
r_static
r_inline
r_void
id|setup_transfer
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
(brace
r_int
id|n
suffix:semicolon
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
r_struct
id|dbdma_cmd
op_star
id|cp
op_assign
id|fs-&gt;dma_cmd
suffix:semicolon
r_struct
id|dbdma_regs
op_star
id|dr
op_assign
id|fs-&gt;dma
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT-&gt;current_nr_sectors
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3: transfer 0 sectors?&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CURRENT-&gt;cmd
op_eq
id|WRITE
)paren
id|n
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|n
op_assign
id|fs-&gt;secpertrack
op_minus
id|fs-&gt;req_sector
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|CURRENT-&gt;current_nr_sectors
)paren
id|n
op_assign
id|CURRENT-&gt;current_nr_sectors
suffix:semicolon
)brace
id|fs-&gt;scount
op_assign
id|n
suffix:semicolon
id|swim3_select
c_func
(paren
id|fs
comma
id|fs-&gt;head
ques
c_cond
id|READ_DATA_1
suffix:colon
id|READ_DATA_0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;sector
comma
id|fs-&gt;req_sector
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;nsect
comma
id|n
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;gap3
comma
l_int|0
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dr-&gt;cmdptr
comma
id|virt_to_bus
c_func
(paren
id|cp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT-&gt;cmd
op_eq
id|WRITE
)paren
(brace
multiline_comment|/* Set up 3 dma commands: write preamble, data, postamble */
id|init_dma
c_func
(paren
id|cp
comma
id|OUTPUT_MORE
comma
id|write_preamble
comma
r_sizeof
(paren
id|write_preamble
)paren
)paren
suffix:semicolon
op_increment
id|cp
suffix:semicolon
id|init_dma
c_func
(paren
id|cp
comma
id|OUTPUT_MORE
comma
id|CURRENT-&gt;buffer
comma
l_int|512
)paren
suffix:semicolon
op_increment
id|cp
suffix:semicolon
id|init_dma
c_func
(paren
id|cp
comma
id|OUTPUT_MORE
comma
id|write_postamble
comma
r_sizeof
(paren
id|write_postamble
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|init_dma
c_func
(paren
id|cp
comma
id|INPUT_MORE
comma
id|CURRENT-&gt;buffer
comma
id|n
op_star
l_int|512
)paren
suffix:semicolon
)brace
op_increment
id|cp
suffix:semicolon
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|dr-&gt;control
comma
(paren
id|RUN
op_lshift
l_int|16
)paren
op_or
id|RUN
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bis
comma
(paren
id|CURRENT-&gt;cmd
op_eq
id|WRITE
ques
c_cond
id|WRITE_SECTORS
suffix:colon
l_int|0
)paren
op_or
id|DO_ACTION
)paren
suffix:semicolon
multiline_comment|/* enable intr when transfer complete */
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
id|ERROR_INTR
op_or
id|TRANSFER_DONE
)paren
suffix:semicolon
id|set_timeout
c_func
(paren
id|fs
comma
l_int|2
op_star
id|HZ
comma
id|xfer_timeout
)paren
suffix:semicolon
multiline_comment|/* enable timeout */
)brace
DECL|function|act
r_static
r_void
id|act
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
(brace
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_switch
c_cond
(paren
id|fs-&gt;state
)paren
(brace
r_case
id|idle
suffix:colon
r_return
suffix:semicolon
multiline_comment|/* XXX shouldn&squot;t get here */
r_case
id|locating
suffix:colon
r_if
c_cond
(paren
id|swim3_readbit
c_func
(paren
id|fs
comma
id|TRACK_ZERO
)paren
)paren
(brace
id|fs-&gt;cur_cyl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;req_cyl
op_eq
l_int|0
)paren
id|fs-&gt;state
op_assign
id|do_transfer
suffix:semicolon
r_else
id|fs-&gt;state
op_assign
id|seeking
suffix:semicolon
r_break
suffix:semicolon
)brace
id|scan_track
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|seeking
suffix:colon
r_if
c_cond
(paren
id|fs-&gt;cur_cyl
OL
l_int|0
)paren
(brace
id|fs-&gt;expect_cyl
op_assign
op_minus
l_int|1
suffix:semicolon
id|fs-&gt;state
op_assign
id|locating
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fs-&gt;req_cyl
op_eq
id|fs-&gt;cur_cyl
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;whoops, seeking 0&bslash;n&quot;
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|do_transfer
suffix:semicolon
r_break
suffix:semicolon
)brace
id|seek_track
c_func
(paren
id|fs
comma
id|fs-&gt;req_cyl
op_minus
id|fs-&gt;cur_cyl
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|settling
suffix:colon
multiline_comment|/* wait for SEEK_COMPLETE to become true */
id|swim3_select
c_func
(paren
id|fs
comma
id|SEEK_COMPLETE
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
id|ERROR_INTR
op_or
id|DATA_CHANGED
)paren
suffix:semicolon
id|in_8
c_func
(paren
op_amp
id|sw-&gt;intr
)paren
suffix:semicolon
multiline_comment|/* clear DATA_CHANGED */
r_if
c_cond
(paren
id|in_8
c_func
(paren
op_amp
id|sw-&gt;status
)paren
op_amp
id|DATA
)paren
(brace
multiline_comment|/* seek_complete is not yet true */
id|set_timeout
c_func
(paren
id|fs
comma
id|HZ
op_div
l_int|2
comma
id|seek_timeout
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
id|in_8
c_func
(paren
op_amp
id|sw-&gt;intr
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|locating
suffix:semicolon
r_break
suffix:semicolon
r_case
id|do_transfer
suffix:colon
r_if
c_cond
(paren
id|fs-&gt;cur_cyl
op_ne
id|fs-&gt;req_cyl
)paren
(brace
r_if
c_cond
(paren
id|fs-&gt;retries
OG
l_int|5
)paren
(brace
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
r_return
suffix:semicolon
)brace
id|fs-&gt;state
op_assign
id|seeking
suffix:semicolon
r_break
suffix:semicolon
)brace
id|setup_transfer
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|jogging
suffix:colon
id|seek_track
c_func
(paren
id|fs
comma
op_minus
l_int|5
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3: unknown state %d&bslash;n&quot;
comma
id|fs-&gt;state
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
DECL|function|scan_timeout
r_static
r_void
id|scan_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|floppy_state
op_star
id|fs
op_assign
(paren
r_struct
id|floppy_state
op_star
)paren
id|data
suffix:semicolon
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
id|fs-&gt;timeout_pending
op_assign
l_int|0
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
id|DO_ACTION
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|RELAX
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
id|fs-&gt;cur_cyl
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;retries
OG
l_int|5
)paren
(brace
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
id|start_request
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
r_else
(brace
id|fs-&gt;state
op_assign
id|jogging
suffix:semicolon
id|act
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
)brace
DECL|function|seek_timeout
r_static
r_void
id|seek_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|floppy_state
op_star
id|fs
op_assign
(paren
r_struct
id|floppy_state
op_star
)paren
id|data
suffix:semicolon
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
id|fs-&gt;timeout_pending
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;state
op_eq
id|settling
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3: MSI sel=%x ctrl=%x stat=%x intr=%x ie=%x&bslash;n&quot;
comma
id|sw-&gt;select
comma
id|sw-&gt;control
comma
id|sw-&gt;status
comma
id|sw-&gt;intr
comma
id|sw-&gt;intr_enable
)paren
suffix:semicolon
)brace
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
id|DO_SEEK
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|RELAX
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;state
op_eq
id|settling
op_logical_and
id|swim3_readbit
c_func
(paren
id|fs
comma
id|SEEK_COMPLETE
)paren
)paren
(brace
multiline_comment|/* printk(KERN_DEBUG &quot;swim3: missed settling interrupt&bslash;n&quot;); */
id|fs-&gt;state
op_assign
id|locating
suffix:semicolon
id|act
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3: seek timeout&bslash;n&quot;
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
id|start_request
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
DECL|function|xfer_timeout
r_static
r_void
id|xfer_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|floppy_state
op_star
id|fs
op_assign
(paren
r_struct
id|floppy_state
op_star
)paren
id|data
suffix:semicolon
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
r_struct
id|dbdma_regs
op_star
id|dr
op_assign
id|fs-&gt;dma
suffix:semicolon
r_struct
id|dbdma_cmd
op_star
id|cp
op_assign
id|fs-&gt;dma_cmd
suffix:semicolon
r_int
r_int
id|s
suffix:semicolon
id|fs-&gt;timeout_pending
op_assign
l_int|0
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dr-&gt;control
comma
id|RUN
op_lshift
l_int|16
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
id|WRITE_SECTORS
op_or
id|DO_ACTION
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|RELAX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT-&gt;cmd
op_eq
id|WRITE
)paren
op_increment
id|cp
suffix:semicolon
r_if
c_cond
(paren
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
)paren
op_ne
l_int|0
)paren
id|s
op_assign
id|fs-&gt;scount
op_minus
(paren
(paren
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;res_count
)paren
op_plus
l_int|511
)paren
op_rshift
l_int|9
)paren
suffix:semicolon
r_else
id|s
op_assign
l_int|0
suffix:semicolon
id|CURRENT-&gt;sector
op_add_assign
id|s
suffix:semicolon
id|CURRENT-&gt;current_nr_sectors
op_sub_assign
id|s
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3: timeout %sing sector %ld&bslash;n&quot;
comma
(paren
id|CURRENT-&gt;cmd
op_eq
id|WRITE
ques
c_cond
l_string|&quot;writ&quot;
suffix:colon
l_string|&quot;read&quot;
)paren
comma
id|CURRENT-&gt;sector
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
id|start_request
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
DECL|function|swim3_interrupt
r_static
r_void
id|swim3_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|floppy_state
op_star
id|fs
op_assign
(paren
r_struct
id|floppy_state
op_star
)paren
id|dev_id
suffix:semicolon
r_volatile
r_struct
id|swim3
op_star
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
r_int
id|intr
comma
id|err
comma
id|n
suffix:semicolon
r_int
id|stat
comma
id|resid
suffix:semicolon
r_struct
id|dbdma_regs
op_star
id|dr
suffix:semicolon
r_struct
id|dbdma_cmd
op_star
id|cp
suffix:semicolon
id|err
op_assign
id|in_8
c_func
(paren
op_amp
id|sw-&gt;error
)paren
suffix:semicolon
id|intr
op_assign
id|in_8
c_func
(paren
op_amp
id|sw-&gt;intr
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;swim3 intr state=%d intr=%x err=%x&bslash;n&quot;
comma
id|fs-&gt;state
comma
id|intr
comma
id|err
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|intr
op_amp
id|ERROR_INTR
)paren
op_logical_and
id|fs-&gt;state
op_ne
id|do_transfer
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3_interrupt, state=%d, cmd=%x, intr=%x, err=%x&bslash;n&quot;
comma
id|fs-&gt;state
comma
id|CURRENT-&gt;cmd
comma
id|intr
comma
id|err
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fs-&gt;state
)paren
(brace
r_case
id|locating
suffix:colon
r_if
c_cond
(paren
id|intr
op_amp
id|SEEN_SECTOR
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
id|DO_ACTION
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|RELAX
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|fs-&gt;timeout
)paren
suffix:semicolon
id|fs-&gt;timeout_pending
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sw-&gt;ctrack
op_eq
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3: seen sector but cyl=ff?&bslash;n&quot;
)paren
suffix:semicolon
id|fs-&gt;cur_cyl
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;retries
OG
l_int|5
)paren
(brace
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
id|start_request
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
r_else
(brace
id|fs-&gt;state
op_assign
id|jogging
suffix:semicolon
id|act
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|fs-&gt;cur_cyl
op_assign
id|sw-&gt;ctrack
suffix:semicolon
id|fs-&gt;cur_sector
op_assign
id|sw-&gt;csect
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;expect_cyl
op_ne
op_minus
l_int|1
op_logical_and
id|fs-&gt;expect_cyl
op_ne
id|fs-&gt;cur_cyl
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3: expected cyl %d, got %d&bslash;n&quot;
comma
id|fs-&gt;expect_cyl
comma
id|fs-&gt;cur_cyl
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|do_transfer
suffix:semicolon
id|act
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|seeking
suffix:colon
r_case
id|jogging
suffix:colon
r_if
c_cond
(paren
id|sw-&gt;nseek
op_eq
l_int|0
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
id|DO_SEEK
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|RELAX
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|fs-&gt;timeout
)paren
suffix:semicolon
id|fs-&gt;timeout_pending
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;state
op_eq
id|seeking
)paren
op_increment
id|fs-&gt;retries
suffix:semicolon
id|fs-&gt;state
op_assign
id|settling
suffix:semicolon
id|act
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|settling
suffix:colon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|fs-&gt;timeout
)paren
suffix:semicolon
id|fs-&gt;timeout_pending
op_assign
l_int|0
suffix:semicolon
id|act
c_func
(paren
id|fs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|do_transfer
suffix:colon
r_if
c_cond
(paren
(paren
id|intr
op_amp
(paren
id|ERROR_INTR
op_or
id|TRANSFER_DONE
)paren
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|dr
op_assign
id|fs-&gt;dma
suffix:semicolon
id|cp
op_assign
id|fs-&gt;dma_cmd
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|dr-&gt;control
comma
id|RUN
op_lshift
l_int|16
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
id|WRITE_SECTORS
op_or
id|DO_ACTION
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;select
comma
id|RELAX
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|fs-&gt;timeout
)paren
suffix:semicolon
id|fs-&gt;timeout_pending
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT-&gt;cmd
op_eq
id|WRITE
)paren
op_increment
id|cp
suffix:semicolon
id|stat
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
id|resid
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;res_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_amp
id|ERROR_INTR
)paren
(brace
id|n
op_assign
id|fs-&gt;scount
op_minus
l_int|1
op_minus
id|resid
op_div
l_int|512
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|0
)paren
(brace
id|CURRENT-&gt;sector
op_add_assign
id|n
suffix:semicolon
id|CURRENT-&gt;current_nr_sectors
op_sub_assign
id|n
suffix:semicolon
id|CURRENT-&gt;buffer
op_add_assign
id|n
op_star
l_int|512
suffix:semicolon
id|fs-&gt;req_sector
op_add_assign
id|n
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fs-&gt;retries
OL
l_int|5
)paren
(brace
op_increment
id|fs-&gt;retries
suffix:semicolon
id|act
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;swim3: error %sing block %ld (err=%x)&bslash;n&quot;
comma
id|CURRENT-&gt;cmd
op_eq
id|WRITE
ques
c_cond
l_string|&quot;writ&quot;
suffix:colon
l_string|&quot;read&quot;
comma
id|CURRENT-&gt;sector
comma
id|err
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|stat
op_amp
id|ACTIVE
)paren
op_eq
l_int|0
op_logical_or
id|resid
op_ne
l_int|0
)paren
(brace
multiline_comment|/* musta been an error */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3: fd dma: stat=%x resid=%d&bslash;n&quot;
comma
id|stat
comma
id|resid
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;  state=%d, cmd=%x, intr=%x, err=%x&bslash;n&quot;
comma
id|fs-&gt;state
comma
id|CURRENT-&gt;cmd
comma
id|intr
comma
id|err
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
id|start_request
c_func
(paren
id|fs
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|CURRENT-&gt;sector
op_add_assign
id|fs-&gt;scount
suffix:semicolon
id|CURRENT-&gt;current_nr_sectors
op_sub_assign
id|fs-&gt;scount
suffix:semicolon
id|CURRENT-&gt;buffer
op_add_assign
id|fs-&gt;scount
op_star
l_int|512
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT-&gt;current_nr_sectors
op_le
l_int|0
)paren
(brace
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
)brace
r_else
(brace
id|fs-&gt;req_sector
op_add_assign
id|fs-&gt;scount
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;req_sector
OG
id|fs-&gt;secpertrack
)paren
(brace
id|fs-&gt;req_sector
op_sub_assign
id|fs-&gt;secpertrack
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|fs-&gt;head
OG
l_int|1
)paren
(brace
id|fs-&gt;head
op_assign
l_int|0
suffix:semicolon
op_increment
id|fs-&gt;req_cyl
suffix:semicolon
)brace
)brace
id|act
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|fs-&gt;state
op_eq
id|idle
)paren
id|start_request
c_func
(paren
id|fs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;swim3: don&squot;t know what to do in state %d&bslash;n&quot;
comma
id|fs-&gt;state
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;static void fd_dma_interrupt(int irq, void *dev_id, struct pt_regs *regs)&n;{&n;}&n;*/
DECL|function|grab_drive
r_static
r_int
id|grab_drive
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
comma
r_enum
id|swim_state
id|state
comma
r_int
id|interruptible
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;state
op_ne
id|idle
)paren
(brace
op_increment
id|fs-&gt;wanted
suffix:semicolon
r_while
c_loop
(paren
id|fs-&gt;state
op_ne
id|available
)paren
(brace
r_if
c_cond
(paren
id|interruptible
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
op_decrement
id|fs-&gt;wanted
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|fs-&gt;wait
)paren
suffix:semicolon
)brace
op_decrement
id|fs-&gt;wanted
suffix:semicolon
)brace
id|fs-&gt;state
op_assign
id|state
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|release_drive
r_static
r_void
id|release_drive
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
id|start_request
c_func
(paren
id|fs
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|fd_eject
r_static
r_int
id|fd_eject
c_func
(paren
r_struct
id|floppy_state
op_star
id|fs
)paren
(brace
r_int
id|err
comma
id|n
suffix:semicolon
id|err
op_assign
id|grab_drive
c_func
(paren
id|fs
comma
id|ejecting
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|swim3_action
c_func
(paren
id|fs
comma
id|EJECT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|2
op_star
id|HZ
suffix:semicolon
id|n
OG
l_int|0
suffix:semicolon
op_decrement
id|n
)paren
(brace
r_if
c_cond
(paren
id|swim3_readbit
c_func
(paren
id|fs
comma
id|RELAX
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|fs-&gt;ejected
op_assign
l_int|1
suffix:semicolon
id|release_drive
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|swim3_fd_eject
r_int
id|swim3_fd_eject
c_func
(paren
r_int
id|devnum
)paren
(brace
r_if
c_cond
(paren
id|devnum
op_ge
id|floppy_count
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Do not check this - this function should ONLY be called early&n;&t; * in the boot process! */
multiline_comment|/* if (floppy_states[devnum].ref_count != 1) return -EBUSY; */
r_return
id|fd_eject
c_func
(paren
op_amp
id|floppy_states
(braket
id|devnum
)braket
)paren
suffix:semicolon
)brace
DECL|variable|floppy_type
r_static
r_struct
id|floppy_struct
id|floppy_type
op_assign
(brace
l_int|2880
comma
l_int|18
comma
l_int|2
comma
l_int|80
comma
l_int|0
comma
l_int|0x1B
comma
l_int|0x00
comma
l_int|0xCF
comma
l_int|0x6C
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*  7 1.44MB 3.5&quot;   */
DECL|function|floppy_ioctl
r_static
r_int
id|floppy_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|param
)paren
(brace
r_struct
id|floppy_state
op_star
id|fs
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|devnum
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devnum
op_ge
id|floppy_count
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_amp
l_int|0x80
)paren
op_logical_and
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|fs
op_assign
op_amp
id|floppy_states
(braket
id|devnum
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;media_bay
op_logical_and
id|check_media_bay
c_func
(paren
id|fs-&gt;media_bay
comma
id|MB_FD
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|FDEJECT
suffix:colon
r_if
c_cond
(paren
id|fs-&gt;ref_count
op_ne
l_int|1
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|err
op_assign
id|fd_eject
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
r_case
id|FDGETPRM
suffix:colon
id|err
op_assign
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|param
comma
(paren
r_void
op_star
)paren
op_amp
id|floppy_type
comma
r_sizeof
(paren
r_struct
id|floppy_struct
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|function|floppy_open
r_static
r_int
id|floppy_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|floppy_state
op_star
id|fs
suffix:semicolon
r_volatile
r_struct
id|swim3
op_star
id|sw
suffix:semicolon
r_int
id|n
comma
id|err
suffix:semicolon
r_int
id|devnum
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devnum
op_ge
id|floppy_count
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|filp
op_eq
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|fs
op_assign
op_amp
id|floppy_states
(braket
id|devnum
)braket
suffix:semicolon
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;ref_count
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|fs-&gt;media_bay
op_logical_and
id|check_media_bay
c_func
(paren
id|fs-&gt;media_bay
comma
id|MB_FD
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;mode
comma
l_int|0x95
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
l_int|0xff
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;setup
comma
id|S_IBM_DRIVE
op_or
id|S_FCLK_DIV2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bis
comma
id|DRIVE_ENABLE
op_or
id|INTR_ENABLE
)paren
suffix:semicolon
id|swim3_action
c_func
(paren
id|fs
comma
id|MOTOR_ON
)paren
suffix:semicolon
id|fs-&gt;write_prot
op_assign
op_minus
l_int|1
suffix:semicolon
id|fs-&gt;cur_cyl
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
id|HZ
suffix:semicolon
id|n
OG
l_int|0
suffix:semicolon
op_decrement
id|n
)paren
(brace
r_if
c_cond
(paren
id|swim3_readbit
c_func
(paren
id|fs
comma
id|SEEK_COMPLETE
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_and
(paren
id|swim3_readbit
c_func
(paren
id|fs
comma
id|SEEK_COMPLETE
)paren
op_eq
l_int|0
op_logical_or
id|swim3_readbit
c_func
(paren
id|fs
comma
id|DISK_IN
)paren
op_eq
l_int|0
)paren
)paren
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|swim3_action
c_func
(paren
id|fs
comma
l_int|9
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fs-&gt;ref_count
op_eq
op_minus
l_int|1
op_logical_or
id|filp-&gt;f_flags
op_amp
id|O_EXCL
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_and
(paren
id|filp-&gt;f_flags
op_amp
id|O_NDELAY
)paren
op_eq
l_int|0
op_logical_and
(paren
id|filp-&gt;f_mode
op_amp
l_int|3
)paren
)paren
(brace
id|check_disk_change
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;ejected
)paren
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_eq
l_int|0
op_logical_and
(paren
id|filp-&gt;f_mode
op_amp
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
id|fs-&gt;write_prot
OL
l_int|0
)paren
id|fs-&gt;write_prot
op_assign
id|swim3_readbit
c_func
(paren
id|fs
comma
id|WRITE_PROT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;write_prot
)paren
id|err
op_assign
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|fs-&gt;ref_count
op_eq
l_int|0
)paren
(brace
id|swim3_action
c_func
(paren
id|fs
comma
id|MOTOR_OFF
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
id|DRIVE_ENABLE
op_or
id|INTR_ENABLE
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_EXCL
)paren
id|fs-&gt;ref_count
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
op_increment
id|fs-&gt;ref_count
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|floppy_release
r_static
r_int
id|floppy_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|floppy_state
op_star
id|fs
suffix:semicolon
r_volatile
r_struct
id|swim3
op_star
id|sw
suffix:semicolon
r_int
id|devnum
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devnum
op_ge
id|floppy_count
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|fs
op_assign
op_amp
id|floppy_states
(braket
id|devnum
)braket
suffix:semicolon
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;ref_count
OG
l_int|0
op_logical_and
op_decrement
id|fs-&gt;ref_count
op_eq
l_int|0
)paren
(brace
id|swim3_action
c_func
(paren
id|fs
comma
id|MOTOR_OFF
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bic
comma
l_int|0xff
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|floppy_check_change
r_static
r_int
id|floppy_check_change
c_func
(paren
id|kdev_t
id|dev
)paren
(brace
r_struct
id|floppy_state
op_star
id|fs
suffix:semicolon
r_int
id|devnum
op_assign
id|MINOR
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|dev
)paren
op_ne
id|MAJOR_NR
op_logical_or
(paren
id|devnum
op_ge
id|floppy_count
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|fs
op_assign
op_amp
id|floppy_states
(braket
id|devnum
)braket
suffix:semicolon
r_return
id|fs-&gt;ejected
suffix:semicolon
)brace
DECL|function|floppy_revalidate
r_static
r_int
id|floppy_revalidate
c_func
(paren
id|kdev_t
id|dev
)paren
(brace
r_struct
id|floppy_state
op_star
id|fs
suffix:semicolon
r_volatile
r_struct
id|swim3
op_star
id|sw
suffix:semicolon
r_int
id|ret
comma
id|n
suffix:semicolon
r_int
id|devnum
op_assign
id|MINOR
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|dev
)paren
op_ne
id|MAJOR_NR
op_logical_or
(paren
id|devnum
op_ge
id|floppy_count
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|fs
op_assign
op_amp
id|floppy_states
(braket
id|devnum
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fs-&gt;media_bay
op_logical_and
id|check_media_bay
c_func
(paren
id|fs-&gt;media_bay
comma
id|MB_FD
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|sw
op_assign
id|fs-&gt;swim3
suffix:semicolon
id|grab_drive
c_func
(paren
id|fs
comma
id|revalidating
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;intr_enable
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|sw-&gt;control_bis
comma
id|DRIVE_ENABLE
op_or
id|INTR_ENABLE
)paren
suffix:semicolon
id|swim3_action
c_func
(paren
id|fs
comma
id|MOTOR_ON
)paren
suffix:semicolon
id|fs-&gt;write_prot
op_assign
op_minus
l_int|1
suffix:semicolon
id|fs-&gt;cur_cyl
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
id|HZ
suffix:semicolon
id|n
OG
l_int|0
suffix:semicolon
op_decrement
id|n
)paren
(brace
r_if
c_cond
(paren
id|swim3_readbit
c_func
(paren
id|fs
comma
id|SEEK_COMPLETE
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|swim3_readbit
c_func
(paren
id|fs
comma
id|SEEK_COMPLETE
)paren
op_eq
l_int|0
op_logical_or
id|swim3_readbit
c_func
(paren
id|fs
comma
id|DISK_IN
)paren
op_eq
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|swim3_action
c_func
(paren
id|fs
comma
id|MOTOR_OFF
)paren
suffix:semicolon
r_else
(brace
id|fs-&gt;ejected
op_assign
l_int|0
suffix:semicolon
id|swim3_action
c_func
(paren
id|fs
comma
l_int|9
)paren
suffix:semicolon
)brace
id|release_drive
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|floppy_off
r_static
r_void
id|floppy_off
c_func
(paren
r_int
r_int
id|nr
)paren
(brace
)brace
DECL|variable|floppy_fops
r_static
r_struct
id|block_device_operations
id|floppy_fops
op_assign
(brace
id|open
suffix:colon
id|floppy_open
comma
id|release
suffix:colon
id|floppy_release
comma
id|ioctl
suffix:colon
id|floppy_ioctl
comma
id|check_media_change
suffix:colon
id|floppy_check_change
comma
id|revalidate
suffix:colon
id|floppy_revalidate
comma
)brace
suffix:semicolon
DECL|function|swim3_init
r_int
id|swim3_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|swim
suffix:semicolon
id|swim
op_assign
id|find_devices
c_func
(paren
l_string|&quot;floppy&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|swim
op_logical_and
(paren
id|floppy_count
OL
id|MAX_FLOPPIES
)paren
)paren
(brace
id|swim3_add_device
c_func
(paren
id|swim
)paren
suffix:semicolon
id|swim
op_assign
id|swim-&gt;next
suffix:semicolon
)brace
id|swim
op_assign
id|find_devices
c_func
(paren
l_string|&quot;swim3&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|swim
op_logical_and
(paren
id|floppy_count
OL
id|MAX_FLOPPIES
)paren
)paren
(brace
id|swim3_add_device
c_func
(paren
id|swim
)paren
suffix:semicolon
id|swim
op_assign
id|swim-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|floppy_count
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;fd&quot;
comma
op_amp
id|floppy_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to get major %d for floppy&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|blk_init_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|DEVICE_REQUEST
)paren
suffix:semicolon
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|floppy_blocksizes
suffix:semicolon
id|blk_size
(braket
id|MAJOR_NR
)braket
op_assign
id|floppy_sizes
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|swim3_add_device
r_static
r_int
id|swim3_add_device
c_func
(paren
r_struct
id|device_node
op_star
id|swim
)paren
(brace
r_struct
id|device_node
op_star
id|mediabay
suffix:semicolon
r_struct
id|floppy_state
op_star
id|fs
op_assign
op_amp
id|floppy_states
(braket
id|floppy_count
)braket
suffix:semicolon
r_if
c_cond
(paren
id|swim-&gt;n_addrs
OL
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;swim3: expecting 2 addrs (n_addrs:%d, n_intrs:%d)&bslash;n&quot;
comma
id|swim-&gt;n_addrs
comma
id|swim-&gt;n_intrs
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|swim-&gt;n_intrs
OL
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;swim3: expecting 2 intrs (n_addrs:%d, n_intrs:%d)&bslash;n&quot;
comma
id|swim-&gt;n_addrs
comma
id|swim-&gt;n_intrs
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|mediabay
op_assign
(paren
id|strcasecmp
c_func
(paren
id|swim-&gt;parent-&gt;type
comma
l_string|&quot;media-bay&quot;
)paren
op_eq
l_int|0
)paren
ques
c_cond
id|swim-&gt;parent
suffix:colon
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|mediabay
op_eq
l_int|NULL
)paren
id|feature_set
c_func
(paren
id|swim
comma
id|FEATURE_SWIM3_enable
)paren
suffix:semicolon
id|memset
c_func
(paren
id|fs
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|fs
)paren
)paren
suffix:semicolon
id|fs-&gt;state
op_assign
id|idle
suffix:semicolon
id|fs-&gt;swim3
op_assign
(paren
r_volatile
r_struct
id|swim3
op_star
)paren
id|ioremap
c_func
(paren
id|swim-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x200
)paren
suffix:semicolon
id|fs-&gt;dma
op_assign
(paren
r_struct
id|dbdma_regs
op_star
)paren
id|ioremap
c_func
(paren
id|swim-&gt;addrs
(braket
l_int|1
)braket
dot
id|address
comma
l_int|0x200
)paren
suffix:semicolon
id|fs-&gt;swim3_intr
op_assign
id|swim-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
id|fs-&gt;dma_intr
op_assign
id|swim-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
suffix:semicolon
id|fs-&gt;cur_cyl
op_assign
op_minus
l_int|1
suffix:semicolon
id|fs-&gt;cur_sector
op_assign
op_minus
l_int|1
suffix:semicolon
id|fs-&gt;secpercyl
op_assign
l_int|36
suffix:semicolon
id|fs-&gt;secpertrack
op_assign
l_int|18
suffix:semicolon
id|fs-&gt;total_secs
op_assign
l_int|2880
suffix:semicolon
id|fs-&gt;media_bay
op_assign
id|mediabay
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|fs-&gt;wait
)paren
suffix:semicolon
id|fs-&gt;dma_cmd
op_assign
(paren
r_struct
id|dbdma_cmd
op_star
)paren
id|DBDMA_ALIGN
c_func
(paren
id|fs-&gt;dbdma_cmd_space
)paren
suffix:semicolon
id|memset
c_func
(paren
id|fs-&gt;dma_cmd
comma
l_int|0
comma
l_int|2
op_star
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|fs-&gt;dma_cmd
(braket
l_int|1
)braket
dot
id|command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|fs-&gt;swim3_intr
comma
id|swim3_interrupt
comma
l_int|0
comma
l_string|&quot;SWIM3&quot;
comma
id|fs
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Couldn&squot;t get irq %d for SWIM3&bslash;n&quot;
comma
id|fs-&gt;swim3_intr
)paren
suffix:semicolon
id|feature_clear
c_func
(paren
id|swim
comma
id|FEATURE_SWIM3_enable
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t;if (request_irq(fs-&gt;dma_intr, fd_dma_interrupt, 0, &quot;SWIM3-dma&quot;, fs)) {&n;&t;&t;printk(KERN_ERR &quot;Couldn&squot;t get irq %d for SWIM3 DMA&quot;,&n;&t;&t;       fs-&gt;dma_intr);&n;&t;&t;feature_clear(swim, FEATURE_SWIM3_enable);&n;&t;&t;return -EBUSY;&n;&t;}&n;*/
id|init_timer
c_func
(paren
op_amp
id|fs-&gt;timeout
)paren
suffix:semicolon
id|do_floppy
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fd%d: SWIM3 floppy controller %s&bslash;n&quot;
comma
id|floppy_count
comma
id|mediabay
ques
c_cond
l_string|&quot;in media bay&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|floppy_count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
