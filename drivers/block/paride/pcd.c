multiline_comment|/* &n;&t;pcd.c&t;(c) 1997-8  Grant R. Guenther &lt;grant@torque.net&gt;&n;&t;&t;            Under the terms of the GNU public license.&n;&n;&t;This is a high-level driver for parallel port ATAPI CD-ROM&n;        drives based on chips supported by the paride module.&n;&n;        By default, the driver will autoprobe for a single parallel&n;        port ATAPI CD-ROM drive, but if their individual parameters are&n;        specified, the driver can handle up to 4 drives.&n;&n;        The behaviour of the pcd driver can be altered by setting&n;        some parameters from the insmod command line.  The following&n;        parameters are adjustable:&n;&n;            drive0      These four arguments can be arrays of       &n;            drive1      1-6 integers as follows:&n;            drive2&n;            drive3      &lt;prt&gt;,&lt;pro&gt;,&lt;uni&gt;,&lt;mod&gt;,&lt;slv&gt;,&lt;dly&gt;&n;&n;                        Where,&n;&n;                &lt;prt&gt;   is the base of the parallel port address for&n;                        the corresponding drive.  (required)&n;&n;                &lt;pro&gt;   is the protocol number for the adapter that&n;                        supports this drive.  These numbers are&n;                        logged by &squot;paride&squot; when the protocol modules&n;                        are initialised.  (0 if not given)&n;&n;                &lt;uni&gt;   for those adapters that support chained&n;                        devices, this is the unit selector for the&n;                        chain of devices on the given port.  It should&n;                        be zero for devices that don&squot;t support chaining.&n;                        (0 if not given)&n;&n;                &lt;mod&gt;   this can be -1 to choose the best mode, or one&n;                        of the mode numbers supported by the adapter.&n;                        (-1 if not given)&n;&n;&t;&t;&lt;slv&gt;   ATAPI CD-ROMs can be jumpered to master or slave.&n;&t;&t;&t;Set this to 0 to choose the master drive, 1 to&n;                        choose the slave, -1 (the default) to choose the&n;&t;&t;&t;first drive found.&n;&n;                &lt;dly&gt;   some parallel ports require the driver to &n;                        go more slowly.  -1 sets a default value that&n;                        should work with the chosen protocol.  Otherwise,&n;                        set this to a small integer, the larger it is&n;                        the slower the port i/o.  In some cases, setting&n;                        this to zero will speed up the device. (default -1)&n;                        &n;            major       You may use this parameter to overide the&n;                        default major number (46) that this driver&n;                        will use.  Be sure to change the device&n;                        name as well.&n;&n;            name        This parameter is a character string that&n;                        contains the name the kernel will use for this&n;                        device (in /proc output, for instance).&n;                        (default &quot;pcd&quot;)&n;&n;            verbose     This parameter controls the amount of logging&n;                        that the driver will do.  Set it to 0 for&n;                        normal operation, 1 to see autoprobe progress&n;                        messages, or 2 to see additional debugging&n;                        output.  (default 0)&n;  &n;            nice        This parameter controls the driver&squot;s use of&n;                        idle CPU time, at the expense of some speed.&n; &n;&t;If this driver is built into the kernel, you can use kernel&n;        the following command line parameters, with the same values&n;        as the corresponding module parameters listed above:&n;&n;&t;    pcd.drive0&n;&t;    pcd.drive1&n;&t;    pcd.drive2&n;&t;    pcd.drive3&n;&t;    pcd.nice&n;&n;        In addition, you can use the parameter pcd.disable to disable&n;        the driver entirely.&n;&n;*/
multiline_comment|/* Changes:&n;&n;&t;1.01&t;GRG 1998.01.24&t;Added test unit ready support&n;&t;1.02    GRG 1998.05.06  Changes to pcd_completion, ready_wait,&n;&t;&t;&t;&t;and loosen interpretation of ATAPI&n;&t;&t;&t;        standard for clearing error status.&n;&t;&t;&t;&t;Use spinlocks. Eliminate sti().&n;&t;1.03    GRG 1998.06.16  Eliminated an Ugh&n;&t;1.04&t;GRG 1998.08.15  Added extra debugging, improvements to&n;&t;&t;&t;&t;pcd_completion, use HZ in loop timing&n;&t;1.05&t;GRG 1998.08.16&t;Conformed to &quot;Uniform CD-ROM&quot; standard&n;&t;1.06    GRG 1998.08.19  Added audio ioctl support&n;&t;1.07    GRG 1998.09.24  Increased reset timeout, added jumbo support&n;&n;*/
DECL|macro|PCD_VERSION
mdefine_line|#define&t;PCD_VERSION&t;&quot;1.07&quot;
DECL|macro|PCD_MAJOR
mdefine_line|#define PCD_MAJOR&t;46
DECL|macro|PCD_NAME
mdefine_line|#define PCD_NAME&t;&quot;pcd&quot;
DECL|macro|PCD_UNITS
mdefine_line|#define PCD_UNITS&t;4
multiline_comment|/* Here are things one can override from the insmod command.&n;   Most are autoprobed by paride unless set here.  Verbose is off&n;   by default.&n;&n;*/
DECL|variable|verbose
r_static
r_int
id|verbose
op_assign
l_int|0
suffix:semicolon
DECL|variable|major
r_static
r_int
id|major
op_assign
id|PCD_MAJOR
suffix:semicolon
DECL|variable|name
r_static
r_char
op_star
id|name
op_assign
id|PCD_NAME
suffix:semicolon
DECL|variable|nice
r_static
r_int
id|nice
op_assign
l_int|0
suffix:semicolon
DECL|variable|disable
r_static
r_int
id|disable
op_assign
l_int|0
suffix:semicolon
DECL|variable|drive0
r_static
r_int
id|drive0
(braket
l_int|6
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drive1
r_static
r_int
id|drive1
(braket
l_int|6
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drive2
r_static
r_int
id|drive2
(braket
l_int|6
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drive3
r_static
r_int
id|drive3
(braket
l_int|6
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drives
r_static
r_int
(paren
op_star
id|drives
(braket
l_int|4
)braket
)paren
(braket
l_int|6
)braket
op_assign
(brace
op_amp
id|drive0
comma
op_amp
id|drive1
comma
op_amp
id|drive2
comma
op_amp
id|drive3
)brace
suffix:semicolon
DECL|variable|pcd_drive_count
r_static
r_int
id|pcd_drive_count
suffix:semicolon
DECL|macro|D_PRT
mdefine_line|#define D_PRT   0
DECL|macro|D_PRO
mdefine_line|#define D_PRO   1
DECL|macro|D_UNI
mdefine_line|#define D_UNI   2
DECL|macro|D_MOD
mdefine_line|#define D_MOD   3
DECL|macro|D_SLV
mdefine_line|#define D_SLV   4
DECL|macro|D_DLY
mdefine_line|#define D_DLY   5
DECL|macro|DU
mdefine_line|#define DU              (*drives[unit])
multiline_comment|/* end of parameters */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/cdrom.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#ifndef MODULE
macro_line|#include &quot;setup.h&quot;
DECL|variable|pcd_stt
r_static
id|STT
id|pcd_stt
(braket
l_int|6
)braket
op_assign
(brace
(brace
l_string|&quot;drive0&quot;
comma
l_int|6
comma
id|drive0
)brace
comma
(brace
l_string|&quot;drive1&quot;
comma
l_int|6
comma
id|drive1
)brace
comma
(brace
l_string|&quot;drive2&quot;
comma
l_int|6
comma
id|drive2
)brace
comma
(brace
l_string|&quot;drive3&quot;
comma
l_int|6
comma
id|drive3
)brace
comma
(brace
l_string|&quot;disable&quot;
comma
l_int|1
comma
op_amp
id|disable
)brace
comma
(brace
l_string|&quot;nice&quot;
comma
l_int|1
comma
op_amp
id|nice
)brace
)brace
suffix:semicolon
DECL|function|pcd_setup
r_void
id|pcd_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
id|generic_setup
c_func
(paren
id|pcd_stt
comma
l_int|6
comma
id|str
)paren
suffix:semicolon
)brace
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|verbose
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|major
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|name
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|nice
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|drive0
comma
l_string|&quot;1-6i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|drive1
comma
l_string|&quot;1-6i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|drive2
comma
l_string|&quot;1-6i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|drive3
comma
l_string|&quot;1-6i&quot;
)paren
suffix:semicolon
macro_line|#include &quot;paride.h&quot;
multiline_comment|/* set up defines for blk.h,  why don&squot;t all drivers do it this way ? */
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR&t;major
DECL|macro|DEVICE_NAME
mdefine_line|#define DEVICE_NAME &quot;PCD&quot;
DECL|macro|DEVICE_REQUEST
mdefine_line|#define DEVICE_REQUEST do_pcd_request
DECL|macro|DEVICE_NR
mdefine_line|#define DEVICE_NR(device) (MINOR(device))
DECL|macro|DEVICE_ON
mdefine_line|#define DEVICE_ON(device)
DECL|macro|DEVICE_OFF
mdefine_line|#define DEVICE_OFF(device)
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;pseudo.h&quot;
DECL|macro|PCD_RETRIES
mdefine_line|#define PCD_RETRIES&t;     5
DECL|macro|PCD_TMO
mdefine_line|#define PCD_TMO&t;&t;   800&t;&t;/* timeout in jiffies */
DECL|macro|PCD_DELAY
mdefine_line|#define PCD_DELAY           50          /* spin delay in uS */
DECL|macro|PCD_READY_TMO
mdefine_line|#define PCD_READY_TMO&t;    20&t;&t;/* in seconds */
DECL|macro|PCD_RESET_TMO
mdefine_line|#define PCD_RESET_TMO&t;   100&t;&t;/* in tenths of a second */
DECL|macro|PCD_SPIN
mdefine_line|#define PCD_SPIN&t;(1000000*PCD_TMO)/(HZ*PCD_DELAY)
DECL|macro|IDE_ERR
mdefine_line|#define IDE_ERR&t;&t;0x01
DECL|macro|IDE_DRQ
mdefine_line|#define IDE_DRQ         0x08
DECL|macro|IDE_READY
mdefine_line|#define IDE_READY       0x40
DECL|macro|IDE_BUSY
mdefine_line|#define IDE_BUSY        0x80
r_int
id|pcd_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|pcd_open
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|purpose
)paren
suffix:semicolon
r_static
r_void
id|pcd_release
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
)paren
suffix:semicolon
r_static
r_int
id|pcd_drive_status
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|slot_nr
)paren
suffix:semicolon
r_static
r_int
id|pcd_media_changed
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|slot_nr
)paren
suffix:semicolon
r_static
r_int
id|pcd_tray_move
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|position
)paren
suffix:semicolon
r_static
r_int
id|pcd_lock_door
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|lock
)paren
suffix:semicolon
r_static
r_int
id|pcd_drive_reset
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
)paren
suffix:semicolon
r_static
r_int
id|pcd_get_mcn
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_struct
id|cdrom_mcn
op_star
id|mcn
)paren
suffix:semicolon
r_static
r_int
id|pcd_audio_ioctl
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
r_static
r_int
id|pcd_packet
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_struct
id|cdrom_generic_command
op_star
id|cgc
)paren
suffix:semicolon
r_static
r_int
id|pcd_detect
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|pcd_probe_capabilities
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_pcd_read_drq
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_pcd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
suffix:semicolon
r_static
r_void
id|do_pcd_read
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|pcd_blocksizes
r_static
r_int
id|pcd_blocksizes
(braket
id|PCD_UNITS
)braket
suffix:semicolon
DECL|struct|pcd_unit
r_struct
id|pcd_unit
(brace
DECL|member|pia
r_struct
id|pi_adapter
id|pia
suffix:semicolon
multiline_comment|/* interface to paride layer */
DECL|member|pi
r_struct
id|pi_adapter
op_star
id|pi
suffix:semicolon
DECL|member|drive
r_int
id|drive
suffix:semicolon
multiline_comment|/* master/slave */
DECL|member|last_sense
r_int
id|last_sense
suffix:semicolon
multiline_comment|/* result of last request sense */
DECL|member|changed
r_int
id|changed
suffix:semicolon
multiline_comment|/* media change seen */
DECL|member|present
r_int
id|present
suffix:semicolon
multiline_comment|/* does this unit exist ? */
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
multiline_comment|/* pcd0, pcd1, etc */
DECL|member|info
r_struct
id|cdrom_device_info
id|info
suffix:semicolon
multiline_comment|/* uniform cdrom interface */
)brace
suffix:semicolon
DECL|variable|pcd
r_struct
id|pcd_unit
id|pcd
(braket
id|PCD_UNITS
)braket
suffix:semicolon
multiline_comment|/*  &squot;unit&squot; must be defined in all functions - either as a local or a param */
DECL|macro|PCD
mdefine_line|#define PCD pcd[unit]
DECL|macro|PI
mdefine_line|#define PI PCD.pi
DECL|variable|pcd_scratch
r_static
r_char
id|pcd_scratch
(braket
l_int|64
)braket
suffix:semicolon
DECL|variable|pcd_buffer
r_static
r_char
id|pcd_buffer
(braket
l_int|2048
)braket
suffix:semicolon
multiline_comment|/* raw block buffer */
DECL|variable|pcd_bufblk
r_static
r_int
id|pcd_bufblk
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* block in buffer, in CD units,&n;                                           -1 for nothing there. See also&n;&t;&t;&t;&t;&t;   pd_unit.&n;&t;&t;&t;&t;&t; */
multiline_comment|/* the variables below are used mainly in the I/O request engine, which&n;   processes only one request at a time.&n;*/
DECL|variable|pcd_unit
r_static
r_int
id|pcd_unit
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* unit of current request &amp; bufblk */
DECL|variable|pcd_retries
r_static
r_int
id|pcd_retries
suffix:semicolon
multiline_comment|/* retries on current request */
DECL|variable|pcd_busy
r_static
r_int
id|pcd_busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* request being processed ? */
DECL|variable|pcd_sector
r_static
r_int
id|pcd_sector
suffix:semicolon
multiline_comment|/* address of next requested sector */
DECL|variable|pcd_count
r_static
r_int
id|pcd_count
suffix:semicolon
multiline_comment|/* number of blocks still to do */
DECL|variable|pcd_buf
r_static
r_char
op_star
id|pcd_buf
suffix:semicolon
multiline_comment|/* buffer for request in progress */
DECL|variable|pcd_warned
r_static
r_int
id|pcd_warned
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Have we logged a phase warning ? */
multiline_comment|/* kernel glue structures */
DECL|variable|pcd_dops
r_static
r_struct
id|cdrom_device_ops
id|pcd_dops
op_assign
(brace
id|pcd_open
comma
id|pcd_release
comma
id|pcd_drive_status
comma
id|pcd_media_changed
comma
id|pcd_tray_move
comma
id|pcd_lock_door
comma
l_int|0
comma
multiline_comment|/* select speed */
l_int|0
comma
multiline_comment|/* select disk  */
l_int|0
comma
multiline_comment|/* get last session */
id|pcd_get_mcn
comma
id|pcd_drive_reset
comma
id|pcd_audio_ioctl
comma
l_int|0
comma
multiline_comment|/* dev_ioctl */
id|CDC_CLOSE_TRAY
op_or
id|CDC_OPEN_TRAY
op_or
id|CDC_LOCK
op_or
id|CDC_MCN
op_or
id|CDC_MEDIA_CHANGED
op_or
id|CDC_RESET
op_or
id|CDC_PLAY_AUDIO
op_or
id|CDC_GENERIC_PACKET
op_or
id|CDC_CD_R
op_or
id|CDC_CD_RW
comma
l_int|0
comma
id|pcd_packet
comma
)brace
suffix:semicolon
DECL|function|pcd_init_units
r_static
r_void
id|pcd_init_units
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
comma
id|j
suffix:semicolon
id|pcd_drive_count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PCD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
(brace
id|PCD.pi
op_assign
op_amp
id|PCD.pia
suffix:semicolon
id|PCD.present
op_assign
l_int|0
suffix:semicolon
id|PCD.last_sense
op_assign
l_int|0
suffix:semicolon
id|PCD.changed
op_assign
l_int|1
suffix:semicolon
id|PCD.drive
op_assign
id|DU
(braket
id|D_SLV
)braket
suffix:semicolon
r_if
c_cond
(paren
id|DU
(braket
id|D_PRT
)braket
)paren
id|pcd_drive_count
op_increment
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|j
OL
(paren
r_sizeof
(paren
id|PCD.info.name
)paren
op_minus
l_int|2
)paren
)paren
op_logical_and
(paren
id|PCD.info.name
(braket
id|j
)braket
op_assign
id|name
(braket
id|j
)braket
)paren
)paren
id|j
op_increment
suffix:semicolon
id|PCD.info.name
(braket
id|j
op_increment
)braket
op_assign
l_char|&squot;0&squot;
op_plus
id|unit
suffix:semicolon
id|PCD.info.name
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|PCD.name
op_assign
op_amp
id|PCD.info.name
(braket
l_int|0
)braket
suffix:semicolon
id|PCD.info.ops
op_assign
op_amp
id|pcd_dops
suffix:semicolon
id|PCD.info.handle
op_assign
l_int|NULL
suffix:semicolon
id|PCD.info.dev
op_assign
id|MKDEV
c_func
(paren
id|major
comma
id|unit
)paren
suffix:semicolon
id|PCD.info.speed
op_assign
l_int|0
suffix:semicolon
id|PCD.info.capacity
op_assign
l_int|1
suffix:semicolon
id|PCD.info.mask
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|pcd_init
r_int
id|pcd_init
(paren
r_void
)paren
multiline_comment|/* preliminary initialisation */
(brace
r_int
id|i
comma
id|unit
suffix:semicolon
r_if
c_cond
(paren
id|disable
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|pcd_init_units
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcd_detect
c_func
(paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* get the atapi capabilities page */
id|pcd_probe_capabilities
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|MAJOR_NR
comma
id|name
comma
op_amp
id|cdrom_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcd: unable to get major number %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PCD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
r_if
c_cond
(paren
id|PCD.present
)paren
id|register_cdrom
c_func
(paren
op_amp
id|PCD.info
)paren
suffix:semicolon
id|blk_init_queue
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|DEVICE_REQUEST
)paren
suffix:semicolon
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 8 sector (4kB) read ahead */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCD_UNITS
suffix:semicolon
id|i
op_increment
)paren
id|pcd_blocksizes
(braket
id|i
)braket
op_assign
l_int|1024
suffix:semicolon
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|pcd_blocksizes
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcd_open
r_static
r_int
id|pcd_open
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|purpose
)paren
(brace
r_int
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|unit
op_ge
id|PCD_UNITS
)paren
op_logical_or
(paren
op_logical_neg
id|PCD.present
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcd_release
r_static
r_void
id|pcd_release
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* Glue for modules ... */
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
macro_line|#ifdef PARIDE_JUMBO
(brace
r_extern
id|paride_init
c_func
(paren
)paren
suffix:semicolon
id|paride_init
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|err
op_assign
id|pcd_init
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
suffix:semicolon
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PCD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
r_if
c_cond
(paren
id|PCD.present
)paren
(brace
id|pi_release
c_func
(paren
id|PI
)paren
suffix:semicolon
id|unregister_cdrom
c_func
(paren
op_amp
id|PCD.info
)paren
suffix:semicolon
)brace
id|unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
id|name
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|macro|WR
mdefine_line|#define WR(c,r,v)       pi_write_regr(PI,c,r,v)
DECL|macro|RR
mdefine_line|#define RR(c,r)         (pi_read_regr(PI,c,r))
DECL|function|pcd_wait
r_static
r_int
id|pcd_wait
c_func
(paren
r_int
id|unit
comma
r_int
id|go
comma
r_int
id|stop
comma
r_char
op_star
id|fun
comma
r_char
op_star
id|msg
)paren
(brace
r_int
id|j
comma
id|r
comma
id|e
comma
id|s
comma
id|p
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
(paren
id|r
op_assign
id|RR
c_func
(paren
l_int|1
comma
l_int|6
)paren
)paren
op_amp
id|go
)paren
op_logical_or
(paren
id|stop
op_logical_and
(paren
op_logical_neg
(paren
id|r
op_amp
id|stop
)paren
)paren
)paren
)paren
op_logical_and
(paren
id|j
op_increment
OL
id|PCD_SPIN
)paren
)paren
id|udelay
c_func
(paren
id|PCD_DELAY
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_amp
(paren
id|IDE_ERR
op_amp
id|stop
)paren
)paren
op_logical_or
(paren
id|j
op_ge
id|PCD_SPIN
)paren
)paren
(brace
id|s
op_assign
id|RR
c_func
(paren
l_int|0
comma
l_int|7
)paren
suffix:semicolon
id|e
op_assign
id|RR
c_func
(paren
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|p
op_assign
id|RR
c_func
(paren
l_int|0
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ge
id|PCD_SPIN
)paren
id|e
op_or_assign
l_int|0x100
suffix:semicolon
r_if
c_cond
(paren
id|fun
)paren
id|printk
c_func
(paren
l_string|&quot;%s: %s %s: alt=0x%x stat=0x%x err=0x%x&quot;
l_string|&quot; loop=%d phase=%d&bslash;n&quot;
comma
id|PCD.name
comma
id|fun
comma
id|msg
comma
id|r
comma
id|s
comma
id|e
comma
id|j
comma
id|p
)paren
suffix:semicolon
r_return
(paren
id|s
op_lshift
l_int|8
)paren
op_plus
id|r
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcd_command
r_static
r_int
id|pcd_command
c_func
(paren
r_int
id|unit
comma
r_char
op_star
id|cmd
comma
r_int
id|dlen
comma
r_char
op_star
id|fun
)paren
(brace
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|6
comma
l_int|0xa0
op_plus
l_int|0x10
op_star
id|PCD.drive
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcd_wait
c_func
(paren
id|unit
comma
id|IDE_BUSY
op_or
id|IDE_DRQ
comma
l_int|0
comma
id|fun
comma
l_string|&quot;before command&quot;
)paren
)paren
(brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|WR
c_func
(paren
l_int|0
comma
l_int|4
comma
id|dlen
op_mod
l_int|256
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|5
comma
id|dlen
op_div
l_int|256
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|7
comma
l_int|0xa0
)paren
suffix:semicolon
multiline_comment|/* ATAPI packet command */
r_if
c_cond
(paren
id|pcd_wait
c_func
(paren
id|unit
comma
id|IDE_BUSY
comma
id|IDE_DRQ
comma
id|fun
comma
l_string|&quot;command DRQ&quot;
)paren
)paren
(brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|RR
c_func
(paren
l_int|0
comma
l_int|2
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: %s: command phase error&bslash;n&quot;
comma
id|PCD.name
comma
id|fun
)paren
suffix:semicolon
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pi_write_block
c_func
(paren
id|PI
comma
id|cmd
comma
l_int|12
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcd_completion
r_static
r_int
id|pcd_completion
c_func
(paren
r_int
id|unit
comma
r_char
op_star
id|buf
comma
r_char
op_star
id|fun
)paren
(brace
r_int
id|r
comma
id|d
comma
id|p
comma
id|n
comma
id|k
comma
id|j
suffix:semicolon
id|r
op_assign
op_minus
l_int|1
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcd_wait
c_func
(paren
id|unit
comma
id|IDE_BUSY
comma
id|IDE_DRQ
op_or
id|IDE_READY
op_or
id|IDE_ERR
comma
id|fun
comma
l_string|&quot;completion&quot;
)paren
)paren
(brace
id|r
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|RR
c_func
(paren
l_int|0
comma
l_int|7
)paren
op_amp
id|IDE_DRQ
)paren
(brace
id|d
op_assign
(paren
id|RR
c_func
(paren
l_int|0
comma
l_int|4
)paren
op_plus
l_int|256
op_star
id|RR
c_func
(paren
l_int|0
comma
l_int|5
)paren
)paren
suffix:semicolon
id|n
op_assign
(paren
(paren
id|d
op_plus
l_int|3
)paren
op_amp
l_int|0xfffc
)paren
suffix:semicolon
id|p
op_assign
id|RR
c_func
(paren
l_int|0
comma
l_int|2
)paren
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_eq
l_int|2
)paren
op_logical_and
(paren
id|n
OG
l_int|0
)paren
op_logical_and
(paren
id|j
op_eq
l_int|0
)paren
)paren
(brace
id|pi_read_block
c_func
(paren
id|PI
comma
id|buf
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: %s: Read %d bytes&bslash;n&quot;
comma
id|PCD.name
comma
id|fun
comma
id|n
)paren
suffix:semicolon
id|r
op_assign
l_int|0
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;%s: %s: Unexpected phase %d, d=%d, k=%d&bslash;n&quot;
comma
id|PCD.name
comma
id|fun
comma
id|p
comma
id|d
comma
id|k
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|verbose
OL
l_int|2
)paren
op_logical_and
op_logical_neg
id|pcd_warned
)paren
(brace
id|pcd_warned
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: WARNING: ATAPI phase errors&bslash;n&quot;
comma
id|PCD.name
)paren
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
op_increment
OG
id|PCD_TMO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Stuck DRQ&bslash;n&quot;
comma
id|PCD.name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcd_wait
c_func
(paren
id|unit
comma
id|IDE_BUSY
comma
id|IDE_DRQ
op_or
id|IDE_READY
op_or
id|IDE_ERR
comma
id|fun
comma
l_string|&quot;completion&quot;
)paren
)paren
(brace
id|r
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|pcd_req_sense
r_static
r_void
id|pcd_req_sense
c_func
(paren
r_int
id|unit
comma
r_char
op_star
id|fun
)paren
(brace
r_char
id|rs_cmd
(braket
l_int|12
)braket
op_assign
(brace
l_int|0x03
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_char
id|buf
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|r
comma
id|c
suffix:semicolon
id|r
op_assign
id|pcd_command
c_func
(paren
id|unit
comma
id|rs_cmd
comma
l_int|16
comma
l_string|&quot;Request sense&quot;
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
id|pcd_completion
c_func
(paren
id|unit
comma
id|buf
comma
l_string|&quot;Request sense&quot;
)paren
suffix:semicolon
id|PCD.last_sense
op_assign
op_minus
l_int|1
suffix:semicolon
id|c
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
(brace
r_if
c_cond
(paren
id|fun
)paren
id|printk
c_func
(paren
l_string|&quot;%s: %s: Sense key: %x, ASC: %x, ASQ: %x&bslash;n&quot;
comma
id|PCD.name
comma
id|fun
comma
id|buf
(braket
l_int|2
)braket
op_amp
l_int|0xf
comma
id|buf
(braket
l_int|12
)braket
comma
id|buf
(braket
l_int|13
)braket
)paren
suffix:semicolon
id|c
op_assign
id|buf
(braket
l_int|2
)braket
op_amp
l_int|0xf
suffix:semicolon
id|PCD.last_sense
op_assign
id|c
op_or
(paren
(paren
id|buf
(braket
l_int|12
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|buf
(braket
l_int|13
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|c
op_eq
l_int|2
)paren
op_logical_or
(paren
id|c
op_eq
l_int|6
)paren
)paren
id|PCD.changed
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|pcd_atapi
r_static
r_int
id|pcd_atapi
c_func
(paren
r_int
id|unit
comma
r_char
op_star
id|cmd
comma
r_int
id|dlen
comma
r_char
op_star
id|buf
comma
r_char
op_star
id|fun
)paren
(brace
r_int
id|r
suffix:semicolon
id|r
op_assign
id|pcd_command
c_func
(paren
id|unit
comma
id|cmd
comma
id|dlen
comma
id|fun
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
id|r
op_assign
id|pcd_completion
c_func
(paren
id|unit
comma
id|buf
comma
id|fun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
id|pcd_req_sense
c_func
(paren
id|unit
comma
id|fun
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|pcd_packet
r_static
r_int
id|pcd_packet
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_struct
id|cdrom_generic_command
op_star
id|cgc
)paren
(brace
r_char
op_star
id|un_cmd
suffix:semicolon
r_int
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
id|un_cmd
op_assign
id|cgc-&gt;cmd
suffix:semicolon
r_return
id|pcd_atapi
c_func
(paren
id|unit
comma
id|un_cmd
comma
id|cgc-&gt;buflen
comma
id|cgc-&gt;buffer
comma
l_string|&quot;generic packet&quot;
)paren
suffix:semicolon
)brace
DECL|macro|DBMSG
mdefine_line|#define DBMSG(msg)&t;((verbose&gt;1)?(msg):NULL)
DECL|function|pcd_media_changed
r_static
r_int
id|pcd_media_changed
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|slot_nr
)paren
(brace
r_int
id|r
suffix:semicolon
r_int
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
id|r
op_assign
id|PCD.changed
suffix:semicolon
id|PCD.changed
op_assign
l_int|0
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|pcd_lock_door
r_static
r_int
id|pcd_lock_door
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|lock
)paren
(brace
r_char
id|un_cmd
(braket
l_int|12
)braket
op_assign
(brace
l_int|0x1e
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|lock
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_return
id|pcd_atapi
c_func
(paren
id|unit
comma
id|un_cmd
comma
l_int|0
comma
id|pcd_scratch
comma
id|lock
ques
c_cond
l_string|&quot;lock door&quot;
suffix:colon
l_string|&quot;unlock door&quot;
)paren
suffix:semicolon
)brace
DECL|function|pcd_tray_move
r_static
r_int
id|pcd_tray_move
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|position
)paren
(brace
r_char
id|ej_cmd
(braket
l_int|12
)braket
op_assign
(brace
l_int|0x1b
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|3
op_minus
id|position
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_return
id|pcd_atapi
c_func
(paren
id|unit
comma
id|ej_cmd
comma
l_int|0
comma
id|pcd_scratch
comma
id|position
ques
c_cond
l_string|&quot;eject&quot;
suffix:colon
l_string|&quot;close tray&quot;
)paren
suffix:semicolon
)brace
DECL|function|pcd_sleep
r_static
r_void
id|pcd_sleep
c_func
(paren
r_int
id|cs
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|cs
)paren
suffix:semicolon
)brace
DECL|function|pcd_reset
r_static
r_int
id|pcd_reset
c_func
(paren
r_int
id|unit
)paren
(brace
r_int
id|i
comma
id|k
comma
id|flg
suffix:semicolon
r_int
id|expect
(braket
l_int|5
)braket
op_assign
(brace
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|0x14
comma
l_int|0xeb
)brace
suffix:semicolon
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|6
comma
l_int|0xa0
op_plus
l_int|0x10
op_star
id|PCD.drive
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|7
comma
l_int|8
)paren
suffix:semicolon
id|pcd_sleep
c_func
(paren
l_int|20
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* delay a bit */
id|k
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|k
op_increment
OL
id|PCD_RESET_TMO
)paren
op_logical_and
(paren
id|RR
c_func
(paren
l_int|1
comma
l_int|6
)paren
op_amp
id|IDE_BUSY
)paren
)paren
id|pcd_sleep
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|flg
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|flg
op_and_assign
(paren
id|RR
c_func
(paren
l_int|0
comma
id|i
op_plus
l_int|1
)paren
op_eq
id|expect
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|verbose
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Reset (%d) signature = &quot;
comma
id|PCD.name
comma
id|k
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%3x&quot;
comma
id|RR
c_func
(paren
l_int|0
comma
id|i
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|flg
)paren
id|printk
c_func
(paren
l_string|&quot; (incorrect)&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_return
id|flg
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|pcd_drive_reset
r_static
r_int
id|pcd_drive_reset
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
)paren
(brace
r_return
id|pcd_reset
c_func
(paren
id|DEVICE_NR
c_func
(paren
id|cdi-&gt;dev
)paren
)paren
suffix:semicolon
)brace
DECL|function|pcd_ready_wait
r_static
r_int
id|pcd_ready_wait
c_func
(paren
r_int
id|unit
comma
r_int
id|tmo
)paren
(brace
r_char
id|tr_cmd
(braket
l_int|12
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|k
comma
id|p
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|k
OL
id|tmo
)paren
(brace
id|PCD.last_sense
op_assign
l_int|0
suffix:semicolon
id|pcd_atapi
c_func
(paren
id|unit
comma
id|tr_cmd
comma
l_int|0
comma
l_int|NULL
comma
id|DBMSG
c_func
(paren
l_string|&quot;test unit ready&quot;
)paren
)paren
suffix:semicolon
id|p
op_assign
id|PCD.last_sense
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
(paren
id|p
op_amp
l_int|0xffff
)paren
op_eq
l_int|0x0402
)paren
op_logical_or
(paren
(paren
id|p
op_amp
l_int|0xff
)paren
op_eq
l_int|6
)paren
)paren
)paren
r_return
id|p
suffix:semicolon
id|k
op_increment
suffix:semicolon
id|pcd_sleep
c_func
(paren
id|HZ
)paren
suffix:semicolon
)brace
r_return
l_int|0x000020
suffix:semicolon
multiline_comment|/* timeout */
)brace
DECL|function|pcd_drive_status
r_static
r_int
id|pcd_drive_status
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
id|slot_nr
)paren
(brace
r_char
id|rc_cmd
(braket
l_int|12
)braket
op_assign
(brace
l_int|0x25
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcd_ready_wait
c_func
(paren
id|unit
comma
id|PCD_READY_TMO
)paren
)paren
r_return
id|CDS_DRIVE_NOT_READY
suffix:semicolon
r_if
c_cond
(paren
id|pcd_atapi
c_func
(paren
id|unit
comma
id|rc_cmd
comma
l_int|8
comma
id|pcd_scratch
comma
id|DBMSG
c_func
(paren
l_string|&quot;check media&quot;
)paren
)paren
)paren
r_return
id|CDS_NO_DISC
suffix:semicolon
r_return
id|CDS_DISC_OK
suffix:semicolon
)brace
DECL|function|pcd_identify
r_static
r_int
id|pcd_identify
c_func
(paren
r_int
id|unit
comma
r_char
op_star
id|id
)paren
(brace
r_int
id|k
comma
id|s
suffix:semicolon
r_char
id|id_cmd
(braket
l_int|12
)braket
op_assign
(brace
l_int|0x12
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|36
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|pcd_bufblk
op_assign
op_minus
l_int|1
suffix:semicolon
id|s
op_assign
id|pcd_atapi
c_func
(paren
id|unit
comma
id|id_cmd
comma
l_int|36
comma
id|pcd_buffer
comma
l_string|&quot;identify&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pcd_buffer
(braket
l_int|0
)braket
op_amp
l_int|0x1f
)paren
op_ne
l_int|5
)paren
(brace
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
l_string|&quot;%s: %s is not a CD-ROM&bslash;n&quot;
comma
id|PCD.name
comma
id|PCD.drive
ques
c_cond
l_string|&quot;Slave&quot;
suffix:colon
l_string|&quot;Master&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|16
suffix:semicolon
id|k
op_increment
)paren
id|id
(braket
id|k
)braket
op_assign
id|pcd_buffer
(braket
l_int|16
op_plus
id|k
)braket
suffix:semicolon
id|id
(braket
l_int|16
)braket
op_assign
l_int|0
suffix:semicolon
id|k
op_assign
l_int|16
suffix:semicolon
r_while
c_loop
(paren
(paren
id|k
op_ge
l_int|0
)paren
op_logical_and
(paren
id|id
(braket
id|k
)braket
op_le
l_int|0x20
)paren
)paren
(brace
id|id
(braket
id|k
)braket
op_assign
l_int|0
suffix:semicolon
id|k
op_decrement
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: %s: %s&bslash;n&quot;
comma
id|PCD.name
comma
id|PCD.drive
ques
c_cond
l_string|&quot;Slave&quot;
suffix:colon
l_string|&quot;Master&quot;
comma
id|id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcd_probe
r_static
r_int
id|pcd_probe
c_func
(paren
r_int
id|unit
comma
r_int
id|ms
comma
r_char
op_star
id|id
)paren
multiline_comment|/*&t;returns  0, with id set if drive is detected&n;&t;        -1, if drive detection failed&n;*/
(brace
r_if
c_cond
(paren
id|ms
op_eq
op_minus
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|PCD.drive
op_assign
l_int|0
suffix:semicolon
id|PCD.drive
op_le
l_int|1
suffix:semicolon
id|PCD.drive
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|pcd_reset
c_func
(paren
id|unit
)paren
op_logical_and
op_logical_neg
id|pcd_identify
c_func
(paren
id|unit
comma
id|id
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|PCD.drive
op_assign
id|ms
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcd_reset
c_func
(paren
id|unit
)paren
op_logical_and
op_logical_neg
id|pcd_identify
c_func
(paren
id|unit
comma
id|id
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|pcd_probe_capabilities
r_static
r_void
id|pcd_probe_capabilities
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
comma
id|r
suffix:semicolon
r_char
id|buffer
(braket
l_int|32
)braket
suffix:semicolon
r_char
id|cmd
(braket
l_int|12
)braket
op_assign
initialization_block
suffix:semicolon
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PCD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|PCD.present
)paren
r_continue
suffix:semicolon
id|r
op_assign
id|pcd_atapi
c_func
(paren
id|unit
comma
id|cmd
comma
l_int|18
comma
id|buffer
comma
l_string|&quot;mode sense capabilities&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_continue
suffix:semicolon
multiline_comment|/* we should now have the cap page */
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|11
)braket
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
id|PCD.info.mask
op_or_assign
id|CDC_CD_R
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|11
)braket
op_amp
l_int|2
)paren
op_eq
l_int|0
)paren
id|PCD.info.mask
op_or_assign
id|CDC_CD_RW
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|12
)braket
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
id|PCD.info.mask
op_or_assign
id|CDC_PLAY_AUDIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|14
)braket
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
id|PCD.info.mask
op_or_assign
id|CDC_LOCK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|14
)braket
op_amp
l_int|8
)paren
op_eq
l_int|0
)paren
id|PCD.info.mask
op_or_assign
id|CDC_OPEN_TRAY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|14
)braket
op_rshift
l_int|6
)paren
op_eq
l_int|0
)paren
id|PCD.info.mask
op_or_assign
id|CDC_CLOSE_TRAY
suffix:semicolon
)brace
)brace
DECL|function|pcd_detect
r_static
r_int
id|pcd_detect
c_func
(paren
r_void
)paren
(brace
r_char
id|id
(braket
l_int|18
)braket
suffix:semicolon
r_int
id|k
comma
id|unit
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s version %s, major %d, nice %d&bslash;n&quot;
comma
id|name
comma
id|name
comma
id|PCD_VERSION
comma
id|major
comma
id|nice
)paren
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pcd_drive_count
op_eq
l_int|0
)paren
(brace
multiline_comment|/* nothing spec&squot;d - so autoprobe for 1 */
id|unit
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pi_init
c_func
(paren
id|PI
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|pcd_buffer
comma
id|PI_PCD
comma
id|verbose
comma
id|PCD.name
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pcd_probe
c_func
(paren
id|unit
comma
op_minus
l_int|1
comma
id|id
)paren
)paren
(brace
id|PCD.present
op_assign
l_int|1
suffix:semicolon
id|k
op_increment
suffix:semicolon
)brace
r_else
id|pi_release
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
)brace
r_else
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PCD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
r_if
c_cond
(paren
id|DU
(braket
id|D_PRT
)braket
)paren
r_if
c_cond
(paren
id|pi_init
c_func
(paren
id|PI
comma
l_int|0
comma
id|DU
(braket
id|D_PRT
)braket
comma
id|DU
(braket
id|D_MOD
)braket
comma
id|DU
(braket
id|D_UNI
)braket
comma
id|DU
(braket
id|D_PRO
)braket
comma
id|DU
(braket
id|D_DLY
)braket
comma
id|pcd_buffer
comma
id|PI_PCD
comma
id|verbose
comma
id|PCD.name
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pcd_probe
c_func
(paren
id|unit
comma
id|DU
(braket
id|D_SLV
)braket
comma
id|id
)paren
)paren
(brace
id|PCD.present
op_assign
l_int|1
suffix:semicolon
id|k
op_increment
suffix:semicolon
)brace
r_else
id|pi_release
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: No CD-ROM drive found&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* I/O request processing */
DECL|function|do_pcd_request
r_static
r_void
id|do_pcd_request
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_int
id|unit
suffix:semicolon
r_if
c_cond
(paren
id|pcd_busy
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|QUEUE_EMPTY
op_logical_or
(paren
id|CURRENT-&gt;rq_status
op_eq
id|RQ_INACTIVE
)paren
)paren
r_return
suffix:semicolon
id|INIT_REQUEST
suffix:semicolon
r_if
c_cond
(paren
id|CURRENT-&gt;cmd
op_eq
id|READ
)paren
(brace
id|unit
op_assign
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unit
op_ne
id|pcd_unit
)paren
(brace
id|pcd_bufblk
op_assign
op_minus
l_int|1
suffix:semicolon
id|pcd_unit
op_assign
id|unit
suffix:semicolon
)brace
id|pcd_sector
op_assign
id|CURRENT-&gt;sector
suffix:semicolon
id|pcd_count
op_assign
id|CURRENT-&gt;current_nr_sectors
suffix:semicolon
id|pcd_buf
op_assign
id|CURRENT-&gt;buffer
suffix:semicolon
id|pcd_busy
op_assign
l_int|1
suffix:semicolon
id|ps_set_intr
c_func
(paren
id|do_pcd_read
comma
l_int|0
comma
l_int|0
comma
id|nice
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|pcd_ready
r_static
r_int
id|pcd_ready
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
op_assign
id|pcd_unit
suffix:semicolon
r_return
(paren
(paren
(paren
id|RR
c_func
(paren
l_int|1
comma
l_int|6
)paren
op_amp
(paren
id|IDE_BUSY
op_or
id|IDE_DRQ
)paren
)paren
op_eq
id|IDE_DRQ
)paren
)paren
suffix:semicolon
)brace
DECL|function|pcd_transfer
r_static
r_void
id|pcd_transfer
c_func
(paren
r_void
)paren
(brace
r_int
id|k
comma
id|o
suffix:semicolon
r_while
c_loop
(paren
id|pcd_count
op_logical_and
(paren
id|pcd_sector
op_div
l_int|4
op_eq
id|pcd_bufblk
)paren
)paren
(brace
id|o
op_assign
(paren
id|pcd_sector
op_mod
l_int|4
)paren
op_star
l_int|512
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|512
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pcd_buf
(braket
id|k
)braket
op_assign
id|pcd_buffer
(braket
id|o
op_plus
id|k
)braket
suffix:semicolon
)brace
id|pcd_count
op_decrement
suffix:semicolon
id|pcd_buf
op_add_assign
l_int|512
suffix:semicolon
id|pcd_sector
op_increment
suffix:semicolon
)brace
)brace
DECL|function|pcd_start
r_static
r_void
id|pcd_start
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
op_assign
id|pcd_unit
suffix:semicolon
r_int
id|b
comma
id|i
suffix:semicolon
r_char
id|rd_cmd
(braket
l_int|12
)braket
op_assign
(brace
l_int|0xa8
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|saved_flags
suffix:semicolon
id|pcd_bufblk
op_assign
id|pcd_sector
op_div
l_int|4
suffix:semicolon
id|b
op_assign
id|pcd_bufblk
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rd_cmd
(braket
l_int|5
op_minus
id|i
)braket
op_assign
id|b
op_amp
l_int|0xff
suffix:semicolon
id|b
op_assign
id|b
op_rshift
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcd_command
c_func
(paren
id|unit
comma
id|rd_cmd
comma
l_int|2048
comma
l_string|&quot;read block&quot;
)paren
)paren
(brace
id|pcd_bufblk
op_assign
op_minus
l_int|1
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|pcd_busy
op_assign
l_int|0
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|do_pcd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ps_set_intr
c_func
(paren
id|do_pcd_read_drq
comma
id|pcd_ready
comma
id|PCD_TMO
comma
id|nice
)paren
suffix:semicolon
)brace
DECL|function|do_pcd_read
r_static
r_void
id|do_pcd_read
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
op_assign
id|pcd_unit
suffix:semicolon
r_int
id|saved_flags
suffix:semicolon
id|pcd_busy
op_assign
l_int|1
suffix:semicolon
id|pcd_retries
op_assign
l_int|0
suffix:semicolon
id|pcd_transfer
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcd_count
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pcd_busy
op_assign
l_int|0
suffix:semicolon
id|do_pcd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pi_do_claimed
c_func
(paren
id|PI
comma
id|pcd_start
)paren
suffix:semicolon
)brace
DECL|function|do_pcd_read_drq
r_static
r_void
id|do_pcd_read_drq
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
op_assign
id|pcd_unit
suffix:semicolon
r_int
id|saved_flags
suffix:semicolon
r_if
c_cond
(paren
id|pcd_completion
c_func
(paren
id|unit
comma
id|pcd_buffer
comma
l_string|&quot;read block&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|pcd_retries
OL
id|PCD_RETRIES
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pcd_retries
op_increment
suffix:semicolon
id|pi_do_claimed
c_func
(paren
id|PI
comma
id|pcd_start
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|pcd_busy
op_assign
l_int|0
suffix:semicolon
id|pcd_bufblk
op_assign
op_minus
l_int|1
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|do_pcd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|do_pcd_read
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|do_pcd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
)brace
multiline_comment|/* the audio_ioctl stuff is adapted from sr_ioctl.c */
DECL|function|pcd_audio_ioctl
r_static
r_int
id|pcd_audio_ioctl
c_func
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CDROMREADTOCHDR
suffix:colon
(brace
r_char
id|cmd
(braket
l_int|12
)braket
op_assign
initialization_block
suffix:semicolon
r_struct
id|cdrom_tochdr
op_star
id|tochdr
op_assign
(paren
r_struct
id|cdrom_tochdr
op_star
)paren
id|arg
suffix:semicolon
r_char
id|buffer
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|r
suffix:semicolon
id|r
op_assign
id|pcd_atapi
c_func
(paren
id|unit
comma
id|cmd
comma
l_int|12
comma
id|buffer
comma
l_string|&quot;read toc header&quot;
)paren
suffix:semicolon
id|tochdr-&gt;cdth_trk0
op_assign
id|buffer
(braket
l_int|2
)braket
suffix:semicolon
id|tochdr-&gt;cdth_trk1
op_assign
id|buffer
(braket
l_int|3
)braket
suffix:semicolon
r_return
id|r
op_star
id|EIO
suffix:semicolon
)brace
r_case
id|CDROMREADTOCENTRY
suffix:colon
(brace
r_char
id|cmd
(braket
l_int|12
)braket
op_assign
initialization_block
suffix:semicolon
r_struct
id|cdrom_tocentry
op_star
id|tocentry
op_assign
(paren
r_struct
id|cdrom_tocentry
op_star
)paren
id|arg
suffix:semicolon
r_int
r_char
id|buffer
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|r
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
(paren
id|tocentry-&gt;cdte_format
op_eq
id|CDROM_MSF
ques
c_cond
l_int|0x02
suffix:colon
l_int|0
)paren
suffix:semicolon
id|cmd
(braket
l_int|6
)braket
op_assign
id|tocentry-&gt;cdte_track
suffix:semicolon
id|r
op_assign
id|pcd_atapi
c_func
(paren
id|unit
comma
id|cmd
comma
l_int|12
comma
id|buffer
comma
l_string|&quot;read toc entry&quot;
)paren
suffix:semicolon
id|tocentry-&gt;cdte_ctrl
op_assign
id|buffer
(braket
l_int|5
)braket
op_amp
l_int|0xf
suffix:semicolon
id|tocentry-&gt;cdte_adr
op_assign
id|buffer
(braket
l_int|5
)braket
op_rshift
l_int|4
suffix:semicolon
id|tocentry-&gt;cdte_datamode
op_assign
(paren
id|tocentry-&gt;cdte_ctrl
op_amp
l_int|0x04
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tocentry-&gt;cdte_format
op_eq
id|CDROM_MSF
)paren
(brace
id|tocentry-&gt;cdte_addr.msf.minute
op_assign
id|buffer
(braket
l_int|9
)braket
suffix:semicolon
id|tocentry-&gt;cdte_addr.msf.second
op_assign
id|buffer
(braket
l_int|10
)braket
suffix:semicolon
id|tocentry-&gt;cdte_addr.msf.frame
op_assign
id|buffer
(braket
l_int|11
)braket
suffix:semicolon
)brace
r_else
id|tocentry-&gt;cdte_addr.lba
op_assign
(paren
(paren
(paren
(paren
(paren
id|buffer
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_plus
id|buffer
(braket
l_int|9
)braket
)paren
op_lshift
l_int|8
)paren
op_plus
id|buffer
(braket
l_int|10
)braket
)paren
op_lshift
l_int|8
)paren
op_plus
id|buffer
(braket
l_int|11
)braket
suffix:semicolon
r_return
id|r
op_star
id|EIO
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
)brace
DECL|function|pcd_get_mcn
r_static
r_int
id|pcd_get_mcn
(paren
r_struct
id|cdrom_device_info
op_star
id|cdi
comma
r_struct
id|cdrom_mcn
op_star
id|mcn
)paren
(brace
r_char
id|cmd
(braket
l_int|12
)braket
op_assign
initialization_block
suffix:semicolon
r_char
id|buffer
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|k
suffix:semicolon
r_int
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|cdi-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcd_atapi
c_func
(paren
id|unit
comma
id|cmd
comma
l_int|24
comma
id|buffer
comma
l_string|&quot;get mcn&quot;
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|13
suffix:semicolon
id|k
op_increment
)paren
id|mcn-&gt;medium_catalog_number
(braket
id|k
)braket
op_assign
id|buffer
(braket
id|k
op_plus
l_int|9
)braket
suffix:semicolon
id|mcn-&gt;medium_catalog_number
(braket
l_int|13
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end of pcd.c */
eof
