multiline_comment|/* &n;        pd.c    (c) 1997-8  Grant R. Guenther &lt;grant@torque.net&gt;&n;                            Under the terms of the GNU public license.&n;&n;        This is the high-level driver for parallel port IDE hard&n;        drives based on chips supported by the paride module.&n;&n;&t;By default, the driver will autoprobe for a single parallel&n;&t;port IDE drive, but if their individual parameters are&n;        specified, the driver can handle up to 4 drives.&n;&n;        The behaviour of the pd driver can be altered by setting&n;        some parameters from the insmod command line.  The following&n;        parameters are adjustable:&n; &n;&t;    drive0  &t;These four arguments can be arrays of&t;    &n;&t;    drive1&t;1-8 integers as follows:&n;&t;    drive2&n;&t;    drive3&t;&lt;prt&gt;,&lt;pro&gt;,&lt;uni&gt;,&lt;mod&gt;,&lt;geo&gt;,&lt;sby&gt;,&lt;dly&gt;,&lt;slv&gt;&n;&n;&t;&t;&t;Where,&n;&n;&t;&t;&lt;prt&gt;&t;is the base of the parallel port address for&n;&t;&t;&t;the corresponding drive.  (required)&n;&n;&t;&t;&lt;pro&gt;   is the protocol number for the adapter that&n;&t;&t;&t;supports this drive.  These numbers are&n;                        logged by &squot;paride&squot; when the protocol modules&n;&t;&t;&t;are initialised.  (0 if not given)&n;&n;&t;&t;&lt;uni&gt;   for those adapters that support chained&n;&t;&t;&t;devices, this is the unit selector for the&n;&t;&t;        chain of devices on the given port.  It should&n;&t;&t;&t;be zero for devices that don&squot;t support chaining.&n;&t;&t;&t;(0 if not given)&n;&n;&t;&t;&lt;mod&gt;   this can be -1 to choose the best mode, or one&n;&t;&t;        of the mode numbers supported by the adapter.&n;&t;&t;&t;(-1 if not given)&n;&n;&t;&t;&lt;geo&gt;   this defaults to 0 to indicate that the driver&n;&t;&t;&t;should use the CHS geometry provided by the drive&n;&t;&t;&t;itself.  If set to 1, the driver will provide&n;&t;&t;&t;a logical geometry with 64 heads and 32 sectors&n;&t;&t;&t;per track, to be consistent with most SCSI&n;&t;&t;        drivers.  (0 if not given)&n;&n;&t;&t;&lt;sby&gt;   set this to zero to disable the power saving&n;&t;&t;&t;standby mode, if needed.  (1 if not given)&n;&n;&t;&t;&lt;dly&gt;   some parallel ports require the driver to &n;&t;&t;&t;go more slowly.  -1 sets a default value that&n;&t;&t;&t;should work with the chosen protocol.  Otherwise,&n;&t;&t;&t;set this to a small integer, the larger it is&n;&t;&t;&t;the slower the port i/o.  In some cases, setting&n;&t;&t;&t;this to zero will speed up the device. (default -1)&n;&n;&t;&t;&lt;slv&gt;   IDE disks can be jumpered to master or slave.&n;                        Set this to 0 to choose the master drive, 1 to&n;                        choose the slave, -1 (the default) to choose the&n;                        first drive found.&n;&t;&t;&t;&n;&n;            major       You may use this parameter to overide the&n;                        default major number (45) that this driver&n;                        will use.  Be sure to change the device&n;                        name as well.&n;&n;            name        This parameter is a character string that&n;                        contains the name the kernel will use for this&n;                        device (in /proc output, for instance).&n;&t;&t;&t;(default &quot;pd&quot;)&n;&n;&t;    cluster&t;The driver will attempt to aggregate requests&n;&t;&t;&t;for adjacent blocks into larger multi-block&n;&t;&t;&t;clusters.  The maximum cluster size (in 512&n;&t;&t;&t;byte sectors) is set with this parameter.&n;&t;&t;&t;(default 64)&n;&n;&t;    verbose&t;This parameter controls the amount of logging&n;&t;&t;&t;that the driver will do.  Set it to 0 for &n;&t;&t;&t;normal operation, 1 to see autoprobe progress&n;&t;&t;&t;messages, or 2 to see additional debugging&n;&t;&t;&t;output.  (default 0)&n;&n;            nice        This parameter controls the driver&squot;s use of&n;                        idle CPU time, at the expense of some speed.&n;&n;        If this driver is built into the kernel, you can use kernel&n;        the following command line parameters, with the same values&n;        as the corresponding module parameters listed above:&n;&n;            pd.drive0&n;            pd.drive1&n;            pd.drive2&n;            pd.drive3&n;            pd.cluster&n;            pd.nice&n;&n;        In addition, you can use the parameter pd.disable to disable&n;        the driver entirely.&n; &n;*/
multiline_comment|/* Changes:&n;&n;&t;1.01&t;GRG 1997.01.24&t;Restored pd_reset()&n;&t;&t;&t;&t;Added eject ioctl&n;&t;1.02    GRG 1998.05.06  SMP spinlock changes, &n;&t;&t;&t;&t;Added slave support&n;&t;1.03    GRG 1998.06.16  Eliminate an Ugh.&n;&t;1.04&t;GRG 1998.08.15  Extra debugging, use HZ in loop timing&n;&t;1.05    GRG 1998.09.24  Added jumbo support&n;&n;*/
DECL|macro|PD_VERSION
mdefine_line|#define PD_VERSION      &quot;1.05&quot;
DECL|macro|PD_MAJOR
mdefine_line|#define PD_MAJOR&t;45
DECL|macro|PD_NAME
mdefine_line|#define PD_NAME&t;&t;&quot;pd&quot;
DECL|macro|PD_UNITS
mdefine_line|#define PD_UNITS&t;4
multiline_comment|/* Here are things one can override from the insmod command.&n;   Most are autoprobed by paride unless set here.  Verbose is off&n;   by default.&n;&n;*/
DECL|variable|verbose
r_static
r_int
id|verbose
op_assign
l_int|0
suffix:semicolon
DECL|variable|major
r_static
r_int
id|major
op_assign
id|PD_MAJOR
suffix:semicolon
DECL|variable|name
r_static
r_char
op_star
id|name
op_assign
id|PD_NAME
suffix:semicolon
DECL|variable|cluster
r_static
r_int
id|cluster
op_assign
l_int|64
suffix:semicolon
DECL|variable|nice
r_static
r_int
id|nice
op_assign
l_int|0
suffix:semicolon
DECL|variable|disable
r_static
r_int
id|disable
op_assign
l_int|0
suffix:semicolon
DECL|variable|drive0
r_static
r_int
id|drive0
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drive1
r_static
r_int
id|drive1
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drive2
r_static
r_int
id|drive2
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drive3
r_static
r_int
id|drive3
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drives
r_static
r_int
(paren
op_star
id|drives
(braket
l_int|4
)braket
)paren
(braket
l_int|8
)braket
op_assign
(brace
op_amp
id|drive0
comma
op_amp
id|drive1
comma
op_amp
id|drive2
comma
op_amp
id|drive3
)brace
suffix:semicolon
DECL|variable|pd_drive_count
r_static
r_int
id|pd_drive_count
suffix:semicolon
DECL|macro|D_PRT
mdefine_line|#define D_PRT&t;0
DECL|macro|D_PRO
mdefine_line|#define D_PRO   1
DECL|macro|D_UNI
mdefine_line|#define D_UNI&t;2
DECL|macro|D_MOD
mdefine_line|#define D_MOD&t;3
DECL|macro|D_GEO
mdefine_line|#define D_GEO&t;4
DECL|macro|D_SBY
mdefine_line|#define D_SBY&t;5
DECL|macro|D_DLY
mdefine_line|#define D_DLY&t;6
DECL|macro|D_SLV
mdefine_line|#define D_SLV   7
DECL|macro|DU
mdefine_line|#define&t;DU&t;&t;(*drives[unit])
multiline_comment|/* end of parameters */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/cdrom.h&gt;&t;/* for the eject ioctl */
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#ifndef MODULE
macro_line|#include &quot;setup.h&quot;
DECL|variable|pd_stt
r_static
id|STT
id|pd_stt
(braket
l_int|7
)braket
op_assign
(brace
(brace
l_string|&quot;drive0&quot;
comma
l_int|8
comma
id|drive0
)brace
comma
(brace
l_string|&quot;drive1&quot;
comma
l_int|8
comma
id|drive1
)brace
comma
(brace
l_string|&quot;drive2&quot;
comma
l_int|8
comma
id|drive2
)brace
comma
(brace
l_string|&quot;drive3&quot;
comma
l_int|8
comma
id|drive3
)brace
comma
(brace
l_string|&quot;disable&quot;
comma
l_int|1
comma
op_amp
id|disable
)brace
comma
(brace
l_string|&quot;cluster&quot;
comma
l_int|1
comma
op_amp
id|cluster
)brace
comma
(brace
l_string|&quot;nice&quot;
comma
l_int|1
comma
op_amp
id|nice
)brace
)brace
suffix:semicolon
DECL|function|pd_setup
r_void
id|pd_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
id|generic_setup
c_func
(paren
id|pd_stt
comma
l_int|7
comma
id|str
)paren
suffix:semicolon
)brace
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|verbose
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|major
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|name
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cluster
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|nice
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|drive0
comma
l_string|&quot;1-8i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|drive1
comma
l_string|&quot;1-8i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|drive2
comma
l_string|&quot;1-8i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|drive3
comma
l_string|&quot;1-8i&quot;
)paren
suffix:semicolon
macro_line|#include &quot;paride.h&quot;
DECL|macro|PD_BITS
mdefine_line|#define PD_BITS    4
multiline_comment|/* set up defines for blk.h,  why don&squot;t all drivers do it this way ? */
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR   major
DECL|macro|DEVICE_NAME
mdefine_line|#define DEVICE_NAME &quot;PD&quot;
DECL|macro|DEVICE_REQUEST
mdefine_line|#define DEVICE_REQUEST do_pd_request
DECL|macro|DEVICE_NR
mdefine_line|#define DEVICE_NR(device) (MINOR(device)&gt;&gt;PD_BITS)
DECL|macro|DEVICE_ON
mdefine_line|#define DEVICE_ON(device)
DECL|macro|DEVICE_OFF
mdefine_line|#define DEVICE_OFF(device)
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &quot;pseudo.h&quot;
DECL|macro|PD_PARTNS
mdefine_line|#define PD_PARTNS  &t;(1&lt;&lt;PD_BITS)
DECL|macro|PD_DEVS
mdefine_line|#define PD_DEVS&t;&t;PD_PARTNS*PD_UNITS
multiline_comment|/* numbers for &quot;SCSI&quot; geometry */
DECL|macro|PD_LOG_HEADS
mdefine_line|#define PD_LOG_HEADS    64
DECL|macro|PD_LOG_SECTS
mdefine_line|#define PD_LOG_SECTS    32
DECL|macro|PD_ID_OFF
mdefine_line|#define PD_ID_OFF       54
DECL|macro|PD_ID_LEN
mdefine_line|#define PD_ID_LEN       14
DECL|macro|PD_MAX_RETRIES
mdefine_line|#define PD_MAX_RETRIES  5
DECL|macro|PD_TMO
mdefine_line|#define PD_TMO          800             /* interrupt timeout in jiffies */
DECL|macro|PD_SPIN_DEL
mdefine_line|#define PD_SPIN_DEL     50              /* spin delay in micro-seconds  */
DECL|macro|PD_SPIN
mdefine_line|#define PD_SPIN         (1000000*PD_TMO)/(HZ*PD_SPIN_DEL)  
DECL|macro|STAT_ERR
mdefine_line|#define STAT_ERR        0x00001
DECL|macro|STAT_INDEX
mdefine_line|#define STAT_INDEX      0x00002
DECL|macro|STAT_ECC
mdefine_line|#define STAT_ECC        0x00004
DECL|macro|STAT_DRQ
mdefine_line|#define STAT_DRQ        0x00008
DECL|macro|STAT_SEEK
mdefine_line|#define STAT_SEEK       0x00010
DECL|macro|STAT_WRERR
mdefine_line|#define STAT_WRERR      0x00020
DECL|macro|STAT_READY
mdefine_line|#define STAT_READY      0x00040
DECL|macro|STAT_BUSY
mdefine_line|#define STAT_BUSY       0x00080
DECL|macro|ERR_AMNF
mdefine_line|#define ERR_AMNF        0x00100
DECL|macro|ERR_TK0NF
mdefine_line|#define ERR_TK0NF       0x00200
DECL|macro|ERR_ABRT
mdefine_line|#define ERR_ABRT        0x00400
DECL|macro|ERR_MCR
mdefine_line|#define ERR_MCR         0x00800
DECL|macro|ERR_IDNF
mdefine_line|#define ERR_IDNF        0x01000
DECL|macro|ERR_MC
mdefine_line|#define ERR_MC          0x02000
DECL|macro|ERR_UNC
mdefine_line|#define ERR_UNC         0x04000
DECL|macro|ERR_TMO
mdefine_line|#define ERR_TMO         0x10000
DECL|macro|IDE_READ
mdefine_line|#define IDE_READ        &t;0x20
DECL|macro|IDE_WRITE
mdefine_line|#define IDE_WRITE       &t;0x30
DECL|macro|IDE_READ_VRFY
mdefine_line|#define IDE_READ_VRFY&t;&t;0x40
DECL|macro|IDE_INIT_DEV_PARMS
mdefine_line|#define IDE_INIT_DEV_PARMS&t;0x91
DECL|macro|IDE_STANDBY
mdefine_line|#define IDE_STANDBY     &t;0x96
DECL|macro|IDE_ACKCHANGE
mdefine_line|#define IDE_ACKCHANGE   &t;0xdb
DECL|macro|IDE_DOORLOCK
mdefine_line|#define IDE_DOORLOCK    &t;0xde
DECL|macro|IDE_DOORUNLOCK
mdefine_line|#define IDE_DOORUNLOCK  &t;0xdf
DECL|macro|IDE_IDENTIFY
mdefine_line|#define IDE_IDENTIFY    &t;0xec
DECL|macro|IDE_EJECT
mdefine_line|#define IDE_EJECT&t;&t;0xed
r_int
id|pd_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|pd_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|pd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_void
id|do_pd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
suffix:semicolon
r_static
r_int
id|pd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|pd_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|pd_revalidate
c_func
(paren
id|kdev_t
id|dev
)paren
suffix:semicolon
r_static
r_int
id|pd_detect
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_pd_read
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_pd_read_start
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_pd_write
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_pd_write_start
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_pd_read_drq
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_pd_write_done
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|pd_identify
(paren
r_int
id|unit
)paren
suffix:semicolon
r_static
r_void
id|pd_media_check
c_func
(paren
r_int
id|unit
)paren
suffix:semicolon
r_static
r_void
id|pd_doorlock
c_func
(paren
r_int
id|unit
comma
r_int
id|func
)paren
suffix:semicolon
r_static
r_int
id|pd_check_media
c_func
(paren
id|kdev_t
id|dev
)paren
suffix:semicolon
r_static
r_void
id|pd_eject
c_func
(paren
r_int
id|unit
)paren
suffix:semicolon
DECL|variable|pd_hd
r_static
r_struct
id|hd_struct
id|pd_hd
(braket
id|PD_DEVS
)braket
suffix:semicolon
DECL|variable|pd_sizes
r_static
r_int
id|pd_sizes
(braket
id|PD_DEVS
)braket
suffix:semicolon
DECL|variable|pd_blocksizes
r_static
r_int
id|pd_blocksizes
(braket
id|PD_DEVS
)braket
suffix:semicolon
DECL|macro|PD_NAMELEN
mdefine_line|#define PD_NAMELEN&t;8
DECL|struct|pd_unit
r_struct
id|pd_unit
(brace
DECL|member|pia
r_struct
id|pi_adapter
id|pia
suffix:semicolon
multiline_comment|/* interface to paride layer */
DECL|member|pi
r_struct
id|pi_adapter
op_star
id|pi
suffix:semicolon
DECL|member|access
r_int
id|access
suffix:semicolon
multiline_comment|/* count of active opens ... */
DECL|member|capacity
r_int
id|capacity
suffix:semicolon
multiline_comment|/* Size of this volume in sectors */
DECL|member|heads
r_int
id|heads
suffix:semicolon
multiline_comment|/* physical geometry */
DECL|member|sectors
r_int
id|sectors
suffix:semicolon
DECL|member|cylinders
r_int
id|cylinders
suffix:semicolon
DECL|member|drive
r_int
id|drive
suffix:semicolon
multiline_comment|/* master=0 slave=1 */
DECL|member|changed
r_int
id|changed
suffix:semicolon
multiline_comment|/* Have we seen a disk change ? */
DECL|member|removable
r_int
id|removable
suffix:semicolon
multiline_comment|/* removable media device  ?  */
DECL|member|standby
r_int
id|standby
suffix:semicolon
DECL|member|alt_geom
r_int
id|alt_geom
suffix:semicolon
DECL|member|present
r_int
id|present
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
id|PD_NAMELEN
)braket
suffix:semicolon
multiline_comment|/* pda, pdb, etc ... */
)brace
suffix:semicolon
DECL|variable|pd
r_struct
id|pd_unit
id|pd
(braket
id|PD_UNITS
)braket
suffix:semicolon
multiline_comment|/*  &squot;unit&squot; must be defined in all functions - either as a local or a param */
DECL|macro|PD
mdefine_line|#define PD pd[unit]
DECL|macro|PI
mdefine_line|#define PI PD.pi
DECL|variable|pd_valid
r_static
r_int
id|pd_valid
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* serialise partition checks */
DECL|variable|pd_scratch
r_static
r_char
id|pd_scratch
(braket
l_int|512
)braket
suffix:semicolon
multiline_comment|/* scratch block buffer */
multiline_comment|/* the variables below are used mainly in the I/O request engine, which&n;   processes only one request at a time.&n;*/
DECL|variable|pd_retries
r_static
r_int
id|pd_retries
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* i/o error retry count */
DECL|variable|pd_busy
r_static
r_int
id|pd_busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* request being processed ? */
DECL|variable|pd_block
r_static
r_int
id|pd_block
suffix:semicolon
multiline_comment|/* address of next requested block */
DECL|variable|pd_count
r_static
r_int
id|pd_count
suffix:semicolon
multiline_comment|/* number of blocks still to do */
DECL|variable|pd_run
r_static
r_int
id|pd_run
suffix:semicolon
multiline_comment|/* sectors in current cluster */
DECL|variable|pd_cmd
r_static
r_int
id|pd_cmd
suffix:semicolon
multiline_comment|/* current command READ/WRITE */
DECL|variable|pd_unit
r_static
r_int
id|pd_unit
suffix:semicolon
multiline_comment|/* unit of current request */
DECL|variable|pd_dev
r_static
r_int
id|pd_dev
suffix:semicolon
multiline_comment|/* minor of current request */
DECL|variable|pd_poffs
r_static
r_int
id|pd_poffs
suffix:semicolon
multiline_comment|/* partition offset of current minor */
DECL|variable|pd_buf
r_static
r_char
op_star
id|pd_buf
suffix:semicolon
multiline_comment|/* buffer for request in progress */
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|pd_wait_open
)paren
suffix:semicolon
DECL|variable|pd_errs
r_static
r_char
op_star
id|pd_errs
(braket
l_int|17
)braket
op_assign
(brace
l_string|&quot;ERR&quot;
comma
l_string|&quot;INDEX&quot;
comma
l_string|&quot;ECC&quot;
comma
l_string|&quot;DRQ&quot;
comma
l_string|&quot;SEEK&quot;
comma
l_string|&quot;WRERR&quot;
comma
l_string|&quot;READY&quot;
comma
l_string|&quot;BUSY&quot;
comma
l_string|&quot;AMNF&quot;
comma
l_string|&quot;TK0NF&quot;
comma
l_string|&quot;ABRT&quot;
comma
l_string|&quot;MCR&quot;
comma
l_string|&quot;IDNF&quot;
comma
l_string|&quot;MC&quot;
comma
l_string|&quot;UNC&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;TMO&quot;
)brace
suffix:semicolon
multiline_comment|/* kernel glue structures */
r_extern
r_struct
id|block_device_operations
id|pd_fops
suffix:semicolon
DECL|variable|pd_gendisk
r_static
r_struct
id|gendisk
id|pd_gendisk
op_assign
(brace
id|PD_MAJOR
comma
multiline_comment|/* Major number */
id|PD_NAME
comma
multiline_comment|/* Major name */
id|PD_BITS
comma
multiline_comment|/* Bits to shift to get real from partition */
id|PD_PARTNS
comma
multiline_comment|/* Number of partitions per real */
id|pd_hd
comma
multiline_comment|/* hd struct */
id|pd_sizes
comma
multiline_comment|/* block sizes */
l_int|0
comma
multiline_comment|/* number */
l_int|NULL
comma
multiline_comment|/* internal */
l_int|NULL
comma
multiline_comment|/* next */
op_amp
id|pd_fops
comma
multiline_comment|/* block device operations */
)brace
suffix:semicolon
DECL|variable|pd_fops
r_static
r_struct
id|block_device_operations
id|pd_fops
op_assign
(brace
id|open
suffix:colon
id|pd_open
comma
id|release
suffix:colon
id|pd_release
comma
id|ioctl
suffix:colon
id|pd_ioctl
comma
id|check_media_change
suffix:colon
id|pd_check_media
comma
id|revalidate
suffix:colon
id|pd_revalidate
)brace
suffix:semicolon
DECL|function|pd_init_units
r_void
id|pd_init_units
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
comma
id|j
suffix:semicolon
id|pd_drive_count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
(brace
id|PD.pi
op_assign
op_amp
id|PD.pia
suffix:semicolon
id|PD.access
op_assign
l_int|0
suffix:semicolon
id|PD.changed
op_assign
l_int|1
suffix:semicolon
id|PD.capacity
op_assign
l_int|0
suffix:semicolon
id|PD.drive
op_assign
id|DU
(braket
id|D_SLV
)braket
suffix:semicolon
id|PD.present
op_assign
l_int|0
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|j
OL
id|PD_NAMELEN
op_minus
l_int|2
)paren
op_logical_and
(paren
id|PD.name
(braket
id|j
)braket
op_assign
id|name
(braket
id|j
)braket
)paren
)paren
id|j
op_increment
suffix:semicolon
id|PD.name
(braket
id|j
op_increment
)braket
op_assign
l_char|&squot;a&squot;
op_plus
id|unit
suffix:semicolon
id|PD.name
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|PD.alt_geom
op_assign
id|DU
(braket
id|D_GEO
)braket
suffix:semicolon
id|PD.standby
op_assign
id|DU
(braket
id|D_SBY
)braket
suffix:semicolon
r_if
c_cond
(paren
id|DU
(braket
id|D_PRT
)braket
)paren
id|pd_drive_count
op_increment
suffix:semicolon
)brace
)brace
DECL|function|pd_new_segment
r_static
r_inline
r_int
id|pd_new_segment
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|req
comma
r_int
id|max_segments
)paren
(brace
r_if
c_cond
(paren
id|max_segments
OG
id|cluster
)paren
id|max_segments
op_assign
id|cluster
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;nr_segments
OL
id|max_segments
)paren
(brace
id|req-&gt;nr_segments
op_increment
suffix:semicolon
id|q-&gt;elevator.nr_segments
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd_back_merge_fn
r_static
r_int
id|pd_back_merge_fn
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|req
comma
r_struct
id|buffer_head
op_star
id|bh
comma
r_int
id|max_segments
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;bhtail-&gt;b_data
op_plus
id|req-&gt;bhtail-&gt;b_size
op_eq
id|bh-&gt;b_data
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|pd_new_segment
c_func
(paren
id|q
comma
id|req
comma
id|max_segments
)paren
suffix:semicolon
)brace
DECL|function|pd_front_merge_fn
r_static
r_int
id|pd_front_merge_fn
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|req
comma
r_struct
id|buffer_head
op_star
id|bh
comma
r_int
id|max_segments
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_data
op_plus
id|bh-&gt;b_size
op_eq
id|req-&gt;bh-&gt;b_data
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|pd_new_segment
c_func
(paren
id|q
comma
id|req
comma
id|max_segments
)paren
suffix:semicolon
)brace
DECL|function|pd_merge_requests_fn
r_static
r_int
id|pd_merge_requests_fn
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|req
comma
r_struct
id|request
op_star
id|next
comma
r_int
id|max_segments
)paren
(brace
r_int
id|total_segments
op_assign
id|req-&gt;nr_segments
op_plus
id|next-&gt;nr_segments
suffix:semicolon
r_int
id|same_segment
suffix:semicolon
r_if
c_cond
(paren
id|max_segments
OG
id|cluster
)paren
id|max_segments
op_assign
id|cluster
suffix:semicolon
id|same_segment
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;bhtail-&gt;b_data
op_plus
id|req-&gt;bhtail-&gt;b_size
op_eq
id|next-&gt;bh-&gt;b_data
)paren
(brace
id|total_segments
op_decrement
suffix:semicolon
id|same_segment
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|total_segments
OG
id|max_segments
)paren
r_return
l_int|0
suffix:semicolon
id|q-&gt;elevator.nr_segments
op_sub_assign
id|same_segment
suffix:semicolon
id|req-&gt;nr_segments
op_assign
id|total_segments
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pd_init
r_int
id|pd_init
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|request_queue_t
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|disable
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|devfs_register_blkdev
c_func
(paren
id|MAJOR_NR
comma
id|name
comma
op_amp
id|pd_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to get major number %d&bslash;n&quot;
comma
id|name
comma
id|major
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|q
op_assign
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
suffix:semicolon
id|blk_init_queue
c_func
(paren
id|q
comma
id|DEVICE_REQUEST
)paren
suffix:semicolon
id|q-&gt;back_merge_fn
op_assign
id|pd_back_merge_fn
suffix:semicolon
id|q-&gt;front_merge_fn
op_assign
id|pd_front_merge_fn
suffix:semicolon
id|q-&gt;merge_requests_fn
op_assign
id|pd_merge_requests_fn
suffix:semicolon
id|read_ahead
(braket
id|MAJOR_NR
)braket
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 8 sector (4kB) read ahead */
id|pd_gendisk.major
op_assign
id|major
suffix:semicolon
id|pd_gendisk.major_name
op_assign
id|name
suffix:semicolon
id|pd_gendisk.next
op_assign
id|gendisk_head
suffix:semicolon
id|gendisk_head
op_assign
op_amp
id|pd_gendisk
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PD_DEVS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pd_blocksizes
(braket
id|i
)braket
op_assign
l_int|1024
suffix:semicolon
)brace
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|pd_blocksizes
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s version %s, major %d, cluster %d, nice %d&bslash;n&quot;
comma
id|name
comma
id|name
comma
id|PD_VERSION
comma
id|major
comma
id|cluster
comma
id|nice
)paren
suffix:semicolon
id|pd_init_units
c_func
(paren
)paren
suffix:semicolon
id|pd_valid
op_assign
l_int|0
suffix:semicolon
id|pd_gendisk.nr_real
op_assign
id|pd_detect
c_func
(paren
)paren
suffix:semicolon
id|pd_valid
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef MODULE
r_if
c_cond
(paren
op_logical_neg
id|pd_gendisk.nr_real
)paren
(brace
id|cleanup_module
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd_open
r_static
r_int
id|pd_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|unit
op_ge
id|PD_UNITS
)paren
op_logical_or
(paren
op_logical_neg
id|PD.present
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|wait_event
(paren
id|pd_wait_open
comma
id|pd_valid
)paren
suffix:semicolon
id|PD.access
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|PD.removable
)paren
(brace
id|pd_media_check
c_func
(paren
id|unit
)paren
suffix:semicolon
id|pd_doorlock
c_func
(paren
id|unit
comma
id|IDE_DOORLOCK
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd_ioctl
r_static
r_int
id|pd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|hd_geometry
op_star
id|geo
op_assign
(paren
r_struct
id|hd_geometry
op_star
)paren
id|arg
suffix:semicolon
r_int
id|dev
comma
id|err
comma
id|unit
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|inode
)paren
op_logical_or
(paren
op_logical_neg
id|inode-&gt;i_rdev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|PD_DEVS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PD.present
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CDROMEJECT
suffix:colon
r_if
c_cond
(paren
id|PD.access
op_eq
l_int|1
)paren
id|pd_eject
c_func
(paren
id|unit
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GETGEO
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|geo
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|geo
comma
r_sizeof
(paren
op_star
id|geo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|PD.alt_geom
)paren
(brace
id|put_user
c_func
(paren
id|PD.capacity
op_div
(paren
id|PD_LOG_HEADS
op_star
id|PD_LOG_SECTS
)paren
comma
(paren
r_int
op_star
)paren
op_amp
id|geo-&gt;cylinders
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|PD_LOG_HEADS
comma
(paren
r_char
op_star
)paren
op_amp
id|geo-&gt;heads
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|PD_LOG_SECTS
comma
(paren
r_char
op_star
)paren
op_amp
id|geo-&gt;sectors
)paren
suffix:semicolon
)brace
r_else
(brace
id|put_user
c_func
(paren
id|PD.cylinders
comma
(paren
r_int
op_star
)paren
op_amp
id|geo-&gt;cylinders
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|PD.heads
comma
(paren
r_char
op_star
)paren
op_amp
id|geo-&gt;heads
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|PD.sectors
comma
(paren
r_char
op_star
)paren
op_amp
id|geo-&gt;sectors
)paren
suffix:semicolon
)brace
id|put_user
c_func
(paren
id|pd_hd
(braket
id|dev
)braket
dot
id|start_sect
comma
(paren
r_int
op_star
)paren
op_amp
id|geo-&gt;start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|BLKGETSIZE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
(paren
id|err
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|pd_hd
(braket
id|dev
)braket
dot
id|nr_sects
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|BLKRRPART
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_return
id|pd_revalidate
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_case
id|BLKROSET
suffix:colon
r_case
id|BLKROGET
suffix:colon
r_case
id|BLKRASET
suffix:colon
r_case
id|BLKRAGET
suffix:colon
r_case
id|BLKFLSBUF
suffix:colon
r_case
id|BLKPG
suffix:colon
r_return
id|blk_ioctl
c_func
(paren
id|inode-&gt;i_rdev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|pd_release
r_static
r_int
id|pd_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|kdev_t
id|devp
suffix:semicolon
r_int
id|unit
suffix:semicolon
id|devp
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|devp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|unit
op_ge
id|PD_UNITS
)paren
op_logical_or
(paren
id|PD.access
op_le
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|PD.access
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PD.access
op_logical_and
id|PD.removable
)paren
id|pd_doorlock
c_func
(paren
id|unit
comma
id|IDE_DOORUNLOCK
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd_check_media
r_static
r_int
id|pd_check_media
c_func
(paren
id|kdev_t
id|dev
)paren
(brace
r_int
id|r
comma
id|unit
suffix:semicolon
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|unit
op_ge
id|PD_UNITS
)paren
op_logical_or
(paren
op_logical_neg
id|PD.present
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PD.removable
)paren
r_return
l_int|0
suffix:semicolon
id|pd_media_check
c_func
(paren
id|unit
)paren
suffix:semicolon
id|r
op_assign
id|PD.changed
suffix:semicolon
id|PD.changed
op_assign
l_int|0
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|pd_revalidate
r_static
r_int
id|pd_revalidate
c_func
(paren
id|kdev_t
id|dev
)paren
(brace
r_int
id|p
comma
id|unit
comma
id|minor
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|kdev_t
id|devp
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|unit
op_ge
id|PD_UNITS
)paren
op_logical_or
(paren
op_logical_neg
id|PD.present
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PD.access
OG
l_int|1
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|pd_valid
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
(paren
id|PD_PARTNS
op_minus
l_int|1
)paren
suffix:semicolon
id|p
op_ge
l_int|0
suffix:semicolon
id|p
op_decrement
)paren
(brace
id|minor
op_assign
id|p
op_plus
id|unit
op_star
id|PD_PARTNS
suffix:semicolon
id|devp
op_assign
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|minor
)paren
suffix:semicolon
id|fsync_dev
c_func
(paren
id|devp
)paren
suffix:semicolon
id|sb
op_assign
id|get_super
c_func
(paren
id|devp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb
)paren
id|invalidate_inodes
c_func
(paren
id|sb
)paren
suffix:semicolon
id|invalidate_buffers
c_func
(paren
id|devp
)paren
suffix:semicolon
id|pd_hd
(braket
id|minor
)braket
dot
id|start_sect
op_assign
l_int|0
suffix:semicolon
id|pd_hd
(braket
id|minor
)braket
dot
id|nr_sects
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pd_identify
c_func
(paren
id|unit
)paren
)paren
id|grok_partitions
c_func
(paren
op_amp
id|pd_gendisk
comma
id|unit
comma
l_int|1
op_lshift
id|PD_BITS
comma
id|PD.capacity
)paren
suffix:semicolon
id|pd_valid
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|pd_wait_open
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* Glue for modules ... */
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef PARIDE_JUMBO
(brace
r_extern
id|paride_init
c_func
(paren
)paren
suffix:semicolon
id|paride_init
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|pd_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|gendisk
op_star
op_star
id|gdp
suffix:semicolon
r_int
id|unit
suffix:semicolon
id|devfs_unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
id|name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|gdp
op_assign
op_amp
id|gendisk_head
suffix:semicolon
op_star
id|gdp
suffix:semicolon
id|gdp
op_assign
op_amp
(paren
(paren
op_star
id|gdp
)paren
op_member_access_from_pointer
id|next
)paren
)paren
r_if
c_cond
(paren
op_star
id|gdp
op_eq
op_amp
id|pd_gendisk
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|gdp
)paren
op_star
id|gdp
op_assign
(paren
op_star
id|gdp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
r_if
c_cond
(paren
id|PD.present
)paren
id|pi_release
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|macro|WR
mdefine_line|#define&t;WR(c,r,v)&t;pi_write_regr(PI,c,r,v)
DECL|macro|RR
mdefine_line|#define&t;RR(c,r)&t;&t;(pi_read_regr(PI,c,r))
DECL|macro|DRIVE
mdefine_line|#define DRIVE&t;&t;(0xa0+0x10*PD.drive)
multiline_comment|/*  ide command interface */
DECL|function|pd_print_error
r_static
r_void
id|pd_print_error
c_func
(paren
r_int
id|unit
comma
r_char
op_star
id|msg
comma
r_int
id|status
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s: status = 0x%x =&quot;
comma
id|PD.name
comma
id|msg
comma
id|status
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; %s&quot;
comma
id|pd_errs
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|pd_reset
r_static
r_void
id|pd_reset
c_func
(paren
r_int
id|unit
)paren
multiline_comment|/* called only for MASTER drive */
(brace
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|1
comma
l_int|6
comma
l_int|4
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|1
comma
l_int|6
comma
l_int|0
)paren
suffix:semicolon
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
DECL|macro|DBMSG
mdefine_line|#define DBMSG(msg)&t;((verbose&gt;1)?(msg):NULL)
DECL|function|pd_wait_for
r_static
r_int
id|pd_wait_for
c_func
(paren
r_int
id|unit
comma
r_int
id|w
comma
r_char
op_star
id|msg
)paren
multiline_comment|/* polled wait */
(brace
r_int
id|k
comma
id|r
comma
id|e
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|k
OL
id|PD_SPIN
)paren
(brace
id|r
op_assign
id|RR
c_func
(paren
l_int|1
comma
l_int|6
)paren
suffix:semicolon
id|k
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|r
op_amp
id|w
)paren
op_eq
id|w
)paren
op_logical_and
op_logical_neg
(paren
id|r
op_amp
id|STAT_BUSY
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
id|PD_SPIN_DEL
)paren
suffix:semicolon
)brace
id|e
op_assign
(paren
id|RR
c_func
(paren
l_int|0
comma
l_int|1
)paren
op_lshift
l_int|8
)paren
op_plus
id|RR
c_func
(paren
l_int|0
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
op_ge
id|PD_SPIN
)paren
id|e
op_or_assign
id|ERR_TMO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e
op_amp
(paren
id|STAT_ERR
op_or
id|ERR_TMO
)paren
)paren
op_logical_and
(paren
id|msg
op_ne
l_int|NULL
)paren
)paren
id|pd_print_error
c_func
(paren
id|unit
comma
id|msg
comma
id|e
)paren
suffix:semicolon
r_return
id|e
suffix:semicolon
)brace
DECL|function|pd_send_command
r_static
r_void
id|pd_send_command
c_func
(paren
r_int
id|unit
comma
r_int
id|n
comma
r_int
id|s
comma
r_int
id|h
comma
r_int
id|c0
comma
r_int
id|c1
comma
r_int
id|func
)paren
(brace
id|WR
c_func
(paren
l_int|0
comma
l_int|6
comma
id|DRIVE
op_plus
id|h
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* the IDE task file */
id|WR
c_func
(paren
l_int|0
comma
l_int|2
comma
id|n
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|3
comma
id|s
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|4
comma
id|c0
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|5
comma
id|c1
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|7
comma
id|func
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|pd_ide_command
r_static
r_void
id|pd_ide_command
c_func
(paren
r_int
id|unit
comma
r_int
id|func
comma
r_int
id|block
comma
r_int
id|count
)paren
multiline_comment|/* Don&squot;t use this call if the capacity is zero. */
(brace
r_int
id|c1
comma
id|c0
comma
id|h
comma
id|s
suffix:semicolon
id|s
op_assign
(paren
id|block
op_mod
id|PD.sectors
)paren
op_plus
l_int|1
suffix:semicolon
id|h
op_assign
(paren
id|block
op_div
id|PD.sectors
)paren
op_mod
id|PD.heads
suffix:semicolon
id|c0
op_assign
(paren
id|block
op_div
(paren
id|PD.sectors
op_star
id|PD.heads
)paren
)paren
op_mod
l_int|256
suffix:semicolon
id|c1
op_assign
(paren
id|block
op_div
(paren
id|PD.sectors
op_star
id|PD.heads
op_star
l_int|256
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|unit
comma
id|count
comma
id|s
comma
id|h
comma
id|c0
comma
id|c1
comma
id|func
)paren
suffix:semicolon
)brace
multiline_comment|/* According to the ATA standard, the default CHS geometry should be&n;   available following a reset.  Some Western Digital drives come up&n;   in a mode where only LBA addresses are accepted until the device&n;   parameters are initialised.&n;*/
DECL|function|pd_init_dev_parms
r_static
r_void
id|pd_init_dev_parms
c_func
(paren
r_int
id|unit
)paren
(brace
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before init_dev_parms&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|unit
comma
id|PD.sectors
comma
l_int|0
comma
id|PD.heads
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
id|IDE_INIT_DEV_PARMS
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
l_int|0
comma
l_string|&quot;Initialise device parameters&quot;
)paren
suffix:semicolon
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
DECL|function|pd_doorlock
r_static
r_void
id|pd_doorlock
c_func
(paren
r_int
id|unit
comma
r_int
id|func
)paren
(brace
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_READY
comma
l_string|&quot;Lock&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pd_send_command
c_func
(paren
id|unit
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|func
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_READY
comma
l_string|&quot;Lock done&quot;
)paren
suffix:semicolon
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
DECL|function|pd_eject
r_static
r_void
id|pd_eject
c_func
(paren
r_int
id|unit
)paren
(brace
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before unlock on eject&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|unit
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_DOORUNLOCK
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;after unlock on eject&quot;
)paren
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before eject&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|unit
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_EJECT
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;after eject&quot;
)paren
)paren
suffix:semicolon
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
DECL|function|pd_media_check
r_static
r_void
id|pd_media_check
c_func
(paren
r_int
id|unit
)paren
(brace
r_int
id|r
suffix:semicolon
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|r
op_assign
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_READY
comma
id|DBMSG
c_func
(paren
l_string|&quot;before media_check&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_amp
id|STAT_ERR
)paren
)paren
(brace
id|pd_send_command
c_func
(paren
id|unit
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_READ_VRFY
)paren
suffix:semicolon
id|r
op_assign
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_READY
comma
id|DBMSG
c_func
(paren
l_string|&quot;RDY after READ_VRFY&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
id|PD.changed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* say changed if other error */
r_if
c_cond
(paren
id|r
op_amp
id|ERR_MC
)paren
(brace
id|PD.changed
op_assign
l_int|1
suffix:semicolon
id|pd_send_command
c_func
(paren
id|unit
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_ACKCHANGE
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_READY
comma
id|DBMSG
c_func
(paren
l_string|&quot;RDY after ACKCHANGE&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|unit
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_READ_VRFY
)paren
suffix:semicolon
id|r
op_assign
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_READY
comma
id|DBMSG
c_func
(paren
l_string|&quot;RDY after VRFY&quot;
)paren
)paren
suffix:semicolon
)brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
DECL|function|pd_standby_off
r_static
r_void
id|pd_standby_off
c_func
(paren
r_int
id|unit
)paren
(brace
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before STANDBY&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|unit
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_STANDBY
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;after STANDBY&quot;
)paren
)paren
suffix:semicolon
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
DECL|macro|word_val
mdefine_line|#define  word_val(n) ((pd_scratch[2*n]&amp;0xff)+256*(pd_scratch[2*n+1]&amp;0xff))
DECL|function|pd_identify
r_static
r_int
id|pd_identify
c_func
(paren
r_int
id|unit
)paren
(brace
r_int
id|j
suffix:semicolon
r_char
id|id
(braket
id|PD_ID_LEN
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* WARNING:  here there may be dragons.  reset() applies to both drives,&n;   but we call it only on probing the MASTER. This should allow most&n;   common configurations to work, but be warned that a reset can clear&n;   settings on the SLAVE drive.&n;*/
r_if
c_cond
(paren
id|PD.drive
op_eq
l_int|0
)paren
id|pd_reset
c_func
(paren
id|unit
)paren
suffix:semicolon
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|WR
c_func
(paren
l_int|0
comma
l_int|6
comma
id|DRIVE
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|unit
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before IDENT&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|unit
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_IDENTIFY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_DRQ
comma
id|DBMSG
c_func
(paren
l_string|&quot;IDENT DRQ&quot;
)paren
)paren
op_amp
id|STAT_ERR
)paren
(brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pi_read_block
c_func
(paren
id|PI
comma
id|pd_scratch
comma
l_int|512
)paren
suffix:semicolon
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|PD.sectors
op_assign
id|word_val
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|PD.heads
op_assign
id|word_val
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|PD.cylinders
op_assign
id|word_val
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|PD.capacity
op_assign
id|PD.sectors
op_star
id|PD.heads
op_star
id|PD.cylinders
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|PD_ID_LEN
suffix:semicolon
id|j
op_increment
)paren
(brace
id|id
(braket
id|j
op_xor
l_int|1
)braket
op_assign
id|pd_scratch
(braket
id|j
op_plus
id|PD_ID_OFF
)braket
suffix:semicolon
)brace
id|j
op_assign
id|PD_ID_LEN
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|j
op_ge
l_int|0
)paren
op_logical_and
(paren
id|id
(braket
id|j
)braket
op_le
l_int|0x20
)paren
)paren
id|j
op_decrement
suffix:semicolon
id|j
op_increment
suffix:semicolon
id|id
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|PD.removable
op_assign
(paren
id|word_val
c_func
(paren
l_int|0
)paren
op_amp
l_int|0x80
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s, %s, %d blocks [%dM], (%d/%d/%d), %s media&bslash;n&quot;
comma
id|PD.name
comma
id|id
comma
id|PD.drive
ques
c_cond
l_string|&quot;slave&quot;
suffix:colon
l_string|&quot;master&quot;
comma
id|PD.capacity
comma
id|PD.capacity
op_div
l_int|2048
comma
id|PD.cylinders
comma
id|PD.heads
comma
id|PD.sectors
comma
id|PD.removable
ques
c_cond
l_string|&quot;removable&quot;
suffix:colon
l_string|&quot;fixed&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PD.capacity
)paren
id|pd_init_dev_parms
c_func
(paren
id|unit
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PD.standby
)paren
id|pd_standby_off
c_func
(paren
id|unit
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pd_probe_drive
r_static
r_int
id|pd_probe_drive
c_func
(paren
r_int
id|unit
)paren
(brace
r_if
c_cond
(paren
id|PD.drive
op_eq
op_minus
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|PD.drive
op_assign
l_int|0
suffix:semicolon
id|PD.drive
op_le
l_int|1
suffix:semicolon
id|PD.drive
op_increment
)paren
r_if
c_cond
(paren
id|pd_identify
c_func
(paren
id|unit
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|pd_identify
c_func
(paren
id|unit
)paren
suffix:semicolon
)brace
DECL|function|pd_detect
r_static
r_int
id|pd_detect
c_func
(paren
r_void
)paren
(brace
r_int
id|k
comma
id|unit
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pd_drive_count
op_eq
l_int|0
)paren
(brace
multiline_comment|/* nothing spec&squot;d - so autoprobe for 1 */
id|unit
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pi_init
c_func
(paren
id|PI
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|pd_scratch
comma
id|PI_PD
comma
id|verbose
comma
id|PD.name
)paren
)paren
(brace
r_if
c_cond
(paren
id|pd_probe_drive
c_func
(paren
id|unit
)paren
)paren
(brace
id|PD.present
op_assign
l_int|1
suffix:semicolon
id|k
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|pi_release
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
)brace
r_else
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
r_if
c_cond
(paren
id|DU
(braket
id|D_PRT
)braket
)paren
r_if
c_cond
(paren
id|pi_init
c_func
(paren
id|PI
comma
l_int|0
comma
id|DU
(braket
id|D_PRT
)braket
comma
id|DU
(braket
id|D_MOD
)braket
comma
id|DU
(braket
id|D_UNI
)braket
comma
id|DU
(braket
id|D_PRO
)braket
comma
id|DU
(braket
id|D_DLY
)braket
comma
id|pd_scratch
comma
id|PI_PD
comma
id|verbose
comma
id|PD.name
)paren
)paren
(brace
r_if
c_cond
(paren
id|pd_probe_drive
c_func
(paren
id|unit
)paren
)paren
(brace
id|PD.present
op_assign
l_int|1
suffix:semicolon
id|k
op_assign
id|unit
op_plus
l_int|1
suffix:semicolon
)brace
r_else
id|pi_release
c_func
(paren
id|PI
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
id|register_disk
c_func
(paren
op_amp
id|pd_gendisk
comma
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|unit
op_lshift
id|PD_BITS
)paren
comma
id|PD_PARTNS
comma
op_amp
id|pd_fops
comma
id|PD.present
ques
c_cond
id|PD.capacity
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* We lie about the number of drives found, as the generic partition&n;   scanner assumes that the drives are numbered sequentially from 0.&n;   This can result in some bogus error messages if non-sequential&n;   drive numbers are used.&n;*/
r_if
c_cond
(paren
id|k
)paren
r_return
id|k
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: no valid drive found&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The i/o request engine */
DECL|function|pd_ready
r_static
r_int
id|pd_ready
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
op_assign
id|pd_unit
suffix:semicolon
r_return
(paren
op_logical_neg
(paren
id|RR
c_func
(paren
l_int|1
comma
l_int|6
)paren
op_amp
id|STAT_BUSY
)paren
)paren
suffix:semicolon
)brace
DECL|function|do_pd_request
r_static
r_void
id|do_pd_request
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
id|unit
suffix:semicolon
r_if
c_cond
(paren
id|pd_busy
)paren
r_return
suffix:semicolon
id|repeat
suffix:colon
r_if
c_cond
(paren
id|QUEUE_EMPTY
op_logical_or
(paren
id|CURRENT-&gt;rq_status
op_eq
id|RQ_INACTIVE
)paren
)paren
r_return
suffix:semicolon
id|INIT_REQUEST
suffix:semicolon
id|pd_dev
op_assign
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
suffix:semicolon
id|pd_unit
op_assign
id|unit
op_assign
id|DEVICE_NR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
suffix:semicolon
id|pd_block
op_assign
id|CURRENT-&gt;sector
suffix:semicolon
id|pd_run
op_assign
id|CURRENT-&gt;nr_sectors
suffix:semicolon
id|pd_count
op_assign
id|CURRENT-&gt;current_nr_sectors
suffix:semicolon
id|bh
op_assign
id|CURRENT-&gt;bh
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pd_dev
op_ge
id|PD_DEVS
)paren
op_logical_or
(paren
(paren
id|pd_block
op_plus
id|pd_count
)paren
OG
id|pd_hd
(braket
id|pd_dev
)braket
dot
id|nr_sects
)paren
)paren
(brace
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|pd_cmd
op_assign
id|CURRENT-&gt;cmd
suffix:semicolon
id|pd_poffs
op_assign
id|pd_hd
(braket
id|pd_dev
)braket
dot
id|start_sect
suffix:semicolon
id|pd_block
op_add_assign
id|pd_poffs
suffix:semicolon
id|pd_buf
op_assign
id|CURRENT-&gt;buffer
suffix:semicolon
id|pd_retries
op_assign
l_int|0
suffix:semicolon
id|pd_busy
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pd_cmd
op_eq
id|READ
)paren
id|pi_do_claimed
c_func
(paren
id|PI
comma
id|do_pd_read
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pd_cmd
op_eq
id|WRITE
)paren
id|pi_do_claimed
c_func
(paren
id|PI
comma
id|do_pd_write
)paren
suffix:semicolon
r_else
(brace
id|pd_busy
op_assign
l_int|0
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
)brace
DECL|function|pd_next_buf
r_static
r_void
id|pd_next_buf
c_func
(paren
r_int
id|unit
)paren
(brace
r_int
id|saved_flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_run
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* paranoia */
r_if
c_cond
(paren
id|QUEUE_EMPTY
op_logical_or
(paren
id|CURRENT-&gt;cmd
op_ne
id|pd_cmd
)paren
op_logical_or
(paren
id|MINOR
c_func
(paren
id|CURRENT-&gt;rq_dev
)paren
op_ne
id|pd_dev
)paren
op_logical_or
(paren
id|CURRENT-&gt;rq_status
op_eq
id|RQ_INACTIVE
)paren
op_logical_or
(paren
id|CURRENT-&gt;sector
op_plus
id|pd_poffs
op_ne
id|pd_block
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: OUCH: request list changed unexpectedly&bslash;n&quot;
comma
id|PD.name
)paren
suffix:semicolon
id|pd_count
op_assign
id|CURRENT-&gt;current_nr_sectors
suffix:semicolon
id|pd_buf
op_assign
id|CURRENT-&gt;buffer
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
)brace
DECL|function|do_pd_read
r_static
r_void
id|do_pd_read
c_func
(paren
r_void
)paren
(brace
id|ps_set_intr
c_func
(paren
id|do_pd_read_start
comma
l_int|0
comma
l_int|0
comma
id|nice
)paren
suffix:semicolon
)brace
DECL|function|do_pd_read_start
r_static
r_void
id|do_pd_read_start
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
op_assign
id|pd_unit
suffix:semicolon
r_int
id|saved_flags
suffix:semicolon
id|pd_busy
op_assign
l_int|1
suffix:semicolon
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_READY
comma
l_string|&quot;do_pd_read&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
id|pi_do_claimed
c_func
(paren
id|PI
comma
id|do_pd_read_start
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pd_busy
op_assign
l_int|0
suffix:semicolon
id|do_pd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pd_ide_command
c_func
(paren
id|unit
comma
id|IDE_READ
comma
id|pd_block
comma
id|pd_run
)paren
suffix:semicolon
id|ps_set_intr
c_func
(paren
id|do_pd_read_drq
comma
id|pd_ready
comma
id|PD_TMO
comma
id|nice
)paren
suffix:semicolon
)brace
DECL|function|do_pd_read_drq
r_static
r_void
id|do_pd_read_drq
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
op_assign
id|pd_unit
suffix:semicolon
r_int
id|saved_flags
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_DRQ
comma
l_string|&quot;do_pd_read_drq&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
id|pi_do_claimed
c_func
(paren
id|PI
comma
id|do_pd_read_start
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pd_busy
op_assign
l_int|0
suffix:semicolon
id|do_pd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pi_read_block
c_func
(paren
id|PI
comma
id|pd_buf
comma
l_int|512
)paren
suffix:semicolon
id|pd_count
op_decrement
suffix:semicolon
id|pd_run
op_decrement
suffix:semicolon
id|pd_buf
op_add_assign
l_int|512
suffix:semicolon
id|pd_block
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_run
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_count
)paren
id|pd_next_buf
c_func
(paren
id|unit
)paren
suffix:semicolon
)brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pd_busy
op_assign
l_int|0
suffix:semicolon
id|do_pd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
)brace
DECL|function|do_pd_write
r_static
r_void
id|do_pd_write
c_func
(paren
r_void
)paren
(brace
id|ps_set_intr
c_func
(paren
id|do_pd_write_start
comma
l_int|0
comma
l_int|0
comma
id|nice
)paren
suffix:semicolon
)brace
DECL|function|do_pd_write_start
r_static
r_void
id|do_pd_write_start
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
op_assign
id|pd_unit
suffix:semicolon
r_int
id|saved_flags
suffix:semicolon
id|pd_busy
op_assign
l_int|1
suffix:semicolon
id|pi_connect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_READY
comma
l_string|&quot;do_pd_write&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
id|pi_do_claimed
c_func
(paren
id|PI
comma
id|do_pd_write_start
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pd_busy
op_assign
l_int|0
suffix:semicolon
id|do_pd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pd_ide_command
c_func
(paren
id|unit
comma
id|IDE_WRITE
comma
id|pd_block
comma
id|pd_run
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_DRQ
comma
l_string|&quot;do_pd_write_drq&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
id|pi_do_claimed
c_func
(paren
id|PI
comma
id|do_pd_write_start
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pd_busy
op_assign
l_int|0
suffix:semicolon
id|do_pd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pi_write_block
c_func
(paren
id|PI
comma
id|pd_buf
comma
l_int|512
)paren
suffix:semicolon
id|pd_count
op_decrement
suffix:semicolon
id|pd_run
op_decrement
suffix:semicolon
id|pd_buf
op_add_assign
l_int|512
suffix:semicolon
id|pd_block
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_run
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_count
)paren
id|pd_next_buf
c_func
(paren
id|unit
)paren
suffix:semicolon
)brace
id|ps_set_intr
c_func
(paren
id|do_pd_write_done
comma
id|pd_ready
comma
id|PD_TMO
comma
id|nice
)paren
suffix:semicolon
)brace
DECL|function|do_pd_write_done
r_static
r_void
id|do_pd_write_done
c_func
(paren
r_void
)paren
(brace
r_int
id|unit
op_assign
id|pd_unit
suffix:semicolon
r_int
id|saved_flags
suffix:semicolon
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|unit
comma
id|STAT_READY
comma
l_string|&quot;do_pd_write_done&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
id|pi_do_claimed
c_func
(paren
id|PI
comma
id|do_pd_write_start
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|pd_busy
op_assign
l_int|0
suffix:semicolon
id|do_pd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pi_disconnect
c_func
(paren
id|PI
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pd_busy
op_assign
l_int|0
suffix:semicolon
id|do_pd_request
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|io_request_lock
comma
id|saved_flags
)paren
suffix:semicolon
)brace
multiline_comment|/* end of pd.c */
eof
