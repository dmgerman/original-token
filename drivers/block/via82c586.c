multiline_comment|/*&n; * linux/drivers/block/via82c586.c&t;Version 0.01&t;Aug 16, 1998&n; *&n; *  Copyright (C) 1998 Michel Aubry&n; *  Copyright (C) 1998 Andre Hedrick&n; *&n; *  The VIA MVP-3 is reported OK with UDMA.&n; *&n; *  VIA chips also have a single FIFO, with the same 64 bytes deep buffer (16 levels &n; *  of 4 bytes each).&n; *  However, VIA chips can have the buffer split either 8:8 levels, 16:0 levels or &n; *  0:16 levels between both channels. One could think of using this feature, as even&n; *  if no level of FIFO is given to a given channel, one can always reach ATAPI drives &n; *  through it, or, if one channel is unused, configuration defaults to an even split &n; *  FIFO levels.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;ide.h&quot;
multiline_comment|/*&n; *  Set VIA Chipset Timings for (U)DMA modes enabled.&n; *&n; *  VIA Apollo chipset has complete support for&n; *  setting up the timing parameters.&n; */
DECL|function|set_via_timings
r_static
r_void
id|set_via_timings
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|hwif-&gt;pci_dev
suffix:semicolon
id|byte
id|post
op_assign
id|hwif-&gt;channel
ques
c_cond
l_int|0xc0
suffix:colon
l_int|0x30
suffix:semicolon
id|byte
id|flush
op_assign
id|hwif-&gt;channel
ques
c_cond
l_int|0xa0
suffix:colon
l_int|0x50
suffix:semicolon
id|byte
id|via_config
op_assign
l_int|0
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
comma
id|errors
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: VIA Bus-Master &quot;
comma
id|hwif-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;dma_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; ERROR, NO DMA_BASE&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* setting IDE read prefetch buffer and IDE post write buffer.&n;&t; * (This feature allows prefetched reads and post writes).&n;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x41
comma
op_amp
id|via_config
)paren
)paren
)paren
(brace
id|errors
op_increment
suffix:semicolon
r_goto
id|via_error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x41
comma
id|via_config
op_or
id|post
)paren
)paren
)paren
(brace
id|errors
op_increment
suffix:semicolon
r_goto
id|via_error
suffix:semicolon
)brace
multiline_comment|/* setting Channel read and End-of-sector FIFO flush.&n;&t; * (This feature ensures that FIFO flush is enabled:&n;         *  - for read DMA when interrupt asserts the given channel.&n;         *  - at the end of each sector for the given channel.)&n;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x46
comma
op_amp
id|via_config
)paren
)paren
)paren
(brace
id|errors
op_increment
suffix:semicolon
r_goto
id|via_error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x46
comma
id|via_config
op_or
id|flush
)paren
)paren
)paren
(brace
id|errors
op_increment
suffix:semicolon
r_goto
id|via_error
suffix:semicolon
)brace
id|via_error
suffix:colon
id|printk
c_func
(paren
l_string|&quot;(U)DMA Timing Config %s&bslash;n&quot;
comma
id|errors
ques
c_cond
l_string|&quot;ERROR&quot;
suffix:colon
l_string|&quot;Success&quot;
)paren
suffix:semicolon
)brace
DECL|function|ide_init_via82c586
r_void
id|ide_init_via82c586
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
id|set_via_timings
c_func
(paren
id|hwif
)paren
suffix:semicolon
)brace
eof
