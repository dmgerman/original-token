multiline_comment|/*&n; *  linux/drivers/block/ide-pci.c&t;Version 1.02  December 29, 1997&n; *&n; *  Copyright (c) 1995-1998  Mark Lord&n; *  May be copied or modified under the terms of the GNU General Public License&n; */
multiline_comment|/*&n; *  This module provides support for automatic detection and&n; *  configuration of all PCI IDE interfaces present in a system.  &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;ide.h&quot;
DECL|macro|DEVID_PIIXa
mdefine_line|#define DEVID_PIIXa&t;((ide_pci_devid_t){PCI_VENDOR_ID_INTEL,   PCI_DEVICE_ID_INTEL_82371FB_0})
DECL|macro|DEVID_PIIXb
mdefine_line|#define DEVID_PIIXb&t;((ide_pci_devid_t){PCI_VENDOR_ID_INTEL,   PCI_DEVICE_ID_INTEL_82371FB_1})
DECL|macro|DEVID_PIIX3
mdefine_line|#define DEVID_PIIX3&t;((ide_pci_devid_t){PCI_VENDOR_ID_INTEL,   PCI_DEVICE_ID_INTEL_82371SB_1})
DECL|macro|DEVID_PIIX4
mdefine_line|#define DEVID_PIIX4&t;((ide_pci_devid_t){PCI_VENDOR_ID_INTEL,   PCI_DEVICE_ID_INTEL_82371AB})
DECL|macro|DEVID_VP_IDE
mdefine_line|#define DEVID_VP_IDE&t;((ide_pci_devid_t){PCI_VENDOR_ID_VIA,     PCI_DEVICE_ID_VIA_82C586_1})
DECL|macro|DEVID_PDC20246
mdefine_line|#define DEVID_PDC20246&t;((ide_pci_devid_t){PCI_VENDOR_ID_PROMISE, PCI_DEVICE_ID_PROMISE_20246})
DECL|macro|DEVID_RZ1000
mdefine_line|#define DEVID_RZ1000&t;((ide_pci_devid_t){PCI_VENDOR_ID_PCTECH,  PCI_DEVICE_ID_PCTECH_RZ1000})
DECL|macro|DEVID_RZ1001
mdefine_line|#define DEVID_RZ1001&t;((ide_pci_devid_t){PCI_VENDOR_ID_PCTECH,  PCI_DEVICE_ID_PCTECH_RZ1001})
DECL|macro|DEVID_CMD640
mdefine_line|#define DEVID_CMD640&t;((ide_pci_devid_t){PCI_VENDOR_ID_CMD,     PCI_DEVICE_ID_CMD_640})
DECL|macro|DEVID_CMD646
mdefine_line|#define DEVID_CMD646&t;((ide_pci_devid_t){PCI_VENDOR_ID_CMD,     PCI_DEVICE_ID_CMD_646})
DECL|macro|DEVID_SIS5513
mdefine_line|#define DEVID_SIS5513&t;((ide_pci_devid_t){PCI_VENDOR_ID_SI,      PCI_DEVICE_ID_SI_5513})
DECL|macro|DEVID_OPTI621
mdefine_line|#define DEVID_OPTI621&t;((ide_pci_devid_t){PCI_VENDOR_ID_OPTI,    PCI_DEVICE_ID_OPTI_82C621})
DECL|macro|DEVID_OPTI621V
mdefine_line|#define DEVID_OPTI621V&t;((ide_pci_devid_t){PCI_VENDOR_ID_OPTI,    PCI_DEVICE_ID_OPTI_82C558})
DECL|macro|DEVID_OPTI621X
mdefine_line|#define DEVID_OPTI621X&t;((ide_pci_devid_t){PCI_VENDOR_ID_OPTI,    0xd568})  /* from datasheets */
DECL|macro|DEVID_TRM290
mdefine_line|#define DEVID_TRM290&t;((ide_pci_devid_t){PCI_VENDOR_ID_TEKRAM,  PCI_DEVICE_ID_TEKRAM_DC290})
DECL|macro|DEVID_NS87410
mdefine_line|#define DEVID_NS87410&t;((ide_pci_devid_t){PCI_VENDOR_ID_NS,      PCI_DEVICE_ID_NS_87410})
DECL|macro|DEVID_NS87415
mdefine_line|#define DEVID_NS87415&t;((ide_pci_devid_t){PCI_VENDOR_ID_NS,      PCI_DEVICE_ID_NS_87415})
DECL|macro|DEVID_HT6565
mdefine_line|#define DEVID_HT6565&t;((ide_pci_devid_t){PCI_VENDOR_ID_HOLTEK,  PCI_DEVICE_ID_HOLTEK_6565})
DECL|macro|DEVID_AEC6210
mdefine_line|#define DEVID_AEC6210&t;((ide_pci_devid_t){0x1191,                0x0005})
DECL|macro|DEVID_W82C105
mdefine_line|#define DEVID_W82C105&t;((ide_pci_devid_t){PCI_VENDOR_ID_WINBOND, PCI_DEVICE_ID_WINBOND_82C105})
DECL|macro|IDE_IGNORE
mdefine_line|#define IDE_IGNORE&t;((void *)-1)
macro_line|#ifdef CONFIG_BLK_DEV_TRM290
r_extern
r_void
id|ide_init_trm290
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_TRM290
mdefine_line|#define INIT_TRM290&t;&amp;ide_init_trm290
macro_line|#else
DECL|macro|INIT_TRM290
mdefine_line|#define INIT_TRM290&t;IDE_IGNORE
macro_line|#endif
macro_line|#ifdef CONFIG_BLK_DEV_OPTI621
r_extern
r_void
id|ide_init_opti621
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_OPTI621
mdefine_line|#define INIT_OPTI621&t;&amp;ide_init_opti621
macro_line|#else
DECL|macro|INIT_OPTI621
mdefine_line|#define INIT_OPTI621&t;NULL
macro_line|#endif
macro_line|#ifdef CONFIG_BLK_DEV_NS87415
r_extern
r_void
id|ide_init_ns87415
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_NS87415
mdefine_line|#define INIT_NS87415&t;&amp;ide_init_ns87415
macro_line|#else
DECL|macro|INIT_NS87415
mdefine_line|#define INIT_NS87415&t;IDE_IGNORE
macro_line|#endif
macro_line|#ifdef CONFIG_BLK_DEV_CMD646
r_extern
r_void
id|ide_init_cmd646
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_CMD646
mdefine_line|#define INIT_CMD646&t;&amp;ide_init_cmd646
macro_line|#else
macro_line|#ifdef __sparc_v9__
DECL|macro|INIT_CMD646
mdefine_line|#define INIT_CMD646&t;IDE_IGNORE
macro_line|#else
DECL|macro|INIT_CMD646
mdefine_line|#define INIT_CMD646&t;NULL
macro_line|#endif
macro_line|#endif
macro_line|#ifdef CONFIG_BLK_DEV_SL82C105
r_extern
r_void
id|ide_init_sl82c105
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_W82C105
mdefine_line|#define INIT_W82C105&t;&amp;ide_init_sl82c105
macro_line|#else
DECL|macro|INIT_W82C105
mdefine_line|#define INIT_W82C105&t;IDE_IGNORE
macro_line|#endif
macro_line|#ifdef CONFIG_BLK_DEV_RZ1000
r_extern
r_void
id|ide_init_rz1000
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_RZ1000
mdefine_line|#define INIT_RZ1000&t;&amp;ide_init_rz1000
macro_line|#else
DECL|macro|INIT_RZ1000
mdefine_line|#define INIT_RZ1000&t;IDE_IGNORE
macro_line|#endif
DECL|struct|ide_pci_enablebit_s
r_typedef
r_struct
id|ide_pci_enablebit_s
(brace
DECL|member|reg
id|byte
id|reg
suffix:semicolon
multiline_comment|/* byte pci reg holding the enable-bit */
DECL|member|mask
id|byte
id|mask
suffix:semicolon
multiline_comment|/* mask to isolate the enable-bit */
DECL|member|val
id|byte
id|val
suffix:semicolon
multiline_comment|/* value of masked reg when &quot;enabled&quot; */
DECL|typedef|ide_pci_enablebit_t
)brace
id|ide_pci_enablebit_t
suffix:semicolon
DECL|struct|ide_pci_device_s
r_typedef
r_struct
id|ide_pci_device_s
(brace
DECL|member|devid
id|ide_pci_devid_t
id|devid
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|init_hwif
r_void
(paren
op_star
id|init_hwif
)paren
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
suffix:semicolon
DECL|member|enablebits
id|ide_pci_enablebit_t
id|enablebits
(braket
l_int|2
)braket
suffix:semicolon
DECL|typedef|ide_pci_device_t
)brace
id|ide_pci_device_t
suffix:semicolon
DECL|variable|__initdata
r_static
id|ide_pci_device_t
id|ide_pci_chipsets
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|DEVID_PIIXa
comma
l_string|&quot;PIIX&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x41
comma
l_int|0x80
comma
l_int|0x80
)brace
comma
(brace
l_int|0x43
comma
l_int|0x80
comma
l_int|0x80
)brace
)brace
)brace
comma
(brace
id|DEVID_PIIXb
comma
l_string|&quot;PIIX&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x41
comma
l_int|0x80
comma
l_int|0x80
)brace
comma
(brace
l_int|0x43
comma
l_int|0x80
comma
l_int|0x80
)brace
)brace
)brace
comma
(brace
id|DEVID_PIIX3
comma
l_string|&quot;PIIX3&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x41
comma
l_int|0x80
comma
l_int|0x80
)brace
comma
(brace
l_int|0x43
comma
l_int|0x80
comma
l_int|0x80
)brace
)brace
)brace
comma
(brace
id|DEVID_PIIX4
comma
l_string|&quot;PIIX4&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x41
comma
l_int|0x80
comma
l_int|0x80
)brace
comma
(brace
l_int|0x43
comma
l_int|0x80
comma
l_int|0x80
)brace
)brace
)brace
comma
(brace
id|DEVID_VP_IDE
comma
l_string|&quot;VP_IDE&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x40
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
(brace
l_int|0x40
comma
l_int|0x01
comma
l_int|0x01
)brace
)brace
)brace
comma
(brace
id|DEVID_PDC20246
comma
l_string|&quot;PDC20246&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x50
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
(brace
l_int|0x50
comma
l_int|0x04
comma
l_int|0x04
)brace
)brace
)brace
comma
(brace
id|DEVID_RZ1000
comma
l_string|&quot;RZ1000&quot;
comma
id|INIT_RZ1000
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_RZ1001
comma
l_string|&quot;RZ1001&quot;
comma
id|INIT_RZ1000
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_CMD640
comma
l_string|&quot;CMD640&quot;
comma
id|IDE_IGNORE
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_NS87410
comma
l_string|&quot;NS87410&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x43
comma
l_int|0x08
comma
l_int|0x08
)brace
comma
(brace
l_int|0x47
comma
l_int|0x08
comma
l_int|0x08
)brace
)brace
)brace
comma
(brace
id|DEVID_SIS5513
comma
l_string|&quot;SIS5513&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x4a
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
(brace
l_int|0x4a
comma
l_int|0x04
comma
l_int|0x04
)brace
)brace
)brace
comma
(brace
id|DEVID_CMD646
comma
l_string|&quot;CMD646&quot;
comma
id|INIT_CMD646
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x51
comma
l_int|0x80
comma
l_int|0x80
)brace
)brace
)brace
comma
(brace
id|DEVID_HT6565
comma
l_string|&quot;HT6565&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_OPTI621
comma
l_string|&quot;OPTI621&quot;
comma
id|INIT_OPTI621
comma
(brace
(brace
l_int|0x45
comma
l_int|0x80
comma
l_int|0x00
)brace
comma
(brace
l_int|0x40
comma
l_int|0x08
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_OPTI621X
comma
l_string|&quot;OPTI621X&quot;
comma
id|INIT_OPTI621
comma
(brace
(brace
l_int|0x45
comma
l_int|0x80
comma
l_int|0x00
)brace
comma
(brace
l_int|0x40
comma
l_int|0x08
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_TRM290
comma
l_string|&quot;TRM290&quot;
comma
id|INIT_TRM290
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_NS87415
comma
l_string|&quot;NS87415&quot;
comma
id|INIT_NS87415
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_AEC6210
comma
l_string|&quot;AEC6210&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_W82C105
comma
l_string|&quot;W82C105&quot;
comma
id|INIT_W82C105
comma
(brace
(brace
l_int|0x40
comma
l_int|0x01
comma
l_int|0x01
)brace
comma
(brace
l_int|0x40
comma
l_int|0x10
comma
l_int|0x10
)brace
)brace
)brace
comma
(brace
id|IDE_PCI_DEVID_NULL
comma
l_string|&quot;PCI_IDE&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Match a PCI IDE port against an entry in ide_hwifs[],&n; * based on io_base port if possible.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
id|ide_hwif_t
op_star
id|ide_match_hwif
(paren
r_int
r_int
id|io_base
comma
r_const
r_char
op_star
id|name
)paren
)paren
(brace
r_int
id|h
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
suffix:semicolon
multiline_comment|/*&n;&t; * Look for a hwif with matching io_base specified using&n;&t; * parameters to ide_setup().&n;&t; */
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|h
)paren
(brace
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|h
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_eq
id|io_base
)paren
(brace
r_if
c_cond
(paren
id|hwif-&gt;chipset
op_eq
id|ide_generic
)paren
r_return
id|hwif
suffix:semicolon
multiline_comment|/* a perfect match */
)brace
)brace
multiline_comment|/*&n;&t; * Look for a hwif with matching io_base default value.&n;&t; * If chipset is &quot;ide_unknown&quot;, then claim that hwif slot.&n;&t; * Otherwise, some other chipset has already claimed it..  :(&n;&t; */
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|h
)paren
(brace
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|h
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_eq
id|io_base
)paren
(brace
r_if
c_cond
(paren
id|hwif-&gt;chipset
op_eq
id|ide_unknown
)paren
r_return
id|hwif
suffix:semicolon
multiline_comment|/* match */
id|printk
c_func
(paren
l_string|&quot;%s: port 0x%04lx already claimed by %s&bslash;n&quot;
comma
id|name
comma
id|io_base
comma
id|hwif-&gt;name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* already claimed */
)brace
)brace
multiline_comment|/*&n;&t; * Okay, there is no hwif matching our io_base,&n;&t; * so we&squot;ll just claim an unassigned slot.&n;&t; * Give preference to claiming other slots before claiming ide0/ide1,&n;&t; * just in case there&squot;s another interface yet-to-be-scanned&n;&t; * which uses ports 1f0/170 (the ide0/ide1 defaults).&n;&t; */
r_for
c_loop
(paren
id|h
op_assign
l_int|2
suffix:semicolon
id|h
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|h
)paren
(brace
id|hwif
op_assign
id|ide_hwifs
op_plus
id|h
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;chipset
op_eq
id|ide_unknown
)paren
r_return
id|hwif
suffix:semicolon
multiline_comment|/* pick an unused entry */
)brace
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
OL
l_int|2
suffix:semicolon
op_increment
id|h
)paren
(brace
id|hwif
op_assign
id|ide_hwifs
op_plus
id|h
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;chipset
op_eq
id|ide_unknown
)paren
r_return
id|hwif
suffix:semicolon
multiline_comment|/* pick an unused entry */
)brace
id|printk
c_func
(paren
l_string|&quot;%s: too many IDE interfaces, no room in table&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|ide_setup_pci_baseregs
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_char
op_star
id|name
)paren
)paren
(brace
id|byte
id|reg
comma
id|progif
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Place both IDE interfaces into PCI &quot;native&quot; mode:&n;&t; */
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_CLASS_PROG
comma
op_amp
id|progif
)paren
op_logical_or
(paren
id|progif
op_amp
l_int|5
)paren
op_ne
l_int|5
)paren
(brace
r_if
c_cond
(paren
(paren
id|progif
op_amp
l_int|0xa
)paren
op_ne
l_int|0xa
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: device not capable of full native PCI mode&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: placing both ports into native PCI mode&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_CLASS_PROG
comma
id|progif
op_or
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_CLASS_PROG
comma
op_amp
id|progif
)paren
op_logical_or
(paren
id|progif
op_amp
l_int|5
)paren
op_ne
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: rewrite of PROGIF failed, wanted 0x%04x, got 0x%04x&bslash;n&quot;
comma
id|name
comma
id|progif
op_or
l_int|5
comma
id|progif
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Setup base registers for IDE command/control spaces for each interface:&n;&t; */
r_for
c_loop
(paren
id|reg
op_assign
l_int|0
suffix:semicolon
id|reg
OL
l_int|4
suffix:semicolon
id|reg
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;base_address
(braket
id|reg
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Missing I/O address #%d, please report to &lt;mj@ucw.cz&gt;&bslash;n&quot;
comma
id|name
comma
id|reg
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ide_setup_pci_device() looks at the primary/secondary interfaces&n; * on a PCI IDE device and, if they are enabled, prepares the IDE driver&n; * for use with them.  This generic code works for most PCI chipsets.&n; *&n; * One thing that is not standardized is the location of the&n; * primary/secondary interface &quot;enable/disable&quot; bits.  For chipsets that&n; * we &quot;know&quot; about, this information is in the ide_pci_device_t struct;&n; * for all other chipsets, we just assume both interfaces are enabled.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|ide_setup_pci_device
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|ide_pci_device_t
op_star
id|d
)paren
)paren
(brace
r_int
r_int
id|port
comma
id|at_least_one_hwif_enabled
op_assign
l_int|0
comma
id|autodma
op_assign
l_int|0
comma
id|pciirq
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|pcicmd
op_assign
l_int|0
comma
id|tried_config
op_assign
l_int|0
suffix:semicolon
id|byte
id|tmp
op_assign
l_int|0
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
comma
op_star
id|mate
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_IDEDMA_AUTO
id|autodma
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|check_if_enabled
suffix:colon
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|pcicmd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: error accessing PCI regs&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcicmd
op_amp
id|PCI_COMMAND_IO
)paren
)paren
(brace
multiline_comment|/* is device disabled? */
multiline_comment|/*&n;&t;&t; * PnP BIOS was *supposed* to have set this device up for us,&n;&t;&t; * but we can do it ourselves, so long as the BIOS has assigned an IRQ&n;&t;&t; *  (or possibly the device is using a &quot;legacy header&quot; for IRQs).&n;&t;&t; * Maybe the user deliberately *disabled* the device,&n;&t;&t; * but we&squot;ll eventually ignore it again if no drives respond.&n;&t;&t; */
r_if
c_cond
(paren
id|tried_config
op_increment
op_logical_or
id|ide_setup_pci_baseregs
c_func
(paren
id|dev
comma
id|d-&gt;name
)paren
op_logical_or
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|pcicmd
op_or
id|PCI_COMMAND_IO
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: device disabled (BIOS)&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|autodma
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default DMA off if we had to configure it here */
r_goto
id|check_if_enabled
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tried_config
)paren
id|printk
c_func
(paren
l_string|&quot;%s: device enabled (Linux)&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Can we trust the reported IRQ?&n;&t; */
id|pciirq
op_assign
id|dev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_amp
op_complement
(paren
l_int|0xfa
)paren
)paren
op_ne
(paren
(paren
id|PCI_CLASS_STORAGE_IDE
op_lshift
l_int|8
)paren
op_or
l_int|5
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: not 100%% native mode: will probe irqs later&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
id|pciirq
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tried_config
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: will probe irqs later&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
id|pciirq
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|pciirq
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: bad irq (%d): will probe later&bslash;n&quot;
comma
id|d-&gt;name
comma
id|pciirq
)paren
suffix:semicolon
id|pciirq
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef __sparc__
id|printk
c_func
(paren
l_string|&quot;%s: 100%% native mode on irq %s&bslash;n&quot;
comma
id|d-&gt;name
comma
id|__irq_itoa
c_func
(paren
id|pciirq
)paren
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;%s: 100%% native mode on irq %d&bslash;n&quot;
comma
id|d-&gt;name
comma
id|pciirq
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;&t; * Set up the IDE ports&n;&t; */
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
op_le
l_int|1
suffix:semicolon
op_increment
id|port
)paren
(brace
r_int
r_int
id|base
op_assign
l_int|0
comma
id|ctl
op_assign
l_int|0
suffix:semicolon
id|ide_pci_enablebit_t
op_star
id|e
op_assign
op_amp
(paren
id|d-&gt;enablebits
(braket
id|port
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;reg
op_logical_and
(paren
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|e-&gt;reg
comma
op_amp
id|tmp
)paren
op_logical_or
(paren
id|tmp
op_amp
id|e-&gt;mask
)paren
op_ne
id|e-&gt;val
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* port not enabled */
r_if
c_cond
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_STORAGE_IDE
op_logical_or
(paren
id|dev
op_member_access_from_pointer
r_class
op_amp
(paren
id|port
ques
c_cond
l_int|4
suffix:colon
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ctl
op_assign
id|dev-&gt;base_address
(braket
(paren
l_int|2
op_star
id|port
)paren
op_plus
l_int|1
)braket
op_amp
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|base
op_assign
id|dev-&gt;base_address
(braket
l_int|2
op_star
id|port
)braket
op_amp
op_complement
l_int|7
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ctl
op_logical_and
op_logical_neg
id|base
)paren
op_logical_or
(paren
id|base
op_logical_and
op_logical_neg
id|ctl
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: inconsistent baseregs (BIOS) for port %d, skipping&bslash;n&quot;
comma
id|d-&gt;name
comma
id|port
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ctl
)paren
id|ctl
op_assign
id|port
ques
c_cond
l_int|0x374
suffix:colon
l_int|0x3f4
suffix:semicolon
multiline_comment|/* use default value */
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
id|base
op_assign
id|port
ques
c_cond
l_int|0x170
suffix:colon
l_int|0x1f0
suffix:semicolon
multiline_comment|/* use default value */
r_if
c_cond
(paren
(paren
id|hwif
op_assign
id|ide_match_hwif
c_func
(paren
id|base
comma
id|d-&gt;name
)paren
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
multiline_comment|/* no room in ide_hwifs[] */
r_if
c_cond
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_ne
id|base
)paren
(brace
id|ide_init_hwif_ports
c_func
(paren
id|hwif-&gt;io_ports
comma
id|base
comma
l_int|NULL
)paren
suffix:semicolon
id|hwif-&gt;io_ports
(braket
id|IDE_CONTROL_OFFSET
)braket
op_assign
id|ctl
op_plus
l_int|2
suffix:semicolon
id|hwif-&gt;noprobe
op_assign
op_logical_neg
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
suffix:semicolon
)brace
id|hwif-&gt;chipset
op_assign
id|ide_pci
suffix:semicolon
id|hwif-&gt;pci_dev
op_assign
id|dev
suffix:semicolon
id|hwif-&gt;pci_devid
op_assign
id|d-&gt;devid
suffix:semicolon
id|hwif-&gt;channel
op_assign
id|port
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;irq
)paren
id|hwif-&gt;irq
op_assign
id|pciirq
suffix:semicolon
r_if
c_cond
(paren
id|mate
)paren
(brace
id|hwif-&gt;mate
op_assign
id|mate
suffix:semicolon
id|mate-&gt;mate
op_assign
id|hwif
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_BLK_DEV_IDEDMA
r_if
c_cond
(paren
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|DEVID_SIS5513
)paren
)paren
id|autodma
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|autodma
)paren
id|hwif-&gt;autodma
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|DEVID_PDC20246
)paren
op_logical_or
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_STORAGE_IDE
op_logical_and
(paren
id|dev
op_member_access_from_pointer
r_class
op_amp
l_int|0x80
)paren
)paren
)paren
(brace
r_int
r_int
id|extra
op_assign
(paren
op_logical_neg
id|mate
op_logical_and
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|DEVID_PDC20246
)paren
)paren
ques
c_cond
l_int|16
suffix:colon
l_int|0
suffix:semicolon
r_int
r_int
id|dma_base
op_assign
id|ide_get_or_set_dma_base
c_func
(paren
id|hwif
comma
id|extra
comma
id|d-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_base
op_logical_and
op_logical_neg
(paren
id|pcicmd
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
multiline_comment|/*&n; &t; &t;&t;&t; * Set up BM-DMA capability (PnP BIOS should have done this)&n; &t; &t;&t;&t; */
id|hwif-&gt;autodma
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default DMA off if we had to configure it here */
(paren
r_void
)paren
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|pcicmd
op_or
id|PCI_COMMAND_MASTER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|pcicmd
)paren
op_logical_or
op_logical_neg
(paren
id|pcicmd
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: %s error updating PCICMD&bslash;n&quot;
comma
id|hwif-&gt;name
comma
id|d-&gt;name
)paren
suffix:semicolon
id|dma_base
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dma_base
)paren
id|ide_setup_dma
c_func
(paren
id|hwif
comma
id|dma_base
comma
l_int|8
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s: %s Bus-Master DMA disabled (BIOS)&bslash;n&quot;
comma
id|hwif-&gt;name
comma
id|d-&gt;name
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_BLK_DEV_IDEDMA */
r_if
c_cond
(paren
id|d-&gt;init_hwif
)paren
multiline_comment|/* Call chipset-specific routine for each enabled hwif */
id|d
op_member_access_from_pointer
id|init_hwif
c_func
(paren
id|hwif
)paren
suffix:semicolon
id|mate
op_assign
id|hwif
suffix:semicolon
id|at_least_one_hwif_enabled
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|at_least_one_hwif_enabled
)paren
id|printk
c_func
(paren
l_string|&quot;%s: neither IDE port enabled (BIOS)&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ide_scan_pcibus() gets invoked at boot time from ide.c.&n; * It finds all PCI IDE controllers and calls ide_setup_pci_device for them.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|ide_scan_pcibus
(paren
r_void
)paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
id|ide_pci_devid_t
id|devid
suffix:semicolon
id|ide_pci_device_t
op_star
id|d
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|pci_devices
suffix:semicolon
id|dev
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
id|devid.vid
op_assign
id|dev-&gt;vendor
suffix:semicolon
id|devid.did
op_assign
id|dev-&gt;device
suffix:semicolon
r_for
c_loop
(paren
id|d
op_assign
id|ide_pci_chipsets
suffix:semicolon
id|d-&gt;devid.vid
op_logical_and
op_logical_neg
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|devid
)paren
suffix:semicolon
op_increment
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;init_hwif
op_eq
id|IDE_IGNORE
)paren
id|printk
c_func
(paren
l_string|&quot;%s: ignored by ide_scan_pci_device() (uses own driver)&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|DEVID_OPTI621V
)paren
op_logical_and
op_logical_neg
(paren
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* OPTI Viper-M uses same devid for functions 0 and 1 */
r_else
r_if
c_cond
(paren
op_logical_neg
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|IDE_PCI_DEVID_NULL
)paren
op_logical_or
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_STORAGE_IDE
)paren
(brace
r_if
c_cond
(paren
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|IDE_PCI_DEVID_NULL
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: unknown IDE controller on PCI bus %02x device %02x, VID=%04x, DID=%04x&bslash;n&quot;
comma
id|d-&gt;name
comma
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
comma
id|devid.vid
comma
id|devid.did
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s: IDE controller on PCI bus %02x dev %02x&bslash;n&quot;
comma
id|d-&gt;name
comma
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
)paren
suffix:semicolon
id|ide_setup_pci_device
c_func
(paren
id|dev
comma
id|d
)paren
suffix:semicolon
)brace
)brace
)brace
eof
