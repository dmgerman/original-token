multiline_comment|/*&n; *  linux/drivers/block/ide-pci.c&t;Version 1.00  December 8, 1997&n; *&n; *  Copyright (c) 1995-1998  Mark Lord&n; *  May be copied or modified under the terms of the GNU General Public License&n; */
multiline_comment|/*&n; * This modules provides support for automatic detection and&n; * configuration of all PCI IDE interfaces present in a system.  &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;ide.h&quot;
DECL|macro|DEVID_PIIX
mdefine_line|#define DEVID_PIIX&t;((ide_pci_devid_t){PCI_VENDOR_ID_INTEL,   PCI_DEVICE_ID_INTEL_82371FB_1})
DECL|macro|DEVID_PIIX3
mdefine_line|#define DEVID_PIIX3&t;((ide_pci_devid_t){PCI_VENDOR_ID_INTEL,   PCI_DEVICE_ID_INTEL_82371SB_1})
DECL|macro|DEVID_PIIX4
mdefine_line|#define DEVID_PIIX4&t;((ide_pci_devid_t){PCI_VENDOR_ID_INTEL,   PCI_DEVICE_ID_INTEL_82371AB})
DECL|macro|DEVID_VP_IDE
mdefine_line|#define DEVID_VP_IDE&t;((ide_pci_devid_t){PCI_VENDOR_ID_VIA,     PCI_DEVICE_ID_VIA_82C586_1})
DECL|macro|DEVID_PDC20246
mdefine_line|#define DEVID_PDC20246&t;((ide_pci_devid_t){PCI_VENDOR_ID_PROMISE, PCI_DEVICE_ID_PROMISE_20246})
DECL|macro|DEVID_RZ1000
mdefine_line|#define DEVID_RZ1000&t;((ide_pci_devid_t){PCI_VENDOR_ID_PCTECH,  PCI_DEVICE_ID_PCTECH_RZ1000})
DECL|macro|DEVID_RZ1001
mdefine_line|#define DEVID_RZ1001&t;((ide_pci_devid_t){PCI_VENDOR_ID_PCTECH,  PCI_DEVICE_ID_PCTECH_RZ1001})
DECL|macro|DEVID_CMD640
mdefine_line|#define DEVID_CMD640&t;((ide_pci_devid_t){PCI_VENDOR_ID_CMD,     PCI_DEVICE_ID_CMD_640})
DECL|macro|DEVID_CMD646
mdefine_line|#define DEVID_CMD646&t;((ide_pci_devid_t){PCI_VENDOR_ID_CMD,     PCI_DEVICE_ID_CMD_646})
DECL|macro|DEVID_SIS5513
mdefine_line|#define DEVID_SIS5513&t;((ide_pci_devid_t){PCI_VENDOR_ID_SI,      PCI_DEVICE_ID_SI_5513})
DECL|macro|DEVID_OPTI621
mdefine_line|#define DEVID_OPTI621&t;((ide_pci_devid_t){PCI_VENDOR_ID_OPTI,    PCI_DEVICE_ID_OPTI_82C621})
DECL|macro|DEVID_OPTI621V
mdefine_line|#define DEVID_OPTI621V&t;((ide_pci_devid_t){PCI_VENDOR_ID_OPTI,    PCI_DEVICE_ID_OPTI_82C558})
DECL|macro|DEVID_OPTI621X
mdefine_line|#define DEVID_OPTI621X&t;((ide_pci_devid_t){PCI_VENDOR_ID_OPTI,    0xd568})  /* from datasheets */
DECL|macro|DEVID_TRM290
mdefine_line|#define DEVID_TRM290&t;((ide_pci_devid_t){PCI_VENDOR_ID_TEKRAM,  PCI_DEVICE_ID_TEKRAM_DC290})
DECL|macro|DEVID_NS87410
mdefine_line|#define DEVID_NS87410&t;((ide_pci_devid_t){PCI_VENDOR_ID_NS,      PCI_DEVICE_ID_NS_87410})
DECL|macro|DEVID_NS87415
mdefine_line|#define DEVID_NS87415&t;((ide_pci_devid_t){PCI_VENDOR_ID_NS,      PCI_DEVICE_ID_NS_87415})
DECL|macro|DEVID_HT6565
mdefine_line|#define DEVID_HT6565&t;((ide_pci_devid_t){PCI_VENDOR_ID_HOLTEK,  PCI_DEVICE_ID_HOLTEK_6565})
DECL|macro|IDE_IGNORE
mdefine_line|#define IDE_IGNORE&t;((void *)-1)
macro_line|#ifdef CONFIG_BLK_DEV_TRM290
r_extern
r_void
id|ide_init_trm290
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_TRM290
mdefine_line|#define INIT_TRM290&t;&amp;ide_init_trm290
macro_line|#else
DECL|macro|INIT_TRM290
mdefine_line|#define INIT_TRM290&t;IDE_IGNORE
macro_line|#endif
macro_line|#ifdef CONFIG_BLK_DEV_OPTI621
r_extern
r_void
id|ide_init_opti621
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_OPTI621
mdefine_line|#define INIT_OPTI621&t;&amp;ide_init_opti621
macro_line|#else
DECL|macro|INIT_OPTI621
mdefine_line|#define INIT_OPTI621&t;NULL
macro_line|#endif
macro_line|#ifdef CONFIG_BLK_DEV_NS87415
r_extern
r_void
id|ide_init_ns87415
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_NS87415
mdefine_line|#define INIT_NS87415&t;&amp;ide_init_ns87415
macro_line|#else
DECL|macro|INIT_NS87415
mdefine_line|#define INIT_NS87415&t;IDE_IGNORE
macro_line|#endif
macro_line|#ifdef CONFIG_BLK_DEV_RZ1000
r_extern
r_void
id|ide_init_rz1000
c_func
(paren
id|ide_hwif_t
op_star
)paren
suffix:semicolon
DECL|macro|INIT_RZ1000
mdefine_line|#define INIT_RZ1000&t;&amp;ide_init_rz1000
macro_line|#else
DECL|macro|INIT_RZ1000
mdefine_line|#define INIT_RZ1000&t;IDE_IGNORE
macro_line|#endif
DECL|struct|ide_pci_enablebit_s
r_typedef
r_struct
id|ide_pci_enablebit_s
(brace
DECL|member|reg
id|byte
id|reg
suffix:semicolon
multiline_comment|/* byte pci reg holding the enable-bit */
DECL|member|mask
id|byte
id|mask
suffix:semicolon
multiline_comment|/* mask to isolate the enable-bit */
DECL|member|val
id|byte
id|val
suffix:semicolon
multiline_comment|/* value of masked reg when &quot;enabled&quot; */
DECL|typedef|ide_pci_enablebit_t
)brace
id|ide_pci_enablebit_t
suffix:semicolon
DECL|struct|ide_pci_device_s
r_typedef
r_struct
id|ide_pci_device_s
(brace
DECL|member|devid
id|ide_pci_devid_t
id|devid
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|init_hwif
r_void
(paren
op_star
id|init_hwif
)paren
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
suffix:semicolon
DECL|member|enablebits
id|ide_pci_enablebit_t
id|enablebits
(braket
l_int|2
)braket
suffix:semicolon
DECL|typedef|ide_pci_device_t
)brace
id|ide_pci_device_t
suffix:semicolon
DECL|variable|__initdata
r_static
id|ide_pci_device_t
id|ide_pci_chipsets
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|DEVID_PIIX
comma
l_string|&quot;PIIX&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x41
comma
l_int|0x80
comma
l_int|0x80
)brace
comma
(brace
l_int|0x43
comma
l_int|0x80
comma
l_int|0x80
)brace
)brace
)brace
comma
(brace
id|DEVID_PIIX3
comma
l_string|&quot;PIIX3&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x41
comma
l_int|0x80
comma
l_int|0x80
)brace
comma
(brace
l_int|0x43
comma
l_int|0x80
comma
l_int|0x80
)brace
)brace
)brace
comma
(brace
id|DEVID_PIIX4
comma
l_string|&quot;PIIX4&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x41
comma
l_int|0x80
comma
l_int|0x80
)brace
comma
(brace
l_int|0x43
comma
l_int|0x80
comma
l_int|0x80
)brace
)brace
)brace
comma
(brace
id|DEVID_VP_IDE
comma
l_string|&quot;VP_IDE&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x40
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
(brace
l_int|0x40
comma
l_int|0x01
comma
l_int|0x01
)brace
)brace
)brace
comma
(brace
id|DEVID_PDC20246
comma
l_string|&quot;PDC20246&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x50
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
(brace
l_int|0x50
comma
l_int|0x04
comma
l_int|0x04
)brace
)brace
)brace
comma
(brace
id|DEVID_RZ1000
comma
l_string|&quot;RZ1000&quot;
comma
id|INIT_RZ1000
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_RZ1001
comma
l_string|&quot;RZ1001&quot;
comma
id|INIT_RZ1000
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_CMD640
comma
l_string|&quot;CMD640&quot;
comma
id|IDE_IGNORE
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_NS87410
comma
l_string|&quot;NS87410&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x43
comma
l_int|0x08
comma
l_int|0x08
)brace
comma
(brace
l_int|0x47
comma
l_int|0x08
comma
l_int|0x08
)brace
)brace
)brace
comma
(brace
id|DEVID_SIS5513
comma
l_string|&quot;SIS5513&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x4a
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
(brace
l_int|0x4a
comma
l_int|0x04
comma
l_int|0x04
)brace
)brace
)brace
comma
(brace
id|DEVID_CMD646
comma
l_string|&quot;CMD646&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x51
comma
l_int|0x80
comma
l_int|0x80
)brace
)brace
)brace
comma
(brace
id|DEVID_HT6565
comma
l_string|&quot;HT6565&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_OPTI621
comma
l_string|&quot;OPTI621&quot;
comma
id|INIT_OPTI621
comma
(brace
(brace
l_int|0x45
comma
l_int|0x80
comma
l_int|0x00
)brace
comma
(brace
l_int|0x40
comma
l_int|0x08
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_OPTI621X
comma
l_string|&quot;OPTI621X&quot;
comma
id|INIT_OPTI621
comma
(brace
(brace
l_int|0x45
comma
l_int|0x80
comma
l_int|0x00
)brace
comma
(brace
l_int|0x40
comma
l_int|0x08
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_TRM290
comma
l_string|&quot;TRM290&quot;
comma
id|INIT_TRM290
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|DEVID_NS87415
comma
l_string|&quot;NS87415&quot;
comma
id|INIT_NS87415
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
comma
(brace
id|IDE_PCI_DEVID_NULL
comma
l_string|&quot;PCI_IDE&quot;
comma
l_int|NULL
comma
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
)brace
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Search for an (apparently) unused block of I/O space&n; * of &quot;size&quot; bytes in length.  Ideally we ought to do a pass&n; * through pcicfg space to eliminate ports already allocated&n; * by the BIOS, to avoid conflicts later in the init cycle,&n; * but we don&squot;t.&t;FIXME&n; */
DECL|function|ide_find_free_region
r_int
r_int
id|ide_find_free_region
(paren
r_int
r_int
id|size
)paren
multiline_comment|/* __init */
(brace
r_static
r_int
r_int
id|base
op_assign
l_int|0x5800
suffix:semicolon
multiline_comment|/* it works for me */
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|base
OG
l_int|0
suffix:semicolon
id|base
op_sub_assign
l_int|0x200
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|check_region
c_func
(paren
id|base
comma
id|size
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|base
op_plus
id|i
)paren
op_ne
l_int|0xff
)paren
r_goto
id|next
suffix:semicolon
)brace
r_return
id|base
suffix:semicolon
multiline_comment|/* success */
)brace
id|next
suffix:colon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* failure */
)brace
multiline_comment|/*&n; * Match a PCI IDE port against an entry in ide_hwifs[],&n; * based on io_base port if possible.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
id|ide_hwif_t
op_star
id|ide_match_hwif
(paren
r_int
r_int
id|io_base
comma
r_const
r_char
op_star
id|name
)paren
)paren
(brace
r_int
id|h
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
suffix:semicolon
multiline_comment|/*&n;&t; * Look for a hwif with matching io_base specified using&n;&t; * parameters to ide_setup().&n;&t; */
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|h
)paren
(brace
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|h
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_eq
id|io_base
)paren
(brace
r_if
c_cond
(paren
id|hwif-&gt;chipset
op_eq
id|ide_generic
)paren
r_return
id|hwif
suffix:semicolon
multiline_comment|/* a perfect match */
)brace
)brace
multiline_comment|/*&n;&t; * Look for a hwif with matching io_base default value.&n;&t; * If chipset is &quot;ide_unknown&quot;, then claim that hwif slot.&n;&t; * Otherwise, some other chipset has already claimed it..  :(&n;&t; */
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|h
)paren
(brace
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|h
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_eq
id|io_base
)paren
(brace
r_if
c_cond
(paren
id|hwif-&gt;chipset
op_eq
id|ide_unknown
)paren
r_return
id|hwif
suffix:semicolon
multiline_comment|/* match */
id|printk
c_func
(paren
l_string|&quot;%s: port 0x%04x already claimed by %s&bslash;n&quot;
comma
id|name
comma
id|io_base
comma
id|hwif-&gt;name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* already claimed */
)brace
)brace
multiline_comment|/*&n;&t; * Okay, there is no hwif matching our io_base,&n;&t; * so we&squot;ll just claim an unassigned slot.&n;&t; * Give preference to claiming other slots before claiming ide0/ide1,&n;&t; * just in case there&squot;s another interface yet-to-be-scanned&n;&t; * which uses ports 1f0/170 (the ide0/ide1 defaults).&n;&t; */
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|h
)paren
(brace
r_int
id|hwifs
(braket
)braket
op_assign
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* assign 3rd/4th before 1st/2nd */
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|hwifs
(braket
id|h
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;chipset
op_eq
id|ide_unknown
)paren
r_return
id|hwif
suffix:semicolon
multiline_comment|/* pick an unused entry */
)brace
id|printk
c_func
(paren
l_string|&quot;%s: too many IDE interfaces, no room in table&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|ide_setup_pci_baseregs
(paren
id|byte
id|bus
comma
id|byte
id|fn
comma
r_const
r_char
op_star
id|name
)paren
)paren
(brace
r_int
r_int
id|base
comma
id|readback
suffix:semicolon
id|byte
id|reg
comma
id|progif
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Place both IDE interfaces into PCI &quot;native&quot; mode:&n;&t; */
r_if
c_cond
(paren
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x09
comma
op_amp
id|progif
)paren
op_logical_or
(paren
id|progif
op_amp
l_int|5
)paren
op_ne
l_int|5
)paren
(brace
r_if
c_cond
(paren
(paren
id|progif
op_amp
l_int|0xa
)paren
op_ne
l_int|0xa
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: device not capable of full native PCI mode&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: placing both ports into native PCI mode&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
(paren
r_void
)paren
id|pcibios_write_config_byte
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x09
comma
id|progif
op_or
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x09
comma
op_amp
id|progif
)paren
op_logical_or
(paren
id|progif
op_amp
l_int|5
)paren
op_ne
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: rewrite of PROGIF failed, wanted 0x%04x, got 0x%04x&bslash;n&quot;
comma
id|name
comma
id|progif
op_or
l_int|5
comma
id|progif
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Setup base registers for IDE command/control spaces for each interface:&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|base
op_assign
id|ide_find_free_region
c_func
(paren
l_int|32
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|reg
op_assign
l_int|0x10
suffix:semicolon
id|reg
op_le
l_int|0x1c
suffix:semicolon
id|reg
op_add_assign
l_int|4
comma
id|base
op_add_assign
l_int|8
)paren
(brace
(paren
r_void
)paren
id|pcibios_write_config_dword
c_func
(paren
id|bus
comma
id|fn
comma
id|reg
comma
id|base
op_or
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|fn
comma
id|reg
comma
op_amp
id|readback
)paren
op_logical_or
(paren
id|readback
op_and_assign
op_complement
l_int|1
)paren
op_ne
id|base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: readback failed for basereg 0x%02x: wrote 0x%04x, read 0x%x04&bslash;n&quot;
comma
id|name
comma
id|reg
comma
id|base
comma
id|readback
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ide_setup_pci_device() looks at the primary/secondary interfaces&n; * on a PCI IDE device and, if they are enabled, prepares the IDE driver&n; * for use with them.  This generic code works for most PCI chipsets.&n; *&n; * One thing that is not standardized is the location of the&n; * primary/secondary interface &quot;enable/disable&quot; bits.  For chipsets that&n; * we &quot;know&quot; about, this information is in the ide_pci_device_t struct;&n; * for all other chipsets, we just assume both interfaces are enabled.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|ide_setup_pci_device
(paren
id|byte
id|bus
comma
id|byte
id|fn
comma
r_int
r_int
id|ccode
comma
id|ide_pci_device_t
op_star
id|d
)paren
)paren
(brace
r_int
r_int
id|port
comma
id|at_least_one_hwif_enabled
op_assign
l_int|0
comma
id|no_autodma
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|pcicmd
op_assign
l_int|0
suffix:semicolon
id|byte
id|tmp
op_assign
l_int|0
comma
id|progif
op_assign
l_int|0
comma
id|pciirq
op_assign
l_int|0
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
comma
op_star
id|mate
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x04
comma
op_amp
id|pcicmd
)paren
op_logical_or
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x09
comma
op_amp
id|progif
)paren
op_logical_or
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x3c
comma
op_amp
id|pciirq
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: error accessing PCI regs&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcicmd
op_amp
l_int|1
)paren
)paren
(brace
multiline_comment|/* is device disabled? */
multiline_comment|/*&n;&t;&t; * PnP BIOS was *supposed* to have set this device up for us,&n;&t;&t; * but we can do it ourselves, so long as the BIOS has assigned an IRQ&n;&t;&t; *  (or possibly the device is using a &quot;legacy header&quot; for IRQs).&n;&t;&t; * Maybe the user deliberately *disabled* the device,&n;&t;&t; * but we&squot;ll eventually ignore it again if no drives respond.&n;&t;&t; */
r_if
c_cond
(paren
id|ide_setup_pci_baseregs
c_func
(paren
id|bus
comma
id|fn
comma
id|d-&gt;name
)paren
op_logical_or
id|pcibios_write_config_word
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x04
comma
id|pcicmd
op_or
l_int|1
)paren
op_logical_or
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x04
comma
op_amp
id|pcicmd
)paren
op_logical_or
op_logical_neg
(paren
id|pcicmd
op_amp
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: device disabled (BIOS)&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|no_autodma
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* default DMA off if we had to configure it here */
id|printk
c_func
(paren
l_string|&quot;%s: device enabled (Linux)&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pciirq
op_logical_or
id|pciirq
op_ge
id|NR_IRQS
)paren
(brace
multiline_comment|/* is pciirq invalid? */
r_if
c_cond
(paren
id|pciirq
op_logical_or
(paren
id|progif
op_amp
l_int|0x5
)paren
)paren
multiline_comment|/* don&squot;t complain if using &quot;legacy&quot; mode */
id|printk
c_func
(paren
l_string|&quot;%s: BIOS returned %d for IRQ (ignored)&bslash;n&quot;
comma
id|d-&gt;name
comma
id|pciirq
)paren
suffix:semicolon
id|pciirq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* probe for it instead */
)brace
multiline_comment|/*&n;&t; * Set up the IDE ports&n;&t; */
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
op_le
l_int|1
suffix:semicolon
op_increment
id|port
)paren
(brace
r_int
r_int
id|base
op_assign
l_int|0
comma
id|ctl
op_assign
l_int|0
suffix:semicolon
id|ide_pci_enablebit_t
op_star
id|e
op_assign
op_amp
(paren
id|d-&gt;enablebits
(braket
id|port
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;reg
op_logical_and
(paren
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|fn
comma
id|e-&gt;reg
comma
op_amp
id|tmp
)paren
op_logical_or
(paren
id|tmp
op_amp
id|e-&gt;mask
)paren
op_ne
id|e-&gt;val
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* port not enabled */
r_if
c_cond
(paren
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x14
op_plus
(paren
id|port
op_star
l_int|8
)paren
comma
op_amp
id|ctl
)paren
op_logical_or
(paren
id|ctl
op_and_assign
op_complement
l_int|3
)paren
op_eq
l_int|0
)paren
id|ctl
op_assign
id|port
ques
c_cond
l_int|0x374
suffix:colon
l_int|0x3f4
suffix:semicolon
multiline_comment|/* use default value */
r_if
c_cond
(paren
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x10
op_plus
(paren
id|port
op_star
l_int|8
)paren
comma
op_amp
id|base
)paren
op_logical_or
(paren
id|base
op_and_assign
op_complement
l_int|7
)paren
op_eq
l_int|0
)paren
id|base
op_assign
id|port
ques
c_cond
l_int|0x170
suffix:colon
l_int|0x1f0
suffix:semicolon
multiline_comment|/* use default value */
r_if
c_cond
(paren
(paren
id|hwif
op_assign
id|ide_match_hwif
c_func
(paren
id|base
comma
id|d-&gt;name
)paren
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
multiline_comment|/* no room in ide_hwifs[] */
r_if
c_cond
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_ne
id|base
)paren
(brace
id|ide_init_hwif_ports
c_func
(paren
id|hwif-&gt;io_ports
comma
id|base
comma
l_int|NULL
)paren
suffix:semicolon
id|hwif-&gt;io_ports
(braket
id|IDE_CONTROL_OFFSET
)braket
op_assign
id|ctl
op_plus
l_int|2
suffix:semicolon
)brace
id|hwif-&gt;chipset
op_assign
id|ide_pci
suffix:semicolon
id|hwif-&gt;pci_bus
op_assign
id|bus
suffix:semicolon
id|hwif-&gt;pci_fn
op_assign
id|fn
suffix:semicolon
id|hwif-&gt;pci_devid
op_assign
id|d-&gt;devid
suffix:semicolon
id|hwif-&gt;channel
op_assign
id|port
suffix:semicolon
id|hwif-&gt;irq
op_assign
id|pciirq
suffix:semicolon
r_if
c_cond
(paren
id|mate
)paren
(brace
id|hwif-&gt;mate
op_assign
id|mate
suffix:semicolon
id|mate-&gt;mate
op_assign
id|hwif
suffix:semicolon
)brace
r_if
c_cond
(paren
id|no_autodma
)paren
id|hwif-&gt;no_autodma
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_BLK_DEV_IDEDMA
r_if
c_cond
(paren
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|DEVID_PDC20246
)paren
op_logical_or
(paren
(paren
id|ccode
op_rshift
l_int|16
)paren
op_eq
id|PCI_CLASS_STORAGE_IDE
op_logical_and
(paren
id|ccode
op_amp
l_int|0x8000
)paren
)paren
)paren
(brace
r_int
r_int
id|extra
op_assign
(paren
op_logical_neg
id|mate
op_logical_and
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|DEVID_PDC20246
)paren
)paren
ques
c_cond
l_int|16
suffix:colon
l_int|0
suffix:semicolon
r_int
r_int
id|dma_base
op_assign
id|ide_get_or_set_dma_base
c_func
(paren
id|hwif
comma
id|extra
comma
id|d-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_base
op_logical_and
op_logical_neg
(paren
id|pcicmd
op_amp
l_int|4
)paren
)paren
(brace
multiline_comment|/*&n; &t; &t;&t;&t; * Set up BM-DMA capability (PnP BIOS should have done this)&n; &t; &t;&t;&t; */
id|hwif-&gt;no_autodma
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* default DMA off if we had to configure it here */
(paren
r_void
)paren
id|pcibios_write_config_word
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x04
comma
(paren
id|pcicmd
op_or
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x04
comma
op_amp
id|pcicmd
)paren
op_logical_or
op_logical_neg
(paren
id|pcicmd
op_amp
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: %s error updating PCICMD&bslash;n&quot;
comma
id|hwif-&gt;name
comma
id|d-&gt;name
)paren
suffix:semicolon
id|dma_base
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dma_base
)paren
id|ide_setup_dma
c_func
(paren
id|hwif
comma
id|dma_base
comma
l_int|8
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s: %s Bus-Master DMA disabled (BIOS), pcicmd=0x%04x, ccode=0x%04x, dma_base=0x%04x&bslash;n&quot;
comma
id|hwif-&gt;name
comma
id|d-&gt;name
comma
id|pcicmd
comma
id|ccode
comma
id|dma_base
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_BLK_DEV_IDEDMA */
r_if
c_cond
(paren
id|d-&gt;init_hwif
)paren
multiline_comment|/* Call chipset-specific routine for each enabled hwif */
id|d
op_member_access_from_pointer
id|init_hwif
c_func
(paren
id|hwif
)paren
suffix:semicolon
id|mate
op_assign
id|hwif
suffix:semicolon
id|at_least_one_hwif_enabled
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|at_least_one_hwif_enabled
)paren
id|printk
c_func
(paren
l_string|&quot;%s: neither IDE port enabled (BIOS)&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ide_scan_pci_device() examines all functions of a PCI device,&n; * looking for IDE interfaces and/or devices in ide_pci_chipsets[].&n; * We cannot use pcibios_find_class() cuz it doesn&squot;t work in all systems.&n; */
DECL|function|ide_scan_pci_device
r_static
r_inline
r_void
id|ide_scan_pci_device
(paren
r_int
r_int
id|bus
comma
r_int
r_int
id|fn
)paren
(brace
r_int
r_int
id|ccode
suffix:semicolon
id|ide_pci_devid_t
id|devid
suffix:semicolon
id|ide_pci_device_t
op_star
id|d
suffix:semicolon
id|byte
id|hedt
suffix:semicolon
r_if
c_cond
(paren
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x0e
comma
op_amp
id|hedt
)paren
)paren
id|hedt
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x00
comma
op_amp
id|devid.vid
)paren
op_logical_or
id|devid.vid
op_eq
l_int|0xffff
op_logical_or
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x02
comma
op_amp
id|devid.did
)paren
op_logical_or
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|devid
comma
id|IDE_PCI_DEVID_NULL
)paren
op_logical_or
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|fn
comma
l_int|0x08
comma
op_amp
id|ccode
)paren
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|d
op_assign
id|ide_pci_chipsets
suffix:semicolon
id|d-&gt;devid.vid
op_logical_and
op_logical_neg
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|devid
)paren
suffix:semicolon
op_increment
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;init_hwif
op_eq
id|IDE_IGNORE
)paren
id|printk
c_func
(paren
l_string|&quot;%s: ignored by ide_scan_pci_device() (uses own driver)&bslash;n&quot;
comma
id|d-&gt;name
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|DEVID_OPTI621V
)paren
op_logical_and
op_logical_neg
(paren
id|fn
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* OPTI Viper-M uses same devid for functions 0 and 1 */
r_else
r_if
c_cond
(paren
op_logical_neg
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|IDE_PCI_DEVID_NULL
)paren
op_logical_or
(paren
id|ccode
op_rshift
l_int|16
)paren
op_eq
id|PCI_CLASS_STORAGE_IDE
)paren
(brace
r_if
c_cond
(paren
id|IDE_PCI_DEVID_EQ
c_func
(paren
id|d-&gt;devid
comma
id|IDE_PCI_DEVID_NULL
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: unknown IDE device on PCI bus %d function %d, VID=%04x, DID=%04x&bslash;n&quot;
comma
id|d-&gt;name
comma
id|bus
comma
id|fn
comma
id|devid.vid
comma
id|devid.did
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s: PCI bus %d function %d&bslash;n&quot;
comma
id|d-&gt;name
comma
id|bus
comma
id|fn
)paren
suffix:semicolon
id|ide_setup_pci_device
c_func
(paren
id|bus
comma
id|fn
comma
id|ccode
comma
id|d
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|hedt
op_eq
l_int|0x80
op_logical_and
(paren
op_increment
id|fn
op_amp
l_int|7
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ide_scan_pcibus() gets invoked at boot time from ide.c&n; *&n; * Loops over all PCI devices on all PCI buses, invoking ide_scan_pci_device().&n; * We cannot use pcibios_find_class() cuz it doesn&squot;t work in all systems.&n; */
DECL|function|ide_scan_pcibus
r_void
id|ide_scan_pcibus
(paren
r_void
)paren
multiline_comment|/* __init */
(brace
r_int
r_int
id|bus
comma
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcibios_present
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|bus
op_assign
l_int|0
suffix:semicolon
id|bus
op_le
l_int|255
suffix:semicolon
op_increment
id|bus
)paren
(brace
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
l_int|256
suffix:semicolon
id|dev
op_add_assign
l_int|8
)paren
(brace
id|ide_scan_pci_device
c_func
(paren
id|bus
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
eof
