multiline_comment|/*&n; * linux/drivers/misc/piix4_acpi.c&n; *&n; *&t;(C) Copyright 1999 Linus Torvalds&n; *&n; * A PM driver for the ACPI portion of the Intel PIIX4&n; * chip.&n; *&n; * This has been known to occasionally work on some laptops.&n; *&n; * It probably only works on Intel PII machines that support&n; * the STPCLK protocol.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
r_extern
r_void
(paren
op_star
id|acpi_idle
)paren
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * This first part should be common to all ACPI&n; * CPU sleep functionality. Assuming we get the&n; * timing heuristics in a better shape than &quot;none&quot; ;)&n; */
DECL|typedef|sleep_fn_t
r_typedef
r_void
(paren
op_star
id|sleep_fn_t
)paren
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * Our &quot;sleep mode&quot; is a fixed point number&n; * with two binary places, ranging between&n; * [0 .. 3[&n; */
DECL|macro|Cx_SHIFT
mdefine_line|#define Cx_SHIFT&t;2
DECL|macro|MAXMODE
mdefine_line|#define MAXMODE&t;&t;((3 &lt;&lt; Cx_SHIFT)-1)
multiline_comment|/*&n; * NOTE!&n; *&n; * Right now this always defaults to C3, which is just broken.&n; * The exit latency is usually too high for much busy IO activity,&n; * and generally it&squot;s not always the best thing to do.&n; *&n; * We should just read the cycle counter around all the cases,&n; * and if we pause for a long time we go to a deeper sleep, while&n; * a short wait makes us go into a lighter sleep.&n; */
DECL|function|common_acpi_idle
r_static
r_void
id|common_acpi_idle
c_func
(paren
id|sleep_fn_t
op_star
id|sleep
)paren
(brace
r_int
id|mode
op_assign
id|MAXMODE
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|current-&gt;need_resched
)paren
(brace
r_int
r_int
id|time
suffix:semicolon
id|time
op_assign
id|get_cycles
c_func
(paren
)paren
suffix:semicolon
id|sleep
(braket
(paren
id|mode
)paren
op_rshift
id|Cx_SHIFT
)braket
(paren
)paren
suffix:semicolon
id|time
op_assign
id|get_cycles
c_func
(paren
)paren
op_minus
id|time
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Yeah, yeah, yeah.&n;&t;&t;&t; *  if (time &gt; Large &amp;&amp; mode &lt; MAXMODE) mode++;&n;&t;&t;&t; *  if (time &lt; Small &amp;&amp; mode &gt; 0) mode--;&n;&t;&t;&t; * Yadda-yadda-yadda.&n;&t;&t;&t; *&n;&t;&t;&t; * &quot;Large&quot; is on the order of half a timer tick.&n;&t;&t;&t; * &quot;Small&quot; is on the order of Large &gt;&gt; 2 or so.&n;&t;&t;&t; *&n;&t;&t;&t; * Somebody should _really_ look at the exact&n;&t;&t;&t; * details. The ACPI bios would give some made-up&n;&t;&t;&t; * numbers, they might be useful (or maybe not:&n;&t;&t;&t; * they are probably tuned for whatever Windows&n;&t;&t;&t; * does, so don&squot;t take them for granted).&n;&t;&t;&t; */
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|check_pgt_cache
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Ok, here starts the magic PIIX4 knowledge */
multiline_comment|/*&n; * Ehh.. We &quot;know&quot; about the northbridge&n; * bus arbitration stuff. Maybe somebody&n; * should actually verify this some day?&n; */
DECL|macro|NORTHBRIDGE_CONTROL
mdefine_line|#define NORTHBRIDGE_CONTROL&t;0x22
DECL|macro|NB_ARBITRATE
mdefine_line|#define&t;&t;NB_ARBITRATE&t;0x01
multiline_comment|/*&n; * PIIX4 ACPI IO offsets and defines&n; */
DECL|macro|PMEN
mdefine_line|#define PMEN&t;&t;0x02
DECL|macro|PMCNTRL
mdefine_line|#define PMCNTRL&t;&t;0x04
DECL|macro|PMTMR
mdefine_line|#define PMTMR&t;&t;0x08
DECL|macro|GPSTS
mdefine_line|#define GPSTS&t;&t;0x0c
DECL|macro|GPEN
mdefine_line|#define GPEN&t;&t;0x0E
DECL|macro|PCNTRL
mdefine_line|#define PCNTRL&t;&t;0x10
DECL|macro|CC_EN
mdefine_line|#define   CC_EN&t;&t;&t;0x0200
DECL|macro|BST_EN
mdefine_line|#define   BST_EN&t;&t;0x0400
DECL|macro|SLEEP_EN
mdefine_line|#define   SLEEP_EN&t;&t;0x0800
DECL|macro|STPCLK_EN
mdefine_line|#define   STPCLK_EN&t;&t;0x1000
DECL|macro|CLKRUN_EN
mdefine_line|#define   CLKRUN_EN&t;&t;0x2000
DECL|macro|PLVL2
mdefine_line|#define PLVL2&t;&t;0x14
DECL|macro|PLVL3
mdefine_line|#define PLVL3&t;&t;0x15
multiline_comment|/*&n; * PIIX4 ACPI PCI configurations offsets and defines&n; */
DECL|macro|DEVACTB
mdefine_line|#define DEVACTB&t;&t;0x58
DECL|macro|BRLD_EN_IRQ0
mdefine_line|#define   BRLD_EN_IRQ0&t;0x01
DECL|macro|BRLD_EN_IRQ
mdefine_line|#define   BRLD_EN_IRQ&t;0x02
DECL|macro|PMREGMISC
mdefine_line|#define PMREGMISC&t;0x80
DECL|macro|PMIOSE
mdefine_line|#define   PMIOSE&t;&t;0x01
DECL|variable|piix4_base_address
r_static
r_int
r_int
id|piix4_base_address
op_assign
l_int|0
suffix:semicolon
DECL|function|piix4_c1_sleep
r_static
r_void
id|piix4_c1_sleep
c_func
(paren
r_void
)paren
(brace
id|asm
r_volatile
(paren
l_string|&quot;sti ; hlt&quot;
suffix:colon
suffix:colon
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
)brace
DECL|function|piix4_c2_sleep
r_static
r_void
id|piix4_c2_sleep
c_func
(paren
r_void
)paren
(brace
id|outl
c_func
(paren
id|CLKRUN_EN
op_or
id|CC_EN
comma
id|piix4_base_address
op_plus
id|PCNTRL
)paren
suffix:semicolon
id|inb
c_func
(paren
id|piix4_base_address
op_plus
id|PLVL2
)paren
suffix:semicolon
)brace
DECL|function|piix4_c3_sleep
r_static
r_void
id|piix4_c3_sleep
c_func
(paren
r_void
)paren
(brace
id|__cli
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|CLKRUN_EN
op_or
id|CC_EN
op_or
id|STPCLK_EN
op_or
id|SLEEP_EN
comma
id|piix4_base_address
op_plus
id|PCNTRL
)paren
suffix:semicolon
id|outb
c_func
(paren
id|NB_ARBITRATE
comma
id|NORTHBRIDGE_CONTROL
)paren
suffix:semicolon
id|inb
c_func
(paren
id|piix4_base_address
op_plus
id|PLVL3
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|NORTHBRIDGE_CONTROL
)paren
suffix:semicolon
id|__sti
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|piix4_sleep
r_static
id|sleep_fn_t
id|piix4_sleep
(braket
)braket
op_assign
(brace
id|piix4_c1_sleep
comma
multiline_comment|/* low-latency C1 (ie &quot;sti ; hlt&quot;) */
id|piix4_c2_sleep
comma
multiline_comment|/* medium latency C2 (ie LVL2 stopckl) */
id|piix4_c3_sleep
multiline_comment|/* high-latency C3 (ie LVL3 sleep) */
)brace
suffix:semicolon
DECL|function|piix4_acpi_idle
r_static
r_void
id|piix4_acpi_idle
c_func
(paren
r_void
)paren
(brace
id|common_acpi_idle
c_func
(paren
id|piix4_sleep
)paren
suffix:semicolon
)brace
DECL|function|piix4_acpi_init
r_static
r_int
id|__init
id|piix4_acpi_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* This is the PIIX4 ACPI device */
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
id|u32
id|base
comma
id|val
suffix:semicolon
id|u16
id|cmd
suffix:semicolon
id|u8
id|pmregmisc
suffix:semicolon
macro_line|#ifdef __SMP__
multiline_comment|/*&n;&t; * We can&squot;t really do idle things with multiple CPU&squot;s, I&squot;m&n;&t; * afraid.  We&squot;d need a per-CPU ACPI device.&n;&t; */
r_if
c_cond
(paren
id|smp_num_cpus
OG
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371AB_3
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Read the IO base value, and verify that it makes sense&n;&t; *&n;&t; * We could enable this if it wasn&squot;t enabled before, but&n;&t; * let&squot;s walk before we run..&n;&t; */
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmd
op_amp
id|PCI_COMMAND_IO
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PMREGMISC
comma
op_amp
id|pmregmisc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pmregmisc
op_amp
id|PMIOSE
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x40
comma
op_amp
id|base
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|base
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|base
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Found PIIX4 ACPI device at %04x&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
id|piix4_base_address
op_assign
id|base
suffix:semicolon
multiline_comment|/* Enable stopcklock, sleep and bursts, along with clock control */
id|outl
c_func
(paren
id|CLKRUN_EN
op_or
id|CC_EN
op_or
id|STPCLK_EN
op_or
id|SLEEP_EN
comma
id|piix4_base_address
op_plus
id|PCNTRL
)paren
suffix:semicolon
multiline_comment|/* Make all unmasked interrupts be BREAK events */
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|DEVACTB
comma
op_amp
id|val
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|DEVACTB
comma
id|val
op_or
id|BRLD_EN_IRQ0
op_or
id|BRLD_EN_IRQ
)paren
suffix:semicolon
multiline_comment|/* Set up the new idle handler.. */
id|acpi_idle
op_assign
id|piix4_acpi_idle
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|piix4_acpi_init
id|__initcall
c_func
(paren
id|piix4_acpi_init
)paren
suffix:semicolon
eof
