multiline_comment|/*&n; *  acpi.c - Linux ACPI driver&n; *&n; *  Copyright (C) 1999 Andrew Henroid&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
multiline_comment|/*&n; * See http://www.geocities.com/SiliconValley/Hardware/3165/&n; * for the user-level ACPI stuff&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
multiline_comment|/*&n; * Defines for 2.2.x&n; */
macro_line|#ifndef __exit
DECL|macro|__exit
mdefine_line|#define __exit
macro_line|#endif
macro_line|#ifndef module_init
DECL|macro|module_init
mdefine_line|#define module_init(x) int init_module(void) {return x();}
macro_line|#endif
macro_line|#ifndef module_exit
DECL|macro|module_exit
mdefine_line|#define module_exit(x) void cleanup_module(void) {x();}
macro_line|#endif
macro_line|#ifndef DECLARE_WAIT_QUEUE_HEAD
DECL|macro|DECLARE_WAIT_QUEUE_HEAD
mdefine_line|#define DECLARE_WAIT_QUEUE_HEAD(x) struct wait_queue * x = NULL
macro_line|#endif
DECL|variable|acpi_facp
r_static
r_struct
id|acpi_facp
op_star
id|acpi_facp
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|acpi_facp_addr
r_static
r_int
r_int
id|acpi_facp_addr
op_assign
l_int|0
suffix:semicolon
DECL|variable|acpi_dsdt_addr
r_static
r_int
r_int
id|acpi_dsdt_addr
op_assign
l_int|0
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|acpi_wait_event
)paren
suffix:semicolon
multiline_comment|/*&n; * Get the value of the fixed event status register&n; */
DECL|function|acpi_read_pm1_status
r_static
id|u32
id|acpi_read_pm1_status
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
)paren
(brace
id|u32
id|value
op_assign
id|inw
c_func
(paren
id|facp-&gt;pm1a_evt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|facp-&gt;pm1b_evt
)paren
(brace
id|value
op_or_assign
id|inw
c_func
(paren
id|facp-&gt;pm1b_evt
)paren
suffix:semicolon
)brace
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the value of the fixed event status register (clear events)&n; */
DECL|function|acpi_write_pm1_status
r_static
r_void
id|acpi_write_pm1_status
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
comma
id|u32
id|value
)paren
(brace
id|outw
c_func
(paren
id|value
comma
id|facp-&gt;pm1a_evt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|facp-&gt;pm1b_evt
)paren
(brace
id|outw
c_func
(paren
id|value
comma
id|facp-&gt;pm1b_evt
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Set the value of the fixed event enable register (enable events)&n; */
DECL|function|acpi_write_pm1_enable
r_static
r_void
id|acpi_write_pm1_enable
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
comma
id|u32
id|value
)paren
(brace
r_int
id|offset
op_assign
id|facp-&gt;pm1_evt_len
op_rshift
l_int|1
suffix:semicolon
id|outw
c_func
(paren
id|value
comma
id|facp-&gt;pm1a_evt
op_plus
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|facp-&gt;pm1b_evt
)paren
(brace
id|outw
c_func
(paren
id|value
comma
id|facp-&gt;pm1b_evt
op_plus
id|offset
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Get the value of the general-purpose event status register&n; */
DECL|function|acpi_read_gpe_status
r_static
id|u32
id|acpi_read_gpe_status
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
)paren
(brace
id|u32
id|value
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|size
suffix:semicolon
r_if
c_cond
(paren
id|facp-&gt;gpe1
)paren
(brace
id|size
op_assign
id|facp-&gt;gpe1_len
op_rshift
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|size
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|value
op_assign
(paren
id|value
op_lshift
l_int|8
)paren
op_or
id|inb
c_func
(paren
id|facp-&gt;gpe1
op_plus
id|i
)paren
suffix:semicolon
)brace
)brace
id|size
op_assign
id|facp-&gt;gpe0_len
op_rshift
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|size
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|value
op_assign
(paren
id|value
op_lshift
l_int|8
)paren
op_or
id|inb
c_func
(paren
id|facp-&gt;gpe0
op_plus
id|i
)paren
suffix:semicolon
)brace
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the value of the general-purpose event status register (clear events)&n; */
DECL|function|acpi_write_gpe_status
r_static
r_void
id|acpi_write_gpe_status
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
comma
id|u32
id|value
)paren
(brace
r_int
id|i
comma
id|size
suffix:semicolon
id|size
op_assign
id|facp-&gt;gpe0_len
op_rshift
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|value
op_amp
l_int|0xff
comma
id|facp-&gt;gpe0
op_plus
id|i
)paren
suffix:semicolon
id|value
op_rshift_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|facp-&gt;gpe1
)paren
(brace
id|size
op_assign
id|facp-&gt;gpe1_len
op_rshift
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|value
op_amp
l_int|0xff
comma
id|facp-&gt;gpe1
op_plus
id|i
)paren
suffix:semicolon
id|value
op_rshift_assign
l_int|8
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Set the value of the general-purpose event enable register (enable events)&n; */
DECL|function|acpi_write_gpe_enable
r_static
r_void
id|acpi_write_gpe_enable
c_func
(paren
r_struct
id|acpi_facp
op_star
id|facp
comma
id|u32
id|value
)paren
(brace
r_int
id|i
comma
id|offset
suffix:semicolon
id|offset
op_assign
id|facp-&gt;gpe0_len
op_rshift
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|offset
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|value
op_amp
l_int|0xff
comma
id|facp-&gt;gpe0
op_plus
id|offset
op_plus
id|i
)paren
suffix:semicolon
id|value
op_rshift_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|facp-&gt;gpe1
)paren
(brace
id|offset
op_assign
id|facp-&gt;gpe1_len
op_rshift
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|offset
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|value
op_amp
l_int|0xff
comma
id|facp-&gt;gpe1
op_plus
id|offset
op_plus
id|i
)paren
suffix:semicolon
id|value
op_rshift_assign
l_int|8
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Map an ACPI table into virtual memory&n; */
DECL|function|acpi_map_table
r_static
r_struct
id|acpi_table
op_star
id|__init
id|acpi_map_table
c_func
(paren
id|u32
id|addr
)paren
(brace
r_struct
id|acpi_table
op_star
id|table
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|addr
)paren
(brace
singleline_comment|// map table header to determine size
id|table
op_assign
(paren
r_struct
id|acpi_table
op_star
)paren
id|ioremap_nocache
c_func
(paren
(paren
r_int
r_int
)paren
id|addr
comma
r_sizeof
(paren
r_struct
id|acpi_table
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|table
)paren
(brace
r_int
r_int
id|table_size
op_assign
id|table-&gt;length
suffix:semicolon
id|iounmap
c_func
(paren
id|table
)paren
suffix:semicolon
singleline_comment|// remap entire table
id|table
op_assign
(paren
r_struct
id|acpi_table
op_star
)paren
id|ioremap_nocache
c_func
(paren
(paren
r_int
r_int
)paren
id|addr
comma
id|table_size
)paren
suffix:semicolon
)brace
)brace
r_return
id|table
suffix:semicolon
)brace
multiline_comment|/*&n; * Unmap an ACPI table from virtual memory&n; */
DECL|function|acpi_unmap_table
r_static
r_void
id|acpi_unmap_table
c_func
(paren
r_struct
id|acpi_table
op_star
id|table
)paren
(brace
r_if
c_cond
(paren
id|table
)paren
(brace
id|iounmap
c_func
(paren
id|table
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Locate and map ACPI tables (FACP, DSDT, ...)&n; */
DECL|function|acpi_map_tables
r_static
r_int
id|__init
id|acpi_map_tables
c_func
(paren
r_void
)paren
(brace
r_struct
id|acpi_rsdp
op_star
id|rsdp
suffix:semicolon
r_struct
id|acpi_table
op_star
id|rsdt
suffix:semicolon
id|u32
op_star
id|rsdt_entry
suffix:semicolon
r_int
id|rsdt_entry_count
suffix:semicolon
id|u8
op_star
id|i
suffix:semicolon
singleline_comment|// search BIOS memory for RSDP
r_for
c_loop
(paren
id|i
op_assign
id|ACPI_BIOS_ROM_BASE
suffix:semicolon
id|i
OL
id|ACPI_BIOS_ROM_END
suffix:semicolon
id|i
op_add_assign
l_int|16
)paren
(brace
id|rsdp
op_assign
(paren
r_struct
id|acpi_rsdp
op_star
)paren
id|i
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
id|rsdp-&gt;signature
)paren
op_eq
id|ACPI_RSDP1_SIG
op_logical_and
id|readl
c_func
(paren
id|rsdp-&gt;signature
op_plus
l_int|1
)paren
op_eq
id|ACPI_RSDP2_SIG
)paren
(brace
r_char
id|oem
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|j
suffix:semicolon
singleline_comment|// strip trailing space and print OEM identifier
id|memcpy_fromio
c_func
(paren
id|oem
comma
id|rsdp-&gt;oem
comma
l_int|6
)paren
suffix:semicolon
id|oem
(braket
l_int|6
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|5
suffix:semicolon
id|j
OG
l_int|0
op_logical_and
(paren
id|oem
(braket
id|j
)braket
op_eq
l_char|&squot;&bslash;0&squot;
op_logical_or
id|oem
(braket
id|j
)braket
op_eq
l_char|&squot; &squot;
)paren
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|oem
(braket
id|j
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ACPI: &bslash;&quot;%s&bslash;&quot; found at 0x%p&bslash;n&quot;
comma
id|oem
comma
(paren
r_void
op_star
)paren
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_ge
id|ACPI_BIOS_ROM_END
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACPI: no RSDP found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
singleline_comment|// fetch RSDT from RSDP
id|rsdt
op_assign
id|acpi_map_table
c_func
(paren
id|readl
c_func
(paren
op_amp
id|rsdp-&gt;rsdt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rsdt
op_logical_or
id|rsdt-&gt;signature
op_ne
id|ACPI_RSDT_SIG
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACPI: no RSDT found&bslash;n&quot;
)paren
suffix:semicolon
id|acpi_unmap_table
c_func
(paren
id|rsdt
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
singleline_comment|// search RSDT for FACP
id|acpi_facp
op_assign
l_int|NULL
suffix:semicolon
id|rsdt_entry
op_assign
(paren
id|u32
op_star
)paren
(paren
id|rsdt
op_plus
l_int|1
)paren
suffix:semicolon
id|rsdt_entry_count
op_assign
(paren
r_int
)paren
(paren
(paren
id|rsdt-&gt;length
op_minus
r_sizeof
(paren
op_star
id|rsdt
)paren
)paren
op_rshift
l_int|2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rsdt_entry_count
)paren
(brace
r_struct
id|acpi_table
op_star
id|dt
op_assign
id|acpi_map_table
c_func
(paren
op_star
id|rsdt_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dt
op_logical_and
id|dt-&gt;signature
op_eq
id|ACPI_FACP_SIG
)paren
(brace
id|acpi_facp
op_assign
(paren
r_struct
id|acpi_facp
op_star
)paren
id|dt
suffix:semicolon
id|acpi_facp_addr
op_assign
op_star
id|rsdt_entry
suffix:semicolon
id|acpi_dsdt_addr
op_assign
id|acpi_facp-&gt;dsdt
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|acpi_unmap_table
c_func
(paren
id|dt
)paren
suffix:semicolon
)brace
id|rsdt_entry
op_increment
suffix:semicolon
id|rsdt_entry_count
op_decrement
suffix:semicolon
)brace
id|acpi_unmap_table
c_func
(paren
id|rsdt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_facp
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACPI: no FACP found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Unmap ACPI tables (FACP, DSDT, ...)&n; */
DECL|function|acpi_unmap_tables
r_static
r_void
id|acpi_unmap_tables
c_func
(paren
r_void
)paren
(brace
id|acpi_idle
op_assign
l_int|NULL
suffix:semicolon
id|acpi_dsdt_addr
op_assign
l_int|0
suffix:semicolon
id|acpi_facp_addr
op_assign
l_int|0
suffix:semicolon
id|acpi_unmap_table
c_func
(paren
(paren
r_struct
id|acpi_table
op_star
)paren
id|acpi_facp
)paren
suffix:semicolon
id|acpi_facp
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle an ACPI SCI (fixed or general purpose event)&n; */
DECL|function|acpi_irq
r_static
r_void
id|acpi_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|status
suffix:semicolon
singleline_comment|// detect and disable any fixed events
id|status
op_assign
id|acpi_read_pm1_status
c_func
(paren
id|acpi_facp
)paren
suffix:semicolon
id|acpi_write_pm1_enable
c_func
(paren
id|acpi_facp
comma
op_complement
id|status
)paren
suffix:semicolon
singleline_comment|// detect and disable any general-purpose events
id|status
op_assign
id|acpi_read_gpe_status
c_func
(paren
id|acpi_facp
)paren
suffix:semicolon
id|acpi_write_gpe_enable
c_func
(paren
id|acpi_facp
comma
op_complement
id|status
)paren
suffix:semicolon
singleline_comment|// notify process reading /dev/acpi
id|wake_up_interruptible
c_func
(paren
op_amp
id|acpi_wait_event
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle open of /dev/acpi&n; */
DECL|function|acpi_open
r_static
r_int
id|acpi_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle close of /dev/acpi&n; */
DECL|function|acpi_release
r_static
r_int
id|acpi_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle command to /dev/acpi&n; */
DECL|function|acpi_ioctl
r_static
r_int
id|acpi_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ACPI_FIND_TABLES
suffix:colon
id|status
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|acpi_find_tables
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
r_struct
id|acpi_find_tables
op_star
id|rqst
op_assign
(paren
r_struct
id|acpi_find_tables
op_star
)paren
id|arg
suffix:semicolon
id|put_user
c_func
(paren
id|acpi_facp_addr
comma
op_amp
id|rqst-&gt;facp
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|acpi_dsdt_addr
comma
op_amp
id|rqst-&gt;dsdt
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACPI_WAIT_EVENT
suffix:colon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|acpi_wait_event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|variable|acpi_fops
r_static
r_struct
id|file_operations
id|acpi_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* llseek */
l_int|NULL
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll */
id|acpi_ioctl
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
id|acpi_open
comma
multiline_comment|/* open */
l_int|NULL
comma
multiline_comment|/* flush */
id|acpi_release
comma
multiline_comment|/* release */
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* check_media_change */
l_int|NULL
comma
multiline_comment|/* revalidate */
l_int|NULL
comma
multiline_comment|/* lock */
)brace
suffix:semicolon
DECL|variable|acpi_device
r_static
r_struct
id|miscdevice
id|acpi_device
op_assign
(brace
id|ACPI_MINOR_DEV
comma
l_string|&quot;acpi&quot;
comma
op_amp
id|acpi_fops
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Make it impossible to enter L2/L3 until after we&squot;ve initialized */
DECL|variable|acpi_p_lvl2_lat
r_static
r_int
r_int
id|acpi_p_lvl2_lat
op_assign
op_complement
l_int|0UL
suffix:semicolon
DECL|variable|acpi_p_lvl3_lat
r_static
r_int
r_int
id|acpi_p_lvl3_lat
op_assign
op_complement
l_int|0UL
suffix:semicolon
multiline_comment|/* Initialize to guaranteed harmless port read */
DECL|variable|acpi_p_lvl2
r_static
id|u16
id|acpi_p_lvl2
op_assign
l_int|0x80
suffix:semicolon
DECL|variable|acpi_p_lvl3
r_static
id|u16
id|acpi_p_lvl3
op_assign
l_int|0x80
suffix:semicolon
DECL|function|acpi_idle_handler
r_static
r_void
id|acpi_idle_handler
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|time
suffix:semicolon
r_static
r_int
id|sleep_level
op_assign
l_int|1
suffix:semicolon
id|time
op_assign
id|inl
c_func
(paren
id|acpi_facp-&gt;pm_tmr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sleep_level
)paren
(brace
r_case
l_int|1
suffix:colon
id|__asm__
id|__volatile__
c_func
(paren
l_string|&quot;sti ; hlt&quot;
suffix:colon
suffix:colon
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|inb
c_func
(paren
id|acpi_p_lvl2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* Disable PCI arbitration while sleeping, to avoid DMA corruption? */
r_if
c_cond
(paren
id|acpi_facp-&gt;pm2_cnt
)paren
(brace
r_int
r_int
id|port
op_assign
id|acpi_facp-&gt;pm2_cnt
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|port
)paren
op_or
id|ACPI_ARB_DIS
comma
id|port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|acpi_p_lvl3
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|port
)paren
op_amp
op_complement
id|ACPI_ARB_DIS
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|inb
c_func
(paren
id|acpi_p_lvl3
)paren
suffix:semicolon
)brace
id|time
op_assign
(paren
id|inl
c_func
(paren
id|acpi_facp-&gt;pm_tmr
)paren
op_minus
id|time
)paren
op_amp
id|ACPI_TMR_MASK
suffix:semicolon
r_if
c_cond
(paren
id|time
OG
id|acpi_p_lvl3_lat
)paren
id|sleep_level
op_assign
l_int|3
suffix:semicolon
r_else
r_if
c_cond
(paren
id|time
OG
id|acpi_p_lvl2_lat
)paren
id|sleep_level
op_assign
l_int|2
suffix:semicolon
r_else
id|sleep_level
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize and enable ACPI&n; */
DECL|function|acpi_init
r_static
r_int
id|__init
id|acpi_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|acpi_map_tables
c_func
(paren
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|acpi_facp-&gt;sci_int
comma
id|acpi_irq
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;acpi&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACPI: SCI (IRQ%d) allocation failed&bslash;n&quot;
comma
id|acpi_facp-&gt;sci_int
)paren
suffix:semicolon
id|acpi_unmap_tables
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|acpi_device
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ACPI: misc. register failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set up the ACPI idle function. Note that we can&squot;t really&n;&t; * do this with multiple CPU&squot;s, we&squot;d need a per-CPU ACPI&n;&t; * device..&n;&t; */
macro_line|#ifdef __SMP__
r_if
c_cond
(paren
id|smp_num_cpus
OG
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
id|acpi_idle
op_assign
id|acpi_idle_handler
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Disable and deinitialize ACPI&n; */
DECL|function|acpi_exit
r_static
r_void
id|__exit
id|acpi_exit
c_func
(paren
r_void
)paren
(brace
id|misc_deregister
c_func
(paren
op_amp
id|acpi_device
)paren
suffix:semicolon
singleline_comment|// disable and clear any pending events
id|acpi_write_gpe_enable
c_func
(paren
id|acpi_facp
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|acpi_read_gpe_status
c_func
(paren
id|acpi_facp
)paren
)paren
(brace
id|acpi_write_gpe_status
c_func
(paren
id|acpi_facp
comma
id|acpi_read_gpe_status
c_func
(paren
id|acpi_facp
)paren
)paren
suffix:semicolon
)brace
id|acpi_write_pm1_enable
c_func
(paren
id|acpi_facp
comma
l_int|0
)paren
suffix:semicolon
id|acpi_write_pm1_status
c_func
(paren
id|acpi_facp
comma
id|acpi_read_pm1_status
c_func
(paren
id|acpi_facp
)paren
)paren
suffix:semicolon
singleline_comment|// disable SCI and free interrupt
id|outb
c_func
(paren
id|acpi_facp-&gt;acpi_disable
comma
id|acpi_facp-&gt;smi_cmd
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|acpi_facp-&gt;sci_int
comma
l_int|NULL
)paren
suffix:semicolon
id|acpi_unmap_tables
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|module_init
c_func
(paren
id|acpi_init
)paren
id|module_exit
c_func
(paren
id|acpi_exit
)paren
macro_line|#else
id|__initcall
c_func
(paren
id|acpi_init
)paren
suffix:semicolon
macro_line|#endif
eof
