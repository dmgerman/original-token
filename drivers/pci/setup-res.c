multiline_comment|/*&n; *&t;drivers/pci/setup-res.c&n; *&n; * Extruded from code written by&n; *      Dave Rusling (david.rusling@reo.mts.dec.com)&n; *      David Mosberger (davidm@cs.arizona.edu)&n; *&t;David Miller (davem@redhat.com)&n; *&n; * Support routines for initializing a PCI subsystem.&n; */
multiline_comment|/* fixed for multiple pci buses, 1999 Andrea Arcangeli &lt;andrea@suse.de&gt; */
multiline_comment|/*&n; * Nov 2000, Ivan Kokshaysky &lt;ink@jurassic.park.msu.ru&gt;&n; *&t;     Resource sorting&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/cache.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
DECL|macro|DEBUG_CONFIG
mdefine_line|#define DEBUG_CONFIG 1
macro_line|#if DEBUG_CONFIG
DECL|macro|DBGC
macro_line|# define DBGC(args)     printk args
macro_line|#else
DECL|macro|DBGC
macro_line|# define DBGC(args)
macro_line|#endif
r_int
id|__init
DECL|function|pci_claim_resource
id|pci_claim_resource
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|resource
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|dev-&gt;resource
(braket
id|resource
)braket
suffix:semicolon
r_struct
id|resource
op_star
id|root
op_assign
id|pci_find_parent_resource
c_func
(paren
id|dev
comma
id|res
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|root
op_ne
l_int|NULL
)paren
(brace
id|err
op_assign
id|request_resource
c_func
(paren
id|root
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: Address space collision on &quot;
l_string|&quot;region %d of device %s [%lx:%lx]&bslash;n&quot;
comma
id|resource
comma
id|dev-&gt;name
comma
id|res-&gt;start
comma
id|res-&gt;end
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: No parent found for region %d &quot;
l_string|&quot;of device %s&bslash;n&quot;
comma
id|resource
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Given the PCI bus a device resides on, try to&n; * find an acceptable resource allocation for a&n; * specific device resource..&n; */
DECL|function|pci_assign_bus_resource
r_static
r_int
id|pci_assign_bus_resource
c_func
(paren
r_const
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|resource
op_star
id|res
comma
r_int
r_int
id|size
comma
r_int
r_int
id|min
comma
r_int
r_int
id|type_mask
comma
r_int
id|resno
)paren
(brace
r_int
id|i
suffix:semicolon
id|type_mask
op_or_assign
id|IORESOURCE_IO
op_or
id|IORESOURCE_MEM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
id|bus-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
r_continue
suffix:semicolon
multiline_comment|/* type_mask must match */
r_if
c_cond
(paren
(paren
id|res-&gt;flags
op_xor
id|r-&gt;flags
)paren
op_amp
id|type_mask
)paren
r_continue
suffix:semicolon
multiline_comment|/* We cannot allocate a non-prefetching resource from a pre-fetching area */
r_if
c_cond
(paren
(paren
id|r-&gt;flags
op_amp
id|IORESOURCE_PREFETCH
)paren
op_logical_and
op_logical_neg
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_PREFETCH
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Ok, try it out.. */
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
id|r
comma
id|res
comma
id|size
comma
id|min
comma
op_minus
l_int|1
comma
id|size
comma
id|pcibios_align_resource
comma
id|dev
)paren
OL
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/* Update PCI config space.  */
id|pcibios_update_resource
c_func
(paren
id|dev
comma
id|r
comma
id|res
comma
id|resno
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_int
DECL|function|pci_assign_resource
id|pci_assign_resource
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|i
)paren
(brace
r_const
r_struct
id|pci_bus
op_star
id|bus
op_assign
id|dev-&gt;bus
suffix:semicolon
r_struct
id|resource
op_star
id|res
op_assign
id|dev-&gt;resource
op_plus
id|i
suffix:semicolon
r_int
r_int
id|size
comma
id|min
suffix:semicolon
id|size
op_assign
id|res-&gt;end
op_minus
id|res-&gt;start
op_plus
l_int|1
suffix:semicolon
id|min
op_assign
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
ques
c_cond
id|PCIBIOS_MIN_IO
suffix:colon
id|PCIBIOS_MIN_MEM
suffix:semicolon
multiline_comment|/* First, try exact prefetching match.. */
r_if
c_cond
(paren
id|pci_assign_bus_resource
c_func
(paren
id|bus
comma
id|dev
comma
id|res
comma
id|size
comma
id|min
comma
id|IORESOURCE_PREFETCH
comma
id|i
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * That failed.&n;&t;&t; *&n;&t;&t; * But a prefetching area can handle a non-prefetching&n;&t;&t; * window (it will just not perform as well).&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_PREFETCH
)paren
op_logical_or
id|pci_assign_bus_resource
c_func
(paren
id|bus
comma
id|dev
comma
id|res
comma
id|size
comma
id|min
comma
l_int|0
comma
id|i
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCI: Failed to allocate resource %d for %s&bslash;n&quot;
comma
id|i
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
id|DBGC
c_func
(paren
(paren
l_string|&quot;  got res[%lx:%lx] for resource %d of %s&bslash;n&quot;
comma
id|res-&gt;start
comma
id|res-&gt;end
comma
id|i
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Sort resources of a given type by alignment */
r_void
id|__init
DECL|function|pdev_sort_resources
id|pdev_sort_resources
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|resource_list
op_star
id|head
comma
id|u32
id|type_mask
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCI_NUM_RESOURCES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|r
suffix:semicolon
r_struct
id|resource_list
op_star
id|list
comma
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|r_size
suffix:semicolon
multiline_comment|/* PCI-PCI bridges may have I/O ports or&n;&t;&t;   memory on the primary bus */
r_if
c_cond
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
op_eq
id|PCI_CLASS_BRIDGE_PCI
op_logical_and
id|i
op_ge
id|PCI_BRIDGE_RESOURCES
)paren
r_continue
suffix:semicolon
id|r
op_assign
op_amp
id|dev-&gt;resource
(braket
id|i
)braket
suffix:semicolon
id|r_size
op_assign
id|r-&gt;end
op_minus
id|r-&gt;start
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|r-&gt;flags
op_amp
id|type_mask
)paren
op_logical_or
id|r-&gt;parent
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: Ignore bogus resource %d &quot;
l_string|&quot;[%lx:%lx] of %s&bslash;n&quot;
comma
id|i
comma
id|r-&gt;start
comma
id|r-&gt;end
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|list
op_assign
id|head
suffix:semicolon
suffix:semicolon
id|list
op_assign
id|list-&gt;next
)paren
(brace
r_int
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_struct
id|resource_list
op_star
id|ln
op_assign
id|list-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|ln
)paren
id|size
op_assign
id|ln-&gt;res-&gt;end
op_minus
id|ln-&gt;res-&gt;start
suffix:semicolon
r_if
c_cond
(paren
id|r_size
OG
id|size
)paren
(brace
id|tmp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|tmp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|tmp-&gt;next
op_assign
id|ln
suffix:semicolon
id|tmp-&gt;res
op_assign
id|r
suffix:semicolon
id|tmp-&gt;dev
op_assign
id|dev
suffix:semicolon
id|list-&gt;next
op_assign
id|tmp
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_void
id|__init
DECL|function|pdev_enable_device
id|pdev_enable_device
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|u16
id|cmd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DBGC
c_func
(paren
(paren
l_string|&quot;PCI enable device: (%s)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCI_NUM_RESOURCES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|dev-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
id|cmd
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
)brace
multiline_comment|/* Special case, disable the ROM.  Several devices act funny&n;&t;   (ie. do not respond to memory space writes) when it is left&n;&t;   enabled.  A good example are QlogicISP adapters.  */
r_if
c_cond
(paren
id|dev-&gt;rom_base_reg
)paren
(brace
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|dev-&gt;rom_base_reg
comma
op_amp
id|reg
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
id|PCI_ROM_ADDRESS_ENABLE
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|dev-&gt;rom_base_reg
comma
id|reg
)paren
suffix:semicolon
id|dev-&gt;resource
(braket
id|PCI_ROM_RESOURCE
)braket
dot
id|flags
op_and_assign
op_complement
id|PCI_ROM_ADDRESS_ENABLE
suffix:semicolon
)brace
multiline_comment|/* All of these (may) have I/O scattered all around and may not&n;&t;   use I/O base address registers at all.  So we just have to&n;&t;   always enable IO to these devices.  */
r_if
c_cond
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_NOT_DEFINED
op_logical_or
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_NOT_DEFINED_VGA
op_logical_or
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_STORAGE_IDE
op_logical_or
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|16
)paren
op_eq
id|PCI_BASE_CLASS_DISPLAY
)paren
(brace
id|cmd
op_or_assign
id|PCI_COMMAND_IO
suffix:semicolon
)brace
multiline_comment|/* ??? Always turn on bus mastering.  If the device doesn&squot;t support&n;&t;   it, the bit will go into the bucket. */
id|cmd
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
multiline_comment|/* Set the cache line and default latency (32).  */
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_CACHE_LINE_SIZE
comma
(paren
l_int|32
op_lshift
l_int|8
)paren
op_or
(paren
id|L1_CACHE_BYTES
op_div
r_sizeof
(paren
id|u32
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable the appropriate bits in the PCI command register.  */
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
id|DBGC
c_func
(paren
(paren
l_string|&quot;  cmd reg 0x%x&bslash;n&quot;
comma
id|cmd
)paren
)paren
suffix:semicolon
)brace
eof
