multiline_comment|/*&n; *&t;drivers/pci/setup-bus.c&n; *&n; * Extruded from code written by&n; *      Dave Rusling (david.rusling@reo.mts.dec.com)&n; *      David Mosberger (davidm@cs.arizona.edu)&n; *&t;David Miller (davem@redhat.com)&n; *&n; * Support routines for initializing a PCI subsystem.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/cache.h&gt;
DECL|macro|DEBUG_CONFIG
mdefine_line|#define DEBUG_CONFIG 0
macro_line|#if DEBUG_CONFIG
DECL|macro|DBGC
macro_line|# define DBGC(args)     printk args
macro_line|#else
DECL|macro|DBGC
macro_line|# define DBGC(args)
macro_line|#endif
DECL|macro|ROUND_UP
mdefine_line|#define ROUND_UP(x, a)&t;&t;(((x) + (a) - 1) &amp; ~((a) - 1))
DECL|macro|ROUND_DOWN
mdefine_line|#define ROUND_DOWN(x, a)&t;((x) &amp; ~((a) - 1))
r_static
r_void
id|__init
DECL|function|pbus_set_ranges
id|pbus_set_ranges
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pbus_set_ranges_data
op_star
id|outer
)paren
(brace
r_struct
id|pbus_set_ranges_data
id|inner
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_struct
id|list_head
op_star
id|ln
suffix:semicolon
id|inner.found_vga
op_assign
l_int|0
suffix:semicolon
id|inner.mem_start
op_assign
id|inner.io_start
op_assign
op_complement
l_int|0UL
suffix:semicolon
id|inner.mem_end
op_assign
id|inner.io_end
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Collect information about how our direct children are layed out. */
r_for
c_loop
(paren
id|ln
op_assign
id|bus-&gt;devices.next
suffix:semicolon
id|ln
op_ne
op_amp
id|bus-&gt;devices
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
(brace
r_int
id|i
suffix:semicolon
id|dev
op_assign
id|pci_dev_b
c_func
(paren
id|ln
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PCI_NUM_RESOURCES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
op_amp
id|dev-&gt;resource
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_IO
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;start
OL
id|inner.io_start
)paren
id|inner.io_start
op_assign
id|res-&gt;start
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;end
OG
id|inner.io_end
)paren
id|inner.io_end
op_assign
id|res-&gt;end
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|res-&gt;flags
op_amp
id|IORESOURCE_MEM
)paren
(brace
r_if
c_cond
(paren
id|res-&gt;start
OL
id|inner.mem_start
)paren
id|inner.mem_start
op_assign
id|res-&gt;start
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;end
OG
id|inner.mem_end
)paren
id|inner.mem_end
op_assign
id|res-&gt;end
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_CLASS_DISPLAY_VGA
)paren
id|inner.found_vga
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* And for all of the sub-busses.  */
r_for
c_loop
(paren
id|ln
op_assign
id|bus-&gt;children.next
suffix:semicolon
id|ln
op_ne
op_amp
id|bus-&gt;children
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
id|pbus_set_ranges
c_func
(paren
id|pci_bus_b
c_func
(paren
id|ln
)paren
comma
op_amp
id|inner
)paren
suffix:semicolon
multiline_comment|/* Align the values.  */
id|inner.io_start
op_assign
id|ROUND_DOWN
c_func
(paren
id|inner.io_start
comma
l_int|4
op_star
l_int|1024
)paren
suffix:semicolon
id|inner.io_end
op_assign
id|ROUND_UP
c_func
(paren
id|inner.io_end
comma
l_int|4
op_star
l_int|1024
)paren
suffix:semicolon
id|inner.mem_start
op_assign
id|ROUND_DOWN
c_func
(paren
id|inner.mem_start
comma
l_int|1
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
id|inner.mem_end
op_assign
id|ROUND_UP
c_func
(paren
id|inner.mem_end
comma
l_int|1
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
id|pcibios_fixup_pbus_ranges
c_func
(paren
id|bus
comma
op_amp
id|inner
)paren
suffix:semicolon
multiline_comment|/* Configure the bridge, if possible.  */
r_if
c_cond
(paren
id|bus-&gt;self
)paren
(brace
r_struct
id|pci_dev
op_star
id|bridge
op_assign
id|bus-&gt;self
suffix:semicolon
id|u32
id|l
suffix:semicolon
multiline_comment|/* Set up the top and bottom of the PCI I/O segment&n;                   for this bus.  */
id|pci_read_config_dword
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE
comma
op_amp
id|l
)paren
suffix:semicolon
id|l
op_and_assign
l_int|0xffff0000
suffix:semicolon
id|l
op_or_assign
(paren
id|inner.io_start
op_rshift
l_int|8
)paren
op_amp
l_int|0x00f0
suffix:semicolon
id|l
op_or_assign
(paren
id|inner.io_end
op_minus
l_int|1
)paren
op_amp
l_int|0xf000
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE
comma
id|l
)paren
suffix:semicolon
multiline_comment|/*&n;                 * Clear out the upper 16 bits of IO base/limit.&n;                 * Clear out the upper 32 bits of PREF base/limit.&n;                 */
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE_UPPER16
comma
l_int|0
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_PREF_BASE_UPPER32
comma
l_int|0
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_PREF_LIMIT_UPPER32
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set up the top and bottom of the PCI Memory segment&n;                   for this bus.  */
id|l
op_assign
(paren
id|inner.mem_start
op_amp
l_int|0xfff00000
)paren
op_rshift
l_int|16
suffix:semicolon
id|l
op_or_assign
(paren
id|inner.mem_end
op_minus
l_int|1
)paren
op_amp
l_int|0xfff00000
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_MEMORY_BASE
comma
id|l
)paren
suffix:semicolon
multiline_comment|/*&n;                 * Turn off downstream PF memory address range, unless&n;                 * there is a VGA behind this bridge, in which case, we&n;                 * enable the PREFETCH range to include BIOS ROM at C0000.&n;                 *&n;                 * NOTE: this is a bit of a hack, done with PREFETCH for&n;                 * simplicity, rather than having to add it into the above&n;                 * non-PREFETCH range, which could then be bigger than we want.&n;                 * We might assume that we could relocate the BIOS ROM, but&n;                 * that would depend on having it found by those who need it&n;                 * (the DEC BIOS emulator would find it, but I do not know&n;                 * about the Xservers). So, we do it this way for now... ;-)&n;                 */
id|l
op_assign
(paren
id|inner.found_vga
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x0000ffff
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_PREF_MEMORY_BASE
comma
id|l
)paren
suffix:semicolon
multiline_comment|/*&n;                 * Tell bridge that there is an ISA bus in the system,&n;                 * and (possibly) a VGA as well.&n;                 */
id|l
op_assign
(paren
id|inner.found_vga
)paren
ques
c_cond
l_int|0x0c
suffix:colon
l_int|0x04
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|bridge
comma
id|PCI_BRIDGE_CONTROL
comma
id|l
)paren
suffix:semicolon
multiline_comment|/*&n;                 * Clear status bits,&n;                 * turn on I/O    enable (for downstream I/O),&n;                 * turn on memory enable (for downstream memory),&n;                 * turn on master enable (for upstream memory and I/O).&n;                 */
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_COMMAND
comma
l_int|0xffff0007
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|outer
)paren
(brace
id|outer-&gt;found_vga
op_or_assign
id|inner.found_vga
suffix:semicolon
r_if
c_cond
(paren
id|inner.io_start
OL
id|outer-&gt;io_start
)paren
id|outer-&gt;io_start
op_assign
id|inner.io_start
suffix:semicolon
r_if
c_cond
(paren
id|inner.io_end
OG
id|outer-&gt;io_end
)paren
id|outer-&gt;io_end
op_assign
id|inner.io_end
suffix:semicolon
r_if
c_cond
(paren
id|inner.mem_start
OL
id|outer-&gt;mem_start
)paren
id|outer-&gt;mem_start
op_assign
id|inner.mem_start
suffix:semicolon
r_if
c_cond
(paren
id|inner.mem_end
OG
id|outer-&gt;mem_end
)paren
id|outer-&gt;mem_end
op_assign
id|inner.mem_end
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|pci_set_bus_ranges
id|pci_set_bus_ranges
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|ln
suffix:semicolon
r_for
c_loop
(paren
id|ln
op_assign
id|pci_root_buses.next
suffix:semicolon
id|ln
op_ne
op_amp
id|pci_root_buses
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
(brace
id|pbus_set_ranges
c_func
(paren
id|pci_bus_b
c_func
(paren
id|ln
)paren
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
eof
