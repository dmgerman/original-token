multiline_comment|/*&n; *&t;drivers/pci/setup-bus.c&n; *&n; * Extruded from code written by&n; *      Dave Rusling (david.rusling@reo.mts.dec.com)&n; *      David Mosberger (davidm@cs.arizona.edu)&n; *&t;David Miller (davem@redhat.com)&n; *&n; * Support routines for initializing a PCI subsystem.&n; */
multiline_comment|/*&n; * Nov 2000, Ivan Kokshaysky &lt;ink@jurassic.park.msu.ru&gt;&n; *&t;     PCI-PCI bridges cleanup, sorted resource allocation&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/cache.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
DECL|macro|DEBUG_CONFIG
mdefine_line|#define DEBUG_CONFIG 1
macro_line|#if DEBUG_CONFIG
DECL|macro|DBGC
macro_line|# define DBGC(args)     printk args
macro_line|#else
DECL|macro|DBGC
macro_line|# define DBGC(args)
macro_line|#endif
DECL|macro|ROUND_UP
mdefine_line|#define ROUND_UP(x, a)&t;&t;(((x) + (a) - 1) &amp; ~((a) - 1))
r_static
r_int
id|__init
DECL|function|pbus_assign_resources_sorted
id|pbus_assign_resources_sorted
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pbus_set_ranges_data
op_star
id|ranges
)paren
(brace
r_struct
id|list_head
op_star
id|ln
suffix:semicolon
r_struct
id|resource
op_star
id|res
suffix:semicolon
r_struct
id|resource_list
id|head_io
comma
id|head_mem
comma
op_star
id|list
comma
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|io_reserved
op_assign
l_int|0
comma
id|mem_reserved
op_assign
l_int|0
suffix:semicolon
r_int
id|idx
comma
id|found_vga
op_assign
l_int|0
suffix:semicolon
id|head_io.next
op_assign
id|head_mem.next
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|ln
op_assign
id|bus-&gt;devices.next
suffix:semicolon
id|ln
op_ne
op_amp
id|bus-&gt;devices
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|pci_dev_b
c_func
(paren
id|ln
)paren
suffix:semicolon
id|u16
r_class
op_assign
id|dev
op_member_access_from_pointer
r_class
op_rshift
l_int|8
suffix:semicolon
id|u16
id|cmd
suffix:semicolon
multiline_comment|/* First, disable the device to avoid side&n;&t;&t;   effects of possibly overlapping I/O and&n;&t;&t;   memory ranges.&n;&t;&t;   Leave VGA enabled - for obvious reason. :-)&n;&t;&t;   Same with all sorts of bridges - they may&n;&t;&t;   have VGA behind them.  */
r_if
c_cond
(paren
r_class
op_eq
id|PCI_CLASS_DISPLAY_VGA
op_logical_or
r_class
op_eq
id|PCI_CLASS_NOT_DEFINED_VGA
)paren
id|found_vga
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
r_class
op_rshift
l_int|8
op_ne
id|PCI_BASE_CLASS_BRIDGE
)paren
(brace
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_and_assign
op_complement
(paren
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/* Reserve some resources for CardBus.&n;&t;&t;   Are these values reasonable? */
r_if
c_cond
(paren
r_class
op_eq
id|PCI_CLASS_BRIDGE_CARDBUS
)paren
(brace
id|io_reserved
op_add_assign
l_int|8
op_star
l_int|1024
suffix:semicolon
id|mem_reserved
op_add_assign
l_int|32
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pdev_sort_resources
c_func
(paren
id|dev
comma
op_amp
id|head_io
comma
id|IORESOURCE_IO
)paren
suffix:semicolon
id|pdev_sort_resources
c_func
(paren
id|dev
comma
op_amp
id|head_mem
comma
id|IORESOURCE_MEM
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|list
op_assign
id|head_io.next
suffix:semicolon
id|list
suffix:semicolon
)paren
(brace
id|res
op_assign
id|list-&gt;res
suffix:semicolon
id|idx
op_assign
id|res
op_minus
op_amp
id|list-&gt;dev-&gt;resource
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pci_assign_resource
c_func
(paren
id|list-&gt;dev
comma
id|idx
)paren
op_eq
l_int|0
op_logical_and
id|ranges-&gt;io_end
OL
id|res-&gt;end
)paren
id|ranges-&gt;io_end
op_assign
id|res-&gt;end
suffix:semicolon
id|tmp
op_assign
id|list
suffix:semicolon
id|list
op_assign
id|list-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|list
op_assign
id|head_mem.next
suffix:semicolon
id|list
suffix:semicolon
)paren
(brace
id|res
op_assign
id|list-&gt;res
suffix:semicolon
id|idx
op_assign
id|res
op_minus
op_amp
id|list-&gt;dev-&gt;resource
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pci_assign_resource
c_func
(paren
id|list-&gt;dev
comma
id|idx
)paren
op_eq
l_int|0
op_logical_and
id|ranges-&gt;mem_end
OL
id|res-&gt;end
)paren
id|ranges-&gt;mem_end
op_assign
id|res-&gt;end
suffix:semicolon
id|tmp
op_assign
id|list
suffix:semicolon
id|list
op_assign
id|list-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
id|ranges-&gt;io_end
op_add_assign
id|io_reserved
suffix:semicolon
id|ranges-&gt;mem_end
op_add_assign
id|mem_reserved
suffix:semicolon
multiline_comment|/* PCI-to-PCI Bridge Architecture Specification rev. 1.1 (1998)&n;&t;   requires that if there is no I/O ports or memory behind the&n;&t;   bridge, corresponding range must be turned off by writing base&n;&t;   value greater than limit to the bridge&squot;s base/limit registers.  */
macro_line|#if 1
multiline_comment|/* But assuming that some hardware designed before 1998 might&n;&t;   not support this (very unlikely - at least all DEC bridges&n;&t;   are ok and I believe that was standard de-facto. -ink), we&n;&t;   must allow for at least one unit.  */
r_if
c_cond
(paren
id|ranges-&gt;io_end
op_eq
id|ranges-&gt;io_start
)paren
id|ranges-&gt;io_end
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ranges-&gt;mem_end
op_eq
id|ranges-&gt;mem_start
)paren
id|ranges-&gt;mem_end
op_add_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|ranges-&gt;io_end
op_assign
id|ROUND_UP
c_func
(paren
id|ranges-&gt;io_end
comma
l_int|4
op_star
l_int|1024
)paren
suffix:semicolon
id|ranges-&gt;mem_end
op_assign
id|ROUND_UP
c_func
(paren
id|ranges-&gt;mem_end
comma
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
r_return
id|found_vga
suffix:semicolon
)brace
multiline_comment|/* Initialize bridges with base/limit values we have collected */
r_static
r_void
id|__init
DECL|function|pci_setup_bridge
id|pci_setup_bridge
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
)paren
(brace
r_struct
id|pbus_set_ranges_data
id|ranges
suffix:semicolon
r_struct
id|pci_dev
op_star
id|bridge
op_assign
id|bus-&gt;self
suffix:semicolon
id|u32
id|l
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge
op_logical_or
(paren
id|bridge
op_member_access_from_pointer
r_class
op_rshift
l_int|8
)paren
op_ne
id|PCI_CLASS_BRIDGE_PCI
)paren
r_return
suffix:semicolon
id|ranges.io_start
op_assign
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
id|ranges.io_end
op_assign
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|end
suffix:semicolon
id|ranges.mem_start
op_assign
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
suffix:semicolon
id|ranges.mem_end
op_assign
id|bus-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|end
suffix:semicolon
id|pcibios_fixup_pbus_ranges
c_func
(paren
id|bus
comma
op_amp
id|ranges
)paren
suffix:semicolon
id|DBGC
c_func
(paren
(paren
l_string|&quot;PCI: Bus %d, bridge: %s&bslash;n&quot;
comma
id|bus-&gt;number
comma
id|bridge-&gt;name
)paren
)paren
suffix:semicolon
id|DBGC
c_func
(paren
(paren
l_string|&quot;  IO window: %04lx-%04lx&bslash;n&quot;
comma
id|ranges.io_start
comma
id|ranges.io_end
)paren
)paren
suffix:semicolon
id|DBGC
c_func
(paren
(paren
l_string|&quot;  MEM window: %08lx-%08lx&bslash;n&quot;
comma
id|ranges.mem_start
comma
id|ranges.mem_end
)paren
)paren
suffix:semicolon
multiline_comment|/* Set up the top and bottom of the PCI I/O segment for this bus. */
id|pci_read_config_dword
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE
comma
op_amp
id|l
)paren
suffix:semicolon
id|l
op_and_assign
l_int|0xffff0000
suffix:semicolon
id|l
op_or_assign
(paren
id|ranges.io_start
op_rshift
l_int|8
)paren
op_amp
l_int|0x00f0
suffix:semicolon
id|l
op_or_assign
id|ranges.io_end
op_amp
l_int|0xf000
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE
comma
id|l
)paren
suffix:semicolon
multiline_comment|/* Clear upper 16 bits of I/O base/limit. */
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE_UPPER16
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear out the upper 32 bits of PREF base/limit. */
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_PREF_BASE_UPPER32
comma
l_int|0
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_PREF_LIMIT_UPPER32
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set up the top and bottom of the PCI Memory segment&n;&t;   for this bus. */
id|l
op_assign
(paren
id|ranges.mem_start
op_rshift
l_int|16
)paren
op_amp
l_int|0xfff0
suffix:semicolon
id|l
op_or_assign
id|ranges.mem_end
op_amp
l_int|0xfff00000
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_MEMORY_BASE
comma
id|l
)paren
suffix:semicolon
multiline_comment|/* Set up PREF base/limit. */
id|l
op_assign
(paren
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|start
op_rshift
l_int|16
)paren
op_amp
l_int|0xfff0
suffix:semicolon
id|l
op_or_assign
id|bus-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|end
op_amp
l_int|0xfff00000
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|bridge
comma
id|PCI_PREF_MEMORY_BASE
comma
id|l
)paren
suffix:semicolon
multiline_comment|/* Check if we have VGA behind the bridge.&n;&t;   Enable ISA in either case. */
id|l
op_assign
(paren
id|bus-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|flags
op_amp
id|IORESOURCE_BUS_HAS_VGA
)paren
ques
c_cond
l_int|0x0c
suffix:colon
l_int|0x04
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|bridge
comma
id|PCI_BRIDGE_CONTROL
comma
id|l
)paren
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|pbus_assign_resources
id|pbus_assign_resources
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pbus_set_ranges_data
op_star
id|ranges
)paren
(brace
r_struct
id|list_head
op_star
id|ln
suffix:semicolon
r_int
id|found_vga
op_assign
id|pbus_assign_resources_sorted
c_func
(paren
id|bus
comma
id|ranges
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ranges-&gt;found_vga
op_logical_and
id|found_vga
)paren
(brace
r_struct
id|pci_bus
op_star
id|b
suffix:semicolon
id|ranges-&gt;found_vga
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Propogate presence of the VGA to upstream bridges */
r_for
c_loop
(paren
id|b
op_assign
id|bus
suffix:semicolon
id|b-&gt;parent
suffix:semicolon
id|b
op_assign
id|b-&gt;parent
)paren
(brace
macro_line|#if 0
multiline_comment|/* ? Do we actually need to enable PF memory? */
id|b-&gt;resource
(braket
l_int|2
)braket
op_member_access_from_pointer
id|start
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|b-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|flags
op_or_assign
id|IORESOURCE_BUS_HAS_VGA
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|ln
op_assign
id|bus-&gt;children.next
suffix:semicolon
id|ln
op_ne
op_amp
id|bus-&gt;children
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
(brace
r_struct
id|pci_bus
op_star
id|b
op_assign
id|pci_bus_b
c_func
(paren
id|ln
)paren
suffix:semicolon
id|b-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
op_assign
id|ranges-&gt;io_start
op_assign
id|ranges-&gt;io_end
suffix:semicolon
id|b-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
op_assign
id|ranges-&gt;mem_start
op_assign
id|ranges-&gt;mem_end
suffix:semicolon
id|pbus_assign_resources
c_func
(paren
id|b
comma
id|ranges
)paren
suffix:semicolon
id|b-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|end
op_assign
id|ranges-&gt;io_end
op_minus
l_int|1
suffix:semicolon
id|b-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|end
op_assign
id|ranges-&gt;mem_end
op_minus
l_int|1
suffix:semicolon
id|pci_setup_bridge
c_func
(paren
id|b
)paren
suffix:semicolon
)brace
)brace
r_void
id|__init
DECL|function|pci_assign_unassigned_resources
id|pci_assign_unassigned_resources
c_func
(paren
r_void
)paren
(brace
r_struct
id|pbus_set_ranges_data
id|ranges
suffix:semicolon
r_struct
id|list_head
op_star
id|ln
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_for
c_loop
(paren
id|ln
op_assign
id|pci_root_buses.next
suffix:semicolon
id|ln
op_ne
op_amp
id|pci_root_buses
suffix:semicolon
id|ln
op_assign
id|ln-&gt;next
)paren
(brace
r_struct
id|pci_bus
op_star
id|b
op_assign
id|pci_bus_b
c_func
(paren
id|ln
)paren
suffix:semicolon
id|ranges.io_start
op_assign
id|b-&gt;resource
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start
op_plus
id|PCIBIOS_MIN_IO
suffix:semicolon
id|ranges.mem_start
op_assign
id|b-&gt;resource
(braket
l_int|1
)braket
op_member_access_from_pointer
id|start
op_plus
id|PCIBIOS_MIN_MEM
suffix:semicolon
id|ranges.io_end
op_assign
id|ranges.io_start
suffix:semicolon
id|ranges.mem_end
op_assign
id|ranges.mem_start
suffix:semicolon
id|ranges.found_vga
op_assign
l_int|0
suffix:semicolon
id|pbus_assign_resources
c_func
(paren
id|b
comma
op_amp
id|ranges
)paren
suffix:semicolon
)brace
id|pci_for_each_dev
c_func
(paren
id|dev
)paren
(brace
id|pdev_enable_device
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Check whether the bridge supports I/O forwarding.&n;   If not, its I/O base/limit register must be&n;   read-only and read as 0. */
r_int
r_int
id|__init
DECL|function|pci_bridge_check_io
id|pci_bridge_check_io
c_func
(paren
r_struct
id|pci_dev
op_star
id|bridge
)paren
(brace
id|u16
id|io
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE
comma
op_amp
id|io
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|io
)paren
(brace
id|pci_write_config_word
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE
comma
l_int|0xf0f0
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE
comma
op_amp
id|io
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|bridge
comma
id|PCI_IO_BASE
comma
l_int|0x0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|io
)paren
r_return
id|IORESOURCE_IO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PCI: bridge %s does not support I/O forwarding!&bslash;n&quot;
comma
id|bridge-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
