multiline_comment|/*&n; * $Id: quirks.c,v 1.5 1998/05/02 19:24:14 mj Exp $&n; *&n; * PCI Chipset-Specific Quirks&n; *&n; * Extracted from pci.c and rewritten by Martin Mares&n; *&n; * This is the right place for all special fixups for on-board&n; * devices not depending on system architecture -- for example&n; * bus bridges.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#ifdef CONFIG_PCI_OPTIMIZE
multiline_comment|/*&n; *&t;The PCI Bridge Optimization -- Some BIOS&squot;es are too lazy&n; *&t;and are unable to turn on several features which can burst&n; *&t;system performance.&n; */
multiline_comment|/*&n; * An item of this structure has the following meaning:&n; * for each optimization, the register address, the mask&n; * and value to write to turn it on.&n; */
DECL|struct|optimization_type
r_struct
id|optimization_type
(brace
DECL|member|type
r_const
r_char
op_star
id|type
suffix:semicolon
DECL|member|off
r_const
r_char
op_star
id|off
suffix:semicolon
DECL|member|on
r_const
r_char
op_star
id|on
suffix:semicolon
DECL|variable|__initdata
)brace
id|bridge_optimization
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_string|&quot;Cache L2&quot;
comma
l_string|&quot;write through&quot;
comma
l_string|&quot;write back&quot;
)brace
comma
(brace
l_string|&quot;CPU-PCI posted write&quot;
comma
l_string|&quot;off&quot;
comma
l_string|&quot;on&quot;
)brace
comma
(brace
l_string|&quot;CPU-Memory posted write&quot;
comma
l_string|&quot;off&quot;
comma
l_string|&quot;on&quot;
)brace
comma
(brace
l_string|&quot;PCI-Memory posted write&quot;
comma
l_string|&quot;off&quot;
comma
l_string|&quot;on&quot;
)brace
comma
(brace
l_string|&quot;PCI burst&quot;
comma
l_string|&quot;off&quot;
comma
l_string|&quot;on&quot;
)brace
)brace
suffix:semicolon
DECL|macro|NUM_OPTIMIZATIONS
mdefine_line|#define NUM_OPTIMIZATIONS &bslash;&n;&t;(sizeof(bridge_optimization) / sizeof(bridge_optimization[0]))
DECL|struct|bridge_mapping_type
r_struct
id|bridge_mapping_type
(brace
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
multiline_comment|/* config space address */
DECL|member|mask
r_int
r_char
id|mask
suffix:semicolon
DECL|member|value
r_int
r_char
id|value
suffix:semicolon
DECL|variable|bridge_mapping
)brace
id|bridge_mapping
(braket
)braket
op_assign
(brace
multiline_comment|/*&n;&t; * Intel Neptune/Mercury/Saturn:&n;&t; *&t;If the internal cache is write back,&n;&t; *&t;the L2 cache must be write through!&n;&t; *&t;I&squot;ve to check out how to control that&n;&t; *&t;for the moment, we won&squot;t touch the cache&n;&t; */
(brace
l_int|0x0
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
(brace
l_int|0x53
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
(brace
l_int|0x53
comma
l_int|0x01
comma
l_int|0x01
)brace
comma
(brace
l_int|0x54
comma
l_int|0x01
comma
l_int|0x01
)brace
comma
(brace
l_int|0x54
comma
l_int|0x02
comma
l_int|0x02
)brace
comma
multiline_comment|/*&n;&t; * UMC 8891A Pentium chipset:&n;&t; *&t;Why did you think UMC was cheaper ??&n;&t; */
(brace
l_int|0x50
comma
l_int|0x10
comma
l_int|0x00
)brace
comma
(brace
l_int|0x51
comma
l_int|0x40
comma
l_int|0x40
)brace
comma
(brace
l_int|0x0
comma
l_int|0x0
comma
l_int|0x0
)brace
comma
(brace
l_int|0x0
comma
l_int|0x0
comma
l_int|0x0
)brace
comma
(brace
l_int|0x0
comma
l_int|0x0
comma
l_int|0x0
)brace
comma
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|quirk_bridge
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pos
)paren
)paren
(brace
r_struct
id|bridge_mapping_type
op_star
id|bmap
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_int
id|i
suffix:semicolon
id|pos
op_mul_assign
id|NUM_OPTIMIZATIONS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_OPTIMIZATIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;    %s: &quot;
comma
id|bridge_optimization
(braket
id|i
)braket
dot
id|type
)paren
suffix:semicolon
id|bmap
op_assign
op_amp
id|bridge_mapping
(braket
id|pos
op_plus
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bmap-&gt;addr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Not supported.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|bmap-&gt;addr
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
id|bmap-&gt;mask
)paren
op_eq
id|bmap-&gt;value
)paren
id|printk
c_func
(paren
l_string|&quot;%s.&bslash;n&quot;
comma
id|bridge_optimization
(braket
id|i
)braket
dot
id|on
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|bridge_optimization
(braket
id|i
)braket
dot
id|off
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|bmap-&gt;addr
comma
(paren
id|val
op_amp
(paren
l_int|0xff
op_minus
id|bmap-&gt;mask
)paren
)paren
op_plus
id|bmap-&gt;value
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; -&gt; %s.&bslash;n&quot;
comma
id|bridge_optimization
(braket
id|i
)braket
dot
id|on
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/* Deal with broken BIOS&squot;es that neglect to enable passive release,&n;   which can cause problems in combination with the 82441FX/PPro MTRRs */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|quirk_passive_release
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|arg
)paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
id|dlc
suffix:semicolon
multiline_comment|/* We have to make sure a particular bit is set in the PIIX3&n;&t;   ISA bridge, so we have to go out and find it. */
r_while
c_loop
(paren
(paren
id|d
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371SB_0
comma
id|d
)paren
)paren
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|d
comma
l_int|0x82
comma
op_amp
id|dlc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dlc
op_amp
l_int|1
op_lshift
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PIIX3: Enabling Passive Release&bslash;n&quot;
)paren
suffix:semicolon
id|dlc
op_or_assign
l_int|1
op_lshift
l_int|1
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|d
comma
l_int|0x82
comma
id|dlc
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*  The VIA VP2/VP3/MVP3 seem to have some &squot;features&squot;. There may be a workaround&n;    but VIA don&squot;t answer queries. If you happen to have good contacts at VIA&n;    ask them for me please -- Alan &n;    &n;    This appears to be BIOS not version dependant. So presumably there is a &n;    chipset level fix */
DECL|variable|isa_dma_bridge_buggy
r_int
id|isa_dma_bridge_buggy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Exported */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|quirk_isa_dma_hangs
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|arg
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|isa_dma_bridge_buggy
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Activating ISA DMA hang workarounds.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|typedef|quirk_handler
r_typedef
r_void
(paren
op_star
id|quirk_handler
)paren
(paren
r_struct
id|pci_dev
op_star
comma
r_int
)paren
suffix:semicolon
multiline_comment|/*&n; * Mapping from quirk handler functions to names.&n; */
DECL|struct|quirk_name
r_struct
id|quirk_name
(brace
DECL|member|handler
id|quirk_handler
id|handler
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|quirk_name
id|quirk_names
(braket
)braket
id|__initdata
op_assign
(brace
macro_line|#ifdef CONFIG_PCI_OPTIMIZE
(brace
id|quirk_bridge
comma
l_string|&quot;Bridge optimization&quot;
)brace
comma
macro_line|#endif
(brace
id|quirk_passive_release
comma
l_string|&quot;Passive release enable&quot;
)brace
comma
(brace
id|quirk_isa_dma_hangs
comma
l_string|&quot;Work around ISA DMA hangs&quot;
)brace
comma
)brace
suffix:semicolon
DECL|function|get_quirk_name
r_static
r_inline
r_char
op_star
id|get_quirk_name
c_func
(paren
id|quirk_handler
id|handler
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|quirk_names
)paren
op_div
r_sizeof
(paren
id|quirk_names
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|handler
op_eq
id|quirk_names
(braket
id|i
)braket
dot
id|handler
)paren
r_return
id|quirk_names
(braket
id|i
)braket
dot
id|name
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Mapping from PCI vendor/device ID pairs to quirk function types and arguments&n; */
DECL|struct|quirk_info
r_struct
id|quirk_info
(brace
DECL|member|vendor
DECL|member|device
r_int
r_int
id|vendor
comma
id|device
suffix:semicolon
DECL|member|handler
id|quirk_handler
id|handler
suffix:semicolon
DECL|member|arg
r_int
r_int
id|arg
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|quirk_info
id|quirk_list
(braket
)braket
id|__initdata
op_assign
(brace
macro_line|#ifdef CONFIG_PCI_OPTIMIZE
(brace
id|PCI_VENDOR_ID_DEC
comma
id|PCI_DEVICE_ID_DEC_BRD
comma
id|quirk_bridge
comma
l_int|0x00
)brace
comma
(brace
id|PCI_VENDOR_ID_UMC
comma
id|PCI_DEVICE_ID_UMC_UM8891A
comma
id|quirk_bridge
comma
l_int|0x01
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82424
comma
id|quirk_bridge
comma
l_int|0x00
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82434
comma
id|quirk_bridge
comma
l_int|0x00
)brace
comma
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82430
comma
id|quirk_bridge
comma
l_int|0x00
)brace
comma
macro_line|#endif
(brace
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82441
comma
id|quirk_passive_release
comma
l_int|0x00
)brace
comma
multiline_comment|/*&n;&t; * Its not totally clear which chipsets are the problematic ones&n;&t; * This is the 82C586 variants. At the moment the 596 is an unknown&n;&t; * quantity &n;&t; */
(brace
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_82C586_0
comma
id|quirk_isa_dma_hangs
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|pci_quirks_init
c_func
(paren
r_void
)paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|d
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;PCI: pci_quirks_init&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|d
op_assign
id|pci_devices
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|quirk_list
)paren
op_div
r_sizeof
(paren
id|quirk_list
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|quirk_info
op_star
id|q
op_assign
id|quirk_list
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;vendor
op_eq
id|d-&gt;vendor
op_logical_and
id|q-&gt;device
op_eq
id|d-&gt;device
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: %02x:%02x [%04x/%04x]: %s (%02x)&bslash;n&quot;
comma
id|d-&gt;bus-&gt;number
comma
id|d-&gt;devfn
comma
id|d-&gt;vendor
comma
id|d-&gt;device
comma
id|get_quirk_name
c_func
(paren
id|q-&gt;handler
)paren
comma
id|q-&gt;arg
)paren
suffix:semicolon
id|q
op_member_access_from_pointer
id|handler
c_func
(paren
id|d
comma
id|q-&gt;arg
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
eof
