multiline_comment|/*&n; * $Id: quirks.c,v 1.5 1998/05/02 19:24:14 mj Exp $&n; *&n; *  This file contains work-arounds for many known PCI hardware&n; *  bugs.  Devices present only on certain architectures (host&n; *  bridges et cetera) should be handled in arch-specific code.&n; *&n; *  Copyright (c) 1999 Martin Mares &lt;mj@suse.cz&gt;&n; *&n; *  The bridge optimization stuff has been removed. If you really&n; *  have a silly BIOS which is unable to set your host bridge right,&n; *  use the PowerTweak utility (see http://powertweak.sourceforge.net).&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|DEBUG
macro_line|#undef DEBUG
multiline_comment|/* Deal with broken BIOS&squot;es that neglect to enable passive release,&n;   which can cause problems in combination with the 82441FX/PPro MTRRs */
DECL|function|quirk_passive_release
r_static
r_void
id|__init
id|quirk_passive_release
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|pci_dev
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
id|dlc
suffix:semicolon
multiline_comment|/* We have to make sure a particular bit is set in the PIIX3&n;&t;   ISA bridge, so we have to go out and find it. */
r_while
c_loop
(paren
(paren
id|d
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371SB_0
comma
id|d
)paren
)paren
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|d
comma
l_int|0x82
comma
op_amp
id|dlc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dlc
op_amp
l_int|1
op_lshift
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCI: PIIX3: Enabling Passive Release on %s&bslash;n&quot;
comma
id|d-&gt;slot_name
)paren
suffix:semicolon
id|dlc
op_or_assign
l_int|1
op_lshift
l_int|1
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|d
comma
l_int|0x82
comma
id|dlc
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*  The VIA VP2/VP3/MVP3 seem to have some &squot;features&squot;. There may be a workaround&n;    but VIA don&squot;t answer queries. If you happen to have good contacts at VIA&n;    ask them for me please -- Alan &n;    &n;    This appears to be BIOS not version dependent. So presumably there is a &n;    chipset level fix */
DECL|variable|isa_dma_bridge_buggy
r_int
id|isa_dma_bridge_buggy
suffix:semicolon
multiline_comment|/* Exported */
DECL|function|quirk_isa_dma_hangs
r_static
r_void
id|__init
id|quirk_isa_dma_hangs
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|isa_dma_bridge_buggy
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Activating ISA DMA hang workarounds.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|variable|pci_pci_problems
r_int
id|pci_pci_problems
suffix:semicolon
multiline_comment|/*&n; *&t;Chipsets where PCI-&gt;PCI transfers vanish or hang&n; */
DECL|function|quirk_nopcipci
r_static
r_void
id|__init
id|quirk_nopcipci
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
(paren
id|pci_pci_problems
op_amp
id|PCIPCI_FAIL
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Disabling direct PCI/PCI transfers.&bslash;n&quot;
)paren
suffix:semicolon
id|pci_pci_problems
op_or_assign
id|PCIPCI_FAIL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Triton requires workarounds to be used by the drivers&n; */
DECL|function|quirk_triton
r_static
r_void
id|__init
id|quirk_triton
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
(paren
id|pci_pci_problems
op_amp
id|PCIPCI_TRITON
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Limiting direct PCI/PCI transfers.&bslash;n&quot;
)paren
suffix:semicolon
id|pci_pci_problems
op_or_assign
id|PCIPCI_TRITON
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;VIA Apollo VP3 needs ETBF on BT848/878&n; */
DECL|function|quirk_viaetbf
r_static
r_void
id|__init
id|quirk_viaetbf
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
(paren
id|pci_pci_problems
op_amp
id|PCIPCI_VIAETBF
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Limiting direct PCI/PCI transfers.&bslash;n&quot;
)paren
suffix:semicolon
id|pci_pci_problems
op_or_assign
id|PCIPCI_VIAETBF
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Natoma has some interesting boundary conditions with Zoran stuff&n; *&t;at least&n; */
DECL|function|quirk_natoma
r_static
r_void
id|__init
id|quirk_natoma
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
(paren
id|pci_pci_problems
op_amp
id|PCIPCI_NATOMA
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Limiting direct PCI/PCI transfers.&bslash;n&quot;
)paren
suffix:semicolon
id|pci_pci_problems
op_or_assign
id|PCIPCI_NATOMA
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *  S3 868 and 968 chips report region size equal to 32M, but they decode 64M.&n; *  If it&squot;s needed, re-allocate the region.&n; */
DECL|function|quirk_s3_64M
r_static
r_void
id|__init
id|quirk_s3_64M
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|resource
op_star
id|r
op_assign
op_amp
id|dev-&gt;resource
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r-&gt;start
op_amp
l_int|0x3ffffff
)paren
op_logical_or
id|r-&gt;end
op_ne
id|r-&gt;start
op_plus
l_int|0x3ffffff
)paren
(brace
id|r-&gt;start
op_assign
l_int|0
suffix:semicolon
id|r-&gt;end
op_assign
l_int|0x3ffffff
suffix:semicolon
)brace
)brace
DECL|function|quirk_io_region
r_static
r_void
id|__init
id|quirk_io_region
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|region
comma
r_int
id|size
comma
r_int
id|nr
)paren
(brace
id|region
op_and_assign
op_complement
(paren
id|size
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|region
)paren
(brace
r_struct
id|resource
op_star
id|res
op_assign
id|dev-&gt;resource
op_plus
id|nr
suffix:semicolon
id|res-&gt;name
op_assign
id|dev-&gt;name
suffix:semicolon
id|res-&gt;start
op_assign
id|region
suffix:semicolon
id|res-&gt;end
op_assign
id|region
op_plus
id|size
op_minus
l_int|1
suffix:semicolon
id|res-&gt;flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
id|pci_claim_resource
c_func
(paren
id|dev
comma
id|nr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Let&squot;s make the southbridge information explicit instead&n; * of having to worry about people probing the ACPI areas,&n; * for example.. (Yes, it happens, and if you read the wrong&n; * ACPI register it will put the machine to sleep with no&n; * way of waking it up again. Bummer).&n; *&n; * ALI M7101: Two IO regions pointed to by words at&n; *&t;0xE0 (64 bytes of ACPI registers)&n; *&t;0xE2 (32 bytes of SMB registers)&n; */
DECL|function|quirk_ali7101_acpi
r_static
r_void
id|__init
id|quirk_ali7101_acpi
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u16
id|region
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
l_int|0xE0
comma
op_amp
id|region
)paren
suffix:semicolon
id|quirk_io_region
c_func
(paren
id|dev
comma
id|region
comma
l_int|64
comma
id|PCI_BRIDGE_RESOURCES
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
l_int|0xE2
comma
op_amp
id|region
)paren
suffix:semicolon
id|quirk_io_region
c_func
(paren
id|dev
comma
id|region
comma
l_int|32
comma
id|PCI_BRIDGE_RESOURCES
op_plus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PIIX4 ACPI: Two IO regions pointed to by longwords at&n; *&t;0x40 (64 bytes of ACPI registers)&n; *&t;0x90 (32 bytes of SMB registers)&n; */
DECL|function|quirk_piix4_acpi
r_static
r_void
id|__init
id|quirk_piix4_acpi
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u32
id|region
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x40
comma
op_amp
id|region
)paren
suffix:semicolon
id|quirk_io_region
c_func
(paren
id|dev
comma
id|region
comma
l_int|64
comma
id|PCI_BRIDGE_RESOURCES
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x90
comma
op_amp
id|region
)paren
suffix:semicolon
id|quirk_io_region
c_func
(paren
id|dev
comma
id|region
comma
l_int|32
comma
id|PCI_BRIDGE_RESOURCES
op_plus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * VIA ACPI: One IO region pointed to by longword at&n; *&t;0x48 or 0x20 (256 bytes of ACPI registers)&n; */
DECL|function|quirk_vt82c586_acpi
r_static
r_void
id|__init
id|quirk_vt82c586_acpi
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u8
id|rev
suffix:semicolon
id|u32
id|region
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rev
op_amp
l_int|0x10
)paren
(brace
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x48
comma
op_amp
id|region
)paren
suffix:semicolon
id|region
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|quirk_io_region
c_func
(paren
id|dev
comma
id|region
comma
l_int|256
comma
id|PCI_BRIDGE_RESOURCES
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * VIA VT82C686 ACPI: Three IO region pointed to by (long)words at&n; *&t;0x48 (256 bytes of ACPI registers)&n; *&t;0x70 (128 bytes of hardware monitoring register)&n; *&t;0x90 (16 bytes of SMB registers)&n; */
DECL|function|quirk_vt82c686_acpi
r_static
r_void
id|__init
id|quirk_vt82c686_acpi
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u16
id|hm
suffix:semicolon
id|u32
id|smb
suffix:semicolon
id|quirk_vt82c586_acpi
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
l_int|0x70
comma
op_amp
id|hm
)paren
suffix:semicolon
id|hm
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|quirk_io_region
c_func
(paren
id|dev
comma
id|hm
comma
l_int|128
comma
id|PCI_BRIDGE_RESOURCES
op_plus
l_int|1
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|0x90
comma
op_amp
id|smb
)paren
suffix:semicolon
id|smb
op_and_assign
id|PCI_BASE_ADDRESS_IO_MASK
suffix:semicolon
id|quirk_io_region
c_func
(paren
id|dev
comma
id|smb
comma
l_int|16
comma
id|PCI_BRIDGE_RESOURCES
op_plus
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PIIX3 USB: We have to disable USB interrupts that are&n; * hardwired to PIRQD# and may be shared with an&n; * external device.&n; *&n; * Legacy Support Register (LEGSUP):&n; *     bit13:  USB PIRQ Enable (USBPIRQDEN),&n; *     bit4:   Trap/SMI On IRQ Enable (USBSMIEN).&n; *&n; * We mask out all r/wc bits, too.&n; */
DECL|function|quirk_piix3_usb
r_static
r_void
id|__init
id|quirk_piix3_usb
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u16
id|legsup
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
l_int|0xc0
comma
op_amp
id|legsup
)paren
suffix:semicolon
id|legsup
op_and_assign
l_int|0x50ef
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
l_int|0xc0
comma
id|legsup
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * VIA VT82C598 has its device ID settable and many BIOSes&n; * set it to the ID of VT82C597 for backward compatibility.&n; * We need to switch it off to be able to recognize the real&n; * type of the chip.&n; */
DECL|function|quirk_vt82c598_id
r_static
r_void
id|__init
id|quirk_vt82c598_id
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0xfc
comma
l_int|0
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_DEVICE_ID
comma
op_amp
id|dev-&gt;device
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  The main table of quirks.&n; */
DECL|variable|__initdata
r_static
r_struct
id|pci_fixup
id|pci_fixups
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82441
comma
id|quirk_passive_release
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82441
comma
id|quirk_passive_release
)brace
comma
multiline_comment|/*&n;&t; * Its not totally clear which chipsets are the problematic ones&n;&t; * We know 82C586 and 82C596 variants are affected.&n;&t; */
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_82C586_0
comma
id|quirk_isa_dma_hangs
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_82C596
comma
id|quirk_isa_dma_hangs
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371SB_0
comma
id|quirk_isa_dma_hangs
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_S3
comma
id|PCI_DEVICE_ID_S3_868
comma
id|quirk_s3_64M
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_S3
comma
id|PCI_DEVICE_ID_S3_968
comma
id|quirk_s3_64M
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82437
comma
id|quirk_triton
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82437VX
comma
id|quirk_triton
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82439
comma
id|quirk_triton
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82439TX
comma
id|quirk_triton
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82441
comma
id|quirk_natoma
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82443LX_0
comma
id|quirk_natoma
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82443LX_1
comma
id|quirk_natoma
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82443BX_0
comma
id|quirk_natoma
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82443BX_1
comma
id|quirk_natoma
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82443BX_2
comma
id|quirk_natoma
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_5597
comma
id|quirk_nopcipci
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_496
comma
id|quirk_nopcipci
)brace
comma
(brace
id|PCI_FIXUP_FINAL
comma
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_82C597_0
comma
id|quirk_viaetbf
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_82C597_0
comma
id|quirk_vt82c598_id
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_82C586_3
comma
id|quirk_vt82c586_acpi
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_82C686_4
comma
id|quirk_vt82c686_acpi
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371AB_3
comma
id|quirk_piix4_acpi
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M7101
comma
id|quirk_ali7101_acpi
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371SB_2
comma
id|quirk_piix3_usb
)brace
comma
(brace
id|PCI_FIXUP_HEADER
comma
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371AB_2
comma
id|quirk_piix3_usb
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|pci_do_fixups
r_static
r_void
id|pci_do_fixups
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|pass
comma
r_struct
id|pci_fixup
op_star
id|f
)paren
(brace
r_while
c_loop
(paren
id|f-&gt;pass
)paren
(brace
r_if
c_cond
(paren
id|f-&gt;pass
op_eq
id|pass
op_logical_and
(paren
id|f-&gt;vendor
op_eq
id|dev-&gt;vendor
op_logical_or
id|f-&gt;vendor
op_eq
(paren
id|u16
)paren
id|PCI_ANY_ID
)paren
op_logical_and
(paren
id|f-&gt;device
op_eq
id|dev-&gt;device
op_logical_or
id|f-&gt;device
op_eq
(paren
id|u16
)paren
id|PCI_ANY_ID
)paren
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;PCI: Calling quirk %p for %s&bslash;n&quot;
comma
id|f-&gt;hook
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
macro_line|#endif
id|f
op_member_access_from_pointer
id|hook
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|f
op_increment
suffix:semicolon
)brace
)brace
DECL|function|pci_fixup_device
r_void
id|pci_fixup_device
c_func
(paren
r_int
id|pass
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|pci_do_fixups
c_func
(paren
id|dev
comma
id|pass
comma
id|pcibios_fixups
)paren
suffix:semicolon
id|pci_do_fixups
c_func
(paren
id|dev
comma
id|pass
comma
id|pci_fixups
)paren
suffix:semicolon
)brace
eof
