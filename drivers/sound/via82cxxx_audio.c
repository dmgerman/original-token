multiline_comment|/*&n; * Support for VIA 82Cxxx Audio Codecs&n; * Copyright 1999,2000 Jeff Garzik &lt;jgarzik@mandrakesoft.com&gt;&n; *&n; * Distributed under the GNU GENERAL PUBLIC LICENSE (GPL) Version 2.&n; * See the &quot;COPYING&quot; file distributed with this software for more info.&n; *&n; * For a list of known bugs (errata) and documentation,&n; * see via-audio.pdf in linux/Documentation/DocBook.&n; * If this documentation does not exist, run &quot;make pdfdocs&quot;.&n; * If &quot;make pdfdocs&quot; fails, obtain the documentation from&n; * the driver&squot;s Website at&n; * http://gtf.org/garzik/drivers/via82cxxx/&n; *&n; */
DECL|macro|VIA_VERSION
mdefine_line|#define VIA_VERSION&t;&quot;1.1.14&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;linux/ac97_codec.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
DECL|macro|VIA_DEBUG
macro_line|#undef VIA_DEBUG&t;/* define to enable debugging output and checks */
macro_line|#ifdef VIA_DEBUG
multiline_comment|/* note: prints function name for you */
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...) printk(KERN_DEBUG &quot;%s: &quot; fmt, __FUNCTION__ , ## args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...)
macro_line|#endif
DECL|macro|VIA_NDEBUG
macro_line|#undef VIA_NDEBUG&t;/* define to disable lightweight runtime checks */
macro_line|#ifdef VIA_NDEBUG
DECL|macro|assert
mdefine_line|#define assert(expr)
macro_line|#else
DECL|macro|assert
mdefine_line|#define assert(expr) &bslash;&n;        if(!(expr)) {&t;&t;&t;&t;&t;&bslash;&n;        printk( &quot;Assertion failed! %s,%s,%s,line=%d&bslash;n&quot;,&t;&bslash;&n;        #expr,__FILE__,__FUNCTION__,__LINE__);&t;&t;&bslash;&n;        }
macro_line|#endif
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; &bslash;&n;    defined(CONFIG_SOUND_VIA82CXXX_PROCFS)
DECL|macro|VIA_PROC_FS
mdefine_line|#define VIA_PROC_FS 1
macro_line|#endif
DECL|macro|VIA_SUPPORT_MMAP
mdefine_line|#define VIA_SUPPORT_MMAP 1 /* buggy, for now... */
DECL|macro|MAX_CARDS
mdefine_line|#define MAX_CARDS&t;1
DECL|macro|VIA_CARD_NAME
mdefine_line|#define VIA_CARD_NAME&t;&quot;VIA 82Cxxx Audio driver &quot; VIA_VERSION
DECL|macro|VIA_MODULE_NAME
mdefine_line|#define VIA_MODULE_NAME &quot;via82cxxx&quot;
DECL|macro|PFX
mdefine_line|#define PFX&t;&t;VIA_MODULE_NAME &quot;: &quot;
DECL|macro|VIA_COUNTER_LIMIT
mdefine_line|#define VIA_COUNTER_LIMIT&t;100000
multiline_comment|/* size of DMA buffers */
DECL|macro|VIA_DMA_BUFFERS
mdefine_line|#define VIA_DMA_BUFFERS&t;&t;16
DECL|macro|VIA_DMA_BUF_SIZE
mdefine_line|#define VIA_DMA_BUF_SIZE&t;PAGE_SIZE
macro_line|#ifndef AC97_PCM_LR_ADC_RATE
DECL|macro|AC97_PCM_LR_ADC_RATE
macro_line|#  define AC97_PCM_LR_ADC_RATE AC97_PCM_LR_DAC_RATE
macro_line|#endif
multiline_comment|/* 82C686 function 5 (audio codec) PCI configuration registers */
DECL|macro|VIA_ACLINK_CTRL
mdefine_line|#define VIA_ACLINK_CTRL&t;&t;0x41
DECL|macro|VIA_FUNC_ENABLE
mdefine_line|#define VIA_FUNC_ENABLE&t;&t;0x42
DECL|macro|VIA_PNP_CONTROL
mdefine_line|#define VIA_PNP_CONTROL&t;&t;0x43
DECL|macro|VIA_FM_NMI_CTRL
mdefine_line|#define VIA_FM_NMI_CTRL&t;&t;0x48
multiline_comment|/*&n; * controller base 0 (scatter-gather) registers&n; *&n; * NOTE: Via datasheet lists first channel as &quot;read&quot;&n; * channel and second channel as &quot;write&quot; channel.&n; * I changed the naming of the constants to be more&n; * clear than I felt the datasheet to be.&n; */
DECL|macro|VIA_BASE0_PCM_OUT_CHAN
mdefine_line|#define VIA_BASE0_PCM_OUT_CHAN&t;0x00 /* output PCM to user */
DECL|macro|VIA_BASE0_PCM_OUT_CHAN_STATUS
mdefine_line|#define VIA_BASE0_PCM_OUT_CHAN_STATUS 0x00
DECL|macro|VIA_BASE0_PCM_OUT_CHAN_CTRL
mdefine_line|#define VIA_BASE0_PCM_OUT_CHAN_CTRL&t;0x01
DECL|macro|VIA_BASE0_PCM_OUT_CHAN_TYPE
mdefine_line|#define VIA_BASE0_PCM_OUT_CHAN_TYPE&t;0x02
DECL|macro|VIA_BASE0_PCM_OUT_BLOCK_COUNT
mdefine_line|#define VIA_BASE0_PCM_OUT_BLOCK_COUNT&t;0x0C
DECL|macro|VIA_BASE0_PCM_IN_CHAN
mdefine_line|#define VIA_BASE0_PCM_IN_CHAN&t;&t;0x10 /* input PCM from user */
DECL|macro|VIA_BASE0_PCM_IN_CHAN_STATUS
mdefine_line|#define VIA_BASE0_PCM_IN_CHAN_STATUS&t;0x10
DECL|macro|VIA_BASE0_PCM_IN_CHAN_CTRL
mdefine_line|#define VIA_BASE0_PCM_IN_CHAN_CTRL&t;0x11
DECL|macro|VIA_BASE0_PCM_IN_CHAN_TYPE
mdefine_line|#define VIA_BASE0_PCM_IN_CHAN_TYPE&t;0x12
multiline_comment|/* offsets from base */
DECL|macro|VIA_PCM_STATUS
mdefine_line|#define VIA_PCM_STATUS&t;&t;&t;0x00
DECL|macro|VIA_PCM_CONTROL
mdefine_line|#define VIA_PCM_CONTROL&t;&t;&t;0x01
DECL|macro|VIA_PCM_TYPE
mdefine_line|#define VIA_PCM_TYPE&t;&t;&t;0x02
DECL|macro|VIA_PCM_TABLE_ADDR
mdefine_line|#define VIA_PCM_TABLE_ADDR&t;&t;0x04
multiline_comment|/* XXX unused DMA channel for FM PCM data */
DECL|macro|VIA_BASE0_FM_OUT_CHAN
mdefine_line|#define VIA_BASE0_FM_OUT_CHAN&t;&t;0x20
DECL|macro|VIA_BASE0_FM_OUT_CHAN_STATUS
mdefine_line|#define VIA_BASE0_FM_OUT_CHAN_STATUS&t;0x20
DECL|macro|VIA_BASE0_FM_OUT_CHAN_CTRL
mdefine_line|#define VIA_BASE0_FM_OUT_CHAN_CTRL&t;0x21
DECL|macro|VIA_BASE0_FM_OUT_CHAN_TYPE
mdefine_line|#define VIA_BASE0_FM_OUT_CHAN_TYPE&t;0x22
DECL|macro|VIA_BASE0_AC97_CTRL
mdefine_line|#define VIA_BASE0_AC97_CTRL&t;&t;0x80
DECL|macro|VIA_BASE0_SGD_STATUS_SHADOW
mdefine_line|#define VIA_BASE0_SGD_STATUS_SHADOW&t;0x84
DECL|macro|VIA_BASE0_GPI_INT_ENABLE
mdefine_line|#define VIA_BASE0_GPI_INT_ENABLE&t;0x8C
DECL|macro|VIA_INTR_OUT
mdefine_line|#define VIA_INTR_OUT&t;&t;&t;((1&lt;&lt;0) |  (1&lt;&lt;4) |  (1&lt;&lt;8))
DECL|macro|VIA_INTR_IN
mdefine_line|#define VIA_INTR_IN&t;&t;&t;((1&lt;&lt;1) |  (1&lt;&lt;5) |  (1&lt;&lt;9))
DECL|macro|VIA_INTR_FM
mdefine_line|#define VIA_INTR_FM&t;&t;&t;((1&lt;&lt;2) |  (1&lt;&lt;6) | (1&lt;&lt;10))
DECL|macro|VIA_INTR_MASK
mdefine_line|#define VIA_INTR_MASK&t;&t;(VIA_INTR_OUT | VIA_INTR_IN | VIA_INTR_FM)
multiline_comment|/* VIA_BASE0_AUDIO_xxx_CHAN_TYPE bits */
DECL|macro|VIA_IRQ_ON_FLAG
mdefine_line|#define VIA_IRQ_ON_FLAG&t;&t;&t;(1&lt;&lt;0)&t;/* int on each flagged scatter block */
DECL|macro|VIA_IRQ_ON_EOL
mdefine_line|#define VIA_IRQ_ON_EOL&t;&t;&t;(1&lt;&lt;1)&t;/* int at end of scatter list */
DECL|macro|VIA_INT_SEL_PCI_LAST_LINE_READ
mdefine_line|#define VIA_INT_SEL_PCI_LAST_LINE_READ&t;(0)&t;/* int at PCI read of last line */
DECL|macro|VIA_INT_SEL_LAST_SAMPLE_SENT
mdefine_line|#define VIA_INT_SEL_LAST_SAMPLE_SENT&t;(1&lt;&lt;2)&t;/* int at last sample sent */
DECL|macro|VIA_INT_SEL_ONE_LINE_LEFT
mdefine_line|#define VIA_INT_SEL_ONE_LINE_LEFT&t;(1&lt;&lt;3)&t;/* int at less than one line to send */
DECL|macro|VIA_PCM_FMT_STEREO
mdefine_line|#define VIA_PCM_FMT_STEREO&t;&t;(1&lt;&lt;4)&t;/* PCM stereo format (bit clear == mono) */
DECL|macro|VIA_PCM_FMT_16BIT
mdefine_line|#define VIA_PCM_FMT_16BIT&t;&t;(1&lt;&lt;5)&t;/* PCM 16-bit format (bit clear == 8-bit) */
DECL|macro|VIA_PCM_REC_FIFO
mdefine_line|#define VIA_PCM_REC_FIFO&t;&t;(1&lt;&lt;6)&t;/* PCM Recording FIFO */
DECL|macro|VIA_RESTART_SGD_ON_EOL
mdefine_line|#define VIA_RESTART_SGD_ON_EOL&t;&t;(1&lt;&lt;7)&t;/* restart scatter-gather at EOL */
DECL|macro|VIA_PCM_FMT_MASK
mdefine_line|#define VIA_PCM_FMT_MASK&t;&t;(VIA_PCM_FMT_STEREO|VIA_PCM_FMT_16BIT)
DECL|macro|VIA_CHAN_TYPE_MASK
mdefine_line|#define VIA_CHAN_TYPE_MASK&t;&t;(VIA_RESTART_SGD_ON_EOL | &bslash;&n;&t;&t;&t;&t;&t; VIA_IRQ_ON_FLAG | &bslash;&n;&t;&t;&t;&t;&t; VIA_IRQ_ON_EOL)
DECL|macro|VIA_CHAN_TYPE_INT_SELECT
mdefine_line|#define VIA_CHAN_TYPE_INT_SELECT&t;(VIA_INT_SEL_LAST_SAMPLE_SENT)
multiline_comment|/* PCI configuration register bits and masks */
DECL|macro|VIA_CR40_AC97_READY
mdefine_line|#define VIA_CR40_AC97_READY&t;0x01
DECL|macro|VIA_CR40_AC97_LOW_POWER
mdefine_line|#define VIA_CR40_AC97_LOW_POWER&t;0x02
DECL|macro|VIA_CR40_SECONDARY_READY
mdefine_line|#define VIA_CR40_SECONDARY_READY 0x04
DECL|macro|VIA_CR41_AC97_ENABLE
mdefine_line|#define VIA_CR41_AC97_ENABLE&t;0x80 /* enable AC97 codec */
DECL|macro|VIA_CR41_AC97_RESET
mdefine_line|#define VIA_CR41_AC97_RESET&t;0x40 /* clear bit to reset AC97 */
DECL|macro|VIA_CR41_AC97_WAKEUP
mdefine_line|#define VIA_CR41_AC97_WAKEUP&t;0x20 /* wake up from power-down mode */
DECL|macro|VIA_CR41_AC97_SDO
mdefine_line|#define VIA_CR41_AC97_SDO&t;0x10 /* force Serial Data Out (SDO) high */
DECL|macro|VIA_CR41_VRA
mdefine_line|#define VIA_CR41_VRA&t;&t;0x08 /* enable variable sample rate */
DECL|macro|VIA_CR41_PCM_ENABLE
mdefine_line|#define VIA_CR41_PCM_ENABLE&t;0x04 /* AC Link SGD Read Channel PCM Data Output */
DECL|macro|VIA_CR41_FM_PCM_ENABLE
mdefine_line|#define VIA_CR41_FM_PCM_ENABLE&t;0x02 /* AC Link FM Channel PCM Data Out */
DECL|macro|VIA_CR41_SB_PCM_ENABLE
mdefine_line|#define VIA_CR41_SB_PCM_ENABLE&t;0x01 /* AC Link SB PCM Data Output */
DECL|macro|VIA_CR41_BOOT_MASK
mdefine_line|#define VIA_CR41_BOOT_MASK&t;(VIA_CR41_AC97_ENABLE | &bslash;&n;&t;&t;&t;&t; VIA_CR41_AC97_WAKEUP | &bslash;&n;&t;&t;&t;&t; VIA_CR41_AC97_SDO)
DECL|macro|VIA_CR41_RUN_MASK
mdefine_line|#define VIA_CR41_RUN_MASK&t;(VIA_CR41_AC97_ENABLE | &bslash;&n;&t;&t;&t;&t; VIA_CR41_AC97_RESET | &bslash;&n;&t;&t;&t;&t; VIA_CR41_VRA | &bslash;&n;&t;&t;&t;&t; VIA_CR41_PCM_ENABLE)
DECL|macro|VIA_CR42_SB_ENABLE
mdefine_line|#define VIA_CR42_SB_ENABLE&t;0x01
DECL|macro|VIA_CR42_MIDI_ENABLE
mdefine_line|#define VIA_CR42_MIDI_ENABLE&t;0x02
DECL|macro|VIA_CR42_FM_ENABLE
mdefine_line|#define VIA_CR42_FM_ENABLE&t;0x04
DECL|macro|VIA_CR42_GAME_ENABLE
mdefine_line|#define VIA_CR42_GAME_ENABLE&t;0x08
DECL|macro|VIA_CR44_SECOND_CODEC_SUPPORT
mdefine_line|#define VIA_CR44_SECOND_CODEC_SUPPORT&t;(1 &lt;&lt; 6)
DECL|macro|VIA_CR44_AC_LINK_ACCESS
mdefine_line|#define VIA_CR44_AC_LINK_ACCESS&t;&t;(1 &lt;&lt; 7)
DECL|macro|VIA_CR48_FM_TRAP_TO_NMI
mdefine_line|#define VIA_CR48_FM_TRAP_TO_NMI&t;&t;(1 &lt;&lt; 2)
multiline_comment|/* controller base 0 register bitmasks */
DECL|macro|VIA_INT_DISABLE_MASK
mdefine_line|#define VIA_INT_DISABLE_MASK&t;&t;(~(0x01|0x02))
DECL|macro|VIA_SGD_STOPPED
mdefine_line|#define VIA_SGD_STOPPED&t;&t;&t;(1 &lt;&lt; 2)
DECL|macro|VIA_SGD_ACTIVE
mdefine_line|#define VIA_SGD_ACTIVE&t;&t;&t;(1 &lt;&lt; 7)
DECL|macro|VIA_SGD_TERMINATE
mdefine_line|#define VIA_SGD_TERMINATE&t;&t;(1 &lt;&lt; 6)
DECL|macro|VIA_SGD_FLAG
mdefine_line|#define VIA_SGD_FLAG&t;&t;&t;(1 &lt;&lt; 0)
DECL|macro|VIA_SGD_EOL
mdefine_line|#define VIA_SGD_EOL&t;&t;&t;(1 &lt;&lt; 1)
DECL|macro|VIA_SGD_START
mdefine_line|#define VIA_SGD_START&t;&t;&t;(1 &lt;&lt; 7)
DECL|macro|VIA_CR80_FIRST_CODEC
mdefine_line|#define VIA_CR80_FIRST_CODEC&t;&t;0
DECL|macro|VIA_CR80_SECOND_CODEC
mdefine_line|#define VIA_CR80_SECOND_CODEC&t;&t;(1 &lt;&lt; 30)
DECL|macro|VIA_CR80_FIRST_CODEC_VALID
mdefine_line|#define VIA_CR80_FIRST_CODEC_VALID&t;(1 &lt;&lt; 25)
DECL|macro|VIA_CR80_VALID
mdefine_line|#define VIA_CR80_VALID&t;&t;&t;(1 &lt;&lt; 25)
DECL|macro|VIA_CR80_SECOND_CODEC_VALID
mdefine_line|#define VIA_CR80_SECOND_CODEC_VALID&t;(1 &lt;&lt; 27)
DECL|macro|VIA_CR80_BUSY
mdefine_line|#define VIA_CR80_BUSY&t;&t;&t;(1 &lt;&lt; 24)
DECL|macro|VIA_CR83_BUSY
mdefine_line|#define VIA_CR83_BUSY&t;&t;&t;(1)
DECL|macro|VIA_CR83_FIRST_CODEC_VALID
mdefine_line|#define VIA_CR83_FIRST_CODEC_VALID&t;(1 &lt;&lt; 1)
DECL|macro|VIA_CR80_READ
mdefine_line|#define VIA_CR80_READ&t;&t;&t;(1 &lt;&lt; 23)
DECL|macro|VIA_CR80_WRITE_MODE
mdefine_line|#define VIA_CR80_WRITE_MODE&t;&t;0
DECL|macro|VIA_CR80_REG_IDX
mdefine_line|#define VIA_CR80_REG_IDX(idx)&t;&t;((((idx) &amp; 0xFF) &gt;&gt; 1) &lt;&lt; 16)
multiline_comment|/* capabilities we announce */
macro_line|#ifdef VIA_SUPPORT_MMAP
DECL|macro|VIA_DSP_CAP
mdefine_line|#define VIA_DSP_CAP (DSP_CAP_REVISION | DSP_CAP_DUPLEX | DSP_CAP_MMAP | &bslash;&n;&t;&t;     DSP_CAP_TRIGGER | DSP_CAP_REALTIME)
macro_line|#else
DECL|macro|VIA_DSP_CAP
mdefine_line|#define VIA_DSP_CAP (DSP_CAP_REVISION | DSP_CAP_DUPLEX | &bslash;&n;&t;&t;     DSP_CAP_TRIGGER | DSP_CAP_REALTIME)
macro_line|#endif
multiline_comment|/* scatter-gather DMA table entry, exactly as passed to hardware */
DECL|struct|via_sgd_table
r_struct
id|via_sgd_table
(brace
DECL|member|addr
id|u32
id|addr
suffix:semicolon
DECL|member|count
id|u32
id|count
suffix:semicolon
multiline_comment|/* includes additional VIA_xxx bits also */
)brace
suffix:semicolon
DECL|macro|VIA_EOL
mdefine_line|#define VIA_EOL (1 &lt;&lt; 31)
DECL|macro|VIA_FLAG
mdefine_line|#define VIA_FLAG (1 &lt;&lt; 30)
DECL|macro|VIA_STOP
mdefine_line|#define VIA_STOP (1 &lt;&lt; 29)
DECL|enum|via_channel_states
r_enum
id|via_channel_states
(brace
DECL|enumerator|sgd_stopped
id|sgd_stopped
op_assign
l_int|0
comma
DECL|enumerator|sgd_in_progress
id|sgd_in_progress
op_assign
l_int|1
comma
)brace
suffix:semicolon
DECL|struct|via_sgd_data
r_struct
id|via_sgd_data
(brace
DECL|member|handle
id|dma_addr_t
id|handle
suffix:semicolon
DECL|member|cpuaddr
r_void
op_star
id|cpuaddr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|via_channel
r_struct
id|via_channel
(brace
DECL|member|n_bufs
id|atomic_t
id|n_bufs
suffix:semicolon
DECL|member|hw_ptr
id|atomic_t
id|hw_ptr
suffix:semicolon
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|sw_ptr
r_int
r_int
id|sw_ptr
suffix:semicolon
DECL|member|slop_len
r_int
r_int
id|slop_len
suffix:semicolon
DECL|member|n_irqs
r_int
r_int
id|n_irqs
suffix:semicolon
DECL|member|bytes
r_int
id|bytes
suffix:semicolon
DECL|member|is_active
r_int
id|is_active
suffix:colon
l_int|1
suffix:semicolon
DECL|member|is_record
r_int
id|is_record
suffix:colon
l_int|1
suffix:semicolon
DECL|member|is_mapped
r_int
id|is_mapped
suffix:colon
l_int|1
suffix:semicolon
DECL|member|is_enabled
r_int
id|is_enabled
suffix:colon
l_int|1
suffix:semicolon
DECL|member|pcm_fmt
id|u8
id|pcm_fmt
suffix:semicolon
multiline_comment|/* VIA_PCM_FMT_xxx */
DECL|member|rate
r_int
id|rate
suffix:semicolon
multiline_comment|/* sample rate */
DECL|member|sgtable
r_volatile
r_struct
id|via_sgd_table
op_star
id|sgtable
suffix:semicolon
DECL|member|sgt_handle
id|dma_addr_t
id|sgt_handle
suffix:semicolon
DECL|member|sgbuf
r_struct
id|via_sgd_data
id|sgbuf
(braket
id|VIA_DMA_BUFFERS
)braket
suffix:semicolon
DECL|member|iobase
r_int
id|iobase
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* data stored for each chip */
DECL|struct|via_info
r_struct
id|via_info
(brace
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|member|baseaddr
r_int
id|baseaddr
suffix:semicolon
DECL|member|ac97
r_struct
id|ac97_codec
id|ac97
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|card_num
r_int
id|card_num
suffix:semicolon
multiline_comment|/* unique card number, from 0 */
DECL|member|dev_dsp
r_int
id|dev_dsp
suffix:semicolon
multiline_comment|/* /dev/dsp index from register_sound_dsp() */
DECL|member|rev_h
r_int
id|rev_h
suffix:colon
l_int|1
suffix:semicolon
DECL|member|syscall_sem
r_struct
id|semaphore
id|syscall_sem
suffix:semicolon
DECL|member|open_sem
r_struct
id|semaphore
id|open_sem
suffix:semicolon
DECL|member|ch_in
r_struct
id|via_channel
id|ch_in
suffix:semicolon
DECL|member|ch_out
r_struct
id|via_channel
id|ch_out
suffix:semicolon
DECL|member|ch_fm
r_struct
id|via_channel
id|ch_fm
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* number of cards, used for assigning unique numbers to cards */
DECL|variable|via_num_cards
r_static
r_int
id|via_num_cards
op_assign
l_int|0
suffix:semicolon
multiline_comment|/****************************************************************&n; *&n; * prototypes&n; *&n; *&n; */
r_static
r_int
id|via_init_one
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
suffix:semicolon
r_static
r_void
id|via_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
id|ssize_t
id|via_dsp_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
id|ssize_t
id|via_dsp_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
r_int
r_int
id|via_dsp_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
suffix:semicolon
r_static
r_int
id|via_dsp_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|via_dsp_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|via_dsp_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
macro_line|#ifdef VIA_SUPPORT_MMAP
r_static
r_int
id|via_dsp_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
suffix:semicolon
macro_line|#endif
r_static
id|u16
id|via_ac97_read_reg
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
suffix:semicolon
r_static
r_void
id|via_ac97_write_reg
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|value
)paren
suffix:semicolon
r_static
id|u8
id|via_ac97_wait_idle
(paren
r_struct
id|via_info
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|via_chan_free
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
)paren
suffix:semicolon
r_static
r_void
id|via_chan_clear
(paren
r_struct
id|via_channel
op_star
id|chan
)paren
suffix:semicolon
r_static
r_void
id|via_chan_pcm_fmt
(paren
r_struct
id|via_channel
op_star
id|chan
comma
r_int
id|reset
)paren
suffix:semicolon
macro_line|#ifdef VIA_PROC_FS
r_static
r_int
id|via_init_proc
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|via_cleanup_proc
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|via_card_init_proc
(paren
r_struct
id|via_info
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|via_card_cleanup_proc
(paren
r_struct
id|via_info
op_star
id|card
)paren
suffix:semicolon
macro_line|#else
DECL|function|via_init_proc
r_static
r_inline
r_int
id|via_init_proc
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_cleanup_proc
r_static
r_inline
r_void
id|via_cleanup_proc
(paren
r_void
)paren
(brace
)brace
DECL|function|via_card_init_proc
r_static
r_inline
r_int
id|via_card_init_proc
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_card_cleanup_proc
r_static
r_inline
r_void
id|via_card_cleanup_proc
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/****************************************************************&n; *&n; * Various data the driver needs&n; *&n; *&n; */
DECL|variable|__initdata
r_static
r_struct
id|pci_device_id
id|via_pci_tbl
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_82C686_5
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|via_pci_tbl
)paren
suffix:semicolon
DECL|variable|via_driver
r_static
r_struct
id|pci_driver
id|via_driver
op_assign
(brace
id|name
suffix:colon
id|VIA_MODULE_NAME
comma
id|id_table
suffix:colon
id|via_pci_tbl
comma
id|probe
suffix:colon
id|via_init_one
comma
id|remove
suffix:colon
id|via_remove_one
comma
)brace
suffix:semicolon
multiline_comment|/****************************************************************&n; *&n; * Low-level base 0 register read/write helpers&n; *&n; *&n; */
multiline_comment|/**&n; *&t;via_chan_stop - Terminate DMA on specified PCM channel&n; *&t;@iobase: PCI base address for SGD channel registers&n; *&n; *&t;Terminate scatter-gather DMA operation for given&n; *&t;channel (derived from @iobase), if DMA is active.&n; *&n; *&t;Note that @iobase is not the PCI base address,&n; *&t;but the PCI base address plus an offset to&n; *&t;one of three PCM channels supported by the chip.&n; *&n; */
DECL|function|via_chan_stop
r_static
r_inline
r_void
id|via_chan_stop
(paren
r_int
id|iobase
)paren
(brace
r_if
c_cond
(paren
id|inb
(paren
id|iobase
op_plus
id|VIA_PCM_STATUS
)paren
op_amp
id|VIA_SGD_ACTIVE
)paren
id|outb
(paren
id|VIA_SGD_TERMINATE
comma
id|iobase
op_plus
id|VIA_PCM_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_chan_status_clear - Clear status flags on specified DMA channel&n; *&t;@iobase: PCI base address for SGD channel registers&n; *&n; *&t;Clear any pending status flags for the given&n; *&t;DMA channel (derived from @iobase), if any&n; *&t;flags are asserted.&n; *&n; *&t;Note that @iobase is not the PCI base address,&n; *&t;but the PCI base address plus an offset to&n; *&t;one of three PCM channels supported by the chip.&n; *&n; */
DECL|function|via_chan_status_clear
r_static
r_inline
r_void
id|via_chan_status_clear
(paren
r_int
id|iobase
)paren
(brace
id|u8
id|tmp
op_assign
id|inb
(paren
id|iobase
op_plus
id|VIA_PCM_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
l_int|0
)paren
id|outb
(paren
id|tmp
comma
id|iobase
op_plus
id|VIA_PCM_STATUS
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;sg_begin - Begin recording or playback on a PCM channel&n; *&t;@chan: Channel for which DMA operation shall begin&n; *&n; *&t;Start scatter-gather DMA for the given channel.&n; *&n; */
DECL|function|sg_begin
r_static
r_inline
r_void
id|sg_begin
(paren
r_struct
id|via_channel
op_star
id|chan
)paren
(brace
id|outb
(paren
id|VIA_SGD_START
comma
id|chan-&gt;iobase
op_plus
id|VIA_PCM_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&n; * Miscellaneous debris&n; *&n; *&n; */
multiline_comment|/**&n; *&t;via_syscall_down - down the card-specific syscell semaphore&n; *&t;@card: Private info for specified board&n; *&t;@nonblock: boolean, non-zero if O_NONBLOCK is set&n; *&n; *&t;Encapsulates standard method of acquiring the syscall sem.&n; *&n; *&t;Returns negative errno on error, or zero for success.&n; */
DECL|function|via_syscall_down
r_static
r_inline
r_int
id|via_syscall_down
(paren
r_struct
id|via_info
op_star
id|card
comma
r_int
id|nonblock
)paren
(brace
r_if
c_cond
(paren
id|nonblock
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
(paren
op_amp
id|card-&gt;syscall_sem
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
(paren
op_amp
id|card-&gt;syscall_sem
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_stop_everything - Stop all audio operations&n; *&t;@card: Private info for specified board&n; *&n; *&t;Stops all DMA operations and interrupts, and clear&n; *&t;any pending status bits resulting from those operations.&n; */
DECL|function|via_stop_everything
r_static
r_void
id|via_stop_everything
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * terminate any existing operations on audio read/write channels&n;&t; */
id|via_chan_stop
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_OUT_CHAN
)paren
suffix:semicolon
id|via_chan_stop
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_IN_CHAN
)paren
suffix:semicolon
id|via_chan_stop
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_FM_OUT_CHAN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * clear any existing stops / flags (sanity check mainly)&n;&t; */
id|via_chan_status_clear
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_OUT_CHAN
)paren
suffix:semicolon
id|via_chan_status_clear
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_IN_CHAN
)paren
suffix:semicolon
id|via_chan_status_clear
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_FM_OUT_CHAN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * clear any enabled interrupt bits, reset to 8-bit mono PCM mode&n;&t; */
id|outb
(paren
l_int|0
comma
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_OUT_CHAN_TYPE
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_IN_CHAN_TYPE
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_FM_OUT_CHAN_TYPE
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_set_rate - Set PCM rate for given channel&n; *&t;@ac97: Pointer to generic codec info struct&n; *&t;@chan: Private info for specified channel&n; *&t;@rate: Desired PCM sample rate, in Khz&n; *&n; *&t;Sets the PCM sample rate for a channel.&n; *&n; *&t;Values for @rate are clamped to a range of 4000 Khz through 48000 Khz,&n; *&t;due to hardware constraints.&n; */
DECL|function|via_set_rate
r_static
r_int
id|via_set_rate
(paren
r_struct
id|ac97_codec
op_star
id|ac97
comma
r_struct
id|via_channel
op_star
id|chan
comma
r_int
id|rate
)paren
(brace
r_int
id|rate_reg
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER, rate = %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|rate_reg
op_assign
id|chan-&gt;is_record
ques
c_cond
id|AC97_PCM_LR_ADC_RATE
suffix:colon
id|AC97_PCM_FRONT_DAC_RATE
suffix:semicolon
id|via_ac97_write_reg
(paren
id|ac97
comma
id|AC97_POWER_CONTROL
comma
(paren
id|via_ac97_read_reg
(paren
id|ac97
comma
id|AC97_POWER_CONTROL
)paren
op_amp
op_complement
l_int|0x0200
)paren
op_or
l_int|0x0200
)paren
suffix:semicolon
id|via_ac97_write_reg
(paren
id|ac97
comma
id|rate_reg
comma
id|rate
)paren
suffix:semicolon
id|via_ac97_write_reg
(paren
id|ac97
comma
id|AC97_POWER_CONTROL
comma
id|via_ac97_read_reg
(paren
id|ac97
comma
id|AC97_POWER_CONTROL
)paren
op_amp
op_complement
l_int|0x0200
)paren
suffix:semicolon
id|udelay
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* the hardware might return a value different than what we&n;&t; * passed to it, so read the rate value back from hardware&n;&t; * to see what we came up with&n;&t; */
id|chan-&gt;rate
op_assign
id|via_ac97_read_reg
(paren
id|ac97
comma
id|rate_reg
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning rate %d Hz&bslash;n&quot;
comma
id|chan-&gt;rate
)paren
suffix:semicolon
r_return
id|chan-&gt;rate
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&n; * Channel-specific operations&n; *&n; *&n; */
multiline_comment|/**&n; *&t;via_chan_init_defaults - Initialize a struct via_channel&n; *&t;@card: Private audio chip info&n; *&t;@chan: Channel to be initialized&n; *&n; *&t;Zero @chan, and then set all static defaults for the structure.&n; */
DECL|function|via_chan_init_defaults
r_static
r_void
id|via_chan_init_defaults
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
)paren
(brace
id|memset
(paren
id|chan
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|chan
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan
op_eq
op_amp
id|card-&gt;ch_out
)paren
(brace
id|chan-&gt;name
op_assign
l_string|&quot;PCM-OUT&quot;
suffix:semicolon
id|chan-&gt;iobase
op_assign
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_OUT_CHAN
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chan
op_eq
op_amp
id|card-&gt;ch_in
)paren
(brace
id|chan-&gt;name
op_assign
l_string|&quot;PCM-IN&quot;
suffix:semicolon
id|chan-&gt;iobase
op_assign
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_IN_CHAN
suffix:semicolon
id|chan-&gt;is_record
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chan
op_eq
op_amp
id|card-&gt;ch_fm
)paren
(brace
id|chan-&gt;name
op_assign
l_string|&quot;PCM-OUT-FM&quot;
suffix:semicolon
id|chan-&gt;iobase
op_assign
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_FM_OUT_CHAN
suffix:semicolon
)brace
r_else
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|init_waitqueue_head
(paren
op_amp
id|chan-&gt;wait
)paren
suffix:semicolon
id|chan-&gt;pcm_fmt
op_assign
id|VIA_PCM_FMT_MASK
suffix:semicolon
id|chan-&gt;is_enabled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;is_record
)paren
id|atomic_set
(paren
op_amp
id|chan-&gt;n_bufs
comma
l_int|0
)paren
suffix:semicolon
r_else
id|atomic_set
(paren
op_amp
id|chan-&gt;n_bufs
comma
id|VIA_DMA_BUFFERS
)paren
suffix:semicolon
id|atomic_set
(paren
op_amp
id|chan-&gt;hw_ptr
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_chan_init - Initialize PCM channel&n; *&t;@card: Private audio chip info&n; *&t;@chan: Channel to be initialized&n; *&n; *&t;Performs all the preparations necessary to begin&n; *&t;using a PCM channel.&n; *&n; *&t;Currently the preparations include allocating the&n; *&t;scatter-gather DMA table and buffers, setting the&n; *&t;PCM channel to a known state, and passing the&n; *&t;address of the DMA table to the hardware.&n; *&n; *&t;Note that special care is taken when passing the&n; *&t;DMA table address to hardware, because it was found&n; *&t;during driver development that the hardware did not&n; *&t;always &quot;take&quot; the address.&n; */
DECL|function|via_chan_init
r_static
r_int
id|via_chan_init
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
)paren
(brace
r_int
id|i
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* bzero channel structure, and init members to defaults */
id|via_chan_init_defaults
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
multiline_comment|/* alloc DMA-able memory for scatter-gather table */
id|chan-&gt;sgtable
op_assign
id|pci_alloc_consistent
(paren
id|card-&gt;pdev
comma
(paren
r_sizeof
(paren
r_struct
id|via_sgd_table
)paren
op_star
id|VIA_DMA_BUFFERS
)paren
comma
op_amp
id|chan-&gt;sgt_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;sgtable
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;DMA table alloc fail, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
(paren
r_void
op_star
)paren
id|chan-&gt;sgtable
comma
l_int|0
comma
(paren
r_sizeof
(paren
r_struct
id|via_sgd_table
)paren
op_star
id|VIA_DMA_BUFFERS
)paren
)paren
suffix:semicolon
multiline_comment|/* alloc DMA-able memory for scatter-gather buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VIA_DMA_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|cpuaddr
op_assign
id|pci_alloc_consistent
(paren
id|card-&gt;pdev
comma
id|VIA_DMA_BUF_SIZE
comma
op_amp
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|cpuaddr
)paren
r_goto
id|err_out_nomem
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
(paren
id|VIA_DMA_BUFFERS
op_minus
l_int|1
)paren
)paren
id|chan-&gt;sgtable
(braket
id|i
)braket
dot
id|count
op_assign
id|cpu_to_le32
(paren
id|VIA_DMA_BUF_SIZE
op_or
id|VIA_FLAG
)paren
suffix:semicolon
r_else
id|chan-&gt;sgtable
(braket
id|i
)braket
dot
id|count
op_assign
id|cpu_to_le32
(paren
id|VIA_DMA_BUF_SIZE
op_or
id|VIA_EOL
)paren
suffix:semicolon
id|chan-&gt;sgtable
(braket
id|i
)braket
dot
id|addr
op_assign
id|cpu_to_le32
(paren
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|handle
)paren
suffix:semicolon
macro_line|#ifndef VIA_NDEBUG
id|memset
(paren
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|cpuaddr
comma
l_int|0xBC
comma
id|VIA_DMA_BUF_SIZE
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 1
id|DPRINTK
(paren
l_string|&quot;dmabuf #%d (h=%lx, 32(h)=%lx, v2p=%lx, a=%p)&bslash;n&quot;
comma
id|i
comma
(paren
r_int
)paren
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|handle
comma
(paren
r_int
)paren
id|chan-&gt;sgtable
(braket
id|i
)braket
dot
id|addr
comma
id|virt_to_phys
c_func
(paren
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|cpuaddr
)paren
comma
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|cpuaddr
)paren
suffix:semicolon
macro_line|#endif
m_assert
(paren
(paren
id|VIA_DMA_BUF_SIZE
op_mod
id|PAGE_SIZE
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* stop any existing channel output */
id|via_chan_clear
(paren
id|chan
)paren
suffix:semicolon
id|via_chan_status_clear
(paren
id|chan-&gt;iobase
)paren
suffix:semicolon
id|via_chan_pcm_fmt
(paren
id|chan
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set location of DMA-able scatter-gather info table */
id|DPRINTK
c_func
(paren
l_string|&quot;outl (0x%X, 0x%04lX)&bslash;n&quot;
comma
id|cpu_to_le32
(paren
id|chan-&gt;sgt_handle
)paren
comma
id|chan-&gt;iobase
op_plus
id|VIA_PCM_TABLE_ADDR
)paren
suffix:semicolon
id|via_ac97_wait_idle
(paren
id|card
)paren
suffix:semicolon
id|outl
(paren
id|cpu_to_le32
(paren
id|chan-&gt;sgt_handle
)paren
comma
id|chan-&gt;iobase
op_plus
id|VIA_PCM_TABLE_ADDR
)paren
suffix:semicolon
id|udelay
(paren
l_int|20
)paren
suffix:semicolon
id|via_ac97_wait_idle
(paren
id|card
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;inl (0x%lX) = %x&bslash;n&quot;
comma
id|chan-&gt;iobase
op_plus
id|VIA_PCM_TABLE_ADDR
comma
id|inl
c_func
(paren
id|chan-&gt;iobase
op_plus
id|VIA_PCM_TABLE_ADDR
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_nomem
suffix:colon
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;DMA buffer alloc fail, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|via_chan_free
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_chan_free - Release a PCM channel&n; *&t;@card: Private audio chip info&n; *&t;@chan: Channel to be released&n; *&n; *&t;Performs all the functions necessary to clean up&n; *&t;an initialized channel.&n; *&n; *&t;Currently these functions include disabled any&n; *&t;active DMA operations, setting the PCM channel&n; *&t;back to a known state, and releasing any allocated&n; *&t;sound buffers.&n; */
DECL|function|via_chan_free
r_static
r_void
id|via_chan_free
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
)paren
(brace
r_int
id|i
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* stop any existing channel output */
id|via_chan_stop
(paren
id|chan-&gt;iobase
)paren
suffix:semicolon
id|via_chan_status_clear
(paren
id|chan-&gt;iobase
)paren
suffix:semicolon
id|via_chan_pcm_fmt
(paren
id|chan
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* zero location of DMA-able scatter-gather info table */
id|via_ac97_wait_idle
c_func
(paren
id|card
)paren
suffix:semicolon
id|outl
(paren
l_int|0
comma
id|chan-&gt;iobase
op_plus
id|VIA_PCM_TABLE_ADDR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VIA_DMA_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|cpuaddr
)paren
(brace
m_assert
(paren
(paren
id|VIA_DMA_BUF_SIZE
op_mod
id|PAGE_SIZE
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|pci_free_consistent
(paren
id|card-&gt;pdev
comma
id|VIA_DMA_BUF_SIZE
comma
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|cpuaddr
comma
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|handle
)paren
suffix:semicolon
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|cpuaddr
op_assign
l_int|NULL
suffix:semicolon
id|chan-&gt;sgbuf
(braket
id|i
)braket
dot
id|handle
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan-&gt;sgtable
)paren
(brace
id|pci_free_consistent
(paren
id|card-&gt;pdev
comma
(paren
r_sizeof
(paren
r_struct
id|via_sgd_table
)paren
op_star
id|VIA_DMA_BUFFERS
)paren
comma
(paren
r_void
op_star
)paren
id|chan-&gt;sgtable
comma
id|chan-&gt;sgt_handle
)paren
suffix:semicolon
id|chan-&gt;sgtable
op_assign
l_int|NULL
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_chan_pcm_fmt - Update PCM channel settings&n; *&t;@chan: Channel to be updated&n; *&t;@reset: Boolean.  If non-zero, channel will be reset&n; *&t;&t;to 8-bit mono mode.&n; *&n; *&t;Stores the settings of the current PCM format,&n; *&t;8-bit or 16-bit, and mono/stereo, into the&n; *&t;hardware settings for the specified channel.&n; *&t;If @reset is non-zero, the channel is reset&n; *&t;to 8-bit mono mode.  Otherwise, the channel&n; *&t;is set to the values stored in the channel&n; *&t;information struct @chan.&n; */
DECL|function|via_chan_pcm_fmt
r_static
r_void
id|via_chan_pcm_fmt
(paren
r_struct
id|via_channel
op_star
id|chan
comma
r_int
id|reset
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER, pcm_fmt=0x%02X, reset=%s&bslash;n&quot;
comma
id|chan-&gt;pcm_fmt
comma
id|reset
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
m_assert
(paren
id|chan
op_ne
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reset
)paren
multiline_comment|/* reset to 8-bit mono mode */
id|chan-&gt;pcm_fmt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* enable interrupts on FLAG and EOL */
id|chan-&gt;pcm_fmt
op_or_assign
id|VIA_CHAN_TYPE_MASK
suffix:semicolon
multiline_comment|/* if we are recording, enable recording fifo bit */
r_if
c_cond
(paren
id|chan-&gt;is_record
)paren
id|chan-&gt;pcm_fmt
op_or_assign
id|VIA_PCM_REC_FIFO
suffix:semicolon
multiline_comment|/* set interrupt select bits where applicable (PCM &amp; FM out channels) */
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;is_record
)paren
id|chan-&gt;pcm_fmt
op_or_assign
id|VIA_CHAN_TYPE_INT_SELECT
suffix:semicolon
id|outb
(paren
id|chan-&gt;pcm_fmt
comma
id|chan-&gt;iobase
op_plus
l_int|2
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, pcm_fmt = 0x%02X, reg = 0x%02X&bslash;n&quot;
comma
id|chan-&gt;pcm_fmt
comma
id|inb
(paren
id|chan-&gt;iobase
op_plus
l_int|2
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_chan_clear - Stop DMA channel operation, and reset pointers&n; *&t;@chan: Channel to be cleared&n; *&n; *&t;Call via_chan_stop to halt DMA operations, and then resets&n; *&t;all software pointers which track DMA operation.&n; */
DECL|function|via_chan_clear
r_static
r_void
id|via_chan_clear
(paren
r_struct
id|via_channel
op_star
id|chan
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|via_chan_stop
(paren
id|chan-&gt;iobase
)paren
suffix:semicolon
id|chan-&gt;is_active
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;is_mapped
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;is_enabled
op_assign
l_int|1
suffix:semicolon
id|chan-&gt;slop_len
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;sw_ptr
op_assign
l_int|0
suffix:semicolon
id|chan-&gt;n_irqs
op_assign
l_int|0
suffix:semicolon
id|atomic_set
(paren
op_amp
id|chan-&gt;hw_ptr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;is_record
)paren
id|atomic_set
(paren
op_amp
id|chan-&gt;n_bufs
comma
l_int|0
)paren
suffix:semicolon
r_else
id|atomic_set
(paren
op_amp
id|chan-&gt;n_bufs
comma
id|VIA_DMA_BUFFERS
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_chan_set_speed - Set PCM sample rate for given channel&n; *&t;@card: Private info for specified board&n; *&t;@chan: Channel whose sample rate will be adjusted&n; *&t;@val: New sample rate, in Khz&n; *&n; *&t;Helper function for the %SNDCTL_DSP_SPEED ioctl.  OSS semantics&n; *&t;demand that all audio operations halt (if they are not already&n; *&t;halted) when the %SNDCTL_DSP_SPEED is given.&n; *&n; *&t;This function halts all audio operations for the given channel&n; *&t;@chan, and then calls via_set_rate to set the audio hardware&n; *&t;to the new rate.&n; */
DECL|function|via_chan_set_speed
r_static
r_int
id|via_chan_set_speed
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
comma
r_int
id|val
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER, requested rate = %d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|via_chan_clear
(paren
id|chan
)paren
suffix:semicolon
id|val
op_assign
id|via_set_rate
(paren
op_amp
id|card-&gt;ac97
comma
id|chan
comma
id|val
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_chan_set_fmt - Set PCM sample size for given channel&n; *&t;@card: Private info for specified board&n; *&t;@chan: Channel whose sample size will be adjusted&n; *&t;@val: New sample size, use the %AFMT_xxx constants&n; *&n; *&t;Helper function for the %SNDCTL_DSP_SETFMT ioctl.  OSS semantics&n; *&t;demand that all audio operations halt (if they are not already&n; *&t;halted) when the %SNDCTL_DSP_SETFMT is given.&n; *&n; *&t;This function halts all audio operations for the given channel&n; *&t;@chan, and then calls via_chan_pcm_fmt to set the audio hardware&n; *&t;to the new sample size, either 8-bit or 16-bit.&n; */
DECL|function|via_chan_set_fmt
r_static
r_int
id|via_chan_set_fmt
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
comma
r_int
id|val
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER, val=%s&bslash;n&quot;
comma
id|val
op_eq
id|AFMT_U8
ques
c_cond
l_string|&quot;AFMT_U8&quot;
suffix:colon
id|val
op_eq
id|AFMT_S16_LE
ques
c_cond
l_string|&quot;AFMT_S16_LE&quot;
suffix:colon
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
id|via_chan_clear
(paren
id|chan
)paren
suffix:semicolon
m_assert
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
suffix:semicolon
multiline_comment|/* this case is handled elsewhere */
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|AFMT_S16_LE
suffix:colon
r_if
c_cond
(paren
(paren
id|chan-&gt;pcm_fmt
op_amp
id|VIA_PCM_FMT_16BIT
)paren
op_eq
l_int|0
)paren
(brace
id|chan-&gt;pcm_fmt
op_or_assign
id|VIA_PCM_FMT_16BIT
suffix:semicolon
id|via_chan_pcm_fmt
(paren
id|chan
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|AFMT_U8
suffix:colon
r_if
c_cond
(paren
id|chan-&gt;pcm_fmt
op_amp
id|VIA_PCM_FMT_16BIT
)paren
(brace
id|chan-&gt;pcm_fmt
op_and_assign
op_complement
id|VIA_PCM_FMT_16BIT
suffix:semicolon
id|via_chan_pcm_fmt
(paren
id|chan
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
(paren
l_string|&quot;unknown AFMT: 0x%X&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|val
op_assign
id|AFMT_S16_LE
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_chan_set_stereo - Enable or disable stereo for a DMA channel&n; *&t;@card: Private info for specified board&n; *&t;@chan: Channel whose stereo setting will be adjusted&n; *&t;@val: New sample size, use the %AFMT_xxx constants&n; *&n; *&t;Helper function for the %SNDCTL_DSP_CHANNELS and %SNDCTL_DSP_STEREO ioctls.  OSS semantics&n; *&t;demand that all audio operations halt (if they are not already&n; *&t;halted) when %SNDCTL_DSP_CHANNELS or SNDCTL_DSP_STEREO is given.&n; *&n; *&t;This function halts all audio operations for the given channel&n; *&t;@chan, and then calls via_chan_pcm_fmt to set the audio hardware&n; *&t;to enable or disable stereo.&n; */
DECL|function|via_chan_set_stereo
r_static
r_int
id|via_chan_set_stereo
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
comma
r_int
id|val
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER, channels = %d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|via_chan_clear
(paren
id|chan
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
multiline_comment|/* mono */
r_case
l_int|1
suffix:colon
id|chan-&gt;pcm_fmt
op_and_assign
op_complement
id|VIA_PCM_FMT_STEREO
suffix:semicolon
id|via_chan_pcm_fmt
(paren
id|chan
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* stereo */
r_case
l_int|2
suffix:colon
id|chan-&gt;pcm_fmt
op_or_assign
id|VIA_PCM_FMT_STEREO
suffix:semicolon
id|via_chan_pcm_fmt
(paren
id|chan
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* unknown */
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;unknown number of channels&bslash;n&quot;
)paren
suffix:semicolon
id|val
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
macro_line|#ifdef VIA_CHAN_DUMP_BUFS
multiline_comment|/**&n; *&t;via_chan_dump_bufs - Display DMA table contents&n; *&t;@chan: Channel whose DMA table will be displayed&n; *&n; *&t;Debugging function which displays the contents of the&n; *&t;scatter-gather DMA table for the given channel @chan.&n; */
DECL|function|via_chan_dump_bufs
r_static
r_void
id|via_chan_dump_bufs
(paren
r_struct
id|via_channel
op_star
id|chan
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VIA_DMA_BUFFERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;#%02d: addr=%x, count=%u, flag=%d, eol=%d&bslash;n&quot;
comma
id|i
comma
id|chan-&gt;sgtable
(braket
id|i
)braket
dot
id|addr
comma
id|chan-&gt;sgtable
(braket
id|i
)braket
dot
id|count
op_amp
l_int|0x00FFFFFF
comma
id|chan-&gt;sgtable
(braket
id|i
)braket
dot
id|count
op_amp
id|VIA_FLAG
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
id|chan-&gt;sgtable
(braket
id|i
)braket
dot
id|count
op_amp
id|VIA_EOL
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;buf_in_use = %d, nextbuf = %d&bslash;n&quot;
comma
id|atomic_read
(paren
op_amp
id|chan-&gt;buf_in_use
)paren
comma
id|atomic_read
(paren
op_amp
id|chan-&gt;sw_ptr
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* VIA_CHAN_DUMP_BUFS */
multiline_comment|/**&n; *&t;via_chan_flush_frag - Flush partially-full playback buffer to hardware&n; *&t;@chan: Channel whose DMA table will be displayed&n; *&n; *&t;Flushes partially-full playback buffer to hardware.&n; */
DECL|function|via_chan_flush_frag
r_static
r_void
id|via_chan_flush_frag
(paren
r_struct
id|via_channel
op_star
id|chan
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|chan-&gt;slop_len
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;sw_ptr
op_eq
(paren
id|VIA_DMA_BUFFERS
op_minus
l_int|1
)paren
)paren
id|chan-&gt;sw_ptr
op_assign
l_int|0
suffix:semicolon
r_else
id|chan-&gt;sw_ptr
op_increment
suffix:semicolon
id|chan-&gt;slop_len
op_assign
l_int|0
suffix:semicolon
m_assert
(paren
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
OG
l_int|0
)paren
suffix:semicolon
id|atomic_dec
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_chan_maybe_start - Initiate audio hardware DMA operation&n; *&t;@chan: Channel whose DMA is to be started&n; *&n; *&t;Initiate DMA operation, if the DMA engine for the given&n; *&t;channel @chan is not already active.&n; */
DECL|function|via_chan_maybe_start
r_static
r_inline
r_void
id|via_chan_maybe_start
(paren
r_struct
id|via_channel
op_star
id|chan
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;is_active
op_logical_and
id|chan-&gt;is_enabled
)paren
(brace
id|chan-&gt;is_active
op_assign
l_int|1
suffix:semicolon
id|sg_begin
(paren
id|chan
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;starting channel %s&bslash;n&quot;
comma
id|chan-&gt;name
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************&n; *&n; * Interface to ac97-codec module&n; *&n; *&n; */
multiline_comment|/**&n; *&t;via_ac97_wait_idle - Wait until AC97 codec is not busy&n; *&t;@card: Private info for specified board&n; *&n; *&t;Sleep until the AC97 codec is no longer busy.&n; *&t;Returns the final value read from the SGD&n; *&t;register being polled.&n; */
DECL|function|via_ac97_wait_idle
r_static
id|u8
id|via_ac97_wait_idle
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
id|u8
id|tmp8
suffix:semicolon
r_int
id|counter
op_assign
id|VIA_COUNTER_LIMIT
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER/EXIT&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|card-&gt;pdev
op_ne
l_int|NULL
)paren
suffix:semicolon
r_do
(brace
id|udelay
(paren
l_int|15
)paren
suffix:semicolon
id|tmp8
op_assign
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x83
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|tmp8
op_amp
id|VIA_CR83_BUSY
)paren
op_logical_and
(paren
id|counter
op_decrement
OG
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp8
op_amp
id|VIA_CR83_BUSY
)paren
id|printk
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;timeout waiting on AC97 codec&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tmp8
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_ac97_read_reg - Read AC97 standard register&n; *&t;@codec: Pointer to generic AC97 codec info&n; *&t;@reg: Index of AC97 register to be read&n; *&n; *&t;Read the value of a single AC97 codec register,&n; *&t;as defined by the Intel AC97 specification.&n; *&n; *&t;Defines the standard AC97 read-register operation&n; *&t;required by the kernel&squot;s ac97_codec interface.&n; *&n; *&t;Returns the 16-bit value stored in the specified&n; *&t;register.&n; */
DECL|function|via_ac97_read_reg
r_static
id|u16
id|via_ac97_read_reg
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
(brace
r_int
r_int
id|data
suffix:semicolon
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_int
id|counter
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|codec
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|codec-&gt;private_data
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|codec-&gt;private_data
suffix:semicolon
id|data
op_assign
(paren
id|reg
op_lshift
l_int|16
)paren
op_or
id|VIA_CR80_READ
suffix:semicolon
id|outl
(paren
id|data
comma
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_AC97_CTRL
)paren
suffix:semicolon
id|udelay
(paren
l_int|20
)paren
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
id|VIA_COUNTER_LIMIT
suffix:semicolon
id|counter
OG
l_int|0
suffix:semicolon
id|counter
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x80
)paren
op_amp
id|VIA_CR80_VALID
)paren
r_goto
id|out
suffix:semicolon
id|udelay
(paren
l_int|15
)paren
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;timeout while reading AC97 codec (0x%lX)&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
id|out
suffix:colon
id|data
op_assign
(paren
r_int
r_int
)paren
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x80
)paren
suffix:semicolon
id|outb
(paren
l_int|0x02
comma
id|card-&gt;baseaddr
op_plus
l_int|0x83
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|data
op_amp
l_int|0x007F0000
)paren
op_rshift
l_int|16
)paren
op_eq
id|reg
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, success, data=0x%lx, retval=0x%lx&bslash;n&quot;
comma
id|data
comma
id|data
op_amp
l_int|0x0000FFFF
)paren
suffix:semicolon
r_return
id|data
op_amp
l_int|0x0000FFFF
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;via82cxxx_audio: not our index: reg=0x%x, newreg=0x%lx&bslash;n&quot;
comma
id|reg
comma
(paren
(paren
id|data
op_amp
l_int|0x007F0000
)paren
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|err_out
suffix:colon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_ac97_write_reg - Write AC97 standard register&n; *&t;@codec: Pointer to generic AC97 codec info&n; *&t;@reg: Index of AC97 register to be written&n; *&t;@value: Value to be written to AC97 register&n; *&n; *&t;Write the value of a single AC97 codec register,&n; *&t;as defined by the Intel AC97 specification.&n; *&n; *&t;Defines the standard AC97 write-register operation&n; *&t;required by the kernel&squot;s ac97_codec interface.&n; */
DECL|function|via_ac97_write_reg
r_static
r_void
id|via_ac97_write_reg
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|value
)paren
(brace
id|u32
id|data
suffix:semicolon
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_int
id|counter
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|codec
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|codec-&gt;private_data
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|codec-&gt;private_data
suffix:semicolon
id|data
op_assign
(paren
id|reg
op_lshift
l_int|16
)paren
op_plus
id|value
suffix:semicolon
id|outl
(paren
id|data
comma
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_AC97_CTRL
)paren
suffix:semicolon
id|udelay
(paren
l_int|10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
id|VIA_COUNTER_LIMIT
suffix:semicolon
id|counter
OG
l_int|0
suffix:semicolon
id|counter
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x83
)paren
op_amp
id|VIA_CR83_BUSY
)paren
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|udelay
(paren
l_int|15
)paren
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;timeout after AC97 codec write (0x%X, 0x%X)&bslash;n&quot;
comma
id|reg
comma
id|value
)paren
suffix:semicolon
id|out
suffix:colon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|via_mixer_open
r_static
r_int
id|via_mixer_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_struct
id|pci_driver
op_star
id|drvr
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|pci_for_each_dev
c_func
(paren
id|pdev
)paren
(brace
id|drvr
op_assign
id|pci_dev_driver
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvr
op_eq
op_amp
id|via_driver
)paren
(brace
m_assert
(paren
id|pci_get_drvdata
(paren
id|pdev
)paren
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|pci_get_drvdata
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ac97.dev_mixer
op_eq
id|minor
)paren
r_goto
id|match
suffix:semicolon
)brace
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -ENODEV&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
id|match
suffix:colon
id|file-&gt;private_data
op_assign
op_amp
id|card-&gt;ac97
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_mixer_ioctl
r_static
r_int
id|via_mixer_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ac97_codec
op_star
id|codec
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|codec
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|codec-&gt;private_data
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
id|rc
op_assign
id|via_syscall_down
(paren
id|card
comma
id|nonblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
id|codec
op_member_access_from_pointer
id|mixer_ioctl
c_func
(paren
id|codec
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|up
(paren
op_amp
id|card-&gt;syscall_sem
)paren
suffix:semicolon
id|out
suffix:colon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|via_llseek
r_static
id|loff_t
id|via_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning -ESPIPE&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
DECL|variable|via_mixer_fops
r_static
r_struct
id|file_operations
id|via_mixer_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|open
suffix:colon
id|via_mixer_open
comma
id|llseek
suffix:colon
id|via_llseek
comma
id|ioctl
suffix:colon
id|via_mixer_ioctl
comma
)brace
suffix:semicolon
DECL|function|via_ac97_reset
r_static
r_int
id|__init
id|via_ac97_reset
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|card-&gt;pdev
suffix:semicolon
id|u8
id|tmp8
suffix:semicolon
id|u16
id|tmp16
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|pdev
op_ne
l_int|NULL
)paren
suffix:semicolon
macro_line|#ifndef NDEBUG
(brace
id|u8
id|r40
comma
id|r41
comma
id|r42
comma
id|r43
comma
id|r44
comma
id|r48
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x40
comma
op_amp
id|r40
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x41
comma
op_amp
id|r41
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x42
comma
op_amp
id|r42
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x43
comma
op_amp
id|r43
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x44
comma
op_amp
id|r44
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x48
comma
op_amp
id|r48
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;PCI config: %02X %02X %02X %02X %02X %02X&bslash;n&quot;
comma
id|r40
comma
id|r41
comma
id|r42
comma
id|r43
comma
id|r44
comma
id|r48
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;regs==%02X %02X %02X %08X %08X %08X %08X&bslash;n&quot;
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x00
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x01
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x02
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x04
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x0C
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x80
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x84
)paren
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;         * reset AC97 controller: enable, disable, enable&n;         * pause after each command for good luck&n;         */
id|pci_write_config_byte
(paren
id|pdev
comma
id|VIA_ACLINK_CTRL
comma
id|VIA_CR41_AC97_ENABLE
op_or
id|VIA_CR41_AC97_RESET
op_or
id|VIA_CR41_AC97_WAKEUP
)paren
suffix:semicolon
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
id|pci_write_config_byte
(paren
id|pdev
comma
id|VIA_ACLINK_CTRL
comma
l_int|0
)paren
suffix:semicolon
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
id|pci_write_config_byte
(paren
id|pdev
comma
id|VIA_ACLINK_CTRL
comma
id|VIA_CR41_AC97_ENABLE
op_or
id|VIA_CR41_PCM_ENABLE
op_or
id|VIA_CR41_VRA
op_or
id|VIA_CR41_AC97_RESET
)paren
suffix:semicolon
id|udelay
(paren
l_int|100
)paren
suffix:semicolon
macro_line|#if 0 /* this breaks on K7M */
multiline_comment|/* disable legacy stuff */
id|pci_write_config_byte
(paren
id|pdev
comma
l_int|0x42
comma
l_int|0x00
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* route FM trap to IRQ, disable FM trap */
id|pci_write_config_byte
(paren
id|pdev
comma
l_int|0x48
comma
l_int|0x05
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* disable all codec GPI interrupts */
id|outl
(paren
l_int|0
comma
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
op_plus
l_int|0x8C
)paren
suffix:semicolon
multiline_comment|/* WARNING: this line is magic.  Remove this&n;&t; * and things break. */
multiline_comment|/* enable variable rate, variable rate MIC ADC */
id|tmp16
op_assign
id|via_ac97_read_reg
(paren
op_amp
id|card-&gt;ac97
comma
l_int|0x2A
)paren
suffix:semicolon
id|via_ac97_write_reg
(paren
op_amp
id|card-&gt;ac97
comma
l_int|0x2A
comma
id|tmp16
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|pdev
comma
id|VIA_ACLINK_CTRL
comma
op_amp
id|tmp8
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp8
op_amp
(paren
id|VIA_CR41_AC97_ENABLE
op_or
id|VIA_CR41_AC97_RESET
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot enable AC97 controller, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, tmp8=%X, returning -ENODEV&bslash;n&quot;
comma
id|tmp8
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_ac97_codec_wait
r_static
r_void
id|via_ac97_codec_wait
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
(brace
m_assert
(paren
id|codec-&gt;private_data
op_ne
l_int|NULL
)paren
suffix:semicolon
id|via_ac97_wait_idle
(paren
id|codec-&gt;private_data
)paren
suffix:semicolon
)brace
DECL|function|via_ac97_init
r_static
r_int
id|__init
id|via_ac97_init
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
r_int
id|rc
suffix:semicolon
id|u16
id|tmp16
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|card-&gt;ac97
comma
l_int|0
comma
r_sizeof
(paren
id|card-&gt;ac97
)paren
)paren
suffix:semicolon
id|card-&gt;ac97.private_data
op_assign
id|card
suffix:semicolon
id|card-&gt;ac97.codec_read
op_assign
id|via_ac97_read_reg
suffix:semicolon
id|card-&gt;ac97.codec_write
op_assign
id|via_ac97_write_reg
suffix:semicolon
id|card-&gt;ac97.codec_wait
op_assign
id|via_ac97_codec_wait
suffix:semicolon
id|card-&gt;ac97.dev_mixer
op_assign
id|register_sound_mixer
(paren
op_amp
id|via_mixer_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ac97.dev_mixer
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to register AC97 mixer, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning -EIO&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|rc
op_assign
id|via_ac97_reset
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to reset AC97 codec, aborting&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ac97_probe_codec
(paren
op_amp
id|card-&gt;ac97
)paren
op_eq
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to probe AC97 codec, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
multiline_comment|/* enable variable rate, variable rate MIC ADC */
id|tmp16
op_assign
id|via_ac97_read_reg
(paren
op_amp
id|card-&gt;ac97
comma
l_int|0x2A
)paren
suffix:semicolon
id|via_ac97_write_reg
(paren
op_amp
id|card-&gt;ac97
comma
l_int|0x2A
comma
id|tmp16
op_or
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
id|unregister_sound_mixer
(paren
id|card-&gt;ac97.dev_mixer
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|via_ac97_cleanup
r_static
r_void
id|via_ac97_cleanup
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|card-&gt;ac97.dev_mixer
op_ge
l_int|0
)paren
suffix:semicolon
id|unregister_sound_mixer
(paren
id|card-&gt;ac97.dev_mixer
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&n; * Interrupt-related code&n; *&n; */
multiline_comment|/**&n; *&t;via_intr_channel - handle an interrupt for a single channel&n; *&t;@chan: handle interrupt for this channel&n; *&n; *&t;This is the &quot;meat&quot; of the interrupt handler,&n; *&t;containing the actions taken each time an interrupt&n; *&t;occurs.  All communication and coordination with&n; *&t;userspace takes place here.&n; *&n; *&t;Locking: inside card-&gt;lock&n; */
DECL|function|via_intr_channel
r_static
r_void
id|via_intr_channel
(paren
r_struct
id|via_channel
op_star
id|chan
)paren
(brace
id|u8
id|status
suffix:semicolon
r_int
id|n
suffix:semicolon
multiline_comment|/* check pertinent bits of status register for action bits */
id|status
op_assign
id|inb
(paren
id|chan-&gt;iobase
)paren
op_amp
(paren
id|VIA_SGD_FLAG
op_or
id|VIA_SGD_EOL
op_or
id|VIA_SGD_STOPPED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
r_return
suffix:semicolon
multiline_comment|/* acknowledge any flagged bits ASAP */
id|outb
(paren
id|status
comma
id|chan-&gt;iobase
)paren
suffix:semicolon
multiline_comment|/* grab current h/w ptr value */
id|n
op_assign
id|atomic_read
(paren
op_amp
id|chan-&gt;hw_ptr
)paren
suffix:semicolon
multiline_comment|/* sanity check: make sure our h/w ptr doesn&squot;t have a weird value */
m_assert
(paren
id|n
op_ge
l_int|0
)paren
suffix:semicolon
m_assert
(paren
id|n
OL
id|VIA_DMA_BUFFERS
)paren
suffix:semicolon
multiline_comment|/* reset SGD data structure in memory to reflect a full buffer,&n;&t; * and advance the h/w ptr, wrapping around to zero if needed&n;&t; */
r_if
c_cond
(paren
id|n
op_eq
(paren
id|VIA_DMA_BUFFERS
op_minus
l_int|1
)paren
)paren
(brace
id|chan-&gt;sgtable
(braket
id|n
)braket
dot
id|count
op_assign
(paren
id|VIA_DMA_BUF_SIZE
op_or
id|VIA_EOL
)paren
suffix:semicolon
id|atomic_set
(paren
op_amp
id|chan-&gt;hw_ptr
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|chan-&gt;sgtable
(braket
id|n
)braket
dot
id|count
op_assign
(paren
id|VIA_DMA_BUF_SIZE
op_or
id|VIA_FLAG
)paren
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|chan-&gt;hw_ptr
)paren
suffix:semicolon
)brace
multiline_comment|/* accounting crap for SNDCTL_DSP_GETxPTR */
id|chan-&gt;n_irqs
op_increment
suffix:semicolon
id|chan-&gt;bytes
op_add_assign
id|VIA_DMA_BUF_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;bytes
OL
l_int|0
)paren
multiline_comment|/* handle overflow of 31-bit value */
id|chan-&gt;bytes
op_assign
id|VIA_DMA_BUF_SIZE
suffix:semicolon
multiline_comment|/* wake up anyone listening to see when interrupts occur */
r_if
c_cond
(paren
id|waitqueue_active
(paren
op_amp
id|chan-&gt;wait
)paren
)paren
id|wake_up_all
(paren
op_amp
id|chan-&gt;wait
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s intr, status=0x%02X, hwptr=0x%lX, chan-&gt;hw_ptr=%d&bslash;n&quot;
comma
id|chan-&gt;name
comma
id|status
comma
(paren
r_int
)paren
id|inl
(paren
id|chan-&gt;iobase
op_plus
l_int|0x04
)paren
comma
id|atomic_read
(paren
op_amp
id|chan-&gt;hw_ptr
)paren
)paren
suffix:semicolon
multiline_comment|/* all following checks only occur when not in mmap(2) mode */
r_if
c_cond
(paren
id|chan-&gt;is_mapped
)paren
r_return
suffix:semicolon
multiline_comment|/* If we are recording, then n_bufs represents the number&n;&t; * of buffers waiting to be handled by userspace.&n;&t; * If we are playback, then n_bufs represents the number&n;&t; * of buffers remaining to be filled by userspace.&n;&t; * We increment here.  If we reach max buffers (VIA_DMA_BUFFERS),&n;&t; * this indicates an underrun/overrun.  For this case under OSS,&n;&t; * we stop the record/playback process.&n;&t; */
r_if
c_cond
(paren
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
OL
id|VIA_DMA_BUFFERS
)paren
id|atomic_inc
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
m_assert
(paren
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
op_le
id|VIA_DMA_BUFFERS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
op_eq
id|VIA_DMA_BUFFERS
)paren
(brace
id|chan-&gt;is_active
op_assign
l_int|0
suffix:semicolon
id|via_chan_stop
(paren
id|chan-&gt;iobase
)paren
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;%s intr, channel n_bufs == %d&bslash;n&quot;
comma
id|chan-&gt;name
comma
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
)paren
suffix:semicolon
)brace
DECL|function|via_interrupt
r_static
r_void
id|via_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|via_info
op_star
id|card
op_assign
id|dev_id
suffix:semicolon
id|u32
id|status32
suffix:semicolon
multiline_comment|/* to minimize interrupt sharing costs, we use the SGD status&n;&t; * shadow register to check the status of all inputs and&n;&t; * outputs with a single 32-bit bus read.  If no interrupt&n;&t; * conditions are flagged, we exit immediately&n;&t; */
id|status32
op_assign
id|inl
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_SGD_STATUS_SHADOW
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status32
op_amp
id|VIA_INTR_MASK
)paren
)paren
r_return
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;intr, status32 == 0x%08X&bslash;n&quot;
comma
id|status32
)paren
suffix:semicolon
multiline_comment|/* synchronize interrupt handling under SMP.  this spinlock&n;&t; * goes away completely on UP&n;&t; */
id|spin_lock
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status32
op_amp
id|VIA_INTR_OUT
)paren
id|via_intr_channel
(paren
op_amp
id|card-&gt;ch_out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status32
op_amp
id|VIA_INTR_IN
)paren
id|via_intr_channel
(paren
op_amp
id|card-&gt;ch_in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status32
op_amp
id|VIA_INTR_FM
)paren
id|via_intr_channel
(paren
op_amp
id|card-&gt;ch_fm
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_interrupt_disable - Disable all interrupt-generating sources&n; *&t;@card: Private info for specified board&n; *&n; *&t;Disables all interrupt-generation flags in the Via&n; *&t;audio hardware registers.&n; */
DECL|function|via_interrupt_disable
r_static
r_void
id|via_interrupt_disable
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
id|u8
id|tmp8
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
id|VIA_FM_NMI_CTRL
comma
op_amp
id|tmp8
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp8
op_amp
id|VIA_CR48_FM_TRAP_TO_NMI
)paren
op_eq
l_int|0
)paren
(brace
id|tmp8
op_or_assign
id|VIA_CR48_FM_TRAP_TO_NMI
suffix:semicolon
id|pci_write_config_byte
(paren
id|card-&gt;pdev
comma
id|VIA_FM_NMI_CTRL
comma
id|tmp8
)paren
suffix:semicolon
)brace
id|outb
(paren
id|inb
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_OUT_CHAN_TYPE
)paren
op_amp
id|VIA_INT_DISABLE_MASK
comma
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_OUT_CHAN_TYPE
)paren
suffix:semicolon
id|outb
(paren
id|inb
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_IN_CHAN_TYPE
)paren
op_amp
id|VIA_INT_DISABLE_MASK
comma
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_PCM_IN_CHAN_TYPE
)paren
suffix:semicolon
id|outb
(paren
id|inb
(paren
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_FM_OUT_CHAN_TYPE
)paren
op_amp
id|VIA_INT_DISABLE_MASK
comma
id|card-&gt;baseaddr
op_plus
id|VIA_BASE0_FM_OUT_CHAN_TYPE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_interrupt_init - Initialize interrupt handling&n; *&t;@card: Private info for specified board&n; *&n; *&t;Obtain and reserve IRQ for using in handling audio events.&n; *&t;Also, disable any IRQ-generating resources, to make sure&n; *&t;we don&squot;t get interrupts before we want them.&n; */
DECL|function|via_interrupt_init
r_static
r_int
id|via_interrupt_init
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|card-&gt;pdev
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* check for sane IRQ number. can this ever happen? */
r_if
c_cond
(paren
id|card-&gt;pdev-&gt;irq
OL
l_int|2
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;insane IRQ %d, aborting&bslash;n&quot;
comma
id|card-&gt;pdev-&gt;irq
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -EIO&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
(paren
id|card-&gt;pdev-&gt;irq
comma
id|via_interrupt
comma
id|SA_SHIRQ
comma
id|VIA_MODULE_NAME
comma
id|card
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to obtain IRQ %d, aborting&bslash;n&quot;
comma
id|card-&gt;pdev-&gt;irq
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -EBUSY&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* we don&squot;t want interrupts until we&squot;re opened */
id|via_interrupt_disable
(paren
id|card
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_interrupt_cleanup - Shutdown driver interrupt handling&n; *&t;@card: Private info for specified board&n; *&n; *&t;Disable any potential interrupt sources in the Via audio&n; *&t;hardware, and then release (un-reserve) the IRQ line&n; *&t;in the kernel core.&n; */
DECL|function|via_interrupt_cleanup
r_static
r_void
id|via_interrupt_cleanup
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|card-&gt;pdev
op_ne
l_int|NULL
)paren
suffix:semicolon
id|via_interrupt_disable
(paren
id|card
)paren
suffix:semicolon
id|free_irq
(paren
id|card-&gt;pdev-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&n; * OSS DSP device&n; *&n; */
DECL|variable|via_dsp_fops
r_static
r_struct
id|file_operations
id|via_dsp_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|open
suffix:colon
id|via_dsp_open
comma
id|release
suffix:colon
id|via_dsp_release
comma
id|read
suffix:colon
id|via_dsp_read
comma
id|write
suffix:colon
id|via_dsp_write
comma
id|poll
suffix:colon
id|via_dsp_poll
comma
id|llseek
suffix:colon
id|via_llseek
comma
id|ioctl
suffix:colon
id|via_dsp_ioctl
comma
macro_line|#ifdef VIA_SUPPORT_MMAP
id|mmap
suffix:colon
id|via_dsp_mmap
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|function|via_dsp_init
r_static
r_int
id|__init
id|via_dsp_init
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
id|u8
id|tmp8
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* turn off legacy features, if not already */
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
id|VIA_FUNC_ENABLE
comma
op_amp
id|tmp8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp8
op_amp
(paren
id|VIA_CR42_SB_ENABLE
op_or
id|VIA_CR42_MIDI_ENABLE
op_or
id|VIA_CR42_FM_ENABLE
)paren
)paren
(brace
id|tmp8
op_and_assign
op_complement
(paren
id|VIA_CR42_SB_ENABLE
op_or
id|VIA_CR42_MIDI_ENABLE
op_or
id|VIA_CR42_FM_ENABLE
)paren
suffix:semicolon
id|pci_write_config_byte
(paren
id|card-&gt;pdev
comma
id|VIA_FUNC_ENABLE
comma
id|tmp8
)paren
suffix:semicolon
)brace
id|via_stop_everything
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;dev_dsp
op_assign
id|register_sound_dsp
(paren
op_amp
id|via_dsp_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;dev_dsp
OL
l_int|0
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -ENODEV&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_dsp_cleanup
r_static
r_void
id|via_dsp_cleanup
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|card-&gt;dev_dsp
op_ge
l_int|0
)paren
suffix:semicolon
id|via_stop_everything
(paren
id|card
)paren
suffix:semicolon
id|unregister_sound_dsp
(paren
id|card-&gt;dev_dsp
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef VIA_SUPPORT_MMAP
DECL|function|via_mm_nopage
r_static
r_struct
id|page
op_star
id|via_mm_nopage
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|address
comma
r_int
id|write_access
)paren
(brace
r_struct
id|via_info
op_star
id|card
op_assign
id|vma-&gt;vm_private_data
suffix:semicolon
r_struct
id|via_channel
op_star
id|chan
op_assign
op_amp
id|card-&gt;ch_out
suffix:semicolon
r_struct
id|page
op_star
id|dmapage
suffix:semicolon
r_int
r_int
id|pgoff
suffix:semicolon
r_int
id|rd
comma
id|wr
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER, start %lXh, ofs %lXh, pgoff %ld, addr %lXh, wr %d&bslash;n&quot;
comma
id|vma-&gt;vm_start
comma
id|address
op_minus
id|vma-&gt;vm_start
comma
(paren
id|address
op_minus
id|vma-&gt;vm_start
)paren
op_rshift
id|PAGE_SHIFT
comma
id|address
comma
id|write_access
)paren
suffix:semicolon
m_assert
(paren
id|VIA_DMA_BUF_SIZE
op_eq
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|address
OG
id|vma-&gt;vm_end
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning NOPAGE_SIGBUS&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|NOPAGE_SIGBUS
suffix:semicolon
multiline_comment|/* Disallow mremap */
)brace
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning NOPAGE_OOM&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|NOPAGE_OOM
suffix:semicolon
multiline_comment|/* Nothing allocated */
)brace
id|pgoff
op_assign
id|vma-&gt;vm_pgoff
op_plus
(paren
(paren
id|address
op_minus
id|vma-&gt;vm_start
)paren
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|rd
op_assign
id|card-&gt;ch_in.is_mapped
suffix:semicolon
id|wr
op_assign
id|card-&gt;ch_out.is_mapped
suffix:semicolon
macro_line|#ifndef VIA_NDEBUG
(brace
r_int
r_int
id|max_bufs
op_assign
id|VIA_DMA_BUFFERS
suffix:semicolon
r_if
c_cond
(paren
id|rd
op_logical_and
id|wr
)paren
id|max_bufs
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/* via_dsp_mmap() should ensure this */
m_assert
(paren
id|pgoff
OL
id|max_bufs
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* if full-duplex (read+write) and we have two sets of bufs,&n;&t; * then the playback buffers come first, sez soundcard.c */
r_if
c_cond
(paren
id|pgoff
op_ge
id|VIA_DMA_BUFFERS
)paren
(brace
id|pgoff
op_sub_assign
id|VIA_DMA_BUFFERS
suffix:semicolon
id|chan
op_assign
op_amp
id|card-&gt;ch_in
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|wr
)paren
id|chan
op_assign
op_amp
id|card-&gt;ch_in
suffix:semicolon
m_assert
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|chan-&gt;sgbuf
(braket
id|pgoff
)braket
dot
id|cpuaddr
)paren
op_mod
id|PAGE_SIZE
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|dmapage
op_assign
id|virt_to_page
(paren
id|chan-&gt;sgbuf
(braket
id|pgoff
)braket
dot
id|cpuaddr
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning page %p for cpuaddr %lXh&bslash;n&quot;
comma
id|dmapage
comma
(paren
r_int
r_int
)paren
id|chan-&gt;sgbuf
(braket
id|pgoff
)braket
dot
id|cpuaddr
)paren
suffix:semicolon
id|get_page
(paren
id|dmapage
)paren
suffix:semicolon
r_return
id|dmapage
suffix:semicolon
)brace
macro_line|#ifndef VM_RESERVED
DECL|function|via_mm_swapout
r_static
r_int
id|via_mm_swapout
(paren
r_struct
id|page
op_star
id|page
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* VM_RESERVED */
DECL|variable|via_mm_ops
r_struct
id|vm_operations_struct
id|via_mm_ops
op_assign
(brace
id|nopage
suffix:colon
id|via_mm_nopage
comma
macro_line|#ifndef VM_RESERVED
id|swapout
suffix:colon
id|via_mm_swapout
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|function|via_dsp_mmap
r_static
r_int
id|via_dsp_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|EINVAL
comma
id|rd
op_assign
l_int|0
comma
id|wr
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|max_size
comma
id|size
comma
id|start
comma
id|offset
suffix:semicolon
m_assert
(paren
id|file
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|vma
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|file-&gt;private_data
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER, start %lXh, size %ld, pgoff %ld&bslash;n&quot;
comma
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_pgoff
)paren
suffix:semicolon
m_assert
(paren
id|VIA_DMA_BUF_SIZE
op_eq
id|PAGE_SIZE
)paren
suffix:semicolon
id|max_size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|rd
op_assign
l_int|1
suffix:semicolon
id|max_size
op_add_assign
(paren
id|VIA_DMA_BUFFERS
op_star
id|VIA_DMA_BUF_SIZE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|wr
op_assign
l_int|1
suffix:semicolon
id|max_size
op_add_assign
(paren
id|VIA_DMA_BUFFERS
op_star
id|VIA_DMA_BUF_SIZE
)paren
suffix:semicolon
)brace
id|start
op_assign
id|vma-&gt;vm_start
suffix:semicolon
id|offset
op_assign
(paren
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
multiline_comment|/* some basic size/offset sanity checks */
r_if
c_cond
(paren
id|size
OG
id|max_size
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|offset
OG
id|max_size
op_minus
id|size
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
id|via_syscall_down
(paren
id|card
comma
id|nonblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
id|vma-&gt;vm_ops
op_assign
op_amp
id|via_mm_ops
suffix:semicolon
id|vma-&gt;vm_private_data
op_assign
id|card
suffix:semicolon
macro_line|#ifdef VM_RESERVED
id|vma-&gt;vm_flags
op_or_assign
id|VM_RESERVED
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|rd
)paren
id|card-&gt;ch_in.is_mapped
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
id|card-&gt;ch_out.is_mapped
op_assign
l_int|1
suffix:semicolon
id|up
(paren
op_amp
id|card-&gt;syscall_sem
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif /* VIA_SUPPORT_MMAP */
DECL|function|via_dsp_do_read
r_static
id|ssize_t
id|via_dsp_do_read
(paren
r_struct
id|via_info
op_star
id|card
comma
r_char
op_star
id|userbuf
comma
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_const
r_char
op_star
id|orig_userbuf
op_assign
id|userbuf
suffix:semicolon
r_struct
id|via_channel
op_star
id|chan
op_assign
op_amp
id|card-&gt;ch_in
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|n
comma
id|tmp
suffix:semicolon
multiline_comment|/* if SGD has not yet been started, start it */
id|via_chan_maybe_start
(paren
id|chan
)paren
suffix:semicolon
id|handle_one_block
suffix:colon
multiline_comment|/* just to be a nice neighbor */
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
id|schedule
(paren
)paren
suffix:semicolon
multiline_comment|/* grab current channel software pointer.  In the case of&n;&t; * recording, this is pointing to the next buffer that&n;&t; * will receive data from the audio hardware.&n;&t; */
id|n
op_assign
id|chan-&gt;sw_ptr
suffix:semicolon
multiline_comment|/* n_bufs represents the number of buffers waiting&n;&t; * to be copied to userland.  sleep until at least&n;&t; * one buffer has been read from the audio hardware.&n;&t; */
id|tmp
op_assign
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
m_assert
(paren
id|tmp
op_ge
l_int|0
)paren
suffix:semicolon
m_assert
(paren
id|tmp
op_le
id|VIA_DMA_BUFFERS
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|nonblock
op_logical_or
op_logical_neg
id|chan-&gt;is_active
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Sleeping on block %d&bslash;n&quot;
comma
id|n
)paren
suffix:semicolon
id|interruptible_sleep_on
(paren
op_amp
id|chan-&gt;wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|tmp
op_assign
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
)brace
multiline_comment|/* Now that we have a buffer we can read from, send&n;&t; * as much as sample data possible to userspace.&n;&t; */
r_while
c_loop
(paren
(paren
id|count
OG
l_int|0
)paren
op_logical_and
(paren
id|chan-&gt;slop_len
OL
id|VIA_DMA_BUF_SIZE
)paren
)paren
(brace
r_int
id|slop_left
op_assign
id|VIA_DMA_BUF_SIZE
op_minus
id|chan-&gt;slop_len
suffix:semicolon
id|size
op_assign
(paren
id|count
OL
id|slop_left
)paren
ques
c_cond
id|count
suffix:colon
id|slop_left
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|userbuf
comma
id|chan-&gt;sgbuf
(braket
id|n
)braket
dot
id|cpuaddr
op_plus
id|chan-&gt;slop_len
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|count
op_sub_assign
id|size
suffix:semicolon
id|chan-&gt;slop_len
op_add_assign
id|size
suffix:semicolon
id|userbuf
op_add_assign
id|size
suffix:semicolon
)brace
multiline_comment|/* If we didn&squot;t copy the buffer completely to userspace,&n;&t; * stop now.&n;&t; */
r_if
c_cond
(paren
id|chan-&gt;slop_len
OL
id|VIA_DMA_BUF_SIZE
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * If we get to this point, we copied one buffer completely&n;&t; * to userspace, give the buffer back to the hardware.&n;&t; */
multiline_comment|/* advance channel software pointer to point to&n;&t; * the next buffer from which we will copy&n;&t; */
r_if
c_cond
(paren
id|chan-&gt;sw_ptr
op_eq
(paren
id|VIA_DMA_BUFFERS
op_minus
l_int|1
)paren
)paren
id|chan-&gt;sw_ptr
op_assign
l_int|0
suffix:semicolon
r_else
id|chan-&gt;sw_ptr
op_increment
suffix:semicolon
multiline_comment|/* mark one less buffer waiting to be processed */
m_assert
(paren
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
OG
l_int|0
)paren
suffix:semicolon
id|atomic_dec
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
multiline_comment|/* we are at a block boundary, there is no fragment data */
id|chan-&gt;slop_len
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Flushed block %u, sw_ptr now %u, n_bufs now %d&bslash;n&quot;
comma
id|n
comma
id|chan-&gt;sw_ptr
comma
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;regs==%02X %02X %02X %08X %08X %08X %08X&bslash;n&quot;
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x00
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x01
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x02
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x04
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x0C
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x80
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x84
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|0
)paren
r_goto
id|handle_one_block
suffix:semicolon
id|out
suffix:colon
r_return
id|userbuf
op_minus
id|orig_userbuf
suffix:semicolon
)brace
DECL|function|via_dsp_read
r_static
id|ssize_t
id|via_dsp_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER, file=%p, buffer=%p, count=%u, ppos=%lu&bslash;n&quot;
comma
id|file
comma
id|buffer
comma
id|count
comma
id|ppos
ques
c_cond
(paren
(paren
r_int
r_int
)paren
op_star
id|ppos
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
m_assert
(paren
id|file
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|buffer
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|file-&gt;private_data
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -ESPIPE&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
id|rc
op_assign
id|via_syscall_down
(paren
id|card
comma
id|nonblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ch_in.is_mapped
)paren
(brace
id|rc
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out_up
suffix:semicolon
)brace
id|rc
op_assign
id|via_dsp_do_read
(paren
id|card
comma
id|buffer
comma
id|count
comma
id|nonblock
)paren
suffix:semicolon
id|out_up
suffix:colon
id|up
(paren
op_amp
id|card-&gt;syscall_sem
)paren
suffix:semicolon
id|out
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning %ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|via_dsp_do_write
r_static
id|ssize_t
id|via_dsp_do_write
(paren
r_struct
id|via_info
op_star
id|card
comma
r_const
r_char
op_star
id|userbuf
comma
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_const
r_char
op_star
id|orig_userbuf
op_assign
id|userbuf
suffix:semicolon
r_struct
id|via_channel
op_star
id|chan
op_assign
op_amp
id|card-&gt;ch_out
suffix:semicolon
r_volatile
r_struct
id|via_sgd_table
op_star
id|sgtable
op_assign
id|chan-&gt;sgtable
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|n
comma
id|tmp
suffix:semicolon
id|handle_one_block
suffix:colon
multiline_comment|/* just to be a nice neighbor */
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
id|schedule
(paren
)paren
suffix:semicolon
multiline_comment|/* grab current channel software pointer.  In the case of&n;&t; * playback, this is pointing to the next buffer that&n;&t; * should receive data from userland.&n;&t; */
id|n
op_assign
id|chan-&gt;sw_ptr
suffix:semicolon
multiline_comment|/* n_bufs represents the number of buffers remaining&n;&t; * to be filled by userspace.  Sleep until&n;&t; * at least one buffer is available for our use.&n;&t; */
id|tmp
op_assign
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
m_assert
(paren
id|tmp
op_ge
l_int|0
)paren
suffix:semicolon
m_assert
(paren
id|tmp
op_le
id|VIA_DMA_BUFFERS
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|nonblock
op_logical_or
op_logical_neg
id|chan-&gt;is_enabled
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Sleeping on block %d, tmp==%d, ir==%d&bslash;n&quot;
comma
id|n
comma
id|tmp
comma
id|chan-&gt;is_record
)paren
suffix:semicolon
id|interruptible_sleep_on
(paren
op_amp
id|chan-&gt;wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|tmp
op_assign
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
)brace
multiline_comment|/* Now that we have a buffer we can write to, fill it up&n;&t; * as much as possible with data from userspace.&n;&t; */
r_while
c_loop
(paren
(paren
id|count
OG
l_int|0
)paren
op_logical_and
(paren
id|chan-&gt;slop_len
OL
id|VIA_DMA_BUF_SIZE
)paren
)paren
(brace
r_int
id|slop_left
op_assign
id|VIA_DMA_BUF_SIZE
op_minus
id|chan-&gt;slop_len
suffix:semicolon
id|size
op_assign
(paren
id|count
OL
id|slop_left
)paren
ques
c_cond
id|count
suffix:colon
id|slop_left
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
id|chan-&gt;sgbuf
(braket
id|n
)braket
dot
id|cpuaddr
op_plus
id|chan-&gt;slop_len
comma
id|userbuf
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|count
op_sub_assign
id|size
suffix:semicolon
id|chan-&gt;slop_len
op_add_assign
id|size
suffix:semicolon
id|userbuf
op_add_assign
id|size
suffix:semicolon
)brace
multiline_comment|/* If we didn&squot;t fill up the buffer with data, stop now.&n;&t; * Put a &squot;stop&squot; marker in the DMA table too, to tell the&n;&t; * audio hardware to stop if it gets here.&n;&t; */
r_if
c_cond
(paren
id|chan-&gt;slop_len
OL
id|VIA_DMA_BUF_SIZE
)paren
(brace
id|sgtable
(braket
id|n
)braket
dot
id|count
op_assign
id|cpu_to_le32
(paren
id|chan-&gt;slop_len
op_or
id|VIA_EOL
op_or
id|VIA_STOP
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If we get to this point, we have filled a buffer with&n;&t; * audio data, flush the buffer to audio hardware.&n;&t; */
multiline_comment|/* Record the true size for the audio hardware to notice */
r_if
c_cond
(paren
id|n
op_eq
(paren
id|VIA_DMA_BUFFERS
op_minus
l_int|1
)paren
)paren
id|sgtable
(braket
id|n
)braket
dot
id|count
op_assign
id|cpu_to_le32
(paren
id|VIA_DMA_BUF_SIZE
op_or
id|VIA_EOL
)paren
suffix:semicolon
r_else
id|sgtable
(braket
id|n
)braket
dot
id|count
op_assign
id|cpu_to_le32
(paren
id|VIA_DMA_BUF_SIZE
op_or
id|VIA_FLAG
)paren
suffix:semicolon
multiline_comment|/* advance channel software pointer to point to&n;&t; * the next buffer we will fill with data&n;&t; */
r_if
c_cond
(paren
id|chan-&gt;sw_ptr
op_eq
(paren
id|VIA_DMA_BUFFERS
op_minus
l_int|1
)paren
)paren
id|chan-&gt;sw_ptr
op_assign
l_int|0
suffix:semicolon
r_else
id|chan-&gt;sw_ptr
op_increment
suffix:semicolon
multiline_comment|/* mark one less buffer as being available for userspace consumption */
m_assert
(paren
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
OG
l_int|0
)paren
suffix:semicolon
id|atomic_dec
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
multiline_comment|/* we are at a block boundary, there is no fragment data */
id|chan-&gt;slop_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if SGD has not yet been started, start it */
id|via_chan_maybe_start
(paren
id|chan
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Flushed block %u, sw_ptr now %u, n_bufs now %d&bslash;n&quot;
comma
id|n
comma
id|chan-&gt;sw_ptr
comma
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;regs==%02X %02X %02X %08X %08X %08X %08X&bslash;n&quot;
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x00
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x01
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x02
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x04
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x0C
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x80
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x84
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|0
)paren
r_goto
id|handle_one_block
suffix:semicolon
id|out
suffix:colon
r_return
id|userbuf
op_minus
id|orig_userbuf
suffix:semicolon
)brace
DECL|function|via_dsp_write
r_static
id|ssize_t
id|via_dsp_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|via_info
op_star
id|card
suffix:semicolon
id|ssize_t
id|rc
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER, file=%p, buffer=%p, count=%u, ppos=%lu&bslash;n&quot;
comma
id|file
comma
id|buffer
comma
id|count
comma
id|ppos
ques
c_cond
(paren
(paren
r_int
r_int
)paren
op_star
id|ppos
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
m_assert
(paren
id|file
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|buffer
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|file-&gt;private_data
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -ESPIPE&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
id|rc
op_assign
id|via_syscall_down
(paren
id|card
comma
id|nonblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ch_out.is_mapped
)paren
(brace
id|rc
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out_up
suffix:semicolon
)brace
id|rc
op_assign
id|via_dsp_do_write
(paren
id|card
comma
id|buffer
comma
id|count
comma
id|nonblock
)paren
suffix:semicolon
id|out_up
suffix:colon
id|up
(paren
op_amp
id|card-&gt;syscall_sem
)paren
suffix:semicolon
id|out
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning %ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|via_dsp_poll
r_static
r_int
r_int
id|via_dsp_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
comma
id|rd
comma
id|wr
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|file
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|file-&gt;private_data
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
id|rd
op_assign
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
suffix:semicolon
id|wr
op_assign
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wr
op_logical_and
(paren
id|atomic_read
(paren
op_amp
id|card-&gt;ch_out.n_bufs
)paren
op_eq
l_int|0
)paren
)paren
(brace
m_assert
(paren
id|card-&gt;ch_out.is_active
)paren
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|card-&gt;ch_out.wait
comma
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rd
)paren
(brace
multiline_comment|/* XXX is it ok, spec-wise, to start DMA here? */
id|via_chan_maybe_start
(paren
op_amp
id|card-&gt;ch_in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
(paren
op_amp
id|card-&gt;ch_in.n_bufs
)paren
op_eq
l_int|0
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|card-&gt;ch_in.wait
comma
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wr
op_logical_and
(paren
id|atomic_read
(paren
op_amp
id|card-&gt;ch_out.n_bufs
)paren
OG
l_int|0
)paren
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
r_if
c_cond
(paren
id|rd
op_logical_and
(paren
id|atomic_read
(paren
op_amp
id|card-&gt;ch_in.n_bufs
)paren
OG
l_int|0
)paren
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning %u&bslash;n&quot;
comma
id|mask
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_dsp_drain_playback - sleep until all playback samples are flushed&n; *&t;@card: Private info for specified board&n; *&t;@chan: Channel to drain&n; *&t;@nonblock: boolean, non-zero if O_NONBLOCK is set&n; *&n; *&t;Sleeps until all playback has been flushed to the audio&n; *&t;hardware.&n; *&n; *&t;Locking: inside card-&gt;syscall_sem&n; */
DECL|function|via_dsp_drain_playback
r_static
r_int
id|via_dsp_drain_playback
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
comma
r_int
id|nonblock
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER, nonblock = %d&bslash;n&quot;
comma
id|nonblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;slop_len
OG
l_int|0
)paren
id|via_chan_flush_frag
(paren
id|chan
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
op_eq
id|VIA_DMA_BUFFERS
)paren
r_goto
id|out
suffix:semicolon
id|via_chan_maybe_start
(paren
id|chan
)paren
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
OL
id|VIA_DMA_BUFFERS
)paren
(brace
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -EAGAIN&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
macro_line|#ifdef VIA_DEBUG
(brace
id|u8
id|r40
comma
id|r41
comma
id|r42
comma
id|r43
comma
id|r44
comma
id|r48
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x40
comma
op_amp
id|r40
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x41
comma
op_amp
id|r41
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x42
comma
op_amp
id|r42
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x43
comma
op_amp
id|r43
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x44
comma
op_amp
id|r44
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x48
comma
op_amp
id|r48
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;PCI config: %02X %02X %02X %02X %02X %02X&bslash;n&quot;
comma
id|r40
comma
id|r41
comma
id|r42
comma
id|r43
comma
id|r44
comma
id|r48
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;regs==%02X %02X %02X %08X %08X %08X %08X&bslash;n&quot;
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x00
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x01
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x02
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x04
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x0C
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x80
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x84
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;is_active
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;sleeping but not active&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|DPRINTK
(paren
l_string|&quot;sleeping, nbufs=%d&bslash;n&quot;
comma
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
)paren
suffix:semicolon
id|interruptible_sleep_on
(paren
op_amp
id|chan-&gt;wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -ERESTARTSYS&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
macro_line|#ifdef VIA_DEBUG
(brace
id|u8
id|r40
comma
id|r41
comma
id|r42
comma
id|r43
comma
id|r44
comma
id|r48
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x40
comma
op_amp
id|r40
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x41
comma
op_amp
id|r41
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x42
comma
op_amp
id|r42
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x43
comma
op_amp
id|r43
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x44
comma
op_amp
id|r44
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x48
comma
op_amp
id|r48
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;PCI config: %02X %02X %02X %02X %02X %02X&bslash;n&quot;
comma
id|r40
comma
id|r41
comma
id|r42
comma
id|r43
comma
id|r44
comma
id|r48
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;regs==%02X %02X %02X %08X %08X %08X %08X&bslash;n&quot;
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x00
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x01
)paren
comma
id|inb
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x02
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x04
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x0C
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x80
)paren
comma
id|inl
(paren
id|card-&gt;baseaddr
op_plus
l_int|0x84
)paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;final nbufs=%d&bslash;n&quot;
comma
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|out
suffix:colon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_dsp_ioctl_space - get information about channel buffering&n; *&t;@card: Private info for specified board&n; *&t;@chan: pointer to channel-specific info&n; *&t;@arg: user buffer for returned information&n; *&n; *&t;Handles SNDCTL_DSP_GETISPACE and SNDCTL_DSP_GETOSPACE.&n; *&n; *&t;Locking: inside card-&gt;syscall_sem&n; */
DECL|function|via_dsp_ioctl_space
r_static
r_int
id|via_dsp_ioctl_space
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
comma
r_void
op_star
id|arg
)paren
(brace
id|audio_buf_info
id|info
suffix:semicolon
id|info.fragstotal
op_assign
id|VIA_DMA_BUFFERS
suffix:semicolon
id|info.fragsize
op_assign
id|VIA_DMA_BUF_SIZE
suffix:semicolon
multiline_comment|/* number of full fragments we can read/write without blocking */
id|info.fragments
op_assign
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chan-&gt;slop_len
OG
l_int|0
)paren
op_logical_and
(paren
id|info.fragments
OG
l_int|0
)paren
)paren
id|info.fragments
op_decrement
suffix:semicolon
multiline_comment|/* number of bytes that can be read or written immediately&n;&t; * without blocking.&n;&t; */
id|info.bytes
op_assign
(paren
id|info.fragments
op_star
id|VIA_DMA_BUF_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;slop_len
OG
l_int|0
)paren
id|info.bytes
op_add_assign
id|VIA_DMA_BUF_SIZE
op_minus
id|chan-&gt;slop_len
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning fragstotal=%d, fragsize=%d, fragments=%d, bytes=%d&bslash;n&quot;
comma
id|info.fragstotal
comma
id|info.fragsize
comma
id|info.fragments
comma
id|info.bytes
)paren
suffix:semicolon
r_return
id|copy_to_user
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;via_dsp_ioctl_ptr - get information about hardware buffer ptr&n; *&t;@card: Private info for specified board&n; *&t;@chan: pointer to channel-specific info&n; *&t;@arg: user buffer for returned information&n; *&n; *&t;Handles SNDCTL_DSP_GETIPTR and SNDCTL_DSP_GETOPTR.&n; *&n; *&t;Locking: inside card-&gt;syscall_sem&n; */
DECL|function|via_dsp_ioctl_ptr
r_static
r_int
id|via_dsp_ioctl_ptr
(paren
r_struct
id|via_info
op_star
id|card
comma
r_struct
id|via_channel
op_star
id|chan
comma
r_void
op_star
id|arg
)paren
(brace
id|count_info
id|info
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|info.bytes
op_assign
id|chan-&gt;bytes
suffix:semicolon
id|info.blocks
op_assign
id|chan-&gt;n_irqs
suffix:semicolon
id|chan-&gt;n_irqs
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;is_active
)paren
(brace
r_int
r_int
id|extra
suffix:semicolon
id|info.ptr
op_assign
id|atomic_read
(paren
op_amp
id|chan-&gt;hw_ptr
)paren
op_star
id|VIA_DMA_BUF_SIZE
suffix:semicolon
id|extra
op_assign
id|VIA_DMA_BUF_SIZE
op_minus
id|inl
(paren
id|chan-&gt;iobase
op_plus
id|VIA_BASE0_PCM_OUT_BLOCK_COUNT
)paren
suffix:semicolon
id|info.ptr
op_add_assign
id|extra
suffix:semicolon
id|info.bytes
op_add_assign
id|extra
suffix:semicolon
)brace
r_else
(brace
id|info.ptr
op_assign
l_int|0
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning bytes=%d, blocks=%d, ptr=%d&bslash;n&quot;
comma
id|info.bytes
comma
id|info.blocks
comma
id|info.ptr
)paren
suffix:semicolon
r_return
id|copy_to_user
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
)brace
DECL|function|via_dsp_ioctl_trigger
r_static
r_int
id|via_dsp_ioctl_trigger
(paren
r_struct
id|via_channel
op_star
id|chan
comma
r_int
id|val
)paren
(brace
r_int
id|enable
comma
id|do_something
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;is_record
)paren
id|enable
op_assign
(paren
id|val
op_amp
id|PCM_ENABLE_INPUT
)paren
suffix:semicolon
r_else
id|enable
op_assign
(paren
id|val
op_amp
id|PCM_ENABLE_OUTPUT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan-&gt;is_enabled
op_logical_and
id|enable
)paren
(brace
id|do_something
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chan-&gt;is_enabled
op_logical_and
op_logical_neg
id|enable
)paren
(brace
id|do_something
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|do_something
op_assign
l_int|0
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;enable=%d, do_something=%d&bslash;n&quot;
comma
id|enable
comma
id|do_something
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;is_active
op_logical_and
id|do_something
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|do_something
op_eq
l_int|1
)paren
(brace
id|chan-&gt;is_enabled
op_assign
l_int|1
suffix:semicolon
id|via_chan_maybe_start
(paren
id|chan
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Triggering input&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|do_something
op_eq
op_minus
l_int|1
)paren
(brace
id|chan-&gt;is_enabled
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Setup input trigger&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_dsp_ioctl
r_static
r_int
id|via_dsp_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|rc
comma
id|rd
op_assign
l_int|0
comma
id|wr
op_assign
l_int|0
comma
id|val
op_assign
l_int|0
suffix:semicolon
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_struct
id|via_channel
op_star
id|chan
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
m_assert
(paren
id|file
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|file-&gt;private_data
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|wr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|rd
op_assign
l_int|1
suffix:semicolon
id|rc
op_assign
id|via_syscall_down
(paren
id|card
comma
id|nonblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* OSS API version.  XXX unverified */
r_case
id|OSS_GETVERSION
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;ioctl OSS_GETVERSION, EXIT, returning SOUND_VERSION&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|put_user
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* list of supported PCM data formats */
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_GETFMTS, EXIT, returning AFMT U8|S16_LE&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|put_user
(paren
id|AFMT_U8
op_or
id|AFMT_S16_LE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* query or set current channel&squot;s PCM data format */
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_SETFMT, val==%d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|rd
)paren
id|rc
op_assign
id|via_chan_set_fmt
(paren
id|card
comma
op_amp
id|card-&gt;ch_in
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|wr
)paren
id|rc
op_assign
id|via_chan_set_fmt
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|val
op_assign
id|rc
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rd
op_logical_and
(paren
id|card-&gt;ch_in.pcm_fmt
op_amp
id|VIA_PCM_FMT_16BIT
)paren
)paren
op_logical_or
(paren
id|wr
op_logical_and
(paren
id|card-&gt;ch_out.pcm_fmt
op_amp
id|VIA_PCM_FMT_16BIT
)paren
)paren
)paren
id|val
op_assign
id|AFMT_S16_LE
suffix:semicolon
r_else
id|val
op_assign
id|AFMT_U8
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;SETFMT EXIT, returning %d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|rc
op_assign
id|put_user
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* query or set number of channels (1=mono, 2=stereo) */
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_CHANNELS, val==%d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|rd
)paren
id|rc
op_assign
id|via_chan_set_stereo
(paren
id|card
comma
op_amp
id|card-&gt;ch_in
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|wr
)paren
id|rc
op_assign
id|via_chan_set_stereo
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|val
op_assign
id|rc
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|rd
op_logical_and
(paren
id|card-&gt;ch_in.pcm_fmt
op_amp
id|VIA_PCM_FMT_STEREO
)paren
)paren
op_logical_or
(paren
id|wr
op_logical_and
(paren
id|card-&gt;ch_out.pcm_fmt
op_amp
id|VIA_PCM_FMT_STEREO
)paren
)paren
)paren
id|val
op_assign
l_int|2
suffix:semicolon
r_else
id|val
op_assign
l_int|1
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;CHANNELS EXIT, returning %d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|rc
op_assign
id|put_user
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* enable (val is not zero) or disable (val == 0) stereo */
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_STEREO, val==%d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|rd
)paren
id|rc
op_assign
id|via_chan_set_stereo
(paren
id|card
comma
op_amp
id|card-&gt;ch_in
comma
id|val
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|wr
)paren
id|rc
op_assign
id|via_chan_set_stereo
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
comma
id|val
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;STEREO EXIT, returning %d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* query or set sampling rate */
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_SPEED, val==%d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
OG
l_int|0
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|rd
)paren
id|rc
op_assign
id|via_chan_set_speed
(paren
id|card
comma
op_amp
id|card-&gt;ch_in
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|wr
)paren
id|rc
op_assign
id|via_chan_set_speed
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|val
op_assign
id|rc
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|rd
)paren
id|val
op_assign
id|card-&gt;ch_in.rate
suffix:semicolon
r_else
r_if
c_cond
(paren
id|wr
)paren
id|val
op_assign
id|card-&gt;ch_out.rate
suffix:semicolon
r_else
id|val
op_assign
l_int|0
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;SPEED EXIT, returning %d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|rc
op_assign
id|put_user
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* wait until all buffers have been played, and then stop device */
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
id|DPRINTK
(paren
l_string|&quot;DSP_SYNC&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;SYNC EXIT (after calling via_dsp_drain_playback)&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|via_dsp_drain_playback
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
comma
id|nonblock
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* stop recording/playback immediately */
r_case
id|SNDCTL_DSP_RESET
suffix:colon
id|DPRINTK
(paren
l_string|&quot;DSP_RESET&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
(brace
id|via_chan_clear
(paren
op_amp
id|card-&gt;ch_in
)paren
suffix:semicolon
id|via_chan_pcm_fmt
(paren
op_amp
id|card-&gt;ch_in
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wr
)paren
(brace
id|via_chan_clear
(paren
op_amp
id|card-&gt;ch_out
)paren
suffix:semicolon
id|via_chan_pcm_fmt
(paren
op_amp
id|card-&gt;ch_out
comma
l_int|1
)paren
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* obtain bitmask of device capabilities, such as mmap, full duplex, etc. */
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_GETCAPS&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|put_user
c_func
(paren
id|VIA_DSP_CAP
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* obtain bitmask of device capabilities, such as mmap, full duplex, etc. */
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_GETBLKSIZE&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|put_user
c_func
(paren
id|VIA_DMA_BUF_SIZE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* obtain information about input buffering */
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_GETISPACE&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
id|rc
op_assign
id|via_dsp_ioctl_space
(paren
id|card
comma
op_amp
id|card-&gt;ch_in
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* obtain information about output buffering */
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_GETOSPACE&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
id|rc
op_assign
id|via_dsp_ioctl_space
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* obtain information about input hardware pointer */
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_GETIPTR&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
id|rc
op_assign
id|via_dsp_ioctl_ptr
(paren
id|card
comma
op_amp
id|card-&gt;ch_in
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* obtain information about output hardware pointer */
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_GETOPTR&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
id|rc
op_assign
id|via_dsp_ioctl_ptr
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* return number of bytes remaining to be played by DMA engine */
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_GETODELAY&bslash;n&quot;
)paren
suffix:semicolon
id|chan
op_assign
op_amp
id|card-&gt;ch_out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wr
)paren
r_break
suffix:semicolon
id|val
op_assign
id|VIA_DMA_BUFFERS
op_minus
id|atomic_read
(paren
op_amp
id|chan-&gt;n_bufs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
l_int|0
)paren
(brace
id|val
op_mul_assign
id|VIA_DMA_BUF_SIZE
suffix:semicolon
id|val
op_sub_assign
id|VIA_DMA_BUF_SIZE
op_minus
id|inl
(paren
id|chan-&gt;iobase
op_plus
id|VIA_BASE0_PCM_OUT_BLOCK_COUNT
)paren
suffix:semicolon
)brace
id|val
op_add_assign
id|chan-&gt;slop_len
suffix:semicolon
m_assert
(paren
id|val
op_le
(paren
id|VIA_DMA_BUF_SIZE
op_star
id|VIA_DMA_BUFFERS
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;GETODELAY EXIT, val = %d bytes&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|rc
op_assign
id|put_user
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* handle the quick-start of a channel,&n;&t; * or the notification that a quick-start will&n;&t; * occur in the future&n;&t; */
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_SETTRIGGER, rd=%d, wr=%d, act=%d/%d, en=%d/%d&bslash;n&quot;
comma
id|rd
comma
id|wr
comma
id|card-&gt;ch_in.is_active
comma
id|card-&gt;ch_out.is_active
comma
id|card-&gt;ch_in.is_enabled
comma
id|card-&gt;ch_out.is_enabled
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
id|rc
op_assign
id|via_dsp_ioctl_trigger
(paren
op_amp
id|card-&gt;ch_in
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
op_logical_and
id|wr
)paren
id|rc
op_assign
id|via_dsp_ioctl_trigger
(paren
op_amp
id|card-&gt;ch_out
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Enable full duplex.  Since we do this as soon as we are opened&n;&t; * with O_RDWR, this is mainly a no-op that always returns success.&n;&t; */
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_SETDUPLEX&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rd
op_logical_or
op_logical_neg
id|wr
)paren
r_break
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* set fragment size.  implemented as a successful no-op for now */
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_SETFRAGMENT, val==%d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;SNDCTL_DSP_SETFRAGMENT (fragshift==0x%04X (%d), maxfrags==0x%04X (%d))&bslash;n&quot;
comma
id|val
op_amp
l_int|0xFFFF
comma
id|val
op_amp
l_int|0xFFFF
comma
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xFFFF
comma
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
multiline_comment|/* just to shut up some programs */
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* inform device of an upcoming pause in input (or output). */
r_case
id|SNDCTL_DSP_POST
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;DSP_POST&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;ch_out.slop_len
OG
l_int|0
)paren
id|via_chan_flush_frag
(paren
op_amp
id|card-&gt;ch_out
)paren
suffix:semicolon
id|via_chan_maybe_start
(paren
op_amp
id|card-&gt;ch_out
)paren
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* not implemented */
r_default
suffix:colon
id|DPRINTK
(paren
l_string|&quot;unhandled ioctl, cmd==%u, arg==%p&bslash;n&quot;
comma
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
(paren
op_amp
id|card-&gt;syscall_sem
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|via_dsp_open
r_static
r_int
id|via_dsp_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|rc
comma
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_int
id|got_read_chan
op_assign
l_int|0
suffix:semicolon
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
r_struct
id|via_channel
op_star
id|chan
suffix:semicolon
r_struct
id|pci_driver
op_star
id|drvr
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER, minor=%d, file-&gt;f_mode=0x%x&bslash;n&quot;
comma
id|minor
comma
id|file-&gt;f_mode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
)paren
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -EINVAL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|card
op_assign
l_int|NULL
suffix:semicolon
id|pci_for_each_dev
c_func
(paren
id|pdev
)paren
(brace
id|drvr
op_assign
id|pci_dev_driver
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvr
op_eq
op_amp
id|via_driver
)paren
(brace
m_assert
(paren
id|pci_get_drvdata
(paren
id|pdev
)paren
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|pci_get_drvdata
(paren
id|pdev
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;dev_dsp = %d, minor = %d, assn = %d&bslash;n&quot;
comma
id|card-&gt;dev_dsp
comma
id|minor
comma
(paren
id|card-&gt;dev_dsp
op_xor
id|minor
)paren
op_amp
op_complement
l_int|0xf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|card-&gt;dev_dsp
op_xor
id|minor
)paren
op_amp
op_complement
l_int|0xf
)paren
op_eq
l_int|0
)paren
r_goto
id|match
suffix:semicolon
)brace
)brace
id|DPRINTK
(paren
l_string|&quot;no matching %s found&bslash;n&quot;
comma
id|card
ques
c_cond
l_string|&quot;minor&quot;
suffix:colon
l_string|&quot;driver&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
id|match
suffix:colon
r_if
c_cond
(paren
id|nonblock
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
(paren
op_amp
id|card-&gt;open_sem
)paren
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -EAGAIN&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
(paren
op_amp
id|card-&gt;open_sem
)paren
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -ERESTARTSYS&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
id|file-&gt;private_data
op_assign
id|card
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;file-&gt;f_mode == 0x%x&bslash;n&quot;
comma
id|file-&gt;f_mode
)paren
suffix:semicolon
multiline_comment|/* handle input from analog source */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|chan
op_assign
op_amp
id|card-&gt;ch_in
suffix:semicolon
id|rc
op_assign
id|via_chan_init
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
id|got_read_chan
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* why is this forced to 16-bit stereo in all drivers? */
id|chan-&gt;pcm_fmt
op_assign
id|VIA_PCM_FMT_16BIT
op_or
id|VIA_PCM_FMT_STEREO
suffix:semicolon
id|via_chan_pcm_fmt
(paren
id|chan
comma
l_int|0
)paren
suffix:semicolon
id|via_set_rate
(paren
op_amp
id|card-&gt;ac97
comma
id|chan
comma
l_int|44100
)paren
suffix:semicolon
)brace
multiline_comment|/* handle output to analog source */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|chan
op_assign
op_amp
id|card-&gt;ch_out
suffix:semicolon
id|rc
op_assign
id|via_chan_init
(paren
id|card
comma
id|chan
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out_read_chan
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0xf
)paren
op_eq
id|SND_DEV_DSP16
)paren
(brace
id|chan-&gt;pcm_fmt
op_or_assign
id|VIA_PCM_FMT_16BIT
suffix:semicolon
id|via_set_rate
(paren
op_amp
id|card-&gt;ac97
comma
id|chan
comma
l_int|44100
)paren
suffix:semicolon
)brace
r_else
(brace
id|via_set_rate
(paren
op_amp
id|card-&gt;ac97
comma
id|chan
comma
l_int|8000
)paren
suffix:semicolon
)brace
id|via_chan_pcm_fmt
(paren
id|chan
comma
l_int|0
)paren
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_read_chan
suffix:colon
r_if
c_cond
(paren
id|got_read_chan
)paren
id|via_chan_free
(paren
id|card
comma
op_amp
id|card-&gt;ch_in
)paren
suffix:semicolon
id|err_out
suffix:colon
id|up
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ERROR EXIT, returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|via_dsp_release
r_static
r_int
id|via_dsp_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|via_info
op_star
id|card
suffix:semicolon
r_int
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|file
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|file-&gt;private_data
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
id|rc
op_assign
id|via_syscall_down
(paren
id|card
comma
id|nonblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT (syscall_down error), rc=%d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|rc
op_assign
id|via_dsp_drain_playback
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
comma
id|nonblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;via_audio: ignoring drain playback error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|via_chan_free
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|via_chan_free
(paren
id|card
comma
op_amp
id|card-&gt;ch_in
)paren
suffix:semicolon
id|up
(paren
op_amp
id|card-&gt;syscall_sem
)paren
suffix:semicolon
id|up
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&n; * Chip setup and kernel registration&n; *&n; *&n; */
DECL|function|via_init_one
r_static
r_int
id|__init
id|via_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|via_info
op_star
id|card
suffix:semicolon
id|u8
id|tmp
suffix:semicolon
r_static
r_int
id|printed_version
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|printed_version
op_increment
op_eq
l_int|0
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;Via 686a audio driver &quot;
id|VIA_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
(paren
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
(paren
id|pdev
comma
l_int|0
)paren
comma
id|VIA_MODULE_NAME
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to obtain I/O resources, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
(paren
id|pdev
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_out_none
suffix:semicolon
)brace
id|card
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|card
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;out of memory, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_none
suffix:semicolon
)brace
id|pci_set_drvdata
(paren
id|pdev
comma
id|card
)paren
suffix:semicolon
id|memset
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|card
)paren
)paren
suffix:semicolon
id|card-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|card-&gt;baseaddr
op_assign
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|card-&gt;card_num
op_assign
id|via_num_cards
op_increment
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|init_MUTEX
(paren
op_amp
id|card-&gt;syscall_sem
)paren
suffix:semicolon
id|init_MUTEX
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
multiline_comment|/* we must init these now, in case the intr handler needs them */
id|via_chan_init_defaults
(paren
id|card
comma
op_amp
id|card-&gt;ch_out
)paren
suffix:semicolon
id|via_chan_init_defaults
(paren
id|card
comma
op_amp
id|card-&gt;ch_in
)paren
suffix:semicolon
id|via_chan_init_defaults
(paren
id|card
comma
op_amp
id|card-&gt;ch_fm
)paren
suffix:semicolon
multiline_comment|/* if BAR 2 is present, chip is Rev H or later,&n;&t; * which means it has a few extra features */
r_if
c_cond
(paren
id|pci_resource_start
(paren
id|pdev
comma
l_int|2
)paren
OG
l_int|0
)paren
id|card-&gt;rev_h
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pdev-&gt;irq
OL
l_int|1
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;invalid PCI IRQ %d, aborting&bslash;n&quot;
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out_kfree
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
(paren
id|pdev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_IO
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to locate I/O resources, aborting&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out_kfree
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * init AC97 mixer and codec&n;&t; */
id|rc
op_assign
id|via_ac97_init
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;AC97 init failed, aborting&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_kfree
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * init DSP device&n;&t; */
id|rc
op_assign
id|via_dsp_init
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;DSP device init failed, aborting&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_have_mixer
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * per-card /proc info&n;&t; */
id|rc
op_assign
id|via_card_init_proc
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;card-specific /proc init failed, aborting&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_have_dsp
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * init and turn on interrupts, as the last thing we do&n;&t; */
id|rc
op_assign
id|via_interrupt_init
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;interrupt init failed, aborting&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_have_proc
suffix:semicolon
)brace
id|pci_read_config_byte
(paren
id|pdev
comma
l_int|0x3C
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x0F
)paren
op_ne
id|pdev-&gt;irq
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;IRQ fixup, 0x3C==0x%02X&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|udelay
(paren
l_int|15
)paren
suffix:semicolon
id|tmp
op_and_assign
l_int|0xF0
suffix:semicolon
id|tmp
op_or_assign
id|pdev-&gt;irq
suffix:semicolon
id|pci_write_config_byte
(paren
id|pdev
comma
l_int|0x3C
comma
id|tmp
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;new 0x3c==0x%02x&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
)brace
r_else
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;IRQ reg 0x3c==0x%02x, irq==%d&bslash;n&quot;
comma
id|tmp
comma
id|tmp
op_amp
l_int|0x0F
)paren
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;board #%d at 0x%04lX, IRQ %d&bslash;n&quot;
comma
id|card-&gt;card_num
op_plus
l_int|1
comma
id|card-&gt;baseaddr
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_have_proc
suffix:colon
id|via_card_cleanup_proc
(paren
id|card
)paren
suffix:semicolon
id|err_out_have_dsp
suffix:colon
id|via_dsp_cleanup
(paren
id|card
)paren
suffix:semicolon
id|err_out_have_mixer
suffix:colon
id|via_ac97_cleanup
(paren
id|card
)paren
suffix:semicolon
id|err_out_kfree
suffix:colon
macro_line|#ifndef VIA_NDEBUG
id|memset
(paren
id|card
comma
l_int|0xAB
comma
r_sizeof
(paren
op_star
id|card
)paren
)paren
suffix:semicolon
multiline_comment|/* poison memory */
macro_line|#endif
id|kfree
(paren
id|card
)paren
suffix:semicolon
id|err_out_none
suffix:colon
id|release_region
(paren
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|err_out
suffix:colon
id|pci_set_drvdata
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|via_remove_one
r_static
r_void
id|__exit
id|via_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|via_info
op_star
id|card
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|pdev
op_ne
l_int|NULL
)paren
suffix:semicolon
id|card
op_assign
id|pci_get_drvdata
(paren
id|pdev
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
id|via_interrupt_cleanup
(paren
id|card
)paren
suffix:semicolon
id|via_card_cleanup_proc
(paren
id|card
)paren
suffix:semicolon
id|via_dsp_cleanup
(paren
id|card
)paren
suffix:semicolon
id|via_ac97_cleanup
(paren
id|card
)paren
suffix:semicolon
id|release_region
(paren
id|pci_resource_start
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#ifndef VIA_NDEBUG
id|memset
(paren
id|card
comma
l_int|0xAB
comma
r_sizeof
(paren
op_star
id|card
)paren
)paren
suffix:semicolon
multiline_comment|/* poison memory */
macro_line|#endif
id|kfree
(paren
id|card
)paren
suffix:semicolon
id|pci_set_drvdata
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|pci_set_power_state
(paren
id|pdev
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* ...zzzzzz */
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/****************************************************************&n; *&n; * Driver initialization and cleanup&n; *&n; *&n; */
DECL|function|init_via82cxxx_audio
r_static
r_int
id|__init
id|init_via82cxxx_audio
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|via_init_proc
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|pci_register_driver
(paren
op_amp
id|via_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|pci_unregister_driver
(paren
op_amp
id|via_driver
)paren
suffix:semicolon
id|via_cleanup_proc
(paren
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -ENODEV&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_via82cxxx_audio
r_static
r_void
id|__exit
id|cleanup_via82cxxx_audio
c_func
(paren
r_void
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|pci_unregister_driver
(paren
op_amp
id|via_driver
)paren
suffix:semicolon
id|via_cleanup_proc
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|init_via82cxxx_audio
id|module_init
c_func
(paren
id|init_via82cxxx_audio
)paren
suffix:semicolon
DECL|variable|cleanup_via82cxxx_audio
id|module_exit
c_func
(paren
id|cleanup_via82cxxx_audio
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jeff Garzik &lt;jgarzik@mandrakesoft.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;DSP audio and mixer driver for Via 82Cxxx audio devices&quot;
)paren
suffix:semicolon
id|EXPORT_NO_SYMBOLS
suffix:semicolon
macro_line|#ifdef VIA_PROC_FS
multiline_comment|/****************************************************************&n; *&n; * /proc/driver/via/info&n; *&n; *&n; */
DECL|function|via_info_read_proc
r_static
r_int
id|via_info_read_proc
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
DECL|macro|YN
mdefine_line|#define YN(val,bit) (((val) &amp; (bit)) ? &quot;yes&quot; : &quot;no&quot;)
DECL|macro|ED
mdefine_line|#define ED(val,bit) (((val) &amp; (bit)) ? &quot;enable&quot; : &quot;disable&quot;)
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|u8
id|r40
comma
id|r41
comma
id|r42
comma
id|r44
suffix:semicolon
r_struct
id|via_info
op_star
id|card
op_assign
id|data
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|card
op_ne
l_int|NULL
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|VIA_CARD_NAME
l_string|&quot;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x40
comma
op_amp
id|r40
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x41
comma
op_amp
id|r41
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x42
comma
op_amp
id|r42
)paren
suffix:semicolon
id|pci_read_config_byte
(paren
id|card-&gt;pdev
comma
l_int|0x44
comma
op_amp
id|r44
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Via 82Cxxx PCI registers:&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;40  Codec Ready: %s&bslash;n&quot;
l_string|&quot;    Codec Low-power: %s&bslash;n&quot;
l_string|&quot;    Secondary Codec Ready: %s&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;41  Interface Enable: %s&bslash;n&quot;
l_string|&quot;    De-Assert Reset: %s&bslash;n&quot;
l_string|&quot;    Force SYNC high: %s&bslash;n&quot;
l_string|&quot;    Force SDO high: %s&bslash;n&quot;
l_string|&quot;    Variable Sample Rate On-Demand Mode: %s&bslash;n&quot;
l_string|&quot;    SGD Read Channel PCM Data Out: %s&bslash;n&quot;
l_string|&quot;    FM Channel PCM Data Out: %s&bslash;n&quot;
l_string|&quot;    SB PCM Data Out: %s&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;42  Game port enabled: %s&bslash;n&quot;
l_string|&quot;    SoundBlaster enabled: %s&bslash;n&quot;
l_string|&quot;    FM enabled: %s&bslash;n&quot;
l_string|&quot;    MIDI enabled: %s&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
l_string|&quot;44  AC-Link Interface Access: %s&bslash;n&quot;
l_string|&quot;    Secondary Codec Support: %s&bslash;n&quot;
l_string|&quot;&bslash;n&quot;
comma
id|YN
(paren
id|r40
comma
id|VIA_CR40_AC97_READY
)paren
comma
id|YN
(paren
id|r40
comma
id|VIA_CR40_AC97_LOW_POWER
)paren
comma
id|YN
(paren
id|r40
comma
id|VIA_CR40_SECONDARY_READY
)paren
comma
id|ED
(paren
id|r41
comma
id|VIA_CR41_AC97_ENABLE
)paren
comma
id|YN
(paren
id|r41
comma
(paren
l_int|1
op_lshift
l_int|6
)paren
)paren
comma
id|YN
(paren
id|r41
comma
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
comma
id|YN
(paren
id|r41
comma
(paren
l_int|1
op_lshift
l_int|4
)paren
)paren
comma
id|ED
(paren
id|r41
comma
(paren
l_int|1
op_lshift
l_int|3
)paren
)paren
comma
id|ED
(paren
id|r41
comma
(paren
l_int|1
op_lshift
l_int|2
)paren
)paren
comma
id|ED
(paren
id|r41
comma
(paren
l_int|1
op_lshift
l_int|1
)paren
)paren
comma
id|ED
(paren
id|r41
comma
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
comma
id|YN
(paren
id|r42
comma
id|VIA_CR42_GAME_ENABLE
)paren
comma
id|YN
(paren
id|r42
comma
id|VIA_CR42_SB_ENABLE
)paren
comma
id|YN
(paren
id|r42
comma
id|VIA_CR42_FM_ENABLE
)paren
comma
id|YN
(paren
id|r42
comma
id|VIA_CR42_MIDI_ENABLE
)paren
comma
id|YN
(paren
id|r44
comma
id|VIA_CR44_AC_LINK_ACCESS
)paren
comma
id|YN
(paren
id|r44
comma
id|VIA_CR44_SECOND_CODEC_SUPPORT
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
DECL|macro|YN
macro_line|#undef YN
DECL|macro|ED
macro_line|#undef ED
)brace
multiline_comment|/****************************************************************&n; *&n; * /proc/driver/via/... setup and cleanup&n; *&n; *&n; */
DECL|function|via_init_proc
r_static
r_int
id|__init
id|via_init_proc
(paren
r_void
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_mkdir
(paren
l_string|&quot;driver/via&quot;
comma
l_int|0
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|via_cleanup_proc
r_static
r_void
id|via_cleanup_proc
(paren
r_void
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;driver/via&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|via_card_init_proc
r_static
r_int
id|__init
id|via_card_init_proc
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
r_char
id|s
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|sprintf
(paren
id|s
comma
l_string|&quot;driver/via/%d&quot;
comma
id|card-&gt;card_num
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_mkdir
(paren
id|s
comma
l_int|0
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_out_none
suffix:semicolon
)brace
id|sprintf
(paren
id|s
comma
l_string|&quot;driver/via/%d/info&quot;
comma
id|card-&gt;card_num
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|create_proc_read_entry
(paren
id|s
comma
l_int|0
comma
l_int|0
comma
id|via_info_read_proc
comma
id|card
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_out_dir
suffix:semicolon
)brace
id|sprintf
(paren
id|s
comma
l_string|&quot;driver/via/%d/ac97&quot;
comma
id|card-&gt;card_num
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|create_proc_read_entry
(paren
id|s
comma
l_int|0
comma
l_int|0
comma
id|ac97_read_proc
comma
op_amp
id|card-&gt;ac97
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_out_info
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_info
suffix:colon
id|sprintf
(paren
id|s
comma
l_string|&quot;driver/via/%d/info&quot;
comma
id|card-&gt;card_num
)paren
suffix:semicolon
id|remove_proc_entry
(paren
id|s
comma
l_int|NULL
)paren
suffix:semicolon
id|err_out_dir
suffix:colon
id|sprintf
(paren
id|s
comma
l_string|&quot;driver/via/%d&quot;
comma
id|card-&gt;card_num
)paren
suffix:semicolon
id|remove_proc_entry
(paren
id|s
comma
l_int|NULL
)paren
suffix:semicolon
id|err_out_none
suffix:colon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|via_card_cleanup_proc
r_static
r_void
id|via_card_cleanup_proc
(paren
r_struct
id|via_info
op_star
id|card
)paren
(brace
r_char
id|s
(braket
l_int|32
)braket
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|sprintf
(paren
id|s
comma
l_string|&quot;driver/via/%d/ac97&quot;
comma
id|card-&gt;card_num
)paren
suffix:semicolon
id|remove_proc_entry
(paren
id|s
comma
l_int|NULL
)paren
suffix:semicolon
id|sprintf
(paren
id|s
comma
l_string|&quot;driver/via/%d/info&quot;
comma
id|card-&gt;card_num
)paren
suffix:semicolon
id|remove_proc_entry
(paren
id|s
comma
l_int|NULL
)paren
suffix:semicolon
id|sprintf
(paren
id|s
comma
l_string|&quot;driver/via/%d&quot;
comma
id|card-&gt;card_num
)paren
suffix:semicolon
id|remove_proc_entry
(paren
id|s
comma
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* VIA_PROC_FS */
eof
