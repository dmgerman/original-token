multiline_comment|/*&n; * sound/sequencer.c&n; *&n; * The sequencer personality manager.&n; *&n; * Copyright by Hannu Savolainen 1993&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; */
DECL|macro|SEQUENCER_C
mdefine_line|#define SEQUENCER_C
macro_line|#include &quot;sound_config.h&quot;
macro_line|#ifdef CONFIGURE_SOUNDCARD
macro_line|#ifndef EXCLUDE_SEQUENCER
DECL|variable|sequencer_ok
r_static
r_int
id|sequencer_ok
op_assign
l_int|0
suffix:semicolon
id|DEFINE_WAIT_QUEUE
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
suffix:semicolon
multiline_comment|/* DEFINE_WAIT_QUEUE (midi_sleeper, midi_sleep_flag); */
DECL|macro|midi_sleeper
mdefine_line|#define midi_sleeper seq_sleeper
DECL|macro|midi_sleep_flag
mdefine_line|#define midi_sleep_flag seq_sleep_flag
DECL|variable|midi_opened
r_static
r_int
id|midi_opened
(braket
id|MAX_MIDI_DEV
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
multiline_comment|/* 1 if the process has opened MIDI */
DECL|variable|midi_written
r_static
r_int
id|midi_written
(braket
id|MAX_MIDI_DEV
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|seq_time
r_int
r_int
id|seq_time
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reference point for the timer */
macro_line|#include &quot;tuning.h&quot;
DECL|macro|EV_SZ
mdefine_line|#define EV_SZ&t;8
DECL|macro|IEV_SZ
mdefine_line|#define IEV_SZ&t;4
DECL|variable|queue
r_static
r_int
r_char
op_star
id|queue
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* SEQ_MAX_QUEUE * EV_SZ bytes */
DECL|variable|iqueue
r_static
r_int
r_char
op_star
id|iqueue
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* SEQ_MAX_QUEUE * IEV_SZ bytes */
DECL|variable|qhead
DECL|variable|qtail
DECL|variable|qlen
r_static
r_volatile
r_int
id|qhead
op_assign
l_int|0
comma
id|qtail
op_assign
l_int|0
comma
id|qlen
op_assign
l_int|0
suffix:semicolon
DECL|variable|iqhead
DECL|variable|iqtail
DECL|variable|iqlen
r_static
r_volatile
r_int
id|iqhead
op_assign
l_int|0
comma
id|iqtail
op_assign
l_int|0
comma
id|iqlen
op_assign
l_int|0
suffix:semicolon
DECL|variable|seq_playing
r_static
r_volatile
r_int
id|seq_playing
op_assign
l_int|0
suffix:semicolon
DECL|variable|sequencer_busy
r_static
r_int
id|sequencer_busy
op_assign
l_int|0
suffix:semicolon
DECL|variable|output_treshold
r_static
r_int
id|output_treshold
suffix:semicolon
DECL|variable|synth_open_mask
r_static
r_int
id|synth_open_mask
suffix:semicolon
r_static
r_int
id|seq_queue
(paren
r_int
r_char
op_star
id|note
)paren
suffix:semicolon
r_static
r_void
id|seq_startplay
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|seq_sync
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|seq_reset
(paren
r_void
)paren
suffix:semicolon
DECL|variable|pmgr_present
r_static
r_int
id|pmgr_present
(braket
id|MAX_SYNTH_DEV
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
macro_line|#if MAX_SYNTH_DEV &gt; 15
macro_line|#error Too many synthesizer devices
macro_line|#endif
r_int
DECL|function|sequencer_read
id|sequencer_read
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
comma
id|snd_rw_buf
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|c
op_assign
id|count
comma
id|p
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dev
op_assign
id|dev
op_rshift
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager device */
r_return
id|pmgr_read
(paren
id|dev
op_minus
l_int|1
comma
id|file
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_while
c_loop
(paren
id|c
OG
l_int|3
)paren
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iqlen
)paren
(brace
r_if
c_cond
(paren
id|c
op_ne
id|count
)paren
multiline_comment|/* Some data has been received */
(brace
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_return
id|count
op_minus
id|c
suffix:semicolon
multiline_comment|/* Return what we have */
)brace
id|DO_SLEEP
(paren
id|midi_sleeper
comma
id|midi_sleep_flag
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iqlen
)paren
(brace
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_return
id|count
op_minus
id|c
suffix:semicolon
)brace
)brace
id|COPY_TO_USER
(paren
id|buf
comma
id|p
comma
op_amp
id|iqueue
(braket
id|iqhead
op_star
id|IEV_SZ
)braket
comma
id|IEV_SZ
)paren
suffix:semicolon
id|p
op_add_assign
l_int|4
suffix:semicolon
id|c
op_sub_assign
l_int|4
suffix:semicolon
id|iqhead
op_assign
(paren
id|iqhead
op_plus
l_int|1
)paren
op_mod
id|SEQ_MAX_QUEUE
suffix:semicolon
id|iqlen
op_decrement
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
id|count
op_minus
id|c
suffix:semicolon
)brace
r_static
r_void
DECL|function|sequencer_midi_output
id|sequencer_midi_output
(paren
r_int
id|dev
)paren
(brace
multiline_comment|/* Currently NOP */
)brace
r_static
r_void
DECL|function|copy_to_input
id|copy_to_input
(paren
r_int
r_char
op_star
id|event
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|iqlen
op_ge
(paren
id|SEQ_MAX_QUEUE
op_minus
l_int|1
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Overflow */
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|iqueue
(braket
id|iqtail
op_star
id|IEV_SZ
)braket
comma
id|event
comma
id|IEV_SZ
)paren
suffix:semicolon
id|iqlen
op_increment
suffix:semicolon
id|iqtail
op_assign
(paren
id|iqtail
op_plus
l_int|1
)paren
op_mod
id|SEQ_MAX_QUEUE
suffix:semicolon
r_if
c_cond
(paren
id|SOMEONE_WAITING
(paren
id|midi_sleeper
comma
id|midi_sleep_flag
)paren
)paren
(brace
id|WAKE_UP
(paren
id|midi_sleeper
comma
id|midi_sleep_flag
)paren
suffix:semicolon
)brace
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sequencer_midi_input
id|sequencer_midi_input
(paren
r_int
id|dev
comma
r_int
r_char
id|data
)paren
(brace
r_int
id|tstamp
suffix:semicolon
r_int
r_char
id|event
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
l_int|0xfe
)paren
multiline_comment|/* Active sensing */
r_return
suffix:semicolon
multiline_comment|/* Ignore */
id|tstamp
op_assign
id|GET_TIME
(paren
)paren
op_minus
id|seq_time
suffix:semicolon
multiline_comment|/* Time since open() */
id|tstamp
op_assign
(paren
id|tstamp
op_lshift
l_int|8
)paren
op_or
id|SEQ_WAIT
suffix:semicolon
id|copy_to_input
(paren
(paren
r_int
r_char
op_star
)paren
op_amp
id|tstamp
)paren
suffix:semicolon
id|event
(braket
l_int|0
)braket
op_assign
id|SEQ_MIDIPUTC
suffix:semicolon
id|event
(braket
l_int|1
)braket
op_assign
id|data
suffix:semicolon
id|event
(braket
l_int|2
)braket
op_assign
id|dev
suffix:semicolon
id|event
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|copy_to_input
(paren
id|event
)paren
suffix:semicolon
)brace
r_int
DECL|function|sequencer_write
id|sequencer_write
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
comma
id|snd_rw_buf
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_char
id|event
(braket
id|EV_SZ
)braket
comma
id|ev_code
suffix:semicolon
r_int
id|p
op_assign
l_int|0
comma
id|c
comma
id|ev_size
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|mode
op_assign
id|file-&gt;mode
op_amp
id|O_ACCMODE
suffix:semicolon
id|dev
op_assign
id|dev
op_rshift
l_int|4
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;sequencer_write(dev=%d, count=%d)&bslash;n&quot;
comma
id|dev
comma
id|count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|OPEN_READ
)paren
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager device */
r_return
id|pmgr_write
(paren
id|dev
op_minus
l_int|1
comma
id|file
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|c
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|c
op_ge
l_int|4
)paren
(brace
id|COPY_FROM_USER
(paren
id|event
comma
id|buf
comma
id|p
comma
l_int|4
)paren
suffix:semicolon
id|ev_code
op_assign
id|event
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ev_code
op_eq
id|SEQ_FULLSIZE
)paren
(brace
r_int
id|err
suffix:semicolon
id|dev
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|event
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_synths
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
id|err
op_assign
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|load_patch
(paren
id|dev
comma
op_star
(paren
r_int
op_star
)paren
op_amp
id|event
(braket
l_int|0
)braket
comma
id|buf
comma
id|p
op_plus
l_int|4
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ev_code
op_eq
id|SEQ_EXTENDED
op_logical_or
id|ev_code
op_eq
id|SEQ_PRIVATE
)paren
(brace
id|ev_size
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|c
OL
id|ev_size
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|seq_playing
)paren
id|seq_startplay
(paren
)paren
suffix:semicolon
r_return
id|count
op_minus
id|c
suffix:semicolon
)brace
id|COPY_FROM_USER
(paren
op_amp
id|event
(braket
l_int|4
)braket
comma
id|buf
comma
id|p
op_plus
l_int|4
comma
l_int|4
)paren
suffix:semicolon
)brace
r_else
id|ev_size
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|event
(braket
l_int|0
)braket
op_eq
id|SEQ_MIDIPUTC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|midi_opened
(braket
id|event
(braket
l_int|2
)braket
)braket
)paren
(brace
r_int
id|mode
suffix:semicolon
r_int
id|dev
op_assign
id|event
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|num_midis
)paren
(brace
id|printk
(paren
l_string|&quot;Sequencer Error: Nonexistent MIDI device %d&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
id|mode
op_assign
id|file-&gt;mode
op_amp
id|O_ACCMODE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|open
(paren
id|dev
comma
id|mode
comma
id|sequencer_midi_input
comma
id|sequencer_midi_output
)paren
)paren
OL
l_int|0
)paren
(brace
id|seq_reset
(paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Sequencer Error: Unable to open Midi #%d&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|midi_opened
(braket
id|dev
)braket
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|seq_queue
(paren
id|event
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|seq_playing
)paren
id|seq_startplay
(paren
)paren
suffix:semicolon
r_return
id|count
op_minus
id|c
suffix:semicolon
)brace
id|p
op_add_assign
id|ev_size
suffix:semicolon
id|c
op_sub_assign
id|ev_size
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|seq_playing
)paren
id|seq_startplay
(paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
r_int
DECL|function|seq_queue
id|seq_queue
(paren
r_int
r_char
op_star
id|note
)paren
(brace
multiline_comment|/* Test if there is space in the queue */
r_if
c_cond
(paren
id|qlen
op_ge
id|SEQ_MAX_QUEUE
)paren
r_if
c_cond
(paren
op_logical_neg
id|seq_playing
)paren
id|seq_startplay
(paren
)paren
suffix:semicolon
multiline_comment|/* Give chance to drain the queue */
r_if
c_cond
(paren
id|qlen
op_ge
id|SEQ_MAX_QUEUE
op_logical_and
op_logical_neg
id|SOMEONE_WAITING
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
)paren
(brace
multiline_comment|/* Sleep until there is enough space on the queue */
id|DO_SLEEP
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qlen
op_ge
id|SEQ_MAX_QUEUE
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* To be sure */
id|memcpy
(paren
op_amp
id|queue
(braket
id|qtail
op_star
id|EV_SZ
)braket
comma
id|note
comma
id|EV_SZ
)paren
suffix:semicolon
id|qtail
op_assign
(paren
id|qtail
op_plus
l_int|1
)paren
op_mod
id|SEQ_MAX_QUEUE
suffix:semicolon
id|qlen
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|extended_event
id|extended_event
(paren
r_int
r_char
op_star
id|q
)paren
(brace
r_int
id|dev
op_assign
id|q
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_synths
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|q
(braket
l_int|1
)braket
)paren
(brace
r_case
id|SEQ_NOTEOFF
suffix:colon
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|kill_note
(paren
id|dev
comma
id|q
(braket
l_int|3
)braket
comma
id|q
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_NOTEON
suffix:colon
r_if
c_cond
(paren
id|q
(braket
l_int|4
)braket
OG
l_int|127
op_logical_and
id|q
(braket
l_int|4
)braket
op_ne
l_int|255
)paren
r_return
l_int|0
suffix:semicolon
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|start_note
(paren
id|dev
comma
id|q
(braket
l_int|3
)braket
comma
id|q
(braket
l_int|4
)braket
comma
id|q
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_PGMCHANGE
suffix:colon
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|set_instr
(paren
id|dev
comma
id|q
(braket
l_int|3
)braket
comma
id|q
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_AFTERTOUCH
suffix:colon
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|aftertouch
(paren
id|dev
comma
id|q
(braket
l_int|3
)braket
comma
id|q
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_BALANCE
suffix:colon
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|panning
(paren
id|dev
comma
id|q
(braket
l_int|3
)braket
comma
(paren
r_char
)paren
id|q
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_CONTROLLER
suffix:colon
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|controller
(paren
id|dev
comma
id|q
(braket
l_int|3
)braket
comma
id|q
(braket
l_int|4
)braket
comma
op_star
(paren
r_int
op_star
)paren
op_amp
id|q
(braket
l_int|5
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_VOLMODE
suffix:colon
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|volume_method
(paren
id|dev
comma
id|q
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|seq_startplay
id|seq_startplay
(paren
r_void
)paren
(brace
r_int
id|this_one
suffix:semicolon
r_int
r_int
op_star
id|delay
suffix:semicolon
r_int
r_char
op_star
id|q
suffix:semicolon
r_while
c_loop
(paren
id|qlen
OG
l_int|0
)paren
(brace
id|qhead
op_assign
(paren
(paren
id|this_one
op_assign
id|qhead
)paren
op_plus
l_int|1
)paren
op_mod
id|SEQ_MAX_QUEUE
suffix:semicolon
id|qlen
op_decrement
suffix:semicolon
id|q
op_assign
op_amp
id|queue
(braket
id|this_one
op_star
id|EV_SZ
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|q
(braket
l_int|0
)braket
)paren
(brace
r_case
id|SEQ_NOTEOFF
suffix:colon
r_if
c_cond
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
r_if
c_cond
(paren
id|synth_devs
(braket
l_int|0
)braket
)paren
id|synth_devs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|kill_note
(paren
l_int|0
comma
id|q
(braket
l_int|1
)braket
comma
id|q
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_NOTEON
suffix:colon
r_if
c_cond
(paren
id|q
(braket
l_int|4
)braket
OL
l_int|128
op_logical_or
id|q
(braket
l_int|4
)braket
op_eq
l_int|255
)paren
r_if
c_cond
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
r_if
c_cond
(paren
id|synth_devs
(braket
l_int|0
)braket
)paren
id|synth_devs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start_note
(paren
l_int|0
comma
id|q
(braket
l_int|1
)braket
comma
id|q
(braket
l_int|2
)braket
comma
id|q
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_WAIT
suffix:colon
id|delay
op_assign
(paren
r_int
r_int
op_star
)paren
id|q
suffix:semicolon
multiline_comment|/* Bytes 1 to 3 are containing the&n;&t;&t;&t;&t;&t; * delay in GET_TIME() */
op_star
id|delay
op_assign
(paren
op_star
id|delay
op_rshift
l_int|8
)paren
op_amp
l_int|0xffffff
suffix:semicolon
r_if
c_cond
(paren
op_star
id|delay
OG
l_int|0
)paren
(brace
r_int
id|time
suffix:semicolon
id|seq_playing
op_assign
l_int|1
suffix:semicolon
id|time
op_assign
op_star
id|delay
suffix:semicolon
id|request_sound_timer
(paren
id|time
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SEQ_MAX_QUEUE
op_minus
id|qlen
)paren
op_ge
id|output_treshold
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SOMEONE_WAITING
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
)paren
(brace
id|WAKE_UP
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
suffix:semicolon
)brace
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
multiline_comment|/* Stop here. Timer routine will continue&n;&t;&t;&t;&t; * playing after the delay */
)brace
r_break
suffix:semicolon
r_case
id|SEQ_PGMCHANGE
suffix:colon
r_if
c_cond
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
r_if
c_cond
(paren
id|synth_devs
(braket
l_int|0
)braket
)paren
id|synth_devs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|set_instr
(paren
l_int|0
comma
id|q
(braket
l_int|1
)braket
comma
id|q
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_SYNCTIMER
suffix:colon
multiline_comment|/* Reset timer */
id|seq_time
op_assign
id|GET_TIME
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_MIDIPUTC
suffix:colon
multiline_comment|/* Put a midi character */
r_if
c_cond
(paren
id|midi_opened
(braket
id|q
(braket
l_int|2
)braket
)braket
)paren
(brace
r_int
id|dev
suffix:semicolon
id|dev
op_assign
id|q
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|putc
(paren
id|dev
comma
id|q
(braket
l_int|1
)braket
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;   * Output FIFO is full. Wait one timer cycle and try again.&n;&t;&t;   */
id|qlen
op_increment
suffix:semicolon
id|qhead
op_assign
id|this_one
suffix:semicolon
multiline_comment|/* Restore queue */
id|seq_playing
op_assign
l_int|1
suffix:semicolon
id|request_sound_timer
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
id|midi_written
(braket
id|dev
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SEQ_ECHO
suffix:colon
id|copy_to_input
(paren
id|q
)paren
suffix:semicolon
multiline_comment|/* Echo back to the process */
r_break
suffix:semicolon
r_case
id|SEQ_PRIVATE
suffix:colon
r_if
c_cond
(paren
id|q
(braket
l_int|1
)braket
OL
id|num_synths
)paren
id|synth_devs
(braket
id|q
(braket
l_int|1
)braket
)braket
op_member_access_from_pointer
id|hw_control
(paren
id|q
(braket
l_int|1
)braket
comma
id|q
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_EXTENDED
suffix:colon
id|extended_event
(paren
id|q
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
)brace
id|seq_playing
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|SEQ_MAX_QUEUE
op_minus
id|qlen
)paren
op_ge
id|output_treshold
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SOMEONE_WAITING
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
)paren
(brace
id|WAKE_UP
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
suffix:semicolon
)brace
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|sequencer_open
id|sequencer_open
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
)paren
(brace
r_int
id|retval
comma
id|mode
comma
id|i
suffix:semicolon
id|dev
op_assign
id|dev
op_rshift
l_int|4
suffix:semicolon
id|mode
op_assign
id|file-&gt;mode
op_amp
id|O_ACCMODE
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;sequencer_open(dev=%d)&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sequencer_ok
)paren
(brace
id|printk
(paren
l_string|&quot;Soundcard: Sequencer not initialized&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager device */
(brace
r_int
id|err
suffix:semicolon
id|dev
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|pmgr_present
(braket
id|dev
)braket
)paren
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pmgr_open
(paren
id|dev
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Failed */
id|pmgr_present
(braket
id|dev
)braket
op_assign
l_int|1
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sequencer_busy
)paren
(brace
id|printk
(paren
l_string|&quot;Sequencer busy&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|num_synths
op_plus
id|num_midis
)paren
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
id|synth_open_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|OPEN_WRITE
op_logical_or
id|mode
op_eq
id|OPEN_READWRITE
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_synths
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Open synth devices */
r_if
c_cond
(paren
id|synth_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|open
(paren
id|i
comma
id|mode
)paren
OL
l_int|0
)paren
id|printk
(paren
l_string|&quot;Sequencer: Warning! Cannot open synth device #%d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_else
id|synth_open_mask
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|seq_time
op_assign
id|GET_TIME
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_midis
suffix:semicolon
id|i
op_increment
)paren
(brace
id|midi_opened
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|midi_written
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mode
op_eq
id|OPEN_READ
op_logical_or
id|mode
op_eq
id|OPEN_READWRITE
)paren
(brace
multiline_comment|/* Initialize midi input devices */
r_if
c_cond
(paren
op_logical_neg
id|num_midis
)paren
(brace
id|printk
(paren
l_string|&quot;Sequencer: No Midi devices. Input not possible&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_midis
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|midi_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|open
(paren
id|i
comma
id|mode
comma
id|sequencer_midi_input
comma
id|sequencer_midi_output
)paren
)paren
op_ge
l_int|0
)paren
id|midi_opened
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|sequencer_busy
op_assign
l_int|1
suffix:semicolon
id|RESET_WAIT_QUEUE
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
suffix:semicolon
id|RESET_WAIT_QUEUE
(paren
id|midi_sleeper
comma
id|midi_sleep_flag
)paren
suffix:semicolon
id|output_treshold
op_assign
id|SEQ_MAX_QUEUE
op_div
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_synths
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pmgr_present
(braket
id|i
)braket
)paren
id|pmgr_inform
(paren
id|i
comma
id|PM_E_OPENED
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|seq_drain_midi_queues
id|seq_drain_midi_queues
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|n
suffix:semicolon
multiline_comment|/*&n;   * Give the Midi drivers time to drain their output queues&n;   */
id|n
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|PROCESS_ABORTING
(paren
id|midi_sleeper
comma
id|midi_sleep_flag
)paren
op_logical_and
id|n
)paren
(brace
id|n
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_midis
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|midi_opened
(braket
id|i
)braket
op_logical_and
id|midi_written
(braket
id|i
)braket
)paren
r_if
c_cond
(paren
id|midi_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|buffer_status
op_ne
l_int|NULL
)paren
r_if
c_cond
(paren
id|midi_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|buffer_status
(paren
id|i
)paren
)paren
id|n
op_increment
suffix:semicolon
multiline_comment|/*&n;       * Let&squot;s have a delay&n;       */
r_if
c_cond
(paren
id|n
)paren
(brace
id|DO_SLEEP
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
comma
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
)brace
)brace
)brace
r_void
DECL|function|sequencer_release
id|sequencer_release
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|mode
op_assign
id|file-&gt;mode
op_amp
id|O_ACCMODE
suffix:semicolon
id|dev
op_assign
id|dev
op_rshift
l_int|4
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;sequencer_release(dev=%d)&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager device */
(brace
id|dev
op_decrement
suffix:semicolon
id|pmgr_release
(paren
id|dev
)paren
suffix:semicolon
id|pmgr_present
(braket
id|dev
)braket
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;     * Wait until the queue is empty&n;   */
r_while
c_loop
(paren
op_logical_neg
id|PROCESS_ABORTING
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
op_logical_and
id|qlen
)paren
(brace
id|seq_sync
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mode
op_ne
id|OPEN_READ
)paren
id|seq_drain_midi_queues
(paren
)paren
suffix:semicolon
multiline_comment|/* Ensure the output queues are empty */
id|seq_reset
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
id|OPEN_READ
)paren
id|seq_drain_midi_queues
(paren
)paren
suffix:semicolon
multiline_comment|/* Flush the all notes off messages */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_midis
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|midi_opened
(braket
id|i
)braket
)paren
id|midi_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|close
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|OPEN_WRITE
op_logical_or
id|mode
op_eq
id|OPEN_READWRITE
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_synths
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
multiline_comment|/* Actually opened */
r_if
c_cond
(paren
id|synth_devs
(braket
id|i
)braket
)paren
id|synth_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|close
(paren
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_synths
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pmgr_present
(braket
id|i
)braket
)paren
id|pmgr_inform
(paren
id|i
comma
id|PM_E_CLOSED
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|sequencer_busy
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|seq_sync
id|seq_sync
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|qlen
op_logical_and
op_logical_neg
id|seq_playing
op_logical_and
op_logical_neg
id|PROCESS_ABORTING
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
)paren
id|seq_startplay
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qlen
op_logical_and
op_logical_neg
id|SOMEONE_WAITING
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
)paren
multiline_comment|/* Queue not empty */
(brace
id|DO_SLEEP
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|qlen
suffix:semicolon
)brace
r_static
r_void
DECL|function|midi_outc
id|midi_outc
(paren
r_int
id|dev
comma
r_int
r_char
id|data
)paren
(brace
multiline_comment|/*&n;   * NOTE! Calls sleep(). Don&squot;t call this from interrupt.&n;   */
r_int
id|n
suffix:semicolon
multiline_comment|/* This routine sends one byte to the Midi channel. */
multiline_comment|/* If the output Fifo is full, it waits until there */
multiline_comment|/* is space in the queue */
id|n
op_assign
l_int|300
suffix:semicolon
multiline_comment|/* Timeout in jiffies */
r_while
c_loop
(paren
id|n
op_logical_and
op_logical_neg
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|putc
(paren
id|dev
comma
id|data
)paren
)paren
(brace
id|DO_SLEEP
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
comma
l_int|4
)paren
suffix:semicolon
id|n
op_decrement
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|seq_reset
id|seq_reset
(paren
r_void
)paren
(brace
multiline_comment|/*&n;   * NOTE! Calls sleep(). Don&squot;t call this from interrupt.&n;   */
r_int
id|i
comma
id|chn
suffix:semicolon
id|sound_stop_timer
(paren
)paren
suffix:semicolon
id|qlen
op_assign
id|qhead
op_assign
id|qtail
op_assign
l_int|0
suffix:semicolon
id|iqlen
op_assign
id|iqhead
op_assign
id|iqtail
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_synths
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
r_if
c_cond
(paren
id|synth_devs
(braket
id|i
)braket
)paren
id|synth_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|reset
(paren
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_midis
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|midi_written
(braket
id|i
)braket
)paren
multiline_comment|/* Midi used. Some notes may still be playing */
(brace
r_for
c_loop
(paren
id|chn
op_assign
l_int|0
suffix:semicolon
id|chn
OL
l_int|16
suffix:semicolon
id|chn
op_increment
)paren
(brace
id|midi_outc
(paren
id|i
comma
(paren
r_int
r_char
)paren
(paren
l_int|0xb0
op_plus
(paren
id|chn
op_amp
l_int|0xff
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Channel msg */
id|midi_outc
(paren
id|i
comma
l_int|0x7b
)paren
suffix:semicolon
multiline_comment|/* All notes off */
id|midi_outc
(paren
id|i
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Dummy parameter */
)brace
id|midi_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|close
(paren
id|i
)paren
suffix:semicolon
id|midi_written
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|midi_opened
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|seq_playing
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|SOMEONE_WAITING
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
)paren
id|printk
(paren
l_string|&quot;Sequencer Warning: Unexpected sleeping process&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_int
DECL|function|sequencer_ioctl
id|sequencer_ioctl
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|midi_dev
comma
id|orig_dev
suffix:semicolon
r_int
id|mode
op_assign
id|file-&gt;mode
op_amp
id|O_ACCMODE
suffix:semicolon
id|orig_dev
op_assign
id|dev
op_assign
id|dev
op_rshift
l_int|4
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDCTL_SEQ_SYNC
suffix:colon
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager */
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|OPEN_READ
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|qlen
op_logical_and
op_logical_neg
id|PROCESS_ABORTING
(paren
id|seq_sleeper
comma
id|seq_sleep_flag
)paren
)paren
id|seq_sync
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_RESET
suffix:colon
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager */
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
id|seq_reset
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_TESTMIDI
suffix:colon
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager */
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
id|midi_dev
op_assign
id|IOCTL_IN
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|midi_dev
op_ge
id|num_midis
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|midi_opened
(braket
id|midi_dev
)braket
)paren
(brace
r_int
id|err
comma
id|mode
suffix:semicolon
id|mode
op_assign
id|file-&gt;mode
op_amp
id|O_ACCMODE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|midi_devs
(braket
id|midi_dev
)braket
op_member_access_from_pointer
id|open
(paren
id|midi_dev
comma
id|mode
comma
id|sequencer_midi_input
comma
id|sequencer_midi_output
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
id|midi_opened
(braket
id|midi_dev
)braket
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_GETINCOUNT
suffix:colon
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager */
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|OPEN_WRITE
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|iqlen
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_GETOUTCOUNT
suffix:colon
r_if
c_cond
(paren
id|mode
op_eq
id|OPEN_READ
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|SEQ_MAX_QUEUE
op_minus
id|qlen
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_CTRLRATE
suffix:colon
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager */
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
multiline_comment|/* If *arg == 0, just return the current rate */
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|HZ
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_RESETSAMPLES
suffix:colon
id|dev
op_assign
id|IOCTL_IN
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_synths
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
op_logical_and
op_logical_neg
id|orig_dev
)paren
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|orig_dev
op_logical_and
id|pmgr_present
(braket
id|dev
)braket
)paren
id|pmgr_inform
(paren
id|dev
comma
id|PM_E_PATCH_RESET
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|ioctl
(paren
id|dev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_NRSYNTHS
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|num_synths
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_NRMIDIS
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|num_midis
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SYNTH_MEMAVL
suffix:colon
(brace
r_int
id|dev
op_assign
id|IOCTL_IN
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_synths
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
op_logical_and
op_logical_neg
id|orig_dev
)paren
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|ioctl
(paren
id|dev
comma
id|cmd
comma
id|arg
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_FM_4OP_ENABLE
suffix:colon
(brace
r_int
id|dev
op_assign
id|IOCTL_IN
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_synths
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|ioctl
(paren
id|dev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_SYNTH_INFO
suffix:colon
(brace
r_struct
id|synth_info
id|inf
suffix:semicolon
r_int
id|dev
suffix:semicolon
id|IOCTL_FROM_USER
(paren
(paren
r_char
op_star
)paren
op_amp
id|inf
comma
(paren
r_char
op_star
)paren
id|arg
comma
l_int|0
comma
r_sizeof
(paren
id|inf
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|inf.device
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_synths
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
op_logical_and
op_logical_neg
id|orig_dev
)paren
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
r_return
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|ioctl
(paren
id|dev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_MIDI_INFO
suffix:colon
(brace
r_struct
id|midi_info
id|inf
suffix:semicolon
r_int
id|dev
suffix:semicolon
id|IOCTL_FROM_USER
(paren
(paren
r_char
op_star
)paren
op_amp
id|inf
comma
(paren
r_char
op_star
)paren
id|arg
comma
l_int|0
comma
r_sizeof
(paren
id|inf
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|inf.device
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_midis
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
id|IOCTL_TO_USER
(paren
(paren
r_char
op_star
)paren
id|arg
comma
l_int|0
comma
(paren
r_char
op_star
)paren
op_amp
(paren
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|info
)paren
comma
r_sizeof
(paren
id|inf
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_PMGR_IFACE
suffix:colon
(brace
r_struct
id|patmgr_info
op_star
id|inf
suffix:semicolon
r_int
id|dev
comma
id|err
suffix:semicolon
id|inf
op_assign
(paren
r_struct
id|patmgr_info
op_star
)paren
id|KERNEL_MALLOC
(paren
r_sizeof
(paren
op_star
id|inf
)paren
)paren
suffix:semicolon
id|IOCTL_FROM_USER
(paren
(paren
r_char
op_star
)paren
id|inf
comma
(paren
r_char
op_star
)paren
id|arg
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|inf
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|inf-&gt;device
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_synths
)paren
(brace
id|KERNEL_FREE
(paren
id|inf
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|pmgr_interface
)paren
(brace
id|KERNEL_FREE
(paren
id|inf
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|pmgr_interface
(paren
id|dev
comma
id|inf
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|KERNEL_FREE
(paren
id|inf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|IOCTL_TO_USER
(paren
(paren
r_char
op_star
)paren
id|arg
comma
l_int|0
comma
(paren
r_char
op_star
)paren
id|inf
comma
r_sizeof
(paren
op_star
id|inf
)paren
)paren
suffix:semicolon
id|KERNEL_FREE
(paren
id|inf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_PMGR_ACCESS
suffix:colon
(brace
r_struct
id|patmgr_info
op_star
id|inf
suffix:semicolon
r_int
id|dev
comma
id|err
suffix:semicolon
id|inf
op_assign
(paren
r_struct
id|patmgr_info
op_star
)paren
id|KERNEL_MALLOC
(paren
r_sizeof
(paren
op_star
id|inf
)paren
)paren
suffix:semicolon
id|IOCTL_FROM_USER
(paren
(paren
r_char
op_star
)paren
id|inf
comma
(paren
r_char
op_star
)paren
id|arg
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|inf
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|inf-&gt;device
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_synths
)paren
(brace
id|KERNEL_FREE
(paren
id|inf
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pmgr_present
(braket
id|dev
)braket
)paren
(brace
id|KERNEL_FREE
(paren
id|inf
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ESRCH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pmgr_access
(paren
id|dev
comma
id|inf
)paren
)paren
OL
l_int|0
)paren
(brace
id|KERNEL_FREE
(paren
id|inf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|IOCTL_TO_USER
(paren
(paren
r_char
op_star
)paren
id|arg
comma
l_int|0
comma
(paren
r_char
op_star
)paren
id|inf
comma
r_sizeof
(paren
op_star
id|inf
)paren
)paren
suffix:semicolon
id|KERNEL_FREE
(paren
id|inf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_TRESHOLD
suffix:colon
(brace
r_int
id|tmp
op_assign
id|IOCTL_IN
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager */
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|1
)paren
id|tmp
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ge
id|SEQ_MAX_QUEUE
)paren
id|tmp
op_assign
id|SEQ_MAX_QUEUE
op_minus
l_int|1
suffix:semicolon
id|output_treshold
op_assign
id|tmp
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|dev
)paren
multiline_comment|/* Patch manager */
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|OPEN_READ
)paren
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|synth_devs
(braket
l_int|0
)braket
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|synth_open_mask
op_amp
(paren
l_int|1
op_lshift
l_int|0
)paren
)paren
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_return
id|synth_devs
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ioctl
(paren
l_int|0
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
macro_line|#ifdef ALLOW_SELECT
r_int
DECL|function|sequencer_select
id|sequencer_select
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
(brace
id|dev
op_assign
id|dev
op_rshift
l_int|4
suffix:semicolon
r_switch
c_cond
(paren
id|sel_type
)paren
(brace
r_case
id|SEL_IN
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|iqlen
)paren
(brace
id|select_wait
(paren
op_amp
id|midi_sleeper
comma
id|wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEL_OUT
suffix:colon
r_if
c_cond
(paren
id|qlen
op_ge
id|SEQ_MAX_QUEUE
)paren
(brace
id|select_wait
(paren
op_amp
id|seq_sleeper
comma
id|wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEL_EX
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_void
DECL|function|sequencer_timer
id|sequencer_timer
(paren
r_void
)paren
(brace
id|seq_startplay
(paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|note_to_freq
id|note_to_freq
(paren
r_int
id|note_num
)paren
(brace
multiline_comment|/*&n;   * This routine converts a midi note to a frequency (multiplied by 1000)&n;   */
r_int
id|note
comma
id|octave
comma
id|note_freq
suffix:semicolon
r_int
id|notes
(braket
)braket
op_assign
(brace
l_int|261632
comma
l_int|277189
comma
l_int|293671
comma
l_int|311132
comma
l_int|329632
comma
l_int|349232
comma
l_int|369998
comma
l_int|391998
comma
l_int|415306
comma
l_int|440000
comma
l_int|466162
comma
l_int|493880
)brace
suffix:semicolon
multiline_comment|/* Note freq*1000 for octave 5 */
DECL|macro|BASE_OCTAVE
mdefine_line|#define BASE_OCTAVE&t;5
id|octave
op_assign
id|note_num
op_div
l_int|12
suffix:semicolon
id|note
op_assign
id|note_num
op_mod
l_int|12
suffix:semicolon
id|note_freq
op_assign
id|notes
(braket
id|note
)braket
suffix:semicolon
r_if
c_cond
(paren
id|octave
OL
id|BASE_OCTAVE
)paren
id|note_freq
op_rshift_assign
(paren
id|BASE_OCTAVE
op_minus
id|octave
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|octave
OG
id|BASE_OCTAVE
)paren
id|note_freq
op_lshift_assign
(paren
id|octave
op_minus
id|BASE_OCTAVE
)paren
suffix:semicolon
multiline_comment|/* note_freq &gt;&gt;= 1;    */
r_return
id|note_freq
suffix:semicolon
)brace
r_int
r_int
DECL|function|compute_finetune
id|compute_finetune
(paren
r_int
r_int
id|base_freq
comma
r_int
id|bend
comma
r_int
id|range
)paren
(brace
r_int
r_int
id|amount
suffix:semicolon
r_int
id|negative
comma
id|semitones
comma
id|cents
comma
id|multiplier
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bend
)paren
r_return
id|base_freq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|range
)paren
r_return
id|base_freq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base_freq
)paren
r_return
id|base_freq
suffix:semicolon
r_if
c_cond
(paren
id|range
op_ge
l_int|8192
)paren
id|range
op_assign
l_int|8191
suffix:semicolon
id|bend
op_assign
id|bend
op_star
id|range
op_div
l_int|8192
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bend
)paren
r_return
id|base_freq
suffix:semicolon
id|negative
op_assign
id|bend
OL
l_int|0
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bend
OL
l_int|0
)paren
id|bend
op_mul_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|bend
OG
id|range
)paren
id|bend
op_assign
id|range
suffix:semicolon
multiline_comment|/*&n;     if (bend &gt; 2399)&n;     bend = 2399;&n;   */
r_while
c_loop
(paren
id|bend
OG
l_int|2399
)paren
(brace
id|multiplier
op_mul_assign
l_int|4
suffix:semicolon
id|bend
op_sub_assign
l_int|2400
suffix:semicolon
)brace
id|semitones
op_assign
id|bend
op_div
l_int|100
suffix:semicolon
id|cents
op_assign
id|bend
op_mod
l_int|100
suffix:semicolon
id|amount
op_assign
id|semitone_tuning
(braket
id|semitones
)braket
op_star
id|multiplier
op_star
id|cent_tuning
(braket
id|cents
)braket
op_div
l_int|10000
suffix:semicolon
r_if
c_cond
(paren
id|negative
)paren
r_return
(paren
id|base_freq
op_star
l_int|10000
)paren
op_div
id|amount
suffix:semicolon
multiline_comment|/* Bend down */
r_else
r_return
(paren
id|base_freq
op_star
id|amount
)paren
op_div
l_int|10000
suffix:semicolon
multiline_comment|/* Bend up */
)brace
r_int
DECL|function|sequencer_init
id|sequencer_init
(paren
r_int
id|mem_start
)paren
(brace
id|sequencer_ok
op_assign
l_int|1
suffix:semicolon
id|PERMANENT_MALLOC
(paren
r_int
r_char
op_star
comma
id|queue
comma
id|SEQ_MAX_QUEUE
op_star
id|EV_SZ
comma
id|mem_start
)paren
suffix:semicolon
id|PERMANENT_MALLOC
(paren
r_int
r_char
op_star
comma
id|iqueue
comma
id|SEQ_MAX_QUEUE
op_star
id|IEV_SZ
comma
id|mem_start
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* Stub version */
r_int
DECL|function|sequencer_read
id|sequencer_read
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
comma
id|snd_rw_buf
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
)brace
r_int
DECL|function|sequencer_write
id|sequencer_write
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
comma
id|snd_rw_buf
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
)brace
r_int
DECL|function|sequencer_open
id|sequencer_open
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
)paren
(brace
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_void
DECL|function|sequencer_release
id|sequencer_release
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
)paren
(brace
)brace
r_int
DECL|function|sequencer_ioctl
id|sequencer_ioctl
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
)brace
r_int
DECL|function|sequencer_lseek
id|sequencer_lseek
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
comma
id|off_t
id|offset
comma
r_int
id|orig
)paren
(brace
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
)brace
r_int
DECL|function|sequencer_init
id|sequencer_init
(paren
r_int
id|mem_start
)paren
(brace
r_return
id|mem_start
suffix:semicolon
)brace
r_int
DECL|function|sequencer_select
id|sequencer_select
(paren
r_int
id|dev
comma
r_struct
id|fileinfo
op_star
id|file
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
(brace
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
eof
