multiline_comment|/*&n; * sound/sb_common.c&n; *&n; * Common routines for Sound Blaster compatible cards.&n; *&n; *&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; *&n; *&n; * Daniel J. Rodriksson: Modified sbintr to handle 8 and 16 bit interrupts&n; *                       for full duplex support ( only sb16 by now )&n; * Rolf Fokkens:&t; Added (BETA?) support for ES1887 chips.&n; * (fokkensr@vertis.nl)&t; Which means: You can adjust the recording levels.&n; *&n; * 2000/01/18 - separated sb_card and sb_common -&n; * Jeff Garzik &lt;jgarzik@mandrakesoft.com&gt;&n; *&n; * 2000/09/18 - got rid of attach_uart401&n; * Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;sound_firmware.h&quot;
macro_line|#include &quot;mpu401.h&quot;
macro_line|#include &quot;sb_mixer.h&quot;
macro_line|#include &quot;sb.h&quot;
macro_line|#include &quot;sb_ess.h&quot;
multiline_comment|/*&n; * global module flag&n; */
DECL|variable|sb_be_quiet
r_int
id|sb_be_quiet
op_assign
l_int|0
suffix:semicolon
DECL|variable|detected_devc
r_static
id|sb_devc
op_star
id|detected_devc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* For communication from probe to init */
DECL|variable|last_devc
r_static
id|sb_devc
op_star
id|last_devc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* For MPU401 initialization */
DECL|variable|jazz_irq_bits
r_static
r_int
r_char
id|jazz_irq_bits
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|3
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|2
comma
l_int|5
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|6
)brace
suffix:semicolon
DECL|variable|jazz_dma_bits
r_static
r_int
r_char
id|jazz_dma_bits
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|4
)brace
suffix:semicolon
DECL|variable|smw_free
r_void
op_star
id|smw_free
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; * Jazz16 chipset specific control variables&n; */
DECL|variable|jazz16_base
r_static
r_int
id|jazz16_base
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Not detected */
DECL|variable|jazz16_bits
r_static
r_int
r_char
id|jazz16_bits
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* I/O relocation bits */
multiline_comment|/*&n; * Logitech Soundman Wave specific initialization code&n; */
macro_line|#ifdef SMW_MIDI0001_INCLUDED
macro_line|#include &quot;smw-midi0001.h&quot;
macro_line|#else
DECL|variable|smw_ucode
r_static
r_int
r_char
op_star
id|smw_ucode
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|smw_ucodeLen
r_static
r_int
id|smw_ucodeLen
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|variable|last_sb
id|sb_devc
op_star
id|last_sb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Last sb loaded */
DECL|function|sb_dsp_command
r_int
id|sb_dsp_command
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_int
r_char
id|val
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|limit
suffix:semicolon
id|limit
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
multiline_comment|/* Timeout */
multiline_comment|/*&n;&t; * Note! the i&lt;500000 is an emergency exit. The sb_dsp_command() is sometimes&n;&t; * called while interrupts are disabled. This means that the timer is&n;&t; * disabled also. However the timeout situation is a abnormal condition.&n;&t; * Normally the DSP should be ready to accept commands after just couple of&n;&t; * loops.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
template_param
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|DSP_STATUS
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
id|outb
c_func
(paren
(paren
id|val
)paren
comma
id|DSP_COMMAND
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sound Blaster:  DSP command(%x) timeout.&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sb_dsp_get_byte
r_int
id|sb_dsp_get_byte
c_func
(paren
id|sb_devc
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
r_return
id|inb
c_func
(paren
id|DSP_READ
)paren
suffix:semicolon
)brace
r_return
l_int|0xffff
suffix:semicolon
)brace
DECL|function|sb_intr
r_static
r_void
id|sb_intr
(paren
id|sb_devc
op_star
id|devc
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
r_char
id|src
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MDL_SB16
)paren
(brace
id|src
op_assign
id|sb_getmixer
c_func
(paren
id|devc
comma
id|IRQ_STAT
)paren
suffix:semicolon
multiline_comment|/* Interrupt source register */
r_if
c_cond
(paren
id|src
op_amp
l_int|4
)paren
multiline_comment|/* MPU401 interrupt */
r_if
c_cond
(paren
id|devc-&gt;midi_irq_cookie
)paren
(brace
id|uart401intr
c_func
(paren
id|devc-&gt;irq
comma
id|devc-&gt;midi_irq_cookie
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|src
op_amp
l_int|3
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Not a DSP interrupt */
)brace
r_if
c_cond
(paren
id|devc-&gt;intr_active
op_logical_and
(paren
op_logical_neg
id|devc-&gt;fullduplex
op_logical_or
(paren
id|src
op_amp
l_int|0x01
)paren
)paren
)paren
(brace
r_switch
c_cond
(paren
id|devc-&gt;irq_mode
)paren
(brace
r_case
id|IMODE_OUTPUT
suffix:colon
id|DMAbuf_outputintr
c_func
(paren
id|devc-&gt;dev
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INPUT
suffix:colon
id|DMAbuf_inputintr
c_func
(paren
id|devc-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INIT
suffix:colon
r_break
suffix:semicolon
r_case
id|IMODE_MIDI
suffix:colon
id|sb_midi_interrupt
c_func
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* printk(KERN_WARN &quot;Sound Blaster: Unexpected interrupt&bslash;n&quot;); */
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|devc-&gt;intr_active_16
op_logical_and
(paren
id|src
op_amp
l_int|0x02
)paren
)paren
(brace
r_switch
c_cond
(paren
id|devc-&gt;irq_mode_16
)paren
(brace
r_case
id|IMODE_OUTPUT
suffix:colon
id|DMAbuf_outputintr
c_func
(paren
id|devc-&gt;dev
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INPUT
suffix:colon
id|DMAbuf_inputintr
c_func
(paren
id|devc-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INIT
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* printk(KERN_WARN &quot;Sound Blaster: Unexpected interrupt&bslash;n&quot;); */
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Acknowledge interrupts &n;&t; */
r_if
c_cond
(paren
id|src
op_amp
l_int|0x01
)paren
id|status
op_assign
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MDL_SB16
op_logical_and
id|src
op_amp
l_int|0x02
)paren
id|status
op_assign
id|inb
c_func
(paren
id|DSP_DATA_AVL16
)paren
suffix:semicolon
)brace
DECL|function|pci_intr
r_static
r_void
id|pci_intr
c_func
(paren
id|sb_devc
op_star
id|devc
)paren
(brace
r_int
id|src
op_assign
id|inb
c_func
(paren
id|devc-&gt;pcibase
op_plus
l_int|0x1A
)paren
suffix:semicolon
id|src
op_and_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|src
)paren
(brace
id|sb_intr
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
)brace
DECL|function|sbintr
r_static
r_void
id|sbintr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
id|sb_devc
op_star
id|devc
op_assign
id|dev_id
suffix:semicolon
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|devc-&gt;model
)paren
(brace
r_case
id|MDL_ESSPCI
suffix:colon
id|pci_intr
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDL_ESS
suffix:colon
id|ess_intr
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sb_intr
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|sb_dsp_reset
r_int
id|sb_dsp_reset
c_func
(paren
id|sb_devc
op_star
id|devc
)paren
(brace
r_int
id|loopc
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Entered sb_dsp_reset()&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MDL_ESS
)paren
r_return
id|ess_dsp_reset
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* This is only for non-ESS chips */
id|outb
c_func
(paren
l_int|1
comma
id|DSP_RESET
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|DSP_RESET
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loopc
op_assign
l_int|0
suffix:semicolon
id|loopc
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
suffix:semicolon
id|loopc
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_READ
)paren
op_ne
l_int|0xAA
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;sb: No response to RESET&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Sorry */
)brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;sb_dsp_reset() OK&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|dsp_get_vers
r_static
r_void
id|dsp_get_vers
c_func
(paren
id|sb_devc
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Entered dsp_get_vers()&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|devc-&gt;major
op_assign
id|devc-&gt;minor
op_assign
l_int|0
suffix:semicolon
id|sb_dsp_command
c_func
(paren
id|devc
comma
l_int|0xe1
)paren
suffix:semicolon
multiline_comment|/* Get version */
r_for
c_loop
(paren
id|i
op_assign
l_int|100000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;major
op_eq
l_int|0
)paren
id|devc-&gt;major
op_assign
id|inb
c_func
(paren
id|DSP_READ
)paren
suffix:semicolon
r_else
(brace
id|devc-&gt;minor
op_assign
id|inb
c_func
(paren
id|DSP_READ
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;DSP version %d.%02d&bslash;n&quot;
comma
id|devc-&gt;major
comma
id|devc-&gt;minor
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sb16_set_dma_hw
r_static
r_int
id|sb16_set_dma_hw
c_func
(paren
id|sb_devc
op_star
id|devc
)paren
(brace
r_int
id|bits
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;dma8
op_ne
l_int|0
op_logical_and
id|devc-&gt;dma8
op_ne
l_int|1
op_logical_and
id|devc-&gt;dma8
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SB16: Invalid 8 bit DMA (%d)&bslash;n&quot;
comma
id|devc-&gt;dma8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bits
op_assign
(paren
l_int|1
op_lshift
id|devc-&gt;dma8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;dma16
op_ge
l_int|5
op_logical_and
id|devc-&gt;dma16
op_le
l_int|7
)paren
id|bits
op_or_assign
(paren
l_int|1
op_lshift
id|devc-&gt;dma16
)paren
suffix:semicolon
id|sb_setmixer
c_func
(paren
id|devc
comma
id|DMA_NR
comma
id|bits
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sb16_set_mpu_port
r_static
r_void
id|sb16_set_mpu_port
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
multiline_comment|/*&n;&t; * This routine initializes new MIDI port setup register of SB Vibra (CT2502).&n;&t; */
r_int
r_char
id|bits
op_assign
id|sb_getmixer
c_func
(paren
id|devc
comma
l_int|0x84
)paren
op_amp
op_complement
l_int|0x06
suffix:semicolon
r_switch
c_cond
(paren
id|hw_config-&gt;io_base
)paren
(brace
r_case
l_int|0x300
suffix:colon
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x84
comma
id|bits
op_or
l_int|0x04
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x330
suffix:colon
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x84
comma
id|bits
op_or
l_int|0x00
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x84
comma
id|bits
op_or
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Disable MPU */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SB16: Invalid MIDI I/O port %x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
)brace
)brace
DECL|function|sb16_set_irq_hw
r_static
r_int
id|sb16_set_irq_hw
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_int
id|level
)paren
(brace
r_int
id|ival
suffix:semicolon
r_switch
c_cond
(paren
id|level
)paren
(brace
r_case
l_int|5
suffix:colon
id|ival
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|ival
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|ival
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|ival
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SB16: Invalid IRQ%d&bslash;n&quot;
comma
id|level
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sb_setmixer
c_func
(paren
id|devc
comma
id|IRQ_NR
comma
id|ival
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|relocate_Jazz16
r_static
r_void
id|relocate_Jazz16
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|bits
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|jazz16_base
op_ne
l_int|0
op_logical_and
id|jazz16_base
op_ne
id|hw_config-&gt;io_base
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|hw_config-&gt;io_base
)paren
(brace
r_case
l_int|0x220
suffix:colon
id|bits
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x240
suffix:colon
id|bits
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x260
suffix:colon
id|bits
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
id|bits
op_assign
id|jazz16_bits
op_assign
id|bits
op_lshift
l_int|5
suffix:semicolon
id|jazz16_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Magic wake up sequence by writing to 0x201 (aka Joystick port)&n;&t; */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0xAF
)paren
comma
l_int|0x201
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0x50
)paren
comma
l_int|0x201
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|bits
)paren
comma
l_int|0x201
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|init_Jazz16
r_static
r_int
id|init_Jazz16
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_char
id|name
(braket
l_int|100
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * First try to check that the card has Jazz16 chip. It identifies itself&n;&t; * by returning 0x12 as response to DSP command 0xfa.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
c_func
(paren
id|devc
comma
l_int|0xfa
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_get_byte
c_func
(paren
id|devc
)paren
op_ne
l_int|0x12
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * OK so far. Now configure the IRQ and DMA channel used by the card.&n;&t; */
r_if
c_cond
(paren
id|hw_config-&gt;irq
template_param
l_int|15
op_logical_or
id|jazz_irq_bits
(braket
id|hw_config-&gt;irq
)braket
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Jazz16: Invalid interrupt (IRQ%d)&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;dma
template_param
l_int|3
op_logical_or
id|jazz_dma_bits
(braket
id|hw_config-&gt;dma
)braket
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Jazz16: Invalid 8 bit DMA (DMA%d)&bslash;n&quot;
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;dma2
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Jazz16: No 16 bit DMA channel defined&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;dma2
template_param
l_int|7
op_logical_or
id|jazz_dma_bits
(braket
id|hw_config-&gt;dma2
)braket
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Jazz16: Invalid 16 bit DMA (DMA%d)&bslash;n&quot;
comma
id|hw_config-&gt;dma2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|devc-&gt;dma16
op_assign
id|hw_config-&gt;dma2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
c_func
(paren
id|devc
comma
l_int|0xfb
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
c_func
(paren
id|devc
comma
id|jazz_dma_bits
(braket
id|hw_config-&gt;dma
)braket
op_or
(paren
id|jazz_dma_bits
(braket
id|hw_config-&gt;dma2
)braket
op_lshift
l_int|4
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
c_func
(paren
id|devc
comma
id|jazz_irq_bits
(braket
id|hw_config-&gt;irq
)braket
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Now we have configured a standard Jazz16 device. &n;&t; */
id|devc-&gt;model
op_assign
id|MDL_JAZZ
suffix:semicolon
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;Jazz16&quot;
)paren
suffix:semicolon
id|hw_config-&gt;name
op_assign
l_string|&quot;Jazz16&quot;
suffix:semicolon
id|devc-&gt;caps
op_or_assign
id|SB_NO_MIDI
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|relocate_ess1688
r_static
r_void
id|relocate_ess1688
c_func
(paren
id|sb_devc
op_star
id|devc
)paren
(brace
r_int
r_char
id|bits
suffix:semicolon
r_switch
c_cond
(paren
id|devc-&gt;base
)paren
(brace
r_case
l_int|0x220
suffix:colon
id|bits
op_assign
l_int|0x04
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x230
suffix:colon
id|bits
op_assign
l_int|0x05
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x240
suffix:colon
id|bits
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x250
suffix:colon
id|bits
op_assign
l_int|0x07
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
multiline_comment|/* Wrong port */
)brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Doing ESS1688 address selection&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * ES1688 supports two alternative ways for software address config.&n;&t; * First try the so called Read-Sequence-Key method.&n;&t; */
multiline_comment|/* Reset the sequence logic */
id|inb
c_func
(paren
l_int|0x229
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x229
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x229
)paren
suffix:semicolon
multiline_comment|/* Perform the read sequence */
id|inb
c_func
(paren
l_int|0x22b
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x229
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x22b
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x229
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x229
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x22b
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x229
)paren
suffix:semicolon
multiline_comment|/* Select the base address by reading from it. Then probe using the port. */
id|inb
c_func
(paren
id|devc-&gt;base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_reset
c_func
(paren
id|devc
)paren
)paren
multiline_comment|/* Bingo */
r_return
suffix:semicolon
macro_line|#if 0&t;&t;&t;&t;/* This causes system lockups (Nokia 386/25 at least) */
multiline_comment|/*&n;&t; * The last resort is the system control register method.&n;&t; */
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
l_int|0xfb
)paren
suffix:semicolon
multiline_comment|/* 0xFB is the unlock register */
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
l_int|0xe0
)paren
suffix:semicolon
multiline_comment|/* Select index 0 */
id|outb
c_func
(paren
(paren
id|bits
)paren
comma
l_int|0xe1
)paren
suffix:semicolon
multiline_comment|/* Write the config bits */
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
l_int|0xf9
)paren
suffix:semicolon
multiline_comment|/* 0xFB is the lock register */
macro_line|#endif
)brace
DECL|function|sb_dsp_detect
r_int
id|sb_dsp_detect
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
comma
r_int
id|pci
comma
r_int
id|pciio
comma
r_struct
id|sb_module_options
op_star
id|sbmo
)paren
(brace
id|sb_devc
id|sb_info
suffix:semicolon
id|sb_devc
op_star
id|devc
op_assign
op_amp
id|sb_info
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|sb_info
comma
l_int|0
comma
r_sizeof
(paren
id|sb_info
)paren
)paren
suffix:semicolon
multiline_comment|/* Zero everything */
multiline_comment|/* Copy module options in place */
r_if
c_cond
(paren
id|sbmo
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|devc-&gt;sbmo
comma
id|sbmo
comma
r_sizeof
(paren
r_struct
id|sb_module_options
)paren
)paren
suffix:semicolon
)brace
id|sb_info.my_mididev
op_assign
op_minus
l_int|1
suffix:semicolon
id|sb_info.my_mixerdev
op_assign
op_minus
l_int|1
suffix:semicolon
id|sb_info.dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize variables &n;&t; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;sb_dsp_detect(%x) entered&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
)paren
)paren
(brace
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sb: I/O region in use.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|devc-&gt;type
op_assign
id|hw_config-&gt;card_subtype
suffix:semicolon
id|devc-&gt;base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|devc-&gt;irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|devc-&gt;dma8
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|devc-&gt;dma16
op_assign
op_minus
l_int|1
suffix:semicolon
id|devc-&gt;pcibase
op_assign
id|pciio
suffix:semicolon
r_if
c_cond
(paren
id|pci
op_eq
id|SB_PCI_ESSMAESTRO
)paren
(brace
id|devc-&gt;model
op_assign
id|MDL_ESSPCI
suffix:semicolon
id|devc-&gt;caps
op_or_assign
id|SB_PCI_IRQ
suffix:semicolon
id|hw_config-&gt;driver_use_1
op_or_assign
id|SB_PCI_IRQ
suffix:semicolon
id|hw_config-&gt;card_subtype
op_assign
id|MDL_ESSPCI
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci
op_eq
id|SB_PCI_YAMAHA
)paren
(brace
id|devc-&gt;model
op_assign
id|MDL_YMPCI
suffix:semicolon
id|devc-&gt;caps
op_or_assign
id|SB_PCI_IRQ
suffix:semicolon
id|hw_config-&gt;driver_use_1
op_or_assign
id|SB_PCI_IRQ
suffix:semicolon
id|hw_config-&gt;card_subtype
op_assign
id|MDL_YMPCI
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Yamaha PCI mode.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;sbmo.acer
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x09
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x09
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x09
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x0b
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x09
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x0b
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x09
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x09
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x0b
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x09
)paren
suffix:semicolon
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|0x00
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Detect the device&n;&t; */
r_if
c_cond
(paren
id|sb_dsp_reset
c_func
(paren
id|devc
)paren
)paren
id|dsp_get_vers
c_func
(paren
id|devc
)paren
suffix:semicolon
r_else
id|devc-&gt;major
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;type
op_eq
l_int|0
op_logical_or
id|devc-&gt;type
op_eq
id|MDL_JAZZ
op_logical_or
id|devc-&gt;type
op_eq
id|MDL_SMW
)paren
r_if
c_cond
(paren
id|devc-&gt;major
op_eq
l_int|0
op_logical_or
(paren
id|devc-&gt;major
op_eq
l_int|3
op_logical_and
id|devc-&gt;minor
op_eq
l_int|1
)paren
)paren
id|relocate_Jazz16
c_func
(paren
id|devc
comma
id|hw_config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;major
op_eq
l_int|0
op_logical_and
(paren
id|devc-&gt;type
op_eq
id|MDL_ESS
op_logical_or
id|devc-&gt;type
op_eq
l_int|0
)paren
)paren
id|relocate_ess1688
c_func
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_reset
c_func
(paren
id|devc
)paren
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;SB reset failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sb: dsp reset failed.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;major
op_eq
l_int|0
)paren
id|dsp_get_vers
c_func
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;major
op_eq
l_int|3
op_logical_and
id|devc-&gt;minor
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;type
op_eq
id|MDL_AZTECH
)paren
multiline_comment|/* SG Washington? */
(brace
r_if
c_cond
(paren
id|sb_dsp_command
c_func
(paren
id|devc
comma
l_int|0x09
)paren
)paren
r_if
c_cond
(paren
id|sb_dsp_command
c_func
(paren
id|devc
comma
l_int|0x00
)paren
)paren
multiline_comment|/* Enter WSS mode */
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Have some delay */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
id|inb
c_func
(paren
id|DSP_DATA_AVAIL
)paren
suffix:semicolon
id|devc-&gt;caps
op_assign
id|SB_NO_AUDIO
op_or
id|SB_NO_MIDI
suffix:semicolon
multiline_comment|/* Mixer only */
id|devc-&gt;model
op_assign
id|MDL_AZTECH
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|devc-&gt;type
op_eq
id|MDL_ESSPCI
)paren
(brace
id|devc-&gt;model
op_assign
id|MDL_ESSPCI
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;type
op_eq
id|MDL_YMPCI
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;YMPCI selected&bslash;n&quot;
)paren
suffix:semicolon
id|devc-&gt;model
op_assign
id|MDL_YMPCI
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Save device information for sb_dsp_init()&n;&t; */
id|detected_devc
op_assign
(paren
id|sb_devc
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|sb_devc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|detected_devc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sb: Can&squot;t allocate memory for device information&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|detected_devc
comma
(paren
r_char
op_star
)paren
id|devc
comma
r_sizeof
(paren
id|sb_devc
)paren
)paren
suffix:semicolon
id|MDB
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SB %d.%02d detected OK (%x)&bslash;n&quot;
comma
id|devc-&gt;major
comma
id|devc-&gt;minor
comma
id|hw_config-&gt;io_base
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sb_dsp_init
r_int
id|sb_dsp_init
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
comma
r_struct
id|module
op_star
id|owner
)paren
(brace
id|sb_devc
op_star
id|devc
suffix:semicolon
r_char
id|name
(braket
l_int|100
)braket
suffix:semicolon
r_extern
r_int
id|sb_be_quiet
suffix:semicolon
r_int
id|mixer22
comma
id|mixer30
suffix:semicolon
multiline_comment|/*&n; * Check if we had detected a SB device earlier&n; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;sb_dsp_init(%x) entered&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
)paren
suffix:semicolon
id|name
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|detected_devc
op_eq
l_int|NULL
)paren
(brace
id|MDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;No detected device&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|devc
op_assign
id|detected_devc
suffix:semicolon
id|detected_devc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;base
op_ne
id|hw_config-&gt;io_base
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;I/O port mismatch&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now continue initialization of the device&n;&t; */
id|devc-&gt;caps
op_assign
id|hw_config-&gt;driver_use_1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|devc-&gt;caps
op_amp
id|SB_NO_AUDIO
)paren
op_logical_and
(paren
id|devc-&gt;caps
op_amp
id|SB_NO_MIDI
)paren
)paren
op_logical_and
id|hw_config-&gt;irq
OG
l_int|0
)paren
(brace
multiline_comment|/* IRQ setup */
multiline_comment|/*&n;&t;&t; *&t;ESS PCI cards do shared PCI IRQ stuff. Since they&n;&t;&t; *&t;will get shared PCI irq lines we must cope.&n;&t;&t; */
r_int
id|i
op_assign
(paren
id|devc-&gt;caps
op_amp
id|SB_PCI_IRQ
)paren
ques
c_cond
id|SA_SHIRQ
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hw_config-&gt;irq
comma
id|sbintr
comma
id|i
comma
l_string|&quot;soundblaster&quot;
comma
id|devc
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SB: Can&squot;t allocate IRQ%d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|devc-&gt;irq_ok
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;major
op_eq
l_int|4
)paren
r_if
c_cond
(paren
op_logical_neg
id|sb16_set_irq_hw
c_func
(paren
id|devc
comma
id|devc-&gt;irq
)paren
)paren
multiline_comment|/* Unsupported IRQ */
(brace
id|free_irq
c_func
(paren
id|devc-&gt;irq
comma
id|devc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|devc-&gt;type
op_eq
l_int|0
op_logical_or
id|devc-&gt;type
op_eq
id|MDL_ESS
)paren
op_logical_and
id|devc-&gt;major
op_eq
l_int|3
op_logical_and
id|devc-&gt;minor
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Handle various chipsets which claim they are SB Pro compatible */
r_if
c_cond
(paren
(paren
id|devc-&gt;type
op_ne
l_int|0
op_logical_and
id|devc-&gt;type
op_ne
id|MDL_ESS
)paren
op_logical_or
op_logical_neg
id|ess_init
c_func
(paren
id|devc
comma
id|hw_config
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|devc-&gt;type
op_ne
l_int|0
op_logical_and
id|devc-&gt;type
op_ne
id|MDL_JAZZ
op_logical_and
id|devc-&gt;type
op_ne
id|MDL_SMW
)paren
op_logical_or
op_logical_neg
id|init_Jazz16
c_func
(paren
id|devc
comma
id|hw_config
)paren
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;This is a genuine SB Pro&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|devc-&gt;major
op_eq
l_int|4
op_logical_and
id|devc-&gt;minor
op_le
l_int|11
)paren
multiline_comment|/* Won&squot;t work */
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
r_else
(brace
r_int
id|n
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|3
op_logical_and
id|devc-&gt;irq_ok
op_eq
l_int|0
suffix:semicolon
id|n
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sb_dsp_command
c_func
(paren
id|devc
comma
l_int|0xf2
)paren
)paren
multiline_comment|/* Cause interrupt immediately */
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|devc-&gt;irq_ok
op_logical_and
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|devc-&gt;irq_ok
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sb: Interrupt test on IRQ%d failed - Probable IRQ conflict&bslash;n&quot;
comma
id|devc-&gt;irq
)paren
suffix:semicolon
r_else
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;IRQ test OK (IRQ%d)&bslash;n&quot;
comma
id|devc-&gt;irq
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* IRQ setup */
id|request_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
comma
l_string|&quot;soundblaster&quot;
)paren
suffix:semicolon
id|last_sb
op_assign
id|devc
suffix:semicolon
r_switch
c_cond
(paren
id|devc-&gt;major
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* SB 1.0 or 1.5 */
id|devc-&gt;model
op_assign
id|hw_config-&gt;card_subtype
op_assign
id|MDL_SB1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* SB 2.x */
r_if
c_cond
(paren
id|devc-&gt;minor
op_eq
l_int|0
)paren
id|devc-&gt;model
op_assign
id|hw_config-&gt;card_subtype
op_assign
id|MDL_SB2
suffix:semicolon
r_else
id|devc-&gt;model
op_assign
id|hw_config-&gt;card_subtype
op_assign
id|MDL_SB201
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* SB Pro and most clones */
r_switch
c_cond
(paren
id|devc-&gt;model
)paren
(brace
r_case
l_int|0
suffix:colon
id|devc-&gt;model
op_assign
id|hw_config-&gt;card_subtype
op_assign
id|MDL_SBPRO
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;name
op_eq
l_int|NULL
)paren
id|hw_config-&gt;name
op_assign
l_string|&quot;Sound Blaster Pro (8 BIT ONLY)&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDL_ESS
suffix:colon
id|ess_dsp_init
c_func
(paren
id|devc
comma
id|hw_config
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|devc-&gt;model
op_assign
id|hw_config-&gt;card_subtype
op_assign
id|MDL_SB16
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t; * ALS007 and ALS100 return DSP version 4.2 and have 2 post-reset !=0&n;&t;&t;&t; * registers at 0x3c and 0x4c (output ctrl registers on ALS007) whereas&n;&t;&t;&t; * a &quot;standard&quot; SB16 doesn&squot;t have a register at 0x4c.  ALS100 actively&n;&t;&t;&t; * updates register 0x22 whenever 0x30 changes, as per the SB16 spec.&n;&t;&t;&t; * Since ALS007 doesn&squot;t, this can be used to differentiate the 2 cards.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|devc-&gt;minor
op_eq
l_int|2
)paren
op_logical_and
id|sb_getmixer
c_func
(paren
id|devc
comma
l_int|0x3c
)paren
op_logical_and
id|sb_getmixer
c_func
(paren
id|devc
comma
l_int|0x4c
)paren
)paren
(brace
id|mixer30
op_assign
id|sb_getmixer
c_func
(paren
id|devc
comma
l_int|0x30
)paren
suffix:semicolon
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x22
comma
(paren
id|mixer22
op_assign
id|sb_getmixer
c_func
(paren
id|devc
comma
l_int|0x22
)paren
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x30
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* ALS100 will force 0x30 to 0xf8 like SB16; ALS007 will allow 0xff. */
multiline_comment|/* Register 0x22 &amp; 0xf0 on ALS100 == 0xf0; on ALS007 it == 0x10.     */
r_if
c_cond
(paren
(paren
id|sb_getmixer
c_func
(paren
id|devc
comma
l_int|0x30
)paren
op_ne
l_int|0xff
)paren
op_logical_or
(paren
(paren
id|sb_getmixer
c_func
(paren
id|devc
comma
l_int|0x22
)paren
op_amp
l_int|0xf0
)paren
op_ne
l_int|0x10
)paren
)paren
(brace
id|devc-&gt;submodel
op_assign
id|SUBMDL_ALS100
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;name
op_eq
l_int|NULL
)paren
id|hw_config-&gt;name
op_assign
l_string|&quot;Sound Blaster 16 (ALS-100)&quot;
suffix:semicolon
)brace
r_else
(brace
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x3c
comma
l_int|0x1f
)paren
suffix:semicolon
multiline_comment|/* Enable all inputs */
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x4c
comma
l_int|0x1f
)paren
suffix:semicolon
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x22
comma
id|mixer22
)paren
suffix:semicolon
multiline_comment|/* Restore 0x22 to original value */
id|devc-&gt;submodel
op_assign
id|SUBMDL_ALS007
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;name
op_eq
l_int|NULL
)paren
id|hw_config-&gt;name
op_assign
l_string|&quot;Sound Blaster 16 (ALS-007)&quot;
suffix:semicolon
)brace
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x30
comma
id|mixer30
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hw_config-&gt;name
op_eq
l_int|NULL
)paren
id|hw_config-&gt;name
op_assign
l_string|&quot;Sound Blaster 16&quot;
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;dma2
op_eq
op_minus
l_int|1
)paren
id|devc-&gt;dma16
op_assign
id|devc-&gt;dma8
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hw_config-&gt;dma2
template_param
l_int|7
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SB16: Bad or missing 16 bit DMA channel&bslash;n&quot;
)paren
suffix:semicolon
id|devc-&gt;dma16
op_assign
id|devc-&gt;dma8
suffix:semicolon
)brace
r_else
id|devc-&gt;dma16
op_assign
id|hw_config-&gt;dma2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb16_set_dma_hw
c_func
(paren
id|devc
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|devc-&gt;irq
comma
id|devc
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|devc-&gt;caps
op_or_assign
id|SB_NO_MIDI
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;caps
op_amp
id|SB_NO_MIXER
)paren
)paren
r_if
c_cond
(paren
id|devc-&gt;major
op_eq
l_int|3
op_logical_or
id|devc-&gt;major
op_eq
l_int|4
)paren
id|sb_mixer_init
c_func
(paren
id|devc
comma
id|owner
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;caps
op_amp
id|SB_NO_MIDI
)paren
)paren
id|sb_dsp_midi_init
c_func
(paren
id|devc
comma
id|owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;name
op_eq
l_int|NULL
)paren
id|hw_config-&gt;name
op_assign
l_string|&quot;Sound Blaster (8 BIT/MONO ONLY)&quot;
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%s (%d.%02d)&quot;
comma
id|hw_config-&gt;name
comma
id|devc-&gt;major
comma
id|devc-&gt;minor
)paren
suffix:semicolon
id|conf_printf
c_func
(paren
id|name
comma
id|hw_config
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Assuming that a sound card is Sound Blaster (compatible) is the most common&n;&t; * configuration error and the mother of all problems. Usually sound cards&n;&t; * emulate SB Pro but in addition they have a 16 bit native mode which should be&n;&t; * used in Unix. See Readme.cards for more information about configuring OSS/Free&n;&t; * properly.&n;&t; */
r_if
c_cond
(paren
id|devc-&gt;model
op_le
id|MDL_SBPRO
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;major
op_eq
l_int|3
op_logical_and
id|devc-&gt;minor
op_ne
l_int|1
)paren
multiline_comment|/* &quot;True&quot; SB Pro should have v3.1 (rare ones may have 3.2). */
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;This sound card may not be fully Sound Blaster Pro compatible.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;In many cases there is another way to configure OSS so that&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;it works properly with OSS (for example in 16 bit mode).&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Please ignore this message if you _really_ have a SB Pro.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|sb_be_quiet
op_logical_and
id|devc-&gt;model
op_eq
id|MDL_SBPRO
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SB DSP version is just %d.%02d which means that your card is&bslash;n&quot;
comma
id|devc-&gt;major
comma
id|devc-&gt;minor
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;several years old (8 bit only device) or alternatively the sound driver&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;is incorrectly configured.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|hw_config-&gt;card_subtype
op_assign
id|devc-&gt;model
suffix:semicolon
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_assign
id|devc-&gt;dev
suffix:semicolon
id|last_devc
op_assign
id|devc
suffix:semicolon
multiline_comment|/* For SB MPU detection */
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;caps
op_amp
id|SB_NO_AUDIO
)paren
op_logical_and
id|devc-&gt;dma8
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sound_alloc_dma
c_func
(paren
id|devc-&gt;dma8
comma
l_string|&quot;SoundBlaster8&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sound Blaster: Can&squot;t allocate 8 bit DMA channel %d&bslash;n&quot;
comma
id|devc-&gt;dma8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;dma16
op_ge
l_int|0
op_logical_and
id|devc-&gt;dma16
op_ne
id|devc-&gt;dma8
)paren
(brace
r_if
c_cond
(paren
id|sound_alloc_dma
c_func
(paren
id|devc-&gt;dma16
comma
l_string|&quot;SoundBlaster16&quot;
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Sound Blaster:  can&squot;t allocate 16 bit DMA channel %d.&bslash;n&quot;
comma
id|devc-&gt;dma16
)paren
suffix:semicolon
)brace
id|sb_audio_init
c_func
(paren
id|devc
comma
id|name
comma
id|owner
)paren
suffix:semicolon
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_assign
id|devc-&gt;dev
suffix:semicolon
)brace
r_else
(brace
id|MDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Sound Blaster:  no audio devices found.&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sb_dsp_disable_midi
r_void
id|sb_dsp_disable_midi
c_func
(paren
r_int
id|io_base
)paren
(brace
)brace
DECL|function|sb_dsp_disable_recording
r_void
id|sb_dsp_disable_recording
c_func
(paren
r_int
id|io_base
)paren
(brace
)brace
multiline_comment|/* if (sbmpu) below we allow mpu401 to manage the midi devs&n;   otherwise we have to unload them. (Andrzej Krzysztofowicz) */
DECL|function|sb_dsp_unload
r_void
id|sb_dsp_unload
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
comma
r_int
id|sbmpu
)paren
(brace
id|sb_devc
op_star
id|devc
suffix:semicolon
id|devc
op_assign
id|audio_devs
(braket
id|hw_config-&gt;slots
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|devc
op_logical_and
id|devc-&gt;base
op_eq
id|hw_config-&gt;io_base
)paren
(brace
r_if
c_cond
(paren
(paren
id|devc-&gt;model
op_amp
id|MDL_ESS
)paren
op_logical_and
id|devc-&gt;pcibase
)paren
id|release_region
c_func
(paren
id|devc-&gt;pcibase
comma
l_int|8
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|devc-&gt;base
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;caps
op_amp
id|SB_NO_AUDIO
)paren
)paren
(brace
id|sound_free_dma
c_func
(paren
id|devc-&gt;dma8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;dma16
op_ge
l_int|0
)paren
id|sound_free_dma
c_func
(paren
id|devc-&gt;dma16
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;caps
op_amp
id|SB_NO_AUDIO
op_logical_and
id|devc-&gt;caps
op_amp
id|SB_NO_MIDI
)paren
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;irq
OG
l_int|0
)paren
id|free_irq
c_func
(paren
id|devc-&gt;irq
comma
id|devc
)paren
suffix:semicolon
id|sb_mixer_unload
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t have to do this bit any more the UART401 is its own&n;&t;&t;&t;&t;master  -- Krzysztof Halasa */
multiline_comment|/* But we have to do it, if UART401 is not detected */
r_if
c_cond
(paren
op_logical_neg
id|sbmpu
)paren
id|sound_unload_mididev
c_func
(paren
id|devc-&gt;my_mididev
)paren
suffix:semicolon
id|sound_unload_audiodev
c_func
(paren
id|devc-&gt;dev
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
r_else
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|detected_devc
)paren
(brace
id|kfree
c_func
(paren
id|detected_devc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Mixer access routines&n; *&n; *&t;ES1887 modifications: some mixer registers reside in the&n; *&t;range above 0xa0. These must be accessed in another way.&n; */
DECL|function|sb_setmixer
r_void
id|sb_setmixer
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_int
r_int
id|port
comma
r_int
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MDL_ESS
)paren
r_return
id|ess_setmixer
(paren
id|devc
comma
id|port
comma
id|value
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|port
op_amp
l_int|0xff
)paren
)paren
comma
id|MIXER_ADDR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|value
op_amp
l_int|0xff
)paren
)paren
comma
id|MIXER_DATA
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sb_getmixer
r_int
r_int
id|sb_getmixer
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_int
r_int
id|port
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MDL_ESS
)paren
r_return
id|ess_getmixer
(paren
id|devc
comma
id|port
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|port
op_amp
l_int|0xff
)paren
)paren
comma
id|MIXER_ADDR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|MIXER_DATA
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|sb_chgmixer
r_void
id|sb_chgmixer
(paren
id|sb_devc
op_star
id|devc
comma
r_int
r_int
id|reg
comma
r_int
r_int
id|mask
comma
r_int
r_int
id|val
)paren
(brace
r_int
id|value
suffix:semicolon
id|value
op_assign
id|sb_getmixer
c_func
(paren
id|devc
comma
id|reg
)paren
suffix:semicolon
id|value
op_assign
(paren
id|value
op_amp
op_complement
id|mask
)paren
op_or
(paren
id|val
op_amp
id|mask
)paren
suffix:semicolon
id|sb_setmixer
c_func
(paren
id|devc
comma
id|reg
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;MPU401 MIDI initialization.&n; */
DECL|function|smw_putmem
r_static
r_void
id|smw_putmem
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_int
id|base
comma
r_int
id|addr
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|addr
op_amp
l_int|0xff
)paren
comma
id|base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Low address bits */
id|outb
c_func
(paren
(paren
id|addr
op_rshift
l_int|8
)paren
comma
id|base
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* High address bits */
id|outb
c_func
(paren
(paren
id|val
)paren
comma
id|base
)paren
suffix:semicolon
multiline_comment|/* Data */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|smw_getmem
r_static
r_int
r_char
id|smw_getmem
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_int
id|base
comma
r_int
id|addr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|addr
op_amp
l_int|0xff
)paren
comma
id|base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Low address bits */
id|outb
c_func
(paren
(paren
id|addr
op_rshift
l_int|8
)paren
comma
id|base
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* High address bits */
id|val
op_assign
id|inb
c_func
(paren
id|base
)paren
suffix:semicolon
multiline_comment|/* Data */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|smw_midi_init
r_static
r_int
id|smw_midi_init
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|mpu_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
r_int
id|mp_base
op_assign
id|mpu_base
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* Microcontroller base */
r_int
id|i
suffix:semicolon
r_int
r_char
id|control
suffix:semicolon
multiline_comment|/*&n;&t; *  Reset the microcontroller so that the RAM can be accessed&n;&t; */
id|control
op_assign
id|inb
c_func
(paren
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|control
op_or
l_int|3
)paren
comma
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Set last two bits to 1 (?) */
id|outb
c_func
(paren
(paren
(paren
id|control
op_amp
l_int|0xfe
)paren
op_or
l_int|2
)paren
comma
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* xxxxxxx0 resets the mc */
id|mdelay
c_func
(paren
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Wait at least 1ms */
id|outb
c_func
(paren
(paren
id|control
op_amp
l_int|0xfc
)paren
comma
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* xxxxxx00 enables RAM */
multiline_comment|/*&n;&t; *  Detect microcontroller by probing the 8k RAM area&n;&t; */
id|smw_putmem
c_func
(paren
id|devc
comma
id|mp_base
comma
l_int|0
comma
l_int|0x00
)paren
suffix:semicolon
id|smw_putmem
c_func
(paren
id|devc
comma
id|mp_base
comma
l_int|1
comma
l_int|0xff
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smw_getmem
c_func
(paren
id|devc
comma
id|mp_base
comma
l_int|0
)paren
op_ne
l_int|0x00
op_logical_or
id|smw_getmem
c_func
(paren
id|devc
comma
id|mp_base
comma
l_int|1
)paren
op_ne
l_int|0xff
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;SM Wave: No microcontroller RAM detected (%02x, %02x)&bslash;n&quot;
comma
id|smw_getmem
c_func
(paren
id|devc
comma
id|mp_base
comma
l_int|0
)paren
comma
id|smw_getmem
c_func
(paren
id|devc
comma
id|mp_base
comma
l_int|1
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No RAM */
)brace
multiline_comment|/*&n;&t; *  There is RAM so assume it&squot;s really a SM Wave&n;&t; */
id|devc-&gt;model
op_assign
id|MDL_SMW
suffix:semicolon
id|smw_mixer_init
c_func
(paren
id|devc
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_if
c_cond
(paren
op_logical_neg
id|smw_ucode
)paren
(brace
id|smw_ucodeLen
op_assign
id|mod_firmware_load
c_func
(paren
l_string|&quot;/etc/sound/midi0001.bin&quot;
comma
(paren
r_void
op_star
)paren
op_amp
id|smw_ucode
)paren
suffix:semicolon
id|smw_free
op_assign
id|smw_ucode
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|smw_ucodeLen
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smw_ucodeLen
op_ne
l_int|8192
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SM Wave: Invalid microcode (MIDI0001.BIN) length&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *  Download microcode&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8192
suffix:semicolon
id|i
op_increment
)paren
id|smw_putmem
c_func
(paren
id|devc
comma
id|mp_base
comma
id|i
comma
id|smw_ucode
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *  Verify microcode&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8192
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|smw_getmem
c_func
(paren
id|devc
comma
id|mp_base
comma
id|i
)paren
op_ne
id|smw_ucode
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SM Wave: Microcode verification failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|control
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef SMW_SCSI_IRQ
multiline_comment|/*&n;&t; * Set the SCSI interrupt (IRQ2/9, IRQ3 or IRQ10). The SCSI interrupt&n;&t; * is disabled by default.&n;&t; *&n;&t; * FIXME - make this a module option&n;&t; *&n;&t; * BTW the Zilog 5380 SCSI controller is located at MPU base + 0x10.&n;&t; */
(brace
r_static
r_int
r_char
id|scsi_irq_bits
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|control
op_or_assign
id|scsi_irq_bits
(braket
id|SMW_SCSI_IRQ
)braket
op_lshift
l_int|6
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef SMW_OPL4_ENABLE
multiline_comment|/*&n;&t; *  Make the OPL4 chip visible on the PC bus at 0x380.&n;&t; *&n;&t; *  There is no need to enable this feature since this driver&n;&t; *  doesn&squot;t support OPL4 yet. Also there is no RAM in SM Wave so&n;&t; *  enabling OPL4 is pretty useless.&n;&t; */
id|control
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Uses IRQ12 if bit 0x20 == 0 */
multiline_comment|/* control |= 0x20;      Uncomment this if you want to use IRQ7 */
macro_line|#endif
id|outb
c_func
(paren
(paren
id|control
op_or
l_int|0x03
)paren
comma
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* xxxxxx11 restarts */
id|hw_config-&gt;name
op_assign
l_string|&quot;SoundMan Wave&quot;
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|init_Jazz16_midi
r_static
r_int
id|init_Jazz16_midi
c_func
(paren
id|sb_devc
op_star
id|devc
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|mpu_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
r_int
id|sb_base
op_assign
id|devc-&gt;base
suffix:semicolon
r_int
id|irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
r_int
r_char
id|bits
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
id|irq
op_mul_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|irq
template_param
l_int|15
op_logical_or
id|jazz_irq_bits
(braket
id|irq
)braket
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Jazz16: Invalid MIDI interrupt (IRQ%d)&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|sb_base
)paren
(brace
r_case
l_int|0x220
suffix:colon
id|bits
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x240
suffix:colon
id|bits
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x260
suffix:colon
id|bits
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
id|bits
op_assign
id|jazz16_bits
op_assign
id|bits
op_lshift
l_int|5
suffix:semicolon
r_switch
c_cond
(paren
id|mpu_base
)paren
(brace
r_case
l_int|0x310
suffix:colon
id|bits
op_or_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x320
suffix:colon
id|bits
op_or_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x330
suffix:colon
id|bits
op_or_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Jazz16: Invalid MIDI I/O port %x&bslash;n&quot;
comma
id|mpu_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Magic wake up sequence by writing to 0x201 (aka Joystick port)&n;&t; */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xAF
comma
l_int|0x201
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x50
comma
l_int|0x201
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bits
comma
l_int|0x201
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|hw_config-&gt;name
op_assign
l_string|&quot;Jazz16&quot;
suffix:semicolon
id|smw_midi_init
c_func
(paren
id|devc
comma
id|hw_config
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
c_func
(paren
id|devc
comma
l_int|0xfb
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
c_func
(paren
id|devc
comma
id|jazz_dma_bits
(braket
id|devc-&gt;dma8
)braket
op_or
(paren
id|jazz_dma_bits
(braket
id|devc-&gt;dma16
)braket
op_lshift
l_int|4
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
c_func
(paren
id|devc
comma
id|jazz_irq_bits
(braket
id|devc-&gt;irq
)braket
op_or
(paren
id|jazz_irq_bits
(braket
id|irq
)braket
op_lshift
l_int|4
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|probe_sbmpu
r_int
id|probe_sbmpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
comma
r_struct
id|module
op_star
id|owner
)paren
(brace
id|sb_devc
op_star
id|devc
op_assign
id|last_devc
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|last_devc
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|last_devc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;io_base
op_le
l_int|0
)paren
(brace
multiline_comment|/* The real vibra16 is fine about this, but we have to go&n;&t;&t;   wipe up after Cyrix again */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MDL_SB16
op_logical_and
id|devc-&gt;minor
op_ge
l_int|12
)paren
(brace
r_int
r_char
id|bits
op_assign
id|sb_getmixer
c_func
(paren
id|devc
comma
l_int|0x84
)paren
op_amp
op_complement
l_int|0x06
suffix:semicolon
id|sb_setmixer
c_func
(paren
id|devc
comma
l_int|0x84
comma
id|bits
op_or
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Disable MPU */
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_SOUND_MPU401)
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MDL_ESS
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sbmpu: I/O port conflict (%x)&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ess_midi_init
c_func
(paren
id|devc
comma
id|hw_config
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|hw_config-&gt;name
op_assign
l_string|&quot;ESS1xxx MPU&quot;
suffix:semicolon
id|devc-&gt;midi_irq_cookie
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|probe_mpu401
c_func
(paren
id|hw_config
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|attach_mpu401
c_func
(paren
id|hw_config
comma
id|owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_sb-&gt;irq
op_eq
op_minus
id|hw_config-&gt;irq
)paren
id|last_sb-&gt;midi_irq_cookie
op_assign
(paren
r_void
op_star
)paren
id|hw_config-&gt;slots
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|devc-&gt;model
)paren
(brace
r_case
id|MDL_SB16
suffix:colon
r_if
c_cond
(paren
id|hw_config-&gt;io_base
op_ne
l_int|0x300
op_logical_and
id|hw_config-&gt;io_base
op_ne
l_int|0x330
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SB16: Invalid MIDI port %x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|hw_config-&gt;name
op_assign
l_string|&quot;Sound Blaster 16&quot;
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;irq
OL
l_int|3
op_logical_or
id|hw_config-&gt;irq
op_eq
id|devc-&gt;irq
)paren
id|hw_config-&gt;irq
op_assign
op_minus
id|devc-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;minor
OG
l_int|12
)paren
multiline_comment|/* What is Vibra&squot;s version??? */
id|sb16_set_mpu_port
c_func
(paren
id|devc
comma
id|hw_config
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDL_JAZZ
suffix:colon
r_if
c_cond
(paren
id|hw_config-&gt;irq
OL
l_int|3
op_logical_or
id|hw_config-&gt;irq
op_eq
id|devc-&gt;irq
)paren
id|hw_config-&gt;irq
op_assign
op_minus
id|devc-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|init_Jazz16_midi
c_func
(paren
id|devc
comma
id|hw_config
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MDL_YMPCI
suffix:colon
id|hw_config-&gt;name
op_assign
l_string|&quot;Yamaha PCI Legacy&quot;
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Yamaha PCI legacy UART401 check.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
id|ret
op_assign
id|probe_uart401
c_func
(paren
id|hw_config
comma
id|owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|last_sb-&gt;midi_irq_cookie
op_assign
id|midi_devs
(braket
id|hw_config-&gt;slots
(braket
l_int|4
)braket
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|unload_sbmpu
r_void
id|unload_sbmpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
macro_line|#if defined(CONFIG_SOUND_MPU401)
r_if
c_cond
(paren
op_logical_neg
id|strcmp
(paren
id|hw_config-&gt;name
comma
l_string|&quot;ESS1xxx MPU&quot;
)paren
)paren
(brace
id|unload_mpu401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
id|unload_uart401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|variable|sb_dsp_init
id|EXPORT_SYMBOL
c_func
(paren
id|sb_dsp_init
)paren
suffix:semicolon
DECL|variable|sb_dsp_detect
id|EXPORT_SYMBOL
c_func
(paren
id|sb_dsp_detect
)paren
suffix:semicolon
DECL|variable|sb_dsp_unload
id|EXPORT_SYMBOL
c_func
(paren
id|sb_dsp_unload
)paren
suffix:semicolon
DECL|variable|sb_dsp_disable_midi
id|EXPORT_SYMBOL
c_func
(paren
id|sb_dsp_disable_midi
)paren
suffix:semicolon
DECL|variable|sb_be_quiet
id|EXPORT_SYMBOL
c_func
(paren
id|sb_be_quiet
)paren
suffix:semicolon
DECL|variable|probe_sbmpu
id|EXPORT_SYMBOL
c_func
(paren
id|probe_sbmpu
)paren
suffix:semicolon
DECL|variable|unload_sbmpu
id|EXPORT_SYMBOL
c_func
(paren
id|unload_sbmpu
)paren
suffix:semicolon
DECL|variable|smw_free
id|EXPORT_SYMBOL
c_func
(paren
id|smw_free
)paren
suffix:semicolon
eof
