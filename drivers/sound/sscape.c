multiline_comment|/*&n; * sound/sscape.c&n; *&n; * Low level driver for Ensoniq SoundScape&n; */
multiline_comment|/*&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;soundmodule.h&quot;
macro_line|#if defined(CONFIG_SSCAPEHW) || defined(MODULE)
macro_line|#include &quot;coproc.h&quot;
multiline_comment|/*&n; *    I/O ports&n; */
DECL|macro|MIDI_DATA
mdefine_line|#define MIDI_DATA        0
DECL|macro|MIDI_CTRL
mdefine_line|#define MIDI_CTRL        1
DECL|macro|HOST_CTRL
mdefine_line|#define HOST_CTRL        2
DECL|macro|TX_READY
mdefine_line|#define TX_READY&t;&t;0x02
DECL|macro|RX_READY
mdefine_line|#define RX_READY&t;&t;0x01
DECL|macro|HOST_DATA
mdefine_line|#define HOST_DATA        3
DECL|macro|ODIE_ADDR
mdefine_line|#define ODIE_ADDR        4
DECL|macro|ODIE_DATA
mdefine_line|#define ODIE_DATA        5
multiline_comment|/*&n; *    Indirect registers&n; */
DECL|macro|GA_INTSTAT_REG
mdefine_line|#define GA_INTSTAT_REG   0
DECL|macro|GA_INTENA_REG
mdefine_line|#define GA_INTENA_REG    1
DECL|macro|GA_DMAA_REG
mdefine_line|#define GA_DMAA_REG      2
DECL|macro|GA_DMAB_REG
mdefine_line|#define GA_DMAB_REG      3
DECL|macro|GA_INTCFG_REG
mdefine_line|#define GA_INTCFG_REG    4
DECL|macro|GA_DMACFG_REG
mdefine_line|#define GA_DMACFG_REG    5
DECL|macro|GA_CDCFG_REG
mdefine_line|#define GA_CDCFG_REG     6
DECL|macro|GA_SMCFGA_REG
mdefine_line|#define GA_SMCFGA_REG    7
DECL|macro|GA_SMCFGB_REG
mdefine_line|#define GA_SMCFGB_REG    8
DECL|macro|GA_HMCTL_REG
mdefine_line|#define GA_HMCTL_REG     9
multiline_comment|/*&n; * DMA channel identifiers (A and B)&n; */
DECL|macro|SSCAPE_DMA_A
mdefine_line|#define SSCAPE_DMA_A &t;&t;0
DECL|macro|SSCAPE_DMA_B
mdefine_line|#define SSCAPE_DMA_B&t;&t;1
DECL|macro|PORT
mdefine_line|#define PORT(name)&t;(devc-&gt;base+name)
multiline_comment|/*&n; * Host commands recognized by the OBP microcode&n; */
DECL|macro|CMD_GEN_HOST_ACK
mdefine_line|#define CMD_GEN_HOST_ACK        0x80
DECL|macro|CMD_GEN_MPU_ACK
mdefine_line|#define CMD_GEN_MPU_ACK         0x81
DECL|macro|CMD_GET_BOARD_TYPE
mdefine_line|#define CMD_GET_BOARD_TYPE      0x82
DECL|macro|CMD_SET_CONTROL
mdefine_line|#define CMD_SET_CONTROL         0x88&t;/* Old firmware only */
DECL|macro|CMD_GET_CONTROL
mdefine_line|#define CMD_GET_CONTROL         0x89&t;/* Old firmware only */
DECL|macro|CTL_MASTER_VOL
mdefine_line|#define &t;CTL_MASTER_VOL          0
DECL|macro|CTL_MIC_MODE
mdefine_line|#define &t;CTL_MIC_MODE            2
DECL|macro|CTL_SYNTH_VOL
mdefine_line|#define &t;CTL_SYNTH_VOL           4
DECL|macro|CTL_WAVE_VOL
mdefine_line|#define &t;CTL_WAVE_VOL            7
DECL|macro|CMD_SET_EXTMIDI
mdefine_line|#define CMD_SET_EXTMIDI&t;&t;0x8a
DECL|macro|CMD_GET_EXTMIDI
mdefine_line|#define CMD_GET_EXTMIDI&t;&t;0x8b
DECL|macro|CMD_SET_MT32
mdefine_line|#define CMD_SET_MT32            0x8c
DECL|macro|CMD_GET_MT32
mdefine_line|#define CMD_GET_MT32            0x8d
DECL|macro|CMD_ACK
mdefine_line|#define CMD_ACK&t;&t;&t;0x80
DECL|struct|sscape_info
r_typedef
r_struct
id|sscape_info
(brace
DECL|member|base
DECL|member|irq
DECL|member|dma
r_int
id|base
comma
id|irq
comma
id|dma
suffix:semicolon
DECL|member|ok
r_int
id|ok
suffix:semicolon
multiline_comment|/* Properly detected */
DECL|member|failed
r_int
id|failed
suffix:semicolon
DECL|member|dma_allocated
r_int
id|dma_allocated
suffix:semicolon
DECL|member|codec_audiodev
r_int
id|codec_audiodev
suffix:semicolon
DECL|member|opened
r_int
id|opened
suffix:semicolon
DECL|member|osp
r_int
op_star
id|osp
suffix:semicolon
DECL|member|my_audiodev
r_int
id|my_audiodev
suffix:semicolon
DECL|typedef|sscape_info
)brace
id|sscape_info
suffix:semicolon
DECL|variable|adev_info
r_static
r_struct
id|sscape_info
id|adev_info
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|devc
r_static
r_struct
id|sscape_info
op_star
id|devc
op_assign
op_amp
id|adev_info
suffix:semicolon
DECL|variable|sscape_mididev
r_static
r_int
id|sscape_mididev
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|sscape_sleeper
r_static
r_struct
id|wait_queue
op_star
id|sscape_sleeper
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|sscape_sleep_flag
r_static
r_volatile
r_struct
id|snd_wait
id|sscape_sleep_flag
op_assign
(brace
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Some older cards have assigned interrupt bits differently than new ones */
DECL|variable|valid_interrupts_old
r_static
r_char
id|valid_interrupts_old
(braket
)braket
op_assign
(brace
l_int|9
comma
l_int|7
comma
l_int|5
comma
l_int|15
)brace
suffix:semicolon
DECL|variable|valid_interrupts_new
r_static
r_char
id|valid_interrupts_new
(braket
)braket
op_assign
(brace
l_int|9
comma
l_int|5
comma
l_int|7
comma
l_int|10
)brace
suffix:semicolon
DECL|variable|valid_interrupts
r_static
r_char
op_star
id|valid_interrupts
op_assign
id|valid_interrupts_new
suffix:semicolon
macro_line|#ifdef REVEAL_SPEA
DECL|variable|old_hardware
r_static
r_char
id|old_hardware
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|old_hardware
r_static
r_char
id|old_hardware
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|function|sscape_read
r_static
r_int
r_char
id|sscape_read
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
comma
r_int
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|reg
)paren
comma
id|PORT
c_func
(paren
id|ODIE_ADDR
)paren
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|PORT
c_func
(paren
id|ODIE_DATA
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_void
DECL|function|sscape_write
id|sscape_write
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|reg
)paren
comma
id|PORT
c_func
(paren
id|ODIE_ADDR
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|data
)paren
comma
id|PORT
c_func
(paren
id|ODIE_DATA
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|host_open
id|host_open
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
)paren
(brace
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
id|PORT
c_func
(paren
id|HOST_CTRL
)paren
)paren
suffix:semicolon
multiline_comment|/* Put the board to the host mode */
)brace
r_static
r_void
DECL|function|host_close
id|host_close
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
)paren
(brace
id|outb
c_func
(paren
(paren
l_int|0x03
)paren
comma
id|PORT
c_func
(paren
id|HOST_CTRL
)paren
)paren
suffix:semicolon
multiline_comment|/* Put the board to the MIDI mode */
)brace
r_static
r_int
DECL|function|host_write
id|host_write
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
comma
r_int
r_char
op_star
id|data
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|timeout_val
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   * Send the command and data bytes&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|timeout_val
op_assign
l_int|10000
suffix:semicolon
id|timeout_val
OG
l_int|0
suffix:semicolon
id|timeout_val
op_decrement
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PORT
c_func
(paren
id|HOST_CTRL
)paren
)paren
op_amp
id|TX_READY
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|timeout_val
op_le
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
id|data
(braket
id|i
)braket
)paren
comma
id|PORT
c_func
(paren
id|HOST_DATA
)paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|host_read
id|host_read
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|timeout_val
suffix:semicolon
r_int
r_char
id|data
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   * Read a byte&n;&t; */
r_for
c_loop
(paren
id|timeout_val
op_assign
l_int|10000
suffix:semicolon
id|timeout_val
OG
l_int|0
suffix:semicolon
id|timeout_val
op_decrement
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PORT
c_func
(paren
id|HOST_CTRL
)paren
)paren
op_amp
id|RX_READY
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|timeout_val
op_le
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|data
op_assign
id|inb
c_func
(paren
id|PORT
c_func
(paren
id|HOST_DATA
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
r_static
r_int
DECL|function|host_command2
id|host_command2
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
comma
r_int
id|cmd
comma
r_int
id|parm1
)paren
(brace
r_int
r_char
id|buf
(braket
l_int|10
)braket
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|cmd
op_amp
l_int|0xff
)paren
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|parm1
op_amp
l_int|0xff
)paren
suffix:semicolon
r_return
id|host_write
c_func
(paren
id|devc
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|host_command3
id|host_command3
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
comma
r_int
id|cmd
comma
r_int
id|parm1
comma
r_int
id|parm2
)paren
(brace
r_int
r_char
id|buf
(braket
l_int|10
)braket
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|cmd
op_amp
l_int|0xff
)paren
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|parm1
op_amp
l_int|0xff
)paren
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
(paren
r_int
r_char
)paren
(paren
id|parm2
op_amp
l_int|0xff
)paren
suffix:semicolon
r_return
id|host_write
c_func
(paren
id|devc
comma
id|buf
comma
l_int|3
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_mt32
id|set_mt32
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
comma
r_int
id|value
)paren
(brace
id|host_open
c_func
(paren
id|devc
)paren
suffix:semicolon
id|host_command2
c_func
(paren
id|devc
comma
id|CMD_SET_MT32
comma
id|value
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host_read
c_func
(paren
id|devc
)paren
op_ne
id|CMD_ACK
)paren
(brace
multiline_comment|/* printk( &quot;SNDSCAPE: Setting MT32 mode failed&bslash;n&quot;); */
)brace
id|host_close
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_control
id|set_control
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
comma
r_int
id|ctrl
comma
r_int
id|value
)paren
(brace
id|host_open
c_func
(paren
id|devc
)paren
suffix:semicolon
id|host_command3
c_func
(paren
id|devc
comma
id|CMD_SET_CONTROL
comma
id|ctrl
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host_read
c_func
(paren
id|devc
)paren
op_ne
id|CMD_ACK
)paren
(brace
multiline_comment|/* printk( &quot;SNDSCAPE: Setting control (%d) failed&bslash;n&quot;,  ctrl); */
)brace
id|host_close
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|do_dma
id|do_dma
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
comma
r_int
id|dma_chan
comma
r_int
r_int
id|buf
comma
r_int
id|blk_size
comma
r_int
id|mode
)paren
(brace
r_int
r_char
id|temp
suffix:semicolon
r_if
c_cond
(paren
id|dma_chan
op_ne
id|SSCAPE_DMA_A
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SSCAPE: Tried to use DMA channel  != A. Why?&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|audio_devs
(braket
id|devc-&gt;codec_audiodev
)braket
op_member_access_from_pointer
id|flags
op_and_assign
op_complement
id|DMA_AUTOMODE
suffix:semicolon
id|DMAbuf_start_dma
c_func
(paren
id|devc-&gt;codec_audiodev
comma
id|buf
comma
id|blk_size
comma
id|mode
)paren
suffix:semicolon
id|audio_devs
(braket
id|devc-&gt;codec_audiodev
)braket
op_member_access_from_pointer
id|flags
op_or_assign
id|DMA_AUTOMODE
suffix:semicolon
id|temp
op_assign
id|devc-&gt;dma
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* Setup DMA channel select bits */
r_if
c_cond
(paren
id|devc-&gt;dma
op_le
l_int|3
)paren
id|temp
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* 8 bit DMA channel */
id|temp
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/* Trigger DMA */
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_DMAA_REG
comma
id|temp
)paren
suffix:semicolon
id|temp
op_and_assign
l_int|0xfe
suffix:semicolon
multiline_comment|/* Clear DMA trigger */
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_DMAA_REG
comma
id|temp
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|verify_mpu
id|verify_mpu
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
)paren
(brace
multiline_comment|/*&n;&t;   * The SoundScape board could be in three modes (MPU, 8250 and host).&n;&t;   * If the card is not in the MPU mode, enabling the MPU driver will&n;&t;   * cause infinite loop (the driver believes that there is always some&n;&t;   * received data in the buffer.&n;&t;   *&n;&t;   * Detect this by looking if there are more than 10 received MIDI bytes&n;&t;   * (0x00) in the buffer.&n;&t; */
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
id|HOST_CTRL
)paren
op_amp
l_int|0x80
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_ne
l_int|0x00
)paren
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;SoundScape: The device is not in the MPU-401 mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sscape_coproc_open
id|sscape_coproc_open
c_func
(paren
r_void
op_star
id|dev_info
comma
r_int
id|sub_device
)paren
(brace
r_if
c_cond
(paren
id|sub_device
op_eq
id|COPR_MIDI
)paren
(brace
id|set_mt32
c_func
(paren
id|devc
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|verify_mpu
c_func
(paren
id|devc
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|sscape_sleep_flag.opts
op_assign
id|WK_NONE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sscape_coproc_close
id|sscape_coproc_close
c_func
(paren
r_void
op_star
id|dev_info
comma
r_int
id|sub_device
)paren
(brace
r_struct
id|sscape_info
op_star
id|devc
op_assign
id|dev_info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;dma_allocated
)paren
(brace
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_DMAA_REG
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* DMA channel disabled */
id|devc-&gt;dma_allocated
op_assign
l_int|0
suffix:semicolon
)brace
id|sscape_sleep_flag.opts
op_assign
id|WK_NONE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|sscape_coproc_reset
id|sscape_coproc_reset
c_func
(paren
r_void
op_star
id|dev_info
)paren
(brace
)brace
r_static
r_int
DECL|function|sscape_download_boot
id|sscape_download_boot
c_func
(paren
r_struct
id|sscape_info
op_star
id|devc
comma
r_int
r_char
op_star
id|block
comma
r_int
id|size
comma
r_int
id|flag
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|temp
suffix:semicolon
r_volatile
r_int
id|done
comma
id|timeout_val
suffix:semicolon
r_static
r_int
r_char
id|codec_dma_bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|CPF_FIRST
)paren
(brace
multiline_comment|/*&n;&t;&t;     * First block. Have to allocate DMA and to reset the board&n;&t;&t;     * before continuing.&n;&t;&t;   */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|codec_dma_bits
op_assign
id|sscape_read
c_func
(paren
id|devc
comma
id|GA_CDCFG_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;dma_allocated
op_eq
l_int|0
)paren
(brace
id|devc-&gt;dma_allocated
op_assign
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_HMCTL_REG
comma
(paren
id|temp
op_assign
id|sscape_read
c_func
(paren
id|devc
comma
id|GA_HMCTL_REG
)paren
)paren
op_amp
l_int|0x3f
)paren
suffix:semicolon
multiline_comment|/*Reset */
r_for
c_loop
(paren
id|timeout_val
op_assign
l_int|10000
suffix:semicolon
id|timeout_val
OG
l_int|0
suffix:semicolon
id|timeout_val
op_decrement
)paren
id|sscape_read
c_func
(paren
id|devc
comma
id|GA_HMCTL_REG
)paren
suffix:semicolon
multiline_comment|/* Delay */
multiline_comment|/* Take board out of reset */
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_HMCTL_REG
comma
(paren
id|temp
op_assign
id|sscape_read
c_func
(paren
id|devc
comma
id|GA_HMCTL_REG
)paren
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Transfer one code block using DMA&n;&t; */
r_if
c_cond
(paren
id|audio_devs
(braket
id|devc-&gt;codec_audiodev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;raw_buf
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SSCAPE: Error: DMA buffer not available&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|audio_devs
(braket
id|devc-&gt;codec_audiodev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;raw_buf
comma
id|block
comma
id|size
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/******** INTERRUPTS DISABLED NOW ********/
id|do_dma
c_func
(paren
id|devc
comma
id|SSCAPE_DMA_A
comma
id|audio_devs
(braket
id|devc-&gt;codec_audiodev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;raw_buf_phys
comma
id|size
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait until transfer completes.&n;&t; */
id|sscape_sleep_flag.opts
op_assign
id|WK_NONE
suffix:semicolon
id|done
op_assign
l_int|0
suffix:semicolon
id|timeout_val
op_assign
l_int|30
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
op_logical_and
id|timeout_val
op_decrement
OG
l_int|0
)paren
(brace
r_int
id|resid
suffix:semicolon
(brace
r_int
r_int
id|tlimit
suffix:semicolon
r_if
c_cond
(paren
id|HZ
op_div
l_int|50
)paren
id|current-&gt;timeout
op_assign
id|tlimit
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|50
)paren
suffix:semicolon
r_else
id|tlimit
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|sscape_sleep_flag.opts
op_assign
id|WK_SLEEP
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|sscape_sleeper
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sscape_sleep_flag.opts
op_amp
id|WK_WAKEUP
)paren
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|tlimit
)paren
id|sscape_sleep_flag.opts
op_or_assign
id|WK_TIMEOUT
suffix:semicolon
)brace
id|sscape_sleep_flag.opts
op_and_assign
op_complement
id|WK_SLEEP
suffix:semicolon
)brace
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|devc-&gt;dma
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|resid
op_assign
id|get_dma_residue
c_func
(paren
id|devc-&gt;dma
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|done
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|CPF_LAST
)paren
(brace
multiline_comment|/*&n;&t;&t;     * Take the board out of reset&n;&t;&t;   */
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
id|PORT
c_func
(paren
id|HOST_CTRL
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
id|PORT
c_func
(paren
id|MIDI_CTRL
)paren
)paren
suffix:semicolon
id|temp
op_assign
id|sscape_read
c_func
(paren
id|devc
comma
id|GA_HMCTL_REG
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x40
suffix:semicolon
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_HMCTL_REG
comma
id|temp
)paren
suffix:semicolon
multiline_comment|/* Kickstart the board */
multiline_comment|/*&n;&t;&t;     * Wait until the ODB wakes up&n;&t;&t;   */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|done
op_assign
l_int|0
suffix:semicolon
id|timeout_val
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
op_logical_and
id|timeout_val
op_decrement
OG
l_int|0
)paren
(brace
r_int
r_char
id|x
suffix:semicolon
(brace
r_int
r_int
id|tlimit
suffix:semicolon
r_if
c_cond
(paren
l_int|1
)paren
id|current-&gt;timeout
op_assign
id|tlimit
op_assign
id|jiffies
op_plus
(paren
l_int|1
)paren
suffix:semicolon
r_else
id|tlimit
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|sscape_sleep_flag.opts
op_assign
id|WK_SLEEP
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|sscape_sleeper
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sscape_sleep_flag.opts
op_amp
id|WK_WAKEUP
)paren
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|tlimit
)paren
id|sscape_sleep_flag.opts
op_or_assign
id|WK_TIMEOUT
suffix:semicolon
)brace
id|sscape_sleep_flag.opts
op_and_assign
op_complement
id|WK_SLEEP
suffix:semicolon
)brace
suffix:semicolon
id|x
op_assign
id|inb
c_func
(paren
id|PORT
c_func
(paren
id|HOST_DATA
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
l_int|0xff
op_logical_or
id|x
op_eq
l_int|0xfe
)paren
multiline_comment|/* OBP startup acknowledge */
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Soundscape: Acknowledge = %x&bslash;n&quot;
comma
id|x
)paren
)paren
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_CDCFG_REG
comma
id|codec_dma_bits
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SoundScape: The OBP didn&squot;t respond after code download&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|done
op_assign
l_int|0
suffix:semicolon
id|timeout_val
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
op_logical_and
id|timeout_val
op_decrement
OG
l_int|0
)paren
(brace
(brace
r_int
r_int
id|tlimit
suffix:semicolon
r_if
c_cond
(paren
l_int|1
)paren
id|current-&gt;timeout
op_assign
id|tlimit
op_assign
id|jiffies
op_plus
(paren
l_int|1
)paren
suffix:semicolon
r_else
id|tlimit
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|sscape_sleep_flag.opts
op_assign
id|WK_SLEEP
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|sscape_sleeper
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sscape_sleep_flag.opts
op_amp
id|WK_WAKEUP
)paren
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_ge
id|tlimit
)paren
id|sscape_sleep_flag.opts
op_or_assign
id|WK_TIMEOUT
suffix:semicolon
)brace
id|sscape_sleep_flag.opts
op_and_assign
op_complement
id|WK_SLEEP
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PORT
c_func
(paren
id|HOST_DATA
)paren
)paren
op_eq
l_int|0xfe
)paren
multiline_comment|/* Host startup acknowledge */
id|done
op_assign
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SoundScape: OBP Initialization failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;SoundScape board initialized OK&bslash;n&quot;
)paren
suffix:semicolon
id|set_control
c_func
(paren
id|devc
comma
id|CTL_MASTER_VOL
comma
l_int|100
)paren
suffix:semicolon
id|set_control
c_func
(paren
id|devc
comma
id|CTL_SYNTH_VOL
comma
l_int|100
)paren
suffix:semicolon
macro_line|#ifdef SSCAPE_DEBUG3
multiline_comment|/*&n;&t;&t;     * Temporary debugging aid. Print contents of the registers after&n;&t;&t;     * downloading the code.&n;&t;&t;   */
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;I%d = %02x (new value)&bslash;n&quot;
comma
id|i
comma
id|sscape_read
c_func
(paren
id|devc
comma
id|i
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|download_boot_block
id|download_boot_block
c_func
(paren
r_void
op_star
id|dev_info
comma
id|copr_buffer
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|buf-&gt;len
op_le
l_int|0
op_logical_or
id|buf-&gt;len
OG
r_sizeof
(paren
id|buf-&gt;data
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sscape_download_boot
c_func
(paren
id|devc
comma
id|buf-&gt;data
comma
id|buf-&gt;len
comma
id|buf-&gt;flags
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SSCAPE: Unable to load microcode block to the OBP.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sscape_coproc_ioctl
id|sscape_coproc_ioctl
c_func
(paren
r_void
op_star
id|dev_info
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
comma
r_int
id|local
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDCTL_COPR_RESET
suffix:colon
id|sscape_coproc_reset
c_func
(paren
id|dev_info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_COPR_LOAD
suffix:colon
(brace
id|copr_buffer
op_star
id|buf
suffix:semicolon
r_int
id|err
suffix:semicolon
id|buf
op_assign
(paren
id|copr_buffer
op_star
)paren
id|vmalloc
c_func
(paren
r_sizeof
(paren
id|copr_buffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|buf
comma
(paren
op_amp
(paren
(paren
r_char
op_star
)paren
id|arg
)paren
(braket
l_int|0
)braket
)paren
comma
r_sizeof
(paren
op_star
id|buf
)paren
)paren
suffix:semicolon
id|err
op_assign
id|download_boot_block
c_func
(paren
id|dev_info
comma
id|buf
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|variable|sscape_coproc_operations
r_static
id|coproc_operations
id|sscape_coproc_operations
op_assign
(brace
l_string|&quot;SoundScape M68K&quot;
comma
id|sscape_coproc_open
comma
id|sscape_coproc_close
comma
id|sscape_coproc_ioctl
comma
id|sscape_coproc_reset
comma
op_amp
id|adev_info
)brace
suffix:semicolon
DECL|variable|sscape_detected
r_static
r_int
id|sscape_detected
op_assign
l_int|0
suffix:semicolon
r_void
DECL|function|attach_sscape
id|attach_sscape
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
macro_line|#ifndef SSCAPE_REGS
multiline_comment|/*&n;&t;   * Config register values for Spea/V7 Media FX and Ensoniq S-2000.&n;&t;   * These values are card&n;&t;   * dependent. If you have another SoundScape based card, you have to&n;&t;   * find the correct values. Do the following:&n;&t;   *  - Compile this driver with SSCAPE_DEBUG1 defined.&n;&t;   *  - Shut down and power off your machine.&n;&t;   *  - Boot with DOS so that the SSINIT.EXE program is run.&n;&t;   *  - Warm boot to {Linux|SYSV|BSD} and write down the lines displayed&n;&t;   *    when detecting the SoundScape.&n;&t;   *  - Modify the following list to use the values printed during boot.&n;&t;   *    Undefine the SSCAPE_DEBUG1&n;&t; */
DECL|macro|SSCAPE_REGS
mdefine_line|#define SSCAPE_REGS { &bslash;&n;/* I0 */&t;0x00, &bslash;&n;&t;&t;0xf0, /* Note! Ignored. Set always to 0xf0 */ &bslash;&n;&t;&t;0x20, /* Note! Ignored. Set always to 0x20 */ &bslash;&n;&t;&t;0x20, /* Note! Ignored. Set always to 0x20 */ &bslash;&n;&t;&t;0xf5, /* Ignored */ &bslash;&n;&t;&t;0x10, &bslash;&n;&t;&t;0x00, &bslash;&n;&t;&t;0x2e, /* I7 MEM config A. Likely to vary between models */ &bslash;&n;&t;&t;0x00, /* I8 MEM config B. Likely to vary between models */ &bslash;&n;/* I9 */&t;0x40 /* Ignored */ &bslash;&n;&t;}
macro_line|#endif
r_int
r_int
id|flags
suffix:semicolon
r_static
r_int
r_char
id|regs
(braket
l_int|10
)braket
op_assign
id|SSCAPE_REGS
suffix:semicolon
r_int
id|i
comma
id|irq_bits
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|sscape_detected
op_ne
id|hw_config-&gt;io_base
)paren
r_return
suffix:semicolon
id|request_region
c_func
(paren
id|devc-&gt;base
op_plus
l_int|2
comma
l_int|6
comma
l_string|&quot;SoundScape&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_hardware
)paren
(brace
id|valid_interrupts
op_assign
id|valid_interrupts_old
suffix:semicolon
id|conf_printf
c_func
(paren
l_string|&quot;Ensoniq SoundScape (old)&quot;
comma
id|hw_config
)paren
suffix:semicolon
)brace
r_else
id|conf_printf
c_func
(paren
l_string|&quot;Ensoniq SoundScape&quot;
comma
id|hw_config
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|valid_interrupts
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hw_config-&gt;irq
op_eq
id|valid_interrupts
(braket
id|i
)braket
)paren
(brace
id|irq_bits
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|15
op_logical_or
(paren
id|regs
(braket
l_int|4
)braket
op_assign
id|irq_bits
op_eq
l_int|0xff
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Invalid IRQ%d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* Host interrupt enable */
id|sscape_write
c_func
(paren
id|devc
comma
id|i
comma
l_int|0xf0
)paren
suffix:semicolon
multiline_comment|/* All interrupts enabled */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* DMA A status/trigger register */
r_case
l_int|3
suffix:colon
multiline_comment|/* DMA B status/trigger register */
id|sscape_write
c_func
(paren
id|devc
comma
id|i
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* DMA channel disabled */
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* Host interrupt config reg */
id|sscape_write
c_func
(paren
id|devc
comma
id|i
comma
l_int|0xf0
op_or
(paren
id|irq_bits
op_lshift
l_int|2
)paren
op_or
id|irq_bits
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* Don&squot;t destroy CD-ROM DMA config bits (0xc0) */
id|sscape_write
c_func
(paren
id|devc
comma
id|i
comma
(paren
id|regs
(braket
id|i
)braket
op_amp
l_int|0x3f
)paren
op_or
(paren
id|sscape_read
c_func
(paren
id|devc
comma
id|i
)paren
op_amp
l_int|0xc0
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
multiline_comment|/* CD-ROM config (WSS codec actually) */
id|sscape_write
c_func
(paren
id|devc
comma
id|i
comma
id|regs
(braket
id|i
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
multiline_comment|/* Master control reg. Don&squot;t modify CR-ROM bits. Disable SB emul */
id|sscape_write
c_func
(paren
id|devc
comma
id|i
comma
(paren
id|sscape_read
c_func
(paren
id|devc
comma
id|i
)paren
op_amp
l_int|0xf0
)paren
op_or
l_int|0x08
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sscape_write
c_func
(paren
id|devc
comma
id|i
comma
id|regs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#ifdef SSCAPE_DEBUG2
multiline_comment|/*&n;&t;   * Temporary debugging aid. Print contents of the registers after&n;&t;   * changing them.&n;&t; */
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;I%d = %02x (new value)&bslash;n&quot;
comma
id|i
comma
id|sscape_read
c_func
(paren
id|devc
comma
id|i
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_MIDI) &amp;&amp; defined(CONFIG_MPU_EMU)
r_if
c_cond
(paren
id|probe_mpu401
c_func
(paren
id|hw_config
)paren
)paren
id|hw_config-&gt;always_detect
op_assign
l_int|1
suffix:semicolon
(brace
id|hw_config-&gt;name
op_assign
l_string|&quot;SoundScape&quot;
suffix:semicolon
id|hw_config-&gt;irq
op_mul_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Negative value signals IRQ sharing */
id|attach_mpu401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
id|hw_config-&gt;irq
op_mul_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Restore it */
r_if
c_cond
(paren
id|hw_config-&gt;slots
(braket
l_int|1
)braket
op_ne
op_minus
l_int|1
)paren
multiline_comment|/* The MPU driver installed itself */
(brace
id|sscape_mididev
op_assign
id|hw_config-&gt;slots
(braket
l_int|1
)braket
suffix:semicolon
id|midi_devs
(braket
id|hw_config-&gt;slots
(braket
l_int|1
)braket
)braket
op_member_access_from_pointer
id|coproc
op_assign
op_amp
id|sscape_coproc_operations
suffix:semicolon
)brace
)brace
macro_line|#endif
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_INTENA_REG
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* Master IRQ enable */
id|devc-&gt;ok
op_assign
l_int|1
suffix:semicolon
id|devc-&gt;failed
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|detect_ga
id|detect_ga
c_func
(paren
id|sscape_info
op_star
id|devc
)paren
(brace
r_int
r_char
id|save
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Entered Soundscape detect_ga(%x)&bslash;n&quot;
comma
id|devc-&gt;base
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|devc-&gt;base
comma
l_int|8
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;   * First check that the address register of &quot;ODIE&quot; is&n;&t;   * there and that it has exactly 4 writable bits.&n;&t;   * First 4 bits&n;&t; */
r_if
c_cond
(paren
(paren
id|save
op_assign
id|inb
c_func
(paren
id|PORT
c_func
(paren
id|ODIE_ADDR
)paren
)paren
)paren
op_amp
l_int|0xf0
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;soundscape: Detect error A&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
id|PORT
c_func
(paren
id|ODIE_ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PORT
c_func
(paren
id|ODIE_ADDR
)paren
)paren
op_ne
l_int|0x00
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;soundscape: Detect error B&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
l_int|0xff
)paren
comma
id|PORT
c_func
(paren
id|ODIE_ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PORT
c_func
(paren
id|ODIE_ADDR
)paren
)paren
op_ne
l_int|0x0f
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;soundscape: Detect error C&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
id|save
)paren
comma
id|PORT
c_func
(paren
id|ODIE_ADDR
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   * Now verify that some indirect registers return zero on some bits.&n;&t;   * This may break the driver with some future revisions of &quot;ODIE&quot; but...&n;&t; */
r_if
c_cond
(paren
id|sscape_read
c_func
(paren
id|devc
comma
l_int|0
)paren
op_amp
l_int|0x0c
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;soundscape: Detect error D (%x)&bslash;n&quot;
comma
id|sscape_read
c_func
(paren
id|devc
comma
l_int|0
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sscape_read
c_func
(paren
id|devc
comma
l_int|1
)paren
op_amp
l_int|0x0f
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;soundscape: Detect error E&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sscape_read
c_func
(paren
id|devc
comma
l_int|5
)paren
op_amp
l_int|0x0f
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;soundscape: Detect error F&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|probe_sscape
id|probe_sscape
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_if
c_cond
(paren
id|sscape_detected
op_ne
l_int|0
op_logical_and
id|sscape_detected
op_ne
id|hw_config-&gt;io_base
)paren
r_return
l_int|0
suffix:semicolon
id|devc-&gt;base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|devc-&gt;irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|devc-&gt;dma
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|devc-&gt;osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
macro_line|#ifdef SSCAPE_DEBUG1
multiline_comment|/*&n;&t;   * Temporary debugging aid. Print contents of the registers before&n;&t;   * changing them.&n;&t; */
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;I%d = %02x (old value)&bslash;n&quot;
comma
id|i
comma
id|sscape_read
c_func
(paren
id|devc
comma
id|i
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|devc-&gt;failed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_ga
c_func
(paren
id|devc
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|old_hardware
)paren
multiline_comment|/* Check that it&squot;s really an old Spea/Reveal card. */
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_int
id|cc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|tmp
op_assign
id|sscape_read
c_func
(paren
id|devc
comma
id|GA_HMCTL_REG
)paren
)paren
op_amp
l_int|0xc0
)paren
)paren
(brace
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_HMCTL_REG
comma
id|tmp
op_or
l_int|0x80
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cc
op_assign
l_int|0
suffix:semicolon
id|cc
OL
l_int|200000
suffix:semicolon
op_increment
id|cc
)paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
id|ODIE_ADDR
)paren
suffix:semicolon
)brace
)brace
id|sscape_detected
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|probe_ss_ms_sound
id|probe_ss_ms_sound
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
comma
id|irq_bits
op_assign
l_int|0xff
suffix:semicolon
r_int
id|ad_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;failed
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Soundscape: Card not detected&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;ok
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SoundScape: Invalid initialization order.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|valid_interrupts
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hw_config-&gt;irq
op_eq
id|valid_interrupts
(braket
id|i
)braket
)paren
(brace
id|irq_bits
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|15
op_logical_or
id|irq_bits
op_eq
l_int|0xff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;SoundScape: Invalid MSS IRQ%d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|old_hardware
)paren
id|ad_flags
op_assign
l_int|0x12345677
suffix:semicolon
multiline_comment|/* Tell that we may have a CS4248 chip (Spea-V7 Media FX) */
r_return
id|ad1848_detect
c_func
(paren
id|hw_config-&gt;io_base
comma
op_amp
id|ad_flags
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
)brace
r_void
DECL|function|attach_ss_ms_sound
id|attach_ss_ms_sound
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
multiline_comment|/*&n;&t;   * This routine configures the SoundScape card for use with the&n;&t;   * Win Sound System driver. The AD1848 codec interface uses the CD-ROM&n;&t;   * config registers of the &quot;ODIE&quot;.&n;&t; */
r_int
id|i
comma
id|irq_bits
op_assign
l_int|0xff
suffix:semicolon
id|hw_config-&gt;dma
op_assign
id|devc-&gt;dma
suffix:semicolon
multiline_comment|/* Share the DMA with the ODIE/OPUS chip */
multiline_comment|/*&n;&t; * Setup the DMA polarity.&n;&t; */
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_DMACFG_REG
comma
l_int|0x50
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   * Take the gate-array off of the DMA channel.&n;&t; */
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_DMAB_REG
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   * Init the AD1848 (CD-ROM) config reg.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|valid_interrupts
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hw_config-&gt;irq
op_eq
id|valid_interrupts
(braket
id|i
)braket
)paren
(brace
id|irq_bits
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sscape_write
c_func
(paren
id|devc
comma
id|GA_CDCFG_REG
comma
l_int|0x89
op_or
(paren
id|hw_config-&gt;dma
op_lshift
l_int|4
)paren
op_or
(paren
id|irq_bits
op_lshift
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;irq
op_eq
id|devc-&gt;irq
)paren
id|printk
c_func
(paren
l_string|&quot;SoundScape: Warning! The WSS mode can&squot;t share IRQ with MIDI&bslash;n&quot;
)paren
suffix:semicolon
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_assign
id|ad1848_init
c_func
(paren
l_string|&quot;SoundScape&quot;
comma
id|hw_config-&gt;io_base
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma
comma
l_int|0
comma
id|devc-&gt;osp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_ne
op_minus
l_int|1
)paren
multiline_comment|/* The AD1848 driver installed itself */
(brace
id|audio_devs
(braket
id|hw_config-&gt;slots
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|coproc
op_assign
op_amp
id|sscape_coproc_operations
suffix:semicolon
id|devc-&gt;codec_audiodev
op_assign
id|hw_config-&gt;slots
(braket
l_int|0
)braket
suffix:semicolon
id|devc-&gt;my_audiodev
op_assign
id|hw_config-&gt;slots
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Set proper routings here (what are they) */
id|AD1848_REROUTE
c_func
(paren
id|SOUND_MIXER_LINE1
comma
id|SOUND_MIXER_LINE
)paren
suffix:semicolon
)brace
macro_line|#ifdef SSCAPE_DEBUG5
multiline_comment|/*&n;&t;   * Temporary debugging aid. Print contents of the registers&n;&t;   * after the AD1848 device has been initialized.&n;&t; */
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;I%d = %02x&bslash;n&quot;
comma
id|i
comma
id|sscape_read
c_func
(paren
id|devc
comma
id|i
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_void
DECL|function|unload_sscape
id|unload_sscape
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|release_region
c_func
(paren
id|devc-&gt;base
op_plus
l_int|2
comma
l_int|6
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_MPU_EMU) &amp;&amp; defined(CONFIG_MIDI)
id|unload_mpu401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|unload_ss_ms_sound
id|unload_ss_ms_sound
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|ad1848_unload
c_func
(paren
id|hw_config-&gt;io_base
comma
id|hw_config-&gt;irq
comma
id|devc-&gt;dma
comma
id|devc-&gt;dma
comma
l_int|0
)paren
suffix:semicolon
id|sound_unload_audiodev
c_func
(paren
id|hw_config-&gt;slots
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|dma
r_int
id|dma
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|irq
r_int
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|io
r_int
id|io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mpu_irq
r_int
id|mpu_irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mpu_io
r_int
id|mpu_io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mss
r_static
r_int
id|mss
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mpu_irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mpu_io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mss
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|config
r_struct
id|address_info
id|config
suffix:semicolon
DECL|variable|mpu_config
r_struct
id|address_info
id|mpu_config
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Soundscape driver Copyright (C) by Hannu Savolainen 1993-1996&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma
op_eq
op_minus
l_int|1
op_logical_or
id|irq
op_eq
op_minus
l_int|1
op_logical_or
id|io
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DMA, IRQ, and IO port must be specified.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mpu_irq
op_eq
op_minus
l_int|1
op_logical_and
id|mpu_io
op_ne
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MPU_IRQ must be specified if MPU_IO is set.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|config.irq
op_assign
id|irq
suffix:semicolon
id|config.dma
op_assign
id|dma
suffix:semicolon
id|config.io_base
op_assign
id|io
suffix:semicolon
id|mpu_config.irq
op_assign
id|mpu_irq
suffix:semicolon
id|mpu_config.io_base
op_assign
id|mpu_io
suffix:semicolon
r_if
c_cond
(paren
id|probe_sscape
c_func
(paren
op_amp
id|mpu_config
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|attach_sscape
c_func
(paren
op_amp
id|mpu_config
)paren
suffix:semicolon
id|mss
op_assign
id|probe_ss_ms_sound
c_func
(paren
op_amp
id|config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mss
)paren
id|attach_ss_ms_sound
c_func
(paren
op_amp
id|config
)paren
suffix:semicolon
id|SOUND_LOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|mss
)paren
id|unload_ss_ms_sound
c_func
(paren
op_amp
id|config
)paren
suffix:semicolon
id|SOUND_LOCK_END
suffix:semicolon
id|unload_sscape
c_func
(paren
op_amp
id|config
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
eof
