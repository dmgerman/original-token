multiline_comment|/*****************************************************************************&n; *&n; *      ESS Maestro/Maestro-2/Maestro-2E driver for Linux 2.2.x&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *      This program is distributed in the hope that it will be useful,&n; *      but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *      GNU General Public License for more details.&n; *&n; *      You should have received a copy of the GNU General Public License&n; *      along with this program; if not, write to the Free Software&n; *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *&t;(c) Copyright 1999&t; Alan Cox &lt;alan.cox@linux.org&gt;&n; *&n; *&t;Based heavily on SonicVibes.c:&n; *      Copyright (C) 1998-1999  Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *&n; *&t;Heavily modified by Zach Brown &lt;zab@redhat.com&gt; based on lunch&n; *&t;with ESS engineers.  Many thanks to Howard Kim for providing &n; *&t;contacts and hardware.  Honorable mention goes to Eric &n; *&t;Brombaugh for the BOB routines and nice hacking in general.&n; *&n; *  Supported devices:&n; *  /dev/dsp0-7    standard /dev/dsp device, (mostly) OSS compatible&n; *  /dev/mixer  standard /dev/mixer device, (mostly) OSS compatible&n; *&n; *  Hardware Description&n; *&n; *&t;A working Maestro setup contains the Maestro chip wired to a &n; *&t;codec or 2.  In the Maestro we have the APUs, the ASP, and the&n; *&t;Wavecache.  The APUs can be though of as virtual audio routing&n; *&t;channels.  They can take data from a number of sources and perform&n; *&t;basic encodings of the data.  The wavecache is a storehouse for&n; *&t;PCM data.  Typically it deals with PCI and interracts with the&n; *&t;APUs.  The ASP is a wacky DSP like device that ESS is loathe&n; *&t;to release docs on.  Thankfully it isn&squot;t required on the Maestro&n; *&t;until you start doing insane things like FM emulation and surround&n; *&t;encoding.  The codecs are almost always AC-97 compliant codecs, &n; *&t;but it appears that early Maestros may have had PT101 (an ESS&n; *&t;part?) wired to them.  The only real difference in the Maestro&n; *&t;families is external goop like docking capability, memory for&n; *&t;the ASP, and trivial initialization differences.&n; *&n; *  Driver Operation&n; *&n; *&t;We only drive the APU/Wavecache as typical DACs and drive the&n; *&t;mixers in the codecs.  There are 64 APUs.  We assign 4 to each&n; *&t;/dev/dsp? device.  2 channels for both in and out.&n; *&n; *&t;For output we maintain a ring buffer of data that we are dmaing&n; *&t;to the card.  In mono operation this is nice and easy.  When&n; *&t;we receive data we tack it onto the ring buffer and make sure&n; *&t;the APU assigned to it is playing over the data.  When we fill&n; *&t;the ring buffer we put the client to sleep until there is&n; *&t;room again.  Easy.&n; *&n; *&t;However, this starts to stink when we use stereo.  The APUs&n; *&t;supposedly can decode LRLR packed stereo data, but it&n; *&t;doesn&squot;t work.  So we&squot;re forced to use dual mono APUs walking over&n; *&t;mono encoded data.  This requires us to split the input from&n; *&t;the client and complicates the buffer maths tremendously.  Ick.&n; *&n; *&t;Once input is actually written, it will be worth pointing out&n; *&t;that only 44/16 input actually works.&n; *&n; * TODO&n; *&t;Leaks memory?&n; *&t;recording is horribly broken&n; *&t;apus or dmas get out sync&n; *&t;bob can be started twice&n; *&t;anyone have a pt101 codec?&n; *&t;ess&squot;s ac97 codec (es1921) doesn&squot;t work&n; *&t;generally test across codecs..&n; *&t;mmap(), but beware stereo encoding nastiness.&n; */
multiline_comment|/*****************************************************************************/
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#ifdef MODVERSIONS
macro_line|#include &lt;linux/modversions.h&gt;
macro_line|#endif
macro_line|#endif
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &quot;maestro.h&quot;
macro_line|#include &quot;maestro_tables.h&quot;
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|M_DEBUG
mdefine_line|#define M_DEBUG 1
macro_line|#ifdef M_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
DECL|macro|M_printk
mdefine_line|#define M_printk(args...) {if (debug) printk(args);}
macro_line|#else
DECL|macro|M_printk
mdefine_line|#define M_printk(x)
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;0.03&quot;
macro_line|#ifndef PCI_VENDOR_ESS
DECL|macro|PCI_VENDOR_ESS
mdefine_line|#define PCI_VENDOR_ESS&t;&t;&t;0x125D
DECL|macro|PCI_DEVICE_ID_ESS_ESS1968
mdefine_line|#define PCI_DEVICE_ID_ESS_ESS1968&t;0x1968&t;&t;/* Maestro 2&t;*/
DECL|macro|PCI_DEVICE_ID_ESS_ESS1978
mdefine_line|#define PCI_DEVICE_ID_ESS_ESS1978      &t;0x1978&t;&t;/* Maestro 2E&t;*/
DECL|macro|PCI_VENDOR_ESS_OLD
mdefine_line|#define PCI_VENDOR_ESS_OLD&t;&t;0x1285&t;&t;/* vendor id for maestro 1 */
DECL|macro|PCI_DEVICE_ID_ESS_ESS0100
mdefine_line|#define PCI_DEVICE_ID_ESS_ESS0100&t;0x0100&t;&t;/* maestro 1 */
macro_line|#endif /* PCI_VENDOR_ESS */
DECL|macro|ESS_CHAN_HARD
mdefine_line|#define ESS_CHAN_HARD&t;&t;0x100
DECL|macro|ESS_CFMT_STEREO
mdefine_line|#define ESS_CFMT_STEREO     0x01
DECL|macro|ESS_CFMT_16BIT
mdefine_line|#define ESS_CFMT_16BIT      0x02
DECL|macro|ESS_CFMT_MASK
mdefine_line|#define ESS_CFMT_MASK       0x03
DECL|macro|ESS_CFMT_ASHIFT
mdefine_line|#define ESS_CFMT_ASHIFT     0   
DECL|macro|ESS_CFMT_CSHIFT
mdefine_line|#define ESS_CFMT_CSHIFT     4
DECL|macro|ESS_ENABLE_PE
mdefine_line|#define ESS_ENABLE_PE&t;&t;1
DECL|macro|ESS_ENABLE_RE
mdefine_line|#define ESS_ENABLE_RE&t;&t;2
DECL|macro|ESS_STATE_MAGIC
mdefine_line|#define ESS_STATE_MAGIC&t;&t;0x125D1968
DECL|macro|ESS_CARD_MAGIC
mdefine_line|#define ESS_CARD_MAGIC&t;&t;0x19283746
DECL|macro|DAC_RUNNING
mdefine_line|#define DAC_RUNNING&t;&t;1
DECL|macro|ADC_RUNNING
mdefine_line|#define ADC_RUNNING&t;&t;2
DECL|variable|sample_size
r_static
r_const
r_int
id|sample_size
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|4
)brace
suffix:semicolon
DECL|variable|sample_shift
r_static
r_const
r_int
id|sample_shift
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|2
)brace
suffix:semicolon
DECL|enum|card_types_t
r_enum
id|card_types_t
(brace
DECL|enumerator|TYPE_MAESTRO
id|TYPE_MAESTRO
comma
DECL|enumerator|TYPE_MAESTRO2
id|TYPE_MAESTRO2
comma
DECL|enumerator|TYPE_MAESTRO2E
id|TYPE_MAESTRO2E
)brace
suffix:semicolon
DECL|variable|card_names
r_static
r_const
r_char
op_star
id|card_names
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|macro|SND_DEV_DSP16
mdefine_line|#define SND_DEV_DSP16   5 
multiline_comment|/* --------------------------------------------------------------------- */
DECL|struct|ess_state
r_struct
id|ess_state
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
multiline_comment|/* FIXME: we probably want submixers in here, but only one record pair */
DECL|member|apu
id|u8
id|apu
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Left, Right, Left In, Right In */
DECL|member|apu_mode
id|u8
id|apu_mode
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Running mode for this APU */
DECL|member|apu_pan
id|u8
id|apu_pan
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Panning setup for this APU */
DECL|member|card
r_struct
id|ess_card
op_star
id|card
suffix:semicolon
multiline_comment|/* Card info */
multiline_comment|/* wave stuff */
DECL|member|rateadc
DECL|member|ratedac
r_int
r_int
id|rateadc
comma
id|ratedac
suffix:semicolon
DECL|member|fmt
DECL|member|enable
r_int
r_char
id|fmt
comma
id|enable
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|open_sem
r_struct
id|semaphore
id|open_sem
suffix:semicolon
DECL|member|open_mode
id|mode_t
id|open_mode
suffix:semicolon
DECL|member|open_wait
id|wait_queue_head_t
id|open_wait
suffix:semicolon
multiline_comment|/* soundcore stuff */
DECL|member|dev_audio
r_int
id|dev_audio
suffix:semicolon
DECL|struct|dmabuf
r_struct
id|dmabuf
(brace
DECL|member|rawbuf
r_void
op_star
id|rawbuf
suffix:semicolon
DECL|member|buforder
r_int
id|buforder
suffix:semicolon
DECL|member|numfrag
r_int
id|numfrag
suffix:semicolon
DECL|member|fragshift
r_int
id|fragshift
suffix:semicolon
DECL|member|hwptr
DECL|member|swptr
r_int
id|hwptr
comma
id|swptr
suffix:semicolon
DECL|member|total_bytes
r_int
id|total_bytes
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
multiline_comment|/* over/underrun */
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
multiline_comment|/* redundant, but makes calculations easier */
DECL|member|fragsize
r_int
id|fragsize
suffix:semicolon
DECL|member|dmasize
r_int
id|dmasize
suffix:semicolon
DECL|member|fragsamples
r_int
id|fragsamples
suffix:semicolon
multiline_comment|/* OSS stuff */
DECL|member|mapped
r_int
id|mapped
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ready
r_int
id|ready
suffix:colon
l_int|1
suffix:semicolon
DECL|member|endcleared
r_int
id|endcleared
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ossfragshift
r_int
id|ossfragshift
suffix:semicolon
DECL|member|ossmaxfrags
r_int
id|ossmaxfrags
suffix:semicolon
DECL|member|subdivision
r_int
id|subdivision
suffix:semicolon
DECL|member|base
id|u16
id|base
suffix:semicolon
multiline_comment|/* Offset for ptr */
DECL|member|dma_dac
DECL|member|dma_adc
)brace
id|dma_dac
comma
id|dma_adc
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|ess_card
r_struct
id|ess_card
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
multiline_comment|/* We keep maestro cards in a linked list */
DECL|member|next
r_struct
id|ess_card
op_star
id|next
suffix:semicolon
DECL|member|dev_mixer
r_int
id|dev_mixer
suffix:semicolon
DECL|member|card_type
r_int
id|card_type
suffix:semicolon
multiline_comment|/* as most of this is static,&n;&t;&t;perhaps it should be a pointer to a global struct */
DECL|struct|mixer_goo
r_struct
id|mixer_goo
(brace
DECL|member|modcnt
r_int
id|modcnt
suffix:semicolon
DECL|member|supported_mixers
r_int
id|supported_mixers
suffix:semicolon
DECL|member|stereo_mixers
r_int
id|stereo_mixers
suffix:semicolon
DECL|member|record_sources
r_int
id|record_sources
suffix:semicolon
multiline_comment|/* the caller must guarantee arg sanity before calling these */
DECL|member|read_mixer
r_int
(paren
op_star
id|read_mixer
)paren
(paren
r_struct
id|ess_card
op_star
id|card
comma
r_int
id|index
)paren
suffix:semicolon
DECL|member|write_mixer
r_void
(paren
op_star
id|write_mixer
)paren
(paren
r_struct
id|ess_card
op_star
id|card
comma
r_int
id|mixer
comma
r_int
id|vol
)paren
suffix:semicolon
DECL|member|recmask_io
r_int
(paren
op_star
id|recmask_io
)paren
(paren
r_struct
id|ess_card
op_star
id|card
comma
r_int
id|rw
comma
r_int
id|mask
)paren
suffix:semicolon
DECL|member|mix
)brace
id|mix
suffix:semicolon
DECL|member|channels
r_struct
id|ess_state
id|channels
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|maestro_map
id|u16
id|maestro_map
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* Register map */
multiline_comment|/* hardware resources */
DECL|member|iobase
id|u32
id|iobase
suffix:semicolon
DECL|member|irq
id|u32
id|irq
suffix:semicolon
)brace
suffix:semicolon
DECL|function|ld2
r_extern
id|__inline__
r_int
id|ld2
c_func
(paren
r_int
r_int
id|x
)paren
(brace
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|x
op_ge
l_int|0x10000
)paren
(brace
id|x
op_rshift_assign
l_int|16
suffix:semicolon
id|r
op_add_assign
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|0x100
)paren
(brace
id|x
op_rshift_assign
l_int|8
suffix:semicolon
id|r
op_add_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|0x10
)paren
(brace
id|x
op_rshift_assign
l_int|4
suffix:semicolon
id|r
op_add_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|4
)paren
(brace
id|x
op_rshift_assign
l_int|2
suffix:semicolon
id|r
op_add_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|2
)paren
id|r
op_increment
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|devs
r_static
r_struct
id|ess_card
op_star
id|devs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; *&t;ESS Maestro AC97 codec programming interface.&n; */
DECL|function|maestro_ac97_set
r_static
r_void
id|maestro_ac97_set
c_func
(paren
r_int
id|io
comma
id|u8
id|cmd
comma
id|u16
id|val
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Wait for the codec bus to be free &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|io
op_plus
id|ESS_AC97_INDEX
)paren
op_amp
l_int|1
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;Write the bus&n;&t; */
id|outw
c_func
(paren
id|val
comma
id|io
op_plus
id|ESS_AC97_DATA
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* should actually be delaying 10 milliseconds? */
id|outb
c_func
(paren
id|cmd
comma
id|io
op_plus
id|ESS_AC97_INDEX
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|maestro_ac97_get
r_static
id|u16
id|maestro_ac97_get
c_func
(paren
r_int
id|io
comma
id|u8
id|cmd
)paren
(brace
r_int
id|sanity
op_assign
l_int|100000
suffix:semicolon
id|u16
id|data
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Wait for the codec bus to be free &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|io
op_plus
id|ESS_AC97_INDEX
)paren
op_amp
l_int|1
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|outb
c_func
(paren
id|cmd
op_or
l_int|0x80
comma
id|io
op_plus
id|ESS_AC97_INDEX
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|io
op_plus
id|ESS_AC97_INDEX
)paren
op_amp
l_int|1
)paren
(brace
id|sanity
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sanity
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;maestro: ac97 codec read timeout.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|data
op_assign
id|inw
c_func
(paren
id|io
op_plus
id|ESS_AC97_DATA
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;The Maestro can be wired to a standard AC97 compliant codec&n; *&t;(see www.intel.com for the pdf&squot;s on this), or to a PT101 codec&n; *&t;which appears to be the ES1918 (data sheet on the esstech.com.tw site)&n; *&n; *&t;The PT101 setup is untested.&n; */
DECL|function|maestro_ac97_init
r_static
id|u16
id|maestro_ac97_init
c_func
(paren
r_int
id|iobase
)paren
(brace
r_int
id|val
comma
id|seid
comma
id|caps
suffix:semicolon
id|u16
id|vend1
comma
id|vend2
suffix:semicolon
macro_line|#if 0 /* an experiment for another time */
multiline_comment|/* aim at the second codec */
id|outw
c_func
(paren
l_int|0x21
comma
id|iobase
op_plus
l_int|0x38
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x5555
comma
id|iobase
op_plus
l_int|0x3a
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x5555
comma
id|iobase
op_plus
l_int|0x3c
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|vend1
op_assign
id|maestro_ac97_get
c_func
(paren
id|iobase
comma
l_int|0x7c
)paren
suffix:semicolon
id|vend2
op_assign
id|maestro_ac97_get
c_func
(paren
id|iobase
comma
l_int|0x7e
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vend1
op_ne
l_int|0xffff
op_logical_or
id|vend2
op_ne
l_int|0xffff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;maestro: It seems you have a second codec: %x %x, please report this.&bslash;n&quot;
comma
id|vend1
comma
id|vend2
)paren
suffix:semicolon
)brace
multiline_comment|/* back to the first */
id|outw
c_func
(paren
l_int|0x0
comma
id|iobase
op_plus
l_int|0x38
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|iobase
op_plus
l_int|0x3a
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0
comma
id|iobase
op_plus
l_int|0x3c
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* should make sure we&squot;re ac97 2.1? */
id|vend1
op_assign
id|maestro_ac97_get
c_func
(paren
id|iobase
comma
l_int|0x7c
)paren
suffix:semicolon
id|vend2
op_assign
id|maestro_ac97_get
c_func
(paren
id|iobase
comma
l_int|0x7e
)paren
suffix:semicolon
id|val
op_assign
id|maestro_ac97_get
c_func
(paren
id|iobase
comma
l_int|0x00
)paren
suffix:semicolon
id|seid
op_assign
id|val
op_rshift
l_int|8
suffix:semicolon
id|caps
op_assign
id|val
op_amp
l_int|255
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;maestro: AC97 Codec detected: v: 0x%2x%2x 3d: 0x%x caps: 0x%x&bslash;n&quot;
comma
id|vend1
comma
id|vend2
comma
id|seid
comma
id|caps
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
r_int
)paren
(paren
id|vend1
op_lshift
l_int|16
)paren
op_or
id|vend2
)paren
(brace
multiline_comment|/* magic vendor specifc init code, _no_ idea what these do */
macro_line|#if 0
r_case
l_int|0x83847609
suffix:colon
multiline_comment|/* ESS 1921 */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x76
comma
l_int|0xABBA
)paren
suffix:semicolon
multiline_comment|/* o/~ Take a chance on me o/~ */
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x78
comma
l_int|0x3002
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x78
comma
l_int|0x3802
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* set master, headphone, master mono */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x02
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* always set headphones to max unmuted, OSS won&squot;t &n;&t;&t;let us change it :( */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x04
comma
l_int|0x0000
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x06
comma
l_int|0x0000
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x08
comma
l_int|0x0606
)paren
suffix:semicolon
multiline_comment|/* beep, phone, mic, line, cd video, aux */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x0A
comma
l_int|0x1F1F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x0C
comma
l_int|0x1F1F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x0E
comma
l_int|0x1F1F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x10
comma
l_int|0x1F1F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x12
comma
l_int|0x1F1F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x14
comma
l_int|0x1F1F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x16
comma
l_int|0x1F1F
)paren
suffix:semicolon
multiline_comment|/* unmute, but set pcm out to 1/2 */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x18
comma
l_int|0x0808
)paren
suffix:semicolon
multiline_comment|/* null record select */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x1A
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* record gain, record gain mic.. */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x1C
comma
l_int|0x0404
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x1E
comma
l_int|0x0404
)paren
suffix:semicolon
multiline_comment|/* null misc stuff */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x20
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* power up various units? */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x26
comma
l_int|0x000F
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|maestro_pt101_init
r_static
id|u16
id|maestro_pt101_init
c_func
(paren
r_int
id|iobase
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;maestro: PT101 Codec detected, initializing but _not_ installing mixer device.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* who knows.. */
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x2A
comma
l_int|0x0001
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x2C
comma
l_int|0x0000
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x2C
comma
l_int|0xFFFF
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x10
comma
l_int|0x9F1F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x12
comma
l_int|0x0808
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x14
comma
l_int|0x9F1F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x16
comma
l_int|0x9F1F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x18
comma
l_int|0x0404
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x1A
comma
l_int|0x0000
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x1C
comma
l_int|0x0000
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x02
comma
l_int|0x0404
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x04
comma
l_int|0x0808
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x0C
comma
l_int|0x801F
)paren
suffix:semicolon
id|maestro_ac97_set
c_func
(paren
id|iobase
comma
l_int|0x0E
comma
l_int|0x801F
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|maestro_ac97_reset
r_static
r_void
id|maestro_ac97_reset
c_func
(paren
r_int
id|ioaddr
)paren
(brace
id|outw
c_func
(paren
l_int|0x2000
comma
id|ioaddr
op_plus
l_int|0x36
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
l_int|0x36
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Indirect register access. Not all registers are readable so we&n; *&t;need to keep register state ourselves&n; */
DECL|macro|WRITEABLE_MAP
mdefine_line|#define WRITEABLE_MAP&t;0xEFFFFF
DECL|macro|READABLE_MAP
mdefine_line|#define READABLE_MAP&t;0x64003F
multiline_comment|/*&n; *&t;The Maestro engineers were a little indirection happy. These indirected&n; *&t;registers themselves include indirect registers at another layer&n; */
DECL|function|maestro_write
r_static
r_void
id|maestro_write
c_func
(paren
r_struct
id|ess_state
op_star
id|ess
comma
id|u16
id|reg
comma
id|u16
id|data
)paren
(brace
r_int
id|ioaddr
op_assign
id|ess-&gt;card-&gt;iobase
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
comma
id|ioaddr
op_plus
l_int|0x02
)paren
suffix:semicolon
id|outw
c_func
(paren
id|data
comma
id|ioaddr
op_plus
l_int|0x00
)paren
suffix:semicolon
id|ess-&gt;card-&gt;maestro_map
(braket
id|reg
)braket
op_assign
id|data
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|maestro_read
r_static
id|u16
id|maestro_read
c_func
(paren
r_struct
id|ess_state
op_star
id|ess
comma
id|u16
id|reg
)paren
(brace
r_int
id|ioaddr
op_assign
id|ess-&gt;card-&gt;iobase
suffix:semicolon
r_if
c_cond
(paren
id|READABLE_MAP
op_amp
(paren
l_int|1
op_lshift
id|reg
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
comma
id|ioaddr
op_plus
l_int|0x02
)paren
suffix:semicolon
id|ess-&gt;card-&gt;maestro_map
(braket
id|reg
)braket
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x00
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
id|ess-&gt;card-&gt;maestro_map
(braket
id|reg
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;These routines handle accessing the second level indirections to the&n; *&t;wave ram.&n; */
multiline_comment|/*&n; *&t;The register names are the ones ESS uses (see 104T31.ZIP)&n; */
DECL|macro|IDR0_DATA_PORT
mdefine_line|#define IDR0_DATA_PORT&t;&t;0x00
DECL|macro|IDR1_CRAM_POINTER
mdefine_line|#define IDR1_CRAM_POINTER&t;0x01
DECL|macro|IDR2_CRAM_DATA
mdefine_line|#define IDR2_CRAM_DATA&t;&t;0x02
DECL|macro|IDR3_WAVE_DATA
mdefine_line|#define IDR3_WAVE_DATA&t;&t;0x03
DECL|macro|IDR4_WAVE_PTR_LOW
mdefine_line|#define IDR4_WAVE_PTR_LOW&t;0x04
DECL|macro|IDR5_WAVE_PTR_HI
mdefine_line|#define IDR5_WAVE_PTR_HI&t;0x05
DECL|macro|IDR6_TIMER_CTRL
mdefine_line|#define IDR6_TIMER_CTRL&t;&t;0x06
DECL|macro|IDR7_WAVE_ROMRAM
mdefine_line|#define IDR7_WAVE_ROMRAM&t;0x07
DECL|function|apu_index_set
r_static
r_void
id|apu_index_set
c_func
(paren
r_struct
id|ess_state
op_star
id|ess
comma
id|u16
id|index
)paren
(brace
r_int
id|i
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
id|IDR1_CRAM_POINTER
comma
id|index
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|maestro_read
c_func
(paren
id|ess
comma
id|IDR1_CRAM_POINTER
)paren
op_eq
id|index
)paren
(brace
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;maestro: APU register select failed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|apu_data_set
r_static
r_void
id|apu_data_set
c_func
(paren
r_struct
id|ess_state
op_star
id|ess
comma
id|u16
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|maestro_read
c_func
(paren
id|ess
comma
id|IDR0_DATA_PORT
)paren
op_eq
id|data
)paren
(brace
r_return
suffix:semicolon
)brace
id|maestro_write
c_func
(paren
id|ess
comma
id|IDR0_DATA_PORT
comma
id|data
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;This is the public interface for APU manipulation. It handles the&n; *&t;interlock to avoid two APU writes in parallel etc. Don&squot;t diddle&n; *&t;directly with the stuff above.&n; */
DECL|function|apu_set_register
r_static
r_void
id|apu_set_register
c_func
(paren
r_struct
id|ess_state
op_star
id|ess
comma
id|u16
id|channel
comma
id|u8
id|reg
comma
id|u16
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_amp
id|ESS_CHAN_HARD
)paren
(brace
id|channel
op_and_assign
op_complement
id|ESS_CHAN_HARD
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|channel
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BAD CHANNEL %d.&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
)brace
r_else
id|channel
op_assign
id|ess-&gt;apu
(braket
id|channel
)braket
suffix:semicolon
)brace
id|reg
op_or_assign
(paren
id|channel
op_lshift
l_int|4
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|apu_index_set
c_func
(paren
id|ess
comma
id|reg
)paren
suffix:semicolon
id|apu_data_set
c_func
(paren
id|ess
comma
id|data
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|apu_get_register
r_static
id|u16
id|apu_get_register
c_func
(paren
r_struct
id|ess_state
op_star
id|ess
comma
id|u16
id|channel
comma
id|u8
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|v
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_amp
id|ESS_CHAN_HARD
)paren
(brace
id|channel
op_and_assign
op_complement
id|ESS_CHAN_HARD
suffix:semicolon
)brace
r_else
id|channel
op_assign
id|ess-&gt;apu
(braket
id|channel
)braket
suffix:semicolon
id|reg
op_or_assign
(paren
id|channel
op_lshift
l_int|4
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|apu_index_set
c_func
(paren
id|ess
comma
id|reg
)paren
suffix:semicolon
id|v
op_assign
id|maestro_read
c_func
(paren
id|ess
comma
id|IDR0_DATA_PORT
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|v
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;The wavecache does pci fetches for us and feeds&n; *&t;them to the APUs..  &n; *&t;XXX describe interface&n; */
DECL|function|wave_set_register
r_static
r_void
id|wave_set_register
c_func
(paren
r_struct
id|ess_state
op_star
id|ess
comma
id|u16
id|reg
comma
id|u16
id|value
)paren
(brace
r_int
id|ioaddr
op_assign
id|ess-&gt;card-&gt;iobase
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
comma
id|ioaddr
op_plus
l_int|0x10
)paren
suffix:semicolon
id|outw
c_func
(paren
id|value
comma
id|ioaddr
op_plus
l_int|0x12
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|wave_get_register
r_static
id|u16
id|wave_get_register
c_func
(paren
r_struct
id|ess_state
op_star
id|ess
comma
id|u16
id|reg
)paren
(brace
r_int
id|ioaddr
op_assign
id|ess-&gt;card-&gt;iobase
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|value
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
comma
id|ioaddr
op_plus
l_int|0x10
)paren
suffix:semicolon
id|value
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x12
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
DECL|function|sound_reset
r_static
r_void
id|sound_reset
c_func
(paren
r_int
id|ioaddr
)paren
(brace
id|outw
c_func
(paren
l_int|0x2000
comma
l_int|0x18
op_plus
id|ioaddr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
l_int|0x18
op_plus
id|ioaddr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
DECL|function|set_apu_fmt
r_static
r_void
id|set_apu_fmt
c_func
(paren
r_struct
id|ess_state
op_star
id|s
comma
r_int
id|apu
comma
r_int
id|mode
)paren
(brace
r_if
c_cond
(paren
id|mode
op_amp
id|ESS_CFMT_16BIT
)paren
(brace
id|s-&gt;apu_mode
(braket
id|apu
)braket
op_assign
l_int|0x10
suffix:semicolon
id|s-&gt;apu_mode
(braket
id|apu
op_plus
l_int|1
)braket
op_assign
l_int|0x10
suffix:semicolon
)brace
r_else
(brace
id|s-&gt;apu_mode
(braket
id|apu
)braket
op_assign
l_int|0x30
suffix:semicolon
id|s-&gt;apu_mode
(braket
id|apu
op_plus
l_int|1
)braket
op_assign
l_int|0x30
suffix:semicolon
)brace
)brace
DECL|function|set_fmt
r_static
r_void
id|set_fmt
c_func
(paren
r_struct
id|ess_state
op_star
id|s
comma
r_int
r_char
id|mask
comma
r_int
r_char
id|data
)paren
(brace
id|s-&gt;fmt
op_assign
(paren
id|s-&gt;fmt
op_amp
id|mask
)paren
op_or
id|data
suffix:semicolon
id|set_apu_fmt
c_func
(paren
id|s
comma
l_int|0
comma
id|s-&gt;fmt
op_amp
id|ESS_CFMT_MASK
)paren
suffix:semicolon
id|set_apu_fmt
c_func
(paren
id|s
comma
l_int|2
comma
(paren
id|s-&gt;fmt
op_rshift
id|ESS_CFMT_CSHIFT
)paren
op_amp
id|ESS_CFMT_MASK
)paren
suffix:semicolon
)brace
DECL|function|compute_rate
r_static
id|u16
id|compute_rate
c_func
(paren
id|u32
id|freq
)paren
(brace
r_if
c_cond
(paren
id|freq
op_eq
l_int|48000
)paren
(brace
r_return
l_int|0xFFFF
suffix:semicolon
)brace
id|freq
op_lshift_assign
l_int|16
suffix:semicolon
id|freq
op_div_assign
l_int|48000
suffix:semicolon
r_return
id|freq
suffix:semicolon
)brace
DECL|function|set_dac_rate
r_static
r_void
id|set_dac_rate
c_func
(paren
r_struct
id|ess_state
op_star
id|s
comma
r_int
id|rate
)paren
(brace
id|u32
id|freq
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|s-&gt;ratedac
op_assign
id|rate
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;fmt
op_amp
id|ESS_CFMT_16BIT
)paren
)paren
(brace
id|rate
op_rshift_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* who knows */
multiline_comment|/*&t;M_printk(&quot;computing dac rate %d with mode %d&bslash;n&quot;,rate,s-&gt;fmt);*/
id|freq
op_assign
id|compute_rate
c_func
(paren
id|rate
)paren
suffix:semicolon
multiline_comment|/* Load the frequency, turn on 6dB, turn off the effects */
id|apu_set_register
c_func
(paren
id|s
comma
l_int|0
comma
l_int|2
comma
(paren
id|freq
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
op_or
l_int|0x10
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|0
comma
l_int|3
comma
id|freq
op_rshift
l_int|8
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|1
comma
l_int|2
comma
(paren
id|freq
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
op_or
l_int|0x10
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|1
comma
l_int|3
comma
id|freq
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
DECL|function|set_adc_rate
r_static
r_void
id|set_adc_rate
c_func
(paren
r_struct
id|ess_state
op_star
id|s
comma
r_int
id|rate
)paren
(brace
id|u32
id|freq
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|s-&gt;rateadc
op_assign
id|rate
suffix:semicolon
id|freq
op_assign
id|compute_rate
c_func
(paren
id|rate
)paren
suffix:semicolon
multiline_comment|/* Load the frequency, turn on 6dB, turn off the effects */
id|apu_set_register
c_func
(paren
id|s
comma
l_int|2
comma
l_int|2
comma
(paren
id|freq
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
op_or
l_int|0x10
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|2
comma
l_int|3
comma
id|freq
op_rshift
l_int|8
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|3
comma
l_int|2
comma
(paren
id|freq
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
op_or
l_int|0x10
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|3
comma
l_int|3
comma
id|freq
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Native play back driver &n; */
DECL|function|ess_play_setup
r_static
r_void
id|ess_play_setup
c_func
(paren
r_struct
id|ess_state
op_star
id|ess
comma
r_int
id|mode
comma
id|u32
id|rate
comma
r_void
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
id|u32
id|pa
suffix:semicolon
id|u32
id|tmpval
suffix:semicolon
r_int
id|high_apu
op_assign
l_int|0
suffix:semicolon
r_int
id|channel
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;mode=%d rate=%d buf=%p len=%d.&bslash;n&quot;
comma
id|mode
comma
id|rate
comma
id|buffer
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* all maestro sizes are in 16bit words */
id|size
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* we&squot;re given the full size of the buffer, but&n;&t;in stereo each channel will only play its half */
r_if
c_cond
(paren
id|mode
op_amp
id|ESS_CFMT_STEREO
)paren
(brace
id|size
op_rshift_assign
l_int|1
suffix:semicolon
id|high_apu
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
op_le
id|high_apu
suffix:semicolon
id|channel
op_increment
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;To understand this it helps to know how the&n;&t;&t; *&t;wave cache works. There are 4 DSP wavecache &n;&t;&t; *&t;blocks which are 0x1FC-&gt;0x1FF. They are selected&n;&t;&t; *&t;by setting bits  22,21,20 of the address to&n;&t;&t; *&t;1 X Y   where X Y select the block.&n;&t;&t; *&n;&t;&t; *&t;In addition stereo pairing is supported. This is&n;&t;&t; *&t;set in the wave cache control for the channel as is&n;&t;&t; *&t;8bit unsigned.&n;&t;&t; *&n;&t;&t; *&t;Note that this causes a problem. With our limit of&n;&t;&t; *&t;about 12 full duplex pairs (48 channels active) we&n;&t;&t; *&t;will need to do a lot of juggling to get all the&n;&t;&t; *&t;memory we want sufficiently close together.&n;&t;&t; *&t;&n;&t;&t; *&t;Even with 64K blocks that means&n;&t;&t; *&t;&t;24 channel pairs&n;&t;&t; *&t;&t;6 pairs/block&n;&t;&t; *&t;&n;&t;&t; *&t;10K per channel pair = 5000 samples.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|channel
)paren
(brace
id|pa
op_assign
id|virt_to_bus
c_func
(paren
id|buffer
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* right channel plays its split half.&n;&t;&t;&t;*2 accomodates for rampant shifting earlier */
id|pa
op_assign
id|virt_to_bus
c_func
(paren
id|buffer
op_plus
id|size
op_star
l_int|2
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;sending pa %x to %d&bslash;n&quot;
comma
id|pa
comma
id|channel
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|ess
comma
l_int|0x01FC
comma
(paren
id|pa
op_amp
l_int|0xFFE00000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
multiline_comment|/* set the wavecache control reg */
id|tmpval
op_assign
(paren
id|pa
op_minus
l_int|0x10
)paren
op_amp
l_int|0xFFF8
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|mode
op_amp
l_int|1
)paren
(brace
id|tmpval
op_or_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* stereo */
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|mode
op_amp
l_int|2
)paren
)paren
(brace
id|tmpval
op_or_assign
l_int|4
suffix:semicolon
)brace
multiline_comment|/* 8bit */
id|wave_set_register
c_func
(paren
id|ess
comma
id|ess-&gt;apu
(braket
id|channel
)braket
op_lshift
l_int|3
comma
id|tmpval
)paren
suffix:semicolon
id|pa
op_and_assign
l_int|0x1FFFFF
suffix:semicolon
multiline_comment|/* Low 21 bits */
id|pa
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* words */
multiline_comment|/* base offset of dma calcs when reading the pointer&n;&t;&t;&t;on this left one */
r_if
c_cond
(paren
op_logical_neg
id|channel
)paren
(brace
id|ess-&gt;dma_dac.base
op_assign
id|pa
op_amp
l_int|0xFFFF
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|mode
op_amp
id|ESS_CFMT_STEREO
)paren
(brace
multiline_comment|/* Enable stereo */
id|pa
op_or_assign
l_int|0x00800000
suffix:semicolon
)brace
macro_line|#endif
id|pa
op_or_assign
l_int|0x00400000
suffix:semicolon
multiline_comment|/* System RAM */
multiline_comment|/* Begin loading the APU */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|15
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* clear all PBRs */
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
id|i
comma
l_int|0x0000
)paren
suffix:semicolon
)brace
multiline_comment|/* Load the frequency, turn on 6dB, turn off the effects */
multiline_comment|/*&t;&t;apu_set_register(ess, channel, 2, (rate&amp;0xFF)&lt;&lt;8|0x10);&n;&t;&t;apu_set_register(ess, channel, 3, rate&gt;&gt;8);*/
multiline_comment|/* Load the buffer into the wave engine */
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|4
comma
(paren
(paren
id|pa
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* XXX reg is little endian.. */
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|5
comma
id|pa
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|6
comma
(paren
id|pa
op_plus
id|size
)paren
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
multiline_comment|/* setting loop == sample len */
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|7
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* clear effects/env.. */
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|8
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* aplitudeNow to 0xd0? */
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|9
comma
l_int|0xD000
)paren
suffix:semicolon
multiline_comment|/* set the panning reg of the apu to left/right/mid.. */
multiline_comment|/* clear routing stuff */
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|11
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* mark dma and turn on filter stuff? */
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|0
comma
l_int|0x400F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|ESS_CFMT_STEREO
)paren
(brace
multiline_comment|/* set panning: left or right */
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|10
comma
l_int|0x8F00
op_or
(paren
id|channel
ques
c_cond
l_int|0x10
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_else
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|10
comma
l_int|0x8F08
)paren
suffix:semicolon
)brace
multiline_comment|/* clear WP interupts */
id|outw
c_func
(paren
l_int|1
comma
id|ess-&gt;card-&gt;iobase
op_plus
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* enable WP ints */
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ess-&gt;card-&gt;iobase
op_plus
l_int|0x18
)paren
op_or
l_int|4
comma
id|ess-&gt;card-&gt;iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|set_dac_rate
c_func
(paren
id|ess
comma
id|rate
)paren
suffix:semicolon
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
op_le
id|high_apu
suffix:semicolon
id|channel
op_increment
)paren
(brace
multiline_comment|/* Turn on the DMA */
r_if
c_cond
(paren
id|mode
op_amp
id|ESS_CFMT_16BIT
)paren
(brace
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|0
comma
(paren
id|apu_get_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
op_or
l_int|0x10
)paren
suffix:semicolon
id|ess-&gt;apu_mode
(braket
id|channel
)braket
op_assign
l_int|0x10
suffix:semicolon
)brace
r_else
(brace
id|apu_set_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|0
comma
(paren
id|apu_get_register
c_func
(paren
id|ess
comma
id|channel
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
op_or
l_int|0x30
)paren
suffix:semicolon
id|ess-&gt;apu_mode
(braket
id|channel
)braket
op_assign
l_int|0x30
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|set_dmaa
r_static
r_void
id|set_dmaa
c_func
(paren
r_struct
id|ess_state
op_star
id|s
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|count
)paren
(brace
)brace
DECL|function|set_dmac
r_static
r_void
id|set_dmac
c_func
(paren
r_struct
id|ess_state
op_star
id|s
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|count
)paren
(brace
)brace
multiline_comment|/* Playback pointer */
DECL|function|get_dmaa
r_extern
id|__inline__
r_int
id|get_dmaa
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
r_int
id|ioport
op_assign
id|s-&gt;card-&gt;iobase
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|outw
c_func
(paren
l_int|1
comma
id|ioport
op_plus
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
id|s-&gt;apu
(braket
l_int|0
)braket
op_lshift
l_int|4
op_or
l_int|5
comma
id|ioport
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioport
op_plus
l_int|2
)paren
suffix:semicolon
id|offset
op_assign
id|inw
c_func
(paren
id|ioport
)paren
suffix:semicolon
multiline_comment|/*&t;M_printk(&quot;dmaa: offset: %d, base: %d&bslash;n&quot;,offset,s-&gt;dma_dac.base);*/
id|offset
op_sub_assign
id|s-&gt;dma_dac.base
suffix:semicolon
r_return
(paren
id|offset
op_amp
l_int|0xFFFE
)paren
multiline_comment|/*&lt;&lt;1*/
suffix:semicolon
multiline_comment|/* XXX printk didn&squot;t have it */
)brace
multiline_comment|/* Record pointer */
DECL|function|get_dmac
r_extern
id|__inline__
r_int
id|get_dmac
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
r_int
id|ioport
op_assign
id|s-&gt;card-&gt;iobase
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|outw
c_func
(paren
l_int|1
comma
id|ioport
op_plus
l_int|2
)paren
suffix:semicolon
id|outw
c_func
(paren
id|s-&gt;apu
(braket
l_int|2
)braket
op_lshift
l_int|4
op_or
l_int|5
comma
id|ioport
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|ioport
op_plus
l_int|2
)paren
suffix:semicolon
id|offset
op_assign
id|inw
c_func
(paren
id|ioport
)paren
suffix:semicolon
multiline_comment|/* The offset is an address not a position relative to base */
r_return
(paren
id|offset
op_amp
l_int|0xFFFE
)paren
op_lshift
l_int|1
suffix:semicolon
multiline_comment|/* hardware is in words */
)brace
multiline_comment|/*&n; *&t;Meet Bob, the timer...&n; */
r_static
r_void
id|ess_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|macro|ESS_HW_TIMER
mdefine_line|#define ESS_HW_TIMER
macro_line|#ifndef ESS_HW_TIMER
multiline_comment|/* old kernel timer based timer ints, should BOB prove flakey */
DECL|variable|tmp_timer
r_static
r_struct
id|timer_list
id|tmp_timer
suffix:semicolon
DECL|variable|bob_stopped
r_static
r_int
id|bob_stopped
suffix:semicolon
DECL|function|ess_interrupt_fake
r_static
r_void
id|ess_interrupt_fake
c_func
(paren
r_int
r_int
id|v
)paren
(brace
id|ess_interrupt
c_func
(paren
l_int|5
comma
(paren
r_void
op_star
)paren
id|v
comma
l_int|NULL
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|tmp_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bob_stopped
)paren
(brace
id|tmp_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tmp_timer
)paren
suffix:semicolon
)brace
r_else
id|M_printk
c_func
(paren
l_string|&quot;Stopping bob (SW)&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|stop_bob
r_static
r_void
id|stop_bob
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
id|bob_stopped
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|kill_bob
r_static
r_void
id|kill_bob
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|tmp_timer
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;Killing bob (SW)&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|start_bob
r_static
r_void
id|start_bob
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
r_static
r_int
id|init
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|init
)paren
(brace
id|init
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|tmp_timer
)paren
suffix:semicolon
id|tmp_timer.function
op_assign
id|ess_interrupt_fake
suffix:semicolon
)brace
id|bob_stopped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|tmp_timer
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|tmp_timer
)paren
suffix:semicolon
id|tmp_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|tmp_timer.data
op_assign
(paren
r_int
r_int
)paren
id|s-&gt;card
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tmp_timer
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;Starting bob (SW)&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
multiline_comment|/* nice HW BOB implementation.  cheers, eric. */
DECL|function|stop_bob
r_static
r_void
id|stop_bob
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
multiline_comment|/* Mask IDR 11,17 */
id|maestro_write
c_func
(paren
id|s
comma
l_int|0x11
comma
id|maestro_read
c_func
(paren
id|s
comma
l_int|0x11
)paren
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|s
comma
l_int|0x17
comma
id|maestro_read
c_func
(paren
id|s
comma
l_int|0x17
)paren
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* eventually we could be clever and limit bob ints&n;&t;to the frequency at which our smallest duration&n;&t;chunks may expire */
DECL|function|start_bob
r_static
r_void
id|start_bob
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
id|stop_bob
c_func
(paren
id|s
)paren
suffix:semicolon
singleline_comment|// make sure bob&squot;s not already running
id|maestro_write
c_func
(paren
id|s
comma
l_int|6
comma
l_int|0x8000
op_or
(paren
l_int|1
op_lshift
l_int|12
)paren
op_or
(paren
l_int|5
op_lshift
l_int|5
)paren
op_or
l_int|11
)paren
suffix:semicolon
singleline_comment|// (50MHz/2^14)/12 = 254 Hz = 40 mS
multiline_comment|/* Now set IDR 11/17 */
id|maestro_write
c_func
(paren
id|s
comma
l_int|0x11
comma
id|maestro_read
c_func
(paren
id|s
comma
l_int|0x11
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|s
comma
l_int|0x17
comma
id|maestro_read
c_func
(paren
id|s
comma
l_int|0x17
)paren
op_or
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif 
singleline_comment|// ESS_HW_TIMER
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|adc_active
r_static
r_int
id|adc_active
op_assign
l_int|0
suffix:semicolon
DECL|function|stop_adc
r_extern
r_inline
r_void
id|stop_adc
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Stop left and right recording APU */
id|s-&gt;enable
op_and_assign
op_complement
id|ADC_RUNNING
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|2
comma
l_int|0
comma
id|apu_get_register
c_func
(paren
id|s
comma
l_int|2
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|3
comma
l_int|0
comma
id|apu_get_register
c_func
(paren
id|s
comma
l_int|3
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
suffix:semicolon
id|adc_active
op_and_assign
op_complement
l_int|1
suffix:semicolon
singleline_comment|//&t;if(!adc_active)
singleline_comment|//&t;&t;stop_bob(s);
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|stop_dac
r_extern
r_inline
r_void
id|stop_dac
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|s-&gt;enable
op_and_assign
op_complement
id|DAC_RUNNING
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|0
comma
l_int|0
comma
id|apu_get_register
c_func
(paren
id|s
comma
l_int|0
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|1
comma
l_int|0
comma
id|apu_get_register
c_func
(paren
id|s
comma
l_int|1
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
suffix:semicolon
id|adc_active
op_and_assign
op_complement
l_int|2
suffix:semicolon
singleline_comment|//&t;if(!adc_active)
singleline_comment|//&t;&t;stop_bob(s);
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|start_dac
r_static
r_void
id|start_dac
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s-&gt;dma_dac.mapped
op_logical_or
id|s-&gt;dma_dac.count
OG
l_int|0
)paren
op_logical_and
id|s-&gt;dma_dac.ready
)paren
(brace
id|s-&gt;enable
op_or_assign
id|DAC_RUNNING
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|0
comma
l_int|0
comma
(paren
id|apu_get_register
c_func
(paren
id|s
comma
l_int|0
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
op_or
id|s-&gt;apu_mode
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;fmt
op_amp
id|ESS_CFMT_STEREO
)paren
(brace
id|apu_set_register
c_func
(paren
id|s
comma
l_int|1
comma
l_int|0
comma
(paren
id|apu_get_register
c_func
(paren
id|s
comma
l_int|1
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
op_or
id|s-&gt;apu_mode
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//&t;if(!adc_active)
singleline_comment|//&t;&t;start_bob(s);
id|adc_active
op_or_assign
l_int|2
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|start_adc
r_static
r_void
id|start_adc
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s-&gt;dma_adc.mapped
op_logical_or
id|s-&gt;dma_adc.count
OL
(paren
r_int
)paren
(paren
id|s-&gt;dma_adc.dmasize
op_minus
l_int|2
op_star
id|s-&gt;dma_adc.fragsize
)paren
)paren
op_logical_and
id|s-&gt;dma_adc.ready
)paren
(brace
id|s-&gt;enable
op_or_assign
id|ADC_RUNNING
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|2
comma
l_int|0
comma
(paren
id|apu_get_register
c_func
(paren
id|s
comma
l_int|2
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
op_or
id|s-&gt;apu_mode
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|s
comma
l_int|3
comma
l_int|0
comma
(paren
id|apu_get_register
c_func
(paren
id|s
comma
l_int|3
comma
l_int|0
)paren
op_amp
l_int|0xFF0F
)paren
op_or
id|s-&gt;apu_mode
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
singleline_comment|//&t;if(!adc_active)
singleline_comment|//&t;&t;start_bob(s);
id|adc_active
op_or_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|DMABUF_DEFAULTORDER
mdefine_line|#define DMABUF_DEFAULTORDER (15-PAGE_SHIFT)
DECL|macro|DMABUF_MINORDER
mdefine_line|#define DMABUF_MINORDER 1
DECL|function|dealloc_dmabuf
r_static
r_void
id|dealloc_dmabuf
c_func
(paren
r_struct
id|dmabuf
op_star
id|db
)paren
(brace
r_int
r_int
id|map
comma
id|mapend
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;rawbuf
)paren
(brace
multiline_comment|/* undo marking the pages as reserved */
id|mapend
op_assign
id|MAP_NR
c_func
(paren
id|db-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|map
op_assign
id|MAP_NR
c_func
(paren
id|db-&gt;rawbuf
)paren
suffix:semicolon
id|map
op_le
id|mapend
suffix:semicolon
id|map
op_increment
)paren
id|clear_bit
c_func
(paren
id|PG_reserved
comma
op_amp
id|mem_map
(braket
id|map
)braket
dot
id|flags
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|db-&gt;rawbuf
comma
id|db-&gt;buforder
)paren
suffix:semicolon
)brace
id|db-&gt;rawbuf
op_assign
l_int|NULL
suffix:semicolon
id|db-&gt;mapped
op_assign
id|db-&gt;ready
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|prog_dmabuf
r_static
r_int
id|prog_dmabuf
c_func
(paren
r_struct
id|ess_state
op_star
id|s
comma
r_int
id|rec
)paren
(brace
r_struct
id|dmabuf
op_star
id|db
op_assign
id|rec
ques
c_cond
op_amp
id|s-&gt;dma_adc
suffix:colon
op_amp
id|s-&gt;dma_dac
suffix:semicolon
r_int
id|rate
op_assign
id|rec
ques
c_cond
id|s-&gt;rateadc
suffix:colon
id|s-&gt;ratedac
suffix:semicolon
r_int
id|order
suffix:semicolon
r_int
id|bytepersec
suffix:semicolon
r_int
id|bufs
suffix:semicolon
r_int
r_int
id|map
comma
id|mapend
suffix:semicolon
r_int
r_char
id|fmt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|fmt
op_assign
id|s-&gt;fmt
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
(brace
id|s-&gt;enable
op_and_assign
op_complement
id|ESS_ENABLE_RE
suffix:semicolon
id|fmt
op_rshift_assign
id|ESS_CFMT_CSHIFT
suffix:semicolon
)brace
r_else
(brace
id|s-&gt;enable
op_and_assign
op_complement
id|ESS_ENABLE_PE
suffix:semicolon
id|fmt
op_rshift_assign
id|ESS_CFMT_ASHIFT
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|db-&gt;hwptr
op_assign
id|db-&gt;swptr
op_assign
id|db-&gt;total_bytes
op_assign
id|db-&gt;count
op_assign
id|db-&gt;error
op_assign
id|db-&gt;endcleared
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|db-&gt;rawbuf
)paren
(brace
id|db-&gt;ready
op_assign
id|db-&gt;mapped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* alloc as big a chunk as we can */
r_for
c_loop
(paren
id|order
op_assign
id|DMABUF_DEFAULTORDER
suffix:semicolon
id|order
op_ge
id|DMABUF_MINORDER
op_logical_and
op_logical_neg
id|db-&gt;rawbuf
suffix:semicolon
id|order
op_decrement
)paren
id|db-&gt;rawbuf
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|db-&gt;rawbuf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|db-&gt;buforder
op_assign
id|order
suffix:semicolon
r_if
c_cond
(paren
(paren
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
op_xor
(paren
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
op_minus
l_int|1
)paren
)paren
op_amp
op_complement
l_int|0xffff
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maestro: DMA buffer crosses 64k boundary: busaddr 0x%lx  size %ld&bslash;n&quot;
comma
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
comma
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
op_minus
l_int|1
)paren
op_amp
op_complement
l_int|0xffffff
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maestro: DMA buffer beyond 16MB: busaddr 0x%lx  size %ld&bslash;n&quot;
comma
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
comma
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
suffix:semicolon
multiline_comment|/* now mark the pages as reserved; otherwise remap_page_range doesn&squot;t do what we want */
id|mapend
op_assign
id|MAP_NR
c_func
(paren
id|db-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|map
op_assign
id|MAP_NR
c_func
(paren
id|db-&gt;rawbuf
)paren
suffix:semicolon
id|map
op_le
id|mapend
suffix:semicolon
id|map
op_increment
)paren
id|set_bit
c_func
(paren
id|PG_reserved
comma
op_amp
id|mem_map
(braket
id|map
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
id|bytepersec
op_assign
id|rate
op_lshift
id|sample_shift
(braket
id|fmt
)braket
suffix:semicolon
id|bufs
op_assign
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;ossfragshift
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1000
op_lshift
id|db-&gt;ossfragshift
)paren
OL
id|bytepersec
)paren
id|db-&gt;fragshift
op_assign
id|ld2
c_func
(paren
id|bytepersec
op_div
l_int|1000
)paren
suffix:semicolon
r_else
id|db-&gt;fragshift
op_assign
id|db-&gt;ossfragshift
suffix:semicolon
)brace
r_else
(brace
id|db-&gt;fragshift
op_assign
id|ld2
c_func
(paren
id|bytepersec
op_div
l_int|100
op_div
(paren
id|db-&gt;subdivision
ques
c_cond
id|db-&gt;subdivision
suffix:colon
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;fragshift
OL
l_int|3
)paren
id|db-&gt;fragshift
op_assign
l_int|3
suffix:semicolon
)brace
id|db-&gt;numfrag
op_assign
id|bufs
op_rshift
id|db-&gt;fragshift
suffix:semicolon
r_while
c_loop
(paren
id|db-&gt;numfrag
template_param
l_int|3
)paren
(brace
id|db-&gt;fragshift
op_decrement
suffix:semicolon
id|db-&gt;numfrag
op_assign
id|bufs
op_rshift
id|db-&gt;fragshift
suffix:semicolon
)brace
id|db-&gt;fragsize
op_assign
l_int|1
op_lshift
id|db-&gt;fragshift
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;ossmaxfrags
op_ge
l_int|4
op_logical_and
id|db-&gt;ossmaxfrags
OL
id|db-&gt;numfrag
)paren
id|db-&gt;numfrag
op_assign
id|db-&gt;ossmaxfrags
suffix:semicolon
id|db-&gt;fragsamples
op_assign
id|db-&gt;fragsize
op_rshift
id|sample_shift
(braket
id|fmt
)braket
suffix:semicolon
id|db-&gt;dmasize
op_assign
id|db-&gt;numfrag
op_lshift
id|db-&gt;fragshift
suffix:semicolon
id|memset
c_func
(paren
id|db-&gt;rawbuf
comma
(paren
id|fmt
op_amp
id|ESS_CFMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
comma
id|db-&gt;dmasize
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
(brace
id|set_dmac
c_func
(paren
id|s
comma
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
comma
id|db-&gt;numfrag
op_lshift
id|db-&gt;fragshift
)paren
suffix:semicolon
multiline_comment|/* program enhanced mode registers */
multiline_comment|/* FILL */
)brace
r_else
(brace
singleline_comment|//set_dmaa(s, virt_to_bus(db-&gt;rawbuf), db-&gt;numfrag &lt;&lt; db-&gt;fragshift);
multiline_comment|/* program enhanced mode registers */
multiline_comment|/* FILL */
singleline_comment|//set_dac_rate(s, s-&gt;ratedac);&t;// redundant
id|ess_play_setup
c_func
(paren
id|s
comma
id|fmt
comma
id|s-&gt;ratedac
comma
id|db-&gt;rawbuf
comma
id|db-&gt;numfrag
op_lshift
id|db-&gt;fragshift
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|db-&gt;ready
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|clear_advance
r_extern
id|__inline__
r_void
id|clear_advance
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
r_int
r_char
id|c
op_assign
(paren
id|s-&gt;fmt
op_amp
(paren
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_ASHIFT
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
id|s-&gt;dma_dac.rawbuf
suffix:semicolon
r_int
id|bsize
op_assign
id|s-&gt;dma_dac.dmasize
suffix:semicolon
r_int
id|bptr
op_assign
id|s-&gt;dma_dac.swptr
suffix:semicolon
r_int
id|len
op_assign
id|s-&gt;dma_dac.fragsize
suffix:semicolon
r_if
c_cond
(paren
id|bptr
op_plus
id|len
OG
id|bsize
)paren
(brace
r_int
id|x
op_assign
id|bsize
op_minus
id|bptr
suffix:semicolon
id|memset
c_func
(paren
id|buf
op_plus
id|bptr
comma
id|c
comma
id|x
)paren
suffix:semicolon
multiline_comment|/* account for wrapping? */
id|bptr
op_assign
l_int|0
suffix:semicolon
id|len
op_sub_assign
id|x
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buf
op_plus
id|bptr
comma
id|c
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* call with spinlock held! */
DECL|function|ess_update_ptr
r_static
r_void
id|ess_update_ptr
c_func
(paren
r_struct
id|ess_state
op_star
id|s
)paren
(brace
r_int
id|hwptr
suffix:semicolon
r_int
id|diff
suffix:semicolon
multiline_comment|/* update ADC pointer */
r_if
c_cond
(paren
id|s-&gt;dma_adc.ready
)paren
(brace
id|M_printk
c_func
(paren
l_string|&quot;adc ready.. &bslash;n&quot;
)paren
suffix:semicolon
id|hwptr
op_assign
(paren
multiline_comment|/*s-&gt;dma_adc.dmasize - */
id|get_dmac
c_func
(paren
id|s
)paren
)paren
op_mod
id|s-&gt;dma_adc.dmasize
suffix:semicolon
id|diff
op_assign
(paren
id|s-&gt;dma_adc.dmasize
op_plus
id|hwptr
op_minus
id|s-&gt;dma_adc.hwptr
)paren
op_mod
id|s-&gt;dma_adc.dmasize
suffix:semicolon
id|s-&gt;dma_adc.hwptr
op_assign
id|hwptr
suffix:semicolon
id|s-&gt;dma_adc.total_bytes
op_add_assign
id|diff
suffix:semicolon
id|s-&gt;dma_adc.count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_adc.fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|s-&gt;dma_adc.wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.mapped
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
OG
(paren
r_int
)paren
(paren
id|s-&gt;dma_adc.dmasize
op_minus
(paren
(paren
l_int|3
op_star
id|s-&gt;dma_adc.fragsize
)paren
op_rshift
l_int|1
)paren
)paren
)paren
(brace
id|s-&gt;enable
op_and_assign
op_complement
id|ESS_ENABLE_RE
suffix:semicolon
multiline_comment|/* FILL ME */
singleline_comment|//&t;&t;&t;&t;wrindir(s, SV_CIENABLE, s-&gt;enable);
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.error
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* update DAC pointer */
r_if
c_cond
(paren
id|s-&gt;dma_dac.ready
)paren
(brace
id|hwptr
op_assign
(paren
multiline_comment|/*s-&gt;dma_dac.dmasize -*/
id|get_dmaa
c_func
(paren
id|s
)paren
)paren
op_mod
id|s-&gt;dma_dac.dmasize
suffix:semicolon
id|diff
op_assign
(paren
id|s-&gt;dma_dac.dmasize
op_plus
id|hwptr
op_minus
id|s-&gt;dma_dac.hwptr
)paren
op_mod
id|s-&gt;dma_dac.dmasize
suffix:semicolon
multiline_comment|/*&t;&t;M_printk(&quot;updating dac: hwptr: %d diff: %d&bslash;n&quot;,hwptr,diff);*/
id|s-&gt;dma_dac.hwptr
op_assign
id|hwptr
suffix:semicolon
id|s-&gt;dma_dac.total_bytes
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
(brace
id|s-&gt;dma_dac.count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|s-&gt;dma_dac.count
op_sub_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_le
l_int|0
)paren
(brace
id|s-&gt;enable
op_and_assign
op_complement
id|ESS_ENABLE_PE
suffix:semicolon
multiline_comment|/* FILL ME */
singleline_comment|//&t;&t;&t;&t;wrindir(s, SV_CIENABLE, s-&gt;enable);
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.error
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_le
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
op_logical_and
op_logical_neg
id|s-&gt;dma_dac.endcleared
)paren
(brace
id|clear_advance
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.endcleared
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_plus
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
op_le
(paren
r_int
)paren
id|s-&gt;dma_dac.dmasize
)paren
id|wake_up
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|ess_interrupt
r_static
r_void
id|ess_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|ess_state
op_star
id|s
suffix:semicolon
r_struct
id|ess_card
op_star
id|c
op_assign
(paren
r_struct
id|ess_card
op_star
)paren
id|dev_id
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|event
suffix:semicolon
id|event
op_assign
id|inb
c_func
(paren
id|c-&gt;iobase
op_plus
l_int|0x1A
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|c-&gt;iobase
op_plus
l_int|4
)paren
op_amp
l_int|1
comma
id|c-&gt;iobase
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/*&t;M_printk(&quot;maestro int: %x&bslash;n&quot;,event);*/
r_if
c_cond
(paren
id|event
op_amp
(paren
l_int|1
op_lshift
l_int|6
)paren
)paren
(brace
multiline_comment|/* XXX if we have a hw volume control int enable&n;&t;&t;&t;all the ints?  doesn&squot;t make sense.. */
id|event
op_assign
id|inw
c_func
(paren
id|c-&gt;iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xFF
comma
id|c-&gt;iobase
op_plus
l_int|0x1A
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* else ack &squot;em all, i imagine */
id|outb
c_func
(paren
l_int|0xFF
comma
id|c-&gt;iobase
op_plus
l_int|0x1A
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Update the pointers for all APU&squot;s we are running.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|s
op_assign
op_amp
id|c-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dev_audio
op_eq
op_minus
l_int|1
)paren
(brace
r_break
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|s-&gt;lock
)paren
suffix:semicolon
id|ess_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|s-&gt;lock
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|invalid_magic
r_static
r_const
r_char
id|invalid_magic
(braket
)braket
op_assign
id|KERN_CRIT
l_string|&quot;maestro: invalid magic value in %s&bslash;n&quot;
suffix:semicolon
DECL|macro|VALIDATE_MAGIC
mdefine_line|#define VALIDATE_MAGIC(FOO,MAG)                         &bslash;&n;({                                                &bslash;&n;&t;if (!(FOO) || (FOO)-&gt;magic != MAG) { &bslash;&n;&t;&t;printk(invalid_magic,__FUNCTION__);            &bslash;&n;&t;&t;return -ENXIO;                    &bslash;&n;&t;}                                         &bslash;&n;})
DECL|macro|VALIDATE_STATE
mdefine_line|#define VALIDATE_STATE(a) VALIDATE_MAGIC(a,ESS_STATE_MAGIC)
DECL|macro|VALIDATE_CARD
mdefine_line|#define VALIDATE_CARD(a) VALIDATE_MAGIC(a,ESS_CARD_MAGIC)
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/* ac97 mixer routines.  */
DECL|macro|AC97_STEREO_MASK
mdefine_line|#define AC97_STEREO_MASK (SOUND_MASK_VOLUME|&bslash;&n;&t;SOUND_MASK_PCM|SOUND_MASK_LINE|SOUND_MASK_CD|&bslash;&n;&t;SOUND_MASK_VIDEO|SOUND_MASK_LINE1|SOUND_MASK_IGAIN)
DECL|macro|AC97_SUPPORTED_MASK
mdefine_line|#define AC97_SUPPORTED_MASK (AC97_STEREO_MASK | &bslash;&n;&t;SOUND_MASK_BASS|SOUND_MASK_TREBLE|SOUND_MASK_MIC|&bslash;&n;&t;SOUND_MASK_SPEAKER)
DECL|macro|AC97_RECORD_MASK
mdefine_line|#define AC97_RECORD_MASK (SOUND_MASK_MIC|&bslash;&n;&t;SOUND_MASK_CD| SOUND_MASK_VIDEO| SOUND_MASK_LINE1| SOUND_MASK_LINE|&bslash;&n;&t;SOUND_MASK_PHONEIN)
DECL|macro|supported_mixer
mdefine_line|#define supported_mixer(CARD,FOO) ( CARD-&gt;mix.supported_mixers &amp; (1&lt;&lt;FOO) )
DECL|struct|ac97_mixer_hw
r_static
r_struct
id|ac97_mixer_hw
(brace
DECL|member|offset
r_int
r_char
id|offset
suffix:semicolon
DECL|member|scale
r_int
id|scale
suffix:semicolon
DECL|variable|ac97_hw
)brace
id|ac97_hw
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_VOLUME
)braket
op_assign
(brace
l_int|0x02
comma
l_int|63
)brace
comma
(braket
id|SOUND_MIXER_BASS
)braket
op_assign
(brace
l_int|0x08
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_TREBLE
)braket
op_assign
(brace
l_int|0x08
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_SPEAKER
)braket
op_assign
(brace
l_int|0x0a
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
(brace
l_int|0x0e
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_LINE
)braket
op_assign
(brace
l_int|0x10
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_CD
)braket
op_assign
(brace
l_int|0x12
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_VIDEO
)braket
op_assign
(brace
l_int|0x14
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_LINE1
)braket
op_assign
(brace
l_int|0x16
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_PCM
)braket
op_assign
(brace
l_int|0x18
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_IGAIN
)braket
op_assign
(brace
l_int|0x1c
comma
l_int|31
)brace
)brace
suffix:semicolon
multiline_comment|/* reads the given OSS mixer from the ac97&n;&t;the caller must have insured that the ac97 knows&n;&t;about that given mixer, and should be holding a&n;&t;spinlock for the card */
DECL|function|ac97_read_mixer
r_static
r_int
id|ac97_read_mixer
c_func
(paren
r_struct
id|ess_card
op_star
id|card
comma
r_int
id|mixer
)paren
(brace
id|u16
id|val
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|ac97_mixer_hw
op_star
id|mh
op_assign
op_amp
id|ac97_hw
(braket
id|mixer
)braket
suffix:semicolon
id|val
op_assign
id|maestro_ac97_get
c_func
(paren
id|card-&gt;iobase
comma
id|mh-&gt;offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AC97_STEREO_MASK
op_amp
(paren
l_int|1
op_lshift
id|mixer
)paren
)paren
(brace
multiline_comment|/* nice stereo mixers .. */
r_int
id|left
comma
id|right
suffix:semicolon
id|left
op_assign
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|right
op_assign
id|val
op_amp
l_int|0x7f
suffix:semicolon
id|right
op_assign
l_int|100
op_minus
(paren
(paren
id|right
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
id|left
op_assign
l_int|100
op_minus
(paren
(paren
id|left
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
id|ret
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_SPEAKER
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
(paren
id|val
op_amp
l_int|0x1e
)paren
op_rshift
l_int|1
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_MIC
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0x1f
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
multiline_comment|/*  the low bit is optional in the tone sliders and masking&n;&t;&t;it lets is avoid the 0xf &squot;bypass&squot;.. */
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_BASS
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xe
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_TREBLE
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0xe
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
id|M_printk
c_func
(paren
l_string|&quot;read mixer %d (0x%x) %x -&gt; %x&bslash;n&quot;
comma
id|mixer
comma
id|mh-&gt;offset
comma
id|val
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* write the OSS encoded volume to the given OSS encoded mixer,&n;&t;again caller&squot;s job to make sure all is well in arg land,&n;&t;call with spinlock held */
DECL|function|ac97_write_mixer
r_static
r_void
id|ac97_write_mixer
c_func
(paren
r_struct
id|ess_card
op_star
id|card
comma
r_int
id|mixer
comma
r_int
id|vol
)paren
(brace
id|u16
id|val
op_assign
l_int|0
suffix:semicolon
r_int
id|left
comma
id|right
suffix:semicolon
r_struct
id|ac97_mixer_hw
op_star
id|mh
op_assign
op_amp
id|ac97_hw
(braket
id|mixer
)braket
suffix:semicolon
multiline_comment|/* cleanse input a little */
id|right
op_assign
(paren
(paren
id|vol
op_rshift
l_int|8
)paren
op_amp
l_int|0x7f
)paren
suffix:semicolon
id|left
op_assign
(paren
id|vol
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
(brace
id|right
op_assign
l_int|100
suffix:semicolon
)brace
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
(brace
id|left
op_assign
l_int|100
suffix:semicolon
)brace
id|M_printk
c_func
(paren
l_string|&quot;wrote mixer %d (0x%x) %d,%d&quot;
comma
id|mixer
comma
id|mh-&gt;offset
comma
id|left
comma
id|right
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AC97_STEREO_MASK
op_amp
(paren
l_int|1
op_lshift
id|mixer
)paren
)paren
(brace
multiline_comment|/* stereo mixers */
id|right
op_assign
(paren
(paren
l_int|100
op_minus
id|right
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
id|val
op_assign
(paren
id|left
op_lshift
l_int|8
)paren
op_or
id|right
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_SPEAKER
)paren
(brace
id|val
op_assign
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
op_lshift
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_MIC
)paren
(brace
id|val
op_assign
id|maestro_ac97_get
c_func
(paren
id|card-&gt;iobase
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x001f
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
suffix:semicolon
multiline_comment|/*  the low bit is optional in the tone sliders and masking&n;&t;&t;it lets is avoid the 0xf &squot;bypass&squot;.. */
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_BASS
)paren
(brace
id|val
op_assign
id|maestro_ac97_get
c_func
(paren
id|card-&gt;iobase
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x0f00
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
op_lshift
l_int|8
)paren
op_amp
l_int|0xe0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_TREBLE
)paren
(brace
id|val
op_assign
id|maestro_ac97_get
c_func
(paren
id|card-&gt;iobase
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x000f
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
op_amp
l_int|0xe
suffix:semicolon
)brace
id|maestro_ac97_set
c_func
(paren
id|card-&gt;iobase
comma
id|mh-&gt;offset
comma
id|val
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot; -&gt; %x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
)brace
DECL|enum|ac97_recsettings
r_enum
id|ac97_recsettings
(brace
DECL|enumerator|AC97_REC_MIC
id|AC97_REC_MIC
op_assign
l_int|0
comma
DECL|enumerator|AC97_REC_CD
id|AC97_REC_CD
comma
DECL|enumerator|AC97_REC_VIDEO
id|AC97_REC_VIDEO
comma
DECL|enumerator|AC97_REC_AUX
id|AC97_REC_AUX
comma
DECL|enumerator|AC97_REC_LINE
id|AC97_REC_LINE
comma
DECL|enumerator|AC97_REC_STEREO
id|AC97_REC_STEREO
comma
multiline_comment|/* combination of all enabled outputs..  */
DECL|enumerator|AC97_REC_MONO
id|AC97_REC_MONO
comma
multiline_comment|/*.. or the mono equivalent */
DECL|enumerator|AC97_REC_PHONE
id|AC97_REC_PHONE
)brace
suffix:semicolon
DECL|variable|ac97_rm2oss
r_static
r_int
r_int
id|ac97_rm2oss
(braket
)braket
op_assign
(brace
(braket
id|AC97_REC_MIC
)braket
op_assign
id|SOUND_MASK_MIC
comma
(braket
id|AC97_REC_CD
)braket
op_assign
id|SOUND_MASK_CD
comma
(braket
id|AC97_REC_VIDEO
)braket
op_assign
id|SOUND_MASK_VIDEO
comma
(braket
id|AC97_REC_AUX
)braket
op_assign
id|SOUND_MASK_LINE1
comma
(braket
id|AC97_REC_LINE
)braket
op_assign
id|SOUND_MASK_LINE
comma
(braket
id|AC97_REC_PHONE
)braket
op_assign
id|SOUND_MASK_PHONEIN
)brace
suffix:semicolon
multiline_comment|/* indexed by bit position, XXX dependant on OSS header internals */
DECL|variable|ac97_oss_rm
r_static
r_int
r_int
id|ac97_oss_rm
(braket
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
id|AC97_REC_MIC
comma
(braket
id|SOUND_MIXER_CD
)braket
op_assign
id|AC97_REC_CD
comma
(braket
id|SOUND_MIXER_VIDEO
)braket
op_assign
id|AC97_REC_VIDEO
comma
(braket
id|SOUND_MIXER_LINE1
)braket
op_assign
id|AC97_REC_AUX
comma
(braket
id|SOUND_MIXER_LINE
)braket
op_assign
id|AC97_REC_LINE
comma
(braket
id|SOUND_MIXER_PHONEIN
)braket
op_assign
id|AC97_REC_PHONE
)brace
suffix:semicolon
multiline_comment|/* read or write the recmask &n;&t;the ac97 can really have left and right recording&n;&t;inputs independantly set, but OSS doesn&squot;t seem to &n;&t;want us to express that to the user. &n;&t;the caller guarantees that we have a supported bit set,&n;&t;and they must be holding the card&squot;s spinlock */
DECL|function|ac97_recmask_io
r_static
r_int
id|ac97_recmask_io
c_func
(paren
r_struct
id|ess_card
op_star
id|card
comma
r_int
id|rw
comma
r_int
id|mask
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|rw
)paren
(brace
multiline_comment|/* read it from the card */
id|val
op_assign
id|maestro_ac97_get
c_func
(paren
id|card-&gt;iobase
comma
l_int|0x1a
)paren
op_amp
l_int|0x7
suffix:semicolon
r_return
id|ac97_rm2oss
(braket
id|val
)braket
suffix:semicolon
)brace
multiline_comment|/* else, write the first set in the mask as the&n;&t;&t;output */
id|val
op_assign
id|ffs
c_func
(paren
id|mask
)paren
suffix:semicolon
id|val
op_assign
id|ac97_oss_rm
(braket
id|val
op_minus
l_int|1
)braket
suffix:semicolon
id|val
op_or_assign
id|val
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* set both channels */
id|maestro_ac97_set
c_func
(paren
id|card-&gt;iobase
comma
l_int|0x1a
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|ac97_mixer_ioctl
r_static
r_int
id|ac97_mixer_ioctl
c_func
(paren
r_struct
id|ess_card
op_star
id|card
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|val
op_assign
l_int|0
suffix:semicolon
r_struct
id|ess_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
l_int|0
)braket
suffix:semicolon
id|VALIDATE_CARD
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_INFO
)paren
(brace
id|mixer_info
id|info
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
id|info.modify_counter
op_assign
id|card-&gt;mix.modcnt
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_OLD_MIXER_INFO
)paren
(brace
id|_old_mixer_info
id|info
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|OSS_GETVERSION
)paren
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
op_ne
l_char|&squot;M&squot;
op_logical_or
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
op_ne
r_sizeof
(paren
r_int
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
id|_IOC_READ
)paren
(brace
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
multiline_comment|/* give them the current record source */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|val
op_assign
id|card-&gt;mix
dot
id|recmask_io
c_func
(paren
id|card
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
multiline_comment|/* give them the supported mixers */
id|val
op_assign
id|card-&gt;mix.supported_mixers
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
multiline_comment|/* Arg contains a bit for each supported recording source */
id|val
op_assign
id|card-&gt;mix.record_sources
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
multiline_comment|/* Mixer channels supporting stereo */
id|val
op_assign
id|card-&gt;mix.stereo_mixers
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
id|val
op_assign
id|SOUND_CAP_EXCL_INPUT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* read a specific mixer */
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|card
comma
id|i
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|val
op_assign
id|card-&gt;mix
dot
id|read_mixer
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_ne
(paren
id|_IOC_WRITE
op_or
id|_IOC_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|card-&gt;mix.modcnt
op_increment
suffix:semicolon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
multiline_comment|/* Arg contains a bit for each recording source */
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_and_assign
id|card-&gt;mix.record_sources
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|card-&gt;mix
dot
id|recmask_io
c_func
(paren
id|card
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|card
comma
id|i
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|card-&gt;mix
dot
id|write_mixer
c_func
(paren
id|card
comma
id|i
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|ess_llseek
r_static
id|loff_t
id|ess_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|ess_open_mixdev
r_static
r_int
id|ess_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|ess_card
op_star
id|card
op_assign
id|devs
suffix:semicolon
r_while
c_loop
(paren
id|card
op_logical_and
id|card-&gt;dev_mixer
op_ne
id|minor
)paren
id|card
op_assign
id|card-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|file-&gt;private_data
op_assign
id|card
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ess_release_mixdev
r_static
r_int
id|ess_release_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|ess_card
op_star
id|card
op_assign
(paren
r_struct
id|ess_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|VALIDATE_CARD
c_func
(paren
id|card
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ess_ioctl_mixdev
r_static
r_int
id|ess_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ess_card
op_star
id|card
op_assign
(paren
r_struct
id|ess_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|VALIDATE_CARD
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|ac97_mixer_ioctl
c_func
(paren
id|card
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|variable|ess_mixer_fops
r_static
multiline_comment|/*const*/
r_struct
id|file_operations
id|ess_mixer_fops
op_assign
(brace
op_amp
id|ess_llseek
comma
l_int|NULL
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll */
op_amp
id|ess_ioctl_mixdev
comma
l_int|NULL
comma
multiline_comment|/* mmap */
op_amp
id|ess_open_mixdev
comma
l_int|NULL
comma
multiline_comment|/* flush */
op_amp
id|ess_release_mixdev
comma
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* check_media_change */
l_int|NULL
comma
multiline_comment|/* revalidate */
l_int|NULL
comma
multiline_comment|/* lock */
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|drain_dac
r_static
r_int
id|drain_dac
c_func
(paren
r_struct
id|ess_state
op_star
id|s
comma
r_int
id|nonblock
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
comma
id|tmo
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
op_logical_or
op_logical_neg
id|s-&gt;dma_dac.ready
)paren
r_return
l_int|0
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
id|s-&gt;dma_dac.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|tmo
op_assign
(paren
id|count
op_star
id|HZ
)paren
op_div
id|s-&gt;ratedac
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
(paren
id|s-&gt;fmt
op_rshift
id|ESS_CFMT_ASHIFT
)paren
op_amp
id|ESS_CFMT_MASK
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schedule_timeout
c_func
(paren
id|tmo
ques
c_cond
suffix:colon
l_int|1
)paren
op_logical_and
id|tmo
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maestro: dma timed out??&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|ess_read
r_static
id|ssize_t
id|ess_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|ess_state
op_star
id|s
op_assign
(paren
r_struct
id|ess_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
multiline_comment|/* for damned dual players */
r_int
id|cnt
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ess_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|swptr
op_assign
id|s-&gt;dma_adc.swptr
suffix:semicolon
id|cnt
op_assign
id|s-&gt;dma_adc.dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
OL
id|cnt
)paren
id|cnt
op_assign
id|s-&gt;dma_adc.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|s-&gt;dma_adc.wait
comma
id|HZ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maestro: read: chip lockup? dmasz %u fragsz %u count %i hwptr %u swptr %u&bslash;n&quot;
comma
id|s-&gt;dma_adc.dmasize
comma
id|s-&gt;dma_adc.fragsize
comma
id|s-&gt;dma_adc.count
comma
id|s-&gt;dma_adc.hwptr
comma
id|s-&gt;dma_adc.swptr
)paren
suffix:semicolon
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_dmac
c_func
(paren
id|s
comma
id|virt_to_bus
c_func
(paren
id|s-&gt;dma_adc.rawbuf
)paren
comma
id|s-&gt;dma_adc.numfrag
op_lshift
id|s-&gt;dma_adc.fragshift
)paren
suffix:semicolon
multiline_comment|/* program enhanced mode registers */
multiline_comment|/* FILL ME */
singleline_comment|//&t;&t;&t;&t;wrindir(s, SV_CIDMACBASECOUNT1, (s-&gt;dma_adc.fragsamples-1) &gt;&gt; 8);
singleline_comment|//&t;&t;&t;&t;wrindir(s, SV_CIDMACBASECOUNT0, s-&gt;dma_adc.fragsamples-1);
id|s-&gt;dma_adc.count
op_assign
id|s-&gt;dma_adc.hwptr
op_assign
id|s-&gt;dma_adc.swptr
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|s-&gt;dma_adc.rawbuf
op_plus
id|swptr
comma
id|cnt
)paren
)paren
r_return
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EFAULT
suffix:semicolon
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|s-&gt;dma_adc.dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|s-&gt;dma_adc.swptr
op_assign
id|swptr
suffix:semicolon
id|s-&gt;dma_adc.count
op_sub_assign
id|cnt
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* god this is gross..*/
DECL|function|split_stereo
r_int
id|split_stereo
c_func
(paren
r_int
r_char
op_star
id|real_buffer
comma
r_int
r_char
op_star
id|tmp_buffer
comma
r_int
id|offset
comma
r_int
id|count
comma
r_int
id|bufsize
comma
r_int
id|mode
)paren
(brace
multiline_comment|/* oh, bother.&t;stereo decoding APU&squot;s don&squot;t work in 16bit so we&n;&t;use dual linear decoders.  which means we have to hack up stereo&n;&t;buffer&squot;s we&squot;re given.  yuck. &n;&n;&t;and we have to be able to work a byte at a time..*/
r_int
r_char
op_star
id|so
comma
op_star
id|left
comma
op_star
id|right
suffix:semicolon
r_int
id|i
suffix:semicolon
id|so
op_assign
id|tmp_buffer
suffix:semicolon
id|left
op_assign
id|real_buffer
op_plus
id|offset
suffix:semicolon
id|right
op_assign
id|real_buffer
op_plus
id|bufsize
op_div
l_int|2
op_plus
id|offset
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;writing %d to %p and %p from %p:%d bufs: %d&bslash;n&quot;
comma
id|count
op_div
l_int|2
comma
id|left
comma
id|right
comma
id|real_buffer
comma
id|offset
comma
id|bufsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|ESS_CFMT_16BIT
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
id|count
op_div
l_int|4
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
op_star
(paren
id|right
op_increment
)paren
op_assign
(paren
op_star
(paren
id|so
op_plus
l_int|2
)paren
)paren
suffix:semicolon
op_star
(paren
id|right
op_increment
)paren
op_assign
(paren
op_star
(paren
id|so
op_plus
l_int|3
)paren
)paren
suffix:semicolon
op_star
(paren
id|left
op_increment
)paren
op_assign
(paren
op_star
id|so
)paren
suffix:semicolon
op_star
(paren
id|left
op_increment
)paren
op_assign
(paren
op_star
(paren
id|so
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|so
op_add_assign
l_int|4
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
id|count
op_div
l_int|2
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
op_star
(paren
id|right
op_increment
)paren
op_assign
(paren
op_star
(paren
id|so
op_plus
l_int|1
)paren
)paren
suffix:semicolon
op_star
(paren
id|left
op_increment
)paren
op_assign
(paren
op_star
id|so
)paren
suffix:semicolon
id|so
op_add_assign
l_int|2
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ess_write
r_static
id|ssize_t
id|ess_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|ess_state
op_star
id|s
op_assign
(paren
r_struct
id|ess_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
r_char
op_star
id|splitbuf
op_assign
l_int|NULL
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_dac.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* I wish we could be more clever than this */
r_if
c_cond
(paren
op_logical_neg
(paren
id|splitbuf
op_assign
id|kmalloc
c_func
(paren
id|count
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ess_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
OL
l_int|0
)paren
(brace
id|s-&gt;dma_dac.count
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|s-&gt;dma_dac.hwptr
suffix:semicolon
)brace
id|swptr
op_assign
id|s-&gt;dma_dac.swptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;fmt
op_amp
id|ESS_CFMT_STEREO
)paren
(brace
multiline_comment|/* in stereo we have the &squot;dual&squot; buffers.. */
id|cnt
op_assign
(paren
(paren
id|s-&gt;dma_dac.dmasize
op_div
l_int|2
)paren
op_minus
id|swptr
)paren
op_star
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|cnt
op_assign
id|s-&gt;dma_dac.dmasize
op_minus
id|swptr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_plus
id|cnt
OG
id|s-&gt;dma_dac.dmasize
)paren
id|cnt
op_assign
id|s-&gt;dma_dac.dmasize
op_minus
id|s-&gt;dma_dac.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
multiline_comment|/* our goofball stereo splitter can only deal in mults of 4 */
r_if
c_cond
(paren
id|cnt
OG
l_int|0
)paren
id|cnt
op_and_assign
op_complement
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
multiline_comment|/* buffer is full, wait for it to be played */
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_goto
id|return_free
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
id|HZ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;maestro: write: chip lockup? dmasz %u fragsz %u count %i hwptr %u swptr %u&bslash;n&quot;
comma
id|s-&gt;dma_dac.dmasize
comma
id|s-&gt;dma_dac.fragsize
comma
id|s-&gt;dma_dac.count
comma
id|s-&gt;dma_dac.hwptr
comma
id|s-&gt;dma_dac.swptr
)paren
suffix:semicolon
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_dmaa
c_func
(paren
id|s
comma
id|virt_to_bus
c_func
(paren
id|s-&gt;dma_dac.rawbuf
)paren
comma
id|s-&gt;dma_dac.numfrag
op_lshift
id|s-&gt;dma_dac.fragshift
)paren
suffix:semicolon
multiline_comment|/* program enhanced mode registers */
singleline_comment|//&t;&t;&t;&t;wrindir(s, SV_CIDMAABASECOUNT1, (s-&gt;dma_dac.fragsamples-1) &gt;&gt; 8);
singleline_comment|//&t;&t;&t;&t;wrindir(s, SV_CIDMAABASECOUNT0, s-&gt;dma_dac.fragsamples-1);
multiline_comment|/* FILL ME */
id|s-&gt;dma_dac.count
op_assign
id|s-&gt;dma_dac.hwptr
op_assign
id|s-&gt;dma_dac.swptr
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|return_free
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;fmt
op_amp
id|ESS_CFMT_STEREO
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|splitbuf
comma
id|buffer
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|return_free
suffix:semicolon
)brace
id|split_stereo
c_func
(paren
id|s-&gt;dma_dac.rawbuf
comma
id|splitbuf
comma
id|swptr
comma
id|cnt
comma
id|s-&gt;dma_dac.dmasize
comma
id|s-&gt;fmt
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|s-&gt;dma_dac.rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|return_free
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|s-&gt;fmt
op_amp
id|ESS_CFMT_STEREO
)paren
(brace
multiline_comment|/* again with the weird pointer magic*/
id|swptr
op_assign
(paren
id|swptr
op_plus
(paren
id|cnt
op_div
l_int|2
)paren
)paren
op_mod
(paren
id|s-&gt;dma_dac.dmasize
op_div
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|s-&gt;dma_dac.dmasize
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|swptr
suffix:semicolon
id|s-&gt;dma_dac.count
op_add_assign
id|cnt
suffix:semicolon
id|s-&gt;dma_dac.endcleared
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|return_free
suffix:colon
r_if
c_cond
(paren
id|splitbuf
)paren
id|kfree
c_func
(paren
id|splitbuf
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ess_poll
r_static
r_int
r_int
id|ess_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|ess_state
op_star
id|s
op_assign
(paren
r_struct
id|ess_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|s-&gt;dma_dac.wait
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|s-&gt;dma_adc.wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ess_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_adc.fragsize
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|s-&gt;dma_dac.dmasize
op_ge
id|s-&gt;dma_dac.count
op_plus
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/* this needs to be fixed to deal with the dualing apus/buffers */
macro_line|#if 0
r_static
r_int
id|ess_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|ess_state
op_star
id|s
op_assign
(paren
r_struct
id|ess_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|db
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|db
op_assign
op_amp
id|s-&gt;dma_dac
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|db
op_assign
op_amp
id|s-&gt;dma_adc
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma-&gt;vm_start
comma
id|virt_to_phys
c_func
(paren
id|db-&gt;rawbuf
)paren
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|db-&gt;mapped
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ess_ioctl
r_static
r_int
id|ess_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ess_state
op_star
id|s
op_assign
(paren
r_struct
id|ess_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|audio_buf_info
id|abinfo
suffix:semicolon
id|count_info
id|cinfo
suffix:semicolon
r_int
id|val
comma
id|mapped
comma
id|ret
suffix:semicolon
r_int
r_char
id|fmtm
comma
id|fmtd
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
id|mapped
op_assign
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
id|s-&gt;dma_dac.mapped
)paren
op_logical_or
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
op_logical_and
id|s-&gt;dma_adc.mapped
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|drain_dac
c_func
(paren
id|s
comma
l_int|0
multiline_comment|/*file-&gt;f_flags &amp; O_NONBLOCK*/
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
id|put_user
c_func
(paren
l_int|0
multiline_comment|/*DSP_CAP_DUPLEX | DSP_CAP_REALTIME | DSP_CAP_TRIGGER | DSP_CAP_MMAP*/
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|s-&gt;dma_dac.hwptr
op_assign
id|s-&gt;dma_dac.count
op_assign
id|s-&gt;dma_dac.total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|s-&gt;dma_adc.swptr
op_assign
id|s-&gt;dma_adc.hwptr
op_assign
id|s-&gt;dma_adc.count
op_assign
id|s-&gt;dma_adc.total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
id|set_adc_rate
c_func
(paren
id|s
comma
id|val
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
id|set_dac_rate
c_func
(paren
id|s
comma
id|val
)paren
suffix:semicolon
)brace
)brace
r_return
id|put_user
c_func
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
id|s-&gt;rateadc
suffix:colon
id|s-&gt;ratedac
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|fmtd
op_assign
l_int|0
suffix:semicolon
id|fmtm
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|fmtd
op_or_assign
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_CSHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_CSHIFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|fmtd
op_or_assign
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_ASHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_ASHIFT
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmtd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
id|fmtd
op_assign
l_int|0
suffix:semicolon
id|fmtm
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
id|fmtd
op_or_assign
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_CSHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_CSHIFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
id|fmtd
op_or_assign
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_ASHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_ASHIFT
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmtd
)paren
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_CSHIFT
)paren
suffix:colon
(paren
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_ASHIFT
)paren
)paren
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask */
r_return
id|put_user
c_func
(paren
id|AFMT_S8
op_or
id|AFMT_S16_LE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Selects ONE fmt*/
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
id|fmtd
op_assign
l_int|0
suffix:semicolon
id|fmtm
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|fmtd
op_or_assign
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_CSHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_CSHIFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|fmtd
op_or_assign
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_ASHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_ASHIFT
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmtd
)paren
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_CSHIFT
)paren
suffix:colon
(paren
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_ASHIFT
)paren
)paren
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_S8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETTRIGGER
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|s-&gt;enable
op_amp
id|ESS_ENABLE_RE
)paren
id|val
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|s-&gt;enable
op_amp
id|ESS_ENABLE_PE
)paren
id|val
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_INPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_OUTPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_dac.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;enable
op_amp
id|ESS_ENABLE_PE
)paren
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ess_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|s-&gt;dma_dac.fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|s-&gt;dma_dac.dmasize
op_minus
id|s-&gt;dma_dac.count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|s-&gt;dma_dac.numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|s-&gt;dma_dac.fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;enable
op_amp
id|ESS_ENABLE_RE
)paren
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ess_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|s-&gt;dma_adc.fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|s-&gt;dma_adc.count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|s-&gt;dma_adc.numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|s-&gt;dma_adc.fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ess_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|val
op_assign
id|s-&gt;dma_dac.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ess_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|s-&gt;dma_adc.total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|s-&gt;dma_adc.count
op_rshift
id|s-&gt;dma_adc.fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|s-&gt;dma_adc.hwptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.mapped
)paren
id|s-&gt;dma_adc.count
op_and_assign
id|s-&gt;dma_adc.fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ess_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|s-&gt;dma_dac.total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|s-&gt;dma_dac.count
op_rshift
id|s-&gt;dma_dac.fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|s-&gt;dma_dac.hwptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
id|s-&gt;dma_dac.count
op_and_assign
id|s-&gt;dma_dac.fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|s-&gt;dma_dac.fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|s-&gt;dma_adc.fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|s-&gt;dma_adc.ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|s-&gt;dma_adc.ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ossfragshift
OL
l_int|4
)paren
id|s-&gt;dma_adc.ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ossfragshift
OG
l_int|15
)paren
id|s-&gt;dma_adc.ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ossmaxfrags
OL
l_int|4
)paren
id|s-&gt;dma_adc.ossmaxfrags
op_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|s-&gt;dma_dac.ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|s-&gt;dma_dac.ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.ossfragshift
OL
l_int|4
)paren
id|s-&gt;dma_dac.ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.ossfragshift
OG
l_int|15
)paren
id|s-&gt;dma_dac.ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.ossmaxfrags
OL
l_int|4
)paren
id|s-&gt;dma_dac.ossmaxfrags
op_assign
l_int|4
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SUBDIVIDE
suffix:colon
r_if
c_cond
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|s-&gt;dma_adc.subdivision
)paren
op_logical_or
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|s-&gt;dma_dac.subdivision
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|1
op_logical_and
id|val
op_ne
l_int|2
op_logical_and
id|val
op_ne
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|s-&gt;dma_adc.subdivision
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|s-&gt;dma_dac.subdivision
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
id|s-&gt;rateadc
suffix:colon
id|s-&gt;ratedac
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_CSHIFT
)paren
suffix:colon
(paren
id|ESS_CFMT_STEREO
op_lshift
id|ESS_CFMT_ASHIFT
)paren
)paren
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_CSHIFT
)paren
suffix:colon
(paren
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_ASHIFT
)paren
)paren
)paren
ques
c_cond
l_int|16
suffix:colon
l_int|8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SNDCTL_DSP_SETSYNCRO
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|//&t;return mixer_ioctl(s, cmd, arg);
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ess_open
r_static
r_int
id|ess_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|ess_card
op_star
id|c
op_assign
id|devs
suffix:semicolon
r_struct
id|ess_state
op_star
id|s
op_assign
l_int|NULL
comma
op_star
id|sp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|fmtm
op_assign
op_complement
l_int|0
comma
id|fmts
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Scan the cards and find the channel. We only&n;&t; *&t;do this at open time so it is ok&n;&t; */
r_while
c_loop
(paren
id|c
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sp
op_assign
op_amp
id|c-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;dev_audio
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sp-&gt;dev_audio
op_xor
id|minor
)paren
op_amp
op_complement
l_int|0xf
)paren
(brace
r_continue
suffix:semicolon
)brace
id|s
op_assign
id|sp
suffix:semicolon
)brace
id|c
op_assign
id|c-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|s
suffix:semicolon
multiline_comment|/* wait for device to become free */
id|down
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
r_while
c_loop
(paren
id|s-&gt;open_mode
op_amp
id|file-&gt;f_mode
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|s-&gt;open_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|down
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|fmtm
op_and_assign
op_complement
(paren
(paren
id|ESS_CFMT_STEREO
op_or
id|ESS_CFMT_16BIT
)paren
op_lshift
id|ESS_CFMT_CSHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0xf
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|fmts
op_or_assign
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_CSHIFT
suffix:semicolon
id|s-&gt;dma_adc.ossfragshift
op_assign
id|s-&gt;dma_adc.ossmaxfrags
op_assign
id|s-&gt;dma_adc.subdivision
op_assign
l_int|0
suffix:semicolon
id|set_adc_rate
c_func
(paren
id|s
comma
l_int|8000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|fmtm
op_and_assign
op_complement
(paren
(paren
id|ESS_CFMT_STEREO
op_or
id|ESS_CFMT_16BIT
)paren
op_lshift
id|ESS_CFMT_ASHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0xf
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|fmts
op_or_assign
id|ESS_CFMT_16BIT
op_lshift
id|ESS_CFMT_ASHIFT
suffix:semicolon
id|s-&gt;dma_dac.ossfragshift
op_assign
id|s-&gt;dma_dac.ossmaxfrags
op_assign
id|s-&gt;dma_dac.subdivision
op_assign
l_int|0
suffix:semicolon
id|set_dac_rate
c_func
(paren
id|s
comma
l_int|8000
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmts
)paren
suffix:semicolon
id|s-&gt;open_mode
op_or_assign
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|start_bob
c_func
(paren
id|s
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ess_release
r_static
r_int
id|ess_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|ess_state
op_star
id|s
op_assign
(paren
r_struct
id|ess_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|drain_dac
c_func
(paren
id|s
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
op_amp
id|s-&gt;dma_dac
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
op_amp
id|s-&gt;dma_adc
)paren
suffix:semicolon
)brace
id|s-&gt;open_mode
op_and_assign
(paren
op_complement
id|file-&gt;f_mode
)paren
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|stop_bob
c_func
(paren
id|s
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|s-&gt;open_wait
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ess_audio_fops
r_static
multiline_comment|/*const*/
r_struct
id|file_operations
id|ess_audio_fops
op_assign
(brace
op_amp
id|ess_llseek
comma
op_amp
id|ess_read
comma
op_amp
id|ess_write
comma
l_int|NULL
comma
multiline_comment|/* readdir */
op_amp
id|ess_poll
comma
op_amp
id|ess_ioctl
comma
l_int|NULL
comma
multiline_comment|/* XXX &amp;ess_mmap, */
op_amp
id|ess_open
comma
l_int|NULL
comma
multiline_comment|/* flush */
op_amp
id|ess_release
comma
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* check_media_change */
l_int|NULL
comma
multiline_comment|/* revalidate */
l_int|NULL
comma
multiline_comment|/* lock */
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&t;XXX get rid of this&n; *&t;maximum number of devices &n; */
DECL|macro|NR_DEVICE
mdefine_line|#define NR_DEVICE 4
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|maestro_install
r_static
r_int
id|maestro_install
c_func
(paren
r_struct
id|pci_dev
op_star
id|pcidev
comma
r_int
id|card_type
comma
r_int
id|index
)paren
(brace
id|u16
id|w
suffix:semicolon
id|u32
id|n
suffix:semicolon
r_int
id|iobase
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|ess_card
op_star
id|card
suffix:semicolon
r_struct
id|ess_state
op_star
id|ess
suffix:semicolon
r_int
id|apu
suffix:semicolon
r_int
id|num
op_assign
l_int|0
suffix:semicolon
id|iobase
op_assign
id|pcidev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ess_card
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;maestro: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|card
)paren
)paren
suffix:semicolon
id|card-&gt;iobase
op_assign
id|iobase
suffix:semicolon
id|card-&gt;card_type
op_assign
id|card_type
suffix:semicolon
id|card-&gt;irq
op_assign
id|pcidev-&gt;irq
suffix:semicolon
id|card-&gt;next
op_assign
id|devs
suffix:semicolon
id|card-&gt;magic
op_assign
id|ESS_CARD_MAGIC
suffix:semicolon
id|devs
op_assign
id|card
suffix:semicolon
multiline_comment|/* init our 8 groups of 4 apus */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ess_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
id|s-&gt;card
op_assign
id|card
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;dma_adc.wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;open_wait
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|s-&gt;magic
op_assign
id|ESS_STATE_MAGIC
suffix:semicolon
id|s-&gt;apu
(braket
l_int|0
)braket
op_assign
l_int|4
op_star
id|i
suffix:semicolon
id|s-&gt;apu
(braket
l_int|1
)braket
op_assign
(paren
l_int|4
op_star
id|i
)paren
op_plus
l_int|1
suffix:semicolon
id|s-&gt;apu
(braket
l_int|2
)braket
op_assign
(paren
l_int|4
op_star
id|i
)paren
op_plus
l_int|2
suffix:semicolon
id|s-&gt;apu
(braket
l_int|3
)braket
op_assign
(paren
l_int|4
op_star
id|i
)paren
op_plus
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ready
op_logical_or
id|s-&gt;dma_dac.ready
op_logical_or
id|s-&gt;dma_adc.rawbuf
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BOTCH!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* register devices */
r_if
c_cond
(paren
(paren
id|s-&gt;dev_audio
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|ess_audio_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|num
op_assign
id|i
suffix:semicolon
multiline_comment|/* clear the rest if we ran out of slots to register */
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ess_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
id|s-&gt;dev_audio
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|ess
op_assign
op_amp
id|card-&gt;channels
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Ok card ready. Begin setup proper&n;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;maestro: Configuring %s at 0x%04X&bslash;n&quot;
comma
id|card_names
(braket
id|card_type
)braket
comma
id|iobase
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Disable ACPI&n;&t; */
id|pci_write_config_dword
c_func
(paren
id|pcidev
comma
l_int|0x54
comma
l_int|0x00000000
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pcidev
comma
l_int|0x56
comma
l_int|0x00000000
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Use TDMA for now. TDMA works on all boards, so while its&n;&t; *&t;not the most efficient its the simplest.&n;&t; */
id|pci_read_config_word
c_func
(paren
id|pcidev
comma
l_int|0x50
comma
op_amp
id|w
)paren
suffix:semicolon
multiline_comment|/* Clear DMA bits */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|10
op_or
l_int|1
op_lshift
l_int|9
op_or
l_int|1
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* TDMA on */
id|w
op_or_assign
(paren
l_int|1
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* XXX do we care about these two ? */
multiline_comment|/*&n;&t; *&t;MPU at 330&n;&t; */
id|w
op_and_assign
op_complement
(paren
(paren
l_int|1
op_lshift
l_int|4
)paren
op_or
(paren
l_int|1
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;SB at 0x220&n;&t; */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|2
)paren
suffix:semicolon
macro_line|#if 0 /* huh?  its sub decode.. */
multiline_comment|/*&n;&t; *&t;Reserved write as 0&n;&t; */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; *&t;Some of these are undocumented bits&n;&t; */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|13
)paren
op_or
(paren
l_int|1
op_lshift
l_int|14
)paren
suffix:semicolon
multiline_comment|/* PIC Snoop mode bits */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|11
)paren
suffix:semicolon
multiline_comment|/* Safeguard off */
id|w
op_or_assign
(paren
l_int|1
op_lshift
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Posted write */
id|w
op_or_assign
(paren
l_int|1
op_lshift
l_int|6
)paren
suffix:semicolon
multiline_comment|/* ISA timing on */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Subtractive decode off */
multiline_comment|/* XXX huh?  claims to be reserved.. */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t swap left/right */
id|pci_write_config_word
c_func
(paren
id|pcidev
comma
l_int|0x50
comma
id|w
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pcidev
comma
l_int|0x52
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|15
)paren
suffix:semicolon
multiline_comment|/* Turn off internal clock multiplier */
multiline_comment|/* XXX how do we know which to use? */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|14
)paren
suffix:semicolon
multiline_comment|/* External clock */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|7
)paren
suffix:semicolon
multiline_comment|/* HWV off */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Debounce off */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|5
)paren
suffix:semicolon
multiline_comment|/* GPIO 4:5 */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Disconnect from the CHI */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|3
)paren
suffix:semicolon
multiline_comment|/* IDMA off (undocumented) */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* MIDI fix off (undoc) */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* reserved, always write 0 */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
multiline_comment|/* IRQ to ISA off (undoc) */
id|pci_write_config_word
c_func
(paren
id|pcidev
comma
l_int|0x52
comma
id|w
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;DDMA off&n;&t; */
id|pci_read_config_word
c_func
(paren
id|pcidev
comma
l_int|0x60
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pcidev
comma
l_int|0x60
comma
id|w
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Legacy mode&n;&t; */
id|pci_read_config_word
c_func
(paren
id|pcidev
comma
l_int|0x40
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_or_assign
(paren
l_int|1
op_lshift
l_int|15
)paren
suffix:semicolon
multiline_comment|/* legacy decode off */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|14
)paren
suffix:semicolon
multiline_comment|/* Disable SIRQ */
id|w
op_and_assign
op_complement
(paren
l_int|0x1f
)paren
suffix:semicolon
multiline_comment|/* disable mpu irq/io, game port, fm, SB */
id|pci_write_config_word
c_func
(paren
id|pcidev
comma
l_int|0x40
comma
id|w
)paren
suffix:semicolon
id|sound_reset
c_func
(paren
id|iobase
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Reset the CODEC&n;&t; */
id|maestro_ac97_reset
c_func
(paren
id|iobase
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Ring Bus Setup&n;&t; */
id|n
op_assign
id|inl
c_func
(paren
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_and_assign
op_complement
l_int|0xF000
suffix:semicolon
id|n
op_or_assign
l_int|12
op_lshift
l_int|12
suffix:semicolon
multiline_comment|/* Direct Sound, Stereo */
id|n
op_assign
id|inl
c_func
(paren
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_and_assign
op_complement
l_int|0x0F00
suffix:semicolon
multiline_comment|/* Modem off */
id|outl
c_func
(paren
id|n
comma
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_assign
id|inl
c_func
(paren
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_and_assign
op_complement
l_int|0x00F0
suffix:semicolon
id|n
op_or_assign
l_int|9
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* DAC, Stereo */
id|outl
c_func
(paren
id|n
comma
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_assign
id|inl
c_func
(paren
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_and_assign
op_complement
l_int|0x000F
suffix:semicolon
multiline_comment|/* ASSP off */
id|outl
c_func
(paren
id|n
comma
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_assign
id|inl
c_func
(paren
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_or_assign
(paren
l_int|1
op_lshift
l_int|29
)paren
suffix:semicolon
multiline_comment|/* Enable ring bus */
id|outl
c_func
(paren
id|n
comma
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_assign
id|inl
c_func
(paren
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_or_assign
(paren
l_int|1
op_lshift
l_int|28
)paren
suffix:semicolon
multiline_comment|/* Enable serial bus */
id|outl
c_func
(paren
id|n
comma
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_assign
id|inl
c_func
(paren
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_and_assign
op_complement
l_int|0x00F00000
suffix:semicolon
multiline_comment|/* MIC off */
id|outl
c_func
(paren
id|n
comma
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_assign
id|inl
c_func
(paren
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|n
op_and_assign
op_complement
l_int|0x000F0000
suffix:semicolon
multiline_comment|/* I2S off */
id|outl
c_func
(paren
id|n
comma
id|iobase
op_plus
l_int|0x34
)paren
suffix:semicolon
id|w
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|7
)paren
suffix:semicolon
multiline_comment|/* ClkRun off */
id|outw
c_func
(paren
id|w
comma
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Harpo off */
id|outw
c_func
(paren
id|w
comma
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|4
)paren
suffix:semicolon
multiline_comment|/* ASSP irq off */
id|outw
c_func
(paren
id|w
comma
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|3
)paren
suffix:semicolon
multiline_comment|/* ISDN irq off */
id|outw
c_func
(paren
id|w
comma
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_or_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Direct Sound IRQ on */
id|outw
c_func
(paren
id|w
comma
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* MPU401 IRQ off */
id|outw
c_func
(paren
id|w
comma
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|w
op_or_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SB IRQ on */
id|outw
c_func
(paren
id|w
comma
id|iobase
op_plus
l_int|0x18
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
l_int|0xA4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|3
comma
id|iobase
op_plus
l_int|0xA2
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
l_int|0xA6
)paren
suffix:semicolon
r_for
c_loop
(paren
id|apu
op_assign
l_int|0
suffix:semicolon
id|apu
OL
l_int|16
suffix:semicolon
id|apu
op_increment
)paren
(brace
multiline_comment|/* Write 0 into the buffer area 0x1E0-&gt;1EF */
id|outw
c_func
(paren
l_int|0x01E0
op_plus
id|apu
comma
l_int|0x10
op_plus
id|iobase
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
l_int|0x12
op_plus
id|iobase
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The 1.10 test program seem to write 0 into the buffer area&n;&t;&t; * 0x1D0-0x1DF too.&n;&t;&t; */
id|outw
c_func
(paren
l_int|0x01D0
op_plus
id|apu
comma
l_int|0x10
op_plus
id|iobase
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
l_int|0x12
op_plus
id|iobase
)paren
suffix:semicolon
)brace
macro_line|#if 1
id|wave_set_register
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
comma
(paren
id|wave_get_register
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
)paren
op_amp
l_int|0xFF00
)paren
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
comma
id|wave_get_register
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
)paren
op_or
l_int|0x100
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
comma
id|wave_get_register
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
)paren
op_amp
op_complement
l_int|0x200
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
comma
id|wave_get_register
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
)paren
op_or
op_complement
l_int|0x400
)paren
suffix:semicolon
macro_line|#else&t;&t;
id|maestro_write
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
comma
(paren
id|maestro_read
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
)paren
op_amp
l_int|0xFF00
)paren
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
comma
id|maestro_read
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
)paren
op_or
l_int|0x100
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
comma
id|maestro_read
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
)paren
op_amp
op_complement
l_int|0x200
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
comma
id|maestro_read
c_func
(paren
id|ess
comma
id|IDR7_WAVE_ROMRAM
)paren
op_or
l_int|0x400
)paren
suffix:semicolon
macro_line|#endif
id|maestro_write
c_func
(paren
id|ess
comma
id|IDR2_CRAM_DATA
comma
l_int|0x0000
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
l_int|0x08
comma
l_int|0xB004
)paren
suffix:semicolon
multiline_comment|/* Now back to the DirectSound stuff */
id|maestro_write
c_func
(paren
id|ess
comma
l_int|0x09
comma
l_int|0x001B
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
l_int|0x0A
comma
l_int|0x8000
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
l_int|0x0B
comma
l_int|0x3F37
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
l_int|0x0C
comma
l_int|0x0098
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
l_int|0x0C
comma
(paren
id|maestro_read
c_func
(paren
id|ess
comma
l_int|0x0C
)paren
op_amp
op_complement
l_int|0xF000
)paren
op_or
l_int|0x8000
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
l_int|0x0C
comma
(paren
id|maestro_read
c_func
(paren
id|ess
comma
l_int|0x0C
)paren
op_amp
op_complement
l_int|0x0F00
)paren
op_or
l_int|0x0500
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|ess
comma
l_int|0x0D
comma
l_int|0x7632
)paren
suffix:semicolon
multiline_comment|/* Wave cache control on - test off, sg off, &n;&t;&t;enable, enable extra chans 1Mb */
id|outw
c_func
(paren
id|inw
c_func
(paren
l_int|0x14
op_plus
id|iobase
)paren
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
comma
l_int|0x14
op_plus
id|iobase
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
l_int|0x14
op_plus
id|iobase
)paren
op_amp
l_int|0xFE03
comma
l_int|0x14
op_plus
id|iobase
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|inw
c_func
(paren
l_int|0x14
op_plus
id|iobase
)paren
op_amp
l_int|0xFFFC
)paren
comma
l_int|0x14
op_plus
id|iobase
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
l_int|0x14
op_plus
id|iobase
)paren
op_or
(paren
l_int|1
op_lshift
l_int|7
)paren
comma
l_int|0x14
op_plus
id|iobase
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xA1A0
comma
l_int|0x14
op_plus
id|iobase
)paren
suffix:semicolon
multiline_comment|/* 0300 ? */
r_if
c_cond
(paren
id|maestro_ac97_get
c_func
(paren
id|iobase
comma
l_int|0x00
)paren
op_eq
l_int|0x0080
)paren
(brace
id|maestro_pt101_init
c_func
(paren
id|iobase
)paren
suffix:semicolon
)brace
r_else
(brace
id|maestro_ac97_init
c_func
(paren
id|iobase
)paren
suffix:semicolon
id|card-&gt;mix.supported_mixers
op_assign
id|AC97_SUPPORTED_MASK
suffix:semicolon
id|card-&gt;mix.stereo_mixers
op_assign
id|AC97_STEREO_MASK
suffix:semicolon
id|card-&gt;mix.record_sources
op_assign
id|AC97_RECORD_MASK
suffix:semicolon
id|card-&gt;mix.read_mixer
op_assign
id|ac97_read_mixer
suffix:semicolon
id|card-&gt;mix.write_mixer
op_assign
id|ac97_write_mixer
suffix:semicolon
id|card-&gt;mix.recmask_io
op_assign
id|ac97_recmask_io
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;dev_mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|ess_mixer_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;maestro: couldn&squot;t register mixer!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Now clear the channel data */
r_for
c_loop
(paren
id|apu
op_assign
l_int|0
suffix:semicolon
id|apu
OL
l_int|64
suffix:semicolon
id|apu
op_increment
)paren
(brace
r_for
c_loop
(paren
id|w
op_assign
l_int|0
suffix:semicolon
id|w
OL
l_int|0x0E
suffix:semicolon
id|w
op_increment
)paren
(brace
id|apu_set_register
c_func
(paren
id|ess
comma
id|apu
op_or
id|ESS_CHAN_HARD
comma
id|w
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|card-&gt;irq
comma
id|ess_interrupt
comma
id|SA_SHIRQ
comma
id|card_names
(braket
id|card_type
)braket
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;maestro: unable to allocate irq %d,&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//&t;ess_play_test(ess);
id|printk
c_func
(paren
l_string|&quot;maestro: %d channels configured.&bslash;n&quot;
comma
id|num
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|__init
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|init_maestro
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
r_struct
id|pci_dev
op_star
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|index
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
multiline_comment|/* No PCI bus in this machine! */
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;maestro: version &quot;
id|DRIVER_VERSION
l_string|&quot; time &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Find the ESS Maestro 2.&n;&t; */
r_while
c_loop
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ESS
comma
id|PCI_DEVICE_ID_ESS_ESS1968
comma
id|pcidev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|index
op_add_assign
id|maestro_install
c_func
(paren
id|pcidev
comma
id|TYPE_MAESTRO2
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
id|NR_DEVICE
)paren
(brace
r_return
id|index
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;Find the ESS Maestro 2E&n;&t; */
r_while
c_loop
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ESS
comma
id|PCI_DEVICE_ID_ESS_ESS1978
comma
id|pcidev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|index
op_add_assign
id|maestro_install
c_func
(paren
id|pcidev
comma
id|TYPE_MAESTRO2E
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
id|NR_DEVICE
)paren
(brace
r_return
id|index
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;ESS Maestro 1&n;&t; */
r_while
c_loop
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ESS_OLD
comma
id|PCI_DEVICE_ID_ESS_ESS0100
comma
id|pcidev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|index
op_add_assign
id|maestro_install
c_func
(paren
id|pcidev
comma
id|TYPE_MAESTRO
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
id|NR_DEVICE
)paren
(brace
r_return
id|index
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|index
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alan Cox &lt;alan@redhat.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ESS Maestro Driver&quot;
)paren
suffix:semicolon
macro_line|#ifdef M_DEBUG
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|ess_card
op_star
id|s
suffix:semicolon
r_while
c_loop
(paren
(paren
id|s
op_assign
id|devs
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|devs
op_assign
id|devs-&gt;next
suffix:semicolon
singleline_comment|//&t;&t;ess_play_test(&amp;s-&gt;channels[0]);
macro_line|#ifndef ESS_HW_TIMER
id|kill_bob
c_func
(paren
op_amp
id|s-&gt;channels
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#else
id|stop_bob
c_func
(paren
op_amp
id|s-&gt;channels
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|//&t;&t;outb(~0, s-&gt;ioenh + SV_CODEC_INTMASK);  /* disable ints */
singleline_comment|//&t;&t;synchronize_irq();
singleline_comment|//&t;&t;inb(s-&gt;ioenh + SV_CODEC_STATUS); /* ack interrupts */
singleline_comment|//&t;&t;wrindir(s, SV_CIENABLE, 0);     /* disable DMAA and DMAC */
singleline_comment|//outb(0, s-&gt;iodmaa + SV_DMA_RESET);
singleline_comment|//outb(0, s-&gt;iodmac + SV_DMA_RESET);
id|free_irq
c_func
(paren
id|s-&gt;irq
comma
id|s
)paren
suffix:semicolon
id|unregister_sound_mixer
c_func
(paren
id|s-&gt;dev_mixer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|ess_state
op_star
id|ess
op_assign
op_amp
id|s-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ess-&gt;dev_audio
op_ne
op_minus
l_int|1
)paren
(brace
id|unregister_sound_dsp
c_func
(paren
id|ess-&gt;dev_audio
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|M_printk
c_func
(paren
l_string|&quot;maestro: unloading&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
macro_line|#if 0
multiline_comment|/*============================================================================&n; *  ex-code that we&squot;re not using anymore..&n; *============================================================================&n; */
multiline_comment|/*&n; *&t;The ASSP is fortunately not double indexed&n; */
r_static
r_void
id|assp_set_register
c_func
(paren
r_int
id|ioaddr
comma
id|u32
id|reg
comma
id|u32
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|ioaddr
op_plus
l_int|0x80
)paren
suffix:semicolon
id|outl
c_func
(paren
id|value
comma
id|ioaddr
op_plus
l_int|0x84
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
id|u32
id|assp_get_register
c_func
(paren
r_int
id|ioaddr
comma
id|u32
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|value
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|ioaddr
op_plus
l_int|0x80
)paren
suffix:semicolon
id|value
op_assign
id|inl
c_func
(paren
id|ioaddr
op_plus
l_int|0x84
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/* the ASP is basically a DSP that one can dma instructions&n;&t;into.  it can do things like surround encoding or&n;&t;fm synth in sb emul mode.  It is highly proprietary&n;&t;and the ESS dudes are none too excited about telling&n;&t;us about it.  so screw it, we&squot;ll just turn it off and&n;&t;not bother with it.  Its not needed for apu/dac work. */
r_static
r_void
id|asp_load
c_func
(paren
r_int
id|ioaddr
comma
id|u16
id|l
comma
id|u16
id|h
comma
id|u16
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
id|outw
c_func
(paren
id|l
comma
id|ioaddr
op_plus
l_int|0x80
)paren
suffix:semicolon
id|outw
c_func
(paren
id|h
comma
id|ioaddr
op_plus
l_int|0x82
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outw
c_func
(paren
op_star
id|data
op_increment
comma
id|ioaddr
op_plus
l_int|0x84
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|asp_memset
c_func
(paren
r_int
id|ioaddr
comma
id|u16
id|l
comma
id|u16
id|h
comma
id|u16
id|v
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
id|outw
c_func
(paren
id|l
comma
id|ioaddr
op_plus
l_int|0x80
)paren
suffix:semicolon
id|outw
c_func
(paren
id|h
comma
id|ioaddr
op_plus
l_int|0x82
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outw
c_func
(paren
id|v
comma
id|ioaddr
op_plus
l_int|0x84
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Load a code table into the ASP.&n; */
mdefine_line|#define ASSP_LOAD_PROGRAM 0x02 
mdefine_line|#define ASSP_LOAD_DATA 0x03 
r_static
r_void
id|load_tables
c_func
(paren
r_int
id|iobase
)paren
(brace
id|outb
c_func
(paren
l_int|0x00
comma
id|ESS_SETUP_A4
op_plus
id|iobase
)paren
suffix:semicolon
multiline_comment|/* start ASSP programming */
id|asp_load
c_func
(paren
id|iobase
comma
l_int|0x0
comma
id|ASSP_LOAD_PROGRAM
comma
id|asp_block_0
comma
r_sizeof
(paren
id|asp_block_0
)paren
op_div
l_int|2
)paren
suffix:semicolon
id|asp_load
c_func
(paren
id|iobase
comma
l_int|0x0800
comma
id|ASSP_LOAD_PROGRAM
comma
id|asp_block_1
comma
r_sizeof
(paren
id|asp_block_1
)paren
op_div
l_int|2
)paren
suffix:semicolon
id|asp_memset
c_func
(paren
id|iobase
comma
l_int|0x1000
comma
id|ASSP_LOAD_DATA
comma
l_int|0
comma
l_int|1024
)paren
suffix:semicolon
multiline_comment|/*&n; * At page 25 of the Maestro-2E data sheet, Table 7, there is a layout of the&n; * ASSP memory mapping that describe the 0x2000-0x23FF as a data area.&n; * The 1.10 version of the test code load 0x3B4 words of data into this area.&n; * I have grabbed the data with hexdump and inserted them into this code.&n; */
id|asp_load
c_func
(paren
id|iobase
comma
l_int|0x2000
comma
id|ASSP_LOAD_DATA
comma
id|asp_block_4
comma
r_sizeof
(paren
id|asp_block_4
)paren
op_div
l_int|2
)paren
suffix:semicolon
id|asp_memset
c_func
(paren
id|iobase
comma
l_int|0x11BC
comma
id|ASSP_LOAD_DATA
comma
l_int|0x18
comma
l_int|36
)paren
suffix:semicolon
id|asp_load
c_func
(paren
id|iobase
comma
l_int|0x13DC
comma
id|ASSP_LOAD_DATA
comma
id|asp_block_2
comma
r_sizeof
(paren
id|asp_block_2
)paren
op_div
l_int|2
)paren
suffix:semicolon
id|asp_load
c_func
(paren
id|iobase
comma
l_int|0x1300
comma
id|ASSP_LOAD_DATA
comma
id|asp_block_3
comma
r_sizeof
(paren
id|asp_block_3
)paren
op_div
l_int|2
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x41
comma
id|ESS_SETUP_A4
op_plus
id|iobase
)paren
suffix:semicolon
multiline_comment|/* stop programming and run ASSP */
)brace
multiline_comment|/*&n; *&t;Do not use the main maestro_reset.  it is known&n; *&t;to leave certain chips in an unstable state.&n; *&t;best to just reset the direct sound (apus) and&n; *&t;assp pieces seperately.&n; */
r_static
r_void
id|maestro_reset
c_func
(paren
r_int
id|ioaddr
)paren
(brace
id|outw
c_func
(paren
l_int|0x8000
comma
l_int|0x18
op_plus
id|ioaddr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
l_int|0x18
op_plus
id|ioaddr
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
