multiline_comment|/*&n; * sound/ad1848.c&n; *&n; * The low level driver for the AD1848/CS4248 codec chip which&n; * is used for example in the MS Sound System.&n; *&n; * The CS4231 which is used in the GUS MAX and some other cards is&n; * upwards compatible with AD1848 and this driver is able to drive it.&n; *&n; * CS4231A and AD1845 are upward compatible with CS4231. However&n; * the new features of these chips are different.&n; *&n; * CS4232 is a PnP audio chip which contains a CS4231A (and SB, MPU).&n; * CS4232A is an improved version of CS4232.&n; *&n; *&n; *&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; *&n; *&n; * Thomas Sailer&t;: ioctl code reworked (vmalloc/vfree removed)&n; *&t;&t;&t;  general sleep/wakeup clean up.&n; * Alan Cox&t;&t;: reformatted. Fixed SMP bugs. Moved to kernel alloc/free&n; *&t;&t;          of irqs. Use dev_id.&n; * Christoph Hellwig&t;: adapted to module_init/module_exit&n; * Aki Laukkanen&t;: added power management support&n; *&n; * Status:&n; *&t;&t;Tested. Believed fully functional.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
DECL|macro|DEB
mdefine_line|#define DEB(x)
DECL|macro|DEB1
mdefine_line|#define DEB1(x)
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;ad1848.h&quot;
macro_line|#include &quot;ad1848_mixer.h&quot;
r_typedef
r_struct
(brace
DECL|member|base
r_int
id|base
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|dma1
DECL|member|dma2
r_int
id|dma1
comma
id|dma2
suffix:semicolon
DECL|member|dual_dma
r_int
id|dual_dma
suffix:semicolon
multiline_comment|/* 1, when two DMA channels allocated */
DECL|member|subtype
r_int
id|subtype
suffix:semicolon
DECL|member|MCE_bit
r_int
r_char
id|MCE_bit
suffix:semicolon
DECL|member|saved_regs
r_int
r_char
id|saved_regs
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|debug_flag
r_int
id|debug_flag
suffix:semicolon
DECL|member|audio_flags
r_int
id|audio_flags
suffix:semicolon
DECL|member|record_dev
DECL|member|playback_dev
r_int
id|record_dev
comma
id|playback_dev
suffix:semicolon
DECL|member|xfer_count
r_int
id|xfer_count
suffix:semicolon
DECL|member|audio_mode
r_int
id|audio_mode
suffix:semicolon
DECL|member|open_mode
r_int
id|open_mode
suffix:semicolon
DECL|member|intr_active
r_int
id|intr_active
suffix:semicolon
DECL|member|chip_name
DECL|member|name
r_char
op_star
id|chip_name
comma
op_star
id|name
suffix:semicolon
DECL|member|model
r_int
id|model
suffix:semicolon
DECL|macro|MD_1848
mdefine_line|#define MD_1848&t;&t;1
DECL|macro|MD_4231
mdefine_line|#define MD_4231&t;&t;2
DECL|macro|MD_4231A
mdefine_line|#define MD_4231A&t;3
DECL|macro|MD_1845
mdefine_line|#define MD_1845&t;&t;4
DECL|macro|MD_4232
mdefine_line|#define MD_4232&t;&t;5
DECL|macro|MD_C930
mdefine_line|#define MD_C930&t;&t;6
DECL|macro|MD_IWAVE
mdefine_line|#define MD_IWAVE&t;7
DECL|macro|MD_4235
mdefine_line|#define MD_4235         8 /* Crystal Audio CS4235  */
DECL|macro|MD_1845_SSCAPE
mdefine_line|#define MD_1845_SSCAPE  9 /* Ensoniq Soundscape PNP*/
multiline_comment|/* Mixer parameters */
DECL|member|recmask
r_int
id|recmask
suffix:semicolon
DECL|member|supported_devices
DECL|member|orig_devices
r_int
id|supported_devices
comma
id|orig_devices
suffix:semicolon
DECL|member|supported_rec_devices
DECL|member|orig_rec_devices
r_int
id|supported_rec_devices
comma
id|orig_rec_devices
suffix:semicolon
DECL|member|levels
r_int
op_star
id|levels
suffix:semicolon
DECL|member|mixer_reroute
r_int
id|mixer_reroute
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|dev_no
r_int
id|dev_no
suffix:semicolon
DECL|member|timer_ticks
r_volatile
r_int
r_int
id|timer_ticks
suffix:semicolon
DECL|member|timer_running
r_int
id|timer_running
suffix:semicolon
DECL|member|irq_ok
r_int
id|irq_ok
suffix:semicolon
DECL|member|mix_devices
id|mixer_ents
op_star
id|mix_devices
suffix:semicolon
DECL|member|mixer_output_port
r_int
id|mixer_output_port
suffix:semicolon
multiline_comment|/* Power management */
DECL|member|pmdev
r_struct
id|pm_dev
op_star
id|pmdev
suffix:semicolon
DECL|typedef|ad1848_info
)brace
id|ad1848_info
suffix:semicolon
DECL|struct|ad1848_port_info
r_typedef
r_struct
id|ad1848_port_info
(brace
DECL|member|open_mode
r_int
id|open_mode
suffix:semicolon
DECL|member|speed
r_int
id|speed
suffix:semicolon
DECL|member|speed_bits
r_int
r_char
id|speed_bits
suffix:semicolon
DECL|member|channels
r_int
id|channels
suffix:semicolon
DECL|member|audio_format
r_int
id|audio_format
suffix:semicolon
DECL|member|format_bits
r_int
r_char
id|format_bits
suffix:semicolon
)brace
DECL|typedef|ad1848_port_info
id|ad1848_port_info
suffix:semicolon
DECL|variable|cfg
r_static
r_struct
id|address_info
id|cfg
suffix:semicolon
DECL|variable|nr_ad1848_devs
r_static
r_int
id|nr_ad1848_devs
op_assign
l_int|0
suffix:semicolon
DECL|variable|deskpro_xl
r_int
id|deskpro_xl
op_assign
l_int|0
suffix:semicolon
DECL|variable|deskpro_m
r_int
id|deskpro_m
op_assign
l_int|0
suffix:semicolon
DECL|variable|soundpro
r_int
id|soundpro
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq2dev
r_static
r_volatile
r_int
r_char
id|irq2dev
(braket
l_int|17
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
macro_line|#ifndef EXCLUDE_TIMERS
DECL|variable|timer_installed
r_static
r_int
id|timer_installed
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
DECL|variable|loaded
r_static
r_int
id|loaded
op_assign
l_int|0
suffix:semicolon
DECL|variable|ad_format_mask
r_static
r_int
id|ad_format_mask
(braket
l_int|10
multiline_comment|/*devc-&gt;model */
)braket
op_assign
(brace
l_int|0
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
comma
multiline_comment|/* AD1845 */
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
multiline_comment|/* CS4235 */
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
multiline_comment|/* Ensoniq Soundscape*/
)brace
suffix:semicolon
DECL|variable|adev_info
r_static
id|ad1848_info
id|adev_info
(braket
id|MAX_AUDIO_DEV
)braket
suffix:semicolon
DECL|macro|io_Index_Addr
mdefine_line|#define io_Index_Addr(d)&t;((d)-&gt;base)
DECL|macro|io_Indexed_Data
mdefine_line|#define io_Indexed_Data(d)&t;((d)-&gt;base+1)
DECL|macro|io_Status
mdefine_line|#define io_Status(d)&t;&t;((d)-&gt;base+2)
DECL|macro|io_Polled_IO
mdefine_line|#define io_Polled_IO(d)&t;&t;((d)-&gt;base+3)
r_static
r_struct
(brace
DECL|member|flags
r_int
r_char
id|flags
suffix:semicolon
DECL|macro|CAP_F_TIMER
mdefine_line|#define CAP_F_TIMER 0x01     
DECL|variable|capabilities
)brace
id|capabilities
(braket
l_int|10
multiline_comment|/*devc-&gt;model */
)braket
op_assign
(brace
(brace
l_int|0
)brace
comma
(brace
l_int|0
)brace
multiline_comment|/* MD_1848  */
comma
(brace
id|CAP_F_TIMER
)brace
multiline_comment|/* MD_4231  */
comma
(brace
id|CAP_F_TIMER
)brace
multiline_comment|/* MD_4231A */
comma
(brace
id|CAP_F_TIMER
)brace
multiline_comment|/* MD_1845  */
comma
(brace
id|CAP_F_TIMER
)brace
multiline_comment|/* MD_4232  */
comma
(brace
l_int|0
)brace
multiline_comment|/* MD_C930  */
comma
(brace
id|CAP_F_TIMER
)brace
multiline_comment|/* MD_IWAVE */
comma
(brace
l_int|0
)brace
multiline_comment|/* MD_4235  */
comma
(brace
id|CAP_F_TIMER
)brace
multiline_comment|/* MD_1845_SSCAPE */
)brace
suffix:semicolon
r_static
r_int
id|ad1848_open
c_func
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|ad1848_close
c_func
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_output_block
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
suffix:semicolon
r_static
r_void
id|ad1848_start_input
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
suffix:semicolon
r_static
r_int
id|ad1848_prepare_for_output
c_func
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
suffix:semicolon
r_static
r_int
id|ad1848_prepare_for_input
c_func
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
suffix:semicolon
r_static
r_void
id|ad1848_halt
c_func
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_halt_input
c_func
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_halt_output
c_func
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_trigger
c_func
(paren
r_int
id|dev
comma
r_int
id|bits
)paren
suffix:semicolon
r_static
r_int
id|ad1848_pm_callback
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
suffix:semicolon
macro_line|#ifndef EXCLUDE_TIMERS
r_static
r_int
id|ad1848_tmr_install
c_func
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_tmr_reprogram
c_func
(paren
r_int
id|dev
)paren
suffix:semicolon
macro_line|#endif
DECL|function|ad_read
r_static
r_int
id|ad_read
c_func
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|x
suffix:semicolon
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_or
id|devc-&gt;MCE_bit
)paren
comma
id|io_Index_Addr
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
id|x
op_assign
id|inb
c_func
(paren
id|io_Indexed_Data
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;(%02x&lt;-%02x) &quot;, reg|devc-&gt;MCE_bit, x); */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
DECL|function|ad_write
r_static
r_void
id|ad_write
c_func
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/* Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_or
id|devc-&gt;MCE_bit
)paren
comma
id|io_Index_Addr
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|data
op_amp
l_int|0xff
)paren
)paren
comma
id|io_Indexed_Data
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;(%02x-&gt;%02x) &quot;, reg|devc-&gt;MCE_bit, data); */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|wait_for_calibration
r_static
r_void
id|wait_for_calibration
c_func
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Wait until the auto calibration process has finished.&n;&t; *&n;&t; * 1)       Wait until the chip becomes ready (reads don&squot;t return 0x80).&n;&t; * 2)       Wait until the ACI bit of I11 gets on and then off.&n;&t; */
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_amp
l_int|0x80
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ad1848: Auto calibration timed out(1).&bslash;n&quot;
)paren
suffix:semicolon
id|timeout
op_assign
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
op_logical_neg
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
)paren
r_return
suffix:semicolon
id|timeout
op_assign
l_int|80000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
r_if
c_cond
(paren
(paren
id|devc-&gt;model
op_ne
id|MD_1845
)paren
op_logical_or
(paren
id|devc-&gt;model
op_ne
id|MD_1845_SSCAPE
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ad1848: Auto calibration timed out(3).&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ad_mute
r_static
r_void
id|ad_mute
c_func
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
id|prev
suffix:semicolon
multiline_comment|/*&n;&t; * Save old register settings and mute output channels&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|6
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|prev
op_assign
id|devc-&gt;saved_regs
(braket
id|i
)braket
op_assign
id|ad_read
c_func
(paren
id|devc
comma
id|i
)paren
suffix:semicolon
)brace
)brace
DECL|function|ad_unmute
r_static
r_void
id|ad_unmute
c_func
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
)brace
DECL|function|ad_enter_MCE
r_static
r_void
id|ad_enter_MCE
c_func
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_int
r_int
id|prev
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|devc-&gt;MCE_bit
op_assign
l_int|0x40
suffix:semicolon
id|prev
op_assign
id|inb
c_func
(paren
id|io_Index_Addr
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_amp
l_int|0x40
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
id|devc-&gt;MCE_bit
)paren
comma
id|io_Index_Addr
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad_leave_MCE
r_static
r_void
id|ad_leave_MCE
c_func
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|prev
comma
id|acal
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|acal
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
suffix:semicolon
id|devc-&gt;MCE_bit
op_assign
l_int|0x00
suffix:semicolon
id|prev
op_assign
id|inb
c_func
(paren
id|io_Index_Addr
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
id|io_Index_Addr
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear the MCE bit */
r_if
c_cond
(paren
(paren
id|prev
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Not in MCE mode */
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
id|io_Index_Addr
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear the MCE bit */
r_if
c_cond
(paren
id|acal
op_amp
l_int|0x08
)paren
multiline_comment|/* Auto calibration is enabled */
id|wait_for_calibration
c_func
(paren
id|devc
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1848_set_recmask
r_static
r_int
id|ad1848_set_recmask
c_func
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|mask
)paren
(brace
r_int
r_char
id|recdev
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
id|mask
op_and_assign
id|devc-&gt;supported_rec_devices
suffix:semicolon
multiline_comment|/* Rename the mixer bits if necessary */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
op_ne
id|i
)paren
(brace
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
id|n
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Count selected device bits */
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|soundpro
)paren
(brace
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
r_else
r_if
c_cond
(paren
id|n
op_ne
l_int|1
)paren
(brace
multiline_comment|/* Too many devices selected */
id|mask
op_and_assign
op_complement
id|devc-&gt;recmask
suffix:semicolon
multiline_comment|/* Filter out active settings */
id|n
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Count selected device bits */
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
l_int|1
)paren
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mask
)paren
(brace
r_case
id|SOUND_MASK_MIC
suffix:colon
id|recdev
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_LINE
suffix:colon
r_case
id|SOUND_MASK_LINE3
suffix:colon
id|recdev
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_CD
suffix:colon
r_case
id|SOUND_MASK_LINE1
suffix:colon
id|recdev
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_IMIX
suffix:colon
id|recdev
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
id|recdev
op_assign
l_int|2
suffix:semicolon
)brace
id|recdev
op_lshift_assign
l_int|6
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|0
comma
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|0
)paren
op_amp
l_int|0x3f
)paren
op_or
id|recdev
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|1
comma
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|1
)paren
op_amp
l_int|0x3f
)paren
op_or
id|recdev
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* soundpro */
r_int
r_char
id|val
suffix:semicolon
r_int
id|set_rec_bit
suffix:semicolon
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* For each bit */
r_if
c_cond
(paren
(paren
id|devc-&gt;supported_rec_devices
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/* Device not supported */
r_for
c_loop
(paren
id|j
op_assign
id|LEFT_CHN
suffix:semicolon
id|j
op_le
id|RIGHT_CHN
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|nbits
op_eq
l_int|0
)paren
multiline_comment|/* Inexistent channel */
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * This is tricky:&n;&t;&t;&t;&t; * set_rec_bit becomes 1 if the corresponding bit in mask is set&n;&t;&t;&t;&t; * then it gets flipped if the polarity is inverse&n;&t;&t;&t;&t; */
id|set_rec_bit
op_assign
(paren
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_ne
l_int|0
)paren
op_xor
id|devc-&gt;mix_devices
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|recpol
suffix:semicolon
id|val
op_assign
id|ad_read
c_func
(paren
id|devc
comma
id|devc-&gt;mix_devices
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|recreg
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|devc-&gt;mix_devices
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|recpos
)paren
suffix:semicolon
id|val
op_or_assign
(paren
id|set_rec_bit
op_lshift
id|devc-&gt;mix_devices
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|recpos
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
id|devc-&gt;mix_devices
(braket
id|i
)braket
(braket
id|j
)braket
dot
id|recreg
comma
id|val
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Rename the mixer bits back if necessary */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
op_ne
id|i
)paren
(brace
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
)paren
)paren
(brace
id|mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
)paren
suffix:semicolon
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
id|devc-&gt;recmask
op_assign
id|mask
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|change_bits
r_static
r_void
id|change_bits
c_func
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
r_char
op_star
id|regval
comma
r_int
r_char
op_star
id|muteval
comma
r_int
id|dev
comma
r_int
id|chn
comma
r_int
id|newval
)paren
(brace
r_int
r_char
id|mask
suffix:semicolon
r_int
id|shift
suffix:semicolon
r_int
id|mute
suffix:semicolon
r_int
id|mutemask
suffix:semicolon
r_int
id|set_mute_bit
suffix:semicolon
id|set_mute_bit
op_assign
(paren
id|newval
op_eq
l_int|0
)paren
op_xor
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|mutepol
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|polarity
op_eq
l_int|1
)paren
multiline_comment|/* Reverse */
id|newval
op_assign
l_int|100
op_minus
id|newval
suffix:semicolon
id|mask
op_assign
(paren
l_int|1
op_lshift
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|nbits
)paren
op_minus
l_int|1
suffix:semicolon
id|shift
op_assign
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|bitpos
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|mutepos
op_eq
l_int|8
)paren
(brace
multiline_comment|/* if there is no mute bit */
id|mute
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No mute bit; do nothing special */
id|mutemask
op_assign
op_complement
l_int|0
suffix:semicolon
multiline_comment|/* No mute bit; do nothing special */
)brace
r_else
(brace
id|mute
op_assign
(paren
id|set_mute_bit
op_lshift
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|mutepos
)paren
suffix:semicolon
id|mutemask
op_assign
op_complement
(paren
l_int|1
op_lshift
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|mutepos
)paren
suffix:semicolon
)brace
id|newval
op_assign
(paren
r_int
)paren
(paren
(paren
id|newval
op_star
id|mask
)paren
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
multiline_comment|/* Scale it */
op_star
id|regval
op_and_assign
op_complement
(paren
id|mask
op_lshift
id|shift
)paren
suffix:semicolon
multiline_comment|/* Clear bits */
op_star
id|regval
op_or_assign
(paren
id|newval
op_amp
id|mask
)paren
op_lshift
id|shift
suffix:semicolon
multiline_comment|/* Set new value */
op_star
id|muteval
op_and_assign
id|mutemask
suffix:semicolon
op_star
id|muteval
op_or_assign
id|mute
suffix:semicolon
)brace
DECL|function|ad1848_mixer_get
r_static
r_int
id|ad1848_mixer_get
c_func
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|1
op_lshift
id|dev
)paren
op_amp
id|devc-&gt;supported_devices
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|devc-&gt;mixer_reroute
(braket
id|dev
)braket
suffix:semicolon
r_return
id|devc-&gt;levels
(braket
id|dev
)braket
suffix:semicolon
)brace
DECL|function|ad1848_mixer_set_channel
r_static
r_void
id|ad1848_mixer_set_channel
c_func
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|dev
comma
r_int
id|value
comma
r_int
id|channel
)paren
(brace
r_int
id|regoffs
comma
id|muteregoffs
suffix:semicolon
r_int
r_char
id|val
comma
id|muteval
suffix:semicolon
id|regoffs
op_assign
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|channel
)braket
dot
id|regno
suffix:semicolon
id|muteregoffs
op_assign
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|channel
)braket
dot
id|mutereg
suffix:semicolon
id|val
op_assign
id|ad_read
c_func
(paren
id|devc
comma
id|regoffs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|muteregoffs
op_ne
id|regoffs
)paren
(brace
id|muteval
op_assign
id|ad_read
c_func
(paren
id|devc
comma
id|muteregoffs
)paren
suffix:semicolon
id|change_bits
c_func
(paren
id|devc
comma
op_amp
id|val
comma
op_amp
id|muteval
comma
id|dev
comma
id|channel
comma
id|value
)paren
suffix:semicolon
)brace
r_else
id|change_bits
c_func
(paren
id|devc
comma
op_amp
id|val
comma
op_amp
id|val
comma
id|dev
comma
id|channel
comma
id|value
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
id|regoffs
comma
id|val
)paren
suffix:semicolon
id|devc-&gt;saved_regs
(braket
id|regoffs
)braket
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|muteregoffs
op_ne
id|regoffs
)paren
(brace
id|ad_write
c_func
(paren
id|devc
comma
id|muteregoffs
comma
id|muteval
)paren
suffix:semicolon
id|devc-&gt;saved_regs
(braket
id|muteregoffs
)braket
op_assign
id|muteval
suffix:semicolon
)brace
)brace
DECL|function|ad1848_mixer_set
r_static
r_int
id|ad1848_mixer_set
c_func
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|dev
comma
r_int
id|value
)paren
(brace
r_int
id|left
op_assign
id|value
op_amp
l_int|0x000000ff
suffix:semicolon
r_int
id|right
op_assign
(paren
id|value
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
r_int
id|retvol
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
l_int|31
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|devc-&gt;mixer_reroute
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|LEFT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
id|right
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
multiline_comment|/* Mono control */
id|right
op_assign
id|left
suffix:semicolon
id|retvol
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Scale volumes */
id|left
op_assign
id|mix_cvt
(braket
id|left
)braket
suffix:semicolon
id|right
op_assign
id|mix_cvt
(braket
id|right
)braket
suffix:semicolon
id|devc-&gt;levels
(braket
id|dev
)braket
op_assign
id|retvol
suffix:semicolon
multiline_comment|/*&n;&t; * Set the left channel&n;&t; */
id|ad1848_mixer_set_channel
c_func
(paren
id|devc
comma
id|dev
comma
id|left
comma
id|LEFT_CHN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the right channel&n;&t; */
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|ad1848_mixer_set_channel
c_func
(paren
id|devc
comma
id|dev
comma
id|right
comma
id|RIGHT_CHN
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retvol
suffix:semicolon
)brace
DECL|function|ad1848_mixer_reset
r_static
r_void
id|ad1848_mixer_reset
c_func
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
id|devc-&gt;mix_devices
op_assign
op_amp
(paren
id|ad1848_mix_devices
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%s_%d&quot;
comma
id|devc-&gt;chip_name
comma
id|nr_ad1848_devs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
id|devc-&gt;supported_rec_devices
op_assign
id|MODE1_REC_DEVICES
suffix:semicolon
r_switch
c_cond
(paren
id|devc-&gt;model
)paren
(brace
r_case
id|MD_4231
suffix:colon
r_case
id|MD_4231A
suffix:colon
r_case
id|MD_1845
suffix:colon
r_case
id|MD_1845_SSCAPE
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE2_MIXER_DEVICES
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MD_C930
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|C930_MIXER_DEVICES
suffix:semicolon
id|devc-&gt;mix_devices
op_assign
op_amp
(paren
id|c930_mix_devices
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MD_IWAVE
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE3_MIXER_DEVICES
suffix:semicolon
id|devc-&gt;mix_devices
op_assign
op_amp
(paren
id|iwave_mix_devices
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MD_4232
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE3_MIXER_DEVICES
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MD_1848
suffix:colon
r_if
c_cond
(paren
id|soundpro
)paren
(brace
id|devc-&gt;supported_devices
op_assign
id|SPRO_MIXER_DEVICES
suffix:semicolon
id|devc-&gt;supported_rec_devices
op_assign
id|SPRO_REC_DEVICES
suffix:semicolon
id|devc-&gt;mix_devices
op_assign
op_amp
(paren
id|spro_mix_devices
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE1_MIXER_DEVICES
suffix:semicolon
)brace
id|devc-&gt;orig_devices
op_assign
id|devc-&gt;supported_devices
suffix:semicolon
id|devc-&gt;orig_rec_devices
op_assign
id|devc-&gt;supported_rec_devices
suffix:semicolon
id|devc-&gt;levels
op_assign
id|load_mixer_volumes
c_func
(paren
id|name
comma
id|default_mixer_levels
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|ad1848_mixer_set
c_func
(paren
id|devc
comma
id|i
comma
id|devc-&gt;levels
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|ad1848_set_recmask
c_func
(paren
id|devc
comma
id|SOUND_MASK_MIC
)paren
suffix:semicolon
id|devc-&gt;mixer_output_port
op_assign
id|devc-&gt;levels
(braket
l_int|31
)braket
op_or
id|AUDIO_HEADPHONE
op_or
id|AUDIO_LINE_OUT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|soundpro
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;mixer_output_port
op_amp
id|AUDIO_SPEAKER
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|26
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|26
)paren
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Unmute mono out */
r_else
id|ad_write
c_func
(paren
id|devc
comma
l_int|26
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|26
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mute mono out */
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * From the &quot;wouldn&squot;t it be nice if the mixer API had (better)&n;&t;&t; * support for custom stuff&quot; category&n;&t;&t; */
multiline_comment|/* Enable surround mode and SB16 mixer */
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
l_int|0x60
)paren
suffix:semicolon
)brace
)brace
DECL|function|ad1848_mixer_ioctl
r_static
r_int
id|ad1848_mixer_ioctl
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
id|mixer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_PRIVATE1
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0xffff
)paren
(brace
id|val
op_and_assign
(paren
id|AUDIO_SPEAKER
op_or
id|AUDIO_HEADPHONE
op_or
id|AUDIO_LINE_OUT
)paren
suffix:semicolon
id|devc-&gt;mixer_output_port
op_assign
id|val
suffix:semicolon
id|val
op_or_assign
id|AUDIO_HEADPHONE
op_or
id|AUDIO_LINE_OUT
suffix:semicolon
multiline_comment|/* Always on */
id|devc-&gt;mixer_output_port
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|AUDIO_SPEAKER
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|26
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|26
)paren
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Unmute mono out */
r_else
id|ad_write
c_func
(paren
id|devc
comma
l_int|26
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|26
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mute mono out */
)brace
id|val
op_assign
id|devc-&gt;mixer_output_port
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_PRIVATE2
)paren
(brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ad1848_control
c_func
(paren
id|AD1848_MIXER_REROUTE
comma
id|val
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|cmd
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_eq
l_char|&squot;M&squot;
)paren
(brace
r_if
c_cond
(paren
id|_SIOC_DIR
c_func
(paren
id|cmd
)paren
op_amp
id|_SIOC_WRITE
)paren
(brace
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
id|ad1848_set_recmask
c_func
(paren
id|devc
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
id|ad1848_mixer_set
c_func
(paren
id|devc
comma
id|cmd
op_amp
l_int|0xff
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Return parameters&n;&t;&t;&t;&t; */
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
id|val
op_assign
id|devc-&gt;recmask
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
id|val
op_assign
id|devc-&gt;supported_devices
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
id|val
op_assign
id|devc-&gt;supported_devices
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_C930
)paren
id|val
op_and_assign
op_complement
(paren
id|SOUND_MASK_SPEAKER
op_or
id|SOUND_MASK_IMIX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
id|val
op_assign
id|devc-&gt;supported_rec_devices
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
id|val
op_assign
id|SOUND_CAP_EXCL_INPUT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|val
op_assign
id|ad1848_mixer_get
c_func
(paren
id|devc
comma
id|cmd
op_amp
l_int|0xff
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ad1848_set_speed
r_static
r_int
id|ad1848_set_speed
c_func
(paren
r_int
id|dev
comma
r_int
id|arg
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
multiline_comment|/*&n;&t; * The sampling speed is encoded in the least significant nibble of I8. The&n;&t; * LSB selects the clock source (0=24.576 MHz, 1=16.9344 MHz) and other&n;&t; * three bits select the divisor (indirectly):&n;&t; *&n;&t; * The available speeds are in the following table. Keep the speeds in&n;&t; * the increasing order.&n;&t; */
r_typedef
r_struct
(brace
r_int
id|speed
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
)brace
id|speed_struct
suffix:semicolon
r_static
id|speed_struct
id|speed_table
(braket
)braket
op_assign
(brace
(brace
l_int|5510
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|5510
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|6620
comma
(paren
l_int|7
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|8000
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|9600
comma
(paren
l_int|7
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|11025
comma
(paren
l_int|1
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|16000
comma
(paren
l_int|1
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|18900
comma
(paren
l_int|2
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|22050
comma
(paren
l_int|3
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|27420
comma
(paren
l_int|2
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|32000
comma
(paren
l_int|3
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|33075
comma
(paren
l_int|6
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|37800
comma
(paren
l_int|4
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|44100
comma
(paren
l_int|5
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|48000
comma
(paren
l_int|6
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|n
comma
id|selected
op_assign
op_minus
l_int|1
suffix:semicolon
id|n
op_assign
r_sizeof
(paren
id|speed_table
)paren
op_div
r_sizeof
(paren
id|speed_struct
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_le
l_int|0
)paren
r_return
id|portc-&gt;speed
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845
op_logical_or
id|devc-&gt;model
op_eq
id|MD_1845_SSCAPE
)paren
multiline_comment|/* AD1845 has different timer than others */
(brace
r_if
c_cond
(paren
id|arg
OL
l_int|4000
)paren
id|arg
op_assign
l_int|4000
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|50000
)paren
id|arg
op_assign
l_int|50000
suffix:semicolon
id|portc-&gt;speed
op_assign
id|arg
suffix:semicolon
id|portc-&gt;speed_bits
op_assign
id|speed_table
(braket
l_int|3
)braket
dot
id|bits
suffix:semicolon
r_return
id|portc-&gt;speed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
OL
id|speed_table
(braket
l_int|0
)braket
dot
id|speed
)paren
id|selected
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
id|speed_table
(braket
id|n
op_minus
l_int|1
)braket
dot
id|speed
)paren
id|selected
op_assign
id|n
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
multiline_comment|/*really */
suffix:semicolon
id|selected
op_eq
op_minus
l_int|1
op_logical_and
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|speed_table
(braket
id|i
)braket
dot
id|speed
op_eq
id|arg
)paren
id|selected
op_assign
id|i
suffix:semicolon
r_else
r_if
c_cond
(paren
id|speed_table
(braket
id|i
)braket
dot
id|speed
OG
id|arg
)paren
(brace
r_int
id|diff1
comma
id|diff2
suffix:semicolon
id|diff1
op_assign
id|arg
op_minus
id|speed_table
(braket
id|i
op_minus
l_int|1
)braket
dot
id|speed
suffix:semicolon
id|diff2
op_assign
id|speed_table
(braket
id|i
)braket
dot
id|speed
op_minus
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|diff1
OL
id|diff2
)paren
id|selected
op_assign
id|i
op_minus
l_int|1
suffix:semicolon
r_else
id|selected
op_assign
id|i
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|selected
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ad1848: Can&squot;t find speed???&bslash;n&quot;
)paren
suffix:semicolon
id|selected
op_assign
l_int|3
suffix:semicolon
)brace
id|portc-&gt;speed
op_assign
id|speed_table
(braket
id|selected
)braket
dot
id|speed
suffix:semicolon
id|portc-&gt;speed_bits
op_assign
id|speed_table
(braket
id|selected
)braket
dot
id|bits
suffix:semicolon
r_return
id|portc-&gt;speed
suffix:semicolon
)brace
DECL|function|ad1848_set_channels
r_static
r_int
id|ad1848_set_channels
c_func
(paren
r_int
id|dev
comma
r_int
id|arg
)paren
(brace
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_ne
l_int|1
op_logical_and
id|arg
op_ne
l_int|2
)paren
r_return
id|portc-&gt;channels
suffix:semicolon
id|portc-&gt;channels
op_assign
id|arg
suffix:semicolon
r_return
id|arg
suffix:semicolon
)brace
DECL|function|ad1848_set_bits
r_static
r_int
r_int
id|ad1848_set_bits
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|arg
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_static
r_struct
id|format_tbl
(brace
r_int
id|format
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
)brace
id|format2bits
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
id|AFMT_MU_LAW
comma
l_int|1
)brace
comma
(brace
id|AFMT_A_LAW
comma
l_int|3
)brace
comma
(brace
id|AFMT_IMA_ADPCM
comma
l_int|5
)brace
comma
(brace
id|AFMT_U8
comma
l_int|0
)brace
comma
(brace
id|AFMT_S16_LE
comma
l_int|2
)brace
comma
(brace
id|AFMT_S16_BE
comma
l_int|6
)brace
comma
(brace
id|AFMT_S8
comma
l_int|0
)brace
comma
(brace
id|AFMT_U16_LE
comma
l_int|0
)brace
comma
(brace
id|AFMT_U16_BE
comma
l_int|0
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|n
op_assign
r_sizeof
(paren
id|format2bits
)paren
op_div
r_sizeof
(paren
r_struct
id|format_tbl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_eq
l_int|0
)paren
r_return
id|portc-&gt;audio_format
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|arg
op_amp
id|ad_format_mask
(braket
id|devc-&gt;model
)braket
)paren
)paren
id|arg
op_assign
id|AFMT_U8
suffix:semicolon
id|portc-&gt;audio_format
op_assign
id|arg
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|format2bits
(braket
id|i
)braket
dot
id|format
op_eq
id|arg
)paren
(brace
r_if
c_cond
(paren
(paren
id|portc-&gt;format_bits
op_assign
id|format2bits
(braket
id|i
)braket
dot
id|bits
)paren
op_eq
l_int|0
)paren
r_return
id|portc-&gt;audio_format
op_assign
id|AFMT_U8
suffix:semicolon
multiline_comment|/* Was not supported */
r_return
id|arg
suffix:semicolon
)brace
multiline_comment|/* Still hanging here. Something must be terribly wrong */
id|portc-&gt;format_bits
op_assign
l_int|0
suffix:semicolon
r_return
id|portc-&gt;audio_format
op_assign
id|AFMT_U8
suffix:semicolon
)brace
DECL|variable|ad1848_audio_driver
r_static
r_struct
id|audio_driver
id|ad1848_audio_driver
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|open
suffix:colon
id|ad1848_open
comma
id|close
suffix:colon
id|ad1848_close
comma
id|output_block
suffix:colon
id|ad1848_output_block
comma
id|start_input
suffix:colon
id|ad1848_start_input
comma
id|prepare_for_input
suffix:colon
id|ad1848_prepare_for_input
comma
id|prepare_for_output
suffix:colon
id|ad1848_prepare_for_output
comma
id|halt_io
suffix:colon
id|ad1848_halt
comma
id|halt_input
suffix:colon
id|ad1848_halt_input
comma
id|halt_output
suffix:colon
id|ad1848_halt_output
comma
id|trigger
suffix:colon
id|ad1848_trigger
comma
id|set_speed
suffix:colon
id|ad1848_set_speed
comma
id|set_bits
suffix:colon
id|ad1848_set_bits
comma
id|set_channels
suffix:colon
id|ad1848_set_channels
)brace
suffix:semicolon
DECL|variable|ad1848_mixer_operations
r_static
r_struct
id|mixer_operations
id|ad1848_mixer_operations
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|id
suffix:colon
l_string|&quot;SOUNDPORT&quot;
comma
id|name
suffix:colon
l_string|&quot;AD1848/CS4248/CS4231&quot;
comma
id|ioctl
suffix:colon
id|ad1848_mixer_ioctl
)brace
suffix:semicolon
DECL|function|ad1848_open
r_static
r_int
id|ad1848_open
c_func
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
l_int|NULL
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_audiodevs
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;open_mode
op_logical_or
(paren
id|devc-&gt;open_mode
op_amp
id|mode
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|devc-&gt;dual_dma
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DMA_DUPLEX
)paren
(brace
id|devc-&gt;dual_dma
op_assign
l_int|1
suffix:semicolon
)brace
id|devc-&gt;intr_active
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;open_mode
op_or_assign
id|mode
suffix:semicolon
id|portc-&gt;open_mode
op_assign
id|mode
suffix:semicolon
id|ad1848_trigger
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|OPEN_READ
)paren
id|devc-&gt;record_dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|OPEN_WRITE
)paren
id|devc-&gt;playback_dev
op_assign
id|dev
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n; * Mute output until the playback really starts. This decreases clicking (hope so).&n; */
id|ad_mute
c_func
(paren
id|devc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1848_close
r_static
r_void
id|ad1848_close
c_func
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_close(void)&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|0
suffix:semicolon
id|ad1848_halt
c_func
(paren
id|dev
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;open_mode
op_and_assign
op_complement
id|portc-&gt;open_mode
suffix:semicolon
id|portc-&gt;open_mode
op_assign
l_int|0
suffix:semicolon
id|ad_unmute
c_func
(paren
id|devc
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1848_output_block
r_static
r_void
id|ad1848_output_block
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
(brace
r_int
r_int
id|flags
comma
id|cnt
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;audio_format
op_eq
id|AFMT_IMA_ADPCM
)paren
(brace
id|cnt
op_div_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|portc-&gt;audio_format
op_amp
(paren
id|AFMT_S16_LE
op_or
id|AFMT_S16_BE
)paren
)paren
multiline_comment|/* 16 bit data */
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|portc-&gt;channels
OG
l_int|1
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_OUTPUT
)paren
op_logical_and
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DMA_AUTOMODE
)paren
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|devc-&gt;xfer_count
)paren
(brace
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Auto DMA mode on. No need to react&n;&t;&t;&t; */
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|15
comma
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|14
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
id|cnt
suffix:semicolon
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1848_start_input
r_static
r_void
id|ad1848_start_input
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
(brace
r_int
r_int
id|flags
comma
id|cnt
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;audio_format
op_eq
id|AFMT_IMA_ADPCM
)paren
(brace
id|cnt
op_div_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|portc-&gt;audio_format
op_amp
(paren
id|AFMT_S16_LE
op_or
id|AFMT_S16_BE
)paren
)paren
multiline_comment|/* 16 bit data */
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|portc-&gt;channels
OG
l_int|1
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_INPUT
)paren
op_logical_and
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DMA_AUTOMODE
)paren
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|devc-&gt;xfer_count
)paren
(brace
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Auto DMA mode on. No need to react&n;&t;&t;&t; */
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1848
)paren
(brace
id|ad_write
c_func
(paren
id|devc
comma
l_int|15
comma
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|14
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ad_write
c_func
(paren
id|devc
comma
l_int|31
comma
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|30
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
id|ad_unmute
c_func
(paren
id|devc
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
id|cnt
suffix:semicolon
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1848_prepare_for_output
r_static
r_int
id|ad1848_prepare_for_output
c_func
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
r_char
id|fs
comma
id|old_fs
comma
id|tmp
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|ad_mute
c_func
(paren
id|devc
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|fs
op_assign
id|portc-&gt;speed_bits
op_or
(paren
id|portc-&gt;format_bits
op_lshift
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;channels
OG
l_int|1
)paren
id|fs
op_or_assign
l_int|0x10
suffix:semicolon
id|ad_enter_MCE
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Enables changes to the format select reg */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845
op_logical_or
id|devc-&gt;model
op_eq
id|MD_1845_SSCAPE
)paren
multiline_comment|/* Use alternate speed select registers */
(brace
id|fs
op_and_assign
l_int|0xf0
suffix:semicolon
multiline_comment|/* Mask off the rate select bits */
id|ad_write
c_func
(paren
id|devc
comma
l_int|22
comma
(paren
id|portc-&gt;speed
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed MSB */
id|ad_write
c_func
(paren
id|devc
comma
l_int|23
comma
id|portc-&gt;speed
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed LSB */
)brace
id|old_fs
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_4232
)paren
(brace
id|tmp
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|16
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_or
l_int|0x30
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|17
comma
l_int|0xc2
)paren
suffix:semicolon
multiline_comment|/* Disable variable frequency select */
id|ad_write
c_func
(paren
id|devc
comma
l_int|8
comma
id|fs
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Write to I8 starts resynchronization. Wait until it completes.&n;&t; */
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|100
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_ne
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|10000
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_4232
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_amp
op_complement
l_int|0x30
)paren
suffix:semicolon
id|ad_leave_MCE
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Starts the calibration process.&n;&t;&t;&t;&t; */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef EXCLUDE_TIMERS
r_if
c_cond
(paren
id|dev
op_eq
id|timer_installed
op_logical_and
id|devc-&gt;timer_running
)paren
r_if
c_cond
(paren
(paren
id|fs
op_amp
l_int|0x01
)paren
op_ne
(paren
id|old_fs
op_amp
l_int|0x01
)paren
)paren
(brace
id|ad1848_tmr_reprogram
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ad1848_halt_output
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1848_prepare_for_input
r_static
r_int
id|ad1848_prepare_for_input
c_func
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
r_char
id|fs
comma
id|old_fs
comma
id|tmp
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;audio_mode
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|fs
op_assign
id|portc-&gt;speed_bits
op_or
(paren
id|portc-&gt;format_bits
op_lshift
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;channels
OG
l_int|1
)paren
id|fs
op_or_assign
l_int|0x10
suffix:semicolon
id|ad_enter_MCE
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Enables changes to the format select reg */
r_if
c_cond
(paren
(paren
id|devc-&gt;model
op_eq
id|MD_1845
)paren
op_logical_or
(paren
id|devc-&gt;model
op_eq
id|MD_1845_SSCAPE
)paren
)paren
multiline_comment|/* Use alternate speed select registers */
(brace
id|fs
op_and_assign
l_int|0xf0
suffix:semicolon
multiline_comment|/* Mask off the rate select bits */
id|ad_write
c_func
(paren
id|devc
comma
l_int|22
comma
(paren
id|portc-&gt;speed
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed MSB */
id|ad_write
c_func
(paren
id|devc
comma
l_int|23
comma
id|portc-&gt;speed
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed LSB */
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_4232
)paren
(brace
id|tmp
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|16
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_or
l_int|0x30
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|17
comma
l_int|0xc2
)paren
suffix:semicolon
multiline_comment|/* Disable variable frequency select */
multiline_comment|/*&n;&t; * If mode &gt;= 2 (CS4231), set I28. It&squot;s the capture format register.&n;&t; */
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
)paren
(brace
id|old_fs
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|28
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|28
comma
id|fs
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Write to I28 starts resynchronization. Wait until it completes.&n;&t;&t; */
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|100
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_ne
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|10000
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
op_logical_and
id|devc-&gt;model
op_ne
id|MD_1845
op_logical_and
id|devc-&gt;model
op_ne
id|MD_1845_SSCAPE
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * CS4231 compatible devices don&squot;t have separate sampling rate selection&n;&t;&t;&t; * register for recording an playback. The I8 register is shared so we have to&n;&t;&t;&t; * set the speed encoding bits of it too.&n;&t;&t;&t; */
r_int
r_char
id|tmp
op_assign
id|portc-&gt;speed_bits
op_or
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|8
)paren
op_amp
l_int|0xf0
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|8
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Write to I8 starts resynchronization. Wait until it completes.&n;&t;&t;&t; */
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|100
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_ne
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|10000
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* For AD1848 set I8. */
id|old_fs
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|8
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|8
comma
id|fs
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Write to I8 starts resynchronization. Wait until it completes.&n;&t;&t; */
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|100
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_ne
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|10000
op_logical_and
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_4232
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_amp
op_complement
l_int|0x30
)paren
suffix:semicolon
id|ad_leave_MCE
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Starts the calibration process.&n;&t;&t;&t;&t; */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef EXCLUDE_TIMERS
r_if
c_cond
(paren
id|dev
op_eq
id|timer_installed
op_logical_and
id|devc-&gt;timer_running
)paren
(brace
r_if
c_cond
(paren
(paren
id|fs
op_amp
l_int|0x01
)paren
op_ne
(paren
id|old_fs
op_amp
l_int|0x01
)paren
)paren
(brace
id|ad1848_tmr_reprogram
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|ad1848_halt_input
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1848_halt
r_static
r_void
id|ad1848_halt
c_func
(paren
r_int
id|dev
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_int
r_char
id|bits
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
l_int|0x01
op_logical_and
(paren
id|portc-&gt;open_mode
op_amp
id|OPEN_WRITE
)paren
)paren
id|ad1848_halt_output
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
l_int|0x02
op_logical_and
(paren
id|portc-&gt;open_mode
op_amp
id|OPEN_READ
)paren
)paren
id|ad1848_halt_input
c_func
(paren
id|dev
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ad1848_halt_input
r_static
r_void
id|ad1848_halt_input
c_func
(paren
r_int
id|dev
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
op_amp
l_int|0x02
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Capture not enabled */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ad_mute
c_func
(paren
id|devc
)paren
suffix:semicolon
(brace
r_int
id|tmout
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|disable_dma
c_func
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_in-&gt;dma
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|tmout
op_assign
l_int|0
suffix:semicolon
id|tmout
OL
l_int|100000
suffix:semicolon
id|tmout
op_increment
)paren
r_if
c_cond
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x10
)paren
r_break
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|9
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Stop capture */
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|enable_dma
c_func
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_in-&gt;dma
)paren
suffix:semicolon
)brace
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_INPUT
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0
comma
id|io_Status
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|outb
c_func
(paren
l_int|0
comma
id|io_Status
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_INPUT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1848_halt_output
r_static
r_void
id|ad1848_halt_output
c_func
(paren
r_int
id|dev
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
op_amp
l_int|0x01
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Playback not enabled */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ad_mute
c_func
(paren
id|devc
)paren
suffix:semicolon
(brace
r_int
id|tmout
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|disable_dma
c_func
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;dma
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|tmout
op_assign
l_int|0
suffix:semicolon
id|tmout
OL
l_int|100000
suffix:semicolon
id|tmout
op_increment
)paren
r_if
c_cond
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x10
)paren
r_break
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|9
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Stop playback */
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|enable_dma
c_func
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;dma
)paren
suffix:semicolon
)brace
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_OUTPUT
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
l_int|0
)paren
comma
id|io_Status
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|outb
c_func
(paren
(paren
l_int|0
)paren
comma
id|io_Status
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1848_trigger
r_static
r_void
id|ad1848_trigger
c_func
(paren
r_int
id|dev
comma
r_int
id|state
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
comma
id|old
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|state
op_and_assign
id|devc-&gt;audio_mode
suffix:semicolon
id|tmp
op_assign
id|old
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;open_mode
op_amp
id|OPEN_READ
)paren
(brace
r_if
c_cond
(paren
id|state
op_amp
id|PCM_ENABLE_INPUT
)paren
id|tmp
op_or_assign
l_int|0x02
suffix:semicolon
r_else
id|tmp
op_and_assign
op_complement
l_int|0x02
suffix:semicolon
)brace
r_if
c_cond
(paren
id|portc-&gt;open_mode
op_amp
id|OPEN_WRITE
)paren
(brace
r_if
c_cond
(paren
id|state
op_amp
id|PCM_ENABLE_OUTPUT
)paren
id|tmp
op_or_assign
l_int|0x01
suffix:semicolon
r_else
id|tmp
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
)brace
multiline_comment|/* ad_mute(devc); */
r_if
c_cond
(paren
id|tmp
op_ne
id|old
)paren
(brace
id|ad_write
c_func
(paren
id|devc
comma
l_int|9
comma
id|tmp
)paren
suffix:semicolon
id|ad_unmute
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1848_init_hw
r_static
r_void
id|ad1848_init_hw
c_func
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Initial values for the indirect registers of CS4248/AD1848.&n;&t; */
r_static
r_int
id|init_values
(braket
)braket
op_assign
(brace
l_int|0xa8
comma
l_int|0xa8
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x0c
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x8a
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/* Positions 16 to 31 just for CS4231/2 and ad1845 */
l_int|0x80
comma
l_int|0x00
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x1f
comma
l_int|0x40
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|ad_write
c_func
(paren
id|devc
comma
id|i
comma
id|init_values
(braket
id|i
)braket
)paren
suffix:semicolon
id|ad_mute
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Initialize some variables */
id|ad_unmute
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Leave it unmuted now */
r_if
c_cond
(paren
id|devc-&gt;model
OG
id|MD_1848
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845_SSCAPE
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|12
)paren
op_or
l_int|0x50
)paren
suffix:semicolon
r_else
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|12
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mode2 = enabled */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
l_int|0x6c
)paren
suffix:semicolon
multiline_comment|/* Select codec mode 3 */
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1845_SSCAPE
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|ad_write
c_func
(paren
id|devc
comma
id|i
comma
id|init_values
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* Playback and capture counters enabled */
)brace
r_if
c_cond
(paren
id|devc-&gt;model
OG
id|MD_1848
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;audio_flags
op_amp
id|DMA_DUPLEX
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|9
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Dual DMA mode */
r_else
id|ad_write
c_func
(paren
id|devc
comma
l_int|9
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
op_or
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Single DMA mode */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845
op_logical_or
id|devc-&gt;model
op_eq
id|MD_1845_SSCAPE
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|27
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|27
)paren
op_or
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* Alternate freq select enabled */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
(brace
multiline_comment|/* Some magic Interwave specific initialization */
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
l_int|0x6c
)paren
suffix:semicolon
multiline_comment|/* Select codec mode 3 */
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* Playback and capture counters enabled */
id|ad_write
c_func
(paren
id|devc
comma
l_int|17
comma
l_int|0xc2
)paren
suffix:semicolon
multiline_comment|/* Alternate feature enable */
)brace
)brace
r_else
(brace
id|devc-&gt;audio_flags
op_and_assign
op_complement
id|DMA_DUPLEX
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|9
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
op_or
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Single DMA mode */
r_if
c_cond
(paren
id|soundpro
)paren
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|12
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mode2 = enabled */
)brace
id|outb
c_func
(paren
(paren
l_int|0
)paren
comma
id|io_Status
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear pending interrupts */
multiline_comment|/*&n;&t; * Toggle the MCE bit. It completes the initialization phase.&n;&t; */
id|ad_enter_MCE
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* In case the bit was off */
id|ad_leave_MCE
c_func
(paren
id|devc
)paren
suffix:semicolon
id|ad1848_mixer_reset
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
DECL|function|ad1848_detect
r_int
id|ad1848_detect
c_func
(paren
r_int
id|io_base
comma
r_int
op_star
id|ad_flags
comma
r_int
op_star
id|osp
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
op_amp
id|adev_info
(braket
id|nr_ad1848_devs
)braket
suffix:semicolon
r_int
r_char
id|tmp1
op_assign
l_int|0xff
comma
id|tmp2
op_assign
l_int|0xff
suffix:semicolon
r_int
id|optiC930
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* OPTi 82C930 flag */
r_int
id|interwave
op_assign
l_int|0
suffix:semicolon
r_int
id|ad1847_flag
op_assign
l_int|0
suffix:semicolon
r_int
id|cs4248_flag
op_assign
l_int|0
suffix:semicolon
r_int
id|sscape_flag
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect(%x)&bslash;n&quot;
comma
id|io_base
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
)paren
(brace
r_if
c_cond
(paren
op_star
id|ad_flags
op_eq
l_int|0x12345678
)paren
(brace
id|interwave
op_assign
l_int|1
suffix:semicolon
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|ad_flags
op_eq
l_int|0x87654321
)paren
(brace
id|sscape_flag
op_assign
l_int|1
suffix:semicolon
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|ad_flags
op_eq
l_int|0x12345677
)paren
(brace
id|cs4248_flag
op_assign
l_int|1
suffix:semicolon
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|nr_ad1848_devs
op_ge
id|MAX_AUDIO_DEV
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ad1848 - Too many audio devices&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|io_base
comma
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ad1848.c: Port %x not free.&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|devc-&gt;base
op_assign
id|io_base
suffix:semicolon
id|devc-&gt;irq_ok
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;timer_running
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;MCE_bit
op_assign
l_int|0x40
suffix:semicolon
id|devc-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;open_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;chip_name
op_assign
id|devc-&gt;name
op_assign
l_string|&quot;AD1848&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_1848
suffix:semicolon
multiline_comment|/* AD1848 or CS4248 */
id|devc-&gt;levels
op_assign
l_int|NULL
suffix:semicolon
id|devc-&gt;debug_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Check that the I/O address is in use.&n;&t; *&n;&t; * The bit 0x80 of the base I/O port is known to be 0 after the&n;&t; * chip has performed its power on initialization. Just assume&n;&t; * this has happened before the OS is starting.&n;&t; *&n;&t; * If the I/O address is unused, it typically returns 0xff.&n;&t; */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0xff
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect: The base I/O address appears to be dead&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Wait for the device to stop initialization&n;&t; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step 0&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|x
op_assign
id|inb
c_func
(paren
id|devc-&gt;base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
l_int|0xff
op_logical_or
op_logical_neg
(paren
id|x
op_amp
l_int|0x80
)paren
)paren
r_break
suffix:semicolon
)brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step A&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/* Not ready. Let&squot;s wait */
id|ad_leave_MCE
c_func
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|devc-&gt;base
)paren
op_amp
l_int|0x80
)paren
op_ne
l_int|0x00
)paren
multiline_comment|/* Not a AD1848 */
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848 detect error - step A (%02x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|inb
c_func
(paren
id|devc-&gt;base
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Test if it&squot;s possible to change contents of the indirect registers.&n;&t; * Registers 0 and 1 are ADC volume registers. The bit 0x10 is read only&n;&t; * so try to avoid using it.&n;&t; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step B&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|1
comma
l_int|0x45
)paren
suffix:semicolon
multiline_comment|/* 0x55 with bit 0x10 clear */
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|0
)paren
)paren
op_ne
l_int|0xaa
op_logical_or
(paren
id|tmp2
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|1
)paren
)paren
op_ne
l_int|0x45
)paren
(brace
r_if
c_cond
(paren
id|tmp2
op_eq
l_int|0x65
)paren
multiline_comment|/* AD1847 has couple of bits hardcoded to 1 */
id|ad1847_flag
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848 detect error - step B (%x/%x)&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step C&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|0
comma
l_int|0x45
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|1
comma
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|0
)paren
)paren
op_ne
l_int|0x45
op_logical_or
(paren
id|tmp2
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|1
)paren
)paren
op_ne
l_int|0xaa
)paren
(brace
r_if
c_cond
(paren
id|tmp2
op_eq
l_int|0x8a
)paren
multiline_comment|/* AD1847 has few bits hardcoded to 1 */
id|ad1847_flag
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848 detect error - step C (%x/%x)&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * The indirect register I12 has some read only bits. Let&squot;s&n;&t; * try to change them.&n;&t; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step D&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|12
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
(paren
op_complement
id|tmp
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x0f
)paren
op_ne
(paren
(paren
id|tmp1
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|12
)paren
)paren
op_amp
l_int|0x0f
)paren
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848 detect error - step D (%x)&bslash;n&quot;
comma
id|tmp1
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * NOTE! Last 4 bits of the reg I12 tell the chip revision.&n;&t; *   0x01=RevB and 0x0A=RevC.&n;&t; */
multiline_comment|/*&n;&t; * The original AD1848/CS4248 has just 15 indirect registers. This means&n;&t; * that I0 and I16 should return the same value (etc.).&n;&t; * However this doesn&squot;t work with CS4248. Actually it seems to be impossible&n;&t; * to detect if the chip is a CS4231 or CS4248.&n;&t; * Ensure that the Mode2 enable bit of I12 is 0. Otherwise this test fails&n;&t; * with CS4231.&n;&t; */
multiline_comment|/*&n;&t; * OPTi 82C930 has mode2 control bit in another place. This test will fail&n;&t; * with it. Accept this situation as a possible indication of this chip.&n;&t; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step F&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Mode2=disabled */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
c_func
(paren
id|devc
comma
id|i
)paren
)paren
op_ne
(paren
id|tmp2
op_assign
id|ad_read
c_func
(paren
id|devc
comma
id|i
op_plus
l_int|16
)paren
)paren
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848 detect step F(%d/%x/%x) - OPTi chip???&bslash;n&quot;
comma
id|i
comma
id|tmp1
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ad1847_flag
)paren
id|optiC930
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Try to switch the chip to mode2 (CS4231) by setting the MODE2 bit (0x40).&n;&t; * The bit 0x80 is always 1 in CS4248 and CS4231.&n;&t; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step G&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
op_logical_and
op_star
id|ad_flags
op_eq
l_int|400
)paren
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
r_else
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Set mode2, clear 0x80 */
r_if
c_cond
(paren
id|ad_flags
)paren
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
id|tmp1
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp1
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|ad_flags
)paren
op_star
id|ad_flags
op_or_assign
id|AD_F_CS4248
suffix:semicolon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4248&quot;
suffix:semicolon
multiline_comment|/* Our best knowledge just now */
)brace
r_if
c_cond
(paren
id|optiC930
op_logical_or
(paren
id|tmp1
op_amp
l_int|0xc0
)paren
op_eq
(paren
l_int|0x80
op_or
l_int|0x40
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *      CS4231 detected - is it?&n;&t;&t; *&n;&t;&t; *      Verify that setting I0 doesn&squot;t change I16.&n;&t;&t; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step H&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set I16 to known value */
id|ad_write
c_func
(paren
id|devc
comma
l_int|0
comma
l_int|0x45
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|16
)paren
)paren
op_ne
l_int|0x45
)paren
multiline_comment|/* No change -&gt; CS4231? */
(brace
id|ad_write
c_func
(paren
id|devc
comma
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|16
)paren
)paren
op_eq
l_int|0xaa
)paren
multiline_comment|/* Rotten bits? */
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848 detect error - step H(%x)&bslash;n&quot;
comma
id|tmp1
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Verify that some bits of I25 are read only.&n;&t;&t;&t; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step I&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tmp1
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|25
)paren
suffix:semicolon
multiline_comment|/* Original bits */
id|ad_write
c_func
(paren
id|devc
comma
l_int|25
comma
op_complement
id|tmp1
)paren
suffix:semicolon
multiline_comment|/* Invert all bits */
r_if
c_cond
(paren
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|25
)paren
op_amp
l_int|0xe7
)paren
op_eq
(paren
id|tmp1
op_amp
l_int|0xe7
)paren
)paren
(brace
r_int
id|id
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; *      It&squot;s at least CS4231&n;&t;&t;&t;&t; */
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4231&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4231
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * It could be an AD1845 or CS4231A as well.&n;&t;&t;&t;&t; * CS4231 and AD1845 report the same revision info in I25&n;&t;&t;&t;&t; * while the CS4231A reports different.&n;&t;&t;&t;&t; */
id|id
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|25
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_amp
l_int|0xe7
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/* Device busy??? */
id|id
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|25
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_amp
l_int|0xe7
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/* Device still busy??? */
id|id
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|25
)paren
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step J (%02x/%02x)&bslash;n&quot;
comma
id|id
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|25
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_amp
l_int|0xe7
)paren
op_eq
l_int|0x80
)paren
(brace
multiline_comment|/* &n;&t;&t;&t;&t;&t; * It must be a CS4231 or AD1845. The register I23 of&n;&t;&t;&t;&t;&t; * CS4231 is undefined and it appears to be read only.&n;&t;&t;&t;&t;&t; * AD1845 uses I23 for setting sample rate. Assume&n;&t;&t;&t;&t;&t; * the chip is AD1845 if I23 is changeable.&n;&t;&t;&t;&t;&t; */
r_int
r_char
id|tmp
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|23
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|23
comma
op_complement
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interwave
)paren
(brace
id|devc-&gt;model
op_assign
id|MD_IWAVE
suffix:semicolon
id|devc-&gt;chip_name
op_assign
l_string|&quot;IWave&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|23
)paren
op_ne
id|tmp
)paren
multiline_comment|/* AD1845 ? */
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;AD1845&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_1845
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cs4248_flag
)paren
(brace
r_if
c_cond
(paren
id|ad_flags
)paren
op_star
id|ad_flags
op_or_assign
id|AD_F_CS4248
suffix:semicolon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4248&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_1848
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|12
)paren
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mode2 off */
)brace
id|ad_write
c_func
(paren
id|devc
comma
l_int|23
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore */
)brace
r_else
(brace
r_switch
c_cond
(paren
id|id
op_amp
l_int|0x1f
)paren
(brace
r_case
l_int|3
suffix:colon
multiline_comment|/* CS4236/CS4235 */
(brace
r_int
id|xid
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|12
)paren
op_or
l_int|0x60
)paren
suffix:semicolon
multiline_comment|/* switch to mode 3 */
id|ad_write
c_func
(paren
id|devc
comma
l_int|23
comma
l_int|0x9c
)paren
suffix:semicolon
multiline_comment|/* select extended register 25 */
id|xid
op_assign
id|inb
c_func
(paren
id|io_Indexed_Data
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|12
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|12
)paren
op_amp
op_complement
l_int|0x60
)paren
suffix:semicolon
multiline_comment|/* back to mode 0 */
r_if
c_cond
(paren
(paren
id|xid
op_amp
l_int|0x1f
)paren
op_eq
l_int|0x1d
)paren
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4235&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4235
suffix:semicolon
)brace
r_else
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4236&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4232
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* CS4232/CS4232A */
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4232&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4232
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
(paren
id|id
op_amp
l_int|0xe0
)paren
op_eq
l_int|0xa0
)paren
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4231A&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4231A
suffix:semicolon
)brace
r_else
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4321&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4231
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* maybe */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848: I25 = %02x/%02x&bslash;n&quot;
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|25
)paren
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|25
)paren
op_amp
l_int|0xe7
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|optiC930
)paren
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;82C930&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_C930
suffix:semicolon
)brace
r_else
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4231&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4231
suffix:semicolon
)brace
)brace
)brace
)brace
id|ad_write
c_func
(paren
id|devc
comma
l_int|25
comma
id|tmp1
)paren
suffix:semicolon
multiline_comment|/* Restore bits */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step K&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|tmp1
op_eq
l_int|0x0a
)paren
(brace
multiline_comment|/*&n;&t;&t; * Is it perhaps a SoundPro CMI8330?&n;&t;&t; * If so, then we should be able to change indirect registers&n;&t;&t; * greater than I15 after activating MODE2, even though reading&n;&t;&t; * back I12 does not show it.&n;&t;&t; */
multiline_comment|/*&n;&t;&t; * Let&squot;s try comparing register values&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
c_func
(paren
id|devc
comma
id|i
)paren
)paren
op_ne
(paren
id|tmp2
op_assign
id|ad_read
c_func
(paren
id|devc
comma
id|i
op_plus
l_int|16
)paren
)paren
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848 detect step H(%d/%x/%x) - SoundPro chip?&bslash;n&quot;
comma
id|i
comma
id|tmp1
comma
id|tmp2
)paren
)paren
suffix:semicolon
id|soundpro
op_assign
l_int|1
suffix:semicolon
id|devc-&gt;chip_name
op_assign
l_string|&quot;SoundPro CMI 8330&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - step L&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
)paren
op_star
id|ad_flags
op_or_assign
id|AD_F_CS4231
suffix:semicolon
)brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848_detect() - Detected OK&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1848
op_logical_and
id|ad1847_flag
)paren
id|devc-&gt;chip_name
op_assign
l_string|&quot;AD1847&quot;
suffix:semicolon
r_if
c_cond
(paren
id|sscape_flag
op_eq
l_int|1
)paren
id|devc-&gt;model
op_assign
id|MD_1845_SSCAPE
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ad1848_init
r_int
id|ad1848_init
(paren
r_char
op_star
id|name
comma
r_int
id|io_base
comma
r_int
id|irq
comma
r_int
id|dma_playback
comma
r_int
id|dma_capture
comma
r_int
id|share_dma
comma
r_int
op_star
id|osp
comma
r_struct
id|module
op_star
id|owner
)paren
(brace
multiline_comment|/*&n;&t; * NOTE! If irq &lt; 0, there is another driver which has allocated the IRQ&n;&t; *   so that this driver doesn&squot;t need to allocate/deallocate it.&n;&t; *   The actually used IRQ is ABS(irq).&n;&t; */
r_int
id|my_dev
suffix:semicolon
r_char
id|dev_name
(braket
l_int|100
)braket
suffix:semicolon
r_int
id|e
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
op_amp
id|adev_info
(braket
id|nr_ad1848_devs
)braket
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
l_int|NULL
suffix:semicolon
id|devc-&gt;irq
op_assign
(paren
id|irq
OG
l_int|0
)paren
ques
c_cond
id|irq
suffix:colon
l_int|0
suffix:semicolon
id|devc-&gt;open_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;dma1
op_assign
id|dma_playback
suffix:semicolon
id|devc-&gt;dma2
op_assign
id|dma_capture
suffix:semicolon
id|devc-&gt;subtype
op_assign
id|cfg.card_subtype
suffix:semicolon
id|devc-&gt;audio_flags
op_assign
id|DMA_AUTOMODE
suffix:semicolon
id|devc-&gt;playback_dev
op_assign
id|devc-&gt;record_dev
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
)paren
id|devc-&gt;name
op_assign
id|name
suffix:semicolon
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
op_logical_and
id|name
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
id|sprintf
c_func
(paren
id|dev_name
comma
l_string|&quot;%s (%s)&quot;
comma
id|name
comma
id|devc-&gt;chip_name
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|dev_name
comma
l_string|&quot;Generic audio codec (%s)&quot;
comma
id|devc-&gt;chip_name
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|devc-&gt;base
comma
l_int|4
comma
id|devc-&gt;name
)paren
suffix:semicolon
id|conf_printf2
c_func
(paren
id|dev_name
comma
id|devc-&gt;base
comma
id|devc-&gt;irq
comma
id|dma_playback
comma
id|dma_capture
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1848
op_logical_or
id|devc-&gt;model
op_eq
id|MD_C930
)paren
id|devc-&gt;audio_flags
op_or_assign
id|DMA_HARDSTOP
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
OG
id|MD_1848
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;dma1
op_eq
id|devc-&gt;dma2
op_logical_or
id|devc-&gt;dma2
op_eq
op_minus
l_int|1
op_logical_or
id|devc-&gt;dma1
op_eq
op_minus
l_int|1
)paren
id|devc-&gt;audio_flags
op_and_assign
op_complement
id|DMA_DUPLEX
suffix:semicolon
r_else
id|devc-&gt;audio_flags
op_or_assign
id|DMA_DUPLEX
suffix:semicolon
)brace
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ad1848_port_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portc
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|owner
)paren
id|ad1848_audio_driver.owner
op_assign
id|owner
suffix:semicolon
r_if
c_cond
(paren
(paren
id|my_dev
op_assign
id|sound_install_audiodrv
c_func
(paren
id|AUDIO_DRIVER_VERSION
comma
id|dev_name
comma
op_amp
id|ad1848_audio_driver
comma
r_sizeof
(paren
r_struct
id|audio_driver
)paren
comma
id|devc-&gt;audio_flags
comma
id|ad_format_mask
(braket
id|devc-&gt;model
)braket
comma
id|devc
comma
id|dma_playback
comma
id|dma_capture
)paren
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|portc
)paren
suffix:semicolon
id|portc
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|portc
op_assign
id|portc
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|mixer_dev
op_assign
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|portc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|portc
)paren
)paren
suffix:semicolon
id|nr_ad1848_devs
op_increment
suffix:semicolon
id|devc-&gt;pmdev
op_assign
id|pm_register
c_func
(paren
id|PM_ISA_DEV
comma
id|my_dev
comma
id|ad1848_pm_callback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;pmdev
)paren
id|devc-&gt;pmdev-&gt;data
op_assign
id|devc
suffix:semicolon
id|ad1848_init_hw
c_func
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
(brace
id|devc-&gt;dev_no
op_assign
id|my_dev
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|devc-&gt;irq
comma
id|adintr
comma
l_int|0
comma
id|devc-&gt;name
comma
(paren
r_void
op_star
)paren
id|my_dev
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ad1848: Unable to allocate IRQ&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t free it either then.. */
id|devc-&gt;irq
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|capabilities
(braket
id|devc-&gt;model
)braket
dot
id|flags
op_amp
id|CAP_F_TIMER
)paren
(brace
macro_line|#ifndef CONFIG_SMP
r_int
id|x
suffix:semicolon
r_int
r_char
id|tmp
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|16
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;
id|devc-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|21
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Timer MSB */
id|ad_write
c_func
(paren
id|devc
comma
l_int|20
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* Timer LSB */
macro_line|#ifndef CONFIG_SMP
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Enable timer */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
l_int|100000
op_logical_and
id|devc-&gt;timer_ticks
op_eq
l_int|0
suffix:semicolon
id|x
op_increment
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Disable timer */
r_if
c_cond
(paren
id|devc-&gt;timer_ticks
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ad1848: Interrupt test failed (IRQ%d)&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_else
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Interrupt test OK&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#else
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
macro_line|#endif&t;&t;&t;
)brace
r_else
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Couldn&squot;t test. assume it&squot;s OK */
)brace
r_else
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
id|irq2dev
(braket
op_minus
id|irq
)braket
op_assign
id|devc-&gt;dev_no
op_assign
id|my_dev
suffix:semicolon
macro_line|#ifndef EXCLUDE_TIMERS
r_if
c_cond
(paren
(paren
id|capabilities
(braket
id|devc-&gt;model
)braket
dot
id|flags
op_amp
id|CAP_F_TIMER
)paren
op_logical_and
id|devc-&gt;irq_ok
)paren
id|ad1848_tmr_install
c_func
(paren
id|my_dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|share_dma
)paren
(brace
r_if
c_cond
(paren
id|sound_alloc_dma
c_func
(paren
id|dma_playback
comma
id|devc-&gt;name
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ad1848.c: Can&squot;t allocate DMA%d&bslash;n&quot;
comma
id|dma_playback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_capture
op_ne
id|dma_playback
)paren
r_if
c_cond
(paren
id|sound_alloc_dma
c_func
(paren
id|dma_capture
comma
id|devc-&gt;name
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ad1848.c: Can&squot;t allocate DMA%d&bslash;n&quot;
comma
id|dma_capture
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|e
op_assign
id|sound_install_mixer
c_func
(paren
id|MIXER_DRIVER_VERSION
comma
id|dev_name
comma
op_amp
id|ad1848_mixer_operations
comma
r_sizeof
(paren
r_struct
id|mixer_operations
)paren
comma
id|devc
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|mixer_dev
op_assign
id|e
suffix:semicolon
)brace
r_return
id|my_dev
suffix:semicolon
)brace
DECL|function|ad1848_control
r_int
id|ad1848_control
c_func
(paren
r_int
id|cmd
comma
r_int
id|arg
)paren
(brace
id|ad1848_info
op_star
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|nr_ad1848_devs
OL
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|devc
op_assign
op_amp
id|adev_info
(braket
id|nr_ad1848_devs
op_minus
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AD1848_SET_XTAL
suffix:colon
multiline_comment|/* Change clock frequency of AD1845 (only ) */
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1845
op_logical_or
id|devc-&gt;model
op_ne
id|MD_1845_SSCAPE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ad_enter_MCE
c_func
(paren
id|devc
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|29
comma
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|29
)paren
op_amp
l_int|0x1f
)paren
op_or
(paren
id|arg
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
id|ad_leave_MCE
c_func
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD1848_MIXER_REROUTE
suffix:colon
(brace
r_int
id|o
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|n
op_assign
id|arg
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|o
OL
l_int|0
op_logical_or
id|o
op_ge
id|SOUND_MIXER_NRDEVICES
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|o
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|devc-&gt;supported_rec_devices
op_amp
(paren
l_int|1
op_lshift
id|o
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
id|SOUND_MIXER_NONE
)paren
(brace
multiline_comment|/* Just hide this control */
id|ad1848_mixer_set
c_func
(paren
id|devc
comma
id|o
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Shut up it */
id|devc-&gt;supported_devices
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|o
)paren
suffix:semicolon
id|devc-&gt;supported_rec_devices
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|o
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Make the mixer control identified by o to appear as n */
r_if
c_cond
(paren
id|n
OL
l_int|0
op_logical_or
id|n
op_ge
id|SOUND_MIXER_NRDEVICES
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|devc-&gt;mixer_reroute
(braket
id|n
)braket
op_assign
id|o
suffix:semicolon
multiline_comment|/* Rename the control */
r_if
c_cond
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|o
)paren
)paren
id|devc-&gt;supported_devices
op_or_assign
(paren
l_int|1
op_lshift
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;supported_rec_devices
op_amp
(paren
l_int|1
op_lshift
id|o
)paren
)paren
id|devc-&gt;supported_rec_devices
op_or_assign
(paren
l_int|1
op_lshift
id|n
)paren
suffix:semicolon
id|devc-&gt;supported_devices
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|o
)paren
suffix:semicolon
id|devc-&gt;supported_rec_devices
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|o
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1848_unload
r_void
id|ad1848_unload
c_func
(paren
r_int
id|io_base
comma
r_int
id|irq
comma
r_int
id|dma_playback
comma
r_int
id|dma_capture
comma
r_int
id|share_dma
)paren
(brace
r_int
id|i
comma
id|mixer
comma
id|dev
op_assign
l_int|0
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|devc
op_eq
l_int|NULL
op_logical_and
id|i
OL
id|nr_ad1848_devs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|adev_info
(braket
id|i
)braket
dot
id|base
op_eq
id|io_base
)paren
(brace
id|devc
op_assign
op_amp
id|adev_info
(braket
id|i
)braket
suffix:semicolon
id|dev
op_assign
id|devc-&gt;dev_no
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|devc
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|devc-&gt;base
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|share_dma
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;irq
OG
l_int|0
)paren
multiline_comment|/* There is no point in freeing irq, if it wasn&squot;t allocated */
id|free_irq
c_func
(paren
id|devc-&gt;irq
comma
(paren
r_void
op_star
)paren
id|devc-&gt;dev_no
)paren
suffix:semicolon
id|sound_free_dma
c_func
(paren
id|dma_playback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_playback
op_ne
id|dma_capture
)paren
id|sound_free_dma
c_func
(paren
id|dma_capture
)paren
suffix:semicolon
)brace
id|mixer
op_assign
id|audio_devs
(braket
id|devc-&gt;dev_no
)braket
op_member_access_from_pointer
id|mixer_dev
suffix:semicolon
r_if
c_cond
(paren
id|mixer
op_ge
l_int|0
)paren
(brace
id|sound_unload_mixerdev
c_func
(paren
id|mixer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;pmdev
)paren
id|pm_unregister
c_func
(paren
id|devc-&gt;pmdev
)paren
suffix:semicolon
id|nr_ad1848_devs
op_decrement
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|nr_ad1848_devs
suffix:semicolon
id|i
op_increment
)paren
id|adev_info
(braket
id|i
)braket
op_assign
id|adev_info
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ad1848: Can&squot;t find device to be unloaded. Base=%x&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
)brace
DECL|function|adintr
r_void
id|adintr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|ad1848_info
op_star
id|devc
suffix:semicolon
r_int
id|dev
suffix:semicolon
r_int
id|alt_stat
op_assign
l_int|0xff
suffix:semicolon
r_int
r_char
id|c930_stat
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|dev
op_assign
(paren
r_int
)paren
id|dev_id
suffix:semicolon
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|interrupt_again
suffix:colon
multiline_comment|/* Jump back here if int status doesn&squot;t reset */
id|status
op_assign
id|inb
c_func
(paren
id|io_Status
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0x80
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;adintr: Why?&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1848
)paren
id|outb
c_func
(paren
(paren
l_int|0
)paren
comma
id|io_Status
c_func
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x01
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_C930
)paren
(brace
multiline_comment|/* 82C930 has interrupt status register in MAD16 register MC11 */
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* 0xe0e is C930 address port&n;&t;&t;&t; * 0xe0f is C930 data port&n;&t;&t;&t; */
id|outb
c_func
(paren
l_int|11
comma
l_int|0xe0e
)paren
suffix:semicolon
id|c930_stat
op_assign
id|inb
c_func
(paren
l_int|0xe0f
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
op_complement
id|c930_stat
)paren
comma
l_int|0xe0f
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|alt_stat
op_assign
(paren
id|c930_stat
op_lshift
l_int|2
)paren
op_amp
l_int|0x30
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
)paren
(brace
id|alt_stat
op_assign
id|ad_read
c_func
(paren
id|devc
comma
l_int|24
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|24
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|24
)paren
op_amp
op_complement
id|alt_stat
)paren
suffix:semicolon
multiline_comment|/* Selective ack */
)brace
r_if
c_cond
(paren
(paren
id|devc-&gt;open_mode
op_amp
id|OPEN_READ
)paren
op_logical_and
(paren
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_INPUT
)paren
op_logical_and
(paren
id|alt_stat
op_amp
l_int|0x20
)paren
)paren
(brace
id|DMAbuf_inputintr
c_func
(paren
id|devc-&gt;record_dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|devc-&gt;open_mode
op_amp
id|OPEN_WRITE
)paren
op_logical_and
(paren
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_OUTPUT
)paren
op_logical_and
(paren
id|alt_stat
op_amp
l_int|0x10
)paren
)paren
(brace
id|DMAbuf_outputintr
c_func
(paren
id|devc-&gt;playback_dev
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
op_logical_and
(paren
id|alt_stat
op_amp
l_int|0x40
)paren
)paren
multiline_comment|/* Timer interrupt */
(brace
id|devc-&gt;timer_ticks
op_increment
suffix:semicolon
macro_line|#ifndef EXCLUDE_TIMERS
r_if
c_cond
(paren
id|timer_installed
op_eq
id|dev
op_logical_and
id|devc-&gt;timer_running
)paren
id|sound_timer_interrupt
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/*&n; * Sometimes playback or capture interrupts occur while a timer interrupt&n; * is being handled. The interrupt will not be retriggered if we don&squot;t&n; * handle it now. Check if an interrupt is still pending and restart&n; * the handler in this case.&n; */
r_if
c_cond
(paren
id|inb
c_func
(paren
id|io_Status
c_func
(paren
id|devc
)paren
)paren
op_amp
l_int|0x01
op_logical_and
id|cnt
op_increment
OL
l_int|4
)paren
(brace
r_goto
id|interrupt_again
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Experimental initialization sequence for the integrated sound system&n; *&t;of the Compaq Deskpro M.&n; */
DECL|function|init_deskpro_m
r_static
r_int
id|init_deskpro_m
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|inb
c_func
(paren
l_int|0xc44
)paren
)paren
op_eq
l_int|0xff
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;init_deskpro_m: Dead port 0xc44&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
c_func
(paren
l_int|0x10
comma
l_int|0xc44
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x40
comma
l_int|0xc45
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
l_int|0xc46
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xe8
comma
l_int|0xc47
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x14
comma
l_int|0xc44
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x40
comma
l_int|0xc45
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
l_int|0xc46
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xe8
comma
l_int|0xc47
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x10
comma
l_int|0xc44
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Experimental initialization sequence for the integrated sound system&n; *&t;of Compaq Deskpro XL.&n; */
DECL|function|init_deskpro
r_static
r_int
id|init_deskpro
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|inb
c_func
(paren
l_int|0xc44
)paren
)paren
op_eq
l_int|0xff
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;init_deskpro: Dead port 0xc44&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank 1 */
r_if
c_cond
(paren
id|inb
c_func
(paren
l_int|0xc44
)paren
op_ne
l_int|0x04
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;init_deskpro: Invalid bank1 signature in port 0xc44&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * OK. It looks like a Deskpro so let&squot;s proceed.&n;&t; */
multiline_comment|/*&n;&t; * I/O port 0xc44 Audio configuration register.&n;&t; *&n;&t; * bits 0xc0:   Audio revision bits&n;&t; *              0x00 = Compaq Business Audio&n;&t; *              0x40 = MS Sound System Compatible (reset default)&n;&t; *              0x80 = Reserved&n;&t; *              0xc0 = Reserved&n;&t; * bit 0x20:    No Wait State Enable&n;&t; *              0x00 = Disabled (reset default, DMA mode)&n;&t; *              0x20 = Enabled (programmed I/O mode)&n;&t; * bit 0x10:    MS Sound System Decode Enable&n;&t; *              0x00 = Decoding disabled (reset default)&n;&t; *              0x10 = Decoding enabled&n;&t; * bit 0x08:    FM Synthesis Decode Enable&n;&t; *              0x00 = Decoding Disabled (reset default)&n;&t; *              0x08 = Decoding enabled&n;&t; * bit 0x04     Bank select&n;&t; *              0x00 = Bank 0&n;&t; *              0x04 = Bank 1&n;&t; * bits 0x03    MSS Base address&n;&t; *              0x00 = 0x530 (reset default)&n;&t; *              0x01 = 0x604&n;&t; *              0x02 = 0xf40&n;&t; *              0x03 = 0xe80&n;&t; */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
c_func
(paren
l_string|&quot;Port 0xc44 (before): &quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|inb
c_func
(paren
l_int|0xc44
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc44
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Set bank 1 of the register */
id|tmp
op_assign
l_int|0x58
suffix:semicolon
multiline_comment|/* MSS Mode, MSS&amp;FM decode enabled */
r_switch
c_cond
(paren
id|hw_config-&gt;io_base
)paren
(brace
r_case
l_int|0x530
suffix:colon
id|tmp
op_or_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x604
suffix:colon
id|tmp
op_or_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf40
suffix:colon
id|tmp
op_or_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe80
suffix:colon
id|tmp
op_or_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;init_deskpro: Invalid MSS port %x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Write to bank=0 */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
c_func
(paren
l_string|&quot;Port 0xc44 (after): &quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|inb
c_func
(paren
l_int|0xc44
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
c_func
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc44
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * I/O port 0xc45 FM Address Decode/MSS ID Register.&n;&t; *&n;&t; * bank=0, bits 0xfe:   FM synthesis Decode Compare bits 7:1 (default=0x88)&n;&t; * bank=0, bit 0x01:    SBIC Power Control Bit&n;&t; *                      0x00 = Powered up&n;&t; *                      0x01 = Powered down&n;&t; * bank=1, bits 0xfc:   MSS ID (default=0x40)&n;&t; */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
c_func
(paren
l_string|&quot;Port 0xc45 (before): &quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|inb
c_func
(paren
l_int|0xc45
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
c_func
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc45
)paren
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|outb
c_func
(paren
(paren
l_int|0x88
)paren
comma
l_int|0xc45
)paren
suffix:semicolon
multiline_comment|/* FM base 7:0 = 0x88 */
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|outb
c_func
(paren
(paren
l_int|0x10
)paren
comma
l_int|0xc45
)paren
suffix:semicolon
multiline_comment|/* MSS ID = 0x10 (MSS port returns 0x04) */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
c_func
(paren
l_string|&quot;Port 0xc45 (after): &quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|inb
c_func
(paren
l_int|0xc45
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
c_func
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc45
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * I/O port 0xc46 FM Address Decode/Address ASIC Revision Register.&n;&t; *&n;&t; * bank=0, bits 0xff:   FM synthesis Decode Compare bits 15:8 (default=0x03)&n;&t; * bank=1, bits 0xff:   Audio addressing ASIC id&n;&t; */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
c_func
(paren
l_string|&quot;Port 0xc46 (before): &quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|inb
c_func
(paren
l_int|0xc46
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
c_func
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc46
)paren
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|outb
c_func
(paren
(paren
l_int|0x03
)paren
comma
l_int|0xc46
)paren
suffix:semicolon
multiline_comment|/* FM base 15:8 = 0x03 */
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|outb
c_func
(paren
(paren
l_int|0x11
)paren
comma
l_int|0xc46
)paren
suffix:semicolon
multiline_comment|/* ASIC ID = 0x11 */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
c_func
(paren
l_string|&quot;Port 0xc46 (after): &quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|inb
c_func
(paren
l_int|0xc46
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
c_func
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc46
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * I/O port 0xc47 FM Address Decode Register.&n;&t; *&n;&t; * bank=0, bits 0xff:   Decode enable selection for various FM address bits&n;&t; * bank=1, bits 0xff:   Reserved&n;&t; */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
c_func
(paren
l_string|&quot;Port 0xc47 (before): &quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|inb
c_func
(paren
l_int|0xc47
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
c_func
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc47
)paren
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|outb
c_func
(paren
(paren
l_int|0x7c
)paren
comma
l_int|0xc47
)paren
suffix:semicolon
multiline_comment|/* FM decode enable bits = 0x7c */
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
l_int|0xc47
)paren
suffix:semicolon
multiline_comment|/* Reserved bank1 = 0x00 */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
c_func
(paren
l_string|&quot;Port 0xc47 (after): &quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|inb
c_func
(paren
l_int|0xc47
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
c_func
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc47
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * I/O port 0xc6f = Audio Disable Function Register&n;&t; */
macro_line|#ifdef DEBUGXL
id|printk
c_func
(paren
l_string|&quot;Port 0xc6f (before) = %02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc6f
)paren
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
(paren
l_int|0x80
)paren
comma
l_int|0xc6f
)paren
suffix:semicolon
macro_line|#ifdef DEBUGXL
id|printk
c_func
(paren
l_string|&quot;Port 0xc6f (after) = %02x&bslash;n&quot;
comma
id|inb
c_func
(paren
l_int|0xc6f
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|probe_ms_sound
r_int
id|probe_ms_sound
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Entered probe_ms_sound(%x, %d)&bslash;n&quot;
comma
id|hw_config-&gt;io_base
comma
id|hw_config-&gt;card_subtype
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|8
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: I/O port conflict&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;card_subtype
op_eq
l_int|1
)paren
multiline_comment|/* Has no IRQ/DMA registers */
(brace
multiline_comment|/* check_opl3(0x388, hw_config); */
r_return
id|ad1848_detect
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|deskpro_xl
op_logical_and
id|hw_config-&gt;card_subtype
op_eq
l_int|2
)paren
multiline_comment|/* Compaq Deskpro XL */
(brace
r_if
c_cond
(paren
op_logical_neg
id|init_deskpro
c_func
(paren
id|hw_config
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|deskpro_m
)paren
multiline_comment|/* Compaq Deskpro M */
(brace
r_if
c_cond
(paren
op_logical_neg
id|init_deskpro_m
c_func
(paren
id|hw_config
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   * Check if the IO port returns valid signature. The original MS Sound&n;&t;   * system returns 0x04 while some cards (AudioTrix Pro for example)&n;&t;   * return 0x00 or 0x0f.&n;&t; */
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
)paren
op_eq
l_int|0xff
)paren
multiline_comment|/* Bus float */
(brace
r_int
id|ret
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;I/O address is inactive (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|ad1848_detect
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;MSS signature = %x&bslash;n&quot;
comma
id|tmp
op_amp
l_int|0x3f
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x04
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x0f
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x00
)paren
(brace
r_int
id|ret
suffix:semicolon
id|MDB
c_func
(paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No MSS signature detected on port 0x%x (0x%x)&bslash;n&quot;
comma
id|hw_config-&gt;io_base
comma
(paren
r_int
)paren
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
)paren
)paren
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Trying to detect codec anyway but IRQ/DMA may not work&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|ad1848_detect
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|hw_config-&gt;card_subtype
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|hw_config-&gt;irq
op_ne
l_int|5
)paren
op_logical_and
(paren
id|hw_config-&gt;irq
op_ne
l_int|7
)paren
op_logical_and
(paren
id|hw_config-&gt;irq
op_ne
l_int|9
)paren
op_logical_and
(paren
id|hw_config-&gt;irq
op_ne
l_int|10
)paren
op_logical_and
(paren
id|hw_config-&gt;irq
op_ne
l_int|11
)paren
op_logical_and
(paren
id|hw_config-&gt;irq
op_ne
l_int|12
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: Bad IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_ne
l_int|0
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|1
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: Bad DMA %d&bslash;n&quot;
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check that DMA0 is not in use with a 8 bit board.&n;&t; */
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_eq
l_int|0
op_logical_and
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: Can&squot;t use DMA0 with a 8 bit card/slot&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|7
op_logical_and
id|hw_config-&gt;irq
op_ne
l_int|9
op_logical_and
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: Can&squot;t use IRQ%d with a 8 bit card/slot&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|ad1848_detect
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
)brace
DECL|function|attach_ms_sound
r_void
id|attach_ms_sound
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
comma
r_struct
id|module
op_star
id|owner
)paren
(brace
r_static
r_int
r_char
id|interrupt_bits
(braket
l_int|12
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x00
comma
op_minus
l_int|1
comma
l_int|0x08
comma
op_minus
l_int|1
comma
l_int|0x10
comma
l_int|0x18
comma
l_int|0x20
)brace
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
r_char
id|dma2_bit
op_assign
l_int|0
suffix:semicolon
r_static
r_char
id|dma_bits
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|0
comma
l_int|3
)brace
suffix:semicolon
r_int
id|config_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|0
suffix:semicolon
r_int
id|version_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|3
suffix:semicolon
r_int
id|dma
op_assign
id|hw_config-&gt;dma
suffix:semicolon
r_int
id|dma2
op_assign
id|hw_config-&gt;dma2
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;card_subtype
op_eq
l_int|1
)paren
multiline_comment|/* Has no IRQ/DMA registers */
(brace
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_assign
id|ad1848_init
c_func
(paren
l_string|&quot;MS Sound System&quot;
comma
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
comma
l_int|0
comma
id|hw_config-&gt;osp
comma
id|owner
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|4
comma
l_string|&quot;WSS config&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set the IRQ and DMA addresses.&n;&t; */
id|bits
op_assign
id|interrupt_bits
(braket
id|hw_config-&gt;irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: Bad IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
id|bits
op_or
l_int|0x40
)paren
comma
id|config_port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|version_port
)paren
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;[MSS: IRQ Conflict?]&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Handle the capture DMA channel&n; */
r_if
c_cond
(paren
id|dma2
op_ne
op_minus
l_int|1
op_logical_and
id|dma2
op_ne
id|dma
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|dma
op_eq
l_int|0
op_logical_and
id|dma2
op_eq
l_int|1
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|1
op_logical_and
id|dma2
op_eq
l_int|0
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|3
op_logical_and
id|dma2
op_eq
l_int|0
)paren
)paren
)paren
(brace
multiline_comment|/* Unsupported combination. Try to swap channels */
r_int
id|tmp
op_assign
id|dma
suffix:semicolon
id|dma
op_assign
id|dma2
suffix:semicolon
id|dma2
op_assign
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dma
op_eq
l_int|0
op_logical_and
id|dma2
op_eq
l_int|1
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|1
op_logical_and
id|dma2
op_eq
l_int|0
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|3
op_logical_and
id|dma2
op_eq
l_int|0
)paren
)paren
(brace
id|dma2_bit
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Enable capture DMA */
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;MSS: Invalid capture DMA&bslash;n&quot;
)paren
suffix:semicolon
id|dma2
op_assign
id|dma
suffix:semicolon
)brace
)brace
r_else
(brace
id|dma2
op_assign
id|dma
suffix:semicolon
)brace
id|hw_config-&gt;dma
op_assign
id|dma
suffix:semicolon
id|hw_config-&gt;dma2
op_assign
id|dma2
suffix:semicolon
id|outb
c_func
(paren
(paren
id|bits
op_or
id|dma_bits
(braket
id|dma
)braket
op_or
id|dma2_bit
)paren
comma
id|config_port
)paren
suffix:semicolon
multiline_comment|/* Write IRQ+DMA setup */
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_assign
id|ad1848_init
c_func
(paren
l_string|&quot;MS Sound System&quot;
comma
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|dma
comma
id|dma2
comma
l_int|0
comma
id|hw_config-&gt;osp
comma
id|THIS_MODULE
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|4
comma
l_string|&quot;WSS config&quot;
)paren
suffix:semicolon
)brace
DECL|function|unload_ms_sound
r_void
id|unload_ms_sound
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|ad1848_unload
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
comma
l_int|0
)paren
suffix:semicolon
id|sound_unload_audiodev
c_func
(paren
id|hw_config-&gt;slots
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|4
)paren
suffix:semicolon
)brace
macro_line|#ifndef EXCLUDE_TIMERS
multiline_comment|/*&n; * Timer stuff (for /dev/music).&n; */
DECL|variable|current_interval
r_static
r_int
r_int
id|current_interval
op_assign
l_int|0
suffix:semicolon
DECL|function|ad1848_tmr_start
r_static
r_int
r_int
id|ad1848_tmr_start
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|usecs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|xtal_nsecs
suffix:semicolon
multiline_comment|/* nanoseconds per xtal oscillator tick */
r_int
r_int
id|divider
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Length of the timer interval (in nanoseconds) depends on the&n;&t; * selected crystal oscillator. Check this from bit 0x01 of I8.&n;&t; *&n;&t; * AD1845 has just one oscillator which has cycle time of 10.050 us&n;&t; * (when a 24.576 MHz xtal oscillator is used).&n;&t; *&n;&t; * Convert requested interval to nanoseconds before computing&n;&t; * the timer divider.&n;&t; */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845
op_logical_or
id|devc-&gt;model
op_eq
id|MD_1845_SSCAPE
)paren
id|xtal_nsecs
op_assign
l_int|10050
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|8
)paren
op_amp
l_int|0x01
)paren
id|xtal_nsecs
op_assign
l_int|9920
suffix:semicolon
r_else
id|xtal_nsecs
op_assign
l_int|9969
suffix:semicolon
id|divider
op_assign
(paren
id|usecs
op_star
l_int|1000
op_plus
id|xtal_nsecs
op_div
l_int|2
)paren
op_div
id|xtal_nsecs
suffix:semicolon
r_if
c_cond
(paren
id|divider
OL
l_int|100
)paren
multiline_comment|/* Don&squot;t allow shorter intervals than about 1ms */
id|divider
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|divider
OG
l_int|65535
)paren
multiline_comment|/* Overflow check */
id|divider
op_assign
l_int|65535
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|21
comma
(paren
id|divider
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Set upper bits */
id|ad_write
c_func
(paren
id|devc
comma
l_int|20
comma
id|divider
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Set lower bits */
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|16
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Start the timer */
id|devc-&gt;timer_running
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|current_interval
op_assign
(paren
id|divider
op_star
id|xtal_nsecs
op_plus
l_int|500
)paren
op_div
l_int|1000
suffix:semicolon
)brace
DECL|function|ad1848_tmr_reprogram
r_static
r_void
id|ad1848_tmr_reprogram
c_func
(paren
r_int
id|dev
)paren
(brace
multiline_comment|/*&n;&t; *    Audio driver has changed sampling rate so that a different xtal&n;&t; *      oscillator was selected. We have to reprogram the timer rate.&n;&t; */
id|ad1848_tmr_start
c_func
(paren
id|dev
comma
id|current_interval
)paren
suffix:semicolon
id|sound_timer_syncinterval
c_func
(paren
id|current_interval
)paren
suffix:semicolon
)brace
DECL|function|ad1848_tmr_disable
r_static
r_void
id|ad1848_tmr_disable
c_func
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|16
)paren
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
id|devc-&gt;timer_running
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1848_tmr_restart
r_static
r_void
id|ad1848_tmr_restart
c_func
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|current_interval
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|16
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
id|devc-&gt;timer_running
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|ad1848_tmr
r_static
r_struct
id|sound_lowlev_timer
id|ad1848_tmr
op_assign
(brace
l_int|0
comma
l_int|2
comma
id|ad1848_tmr_start
comma
id|ad1848_tmr_disable
comma
id|ad1848_tmr_restart
)brace
suffix:semicolon
DECL|function|ad1848_tmr_install
r_static
r_int
id|ad1848_tmr_install
c_func
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|timer_installed
op_ne
op_minus
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Don&squot;t install another timer */
id|timer_installed
op_assign
id|ad1848_tmr.dev
op_assign
id|dev
suffix:semicolon
id|sound_timer_init
c_func
(paren
op_amp
id|ad1848_tmr
comma
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* EXCLUDE_TIMERS */
DECL|function|ad1848_suspend
r_static
r_int
id|ad1848_suspend
c_func
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ad_mute
c_func
(paren
id|devc
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1848_resume
r_static
r_int
id|ad1848_resume
c_func
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|mixer_levels
(braket
l_int|32
)braket
comma
id|i
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* store old mixer levels */
id|memcpy
c_func
(paren
id|mixer_levels
comma
id|devc-&gt;levels
comma
r_sizeof
(paren
id|mixer_levels
)paren
)paren
suffix:semicolon
id|ad1848_init_hw
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* restore mixer levels */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|ad1848_mixer_set
c_func
(paren
id|devc
comma
id|devc-&gt;dev_no
comma
id|mixer_levels
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|devc-&gt;subtype
)paren
(brace
r_static
r_int
r_char
id|interrupt_bits
(braket
l_int|12
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x00
comma
op_minus
l_int|1
comma
l_int|0x08
comma
op_minus
l_int|1
comma
l_int|0x10
comma
l_int|0x18
comma
l_int|0x20
)brace
suffix:semicolon
r_static
r_char
id|dma_bits
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|0
comma
l_int|3
)brace
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
r_char
id|dma2_bit
op_assign
l_int|0
suffix:semicolon
r_int
id|config_port
op_assign
id|devc-&gt;base
op_plus
l_int|0
suffix:semicolon
id|bits
op_assign
id|interrupt_bits
(braket
id|devc-&gt;irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: Bad IRQ %d&bslash;n&quot;
comma
id|devc-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
id|bits
op_or
l_int|0x40
)paren
comma
id|config_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;dma2
op_ne
op_minus
l_int|1
op_logical_and
id|devc-&gt;dma2
op_ne
id|devc-&gt;dma1
)paren
r_if
c_cond
(paren
(paren
id|devc-&gt;dma1
op_eq
l_int|0
op_logical_and
id|devc-&gt;dma2
op_eq
l_int|1
)paren
op_logical_or
(paren
id|devc-&gt;dma1
op_eq
l_int|1
op_logical_and
id|devc-&gt;dma2
op_eq
l_int|0
)paren
op_logical_or
(paren
id|devc-&gt;dma1
op_eq
l_int|3
op_logical_and
id|devc-&gt;dma2
op_eq
l_int|0
)paren
)paren
id|dma2_bit
op_assign
l_int|0x04
suffix:semicolon
id|outb
c_func
(paren
(paren
id|bits
op_or
id|dma_bits
(braket
id|devc-&gt;dma1
)braket
op_or
id|dma2_bit
)paren
comma
id|config_port
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1848_pm_callback
r_static
r_int
id|ad1848_pm_callback
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
id|dev-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|devc
)paren
(brace
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1848: pm event received: 0x%x&bslash;n&quot;
comma
id|rqst
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rqst
)paren
(brace
r_case
id|PM_SUSPEND
suffix:colon
id|ad1848_suspend
c_func
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PM_RESUME
suffix:colon
id|ad1848_resume
c_func
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ad1848_detect
id|EXPORT_SYMBOL
c_func
(paren
id|ad1848_detect
)paren
suffix:semicolon
DECL|variable|ad1848_init
id|EXPORT_SYMBOL
c_func
(paren
id|ad1848_init
)paren
suffix:semicolon
DECL|variable|ad1848_unload
id|EXPORT_SYMBOL
c_func
(paren
id|ad1848_unload
)paren
suffix:semicolon
DECL|variable|ad1848_control
id|EXPORT_SYMBOL
c_func
(paren
id|ad1848_control
)paren
suffix:semicolon
DECL|variable|adintr
id|EXPORT_SYMBOL
c_func
(paren
id|adintr
)paren
suffix:semicolon
DECL|variable|probe_ms_sound
id|EXPORT_SYMBOL
c_func
(paren
id|probe_ms_sound
)paren
suffix:semicolon
DECL|variable|attach_ms_sound
id|EXPORT_SYMBOL
c_func
(paren
id|attach_ms_sound
)paren
suffix:semicolon
DECL|variable|unload_ms_sound
id|EXPORT_SYMBOL
c_func
(paren
id|unload_ms_sound
)paren
suffix:semicolon
DECL|variable|io
r_static
r_int
id|__initdata
id|io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|__initdata
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma
r_static
r_int
id|__initdata
id|dma
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma2
r_static
r_int
id|__initdata
id|dma2
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|type
r_static
r_int
id|__initdata
id|type
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* I/O for a raw AD1848 card */
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* IRQ to use */
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* First DMA channel */
id|MODULE_PARM
c_func
(paren
id|dma2
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* Second DMA channel */
id|MODULE_PARM
c_func
(paren
id|type
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* Card type */
id|MODULE_PARM
c_func
(paren
id|deskpro_xl
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* Special magic for Deskpro XL boxen&n;*/
id|MODULE_PARM
c_func
(paren
id|deskpro_m
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* Special magic for Deskpro M box */
id|MODULE_PARM
c_func
(paren
id|soundpro
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* More special magic for SoundPro&n;chips */
DECL|function|init_ad1848
r_static
r_int
id|__init
id|init_ad1848
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ad1848/cs4248 codec driver Copyright (C) by Hannu Savolainen 1993-1996&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|irq
op_eq
op_minus
l_int|1
op_logical_or
id|dma
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ad1848: must give I/O , IRQ and DMA.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|cfg.irq
op_assign
id|irq
suffix:semicolon
id|cfg.io_base
op_assign
id|io
suffix:semicolon
id|cfg.dma
op_assign
id|dma
suffix:semicolon
id|cfg.dma2
op_assign
id|dma2
suffix:semicolon
id|cfg.card_subtype
op_assign
id|type
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|probe_ms_sound
c_func
(paren
op_amp
id|cfg
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|attach_ms_sound
c_func
(paren
op_amp
id|cfg
comma
id|THIS_MODULE
)paren
suffix:semicolon
id|loaded
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_ad1848
r_static
r_void
id|__exit
id|cleanup_ad1848
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|loaded
)paren
(brace
id|unload_ms_sound
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
)brace
)brace
DECL|variable|init_ad1848
id|module_init
c_func
(paren
id|init_ad1848
)paren
suffix:semicolon
DECL|variable|cleanup_ad1848
id|module_exit
c_func
(paren
id|cleanup_ad1848
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|setup_ad1848
r_static
r_int
id|__init
id|setup_ad1848
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/* io, irq, dma, dma2, type */
r_int
id|ints
(braket
l_int|6
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|io
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|irq
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|dma
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|dma2
op_assign
id|ints
(braket
l_int|4
)braket
suffix:semicolon
id|type
op_assign
id|ints
(braket
l_int|5
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;ad1848=&quot;
comma
id|setup_ad1848
)paren
suffix:semicolon
macro_line|#endif
eof
