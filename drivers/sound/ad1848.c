multiline_comment|/*&n; * sound/ad1848.c&n; *&n; * The low level driver for the AD1848/CS4248 codec chip which&n; * is used for example in the MS Sound System.&n; *&n; * The CS4231 which is used in the GUS MAX and some other cards is&n; * upwards compatible with AD1848 and this driver is able to drive it.&n; *&n; * CS4231A and AD1845 are upward compatible with CS4231. However&n; * the new features of these chips are different.&n; *&n; * CS4232 is a PnP audio chip which contains a CS4231A (and SB, MPU).&n; * CS4232A is an improved version of CS4232.&n; */
multiline_comment|/*&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; */
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|DEB
mdefine_line|#define DEB(x)
DECL|macro|DEB1
mdefine_line|#define DEB1(x)
macro_line|#include &quot;sound_config.h&quot;
macro_line|#ifdef CONFIG_AD1848
macro_line|#include &quot;ad1848_mixer.h&quot;
r_typedef
r_struct
(brace
DECL|member|base
r_int
id|base
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|dma1
DECL|member|dma2
r_int
id|dma1
comma
id|dma2
suffix:semicolon
DECL|member|dual_dma
r_int
id|dual_dma
suffix:semicolon
multiline_comment|/* 1, when two DMA channels allocated */
DECL|member|MCE_bit
r_int
r_char
id|MCE_bit
suffix:semicolon
DECL|member|saved_regs
r_int
r_char
id|saved_regs
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|debug_flag
r_int
id|debug_flag
suffix:semicolon
DECL|member|audio_flags
r_int
id|audio_flags
suffix:semicolon
DECL|member|record_dev
DECL|member|playback_dev
r_int
id|record_dev
comma
id|playback_dev
suffix:semicolon
DECL|member|xfer_count
r_int
id|xfer_count
suffix:semicolon
DECL|member|audio_mode
r_int
id|audio_mode
suffix:semicolon
DECL|member|open_mode
r_int
id|open_mode
suffix:semicolon
DECL|member|intr_active
r_int
id|intr_active
suffix:semicolon
DECL|member|chip_name
DECL|member|name
r_char
op_star
id|chip_name
comma
op_star
id|name
suffix:semicolon
DECL|member|model
r_int
id|model
suffix:semicolon
DECL|macro|MD_1848
mdefine_line|#define MD_1848&t;&t;1
DECL|macro|MD_4231
mdefine_line|#define MD_4231&t;&t;2
DECL|macro|MD_4231A
mdefine_line|#define MD_4231A&t;3
DECL|macro|MD_1845
mdefine_line|#define MD_1845&t;&t;4
DECL|macro|MD_4232
mdefine_line|#define MD_4232&t;&t;5
DECL|macro|MD_C930
mdefine_line|#define MD_C930&t;&t;6
DECL|macro|MD_IWAVE
mdefine_line|#define MD_IWAVE&t;7
multiline_comment|/* Mixer parameters */
DECL|member|recmask
r_int
id|recmask
suffix:semicolon
DECL|member|supported_devices
DECL|member|orig_devices
r_int
id|supported_devices
comma
id|orig_devices
suffix:semicolon
DECL|member|supported_rec_devices
DECL|member|orig_rec_devices
r_int
id|supported_rec_devices
comma
id|orig_rec_devices
suffix:semicolon
DECL|member|levels
r_int
op_star
id|levels
suffix:semicolon
DECL|member|mixer_reroute
r_int
id|mixer_reroute
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|dev_no
r_int
id|dev_no
suffix:semicolon
DECL|member|timer_ticks
r_volatile
r_int
r_int
id|timer_ticks
suffix:semicolon
DECL|member|timer_running
r_int
id|timer_running
suffix:semicolon
DECL|member|irq_ok
r_int
id|irq_ok
suffix:semicolon
DECL|member|mix_devices
id|mixer_ents
op_star
id|mix_devices
suffix:semicolon
DECL|member|mixer_output_port
r_int
id|mixer_output_port
suffix:semicolon
DECL|member|c930_password_port
r_int
id|c930_password_port
suffix:semicolon
)brace
DECL|typedef|ad1848_info
id|ad1848_info
suffix:semicolon
DECL|struct|ad1848_port_info
r_typedef
r_struct
id|ad1848_port_info
(brace
DECL|member|open_mode
r_int
id|open_mode
suffix:semicolon
DECL|member|speed
r_int
id|speed
suffix:semicolon
DECL|member|speed_bits
r_int
r_char
id|speed_bits
suffix:semicolon
DECL|member|channels
r_int
id|channels
suffix:semicolon
DECL|member|audio_format
r_int
id|audio_format
suffix:semicolon
DECL|member|format_bits
r_int
r_char
id|format_bits
suffix:semicolon
)brace
DECL|typedef|ad1848_port_info
id|ad1848_port_info
suffix:semicolon
DECL|variable|nr_ad1848_devs
r_static
r_int
id|nr_ad1848_devs
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq2dev
r_static
r_volatile
r_char
id|irq2dev
(braket
l_int|17
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
macro_line|#if defined(CONFIG_SEQUENCER) &amp;&amp; !defined(EXCLUDE_TIMERS)
DECL|variable|timer_installed
r_static
r_int
id|timer_installed
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
DECL|variable|ad_format_mask
r_static
r_int
id|ad_format_mask
(braket
l_int|8
multiline_comment|/*devc-&gt;model */
)braket
op_assign
(brace
l_int|0
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
comma
multiline_comment|/* AD1845 */
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_S16_BE
op_or
id|AFMT_IMA_ADPCM
)brace
suffix:semicolon
DECL|variable|adev_info
r_static
id|ad1848_info
id|adev_info
(braket
id|MAX_AUDIO_DEV
)braket
suffix:semicolon
DECL|macro|io_Index_Addr
mdefine_line|#define io_Index_Addr(d)&t;((d)-&gt;base)
DECL|macro|io_Indexed_Data
mdefine_line|#define io_Indexed_Data(d)&t;((d)-&gt;base+1)
DECL|macro|io_Status
mdefine_line|#define io_Status(d)&t;&t;((d)-&gt;base+2)
DECL|macro|io_Polled_IO
mdefine_line|#define io_Polled_IO(d)&t;&t;((d)-&gt;base+3)
r_static
r_int
id|ad1848_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|ad1848_close
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ad1848_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
suffix:semicolon
r_static
r_void
id|ad1848_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
suffix:semicolon
r_static
r_void
id|ad1848_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
suffix:semicolon
r_static
r_int
id|ad1848_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
suffix:semicolon
r_static
r_int
id|ad1848_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
suffix:semicolon
r_static
r_void
id|ad1848_halt
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_halt_input
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_halt_output
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_trigger
(paren
r_int
id|dev
comma
r_int
id|bits
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_SEQUENCER) &amp;&amp; !defined(EXCLUDE_TIMERS)
r_static
r_int
id|ad1848_tmr_install
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_tmr_reprogram
(paren
r_int
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
DECL|function|ad_read
id|ad_read
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|x
suffix:semicolon
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|outb
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_or
id|devc-&gt;MCE_bit
)paren
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
id|x
op_assign
id|inb
(paren
id|io_Indexed_Data
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;(%02x&lt;-%02x) &quot;, reg|devc-&gt;MCE_bit, x); */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad_write
id|ad_write
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|outb
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_or
id|devc-&gt;MCE_bit
)paren
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|data
op_amp
l_int|0xff
)paren
)paren
comma
id|io_Indexed_Data
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;(%02x-&gt;%02x) &quot;, reg|devc-&gt;MCE_bit, data); */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|wait_for_calibration
id|wait_for_calibration
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;     * Wait until the auto calibration process has finished.&n;     *&n;     * 1)       Wait until the chip becomes ready (reads don&squot;t return 0x80).&n;     * 2)       Wait until the ACI bit of I11 gets on and then off.&n;   */
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|inb
(paren
id|devc-&gt;base
)paren
op_amp
l_int|0x80
)paren
id|printk
(paren
l_string|&quot;ad1848: Auto calibration timed out(1).&bslash;n&quot;
)paren
suffix:semicolon
id|timeout
op_assign
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
op_logical_neg
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
)paren
r_return
suffix:semicolon
id|timeout
op_assign
l_int|80000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1845
)paren
id|printk
(paren
l_string|&quot;ad1848: Auto calibration timed out(3).&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad_mute
id|ad_mute
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
id|prev
suffix:semicolon
multiline_comment|/*&n;     * Save old register settings and mute output channels&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|6
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|prev
op_assign
id|devc-&gt;saved_regs
(braket
id|i
)braket
op_assign
id|ad_read
(paren
id|devc
comma
id|i
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ad_unmute
id|ad_unmute
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
)brace
r_static
r_void
DECL|function|ad_enter_MCE
id|ad_enter_MCE
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_int
r_int
id|prev
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|devc-&gt;MCE_bit
op_assign
l_int|0x40
suffix:semicolon
id|prev
op_assign
id|inb
(paren
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_amp
l_int|0x40
)paren
(brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb
(paren
(paren
id|devc-&gt;MCE_bit
)paren
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad_leave_MCE
id|ad_leave_MCE
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|prev
comma
id|acal
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|acal
op_assign
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
suffix:semicolon
id|devc-&gt;MCE_bit
op_assign
l_int|0x00
suffix:semicolon
id|prev
op_assign
id|inb
(paren
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
l_int|0x00
)paren
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear the MCE bit */
r_if
c_cond
(paren
(paren
id|prev
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Not in MCE mode */
(brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb
(paren
(paren
l_int|0x00
)paren
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear the MCE bit */
r_if
c_cond
(paren
id|acal
op_amp
l_int|0x08
)paren
multiline_comment|/* Auto calibration is enabled */
id|wait_for_calibration
(paren
id|devc
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_set_recmask
id|ad1848_set_recmask
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|mask
)paren
(brace
r_int
r_char
id|recdev
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
id|mask
op_and_assign
id|devc-&gt;supported_rec_devices
suffix:semicolon
multiline_comment|/* Rename the mixer bits if necessary */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
op_ne
id|i
)paren
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|n
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Count selected device bits */
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
r_else
r_if
c_cond
(paren
id|n
op_ne
l_int|1
)paren
multiline_comment|/* Too many devices selected */
(brace
id|mask
op_and_assign
op_complement
id|devc-&gt;recmask
suffix:semicolon
multiline_comment|/* Filter out active settings */
id|n
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Count selected device bits */
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
l_int|1
)paren
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mask
)paren
(brace
r_case
id|SOUND_MASK_MIC
suffix:colon
id|recdev
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_LINE
suffix:colon
r_case
id|SOUND_MASK_LINE3
suffix:colon
id|recdev
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_CD
suffix:colon
r_case
id|SOUND_MASK_LINE1
suffix:colon
id|recdev
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_IMIX
suffix:colon
id|recdev
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
id|recdev
op_assign
l_int|2
suffix:semicolon
)brace
id|recdev
op_lshift_assign
l_int|6
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|0
comma
(paren
id|ad_read
(paren
id|devc
comma
l_int|0
)paren
op_amp
l_int|0x3f
)paren
op_or
id|recdev
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|1
comma
(paren
id|ad_read
(paren
id|devc
comma
l_int|1
)paren
op_amp
l_int|0x3f
)paren
op_or
id|recdev
)paren
suffix:semicolon
multiline_comment|/* Rename the mixer bits back if necessary */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
op_ne
id|i
)paren
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
)paren
)paren
(brace
id|mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
)paren
suffix:semicolon
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
id|devc-&gt;recmask
op_assign
id|mask
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
r_static
r_void
DECL|function|change_bits
id|change_bits
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
r_char
op_star
id|regval
comma
r_int
id|dev
comma
r_int
id|chn
comma
r_int
id|newval
)paren
(brace
r_int
r_char
id|mask
suffix:semicolon
r_int
id|shift
suffix:semicolon
r_int
id|mute
suffix:semicolon
r_int
id|mutemask
suffix:semicolon
r_int
id|set_mute_bit
suffix:semicolon
id|set_mute_bit
op_assign
(paren
id|newval
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|polarity
op_eq
l_int|1
)paren
multiline_comment|/* Reverse */
id|newval
op_assign
l_int|100
op_minus
id|newval
suffix:semicolon
id|mask
op_assign
(paren
l_int|1
op_lshift
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|nbits
)paren
op_minus
l_int|1
suffix:semicolon
id|shift
op_assign
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|bitpos
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|mutepos
op_eq
l_int|8
)paren
(brace
multiline_comment|/* if there is no mute bit */
id|mute
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No mute bit; do nothing special */
id|mutemask
op_assign
op_complement
l_int|0
suffix:semicolon
multiline_comment|/* No mute bit; do nothing special */
)brace
r_else
(brace
id|mute
op_assign
(paren
id|set_mute_bit
op_lshift
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|mutepos
)paren
suffix:semicolon
id|mutemask
op_assign
op_complement
(paren
l_int|1
op_lshift
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|mutepos
)paren
suffix:semicolon
)brace
id|newval
op_assign
(paren
r_int
)paren
(paren
(paren
id|newval
op_star
id|mask
)paren
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
multiline_comment|/* Scale it */
op_star
id|regval
op_and_assign
(paren
op_complement
(paren
id|mask
op_lshift
id|shift
)paren
)paren
op_amp
(paren
id|mutemask
)paren
suffix:semicolon
multiline_comment|/* Clear bits */
op_star
id|regval
op_or_assign
(paren
(paren
id|newval
op_amp
id|mask
)paren
op_lshift
id|shift
)paren
op_or
id|mute
suffix:semicolon
multiline_comment|/* Set new value */
)brace
r_static
r_int
DECL|function|ad1848_mixer_get
id|ad1848_mixer_get
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|1
op_lshift
id|dev
)paren
op_amp
id|devc-&gt;supported_devices
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|devc-&gt;mixer_reroute
(braket
id|dev
)braket
suffix:semicolon
r_return
id|devc-&gt;levels
(braket
id|dev
)braket
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_mixer_set
id|ad1848_mixer_set
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|dev
comma
r_int
id|value
)paren
(brace
r_int
id|left
op_assign
id|value
op_amp
l_int|0x000000ff
suffix:semicolon
r_int
id|right
op_assign
(paren
id|value
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
r_int
id|retvol
suffix:semicolon
r_int
id|regoffs
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
l_int|31
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|devc-&gt;mixer_reroute
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
id|right
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
multiline_comment|/* Mono control */
id|right
op_assign
id|left
suffix:semicolon
id|retvol
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Scale volumes */
id|left
op_assign
id|mix_cvt
(braket
id|left
)braket
suffix:semicolon
id|right
op_assign
id|mix_cvt
(braket
id|right
)braket
suffix:semicolon
multiline_comment|/* Scale it again */
id|left
op_assign
id|mix_cvt
(braket
id|left
)braket
suffix:semicolon
id|right
op_assign
id|mix_cvt
(braket
id|right
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|LEFT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|devc-&gt;levels
(braket
id|dev
)braket
op_assign
id|retvol
suffix:semicolon
multiline_comment|/*&n;     * Set the left channel&n;   */
id|regoffs
op_assign
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|LEFT_CHN
)braket
dot
id|regno
suffix:semicolon
id|val
op_assign
id|ad_read
(paren
id|devc
comma
id|regoffs
)paren
suffix:semicolon
id|change_bits
(paren
id|devc
comma
op_amp
id|val
comma
id|dev
comma
id|LEFT_CHN
comma
id|left
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
id|regoffs
comma
id|val
)paren
suffix:semicolon
id|devc-&gt;saved_regs
(braket
id|regoffs
)braket
op_assign
id|val
suffix:semicolon
multiline_comment|/*&n;     * Set the right channel&n;   */
r_if
c_cond
(paren
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
r_return
id|retvol
suffix:semicolon
multiline_comment|/* Was just a mono channel */
id|regoffs
op_assign
id|devc-&gt;mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|regno
suffix:semicolon
id|val
op_assign
id|ad_read
(paren
id|devc
comma
id|regoffs
)paren
suffix:semicolon
id|change_bits
(paren
id|devc
comma
op_amp
id|val
comma
id|dev
comma
id|RIGHT_CHN
comma
id|right
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
id|regoffs
comma
id|val
)paren
suffix:semicolon
id|devc-&gt;saved_regs
(braket
id|regoffs
)braket
op_assign
id|val
suffix:semicolon
r_return
id|retvol
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_mixer_reset
id|ad1848_mixer_reset
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
id|devc-&gt;mix_devices
op_assign
op_amp
(paren
id|ad1848_mix_devices
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sprintf
(paren
id|name
comma
l_string|&quot;%s_%d&quot;
comma
id|devc-&gt;chip_name
comma
id|nr_ad1848_devs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|devc-&gt;mixer_reroute
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|devc-&gt;model
)paren
(brace
r_case
id|MD_4231
suffix:colon
r_case
id|MD_4231A
suffix:colon
r_case
id|MD_1845
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE2_MIXER_DEVICES
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MD_C930
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|C930_MIXER_DEVICES
suffix:semicolon
id|devc-&gt;mix_devices
op_assign
op_amp
(paren
id|c930_mix_devices
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MD_IWAVE
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE3_MIXER_DEVICES
suffix:semicolon
id|devc-&gt;mix_devices
op_assign
op_amp
(paren
id|iwave_mix_devices
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MD_4232
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE3_MIXER_DEVICES
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE1_MIXER_DEVICES
suffix:semicolon
)brace
id|devc-&gt;supported_rec_devices
op_assign
id|MODE1_REC_DEVICES
suffix:semicolon
id|devc-&gt;orig_devices
op_assign
id|devc-&gt;supported_devices
suffix:semicolon
id|devc-&gt;orig_rec_devices
op_assign
id|devc-&gt;supported_rec_devices
suffix:semicolon
id|devc-&gt;levels
op_assign
id|load_mixer_volumes
(paren
id|name
comma
id|default_mixer_levels
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|ad1848_mixer_set
(paren
id|devc
comma
id|i
comma
id|devc-&gt;levels
(braket
id|i
)braket
)paren
suffix:semicolon
id|ad1848_set_recmask
(paren
id|devc
comma
id|SOUND_MASK_MIC
)paren
suffix:semicolon
id|devc-&gt;mixer_output_port
op_assign
id|devc-&gt;levels
(braket
l_int|31
)braket
op_or
id|AUDIO_HEADPHONE
op_or
id|AUDIO_LINE_OUT
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mixer_output_port
op_amp
id|AUDIO_SPEAKER
)paren
id|ad_write
(paren
id|devc
comma
l_int|26
comma
id|ad_read
(paren
id|devc
comma
l_int|26
)paren
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Unmute mono out */
r_else
id|ad_write
(paren
id|devc
comma
l_int|26
comma
id|ad_read
(paren
id|devc
comma
l_int|26
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mute mono out */
)brace
r_static
r_int
DECL|function|ad1848_mixer_ioctl
id|ad1848_mixer_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
id|mixer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_PRIVATE1
)paren
(brace
r_int
id|val
suffix:semicolon
id|val
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
l_int|0xffff
)paren
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|devc-&gt;mixer_output_port
)paren
suffix:semicolon
id|val
op_and_assign
(paren
id|AUDIO_SPEAKER
op_or
id|AUDIO_HEADPHONE
op_or
id|AUDIO_LINE_OUT
)paren
suffix:semicolon
id|devc-&gt;mixer_output_port
op_assign
id|val
suffix:semicolon
id|val
op_or_assign
id|AUDIO_HEADPHONE
op_or
id|AUDIO_LINE_OUT
suffix:semicolon
multiline_comment|/* Always on */
id|devc-&gt;mixer_output_port
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|AUDIO_SPEAKER
)paren
id|ad_write
(paren
id|devc
comma
l_int|26
comma
id|ad_read
(paren
id|devc
comma
l_int|26
)paren
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Unmute mono out */
r_else
id|ad_write
(paren
id|devc
comma
l_int|26
comma
id|ad_read
(paren
id|devc
comma
l_int|26
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mute mono out */
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|devc-&gt;mixer_output_port
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|cmd
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_eq
l_char|&squot;M&squot;
)paren
(brace
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|_SIOC_DIR
(paren
id|cmd
)paren
op_amp
id|_SIOC_WRITE
)paren
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
id|val
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ad1848_set_recmask
(paren
id|devc
comma
id|val
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|val
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ad1848_mixer_set
(paren
id|devc
comma
id|cmd
op_amp
l_int|0xff
comma
id|val
)paren
)paren
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * Return parameters&n;&t;&t;&t;&t; */
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|devc-&gt;recmask
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|devc-&gt;supported_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_C930
)paren
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|devc-&gt;supported_devices
)paren
suffix:semicolon
r_else
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|devc-&gt;supported_devices
op_amp
op_complement
(paren
id|SOUND_MASK_SPEAKER
op_or
id|SOUND_MASK_IMIX
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|devc-&gt;supported_rec_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|SOUND_CAP_EXCL_INPUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ad1848_mixer_get
(paren
id|devc
comma
id|cmd
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_set_speed
id|ad1848_set_speed
(paren
r_int
id|dev
comma
r_int
id|arg
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
multiline_comment|/*&n;     * The sampling speed is encoded in the least significant nibble of I8. The&n;     * LSB selects the clock source (0=24.576 MHz, 1=16.9344 MHz) and other&n;     * three bits select the divisor (indirectly):&n;     *&n;     * The available speeds are in the following table. Keep the speeds in&n;     * the increasing order.&n;   */
r_typedef
r_struct
(brace
r_int
id|speed
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
)brace
id|speed_struct
suffix:semicolon
r_static
id|speed_struct
id|speed_table
(braket
)braket
op_assign
(brace
(brace
l_int|5510
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|5510
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|6620
comma
(paren
l_int|7
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|8000
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|9600
comma
(paren
l_int|7
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|11025
comma
(paren
l_int|1
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|16000
comma
(paren
l_int|1
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|18900
comma
(paren
l_int|2
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|22050
comma
(paren
l_int|3
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|27420
comma
(paren
l_int|2
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|32000
comma
(paren
l_int|3
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|33075
comma
(paren
l_int|6
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|37800
comma
(paren
l_int|4
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|44100
comma
(paren
l_int|5
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|48000
comma
(paren
l_int|6
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|n
comma
id|selected
op_assign
op_minus
l_int|1
suffix:semicolon
id|n
op_assign
r_sizeof
(paren
id|speed_table
)paren
op_div
r_sizeof
(paren
id|speed_struct
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_le
l_int|0
)paren
r_return
id|portc-&gt;speed
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845
)paren
multiline_comment|/* AD1845 has different timer than others */
(brace
r_if
c_cond
(paren
id|arg
OL
l_int|4000
)paren
id|arg
op_assign
l_int|4000
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|50000
)paren
id|arg
op_assign
l_int|50000
suffix:semicolon
id|portc-&gt;speed
op_assign
id|arg
suffix:semicolon
id|portc-&gt;speed_bits
op_assign
id|speed_table
(braket
l_int|3
)braket
dot
id|bits
suffix:semicolon
r_return
id|portc-&gt;speed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
OL
id|speed_table
(braket
l_int|0
)braket
dot
id|speed
)paren
id|selected
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
id|speed_table
(braket
id|n
op_minus
l_int|1
)braket
dot
id|speed
)paren
id|selected
op_assign
id|n
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
multiline_comment|/*really */
suffix:semicolon
id|selected
op_eq
op_minus
l_int|1
op_logical_and
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|speed_table
(braket
id|i
)braket
dot
id|speed
op_eq
id|arg
)paren
id|selected
op_assign
id|i
suffix:semicolon
r_else
r_if
c_cond
(paren
id|speed_table
(braket
id|i
)braket
dot
id|speed
OG
id|arg
)paren
(brace
r_int
id|diff1
comma
id|diff2
suffix:semicolon
id|diff1
op_assign
id|arg
op_minus
id|speed_table
(braket
id|i
op_minus
l_int|1
)braket
dot
id|speed
suffix:semicolon
id|diff2
op_assign
id|speed_table
(braket
id|i
)braket
dot
id|speed
op_minus
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|diff1
OL
id|diff2
)paren
id|selected
op_assign
id|i
op_minus
l_int|1
suffix:semicolon
r_else
id|selected
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|selected
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;ad1848: Can&squot;t find speed???&bslash;n&quot;
)paren
suffix:semicolon
id|selected
op_assign
l_int|3
suffix:semicolon
)brace
id|portc-&gt;speed
op_assign
id|speed_table
(braket
id|selected
)braket
dot
id|speed
suffix:semicolon
id|portc-&gt;speed_bits
op_assign
id|speed_table
(braket
id|selected
)braket
dot
id|bits
suffix:semicolon
r_return
id|portc-&gt;speed
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_set_channels
id|ad1848_set_channels
(paren
r_int
id|dev
comma
r_int
id|arg
)paren
(brace
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_ne
l_int|1
op_logical_and
id|arg
op_ne
l_int|2
)paren
r_return
id|portc-&gt;channels
suffix:semicolon
id|portc-&gt;channels
op_assign
id|arg
suffix:semicolon
r_return
id|arg
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|ad1848_set_bits
id|ad1848_set_bits
(paren
r_int
id|dev
comma
r_int
r_int
id|arg
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_static
r_struct
id|format_tbl
(brace
r_int
id|format
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
)brace
id|format2bits
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
id|AFMT_MU_LAW
comma
l_int|1
)brace
comma
(brace
id|AFMT_A_LAW
comma
l_int|3
)brace
comma
(brace
id|AFMT_IMA_ADPCM
comma
l_int|5
)brace
comma
(brace
id|AFMT_U8
comma
l_int|0
)brace
comma
(brace
id|AFMT_S16_LE
comma
l_int|2
)brace
comma
(brace
id|AFMT_S16_BE
comma
l_int|6
)brace
comma
(brace
id|AFMT_S8
comma
l_int|0
)brace
comma
(brace
id|AFMT_U16_LE
comma
l_int|0
)brace
comma
(brace
id|AFMT_U16_BE
comma
l_int|0
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|n
op_assign
r_sizeof
(paren
id|format2bits
)paren
op_div
r_sizeof
(paren
r_struct
id|format_tbl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_eq
l_int|0
)paren
r_return
id|portc-&gt;audio_format
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|arg
op_amp
id|ad_format_mask
(braket
id|devc-&gt;model
)braket
)paren
)paren
id|arg
op_assign
id|AFMT_U8
suffix:semicolon
id|portc-&gt;audio_format
op_assign
id|arg
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|format2bits
(braket
id|i
)braket
dot
id|format
op_eq
id|arg
)paren
(brace
r_if
c_cond
(paren
(paren
id|portc-&gt;format_bits
op_assign
id|format2bits
(braket
id|i
)braket
dot
id|bits
)paren
op_eq
l_int|0
)paren
r_return
id|portc-&gt;audio_format
op_assign
id|AFMT_U8
suffix:semicolon
multiline_comment|/* Was not supported */
r_return
id|arg
suffix:semicolon
)brace
multiline_comment|/* Still hanging here. Something must be terribly wrong */
id|portc-&gt;format_bits
op_assign
l_int|0
suffix:semicolon
r_return
id|portc-&gt;audio_format
op_assign
id|AFMT_U8
suffix:semicolon
)brace
DECL|variable|ad1848_audio_driver
r_static
r_struct
id|audio_driver
id|ad1848_audio_driver
op_assign
(brace
id|ad1848_open
comma
id|ad1848_close
comma
id|ad1848_output_block
comma
id|ad1848_start_input
comma
id|ad1848_ioctl
comma
id|ad1848_prepare_for_input
comma
id|ad1848_prepare_for_output
comma
id|ad1848_halt
comma
l_int|NULL
comma
l_int|NULL
comma
id|ad1848_halt_input
comma
id|ad1848_halt_output
comma
id|ad1848_trigger
comma
id|ad1848_set_speed
comma
id|ad1848_set_bits
comma
id|ad1848_set_channels
)brace
suffix:semicolon
DECL|variable|ad1848_mixer_operations
r_static
r_struct
id|mixer_operations
id|ad1848_mixer_operations
op_assign
(brace
l_string|&quot;SOUNDPORT&quot;
comma
l_string|&quot;AD1848/CS4248/CS4231&quot;
comma
id|ad1848_mixer_ioctl
)brace
suffix:semicolon
r_static
r_int
DECL|function|ad1848_open
id|ad1848_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
l_int|NULL
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_audiodevs
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;open_mode
op_logical_or
(paren
id|devc-&gt;open_mode
op_amp
id|mode
)paren
)paren
(brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|devc-&gt;dual_dma
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DMA_DUPLEX
)paren
(brace
id|devc-&gt;dual_dma
op_assign
l_int|1
suffix:semicolon
)brace
id|devc-&gt;intr_active
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;open_mode
op_or_assign
id|mode
suffix:semicolon
id|portc-&gt;open_mode
op_assign
id|mode
suffix:semicolon
id|ad1848_trigger
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|OPEN_READ
)paren
id|devc-&gt;record_dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|OPEN_WRITE
)paren
id|devc-&gt;playback_dev
op_assign
id|dev
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n; * Mute output until the playback really starts. This decreases clicking (hope so).&n; */
id|ad_mute
(paren
id|devc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_close
id|ad1848_close
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;ad1848_close(void)&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|0
suffix:semicolon
id|ad1848_halt
(paren
id|dev
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;open_mode
op_and_assign
op_complement
id|portc-&gt;open_mode
suffix:semicolon
id|portc-&gt;open_mode
op_assign
l_int|0
suffix:semicolon
id|ad_unmute
(paren
id|devc
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_ioctl
id|ad1848_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_output_block
id|ad1848_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
(brace
r_int
r_int
id|flags
comma
id|cnt
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;audio_format
op_eq
id|AFMT_IMA_ADPCM
)paren
(brace
id|cnt
op_div_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|portc-&gt;audio_format
op_amp
(paren
id|AFMT_S16_LE
op_or
id|AFMT_S16_BE
)paren
)paren
multiline_comment|/* 16 bit data */
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|portc-&gt;channels
OG
l_int|1
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_OUTPUT
op_logical_and
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DMA_AUTOMODE
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|devc-&gt;xfer_count
)paren
(brace
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Auto DMA mode on. No need to react&n;&t;&t;&t;&t; */
)brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|15
comma
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|14
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
id|cnt
suffix:semicolon
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_start_input
id|ad1848_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
(brace
r_int
r_int
id|flags
comma
id|cnt
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;audio_format
op_eq
id|AFMT_IMA_ADPCM
)paren
(brace
id|cnt
op_div_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|portc-&gt;audio_format
op_amp
(paren
id|AFMT_S16_LE
op_or
id|AFMT_S16_BE
)paren
)paren
multiline_comment|/* 16 bit data */
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|portc-&gt;channels
OG
l_int|1
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_INPUT
op_logical_and
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DMA_AUTOMODE
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|devc-&gt;xfer_count
)paren
(brace
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Auto DMA mode on. No need to react&n;&t;&t;&t;&t; */
)brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1848
)paren
(brace
id|ad_write
(paren
id|devc
comma
l_int|15
comma
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|14
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ad_write
(paren
id|devc
comma
l_int|31
comma
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|30
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
id|ad_unmute
(paren
id|devc
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
id|cnt
suffix:semicolon
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_prepare_for_output
id|ad1848_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
r_char
id|fs
comma
id|old_fs
comma
id|tmp
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
id|ad_mute
(paren
id|devc
)paren
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|fs
op_assign
id|portc-&gt;speed_bits
op_or
(paren
id|portc-&gt;format_bits
op_lshift
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;channels
OG
l_int|1
)paren
id|fs
op_or_assign
l_int|0x10
suffix:semicolon
id|ad_enter_MCE
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Enables changes to the format select reg */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845
)paren
multiline_comment|/* Use alternate speed select registers */
(brace
id|fs
op_and_assign
l_int|0xf0
suffix:semicolon
multiline_comment|/* Mask off the rate select bits */
id|ad_write
(paren
id|devc
comma
l_int|22
comma
(paren
id|portc-&gt;speed
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed MSB */
id|ad_write
(paren
id|devc
comma
l_int|23
comma
id|portc-&gt;speed
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed LSB */
)brace
id|old_fs
op_assign
id|ad_read
(paren
id|devc
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_4232
)paren
(brace
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_or
l_int|0x30
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
id|ad_write
(paren
id|devc
comma
l_int|17
comma
l_int|0xc2
)paren
suffix:semicolon
multiline_comment|/* Disable variable frequency select */
id|ad_write
(paren
id|devc
comma
l_int|8
comma
id|fs
)paren
suffix:semicolon
multiline_comment|/*&n;   * Write to I8 starts resynchronization. Wait until it completes.&n;   */
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|100
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_ne
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|10000
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_4232
)paren
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_amp
op_complement
l_int|0x30
)paren
suffix:semicolon
id|ad_leave_MCE
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Starts the calibration process.&n;&t;&t;&t;&t; */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(CONFIG_SEQUENCER) &amp;&amp; !defined(EXCLUDE_TIMERS)
r_if
c_cond
(paren
id|dev
op_eq
id|timer_installed
op_logical_and
id|devc-&gt;timer_running
)paren
r_if
c_cond
(paren
(paren
id|fs
op_amp
l_int|0x01
)paren
op_ne
(paren
id|old_fs
op_amp
l_int|0x01
)paren
)paren
(brace
id|ad1848_tmr_reprogram
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ad1848_halt_output
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_prepare_for_input
id|ad1848_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
r_char
id|fs
comma
id|old_fs
comma
id|tmp
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;audio_mode
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|fs
op_assign
id|portc-&gt;speed_bits
op_or
(paren
id|portc-&gt;format_bits
op_lshift
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;channels
OG
l_int|1
)paren
id|fs
op_or_assign
l_int|0x10
suffix:semicolon
id|ad_enter_MCE
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Enables changes to the format select reg */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845
)paren
multiline_comment|/* Use alternate speed select registers */
(brace
id|fs
op_and_assign
l_int|0xf0
suffix:semicolon
multiline_comment|/* Mask off the rate select bits */
id|ad_write
(paren
id|devc
comma
l_int|22
comma
(paren
id|portc-&gt;speed
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed MSB */
id|ad_write
(paren
id|devc
comma
l_int|23
comma
id|portc-&gt;speed
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed LSB */
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_4232
)paren
(brace
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_or
l_int|0x30
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
id|ad_write
(paren
id|devc
comma
l_int|17
comma
l_int|0xc2
)paren
suffix:semicolon
multiline_comment|/* Disable variable frequency select */
multiline_comment|/*&n;   * If mode &gt;= 2 (CS4231), set I28. It&squot;s the capture format register.&n;   */
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
)paren
(brace
id|old_fs
op_assign
id|ad_read
(paren
id|devc
comma
l_int|28
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|28
comma
id|fs
)paren
suffix:semicolon
multiline_comment|/*&n;       * Write to I28 starts resynchronization. Wait until it completes.&n;       */
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|100
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_ne
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|10000
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
op_logical_and
id|devc-&gt;model
op_ne
id|MD_1845
)paren
(brace
multiline_comment|/*&n;&t;   * CS4231 compatible devices don&squot;t have separate sampling rate selection&n;&t;   * register for recording an playback. The I8 register is shared so we have to&n;&t;   * set the speed encoding bits of it too.&n;&t;   */
r_int
r_char
id|tmp
op_assign
id|portc-&gt;speed_bits
op_or
(paren
id|ad_read
(paren
id|devc
comma
l_int|8
)paren
op_amp
l_int|0xf0
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|8
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   * Write to I8 starts resynchronization. Wait until it completes.&n;&t;   */
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|100
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_ne
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|10000
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* For AD1848 set I8. */
id|old_fs
op_assign
id|ad_read
(paren
id|devc
comma
l_int|8
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|8
comma
id|fs
)paren
suffix:semicolon
multiline_comment|/*&n;       * Write to I8 starts resynchronization. Wait until it completes.&n;       */
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|100
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_ne
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|10000
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_4232
)paren
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_amp
op_complement
l_int|0x30
)paren
suffix:semicolon
id|ad_leave_MCE
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Starts the calibration process.&n;&t;&t;&t;&t; */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(CONFIG_SEQUENCER) &amp;&amp; !defined(EXCLUDE_TIMERS)
r_if
c_cond
(paren
id|dev
op_eq
id|timer_installed
op_logical_and
id|devc-&gt;timer_running
)paren
r_if
c_cond
(paren
(paren
id|fs
op_amp
l_int|0x01
)paren
op_ne
(paren
id|old_fs
op_amp
l_int|0x01
)paren
)paren
(brace
id|ad1848_tmr_reprogram
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ad1848_halt_input
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_halt
id|ad1848_halt
(paren
r_int
id|dev
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_int
r_char
id|bits
op_assign
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
l_int|0x01
op_logical_and
id|portc-&gt;open_mode
op_amp
id|OPEN_WRITE
)paren
id|ad1848_halt_output
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
l_int|0x02
op_logical_and
id|portc-&gt;open_mode
op_amp
id|OPEN_READ
)paren
id|ad1848_halt_input
(paren
id|dev
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_halt_input
id|ad1848_halt_input
(paren
r_int
id|dev
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
l_int|0x02
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Capture not enabled */
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|ad_mute
(paren
id|devc
)paren
suffix:semicolon
(brace
r_int
id|tmout
suffix:semicolon
id|disable_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_in-&gt;dma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tmout
op_assign
l_int|0
suffix:semicolon
id|tmout
OL
l_int|100000
suffix:semicolon
id|tmout
op_increment
)paren
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x10
)paren
r_break
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Stop capture */
id|enable_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_in-&gt;dma
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_INPUT
suffix:semicolon
)brace
id|outb
(paren
(paren
l_int|0
)paren
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|outb
(paren
(paren
l_int|0
)paren
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_INPUT
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_halt_output
id|ad1848_halt_output
(paren
r_int
id|dev
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
l_int|0x01
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Playback not enabled */
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|ad_mute
(paren
id|devc
)paren
suffix:semicolon
(brace
r_int
id|tmout
suffix:semicolon
id|disable_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;dma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tmout
op_assign
l_int|0
suffix:semicolon
id|tmout
OL
l_int|100000
suffix:semicolon
id|tmout
op_increment
)paren
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x10
)paren
r_break
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Stop playback */
id|enable_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;dma
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_OUTPUT
suffix:semicolon
)brace
id|outb
(paren
(paren
l_int|0
)paren
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|outb
(paren
(paren
l_int|0
)paren
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_trigger
id|ad1848_trigger
(paren
r_int
id|dev
comma
r_int
id|state
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|portc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
comma
id|old
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|state
op_and_assign
id|devc-&gt;audio_mode
suffix:semicolon
id|tmp
op_assign
id|old
op_assign
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portc-&gt;open_mode
op_amp
id|OPEN_READ
)paren
(brace
r_if
c_cond
(paren
id|state
op_amp
id|PCM_ENABLE_INPUT
)paren
id|tmp
op_or_assign
l_int|0x02
suffix:semicolon
r_else
id|tmp
op_and_assign
op_complement
l_int|0x02
suffix:semicolon
)brace
r_if
c_cond
(paren
id|portc-&gt;open_mode
op_amp
id|OPEN_WRITE
)paren
(brace
r_if
c_cond
(paren
id|state
op_amp
id|PCM_ENABLE_OUTPUT
)paren
id|tmp
op_or_assign
l_int|0x01
suffix:semicolon
r_else
id|tmp
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
)brace
multiline_comment|/* ad_mute(devc); */
r_if
c_cond
(paren
id|tmp
op_ne
id|old
)paren
(brace
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|tmp
)paren
suffix:semicolon
id|ad_unmute
(paren
id|devc
)paren
suffix:semicolon
)brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_init_hw
id|ad1848_init_hw
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;   * Initial values for the indirect registers of CS4248/AD1848.&n;   */
r_static
r_int
id|init_values
(braket
)braket
op_assign
(brace
l_int|0xa8
comma
l_int|0xa8
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x0c
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x8a
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/* Positions 16 to 31 just for CS4231/2 and ad1845 */
l_int|0x80
comma
l_int|0x00
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|ad_write
(paren
id|devc
comma
id|i
comma
id|init_values
(braket
id|i
)braket
)paren
suffix:semicolon
id|ad_mute
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Initialize some variables */
id|ad_unmute
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Leave it unmuted now */
r_if
c_cond
(paren
id|devc-&gt;model
OG
id|MD_1848
)paren
(brace
id|ad_write
(paren
id|devc
comma
l_int|12
comma
id|ad_read
(paren
id|devc
comma
l_int|12
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mode2 = enabled */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
id|ad_write
(paren
id|devc
comma
l_int|12
comma
l_int|0x6c
)paren
suffix:semicolon
multiline_comment|/* Select codec mode 3 */
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|ad_write
(paren
id|devc
comma
id|i
comma
id|init_values
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
id|ad_write
(paren
id|devc
comma
l_int|16
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* Playback and capture counters enabled */
)brace
r_if
c_cond
(paren
id|devc-&gt;model
OG
id|MD_1848
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;audio_flags
op_amp
id|DMA_DUPLEX
)paren
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Dual DMA mode */
r_else
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_or
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Single DMA mode */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845
)paren
id|ad_write
(paren
id|devc
comma
l_int|27
comma
id|ad_read
(paren
id|devc
comma
l_int|27
)paren
op_or
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* Alternate freq select enabled */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_IWAVE
)paren
(brace
multiline_comment|/* Some magic Interwave specific initialization */
id|ad_write
(paren
id|devc
comma
l_int|12
comma
l_int|0x6c
)paren
suffix:semicolon
multiline_comment|/* Select codec mode 3 */
id|ad_write
(paren
id|devc
comma
l_int|16
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* Playback and capture counters enabled */
id|ad_write
(paren
id|devc
comma
l_int|17
comma
l_int|0xc2
)paren
suffix:semicolon
multiline_comment|/* Alternate feature enable */
)brace
)brace
r_else
(brace
id|devc-&gt;audio_flags
op_and_assign
op_complement
id|DMA_DUPLEX
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_or
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Single DMA mode */
)brace
id|outb
(paren
(paren
l_int|0
)paren
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear pending interrupts */
multiline_comment|/*&n;   * Toggle the MCE bit. It completes the initialization phase.&n;   */
id|ad_enter_MCE
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* In case the bit was off */
id|ad_leave_MCE
(paren
id|devc
)paren
suffix:semicolon
id|ad1848_mixer_reset
(paren
id|devc
)paren
suffix:semicolon
)brace
r_int
DECL|function|ad1848_detect
id|ad1848_detect
(paren
r_int
id|io_base
comma
r_int
op_star
id|ad_flags
comma
r_int
op_star
id|osp
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
op_amp
id|adev_info
(braket
id|nr_ad1848_devs
)braket
suffix:semicolon
r_int
r_char
id|tmp1
op_assign
l_int|0xff
comma
id|tmp2
op_assign
l_int|0xff
suffix:semicolon
r_int
id|optiC930
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* OPTi 82C930 flag */
r_int
id|interwave
op_assign
l_int|0
suffix:semicolon
r_int
id|ad1847_flag
op_assign
l_int|0
suffix:semicolon
r_int
id|cs4248_flag
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect(%x)&bslash;n&quot;
comma
id|io_base
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
)paren
(brace
r_if
c_cond
(paren
op_star
id|ad_flags
op_eq
l_int|0x12345678
)paren
(brace
id|interwave
op_assign
l_int|1
suffix:semicolon
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|ad_flags
op_eq
l_int|0x12345677
)paren
(brace
id|cs4248_flag
op_assign
l_int|1
suffix:semicolon
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|nr_ad1848_devs
op_ge
id|MAX_AUDIO_DEV
)paren
(brace
id|printk
(paren
l_string|&quot;ad1848 - Too many audio devices&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
(paren
id|io_base
comma
l_int|4
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;ad1848.c: Port %x not free.&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|devc-&gt;base
op_assign
id|io_base
suffix:semicolon
id|devc-&gt;irq_ok
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;timer_running
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;MCE_bit
op_assign
l_int|0x40
suffix:semicolon
id|devc-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;open_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;chip_name
op_assign
id|devc-&gt;name
op_assign
l_string|&quot;AD1848&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_1848
suffix:semicolon
multiline_comment|/* AD1848 or CS4248 */
id|devc-&gt;levels
op_assign
l_int|NULL
suffix:semicolon
id|devc-&gt;c930_password_port
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;debug_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;     * Check that the I/O address is in use.&n;     *&n;     * The bit 0x80 of the base I/O port is known to be 0 after the&n;     * chip has performed its power on initialization. Just assume&n;     * this has happened before the OS is starting.&n;     *&n;     * If the I/O address is unused, it typically returns 0xff.&n;   */
r_if
c_cond
(paren
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0xff
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect: The base I/O address appears to be dead&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait for the device to stop initialization&n; */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step 0&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10000000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|x
op_assign
id|inb
(paren
id|devc-&gt;base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
l_int|0xff
op_logical_or
op_logical_neg
(paren
id|x
op_amp
l_int|0x80
)paren
)paren
r_break
suffix:semicolon
)brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step A&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/* Not ready. Let&squot;s wait */
id|ad_leave_MCE
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
(paren
id|devc-&gt;base
)paren
op_amp
l_int|0x80
)paren
op_ne
l_int|0x00
)paren
multiline_comment|/* Not a AD1848 */
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step A (%02x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|inb
(paren
id|devc-&gt;base
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * Test if it&squot;s possible to change contents of the indirect registers.&n;     * Registers 0 and 1 are ADC volume registers. The bit 0x10 is read only&n;     * so try to avoid using it.&n;   */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step B&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|1
comma
l_int|0x45
)paren
suffix:semicolon
multiline_comment|/* 0x55 with bit 0x10 clear */
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|0
)paren
)paren
op_ne
l_int|0xaa
op_logical_or
(paren
id|tmp2
op_assign
id|ad_read
(paren
id|devc
comma
l_int|1
)paren
)paren
op_ne
l_int|0x45
)paren
r_if
c_cond
(paren
id|tmp2
op_eq
l_int|0x65
)paren
multiline_comment|/* AD1847 has couple of bits hardcoded to 1 */
id|ad1847_flag
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step B (%x/%x)&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step C&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|0
comma
l_int|0x45
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|1
comma
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|0
)paren
)paren
op_ne
l_int|0x45
op_logical_or
(paren
id|tmp2
op_assign
id|ad_read
(paren
id|devc
comma
l_int|1
)paren
)paren
op_ne
l_int|0xaa
)paren
r_if
c_cond
(paren
id|tmp2
op_eq
l_int|0x8a
)paren
multiline_comment|/* AD1847 has few bits hardcoded to 1 */
id|ad1847_flag
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step C (%x/%x)&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * The indirect register I12 has some read only bits. Lets&n;     * try to change them.&n;   */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step D&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|12
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|12
comma
(paren
op_complement
id|tmp
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x0f
)paren
op_ne
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|12
)paren
)paren
op_amp
l_int|0x0f
)paren
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step D (%x)&bslash;n&quot;
comma
id|tmp1
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * NOTE! Last 4 bits of the reg I12 tell the chip revision.&n;     *   0x01=RevB and 0x0A=RevC.&n;   */
multiline_comment|/*&n;     * The original AD1848/CS4248 has just 15 indirect registers. This means&n;     * that I0 and I16 should return the same value (etc.).&n;     * However this doesn&squot;t work with CS4248. Actually it seems to be impossible&n;     * to detect if the chip is a CS4231 or CS4248.&n;     * Ensure that the Mode2 enable bit of I12 is 0. Otherwise this test fails&n;     * with CS4231.&n;   */
multiline_comment|/*&n; * OPTi 82C930 has mode2 control bit in another place. This test will fail&n; * with it. Accept this situation as a possible indication of this chip.&n; */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step F&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|12
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Mode2=disabled */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
id|i
)paren
)paren
op_ne
(paren
id|tmp2
op_assign
id|ad_read
(paren
id|devc
comma
id|i
op_plus
l_int|16
)paren
)paren
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect step F(%d/%x/%x) - OPTi chip???&bslash;n&quot;
comma
id|i
comma
id|tmp1
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ad1847_flag
)paren
id|optiC930
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;     * Try to switch the chip to mode2 (CS4231) by setting the MODE2 bit (0x40).&n;     * The bit 0x80 is always 1 in CS4248 and CS4231.&n;   */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step G&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
op_logical_and
op_star
id|ad_flags
op_eq
l_int|400
)paren
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
r_else
id|ad_write
(paren
id|devc
comma
l_int|12
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Set mode2, clear 0x80 */
r_if
c_cond
(paren
id|ad_flags
)paren
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp1
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|ad_flags
)paren
op_star
id|ad_flags
op_or_assign
id|AD_F_CS4248
suffix:semicolon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4248&quot;
suffix:semicolon
multiline_comment|/* Our best knowledge just now */
)brace
r_if
c_cond
(paren
id|optiC930
op_logical_or
(paren
id|tmp1
op_amp
l_int|0xc0
)paren
op_eq
(paren
l_int|0x80
op_or
l_int|0x40
)paren
)paren
(brace
multiline_comment|/*&n;         *      CS4231 detected - is it?&n;         *&n;         *      Verify that setting I0 doesn&squot;t change I16.&n;       */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step H&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set I16 to known value */
id|ad_write
(paren
id|devc
comma
l_int|0
comma
l_int|0x45
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
)paren
op_ne
l_int|0x45
)paren
multiline_comment|/* No change -&gt; CS4231? */
(brace
id|ad_write
(paren
id|devc
comma
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
)paren
op_eq
l_int|0xaa
)paren
multiline_comment|/* Rotten bits? */
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step H(%x)&bslash;n&quot;
comma
id|tmp1
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;     * Verify that some bits of I25 are read only.&n;&t;   */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step I&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
suffix:semicolon
multiline_comment|/* Original bits */
id|ad_write
(paren
id|devc
comma
l_int|25
comma
op_complement
id|tmp1
)paren
suffix:semicolon
multiline_comment|/* Invert all bits */
r_if
c_cond
(paren
(paren
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
op_amp
l_int|0xe7
)paren
op_eq
(paren
id|tmp1
op_amp
l_int|0xe7
)paren
)paren
(brace
r_int
id|id
comma
id|full_id
suffix:semicolon
multiline_comment|/*&n;&t;       *      It&squot;s at least CS4231&n;&t;       */
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4231&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4231
suffix:semicolon
multiline_comment|/*&n;&t;       * It could be an AD1845 or CS4231A as well.&n;&t;       * CS4231 and AD1845 report the same revision info in I25&n;&t;       * while the CS4231A reports different.&n;&t;       */
id|id
op_assign
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
op_amp
l_int|0xe7
suffix:semicolon
id|full_id
op_assign
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
l_int|0x80
)paren
multiline_comment|/* Device busy??? */
id|id
op_assign
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
op_amp
l_int|0xe7
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
l_int|0x80
)paren
multiline_comment|/* Device still busy??? */
id|id
op_assign
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
op_amp
l_int|0xe7
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step J (%02x/%02x)&bslash;n&quot;
comma
id|id
comma
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
l_int|0xa0
suffix:colon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4231A&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4231A
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xa2
suffix:colon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4232&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4232
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb2
suffix:colon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4232A&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4232
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
r_case
l_int|0x83
suffix:colon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4236&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4232
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x41
suffix:colon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4236B&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_4232
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x80
suffix:colon
(brace
multiline_comment|/* &n;&t;&t;     * It must be a CS4231 or AD1845. The register I23 of&n;&t;&t;     * CS4231 is undefined and it appears to be read only.&n;&t;&t;     * AD1845 uses I23 for setting sample rate. Assume&n;&t;&t;     * the chip is AD1845 if I23 is changeable.&n;&t;&t;     */
r_int
r_char
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|23
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|23
comma
op_complement
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interwave
)paren
(brace
id|devc-&gt;model
op_assign
id|MD_IWAVE
suffix:semicolon
id|devc-&gt;chip_name
op_assign
l_string|&quot;IWave&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|23
)paren
op_ne
id|tmp
)paren
multiline_comment|/* AD1845 ? */
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;AD1845&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_1845
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cs4248_flag
)paren
(brace
r_if
c_cond
(paren
id|ad_flags
)paren
op_star
id|ad_flags
op_or_assign
id|AD_F_CS4248
suffix:semicolon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4248&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_1848
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|12
comma
id|ad_read
(paren
id|devc
comma
l_int|12
)paren
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mode2 off */
)brace
id|ad_write
(paren
id|devc
comma
l_int|23
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore */
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Assume CS4231 or OPTi 82C930 */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848: I25 = %02x/%02x&bslash;n&quot;
comma
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
comma
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
op_amp
l_int|0xe7
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|optiC930
)paren
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;82C930&quot;
suffix:semicolon
id|devc-&gt;model
op_assign
id|MD_C930
suffix:semicolon
)brace
r_else
(brace
id|devc-&gt;model
op_assign
id|MD_4231
suffix:semicolon
)brace
)brace
)brace
id|ad_write
(paren
id|devc
comma
l_int|25
comma
id|tmp1
)paren
suffix:semicolon
multiline_comment|/* Restore bits */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step K&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step L&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
)paren
op_star
id|ad_flags
op_or_assign
id|AD_F_CS4231
suffix:semicolon
)brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - Detected OK&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1848
op_logical_and
id|ad1847_flag
)paren
id|devc-&gt;chip_name
op_assign
l_string|&quot;AD1847&quot;
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|ad1848_init
id|ad1848_init
(paren
r_char
op_star
id|name
comma
r_int
id|io_base
comma
r_int
id|irq
comma
r_int
id|dma_playback
comma
r_int
id|dma_capture
comma
r_int
id|share_dma
comma
r_int
op_star
id|osp
)paren
(brace
multiline_comment|/*&n;     * NOTE! If irq &lt; 0, there is another driver which has allocated the IRQ&n;     *   so that this driver doesn&squot;t need to allocate/deallocate it.&n;     *   The actually used IRQ is ABS(irq).&n;   */
r_int
id|my_dev
suffix:semicolon
r_char
id|dev_name
(braket
l_int|100
)braket
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
op_amp
id|adev_info
(braket
id|nr_ad1848_devs
)braket
suffix:semicolon
id|ad1848_port_info
op_star
id|portc
op_assign
l_int|NULL
suffix:semicolon
id|devc-&gt;irq
op_assign
(paren
id|irq
OG
l_int|0
)paren
ques
c_cond
id|irq
suffix:colon
l_int|0
suffix:semicolon
id|devc-&gt;open_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;dma1
op_assign
id|dma_playback
suffix:semicolon
id|devc-&gt;dma2
op_assign
id|dma_capture
suffix:semicolon
id|devc-&gt;audio_flags
op_assign
id|DMA_AUTOMODE
suffix:semicolon
id|devc-&gt;playback_dev
op_assign
id|devc-&gt;record_dev
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
)paren
id|devc-&gt;name
op_assign
id|name
suffix:semicolon
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
op_logical_and
id|name
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
id|sprintf
(paren
id|dev_name
comma
l_string|&quot;%s (%s)&quot;
comma
id|name
comma
id|devc-&gt;chip_name
)paren
suffix:semicolon
r_else
id|sprintf
(paren
id|dev_name
comma
l_string|&quot;Generic audio codec (%s)&quot;
comma
id|devc-&gt;chip_name
)paren
suffix:semicolon
id|request_region
(paren
id|devc-&gt;base
comma
l_int|4
comma
id|devc-&gt;name
)paren
suffix:semicolon
id|conf_printf2
(paren
id|dev_name
comma
id|devc-&gt;base
comma
id|devc-&gt;irq
comma
id|dma_playback
comma
id|dma_capture
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1848
op_logical_or
id|devc-&gt;model
op_eq
id|MD_C930
)paren
id|devc-&gt;audio_flags
op_or_assign
id|DMA_HARDSTOP
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
OG
id|MD_1848
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;dma1
op_eq
id|devc-&gt;dma2
op_logical_or
id|devc-&gt;dma2
op_eq
op_minus
l_int|1
op_logical_or
id|devc-&gt;dma1
op_eq
op_minus
l_int|1
)paren
id|devc-&gt;audio_flags
op_and_assign
op_complement
id|DMA_DUPLEX
suffix:semicolon
r_else
id|devc-&gt;audio_flags
op_or_assign
id|DMA_DUPLEX
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|my_dev
op_assign
id|sound_install_audiodrv
(paren
id|AUDIO_DRIVER_VERSION
comma
id|dev_name
comma
op_amp
id|ad1848_audio_driver
comma
r_sizeof
(paren
r_struct
id|audio_driver
)paren
comma
id|devc-&gt;audio_flags
comma
id|ad_format_mask
(braket
id|devc-&gt;model
)braket
comma
id|devc
comma
id|dma_playback
comma
id|dma_capture
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|portc
op_assign
(paren
id|ad1848_port_info
op_star
)paren
(paren
id|sound_mem_blocks
(braket
id|sound_nblocks
)braket
op_assign
id|vmalloc
(paren
r_sizeof
(paren
id|ad1848_port_info
)paren
)paren
)paren
suffix:semicolon
id|sound_mem_sizes
(braket
id|sound_nblocks
)braket
op_assign
r_sizeof
(paren
id|ad1848_port_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound_nblocks
OL
l_int|1024
)paren
id|sound_nblocks
op_increment
suffix:semicolon
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|portc
op_assign
id|portc
suffix:semicolon
id|memset
(paren
(paren
r_char
op_star
)paren
id|portc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|portc
)paren
)paren
suffix:semicolon
id|nr_ad1848_devs
op_increment
suffix:semicolon
id|ad1848_init_hw
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
(brace
id|irq2dev
(braket
id|irq
)braket
op_assign
id|devc-&gt;dev_no
op_assign
id|my_dev
suffix:semicolon
r_if
c_cond
(paren
id|snd_set_irq_handler
(paren
id|devc-&gt;irq
comma
id|adintr
comma
id|devc-&gt;name
comma
l_int|NULL
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;ad1848: IRQ in use&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
op_logical_and
id|devc-&gt;model
op_ne
id|MD_C930
)paren
(brace
r_int
id|x
suffix:semicolon
r_int
r_char
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
suffix:semicolon
id|devc-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|21
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Timer MSB */
id|ad_write
(paren
id|devc
comma
l_int|20
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* Timer LSB */
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Enable timer */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
l_int|100000
op_logical_and
id|devc-&gt;timer_ticks
op_eq
l_int|0
suffix:semicolon
id|x
op_increment
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Disable timer */
r_if
c_cond
(paren
id|devc-&gt;timer_ticks
op_eq
l_int|0
)paren
id|printk
(paren
l_string|&quot;ad1848: Interrupt test failed (IRQ%d)&bslash;n&quot;
comma
id|devc-&gt;irq
)paren
suffix:semicolon
r_else
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;Interrupt test OK&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Couldn&squot;t test. assume it&squot;s OK */
)brace
r_else
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
id|irq2dev
(braket
op_minus
id|irq
)braket
op_assign
id|devc-&gt;dev_no
op_assign
id|my_dev
suffix:semicolon
macro_line|#if defined(CONFIG_SEQUENCER) &amp;&amp; !defined(EXCLUDE_TIMERS)
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
op_logical_and
id|devc-&gt;model
op_ne
id|MD_C930
op_logical_and
id|devc-&gt;irq_ok
)paren
id|ad1848_tmr_install
(paren
id|my_dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|share_dma
)paren
(brace
r_if
c_cond
(paren
id|sound_alloc_dma
(paren
id|dma_playback
comma
id|devc-&gt;name
)paren
)paren
id|printk
(paren
l_string|&quot;ad1848.c: Can&squot;t allocate DMA%d&bslash;n&quot;
comma
id|dma_playback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_capture
op_ne
id|dma_playback
)paren
r_if
c_cond
(paren
id|sound_alloc_dma
(paren
id|dma_capture
comma
id|devc-&gt;name
)paren
)paren
id|printk
(paren
l_string|&quot;ad1848.c: Can&squot;t allocate DMA%d&bslash;n&quot;
comma
id|dma_capture
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sound_install_mixer
(paren
id|MIXER_DRIVER_VERSION
comma
id|dev_name
comma
op_amp
id|ad1848_mixer_operations
comma
r_sizeof
(paren
r_struct
id|mixer_operations
)paren
comma
id|devc
)paren
op_ge
l_int|0
)paren
(brace
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|mixer_dev
op_assign
id|num_mixers
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_void
DECL|function|ad1848_control
id|ad1848_control
(paren
r_int
id|cmd
comma
r_int
id|arg
)paren
(brace
id|ad1848_info
op_star
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|nr_ad1848_devs
OL
l_int|1
)paren
r_return
suffix:semicolon
id|devc
op_assign
op_amp
id|adev_info
(braket
id|nr_ad1848_devs
op_minus
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|AD1848_SET_XTAL
suffix:colon
multiline_comment|/* Change clock frequency of AD1845 (only ) */
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1845
)paren
r_return
suffix:semicolon
id|ad_enter_MCE
(paren
id|devc
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|29
comma
(paren
id|ad_read
(paren
id|devc
comma
l_int|29
)paren
op_amp
l_int|0x1f
)paren
op_or
(paren
id|arg
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
id|ad_leave_MCE
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AD1848_MIXER_REROUTE
suffix:colon
(brace
r_int
id|o
op_assign
(paren
id|arg
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|n
op_assign
id|arg
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
id|SOUND_MIXER_NONE
)paren
(brace
multiline_comment|/* Just hide this control */
id|ad1848_mixer_set
(paren
id|devc
comma
id|o
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Shut up it */
id|devc-&gt;supported_devices
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|o
)paren
suffix:semicolon
id|devc-&gt;supported_rec_devices
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|o
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Make the mixer control identified by o to appear as n */
r_if
c_cond
(paren
id|o
template_param
id|SOUND_MIXER_NRDEVICES
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|n
template_param
id|SOUND_MIXER_NRDEVICES
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|o
)paren
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Not supported */
id|devc-&gt;mixer_reroute
(braket
id|n
)braket
op_assign
id|o
suffix:semicolon
multiline_comment|/* Rename the control */
id|devc-&gt;supported_devices
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|o
)paren
suffix:semicolon
id|devc-&gt;supported_devices
op_or_assign
(paren
l_int|1
op_lshift
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;supported_rec_devices
op_amp
(paren
l_int|1
op_lshift
id|o
)paren
)paren
id|devc-&gt;supported_rec_devices
op_or_assign
(paren
l_int|1
op_lshift
id|n
)paren
suffix:semicolon
id|devc-&gt;supported_rec_devices
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|o
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_void
DECL|function|ad1848_unload
id|ad1848_unload
(paren
r_int
id|io_base
comma
r_int
id|irq
comma
r_int
id|dma_playback
comma
r_int
id|dma_capture
comma
r_int
id|share_dma
)paren
(brace
r_int
id|i
comma
id|dev
op_assign
l_int|0
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|devc
op_eq
l_int|NULL
op_logical_and
id|i
OL
id|nr_ad1848_devs
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|adev_info
(braket
id|i
)braket
dot
id|base
op_eq
id|io_base
)paren
(brace
id|devc
op_assign
op_amp
id|adev_info
(braket
id|i
)braket
suffix:semicolon
id|dev
op_assign
id|devc-&gt;dev_no
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc
op_ne
l_int|NULL
)paren
(brace
id|release_region
(paren
id|devc-&gt;base
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|share_dma
)paren
(brace
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
id|snd_release_irq
(paren
id|devc-&gt;irq
)paren
suffix:semicolon
id|sound_free_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_in-&gt;dma
op_ne
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;dma
)paren
id|sound_free_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_in-&gt;dma
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
(paren
l_string|&quot;ad1848: Can&squot;t find device to be unloaded. Base=%x&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
)brace
r_void
DECL|function|adintr
id|adintr
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|ad1848_info
op_star
id|devc
suffix:semicolon
r_int
id|dev
suffix:semicolon
r_int
id|alt_stat
op_assign
l_int|0xff
suffix:semicolon
r_int
r_char
id|c930_stat
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|irq
template_param
l_int|15
)paren
(brace
id|dev
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|dev
op_assign
id|irq2dev
(braket
id|irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_audiodevs
)paren
(brace
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
OL
l_int|17
suffix:semicolon
id|irq
op_increment
)paren
r_if
c_cond
(paren
id|irq2dev
(braket
id|irq
)braket
op_ne
op_minus
l_int|1
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
l_int|15
)paren
(brace
multiline_comment|/* printk(&quot;ad1848.c: Bogus interrupt %d&bslash;n&quot;, irq); */
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|irq2dev
(braket
id|irq
)braket
suffix:semicolon
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
)brace
r_else
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|interrupt_again
suffix:colon
multiline_comment|/* Jump back here if int status doesn&squot;t reset */
id|status
op_assign
id|inb
(paren
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0x80
)paren
id|printk
(paren
l_string|&quot;adintr: Why?&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1848
)paren
id|outb
(paren
(paren
l_int|0
)paren
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x01
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_C930
)paren
(brace
multiline_comment|/* 82C930 has interrupt status register in MAD16 register MC11 */
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|alt_stat
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;c930_password_port
)paren
id|outb
(paren
(paren
l_int|0xe4
)paren
comma
id|devc-&gt;c930_password_port
)paren
suffix:semicolon
multiline_comment|/* Password */
id|outb
(paren
(paren
l_int|11
)paren
comma
l_int|0xe0e
)paren
suffix:semicolon
id|c930_stat
op_assign
id|inb
(paren
l_int|0xe0f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c930_stat
op_amp
l_int|0x04
)paren
id|alt_stat
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Playback intr */
r_if
c_cond
(paren
id|c930_stat
op_amp
l_int|0x08
)paren
id|alt_stat
op_or_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* Playback intr */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
)paren
id|alt_stat
op_assign
id|ad_read
(paren
id|devc
comma
l_int|24
)paren
suffix:semicolon
multiline_comment|/* Acknowledge the intr before proceeding */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_C930
)paren
(brace
multiline_comment|/* 82C930 has interrupt status register in MAD16 register MC11 */
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;c930_password_port
)paren
id|outb
(paren
(paren
l_int|0xe4
)paren
comma
id|devc-&gt;c930_password_port
)paren
suffix:semicolon
multiline_comment|/* Password */
id|outb
(paren
(paren
l_int|11
)paren
comma
l_int|0xe0e
)paren
suffix:semicolon
id|outb
(paren
(paren
op_complement
id|c930_stat
)paren
comma
l_int|0xe0f
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
)paren
id|ad_write
(paren
id|devc
comma
l_int|24
comma
id|ad_read
(paren
id|devc
comma
l_int|24
)paren
op_amp
op_complement
id|alt_stat
)paren
suffix:semicolon
multiline_comment|/* Selective ack */
r_if
c_cond
(paren
id|devc-&gt;open_mode
op_amp
id|OPEN_READ
op_logical_and
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_INPUT
op_logical_and
id|alt_stat
op_amp
l_int|0x20
)paren
(brace
id|DMAbuf_inputintr
(paren
id|devc-&gt;record_dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;open_mode
op_amp
id|OPEN_WRITE
op_logical_and
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_OUTPUT
op_logical_and
id|alt_stat
op_amp
l_int|0x10
)paren
(brace
id|DMAbuf_outputintr
(paren
id|devc-&gt;playback_dev
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
id|MD_1848
op_logical_and
id|alt_stat
op_amp
l_int|0x40
)paren
multiline_comment|/* Timer interrupt */
(brace
id|devc-&gt;timer_ticks
op_increment
suffix:semicolon
macro_line|#if defined(CONFIG_SEQUENCER) &amp;&amp; !defined(EXCLUDE_TIMERS)
r_if
c_cond
(paren
id|timer_installed
op_eq
id|dev
op_logical_and
id|devc-&gt;timer_running
)paren
id|sound_timer_interrupt
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/*&n; * Sometimes playback or capture interrupts occur while a timer interrupt&n; * is being handled. The interrupt will not be retriggered if we don&squot;t&n; * handle it now. Check if an interrupt is still pending and restart&n; * the handler in this case.&n; */
r_if
c_cond
(paren
id|inb
(paren
id|io_Status
(paren
id|devc
)paren
)paren
op_amp
l_int|0x01
op_logical_and
id|cnt
op_increment
OL
l_int|4
)paren
(brace
r_goto
id|interrupt_again
suffix:semicolon
)brace
)brace
macro_line|#ifdef DESKPROXL
multiline_comment|/*&n; * Very experimental initialization sequence for the integrated sound system&n; * of Compaq Deskpro XL. Will be moved somewhere else in future.&n; */
r_static
r_int
DECL|function|init_deskpro
id|init_deskpro
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|inb
(paren
l_int|0xc44
)paren
)paren
op_eq
l_int|0xff
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;init_deskpro: Dead port 0xc44&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank 1 */
r_if
c_cond
(paren
id|inb
(paren
l_int|0xc44
)paren
op_ne
l_int|0x04
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;init_deskpro: Invalid bank1 signature in port 0xc44&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * OK. It looks like a Deskpro so let&squot;s proceed.&n; */
multiline_comment|/*&n; * I/O port 0xc44 Audio configuration register.&n; *&n; * bits 0xc0:   Audio revision bits&n; *              0x00 = Compaq Business Audio&n; *              0x40 = MS Sound System Compatible (reset default)&n; *              0x80 = Reserved&n; *              0xc0 = Reserved&n; * bit 0x20:    No Wait State Enable&n; *              0x00 = Disabled (reset default, DMA mode)&n; *              0x20 = Enabled (programmed I/O mode)&n; * bit 0x10:    MS Sound System Decode Enable&n; *              0x00 = Decoding disabled (reset default)&n; *              0x10 = Decoding enabled&n; * bit 0x08:    FM Synthesis Decode Enable&n; *              0x00 = Decoding Disabled (reset default)&n; *              0x08 = Decoding enabled&n; * bit 0x04     Bank select&n; *              0x00 = Bank 0&n; *              0x04 = Bank 1&n; * bits 0x03    MSS Base address&n; *              0x00 = 0x530 (reset default)&n; *              0x01 = 0x604&n; *              0x02 = 0xf40&n; *              0x03 = 0xe80&n; */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
(paren
l_string|&quot;Port 0xc44 (before): &quot;
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%02x &quot;
comma
id|inb
(paren
l_int|0xc44
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc44
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Set bank 1 of the register */
id|tmp
op_assign
l_int|0x58
suffix:semicolon
multiline_comment|/* MSS Mode, MSS&amp;FM decode enabled */
r_switch
c_cond
(paren
id|hw_config-&gt;io_base
)paren
(brace
r_case
l_int|0x530
suffix:colon
id|tmp
op_or_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x604
suffix:colon
id|tmp
op_or_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf40
suffix:colon
id|tmp
op_or_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe80
suffix:colon
id|tmp
op_or_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DDB
(paren
id|printk
(paren
l_string|&quot;init_deskpro: Invalid MSS port %x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Write to bank=0 */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
(paren
l_string|&quot;Port 0xc44 (after): &quot;
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
(paren
l_string|&quot;%02x &quot;
comma
id|inb
(paren
l_int|0xc44
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc44
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * I/O port 0xc45 FM Address Decode/MSS ID Register.&n; *&n; * bank=0, bits 0xfe:   FM synthesis Decode Compare bits 7:1 (default=0x88)&n; * bank=0, bit 0x01:    SBIC Power Control Bit&n; *                      0x00 = Powered up&n; *                      0x01 = Powered down&n; * bank=1, bits 0xfc:   MSS ID (default=0x40)&n; */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
(paren
l_string|&quot;Port 0xc45 (before): &quot;
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
(paren
l_string|&quot;%02x &quot;
comma
id|inb
(paren
l_int|0xc45
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc45
)paren
)paren
suffix:semicolon
macro_line|#endif
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|outb
(paren
(paren
l_int|0x88
)paren
comma
l_int|0xc45
)paren
suffix:semicolon
multiline_comment|/* FM base 7:0 = 0x88 */
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|outb
(paren
(paren
l_int|0x10
)paren
comma
l_int|0xc45
)paren
suffix:semicolon
multiline_comment|/* MSS ID = 0x10 (MSS port returns 0x04) */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
(paren
l_string|&quot;Port 0xc45 (after): &quot;
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
(paren
l_string|&quot;%02x &quot;
comma
id|inb
(paren
l_int|0xc45
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc45
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * I/O port 0xc46 FM Address Decode/Address ASIC Revision Register.&n; *&n; * bank=0, bits 0xff:   FM synthesis Decode Compare bits 15:8 (default=0x03)&n; * bank=1, bits 0xff:   Audio addressing ASIC id&n; */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
(paren
l_string|&quot;Port 0xc46 (before): &quot;
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
(paren
l_string|&quot;%02x &quot;
comma
id|inb
(paren
l_int|0xc46
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc46
)paren
)paren
suffix:semicolon
macro_line|#endif
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|outb
(paren
(paren
l_int|0x03
)paren
comma
l_int|0xc46
)paren
suffix:semicolon
multiline_comment|/* FM base 15:8 = 0x03 */
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|outb
(paren
(paren
l_int|0x11
)paren
comma
l_int|0xc46
)paren
suffix:semicolon
multiline_comment|/* ASIC ID = 0x11 */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
(paren
l_string|&quot;Port 0xc46 (after): &quot;
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
(paren
l_string|&quot;%02x &quot;
comma
id|inb
(paren
l_int|0xc46
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc46
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * I/O port 0xc47 FM Address Decode Register.&n; *&n; * bank=0, bits 0xff:   Decode enable selection for various FM address bits&n; * bank=1, bits 0xff:   Reserved&n; */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
(paren
l_string|&quot;Port 0xc47 (before): &quot;
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
(paren
l_string|&quot;%02x &quot;
comma
id|inb
(paren
l_int|0xc47
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc47
)paren
)paren
suffix:semicolon
macro_line|#endif
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|outb
(paren
(paren
l_int|0x7c
)paren
comma
l_int|0xc47
)paren
suffix:semicolon
multiline_comment|/* FM decode enable bits = 0x7c */
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|outb
(paren
(paren
l_int|0x00
)paren
comma
l_int|0xc47
)paren
suffix:semicolon
multiline_comment|/* Reserved bank1 = 0x00 */
macro_line|#ifdef DEBUGXL
multiline_comment|/* Debug printing */
id|printk
(paren
l_string|&quot;Port 0xc47 (after): &quot;
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_amp
op_complement
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=0 */
id|printk
(paren
l_string|&quot;%02x &quot;
comma
id|inb
(paren
l_int|0xc47
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
id|tmp
op_or
l_int|0x04
)paren
comma
l_int|0xc44
)paren
suffix:semicolon
multiline_comment|/* Select bank=1 */
id|printk
(paren
l_string|&quot;%02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc47
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * I/O port 0xc6f = Audio Disable Function Register&n; */
macro_line|#ifdef DEBUGXL
id|printk
(paren
l_string|&quot;Port 0xc6f (before) = %02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc6f
)paren
)paren
suffix:semicolon
macro_line|#endif
id|outb
(paren
(paren
l_int|0x80
)paren
comma
l_int|0xc6f
)paren
suffix:semicolon
macro_line|#ifdef DEBUGXL
id|printk
(paren
l_string|&quot;Port 0xc6f (after) = %02x&bslash;n&quot;
comma
id|inb
(paren
l_int|0xc6f
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_int
DECL|function|probe_ms_sound
id|probe_ms_sound
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;Entered probe_ms_sound(%x, %d)&bslash;n&quot;
comma
id|hw_config-&gt;io_base
comma
id|hw_config-&gt;card_subtype
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
(paren
id|hw_config-&gt;io_base
comma
l_int|8
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: I/O port conflict&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;card_subtype
op_eq
l_int|1
)paren
multiline_comment|/* Has no IRQ/DMA registers */
(brace
multiline_comment|/* check_opl3(0x388, hw_config); */
r_return
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
)brace
macro_line|#ifdef DESKPROXL
r_if
c_cond
(paren
id|hw_config-&gt;card_subtype
op_eq
l_int|2
)paren
multiline_comment|/* Compaq Deskpro XL */
(brace
r_if
c_cond
(paren
op_logical_neg
id|init_deskpro
(paren
id|hw_config
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;     * Check if the IO port returns valid signature. The original MS Sound&n;     * system returns 0x04 while some cards (AudioTrix Pro for example)&n;     * return 0x00 or 0x0f.&n;   */
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
)paren
op_eq
l_int|0xff
)paren
multiline_comment|/* Bus float */
(brace
r_int
id|ret
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;I/O address is inactive (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;MSS signature = %x&bslash;n&quot;
comma
id|tmp
op_amp
l_int|0x3f
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x04
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x0f
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x00
)paren
(brace
r_int
id|ret
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;No MSS signature detected on port 0x%x (0x%x)&bslash;n&quot;
comma
id|hw_config-&gt;io_base
comma
(paren
r_int
)paren
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
)paren
)paren
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;Trying to detect codec anyway but IRQ/DMA may not work&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|hw_config-&gt;card_subtype
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|11
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Bad IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_ne
l_int|0
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|1
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|3
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Bad DMA %d&bslash;n&quot;
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * Check that DMA0 is not in use with a 8 bit board.&n;   */
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_eq
l_int|0
op_logical_and
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Can&squot;t use DMA0 with a 8 bit card/slot&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|7
op_logical_and
id|hw_config-&gt;irq
op_ne
l_int|9
op_logical_and
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Can&squot;t use IRQ%d with a 8 bit card/slot&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
)brace
r_void
DECL|function|attach_ms_sound
id|attach_ms_sound
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_static
r_char
id|interrupt_bits
(braket
l_int|12
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x08
comma
op_minus
l_int|1
comma
l_int|0x10
comma
l_int|0x18
comma
l_int|0x20
)brace
suffix:semicolon
r_char
id|bits
comma
id|dma2_bit
op_assign
l_int|0
suffix:semicolon
r_static
r_char
id|dma_bits
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|0
comma
l_int|3
)brace
suffix:semicolon
r_int
id|config_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|0
suffix:semicolon
r_int
id|version_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|3
suffix:semicolon
r_int
id|dma
op_assign
id|hw_config-&gt;dma
suffix:semicolon
r_int
id|dma2
op_assign
id|hw_config-&gt;dma2
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;card_subtype
op_eq
l_int|1
)paren
multiline_comment|/* Has no IRQ/DMA registers */
(brace
id|ad1848_init
(paren
l_string|&quot;MS Sound System&quot;
comma
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
comma
l_int|0
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
id|request_region
(paren
id|hw_config-&gt;io_base
comma
l_int|4
comma
l_string|&quot;WSS config&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;     * Set the IRQ and DMA addresses.&n;   */
id|bits
op_assign
id|interrupt_bits
(braket
id|hw_config-&gt;irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Bad IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb
(paren
(paren
id|bits
op_or
l_int|0x40
)paren
comma
id|config_port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
(paren
id|version_port
)paren
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
id|printk
(paren
l_string|&quot;[MSS: IRQ Conflict?]&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Handle the capture DMA channel&n; */
r_if
c_cond
(paren
id|dma2
op_ne
op_minus
l_int|1
op_logical_and
id|dma2
op_ne
id|dma
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|dma
op_eq
l_int|0
op_logical_and
id|dma2
op_eq
l_int|1
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|1
op_logical_and
id|dma2
op_eq
l_int|0
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|3
op_logical_and
id|dma2
op_eq
l_int|0
)paren
)paren
)paren
(brace
multiline_comment|/* Unsupported combination. Try to swap channels */
r_int
id|tmp
op_assign
id|dma
suffix:semicolon
id|dma
op_assign
id|dma2
suffix:semicolon
id|dma2
op_assign
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dma
op_eq
l_int|0
op_logical_and
id|dma2
op_eq
l_int|1
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|1
op_logical_and
id|dma2
op_eq
l_int|0
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|3
op_logical_and
id|dma2
op_eq
l_int|0
)paren
)paren
(brace
id|dma2_bit
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Enable capture DMA */
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;MSS: Invalid capture DMA&bslash;n&quot;
)paren
suffix:semicolon
id|dma2
op_assign
id|dma
suffix:semicolon
)brace
)brace
r_else
(brace
id|dma2
op_assign
id|dma
suffix:semicolon
)brace
id|hw_config-&gt;dma
op_assign
id|dma
suffix:semicolon
id|hw_config-&gt;dma2
op_assign
id|dma2
suffix:semicolon
id|outb
(paren
(paren
id|bits
op_or
id|dma_bits
(braket
id|dma
)braket
op_or
id|dma2_bit
)paren
comma
id|config_port
)paren
suffix:semicolon
multiline_comment|/* Write IRQ+DMA setup */
id|ad1848_init
(paren
l_string|&quot;MSS audio codec&quot;
comma
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|dma
comma
id|dma2
comma
l_int|0
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
id|request_region
(paren
id|hw_config-&gt;io_base
comma
l_int|4
comma
l_string|&quot;WSS config&quot;
)paren
suffix:semicolon
)brace
r_void
DECL|function|unload_ms_sound
id|unload_ms_sound
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|ad1848_unload
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma
comma
l_int|0
)paren
suffix:semicolon
id|release_region
(paren
id|hw_config-&gt;io_base
comma
l_int|4
)paren
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_SEQUENCER) &amp;&amp; !defined(EXCLUDE_TIMERS)
multiline_comment|/*&n; * Timer stuff (for /dev/music).&n; */
DECL|variable|current_interval
r_static
r_int
r_int
id|current_interval
op_assign
l_int|0
suffix:semicolon
r_static
r_int
r_int
DECL|function|ad1848_tmr_start
id|ad1848_tmr_start
(paren
r_int
id|dev
comma
r_int
r_int
id|usecs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|xtal_nsecs
suffix:semicolon
multiline_comment|/* nanoseconds per xtal oscillator tick */
r_int
r_int
id|divider
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Length of the timer interval (in nanoseconds) depends on the&n; * selected crystal oscillator. Check this from bit 0x01 of I8.&n; *&n; * AD1845 has just one oscillator which has cycle time of 10.050 us&n; * (when a 24.576 MHz xtal oscillator is used).&n; *&n; * Convert requested interval to nanoseconds before computing&n; * the timer divider.&n; */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
id|MD_1845
)paren
id|xtal_nsecs
op_assign
l_int|10050
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|8
)paren
op_amp
l_int|0x01
)paren
id|xtal_nsecs
op_assign
l_int|9920
suffix:semicolon
r_else
id|xtal_nsecs
op_assign
l_int|9969
suffix:semicolon
id|divider
op_assign
(paren
id|usecs
op_star
l_int|1000
op_plus
id|xtal_nsecs
op_div
l_int|2
)paren
op_div
id|xtal_nsecs
suffix:semicolon
r_if
c_cond
(paren
id|divider
OL
l_int|100
)paren
multiline_comment|/* Don&squot;t allow shorter intervals than about 1ms */
id|divider
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|divider
OG
l_int|65535
)paren
multiline_comment|/* Overflow check */
id|divider
op_assign
l_int|65535
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|21
comma
(paren
id|divider
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Set upper bits */
id|ad_write
(paren
id|devc
comma
l_int|20
comma
id|divider
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Set lower bits */
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Start the timer */
id|devc-&gt;timer_running
op_assign
l_int|1
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
id|current_interval
op_assign
(paren
id|divider
op_star
id|xtal_nsecs
op_plus
l_int|500
)paren
op_div
l_int|1000
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_tmr_reprogram
id|ad1848_tmr_reprogram
(paren
r_int
id|dev
)paren
(brace
multiline_comment|/*&n; *    Audio driver has changed sampling rate so that a different xtal&n; *      oscillator was selected. We have to reprogram the timer rate.&n; */
id|ad1848_tmr_start
(paren
id|dev
comma
id|current_interval
)paren
suffix:semicolon
id|sound_timer_syncinterval
(paren
id|current_interval
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_tmr_disable
id|ad1848_tmr_disable
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
id|devc-&gt;timer_running
op_assign
l_int|0
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_tmr_restart
id|ad1848_tmr_restart
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|current_interval
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
id|devc-&gt;timer_running
op_assign
l_int|1
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|ad1848_tmr
r_static
r_struct
id|sound_lowlev_timer
id|ad1848_tmr
op_assign
(brace
l_int|0
comma
l_int|2
comma
id|ad1848_tmr_start
comma
id|ad1848_tmr_disable
comma
id|ad1848_tmr_restart
)brace
suffix:semicolon
r_static
r_int
DECL|function|ad1848_tmr_install
id|ad1848_tmr_install
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|timer_installed
op_ne
op_minus
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Don&squot;t install another timer */
id|timer_installed
op_assign
id|ad1848_tmr.dev
op_assign
id|dev
suffix:semicolon
id|sound_timer_init
(paren
op_amp
id|ad1848_tmr
comma
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
eof
