multiline_comment|/*&n; * sound/ad1848.c&n; *&n; * The low level driver for the AD1848/CS4248 codec chip which&n; * is used for example in the MS Sound System.&n; *&n; * The CS4231 which is used in the GUS MAX and some other cards is&n; * upwards compatible with AD1848 and this driver is able to drive it.&n; *&n; * CS4231A and AD1845 are upward compatible with CS4231. However&n; * the new features of these chips are different.&n; *&n; * CS4232 is a PnP audio chip which contains a CS4231A (and SB, MPU).&n; * CS4232A is an improved version of CS4232.&n; */
multiline_comment|/*&n; * Copyright by Hannu Savolainen 1993-1996&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; */
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|DEB
mdefine_line|#define DEB(x)
DECL|macro|DEB1
mdefine_line|#define DEB1(x)
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIG_AD1848)
macro_line|#include &quot;ad1848_mixer.h&quot;
r_typedef
r_struct
(brace
DECL|member|base
r_int
id|base
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|dual_dma
r_int
id|dual_dma
suffix:semicolon
multiline_comment|/* 1, when two DMA channels allocated */
DECL|member|MCE_bit
r_int
r_char
id|MCE_bit
suffix:semicolon
DECL|member|saved_regs
r_int
r_char
id|saved_regs
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|debug_flag
r_int
id|debug_flag
suffix:semicolon
DECL|member|speed
r_int
id|speed
suffix:semicolon
DECL|member|speed_bits
r_int
r_char
id|speed_bits
suffix:semicolon
DECL|member|channels
r_int
id|channels
suffix:semicolon
DECL|member|audio_format
r_int
id|audio_format
suffix:semicolon
DECL|member|format_bits
r_int
r_char
id|format_bits
suffix:semicolon
DECL|member|xfer_count
r_int
id|xfer_count
suffix:semicolon
DECL|member|irq_mode
r_int
id|irq_mode
suffix:semicolon
DECL|member|intr_active
r_int
id|intr_active
suffix:semicolon
DECL|member|opened
r_int
id|opened
suffix:semicolon
DECL|member|chip_name
r_char
op_star
id|chip_name
suffix:semicolon
DECL|member|mode
r_int
id|mode
suffix:semicolon
DECL|macro|MD_1848
mdefine_line|#define MD_1848&t;&t;1
DECL|macro|MD_4231
mdefine_line|#define MD_4231&t;&t;2
DECL|macro|MD_4231A
mdefine_line|#define MD_4231A&t;3
DECL|macro|MD_1845
mdefine_line|#define MD_1845&t;&t;4
DECL|macro|MD_4232
mdefine_line|#define MD_4232&t;&t;5
multiline_comment|/* Mixer parameters */
DECL|member|recmask
r_int
id|recmask
suffix:semicolon
DECL|member|supported_devices
r_int
id|supported_devices
suffix:semicolon
DECL|member|supported_rec_devices
r_int
id|supported_rec_devices
suffix:semicolon
DECL|member|levels
r_int
r_int
id|levels
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|dev_no
r_int
id|dev_no
suffix:semicolon
DECL|member|timer_ticks
r_volatile
r_int
r_int
id|timer_ticks
suffix:semicolon
DECL|member|timer_running
r_int
id|timer_running
suffix:semicolon
DECL|member|irq_ok
r_int
id|irq_ok
suffix:semicolon
DECL|member|osp
r_int
op_star
id|osp
suffix:semicolon
)brace
DECL|typedef|ad1848_info
id|ad1848_info
suffix:semicolon
DECL|variable|nr_ad1848_devs
r_static
r_int
id|nr_ad1848_devs
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq2dev
r_static
r_volatile
r_char
id|irq2dev
(braket
l_int|17
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|timer_installed
r_static
r_int
id|timer_installed
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mixer2codec
r_static
r_char
id|mixer2codec
(braket
id|MAX_MIXER_DEV
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|ad_format_mask
r_static
r_int
id|ad_format_mask
(braket
l_int|6
multiline_comment|/*devc-&gt;mode */
)braket
op_assign
(brace
l_int|0
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_U16_LE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_U16_LE
op_or
id|AFMT_IMA_ADPCM
comma
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
comma
multiline_comment|/* AD1845 */
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
op_or
id|AFMT_U16_LE
op_or
id|AFMT_IMA_ADPCM
)brace
suffix:semicolon
DECL|variable|dev_info
r_static
id|ad1848_info
id|dev_info
(braket
id|MAX_AUDIO_DEV
)braket
suffix:semicolon
DECL|macro|io_Index_Addr
mdefine_line|#define io_Index_Addr(d)&t;((d)-&gt;base)
DECL|macro|io_Indexed_Data
mdefine_line|#define io_Indexed_Data(d)&t;((d)-&gt;base+1)
DECL|macro|io_Status
mdefine_line|#define io_Status(d)&t;&t;((d)-&gt;base+2)
DECL|macro|io_Polled_IO
mdefine_line|#define io_Polled_IO(d)&t;&t;((d)-&gt;base+3)
r_static
r_int
id|ad1848_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|ad1848_close
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_int
id|ad1848_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
comma
r_int
id|local
)paren
suffix:semicolon
r_static
r_void
id|ad1848_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|dma_restart
)paren
suffix:semicolon
r_static
r_void
id|ad1848_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|dma_restart
)paren
suffix:semicolon
r_static
r_int
id|ad1848_prepare_for_IO
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
suffix:semicolon
r_static
r_void
id|ad1848_reset
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_halt
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_halt_input
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_halt_output
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_trigger
(paren
r_int
id|dev
comma
r_int
id|bits
)paren
suffix:semicolon
r_static
r_int
id|ad1848_tmr_install
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ad1848_tmr_reprogram
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_int
DECL|function|ad_read
id|ad_read
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|x
suffix:semicolon
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|outb
(paren
(paren
r_int
r_char
)paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_or
id|devc-&gt;MCE_bit
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
id|x
op_assign
id|inb
(paren
id|io_Indexed_Data
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/*  printk(&quot;(%02x&lt;-%02x) &quot;, reg|devc-&gt;MCE_bit, x); */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad_write
id|ad_write
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|timeout
op_assign
l_int|900000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|outb
(paren
(paren
r_int
r_char
)paren
(paren
id|reg
op_amp
l_int|0xff
)paren
op_or
id|devc-&gt;MCE_bit
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
id|outb
(paren
(paren
r_int
r_char
)paren
(paren
id|data
op_amp
l_int|0xff
)paren
comma
id|io_Indexed_Data
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;(%02x-&gt;%02x) &quot;, reg|devc-&gt;MCE_bit, data); */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|wait_for_calibration
id|wait_for_calibration
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;     * Wait until the auto calibration process has finished.&n;     *&n;     * 1)       Wait until the chip becomes ready (reads don&squot;t return 0x80).&n;     * 2)       Wait until the ACI bit of I11 gets on and then off.&n;   */
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|inb
(paren
id|devc-&gt;base
)paren
op_amp
l_int|0x80
)paren
id|printk
(paren
l_string|&quot;ad1848: Auto calibration timed out(1).&bslash;n&quot;
)paren
suffix:semicolon
id|timeout
op_assign
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
op_logical_neg
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
)paren
r_return
suffix:semicolon
id|timeout
op_assign
l_int|80000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x20
)paren
id|printk
(paren
l_string|&quot;ad1848: Auto calibration timed out(3).&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad_mute
id|ad_mute
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
id|prev
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mode
op_ne
id|MD_1848
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;     * Save old register settings and mute output channels&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|6
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|prev
op_assign
id|devc-&gt;saved_regs
(braket
id|i
)braket
op_assign
id|ad_read
(paren
id|devc
comma
id|i
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
id|i
comma
id|prev
op_or
l_int|0x80
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ad_unmute
id|ad_unmute
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;     * Restore back old volume registers (unmute)&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|6
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ad_write
(paren
id|devc
comma
id|i
comma
id|devc-&gt;saved_regs
(braket
id|i
)braket
op_amp
op_complement
l_int|0x80
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ad_enter_MCE
id|ad_enter_MCE
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_int
r_int
id|prev
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|devc-&gt;MCE_bit
op_assign
l_int|0x40
suffix:semicolon
id|prev
op_assign
id|inb
(paren
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_amp
l_int|0x40
)paren
(brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb
(paren
id|devc-&gt;MCE_bit
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad_leave_MCE
id|ad_leave_MCE
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|prev
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
multiline_comment|/*Are we initializing */
id|timeout
op_decrement
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|devc-&gt;MCE_bit
op_assign
l_int|0x00
suffix:semicolon
id|prev
op_assign
id|inb
(paren
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
id|outb
(paren
l_int|0x00
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear the MCE bit */
r_if
c_cond
(paren
(paren
id|prev
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Not in MCE mode */
(brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outb
(paren
l_int|0x00
comma
id|io_Index_Addr
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear the MCE bit */
id|wait_for_calibration
(paren
id|devc
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_set_recmask
id|ad1848_set_recmask
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|mask
)paren
(brace
r_int
r_char
id|recdev
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
id|mask
op_and_assign
id|devc-&gt;supported_rec_devices
suffix:semicolon
id|n
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Count selected device bits */
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
r_else
r_if
c_cond
(paren
id|n
op_ne
l_int|1
)paren
multiline_comment|/* Too many devices selected */
(brace
id|mask
op_and_assign
op_complement
id|devc-&gt;recmask
suffix:semicolon
multiline_comment|/* Filter out active settings */
id|n
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Count selected device bits */
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
l_int|1
)paren
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mask
)paren
(brace
r_case
id|SOUND_MASK_MIC
suffix:colon
id|recdev
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_LINE
suffix:colon
r_case
id|SOUND_MASK_LINE3
suffix:colon
id|recdev
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_CD
suffix:colon
r_case
id|SOUND_MASK_LINE1
suffix:colon
id|recdev
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_IMIX
suffix:colon
id|recdev
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
id|recdev
op_assign
l_int|2
suffix:semicolon
)brace
id|recdev
op_lshift_assign
l_int|6
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|0
comma
(paren
id|ad_read
(paren
id|devc
comma
l_int|0
)paren
op_amp
l_int|0x3f
)paren
op_or
id|recdev
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|1
comma
(paren
id|ad_read
(paren
id|devc
comma
l_int|1
)paren
op_amp
l_int|0x3f
)paren
op_or
id|recdev
)paren
suffix:semicolon
id|devc-&gt;recmask
op_assign
id|mask
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
r_static
r_void
DECL|function|change_bits
id|change_bits
(paren
r_int
r_char
op_star
id|regval
comma
r_int
id|dev
comma
r_int
id|chn
comma
r_int
id|newval
)paren
(brace
r_int
r_char
id|mask
suffix:semicolon
r_int
id|shift
suffix:semicolon
r_if
c_cond
(paren
id|mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|polarity
op_eq
l_int|1
)paren
multiline_comment|/* Reverse */
id|newval
op_assign
l_int|100
op_minus
id|newval
suffix:semicolon
id|mask
op_assign
(paren
l_int|1
op_lshift
id|mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|nbits
)paren
op_minus
l_int|1
suffix:semicolon
id|shift
op_assign
id|mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|bitpos
suffix:semicolon
id|newval
op_assign
(paren
r_int
)paren
(paren
(paren
id|newval
op_star
id|mask
)paren
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
multiline_comment|/* Scale it */
op_star
id|regval
op_and_assign
op_complement
(paren
id|mask
op_lshift
id|shift
)paren
suffix:semicolon
multiline_comment|/* Clear bits */
op_star
id|regval
op_or_assign
(paren
id|newval
op_amp
id|mask
)paren
op_lshift
id|shift
suffix:semicolon
multiline_comment|/* Set new value */
)brace
r_static
r_int
DECL|function|ad1848_mixer_get
id|ad1848_mixer_get
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|1
op_lshift
id|dev
)paren
op_amp
id|devc-&gt;supported_devices
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|devc-&gt;levels
(braket
id|dev
)braket
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_mixer_set
id|ad1848_mixer_set
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|dev
comma
r_int
id|value
)paren
(brace
r_int
id|left
op_assign
id|value
op_amp
l_int|0x000000ff
suffix:semicolon
r_int
id|right
op_assign
(paren
id|value
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
r_int
id|retvol
suffix:semicolon
r_int
id|regoffs
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
id|right
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
multiline_comment|/* Mono control */
id|right
op_assign
id|left
suffix:semicolon
id|retvol
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Scale volumes */
id|left
op_assign
id|mix_cvt
(braket
id|left
)braket
suffix:semicolon
id|right
op_assign
id|mix_cvt
(braket
id|right
)braket
suffix:semicolon
multiline_comment|/* Scale it again */
id|left
op_assign
id|mix_cvt
(braket
id|left
)braket
suffix:semicolon
id|right
op_assign
id|mix_cvt
(braket
id|right
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
l_int|31
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|mix_devices
(braket
id|dev
)braket
(braket
id|LEFT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|devc-&gt;levels
(braket
id|dev
)braket
op_assign
id|retvol
suffix:semicolon
multiline_comment|/*&n;     * Set the left channel&n;   */
id|regoffs
op_assign
id|mix_devices
(braket
id|dev
)braket
(braket
id|LEFT_CHN
)braket
dot
id|regno
suffix:semicolon
id|val
op_assign
id|ad_read
(paren
id|devc
comma
id|regoffs
)paren
suffix:semicolon
id|change_bits
(paren
op_amp
id|val
comma
id|dev
comma
id|LEFT_CHN
comma
id|left
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
id|regoffs
comma
id|val
)paren
suffix:semicolon
id|devc-&gt;saved_regs
(braket
id|regoffs
)braket
op_assign
id|val
suffix:semicolon
multiline_comment|/*&n;     * Set the right channel&n;   */
r_if
c_cond
(paren
id|mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
r_return
id|retvol
suffix:semicolon
multiline_comment|/* Was just a mono channel */
id|regoffs
op_assign
id|mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|regno
suffix:semicolon
id|val
op_assign
id|ad_read
(paren
id|devc
comma
id|regoffs
)paren
suffix:semicolon
id|change_bits
(paren
op_amp
id|val
comma
id|dev
comma
id|RIGHT_CHN
comma
id|right
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
id|regoffs
comma
id|val
)paren
suffix:semicolon
id|devc-&gt;saved_regs
(braket
id|regoffs
)braket
op_assign
id|val
suffix:semicolon
r_return
id|retvol
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_mixer_reset
id|ad1848_mixer_reset
(paren
id|ad1848_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|devc-&gt;mode
)paren
(brace
r_case
id|MD_4231
suffix:colon
r_case
id|MD_4231A
suffix:colon
r_case
id|MD_1845
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE2_MIXER_DEVICES
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MD_4232
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE3_MIXER_DEVICES
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|devc-&gt;supported_devices
op_assign
id|MODE1_MIXER_DEVICES
suffix:semicolon
)brace
id|devc-&gt;supported_rec_devices
op_assign
id|MODE1_REC_DEVICES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|ad1848_mixer_set
(paren
id|devc
comma
id|i
comma
id|default_mixer_levels
(braket
id|i
)braket
)paren
suffix:semicolon
id|ad1848_set_recmask
(paren
id|devc
comma
id|SOUND_MASK_MIC
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_mixer_ioctl
id|ad1848_mixer_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
id|ad1848_info
op_star
id|devc
suffix:semicolon
r_int
id|codec_dev
op_assign
id|mixer2codec
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|codec_dev
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|codec_dev
op_decrement
suffix:semicolon
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|codec_dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|cmd
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_eq
l_char|&squot;M&squot;
)paren
(brace
r_if
c_cond
(paren
id|_IOC_DIR
(paren
id|cmd
)paren
op_amp
id|_IOC_WRITE
)paren
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|ad1848_set_recmask
(paren
id|devc
comma
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|ad1848_mixer_set
(paren
id|devc
comma
id|cmd
op_amp
l_int|0xff
comma
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * Return parameters&n;&t;&t;&t;&t; */
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|devc-&gt;recmask
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|devc-&gt;supported_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|devc-&gt;supported_devices
op_amp
op_complement
(paren
id|SOUND_MASK_SPEAKER
op_or
id|SOUND_MASK_IMIX
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|devc-&gt;supported_rec_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|SOUND_CAP_EXCL_INPUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|ad1848_mixer_get
(paren
id|devc
comma
id|cmd
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|ad1848_pcm_operations
r_static
r_struct
id|audio_operations
id|ad1848_pcm_operations
(braket
id|MAX_AUDIO_DEV
)braket
op_assign
(brace
(brace
l_string|&quot;Generic AD1848 codec&quot;
comma
id|DMA_AUTOMODE
comma
id|AFMT_U8
comma
multiline_comment|/* Will be set later */
l_int|NULL
comma
id|ad1848_open
comma
id|ad1848_close
comma
id|ad1848_output_block
comma
id|ad1848_start_input
comma
id|ad1848_ioctl
comma
id|ad1848_prepare_for_IO
comma
id|ad1848_prepare_for_IO
comma
id|ad1848_reset
comma
id|ad1848_halt
comma
l_int|NULL
comma
l_int|NULL
comma
id|ad1848_halt_input
comma
id|ad1848_halt_output
comma
id|ad1848_trigger
)brace
)brace
suffix:semicolon
DECL|variable|ad1848_mixer_operations
r_static
r_struct
id|mixer_operations
id|ad1848_mixer_operations
op_assign
(brace
l_string|&quot;AD1848/CS4248/CS4231&quot;
comma
id|ad1848_mixer_ioctl
)brace
suffix:semicolon
r_static
r_int
DECL|function|ad1848_open
id|ad1848_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_audiodevs
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;opened
)paren
(brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;ad1848: Already opened&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|devc-&gt;dual_dma
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DMA_DUPLEX
)paren
(brace
id|devc-&gt;dual_dma
op_assign
l_int|1
suffix:semicolon
)brace
id|devc-&gt;intr_active
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|1
suffix:semicolon
id|devc-&gt;irq_mode
op_assign
l_int|0
suffix:semicolon
id|ad1848_trigger
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n; * Mute output until the playback really starts. This decreases clicking (hope so).&n; */
id|ad_mute
(paren
id|devc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_close
id|ad1848_close
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;ad1848_close(void)&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|0
suffix:semicolon
id|ad1848_reset
(paren
id|dev
)paren
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;irq_mode
op_assign
l_int|0
suffix:semicolon
id|ad_unmute
(paren
id|devc
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|set_speed
id|set_speed
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|arg
)paren
(brace
multiline_comment|/*&n;     * The sampling speed is encoded in the least significant nibble of I8. The&n;     * LSB selects the clock source (0=24.576 MHz, 1=16.9344 Mhz) and other&n;     * three bits select the divisor (indirectly):&n;     *&n;     * The available speeds are in the following table. Keep the speeds in&n;     * the increasing order.&n;   */
r_typedef
r_struct
(brace
r_int
id|speed
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
)brace
id|speed_struct
suffix:semicolon
r_static
id|speed_struct
id|speed_table
(braket
)braket
op_assign
(brace
(brace
l_int|5510
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|5510
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|6620
comma
(paren
l_int|7
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|8000
comma
(paren
l_int|0
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|9600
comma
(paren
l_int|7
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|11025
comma
(paren
l_int|1
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|16000
comma
(paren
l_int|1
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|18900
comma
(paren
l_int|2
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|22050
comma
(paren
l_int|3
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|27420
comma
(paren
l_int|2
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|32000
comma
(paren
l_int|3
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
comma
(brace
l_int|33075
comma
(paren
l_int|6
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|37800
comma
(paren
l_int|4
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|44100
comma
(paren
l_int|5
op_lshift
l_int|1
)paren
op_or
l_int|1
)brace
comma
(brace
l_int|48000
comma
(paren
l_int|6
op_lshift
l_int|1
)paren
op_or
l_int|0
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|n
comma
id|selected
op_assign
op_minus
l_int|1
suffix:semicolon
id|n
op_assign
r_sizeof
(paren
id|speed_table
)paren
op_div
r_sizeof
(paren
id|speed_struct
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MD_1845
)paren
multiline_comment|/* AD1845 has different timer than others */
(brace
r_if
c_cond
(paren
id|arg
OL
l_int|4000
)paren
id|arg
op_assign
l_int|4000
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|50000
)paren
id|arg
op_assign
l_int|50000
suffix:semicolon
id|devc-&gt;speed
op_assign
id|arg
suffix:semicolon
id|devc-&gt;speed_bits
op_assign
id|speed_table
(braket
l_int|3
)braket
dot
id|bits
suffix:semicolon
r_return
id|devc-&gt;speed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
OL
id|speed_table
(braket
l_int|0
)braket
dot
id|speed
)paren
id|selected
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
id|speed_table
(braket
id|n
op_minus
l_int|1
)braket
dot
id|speed
)paren
id|selected
op_assign
id|n
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
multiline_comment|/*really */
suffix:semicolon
id|selected
op_eq
op_minus
l_int|1
op_logical_and
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|speed_table
(braket
id|i
)braket
dot
id|speed
op_eq
id|arg
)paren
id|selected
op_assign
id|i
suffix:semicolon
r_else
r_if
c_cond
(paren
id|speed_table
(braket
id|i
)braket
dot
id|speed
OG
id|arg
)paren
(brace
r_int
id|diff1
comma
id|diff2
suffix:semicolon
id|diff1
op_assign
id|arg
op_minus
id|speed_table
(braket
id|i
op_minus
l_int|1
)braket
dot
id|speed
suffix:semicolon
id|diff2
op_assign
id|speed_table
(braket
id|i
)braket
dot
id|speed
op_minus
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|diff1
OL
id|diff2
)paren
id|selected
op_assign
id|i
op_minus
l_int|1
suffix:semicolon
r_else
id|selected
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|selected
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;ad1848: Can&squot;t find speed???&bslash;n&quot;
)paren
suffix:semicolon
id|selected
op_assign
l_int|3
suffix:semicolon
)brace
id|devc-&gt;speed
op_assign
id|speed_table
(braket
id|selected
)braket
dot
id|speed
suffix:semicolon
id|devc-&gt;speed_bits
op_assign
id|speed_table
(braket
id|selected
)braket
dot
id|bits
suffix:semicolon
r_return
id|devc-&gt;speed
suffix:semicolon
)brace
r_static
r_int
DECL|function|set_channels
id|set_channels
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
id|arg
op_ne
l_int|1
op_logical_and
id|arg
op_ne
l_int|2
)paren
r_return
id|devc-&gt;channels
suffix:semicolon
id|devc-&gt;channels
op_assign
id|arg
suffix:semicolon
r_return
id|arg
suffix:semicolon
)brace
r_static
r_int
DECL|function|set_format
id|set_format
(paren
id|ad1848_info
op_star
id|devc
comma
r_int
id|arg
)paren
(brace
r_static
r_struct
id|format_tbl
(brace
r_int
id|format
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
)brace
id|format2bits
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
id|AFMT_MU_LAW
comma
l_int|1
)brace
comma
(brace
id|AFMT_A_LAW
comma
l_int|3
)brace
comma
(brace
id|AFMT_IMA_ADPCM
comma
l_int|5
)brace
comma
(brace
id|AFMT_U8
comma
l_int|0
)brace
comma
(brace
id|AFMT_S16_LE
comma
l_int|2
)brace
comma
(brace
id|AFMT_S16_BE
comma
l_int|6
)brace
comma
(brace
id|AFMT_S8
comma
l_int|0
)brace
comma
(brace
id|AFMT_U16_LE
comma
l_int|0
)brace
comma
(brace
id|AFMT_U16_BE
comma
l_int|0
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|n
op_assign
r_sizeof
(paren
id|format2bits
)paren
op_div
r_sizeof
(paren
r_struct
id|format_tbl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|arg
op_amp
id|ad_format_mask
(braket
id|devc-&gt;mode
)braket
)paren
)paren
id|arg
op_assign
id|AFMT_U8
suffix:semicolon
id|devc-&gt;audio_format
op_assign
id|arg
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|format2bits
(braket
id|i
)braket
dot
id|format
op_eq
id|arg
)paren
(brace
r_if
c_cond
(paren
(paren
id|devc-&gt;format_bits
op_assign
id|format2bits
(braket
id|i
)braket
dot
id|bits
)paren
op_eq
l_int|0
)paren
r_return
id|devc-&gt;audio_format
op_assign
id|AFMT_U8
suffix:semicolon
multiline_comment|/* Was not supported */
r_return
id|arg
suffix:semicolon
)brace
multiline_comment|/* Still hanging here. Something must be terribly wrong */
id|devc-&gt;format_bits
op_assign
l_int|0
suffix:semicolon
r_return
id|devc-&gt;audio_format
op_assign
id|AFMT_U8
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_ioctl
id|ad1848_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
comma
r_int
id|local
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SOUND_PCM_WRITE_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|set_speed
(paren
id|devc
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|set_speed
(paren
id|devc
comma
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|devc-&gt;speed
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|devc-&gt;speed
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|set_channels
(paren
id|devc
comma
(paren
r_int
)paren
id|arg
op_plus
l_int|1
)paren
op_minus
l_int|1
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|set_channels
(paren
id|devc
comma
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
op_plus
l_int|1
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|set_channels
(paren
id|devc
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|set_channels
(paren
id|devc
comma
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|devc-&gt;channels
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|devc-&gt;channels
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SAMPLESIZE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|set_format
(paren
id|devc
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|set_format
(paren
id|devc
comma
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|devc-&gt;audio_format
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|devc-&gt;audio_format
)paren
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_output_block
id|ad1848_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|dma_restart
)paren
(brace
r_int
r_int
id|flags
comma
id|cnt
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;audio_format
op_eq
id|AFMT_IMA_ADPCM
)paren
(brace
id|cnt
op_div_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|devc-&gt;audio_format
op_amp
(paren
id|AFMT_S16_LE
op_or
id|AFMT_S16_BE
)paren
)paren
multiline_comment|/* 16 bit data */
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;channels
OG
l_int|1
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;irq_mode
op_amp
id|PCM_ENABLE_OUTPUT
op_logical_and
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DMA_AUTOMODE
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|devc-&gt;xfer_count
)paren
(brace
id|devc-&gt;irq_mode
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Auto DMA mode on. No need to react&n;&t;&t;&t;&t; */
)brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_restart
)paren
(brace
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Playback disable */
multiline_comment|/* ad1848_halt (dev); */
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
)brace
id|ad_write
(paren
id|devc
comma
l_int|15
comma
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|14
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_unmute
(paren
id|devc
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
id|cnt
suffix:semicolon
id|devc-&gt;irq_mode
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_start_input
id|ad1848_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|dma_restart
)paren
(brace
r_int
r_int
id|flags
comma
id|cnt
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;audio_format
op_eq
id|AFMT_IMA_ADPCM
)paren
(brace
id|cnt
op_div_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|devc-&gt;audio_format
op_amp
(paren
id|AFMT_S16_LE
op_or
id|AFMT_S16_BE
)paren
)paren
multiline_comment|/* 16 bit data */
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;channels
OG
l_int|1
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;irq_mode
op_amp
id|PCM_ENABLE_INPUT
op_logical_and
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|flags
op_amp
id|DMA_AUTOMODE
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|devc-&gt;xfer_count
)paren
(brace
id|devc-&gt;irq_mode
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Auto DMA mode on. No need to react&n;&t;&t;&t;&t; */
)brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_restart
)paren
(brace
multiline_comment|/* ad1848_halt (dev); */
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Capture disable */
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MD_1848
op_logical_or
op_logical_neg
id|devc-&gt;dual_dma
)paren
multiline_comment|/* Single DMA channel mode */
(brace
id|ad_write
(paren
id|devc
comma
l_int|15
comma
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|14
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Dual DMA channel mode */
(brace
id|ad_write
(paren
id|devc
comma
l_int|31
comma
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|30
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
id|ad_unmute
(paren
id|devc
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
id|cnt
suffix:semicolon
id|devc-&gt;irq_mode
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
id|devc-&gt;intr_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1848_prepare_for_IO
id|ad1848_prepare_for_IO
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
r_char
id|fs
comma
id|old_fs
comma
id|tmp
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;irq_mode
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|fs
op_assign
id|devc-&gt;speed_bits
op_or
(paren
id|devc-&gt;format_bits
op_lshift
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;channels
OG
l_int|1
)paren
id|fs
op_or_assign
l_int|0x10
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MD_1845
)paren
multiline_comment|/* Use alternate speed select registers */
(brace
id|fs
op_and_assign
l_int|0xf0
suffix:semicolon
multiline_comment|/* Mask off the rate select bits */
id|ad_write
(paren
id|devc
comma
l_int|22
comma
(paren
id|devc-&gt;speed
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed MSB */
id|ad_write
(paren
id|devc
comma
l_int|23
comma
id|devc-&gt;speed
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Speed LSB */
)brace
id|old_fs
op_assign
id|ad_read
(paren
id|devc
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mode
op_ne
id|MD_4232
)paren
r_if
c_cond
(paren
id|fs
op_eq
id|old_fs
)paren
multiline_comment|/* No change */
(brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ad_enter_MCE
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Enables changes to the format select reg */
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MD_4232
)paren
(brace
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_or
l_int|0x30
)paren
suffix:semicolon
)brace
id|ad_write
(paren
id|devc
comma
l_int|8
comma
id|fs
)paren
suffix:semicolon
multiline_comment|/*&n;   * Write to I8 starts resynchronization. Wait until it completes.&n;   */
id|timeout
op_assign
l_int|10000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_decrement
suffix:semicolon
multiline_comment|/*&n;     * If mode == 2 (CS4231), set I28 also. It&squot;s the capture format register.&n;   */
r_if
c_cond
(paren
id|devc-&gt;mode
op_ne
id|MD_1848
)paren
(brace
id|ad_write
(paren
id|devc
comma
l_int|28
comma
id|fs
)paren
suffix:semicolon
multiline_comment|/*&n;         * Write to I28 starts resynchronization. Wait until it completes.&n;       */
id|timeout
op_assign
l_int|10000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OG
l_int|0
op_logical_and
id|inb
(paren
id|devc-&gt;base
)paren
op_eq
l_int|0x80
)paren
id|timeout
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MD_4232
)paren
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_amp
op_complement
l_int|0x30
)paren
suffix:semicolon
id|ad_leave_MCE
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Starts the calibration process.&n;&t;&t;&t;&t; */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|devc-&gt;xfer_count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_SEQUENCER
r_if
c_cond
(paren
id|dev
op_eq
id|timer_installed
op_logical_and
id|devc-&gt;timer_running
)paren
r_if
c_cond
(paren
(paren
id|fs
op_amp
l_int|0x01
)paren
op_ne
(paren
id|old_fs
op_amp
l_int|0x01
)paren
)paren
(brace
id|ad1848_tmr_reprogram
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_reset
id|ad1848_reset
(paren
r_int
id|dev
)paren
(brace
id|ad1848_halt
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_halt
id|ad1848_halt
(paren
r_int
id|dev
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_char
id|bits
op_assign
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
l_int|0x01
)paren
id|ad1848_halt_output
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
l_int|0x02
)paren
id|ad1848_halt_input
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_halt_input
id|ad1848_halt_input
(paren
r_int
id|dev
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|ad_mute
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MD_4232
)paren
multiline_comment|/* Use applied black magic */
(brace
r_int
id|tmout
suffix:semicolon
id|disable_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tmout
op_assign
l_int|0
suffix:semicolon
id|tmout
OL
l_int|100000
suffix:semicolon
id|tmout
op_increment
)paren
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x10
)paren
r_break
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Stop playback */
id|enable_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan1
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Stop capture */
id|outb
(paren
l_int|0
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|outb
(paren
l_int|0
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|devc-&gt;irq_mode
op_and_assign
op_complement
id|PCM_ENABLE_INPUT
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_halt_output
id|ad1848_halt_output
(paren
r_int
id|dev
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|ad_mute
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MD_4232
)paren
multiline_comment|/* Use applied black magic */
(brace
r_int
id|tmout
suffix:semicolon
id|disable_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tmout
op_assign
l_int|0
suffix:semicolon
id|tmout
OL
l_int|100000
suffix:semicolon
id|tmout
op_increment
)paren
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|11
)paren
op_amp
l_int|0x10
)paren
r_break
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Stop playback */
id|enable_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan1
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Stop playback */
id|outb
(paren
l_int|0
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|outb
(paren
l_int|0
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
id|devc-&gt;irq_mode
op_and_assign
op_complement
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_trigger
id|ad1848_trigger
(paren
r_int
id|dev
comma
r_int
id|state
)paren
(brace
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|state
op_and_assign
id|devc-&gt;irq_mode
suffix:semicolon
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x03
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|PCM_ENABLE_INPUT
)paren
id|tmp
op_or_assign
l_int|0x02
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|PCM_ENABLE_OUTPUT
)paren
id|tmp
op_or_assign
l_int|0x01
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|tmp
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_int
DECL|function|ad1848_detect
id|ad1848_detect
(paren
r_int
id|io_base
comma
r_int
op_star
id|ad_flags
comma
r_int
op_star
id|osp
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
op_amp
id|dev_info
(braket
id|nr_ad1848_devs
)braket
suffix:semicolon
r_int
r_char
id|tmp1
op_assign
l_int|0xff
comma
id|tmp2
op_assign
l_int|0xff
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect(%x)&bslash;n&quot;
comma
id|io_base
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
)paren
op_star
id|ad_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nr_ad1848_devs
op_ge
id|MAX_AUDIO_DEV
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step 0&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
(paren
id|io_base
comma
l_int|4
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;&bslash;n&bslash;nad1848.c: Port %x not free.&bslash;n&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|devc-&gt;base
op_assign
id|io_base
suffix:semicolon
id|devc-&gt;irq_ok
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;timer_running
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;MCE_bit
op_assign
l_int|0x40
suffix:semicolon
id|devc-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;chip_name
op_assign
l_string|&quot;AD1848&quot;
suffix:semicolon
id|devc-&gt;mode
op_assign
id|MD_1848
suffix:semicolon
multiline_comment|/* AD1848 or CS4248 */
id|devc-&gt;osp
op_assign
id|osp
suffix:semicolon
id|devc-&gt;debug_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;     * Check that the I/O address is in use.&n;     *&n;     * The bit 0x80 of the base I/O port is known to be 0 after the&n;     * chip has performed it&squot;s power on initialization. Just assume&n;     * this has happened before the OS is starting.&n;     *&n;     * If the I/O address is unused, it typically returns 0xff.&n;   */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step A&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
(paren
id|devc-&gt;base
)paren
op_amp
l_int|0x80
)paren
op_ne
l_int|0x00
)paren
multiline_comment|/* Not a AD1848 */
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step A (%02x)&bslash;n&quot;
comma
id|inb
(paren
id|devc-&gt;base
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848: regs: &quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|DDB
(paren
id|printk
(paren
l_string|&quot;%02x &quot;
comma
id|ad_read
(paren
id|devc
comma
id|i
)paren
)paren
)paren
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;     * Test if it&squot;s possible to change contents of the indirect registers.&n;     * Registers 0 and 1 are ADC volume registers. The bit 0x10 is read only&n;     * so try to avoid using it.&n;   */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step B&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|1
comma
l_int|0x45
)paren
suffix:semicolon
multiline_comment|/* 0x55 with bit 0x10 clear */
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|0
)paren
)paren
op_ne
l_int|0xaa
op_logical_or
(paren
id|tmp2
op_assign
id|ad_read
(paren
id|devc
comma
l_int|1
)paren
)paren
op_ne
l_int|0x45
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step B (%x/%x)&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step C&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|0
comma
l_int|0x45
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|1
comma
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|0
)paren
)paren
op_ne
l_int|0x45
op_logical_or
(paren
id|tmp2
op_assign
id|ad_read
(paren
id|devc
comma
l_int|1
)paren
)paren
op_ne
l_int|0xaa
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step C (%x/%x)&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * The indirect register I12 has some read only bits. Lets&n;     * try to change them.&n;   */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step D&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|12
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|12
comma
(paren
op_complement
id|tmp
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x0f
)paren
op_ne
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|12
)paren
)paren
op_amp
l_int|0x0f
)paren
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step D (%x)&bslash;n&quot;
comma
id|tmp1
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * NOTE! Last 4 bits of the reg I12 tell the chip revision.&n;     *   0x01=RevB and 0x0A=RevC.&n;   */
multiline_comment|/*&n;     * The original AD1848/CS4248 has just 15 indirect registers. This means&n;     * that I0 and I16 should return the same value (etc.).&n;     * Ensure that the Mode2 enable bit of I12 is 0. Otherwise this test fails&n;     * with CS4231.&n;   */
multiline_comment|/*&n;     * Try to switch the chip to mode2 (CS4231) by setting the MODE2 bit (0x40).&n;     * The bit 0x80 is always 1 in CS4248 and CS4231.&n;   */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step G&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|12
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Set mode2, clear 0x80 */
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp1
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|ad_flags
)paren
op_star
id|ad_flags
op_or_assign
id|AD_F_CS4248
suffix:semicolon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4248&quot;
suffix:semicolon
multiline_comment|/* Our best knowledge just now */
)brace
r_if
c_cond
(paren
(paren
id|tmp1
op_amp
l_int|0xc0
)paren
op_eq
(paren
l_int|0x80
op_or
l_int|0x40
)paren
)paren
(brace
multiline_comment|/*&n;         *      CS4231 detected - is it?&n;         *&n;         *      Verify that setting I0 doesn&squot;t change I16.&n;       */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step H&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set I16 to known value */
id|ad_write
(paren
id|devc
comma
l_int|0
comma
l_int|0x45
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
)paren
op_ne
l_int|0x45
)paren
multiline_comment|/* No change -&gt; CS4231? */
(brace
id|ad_write
(paren
id|devc
comma
l_int|0
comma
l_int|0xaa
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
)paren
op_eq
l_int|0xaa
)paren
multiline_comment|/* Rotten bits? */
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848 detect error - step H(%x)&bslash;n&quot;
comma
id|tmp1
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;     * Verify that some bits of I25 are read only.&n;&t;   */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step I&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tmp1
op_assign
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
suffix:semicolon
multiline_comment|/* Original bits */
id|ad_write
(paren
id|devc
comma
l_int|25
comma
op_complement
id|tmp1
)paren
suffix:semicolon
multiline_comment|/* Invert all bits */
r_if
c_cond
(paren
(paren
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
op_amp
l_int|0xe7
)paren
op_eq
(paren
id|tmp1
op_amp
l_int|0xe7
)paren
)paren
(brace
r_int
id|id
suffix:semicolon
multiline_comment|/*&n;&t;       *      It&squot;s at least CS4231&n;&t;       */
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4231&quot;
suffix:semicolon
id|devc-&gt;mode
op_assign
id|MD_4231
suffix:semicolon
multiline_comment|/*&n;&t;       * It could be an AD1845 or CS4231A as well.&n;&t;       * CS4231 and AD1845 report the same revision info in I25&n;&t;       * while the CS4231A reports different.&n;&t;       */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step I&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|id
op_assign
id|ad_read
(paren
id|devc
comma
l_int|25
)paren
op_amp
l_int|0xe7
suffix:semicolon
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
l_int|0xa0
suffix:colon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4231A&quot;
suffix:semicolon
id|devc-&gt;mode
op_assign
id|MD_4231A
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xa2
suffix:colon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4232&quot;
suffix:semicolon
id|devc-&gt;mode
op_assign
id|MD_4232
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xb2
suffix:colon
id|devc-&gt;chip_name
op_assign
l_string|&quot;CS4232A&quot;
suffix:semicolon
id|devc-&gt;mode
op_assign
id|MD_4232
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x80
suffix:colon
(brace
multiline_comment|/* &n;&t;&t;     * It must be a CS4231 or AD1845. The register I23 of&n;&t;&t;     * CS4231 is undefined and it appears to be read only.&n;&t;&t;     * AD1845 uses I23 for setting sample rate. Assume&n;&t;&t;     * the chip is AD1845 if I23 is changeable.&n;&t;&t;     */
r_int
r_char
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|23
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|23
comma
op_complement
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|23
)paren
op_ne
id|tmp
)paren
multiline_comment|/* AD1845 ? */
(brace
id|devc-&gt;chip_name
op_assign
l_string|&quot;AD1845&quot;
suffix:semicolon
id|devc-&gt;mode
op_assign
id|MD_1845
suffix:semicolon
)brace
id|ad_write
(paren
id|devc
comma
l_int|23
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore */
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Assume CS4231 */
id|devc-&gt;mode
op_assign
id|MD_4231
suffix:semicolon
)brace
)brace
id|ad_write
(paren
id|devc
comma
l_int|25
comma
id|tmp1
)paren
suffix:semicolon
multiline_comment|/* Restore bits */
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step K&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - step L&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;mode
op_ne
id|MD_1848
)paren
op_star
id|ad_flags
op_or_assign
id|AD_F_CS4231
suffix:semicolon
)brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;ad1848_detect() - Detected OK&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|ad1848_init
id|ad1848_init
(paren
r_char
op_star
id|name
comma
r_int
id|io_base
comma
r_int
id|irq
comma
r_int
id|dma_playback
comma
r_int
id|dma_capture
comma
r_int
id|share_dma
comma
r_int
op_star
id|osp
)paren
(brace
multiline_comment|/*&n;     * NOTE! If irq &lt; 0, there is another driver which has allocated the IRQ&n;     *   so that this driver doesn&squot;t need to allocate/deallocate it.&n;     *   The actually used IRQ is ABS(irq).&n;   */
multiline_comment|/*&n;     * Initial values for the indirect registers of CS4248/AD1848.&n;   */
r_static
r_int
id|init_values
(braket
)braket
op_assign
(brace
l_int|0xa8
comma
l_int|0xa8
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x0c
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x8a
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/* Positions 16 to 31 just for CS4231 */
l_int|0x80
comma
l_int|0x00
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_int
id|i
comma
id|my_dev
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
op_amp
id|dev_info
(braket
id|nr_ad1848_devs
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ad1848_detect
(paren
id|io_base
comma
l_int|NULL
comma
id|osp
)paren
)paren
r_return
suffix:semicolon
id|request_region
(paren
id|devc-&gt;base
comma
l_int|4
comma
id|devc-&gt;chip_name
)paren
suffix:semicolon
id|devc-&gt;irq
op_assign
(paren
id|irq
OG
l_int|0
)paren
ques
c_cond
id|irq
suffix:colon
l_int|0
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;osp
op_assign
id|osp
suffix:semicolon
r_if
c_cond
(paren
id|nr_ad1848_devs
op_ne
l_int|0
)paren
(brace
id|memcpy
(paren
(paren
r_char
op_star
)paren
op_amp
id|ad1848_pcm_operations
(braket
id|nr_ad1848_devs
)braket
comma
(paren
r_char
op_star
)paren
op_amp
id|ad1848_pcm_operations
(braket
l_int|0
)braket
comma
r_sizeof
(paren
r_struct
id|audio_operations
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|ad_write
(paren
id|devc
comma
id|i
comma
id|init_values
(braket
id|i
)braket
)paren
suffix:semicolon
id|ad_mute
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Initialize some variables */
id|ad_unmute
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* Leave it unmuted now */
r_if
c_cond
(paren
id|devc-&gt;mode
OG
id|MD_1848
)paren
(brace
r_if
c_cond
(paren
id|dma_capture
op_eq
id|dma_playback
op_logical_or
id|dma_capture
op_eq
op_minus
l_int|1
op_logical_or
id|dma_playback
op_eq
op_minus
l_int|1
)paren
(brace
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_or
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Single DMA mode */
id|ad1848_pcm_operations
(braket
id|nr_ad1848_devs
)braket
dot
id|flags
op_and_assign
op_complement
id|DMA_DUPLEX
suffix:semicolon
)brace
r_else
(brace
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_amp
op_complement
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Dual DMA mode */
id|ad1848_pcm_operations
(braket
id|nr_ad1848_devs
)braket
dot
id|flags
op_or_assign
id|DMA_DUPLEX
suffix:semicolon
)brace
id|ad_write
(paren
id|devc
comma
l_int|12
comma
id|ad_read
(paren
id|devc
comma
l_int|12
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Mode2 = enabled */
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|ad_write
(paren
id|devc
comma
id|i
comma
id|init_values
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MD_1845
)paren
id|ad_write
(paren
id|devc
comma
l_int|27
comma
id|ad_read
(paren
id|devc
comma
l_int|27
)paren
op_or
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* Alternate freq select enabled */
)brace
r_else
(brace
id|ad1848_pcm_operations
(braket
id|nr_ad1848_devs
)braket
dot
id|flags
op_and_assign
op_complement
id|DMA_DUPLEX
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|9
comma
id|ad_read
(paren
id|devc
comma
l_int|9
)paren
op_or
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Single DMA mode */
)brace
id|outb
(paren
l_int|0
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear pending interrupts */
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
op_logical_and
id|name
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
id|sprintf
(paren
id|ad1848_pcm_operations
(braket
id|nr_ad1848_devs
)braket
dot
id|name
comma
l_string|&quot;%s (%s)&quot;
comma
id|name
comma
id|devc-&gt;chip_name
)paren
suffix:semicolon
r_else
id|sprintf
(paren
id|ad1848_pcm_operations
(braket
id|nr_ad1848_devs
)braket
dot
id|name
comma
l_string|&quot;Generic audio codec (%s)&quot;
comma
id|devc-&gt;chip_name
)paren
suffix:semicolon
id|conf_printf2
(paren
id|ad1848_pcm_operations
(braket
id|nr_ad1848_devs
)braket
dot
id|name
comma
id|devc-&gt;base
comma
id|devc-&gt;irq
comma
id|dma_playback
comma
id|dma_capture
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_audiodevs
OL
id|MAX_AUDIO_DEV
)paren
(brace
id|audio_devs
(braket
id|my_dev
op_assign
id|num_audiodevs
op_increment
)braket
op_assign
op_amp
id|ad1848_pcm_operations
(braket
id|nr_ad1848_devs
)braket
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
(brace
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|devc
op_assign
id|devc
suffix:semicolon
id|irq2dev
(braket
id|irq
)braket
op_assign
id|devc-&gt;dev_no
op_assign
id|my_dev
suffix:semicolon
r_if
c_cond
(paren
id|snd_set_irq_handler
(paren
id|devc-&gt;irq
comma
id|ad1848_interrupt
comma
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|name
comma
id|devc-&gt;osp
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;ad1848: IRQ in use&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef NO_IRQ_TEST
r_if
c_cond
(paren
id|devc-&gt;mode
op_ne
id|MD_1848
)paren
(brace
r_int
id|x
suffix:semicolon
r_int
r_char
id|tmp
op_assign
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
suffix:semicolon
id|devc-&gt;timer_ticks
op_assign
l_int|0
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|21
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Timer msb */
id|ad_write
(paren
id|devc
comma
l_int|20
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* Timer lsb */
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Enable timer */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
l_int|100000
op_logical_and
id|devc-&gt;timer_ticks
op_eq
l_int|0
suffix:semicolon
id|x
op_increment
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|tmp
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Disable timer */
r_if
c_cond
(paren
id|devc-&gt;timer_ticks
op_eq
l_int|0
)paren
id|printk
(paren
l_string|&quot;[IRQ conflict???]&quot;
)paren
suffix:semicolon
r_else
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Couldn&squot;t test. assume it&squot;s OK */
macro_line|#else
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
id|irq2dev
(braket
op_minus
id|irq
)braket
op_assign
id|devc-&gt;dev_no
op_assign
id|my_dev
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan1
op_assign
id|dma_playback
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan2
op_assign
id|dma_capture
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|buffsize
op_assign
id|DSP_BUFFSIZE
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|devc
op_assign
id|devc
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|format_mask
op_assign
id|ad_format_mask
(braket
id|devc-&gt;mode
)braket
suffix:semicolon
id|nr_ad1848_devs
op_increment
suffix:semicolon
macro_line|#ifdef CONFIG_SEQUENCER
r_if
c_cond
(paren
id|devc-&gt;mode
op_ne
id|MD_1848
op_logical_and
id|devc-&gt;mode
op_ne
id|MD_1845
op_logical_and
id|devc-&gt;irq_ok
)paren
id|ad1848_tmr_install
(paren
id|my_dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|share_dma
)paren
(brace
r_if
c_cond
(paren
id|sound_alloc_dma
(paren
id|dma_playback
comma
l_string|&quot;Sound System&quot;
)paren
)paren
id|printk
(paren
l_string|&quot;ad1848.c: Can&squot;t allocate DMA%d&bslash;n&quot;
comma
id|dma_playback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_capture
op_ne
id|dma_playback
)paren
r_if
c_cond
(paren
id|sound_alloc_dma
(paren
id|dma_capture
comma
l_string|&quot;Sound System (capture)&quot;
)paren
)paren
id|printk
(paren
l_string|&quot;ad1848.c: Can&squot;t allocate DMA%d&bslash;n&quot;
comma
id|dma_capture
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;         * Toggle the MCE bit. It completes the initialization phase.&n;       */
id|ad_enter_MCE
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* In case the bit was off */
id|ad_leave_MCE
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_mixers
OL
id|MAX_MIXER_DEV
)paren
(brace
id|mixer2codec
(braket
id|num_mixers
)braket
op_assign
id|my_dev
op_plus
l_int|1
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|mixer_dev
op_assign
id|num_mixers
suffix:semicolon
id|mixer_devs
(braket
id|num_mixers
op_increment
)braket
op_assign
op_amp
id|ad1848_mixer_operations
suffix:semicolon
id|ad1848_mixer_reset
(paren
id|devc
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
(paren
l_string|&quot;AD1848: Too many PCM devices available&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_void
DECL|function|ad1848_unload
id|ad1848_unload
(paren
r_int
id|io_base
comma
r_int
id|irq
comma
r_int
id|dma_playback
comma
r_int
id|dma_capture
comma
r_int
id|share_dma
)paren
(brace
r_int
id|i
comma
id|dev
op_assign
l_int|0
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|devc
op_eq
l_int|NULL
op_logical_and
id|i
OL
id|nr_ad1848_devs
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|dev_info
(braket
id|i
)braket
dot
id|base
op_eq
id|io_base
)paren
(brace
id|devc
op_assign
op_amp
id|dev_info
(braket
id|i
)braket
suffix:semicolon
id|dev
op_assign
id|devc-&gt;dev_no
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc
op_ne
l_int|NULL
)paren
(brace
id|release_region
(paren
id|devc-&gt;base
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|share_dma
)paren
(brace
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
id|snd_release_irq
(paren
id|devc-&gt;irq
)paren
suffix:semicolon
id|sound_free_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan2
op_ne
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan1
)paren
id|sound_free_dma
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan2
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
(paren
l_string|&quot;ad1848: Can&squot;t find device to be unloaded. Base=%x&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
)brace
r_void
DECL|function|ad1848_interrupt
id|ad1848_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|ad1848_info
op_star
id|devc
suffix:semicolon
r_int
id|dev
suffix:semicolon
r_int
id|alt_stat
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|irq
template_param
l_int|15
)paren
(brace
id|dev
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|dev
op_assign
id|irq2dev
(braket
id|irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_audiodevs
)paren
(brace
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
OL
l_int|17
suffix:semicolon
id|irq
op_increment
)paren
r_if
c_cond
(paren
id|irq2dev
(braket
id|irq
)braket
op_ne
op_minus
l_int|1
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
l_int|15
)paren
(brace
multiline_comment|/* printk (&quot;ad1848.c: Bogus interrupt %d&bslash;n&quot;, irq); */
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|irq2dev
(braket
id|irq
)braket
suffix:semicolon
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
)brace
r_else
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|status
op_assign
id|inb
(paren
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0x80
)paren
id|printk
(paren
l_string|&quot;ad1848_interrupt: Why?&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x01
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;mode
op_ne
id|MD_1848
)paren
id|alt_stat
op_assign
id|ad_read
(paren
id|devc
comma
l_int|24
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;opened
op_logical_and
id|devc-&gt;irq_mode
op_amp
id|PCM_ENABLE_INPUT
op_logical_and
id|alt_stat
op_amp
l_int|0x20
)paren
(brace
id|DMAbuf_inputintr
(paren
id|dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;opened
op_logical_and
id|devc-&gt;irq_mode
op_amp
id|PCM_ENABLE_OUTPUT
op_logical_and
id|alt_stat
op_amp
l_int|0x10
)paren
(brace
id|DMAbuf_outputintr
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;mode
op_ne
id|MD_1848
op_logical_and
id|alt_stat
op_amp
l_int|0x40
)paren
multiline_comment|/* Timer interrupt */
(brace
id|devc-&gt;timer_ticks
op_increment
suffix:semicolon
macro_line|#ifdef CONFIG_SEQUENCER
r_if
c_cond
(paren
id|timer_installed
op_eq
id|dev
op_logical_and
id|devc-&gt;timer_running
)paren
id|sound_timer_interrupt
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|devc-&gt;mode
op_ne
id|MD_1848
)paren
id|ad_write
(paren
id|devc
comma
l_int|24
comma
id|ad_read
(paren
id|devc
comma
l_int|24
)paren
op_amp
op_complement
id|alt_stat
)paren
suffix:semicolon
multiline_comment|/* Selective ack */
r_else
id|outb
(paren
l_int|0
comma
id|io_Status
(paren
id|devc
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt status */
)brace
multiline_comment|/*&n; * Some extra code for the MS Sound System&n; */
r_void
DECL|function|check_opl3
id|check_opl3
(paren
r_int
id|base
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
macro_line|#ifdef CONFIG_YM3812
r_if
c_cond
(paren
id|check_region
(paren
id|base
comma
l_int|4
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;&bslash;n&bslash;nopl3.c: I/O port %x already in use&bslash;n&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|opl3_detect
(paren
id|base
comma
id|hw_config-&gt;osp
)paren
)paren
r_return
suffix:semicolon
id|opl3_init
(paren
l_int|0
comma
id|base
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
id|request_region
(paren
id|base
comma
l_int|4
comma
l_string|&quot;OPL3/OPL2&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_int
DECL|function|probe_ms_sound
id|probe_ms_sound
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;Entered probe_ms_sound(%x, %d)&bslash;n&quot;
comma
id|hw_config-&gt;io_base
comma
id|hw_config-&gt;card_subtype
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
(paren
id|hw_config-&gt;io_base
comma
l_int|8
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: I/O port conflict&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;card_subtype
op_eq
l_int|1
)paren
multiline_comment|/* Has no IRQ/DMA registers */
(brace
multiline_comment|/* check_opl3(0x388, hw_config); */
r_return
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     * Check if the IO port returns valid signature. The original MS Sound&n;     * system returns 0x04 while some cards (AudioTriX Pro for example)&n;     * return 0x00 or 0x0f.&n;   */
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
)paren
op_eq
l_int|0xff
)paren
multiline_comment|/* Bus float */
(brace
r_int
id|ret
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;I/O address is inactive (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x04
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x0f
op_logical_and
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x00
)paren
(brace
r_int
id|ret
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;No MSS signature detected on port 0x%x (0x%x)&bslash;n&quot;
comma
id|hw_config-&gt;io_base
comma
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
)paren
)paren
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;Trying to detect codec anyway but IRQ/DMA may not work&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|11
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Bad IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_ne
l_int|0
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|1
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|3
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Bad DMA %d&bslash;n&quot;
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * Check that DMA0 is not in use with a 8 bit board.&n;   */
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_eq
l_int|0
op_logical_and
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Can&squot;t use DMA0 with a 8 bit card/slot&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|7
op_logical_and
id|hw_config-&gt;irq
op_ne
l_int|9
op_logical_and
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Can&squot;t use IRQ%d with a 8 bit card/slot&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
)brace
r_int
DECL|function|attach_ms_sound
id|attach_ms_sound
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_static
r_char
id|interrupt_bits
(braket
l_int|12
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x08
comma
op_minus
l_int|1
comma
l_int|0x10
comma
l_int|0x18
comma
l_int|0x20
)brace
suffix:semicolon
r_char
id|bits
suffix:semicolon
r_static
r_char
id|dma_bits
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|0
comma
l_int|3
)brace
suffix:semicolon
r_int
id|config_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|0
suffix:semicolon
r_int
id|version_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|3
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
)paren
r_return
id|mem_start
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;card_subtype
op_eq
l_int|1
)paren
multiline_comment|/* Has no IRQ/DMA registers */
(brace
id|ad1848_init
(paren
l_string|&quot;MS Sound System&quot;
comma
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
comma
l_int|0
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
id|request_region
(paren
id|hw_config-&gt;io_base
comma
l_int|4
comma
l_string|&quot;WSS config&quot;
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
multiline_comment|/*&n;     * Set the IRQ and DMA addresses.&n;   */
id|bits
op_assign
id|interrupt_bits
(braket
id|hw_config-&gt;irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
op_minus
l_int|1
)paren
r_return
id|mem_start
suffix:semicolon
id|outb
(paren
id|bits
op_or
l_int|0x40
comma
id|config_port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
(paren
id|version_port
)paren
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
id|printk
(paren
l_string|&quot;[IRQ Conflict?]&quot;
)paren
suffix:semicolon
id|outb
(paren
id|bits
op_or
id|dma_bits
(braket
id|hw_config-&gt;dma
)braket
comma
id|config_port
)paren
suffix:semicolon
multiline_comment|/* Write IRQ+DMA setup */
id|ad1848_init
(paren
l_string|&quot;MS Sound System&quot;
comma
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma
comma
l_int|0
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
id|request_region
(paren
id|hw_config-&gt;io_base
comma
l_int|4
comma
l_string|&quot;WSS config&quot;
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_void
DECL|function|unload_ms_sound
id|unload_ms_sound
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|ad1848_unload
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma
comma
l_int|0
)paren
suffix:semicolon
id|release_region
(paren
id|hw_config-&gt;io_base
comma
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * WSS compatible PnP codec support&n; */
r_int
DECL|function|probe_pnp_ad1848
id|probe_pnp_ad1848
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_return
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
comma
l_int|NULL
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
)brace
r_int
DECL|function|attach_pnp_ad1848
id|attach_pnp_ad1848
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|ad1848_init
(paren
id|hw_config-&gt;name
comma
id|hw_config-&gt;io_base
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
comma
l_int|0
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_void
DECL|function|unload_pnp_ad1848
id|unload_pnp_ad1848
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|ad1848_unload
(paren
id|hw_config-&gt;io_base
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
comma
l_int|0
)paren
suffix:semicolon
id|release_region
(paren
id|hw_config-&gt;io_base
comma
l_int|4
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SEQUENCER
multiline_comment|/*&n; * Timer stuff (for /dev/music).&n; */
DECL|variable|current_interval
r_static
r_int
r_int
id|current_interval
op_assign
l_int|0
suffix:semicolon
r_static
r_int
r_int
DECL|function|ad1848_tmr_start
id|ad1848_tmr_start
(paren
r_int
id|dev
comma
r_int
r_int
id|usecs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|xtal_nsecs
suffix:semicolon
multiline_comment|/* nanoseconds per xtal oscillator tick */
r_int
r_int
id|divider
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Length of the timer interval (in nanoseconds) depends on the&n; * selected crystal oscillator. Check this from bit 0x01 of I8.&n; *&n; * AD1845 has just one oscillator which has cycle time of 10.050 us&n; * (when a 24.576 MHz xtal oscillator is used).&n; *&n; * Convert requested interval to nanoseconds before computing&n; * the timer divider.&n; */
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MD_1845
)paren
id|xtal_nsecs
op_assign
l_int|10050
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ad_read
(paren
id|devc
comma
l_int|8
)paren
op_amp
l_int|0x01
)paren
id|xtal_nsecs
op_assign
l_int|9920
suffix:semicolon
r_else
id|xtal_nsecs
op_assign
l_int|9969
suffix:semicolon
id|divider
op_assign
(paren
id|usecs
op_star
l_int|1000
op_plus
id|xtal_nsecs
op_div
l_int|2
)paren
op_div
id|xtal_nsecs
suffix:semicolon
r_if
c_cond
(paren
id|divider
OL
l_int|100
)paren
multiline_comment|/* Don&squot;t allow shorter intervals than about 1ms */
id|divider
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|divider
OG
l_int|65535
)paren
multiline_comment|/* Overflow check */
id|divider
op_assign
l_int|65535
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|21
comma
(paren
id|divider
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Set upper bits */
id|ad_write
(paren
id|devc
comma
l_int|20
comma
id|divider
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Set lower bits */
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* Start the timer */
id|devc-&gt;timer_running
op_assign
l_int|1
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
id|current_interval
op_assign
(paren
id|divider
op_star
id|xtal_nsecs
op_plus
l_int|500
)paren
op_div
l_int|1000
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_tmr_reprogram
id|ad1848_tmr_reprogram
(paren
r_int
id|dev
)paren
(brace
multiline_comment|/*&n; *    Audio driver has changed sampling rate so that a different xtal&n; *      oscillator was selected. We have to reprogram the timer rate.&n; */
id|ad1848_tmr_start
(paren
id|dev
comma
id|current_interval
)paren
suffix:semicolon
id|sound_timer_syncinterval
(paren
id|current_interval
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_tmr_disable
id|ad1848_tmr_disable
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
op_amp
op_complement
l_int|0x40
)paren
suffix:semicolon
id|devc-&gt;timer_running
op_assign
l_int|0
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ad1848_tmr_restart
id|ad1848_tmr_restart
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1848_info
op_star
id|devc
op_assign
(paren
id|ad1848_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|current_interval
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|16
comma
id|ad_read
(paren
id|devc
comma
l_int|16
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
id|devc-&gt;timer_running
op_assign
l_int|1
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|ad1848_tmr
r_static
r_struct
id|sound_lowlev_timer
id|ad1848_tmr
op_assign
(brace
l_int|0
comma
id|ad1848_tmr_start
comma
id|ad1848_tmr_disable
comma
id|ad1848_tmr_restart
)brace
suffix:semicolon
r_static
r_int
DECL|function|ad1848_tmr_install
id|ad1848_tmr_install
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|timer_installed
op_ne
op_minus
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Don&squot;t install another timer */
id|timer_installed
op_assign
id|ad1848_tmr.dev
op_assign
id|dev
suffix:semicolon
id|sound_timer_init
(paren
op_amp
id|ad1848_tmr
comma
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
eof
