DECL|macro|MAD16_OPL4
mdefine_line|#define MAD16_OPL4&t;&t;/* Disable this if you have problems with OPL3 */
multiline_comment|/*&n; * sound/mad16.c&n; *&n; * Initialization code for OPTi MAD16 compatible audio chips. Including&n; *&n; *      OPTi 82C928     MAD16           (replaced by C929)&n; *      OAK OTI-601D    Mozart&n; *      OPTi 82C929     MAD16 Pro&n; *&n; * These audio interface chips don&squot;t prduce sound themselves. They just&n; * connect some other components (OPL-[234] and a WSS compatible codec)&n; * to the PC bus and perform I/O, DMA and IRQ address decoding. There is&n; * also a UART for the MPU-401 mode (not 82C928/Mozart).&n; * The Mozart chip appears to be compatible with the 82C928 (can anybody&n; * confirm this?).&n; *&n; * NOTE! If you want to set CD-ROM address and/or joystick enable, define&n; *       MAD16_CONF in local.h as combination of the following bits:&n; *&n; *      0x01    - joystick disabled&n; *&n; *      CD-ROM type selection (select just one):&n; *      0x00    - none&n; *      0x02    - Sony 31A&n; *      0x04    - Mitsumi&n; *      0x06    - Panasonic (type &quot;LaserMate&quot;, not &quot;SoundBlaster&quot;)&n; *      0x08    - Secondary IDE (address 0x170)&n; *      0x0a    - Primary IDE (address 0x1F0)&n; *      &n; *      For example Mitsumi with joystick disabled = 0x04|0x01 = 0x05&n; *      For example LaserMate (for use with sbpcd) plus joystick = 0x06&n; *      &n; *    MAD16_CDSEL:&n; *      This defaults to CD I/O 0x340, no IRQ and DMA3 &n; *      (DMA5 with Mitsumi or IDE). If you like to change these, define&n; *      MAD16_CDSEL with the following bits:&n; *&n; *      CD-ROM port: 0x00=340, 0x40=330, 0x80=360 or 0xc0=320&n; *      OPL4 select: 0x20=OPL4, 0x00=OPL3&n; *      CD-ROM irq: 0x00=disabled, 0x04=IRQ5, 0x08=IRQ7, 0x0a=IRQ3, 0x10=IRQ9,&n; *                  0x14=IRQ10 and 0x18=IRQ11.&n; *&n; *      CD-ROM DMA (Sony or Panasonic): 0x00=DMA3, 0x01=DMA2, 0x02=DMA1 or 0x03=disabled&n; *   or&n; *      CD-ROM DMA (Mitsumi or IDE):    0x00=DMA5, 0x01=DMA6, 0x02=DMA7 or 0x03=disabled&n; *&n; *      For use with sbpcd, address 0x340, set MAD16_CDSEL to 0x03 or 0x23.&n; *&n; * Copyright by Hannu Savolainen 1995&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_MAD16)
DECL|variable|already_initialized
r_static
r_int
id|already_initialized
op_assign
l_int|0
suffix:semicolon
DECL|macro|C928
mdefine_line|#define C928&t;1
DECL|macro|MOZART
mdefine_line|#define MOZART&t;2
DECL|macro|C929
mdefine_line|#define C929&t;3
multiline_comment|/*&n; *    Registers&n; *&n; *      The MAD16 occupies I/O ports 0xf8d to 0xf93 (fixed locations).&n; *      All ports are inactive by default. They can be activated by&n; *      writing 0xE2 or 0xE3 to the password register. The password is valid&n; *      only until the next I/O read or write.&n; */
DECL|macro|MC1_PORT
mdefine_line|#define MC1_PORT&t;0xf8d&t;/* SB address, CDROM interface type, joystick */
DECL|macro|MC2_PORT
mdefine_line|#define MC2_PORT&t;0xf8e&t;/* CDROM address, IRQ, DMA, plus OPL4 bit */
DECL|macro|MC3_PORT
mdefine_line|#define MC3_PORT&t;0xf8f
DECL|macro|PASSWD_REG
mdefine_line|#define PASSWD_REG&t;0xf8f
DECL|macro|MC4_PORT
mdefine_line|#define MC4_PORT&t;0xf90
DECL|macro|MC5_PORT
mdefine_line|#define MC5_PORT&t;0xf91
DECL|macro|MC6_PORT
mdefine_line|#define MC6_PORT&t;0xf92
DECL|macro|MC7_PORT
mdefine_line|#define MC7_PORT&t;0xf93
DECL|variable|board_type
r_static
r_int
id|board_type
op_assign
id|C928
suffix:semicolon
macro_line|#ifndef DDB
DECL|macro|DDB
mdefine_line|#define DDB(x)
macro_line|#endif
r_static
r_int
r_char
DECL|function|mad_read
id|mad_read
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|board_type
)paren
multiline_comment|/* Output password */
(brace
r_case
id|C928
suffix:colon
r_case
id|MOZART
suffix:colon
id|OUTB
(paren
l_int|0xE2
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C929
suffix:colon
id|OUTB
(paren
l_int|0xE3
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tmp
op_assign
id|INB
(paren
id|port
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
r_static
r_void
DECL|function|mad_write
id|mad_write
(paren
r_int
id|port
comma
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|board_type
)paren
multiline_comment|/* Output password */
(brace
r_case
id|C928
suffix:colon
r_case
id|MOZART
suffix:colon
id|OUTB
(paren
l_int|0xE2
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C929
suffix:colon
id|OUTB
(paren
l_int|0xE3
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|OUTB
(paren
(paren
r_int
r_char
)paren
(paren
id|value
op_amp
l_int|0xff
)paren
comma
id|port
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|detect_mad16
id|detect_mad16
(paren
r_void
)paren
(brace
r_int
r_char
id|tmp
comma
id|tmp2
suffix:semicolon
multiline_comment|/*&n; * Check that reading a register doesn&squot;t return bus float (0xff)&n; * when the card is accessed using password. This may fail in case&n; * the card is in low power mode. Normally at least the power saving mode&n; * bit should be 0.&n; */
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|mad_read
(paren
id|MC1_PORT
)paren
)paren
op_eq
l_int|0xff
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;MC1_PORT returned 0xff&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Now check that the gate is closed on first I/O after writing&n; * the password. (This is how a MAD16 compatible card works).&n; */
r_if
c_cond
(paren
(paren
id|tmp2
op_assign
id|INB
(paren
id|MC1_PORT
)paren
)paren
op_eq
id|tmp
)paren
multiline_comment|/* It didn&squot;t close */
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;MC1_PORT didn&squot;t close after read (0x%02x)&bslash;n&quot;
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
(paren
id|MC1_PORT
comma
id|tmp
op_xor
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* Togge a bit */
r_if
c_cond
(paren
(paren
id|tmp2
op_assign
id|mad_read
(paren
id|MC1_PORT
)paren
)paren
op_ne
(paren
id|tmp
op_xor
l_int|0x80
)paren
)paren
multiline_comment|/* Compare the bit */
(brace
id|mad_write
(paren
id|MC1_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore */
id|DDB
(paren
id|printk
(paren
l_string|&quot;Bit revert test failed (0x%02x, 0x%02x)&bslash;n&quot;
comma
id|tmp
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
(paren
id|MC1_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore */
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Bingo */
)brace
r_int
DECL|function|probe_mad16
id|probe_mad16
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|valid_ports
(braket
)braket
op_assign
(brace
l_int|0x530
comma
l_int|0xe80
comma
l_int|0xf40
comma
l_int|0x604
)brace
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|already_initialized
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n; *    Check that all ports return 0xff (bus float) when no password&n; *      is written to the password register.&n; */
id|DDB
(paren
id|printk
(paren
l_string|&quot;--- Detecting MAD16 / Mozart ---&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#if 0
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf93
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|INB
(paren
id|i
)paren
op_ne
l_int|0xff
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;port 0x%03x != 0xff (0x%02x)&bslash;n&quot;
comma
id|i
comma
id|INB
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *    Then try to detect with the old password&n; */
id|board_type
op_assign
id|C928
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;Detect using password = 0xE2&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
(paren
)paren
)paren
multiline_comment|/* No luck. Try different model */
(brace
id|board_type
op_assign
id|C929
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;Detect using password = 0xE3&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|printk
(paren
l_string|&quot;mad16.c: 82C929 detected???&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
id|model
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|model
op_assign
id|mad_read
(paren
id|MC3_PORT
)paren
)paren
op_amp
l_int|0x03
)paren
op_eq
l_int|0x03
)paren
(brace
id|printk
(paren
l_string|&quot;mad16.c: Mozart detected???&bslash;n&quot;
)paren
suffix:semicolon
id|board_type
op_assign
id|MOZART
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;mad16.c: 82C928 detected???&bslash;n&quot;
)paren
suffix:semicolon
id|board_type
op_assign
id|C928
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf93
suffix:semicolon
id|i
op_increment
)paren
id|DDB
(paren
id|printk
(paren
l_string|&quot;port %03x = %03x&bslash;n&quot;
comma
id|i
comma
id|mad_read
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Set the WSS address&n; */
id|tmp
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Enable WSS, Disable SB */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|3
)paren
multiline_comment|/* Not a valid port */
(brace
id|printk
(paren
l_string|&quot;MAD16/Mozart: Bad WSS base address 0x%x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid_ports
(braket
id|i
)braket
op_eq
id|hw_config-&gt;io_base
)paren
(brace
id|tmp
op_or_assign
id|i
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* WSS port select bits */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Set optional CD-ROM and joystick settings.&n; */
DECL|macro|MAD16_CONF
mdefine_line|#define MAD16_CONF 0x06
DECL|macro|MAD16_CDSEL
mdefine_line|#define MAD16_CDSEL 0x03
macro_line|#ifdef MAD16_CONF
id|tmp
op_or_assign
(paren
(paren
id|MAD16_CONF
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* CD-ROM and joystick bits */
macro_line|#endif
id|mad_write
(paren
id|MC1_PORT
comma
id|tmp
)paren
suffix:semicolon
macro_line|#if defined(MAD16_CONF) &amp;&amp; defined(MAD16_CDSEL)
id|tmp
op_assign
id|MAD16_CDSEL
suffix:semicolon
macro_line|#else
id|tmp
op_assign
l_int|0x03
suffix:semicolon
macro_line|#endif
macro_line|#ifdef MAD16_OPL4
id|tmp
op_or_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* Enable OPL4 access */
macro_line|#endif
id|mad_write
(paren
id|MC2_PORT
comma
id|tmp
)paren
suffix:semicolon
id|mad_write
(paren
id|MC3_PORT
comma
l_int|0xf0
)paren
suffix:semicolon
multiline_comment|/* Disable SB */
r_if
c_cond
(paren
id|board_type
op_eq
id|C929
)paren
(brace
id|mad_write
(paren
id|MC4_PORT
comma
l_int|0xa2
)paren
suffix:semicolon
id|mad_write
(paren
id|MC5_PORT
comma
l_int|0x95
)paren
suffix:semicolon
multiline_comment|/* AD184x mode (0x9f for CS42xx) */
id|mad_write
(paren
id|MC6_PORT
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* Disable MPU401 */
)brace
r_else
(brace
id|mad_write
(paren
id|MC4_PORT
comma
l_int|0x02
)paren
suffix:semicolon
id|mad_write
(paren
id|MC5_PORT
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* AD184x mode (0x12 for CS42xx) */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf93
suffix:semicolon
id|i
op_increment
)paren
id|DDB
(paren
id|printk
(paren
l_string|&quot;port %03x after init = %03x&bslash;n&quot;
comma
id|i
comma
id|mad_read
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
r_return
id|probe_ms_sound
(paren
id|hw_config
)paren
suffix:semicolon
)brace
r_int
DECL|function|attach_mad16
id|attach_mad16
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|already_initialized
op_assign
l_int|1
suffix:semicolon
r_return
id|attach_ms_sound
(paren
id|mem_start
comma
id|hw_config
)paren
suffix:semicolon
)brace
r_int
DECL|function|attach_mad16_mpu
id|attach_mad16_mpu
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
macro_line|#if (!defined(EXCLUDE_MPU401) || !defined(EXCLUDE_MPU_EMU)) &amp;&amp; !defined(EXCLUDE_MIDI)
r_if
c_cond
(paren
op_logical_neg
id|already_initialized
)paren
r_return
id|mem_start
suffix:semicolon
r_return
id|attach_mpu401
(paren
id|mem_start
comma
id|hw_config
)paren
suffix:semicolon
macro_line|#else
r_return
id|mem_start
suffix:semicolon
macro_line|#endif
)brace
r_int
DECL|function|probe_mad16_mpu
id|probe_mad16_mpu
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
macro_line|#if (!defined(EXCLUDE_MPU401) || !defined(EXCLUDE_MPU_EMU)) &amp;&amp; !defined(EXCLUDE_MIDI)
r_static
r_int
id|mpu_attached
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|valid_ports
(braket
)braket
op_assign
(brace
l_int|0x330
comma
l_int|0x320
comma
l_int|0x310
comma
l_int|0x300
)brace
suffix:semicolon
r_static
r_int
id|valid_irqs
(braket
)braket
op_assign
(brace
l_int|9
comma
l_int|10
comma
l_int|5
comma
l_int|7
)brace
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* A variable with secret power */
r_if
c_cond
(paren
op_logical_neg
id|already_initialized
)paren
multiline_comment|/* The MSS port must be initialized first */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpu_attached
)paren
multiline_comment|/* Don&squot;t let them call this twice */
r_return
l_int|0
suffix:semicolon
id|mpu_attached
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|board_type
OL
id|C929
)paren
multiline_comment|/* Early chip. No MPU support */
(brace
id|printk
(paren
l_string|&quot;Mozart and OPTi 82C928 based cards don&squot;t support MPU401. Sorry&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tmp
op_assign
l_int|0x83
suffix:semicolon
multiline_comment|/* MPU-401 enable */
multiline_comment|/*&n; * Set the MPU base bits&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|3
)paren
multiline_comment|/* Out of array bounds */
(brace
id|printk
(paren
l_string|&quot;MAD16 / Mozart: Invalid MIDI port 0x%x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid_ports
(braket
id|i
)braket
op_eq
id|hw_config-&gt;io_base
)paren
(brace
id|tmp
op_or_assign
id|i
op_lshift
l_int|5
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Set the MPU IRQ bits&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|3
)paren
multiline_comment|/* Out of array bounds */
(brace
id|printk
(paren
l_string|&quot;MAD16 / Mozart: Invalid MIDI IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid_irqs
(braket
id|i
)braket
op_eq
id|hw_config-&gt;irq
)paren
(brace
id|tmp
op_or_assign
id|i
op_lshift
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|mad_write
(paren
id|MC6_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Write MPU401 config */
r_return
id|probe_mpu401
(paren
id|hw_config
)paren
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* That&squot;s all folks */
macro_line|#endif
eof
