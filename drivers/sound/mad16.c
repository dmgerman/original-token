multiline_comment|/*&n; * Copyright (C) by Hannu Savolainen 1993-1996&n; *&n; * USS/Lite for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; */
macro_line|#include &lt;linux/config.h&gt;
multiline_comment|/*&n; * sound/mad16.c&n; *&n; * Initialization code for OPTi MAD16 compatible audio chips. Including&n; *&n; *      OPTi 82C928     MAD16           (replaced by C929)&n; *      OAK OTI-601D    Mozart&n; *      OPTi 82C929     MAD16 Pro&n; *      OPTi 82C930&n; *&n; * These audio interface chips don&squot;t produce sound themselves. They just&n; * connect some other components (OPL-[234] and a WSS compatible codec)&n; * to the PC bus and perform I/O, DMA and IRQ address decoding. There is&n; * also a UART for the MPU-401 mode (not 82C928/Mozart).&n; * The Mozart chip appears to be compatible with the 82C928 (can anybody&n; * confirm this?).&n; *&n; * NOTE! If you want to set CD-ROM address and/or joystick enable, define&n; *       MAD16_CONF in local.h as combination of the following bits:&n; *&n; *      0x01    - joystick disabled&n; *&n; *      CD-ROM type selection (select just one):&n; *      0x00    - none&n; *      0x02    - Sony 31A&n; *      0x04    - Mitsumi&n; *      0x06    - Panasonic (type &quot;LaserMate&quot;, not &quot;Sound Blaster&quot;)&n; *      0x08    - Secondary IDE (address 0x170)&n; *      0x0a    - Primary IDE (address 0x1F0)&n; *      &n; *      For example Mitsumi with joystick disabled = 0x04|0x01 = 0x05&n; *      For example LaserMate (for use with sbpcd) plus joystick = 0x06&n; *      &n; *    MAD16_CDSEL:&n; *      This defaults to CD I/O 0x340, no IRQ and DMA3 &n; *      (DMA5 with Mitsumi or IDE). If you like to change these, define&n; *      MAD16_CDSEL with the following bits:&n; *&n; *      CD-ROM port: 0x00=340, 0x40=330, 0x80=360 or 0xc0=320&n; *      OPL4 select: 0x20=OPL4, 0x00=OPL3&n; *      CD-ROM irq: 0x00=disabled, 0x04=IRQ5, 0x08=IRQ7, 0x0a=IRQ3, 0x10=IRQ9,&n; *                  0x14=IRQ10 and 0x18=IRQ11.&n; *&n; *      CD-ROM DMA (Sony or Panasonic): 0x00=DMA3, 0x01=DMA2, 0x02=DMA1 or 0x03=disabled&n; *   or&n; *      CD-ROM DMA (Mitsumi or IDE):    0x00=DMA5, 0x01=DMA6, 0x02=DMA7 or 0x03=disabled&n; *&n; *      For use with sbpcd, address 0x340, set MAD16_CDSEL to 0x03 or 0x23.&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIG_MAD16)
macro_line|#include &quot;sb.h&quot;
DECL|variable|already_initialized
r_static
r_int
id|already_initialized
op_assign
l_int|0
suffix:semicolon
DECL|macro|C928
mdefine_line|#define C928&t;1
DECL|macro|MOZART
mdefine_line|#define MOZART&t;2
DECL|macro|C929
mdefine_line|#define C929&t;3
DECL|macro|C930
mdefine_line|#define C930&t;4
multiline_comment|/*&n; *    Registers&n; *&n; *      The MAD16 occupies I/O ports 0xf8d to 0xf93 (fixed locations).&n; *      All ports are inactive by default. They can be activated by&n; *      writing 0xE2 or 0xE3 to the password register. The password is valid&n; *      only until the next I/O read or write.&n; *&n; *      82C930 uses 0xE4 as the password and indirect addressing to access&n; *      the config registers.&n; */
DECL|macro|MC0_PORT
mdefine_line|#define MC0_PORT&t;0xf8c&t;/* Dummy port */
DECL|macro|MC1_PORT
mdefine_line|#define MC1_PORT&t;0xf8d&t;/* SB address, CD-ROM interface type, joystick */
DECL|macro|MC2_PORT
mdefine_line|#define MC2_PORT&t;0xf8e&t;/* CD-ROM address, IRQ, DMA, plus OPL4 bit */
DECL|macro|MC3_PORT
mdefine_line|#define MC3_PORT&t;0xf8f
DECL|macro|PASSWD_REG
mdefine_line|#define PASSWD_REG&t;0xf8f
DECL|macro|MC4_PORT
mdefine_line|#define MC4_PORT&t;0xf90
DECL|macro|MC5_PORT
mdefine_line|#define MC5_PORT&t;0xf91
DECL|macro|MC6_PORT
mdefine_line|#define MC6_PORT&t;0xf92
DECL|macro|MC7_PORT
mdefine_line|#define MC7_PORT&t;0xf93
DECL|macro|MC8_PORT
mdefine_line|#define MC8_PORT&t;0xf94
DECL|macro|MC9_PORT
mdefine_line|#define MC9_PORT&t;0xf95
DECL|macro|MC10_PORT
mdefine_line|#define MC10_PORT&t;0xf96
DECL|macro|MC11_PORT
mdefine_line|#define MC11_PORT&t;0xf97
DECL|macro|MC12_PORT
mdefine_line|#define MC12_PORT&t;0xf98
DECL|variable|board_type
r_static
r_int
id|board_type
op_assign
id|C928
suffix:semicolon
DECL|variable|mad16_osp
r_static
r_int
op_star
id|mad16_osp
suffix:semicolon
macro_line|#ifndef DDB
DECL|macro|DDB
mdefine_line|#define DDB(x)
macro_line|#endif
r_static
r_int
r_char
DECL|function|mad_read
id|mad_read
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|board_type
)paren
multiline_comment|/* Output password */
(brace
r_case
id|C928
suffix:colon
r_case
id|MOZART
suffix:colon
id|outb
(paren
l_int|0xE2
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C929
suffix:colon
id|outb
(paren
l_int|0xE3
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C930
suffix:colon
multiline_comment|/* outb( 0xE4,  PASSWD_REG); */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|board_type
op_eq
id|C930
)paren
(brace
id|outb
(paren
id|port
op_minus
id|MC0_PORT
comma
l_int|0xe0e
)paren
suffix:semicolon
multiline_comment|/* Write to index reg */
id|tmp
op_assign
id|inb
(paren
l_int|0xe0f
)paren
suffix:semicolon
multiline_comment|/* Read from data reg */
)brace
r_else
id|tmp
op_assign
id|inb
(paren
id|port
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
r_static
r_void
DECL|function|mad_write
id|mad_write
(paren
r_int
id|port
comma
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|board_type
)paren
multiline_comment|/* Output password */
(brace
r_case
id|C928
suffix:colon
r_case
id|MOZART
suffix:colon
id|outb
(paren
l_int|0xE2
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C929
suffix:colon
id|outb
(paren
l_int|0xE3
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C930
suffix:colon
multiline_comment|/* outb( 0xE4,  PASSWD_REG); */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|board_type
op_eq
id|C930
)paren
(brace
id|outb
(paren
id|port
op_minus
id|MC0_PORT
comma
l_int|0xe0e
)paren
suffix:semicolon
multiline_comment|/* Write to index reg */
id|outb
(paren
(paren
r_int
r_char
)paren
(paren
id|value
op_amp
l_int|0xff
)paren
comma
l_int|0xe0f
)paren
suffix:semicolon
)brace
r_else
id|outb
(paren
(paren
r_int
r_char
)paren
(paren
id|value
op_amp
l_int|0xff
)paren
comma
id|port
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|detect_c930
id|detect_c930
(paren
r_void
)paren
(brace
r_int
r_char
id|tmp
op_assign
id|mad_read
(paren
id|MC1_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x06
)paren
op_ne
l_int|0x06
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;Wrong C930 signature (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
multiline_comment|/* return 0; */
)brace
id|mad_write
(paren
id|MC1_PORT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mad_read
(paren
id|MC1_PORT
)paren
op_ne
l_int|0x06
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;Wrong C930 signature2 (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
multiline_comment|/* return 0; */
)brace
id|mad_write
(paren
id|MC1_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore bits */
id|mad_write
(paren
id|MC7_PORT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|mad_read
(paren
id|MC7_PORT
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;MC7 not writable (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
(paren
id|MC7_PORT
comma
l_int|0xcb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|mad_read
(paren
id|MC7_PORT
)paren
)paren
op_ne
l_int|0xcb
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;MC7 not writable2 (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|detect_mad16
id|detect_mad16
(paren
r_void
)paren
(brace
r_int
r_char
id|tmp
comma
id|tmp2
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n; * Check that reading a register doesn&squot;t return bus float (0xff)&n; * when the card is accessed using password. This may fail in case&n; * the card is in low power mode. Normally at least the power saving mode&n; * bit should be 0.&n; */
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|mad_read
(paren
id|MC1_PORT
)paren
)paren
op_eq
l_int|0xff
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;MC1_PORT returned 0xff&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf98
suffix:semicolon
id|i
op_increment
)paren
id|DDB
(paren
id|printk
(paren
l_string|&quot;Port %0x (init value) = %0x&bslash;n&quot;
comma
id|i
comma
id|mad_read
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board_type
op_eq
id|C930
)paren
r_return
id|detect_c930
(paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Now check that the gate is closed on first I/O after writing&n; * the password. (This is how a MAD16 compatible card works).&n; */
r_if
c_cond
(paren
(paren
id|tmp2
op_assign
id|inb
(paren
id|MC1_PORT
)paren
)paren
op_eq
id|tmp
)paren
multiline_comment|/* It didn&squot;t close */
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;MC1_PORT didn&squot;t close after read (0x%02x)&bslash;n&quot;
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
(paren
id|MC1_PORT
comma
id|tmp
op_xor
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* Toggle a bit */
r_if
c_cond
(paren
(paren
id|tmp2
op_assign
id|mad_read
(paren
id|MC1_PORT
)paren
)paren
op_ne
(paren
id|tmp
op_xor
l_int|0x80
)paren
)paren
multiline_comment|/* Compare the bit */
(brace
id|mad_write
(paren
id|MC1_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore */
id|DDB
(paren
id|printk
(paren
l_string|&quot;Bit revert test failed (0x%02x, 0x%02x)&bslash;n&quot;
comma
id|tmp
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
(paren
id|MC1_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore */
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Bingo */
)brace
r_static
r_int
DECL|function|wss_init
id|wss_init
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|ad_flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; *    Verify the WSS parameters&n; */
r_if
c_cond
(paren
id|check_region
(paren
id|hw_config-&gt;io_base
comma
l_int|8
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: I/O port conflict&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
op_amp
id|ad_flags
comma
id|mad16_osp
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;     * Check if the IO port returns valid signature. The original MS Sound&n;     * system returns 0x04 while some cards (AudioTrix Pro for example)&n;     * return 0x00.&n;   */
r_if
c_cond
(paren
(paren
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x04
op_logical_and
(paren
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x00
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;No MSS signature detected on port 0x%x (0x%x)&bslash;n&quot;
comma
id|hw_config-&gt;io_base
comma
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|11
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Bad IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_ne
l_int|0
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|1
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|3
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Bad DMA %d&bslash;n&quot;
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * Check that DMA0 is not in use with a 8 bit board.&n;   */
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_eq
l_int|0
op_logical_and
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Can&squot;t use DMA0 with a 8 bit card/slot&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|7
op_logical_and
id|hw_config-&gt;irq
op_ne
l_int|9
op_logical_and
id|inb
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
(brace
id|printk
(paren
l_string|&quot;MSS: Can&squot;t use IRQ%d with a 8 bit card/slot&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|init_c930
id|init_c930
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|cfg
suffix:semicolon
id|cfg
op_assign
(paren
id|mad_read
(paren
id|MC1_PORT
)paren
op_amp
op_complement
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* mad_write(MC1_PORT, 0); */
r_switch
c_cond
(paren
id|hw_config-&gt;io_base
)paren
(brace
r_case
l_int|0x530
suffix:colon
id|cfg
op_or_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe80
suffix:colon
id|cfg
op_or_assign
l_int|0x10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf40
suffix:colon
id|cfg
op_or_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x604
suffix:colon
id|cfg
op_or_assign
l_int|0x30
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;MAD16: Invalid codec port %x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
(paren
id|MC1_PORT
comma
id|cfg
)paren
suffix:semicolon
multiline_comment|/* MC2 is CD configuration. Don&squot;t touch it. */
id|mad_write
(paren
id|MC3_PORT
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable SB mode IRQ and DMA */
id|mad_write
(paren
id|MC4_PORT
comma
l_int|0x52
)paren
suffix:semicolon
multiline_comment|/* ??? */
id|mad_write
(paren
id|MC5_PORT
comma
l_int|0x3D
)paren
suffix:semicolon
multiline_comment|/* Init it into mode2 */
id|mad_write
(paren
id|MC6_PORT
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Enable WSS, Disable MPU and SB */
id|mad_write
(paren
id|MC7_PORT
comma
l_int|0xCB
)paren
suffix:semicolon
id|mad_write
(paren
id|MC10_PORT
comma
l_int|0x11
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wss_init
(paren
id|hw_config
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n; * A temporary kludge which drops the device back to mode1.&n; * This removes problems with interrupts but disables full duplex.&n; * A better solution should be introduced later.&n; */
id|mad_write
(paren
id|MC5_PORT
comma
l_int|0x1D
)paren
suffix:semicolon
multiline_comment|/* Disable mode2 */
r_return
id|wss_init
(paren
id|hw_config
)paren
suffix:semicolon
)brace
r_int
DECL|function|probe_mad16
id|probe_mad16
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|valid_ports
(braket
)braket
op_assign
(brace
l_int|0x530
comma
l_int|0xe80
comma
l_int|0xf40
comma
l_int|0x604
)brace
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_int
r_char
id|cs4231_mode
op_assign
l_int|0
suffix:semicolon
r_int
id|ad_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|already_initialized
)paren
r_return
l_int|0
suffix:semicolon
id|mad16_osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
multiline_comment|/*&n; *    Check that all ports return 0xff (bus float) when no password&n; *      is written to the password register.&n; */
id|DDB
(paren
id|printk
(paren
l_string|&quot;--- Detecting MAD16 / Mozart ---&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; *    Then try to detect with the old password&n; */
id|board_type
op_assign
id|C928
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;Detect using password = 0xE2&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
(paren
)paren
)paren
multiline_comment|/* No luck. Try different model */
(brace
id|board_type
op_assign
id|C929
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;Detect using password = 0xE3&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|inb
(paren
id|PASSWD_REG
)paren
op_ne
l_int|0xff
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n; * First relocate MC# registers to 0xe0e/0xe0f, disable password &n; */
id|outb
(paren
l_int|0xE4
comma
id|PASSWD_REG
)paren
suffix:semicolon
id|outb
(paren
l_int|0x80
comma
id|PASSWD_REG
)paren
suffix:semicolon
id|board_type
op_assign
id|C930
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;Detect using password = 0xE4&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf93
suffix:semicolon
id|i
op_increment
)paren
id|DDB
(paren
id|printk
(paren
l_string|&quot;port %03x = %02x&bslash;n&quot;
comma
id|i
comma
id|mad_read
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;mad16.c: 82C930 detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|init_c930
(paren
id|hw_config
)paren
suffix:semicolon
)brace
r_else
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;mad16.c: 82C929 detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
r_char
id|model
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|model
op_assign
id|mad_read
(paren
id|MC3_PORT
)paren
)paren
op_amp
l_int|0x03
)paren
op_eq
l_int|0x03
)paren
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;mad16.c: Mozart detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|board_type
op_assign
id|MOZART
suffix:semicolon
)brace
r_else
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;mad16.c: 82C928 detected???&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|board_type
op_assign
id|C928
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf93
suffix:semicolon
id|i
op_increment
)paren
id|DDB
(paren
id|printk
(paren
l_string|&quot;port %03x = %02x&bslash;n&quot;
comma
id|i
comma
id|mad_read
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Set the WSS address&n; */
id|tmp
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Enable WSS, Disable SB */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|3
)paren
multiline_comment|/* Not a valid port */
(brace
id|printk
(paren
l_string|&quot;MAD16/Mozart: Bad WSS base address 0x%x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid_ports
(braket
id|i
)braket
op_eq
id|hw_config-&gt;io_base
)paren
(brace
id|tmp
op_or_assign
id|i
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* WSS port select bits */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Set optional CD-ROM and joystick settings.&n; */
macro_line|#ifdef MAD16_CONF
id|tmp
op_or_assign
(paren
(paren
id|MAD16_CONF
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* CD-ROM and joystick bits */
macro_line|#endif
id|mad_write
(paren
id|MC1_PORT
comma
id|tmp
)paren
suffix:semicolon
macro_line|#if defined(MAD16_CONF) &amp;&amp; defined(MAD16_CDSEL)
id|tmp
op_assign
id|MAD16_CDSEL
suffix:semicolon
macro_line|#else
id|tmp
op_assign
l_int|0x03
suffix:semicolon
macro_line|#endif
macro_line|#ifdef MAD16_OPL4
id|tmp
op_or_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* Enable OPL4 access */
macro_line|#endif
id|mad_write
(paren
id|MC2_PORT
comma
id|tmp
)paren
suffix:semicolon
id|mad_write
(paren
id|MC3_PORT
comma
l_int|0xf0
)paren
suffix:semicolon
multiline_comment|/* Disable SB */
r_if
c_cond
(paren
op_logical_neg
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
op_amp
id|ad_flags
comma
id|mad16_osp
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
op_amp
(paren
id|AD_F_CS4231
op_or
id|AD_F_CS4248
)paren
)paren
id|cs4231_mode
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* CS4248/CS4231 sync delay switch */
r_if
c_cond
(paren
id|board_type
op_eq
id|C929
)paren
(brace
id|mad_write
(paren
id|MC4_PORT
comma
l_int|0xa2
)paren
suffix:semicolon
id|mad_write
(paren
id|MC5_PORT
comma
l_int|0xA5
op_or
id|cs4231_mode
)paren
suffix:semicolon
id|mad_write
(paren
id|MC6_PORT
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* Disable MPU401 */
)brace
r_else
(brace
id|mad_write
(paren
id|MC4_PORT
comma
l_int|0x02
)paren
suffix:semicolon
id|mad_write
(paren
id|MC5_PORT
comma
l_int|0x30
op_or
id|cs4231_mode
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf93
suffix:semicolon
id|i
op_increment
)paren
id|DDB
(paren
id|printk
(paren
l_string|&quot;port %03x after init = %02x&bslash;n&quot;
comma
id|i
comma
id|mad_read
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
id|wss_init
(paren
id|hw_config
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|attach_mad16
id|attach_mad16
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_static
r_char
id|interrupt_bits
(braket
l_int|12
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x08
comma
op_minus
l_int|1
comma
l_int|0x10
comma
l_int|0x18
comma
l_int|0x20
)brace
suffix:semicolon
r_char
id|bits
suffix:semicolon
r_static
r_char
id|dma_bits
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|0
comma
l_int|3
)brace
suffix:semicolon
r_int
id|config_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|0
comma
id|version_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|3
suffix:semicolon
r_int
id|ad_flags
op_assign
l_int|0
comma
id|dma
op_assign
id|hw_config-&gt;dma
comma
id|dma2
op_assign
id|hw_config-&gt;dma2
suffix:semicolon
r_int
r_char
id|dma2_bit
op_assign
l_int|0
suffix:semicolon
id|already_initialized
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ad1848_detect
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
op_amp
id|ad_flags
comma
id|mad16_osp
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;     * Set the IRQ and DMA addresses.&n;   */
id|bits
op_assign
id|interrupt_bits
(braket
id|hw_config-&gt;irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|outb
(paren
id|bits
op_or
l_int|0x40
comma
id|config_port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
(paren
id|version_port
)paren
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
id|printk
(paren
l_string|&quot;[IRQ Conflict?]&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Handle the capture DMA channel&n; */
r_if
c_cond
(paren
id|ad_flags
op_amp
id|AD_F_CS4231
op_logical_and
id|dma2
op_ne
op_minus
l_int|1
op_logical_and
id|dma2
op_ne
id|dma
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|dma
op_eq
l_int|0
op_logical_and
id|dma2
op_eq
l_int|1
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|1
op_logical_and
id|dma2
op_eq
l_int|0
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|3
op_logical_and
id|dma2
op_eq
l_int|0
)paren
)paren
)paren
(brace
multiline_comment|/* Unsupported combination. Try to swap channels */
r_int
id|tmp
op_assign
id|dma
suffix:semicolon
id|dma
op_assign
id|dma2
suffix:semicolon
id|dma2
op_assign
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dma
op_eq
l_int|0
op_logical_and
id|dma2
op_eq
l_int|1
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|1
op_logical_and
id|dma2
op_eq
l_int|0
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|3
op_logical_and
id|dma2
op_eq
l_int|0
)paren
)paren
(brace
id|dma2_bit
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Enable capture DMA */
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;MAD16: Invalid capture DMA&bslash;n&quot;
)paren
suffix:semicolon
id|dma2
op_assign
id|dma
suffix:semicolon
)brace
)brace
r_else
id|dma2
op_assign
id|dma
suffix:semicolon
id|outb
(paren
id|bits
op_or
id|dma_bits
(braket
id|dma
)braket
op_or
id|dma2_bit
comma
id|config_port
)paren
suffix:semicolon
multiline_comment|/* Write IRQ+DMA setup */
id|ad1848_init
(paren
l_string|&quot;MAD16 WSS&quot;
comma
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|dma
comma
id|dma2
comma
l_int|0
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
id|request_region
(paren
id|hw_config-&gt;io_base
comma
l_int|4
comma
l_string|&quot;MAD16 WSS config&quot;
)paren
suffix:semicolon
)brace
r_void
DECL|function|attach_mad16_mpu
id|attach_mad16_mpu
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_if
c_cond
(paren
id|board_type
OL
id|C929
)paren
multiline_comment|/* Early chip. No MPU support. Just SB MIDI */
(brace
macro_line|#ifdef CONFIG_MIDI
r_if
c_cond
(paren
id|mad_read
(paren
id|MC1_PORT
)paren
op_amp
l_int|0x20
)paren
id|hw_config-&gt;io_base
op_assign
l_int|0x240
suffix:semicolon
r_else
id|hw_config-&gt;io_base
op_assign
l_int|0x220
suffix:semicolon
id|hw_config-&gt;name
op_assign
l_string|&quot;Mad16/Mozart&quot;
suffix:semicolon
id|sb_dsp_init
(paren
id|hw_config
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_UART401) &amp;&amp; defined(CONFIG_MIDI)
r_if
c_cond
(paren
op_logical_neg
id|already_initialized
)paren
r_return
suffix:semicolon
id|hw_config-&gt;driver_use_1
op_assign
id|SB_MIDI_ONLY
suffix:semicolon
id|hw_config-&gt;name
op_assign
l_string|&quot;Mad16/Mozart&quot;
suffix:semicolon
id|attach_uart401
(paren
id|hw_config
)paren
suffix:semicolon
macro_line|#endif
)brace
r_int
DECL|function|probe_mad16_mpu
id|probe_mad16_mpu
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
macro_line|#if defined(CONFIG_UART401) &amp;&amp; defined(CONFIG_MIDI)
r_static
r_int
id|mpu_attached
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|valid_ports
(braket
)braket
op_assign
(brace
l_int|0x330
comma
l_int|0x320
comma
l_int|0x310
comma
l_int|0x300
)brace
suffix:semicolon
r_static
r_int
id|valid_irqs
(braket
)braket
op_assign
(brace
l_int|9
comma
l_int|10
comma
l_int|5
comma
l_int|7
)brace
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* A variable with secret power */
r_if
c_cond
(paren
op_logical_neg
id|already_initialized
)paren
multiline_comment|/* The MSS port must be initialized first */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpu_attached
)paren
multiline_comment|/* Don&squot;t let them call this twice */
r_return
l_int|0
suffix:semicolon
id|mpu_attached
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|board_type
OL
id|C929
)paren
multiline_comment|/* Early chip. No MPU support. Just SB MIDI */
(brace
macro_line|#ifdef CONFIG_MIDI
r_int
r_char
id|tmp
suffix:semicolon
id|tmp
op_assign
id|mad_read
(paren
id|MC3_PORT
)paren
suffix:semicolon
multiline_comment|/* &n;       * MAD16 SB base is defined by the WSS base. It cannot be changed &n;       * alone.&n;       * Ignore configured I/O base. Use the active setting. &n;       */
r_if
c_cond
(paren
id|mad_read
(paren
id|MC1_PORT
)paren
op_amp
l_int|0x20
)paren
id|hw_config-&gt;io_base
op_assign
l_int|0x240
suffix:semicolon
r_else
id|hw_config-&gt;io_base
op_assign
l_int|0x220
suffix:semicolon
r_switch
c_cond
(paren
id|hw_config-&gt;irq
)paren
(brace
r_case
l_int|5
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_or
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
l_int|0x3f
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_or
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;mad16/Mozart: Invalid MIDI IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
(paren
id|MC3_PORT
comma
id|tmp
op_or
l_int|0x04
)paren
suffix:semicolon
id|hw_config-&gt;driver_use_1
op_assign
id|SB_MIDI_ONLY
suffix:semicolon
r_return
id|sb_dsp_detect
(paren
id|hw_config
)paren
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
id|tmp
op_assign
id|mad_read
(paren
id|MC6_PORT
)paren
op_amp
l_int|0x83
suffix:semicolon
id|tmp
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* MPU-401 enable */
multiline_comment|/*&n; * Set the MPU base bits&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|3
)paren
multiline_comment|/* Out of array bounds */
(brace
id|printk
(paren
l_string|&quot;MAD16 / Mozart: Invalid MIDI port 0x%x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid_ports
(braket
id|i
)braket
op_eq
id|hw_config-&gt;io_base
)paren
(brace
id|tmp
op_or_assign
id|i
op_lshift
l_int|5
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Set the MPU IRQ bits&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|3
)paren
multiline_comment|/* Out of array bounds */
(brace
id|printk
(paren
l_string|&quot;MAD16 / Mozart: Invalid MIDI IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid_irqs
(braket
id|i
)braket
op_eq
id|hw_config-&gt;irq
)paren
(brace
id|tmp
op_or_assign
id|i
op_lshift
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|mad_write
(paren
id|MC6_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Write MPU401 config */
r_return
id|probe_uart401
(paren
id|hw_config
)paren
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|unload_mad16
id|unload_mad16
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|ad1848_unload
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
comma
l_int|0
)paren
suffix:semicolon
id|release_region
(paren
id|hw_config-&gt;io_base
comma
l_int|4
)paren
suffix:semicolon
)brace
r_void
DECL|function|unload_mad16_mpu
id|unload_mad16_mpu
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
macro_line|#ifdef CONFIG_MIDI
r_if
c_cond
(paren
id|board_type
OL
id|C929
)paren
multiline_comment|/* Early chip. No MPU support. Just SB MIDI */
(brace
id|sb_dsp_unload
(paren
id|hw_config
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if (defined(CONFIG_UART401) || defined(CONFIG_MPU_EMU)) &amp;&amp; defined(CONFIG_MIDI)
id|unload_uart401
(paren
id|hw_config
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* That&squot;s all folks */
macro_line|#endif
eof
