multiline_comment|/*&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * mad16.c&n; *&n; * Initialization code for OPTi MAD16 compatible audio chips. Including&n; *&n; *      OPTi 82C928     MAD16           (replaced by C929)&n; *      OAK OTI-601D    Mozart&n; *      OAK OTI-605&t;Mozart&t;&t;(later version with MPU401 Midi)&n; *      OPTi 82C929     MAD16 Pro&n; *      OPTi 82C930&n; *      OPTi 82C924&n; *&n; * These audio interface chips don&squot;t produce sound themselves. They just&n; * connect some other components (OPL-[234] and a WSS compatible codec)&n; * to the PC bus and perform I/O, DMA and IRQ address decoding. There is&n; * also a UART for the MPU-401 mode (not 82C928/Mozart).&n; * The Mozart chip appears to be compatible with the 82C928, although later&n; * issues of the card, using the OTI-605 chip, have an MPU-401 compatable Midi&n; * port. This port is configured differently to that of the OPTi audio chips.&n; *&n; *&t;Changes&n; *&t;&n; *&t;Alan Cox&t;&t;Clean up, added module selections.&n; *&n; *&t;A. Wik&t;&t;&t;Added support for Opti924 PnP.&n; *&t;&t;&t;&t;Improved debugging support.&t;16-May-1998&n; *&t;&t;&t;&t;Fixed bug.&t;&t;&t;16-Jun-1998&n; *&n; *      Torsten Duwe            Made Opti924 PnP support non-destructive&n; *                                                             &t;23-Dec-1998&n; *&n; *&t;Paul Grayson&t;&t;Added support for Midi on later Mozart cards.&n; *&t;&t;&t;&t;&t;&t;&t;&t;25-Nov-1999&n; *&t;Christoph Hellwig&t;Adapted to module_init/module_exit.&n; *&t;Arnaldo C. de Melo&t;got rid of attach_uart401       21-Sep-2000&n; *&n; *&t;Pavel Rabel&t;&t;Clean up                           Nov-2000&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;ad1848.h&quot;
macro_line|#include &quot;sb.h&quot;
macro_line|#include &quot;mpu401.h&quot;
DECL|variable|mad16_conf
r_static
r_int
id|mad16_conf
suffix:semicolon
DECL|variable|mad16_cdsel
r_static
r_int
id|mad16_cdsel
suffix:semicolon
DECL|variable|already_initialized
r_static
r_int
id|already_initialized
op_assign
l_int|0
suffix:semicolon
DECL|macro|C928
mdefine_line|#define C928&t;1
DECL|macro|MOZART
mdefine_line|#define MOZART&t;2
DECL|macro|C929
mdefine_line|#define C929&t;3
DECL|macro|C930
mdefine_line|#define C930&t;4
DECL|macro|C924
mdefine_line|#define C924    5
multiline_comment|/*&n; *    Registers&n; *&n; *      The MAD16 occupies I/O ports 0xf8d to 0xf93 (fixed locations).&n; *      All ports are inactive by default. They can be activated by&n; *      writing 0xE2 or 0xE3 to the password register. The password is valid&n; *      only until the next I/O read or write.&n; *&n; *      82C930 uses 0xE4 as the password and indirect addressing to access&n; *      the config registers.&n; */
DECL|macro|MC0_PORT
mdefine_line|#define MC0_PORT&t;0xf8c&t;/* Dummy port */
DECL|macro|MC1_PORT
mdefine_line|#define MC1_PORT&t;0xf8d&t;/* SB address, CD-ROM interface type, joystick */
DECL|macro|MC2_PORT
mdefine_line|#define MC2_PORT&t;0xf8e&t;/* CD-ROM address, IRQ, DMA, plus OPL4 bit */
DECL|macro|MC3_PORT
mdefine_line|#define MC3_PORT&t;0xf8f
DECL|macro|PASSWD_REG
mdefine_line|#define PASSWD_REG&t;0xf8f
DECL|macro|MC4_PORT
mdefine_line|#define MC4_PORT&t;0xf90
DECL|macro|MC5_PORT
mdefine_line|#define MC5_PORT&t;0xf91
DECL|macro|MC6_PORT
mdefine_line|#define MC6_PORT&t;0xf92
DECL|macro|MC7_PORT
mdefine_line|#define MC7_PORT&t;0xf93
DECL|macro|MC8_PORT
mdefine_line|#define MC8_PORT&t;0xf94
DECL|macro|MC9_PORT
mdefine_line|#define MC9_PORT&t;0xf95
DECL|macro|MC10_PORT
mdefine_line|#define MC10_PORT&t;0xf96
DECL|macro|MC11_PORT
mdefine_line|#define MC11_PORT&t;0xf97
DECL|macro|MC12_PORT
mdefine_line|#define MC12_PORT&t;0xf98
DECL|variable|board_type
r_static
r_int
id|board_type
op_assign
id|C928
suffix:semicolon
DECL|variable|mad16_osp
r_static
r_int
op_star
id|mad16_osp
suffix:semicolon
DECL|variable|c931_detected
r_static
r_int
id|c931_detected
suffix:semicolon
multiline_comment|/* minor differences from C930 */
DECL|variable|c924pnp
r_static
r_char
id|c924pnp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &quot;     &quot;           &quot;    C924 */
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* debugging output */
macro_line|#ifdef DDB
DECL|macro|DDB
macro_line|#undef DDB
macro_line|#endif
DECL|macro|DDB
mdefine_line|#define DDB(x) {if (debug) x;}
DECL|function|mad_read
r_static
r_int
r_char
id|mad_read
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|board_type
)paren
multiline_comment|/* Output password */
(brace
r_case
id|C928
suffix:colon
r_case
id|MOZART
suffix:colon
id|outb
c_func
(paren
(paren
l_int|0xE2
)paren
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C929
suffix:colon
id|outb
c_func
(paren
(paren
l_int|0xE3
)paren
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C930
suffix:colon
multiline_comment|/* outb(( 0xE4),  PASSWD_REG); */
r_break
suffix:semicolon
r_case
id|C924
suffix:colon
multiline_comment|/* the c924 has its ports relocated by -128 if&n;&t;&t;&t;   PnP is enabled  -aw */
r_if
c_cond
(paren
op_logical_neg
id|c924pnp
)paren
id|outb
c_func
(paren
(paren
l_int|0xE5
)paren
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
(paren
l_int|0xE5
)paren
comma
id|PASSWD_REG
op_minus
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|board_type
op_eq
id|C930
)paren
(brace
id|outb
c_func
(paren
(paren
id|port
op_minus
id|MC0_PORT
)paren
comma
l_int|0xe0e
)paren
suffix:semicolon
multiline_comment|/* Write to index reg */
id|tmp
op_assign
id|inb
c_func
(paren
l_int|0xe0f
)paren
suffix:semicolon
multiline_comment|/* Read from data reg */
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|c924pnp
)paren
id|tmp
op_assign
id|inb
c_func
(paren
id|port
)paren
suffix:semicolon
r_else
id|tmp
op_assign
id|inb
c_func
(paren
id|port
op_minus
l_int|0x80
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|mad_write
r_static
r_void
id|mad_write
c_func
(paren
r_int
id|port
comma
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|board_type
)paren
multiline_comment|/* Output password */
(brace
r_case
id|C928
suffix:colon
r_case
id|MOZART
suffix:colon
id|outb
c_func
(paren
(paren
l_int|0xE2
)paren
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C929
suffix:colon
id|outb
c_func
(paren
(paren
l_int|0xE3
)paren
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C930
suffix:colon
multiline_comment|/* outb(( 0xE4),  PASSWD_REG); */
r_break
suffix:semicolon
r_case
id|C924
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|c924pnp
)paren
id|outb
c_func
(paren
(paren
l_int|0xE5
)paren
comma
id|PASSWD_REG
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
(paren
l_int|0xE5
)paren
comma
id|PASSWD_REG
op_minus
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|board_type
op_eq
id|C930
)paren
(brace
id|outb
c_func
(paren
(paren
id|port
op_minus
id|MC0_PORT
)paren
comma
l_int|0xe0e
)paren
suffix:semicolon
multiline_comment|/* Write to index reg */
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|value
op_amp
l_int|0xff
)paren
)paren
comma
l_int|0xe0f
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|c924pnp
)paren
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|value
op_amp
l_int|0xff
)paren
)paren
comma
id|port
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|value
op_amp
l_int|0xff
)paren
)paren
comma
id|port
op_minus
l_int|0x80
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|detect_c930
r_static
r_int
id|__init
id|detect_c930
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|tmp
op_assign
id|mad_read
c_func
(paren
id|MC1_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x06
)paren
op_ne
l_int|0x06
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Wrong C930 signature (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
multiline_comment|/* return 0; */
)brace
id|mad_write
c_func
(paren
id|MC1_PORT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mad_read
c_func
(paren
id|MC1_PORT
)paren
op_ne
l_int|0x06
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Wrong C930 signature2 (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
multiline_comment|/* return 0; */
)brace
id|mad_write
c_func
(paren
id|MC1_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore bits */
id|mad_write
c_func
(paren
id|MC7_PORT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|mad_read
c_func
(paren
id|MC7_PORT
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;MC7 not writable (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
c_func
(paren
id|MC7_PORT
comma
l_int|0xcb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|mad_read
c_func
(paren
id|MC7_PORT
)paren
)paren
op_ne
l_int|0xcb
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;MC7 not writable2 (%x)&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tmp
op_assign
id|mad_read
c_func
(paren
id|MC0_PORT
op_plus
l_int|18
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0xff
op_logical_or
id|tmp
op_eq
l_int|0x00
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* We probably have a C931 */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Detected C931 config=0x%02x&bslash;n&quot;
comma
id|tmp
)paren
)paren
suffix:semicolon
id|c931_detected
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;         * We cannot configure the chip if it is in PnP mode.&n;         * If we have a CSN assigned (bit 8 in MC13) we first try&n;         * a software reset, then a software power off, finally&n;         * Clearing PnP mode. The last option is not&n;&t; * Bit 8 in MC13 &n;         */
r_if
c_cond
(paren
(paren
id|mad_read
c_func
(paren
id|MC0_PORT
op_plus
l_int|13
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Software reset */
id|mad_write
c_func
(paren
id|MC9_PORT
comma
l_int|0x02
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC9_PORT
comma
l_int|0x00
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mad_read
c_func
(paren
id|MC0_PORT
op_plus
l_int|13
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Power off, and on again */
id|mad_write
c_func
(paren
id|MC9_PORT
comma
l_int|0xc2
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC9_PORT
comma
l_int|0xc0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mad_read
c_func
(paren
id|MC0_PORT
op_plus
l_int|13
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#if 0&t;
multiline_comment|/* Force off PnP mode. This is not recommended because&n;&t; * the PnP bios will not recognize the chip on the next&n;&t; * warm boot and may assignd different resources to other&n;&t; * PnP/PCI cards.&n;&t; */
id|mad_write
c_func
(paren
id|MC0_PORT
op_plus
l_int|17
comma
l_int|0x04
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|detect_mad16
r_static
r_int
id|__init
id|detect_mad16
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|tmp
comma
id|tmp2
comma
id|bit
suffix:semicolon
r_int
id|i
comma
id|port
suffix:semicolon
multiline_comment|/*&n;&t; * Check that reading a register doesn&squot;t return bus float (0xff)&n;&t; * when the card is accessed using password. This may fail in case&n;&t; * the card is in low power mode. Normally at least the power saving&n;&t; * mode bit should be 0.&n;&t; */
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|mad_read
c_func
(paren
id|MC1_PORT
)paren
)paren
op_eq
l_int|0xff
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;MC1_PORT returned 0xff&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf98
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|c924pnp
)paren
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Port %0x (init value) = %0x&bslash;n&quot;
comma
id|i
comma
id|mad_read
c_func
(paren
id|i
)paren
)paren
)paren
r_else
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Port %0x (init value) = %0x&bslash;n&quot;
comma
id|i
op_minus
l_int|0x80
comma
id|mad_read
c_func
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board_type
op_eq
id|C930
)paren
r_return
id|detect_c930
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now check that the gate is closed on first I/O after writing&n;&t; * the password. (This is how a MAD16 compatible card works).&n;&t; */
r_if
c_cond
(paren
(paren
id|tmp2
op_assign
id|inb
c_func
(paren
id|MC1_PORT
)paren
)paren
op_eq
id|tmp
)paren
multiline_comment|/* It didn&squot;t close */
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;MC1_PORT didn&squot;t close after read (0x%02x)&bslash;n&quot;
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bit
op_assign
(paren
id|c924pnp
)paren
ques
c_cond
l_int|0x20
suffix:colon
l_int|0x80
suffix:semicolon
id|port
op_assign
(paren
id|c924pnp
)paren
ques
c_cond
id|MC2_PORT
suffix:colon
id|MC1_PORT
suffix:semicolon
id|tmp
op_assign
id|mad_read
c_func
(paren
id|port
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|port
comma
id|tmp
op_xor
id|bit
)paren
suffix:semicolon
multiline_comment|/* Toggle a bit */
r_if
c_cond
(paren
(paren
id|tmp2
op_assign
id|mad_read
c_func
(paren
id|port
)paren
)paren
op_ne
(paren
id|tmp
op_xor
id|bit
)paren
)paren
multiline_comment|/* Compare the bit */
(brace
id|mad_write
c_func
(paren
id|port
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Bit revert test failed (0x%02x, 0x%02x)&bslash;n&quot;
comma
id|tmp
comma
id|tmp2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
c_func
(paren
id|port
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Restore */
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Bingo */
)brace
DECL|function|wss_init
r_static
r_int
id|__init
id|wss_init
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|ad_flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *    Verify the WSS parameters&n;&t; */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|8
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: I/O port conflict&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ad1848_detect
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
op_amp
id|ad_flags
comma
id|mad16_osp
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Check if the IO port returns valid signature. The original MS Sound&n;&t; * system returns 0x04 while some cards (AudioTrix Pro for example)&n;&t; * return 0x00.&n;&t; */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x04
op_logical_and
(paren
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x00
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;No MSS signature detected on port 0x%x (0x%x)&bslash;n&quot;
comma
id|hw_config-&gt;io_base
comma
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|11
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: Bad IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_ne
l_int|0
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|1
op_logical_and
id|hw_config-&gt;dma
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: Bad DMA %d&bslash;n&quot;
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check that DMA0 is not in use with a 8 bit board.&n;&t; */
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_eq
l_int|0
op_logical_and
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MSS: Can&squot;t use DMA0 with a 8 bit card/slot&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hw_config-&gt;irq
OG
l_int|7
op_logical_and
id|hw_config-&gt;irq
op_ne
l_int|9
op_logical_and
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|3
)paren
op_amp
l_int|0x80
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSS: Can&squot;t use IRQ%d with a 8 bit card/slot&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|init_c930
r_static
r_int
id|__init
id|init_c930
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|cfg
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|c931_detected
)paren
(brace
multiline_comment|/* Bit 0 has reversd meaning. Bits 1 and 2 sese&n;&t;&t;   reversed on write.&n;&t;&t;   Support only IDE cdrom. IDE port programmed&n;&t;&t;   somewhere else. */
id|cfg
op_assign
(paren
id|cfg
op_amp
l_int|0x09
)paren
op_xor
l_int|0x07
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|hw_config-&gt;io_base
)paren
(brace
r_case
l_int|0x530
suffix:colon
id|cfg
op_or_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe80
suffix:colon
id|cfg
op_or_assign
l_int|0x10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf40
suffix:colon
id|cfg
op_or_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x604
suffix:colon
id|cfg
op_or_assign
l_int|0x30
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MAD16: Invalid codec port %x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
c_func
(paren
id|MC1_PORT
comma
id|cfg
)paren
suffix:semicolon
multiline_comment|/* MC2 is CD configuration. Don&squot;t touch it. */
id|mad_write
c_func
(paren
id|MC3_PORT
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable SB mode IRQ and DMA */
multiline_comment|/* bit 2 of MC4 reverses it&squot;s meaning between the C930&n;&t;   and the C931. */
id|cfg
op_assign
id|c931_detected
ques
c_cond
l_int|0x04
suffix:colon
l_int|0x00
suffix:semicolon
id|mad_write
c_func
(paren
id|MC4_PORT
comma
l_int|0x52
op_or
id|cfg
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC5_PORT
comma
l_int|0x3C
)paren
suffix:semicolon
multiline_comment|/* Init it into mode2 */
id|mad_write
c_func
(paren
id|MC6_PORT
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* Enable WSS, Disable MPU and SB */
id|mad_write
c_func
(paren
id|MC7_PORT
comma
l_int|0xCB
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC10_PORT
comma
l_int|0x11
)paren
suffix:semicolon
r_return
id|wss_init
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|function|chip_detect
r_static
r_int
id|__init
id|chip_detect
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; *    Then try to detect with the old password&n;&t; */
id|board_type
op_assign
id|C924
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Detect using password = 0xE5&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
c_func
(paren
)paren
)paren
multiline_comment|/* No luck. Try different model */
(brace
id|board_type
op_assign
id|C928
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Detect using password = 0xE2&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
c_func
(paren
)paren
)paren
(brace
id|board_type
op_assign
id|C929
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Detect using password = 0xE3&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PASSWD_REG
)paren
op_ne
l_int|0xff
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * First relocate MC# registers to 0xe0e/0xe0f, disable password &n;&t;&t;&t;&t; */
id|outb
c_func
(paren
(paren
l_int|0xE4
)paren
comma
id|PASSWD_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0x80
)paren
comma
id|PASSWD_REG
)paren
suffix:semicolon
id|board_type
op_assign
id|C930
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Detect using password = 0xE4&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf93
suffix:semicolon
id|i
op_increment
)paren
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;port %03x = %02x&bslash;n&quot;
comma
id|i
comma
id|mad_read
c_func
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* The C931 has the password reg at F8D */
id|outb
c_func
(paren
(paren
l_int|0xE4
)paren
comma
l_int|0xF8D
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0x80
)paren
comma
l_int|0xF8D
)paren
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Detect using password = 0xE4 for C931&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
c_func
(paren
)paren
)paren
(brace
id|board_type
op_assign
id|C924
suffix:semicolon
id|c924pnp
op_increment
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Detect using password = 0xE5 (again), port offset -0x80&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|detect_mad16
c_func
(paren
)paren
)paren
(brace
id|c924pnp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;mad16.c: 82C924 PnP detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;mad16.c: 82C930 detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;mad16.c: 82C929 detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
id|model
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|model
op_assign
id|mad_read
c_func
(paren
id|MC3_PORT
)paren
)paren
op_amp
l_int|0x03
)paren
op_eq
l_int|0x03
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;mad16.c: Mozart detected&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|board_type
op_assign
id|MOZART
suffix:semicolon
)brace
r_else
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;mad16.c: 82C928 detected???&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|board_type
op_assign
id|C928
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|probe_mad16
r_static
r_int
id|__init
id|probe_mad16
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|valid_ports
(braket
)braket
op_assign
(brace
l_int|0x530
comma
l_int|0xe80
comma
l_int|0xf40
comma
l_int|0x604
)brace
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_int
r_char
id|cs4231_mode
op_assign
l_int|0
suffix:semicolon
r_int
id|ad_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|already_initialized
)paren
r_return
l_int|0
suffix:semicolon
id|mad16_osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
multiline_comment|/*&n;&t; *    Check that all ports return 0xff (bus float) when no password&n;&t; *      is written to the password register.&n;&t; */
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;--- Detecting MAD16 / Mozart ---&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip_detect
c_func
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|board_type
op_eq
id|C930
)paren
r_return
id|init_c930
c_func
(paren
id|hw_config
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf93
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|c924pnp
)paren
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;port %03x = %02x&bslash;n&quot;
comma
id|i
comma
id|mad_read
c_func
(paren
id|i
)paren
)paren
)paren
r_else
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;port %03x = %02x&bslash;n&quot;
comma
id|i
op_minus
l_int|0x80
comma
id|mad_read
c_func
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Set the WSS address&n; */
id|tmp
op_assign
(paren
id|mad_read
c_func
(paren
id|MC1_PORT
)paren
op_amp
l_int|0x0f
)paren
op_or
l_int|0x80
suffix:semicolon
multiline_comment|/* Enable WSS, Disable SB */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|3
)paren
multiline_comment|/* Not a valid port */
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MAD16/Mozart: Bad WSS base address 0x%x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|valid_ports
(braket
id|i
)braket
op_eq
id|hw_config-&gt;io_base
)paren
(brace
id|tmp
op_or_assign
id|i
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* WSS port select bits */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Set optional CD-ROM and joystick settings.&n;&t; */
id|tmp
op_and_assign
op_complement
l_int|0x0f
suffix:semicolon
id|mad_write
c_func
(paren
id|MC1_PORT
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
id|mad_read
c_func
(paren
id|MC2_PORT
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC2_PORT
comma
id|tmp
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC3_PORT
comma
l_int|0xf0
)paren
suffix:semicolon
multiline_comment|/* Disable SB */
r_if
c_cond
(paren
id|board_type
op_eq
id|C924
)paren
multiline_comment|/* Specific C924 init values */
(brace
id|mad_write
c_func
(paren
id|MC4_PORT
comma
l_int|0xA0
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC5_PORT
comma
l_int|0x05
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC6_PORT
comma
l_int|0x03
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ad1848_detect
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
op_amp
id|ad_flags
comma
id|mad16_osp
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ad_flags
op_amp
(paren
id|AD_F_CS4231
op_or
id|AD_F_CS4248
)paren
)paren
id|cs4231_mode
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* CS4248/CS4231 sync delay switch */
r_if
c_cond
(paren
id|board_type
op_eq
id|C929
)paren
(brace
id|mad_write
c_func
(paren
id|MC4_PORT
comma
l_int|0xa2
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC5_PORT
comma
l_int|0xA5
op_or
id|cs4231_mode
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC6_PORT
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* Disable MPU401 */
)brace
r_else
(brace
id|mad_write
c_func
(paren
id|MC4_PORT
comma
l_int|0x02
)paren
suffix:semicolon
id|mad_write
c_func
(paren
id|MC5_PORT
comma
l_int|0x30
op_or
id|cs4231_mode
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0xf8d
suffix:semicolon
id|i
op_le
l_int|0xf93
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|c924pnp
)paren
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;port %03x after init = %02x&bslash;n&quot;
comma
id|i
comma
id|mad_read
c_func
(paren
id|i
)paren
)paren
)paren
r_else
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;port %03x after init = %02x&bslash;n&quot;
comma
id|i
op_minus
l_int|0x80
comma
id|mad_read
c_func
(paren
id|i
)paren
)paren
)paren
suffix:semicolon
id|wss_init
c_func
(paren
id|hw_config
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|attach_mad16
r_static
r_void
id|__init
id|attach_mad16
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_static
r_int
r_char
id|interrupt_bits
(braket
l_int|12
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x08
comma
op_minus
l_int|1
comma
l_int|0x10
comma
l_int|0x18
comma
l_int|0x20
)brace
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
r_static
r_char
id|dma_bits
(braket
l_int|4
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|0
comma
l_int|3
)brace
suffix:semicolon
r_int
id|config_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|0
comma
id|version_port
op_assign
id|hw_config-&gt;io_base
op_plus
l_int|3
suffix:semicolon
r_int
id|ad_flags
op_assign
l_int|0
comma
id|dma
op_assign
id|hw_config-&gt;dma
comma
id|dma2
op_assign
id|hw_config-&gt;dma2
suffix:semicolon
r_int
r_char
id|dma2_bit
op_assign
l_int|0
suffix:semicolon
id|already_initialized
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ad1848_detect
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
op_amp
id|ad_flags
comma
id|mad16_osp
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Set the IRQ and DMA addresses.&n;&t; */
r_if
c_cond
(paren
id|board_type
op_eq
id|C930
op_logical_or
id|c924pnp
)paren
id|interrupt_bits
(braket
l_int|5
)braket
op_assign
l_int|0x28
suffix:semicolon
multiline_comment|/* Also IRQ5 is possible on C930 */
id|bits
op_assign
id|interrupt_bits
(braket
id|hw_config-&gt;irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|outb
c_func
(paren
(paren
id|bits
op_or
l_int|0x40
)paren
comma
id|config_port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|version_port
)paren
op_amp
l_int|0x40
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;[IRQ Conflict?]&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Handle the capture DMA channel&n;&t; */
r_if
c_cond
(paren
id|ad_flags
op_amp
id|AD_F_CS4231
op_logical_and
id|dma2
op_ne
op_minus
l_int|1
op_logical_and
id|dma2
op_ne
id|dma
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|dma
op_eq
l_int|0
op_logical_and
id|dma2
op_eq
l_int|1
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|1
op_logical_and
id|dma2
op_eq
l_int|0
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|3
op_logical_and
id|dma2
op_eq
l_int|0
)paren
)paren
)paren
(brace
multiline_comment|/* Unsupported combination. Try to swap channels */
r_int
id|tmp
op_assign
id|dma
suffix:semicolon
id|dma
op_assign
id|dma2
suffix:semicolon
id|dma2
op_assign
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dma
op_eq
l_int|0
op_logical_and
id|dma2
op_eq
l_int|1
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|1
op_logical_and
id|dma2
op_eq
l_int|0
)paren
op_logical_or
(paren
id|dma
op_eq
l_int|3
op_logical_and
id|dma2
op_eq
l_int|0
)paren
)paren
(brace
id|dma2_bit
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* Enable capture DMA */
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;MAD16: Invalid capture DMA&bslash;n&quot;
)paren
suffix:semicolon
id|dma2
op_assign
id|dma
suffix:semicolon
)brace
)brace
r_else
id|dma2
op_assign
id|dma
suffix:semicolon
id|outb
c_func
(paren
(paren
id|bits
op_or
id|dma_bits
(braket
id|dma
)braket
op_or
id|dma2_bit
)paren
comma
id|config_port
)paren
suffix:semicolon
multiline_comment|/* Write IRQ+DMA setup */
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_assign
id|ad1848_init
c_func
(paren
l_string|&quot;MAD16 WSS&quot;
comma
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|dma
comma
id|dma2
comma
l_int|0
comma
id|hw_config-&gt;osp
comma
id|THIS_MODULE
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|4
comma
l_string|&quot;MAD16 WSS config&quot;
)paren
suffix:semicolon
)brace
DECL|function|probe_mad16_mpu
r_static
r_int
id|__init
id|probe_mad16_mpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_static
r_int
id|mpu_attached
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|already_initialized
)paren
multiline_comment|/* The MSS port must be initialized first */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mpu_attached
)paren
multiline_comment|/* Don&squot;t let them call this twice */
r_return
l_int|0
suffix:semicolon
id|mpu_attached
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|board_type
OL
id|C929
)paren
multiline_comment|/* Early chip. No MPU support. Just SB MIDI */
(brace
macro_line|#ifdef CONFIG_MAD16_OLDCARD
id|tmp
op_assign
id|mad_read
c_func
(paren
id|MC3_PORT
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * MAD16 SB base is defined by the WSS base. It cannot be changed &n;&t;&t; * alone.&n;&t;&t; * Ignore configured I/O base. Use the active setting. &n;&t;&t; */
r_if
c_cond
(paren
id|mad_read
c_func
(paren
id|MC1_PORT
)paren
op_amp
l_int|0x20
)paren
id|hw_config-&gt;io_base
op_assign
l_int|0x240
suffix:semicolon
r_else
id|hw_config-&gt;io_base
op_assign
l_int|0x220
suffix:semicolon
r_switch
c_cond
(paren
id|hw_config-&gt;irq
)paren
(brace
r_case
l_int|5
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_or
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
l_int|0x3f
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
id|tmp
op_assign
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_or
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mad16/Mozart: Invalid MIDI IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
c_func
(paren
id|MC3_PORT
comma
id|tmp
op_or
l_int|0x04
)paren
suffix:semicolon
id|hw_config-&gt;driver_use_1
op_assign
id|SB_MIDI_ONLY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_detect
c_func
(paren
id|hw_config
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mad_read
c_func
(paren
id|MC1_PORT
)paren
op_amp
l_int|0x20
)paren
id|hw_config-&gt;io_base
op_assign
l_int|0x240
suffix:semicolon
r_else
id|hw_config-&gt;io_base
op_assign
l_int|0x220
suffix:semicolon
id|hw_config-&gt;name
op_assign
l_string|&quot;Mad16/Mozart&quot;
suffix:semicolon
id|sb_dsp_init
c_func
(paren
id|hw_config
comma
id|THIS_MODULE
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
macro_line|#else
multiline_comment|/* assuming all later Mozart cards are identified as&n;&t;&t; * either 82C928 or Mozart. If so, following code attempts&n;&t;&t; * to set MPU register. TODO - add probing&n;&t;&t; */
id|tmp
op_assign
id|mad_read
c_func
(paren
id|MC8_PORT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hw_config-&gt;irq
)paren
(brace
r_case
l_int|5
suffix:colon
id|tmp
op_or_assign
l_int|0x08
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|tmp
op_or_assign
l_int|0x10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|tmp
op_or_assign
l_int|0x18
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|tmp
op_or_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11
suffix:colon
id|tmp
op_or_assign
l_int|0x28
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mad16/MOZART: invalid mpu_irq&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|hw_config-&gt;io_base
)paren
(brace
r_case
l_int|0x300
suffix:colon
id|tmp
op_or_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x310
suffix:colon
id|tmp
op_or_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x320
suffix:colon
id|tmp
op_or_assign
l_int|0x05
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x330
suffix:colon
id|tmp
op_or_assign
l_int|0x07
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mad16/MOZART: invalid mpu_io&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|mad_write
c_func
(paren
id|MC8_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* write MPU port parameters */
r_goto
id|probe_401
suffix:semicolon
macro_line|#endif
)brace
id|tmp
op_assign
id|mad_read
c_func
(paren
id|MC6_PORT
)paren
op_amp
l_int|0x83
suffix:semicolon
id|tmp
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* MPU-401 enable */
multiline_comment|/* Set the MPU base bits */
r_switch
c_cond
(paren
id|hw_config-&gt;io_base
)paren
(brace
r_case
l_int|0x300
suffix:colon
id|tmp
op_or_assign
l_int|0x60
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x310
suffix:colon
id|tmp
op_or_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x320
suffix:colon
id|tmp
op_or_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x330
suffix:colon
id|tmp
op_or_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MAD16: Invalid MIDI port 0x%x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the MPU IRQ bits */
r_switch
c_cond
(paren
id|hw_config-&gt;irq
)paren
(brace
r_case
l_int|5
suffix:colon
id|tmp
op_or_assign
l_int|0x10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|tmp
op_or_assign
l_int|0x18
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9
suffix:colon
id|tmp
op_or_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|tmp
op_or_assign
l_int|0x08
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MAD16: Invalid MIDI IRQ %d&bslash;n&quot;
comma
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mad_write
c_func
(paren
id|MC6_PORT
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Write MPU401 config */
macro_line|#ifndef CONFIG_MAD16_OLDCARD
id|probe_401
suffix:colon
macro_line|#endif
id|hw_config-&gt;driver_use_1
op_assign
id|SB_MIDI_ONLY
suffix:semicolon
id|hw_config-&gt;name
op_assign
l_string|&quot;Mad16/Mozart&quot;
suffix:semicolon
r_return
id|probe_uart401
c_func
(paren
id|hw_config
comma
id|THIS_MODULE
)paren
suffix:semicolon
)brace
DECL|function|unload_mad16
r_static
r_void
id|__exit
id|unload_mad16
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|ad1848_unload
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|4
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
comma
l_int|0
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|4
)paren
suffix:semicolon
id|sound_unload_audiodev
c_func
(paren
id|hw_config-&gt;slots
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
DECL|function|unload_mad16_mpu
r_static
r_void
id|__exit
id|unload_mad16_mpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
macro_line|#ifdef CONFIG_MAD16_OLDCARD
r_if
c_cond
(paren
id|board_type
OL
id|C929
)paren
multiline_comment|/* Early chip. No MPU support. Just SB MIDI */
(brace
id|sb_dsp_unload
c_func
(paren
id|hw_config
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
id|unload_uart401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|variable|cfg
r_static
r_struct
id|address_info
id|cfg
suffix:semicolon
DECL|variable|cfg_mpu
r_static
r_struct
id|address_info
id|cfg_mpu
suffix:semicolon
DECL|variable|found_mpu
r_static
r_int
id|found_mpu
suffix:semicolon
DECL|variable|mpu_io
r_static
r_int
id|__initdata
id|mpu_io
op_assign
l_int|0
suffix:semicolon
DECL|variable|mpu_irq
r_static
r_int
id|__initdata
id|mpu_irq
op_assign
l_int|0
suffix:semicolon
DECL|variable|io
r_static
r_int
id|__initdata
id|io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma
r_static
r_int
id|__initdata
id|dma
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma16
r_static
r_int
id|__initdata
id|dma16
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set this for modules that need it */
DECL|variable|irq
r_static
r_int
id|__initdata
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|cdtype
r_static
r_int
id|__initdata
id|cdtype
op_assign
l_int|0
suffix:semicolon
DECL|variable|cdirq
r_static
r_int
id|__initdata
id|cdirq
op_assign
l_int|0
suffix:semicolon
DECL|variable|cdport
r_static
r_int
id|__initdata
id|cdport
op_assign
l_int|0x340
suffix:semicolon
DECL|variable|cddma
r_static
r_int
id|__initdata
id|cddma
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|opl4
r_static
r_int
id|__initdata
id|opl4
op_assign
l_int|0
suffix:semicolon
DECL|variable|joystick
r_static
r_int
id|__initdata
id|joystick
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mpu_io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mpu_irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma16
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cdtype
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cdirq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cdport
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cddma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|opl4
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|joystick
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|dma_map
r_static
r_int
id|__initdata
id|dma_map
(braket
l_int|2
)braket
(braket
l_int|8
)braket
op_assign
(brace
(brace
l_int|0x03
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x02
)brace
comma
(brace
l_int|0x03
comma
op_minus
l_int|1
comma
l_int|0x01
comma
l_int|0x00
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
DECL|variable|irq_map
r_static
r_int
id|__initdata
id|irq_map
(braket
l_int|16
)braket
op_assign
(brace
l_int|0x00
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0x0A
comma
op_minus
l_int|1
comma
l_int|0x04
comma
op_minus
l_int|1
comma
l_int|0x08
comma
op_minus
l_int|1
comma
l_int|0x10
comma
l_int|0x14
comma
l_int|0x18
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|function|init_mad16
r_static
r_int
id|__init
id|init_mad16
c_func
(paren
r_void
)paren
(brace
r_int
id|dmatype
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MAD16 audio driver Copyright (C) by Hannu Savolainen 1993-1996&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CDROM &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cdtype
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Disabled&quot;
)paren
suffix:semicolon
id|cdirq
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Sony CDU31A&quot;
)paren
suffix:semicolon
id|dmatype
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cddma
op_eq
op_minus
l_int|1
)paren
(brace
id|cddma
op_assign
l_int|3
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Mitsumi&quot;
)paren
suffix:semicolon
id|dmatype
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cddma
op_eq
op_minus
l_int|1
)paren
(brace
id|cddma
op_assign
l_int|5
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Panasonic Lasermate&quot;
)paren
suffix:semicolon
id|dmatype
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cddma
op_eq
op_minus
l_int|1
)paren
(brace
id|cddma
op_assign
l_int|3
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Secondary IDE&quot;
)paren
suffix:semicolon
id|dmatype
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cddma
op_eq
op_minus
l_int|1
)paren
(brace
id|cddma
op_assign
l_int|5
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Primary IDE&quot;
)paren
suffix:semicolon
id|dmatype
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cddma
op_eq
op_minus
l_int|1
)paren
(brace
id|cddma
op_assign
l_int|5
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Invalid CDROM type&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;         *    Build the config words&n;         */
id|mad16_conf
op_assign
(paren
id|joystick
op_xor
l_int|1
)paren
op_or
id|cdtype
suffix:semicolon
id|mad16_cdsel
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|opl4
)paren
id|mad16_cdsel
op_or_assign
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
id|cdtype
)paren
(brace
r_if
c_cond
(paren
id|cddma
OG
l_int|7
op_logical_or
id|cddma
OL
l_int|0
op_logical_or
id|dma_map
(braket
id|dmatype
)braket
(braket
id|cddma
)braket
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Invalid CDROM DMA&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cddma
)paren
id|printk
c_func
(paren
l_string|&quot;, DMA %d&quot;
comma
id|cddma
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;, no DMA&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdirq
)paren
id|printk
c_func
(paren
l_string|&quot;, no IRQ&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cdirq
template_param
l_int|15
op_logical_or
id|irq_map
(braket
id|cdirq
)braket
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;, invalid IRQ (disabling)&quot;
)paren
suffix:semicolon
id|cdirq
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;, IRQ %d&quot;
comma
id|cdirq
)paren
suffix:semicolon
id|mad16_cdsel
op_or_assign
id|dma_map
(braket
id|dmatype
)braket
(braket
id|cddma
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cdtype
OL
l_int|0x08
)paren
(brace
r_switch
c_cond
(paren
id|cdport
)paren
(brace
r_case
l_int|0x340
suffix:colon
id|mad16_cdsel
op_or_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x330
suffix:colon
id|mad16_cdsel
op_or_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x360
suffix:colon
id|mad16_cdsel
op_or_assign
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x320
suffix:colon
id|mad16_cdsel
op_or_assign
l_int|0xC0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unknown CDROM I/O base %d&bslash;n&quot;
comma
id|cdport
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|mad16_cdsel
op_or_assign
id|irq_map
(braket
id|cdirq
)braket
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Joystick port &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|joystick
op_eq
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;enabled.&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|joystick
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;disabled.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|cfg.io_base
op_assign
id|io
suffix:semicolon
id|cfg.irq
op_assign
id|irq
suffix:semicolon
id|cfg.dma
op_assign
id|dma
suffix:semicolon
id|cfg.dma2
op_assign
id|dma16
suffix:semicolon
r_if
c_cond
(paren
id|cfg.io_base
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.dma
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.irq
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;I/O, DMA and irq are mandatory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|probe_mad16
c_func
(paren
op_amp
id|cfg
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|cfg_mpu.io_base
op_assign
id|mpu_io
suffix:semicolon
id|cfg_mpu.irq
op_assign
id|mpu_irq
suffix:semicolon
id|attach_mad16
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
id|found_mpu
op_assign
id|probe_mad16_mpu
c_func
(paren
op_amp
id|cfg_mpu
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_mad16
r_static
r_void
id|__exit
id|cleanup_mad16
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|found_mpu
)paren
id|unload_mad16_mpu
c_func
(paren
op_amp
id|cfg_mpu
)paren
suffix:semicolon
id|unload_mad16
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
)brace
DECL|variable|init_mad16
id|module_init
c_func
(paren
id|init_mad16
)paren
suffix:semicolon
DECL|variable|cleanup_mad16
id|module_exit
c_func
(paren
id|cleanup_mad16
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|setup_mad16
r_static
r_int
id|__init
id|setup_mad16
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/* io, irq */
r_int
id|ints
(braket
l_int|7
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|io
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|irq
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|dma
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|dma16
op_assign
id|ints
(braket
l_int|4
)braket
suffix:semicolon
id|mpu_io
op_assign
id|ints
(braket
l_int|5
)braket
suffix:semicolon
id|mpu_irq
op_assign
id|ints
(braket
l_int|6
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;mad16=&quot;
comma
id|setup_mad16
)paren
suffix:semicolon
macro_line|#endif
eof
