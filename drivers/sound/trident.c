multiline_comment|/*****************************************************************************&n; *&n; *      Trident 4D-Wave OSS driver for Linux 2.2.x&n; *&n; *&t;Driver: Alan Cox &lt;alan@redhat.com&gt;&n; *&n; *  Built from:&n; *  &t;Low level code: &lt;audio@tridentmicro.com&gt; from ALSA&n; *  &t;Framework: Thomas Sailer &lt;sailer@ife.ee.ethz.ch&gt;&n; *  &t;Extended by: Zach Brown &lt;zab@redhat.com&gt;  &n; *&n; *&t;Hacked up by:&n; *&t;  Aaron Holtzman &lt;aholtzma@ess.engr.uvic.ca&gt;&n; *&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *      This program is distributed in the hope that it will be useful,&n; *      but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *      GNU General Public License for more details.&n; *&n; *      You should have received a copy of the GNU General Public License&n; *      along with this program; if not, write to the Free Software&n; *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
multiline_comment|/*****************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#ifdef CONFIG_APM
macro_line|#include &lt;linux/apm_bios.h&gt;
macro_line|#endif
macro_line|#include &quot;trident.h&quot;
macro_line|#include &quot;ac97.h&quot;
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|M_DEBUG
mdefine_line|#define M_DEBUG 1
macro_line|#ifdef M_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
DECL|macro|M_printk
mdefine_line|#define M_printk(args...) {if (debug) printk(args);}
macro_line|#else
DECL|macro|M_printk
mdefine_line|#define M_printk(x)
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;0.01&quot;
DECL|macro|TRIDENT_FMT_STEREO
mdefine_line|#define TRIDENT_FMT_STEREO&t;0x01
DECL|macro|TRIDENT_FMT_16BIT
mdefine_line|#define TRIDENT_FMT_16BIT&t;0x02
DECL|macro|TRIDENT_FMT_MASK
mdefine_line|#define TRIDENT_FMT_MASK&t;0x03
DECL|macro|TRIDENT_DAC_SHIFT
mdefine_line|#define TRIDENT_DAC_SHIFT&t;0   
DECL|macro|TRIDENT_ADC_SHIFT
mdefine_line|#define TRIDENT_ADC_SHIFT&t;4
DECL|macro|TRIDENT_ENABLE_PE
mdefine_line|#define TRIDENT_ENABLE_PE&t;1
DECL|macro|TRIDENT_ENABLE_RE
mdefine_line|#define TRIDENT_ENABLE_RE&t;2
DECL|macro|TRIDENT_CARD_MAGIC
mdefine_line|#define TRIDENT_CARD_MAGIC&t;0x5072696E
DECL|macro|TRIDENT_STATE_MAGIC
mdefine_line|#define TRIDENT_STATE_MAGIC&t;0x63657373
DECL|macro|DAC_RUNNING
mdefine_line|#define DAC_RUNNING&t;&t;1
DECL|macro|ADC_RUNNING
mdefine_line|#define ADC_RUNNING&t;&t;2
DECL|macro|NR_DSPS
mdefine_line|#define NR_DSPS&t;&t;8
DECL|macro|SND_DEV_DSP16
mdefine_line|#define SND_DEV_DSP16   5 
DECL|variable|sample_size
r_static
r_const
r_int
id|sample_size
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|4
)brace
suffix:semicolon
DECL|variable|sample_shift
r_static
r_const
r_int
id|sample_shift
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|2
)brace
suffix:semicolon
DECL|enum|card_types_t
r_enum
id|card_types_t
(brace
DECL|enumerator|TYPE_4DWAVE_DX
id|TYPE_4DWAVE_DX
comma
DECL|enumerator|TYPE_4DWAVE_NX
id|TYPE_4DWAVE_NX
)brace
suffix:semicolon
DECL|variable|card_names
r_static
r_const
r_char
op_star
id|card_names
(braket
)braket
op_assign
initialization_block
suffix:semicolon
DECL|struct|tChannelControl
r_typedef
r_struct
id|tChannelControl
(brace
singleline_comment|// register data
DECL|member|lpChStart
r_int
r_int
op_star
id|lpChStart
suffix:semicolon
DECL|member|lpChStop
r_int
r_int
op_star
id|lpChStop
suffix:semicolon
DECL|member|lpChAint
r_int
r_int
op_star
id|lpChAint
suffix:semicolon
DECL|member|lpChAinten
r_int
r_int
op_star
id|lpChAinten
suffix:semicolon
singleline_comment|// register addresses
DECL|member|lpAChStart
r_int
r_int
op_star
id|lpAChStart
suffix:semicolon
DECL|member|lpAChStop
r_int
r_int
op_star
id|lpAChStop
suffix:semicolon
DECL|member|lpAChAint
r_int
r_int
op_star
id|lpAChAint
suffix:semicolon
DECL|member|lpAChAinten
r_int
r_int
op_star
id|lpAChAinten
suffix:semicolon
DECL|member|data
r_int
r_int
id|data
(braket
l_int|16
)braket
suffix:semicolon
DECL|typedef|CHANNELCONTROL
)brace
id|CHANNELCONTROL
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|struct|trident_state
r_struct
id|trident_state
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|channel
r_int
id|channel
suffix:semicolon
DECL|member|card
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
multiline_comment|/* Card info */
multiline_comment|/* wave stuff */
DECL|member|rateadc
DECL|member|ratedac
r_int
r_int
id|rateadc
comma
id|ratedac
suffix:semicolon
DECL|member|fmt
DECL|member|enable
r_int
r_char
id|fmt
comma
id|enable
suffix:semicolon
DECL|member|open_sem
r_struct
id|semaphore
id|open_sem
suffix:semicolon
DECL|member|open_mode
id|mode_t
id|open_mode
suffix:semicolon
DECL|member|open_wait
id|wait_queue_head_t
id|open_wait
suffix:semicolon
multiline_comment|/* soundcore stuff */
DECL|member|dev_audio
r_int
id|dev_audio
suffix:semicolon
DECL|struct|dmabuf
r_struct
id|dmabuf
(brace
DECL|member|rawbuf
r_void
op_star
id|rawbuf
suffix:semicolon
DECL|member|buforder
r_int
id|buforder
suffix:semicolon
DECL|member|numfrag
r_int
id|numfrag
suffix:semicolon
DECL|member|fragshift
r_int
id|fragshift
suffix:semicolon
DECL|member|chan
r_int
id|chan
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Hardware channel */
multiline_comment|/* XXX zab - swptr only in here so that it can be referenced by&n;&t;&t;&t;clear_advance, as far as I can tell :( */
DECL|member|hwptr
DECL|member|swptr
r_int
id|hwptr
comma
id|swptr
suffix:semicolon
DECL|member|total_bytes
r_int
id|total_bytes
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
multiline_comment|/* over/underrun */
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
multiline_comment|/* redundant, but makes calculations easier */
DECL|member|fragsize
r_int
id|fragsize
suffix:semicolon
DECL|member|dmasize
r_int
id|dmasize
suffix:semicolon
DECL|member|fragsamples
r_int
id|fragsamples
suffix:semicolon
multiline_comment|/* OSS stuff */
DECL|member|mapped
r_int
id|mapped
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ready
r_int
id|ready
suffix:colon
l_int|1
suffix:semicolon
DECL|member|endcleared
r_int
id|endcleared
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ossfragshift
r_int
id|ossfragshift
suffix:semicolon
DECL|member|ossmaxfrags
r_int
id|ossmaxfrags
suffix:semicolon
DECL|member|subdivision
r_int
id|subdivision
suffix:semicolon
DECL|member|base
id|u16
id|base
suffix:semicolon
multiline_comment|/* Offset for ptr */
DECL|member|dma_dac
DECL|member|dma_adc
)brace
id|dma_dac
comma
id|dma_adc
suffix:semicolon
DECL|member|bDMAStart
id|u8
id|bDMAStart
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|trident_card
r_struct
id|trident_card
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
multiline_comment|/* We keep trident cards in a linked list */
DECL|member|next
r_struct
id|trident_card
op_star
id|next
suffix:semicolon
multiline_comment|/* The trident has a certain amount of cross channel interaction&n;&t;   so we use a single per card lock */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|dev_mixer
r_int
id|dev_mixer
suffix:semicolon
DECL|member|card_type
r_int
id|card_type
suffix:semicolon
multiline_comment|/* as most of this is static,&n;&t;&t;perhaps it should be a pointer to a global struct */
DECL|struct|mixer_goo
r_struct
id|mixer_goo
(brace
DECL|member|modcnt
r_int
id|modcnt
suffix:semicolon
DECL|member|supported_mixers
r_int
id|supported_mixers
suffix:semicolon
DECL|member|stereo_mixers
r_int
id|stereo_mixers
suffix:semicolon
DECL|member|record_sources
r_int
id|record_sources
suffix:semicolon
multiline_comment|/* the caller must guarantee arg sanity before calling these */
multiline_comment|/*&t;&t;int (*read_mixer)(struct trident_card *card, int index);*/
DECL|member|write_mixer
r_void
(paren
op_star
id|write_mixer
)paren
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|mixer
comma
r_int
r_int
id|left
comma
r_int
r_int
id|right
)paren
suffix:semicolon
DECL|member|recmask_io
r_int
(paren
op_star
id|recmask_io
)paren
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|rw
comma
r_int
id|mask
)paren
suffix:semicolon
DECL|member|mixer_state
r_int
r_int
id|mixer_state
(braket
id|SOUND_MIXER_NRDEVICES
)braket
suffix:semicolon
DECL|member|mix
)brace
id|mix
suffix:semicolon
DECL|member|channels
r_struct
id|trident_state
id|channels
(braket
id|NR_DSPS
)braket
suffix:semicolon
multiline_comment|/* hardware resources */
DECL|member|iobase
r_int
r_int
id|iobase
suffix:semicolon
DECL|member|irq
id|u32
id|irq
suffix:semicolon
DECL|member|ChanMap
id|u32
id|ChanMap
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|ChanPCMcnt
r_int
id|ChanPCMcnt
suffix:semicolon
DECL|member|ChanPCM
r_int
id|ChanPCM
suffix:semicolon
DECL|member|ChRegs
id|CHANNELCONTROL
id|ChRegs
suffix:semicolon
DECL|member|ChanDwordCount
r_int
id|ChanDwordCount
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|debug_timer
r_static
r_struct
id|timer_list
id|debug_timer
suffix:semicolon
DECL|macro|IWriteAinten
mdefine_line|#define IWriteAinten( x ) &bslash;&n;        {int i; &bslash;&n;         for( i= 0; i &lt; ChanDwordCount; i++) &bslash;&n;&t;&t;outl((x)-&gt;lpChAinten[i], TRID_REG(trident, (x)-&gt;lpAChAinten[i]));}
DECL|macro|IReadAinten
mdefine_line|#define IReadAinten( x ) &bslash;&n;        {int i; &bslash;&n;         for( i= 0; i &lt; ChanDwordCount; i++) &bslash;&n;         (x)-&gt;lpChAinten[i] = inl(TRID_REG(trident, (x)-&gt;lpAChAinten[i]));}
DECL|macro|ReadAint
mdefine_line|#define ReadAint( x ) &bslash;&n;        IReadAint( x ) 
DECL|macro|WriteAint
mdefine_line|#define WriteAint( x ) &bslash;&n;        IWriteAint( x ) 
DECL|macro|IWriteAint
mdefine_line|#define IWriteAint( x ) &bslash;&n;        {int i; &bslash;&n;         for( i= 0; i &lt; ChanDwordCount; i++) &bslash;&n;         outl((x)-&gt;lpChAint[i], TRID_REG(trident, (x)-&gt;lpAChAint[i]));}
DECL|macro|IReadAint
mdefine_line|#define IReadAint( x ) &bslash;&n;        {int i; &bslash;&n;         for( i= 0; i &lt; ChanDwordCount; i++) &bslash;&n;         (x)-&gt;lpChAint[i] = inl(TRID_REG(trident, (x)-&gt;lpAChAint[i]));}
multiline_comment|/*&n; *&t;Trident support library routines&n; */
multiline_comment|/*---------------------------------------------------------------------------&n;   void ResetAinten( struct trident_state *trident, int ChannelNum)&n;  &n;   Description: This routine will disable interrupts and ack any &n;                existing interrupts for specified channel.&n;  &n;   Parameters:  trident - pointer to target device class for 4DWave.&n;                ChannelNum - channel number &n;  &n;   returns:     TRUE if everything went ok, else FALSE.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|ResetAinten
r_static
r_void
id|ResetAinten
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
id|ChannelNum
)paren
(brace
r_int
r_int
id|dwMask
suffix:semicolon
r_int
r_int
id|x
op_assign
id|ChannelNum
op_rshift
l_int|5
suffix:semicolon
r_int
r_int
id|ChanDwordCount
op_assign
id|trident-&gt;ChanDwordCount
suffix:semicolon
id|IReadAinten
c_func
(paren
op_amp
id|trident-&gt;ChRegs
)paren
suffix:semicolon
id|dwMask
op_assign
l_int|1
op_lshift
(paren
id|ChannelNum
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|trident-&gt;ChRegs.lpChAinten
(braket
id|x
)braket
op_and_assign
op_complement
id|dwMask
suffix:semicolon
id|IWriteAinten
c_func
(paren
op_amp
id|trident-&gt;ChRegs
)paren
suffix:semicolon
singleline_comment|// Ack the channel in case the interrupt was set before we disable it.
id|outl
c_func
(paren
id|dwMask
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|trident-&gt;ChRegs.lpAChAint
(braket
id|x
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   void EnableEndInterrupts( struct trident_card *trident)&n;  &n;   Description: This routine will enable end of loop interrupts.&n;                End of loop interrupts will occur when a running&n;                channel reaches ESO.&n;  &n;   Parameters:  trident - pointer to target device class for 4DWave.&n;  &n;   returns:     TRUE if everything went ok, else FALSE.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|EnableEndInterrupts
r_static
r_int
id|EnableEndInterrupts
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
)paren
(brace
r_int
r_int
id|GlobalControl
suffix:semicolon
id|GlobalControl
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident
comma
id|T4D_LFO_GC_CIR
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|GlobalControl
op_or_assign
l_int|0x10
suffix:semicolon
id|outb
c_func
(paren
id|GlobalControl
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|T4D_LFO_GC_CIR
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) globctl=%02X&bslash;n&quot;
comma
id|GlobalControl
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) enabled end interrupts&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;e   void DisableEndInterrupts( struct trident_card *trident)&n;  &n;   Description: This routine will disable end of loop interrupts.&n;                End of loop interrupts will occur when a running&n;                channel reaches ESO.&n;  &n;   Parameters:  &n;                trident - pointer to target device class for 4DWave.&n;  &n;   returns:     TRUE if everything went ok, else FALSE.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|DisableEndInterrupts
r_static
r_int
id|DisableEndInterrupts
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
)paren
(brace
r_int
r_int
id|GlobalControl
suffix:semicolon
id|GlobalControl
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident
comma
id|T4D_LFO_GC_CIR
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|GlobalControl
op_and_assign
op_complement
l_int|0x10
suffix:semicolon
id|outb
c_func
(paren
id|GlobalControl
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|T4D_LFO_GC_CIR
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) disabled end interrupts&bslash;n&quot;
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) globctl=%02X&bslash;n&quot;
comma
id|GlobalControl
)paren
suffix:semicolon
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   void trident_enable_voice_irq( unsigned int HwChannel )&n;  &n;    Description: Enable an interrupt channel, any channel 0 thru n.&n;                 This routine automatically handles the fact that there are&n;                 more than 32 channels available.&n;  &n;    Parameters : HwChannel - Channel number 0 thru n.&n;                 trident - pointer to target device class for 4DWave.&n;  &n;    Return Value: None.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|trident_enable_voice_irq
r_void
id|trident_enable_voice_irq
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
r_int
id|HwChannel
)paren
(brace
r_int
r_int
id|x
comma
id|Data
comma
id|ChanDwordCount
suffix:semicolon
id|x
op_assign
id|HwChannel
op_rshift
l_int|5
suffix:semicolon
id|Data
op_assign
l_int|1
op_lshift
(paren
id|HwChannel
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|ChanDwordCount
op_assign
id|trident-&gt;ChanDwordCount
suffix:semicolon
id|IReadAinten
c_func
(paren
op_amp
id|trident-&gt;ChRegs
)paren
suffix:semicolon
id|trident-&gt;ChRegs.lpChAinten
(braket
id|x
)braket
op_or_assign
id|Data
suffix:semicolon
id|IWriteAinten
c_func
(paren
op_amp
id|trident-&gt;ChRegs
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) enabled voice IRQ %d&bslash;n&quot;
comma
id|HwChannel
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   void trident_disable_voice_irq( unsigned int HwChannel )&n;  &n;    Description: Disable an interrupt channel, any channel 0 thru n.&n;                 This routine automatically handles the fact that there are&n;                 more than 32 channels available.&n;  &n;    Parameters : HwChannel - Channel number 0 thru n.&n;                 trident - pointer to target device class for 4DWave.&n;  &n;    Return Value: None.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|trident_disable_voice_irq
r_void
id|trident_disable_voice_irq
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
r_int
id|HwChannel
)paren
(brace
r_int
r_int
id|x
comma
id|Data
comma
id|ChanDwordCount
suffix:semicolon
id|x
op_assign
id|HwChannel
op_rshift
l_int|5
suffix:semicolon
id|Data
op_assign
l_int|1
op_lshift
(paren
id|HwChannel
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|ChanDwordCount
op_assign
id|trident-&gt;ChanDwordCount
suffix:semicolon
id|IReadAinten
c_func
(paren
op_amp
id|trident-&gt;ChRegs
)paren
suffix:semicolon
id|trident-&gt;ChRegs.lpChAinten
(braket
id|x
)braket
op_and_assign
op_complement
id|Data
suffix:semicolon
id|IWriteAinten
c_func
(paren
op_amp
id|trident-&gt;ChRegs
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) disabled voice IRQ %d&bslash;n&quot;
comma
id|HwChannel
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   unsigned int AllocateChannelPCM( void )&n;  &n;    Description: Allocate hardware channel by reverse order (63-0).&n;  &n;    Parameters :  trident - pointer to target device class for 4DWave.&n;  &n;    Return Value: hardware channel - 0-63 or -1 when no channel is available&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|AllocateChannelPCM
r_static
r_int
id|AllocateChannelPCM
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
)paren
(brace
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;ChanPCMcnt
op_ge
id|trident-&gt;ChanPCM
)paren
(brace
id|M_printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;(trident) no channels available.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|idx
op_assign
l_int|31
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|trident-&gt;ChanMap
(braket
l_int|1
)braket
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
id|trident-&gt;ChanMap
(braket
l_int|1
)braket
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|trident-&gt;ChanPCMcnt
op_increment
suffix:semicolon
r_return
id|idx
op_plus
l_int|32
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|idx
op_assign
l_int|31
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|trident-&gt;ChanMap
(braket
l_int|0
)braket
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
id|trident-&gt;ChanMap
(braket
l_int|0
)braket
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|trident-&gt;ChanPCMcnt
op_increment
suffix:semicolon
r_return
id|idx
suffix:semicolon
)brace
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   void FreeChannelPCM( int channel )&n;  &n;    Description: Free hardware channel.&n;  &n;    Parameters :  trident - pointer to target device class for 4DWave.&n;&t;          channel - hardware channel number 0-63&n;  &n;    Return Value: none&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|FreeChannelPCM
r_static
r_void
id|FreeChannelPCM
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
id|channel
)paren
(brace
r_if
c_cond
(paren
id|channel
template_param
l_int|63
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;ChanMap
(braket
id|channel
op_rshift
l_int|5
)braket
op_amp
(paren
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
)paren
)paren
(brace
id|trident-&gt;ChanMap
(braket
id|channel
op_rshift
l_int|5
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
id|trident-&gt;ChanPCMcnt
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   void trident_start_voice( ULONG HwChannel )&n;  &n;    Description: Start a channel, any channel 0 thru n.&n;                 This routine automatically handles the fact that there are&n;                 more than 32 channels available.&n;  &n;    Parameters : HwChannel - Channel number 0 thru n.&n;                 trident - pointer to target device class for 4DWave.&n;  &n;    Return Value: None.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|trident_start_voice
r_void
id|trident_start_voice
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
r_int
id|HwChannel
)paren
(brace
r_int
r_int
id|x
op_assign
id|HwChannel
op_rshift
l_int|5
suffix:semicolon
r_int
r_int
id|Data
op_assign
l_int|1
op_lshift
(paren
id|HwChannel
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|outl
c_func
(paren
id|Data
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|trident-&gt;ChRegs.lpAChStart
(braket
id|x
)braket
)paren
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) start voice %d&bslash;n&quot;
comma
id|HwChannel
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   void trident_stop_voice( ULONG HwChannel )&n;  &n;    Description: Stop a channel, any channel 0 thru n.&n;                 This routine automatically handles the fact that there are&n;                 more than 32 channels available.&n;  &n;    Parameters : HwChannel - Channel number 0 thru n.&n;                 trident - pointer to target device class for 4DWave.&n;  &n;    Return Value: None.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|trident_stop_voice
r_void
id|trident_stop_voice
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
r_int
id|HwChannel
)paren
(brace
r_int
r_int
id|x
op_assign
id|HwChannel
op_rshift
l_int|5
suffix:semicolon
r_int
r_int
id|Data
op_assign
l_int|1
op_lshift
(paren
id|HwChannel
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|outl
c_func
(paren
id|Data
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|trident-&gt;ChRegs.lpAChStop
(braket
id|x
)braket
)paren
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) stop voice %d&bslash;n&quot;
comma
id|HwChannel
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   int DidChannelInterrupt( )&n;  &n;   Description:  Check if interrupt channel occurred.&n;  &n;   Parameters :  trident - pointer to target device class for 4DWave.&n;  &n;   Return Value: TRUE if interrupt occurred, else FALSE.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|DidChannelInterrupt
r_static
r_int
id|DidChannelInterrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
id|channel
)paren
(brace
r_int
r_int
id|ChanDwordCount
op_assign
id|trident-&gt;ChanDwordCount
suffix:semicolon
r_int
r_int
id|x
op_assign
id|channel
op_rshift
l_int|5
suffix:semicolon
r_int
r_int
id|dwMask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|ReadAint
c_func
(paren
op_amp
id|trident-&gt;ChRegs
)paren
suffix:semicolon
r_return
(paren
id|trident-&gt;ChRegs.lpChAint
(braket
id|x
)braket
op_amp
id|dwMask
)paren
ques
c_cond
id|TRUE
suffix:colon
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   void AckChannelInterrupt( )&n;  &n;   Description:  Acknowledge the interrupt bit for channel intrs.&n;  &n;   Parameters :  trident - pointer to target device class for 4DWave.&n;  &n;   Return Value: None&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|AckChannelInterrupt
r_static
r_void
id|AckChannelInterrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
id|channel
)paren
(brace
r_int
r_int
id|ChanDwordCount
op_assign
id|trident-&gt;ChanDwordCount
suffix:semicolon
r_int
r_int
id|x
op_assign
id|channel
op_rshift
l_int|5
suffix:semicolon
r_int
r_int
id|dwMask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|ReadAint
c_func
(paren
op_amp
id|trident-&gt;ChRegs
)paren
suffix:semicolon
id|trident-&gt;ChRegs.lpChAint
(braket
id|x
)braket
op_and_assign
id|dwMask
suffix:semicolon
id|IWriteAint
c_func
(paren
op_amp
id|trident-&gt;ChRegs
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   int LoadDeltaHw( unsigned int HwChannel, unsigned int Delta )&n;  &n;   Description: This routine writes Delta to the hardware.&n;  &n;   Parameters:  Delta - data to write (2 Bytes only)&n;                HwChannel - Hardware channel to write to.&n;   &t;&t;trident - pointer to target device class for 4DWave.&n;  &n;   Returns:     TRUE if all goes well, else FALSE. &n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|LoadDeltaHw
r_static
r_int
id|LoadDeltaHw
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
r_int
id|HwChannel
comma
r_int
r_int
id|Delta
)paren
(brace
id|outb
c_func
(paren
id|HwChannel
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;card_type
op_ne
id|TYPE_4DWAVE_NX
)paren
(brace
id|outw
c_func
(paren
(paren
r_int
r_int
)paren
id|Delta
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|CH_DX_ESO_DELTA
)paren
)paren
suffix:semicolon
)brace
r_else
singleline_comment|// ID_4DWAVE_NX
(brace
id|outb
c_func
(paren
(paren
r_int
r_char
)paren
id|Delta
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|CH_NX_DELTA_CSO
op_plus
l_int|3
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_int
r_char
)paren
(paren
id|Delta
op_rshift
l_int|8
)paren
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|CH_NX_DELTA_ESO
op_plus
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   int LoadVirtualChannel( ULONG *Data, ULONG HwChannel)&n;  &n;   Description: This routine writes all required channel registers to hardware.&n;  &n;   Parameters:  *Data - a pointer to the data to write (5 ULONGS always).&n;                HwChannel - Hardware channel to write to.&n;   &t;&t;trident - pointer to target device class for 4DWave.&n;  &n;   Returns:     TRUE if all goes well, else FALSE. &n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|LoadVirtualChannel
r_static
r_int
id|LoadVirtualChannel
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
r_int
op_star
id|Data
comma
r_int
r_int
id|HwChannel
)paren
(brace
r_int
r_int
id|ChanData
(braket
id|CHANNEL_REGS
)braket
suffix:semicolon
r_int
r_int
id|ULONGSToDo
op_assign
id|CHANNEL_REGS
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
r_int
id|Address
op_assign
id|CHANNEL_START
suffix:semicolon
multiline_comment|/* Copy the data first... Hack... Before mucking with Volume! */
id|memcpy
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|ChanData
comma
(paren
r_int
r_char
op_star
)paren
id|Data
comma
id|ULONGSToDo
op_star
l_int|4
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_int
r_char
)paren
id|HwChannel
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ULONGSToDo
suffix:semicolon
id|i
op_increment
comma
id|Address
op_add_assign
l_int|4
)paren
id|outl
c_func
(paren
id|ChanData
(braket
id|i
)braket
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|Address
)paren
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) load virtual channel %d&bslash;n&quot;
comma
id|HwChannel
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   trident_write_voice_regs&n;  &n;   Description: This routine will write the 5 hardware channel registers&n;                to hardware.&n;  &n;   Paramters:   trident - pointer to target device class for 4DWave.&n;                Channel - Real or Virtual channel number.&n;                Each register field.&n;  &n;   Returns:     TRUE if all goes well, else FALSE. &n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|trident_write_voice_regs
r_int
id|trident_write_voice_regs
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
r_int
r_int
id|Channel
comma
r_int
r_int
id|LBA
comma
r_int
r_int
id|CSO
comma
r_int
r_int
id|ESO
comma
r_int
r_int
id|DELTA
comma
r_int
r_int
id|ALPHA_FMS
comma
r_int
r_int
id|FMC_RVOL_CVOL
comma
r_int
r_int
id|GVSEL
comma
r_int
r_int
id|PAN
comma
r_int
r_int
id|VOL
comma
r_int
r_int
id|CTRL
comma
r_int
r_int
id|EC
)paren
(brace
r_int
r_int
id|ChanData
(braket
id|CHANNEL_REGS
op_plus
l_int|1
)braket
comma
id|FmcRvolCvol
suffix:semicolon
id|ChanData
(braket
l_int|1
)braket
op_assign
id|LBA
suffix:semicolon
id|ChanData
(braket
l_int|4
)braket
op_assign
(paren
id|GVSEL
op_lshift
l_int|31
)paren
op_or
(paren
(paren
id|PAN
op_amp
l_int|0x0000007f
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|VOL
op_amp
l_int|0x000000ff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|CTRL
op_amp
l_int|0x0000000f
)paren
op_lshift
l_int|12
)paren
op_or
(paren
id|EC
op_amp
l_int|0x00000fff
)paren
suffix:semicolon
id|FmcRvolCvol
op_assign
id|FMC_RVOL_CVOL
op_amp
l_int|0x0000ffff
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;card_type
op_ne
id|TYPE_4DWAVE_NX
)paren
(brace
id|ChanData
(braket
l_int|0
)braket
op_assign
(paren
id|CSO
op_lshift
l_int|16
)paren
op_or
(paren
id|ALPHA_FMS
op_amp
l_int|0x0000ffff
)paren
suffix:semicolon
id|ChanData
(braket
l_int|2
)braket
op_assign
(paren
id|ESO
op_lshift
l_int|16
)paren
op_or
(paren
id|DELTA
op_amp
l_int|0x0ffff
)paren
suffix:semicolon
id|ChanData
(braket
l_int|3
)braket
op_assign
id|FmcRvolCvol
suffix:semicolon
)brace
r_else
singleline_comment|// ID_4DWAVE_NX
(brace
id|ChanData
(braket
l_int|0
)braket
op_assign
(paren
id|DELTA
op_lshift
l_int|24
)paren
op_or
(paren
id|CSO
op_amp
l_int|0x00ffffff
)paren
suffix:semicolon
id|ChanData
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|DELTA
op_lshift
l_int|16
)paren
op_amp
l_int|0xff000000
)paren
op_or
(paren
id|ESO
op_amp
l_int|0x00ffffff
)paren
suffix:semicolon
id|ChanData
(braket
l_int|3
)braket
op_assign
(paren
id|ALPHA_FMS
op_lshift
l_int|16
)paren
op_or
id|FmcRvolCvol
suffix:semicolon
)brace
id|LoadVirtualChannel
c_func
(paren
id|trident
comma
id|ChanData
comma
id|Channel
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
DECL|function|compute_rate
r_static
r_int
id|compute_rate
c_func
(paren
id|u32
id|rate
)paren
(brace
r_int
id|delta
suffix:semicolon
singleline_comment|// We special case 44100 and 8000 since rounding with the equation
singleline_comment|// does not give us an accurate enough value. For 11025 and 22050
singleline_comment|// the equation gives us the best answer. All other frequencies will
singleline_comment|// also use the equation. JDW
r_if
c_cond
(paren
id|rate
op_eq
l_int|44100
)paren
id|delta
op_assign
l_int|0xeb3
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|8000
)paren
id|delta
op_assign
l_int|0x2ab
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|48000
)paren
id|delta
op_assign
l_int|0x1000
suffix:semicolon
r_else
id|delta
op_assign
(paren
(paren
(paren
id|rate
op_lshift
l_int|12
)paren
op_plus
id|rate
)paren
op_div
l_int|48000
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
r_return
id|delta
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   trident_set_dac_rate&n;  &n;   Description: This routine will set the sample rate for playback.&n;  &n;   Paramters:   trident - pointer to target device class for 4DWave.&n;                rate    - desired sample rate&n;                set     - actually write hardware if set is true.&n;  &n;   Returns:     The rate allowed by device.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|trident_set_dac_rate
r_static
r_int
r_int
id|trident_set_dac_rate
c_func
(paren
r_struct
id|trident_state
op_star
id|trident
comma
r_int
r_int
id|rate
comma
r_int
id|set
)paren
(brace
r_int
r_int
id|delta
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|delta
op_assign
id|compute_rate
c_func
(paren
id|rate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set
)paren
(brace
singleline_comment|//Select channel window
id|outb
c_func
(paren
id|trident-&gt;dma_dac.chan
(braket
l_int|1
)braket
comma
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;card-&gt;card_type
op_ne
id|TYPE_4DWAVE_NX
)paren
id|outw
c_func
(paren
id|delta
comma
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|CH_DX_ESO_DELTA
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_else
singleline_comment|// ID_4DWAVE_NX
(brace
id|outb
c_func
(paren
id|delta
op_amp
l_int|0xff
comma
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|CH_NX_DELTA_CSO
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|delta
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|CH_NX_DELTA_ESO
)paren
)paren
suffix:semicolon
)brace
)brace
id|M_printk
c_func
(paren
l_string|&quot;(trident) called trident_set_dac_rate : rate = %d, set = %d delta = %4x&bslash;n&quot;
comma
id|rate
comma
id|set
comma
id|delta
)paren
suffix:semicolon
id|trident-&gt;ratedac
op_assign
id|rate
suffix:semicolon
r_return
id|rate
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------&n;   trident_set_adc_rate&n;  &n;   Description: This routine will set the sample rate for capture.&n;  &n;   Paramters:   trident - pointer to target device class for 4DWave.&n;                rate    - desired sample rate&n;                set     - actually write hardware if set is true.&n;  &n;   Returns:     The rate allowed by device.&n;  &n;  ---------------------------------------------------------------------------*/
DECL|function|trident_set_adc_rate
r_static
r_int
r_int
id|trident_set_adc_rate
c_func
(paren
r_struct
id|trident_state
op_star
id|trident
comma
r_int
r_int
id|rate
comma
r_int
id|set
)paren
(brace
singleline_comment|//snd_printk(&quot;trid: called trident_set_adc_rate&bslash;n&quot;);
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|trident-&gt;rateadc
op_assign
id|rate
suffix:semicolon
multiline_comment|/*&n;&t; *&t;FIXME: hit the hardware&n;&t; */
r_return
id|rate
suffix:semicolon
)brace
DECL|function|ld2
r_extern
id|__inline__
r_int
id|ld2
c_func
(paren
r_int
r_int
id|x
)paren
(brace
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|x
op_ge
l_int|0x10000
)paren
(brace
id|x
op_rshift_assign
l_int|16
suffix:semicolon
id|r
op_add_assign
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|0x100
)paren
(brace
id|x
op_rshift_assign
l_int|8
suffix:semicolon
id|r
op_add_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|0x10
)paren
(brace
id|x
op_rshift_assign
l_int|4
suffix:semicolon
id|r
op_add_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|4
)paren
(brace
id|x
op_rshift_assign
l_int|2
suffix:semicolon
id|r
op_add_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|2
)paren
id|r
op_increment
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|devs
r_static
r_struct
id|trident_card
op_star
id|devs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; *&t;Trident AC97 codec programming interface.&n; */
DECL|function|trident_ac97_set
r_static
r_void
id|trident_ac97_set
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
id|u8
id|cmd
comma
id|u16
id|val
)paren
(brace
r_int
r_int
id|address
comma
id|data
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0xffff
suffix:semicolon
id|data
op_assign
(paren
(paren
r_int
r_int
)paren
id|val
)paren
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;card_type
op_ne
id|TYPE_4DWAVE_NX
)paren
(brace
id|address
op_assign
id|DX_ACR0_AC97_W
suffix:semicolon
multiline_comment|/* read AC-97 write register status */
r_do
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident
comma
id|address
)paren
)paren
op_amp
l_int|0x8000
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
suffix:semicolon
)brace
id|data
op_or_assign
(paren
l_int|0x8000
op_or
(paren
id|cmd
op_amp
l_int|0x000000ff
)paren
)paren
suffix:semicolon
)brace
r_else
singleline_comment|// ID_4DWAVE_NX
(brace
id|address
op_assign
id|NX_ACR1_AC97_W
suffix:semicolon
multiline_comment|/* read AC-97 write register status */
r_do
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident
comma
id|address
)paren
)paren
op_amp
l_int|0x0800
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
suffix:semicolon
id|data
op_or_assign
(paren
l_int|0x0800
op_or
(paren
id|cmd
op_amp
l_int|0x000000ff
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: AC97 CODEC write timed out.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|address
)paren
)paren
suffix:semicolon
)brace
DECL|function|trident_ac97_get
r_static
id|u16
id|trident_ac97_get
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
comma
id|u8
id|cmd
)paren
(brace
r_int
r_int
id|data
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;card_type
op_ne
id|TYPE_4DWAVE_NX
)paren
(brace
id|data
op_assign
(paren
l_int|0x00008000L
op_or
(paren
id|cmd
op_amp
l_int|0x000000ff
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|DX_ACR1_AC97_R
)paren
)paren
suffix:semicolon
r_do
(brace
id|data
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident
comma
id|DX_ACR1_AC97_R
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
l_int|0x0008000
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
suffix:semicolon
)brace
)brace
r_else
singleline_comment|// ID_4DWAVE_NX
(brace
id|data
op_assign
(paren
l_int|0x00000800L
op_or
(paren
id|cmd
op_amp
l_int|0x000000ff
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|NX_ACR2_AC97_R_PRIMARY
)paren
)paren
suffix:semicolon
r_do
(brace
id|data
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident
comma
id|NX_ACR2_AC97_R_PRIMARY
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
l_int|0x00000C00
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;trident: AC97 CODEC read timed out.&bslash;n&quot;
)paren
suffix:semicolon
id|data
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
(paren
r_int
r_int
)paren
(paren
id|data
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* OSS interface to the ac97s.. */
DECL|macro|AC97_STEREO_MASK
mdefine_line|#define AC97_STEREO_MASK (SOUND_MASK_VOLUME|&bslash;&n;&t;SOUND_MASK_PCM|SOUND_MASK_LINE|SOUND_MASK_CD|&bslash;&n;&t;SOUND_MASK_VIDEO|SOUND_MASK_LINE1|SOUND_MASK_IGAIN)
DECL|macro|AC97_SUPPORTED_MASK
mdefine_line|#define AC97_SUPPORTED_MASK (AC97_STEREO_MASK | &bslash;&n;&t;SOUND_MASK_BASS|SOUND_MASK_TREBLE|SOUND_MASK_MIC|&bslash;&n;&t;SOUND_MASK_SPEAKER)
DECL|macro|AC97_RECORD_MASK
mdefine_line|#define AC97_RECORD_MASK (SOUND_MASK_MIC|&bslash;&n;&t;SOUND_MASK_CD| SOUND_MASK_VIDEO| SOUND_MASK_LINE1| SOUND_MASK_LINE|&bslash;&n;&t;SOUND_MASK_PHONEIN)
DECL|macro|supported_mixer
mdefine_line|#define supported_mixer(CARD,FOO) ( CARD-&gt;mix.supported_mixers &amp; (1&lt;&lt;FOO) )
multiline_comment|/* this table has default mixer values for all OSS mixers.&n;&t;be sure to fill it in if you add oss mixers&n;&t;to anyone&squot;s supported mixer defines */
multiline_comment|/* possible __init */
DECL|struct|mixer_defaults
r_static
r_struct
id|mixer_defaults
(brace
DECL|member|mixer
r_int
id|mixer
suffix:semicolon
DECL|member|value
r_int
r_int
id|value
suffix:semicolon
DECL|variable|mixer_defaults
)brace
id|mixer_defaults
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
multiline_comment|/* all values 0 -&gt; 100 in bytes */
(brace
id|SOUND_MIXER_VOLUME
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_BASS
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_TREBLE
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_SPEAKER
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_MIC
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_LINE
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_CD
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_VIDEO
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_LINE1
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_PCM
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_IGAIN
comma
l_int|0x3232
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|struct|ac97_mixer_hw
r_static
r_struct
id|ac97_mixer_hw
(brace
DECL|member|offset
r_int
r_char
id|offset
suffix:semicolon
DECL|member|scale
r_int
id|scale
suffix:semicolon
DECL|variable|ac97_hw
)brace
id|ac97_hw
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_VOLUME
)braket
op_assign
(brace
l_int|0x02
comma
l_int|63
)brace
comma
(braket
id|SOUND_MIXER_BASS
)braket
op_assign
(brace
l_int|0x08
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_TREBLE
)braket
op_assign
(brace
l_int|0x08
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_SPEAKER
)braket
op_assign
(brace
l_int|0x0a
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
(brace
l_int|0x0e
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_LINE
)braket
op_assign
(brace
l_int|0x10
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_CD
)braket
op_assign
(brace
l_int|0x12
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_VIDEO
)braket
op_assign
(brace
l_int|0x14
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_LINE1
)braket
op_assign
(brace
l_int|0x16
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_PCM
)braket
op_assign
(brace
l_int|0x18
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_IGAIN
)braket
op_assign
(brace
l_int|0x1c
comma
l_int|31
)brace
)brace
suffix:semicolon
macro_line|#if 0 /* *shrug* removed simply because we never used it.&n;&t;&t;feel free to implement again if needed */
multiline_comment|/* reads the given OSS mixer from the ac97&n;&t;the caller must have insured that the ac97 knows&n;&t;about that given mixer, and should be holding a&n;&t;spinlock for the card */
r_static
r_int
id|ac97_read_mixer
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|mixer
)paren
(brace
id|u16
id|val
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|ac97_mixer_hw
op_star
id|mh
op_assign
op_amp
id|ac97_hw
(braket
id|mixer
)braket
suffix:semicolon
id|val
op_assign
id|trident_ac97_get
c_func
(paren
id|card
comma
id|mh-&gt;offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AC97_STEREO_MASK
op_amp
(paren
l_int|1
op_lshift
id|mixer
)paren
)paren
(brace
multiline_comment|/* nice stereo mixers .. */
r_int
id|left
comma
id|right
suffix:semicolon
id|left
op_assign
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|right
op_assign
id|val
op_amp
l_int|0x7f
suffix:semicolon
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_IGAIN
)paren
(brace
id|right
op_assign
(paren
id|right
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
suffix:semicolon
id|left
op_assign
(paren
id|left
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
suffix:semicolon
r_else
(brace
id|right
op_assign
l_int|100
op_minus
(paren
(paren
id|right
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
id|left
op_assign
l_int|100
op_minus
(paren
(paren
id|left
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_SPEAKER
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
(paren
id|val
op_amp
l_int|0x1e
)paren
op_rshift
l_int|1
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_MIC
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0x1f
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
multiline_comment|/*  the low bit is optional in the tone sliders and masking&n;&t;&t;it lets is avoid the 0xf &squot;bypass&squot;.. */
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_BASS
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xe
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_TREBLE
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0xe
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;read mixer %d (0x%x) %x -&gt; %x&bslash;n&quot;
comma
id|mixer
comma
id|mh-&gt;offset
comma
id|val
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* write the OSS encoded volume to the given OSS encoded mixer,&n;&t;again caller&squot;s job to make sure all is well in arg land,&n;&t;call with spinlock held */
DECL|function|ac97_write_mixer
r_static
r_void
id|ac97_write_mixer
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|mixer
comma
r_int
r_int
id|left
comma
r_int
r_int
id|right
)paren
(brace
id|u16
id|val
op_assign
l_int|0
suffix:semicolon
r_struct
id|ac97_mixer_hw
op_star
id|mh
op_assign
op_amp
id|ac97_hw
(braket
id|mixer
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;(trident) wrote ac97 mixer %d (0x%x) %d,%d&quot;
comma
id|mixer
comma
id|mh-&gt;offset
comma
id|left
comma
id|right
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AC97_STEREO_MASK
op_amp
(paren
l_int|1
op_lshift
id|mixer
)paren
)paren
(brace
multiline_comment|/* stereo mixers */
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_IGAIN
)paren
(brace
id|right
op_assign
(paren
id|right
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
id|left
op_assign
(paren
id|left
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
)brace
r_else
(brace
id|right
op_assign
(paren
(paren
l_int|100
op_minus
id|right
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
)brace
id|val
op_assign
(paren
id|left
op_lshift
l_int|8
)paren
op_or
id|right
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_SPEAKER
)paren
(brace
id|val
op_assign
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
op_lshift
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_MIC
)paren
(brace
id|val
op_assign
id|trident_ac97_get
c_func
(paren
id|card
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x801f
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
suffix:semicolon
multiline_comment|/*  the low bit is optional in the tone sliders and masking&n;&t;&t;it lets us avoid the 0xf &squot;bypass&squot;.. */
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_BASS
)paren
(brace
id|val
op_assign
id|trident_ac97_get
c_func
(paren
id|card
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x0f00
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
op_lshift
l_int|8
)paren
op_amp
l_int|0x0e00
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mixer
op_eq
id|SOUND_MIXER_TREBLE
)paren
(brace
id|val
op_assign
id|trident_ac97_get
c_func
(paren
id|card
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x000f
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
op_amp
l_int|0x000e
suffix:semicolon
)brace
id|trident_ac97_set
c_func
(paren
id|card
comma
id|mh-&gt;offset
comma
id|val
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; -&gt; %x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/* the following tables allow us to go from &n;&t;OSS &lt;-&gt; ac97 quickly. */
DECL|enum|ac97_recsettings
r_enum
id|ac97_recsettings
(brace
DECL|enumerator|AC97_REC_MIC
id|AC97_REC_MIC
op_assign
l_int|0
comma
DECL|enumerator|AC97_REC_CD
id|AC97_REC_CD
comma
DECL|enumerator|AC97_REC_VIDEO
id|AC97_REC_VIDEO
comma
DECL|enumerator|AC97_REC_AUX
id|AC97_REC_AUX
comma
DECL|enumerator|AC97_REC_LINE
id|AC97_REC_LINE
comma
DECL|enumerator|AC97_REC_STEREO
id|AC97_REC_STEREO
comma
multiline_comment|/* combination of all enabled outputs..  */
DECL|enumerator|AC97_REC_MONO
id|AC97_REC_MONO
comma
multiline_comment|/*.. or the mono equivalent */
DECL|enumerator|AC97_REC_PHONE
id|AC97_REC_PHONE
)brace
suffix:semicolon
DECL|variable|ac97_rm2oss
r_static
r_int
r_int
id|ac97_rm2oss
(braket
)braket
op_assign
(brace
(braket
id|AC97_REC_MIC
)braket
op_assign
id|SOUND_MIXER_MIC
comma
(braket
id|AC97_REC_CD
)braket
op_assign
id|SOUND_MIXER_CD
comma
(braket
id|AC97_REC_VIDEO
)braket
op_assign
id|SOUND_MIXER_VIDEO
comma
(braket
id|AC97_REC_AUX
)braket
op_assign
id|SOUND_MIXER_LINE1
comma
(braket
id|AC97_REC_LINE
)braket
op_assign
id|SOUND_MIXER_LINE
comma
(braket
id|AC97_REC_PHONE
)braket
op_assign
id|SOUND_MIXER_PHONEIN
)brace
suffix:semicolon
multiline_comment|/* indexed by bit position */
DECL|variable|ac97_oss_rm
r_static
r_int
r_int
id|ac97_oss_rm
(braket
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
id|AC97_REC_MIC
comma
(braket
id|SOUND_MIXER_CD
)braket
op_assign
id|AC97_REC_CD
comma
(braket
id|SOUND_MIXER_VIDEO
)braket
op_assign
id|AC97_REC_VIDEO
comma
(braket
id|SOUND_MIXER_LINE1
)braket
op_assign
id|AC97_REC_AUX
comma
(braket
id|SOUND_MIXER_LINE
)braket
op_assign
id|AC97_REC_LINE
comma
(braket
id|SOUND_MIXER_PHONEIN
)braket
op_assign
id|AC97_REC_PHONE
)brace
suffix:semicolon
multiline_comment|/* read or write the recmask &n;&t;the ac97 can really have left and right recording&n;&t;inputs independantly set, but OSS doesn&squot;t seem to &n;&t;want us to express that to the user. &n;&t;the caller guarantees that we have a supported bit set,&n;&t;and they must be holding the card&squot;s spinlock */
DECL|function|ac97_recmask_io
r_static
r_int
id|ac97_recmask_io
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|rw
comma
r_int
id|mask
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|rw
)paren
(brace
multiline_comment|/* read it from the card */
id|val
op_assign
id|trident_ac97_get
c_func
(paren
id|card
comma
l_int|0x1a
)paren
op_amp
l_int|0x7
suffix:semicolon
r_return
id|ac97_rm2oss
(braket
id|val
)braket
suffix:semicolon
)brace
multiline_comment|/* else, write the first set in the mask as the&n;&t;&t;output */
id|val
op_assign
id|ffs
c_func
(paren
id|mask
)paren
suffix:semicolon
id|val
op_assign
id|ac97_oss_rm
(braket
id|val
op_minus
l_int|1
)braket
suffix:semicolon
id|val
op_or_assign
id|val
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* set both channels */
id|printk
c_func
(paren
l_string|&quot;trident: setting ac97 recmask to 0x%x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|card
comma
l_int|0x1a
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Generic AC97 codec initialisation. Need to check there are no&n; *&t;quirks for the Trident cards.&n; */
DECL|function|trident_ac97_init
r_static
id|u16
id|trident_ac97_init
c_func
(paren
r_struct
id|trident_card
op_star
id|trident
)paren
(brace
id|trident-&gt;mix.supported_mixers
op_assign
id|AC97_SUPPORTED_MASK
suffix:semicolon
id|trident-&gt;mix.stereo_mixers
op_assign
id|AC97_STEREO_MASK
suffix:semicolon
id|trident-&gt;mix.record_sources
op_assign
id|AC97_RECORD_MASK
suffix:semicolon
multiline_comment|/*&t;trident-&gt;mix.read_mixer = ac97_read_mixer;*/
id|trident-&gt;mix.write_mixer
op_assign
id|ac97_write_mixer
suffix:semicolon
id|trident-&gt;mix.recmask_io
op_assign
id|ac97_recmask_io
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;card_type
op_eq
id|TYPE_4DWAVE_NX
)paren
(brace
r_int
r_int
id|VendorID1
comma
id|VendorID2
suffix:semicolon
id|outl
c_func
(paren
l_int|0x02
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
singleline_comment|// 4 Speaker Codec initialization
id|VendorID1
op_assign
id|trident_ac97_get
c_func
(paren
id|trident
comma
id|AC97_VENDOR_ID1
)paren
suffix:semicolon
id|VendorID2
op_assign
id|trident_ac97_get
c_func
(paren
id|trident
comma
id|AC97_VENDOR_ID2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|VendorID1
op_eq
l_int|0x8384
)paren
op_logical_and
(paren
id|VendorID2
op_eq
l_int|0x7608
)paren
)paren
(brace
singleline_comment|// Sigmatel 9708.
r_int
r_int
id|TestReg
suffix:semicolon
r_int
r_int
id|DTemp
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_SIGMATEL_CIC1
comma
l_int|0xABBAL
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_SIGMATEL_CIC2
comma
l_int|0x1000L
)paren
suffix:semicolon
id|TestReg
op_assign
id|trident_ac97_get
c_func
(paren
id|trident
comma
id|AC97_SIGMATEL_BIAS2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TestReg
op_ne
l_int|0x8000
)paren
singleline_comment|// Errata Notice.
(brace
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_SIGMATEL_BIAS1
comma
l_int|0xABBAL
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_SIGMATEL_BIAS2
comma
l_int|0x0007L
)paren
suffix:semicolon
)brace
r_else
singleline_comment|// Newer version
(brace
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_SIGMATEL_CIC2
comma
l_int|0x1001L
)paren
suffix:semicolon
singleline_comment|// recommended
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_SIGMATEL_DAC2INVERT
comma
l_int|0x0008L
)paren
suffix:semicolon
)brace
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_SURROUND_MASTER
comma
l_int|0x0000L
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_HEADPHONE_VOL
comma
l_int|0x8000L
)paren
suffix:semicolon
id|DTemp
op_assign
(paren
r_int
r_int
)paren
id|trident_ac97_get
c_func
(paren
id|trident
comma
id|AC97_GENERAL_PURPOSE
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_GENERAL_PURPOSE
comma
id|DTemp
op_amp
l_int|0x0000FDFFL
)paren
suffix:semicolon
singleline_comment|// bit9 = 0.
id|DTemp
op_assign
(paren
r_int
r_int
)paren
id|trident_ac97_get
c_func
(paren
id|trident
comma
id|AC97_MIC_VOL
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_MIC_VOL
comma
id|DTemp
op_or
l_int|0x00008000L
)paren
suffix:semicolon
singleline_comment|// bit15 = 1.
id|DTemp
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|DTemp
op_or
l_int|0x0010
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|VendorID1
op_eq
l_int|0x5452
)paren
op_logical_and
(paren
id|VendorID2
op_eq
l_int|0x4108
)paren
)paren
(brace
singleline_comment|// TriTech TR28028
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_SURROUND_MASTER
comma
l_int|0x0000L
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_EXTENDED_STATUS
comma
l_int|0x0000L
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|VendorID1
op_eq
l_int|0x574D
)paren
op_logical_and
(paren
id|VendorID2
op_ge
l_int|0x4C00
)paren
op_logical_and
(paren
id|VendorID2
op_le
l_int|0x4C0f
)paren
)paren
(brace
singleline_comment|// Wolfson WM9704
id|trident_ac97_set
c_func
(paren
id|trident
comma
id|AC97_SURROUND_MASTER
comma
l_int|0x0000L
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;trident: No four Speaker Support with on board CODEC&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
singleline_comment|// S/PDIF C Channel bits 0-31 : 48khz, SCMS disabled
id|outl
c_func
(paren
l_int|0x200004
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|NX_SPCSTATUS
)paren
)paren
suffix:semicolon
singleline_comment|// Enable S/PDIF out, 48khz only from ac97 fifo
id|outb
c_func
(paren
l_int|0x28
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|NX_SPCTRL_SPCSO
op_plus
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|outl
c_func
(paren
l_int|0x02
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* this only fixes the output apu mode to be later set by start_dac and&n;&t;company.  output apu modes are set in trident_rec_setup */
DECL|function|set_fmt
r_static
r_void
id|set_fmt
c_func
(paren
r_struct
id|trident_state
op_star
id|s
comma
r_int
r_char
id|mask
comma
r_int
r_char
id|data
)paren
(brace
id|s-&gt;fmt
op_assign
(paren
id|s-&gt;fmt
op_amp
id|mask
)paren
op_or
id|data
suffix:semicolon
multiline_comment|/* Set the chip ? */
)brace
multiline_comment|/*&n; *&t;Native play back driver &n; */
multiline_comment|/* the mode passed should be already shifted and masked */
DECL|function|trident_play_setup
r_static
r_void
id|trident_play_setup
c_func
(paren
r_struct
id|trident_state
op_star
id|trident
comma
r_int
id|mode
comma
id|u32
id|rate
comma
r_void
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
r_int
r_int
id|LBA
suffix:semicolon
r_int
r_int
id|Delta
suffix:semicolon
r_int
r_int
id|ESO
suffix:semicolon
r_int
r_int
id|CTRL
suffix:semicolon
r_int
r_int
id|FMC_RVOL_CVOL
suffix:semicolon
r_int
r_int
id|GVSEL
suffix:semicolon
r_int
r_int
id|PAN
suffix:semicolon
r_int
r_int
id|VOL
suffix:semicolon
r_int
r_int
id|EC
suffix:semicolon
multiline_comment|/* set Loop Back Address */
id|LBA
op_assign
id|virt_to_bus
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|Delta
op_assign
id|compute_rate
c_func
(paren
id|rate
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) rate, delta = %d %d&bslash;n&quot;
comma
id|rate
comma
id|Delta
)paren
suffix:semicolon
multiline_comment|/* set ESO */
id|ESO
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_16BIT
)paren
id|ESO
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_STEREO
)paren
id|ESO
op_div_assign
l_int|2
suffix:semicolon
id|ESO
op_assign
id|ESO
op_minus
l_int|1
suffix:semicolon
singleline_comment|//snd_printk(&quot;trid: ESO = %d&bslash;n&quot;, ESO);
multiline_comment|/* set ctrl mode&n;&t;   CTRL default: 8-bit (unsigned) mono, loop mode enabled&n;&t; */
id|CTRL
op_assign
l_int|0x00000001
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_16BIT
)paren
(brace
id|CTRL
op_or_assign
l_int|0x00000008
suffix:semicolon
singleline_comment|// 16-bit data
id|CTRL
op_or_assign
l_int|0x00000002
suffix:semicolon
singleline_comment|// signed data
)brace
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_STEREO
)paren
id|CTRL
op_or_assign
l_int|0x00000004
suffix:semicolon
singleline_comment|// stereo data
singleline_comment|//FMC_RVOL_CVOL = 0x0000c000;
id|FMC_RVOL_CVOL
op_assign
l_int|0x0000ffff
suffix:semicolon
id|GVSEL
op_assign
l_int|1
suffix:semicolon
id|PAN
op_assign
l_int|0
suffix:semicolon
id|VOL
op_assign
l_int|0
suffix:semicolon
id|EC
op_assign
l_int|0
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|trident-&gt;card
comma
id|trident-&gt;dma_dac.chan
(braket
l_int|1
)braket
comma
id|LBA
comma
l_int|0
comma
multiline_comment|/* cso */
id|ESO
comma
id|Delta
comma
l_int|0
comma
multiline_comment|/* alpha */
id|FMC_RVOL_CVOL
comma
id|GVSEL
comma
id|PAN
comma
id|VOL
comma
id|CTRL
comma
id|EC
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Native record driver &n; */
multiline_comment|/* again, passed mode is alrady shifted/masked */
DECL|function|trident_rec_setup
r_static
r_void
id|trident_rec_setup
c_func
(paren
r_struct
id|trident_state
op_star
id|trident
comma
r_int
id|mode
comma
id|u32
id|rate
comma
r_void
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
r_int
r_int
id|LBA
suffix:semicolon
r_int
r_int
id|Delta
suffix:semicolon
r_int
r_int
id|ESO
suffix:semicolon
r_int
r_int
id|CTRL
suffix:semicolon
r_int
r_int
id|FMC_RVOL_CVOL
suffix:semicolon
r_int
r_int
id|GVSEL
suffix:semicolon
r_int
r_int
id|PAN
suffix:semicolon
r_int
r_int
id|VOL
suffix:semicolon
r_int
r_int
id|EC
suffix:semicolon
r_int
r_char
id|bValue
suffix:semicolon
r_int
r_int
id|wValue
suffix:semicolon
r_int
r_int
id|dwValue
suffix:semicolon
r_int
r_int
id|wRecCODECSamples
suffix:semicolon
r_int
r_int
id|dwChanFlags
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|trident-&gt;card
suffix:semicolon
singleline_comment|// Enable AC-97 ADC (capture), disable capture interrupt
r_if
c_cond
(paren
id|trident-&gt;card-&gt;card_type
op_ne
id|TYPE_4DWAVE_NX
)paren
(brace
id|bValue
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|bValue
op_or
l_int|0x48
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|wValue
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|wValue
op_or
l_int|0x1000
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
)brace
singleline_comment|// Initilize the channel and set channel Mode
id|outb
c_func
(paren
l_int|0
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|LEGACY_DMAR15
)paren
)paren
suffix:semicolon
singleline_comment|// Set DMA channel operation mode register
id|bValue
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|LEGACY_DMAR11
)paren
)paren
op_amp
l_int|0x03
suffix:semicolon
id|outb
c_func
(paren
id|bValue
op_or
l_int|0x54
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|LEGACY_DMAR11
)paren
)paren
suffix:semicolon
singleline_comment|// Set channel buffer Address
id|LBA
op_assign
id|virt_to_bus
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|outl
c_func
(paren
id|LBA
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|LEGACY_DMAR0
)paren
)paren
suffix:semicolon
multiline_comment|/* set ESO */
id|ESO
op_assign
id|size
suffix:semicolon
id|dwValue
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|LEGACY_DMAR4
)paren
)paren
op_amp
l_int|0xff000000
suffix:semicolon
id|dwValue
op_or_assign
(paren
id|ESO
op_minus
l_int|1
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
id|outl
c_func
(paren
id|dwValue
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|LEGACY_DMAR4
)paren
)paren
suffix:semicolon
singleline_comment|// Set channel sample rate , 4.12 format
id|dwValue
op_assign
(paren
(paren
(paren
r_int
r_int
)paren
l_int|48000L
op_lshift
l_int|12
)paren
op_div
(paren
r_int
r_int
)paren
(paren
id|rate
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
r_int
r_int
)paren
id|dwValue
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_SBDELTA_DELTA_R
)paren
)paren
suffix:semicolon
singleline_comment|// Set channel interrupt blk length
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_16BIT
)paren
(brace
id|wRecCODECSamples
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|ESO
op_rshift
l_int|1
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|dwChanFlags
op_assign
l_int|0xffffb000
suffix:semicolon
)brace
r_else
(brace
id|wRecCODECSamples
op_assign
(paren
r_int
r_int
)paren
(paren
id|ESO
op_minus
l_int|1
)paren
suffix:semicolon
id|dwChanFlags
op_assign
l_int|0xffff1000
suffix:semicolon
)brace
id|dwValue
op_assign
(paren
(paren
r_int
r_int
)paren
id|wRecCODECSamples
)paren
op_lshift
l_int|16
suffix:semicolon
id|dwValue
op_or_assign
(paren
r_int
r_int
)paren
(paren
id|wRecCODECSamples
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
id|outl
c_func
(paren
id|dwValue
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_SBBL_SBCL
)paren
)paren
suffix:semicolon
singleline_comment|// Right now, set format and start to run capturing, 
singleline_comment|// continuous run loop enable.
id|trident-&gt;bDMAStart
op_assign
l_int|0x19
suffix:semicolon
singleline_comment|// 0001 1001b
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_16BIT
)paren
id|trident-&gt;bDMAStart
op_or_assign
l_int|0xa0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_STEREO
)paren
id|trident-&gt;bDMAStart
op_or_assign
l_int|0x40
suffix:semicolon
singleline_comment|// Prepare capture intr channel
id|Delta
op_assign
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|rate
)paren
op_lshift
l_int|12
)paren
op_div
(paren
(paren
r_int
r_int
)paren
(paren
l_int|48000L
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* set Loop Back Address */
id|LBA
op_assign
id|virt_to_bus
c_func
(paren
id|buffer
)paren
suffix:semicolon
multiline_comment|/* set ESO */
id|ESO
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_16BIT
)paren
id|ESO
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_STEREO
)paren
id|ESO
op_div_assign
l_int|2
suffix:semicolon
id|ESO
op_assign
id|ESO
op_minus
l_int|1
suffix:semicolon
singleline_comment|//snd_printk(&quot;trid: ESO = %d&bslash;n&quot;, ESO);
multiline_comment|/* set ctrl mode&n;&t;   CTRL default: 8-bit (unsigned) mono, loop mode enabled&n;&t; */
id|CTRL
op_assign
l_int|0x00000001
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_16BIT
)paren
id|CTRL
op_or_assign
l_int|0x00000008
suffix:semicolon
singleline_comment|// 16-bit data
multiline_comment|/* XXX DO UNSIGNED XXX */
singleline_comment|//if (!(mode &amp; SND_PCM1_MODE_U))
singleline_comment|//&t;CTRL |= 0x00000002;&t;// signed data
r_if
c_cond
(paren
id|mode
op_amp
id|TRIDENT_FMT_STEREO
)paren
id|CTRL
op_or_assign
l_int|0x00000004
suffix:semicolon
singleline_comment|// stereo data
id|FMC_RVOL_CVOL
op_assign
l_int|0x0000ffff
suffix:semicolon
id|GVSEL
op_assign
l_int|1
suffix:semicolon
id|PAN
op_assign
l_int|0xff
suffix:semicolon
id|VOL
op_assign
l_int|0xff
suffix:semicolon
id|EC
op_assign
l_int|0
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|card
comma
id|trident-&gt;dma_adc.chan
(braket
l_int|0
)braket
comma
id|LBA
comma
l_int|0
comma
multiline_comment|/* cso */
id|ESO
comma
id|Delta
comma
l_int|0
comma
multiline_comment|/* alpha */
id|FMC_RVOL_CVOL
comma
id|GVSEL
comma
id|PAN
comma
id|VOL
comma
id|CTRL
comma
id|EC
)paren
suffix:semicolon
)brace
multiline_comment|/* Playback pointer */
DECL|function|get_dmaa
id|__inline__
r_int
r_int
id|get_dmaa
c_func
(paren
r_struct
id|trident_state
op_star
id|trident
)paren
(brace
r_int
r_int
id|cso
suffix:semicolon
r_int
r_int
id|eso
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
(paren
id|trident-&gt;enable
op_amp
id|ADC_RUNNING
)paren
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
id|trident-&gt;dma_dac.chan
(braket
l_int|1
)braket
comma
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;card-&gt;card_type
op_ne
id|TYPE_4DWAVE_NX
)paren
(brace
id|cso
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|CH_DX_CSO_ALPHA_FMS
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|eso
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|CH_DX_ESO_DELTA
op_plus
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
singleline_comment|// ID_4DWAVE_NX
(brace
id|cso
op_assign
(paren
r_int
r_int
)paren
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|CH_NX_DELTA_CSO
)paren
)paren
op_amp
l_int|0x00ffffff
suffix:semicolon
id|eso
op_assign
(paren
r_int
r_int
)paren
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|CH_NX_DELTA_ESO
)paren
)paren
op_amp
l_int|0x00ffffff
suffix:semicolon
)brace
id|M_printk
c_func
(paren
l_string|&quot;(trident) get_dmaa: chip reported %d.%d&bslash;n&quot;
comma
id|cso
comma
id|eso
)paren
suffix:semicolon
id|cso
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cso
OG
id|eso
)paren
id|cso
op_assign
id|eso
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
id|cso
op_mul_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
id|cso
op_mul_assign
l_int|2
suffix:semicolon
r_return
id|cso
suffix:semicolon
)brace
multiline_comment|/* Record pointer */
DECL|function|get_dmac
r_extern
id|__inline__
r_int
id|get_dmac
c_func
(paren
r_struct
id|trident_state
op_star
id|trident
)paren
(brace
r_int
r_int
id|cso
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|trident-&gt;enable
op_amp
id|DAC_RUNNING
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|trident-&gt;dma_adc.chan
(braket
l_int|0
)braket
comma
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;card-&gt;card_type
op_ne
id|TYPE_4DWAVE_NX
)paren
(brace
id|cso
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|CH_DX_CSO_ALPHA_FMS
op_plus
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// ID_4DWAVE_NX 
id|cso
op_assign
(paren
r_int
r_int
)paren
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|trident-&gt;card
comma
id|CH_NX_DELTA_CSO
)paren
)paren
op_amp
l_int|0x00ffffff
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;(trident) get_dmac: chip reported %d&bslash;n&quot;
comma
id|cso
)paren
suffix:semicolon
id|cso
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
id|cso
op_mul_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
id|cso
op_mul_assign
l_int|2
suffix:semicolon
r_return
id|cso
suffix:semicolon
)brace
r_static
r_void
id|trident_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|function|trident_kick
r_static
r_void
id|trident_kick
c_func
(paren
r_int
r_int
id|plop
)paren
(brace
id|trident_interrupt
c_func
(paren
l_int|5
comma
(paren
r_void
op_star
)paren
id|plop
comma
l_int|NULL
)paren
suffix:semicolon
id|debug_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|debug_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop recording (lock held) */
DECL|function|__stop_adc
r_extern
r_inline
r_void
id|__stop_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|s
)paren
(brace
r_struct
id|trident_card
op_star
id|trident
op_assign
id|s-&gt;card
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) stopping ADC&bslash;n&quot;
)paren
suffix:semicolon
id|s-&gt;enable
op_and_assign
op_complement
id|ADC_RUNNING
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|trident
comma
id|s-&gt;dma_adc.chan
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|trident
comma
id|T4D_SBCTRL_SBE2R_SBDD
)paren
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|trident
comma
id|s-&gt;dma_adc.chan
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|trident
comma
id|s-&gt;dma_adc.chan
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ResetAinten
c_func
(paren
id|trident
comma
id|s-&gt;dma_adc.chan
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
DECL|function|stop_adc
r_extern
r_inline
r_void
id|stop_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|s
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|trident_card
op_star
id|trident
op_assign
id|s-&gt;card
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|trident-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|trident-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* stop playback (lock held) */
DECL|function|__stop_dac
r_extern
r_inline
r_void
id|__stop_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|s
)paren
(brace
r_struct
id|trident_card
op_star
id|trident
op_assign
id|s-&gt;card
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) stopping DAC&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//trident_stop_voice(trident, s-&gt;dma_dac.chan[0]);
singleline_comment|//trident_disable_voice_irq(trident, s-&gt;dma_dac.chan[0]);
id|trident_stop_voice
c_func
(paren
id|trident
comma
id|s-&gt;dma_dac.chan
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|trident
comma
id|s-&gt;dma_dac.chan
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|s-&gt;enable
op_and_assign
op_complement
id|DAC_RUNNING
suffix:semicolon
)brace
DECL|function|stop_dac
r_extern
r_inline
r_void
id|stop_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|s
)paren
(brace
r_struct
id|trident_card
op_star
id|trident
op_assign
id|s-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|trident-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|trident-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|start_dac
r_static
r_void
id|start_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|s
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|trident_card
op_star
id|trident
op_assign
id|s-&gt;card
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s-&gt;dma_dac.mapped
op_logical_or
id|s-&gt;dma_dac.count
OG
l_int|0
)paren
op_logical_and
id|s-&gt;dma_dac.ready
)paren
(brace
id|s-&gt;enable
op_or_assign
id|DAC_RUNNING
suffix:semicolon
id|trident_enable_voice_irq
c_func
(paren
id|trident
comma
id|s-&gt;dma_dac.chan
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|trident
comma
id|s-&gt;dma_dac.chan
(braket
l_int|1
)braket
)paren
suffix:semicolon
singleline_comment|//trident_start_voice(trident, s-&gt;dma_dac.chan[0]);
id|M_printk
c_func
(paren
l_string|&quot;(trident) starting DAC&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|start_adc
r_static
r_void
id|start_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|s
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s-&gt;dma_adc.mapped
op_logical_or
id|s-&gt;dma_adc.count
OL
(paren
r_int
)paren
(paren
id|s-&gt;dma_adc.dmasize
op_minus
l_int|2
op_star
id|s-&gt;dma_adc.fragsize
)paren
)paren
op_logical_and
id|s-&gt;dma_adc.ready
)paren
(brace
id|s-&gt;enable
op_or_assign
id|ADC_RUNNING
suffix:semicolon
id|trident_enable_voice_irq
c_func
(paren
id|s-&gt;card
comma
id|s-&gt;dma_adc.chan
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|outb
c_func
(paren
id|s-&gt;bDMAStart
comma
id|TRID_REG
c_func
(paren
id|s-&gt;card
comma
id|T4D_SBCTRL_SBE2R_SBDD
)paren
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|s-&gt;card
comma
id|s-&gt;dma_adc.chan
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) starting ADC&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/* we allocate both buffers at once */
DECL|macro|DMABUF_DEFAULTORDER
mdefine_line|#define DMABUF_DEFAULTORDER (15-PAGE_SHIFT)
DECL|macro|DMABUF_MINORDER
mdefine_line|#define DMABUF_MINORDER 2
DECL|function|dealloc_dmabuf
r_static
r_void
id|dealloc_dmabuf
c_func
(paren
r_struct
id|dmabuf
op_star
id|db
)paren
(brace
r_int
r_int
id|map
comma
id|mapend
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;rawbuf
)paren
(brace
id|M_printk
c_func
(paren
l_string|&quot;(trident) freeing %p&bslash;n&quot;
comma
id|db-&gt;rawbuf
)paren
suffix:semicolon
multiline_comment|/* undo marking the pages as reserved */
id|mapend
op_assign
id|MAP_NR
c_func
(paren
id|db-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|map
op_assign
id|MAP_NR
c_func
(paren
id|db-&gt;rawbuf
)paren
suffix:semicolon
id|map
op_le
id|mapend
suffix:semicolon
id|map
op_increment
)paren
id|clear_bit
c_func
(paren
id|PG_reserved
comma
op_amp
id|mem_map
(braket
id|map
)braket
dot
id|flags
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|db-&gt;rawbuf
comma
id|db-&gt;buforder
)paren
suffix:semicolon
)brace
id|db-&gt;rawbuf
op_assign
l_int|NULL
suffix:semicolon
id|db-&gt;mapped
op_assign
id|db-&gt;ready
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|prog_dmabuf
r_static
r_int
id|prog_dmabuf
c_func
(paren
r_struct
id|trident_state
op_star
id|s
comma
r_int
id|rec
)paren
(brace
r_struct
id|dmabuf
op_star
id|db
op_assign
id|rec
ques
c_cond
op_amp
id|s-&gt;dma_adc
suffix:colon
op_amp
id|s-&gt;dma_dac
suffix:semicolon
r_int
id|rate
op_assign
id|rec
ques
c_cond
id|s-&gt;rateadc
suffix:colon
id|s-&gt;ratedac
suffix:semicolon
r_int
id|order
suffix:semicolon
r_int
id|bytepersec
suffix:semicolon
r_int
id|bufs
suffix:semicolon
r_int
r_int
id|map
comma
id|mapend
suffix:semicolon
r_int
r_char
id|fmt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|fmt
op_assign
id|s-&gt;fmt
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
(brace
id|s-&gt;enable
op_and_assign
op_complement
id|TRIDENT_ENABLE_RE
suffix:semicolon
id|fmt
op_rshift_assign
id|TRIDENT_ADC_SHIFT
suffix:semicolon
)brace
r_else
(brace
id|s-&gt;enable
op_and_assign
op_complement
id|TRIDENT_ENABLE_PE
suffix:semicolon
id|fmt
op_rshift_assign
id|TRIDENT_DAC_SHIFT
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|fmt
op_and_assign
id|TRIDENT_FMT_MASK
suffix:semicolon
id|db-&gt;hwptr
op_assign
id|db-&gt;swptr
op_assign
id|db-&gt;total_bytes
op_assign
id|db-&gt;count
op_assign
id|db-&gt;error
op_assign
id|db-&gt;endcleared
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|db-&gt;rawbuf
)paren
(brace
r_void
op_star
id|rawbuf
suffix:semicolon
multiline_comment|/* haha, this thing is hacked to hell and back.&n;&t;&t;&t;this is so ugly. */
id|s-&gt;dma_dac.ready
op_assign
id|s-&gt;dma_dac.mapped
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
id|s-&gt;dma_adc.mapped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* alloc as big a chunk as we can */
r_for
c_loop
(paren
id|order
op_assign
id|DMABUF_DEFAULTORDER
suffix:semicolon
id|order
op_ge
id|DMABUF_MINORDER
suffix:semicolon
id|order
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|rawbuf
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
id|order
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rawbuf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* we allocated both buffers */
id|s-&gt;dma_adc.rawbuf
op_assign
id|rawbuf
suffix:semicolon
id|s-&gt;dma_dac.rawbuf
op_assign
id|rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
(paren
id|order
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) allocated %ld bytes at %p&bslash;n&quot;
comma
id|PAGE_SIZE
op_lshift
id|order
comma
id|db-&gt;rawbuf
)paren
suffix:semicolon
id|s-&gt;dma_adc.buforder
op_assign
id|s-&gt;dma_dac.buforder
op_assign
id|order
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* XXX these checks are silly now */
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
op_xor
(paren
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
op_minus
l_int|1
)paren
)paren
op_amp
op_complement
l_int|0xffff
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;trident: DMA buffer crosses 64k boundary: busaddr 0x%lx  size %ld&bslash;n&quot;
comma
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
comma
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
op_minus
l_int|1
)paren
op_amp
op_complement
l_int|0xffffff
)paren
id|M_printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;(trident) DMA buffer beyond 16MB: busaddr 0x%lx  size %ld&bslash;n&quot;
comma
id|virt_to_bus
c_func
(paren
id|db-&gt;rawbuf
)paren
comma
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
multiline_comment|/* now mark the pages as reserved; otherwise remap_page_range doesn&squot;t do what we want */
id|mapend
op_assign
id|MAP_NR
c_func
(paren
id|db-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|map
op_assign
id|MAP_NR
c_func
(paren
id|db-&gt;rawbuf
)paren
suffix:semicolon
id|map
op_le
id|mapend
suffix:semicolon
id|map
op_increment
)paren
id|set_bit
c_func
(paren
id|PG_reserved
comma
op_amp
id|mem_map
(braket
id|map
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
id|bytepersec
op_assign
id|rate
op_lshift
id|sample_shift
(braket
id|fmt
)braket
suffix:semicolon
id|bufs
op_assign
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;ossfragshift
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1000
op_lshift
id|db-&gt;ossfragshift
)paren
OL
id|bytepersec
)paren
id|db-&gt;fragshift
op_assign
id|ld2
c_func
(paren
id|bytepersec
op_div
l_int|1000
)paren
suffix:semicolon
r_else
id|db-&gt;fragshift
op_assign
id|db-&gt;ossfragshift
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&t;lets hand out reasonable big ass buffers by default */
id|db-&gt;fragshift
op_assign
(paren
id|db-&gt;buforder
op_plus
id|PAGE_SHIFT
op_minus
l_int|2
)paren
suffix:semicolon
macro_line|#if 0
id|db-&gt;fragshift
op_assign
id|ld2
c_func
(paren
id|bytepersec
op_div
l_int|100
op_div
(paren
id|db-&gt;subdivision
ques
c_cond
id|db-&gt;subdivision
suffix:colon
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;fragshift
OL
l_int|3
)paren
id|db-&gt;fragshift
op_assign
l_int|3
suffix:semicolon
macro_line|#endif
)brace
id|db-&gt;numfrag
op_assign
id|bufs
op_rshift
id|db-&gt;fragshift
suffix:semicolon
r_while
c_loop
(paren
id|db-&gt;numfrag
template_param
l_int|3
)paren
(brace
id|db-&gt;fragshift
op_decrement
suffix:semicolon
id|db-&gt;numfrag
op_assign
id|bufs
op_rshift
id|db-&gt;fragshift
suffix:semicolon
)brace
id|db-&gt;fragsize
op_assign
l_int|1
op_lshift
id|db-&gt;fragshift
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;ossmaxfrags
op_ge
l_int|4
op_logical_and
id|db-&gt;ossmaxfrags
OL
id|db-&gt;numfrag
)paren
id|db-&gt;numfrag
op_assign
id|db-&gt;ossmaxfrags
suffix:semicolon
id|db-&gt;fragsamples
op_assign
id|db-&gt;fragsize
op_rshift
id|sample_shift
(braket
id|fmt
)braket
suffix:semicolon
id|db-&gt;dmasize
op_assign
id|db-&gt;numfrag
op_lshift
id|db-&gt;fragshift
suffix:semicolon
id|memset
c_func
(paren
id|db-&gt;rawbuf
comma
(paren
id|fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
comma
id|db-&gt;dmasize
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
(brace
id|trident_rec_setup
c_func
(paren
id|s
comma
id|fmt
comma
id|s-&gt;rateadc
comma
id|db-&gt;rawbuf
comma
id|db-&gt;numfrag
op_lshift
id|db-&gt;fragshift
)paren
suffix:semicolon
)brace
r_else
(brace
id|trident_play_setup
c_func
(paren
id|s
comma
id|fmt
comma
id|s-&gt;ratedac
comma
id|db-&gt;rawbuf
comma
id|db-&gt;numfrag
op_lshift
id|db-&gt;fragshift
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|db-&gt;ready
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* only called by trident_write */
DECL|function|clear_advance
r_extern
id|__inline__
r_void
id|clear_advance
c_func
(paren
r_struct
id|trident_state
op_star
id|s
)paren
(brace
r_int
r_char
id|c
op_assign
(paren
(paren
id|s-&gt;fmt
op_rshift
id|TRIDENT_DAC_SHIFT
)paren
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
id|s-&gt;dma_dac.rawbuf
suffix:semicolon
r_int
id|bsize
op_assign
id|s-&gt;dma_dac.dmasize
suffix:semicolon
r_int
id|bptr
op_assign
id|s-&gt;dma_dac.swptr
suffix:semicolon
r_int
id|len
op_assign
id|s-&gt;dma_dac.fragsize
suffix:semicolon
r_if
c_cond
(paren
id|bptr
op_plus
id|len
OG
id|bsize
)paren
(brace
r_int
id|x
op_assign
id|bsize
op_minus
id|bptr
suffix:semicolon
id|memset
c_func
(paren
id|buf
op_plus
id|bptr
comma
id|c
comma
id|x
)paren
suffix:semicolon
multiline_comment|/* account for wrapping? */
id|bptr
op_assign
l_int|0
suffix:semicolon
id|len
op_sub_assign
id|x
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buf
op_plus
id|bptr
comma
id|c
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* call with spinlock held! */
DECL|function|trident_update_ptr
r_static
r_void
id|trident_update_ptr
c_func
(paren
r_struct
id|trident_state
op_star
id|s
)paren
(brace
r_int
id|hwptr
suffix:semicolon
r_int
id|diff
suffix:semicolon
multiline_comment|/* update ADC pointer */
r_if
c_cond
(paren
id|s-&gt;dma_adc.ready
)paren
(brace
id|hwptr
op_assign
id|get_dmac
c_func
(paren
id|s
)paren
op_mod
id|s-&gt;dma_adc.dmasize
suffix:semicolon
id|diff
op_assign
(paren
id|s-&gt;dma_adc.dmasize
op_plus
id|hwptr
op_minus
id|s-&gt;dma_adc.hwptr
)paren
op_mod
id|s-&gt;dma_adc.dmasize
suffix:semicolon
id|s-&gt;dma_adc.hwptr
op_assign
id|hwptr
suffix:semicolon
id|s-&gt;dma_adc.total_bytes
op_add_assign
id|diff
suffix:semicolon
id|s-&gt;dma_adc.count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_adc.fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|s-&gt;dma_adc.wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.mapped
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
OG
(paren
r_int
)paren
(paren
id|s-&gt;dma_adc.dmasize
op_minus
(paren
(paren
l_int|3
op_star
id|s-&gt;dma_adc.fragsize
)paren
op_rshift
l_int|1
)paren
)paren
)paren
(brace
id|s-&gt;enable
op_and_assign
op_complement
id|TRIDENT_ENABLE_RE
suffix:semicolon
id|__stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.error
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* update DAC pointer */
r_if
c_cond
(paren
id|s-&gt;dma_dac.ready
)paren
(brace
multiline_comment|/* this is so gross.  */
id|hwptr
op_assign
(paren
multiline_comment|/*s-&gt;dma_dac.dmasize -*/
id|get_dmaa
c_func
(paren
id|s
)paren
)paren
op_mod
id|s-&gt;dma_dac.dmasize
suffix:semicolon
id|diff
op_assign
(paren
id|s-&gt;dma_dac.dmasize
op_plus
id|hwptr
op_minus
id|s-&gt;dma_dac.hwptr
)paren
op_mod
id|s-&gt;dma_dac.dmasize
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) updating dac: hwptr: %d diff: %d&bslash;n&quot;
comma
id|hwptr
comma
id|diff
)paren
suffix:semicolon
id|s-&gt;dma_dac.hwptr
op_assign
id|hwptr
suffix:semicolon
id|s-&gt;dma_dac.total_bytes
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
(brace
id|s-&gt;dma_dac.count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|s-&gt;dma_dac.count
op_sub_assign
id|diff
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) trident_update_ptr: diff: %d, count: %d&bslash;n&quot;
comma
id|diff
comma
id|s-&gt;dma_dac.count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_le
l_int|0
)paren
(brace
id|s-&gt;enable
op_and_assign
op_complement
id|TRIDENT_ENABLE_PE
suffix:semicolon
multiline_comment|/* Lock already held */
id|__stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
multiline_comment|/* brute force everyone back in sync, sigh */
id|s-&gt;dma_dac.count
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_dac.hwptr
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_dac.error
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_le
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
op_logical_and
op_logical_neg
id|s-&gt;dma_dac.endcleared
)paren
(brace
id|clear_advance
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.endcleared
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_plus
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
op_le
(paren
r_int
)paren
id|s-&gt;dma_dac.dmasize
)paren
id|wake_up
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Trident interrupt handlers.&n; */
DECL|function|trident_interrupt
r_static
r_void
id|trident_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|trident_state
op_star
id|s
suffix:semicolon
r_struct
id|trident_card
op_star
id|c
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|dev_id
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|event
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;lock
)paren
suffix:semicolon
id|event
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|c
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
singleline_comment|//&t;if(event &amp; 0x28)
singleline_comment|//&t;&t;printk(&quot;IRQ %04X (%08lX, %08lX)&bslash;n&quot;, event, c-&gt;iobase, TRID_REG(c, T4D_MISCINT));
r_if
c_cond
(paren
id|event
op_amp
l_int|8
)paren
(brace
multiline_comment|/* Midi - TODO */
)brace
r_if
c_cond
(paren
id|event
op_amp
l_int|0x20
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Update the pointers for all channels we are running.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|s
op_assign
op_amp
id|c-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|DidChannelInterrupt
c_func
(paren
id|c
comma
id|i
)paren
)paren
(brace
id|AckChannelInterrupt
c_func
(paren
id|c
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dev_audio
op_ne
op_minus
l_int|1
)paren
(brace
id|trident_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Spurious ? */
id|M_printk
c_func
(paren
l_string|&quot;(trident) spurious channel irq %d.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|c
comma
id|i
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|c
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|invalid_magic
r_static
r_const
r_char
id|invalid_magic
(braket
)braket
op_assign
id|KERN_CRIT
l_string|&quot;trident: invalid magic value in %s&bslash;n&quot;
suffix:semicolon
DECL|macro|VALIDATE_MAGIC
mdefine_line|#define VALIDATE_MAGIC(FOO,MAG)                         &bslash;&n;({                                                &bslash;&n;&t;if (!(FOO) || (FOO)-&gt;magic != MAG) { &bslash;&n;&t;&t;printk(invalid_magic,__FUNCTION__);            &bslash;&n;&t;&t;return -ENXIO;                    &bslash;&n;&t;}                                         &bslash;&n;})
DECL|macro|VALIDATE_STATE
mdefine_line|#define VALIDATE_STATE(a) VALIDATE_MAGIC(a,TRIDENT_STATE_MAGIC)
DECL|macro|VALIDATE_CARD
mdefine_line|#define VALIDATE_CARD(a) VALIDATE_MAGIC(a,TRIDENT_CARD_MAGIC)
DECL|function|set_mixer
r_static
r_void
id|set_mixer
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|mixer
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|left
comma
id|right
suffix:semicolon
multiline_comment|/* cleanse input a little */
id|right
op_assign
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|left
op_assign
(paren
id|val
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
(brace
id|right
op_assign
l_int|100
suffix:semicolon
)brace
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
(brace
id|left
op_assign
l_int|100
suffix:semicolon
)brace
id|card-&gt;mix.mixer_state
(braket
id|mixer
)braket
op_assign
(paren
id|right
op_lshift
l_int|8
)paren
op_or
id|left
suffix:semicolon
id|card-&gt;mix
dot
id|write_mixer
c_func
(paren
id|card
comma
id|mixer
comma
id|left
comma
id|right
)paren
suffix:semicolon
)brace
DECL|function|mixer_ioctl
r_static
r_int
id|mixer_ioctl
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|val
op_assign
l_int|0
suffix:semicolon
id|VALIDATE_CARD
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_INFO
)paren
(brace
id|mixer_info
id|info
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
id|info.modify_counter
op_assign
id|card-&gt;mix.modcnt
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_OLD_MIXER_INFO
)paren
(brace
id|_old_mixer_info
id|info
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|OSS_GETVERSION
)paren
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
op_ne
l_char|&squot;M&squot;
op_logical_or
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
op_ne
r_sizeof
(paren
r_int
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
id|_IOC_READ
)paren
(brace
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
multiline_comment|/* give them the current record source */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;mix.recmask_io
)paren
(brace
id|val
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|val
op_assign
id|card-&gt;mix
dot
id|recmask_io
c_func
(paren
id|card
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
multiline_comment|/* give them the supported mixers */
id|val
op_assign
id|card-&gt;mix.supported_mixers
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
multiline_comment|/* Arg contains a bit for each supported recording source */
id|val
op_assign
id|card-&gt;mix.record_sources
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
multiline_comment|/* Mixer channels supporting stereo */
id|val
op_assign
id|card-&gt;mix.stereo_mixers
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
id|val
op_assign
id|SOUND_CAP_EXCL_INPUT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* read a specific mixer */
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|card
comma
id|i
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* do we ever want to touch the hardware? */
multiline_comment|/*&t;&t;&t;spin_lock_irqsave(&amp;s-&gt;lock, flags);&n;&t;&t;&t;val = card-&gt;mix.read_mixer(card,i);&n;&t;&t;&t;spin_unlock_irqrestore(&amp;s-&gt;lock, flags);*/
id|val
op_assign
id|card-&gt;mix.mixer_state
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/*&t;&t;&t;printk(&quot;returned 0x%x for mixer %d&bslash;n&quot;,val,i);*/
r_break
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_ne
(paren
id|_IOC_WRITE
op_or
id|_IOC_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|card-&gt;mix.modcnt
op_increment
suffix:semicolon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
multiline_comment|/* Arg contains a bit for each recording source */
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;mix.recmask_io
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_and_assign
id|card-&gt;mix.record_sources
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|card-&gt;mix
dot
id|recmask_io
c_func
(paren
id|card
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|card
comma
id|i
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_mixer
c_func
(paren
id|card
comma
id|i
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|trident_llseek
r_static
id|loff_t
id|trident_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|trident_open_mixdev
r_static
r_int
id|trident_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|devs
suffix:semicolon
r_while
c_loop
(paren
id|card
op_logical_and
id|card-&gt;dev_mixer
op_ne
id|minor
)paren
id|card
op_assign
id|card-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|file-&gt;private_data
op_assign
id|card
suffix:semicolon
singleline_comment|//FIXME put back in
singleline_comment|//MOD_INC_USE_COUNT;
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_release_mixdev
r_static
r_int
id|trident_release_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|VALIDATE_CARD
c_func
(paren
id|card
)paren
suffix:semicolon
singleline_comment|//FIXME put back in
singleline_comment|//MOD_DEC_USE_COUNT;
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_ioctl_mixdev
r_static
r_int
id|trident_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|VALIDATE_CARD
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|mixer_ioctl
c_func
(paren
id|card
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|variable|trident_mixer_fops
r_static
multiline_comment|/*const*/
r_struct
id|file_operations
id|trident_mixer_fops
op_assign
(brace
op_amp
id|trident_llseek
comma
l_int|NULL
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll */
op_amp
id|trident_ioctl_mixdev
comma
l_int|NULL
comma
multiline_comment|/* mmap */
op_amp
id|trident_open_mixdev
comma
l_int|NULL
comma
multiline_comment|/* flush */
op_amp
id|trident_release_mixdev
comma
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* check_media_change */
l_int|NULL
comma
multiline_comment|/* revalidate */
l_int|NULL
comma
multiline_comment|/* lock */
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|drain_dac
r_static
r_int
id|drain_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|s
comma
r_int
id|nonblock
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
r_int
id|tmo
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
op_logical_or
op_logical_neg
id|s-&gt;dma_dac.ready
)paren
r_return
l_int|0
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
id|s-&gt;dma_dac.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|tmo
op_assign
(paren
id|count
op_star
id|HZ
)paren
op_div
id|s-&gt;ratedac
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
(paren
id|s-&gt;fmt
op_rshift
id|TRIDENT_DAC_SHIFT
)paren
op_amp
id|TRIDENT_FMT_MASK
)braket
suffix:semicolon
multiline_comment|/* XXX this is just broken.  someone is waking us up alot, or schedule_timeout is broken.&n;&t;&t;or something.  who cares. - zach */
r_if
c_cond
(paren
op_logical_neg
id|schedule_timeout
c_func
(paren
id|tmo
ques
c_cond
id|tmo
suffix:colon
l_int|1
)paren
op_logical_and
id|tmo
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;trident: dma timed out?? %ld&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/* in this loop, dma_adc.count signifies the amount of data thats waiting&n;&t;to be copied to the user&squot;s buffer.  it is filled by the interrupt&n;&t;handler and drained by this loop. */
DECL|function|trident_read
r_static
id|ssize_t
id|trident_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* remember, all these things are expressed in bytes to be&n;&t;&t;&t;sent to the user.. hence the evil / 2 down below */
id|swptr
op_assign
id|s-&gt;dma_adc.swptr
suffix:semicolon
id|cnt
op_assign
id|s-&gt;dma_adc.dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
OL
id|cnt
)paren
id|cnt
op_assign
id|s-&gt;dma_adc.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|s-&gt;dma_adc.wait
comma
id|HZ
)paren
)paren
(brace
id|M_printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;(trident) read: chip lockup? dmasz %u fragsz %u count %i hwptr %u swptr %u&bslash;n&quot;
comma
id|s-&gt;dma_adc.dmasize
comma
id|s-&gt;dma_adc.fragsize
comma
id|s-&gt;dma_adc.count
comma
id|s-&gt;dma_adc.hwptr
comma
id|s-&gt;dma_adc.swptr
)paren
suffix:semicolon
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
singleline_comment|//&t;&t;&t;&t;set_dmac(s, virt_to_bus(s-&gt;dma_adc.rawbuf), s-&gt;dma_adc.numfrag &lt;&lt; s-&gt;dma_adc.fragshift);
id|s-&gt;dma_adc.count
op_assign
id|s-&gt;dma_adc.hwptr
op_assign
id|s-&gt;dma_adc.swptr
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|s-&gt;dma_adc.rawbuf
op_plus
id|swptr
comma
id|cnt
)paren
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|s-&gt;dma_adc.dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|s-&gt;dma_adc.swptr
op_assign
id|swptr
suffix:semicolon
id|s-&gt;dma_adc.count
op_sub_assign
id|cnt
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|trident_write
r_static
id|ssize_t
id|trident_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|mode
op_assign
(paren
id|s-&gt;fmt
op_rshift
id|TRIDENT_DAC_SHIFT
)paren
op_amp
id|TRIDENT_FMT_MASK
suffix:semicolon
id|M_printk
c_func
(paren
l_string|&quot;(trident) trident_write: count %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_dac.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
OL
l_int|0
)paren
(brace
id|s-&gt;dma_dac.count
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|s-&gt;dma_dac.hwptr
suffix:semicolon
)brace
id|swptr
op_assign
id|s-&gt;dma_dac.swptr
suffix:semicolon
id|cnt
op_assign
id|s-&gt;dma_dac.dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_plus
id|cnt
OG
id|s-&gt;dma_dac.dmasize
)paren
id|cnt
op_assign
id|s-&gt;dma_dac.dmasize
op_minus
id|s-&gt;dma_dac.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
multiline_comment|/* buffer is full, wait for it to be played */
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
id|HZ
)paren
)paren
(brace
id|M_printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;trident: write: chip lockup? dmasz %u fragsz %u count %i hwptr %u swptr %u&bslash;n&quot;
comma
id|s-&gt;dma_dac.dmasize
comma
id|s-&gt;dma_dac.fragsize
comma
id|s-&gt;dma_dac.count
comma
id|s-&gt;dma_dac.hwptr
comma
id|s-&gt;dma_dac.swptr
)paren
suffix:semicolon
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
singleline_comment|//&t;&t;&t;set_dmaa(s, virt_to_bus(s-&gt;dma_dac.rawbuf), s-&gt;dma_dac.numfrag &lt;&lt; s-&gt;dma_dac.fragshift);
id|s-&gt;dma_dac.count
op_assign
id|s-&gt;dma_dac.hwptr
op_assign
id|s-&gt;dma_dac.swptr
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|s-&gt;dma_dac.rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|s-&gt;dma_dac.dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|swptr
suffix:semicolon
id|s-&gt;dma_dac.count
op_add_assign
id|cnt
suffix:semicolon
id|s-&gt;dma_dac.endcleared
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|trident_poll
r_static
r_int
r_int
id|trident_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|s-&gt;dma_dac.wait
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|s-&gt;dma_adc.wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_adc.fragsize
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|s-&gt;dma_dac.dmasize
op_ge
id|s-&gt;dma_dac.count
op_plus
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/* this needs to be fixed to deal with the dual apus/buffers */
macro_line|#if 0
r_static
r_int
id|trident_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|db
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|db
op_assign
op_amp
id|s-&gt;dma_dac
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|db
op_assign
op_amp
id|s-&gt;dma_adc
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_offset
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma-&gt;vm_start
comma
id|virt_to_phys
c_func
(paren
id|db-&gt;rawbuf
)paren
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|db-&gt;mapped
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|trident_ioctl
r_static
r_int
id|trident_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|audio_buf_info
id|abinfo
suffix:semicolon
id|count_info
id|cinfo
suffix:semicolon
r_int
id|val
comma
id|mapped
comma
id|ret
suffix:semicolon
r_int
r_char
id|fmtm
comma
id|fmtd
suffix:semicolon
multiline_comment|/*&t;printk(&quot;trident: trident_ioctl: cmd %d&bslash;n&quot;, cmd);*/
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
id|mapped
op_assign
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
id|s-&gt;dma_dac.mapped
)paren
op_logical_or
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
op_logical_and
id|s-&gt;dma_adc.mapped
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|drain_dac
c_func
(paren
id|s
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
multiline_comment|/* XXX fix */
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
id|put_user
c_func
(paren
l_int|0
multiline_comment|/*DSP_CAP_DUPLEX | DSP_CAP_REALTIME | DSP_CAP_TRIGGER | DSP_CAP_MMAP*/
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|s-&gt;dma_dac.hwptr
op_assign
id|s-&gt;dma_dac.count
op_assign
id|s-&gt;dma_dac.total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|s-&gt;dma_adc.swptr
op_assign
id|s-&gt;dma_adc.hwptr
op_assign
id|s-&gt;dma_adc.count
op_assign
id|s-&gt;dma_adc.total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
id|trident_set_adc_rate
c_func
(paren
id|s
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
id|trident_set_dac_rate
c_func
(paren
id|s
comma
id|val
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_return
id|put_user
c_func
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
id|s-&gt;rateadc
suffix:colon
id|s-&gt;ratedac
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|fmtd
op_assign
l_int|0
suffix:semicolon
id|fmtm
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|fmtd
op_or_assign
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_ADC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_ADC_SHIFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|fmtd
op_or_assign
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_DAC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_DAC_SHIFT
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmtd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
id|fmtd
op_assign
l_int|0
suffix:semicolon
id|fmtm
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
id|fmtd
op_or_assign
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_ADC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_ADC_SHIFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
id|fmtd
op_or_assign
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_DAC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_DAC_SHIFT
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmtd
)paren
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_ADC_SHIFT
)paren
suffix:colon
(paren
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_DAC_SHIFT
)paren
)paren
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask */
r_return
id|put_user
c_func
(paren
id|AFMT_S8
op_or
id|AFMT_S16_LE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Selects ONE fmt*/
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
id|fmtd
op_assign
l_int|0
suffix:semicolon
id|fmtm
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fixed at 16bit for now */
id|fmtd
op_or_assign
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_ADC_SHIFT
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|fmtd
op_or_assign
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_ADC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_ADC_SHIFT
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|fmtd
op_or_assign
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_DAC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_DAC_SHIFT
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmtd
)paren
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_ADC_SHIFT
)paren
suffix:colon
(paren
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_DAC_SHIFT
)paren
)paren
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_S8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETTRIGGER
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|s-&gt;enable
op_amp
id|TRIDENT_ENABLE_RE
)paren
id|val
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|s-&gt;enable
op_amp
id|TRIDENT_ENABLE_PE
)paren
id|val
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_INPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_OUTPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_dac.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;enable
op_amp
id|TRIDENT_ENABLE_PE
)paren
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|s-&gt;dma_dac.fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|s-&gt;dma_dac.dmasize
op_minus
id|s-&gt;dma_dac.count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|s-&gt;dma_dac.numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|s-&gt;dma_dac.fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;enable
op_amp
id|TRIDENT_ENABLE_RE
)paren
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|s-&gt;dma_adc.fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|s-&gt;dma_adc.count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|s-&gt;dma_adc.numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|s-&gt;dma_adc.fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|val
op_assign
id|s-&gt;dma_dac.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|s-&gt;dma_adc.total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|s-&gt;dma_adc.count
op_rshift
id|s-&gt;dma_adc.fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|s-&gt;dma_adc.hwptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.mapped
)paren
id|s-&gt;dma_adc.count
op_and_assign
id|s-&gt;dma_adc.fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|s-&gt;dma_dac.total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|s-&gt;dma_dac.count
op_rshift
id|s-&gt;dma_dac.fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|s-&gt;dma_dac.hwptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
id|s-&gt;dma_dac.count
op_and_assign
id|s-&gt;dma_dac.fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|s-&gt;dma_dac.fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|s-&gt;dma_adc.fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|s-&gt;dma_adc.ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|s-&gt;dma_adc.ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ossfragshift
OL
l_int|4
)paren
id|s-&gt;dma_adc.ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ossfragshift
OG
l_int|15
)paren
id|s-&gt;dma_adc.ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ossmaxfrags
OL
l_int|4
)paren
id|s-&gt;dma_adc.ossmaxfrags
op_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|s-&gt;dma_dac.ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|s-&gt;dma_dac.ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.ossfragshift
OL
l_int|4
)paren
id|s-&gt;dma_dac.ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.ossfragshift
OG
l_int|15
)paren
id|s-&gt;dma_dac.ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.ossmaxfrags
OL
l_int|4
)paren
id|s-&gt;dma_dac.ossmaxfrags
op_assign
l_int|4
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SUBDIVIDE
suffix:colon
r_if
c_cond
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|s-&gt;dma_adc.subdivision
)paren
op_logical_or
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|s-&gt;dma_dac.subdivision
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|1
op_logical_and
id|val
op_ne
l_int|2
op_logical_and
id|val
op_ne
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|s-&gt;dma_adc.subdivision
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|s-&gt;dma_dac.subdivision
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
id|s-&gt;rateadc
suffix:colon
id|s-&gt;ratedac
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_ADC_SHIFT
)paren
suffix:colon
(paren
id|TRIDENT_FMT_STEREO
op_lshift
id|TRIDENT_DAC_SHIFT
)paren
)paren
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_ADC_SHIFT
)paren
suffix:colon
(paren
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_DAC_SHIFT
)paren
)paren
)paren
ques
c_cond
l_int|16
suffix:colon
l_int|8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SNDCTL_DSP_SETSYNCRO
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|trident_open
r_static
r_int
id|trident_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|trident_card
op_star
id|c
op_assign
id|devs
suffix:semicolon
r_struct
id|trident_state
op_star
id|s
op_assign
l_int|NULL
comma
op_star
id|sp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|fmtm
op_assign
op_complement
l_int|0
comma
id|fmts
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Scan the cards and find the channel. We only&n;&t; *&t;do this at open time so it is ok&n;&t; */
r_while
c_loop
(paren
id|c
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sp
op_assign
op_amp
id|c-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;dev_audio
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sp-&gt;dev_audio
op_xor
id|minor
)paren
op_amp
op_complement
l_int|0xf
)paren
(brace
r_continue
suffix:semicolon
)brace
id|s
op_assign
id|sp
suffix:semicolon
)brace
id|c
op_assign
id|c-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|s
suffix:semicolon
multiline_comment|/* wait for device to become free */
id|down
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
r_while
c_loop
(paren
id|s-&gt;open_mode
op_amp
id|file-&gt;f_mode
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|s-&gt;open_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|down
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
multiline_comment|/*&n;&t;&t;fmtm &amp;= ~((TRIDENT_FMT_STEREO | TRIDENT_FMT_16BIT) &lt;&lt; TRIDENT_ADC_SHIFT);&n;&t;&t;if ((minor &amp; 0xf) == SND_DEV_DSP16)&n;&t;&t;&t;fmts |= TRIDENT_FMT_16BIT &lt;&lt; TRIDENT_ADC_SHIFT; */
id|fmtm
op_assign
(paren
id|TRIDENT_FMT_STEREO
op_or
id|TRIDENT_FMT_16BIT
)paren
op_lshift
id|TRIDENT_ADC_SHIFT
suffix:semicolon
id|s-&gt;dma_adc.ossfragshift
op_assign
id|s-&gt;dma_adc.ossmaxfrags
op_assign
id|s-&gt;dma_adc.subdivision
op_assign
l_int|0
suffix:semicolon
id|trident_set_adc_rate
c_func
(paren
id|s
comma
l_int|8000
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|fmtm
op_and_assign
op_complement
(paren
(paren
id|TRIDENT_FMT_STEREO
op_or
id|TRIDENT_FMT_16BIT
)paren
op_lshift
id|TRIDENT_DAC_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0xf
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|fmts
op_or_assign
id|TRIDENT_FMT_16BIT
op_lshift
id|TRIDENT_DAC_SHIFT
suffix:semicolon
id|s-&gt;dma_dac.ossfragshift
op_assign
id|s-&gt;dma_dac.ossmaxfrags
op_assign
id|s-&gt;dma_dac.subdivision
op_assign
l_int|0
suffix:semicolon
id|trident_set_dac_rate
c_func
(paren
id|s
comma
l_int|8000
comma
l_int|1
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmts
)paren
suffix:semicolon
id|s-&gt;open_mode
op_or_assign
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
singleline_comment|//FIXME put back in
singleline_comment|//MOD_INC_USE_COUNT;
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_release
r_static
r_int
id|trident_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|drain_dac
c_func
(paren
id|s
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
multiline_comment|/* free our shared dma buffers */
id|dealloc_dmabuf
c_func
(paren
op_amp
id|s-&gt;dma_adc
)paren
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
op_amp
id|s-&gt;dma_dac
)paren
suffix:semicolon
id|s-&gt;open_mode
op_and_assign
(paren
op_complement
id|file-&gt;f_mode
)paren
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
multiline_comment|/* we&squot;re covered by the open_sem */
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|s-&gt;open_wait
)paren
suffix:semicolon
singleline_comment|//FIXME put back in
singleline_comment|//MOD_DEC_USE_COUNT;
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|trident_audio_fops
r_static
multiline_comment|/*const*/
r_struct
id|file_operations
id|trident_audio_fops
op_assign
(brace
op_amp
id|trident_llseek
comma
op_amp
id|trident_read
comma
op_amp
id|trident_write
comma
l_int|NULL
comma
multiline_comment|/* readdir */
op_amp
id|trident_poll
comma
op_amp
id|trident_ioctl
comma
l_int|NULL
comma
multiline_comment|/* XXX &amp;trident_mmap, */
op_amp
id|trident_open
comma
l_int|NULL
comma
multiline_comment|/* flush */
op_amp
id|trident_release
comma
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* check_media_change */
l_int|NULL
comma
multiline_comment|/* revalidate */
l_int|NULL
comma
multiline_comment|/* lock */
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_APM
DECL|function|trident_apm_callback
r_int
id|trident_apm_callback
c_func
(paren
id|apm_event_t
id|ae
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|trident_install
r_static
r_int
id|trident_install
c_func
(paren
r_struct
id|pci_dev
op_star
id|pcidev
comma
r_int
id|card_type
)paren
(brace
id|u16
id|w
suffix:semicolon
id|u32
id|l
suffix:semicolon
r_int
r_int
id|iobase
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
r_struct
id|trident_state
op_star
id|trident
suffix:semicolon
r_int
id|num
op_assign
l_int|0
suffix:semicolon
id|u32
id|ChanDwordCount
suffix:semicolon
id|iobase
op_assign
id|pcidev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
l_int|256
)paren
)paren
(brace
id|M_printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(trident) can&squot;t allocate 256 bytes I/O at 0x%4.4lx&bslash;n&quot;
comma
id|iobase
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* this was tripping up some machines */
r_if
c_cond
(paren
id|pcidev-&gt;irq
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(trident) pci subsystem reports irq 0, this might not be correct.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* just to be sure */
id|pci_set_master
c_func
(paren
id|pcidev
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pcidev
comma
id|PCI_COMMAND
comma
op_amp
id|w
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|w
op_amp
(paren
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MASTER
)paren
)paren
op_ne
(paren
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(trident) BIOS did not enable I/O access.&bslash;n&quot;
)paren
suffix:semicolon
id|w
op_or_assign
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pcidev
comma
id|PCI_COMMAND
comma
id|w
)paren
suffix:semicolon
)brace
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|trident_card
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;(trident) out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|card
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_APM
id|printk
c_func
(paren
l_string|&quot;(trident) apm_reg_callback: %d&bslash;n&quot;
comma
id|apm_register_callback
c_func
(paren
id|trident_apm_callback
)paren
)paren
suffix:semicolon
macro_line|#endif
id|card-&gt;iobase
op_assign
id|iobase
suffix:semicolon
id|card-&gt;card_type
op_assign
id|card_type
suffix:semicolon
id|card-&gt;irq
op_assign
id|pcidev-&gt;irq
suffix:semicolon
id|card-&gt;next
op_assign
id|devs
suffix:semicolon
id|card-&gt;magic
op_assign
id|TRIDENT_CARD_MAGIC
suffix:semicolon
id|devs
op_assign
id|card
suffix:semicolon
id|ChanDwordCount
op_assign
id|card-&gt;ChanDwordCount
op_assign
l_int|2
suffix:semicolon
id|card-&gt;ChanPCM
op_assign
l_int|32
suffix:semicolon
id|card-&gt;ChRegs.lpChStart
op_assign
id|card-&gt;ChRegs.data
suffix:semicolon
id|card-&gt;ChRegs.lpChStop
op_assign
id|card-&gt;ChRegs.lpChStart
op_plus
id|ChanDwordCount
suffix:semicolon
id|card-&gt;ChRegs.lpChAint
op_assign
id|card-&gt;ChRegs.lpChStop
op_plus
id|ChanDwordCount
suffix:semicolon
id|card-&gt;ChRegs.lpChAinten
op_assign
id|card-&gt;ChRegs.lpChAint
op_plus
id|ChanDwordCount
suffix:semicolon
id|card-&gt;ChRegs.lpAChStart
op_assign
id|card-&gt;ChRegs.lpChAinten
op_plus
id|ChanDwordCount
suffix:semicolon
id|card-&gt;ChRegs.lpAChStop
op_assign
id|card-&gt;ChRegs.lpAChStart
op_plus
id|ChanDwordCount
suffix:semicolon
id|card-&gt;ChRegs.lpAChAint
op_assign
id|card-&gt;ChRegs.lpAChStop
op_plus
id|ChanDwordCount
suffix:semicolon
id|card-&gt;ChRegs.lpAChAinten
op_assign
id|card-&gt;ChRegs.lpAChAint
op_plus
id|ChanDwordCount
suffix:semicolon
singleline_comment|// Assign addresses.
id|card-&gt;ChRegs.lpAChStart
(braket
l_int|0
)braket
op_assign
id|T4D_START_A
suffix:semicolon
id|card-&gt;ChRegs.lpAChStop
(braket
l_int|0
)braket
op_assign
id|T4D_STOP_A
suffix:semicolon
id|card-&gt;ChRegs.lpAChAint
(braket
l_int|0
)braket
op_assign
id|T4D_AINT_A
suffix:semicolon
id|card-&gt;ChRegs.lpAChAinten
(braket
l_int|0
)braket
op_assign
id|T4D_AINTEN_A
suffix:semicolon
id|card-&gt;ChRegs.lpAChStart
(braket
l_int|1
)braket
op_assign
id|T4D_START_B
suffix:semicolon
id|card-&gt;ChRegs.lpAChStop
(braket
l_int|1
)braket
op_assign
id|T4D_STOP_B
suffix:semicolon
id|card-&gt;ChRegs.lpAChAint
(braket
l_int|1
)braket
op_assign
id|T4D_AINT_B
suffix:semicolon
id|card-&gt;ChRegs.lpAChAinten
(braket
l_int|1
)braket
op_assign
id|T4D_AINTEN_B
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MUSICVOL_WAVEVOL
)paren
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|card
comma
l_int|0x0L
comma
l_int|0L
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|card
comma
l_int|0x02L
comma
l_int|0L
)paren
suffix:semicolon
id|trident_ac97_set
c_func
(paren
id|card
comma
l_int|0x18L
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;card_type
op_eq
id|TYPE_4DWAVE_NX
)paren
(brace
singleline_comment|// Enable rear channels
id|outl
c_func
(paren
l_int|0x12
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
singleline_comment|// ...or not, since they sound ugly. :)
singleline_comment|// outl(0x02, TRID_REG(card, NX_ACR0_AC97_COM_STAT));
singleline_comment|// S/PDIF C Channel bits 0-31 : 48khz, SCMS disabled
singleline_comment|// outl(0x200004, TRID_REG(card, NX_SPCSTATUS));
singleline_comment|// Disable S/PDIF out, 48khz only from ac97 fifo
singleline_comment|// outb(0x00, TRID_REG(card, NX_SPCTRL_SPCSO + 3));
)brace
r_else
(brace
id|outl
c_func
(paren
l_int|0x02
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
id|s-&gt;card
op_assign
id|card
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;dma_adc.wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;open_wait
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|s-&gt;magic
op_assign
id|TRIDENT_STATE_MAGIC
suffix:semicolon
id|s-&gt;channel
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ready
op_logical_or
id|s-&gt;dma_dac.ready
op_logical_or
id|s-&gt;dma_adc.rawbuf
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(trident) BOTCH!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Now allocate the hardware resources&n;&t;&t; */
singleline_comment|//s-&gt;dma_dac.chan[0] = AllocateChannelPCM(card);
id|s-&gt;dma_dac.chan
(braket
l_int|1
)braket
op_assign
id|AllocateChannelPCM
c_func
(paren
id|card
)paren
suffix:semicolon
singleline_comment|//s-&gt;dma_adc.chan[0] = AllocateChannelPCM(card);
multiline_comment|/* register devices */
r_if
c_cond
(paren
(paren
id|s-&gt;dev_audio
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|trident_audio_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|num
op_assign
id|i
suffix:semicolon
multiline_comment|/* clear the rest if we ran out of slots to register */
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
id|s-&gt;dev_audio
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|trident
op_assign
op_amp
id|card-&gt;channels
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Ok card ready. Begin setup proper&n;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;(trident) Configuring %s found at IO 0x%04lX IRQ %d&bslash;n&quot;
comma
id|card_names
(braket
id|card_type
)braket
comma
id|card-&gt;iobase
comma
id|card-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* stake our claim on the iospace */
id|request_region
c_func
(paren
id|iobase
comma
l_int|256
comma
id|card_names
(braket
id|card_type
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Reset the CODEC&n;&t; */
id|trident_ac97_init
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;dev_mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|trident_mixer_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(trident) couldn&squot;t register mixer!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|mixer_defaults
op_star
id|md
op_assign
op_amp
id|mixer_defaults
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;mixer
op_eq
op_minus
l_int|1
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|card
comma
id|md-&gt;mixer
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|set_mixer
c_func
(paren
id|card
comma
id|md-&gt;mixer
comma
id|md-&gt;value
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|card-&gt;irq
comma
id|trident_interrupt
comma
id|SA_SHIRQ
comma
id|card_names
(braket
id|card_type
)braket
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;(trident) unable to allocate irq %d,&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|unregister_sound_mixer
c_func
(paren
id|card-&gt;dev_mixer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dev_audio
op_ne
op_minus
l_int|1
)paren
(brace
id|unregister_sound_dsp
c_func
(paren
id|s-&gt;dev_audio
)paren
suffix:semicolon
)brace
)brace
id|release_region
c_func
(paren
id|card-&gt;iobase
comma
l_int|256
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|debug_timer
)paren
suffix:semicolon
id|debug_timer.function
op_assign
id|trident_kick
suffix:semicolon
id|debug_timer.data
op_assign
(paren
r_int
r_int
)paren
id|card
suffix:semicolon
id|debug_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
singleline_comment|//&t;add_timer(&amp;debug_timer);
id|printk
c_func
(paren
l_string|&quot;(trident) %d channels configured.&bslash;n&quot;
comma
id|num
)paren
suffix:semicolon
id|EnableEndInterrupts
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|init_trident
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
r_struct
id|pci_dev
op_star
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|foundone
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
multiline_comment|/* No PCI bus in this machine! */
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;(trident) version &quot;
id|DRIVER_VERSION
l_string|&quot; time &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Find the 4DWave DX&n;&t; */
r_while
c_loop
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_TRIDENT
comma
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
comma
id|pcidev
)paren
)paren
op_ne
l_int|NULL
op_logical_and
(paren
id|trident_install
c_func
(paren
id|pcidev
comma
id|TYPE_4DWAVE_DX
)paren
)paren
)paren
(brace
id|foundone
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Find the 4DWave NX&n;&t; */
r_while
c_loop
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_TRIDENT
comma
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
comma
id|pcidev
)paren
)paren
op_ne
l_int|NULL
op_logical_and
(paren
id|trident_install
c_func
(paren
id|pcidev
comma
id|TYPE_4DWAVE_NX
)paren
)paren
)paren
(brace
id|foundone
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|foundone
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alan Cox &lt;alan@redhat.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Trident 4DWave Driver&quot;
)paren
suffix:semicolon
macro_line|#ifdef M_DEBUG
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|trident_card
op_star
id|s
suffix:semicolon
macro_line|#ifdef CONFIG_APM
id|apm_unregister_callback
c_func
(paren
id|trident_apm_callback
)paren
suffix:semicolon
macro_line|#endif
id|del_timer
c_func
(paren
op_amp
id|debug_timer
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|s
op_assign
id|devs
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|devs
op_assign
id|devs-&gt;next
suffix:semicolon
multiline_comment|/* Kill interrupts, and SP/DIF */
id|DisableEndInterrupts
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;card_type
op_eq
id|TYPE_4DWAVE_NX
)paren
(brace
id|outb
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|s
comma
id|NX_SPCTRL_SPCSO
op_plus
l_int|3
)paren
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|s-&gt;irq
comma
id|s
)paren
suffix:semicolon
id|unregister_sound_mixer
c_func
(paren
id|s-&gt;dev_mixer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|trident_state
op_star
id|trident
op_assign
op_amp
id|s-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|trident-&gt;dev_audio
op_ne
op_minus
l_int|1
)paren
(brace
id|unregister_sound_dsp
c_func
(paren
id|trident-&gt;dev_audio
)paren
suffix:semicolon
)brace
)brace
id|release_region
c_func
(paren
id|s-&gt;iobase
comma
l_int|256
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;(trident) unloading&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
