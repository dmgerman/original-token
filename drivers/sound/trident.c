multiline_comment|/*&n; *&n; *&t;Trident 4D-Wave/SiS 7018 OSS driver for Linux 2.2.x&n; *&n; *&t;Driver: Alan Cox &lt;alan@redhat.com&gt;&n; *&n; *  Built from:&n; *&t;Low level code: &lt;audio@tridentmicro.com&gt; from ALSA&n; *&t;Framework: Thomas Sailer &lt;sailer@ife.ee.ethz.ch&gt;&n; *&t;Extended by: Zach Brown &lt;zab@redhat.com&gt;  &n; *&n; *  Hacked up by:&n; *&t;Aaron Holtzman &lt;aholtzma@ess.engr.uvic.ca&gt;&n; *&t;Ollie Lho &lt;ollie@sis.com.tw&gt; SiS 7018 Audio Core Support&n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  History&n; *  v0.11 Jan 27 2000 Ollie Lho&n; *&t;DMA bug, scheduler latency, second try&n; *  v0.10 Jan 24 2000 Ollie Lho&n; *&t;DMA bug fixed, found kernel scheduling problem&n; *  v0.09 Jan 20 2000 Ollie Lho&n; *&t;Clean up of channel register access routine (prepare for channel binding)&n; *  v0.08 Jan 14 2000 Ollie Lho&n; *&t;Isolation of AC97 codec code&n; *  v0.07 Jan 13 2000 Ollie Lho&n; *&t;Get rid of ugly old low level access routines (e.g. CHRegs.lp****)&n; *  v0.06 Jan 11 2000 Ollie Lho&n; *&t;Preliminary support for dual (more ?) AC97 codecs&n; *  v0.05 Jan 08 2000 Luca Montecchiani &lt;m.luca@iname.com&gt;&n; *&t;adapt to 2.3.x new __setup/__init call&n; *  v0.04 Dec 31 1999 Ollie Lho&n; *&t;Multiple Open, using Middle Loop Interrupt to smooth playback&n; *  v0.03 Dec 24 1999 Ollie Lho&n; *&t;mem leak in prog_dmabuf and dealloc_dmabuf removed&n; *  v0.02 Dec 15 1999 Ollie Lho&n; *&t;SiS 7018 support added, playback O.K.&n; *  v0.01 Alan Cox et. al.&n; *&t;Initial Release in kernel 2.3.30, does not work&n; * &n; *  ToDo&n; *&t;Clean up of low level channel register access code. (done)&n; *        Fix the bug on dma buffer management in update_ptr, read/write, drain_dac (done)&n; *&t;Dual AC97 codecs support (done partially, need channel binding to test)&n; *&t;Recording support&n; *&t;Mmap support&n; *&t;&quot;Channel Binding&quot; ioctl extension&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &quot;trident.h&quot;
macro_line|#include &quot;ac97_codec.h&quot;
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;0.11&quot;
multiline_comment|/* magic numbers to protect our data structures */
DECL|macro|TRIDENT_CARD_MAGIC
mdefine_line|#define TRIDENT_CARD_MAGIC&t;0x5072696E /* &quot;Prin&quot; */
DECL|macro|TRIDENT_STATE_MAGIC
mdefine_line|#define TRIDENT_STATE_MAGIC&t;0x63657373 /* &quot;cess&quot; */
multiline_comment|/* The first 32 channels are called Bank A. They are (should be) reserved&n;   for MIDI synthesizer. But since that is not supported yet, we can (ab)use&n;   them to play PCM samples */
DECL|macro|ABUSE_BANK_A
macro_line|#undef ABUSE_BANK_A
multiline_comment|/* maxinum number of instances of opening /dev/dspN, can your CPU handle this ?&n;   NOTE: If /dev/dsp is opened O_RDWR (i.e. full duplex) it will consume 2 HW&n;   channels */
macro_line|#ifdef ABUSE_BANK_A
DECL|macro|NR_HW_CH
mdefine_line|#define NR_HW_CH&t;&t;64
macro_line|#else
DECL|macro|NR_HW_CH
mdefine_line|#define NR_HW_CH&t;&t;32
macro_line|#endif
multiline_comment|/* maxinum nuber of AC97 codecs connected, AC97 2.0 defined 4, but 7018 and 4D-NX only&n;   have 2 SDATA_IN lines (currently) */
DECL|macro|NR_AC97
mdefine_line|#define NR_AC97&t;&t;2
multiline_comment|/* minor number of /dev/dspW */
DECL|macro|SND_DEV_DSP16
mdefine_line|#define SND_DEV_DSP16&t;5 
DECL|variable|sample_size
r_static
r_const
r_int
id|sample_size
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|4
)brace
suffix:semicolon
DECL|variable|sample_shift
r_static
r_const
r_int
id|sample_shift
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|2
)brace
suffix:semicolon
DECL|variable|invalid_magic
r_static
r_const
r_char
id|invalid_magic
(braket
)braket
op_assign
id|KERN_CRIT
l_string|&quot;trident: invalid magic value in %s&bslash;n&quot;
suffix:semicolon
DECL|struct|pci_audio_info
r_struct
id|pci_audio_info
(brace
DECL|member|vendor
id|u16
id|vendor
suffix:semicolon
DECL|member|device
id|u16
id|device
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|pci_audio_devices
r_static
r_struct
id|pci_audio_info
id|pci_audio_devices
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_TRIDENT
comma
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
comma
l_string|&quot;Trident 4DWave DX&quot;
)brace
comma
(brace
id|PCI_VENDOR_ID_TRIDENT
comma
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
comma
l_string|&quot;Trident 4DWave NX&quot;
)brace
comma
(brace
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_7018
comma
l_string|&quot;SiS 7018 PCI Audio&quot;
)brace
)brace
suffix:semicolon
multiline_comment|/* &quot;software&quot; or virtual channel, an instance of opened /dev/dsp */
DECL|struct|trident_state
r_struct
id|trident_state
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|card
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
multiline_comment|/* Card info */
multiline_comment|/* single open lock mechanism, only used for recording */
DECL|member|open_sem
r_struct
id|semaphore
id|open_sem
suffix:semicolon
DECL|member|open_wait
id|wait_queue_head_t
id|open_wait
suffix:semicolon
multiline_comment|/* file mode */
DECL|member|open_mode
id|mode_t
id|open_mode
suffix:semicolon
multiline_comment|/* virtual channel number */
DECL|member|virt
r_int
id|virt
suffix:semicolon
DECL|struct|dmabuf
r_struct
id|dmabuf
(brace
multiline_comment|/* wave sample stuff */
DECL|member|rate
r_int
r_int
id|rate
suffix:semicolon
DECL|member|fmt
DECL|member|enable
r_int
r_char
id|fmt
comma
id|enable
suffix:semicolon
multiline_comment|/* hardware channel */
DECL|member|channel
r_struct
id|trident_channel
op_star
id|channel
suffix:semicolon
multiline_comment|/* OSS buffer manangemeent stuff */
DECL|member|rawbuf
r_void
op_star
id|rawbuf
suffix:semicolon
DECL|member|buforder
r_int
id|buforder
suffix:semicolon
DECL|member|numfrag
r_int
id|numfrag
suffix:semicolon
DECL|member|fragshift
r_int
id|fragshift
suffix:semicolon
multiline_comment|/* our buffer acts like a circular ring */
DECL|member|hwptr
r_int
id|hwptr
suffix:semicolon
multiline_comment|/* where dma last started, update by update_ptr */
DECL|member|swptr
r_int
id|swptr
suffix:semicolon
multiline_comment|/* where driver last clear/filled, updated by read/write */
DECL|member|count
r_int
id|count
suffix:semicolon
multiline_comment|/* bytes to be comsumed by dma machine */
DECL|member|total_bytes
r_int
id|total_bytes
suffix:semicolon
multiline_comment|/* total bytes dmaed by hardware */
DECL|member|error
r_int
id|error
suffix:semicolon
multiline_comment|/* number of over/underruns */
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
multiline_comment|/* put process on wait queue when no more space in buffer */
multiline_comment|/* redundant, but makes calculations easier */
DECL|member|fragsize
r_int
id|fragsize
suffix:semicolon
DECL|member|dmasize
r_int
id|dmasize
suffix:semicolon
DECL|member|fragsamples
r_int
id|fragsamples
suffix:semicolon
multiline_comment|/* OSS stuff */
DECL|member|mapped
r_int
id|mapped
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ready
r_int
id|ready
suffix:colon
l_int|1
suffix:semicolon
DECL|member|endcleared
r_int
id|endcleared
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ossfragshift
r_int
id|ossfragshift
suffix:semicolon
DECL|member|ossmaxfrags
r_int
id|ossmaxfrags
suffix:semicolon
DECL|member|subdivision
r_int
id|subdivision
suffix:semicolon
DECL|member|dma_dac
DECL|member|dma_adc
)brace
id|dma_dac
comma
id|dma_adc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* hardware channels */
DECL|struct|trident_channel
r_struct
id|trident_channel
(brace
DECL|member|num
r_int
id|num
suffix:semicolon
multiline_comment|/* channel number */
DECL|member|lba
id|u32
id|lba
suffix:semicolon
multiline_comment|/* reg 0xe4 */
DECL|member|eso
id|u32
id|eso
suffix:semicolon
multiline_comment|/* reg 0xe8 */
DECL|member|delta
id|u32
id|delta
suffix:semicolon
DECL|member|attribute
id|u16
id|attribute
suffix:semicolon
multiline_comment|/* reg 0xec */
DECL|member|fm_vol
id|u16
id|fm_vol
suffix:semicolon
DECL|member|control
id|u32
id|control
suffix:semicolon
multiline_comment|/* reg 0xf0 */
)brace
suffix:semicolon
DECL|struct|trident_pcm_bank_address
r_struct
id|trident_pcm_bank_address
(brace
DECL|member|start
id|u32
id|start
suffix:semicolon
DECL|member|stop
id|u32
id|stop
suffix:semicolon
DECL|member|aint
id|u32
id|aint
suffix:semicolon
DECL|member|aint_en
id|u32
id|aint_en
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|bank_a_addrs
r_static
r_struct
id|trident_pcm_bank_address
id|bank_a_addrs
op_assign
(brace
id|T4D_START_A
comma
id|T4D_STOP_A
comma
id|T4D_AINT_A
comma
id|T4D_AINTEN_A
)brace
suffix:semicolon
DECL|variable|bank_b_addrs
r_static
r_struct
id|trident_pcm_bank_address
id|bank_b_addrs
op_assign
(brace
id|T4D_START_B
comma
id|T4D_STOP_B
comma
id|T4D_AINT_B
comma
id|T4D_AINTEN_B
)brace
suffix:semicolon
DECL|struct|trident_pcm_bank
r_struct
id|trident_pcm_bank
(brace
multiline_comment|/* register addresses to control bank operations */
DECL|member|addresses
r_struct
id|trident_pcm_bank_address
op_star
id|addresses
suffix:semicolon
multiline_comment|/* each bank has 32 channels */
DECL|member|bitmap
id|u32
id|bitmap
suffix:semicolon
multiline_comment|/* channel allocation bitmap */
DECL|member|channels
r_struct
id|trident_channel
id|channels
(braket
l_int|32
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|trident_card
r_struct
id|trident_card
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
multiline_comment|/* We keep trident cards in a linked list */
DECL|member|next
r_struct
id|trident_card
op_star
id|next
suffix:semicolon
multiline_comment|/* The trident has a certain amount of cross channel interaction&n;&t;   so we use a single per card lock */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* PCI device stuff */
DECL|member|pci_info
r_struct
id|pci_audio_info
op_star
id|pci_info
suffix:semicolon
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|pci_id
id|u16
id|pci_id
suffix:semicolon
multiline_comment|/* soundcore stuff */
DECL|member|dev_audio
r_int
id|dev_audio
suffix:semicolon
multiline_comment|/* structures for abstraction of hardware facilities, codecs, banks and channels*/
DECL|member|ac97_codec
r_struct
id|ac97_codec
op_star
id|ac97_codec
(braket
id|NR_AC97
)braket
suffix:semicolon
DECL|member|banks
r_struct
id|trident_pcm_bank
id|banks
(braket
id|NR_BANKS
)braket
suffix:semicolon
DECL|member|states
r_struct
id|trident_state
op_star
id|states
(braket
id|NR_HW_CH
)braket
suffix:semicolon
multiline_comment|/* hardware resources */
DECL|member|iobase
r_int
r_int
id|iobase
suffix:semicolon
DECL|member|irq
id|u32
id|irq
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|devs
r_static
r_struct
id|trident_card
op_star
id|devs
op_assign
l_int|NULL
suffix:semicolon
r_static
r_void
id|trident_ac97_set
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
suffix:semicolon
r_static
id|u16
id|trident_ac97_get
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
suffix:semicolon
r_static
r_int
id|trident_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|trident_release_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|trident_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
id|loff_t
id|trident_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
suffix:semicolon
DECL|function|trident_enable_loop_interrupts
r_static
r_int
id|trident_enable_loop_interrupts
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
id|u32
id|global_control
suffix:semicolon
id|global_control
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|global_control
op_or_assign
(paren
id|ENDLP_IE
op_or
id|MIDLP_IE
op_or
id|BANK_B_EN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|global_control
op_or_assign
(paren
id|ENDLP_IE
op_or
id|MIDLP_IE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|FALSE
suffix:semicolon
)brace
id|outl
c_func
(paren
id|global_control
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: Enable Loop Interrupts, globctl = 0x%08X&bslash;n&quot;
comma
id|global_control
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|trident_disable_loop_interrupts
r_static
r_int
id|trident_disable_loop_interrupts
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
id|u32
id|global_control
suffix:semicolon
id|global_control
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
id|global_control
op_and_assign
op_complement
(paren
id|ENDLP_IE
op_or
id|MIDLP_IE
)paren
suffix:semicolon
id|outl
c_func
(paren
id|global_control
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: Disabled Loop Interrupts, globctl = 0x%08X&bslash;n&quot;
comma
id|global_control
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|trident_enable_voice_irq
r_static
r_void
id|trident_enable_voice_irq
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint_en
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|reg
op_or_assign
id|mask
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINTEN_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: enabled IRQ on channel %d, AINTEN_B = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_disable_voice_irq
r_static
r_void
id|trident_disable_voice_irq
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint_en
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
id|mask
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Ack the channel in case the interrupt was set before we disable it. */
id|outl
c_func
(paren
id|mask
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|bank-&gt;addresses-&gt;aint
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINTEN_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: disabled IRQ on channel %d, AINTEN_B = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_start_voice
r_static
r_void
id|trident_start_voice
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|addr
op_assign
id|bank-&gt;addresses-&gt;start
suffix:semicolon
macro_line|#ifdef DEBUG
id|u32
id|reg
suffix:semicolon
macro_line|#endif
id|outl
c_func
(paren
id|mask
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_START_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: start voice on channel %d, START_B  = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_stop_voice
r_static
r_void
id|trident_stop_voice
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|addr
op_assign
id|bank-&gt;addresses-&gt;stop
suffix:semicolon
macro_line|#ifdef DEBUG
id|u32
id|reg
suffix:semicolon
macro_line|#endif
id|outl
c_func
(paren
id|mask
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_STOP_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: stop voice on channel %d,  STOP_B  = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_check_channel_interrupt
r_static
r_int
id|trident_check_channel_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|reg
op_amp
id|mask
)paren
id|printk
c_func
(paren
l_string|&quot;trident: channel %d has interrupt, AINT_B = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|reg
op_amp
id|mask
)paren
ques
c_cond
id|TRUE
suffix:colon
id|FALSE
suffix:semicolon
)brace
DECL|function|trident_ack_channel_interrupt
r_static
r_void
id|trident_ack_channel_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|reg
op_and_assign
id|mask
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINT_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: Ack channel %d interrupt, AINT_B = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_alloc_pcm_channel
r_static
r_struct
id|trident_channel
op_star
id|trident_alloc_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_B
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bank-&gt;bitmap
op_eq
op_complement
l_int|0UL
)paren
(brace
multiline_comment|/* no more free channels avaliable */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: no more channels available on Bank B.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef ABUSE_BANK_A
r_goto
id|bank_a
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|idx
op_assign
l_int|31
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
op_plus
l_int|32
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
)brace
macro_line|#ifdef ABUSE_BANK_A
multiline_comment|/* channels in Bank A should be reserved for synthesizer &n;&t;   not for normal use (channels in Bank A can&squot;t record) */
id|bank_a
suffix:colon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_A
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bank-&gt;bitmap
op_eq
op_complement
l_int|0UL
)paren
(brace
multiline_comment|/* no more free channels avaliable */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: no more channels available on Bank A.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|idx
op_assign
l_int|31
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|banks-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
suffix:semicolon
r_return
id|channels
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|trident_free_pcm_channel
r_static
r_void
id|trident_free_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|channel
)paren
(brace
r_int
id|bank
suffix:semicolon
macro_line|#ifdef ABUSE_BANK_A
r_if
c_cond
(paren
id|channel
template_param
l_int|63
)paren
r_return
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|channel
template_param
l_int|63
)paren
r_return
suffix:semicolon
macro_line|#endif
id|bank
op_assign
id|channel
op_rshift
l_int|5
suffix:semicolon
id|channel
op_assign
id|channel
op_amp
l_int|0x1f
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;banks
(braket
id|bank
)braket
dot
id|bitmap
op_amp
(paren
l_int|1
op_lshift
(paren
id|channel
)paren
)paren
)paren
(brace
id|card-&gt;banks
(braket
id|bank
)braket
dot
id|bitmap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|channel
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* called with spin lock held */
DECL|function|trident_load_channel_registers
r_static
r_int
id|trident_load_channel_registers
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
id|u32
op_star
id|data
comma
r_int
r_int
id|channel
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|channel
OG
l_int|63
)paren
r_return
id|FALSE
suffix:semicolon
multiline_comment|/* select hardware channel to write */
id|outb
c_func
(paren
id|channel
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
multiline_comment|/* output the channel registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CHANNEL_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outl
c_func
(paren
id|data
(braket
id|i
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|CHANNEL_START
op_plus
l_int|4
op_star
id|i
)paren
)paren
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* called with spin lock held */
DECL|function|trident_write_voice_regs
r_static
r_int
id|trident_write_voice_regs
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
r_int
id|rec
)paren
(brace
r_int
r_int
id|data
(braket
id|CHANNEL_REGS
op_plus
l_int|1
)braket
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
id|channel
op_assign
id|state-&gt;dma_adc.channel
suffix:semicolon
r_else
id|channel
op_assign
id|state-&gt;dma_dac.channel
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|channel-&gt;lba
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|channel-&gt;control
suffix:semicolon
r_switch
c_cond
(paren
id|state-&gt;card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current Sample Offset */
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|channel-&gt;eso
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;delta
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
(paren
id|channel-&gt;attribute
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;fm_vol
op_amp
l_int|0xffff
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current Sample Offset */
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|channel-&gt;eso
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;delta
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|channel-&gt;fm_vol
op_amp
l_int|0xffff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
(paren
id|channel-&gt;delta
op_lshift
l_int|24
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|channel-&gt;delta
op_lshift
l_int|24
)paren
op_amp
l_int|0xff000000
)paren
op_or
(paren
id|channel-&gt;eso
op_amp
l_int|0x00ffffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|channel-&gt;fm_vol
op_amp
l_int|0xffff
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|FALSE
suffix:semicolon
)brace
r_return
id|trident_load_channel_registers
c_func
(paren
id|state-&gt;card
comma
id|data
comma
id|channel-&gt;num
)paren
suffix:semicolon
)brace
DECL|function|compute_rate
r_static
r_int
id|compute_rate
c_func
(paren
id|u32
id|rate
)paren
(brace
r_int
id|delta
suffix:semicolon
multiline_comment|/* We special case 44100 and 8000 since rounding with the equation&n;&t;   does not give us an accurate enough value. For 11025 and 22050&n;&t;   the equation gives us the best answer. All other frequencies will&n;&t;   also use the equation. JDW */
r_if
c_cond
(paren
id|rate
op_eq
l_int|44100
)paren
id|delta
op_assign
l_int|0xeb3
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|8000
)paren
id|delta
op_assign
l_int|0x2ab
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|48000
)paren
id|delta
op_assign
l_int|0x1000
suffix:semicolon
r_else
id|delta
op_assign
(paren
(paren
(paren
id|rate
op_lshift
l_int|12
)paren
op_plus
id|rate
)paren
op_div
l_int|48000
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
r_return
id|delta
suffix:semicolon
)brace
multiline_comment|/* set playback sample rate */
DECL|function|trident_set_dac_rate
r_static
r_int
r_int
id|trident_set_dac_rate
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
r_int
id|rate
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|dmabuf-&gt;rate
op_assign
id|rate
suffix:semicolon
id|dmabuf-&gt;channel-&gt;delta
op_assign
id|compute_rate
c_func
(paren
id|rate
)paren
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|state
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: called trident_set_dac_rate : rate = %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rate
suffix:semicolon
)brace
multiline_comment|/* set recording sample rate */
DECL|function|trident_set_adc_rate
r_static
r_int
r_int
id|trident_set_adc_rate
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
r_int
id|rate
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_adc
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|dmabuf-&gt;rate
op_assign
id|rate
suffix:semicolon
id|dmabuf-&gt;channel-&gt;delta
op_assign
id|compute_rate
c_func
(paren
id|rate
)paren
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|state
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: called trident_set_adc_rate : rate = %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rate
suffix:semicolon
)brace
multiline_comment|/* prepare channel attributes for playback */
DECL|function|trident_play_setup
r_static
r_void
id|trident_play_setup
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
op_assign
id|dmabuf-&gt;channel
suffix:semicolon
id|channel-&gt;lba
op_assign
id|virt_to_bus
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
suffix:semicolon
id|channel-&gt;delta
op_assign
id|compute_rate
c_func
(paren
id|dmabuf-&gt;rate
)paren
suffix:semicolon
id|channel-&gt;eso
op_assign
id|dmabuf-&gt;dmasize
op_rshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|channel-&gt;eso
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
multiline_comment|/* FIXME: channel attributes are configured by ioctls, but it is not implemented&n;&t;&t;   so just set to ZERO for the moment */
id|channel-&gt;attribute
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|channel-&gt;attribute
op_assign
l_int|0
suffix:semicolon
)brace
id|channel-&gt;fm_vol
op_assign
l_int|0x0
suffix:semicolon
id|channel-&gt;control
op_assign
id|CHANNEL_LOOP
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
(brace
multiline_comment|/* 16-bits */
id|channel-&gt;control
op_or_assign
id|CHANNEL_16BITS
suffix:semicolon
multiline_comment|/* signed */
id|channel-&gt;control
op_or_assign
id|CHANNEL_SIGNED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
multiline_comment|/* stereo */
id|channel-&gt;control
op_or_assign
id|CHANNEL_STEREO
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_play_setup, LBA = 0x%08x, &quot;
l_string|&quot;Delat = 0x%08x, ESO = 0x%08x, Control = 0x%08x&bslash;n&quot;
comma
id|channel-&gt;lba
comma
id|channel-&gt;delta
comma
id|channel-&gt;eso
comma
id|channel-&gt;control
)paren
suffix:semicolon
macro_line|#endif
id|trident_write_voice_regs
c_func
(paren
id|state
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* prepare channel attributes for recording */
DECL|function|trident_rec_setup
r_static
r_void
id|trident_rec_setup
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
id|u16
id|w
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_adc
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
op_assign
id|dmabuf-&gt;channel
suffix:semicolon
multiline_comment|/* Enable AC-97 ADC (capture) */
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
multiline_comment|/* for 7018, the ac97 is always in playback/record (duplex) mode */
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|w
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|w
op_or
l_int|0x48
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|w
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|w
op_or
l_int|0x1000
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
id|channel-&gt;lba
op_assign
id|virt_to_bus
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
suffix:semicolon
id|channel-&gt;delta
op_assign
id|compute_rate
c_func
(paren
id|dmabuf-&gt;rate
)paren
suffix:semicolon
id|channel-&gt;eso
op_assign
id|dmabuf-&gt;dmasize
op_rshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|channel-&gt;eso
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
multiline_comment|/* FIXME: channel attributes are configured by ioctls, but it is not implemented&n;&t;&t;   so just set to ZERO for the moment */
id|channel-&gt;attribute
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|channel-&gt;attribute
op_assign
l_int|0
suffix:semicolon
)brace
id|channel-&gt;fm_vol
op_assign
l_int|0x0
suffix:semicolon
id|channel-&gt;control
op_assign
id|CHANNEL_LOOP
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
(brace
multiline_comment|/* 16-bits */
id|channel-&gt;control
op_or_assign
id|CHANNEL_16BITS
suffix:semicolon
multiline_comment|/* signed */
id|channel-&gt;control
op_or_assign
id|CHANNEL_SIGNED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
multiline_comment|/* stereo */
id|channel-&gt;control
op_or_assign
id|CHANNEL_STEREO
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_rec_setup, LBA = 0x%08x, &quot;
l_string|&quot;Delat = 0x%08x, ESO = 0x%08x, Control = 0x%08x&bslash;n&quot;
comma
id|channel-&gt;lba
comma
id|channel-&gt;delta
comma
id|channel-&gt;eso
comma
id|channel-&gt;control
)paren
suffix:semicolon
macro_line|#endif
id|trident_write_voice_regs
c_func
(paren
id|state
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* get current playback/recording dma buffer pointer (byte offset from LBA),&n;   called with spinlock held! */
DECL|function|trident_get_dma_addr
r_extern
id|__inline__
r_int
id|trident_get_dma_addr
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|rec
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
id|u32
id|cso
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_adc
suffix:semicolon
r_else
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;enable
)paren
r_return
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|dmabuf-&gt;channel-&gt;num
comma
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|state-&gt;card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
multiline_comment|/* 16 bits ESO, CSO for 7018 and DX */
id|cso
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|CH_DX_CSO_ALPHA_FMS
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
multiline_comment|/* 24 bits ESO, CSO for NX */
id|cso
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|CH_NX_DELTA_CSO
)paren
)paren
op_amp
l_int|0x00ffffff
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_get_dma_addr: chip reported channel: %d, cso = %d&bslash;n&quot;
comma
id|dmabuf-&gt;channel-&gt;num
comma
id|cso
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* ESO and CSO are in units of Samples, convert to byte offset */
id|cso
op_lshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
r_return
(paren
id|cso
op_mod
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop recording (lock held) */
DECL|function|__stop_adc
r_extern
id|__inline__
r_void
id|__stop_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_adc
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
id|dmabuf-&gt;enable
op_and_assign
op_complement
id|DMA_RUNNING
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
DECL|function|stop_adc
r_static
r_void
id|stop_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|start_adc
r_static
r_void
id|start_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_adc
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabuf-&gt;mapped
op_logical_or
id|dmabuf-&gt;count
OL
(paren
r_int
)paren
(paren
id|dmabuf-&gt;dmasize
op_minus
l_int|2
op_star
id|dmabuf-&gt;fragsize
)paren
)paren
op_logical_and
id|dmabuf-&gt;ready
)paren
(brace
id|dmabuf-&gt;enable
op_or_assign
id|DMA_RUNNING
suffix:semicolon
id|trident_enable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* stop playback (lock held) */
DECL|function|__stop_dac
r_extern
id|__inline__
r_void
id|__stop_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
id|dmabuf-&gt;enable
op_and_assign
op_complement
id|DMA_RUNNING
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
DECL|function|stop_dac
r_static
r_void
id|stop_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|start_dac
r_static
r_void
id|start_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabuf-&gt;mapped
op_logical_or
id|dmabuf-&gt;count
OG
l_int|0
)paren
op_logical_and
id|dmabuf-&gt;ready
)paren
(brace
id|dmabuf-&gt;enable
op_or_assign
id|DMA_RUNNING
suffix:semicolon
id|trident_enable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|macro|DMABUF_DEFAULTORDER
mdefine_line|#define DMABUF_DEFAULTORDER (15-PAGE_SHIFT)
DECL|macro|DMABUF_MINORDER
mdefine_line|#define DMABUF_MINORDER 1
multiline_comment|/* allocate DMA buffer, playback and recording buffer should be allocated seperately */
DECL|function|alloc_dmabuf
r_static
r_int
id|alloc_dmabuf
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|rec
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
r_void
op_star
id|rawbuf
suffix:semicolon
r_int
id|order
suffix:semicolon
r_int
r_int
id|map
comma
id|mapend
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_adc
suffix:semicolon
r_else
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
multiline_comment|/* alloc as big a chunk as we can, FIXME: is this necessary ?? */
r_for
c_loop
(paren
id|order
op_assign
id|DMABUF_DEFAULTORDER
suffix:semicolon
id|order
op_ge
id|DMABUF_MINORDER
suffix:semicolon
id|order
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|rawbuf
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|order
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rawbuf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: allocated %ld (order = %d) bytes at %p&bslash;n&quot;
comma
id|PAGE_SIZE
op_lshift
id|order
comma
id|order
comma
id|rawbuf
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* for 4DWave and 7018, there are only 30 (31) siginifcan bits for Loop Begin Address&n;&t;   (LBA) which limits the address space to 1 (2) GB, bad T^2 design */
r_if
c_cond
(paren
(paren
id|virt_to_bus
c_func
(paren
id|rawbuf
)paren
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
op_minus
l_int|1
)paren
op_amp
op_complement
l_int|0x3fffffff
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: DMA buffer beyond 1 GB; &quot;
l_string|&quot;bus address = 0x%lx, size = %ld&bslash;n&quot;
comma
id|virt_to_bus
c_func
(paren
id|rawbuf
)paren
comma
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|rawbuf
comma
id|order
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dmabuf-&gt;ready
op_assign
id|dmabuf-&gt;mapped
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;rawbuf
op_assign
id|rawbuf
suffix:semicolon
id|dmabuf-&gt;buforder
op_assign
id|order
suffix:semicolon
multiline_comment|/* now mark the pages as reserved; otherwise remap_page_range doesn&squot;t do what we want */
id|mapend
op_assign
id|MAP_NR
c_func
(paren
id|rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|map
op_assign
id|MAP_NR
c_func
(paren
id|rawbuf
)paren
suffix:semicolon
id|map
op_le
id|mapend
suffix:semicolon
id|map
op_increment
)paren
id|set_bit
c_func
(paren
id|PG_reserved
comma
op_amp
id|mem_map
(braket
id|map
)braket
dot
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* free DMA buffer */
DECL|function|dealloc_dmabuf
r_static
r_void
id|dealloc_dmabuf
c_func
(paren
r_struct
id|dmabuf
op_star
id|dmabuf
)paren
(brace
r_int
r_int
id|map
comma
id|mapend
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;rawbuf
)paren
(brace
multiline_comment|/* undo marking the pages as reserved */
id|mapend
op_assign
id|MAP_NR
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|map
op_assign
id|MAP_NR
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
suffix:semicolon
id|map
op_le
id|mapend
suffix:semicolon
id|map
op_increment
)paren
id|clear_bit
c_func
(paren
id|PG_reserved
comma
op_amp
id|mem_map
(braket
id|map
)braket
dot
id|flags
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|dmabuf-&gt;rawbuf
comma
id|dmabuf-&gt;buforder
)paren
suffix:semicolon
)brace
id|dmabuf-&gt;rawbuf
op_assign
l_int|NULL
suffix:semicolon
id|dmabuf-&gt;mapped
op_assign
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|prog_dmabuf
r_static
r_int
id|prog_dmabuf
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|rec
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
r_int
id|bytepersec
suffix:semicolon
r_int
id|bufsize
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_adc
suffix:semicolon
r_else
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;hwptr
op_assign
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;total_bytes
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;error
op_assign
id|dmabuf-&gt;endcleared
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* allocate DMA buffer if not allocated yet */
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;rawbuf
)paren
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|alloc_dmabuf
c_func
(paren
id|state
comma
id|rec
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* FIXME: figure out all this OSS fragment stuff */
id|bytepersec
op_assign
id|dmabuf-&gt;rate
op_lshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|bufsize
op_assign
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossfragshift
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1000
op_lshift
id|dmabuf-&gt;ossfragshift
)paren
OL
id|bytepersec
)paren
id|dmabuf-&gt;fragshift
op_assign
id|ld2
c_func
(paren
id|bytepersec
op_div
l_int|1000
)paren
suffix:semicolon
r_else
id|dmabuf-&gt;fragshift
op_assign
id|dmabuf-&gt;ossfragshift
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* lets hand out reasonable big ass buffers by default */
id|dmabuf-&gt;fragshift
op_assign
(paren
id|dmabuf-&gt;buforder
op_plus
id|PAGE_SHIFT
op_minus
l_int|2
)paren
suffix:semicolon
)brace
id|dmabuf-&gt;numfrag
op_assign
id|bufsize
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
r_while
c_loop
(paren
id|dmabuf-&gt;numfrag
template_param
l_int|3
)paren
(brace
id|dmabuf-&gt;fragshift
op_decrement
suffix:semicolon
id|dmabuf-&gt;numfrag
op_assign
id|bufsize
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
)brace
id|dmabuf-&gt;fragsize
op_assign
l_int|1
op_lshift
id|dmabuf-&gt;fragshift
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossmaxfrags
op_ge
l_int|4
op_logical_and
id|dmabuf-&gt;ossmaxfrags
OL
id|dmabuf-&gt;numfrag
)paren
id|dmabuf-&gt;numfrag
op_assign
id|dmabuf-&gt;ossmaxfrags
suffix:semicolon
id|dmabuf-&gt;fragsamples
op_assign
id|dmabuf-&gt;fragsize
op_rshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|dmabuf-&gt;dmasize
op_assign
id|dmabuf-&gt;numfrag
op_lshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|memset
c_func
(paren
id|dmabuf-&gt;rawbuf
comma
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
comma
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
(brace
id|trident_rec_setup
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
(brace
id|trident_play_setup
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* set the ready flag for the dma buffer */
id|dmabuf-&gt;ready
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: prog_dmabuf, sample rate = %d, format = %d, numfrag = %d, &quot;
l_string|&quot;fragsize = %d dmasize = %d&bslash;n&quot;
comma
id|dmabuf-&gt;rate
comma
id|dmabuf-&gt;fmt
comma
id|dmabuf-&gt;numfrag
comma
id|dmabuf-&gt;fragsize
comma
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* we are doing quantum mechanics here, the buffer can only be empty, half or full filled i.e.&n;   |------------|------------|   or   |xxxxxxxxxxxx|------------|   or   |xxxxxxxxxxxx|xxxxxxxxxxxx|&n;   but we almost always get this&n;   |xxxxxx------|------------|   or   |xxxxxxxxxxxx|xxxxx-------|&n;   so we have to clear the tail space to &quot;silence&quot;&n;   |xxxxxx000000|------------|   or   |xxxxxxxxxxxx|xxxxxx000000|&n;*/
DECL|function|trident_clear_tail
r_static
r_void
id|trident_clear_tail
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
r_char
id|silence
op_assign
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|swptr
op_eq
l_int|0
op_logical_or
id|swptr
op_eq
id|dmabuf-&gt;dmasize
op_div
l_int|2
op_logical_or
id|swptr
op_eq
id|dmabuf-&gt;dmasize
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|swptr
OL
id|dmabuf-&gt;dmasize
op_div
l_int|2
)paren
id|len
op_assign
id|dmabuf-&gt;dmasize
op_div
l_int|2
op_minus
id|swptr
suffix:semicolon
r_else
id|len
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
id|memset
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|len
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_add_assign
id|len
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|len
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* restart the dma machine in case it is halted */
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
DECL|function|drain_dac
r_static
r_int
id|drain_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|nonblock
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|tmo
suffix:semicolon
r_int
id|count
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
op_logical_or
op_logical_neg
id|dmabuf-&gt;ready
)paren
r_return
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* It seems that we have to set the current state to TASK_INTERRUPTIBLE&n;&t;&t;   every time to make the process really go to sleep */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* No matter how much data left in the buffer, we have to wait untill&n;&t;&t;   CSO == ESO/2 or CSO == ESO when address engine interrupts */
id|tmo
op_assign
(paren
id|dmabuf-&gt;dmasize
op_star
id|HZ
)paren
op_div
id|dmabuf-&gt;rate
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schedule_timeout
c_func
(paren
id|tmo
ques
c_cond
id|tmo
suffix:colon
l_int|1
)paren
op_logical_and
id|tmo
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: drain_dac, dma timeout?&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* call with spinlock held! */
DECL|function|trident_update_ptr
r_static
r_void
id|trident_update_ptr
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
r_int
id|hwptr
suffix:semicolon
r_int
id|diff
suffix:semicolon
multiline_comment|/* update ADC pointer */
r_if
c_cond
(paren
id|state-&gt;dma_adc.ready
)paren
(brace
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_adc
suffix:semicolon
id|hwptr
op_assign
id|trident_get_dma_addr
c_func
(paren
id|state
comma
l_int|1
)paren
suffix:semicolon
id|diff
op_assign
(paren
id|dmabuf-&gt;dmasize
op_plus
id|hwptr
op_minus
id|dmabuf-&gt;hwptr
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|dmabuf-&gt;hwptr
op_assign
id|hwptr
suffix:semicolon
id|dmabuf-&gt;total_bytes
op_add_assign
id|diff
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;mapped
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;count
OG
(paren
r_int
)paren
(paren
id|dmabuf-&gt;dmasize
op_minus
(paren
(paren
l_int|3
op_star
id|dmabuf-&gt;fragsize
)paren
op_rshift
l_int|1
)paren
)paren
)paren
(brace
id|__stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;error
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* update DAC pointer */
r_if
c_cond
(paren
id|state-&gt;dma_dac.ready
)paren
(brace
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
id|hwptr
op_assign
id|trident_get_dma_addr
c_func
(paren
id|state
comma
l_int|0
)paren
suffix:semicolon
id|diff
op_assign
(paren
id|dmabuf-&gt;dmasize
op_plus
id|hwptr
op_minus
id|dmabuf-&gt;hwptr
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|dmabuf-&gt;hwptr
op_assign
id|hwptr
suffix:semicolon
id|dmabuf-&gt;total_bytes
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
id|dmabuf-&gt;count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|dmabuf-&gt;count
op_sub_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
template_param
id|dmabuf-&gt;dmasize
)paren
(brace
multiline_comment|/* buffer underrun or buffer overrun, we have no way to recover&n;&t;&t;&t;&t;   it here, just stop the machine and let the process force hwptr&n;&t;&t;&t;&t;   and swptr to sync */
id|__stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;error
op_increment
suffix:semicolon
)brace
multiline_comment|/* since dma machine only interrupts at ESO and ESO/2, we sure have at &n;&t;&t;&t;   least half of dma buffer free, so wake up the process unconditionally */
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|trident_interrupt
r_static
r_void
id|trident_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|trident_state
op_star
id|state
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|dev_id
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|event
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|event
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_interrupt called, MISCINT = 0x%08x&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|event
op_amp
id|ADDRESS_IRQ
)paren
(brace
multiline_comment|/* Update the pointers for all channels we are running. */
multiline_comment|/* FIXME: should read interrupt status only once */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|trident_check_channel_interrupt
c_func
(paren
id|card
comma
l_int|63
op_minus
id|i
)paren
)paren
(brace
id|trident_ack_channel_interrupt
c_func
(paren
id|card
comma
l_int|63
op_minus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state
op_assign
id|card-&gt;states
(braket
id|i
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;trident: spurious channel irq %d.&bslash;n&quot;
comma
l_int|63
op_minus
id|i
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|event
op_amp
id|SB_IRQ
)paren
(brace
multiline_comment|/* Midi - TODO */
)brace
multiline_comment|/* manually clear interrupt status, bad hardware design, balme T^2 */
id|outl
c_func
(paren
(paren
id|ST_TARGET_REACHED
op_or
id|MIXER_OVERFLOW
op_or
id|MIXER_UNDERFLOW
)paren
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|trident_llseek
r_static
id|loff_t
id|trident_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
multiline_comment|/* in this loop, dma_adc.count signifies the amount of data thats waiting&n;   to be copied to the user&squot;s buffer.  it is filled by the interrupt&n;   handler and drained by this loop. */
DECL|function|trident_read
r_static
id|ssize_t
id|trident_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
id|cnt
)paren
id|cnt
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
id|start_adc
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
id|HZ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;(trident) read: chip lockup? &quot;
l_string|&quot;dmasz %u fragsz %u count %i hwptr %u swptr %u&bslash;n&quot;
comma
id|dmabuf-&gt;dmasize
comma
id|dmabuf-&gt;fragsize
comma
id|dmabuf-&gt;count
comma
id|dmabuf-&gt;hwptr
comma
id|dmabuf-&gt;swptr
)paren
suffix:semicolon
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;count
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;hwptr
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|cnt
)paren
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|swptr
suffix:semicolon
id|dmabuf-&gt;count
op_sub_assign
id|cnt
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_adc
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|trident_write
r_static
id|ssize_t
id|trident_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_write called, count = %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
macro_line|#endif&t;
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
l_int|0
)paren
(brace
multiline_comment|/* buffer underrun, we are recovering from sleep_on_timeout,&n;&t;&t;&t;   resync hwptr and swptr */
id|dmabuf-&gt;count
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;hwptr
suffix:semicolon
)brace
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_plus
id|cnt
OG
id|dmabuf-&gt;dmasize
)paren
id|cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
r_int
r_int
id|tmo
suffix:semicolon
multiline_comment|/* buffer is full, start the dma machine and wait for data to be played */
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* No matter how much data left in the buffer, we have to wait untill&n;&t;&t;&t;   CSO == ESO/2 or CSO == ESO when address engine interrupts */
id|tmo
op_assign
(paren
id|dmabuf-&gt;dmasize
op_star
id|HZ
)paren
op_div
(paren
id|dmabuf-&gt;rate
op_star
l_int|2
)paren
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
multiline_comment|/* There are two situations when sleep_on_timeout returns, one is when the&n;&t;&t;&t;   interrupt is serviced correctly and the process is waked up by ISR ON TIME.&n;&t;&t;&t;   Another is when timeout is expired, which means that either interrupt is NOT&n;&t;&t;&t;   serviced correctly (pending interrupt) or it is TOO LATE for the process to &n;&t;&t;&t;   be scheduled to run (scheduler latency) which results in a (potential) buffer&n;&t;&t;&t;   underrun. And worse, there is NOTHING we can do to prevent it. */
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
id|tmo
)paren
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: schedule timeout, &quot;
l_string|&quot;dmasz %u fragsz %u count %i hwptr %u swptr %u&bslash;n&quot;
comma
id|dmabuf-&gt;dmasize
comma
id|dmabuf-&gt;fragsize
comma
id|dmabuf-&gt;count
comma
id|dmabuf-&gt;hwptr
comma
id|dmabuf-&gt;swptr
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* a buffer underrun, we delay the recovery untill next time the&n;&t;&t;&t;&t;   while loop begin and we REALLY have data to play */
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|swptr
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|cnt
suffix:semicolon
id|dmabuf-&gt;endcleared
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|trident_poll
r_static
r_int
r_int
id|trident_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|trident_state
op_star
id|s
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|s-&gt;dma_dac.wait
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|s-&gt;dma_adc.wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_adc.fragsize
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|s-&gt;dma_dac.dmasize
op_ge
id|s-&gt;dma_dac.count
op_plus
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|trident_mmap
r_static
r_int
id|trident_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_dac
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dma_adc
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_pgoff
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma-&gt;vm_start
comma
id|virt_to_phys
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|dmabuf-&gt;mapped
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_ioctl
r_static
r_int
id|trident_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|audio_buf_info
id|abinfo
suffix:semicolon
id|count_info
id|cinfo
suffix:semicolon
r_int
id|val
comma
id|mapped
comma
id|ret
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
id|mapped
op_assign
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
id|state-&gt;dma_dac.mapped
)paren
op_logical_or
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
op_logical_and
id|state-&gt;dma_adc.mapped
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_ioctl, command = %2d, arg = 0x%08x&bslash;n&quot;
comma
id|_IOC_NR
c_func
(paren
id|cmd
)paren
comma
id|arg
ques
c_cond
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:colon
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|state-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
id|state-&gt;dma_dac.swptr
op_assign
id|state-&gt;dma_dac.hwptr
op_assign
l_int|0
suffix:semicolon
id|state-&gt;dma_dac.count
op_assign
id|state-&gt;dma_dac.total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|state-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
id|state-&gt;dma_adc.swptr
op_assign
id|state-&gt;dma_adc.hwptr
op_assign
l_int|0
suffix:semicolon
id|state-&gt;dma_adc.count
op_assign
id|state-&gt;dma_adc.total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|drain_dac
c_func
(paren
id|state
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
multiline_comment|/* set smaple rate */
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_set_dac_rate
c_func
(paren
id|state
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_set_adc_rate
c_func
(paren
id|state
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
id|put_user
c_func
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
id|state-&gt;dma_adc.rate
suffix:colon
id|state-&gt;dma_dac.rate
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
multiline_comment|/* set stereo or mono channel */
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|state-&gt;dma_dac.fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_else
id|state-&gt;dma_dac.fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|state-&gt;dma_adc.fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_else
id|state-&gt;dma_adc.fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|state-&gt;dma_dac.fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|state-&gt;dma_adc.fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask of supported sample format*/
r_return
id|put_user
c_func
(paren
id|AFMT_S16_LE
op_or
id|AFMT_U16_LE
op_or
id|AFMT_S8
op_or
id|AFMT_U8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Select sample format */
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|state-&gt;dma_dac.fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
r_else
id|state-&gt;dma_dac.fmt
op_and_assign
op_complement
id|TRIDENT_FMT_16BIT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|state-&gt;dma_adc.fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
r_else
id|state-&gt;dma_adc.fmt
op_and_assign
op_complement
id|TRIDENT_FMT_16BIT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|put_user
c_func
(paren
(paren
id|state-&gt;dma_dac.fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_U8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_else
r_return
id|put_user
c_func
(paren
(paren
id|state-&gt;dma_adc.fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_U8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
id|state-&gt;dma_dac.fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_else
id|state-&gt;dma_dac.fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
id|state-&gt;dma_adc.fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_else
id|state-&gt;dma_adc.fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|put_user
c_func
(paren
(paren
id|state-&gt;dma_dac.fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_else
r_return
id|put_user
c_func
(paren
(paren
id|state-&gt;dma_adc.fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
multiline_comment|/* FIXME: the same as RESET ?? */
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SUBDIVIDE
suffix:colon
r_if
c_cond
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|state-&gt;dma_adc.subdivision
)paren
op_logical_or
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|state-&gt;dma_dac.subdivision
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|1
op_logical_and
id|val
op_ne
l_int|2
op_logical_and
id|val
op_ne
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|state-&gt;dma_adc.subdivision
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|state-&gt;dma_dac.subdivision
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|state-&gt;dma_adc.ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|state-&gt;dma_adc.ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;dma_adc.ossfragshift
OL
l_int|4
)paren
id|state-&gt;dma_adc.ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;dma_adc.ossfragshift
OG
l_int|15
)paren
id|state-&gt;dma_adc.ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;dma_adc.ossmaxfrags
OL
l_int|4
)paren
id|state-&gt;dma_adc.ossmaxfrags
op_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|state-&gt;dma_dac.ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|state-&gt;dma_dac.ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;dma_dac.ossfragshift
OL
l_int|4
)paren
id|state-&gt;dma_dac.ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;dma_dac.ossfragshift
OG
l_int|15
)paren
id|state-&gt;dma_dac.ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;dma_dac.ossmaxfrags
OL
l_int|4
)paren
id|state-&gt;dma_dac.ossmaxfrags
op_assign
l_int|4
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state-&gt;dma_dac.enable
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|state-&gt;dma_dac.fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|state-&gt;dma_dac.dmasize
op_minus
id|state-&gt;dma_dac.count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|state-&gt;dma_dac.numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|state-&gt;dma_dac.fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state-&gt;dma_adc.enable
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|state-&gt;dma_adc.fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|state-&gt;dma_adc.count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|state-&gt;dma_adc.numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|state-&gt;dma_adc.fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
id|put_user
c_func
(paren
multiline_comment|/* DSP_CAP_DUPLEX|*/
id|DSP_CAP_REALTIME
op_or
id|DSP_CAP_TRIGGER
op_or
id|DSP_CAP_MMAP
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETTRIGGER
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|state-&gt;dma_adc.enable
)paren
id|val
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|state-&gt;dma_dac.enable
)paren
id|val
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_INPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|state-&gt;dma_adc.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_adc
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_OUTPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|state-&gt;dma_dac.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|state-&gt;dma_adc.total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|state-&gt;dma_adc.count
op_rshift
id|state-&gt;dma_adc.fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|state-&gt;dma_adc.hwptr
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;dma_adc.mapped
)paren
id|state-&gt;dma_adc.count
op_and_assign
id|state-&gt;dma_adc.fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|state-&gt;dma_dac.total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|state-&gt;dma_dac.count
op_rshift
id|state-&gt;dma_dac.fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|state-&gt;dma_dac.hwptr
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;dma_dac.mapped
)paren
id|state-&gt;dma_dac.count
op_and_assign
id|state-&gt;dma_dac.fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
multiline_comment|/* XXX fix */
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|val
op_assign
id|state-&gt;dma_dac.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
id|state-&gt;dma_adc.rate
suffix:colon
id|state-&gt;dma_dac.rate
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|put_user
c_func
(paren
(paren
id|state-&gt;dma_dac.fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_else
r_return
id|put_user
c_func
(paren
(paren
id|state-&gt;dma_adc.fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|put_user
c_func
(paren
(paren
id|state-&gt;dma_dac.fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_U8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_else
r_return
id|put_user
c_func
(paren
(paren
id|state-&gt;dma_adc.fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_U8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_MAPINBUF
suffix:colon
r_case
id|SNDCTL_DSP_MAPOUTBUF
suffix:colon
r_case
id|SNDCTL_DSP_SETSYNCRO
suffix:colon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|trident_open
r_static
r_int
id|trident_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|devs
suffix:semicolon
r_struct
id|trident_state
op_star
id|state
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* find an avaiable virtual channel (instance of /dev/dsp) */
r_while
c_loop
(paren
id|card
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;states
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|state
op_assign
id|card-&gt;states
(braket
id|i
)braket
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|trident_state
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|state
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|trident_state
)paren
)paren
suffix:semicolon
r_goto
id|found_virt
suffix:semicolon
)brace
)brace
id|card
op_assign
id|card-&gt;next
suffix:semicolon
)brace
multiline_comment|/* no more virtual channel avaiable */
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|found_virt
suffix:colon
multiline_comment|/* found a free virtual channel, allocate hardware channels */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
r_if
c_cond
(paren
(paren
id|state-&gt;dma_adc.channel
op_assign
id|trident_alloc_pcm_channel
c_func
(paren
id|card
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|kfree
(paren
id|card-&gt;states
(braket
id|i
)braket
)paren
suffix:semicolon
id|card-&gt;states
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_if
c_cond
(paren
(paren
id|state-&gt;dma_dac.channel
op_assign
id|trident_alloc_pcm_channel
c_func
(paren
id|card
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|kfree
(paren
id|card-&gt;states
(braket
id|i
)braket
)paren
suffix:semicolon
id|card-&gt;states
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
multiline_comment|/* free previously allocated hardware channel */
id|trident_free_pcm_channel
c_func
(paren
id|card
comma
id|state-&gt;dma_adc.channel-&gt;num
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* initialize the virtual channel */
id|state-&gt;virt
op_assign
id|i
suffix:semicolon
id|state-&gt;card
op_assign
id|card
suffix:semicolon
id|state-&gt;magic
op_assign
id|TRIDENT_STATE_MAGIC
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|state-&gt;dma_adc.wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|state-&gt;dma_dac.wait
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|state-&gt;open_sem
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|state
suffix:semicolon
id|down
c_func
(paren
op_amp
id|state-&gt;open_sem
)paren
suffix:semicolon
multiline_comment|/* set default sample format, Refer to  OSS Programmer&squot;s Guide */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
multiline_comment|/* FIXME: Trident 4d can only record in singed 16-bits stereo, 48kHz sample */
id|state-&gt;dma_adc.fmt
op_assign
id|TRIDENT_FMT_STEREO
op_or
id|TRIDENT_FMT_16BIT
suffix:semicolon
id|state-&gt;dma_adc.ossfragshift
op_assign
l_int|0
suffix:semicolon
id|state-&gt;dma_adc.ossmaxfrags
op_assign
l_int|0
suffix:semicolon
id|state-&gt;dma_adc.subdivision
op_assign
l_int|0
suffix:semicolon
id|trident_set_adc_rate
c_func
(paren
id|state
comma
l_int|48000
)paren
suffix:semicolon
)brace
multiline_comment|/* according to OSS document, /dev/dsp should be default to unsigned 8-bits, &n;&t;   mono, with sample rate 8kHz and /dev/dspW will accept 16-bits sample */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|state-&gt;dma_dac.fmt
op_and_assign
op_complement
id|TRIDENT_FMT_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0xf
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|state-&gt;dma_dac.fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
id|state-&gt;dma_dac.ossfragshift
op_assign
l_int|0
suffix:semicolon
id|state-&gt;dma_dac.ossmaxfrags
op_assign
l_int|0
suffix:semicolon
id|state-&gt;dma_dac.subdivision
op_assign
l_int|0
suffix:semicolon
id|trident_set_dac_rate
c_func
(paren
id|state
comma
l_int|8000
)paren
suffix:semicolon
)brace
id|state-&gt;open_mode
op_or_assign
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|state-&gt;open_sem
)paren
suffix:semicolon
singleline_comment|//FIXME put back in
singleline_comment|//MOD_INC_USE_COUNT;
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_release
r_static
r_int
id|trident_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|trident_clear_tail
c_func
(paren
id|state
)paren
suffix:semicolon
id|drain_dac
c_func
(paren
id|state
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
)brace
multiline_comment|/* stop DMA state machine and free DMA buffers/channels */
id|down
c_func
(paren
op_amp
id|state-&gt;open_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
op_amp
id|state-&gt;dma_dac
)paren
suffix:semicolon
id|trident_free_pcm_channel
c_func
(paren
id|state-&gt;card
comma
id|state-&gt;dma_dac.channel-&gt;num
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
op_amp
id|state-&gt;dma_adc
)paren
suffix:semicolon
id|trident_free_pcm_channel
c_func
(paren
id|state-&gt;card
comma
id|state-&gt;dma_adc.channel-&gt;num
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|state-&gt;card-&gt;states
(braket
id|state-&gt;virt
)braket
)paren
suffix:semicolon
id|state-&gt;card-&gt;states
(braket
id|state-&gt;virt
)braket
op_assign
l_int|NULL
suffix:semicolon
id|state-&gt;open_mode
op_and_assign
(paren
op_complement
id|file-&gt;f_mode
)paren
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
multiline_comment|/* we&squot;re covered by the open_sem */
id|up
c_func
(paren
op_amp
id|state-&gt;open_sem
)paren
suffix:semicolon
singleline_comment|//FIXME put back in
singleline_comment|//MOD_DEC_USE_COUNT;
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|trident_audio_fops
r_static
multiline_comment|/*const*/
r_struct
id|file_operations
id|trident_audio_fops
op_assign
(brace
op_amp
id|trident_llseek
comma
op_amp
id|trident_read
comma
op_amp
id|trident_write
comma
l_int|NULL
comma
multiline_comment|/* readdir */
op_amp
id|trident_poll
comma
op_amp
id|trident_ioctl
comma
op_amp
id|trident_mmap
comma
op_amp
id|trident_open
comma
l_int|NULL
comma
multiline_comment|/* flush */
op_amp
id|trident_release
comma
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* lock */
)brace
suffix:semicolon
multiline_comment|/* trident specific AC97 functions */
multiline_comment|/* Write AC97 mixer registers */
DECL|function|trident_ac97_set
r_static
r_void
id|trident_ac97_set
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_int
r_int
id|address
comma
id|mask
comma
id|busy
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|data
op_assign
(paren
(paren
id|u32
)paren
id|val
)paren
op_lshift
l_int|16
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_default
suffix:colon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|address
op_assign
id|SI_AC97_WRITE
suffix:semicolon
id|mask
op_assign
id|SI_AC97_BUSY_WRITE
op_or
id|SI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|SI_AC97_SECONDARY
suffix:semicolon
id|busy
op_assign
id|SI_AC97_BUSY_WRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|address
op_assign
id|DX_ACR0_AC97_W
suffix:semicolon
id|mask
op_assign
id|busy
op_assign
id|DX_AC97_BUSY_WRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|address
op_assign
id|NX_ACR1_AC97_W
suffix:semicolon
id|mask
op_assign
id|NX_AC97_BUSY_WRITE
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|NX_AC97_WRITE_SECONDARY
suffix:semicolon
id|busy
op_assign
id|NX_AC97_BUSY_WRITE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
op_amp
id|busy
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
suffix:semicolon
id|data
op_or_assign
(paren
id|mask
op_or
(paren
id|reg
op_amp
id|AC97_REG_ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: AC97 CODEC write timed out.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Read AC97 codec registers */
DECL|function|trident_ac97_get
r_static
id|u16
id|trident_ac97_get
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_int
r_int
id|address
comma
id|mask
comma
id|busy
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_default
suffix:colon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|address
op_assign
id|SI_AC97_READ
suffix:semicolon
id|mask
op_assign
id|SI_AC97_BUSY_READ
op_or
id|SI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|SI_AC97_SECONDARY
suffix:semicolon
id|busy
op_assign
id|SI_AC97_BUSY_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|address
op_assign
id|DX_ACR1_AC97_R
suffix:semicolon
id|mask
op_assign
id|busy
op_assign
id|DX_AC97_BUSY_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|address
op_assign
id|NX_ACR3_AC97_R_SECONDARY
suffix:semicolon
r_else
id|address
op_assign
id|NX_ACR2_AC97_R_PRIMARY
suffix:semicolon
id|mask
op_assign
id|NX_AC97_BUSY_READ
suffix:semicolon
id|busy
op_assign
l_int|0x0c00
suffix:semicolon
r_break
suffix:semicolon
)brace
id|data
op_assign
(paren
id|mask
op_or
(paren
id|reg
op_amp
id|AC97_REG_ADDR
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
r_do
(brace
id|data
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
id|busy
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: AC97 CODEC read timed out.&bslash;n&quot;
)paren
suffix:semicolon
id|data
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
(paren
id|u16
)paren
(paren
id|data
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* OSS /dev/mixer file operation methods */
DECL|function|trident_open_mixdev
r_static
r_int
id|trident_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|devs
suffix:semicolon
r_for
c_loop
(paren
id|card
op_assign
id|devs
suffix:semicolon
id|card
op_ne
l_int|NULL
suffix:semicolon
id|card
op_assign
id|card-&gt;next
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_AC97
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_ne
l_int|NULL
op_logical_and
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
op_eq
id|minor
)paren
r_goto
id|match
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|match
suffix:colon
id|file-&gt;private_data
op_assign
id|card-&gt;ac97_codec
(braket
id|i
)braket
suffix:semicolon
singleline_comment|//FIXME put back in
singleline_comment|//MOD_INC_USE_COUNT;
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_release_mixdev
r_static
r_int
id|trident_release_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
singleline_comment|//struct ac97_codec *codec = (struct ac97_codec *)file-&gt;private_data;
singleline_comment|//FIXME put back in
singleline_comment|//MOD_DEC_USE_COUNT;
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_ioctl_mixdev
r_static
r_int
id|trident_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ac97_codec
op_star
id|codec
op_assign
(paren
r_struct
id|ac97_codec
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_return
id|codec
op_member_access_from_pointer
id|mixer_ioctl
c_func
(paren
id|codec
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|variable|trident_mixer_fops
r_static
multiline_comment|/*const*/
r_struct
id|file_operations
id|trident_mixer_fops
op_assign
(brace
op_amp
id|trident_llseek
comma
l_int|NULL
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll */
op_amp
id|trident_ioctl_mixdev
comma
l_int|NULL
comma
multiline_comment|/* mmap */
op_amp
id|trident_open_mixdev
comma
l_int|NULL
comma
multiline_comment|/* flush */
op_amp
id|trident_release_mixdev
comma
l_int|NULL
comma
multiline_comment|/* fsync */
l_int|NULL
comma
multiline_comment|/* fasync */
l_int|NULL
comma
multiline_comment|/* lock */
)brace
suffix:semicolon
multiline_comment|/* AC97 codec initialisation. */
DECL|function|trident_ac97_init
r_static
r_int
id|__init
id|trident_ac97_init
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
id|num_ac97
op_assign
l_int|0
suffix:semicolon
r_int
id|ready_2nd
op_assign
l_int|0
suffix:semicolon
r_struct
id|ac97_codec
op_star
id|codec
suffix:semicolon
multiline_comment|/* initialize controller side of AC link, and find out if secondary codes&n;&t;   really exist */
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
multiline_comment|/* disable AC97 GPIO interrupt */
id|outl
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_AC97_GPIO
)paren
)paren
suffix:semicolon
multiline_comment|/* stop AC97 cold reset process */
id|outl
c_func
(paren
id|PCMOUT
op_or
id|SECONDARY_ID
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_SERIAL_INTF_CTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_SERIAL_INTF_CTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
id|SI_AC97_SECONDARY_READY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
multiline_comment|/* playback on */
id|outl
c_func
(paren
id|DX_AC97_PLAYBACK
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
multiline_comment|/* enable AC97 Output Slot 3,4 (PCM Left/Right Playback) */
id|outl
c_func
(paren
id|NX_AC97_PCM_OUTPUT
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
id|NX_AC97_SECONDARY_READY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|num_ac97
op_assign
l_int|0
suffix:semicolon
id|num_ac97
OL
id|NR_AC97
suffix:semicolon
id|num_ac97
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|codec
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ac97_codec
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|codec
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ac97_codec
)paren
)paren
suffix:semicolon
multiline_comment|/* initialize some basic codec information, other fields will be filled&n;&t;&t;   in ac97_probe_codec */
id|codec-&gt;private_data
op_assign
id|card
suffix:semicolon
id|codec-&gt;id
op_assign
id|num_ac97
suffix:semicolon
multiline_comment|/* controller specific low level AC97 access function */
id|codec-&gt;codec_read
op_assign
id|trident_ac97_get
suffix:semicolon
id|codec-&gt;codec_write
op_assign
id|trident_ac97_set
suffix:semicolon
r_if
c_cond
(paren
id|ac97_probe_codec
c_func
(paren
id|codec
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|codec-&gt;dev_mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|trident_mixer_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: couldn&squot;t register mixer!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|codec
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;ac97_codec
(braket
id|num_ac97
)braket
op_assign
id|codec
suffix:semicolon
multiline_comment|/* if there is no secondary codec at all, don&squot;t probe any more */
r_if
c_cond
(paren
op_logical_neg
id|ready_2nd
)paren
r_return
id|num_ac97
op_plus
l_int|1
suffix:semicolon
)brace
r_return
id|num_ac97
suffix:semicolon
)brace
multiline_comment|/* install the driver, we do not allocate hardware channel nor DMA buffer now, they are defered &n;   untill &quot;ACCESS&quot; time (in prog_dmabuf calles by open/read/write/ioctl/mmap) */
DECL|function|trident_install
r_static
r_int
id|__init
id|trident_install
c_func
(paren
r_struct
id|pci_dev
op_star
id|pcidev
comma
r_struct
id|pci_audio_info
op_star
id|pci_info
)paren
(brace
id|u16
id|w
suffix:semicolon
r_int
r_int
id|iobase
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
id|iobase
op_assign
id|pcidev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
l_int|256
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: can&squot;t allocate I/O space at 0x%4.4lx&bslash;n&quot;
comma
id|iobase
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* just to be sure that IO space and bus master is on */
id|pci_set_master
c_func
(paren
id|pcidev
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pcidev
comma
id|PCI_COMMAND
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_or_assign
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pcidev
comma
id|PCI_COMMAND
comma
id|w
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|trident_card
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|card
)paren
)paren
suffix:semicolon
id|card-&gt;iobase
op_assign
id|iobase
suffix:semicolon
id|card-&gt;pci_info
op_assign
id|pci_info
suffix:semicolon
id|card-&gt;pci_id
op_assign
id|pci_info-&gt;device
suffix:semicolon
id|card-&gt;irq
op_assign
id|pcidev-&gt;irq
suffix:semicolon
id|card-&gt;next
op_assign
id|devs
suffix:semicolon
id|card-&gt;magic
op_assign
id|TRIDENT_CARD_MAGIC
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_A
)braket
dot
id|addresses
op_assign
op_amp
id|bank_a_addrs
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_A
)braket
dot
id|bitmap
op_assign
l_int|0UL
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_B
)braket
dot
id|addresses
op_assign
op_amp
id|bank_b_addrs
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_B
)braket
dot
id|bitmap
op_assign
l_int|0UL
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|devs
op_assign
id|card
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;trident: %s found at IO 0x%04lx, IRQ %d&bslash;n&quot;
comma
id|card-&gt;pci_info-&gt;name
comma
id|card-&gt;iobase
comma
id|card-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* claim our iospace and irq */
id|request_region
c_func
(paren
id|card-&gt;iobase
comma
l_int|256
comma
id|card-&gt;pci_info-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|card-&gt;irq
comma
op_amp
id|trident_interrupt
comma
id|SA_SHIRQ
comma
id|card-&gt;pci_info-&gt;name
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: unable to allocate irq %d&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|card-&gt;iobase
comma
l_int|256
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* register /dev/dsp */
r_if
c_cond
(paren
(paren
id|card-&gt;dev_audio
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|trident_audio_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: coundn&squot;t register DSP device!&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|iobase
comma
l_int|256
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* initilize AC97 codec and register /dev/mixer */
r_if
c_cond
(paren
id|trident_ac97_init
c_func
(paren
id|card
)paren
op_le
l_int|0
)paren
(brace
id|unregister_sound_dsp
c_func
(paren
id|card-&gt;dev_audio
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|iobase
comma
l_int|256
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outl
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MUSICVOL_WAVEVOL
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable Address Engine Interrupts */
id|trident_enable_loop_interrupts
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|init_trident
r_static
r_int
id|__init
id|init_trident
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|foundone
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
multiline_comment|/* No PCI bus in this machine! */
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Trident 4DWave/SiS 7018 PCI Audio, version &quot;
id|DRIVER_VERSION
l_string|&quot;, &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|pci_audio_devices
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
c_func
(paren
id|pci_audio_devices
(braket
id|i
)braket
dot
id|vendor
comma
id|pci_audio_devices
(braket
id|i
)braket
dot
id|device
comma
id|pcidev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|foundone
op_add_assign
id|trident_install
c_func
(paren
id|pcidev
comma
id|pci_audio_devices
op_plus
id|i
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|foundone
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alan Cox, Aaron Holtzman, Ollie Lho&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Trident 4DWave/SiS 7018 PCI Audio Driver&quot;
)paren
suffix:semicolon
DECL|function|cleanup_trident
r_static
r_void
id|__exit
id|cleanup_trident
c_func
(paren
r_void
)paren
(brace
r_while
c_loop
(paren
id|devs
op_ne
l_int|NULL
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Kill interrupts, and SP/DIF */
id|trident_disable_loop_interrupts
c_func
(paren
id|devs
)paren
suffix:semicolon
multiline_comment|/* free hardware resources */
id|free_irq
c_func
(paren
id|devs-&gt;irq
comma
id|devs
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|devs-&gt;iobase
comma
l_int|256
)paren
suffix:semicolon
multiline_comment|/* unregister audio devices */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_AC97
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|devs-&gt;ac97_codec
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|unregister_sound_mixer
c_func
(paren
id|devs-&gt;ac97_codec
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
)paren
suffix:semicolon
id|kfree
(paren
id|devs-&gt;ac97_codec
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|unregister_sound_dsp
c_func
(paren
id|devs-&gt;dev_audio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|devs
)paren
suffix:semicolon
id|devs
op_assign
id|devs-&gt;next
suffix:semicolon
)brace
)brace
DECL|variable|init_trident
id|module_init
c_func
(paren
id|init_trident
)paren
suffix:semicolon
DECL|variable|cleanup_trident
id|module_exit
c_func
(paren
id|cleanup_trident
)paren
suffix:semicolon
eof
