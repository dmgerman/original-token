multiline_comment|/*&n; *&n; *&t;Trident 4D-Wave/SiS 7018/ALi 5451 OSS driver for Linux 2.2.x&n; *&n; *&t;Driver: Alan Cox &lt;alan@redhat.com&gt;&n; *&n; *  Built from:&n; *&t;Low level code: &lt;audio@tridentmicro.com&gt; from ALSA&n; *&t;Framework: Thomas Sailer &lt;sailer@ife.ee.ethz.ch&gt;&n; *&t;Extended by: Zach Brown &lt;zab@redhat.com&gt;  &n; *&n; *  Hacked up by:&n; *&t;Aaron Holtzman &lt;aholtzma@ess.engr.uvic.ca&gt;&n; *&t;Ollie Lho &lt;ollie@sis.com.tw&gt; SiS 7018 Audio Core Support&n; *&t;Ching-Ling Lee &lt;cling-li@ali.com.tw&gt; ALi 5451 Audio Core Support &n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  History&n; *  v0.14.6 &n; *&t;Nov 1 2000 Ching-Ling Lee&n; *&t;Fix the bug of memory leak when swithing 5.1-channels to 2 channels.&n; *&t;Add lock protection into dynamic changing format of data.&n; *&t;Oct 18 2000 Ching-Ling Lee&n; *&t;5.1-channels support for ALi&n; *&t;June 28 2000 Ching-Ling Lee&n; *&t;S/PDIF out/in(playback/record) support for ALi 1535+, using /proc to be selected by user&n; *&t;Simple Power Management support for ALi&n; *  v0.14.5 May 23 2000 Ollie Lho&n; *  &t;Misc bug fix from the Net&n; *  v0.14.4 May 20 2000 Aaron Holtzman&n; *  &t;Fix kfree&squot;d memory access in release&n; *  &t;Fix race in open while looking for a free virtual channel slot&n; *  &t;remove open_wait wq (which appears to be unused)&n; *  v0.14.3 May 10 2000 Ollie Lho&n; *&t;fixed a small bug in trident_update_ptr, xmms 1.0.1 no longer uses 100% CPU&n; *  v0.14.2 Mar 29 2000 Ching-Ling Lee&n; *&t;Add clear to silence advance in trident_update_ptr &n; *&t;fix invalid data of the end of the sound&n; *  v0.14.1 Mar 24 2000 Ching-Ling Lee&n; *&t;ALi 5451 support added, playback and recording O.K.&n; *&t;ALi 5451 originally developed and structured based on sonicvibes, and&n; *&t;suggested to merge into this file by Alan Cox.&n; *  v0.14 Mar 15 2000 Ollie Lho&n; *&t;5.1 channel output support with channel binding. What&squot;s the Matrix ?&n; *  v0.13.1 Mar 10 2000 Ollie Lho&n; *&t;few minor bugs on dual codec support, needs more testing&n; *  v0.13 Mar 03 2000 Ollie Lho&n; *&t;new pci_* for 2.4 kernel, back ported to 2.2&n; *  v0.12 Feb 23 2000 Ollie Lho&n; *&t;Preliminary Recording support&n; *  v0.11.2 Feb 19 2000 Ollie Lho&n; *&t;removed incomplete full-dulplex support&n; *  v0.11.1 Jan 28 2000 Ollie Lho&n; *&t;small bug in setting sample rate for 4d-nx (reported by Aaron)&n; *  v0.11 Jan 27 2000 Ollie Lho&n; *&t;DMA bug, scheduler latency, second try&n; *  v0.10 Jan 24 2000 Ollie Lho&n; *&t;DMA bug fixed, found kernel scheduling problem&n; *  v0.09 Jan 20 2000 Ollie Lho&n; *&t;Clean up of channel register access routine (prepare for channel binding)&n; *  v0.08 Jan 14 2000 Ollie Lho&n; *&t;Isolation of AC97 codec code&n; *  v0.07 Jan 13 2000 Ollie Lho&n; *&t;Get rid of ugly old low level access routines (e.g. CHRegs.lp****)&n; *  v0.06 Jan 11 2000 Ollie Lho&n; *&t;Preliminary support for dual (more ?) AC97 codecs&n; *  v0.05 Jan 08 2000 Luca Montecchiani &lt;m.luca@iname.com&gt;&n; *&t;adapt to 2.3.x new __setup/__init call&n; *  v0.04 Dec 31 1999 Ollie Lho&n; *&t;Multiple Open, using Middle Loop Interrupt to smooth playback&n; *  v0.03 Dec 24 1999 Ollie Lho&n; *&t;mem leak in prog_dmabuf and dealloc_dmabuf removed&n; *  v0.02 Dec 15 1999 Ollie Lho&n; *&t;SiS 7018 support added, playback O.K.&n; *  v0.01 Alan Cox et. al.&n; *&t;Initial Release in kernel 2.3.30, does not work&n; * &n; *  ToDo&n; *&t;Clean up of low level channel register access code. (done)&n; *&t;Fix the bug on dma buffer management in update_ptr, read/write, drain_dac (done)&n; *&t;Dual AC97 codecs support (done)&n; *&t;Recording support (done)&n; *&t;Mmap support&n; *&t;&quot;Channel Binding&quot; ioctl extension (done)&n; *&t;new pci device driver interface for 2.4 kernel (done)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/ac97_codec.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &quot;trident.h&quot;
macro_line|#include &lt;linux/pm.h&gt;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;0.14.6&quot;
multiline_comment|/* magic numbers to protect our data structures */
DECL|macro|TRIDENT_CARD_MAGIC
mdefine_line|#define TRIDENT_CARD_MAGIC&t;0x5072696E /* &quot;Prin&quot; */
DECL|macro|TRIDENT_STATE_MAGIC
mdefine_line|#define TRIDENT_STATE_MAGIC&t;0x63657373 /* &quot;cess&quot; */
DECL|macro|TRIDENT_DMA_MASK
mdefine_line|#define TRIDENT_DMA_MASK&t;0x3fffffff /* DMA buffer mask for pci_alloc_consist */
DECL|macro|NR_HW_CH
mdefine_line|#define NR_HW_CH&t;&t;32
multiline_comment|/* maxinum nuber of AC97 codecs connected, AC97 2.0 defined 4, but 7018 and 4D-NX only&n;   have 2 SDATA_IN lines (currently) */
DECL|macro|NR_AC97
mdefine_line|#define NR_AC97&t;&t;2
multiline_comment|/* minor number of /dev/swmodem (temporary, experimental) */
DECL|macro|SND_DEV_SWMODEM
mdefine_line|#define SND_DEV_SWMODEM&t;7
DECL|variable|ali_multi_channels_5_1
r_static
r_const
r_int
id|ali_multi_channels_5_1
(braket
)braket
op_assign
(brace
id|ALI_CENTER_CHANNEL
comma
id|ALI_LEF_CHANNEL
comma
id|ALI_SURR_LEFT_CHANNEL
comma
id|ALI_SURR_RIGHT_CHANNEL
)brace
suffix:semicolon
DECL|variable|sample_size
r_static
r_const
r_int
id|sample_size
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|4
)brace
suffix:semicolon
DECL|variable|sample_shift
r_static
r_const
r_int
id|sample_shift
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|2
)brace
suffix:semicolon
DECL|variable|invalid_magic
r_static
r_const
r_char
id|invalid_magic
(braket
)braket
op_assign
id|KERN_CRIT
l_string|&quot;trident: invalid magic value in %s&bslash;n&quot;
suffix:semicolon
r_enum
(brace
DECL|enumerator|TRIDENT_4D_DX
id|TRIDENT_4D_DX
op_assign
l_int|0
comma
DECL|enumerator|TRIDENT_4D_NX
id|TRIDENT_4D_NX
comma
DECL|enumerator|SIS_7018
id|SIS_7018
comma
DECL|enumerator|ALI_5451
id|ALI_5451
)brace
suffix:semicolon
DECL|variable|card_names
r_static
r_char
op_star
id|card_names
(braket
)braket
op_assign
(brace
l_string|&quot;Trident 4DWave DX&quot;
comma
l_string|&quot;Trident 4DWave NX&quot;
comma
l_string|&quot;SiS 7018 PCI Audio&quot;
comma
l_string|&quot;ALi Audio Accelerator&quot;
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|trident_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_TRIDENT
comma
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TRIDENT_4D_DX
)brace
comma
(brace
id|PCI_VENDOR_ID_TRIDENT
comma
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TRIDENT_4D_NX
)brace
comma
(brace
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_7018
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|SIS_7018
)brace
comma
(brace
id|PCI_VENDOR_ID_ALI
comma
id|PCI_DEVICE_ID_ALI_5451
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|ALI_5451
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|trident_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* &quot;software&quot; or virtual channel, an instance of opened /dev/dsp */
DECL|struct|trident_state
r_struct
id|trident_state
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|card
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
multiline_comment|/* Card info */
multiline_comment|/* file mode */
DECL|member|open_mode
id|mode_t
id|open_mode
suffix:semicolon
multiline_comment|/* virtual channel number */
DECL|member|virt
r_int
id|virt
suffix:semicolon
DECL|struct|dmabuf
r_struct
id|dmabuf
(brace
multiline_comment|/* wave sample stuff */
DECL|member|rate
r_int
r_int
id|rate
suffix:semicolon
DECL|member|fmt
DECL|member|enable
r_int
r_char
id|fmt
comma
id|enable
suffix:semicolon
multiline_comment|/* hardware channel */
DECL|member|channel
r_struct
id|trident_channel
op_star
id|channel
suffix:semicolon
multiline_comment|/* OSS buffer management stuff */
DECL|member|rawbuf
r_void
op_star
id|rawbuf
suffix:semicolon
DECL|member|dma_handle
id|dma_addr_t
id|dma_handle
suffix:semicolon
DECL|member|buforder
r_int
id|buforder
suffix:semicolon
DECL|member|numfrag
r_int
id|numfrag
suffix:semicolon
DECL|member|fragshift
r_int
id|fragshift
suffix:semicolon
multiline_comment|/* our buffer acts like a circular ring */
DECL|member|hwptr
r_int
id|hwptr
suffix:semicolon
multiline_comment|/* where dma last started, updated by update_ptr */
DECL|member|swptr
r_int
id|swptr
suffix:semicolon
multiline_comment|/* where driver last clear/filled, updated by read/write */
DECL|member|count
r_int
id|count
suffix:semicolon
multiline_comment|/* bytes to be comsumed or been generated by dma machine */
DECL|member|total_bytes
r_int
id|total_bytes
suffix:semicolon
multiline_comment|/* total bytes dmaed by hardware */
DECL|member|error
r_int
id|error
suffix:semicolon
multiline_comment|/* number of over/underruns */
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
multiline_comment|/* put process on wait queue when no more space in buffer */
multiline_comment|/* redundant, but makes calculations easier */
DECL|member|fragsize
r_int
id|fragsize
suffix:semicolon
DECL|member|dmasize
r_int
id|dmasize
suffix:semicolon
DECL|member|fragsamples
r_int
id|fragsamples
suffix:semicolon
multiline_comment|/* OSS stuff */
DECL|member|mapped
r_int
id|mapped
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ready
r_int
id|ready
suffix:colon
l_int|1
suffix:semicolon
DECL|member|endcleared
r_int
id|endcleared
suffix:colon
l_int|1
suffix:semicolon
DECL|member|update_flag
r_int
id|update_flag
suffix:semicolon
DECL|member|ossfragshift
r_int
id|ossfragshift
suffix:semicolon
DECL|member|ossmaxfrags
r_int
id|ossmaxfrags
suffix:semicolon
DECL|member|subdivision
r_int
id|subdivision
suffix:semicolon
DECL|member|dmabuf
)brace
id|dmabuf
suffix:semicolon
multiline_comment|/* 5.1channels */
DECL|member|other_states
r_struct
id|trident_state
op_star
id|other_states
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|multi_channels_adjust_count
r_int
id|multi_channels_adjust_count
suffix:semicolon
DECL|member|chans_num
r_int
id|chans_num
suffix:semicolon
DECL|member|fmt_flag
r_int
id|fmt_flag
suffix:colon
l_int|1
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* hardware channels */
DECL|struct|trident_channel
r_struct
id|trident_channel
(brace
DECL|member|num
r_int
id|num
suffix:semicolon
multiline_comment|/* channel number */
DECL|member|lba
id|u32
id|lba
suffix:semicolon
multiline_comment|/* Loop Begine Address, where dma buffer starts */
DECL|member|eso
id|u32
id|eso
suffix:semicolon
multiline_comment|/* End Sample Offset, wehre dma buffer ends (in the unit of samples) */
DECL|member|delta
id|u32
id|delta
suffix:semicolon
multiline_comment|/* delta value, sample rate / 48k for playback, 48k/sample rate for recording */
DECL|member|attribute
id|u16
id|attribute
suffix:semicolon
multiline_comment|/* control where PCM data go and come  */
DECL|member|fm_vol
id|u16
id|fm_vol
suffix:semicolon
DECL|member|control
id|u32
id|control
suffix:semicolon
multiline_comment|/* signed/unsigned, 8/16 bits, mono/stereo */
)brace
suffix:semicolon
DECL|struct|trident_pcm_bank_address
r_struct
id|trident_pcm_bank_address
(brace
DECL|member|start
id|u32
id|start
suffix:semicolon
DECL|member|stop
id|u32
id|stop
suffix:semicolon
DECL|member|aint
id|u32
id|aint
suffix:semicolon
DECL|member|aint_en
id|u32
id|aint_en
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|bank_a_addrs
r_static
r_struct
id|trident_pcm_bank_address
id|bank_a_addrs
op_assign
(brace
id|T4D_START_A
comma
id|T4D_STOP_A
comma
id|T4D_AINT_A
comma
id|T4D_AINTEN_A
)brace
suffix:semicolon
DECL|variable|bank_b_addrs
r_static
r_struct
id|trident_pcm_bank_address
id|bank_b_addrs
op_assign
(brace
id|T4D_START_B
comma
id|T4D_STOP_B
comma
id|T4D_AINT_B
comma
id|T4D_AINTEN_B
)brace
suffix:semicolon
DECL|struct|trident_pcm_bank
r_struct
id|trident_pcm_bank
(brace
multiline_comment|/* register addresses to control bank operations */
DECL|member|addresses
r_struct
id|trident_pcm_bank_address
op_star
id|addresses
suffix:semicolon
multiline_comment|/* each bank has 32 channels */
DECL|member|bitmap
id|u32
id|bitmap
suffix:semicolon
multiline_comment|/* channel allocation bitmap */
DECL|member|channels
r_struct
id|trident_channel
id|channels
(braket
l_int|32
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|trident_card
r_struct
id|trident_card
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
multiline_comment|/* We keep trident cards in a linked list */
DECL|member|next
r_struct
id|trident_card
op_star
id|next
suffix:semicolon
multiline_comment|/* single open lock mechanism, only used for recording */
DECL|member|open_sem
r_struct
id|semaphore
id|open_sem
suffix:semicolon
multiline_comment|/* The trident has a certain amount of cross channel interaction&n;&t;   so we use a single per card lock */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* PCI device stuff */
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|pci_id
id|u16
id|pci_id
suffix:semicolon
DECL|member|revision
id|u8
id|revision
suffix:semicolon
multiline_comment|/* soundcore stuff */
DECL|member|dev_audio
r_int
id|dev_audio
suffix:semicolon
multiline_comment|/* structures for abstraction of hardware facilities, codecs, banks and channels*/
DECL|member|ac97_codec
r_struct
id|ac97_codec
op_star
id|ac97_codec
(braket
id|NR_AC97
)braket
suffix:semicolon
DECL|member|banks
r_struct
id|trident_pcm_bank
id|banks
(braket
id|NR_BANKS
)braket
suffix:semicolon
DECL|member|states
r_struct
id|trident_state
op_star
id|states
(braket
id|NR_HW_CH
)braket
suffix:semicolon
multiline_comment|/* hardware resources */
DECL|member|iobase
r_int
r_int
id|iobase
suffix:semicolon
DECL|member|irq
id|u32
id|irq
suffix:semicolon
multiline_comment|/* Function support */
DECL|member|alloc_pcm_channel
r_struct
id|trident_channel
op_star
(paren
op_star
id|alloc_pcm_channel
)paren
(paren
r_struct
id|trident_card
op_star
)paren
suffix:semicolon
DECL|member|alloc_rec_pcm_channel
r_struct
id|trident_channel
op_star
(paren
op_star
id|alloc_rec_pcm_channel
)paren
(paren
r_struct
id|trident_card
op_star
)paren
suffix:semicolon
DECL|member|free_pcm_channel
r_void
(paren
op_star
id|free_pcm_channel
)paren
(paren
r_struct
id|trident_card
op_star
comma
r_int
r_int
id|chan
)paren
suffix:semicolon
DECL|member|address_interrupt
r_void
(paren
op_star
id|address_interrupt
)paren
(paren
r_struct
id|trident_card
op_star
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* table to map from CHANNELMASK to channel attribute for SiS 7018 */
DECL|variable|mask2attr
r_static
id|u16
id|mask2attr
(braket
)braket
op_assign
(brace
id|PCM_LR
comma
id|PCM_LR
comma
id|SURR_LR
comma
id|CENTER_LFE
comma
id|HSET
comma
id|MIC
comma
id|MODEM_LINE1
comma
id|MODEM_LINE2
comma
id|I2S_LR
comma
id|SPDIF_LR
)brace
suffix:semicolon
multiline_comment|/* table to map from channel attribute to CHANNELMASK for SiS 7018 */
DECL|variable|attr2mask
r_static
r_int
id|attr2mask
(braket
)braket
op_assign
(brace
id|DSP_BIND_MODEM1
comma
id|DSP_BIND_MODEM2
comma
id|DSP_BIND_FRONT
comma
id|DSP_BIND_HANDSET
comma
id|DSP_BIND_I2S
comma
id|DSP_BIND_CENTER_LFE
comma
id|DSP_BIND_SURR
comma
id|DSP_BIND_SPDIF
)brace
suffix:semicolon
DECL|variable|devs
r_static
r_struct
id|trident_card
op_star
id|devs
suffix:semicolon
r_static
r_void
id|trident_ac97_set
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
suffix:semicolon
r_static
id|u16
id|trident_ac97_get
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
suffix:semicolon
r_static
r_int
id|trident_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|trident_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
id|loff_t
id|trident_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
suffix:semicolon
r_static
r_void
id|ali_ac97_set
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
suffix:semicolon
r_static
id|u16
id|ali_ac97_get
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
suffix:semicolon
r_static
r_void
id|ali_set_spdif_out_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|rate
)paren
suffix:semicolon
r_static
r_void
id|ali_enable_special_channel
c_func
(paren
r_struct
id|trident_state
op_star
id|stat
)paren
suffix:semicolon
r_static
r_struct
id|trident_channel
op_star
id|ali_alloc_rec_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_struct
id|trident_channel
op_star
id|ali_alloc_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|ali_pm_callback
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|ali_restore_regs
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_save_regs
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_free_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
suffix:semicolon
r_static
r_int
id|ali_setup_multi_channels
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|chan_nums
)paren
suffix:semicolon
r_static
r_int
r_int
id|ali_get_spdif_in_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_setup_spdif_in
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_disable_spdif_in
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_disable_special_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|ch
)paren
suffix:semicolon
r_static
r_void
id|ali_setup_spdif_out
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|flag
)paren
suffix:semicolon
r_static
r_int
id|ali_write_5_1
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|cnt_for_multi_channel
comma
r_int
r_int
op_star
id|copy_count
comma
r_int
r_int
op_star
id|state_cnt
)paren
suffix:semicolon
r_static
r_int
id|ali_allocate_other_states_resources
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|chan_nums
)paren
suffix:semicolon
r_static
r_void
id|ali_free_other_states_resources
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
suffix:semicolon
multiline_comment|/* save registers for ALi Power Management */
DECL|struct|ali_saved_registers
r_static
r_struct
id|ali_saved_registers
(brace
DECL|member|global_regs
r_int
r_int
id|global_regs
(braket
id|ALI_GLOBAL_REGS
)braket
suffix:semicolon
DECL|member|channel_regs
r_int
r_int
id|channel_regs
(braket
id|ALI_CHANNELS
)braket
(braket
id|ALI_CHANNEL_REGS
)braket
suffix:semicolon
DECL|member|mixer_regs
r_int
id|mixer_regs
(braket
id|ALI_MIXER_REGS
)braket
suffix:semicolon
DECL|variable|ali_registers
)brace
id|ali_registers
suffix:semicolon
DECL|macro|seek_offset
mdefine_line|#define seek_offset(dma_ptr, buffer, cnt, offset, copy_count)&t;(dma_ptr) += (offset);&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;(buffer) += (offset);&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;(cnt) -= (offset);&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;(copy_count) += (offset);
DECL|macro|lock_set_fmt
mdefine_line|#define lock_set_fmt(state)&t;{spin_lock_irqsave(&amp;state-&gt;card-&gt;lock, flags);&t;&t;&t;&bslash;&n;&t;&t;&t;&t;if (state-&gt;fmt_flag) {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;spin_unlock_irqrestore(&amp;state-&gt;card-&gt;lock, flags);&t;&bslash;&n;&t;&t;&t;&t;&t;return -EFAULT;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;state-&gt;fmt_flag = 1;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;spin_unlock_irqrestore(&amp;state-&gt;card-&gt;lock, flags);}
DECL|macro|unlock_set_fmt
mdefine_line|#define unlock_set_fmt(state)&t;{spin_lock_irqsave(&amp;state-&gt;card-&gt;lock, flags);&t;&t;&bslash;&n;&t;&t;&t;&t;state-&gt;fmt_flag = 0;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;spin_unlock_irqrestore(&amp;state-&gt;card-&gt;lock, flags);}
DECL|function|trident_enable_loop_interrupts
r_static
r_int
id|trident_enable_loop_interrupts
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
id|u32
id|global_control
suffix:semicolon
id|global_control
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|global_control
op_or_assign
(paren
id|ENDLP_IE
op_or
id|MIDLP_IE
op_or
id|BANK_B_EN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|global_control
op_or_assign
(paren
id|ENDLP_IE
op_or
id|MIDLP_IE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|FALSE
suffix:semicolon
)brace
id|outl
c_func
(paren
id|global_control
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: Enable Loop Interrupts, globctl = 0x%08X&bslash;n&quot;
comma
id|global_control
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|trident_disable_loop_interrupts
r_static
r_int
id|trident_disable_loop_interrupts
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
id|u32
id|global_control
suffix:semicolon
id|global_control
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
id|global_control
op_and_assign
op_complement
(paren
id|ENDLP_IE
op_or
id|MIDLP_IE
)paren
suffix:semicolon
id|outl
c_func
(paren
id|global_control
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: Disabled Loop Interrupts, globctl = 0x%08X&bslash;n&quot;
comma
id|global_control
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
DECL|function|trident_enable_voice_irq
r_static
r_void
id|trident_enable_voice_irq
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint_en
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|reg
op_or_assign
id|mask
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINTEN_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: enabled IRQ on channel %d, AINTEN_B = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_disable_voice_irq
r_static
r_void
id|trident_disable_voice_irq
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint_en
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
id|mask
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Ack the channel in case the interrupt was set before we disable it. */
id|outl
c_func
(paren
id|mask
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|bank-&gt;addresses-&gt;aint
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINTEN_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: disabled IRQ on channel %d, AINTEN_B = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_start_voice
r_static
r_void
id|trident_start_voice
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|addr
op_assign
id|bank-&gt;addresses-&gt;start
suffix:semicolon
macro_line|#ifdef DEBUG
id|u32
id|reg
suffix:semicolon
macro_line|#endif
id|outl
c_func
(paren
id|mask
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_START_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: start voice on channel %d, START_B  = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_stop_voice
r_static
r_void
id|trident_stop_voice
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|addr
op_assign
id|bank-&gt;addresses-&gt;stop
suffix:semicolon
macro_line|#ifdef DEBUG
id|u32
id|reg
suffix:semicolon
macro_line|#endif
id|outl
c_func
(paren
id|mask
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_STOP_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: stop voice on channel %d,  STOP_B  = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_get_interrupt_mask
r_static
id|u32
id|trident_get_interrupt_mask
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
)braket
suffix:semicolon
id|u32
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint
suffix:semicolon
r_return
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|trident_check_channel_interrupt
r_static
r_int
id|trident_check_channel_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|u32
id|reg
op_assign
id|trident_get_interrupt_mask
(paren
id|card
comma
id|channel
op_rshift
l_int|5
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|reg
op_amp
id|mask
)paren
id|printk
c_func
(paren
l_string|&quot;trident: channel %d has interrupt, AINT_B = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|reg
op_amp
id|mask
)paren
ques
c_cond
id|TRUE
suffix:colon
id|FALSE
suffix:semicolon
)brace
DECL|function|trident_ack_channel_interrupt
r_static
r_void
id|trident_ack_channel_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|reg
op_and_assign
id|mask
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINT_B
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;trident: Ack channel %d interrupt, AINT_B = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|trident_alloc_pcm_channel
r_static
r_struct
id|trident_channel
op_star
id|trident_alloc_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_B
)braket
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|31
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
op_plus
l_int|32
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
)brace
multiline_comment|/* no more free channels avaliable */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: no more channels available on Bank B.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|trident_free_pcm_channel
r_static
r_void
id|trident_free_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
id|bank
suffix:semicolon
r_if
c_cond
(paren
id|channel
template_param
l_int|63
)paren
r_return
suffix:semicolon
id|bank
op_assign
id|channel
op_rshift
l_int|5
suffix:semicolon
id|channel
op_assign
id|channel
op_amp
l_int|0x1f
suffix:semicolon
id|card-&gt;banks
(braket
id|bank
)braket
dot
id|bitmap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|channel
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* called with spin lock held */
DECL|function|trident_load_channel_registers
r_static
r_int
id|trident_load_channel_registers
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
id|u32
op_star
id|data
comma
r_int
r_int
id|channel
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|channel
OG
l_int|63
)paren
r_return
id|FALSE
suffix:semicolon
multiline_comment|/* select hardware channel to write */
id|outb
c_func
(paren
id|channel
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
multiline_comment|/* Output the channel registers, but don&squot;t write register&n;&t;   three to an ALI chip. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CHANNEL_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|3
op_logical_and
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
r_continue
suffix:semicolon
id|outl
c_func
(paren
id|data
(braket
id|i
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|CHANNEL_START
op_plus
l_int|4
op_star
id|i
)paren
)paren
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* called with spin lock held */
DECL|function|trident_write_voice_regs
r_static
r_int
id|trident_write_voice_regs
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_int
r_int
id|data
(braket
id|CHANNEL_REGS
op_plus
l_int|1
)braket
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
suffix:semicolon
id|channel
op_assign
id|state-&gt;dmabuf.channel
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|channel-&gt;lba
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|channel-&gt;control
suffix:semicolon
r_switch
c_cond
(paren
id|state-&gt;card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current Sample Offset */
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|channel-&gt;eso
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;delta
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current Sample Offset */
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|channel-&gt;eso
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;delta
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
(paren
id|channel-&gt;attribute
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;fm_vol
op_amp
l_int|0xffff
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current Sample Offset */
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|channel-&gt;eso
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;delta
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|channel-&gt;fm_vol
op_amp
l_int|0xffff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
(paren
id|channel-&gt;delta
op_lshift
l_int|24
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|channel-&gt;delta
op_lshift
l_int|16
)paren
op_amp
l_int|0xff000000
)paren
op_or
(paren
id|channel-&gt;eso
op_amp
l_int|0x00ffffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|channel-&gt;fm_vol
op_amp
l_int|0xffff
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|FALSE
suffix:semicolon
)brace
r_return
id|trident_load_channel_registers
c_func
(paren
id|state-&gt;card
comma
id|data
comma
id|channel-&gt;num
)paren
suffix:semicolon
)brace
DECL|function|compute_rate_play
r_static
r_int
id|compute_rate_play
c_func
(paren
id|u32
id|rate
)paren
(brace
r_int
id|delta
suffix:semicolon
multiline_comment|/* We special case 44100 and 8000 since rounding with the equation&n;&t;   does not give us an accurate enough value. For 11025 and 22050&n;&t;   the equation gives us the best answer. All other frequencies will&n;&t;   also use the equation. JDW */
r_if
c_cond
(paren
id|rate
op_eq
l_int|44100
)paren
id|delta
op_assign
l_int|0xeb3
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|8000
)paren
id|delta
op_assign
l_int|0x2ab
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|48000
)paren
id|delta
op_assign
l_int|0x1000
suffix:semicolon
r_else
id|delta
op_assign
(paren
(paren
(paren
id|rate
op_lshift
l_int|12
)paren
op_plus
id|rate
)paren
op_div
l_int|48000
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
r_return
id|delta
suffix:semicolon
)brace
DECL|function|compute_rate_rec
r_static
r_int
id|compute_rate_rec
c_func
(paren
id|u32
id|rate
)paren
(brace
r_int
id|delta
suffix:semicolon
r_if
c_cond
(paren
id|rate
op_eq
l_int|44100
)paren
id|delta
op_assign
l_int|0x116a
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|8000
)paren
id|delta
op_assign
l_int|0x6000
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|48000
)paren
id|delta
op_assign
l_int|0x1000
suffix:semicolon
r_else
id|delta
op_assign
(paren
(paren
l_int|48000
op_lshift
l_int|12
)paren
op_div
id|rate
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
r_return
id|delta
suffix:semicolon
)brace
multiline_comment|/* set playback sample rate */
DECL|function|trident_set_dac_rate
r_static
r_int
r_int
id|trident_set_dac_rate
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
r_int
id|rate
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|dmabuf-&gt;rate
op_assign
id|rate
suffix:semicolon
id|dmabuf-&gt;channel-&gt;delta
op_assign
id|compute_rate_play
c_func
(paren
id|rate
)paren
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|state
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: called trident_set_dac_rate : rate = %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rate
suffix:semicolon
)brace
multiline_comment|/* set recording sample rate */
DECL|function|trident_set_adc_rate
r_static
r_int
r_int
id|trident_set_adc_rate
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
r_int
id|rate
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|dmabuf-&gt;rate
op_assign
id|rate
suffix:semicolon
id|dmabuf-&gt;channel-&gt;delta
op_assign
id|compute_rate_rec
c_func
(paren
id|rate
)paren
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|state
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: called trident_set_adc_rate : rate = %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rate
suffix:semicolon
)brace
multiline_comment|/* prepare channel attributes for playback */
DECL|function|trident_play_setup
r_static
r_void
id|trident_play_setup
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
op_assign
id|dmabuf-&gt;channel
suffix:semicolon
id|channel-&gt;lba
op_assign
id|virt_to_bus
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
suffix:semicolon
id|channel-&gt;delta
op_assign
id|compute_rate_play
c_func
(paren
id|dmabuf-&gt;rate
)paren
suffix:semicolon
id|channel-&gt;eso
op_assign
id|dmabuf-&gt;dmasize
op_rshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|channel-&gt;eso
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_ne
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
id|channel-&gt;attribute
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
r_if
c_cond
(paren
(paren
id|channel-&gt;num
op_eq
id|ALI_SPDIF_IN_CHANNEL
)paren
op_logical_or
(paren
id|channel-&gt;num
op_eq
id|ALI_PCM_IN_CHANNEL
)paren
)paren
id|ali_disable_special_channel
c_func
(paren
id|state-&gt;card
comma
id|channel-&gt;num
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
op_amp
id|ALI_SPDIF_OUT_CH_ENABLE
)paren
op_logical_and
(paren
id|channel-&gt;num
op_eq
id|ALI_SPDIF_OUT_CHANNEL
)paren
)paren
(brace
id|ali_set_spdif_out_rate
c_func
(paren
id|state-&gt;card
comma
id|state-&gt;dmabuf.rate
)paren
suffix:semicolon
id|state-&gt;dmabuf.channel-&gt;delta
op_assign
l_int|0x1000
suffix:semicolon
)brace
)brace
)brace
id|channel-&gt;fm_vol
op_assign
l_int|0x0
suffix:semicolon
id|channel-&gt;control
op_assign
id|CHANNEL_LOOP
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
(brace
multiline_comment|/* 16-bits */
id|channel-&gt;control
op_or_assign
id|CHANNEL_16BITS
suffix:semicolon
multiline_comment|/* signed */
id|channel-&gt;control
op_or_assign
id|CHANNEL_SIGNED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
multiline_comment|/* stereo */
id|channel-&gt;control
op_or_assign
id|CHANNEL_STEREO
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_play_setup, LBA = 0x%08x, &quot;
l_string|&quot;Delat = 0x%08x, ESO = 0x%08x, Control = 0x%08x&bslash;n&quot;
comma
id|channel-&gt;lba
comma
id|channel-&gt;delta
comma
id|channel-&gt;eso
comma
id|channel-&gt;control
)paren
suffix:semicolon
macro_line|#endif
id|trident_write_voice_regs
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
multiline_comment|/* prepare channel attributes for recording */
DECL|function|trident_rec_setup
r_static
r_void
id|trident_rec_setup
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
id|u16
id|w
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
op_assign
id|dmabuf-&gt;channel
suffix:semicolon
r_int
r_int
id|rate
suffix:semicolon
multiline_comment|/* Enable AC-97 ADC (capture) */
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
id|ali_enable_special_channel
c_func
(paren
id|state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
multiline_comment|/* for 7018, the ac97 is always in playback/record (duplex) mode */
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|w
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|w
op_or
l_int|0x48
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
multiline_comment|/* enable and set record channel */
id|outb
c_func
(paren
l_int|0x80
op_or
id|channel-&gt;num
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_REC_CH
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|w
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|w
op_or
l_int|0x1000
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
multiline_comment|/* enable and set record channel */
id|outb
c_func
(paren
l_int|0x80
op_or
id|channel-&gt;num
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_REC_CH
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
id|channel-&gt;lba
op_assign
id|virt_to_bus
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
suffix:semicolon
id|channel-&gt;delta
op_assign
id|compute_rate_rec
c_func
(paren
id|dmabuf-&gt;rate
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
op_logical_and
(paren
id|channel-&gt;num
op_eq
id|ALI_SPDIF_IN_CHANNEL
)paren
)paren
(brace
id|rate
op_assign
id|ali_get_spdif_in_rate
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rate
op_ne
l_int|48000
)paren
id|channel-&gt;delta
op_assign
(paren
(paren
id|rate
op_lshift
l_int|12
)paren
op_div
id|dmabuf-&gt;rate
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
)brace
id|channel-&gt;eso
op_assign
id|dmabuf-&gt;dmasize
op_rshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|channel-&gt;eso
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_ne
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
id|channel-&gt;attribute
op_assign
l_int|0
suffix:semicolon
)brace
id|channel-&gt;fm_vol
op_assign
l_int|0x0
suffix:semicolon
id|channel-&gt;control
op_assign
id|CHANNEL_LOOP
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
(brace
multiline_comment|/* 16-bits */
id|channel-&gt;control
op_or_assign
id|CHANNEL_16BITS
suffix:semicolon
multiline_comment|/* signed */
id|channel-&gt;control
op_or_assign
id|CHANNEL_SIGNED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
multiline_comment|/* stereo */
id|channel-&gt;control
op_or_assign
id|CHANNEL_STEREO
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_rec_setup, LBA = 0x%08x, &quot;
l_string|&quot;Delat = 0x%08x, ESO = 0x%08x, Control = 0x%08x&bslash;n&quot;
comma
id|channel-&gt;lba
comma
id|channel-&gt;delta
comma
id|channel-&gt;eso
comma
id|channel-&gt;control
)paren
suffix:semicolon
macro_line|#endif
id|trident_write_voice_regs
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
multiline_comment|/* get current playback/recording dma buffer pointer (byte offset from LBA),&n;   called with spinlock held! */
DECL|function|trident_get_dma_addr
r_extern
id|__inline__
r_int
id|trident_get_dma_addr
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|u32
id|cso
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;enable
)paren
r_return
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|dmabuf-&gt;channel-&gt;num
comma
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|state-&gt;card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
multiline_comment|/* 16 bits ESO, CSO for 7018 and DX */
id|cso
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|CH_DX_CSO_ALPHA_FMS
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
multiline_comment|/* 24 bits ESO, CSO for NX */
id|cso
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|CH_NX_DELTA_CSO
)paren
)paren
op_amp
l_int|0x00ffffff
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_get_dma_addr: chip reported channel: %d, &quot;
l_string|&quot;cso = 0x%04x&bslash;n&quot;
comma
id|dmabuf-&gt;channel-&gt;num
comma
id|cso
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* ESO and CSO are in units of Samples, convert to byte offset */
id|cso
op_lshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
r_return
(paren
id|cso
op_mod
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop recording (lock held) */
DECL|function|__stop_adc
r_extern
id|__inline__
r_void
id|__stop_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
id|dmabuf-&gt;enable
op_and_assign
op_complement
id|ADC_RUNNING
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
DECL|function|stop_adc
r_static
r_void
id|stop_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|start_adc
r_static
r_void
id|start_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabuf-&gt;mapped
op_logical_or
id|dmabuf-&gt;count
OL
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
)paren
op_logical_and
id|dmabuf-&gt;ready
)paren
(brace
id|dmabuf-&gt;enable
op_or_assign
id|ADC_RUNNING
suffix:semicolon
id|trident_enable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* stop playback (lock held) */
DECL|function|__stop_dac
r_extern
id|__inline__
r_void
id|__stop_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
id|dmabuf-&gt;enable
op_and_assign
op_complement
id|DAC_RUNNING
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|trident_stop_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
)brace
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
DECL|function|stop_dac
r_static
r_void
id|stop_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|start_dac
r_static
r_void
id|start_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabuf-&gt;mapped
op_logical_or
id|dmabuf-&gt;count
OG
l_int|0
)paren
op_logical_and
id|dmabuf-&gt;ready
)paren
(brace
id|dmabuf-&gt;enable
op_or_assign
id|DAC_RUNNING
suffix:semicolon
id|trident_enable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|trident_start_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|macro|DMABUF_DEFAULTORDER
mdefine_line|#define DMABUF_DEFAULTORDER (15-PAGE_SHIFT)
DECL|macro|DMABUF_MINORDER
mdefine_line|#define DMABUF_MINORDER 1
multiline_comment|/* allocate DMA buffer, playback and recording buffer should be allocated seperately */
DECL|function|alloc_dmabuf
r_static
r_int
id|alloc_dmabuf
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_void
op_star
id|rawbuf
suffix:semicolon
r_int
id|order
suffix:semicolon
r_struct
id|page
op_star
id|page
comma
op_star
id|pend
suffix:semicolon
multiline_comment|/* alloc as big a chunk as we can, FIXME: is this necessary ?? */
r_for
c_loop
(paren
id|order
op_assign
id|DMABUF_DEFAULTORDER
suffix:semicolon
id|order
op_ge
id|DMABUF_MINORDER
suffix:semicolon
id|order
op_decrement
)paren
r_if
c_cond
(paren
(paren
id|rawbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|state-&gt;card-&gt;pci_dev
comma
id|PAGE_SIZE
op_lshift
id|order
comma
op_amp
id|dmabuf-&gt;dma_handle
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rawbuf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: allocated %ld (order = %d) bytes at %p&bslash;n&quot;
comma
id|PAGE_SIZE
op_lshift
id|order
comma
id|order
comma
id|rawbuf
)paren
suffix:semicolon
macro_line|#endif
id|dmabuf-&gt;ready
op_assign
id|dmabuf-&gt;mapped
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;rawbuf
op_assign
id|rawbuf
suffix:semicolon
id|dmabuf-&gt;buforder
op_assign
id|order
suffix:semicolon
multiline_comment|/* now mark the pages as reserved; otherwise remap_page_range doesn&squot;t do what we want */
id|pend
op_assign
id|virt_to_page
c_func
(paren
id|rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|page
op_assign
id|virt_to_page
c_func
(paren
id|rawbuf
)paren
suffix:semicolon
id|page
op_le
id|pend
suffix:semicolon
id|page
op_increment
)paren
id|mem_map_reserve
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* free DMA buffer */
DECL|function|dealloc_dmabuf
r_static
r_void
id|dealloc_dmabuf
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_struct
id|page
op_star
id|page
comma
op_star
id|pend
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;rawbuf
)paren
(brace
multiline_comment|/* undo marking the pages as reserved */
id|pend
op_assign
id|virt_to_page
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|page
op_assign
id|virt_to_page
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
suffix:semicolon
id|page
op_le
id|pend
suffix:semicolon
id|page
op_increment
)paren
id|mem_map_unreserve
c_func
(paren
id|page
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|state-&gt;card-&gt;pci_dev
comma
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
comma
id|dmabuf-&gt;rawbuf
comma
id|dmabuf-&gt;dma_handle
)paren
suffix:semicolon
)brace
id|dmabuf-&gt;rawbuf
op_assign
l_int|NULL
suffix:semicolon
id|dmabuf-&gt;mapped
op_assign
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|prog_dmabuf
r_static
r_int
id|prog_dmabuf
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|rec
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|bytepersec
suffix:semicolon
r_struct
id|trident_state
op_star
id|s
op_assign
id|state
suffix:semicolon
r_int
id|bufsize
comma
id|dma_nums
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
comma
id|i
comma
id|order
suffix:semicolon
r_struct
id|page
op_star
id|page
comma
op_star
id|pend
suffix:semicolon
id|lock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
id|dma_nums
op_assign
l_int|5
suffix:semicolon
r_else
id|dma_nums
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma_nums
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
(brace
id|s
op_assign
id|state-&gt;other_states
(braket
id|i
op_minus
l_int|1
)braket
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|s-&gt;dmabuf
suffix:semicolon
id|dmabuf-&gt;fmt
op_assign
id|state-&gt;dmabuf.fmt
suffix:semicolon
id|dmabuf-&gt;rate
op_assign
id|state-&gt;dmabuf.rate
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;hwptr
op_assign
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;total_bytes
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;error
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* allocate DMA buffer if not allocated yet */
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;rawbuf
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|alloc_dmabuf
c_func
(paren
id|state
)paren
)paren
)paren
(brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|order
op_assign
id|state-&gt;dmabuf.buforder
op_minus
l_int|1
)paren
op_ge
id|DMABUF_MINORDER
)paren
id|dmabuf-&gt;rawbuf
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;rawbuf
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|state-&gt;dmabuf.rawbuf
comma
id|state-&gt;dmabuf.buforder
)paren
suffix:semicolon
id|state-&gt;dmabuf.rawbuf
op_assign
l_int|NULL
suffix:semicolon
id|i
op_sub_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|state-&gt;other_states
(braket
id|i
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
comma
id|state-&gt;other_states
(braket
id|i
)braket
op_member_access_from_pointer
id|dmabuf.buforder
)paren
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dmabuf-&gt;ready
op_assign
id|dmabuf-&gt;mapped
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;buforder
op_assign
id|order
suffix:semicolon
id|pend
op_assign
id|virt_to_page
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|page
op_assign
id|virt_to_page
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
suffix:semicolon
id|page
op_le
id|pend
suffix:semicolon
id|page
op_increment
)paren
id|mem_map_reserve
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* FIXME: figure out all this OSS fragment stuff */
id|bytepersec
op_assign
id|dmabuf-&gt;rate
op_lshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|bufsize
op_assign
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossfragshift
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1000
op_lshift
id|dmabuf-&gt;ossfragshift
)paren
OL
id|bytepersec
)paren
id|dmabuf-&gt;fragshift
op_assign
id|ld2
c_func
(paren
id|bytepersec
op_div
l_int|1000
)paren
suffix:semicolon
r_else
id|dmabuf-&gt;fragshift
op_assign
id|dmabuf-&gt;ossfragshift
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* lets hand out reasonable big ass buffers by default */
id|dmabuf-&gt;fragshift
op_assign
(paren
id|dmabuf-&gt;buforder
op_plus
id|PAGE_SHIFT
op_minus
l_int|2
)paren
suffix:semicolon
)brace
id|dmabuf-&gt;numfrag
op_assign
id|bufsize
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
r_while
c_loop
(paren
id|dmabuf-&gt;numfrag
template_param
l_int|3
)paren
(brace
id|dmabuf-&gt;fragshift
op_decrement
suffix:semicolon
id|dmabuf-&gt;numfrag
op_assign
id|bufsize
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
)brace
id|dmabuf-&gt;fragsize
op_assign
l_int|1
op_lshift
id|dmabuf-&gt;fragshift
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossmaxfrags
op_ge
l_int|4
op_logical_and
id|dmabuf-&gt;ossmaxfrags
OL
id|dmabuf-&gt;numfrag
)paren
id|dmabuf-&gt;numfrag
op_assign
id|dmabuf-&gt;ossmaxfrags
suffix:semicolon
id|dmabuf-&gt;fragsamples
op_assign
id|dmabuf-&gt;fragsize
op_rshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|dmabuf-&gt;dmasize
op_assign
id|dmabuf-&gt;numfrag
op_lshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|memset
c_func
(paren
id|dmabuf-&gt;rawbuf
comma
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
comma
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
(brace
id|trident_rec_setup
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
(brace
id|trident_play_setup
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* set the ready flag for the dma buffer */
id|dmabuf-&gt;ready
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: prog_dmabuf(%d), sample rate = %d, format = %d, numfrag = %d, &quot;
l_string|&quot;fragsize = %d dmasize = %d&bslash;n&quot;
comma
id|dmabuf-&gt;channel-&gt;num
comma
id|dmabuf-&gt;rate
comma
id|dmabuf-&gt;fmt
comma
id|dmabuf-&gt;numfrag
comma
id|dmabuf-&gt;fragsize
comma
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
macro_line|#endif
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* we are doing quantum mechanics here, the buffer can only be empty, half or full filled i.e.&n;   |------------|------------|   or   |xxxxxxxxxxxx|------------|   or   |xxxxxxxxxxxx|xxxxxxxxxxxx|&n;   but we almost always get this&n;   |xxxxxx------|------------|   or   |xxxxxxxxxxxx|xxxxx-------|&n;   so we have to clear the tail space to &quot;silence&quot;&n;   |xxxxxx000000|------------|   or   |xxxxxxxxxxxx|xxxxxx000000|&n;*/
DECL|function|trident_clear_tail
r_static
r_void
id|trident_clear_tail
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
r_char
id|silence
op_assign
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|swptr
op_eq
l_int|0
op_logical_or
id|swptr
op_eq
id|dmabuf-&gt;dmasize
op_div
l_int|2
op_logical_or
id|swptr
op_eq
id|dmabuf-&gt;dmasize
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|swptr
OL
id|dmabuf-&gt;dmasize
op_div
l_int|2
)paren
id|len
op_assign
id|dmabuf-&gt;dmasize
op_div
l_int|2
op_minus
id|swptr
suffix:semicolon
r_else
id|len
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
id|memset
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|len
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_add_assign
id|len
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|len
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* restart the dma machine in case it is halted */
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
DECL|function|drain_dac
r_static
r_int
id|drain_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|nonblock
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|tmo
suffix:semicolon
r_int
id|count
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
op_logical_or
op_logical_neg
id|dmabuf-&gt;ready
)paren
r_return
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* It seems that we have to set the current state to TASK_INTERRUPTIBLE&n;&t;&t;   every time to make the process really go to sleep */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* No matter how much data left in the buffer, we have to wait untill&n;&t;&t;   CSO == ESO/2 or CSO == ESO when address engine interrupts */
id|tmo
op_assign
(paren
id|dmabuf-&gt;dmasize
op_star
id|HZ
)paren
op_div
id|dmabuf-&gt;rate
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schedule_timeout
c_func
(paren
id|tmo
ques
c_cond
id|tmo
suffix:colon
l_int|1
)paren
op_logical_and
id|tmo
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: drain_dac, dma timeout?&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* update buffer manangement pointers, especially, dmabuf-&gt;count and dmabuf-&gt;hwptr */
DECL|function|trident_update_ptr
r_static
r_void
id|trident_update_ptr
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|hwptr
comma
id|swptr
suffix:semicolon
r_int
id|clear_cnt
op_assign
l_int|0
suffix:semicolon
r_int
id|diff
suffix:semicolon
r_int
r_char
id|silence
suffix:semicolon
r_int
id|half_dmasize
suffix:semicolon
multiline_comment|/* update hardware pointer */
id|hwptr
op_assign
id|trident_get_dma_addr
c_func
(paren
id|state
)paren
suffix:semicolon
id|diff
op_assign
(paren
id|dmabuf-&gt;dmasize
op_plus
id|hwptr
op_minus
id|dmabuf-&gt;hwptr
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|dmabuf-&gt;hwptr
op_assign
id|hwptr
suffix:semicolon
id|dmabuf-&gt;total_bytes
op_add_assign
id|diff
suffix:semicolon
multiline_comment|/* error handling and process wake up for ADC */
r_if
c_cond
(paren
id|dmabuf-&gt;enable
op_eq
id|ADC_RUNNING
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
id|dmabuf-&gt;count
op_sub_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|dmabuf-&gt;count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
template_param
id|dmabuf-&gt;dmasize
)paren
(brace
multiline_comment|/* buffer underrun or buffer overrun, we have no way to recover&n;&t;&t;&t;&t;   it here, just stop the machine and let the process force hwptr&n;&t;&t;&t;&t;   and swptr to sync */
id|__stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;error
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
op_div
l_int|2
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* error handling and process wake up for DAC */
r_if
c_cond
(paren
id|dmabuf-&gt;enable
op_eq
id|DAC_RUNNING
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
id|dmabuf-&gt;count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|dmabuf-&gt;count
op_sub_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
template_param
id|dmabuf-&gt;dmasize
)paren
(brace
multiline_comment|/* buffer underrun or buffer overrun, we have no way to recover&n;&t;&t;&t;&t;   it here, just stop the machine and let the process force hwptr&n;&t;&t;&t;&t;   and swptr to sync */
id|__stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;error
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;endcleared
)paren
(brace
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|silence
op_assign
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;update_flag
op_amp
id|ALI_ADDRESS_INT_UPDATE
)paren
(brace
multiline_comment|/* We must clear end data of 1/2 dmabuf if needed.&n;&t;&t;&t;&t;&t;   According to 1/2 algorithm of Address Engine Interrupt,&n;&t;&t;&t;&t;&t;   check the validation of the data of half dmasize. */
id|half_dmasize
op_assign
id|dmabuf-&gt;dmasize
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|diff
op_assign
id|hwptr
op_minus
id|half_dmasize
)paren
OL
l_int|0
)paren
id|diff
op_assign
id|hwptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabuf-&gt;count
op_plus
id|diff
)paren
OL
id|half_dmasize
)paren
(brace
singleline_comment|//there is invalid data in the end of half buffer
r_if
c_cond
(paren
(paren
id|clear_cnt
op_assign
id|half_dmasize
op_minus
id|swptr
)paren
OL
l_int|0
)paren
id|clear_cnt
op_add_assign
id|half_dmasize
suffix:semicolon
singleline_comment|//clear the invalid data
id|memset
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|clear_cnt
op_assign
id|clear_cnt
op_div
l_int|2
suffix:semicolon
id|swptr
op_assign
id|swptr
op_div
l_int|2
suffix:semicolon
id|memset
(paren
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
(paren
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
(paren
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
(paren
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
)brace
id|dmabuf-&gt;endcleared
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
(brace
id|clear_cnt
op_assign
id|dmabuf-&gt;fragsize
suffix:semicolon
r_if
c_cond
(paren
(paren
id|swptr
op_plus
id|clear_cnt
)paren
OG
id|dmabuf-&gt;dmasize
)paren
id|clear_cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
id|memset
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|clear_cnt
op_assign
id|clear_cnt
op_div
l_int|2
suffix:semicolon
id|swptr
op_assign
id|swptr
op_div
l_int|2
suffix:semicolon
id|memset
(paren
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
(paren
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
(paren
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
(paren
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
)brace
id|dmabuf-&gt;endcleared
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* trident_update_ptr is called by interrupt handler or by process via&n;&t;&t;&t;   ioctl/poll, we only wake up the waiting process when we have more&n;&t;&t;&t;   than 1/2 buffer free (always true for interrupt handler) */
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
op_div
l_int|2
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
)brace
id|dmabuf-&gt;update_flag
op_and_assign
op_complement
id|ALI_ADDRESS_INT_UPDATE
suffix:semicolon
)brace
DECL|function|trident_address_interrupt
r_static
r_void
id|trident_address_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|trident_state
op_star
id|state
suffix:semicolon
multiline_comment|/* Update the pointers for all channels we are running. */
multiline_comment|/* FIXME: should read interrupt status only once */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|trident_check_channel_interrupt
c_func
(paren
id|card
comma
l_int|63
op_minus
id|i
)paren
)paren
(brace
id|trident_ack_channel_interrupt
c_func
(paren
id|card
comma
l_int|63
op_minus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state
op_assign
id|card-&gt;states
(braket
id|i
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;trident: spurious channel irq %d.&bslash;n&quot;
comma
l_int|63
op_minus
id|i
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
l_int|63
op_minus
id|i
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
l_int|63
op_minus
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|trident_interrupt
r_static
r_void
id|trident_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|dev_id
suffix:semicolon
id|u32
id|event
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|event
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_interrupt called, MISCINT = 0x%08x&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|event
op_amp
id|ADDRESS_IRQ
)paren
(brace
id|card
op_member_access_from_pointer
id|address_interrupt
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* manually clear interrupt status, bad hardware design, blame T^2 */
id|outl
c_func
(paren
(paren
id|ST_TARGET_REACHED
op_or
id|MIXER_OVERFLOW
op_or
id|MIXER_UNDERFLOW
)paren
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|trident_llseek
r_static
id|loff_t
id|trident_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
multiline_comment|/* in this loop, dmabuf.count signifies the amount of data that is waiting to be copied to&n;   the user&squot;s buffer.  it is filled by the dma machine and drained by this loop. */
DECL|function|trident_read
r_static
id|ssize_t
id|trident_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_read called, count = %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
OG
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
)paren
(brace
multiline_comment|/* buffer overrun, we are recovering from sleep_on_timeout,&n;&t;&t;&t;   resync hwptr and swptr, make process flush the buffer */
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;dmasize
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;hwptr
suffix:semicolon
)brace
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
id|cnt
)paren
id|cnt
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
r_int
r_int
id|tmo
suffix:semicolon
multiline_comment|/* buffer is empty, start the dma machine and wait for data to be&n;&t;&t;&t;   recorded */
id|start_adc
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* No matter how much space left in the buffer, we have to wait untill&n;&t;&t;&t;   CSO == ESO/2 or CSO == ESO when address engine interrupts */
id|tmo
op_assign
(paren
id|dmabuf-&gt;dmasize
op_star
id|HZ
)paren
op_div
(paren
id|dmabuf-&gt;rate
op_star
l_int|2
)paren
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
multiline_comment|/* There are two situations when sleep_on_timeout returns, one is when&n;&t;&t;&t;   the interrupt is serviced correctly and the process is waked up by&n;&t;&t;&t;   ISR ON TIME. Another is when timeout is expired, which means that&n;&t;&t;&t;   either interrupt is NOT serviced correctly (pending interrupt) or it&n;&t;&t;&t;   is TOO LATE for the process to be scheduled to run (scheduler latency)&n;&t;&t;&t;   which results in a (potential) buffer overrun. And worse, there is&n;&t;&t;&t;   NOTHING we can do to prevent it. */
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
id|tmo
)paren
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: recording schedule timeout, &quot;
l_string|&quot;dmasz %u fragsz %u count %i hwptr %u swptr %u&bslash;n&quot;
comma
id|dmabuf-&gt;dmasize
comma
id|dmabuf-&gt;fragsize
comma
id|dmabuf-&gt;count
comma
id|dmabuf-&gt;hwptr
comma
id|dmabuf-&gt;swptr
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* a buffer overrun, we delay the recovery untill next time the&n;&t;&t;&t;&t;   while loop begin and we REALLY have space to record */
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|swptr
suffix:semicolon
id|dmabuf-&gt;count
op_sub_assign
id|cnt
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_adc
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* in this loop, dmabuf.count signifies the amount of data that is waiting to be dma to&n;   the soundcard.  it is drained by the dma machine and filled by this loop. */
DECL|function|trident_write
r_static
id|ssize_t
id|trident_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
r_int
id|state_cnt
suffix:semicolon
r_int
r_int
id|copy_count
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_write called, count = %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
l_int|0
)paren
(brace
multiline_comment|/* buffer underrun, we are recovering from sleep_on_timeout,&n;&t;&t;&t;   resync hwptr and swptr */
id|dmabuf-&gt;count
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;hwptr
suffix:semicolon
)brace
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_plus
id|cnt
OG
id|dmabuf-&gt;dmasize
)paren
id|cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
r_int
r_int
id|tmo
suffix:semicolon
multiline_comment|/* buffer is full, start the dma machine and wait for data to be&n;&t;&t;&t;   played */
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* No matter how much data left in the buffer, we have to wait untill&n;&t;&t;&t;   CSO == ESO/2 or CSO == ESO when address engine interrupts */
id|lock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
id|tmo
op_assign
(paren
id|dmabuf-&gt;dmasize
op_star
id|HZ
)paren
op_div
(paren
id|dmabuf-&gt;rate
op_star
l_int|2
)paren
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
multiline_comment|/* There are two situations when sleep_on_timeout returns, one is when&n;&t;&t;&t;   the interrupt is serviced correctly and the process is waked up by&n;&t;&t;&t;   ISR ON TIME. Another is when timeout is expired, which means that&n;&t;&t;&t;   either interrupt is NOT serviced correctly (pending interrupt) or it&n;&t;&t;&t;   is TOO LATE for the process to be scheduled to run (scheduler latency)&n;&t;&t;&t;   which results in a (potential) buffer underrun. And worse, there is&n;&t;&t;&t;   NOTHING we can do to prevent it. */
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
id|tmo
)paren
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: playback schedule timeout, &quot;
l_string|&quot;dmasz %u fragsz %u count %i hwptr %u swptr %u&bslash;n&quot;
comma
id|dmabuf-&gt;dmasize
comma
id|dmabuf-&gt;fragsize
comma
id|dmabuf-&gt;count
comma
id|dmabuf-&gt;hwptr
comma
id|dmabuf-&gt;swptr
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* a buffer underrun, we delay the recovery untill next time the&n;&t;&t;&t;&t;   while loop begin and we REALLY have data to play */
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
id|lock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|copy_count
op_assign
l_int|0
suffix:semicolon
id|state_cnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ali_write_5_1
c_func
(paren
id|state
comma
id|buffer
comma
id|cnt
comma
op_amp
id|copy_count
comma
op_amp
id|state_cnt
)paren
op_eq
op_minus
id|EFAULT
)paren
(brace
r_if
c_cond
(paren
id|state_cnt
)paren
(brace
id|swptr
op_assign
(paren
id|swptr
op_plus
id|state_cnt
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|swptr
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|state_cnt
suffix:semicolon
id|dmabuf-&gt;endcleared
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|ret
op_add_assign
id|copy_count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|state_cnt
op_assign
id|cnt
suffix:semicolon
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
id|swptr
op_assign
(paren
id|swptr
op_plus
id|state_cnt
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|swptr
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|state_cnt
suffix:semicolon
id|dmabuf-&gt;endcleared
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* No kernel lock - we have our own spinlock */
DECL|function|trident_poll
r_static
r_int
r_int
id|trident_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dmabuf-&gt;wait
comma
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dmabuf-&gt;wait
comma
id|wait
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
op_ge
id|dmabuf-&gt;count
op_plus
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|trident_mmap
r_static
r_int
id|trident_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
r_goto
id|out
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_pgoff
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma-&gt;vm_start
comma
id|virt_to_phys
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_goto
id|out
suffix:semicolon
id|dmabuf-&gt;mapped
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|trident_ioctl
r_static
r_int
id|trident_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|audio_buf_info
id|abinfo
suffix:semicolon
id|count_info
id|cinfo
suffix:semicolon
r_int
id|val
comma
id|mapped
comma
id|ret
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
id|mapped
op_assign
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
id|dmabuf-&gt;mapped
)paren
op_logical_or
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
op_logical_and
id|dmabuf-&gt;mapped
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;trident: trident_ioctl, command = %2d, arg = 0x%08x&bslash;n&quot;
comma
id|_IOC_NR
c_func
(paren
id|cmd
)paren
comma
id|arg
ques
c_cond
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:colon
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
multiline_comment|/* FIXME: spin_lock ? */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;hwptr
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;hwptr
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|drain_dac
c_func
(paren
id|state
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
multiline_comment|/* set smaple rate */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_set_dac_rate
c_func
(paren
id|state
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_set_adc_rate
c_func
(paren
id|state
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
id|put_user
c_func
(paren
id|dmabuf-&gt;rate
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
multiline_comment|/* set stereo or mono channel */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|lock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|dmabuf-&gt;fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|dmabuf-&gt;fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask of supported sample format*/
r_return
id|put_user
c_func
(paren
id|AFMT_S16_LE
op_or
id|AFMT_U16_LE
op_or
id|AFMT_S8
op_or
id|AFMT_U8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Select sample format */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|lock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_16BIT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_16BIT
suffix:semicolon
)brace
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_U8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
id|lock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
singleline_comment|//prevent from memory leak
r_if
c_cond
(paren
(paren
id|state-&gt;chans_num
OG
l_int|2
)paren
op_logical_and
(paren
id|state-&gt;chans_num
op_ne
id|val
)paren
)paren
(brace
id|ali_free_other_states_resources
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;chans_num
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
(brace
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_eq
l_int|6
)paren
op_logical_and
(paren
id|state-&gt;card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
)paren
(brace
id|ali_setup_multi_channels
c_func
(paren
id|state-&gt;card
comma
l_int|6
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|state-&gt;card-&gt;open_sem
)paren
suffix:semicolon
id|ret
op_assign
id|ali_allocate_other_states_resources
c_func
(paren
id|state
comma
l_int|6
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|state-&gt;card-&gt;open_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_else
id|val
op_assign
l_int|2
suffix:semicolon
multiline_comment|/*yield to 2-channels*/
)brace
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
id|state-&gt;chans_num
op_assign
id|val
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
(paren
id|val
op_eq
l_int|6
)paren
)paren
)paren
id|val
op_assign
l_int|2
suffix:semicolon
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
id|state-&gt;chans_num
op_assign
id|val
suffix:semicolon
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
multiline_comment|/* FIXME: the same as RESET ?? */
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SUBDIVIDE
suffix:colon
r_if
c_cond
(paren
id|dmabuf-&gt;subdivision
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|1
op_logical_and
id|val
op_ne
l_int|2
op_logical_and
id|val
op_ne
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dmabuf-&gt;subdivision
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|dmabuf-&gt;ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|dmabuf-&gt;ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossfragshift
OL
l_int|4
)paren
id|dmabuf-&gt;ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossfragshift
OG
l_int|15
)paren
id|dmabuf-&gt;ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossmaxfrags
OL
l_int|4
)paren
id|dmabuf-&gt;ossmaxfrags
op_assign
l_int|4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|dmabuf-&gt;fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|dmabuf-&gt;count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|dmabuf-&gt;numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|dmabuf-&gt;fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|dmabuf-&gt;numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
id|put_user
c_func
(paren
id|DSP_CAP_REALTIME
op_or
id|DSP_CAP_TRIGGER
op_or
id|DSP_CAP_MMAP
op_or
id|DSP_CAP_BIND
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETTRIGGER
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|dmabuf-&gt;enable
)paren
id|val
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|dmabuf-&gt;enable
)paren
id|val
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_INPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_adc
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_OUTPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|dmabuf-&gt;total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|dmabuf-&gt;count
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|dmabuf-&gt;hwptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
id|dmabuf-&gt;count
op_and_assign
id|dmabuf-&gt;fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|dmabuf-&gt;total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|dmabuf-&gt;count
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|dmabuf-&gt;hwptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
id|dmabuf-&gt;count
op_and_assign
id|dmabuf-&gt;fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|state
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|val
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_return
id|put_user
c_func
(paren
id|dmabuf-&gt;rate
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_U8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCHANNELMASK
suffix:colon
r_return
id|put_user
c_func
(paren
id|DSP_BIND_FRONT
op_or
id|DSP_BIND_SURR
op_or
id|DSP_BIND_CENTER_LFE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_BIND_CHANNEL
suffix:colon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_ne
id|PCI_DEVICE_ID_SI_7018
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|DSP_BIND_QUERY
)paren
(brace
id|val
op_assign
id|dmabuf-&gt;channel-&gt;attribute
op_or
l_int|0x3c00
suffix:semicolon
id|val
op_assign
id|attr2mask
(braket
id|val
op_rshift
l_int|8
)braket
suffix:semicolon
)brace
r_else
(brace
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|dmabuf-&gt;channel-&gt;attribute
op_assign
(paren
id|CHANNEL_REC
op_or
id|SRC_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|dmabuf-&gt;channel-&gt;attribute
op_assign
(paren
id|CHANNEL_SPC_PB
op_or
id|SRC_ENABLE
)paren
suffix:semicolon
id|dmabuf-&gt;channel-&gt;attribute
op_or_assign
id|mask2attr
(braket
id|ffs
c_func
(paren
id|val
)paren
)braket
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_MAPINBUF
suffix:colon
r_case
id|SNDCTL_DSP_MAPOUTBUF
suffix:colon
r_case
id|SNDCTL_DSP_SETSYNCRO
suffix:colon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|trident_open
r_static
r_int
id|trident_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|devs
suffix:semicolon
r_struct
id|trident_state
op_star
id|state
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* find an avaiable virtual channel (instance of /dev/dsp) */
r_while
c_loop
(paren
id|card
op_ne
l_int|NULL
)paren
(brace
id|down
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;states
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|state
op_assign
id|card-&gt;states
(braket
id|i
)braket
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|trident_state
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|state
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|trident_state
)paren
)paren
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_goto
id|found_virt
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
id|card
op_assign
id|card-&gt;next
suffix:semicolon
)brace
multiline_comment|/* no more virtual channel avaiable */
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|found_virt
suffix:colon
multiline_comment|/* found a free virtual channel, allocate hardware channels */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|dmabuf-&gt;channel
op_assign
id|card
op_member_access_from_pointer
id|alloc_rec_pcm_channel
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_else
id|dmabuf-&gt;channel
op_assign
id|card
op_member_access_from_pointer
id|alloc_pcm_channel
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;channel
op_eq
l_int|NULL
)paren
(brace
id|kfree
(paren
id|card-&gt;states
(braket
id|i
)braket
)paren
suffix:semicolon
id|card-&gt;states
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* initialize the virtual channel */
id|state-&gt;virt
op_assign
id|i
suffix:semicolon
id|state-&gt;card
op_assign
id|card
suffix:semicolon
id|state-&gt;magic
op_assign
id|TRIDENT_STATE_MAGIC
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|state
suffix:semicolon
multiline_comment|/* set default sample format. According to OSS Programmer&squot;s Guide  /dev/dsp&n;&t;   should be default to unsigned 8-bits, mono, with sample rate 8kHz and&n;&t;   /dev/dspW will accept 16-bits sample */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0x0f
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
id|dmabuf-&gt;ossfragshift
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;ossmaxfrags
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;subdivision
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
multiline_comment|/* set default channel attribute to normal playback */
id|dmabuf-&gt;channel-&gt;attribute
op_assign
id|CHANNEL_PB
suffix:semicolon
)brace
id|trident_set_dac_rate
c_func
(paren
id|state
comma
l_int|8000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
multiline_comment|/* FIXME: Trident 4d can only record in signed 16-bits stereo, 48kHz sample,&n;&t;&t;   to be dealed with in trident_set_adc_rate() ?? */
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0x0f
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
id|dmabuf-&gt;ossfragshift
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;ossmaxfrags
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;subdivision
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
multiline_comment|/* set default channel attribute to 0x8a80, record from&n;&t;&t;&t;   PCM L/R FIFO and mono = (left + right + 1)/2*/
id|dmabuf-&gt;channel-&gt;attribute
op_assign
(paren
id|CHANNEL_REC
op_or
id|PCM_LR
op_or
id|MONO_MIX
)paren
suffix:semicolon
)brace
id|trident_set_adc_rate
c_func
(paren
id|state
comma
l_int|8000
)paren
suffix:semicolon
)brace
id|state-&gt;open_mode
op_or_assign
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: open virtual channel %d, hard channel %d&bslash;n&quot;
comma
id|state-&gt;virt
comma
id|dmabuf-&gt;channel-&gt;num
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_release
r_static
r_int
id|trident_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|card
op_assign
id|state-&gt;card
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|trident_clear_tail
c_func
(paren
id|state
)paren
suffix:semicolon
id|drain_dac
c_func
(paren
id|state
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
)brace
multiline_comment|/* stop DMA state machine and free DMA buffers/channels */
id|down
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|lock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
OG
l_int|2
)paren
id|ali_free_other_states_resources
c_func
(paren
id|state
)paren
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;card
op_member_access_from_pointer
id|free_pcm_channel
c_func
(paren
id|state-&gt;card
comma
id|dmabuf-&gt;channel-&gt;num
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;card
op_member_access_from_pointer
id|free_pcm_channel
c_func
(paren
id|state-&gt;card
comma
id|dmabuf-&gt;channel-&gt;num
)paren
suffix:semicolon
)brace
id|card-&gt;states
(braket
id|state-&gt;virt
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|state
)paren
suffix:semicolon
multiline_comment|/* we&squot;re covered by the open_sem */
id|up
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|trident_audio_fops
r_static
multiline_comment|/*const*/
r_struct
id|file_operations
id|trident_audio_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|llseek
suffix:colon
id|trident_llseek
comma
id|read
suffix:colon
id|trident_read
comma
id|write
suffix:colon
id|trident_write
comma
id|poll
suffix:colon
id|trident_poll
comma
id|ioctl
suffix:colon
id|trident_ioctl
comma
id|mmap
suffix:colon
id|trident_mmap
comma
id|open
suffix:colon
id|trident_open
comma
id|release
suffix:colon
id|trident_release
comma
)brace
suffix:semicolon
multiline_comment|/* trident specific AC97 functions */
multiline_comment|/* Write AC97 codec registers */
DECL|function|trident_ac97_set
r_static
r_void
id|trident_ac97_set
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_int
r_int
id|address
comma
id|mask
comma
id|busy
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|data
op_assign
(paren
(paren
id|u32
)paren
id|val
)paren
op_lshift
l_int|16
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_default
suffix:colon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|address
op_assign
id|SI_AC97_WRITE
suffix:semicolon
id|mask
op_assign
id|SI_AC97_BUSY_WRITE
op_or
id|SI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|SI_AC97_SECONDARY
suffix:semicolon
id|busy
op_assign
id|SI_AC97_BUSY_WRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|address
op_assign
id|DX_ACR0_AC97_W
suffix:semicolon
id|mask
op_assign
id|busy
op_assign
id|DX_AC97_BUSY_WRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|address
op_assign
id|NX_ACR1_AC97_W
suffix:semicolon
id|mask
op_assign
id|NX_AC97_BUSY_WRITE
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|NX_AC97_WRITE_SECONDARY
suffix:semicolon
id|busy
op_assign
id|NX_AC97_BUSY_WRITE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
op_amp
id|busy
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
suffix:semicolon
id|data
op_or_assign
(paren
id|mask
op_or
(paren
id|reg
op_amp
id|AC97_REG_ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: AC97 CODEC write timed out.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Read AC97 codec registers */
DECL|function|trident_ac97_get
r_static
id|u16
id|trident_ac97_get
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_int
r_int
id|address
comma
id|mask
comma
id|busy
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_default
suffix:colon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|address
op_assign
id|SI_AC97_READ
suffix:semicolon
id|mask
op_assign
id|SI_AC97_BUSY_READ
op_or
id|SI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|SI_AC97_SECONDARY
suffix:semicolon
id|busy
op_assign
id|SI_AC97_BUSY_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|address
op_assign
id|DX_ACR1_AC97_R
suffix:semicolon
id|mask
op_assign
id|busy
op_assign
id|DX_AC97_BUSY_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|address
op_assign
id|NX_ACR3_AC97_R_SECONDARY
suffix:semicolon
r_else
id|address
op_assign
id|NX_ACR2_AC97_R_PRIMARY
suffix:semicolon
id|mask
op_assign
id|NX_AC97_BUSY_READ
suffix:semicolon
id|busy
op_assign
id|NX_AC97_BUSY_READ
op_or
id|NX_AC97_BUSY_DATA
suffix:semicolon
r_break
suffix:semicolon
)brace
id|data
op_assign
(paren
id|mask
op_or
(paren
id|reg
op_amp
id|AC97_REG_ADDR
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
r_do
(brace
id|data
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
id|busy
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: AC97 CODEC read timed out.&bslash;n&quot;
)paren
suffix:semicolon
id|data
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
(paren
id|u16
)paren
(paren
id|data
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Write AC97 codec registers for ALi*/
DECL|function|ali_ac97_set
r_static
r_void
id|ali_ac97_set
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_int
r_int
id|address
comma
id|mask
suffix:semicolon
r_int
r_int
id|wCount1
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|wCount2
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|chk1
comma
id|chk2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|data
op_assign
(paren
(paren
id|u32
)paren
id|val
)paren
op_lshift
l_int|16
suffix:semicolon
id|address
op_assign
id|ALI_AC97_WRITE
suffix:semicolon
id|mask
op_assign
id|ALI_AC97_WRITE_ACTION
op_or
id|ALI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|ALI_AC97_SECONDARY
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;revision
op_eq
id|ALI_5451_V02
)paren
id|mask
op_or_assign
id|ALI_AC97_WRITE_MIXER_REGISTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|wCount1
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
op_amp
id|ALI_AC97_BUSY_WRITE
)paren
op_eq
l_int|0
)paren
(brace
id|data
op_or_assign
(paren
id|mask
op_or
(paren
id|reg
op_amp
id|AC97_REG_ADDR
)paren
)paren
suffix:semicolon
id|chk1
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
id|chk2
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|wCount2
op_decrement
op_logical_and
(paren
id|chk1
op_eq
id|chk2
)paren
)paren
id|chk2
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wCount2
op_eq
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
singleline_comment|//write!
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
singleline_comment|//success
)brace
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
singleline_comment|//wait for a read cycle
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali: AC97 CODEC write timed out.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Read AC97 codec registers for ALi*/
DECL|function|ali_ac97_get
r_static
id|u16
id|ali_ac97_get
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_int
r_int
id|address
comma
id|mask
suffix:semicolon
r_int
r_int
id|wCount1
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|wCount2
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|chk1
comma
id|chk2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|address
op_assign
id|ALI_AC97_READ
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;revision
op_eq
id|ALI_5451_V02
)paren
(brace
id|address
op_assign
id|ALI_AC97_WRITE
suffix:semicolon
id|mask
op_and_assign
id|ALI_AC97_READ_MIXER_REGISTER
suffix:semicolon
)brace
id|mask
op_assign
id|ALI_AC97_READ_ACTION
op_or
id|ALI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|ALI_AC97_SECONDARY
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|data
op_assign
(paren
id|mask
op_or
(paren
id|reg
op_amp
id|AC97_REG_ADDR
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|wCount1
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
op_amp
id|ALI_AC97_BUSY_READ
)paren
op_eq
l_int|0
)paren
(brace
id|chk1
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
id|chk2
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|wCount2
op_decrement
op_logical_and
(paren
id|chk1
op_eq
id|chk2
)paren
)paren
id|chk2
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wCount2
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali: AC97 CODEC read timed out.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
singleline_comment|//read!
id|wCount2
op_assign
l_int|0xffff
suffix:semicolon
r_while
c_loop
(paren
id|wCount2
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
op_amp
id|ALI_AC97_BUSY_READ
)paren
op_eq
l_int|0
)paren
(brace
id|data
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
(paren
id|u16
)paren
(paren
id|data
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
singleline_comment|//wait a read cycle
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali: AC97 CODEC read timed out.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ali_enable_special_channel
r_static
r_void
id|ali_enable_special_channel
c_func
(paren
r_struct
id|trident_state
op_star
id|stat
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|stat-&gt;card
suffix:semicolon
r_int
r_int
id|s_channels
suffix:semicolon
id|s_channels
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|s_channels
op_or_assign
(paren
l_int|1
op_lshift
id|stat-&gt;dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|outl
c_func
(paren
id|s_channels
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;flag:&t;ALI_SPDIF_OUT_TO_SPDIF_OUT&n;&t;ALI_PCM_TO_SPDIF_OUT&n;*/
DECL|function|ali_setup_spdif_out
r_static
r_void
id|ali_setup_spdif_out
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|flag
)paren
(brace
r_int
r_int
id|spdif
suffix:semicolon
r_int
r_char
id|ch
suffix:semicolon
id|ch
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ch
op_or
id|ALI_SPDIF_OUT_ENABLE
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|ch
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ch
op_amp
id|ALI_SPDIF_OUT_CH_STATUS
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|ALI_SPDIF_OUT_TO_SPDIF_OUT
)paren
(brace
id|spdif
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_OUT_CH_ENABLE
suffix:semicolon
id|spdif
op_and_assign
id|ALI_SPDIF_OUT_SEL_SPDIF
suffix:semicolon
id|outw
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|ALI_SPDIF_OUT_NON_PCM
)paren
id|spdif
op_or_assign
l_int|0x0002
suffix:semicolon
r_else
id|spdif
op_and_assign
(paren
op_complement
l_int|0x0002
)paren
suffix:semicolon
id|outw
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|spdif
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_OUT_SEL_PCM
suffix:semicolon
id|outw
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|ali_disable_special_channel
r_static
r_void
id|ali_disable_special_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|ch
)paren
(brace
r_int
r_int
id|sc
suffix:semicolon
id|sc
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|sc
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|ch
)paren
suffix:semicolon
id|outl
c_func
(paren
id|sc
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
)brace
DECL|function|ali_disable_spdif_in
r_static
r_void
id|ali_disable_spdif_in
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|spdif
suffix:semicolon
id|spdif
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_and_assign
(paren
op_complement
id|ALI_SPDIF_IN_SUPPORT
)paren
suffix:semicolon
id|outl
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|ali_disable_special_channel
c_func
(paren
id|card
comma
id|ALI_SPDIF_IN_CHANNEL
)paren
suffix:semicolon
)brace
DECL|function|ali_setup_spdif_in
r_static
r_void
id|ali_setup_spdif_in
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|spdif
suffix:semicolon
singleline_comment|//Set SPDIF IN Supported
id|spdif
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_IN_SUPPORT
suffix:semicolon
id|outl
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_IN_CH_STATUS
suffix:semicolon
id|outb
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
singleline_comment|//Set SPDIF IN Rec
id|spdif
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_IN_CH_ENABLE
suffix:semicolon
id|outl
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_IN_FUNC_ENABLE
suffix:semicolon
id|outb
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
)brace
DECL|function|ali_get_spdif_in_rate
r_static
r_int
r_int
id|ali_get_spdif_in_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|spdif
comma
id|time1
comma
id|time2
suffix:semicolon
r_int
id|count1
comma
id|count2
comma
id|count3
suffix:semicolon
r_int
r_char
id|R1
comma
id|R2
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
l_int|0xAA
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|count1
op_assign
l_int|0xFFFF
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|count1
)paren
(brace
id|count2
op_assign
l_int|0xffff
suffix:semicolon
r_do
(brace
id|count3
op_assign
l_int|0xffff
suffix:semicolon
id|time1
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_do
(brace
id|time2
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|count3
op_decrement
)paren
op_logical_and
(paren
id|time2
op_le
(paren
id|time1
op_plus
l_int|5
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ali: STimer is stopped! Error!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|R1
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|count2
op_decrement
)paren
op_logical_and
(paren
op_logical_neg
(paren
(paren
id|R1
op_eq
l_int|0x0B
)paren
op_logical_or
(paren
id|R1
op_eq
l_int|0x0C
)paren
op_logical_or
(paren
id|R1
op_eq
l_int|0x0D
)paren
op_logical_or
(paren
id|R1
op_eq
l_int|0x0E
)paren
op_logical_or
(paren
id|R1
op_eq
l_int|0x12
)paren
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count2
)paren
r_continue
suffix:semicolon
id|count2
op_assign
l_int|0xffff
suffix:semicolon
id|time1
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_do
(brace
id|time2
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|count2
op_decrement
)paren
op_logical_and
(paren
id|time2
op_le
(paren
id|time1
op_plus
l_int|5
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count2
)paren
r_continue
suffix:semicolon
id|R2
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|count2
op_assign
l_int|0xffff
suffix:semicolon
r_while
c_loop
(paren
(paren
op_decrement
id|count2
)paren
op_logical_and
(paren
id|R2
op_ne
id|R1
)paren
)paren
(brace
id|R1
op_assign
id|R2
suffix:semicolon
id|count3
op_assign
l_int|0xffff
suffix:semicolon
id|time1
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_do
(brace
id|time2
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|count3
op_decrement
)paren
op_logical_and
(paren
id|time2
op_le
(paren
id|time1
op_plus
l_int|5
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ali: STimer is stopped! Error!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|R2
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|R2
op_eq
id|R1
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|count1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ali: Can not Detect the sample rate from SPDIF IN!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|spdif
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
op_or
id|ALI_SPDIF_IN_CH_STATUS
suffix:semicolon
id|outb
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
multiline_comment|/* SPDIF only supprts 48k, 44.1k, 32k */
r_switch
c_cond
(paren
id|R2
)paren
(brace
r_case
l_int|0x12
suffix:colon
id|outw
c_func
(paren
l_int|0x0E08
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_return
l_int|32000
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
r_case
l_int|0x0C
suffix:colon
r_case
l_int|0x0D
suffix:colon
r_case
l_int|0x0E
suffix:colon
r_default
suffix:colon
id|outw
c_func
(paren
l_int|0x0905
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spdif
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|3
)paren
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|spdif
op_eq
l_int|0
)paren
r_return
l_int|44100
suffix:semicolon
r_else
r_return
l_int|48000
suffix:semicolon
)brace
DECL|function|ali_setup_multi_channels
r_static
r_int
id|ali_setup_multi_channels
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|chan_nums
)paren
(brace
r_int
r_int
id|dwValue
suffix:semicolon
r_if
c_cond
(paren
id|chan_nums
op_eq
l_int|6
)paren
(brace
id|dwValue
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
op_or
l_int|0x000f0000
suffix:semicolon
id|outl
c_func
(paren
id|dwValue
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ali_free_pcm_channel
r_static
r_void
id|ali_free_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
id|bank
suffix:semicolon
r_if
c_cond
(paren
id|channel
OG
l_int|31
)paren
r_return
suffix:semicolon
id|bank
op_assign
id|channel
op_rshift
l_int|5
suffix:semicolon
id|channel
op_assign
id|channel
op_amp
l_int|0x1f
suffix:semicolon
id|card-&gt;banks
(braket
id|bank
)braket
dot
id|bitmap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|channel
)paren
)paren
suffix:semicolon
)brace
DECL|function|ali_allocate_other_states_resources
r_static
r_int
id|ali_allocate_other_states_resources
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|chan_nums
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_struct
id|trident_state
op_star
id|s
suffix:semicolon
r_int
id|i
comma
id|state_count
op_assign
l_int|0
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
suffix:semicolon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_A
)braket
suffix:semicolon
r_if
c_cond
(paren
id|chan_nums
op_eq
l_int|6
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|ALI_CHANNELS
)paren
op_logical_and
(paren
id|state_count
op_ne
l_int|4
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;states
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
)paren
)paren
)paren
(brace
id|bank-&gt;bitmap
op_or_assign
(paren
l_int|1
op_lshift
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
)paren
suffix:semicolon
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
)braket
suffix:semicolon
id|channel-&gt;num
op_assign
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
suffix:semicolon
)brace
r_else
(brace
id|state_count
op_decrement
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|state_count
op_ge
l_int|0
suffix:semicolon
id|state_count
op_decrement
)paren
(brace
id|kfree
c_func
(paren
id|state-&gt;other_states
(braket
id|state_count
)braket
)paren
suffix:semicolon
id|ali_free_pcm_channel
c_func
(paren
id|card
comma
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|s
op_assign
id|card-&gt;states
(braket
id|i
)braket
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|trident_state
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
(brace
id|ali_free_pcm_channel
c_func
(paren
id|card
comma
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
)paren
suffix:semicolon
id|state_count
op_decrement
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|state_count
op_ge
l_int|0
suffix:semicolon
id|state_count
op_decrement
)paren
(brace
id|ali_free_pcm_channel
c_func
(paren
id|card
comma
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|state-&gt;other_states
(braket
id|state_count
)braket
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|s
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|trident_state
)paren
)paren
suffix:semicolon
id|s-&gt;dmabuf.channel
op_assign
id|channel
suffix:semicolon
id|s-&gt;dmabuf.ossfragshift
op_assign
id|s-&gt;dmabuf.ossmaxfrags
op_assign
id|s-&gt;dmabuf.subdivision
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;dmabuf.wait
)paren
suffix:semicolon
id|s-&gt;magic
op_assign
id|card-&gt;magic
suffix:semicolon
id|s-&gt;card
op_assign
id|card
suffix:semicolon
id|s-&gt;virt
op_assign
id|i
suffix:semicolon
id|ali_enable_special_channel
c_func
(paren
id|s
)paren
suffix:semicolon
id|state-&gt;other_states
(braket
id|state_count
op_increment
)braket
op_assign
id|s
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|state_count
op_ne
l_int|4
)paren
(brace
id|state_count
op_decrement
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|state_count
op_ge
l_int|0
suffix:semicolon
id|state_count
op_decrement
)paren
(brace
id|kfree
c_func
(paren
id|state-&gt;other_states
(braket
id|state_count
)braket
)paren
suffix:semicolon
id|ali_free_pcm_channel
c_func
(paren
id|card
comma
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ali_save_regs
r_static
r_void
id|ali_save_regs
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ali_registers.global_regs
(braket
l_int|0x2c
)braket
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
singleline_comment|//ali_registers.global_regs[0x20] = inl(TRID_REG(card,T4D_START_A));&t;
id|ali_registers.global_regs
(braket
l_int|0x21
)braket
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_STOP_A
)paren
)paren
suffix:semicolon
singleline_comment|//disable all IRQ bits
id|outl
c_func
(paren
id|ALI_DISABLE_ALL_IRQ
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|ALI_MIXER_REGS
suffix:semicolon
id|i
op_increment
)paren
id|ali_registers.mixer_regs
(braket
id|i
)braket
op_assign
id|ali_ac97_get
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
id|i
op_star
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ALI_GLOBAL_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_MISCINT
)paren
op_logical_or
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_STOP_A
)paren
)paren
r_continue
suffix:semicolon
id|ali_registers.global_regs
(braket
id|i
)braket
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|i
op_star
l_int|4
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ALI_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|i
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ALI_CHANNEL_REGS
suffix:semicolon
id|j
op_increment
)paren
id|ali_registers.channel_regs
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|j
op_star
l_int|4
op_plus
l_int|0xe0
)paren
)paren
suffix:semicolon
)brace
singleline_comment|//Stop all HW channel
id|outl
c_func
(paren
id|ALI_STOP_ALL_CHANNELS
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_STOP_A
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ali_restore_regs
r_static
r_void
id|ali_restore_regs
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|ALI_MIXER_REGS
suffix:semicolon
id|i
op_increment
)paren
id|ali_ac97_set
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
id|i
op_star
l_int|2
comma
id|ali_registers.mixer_regs
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ALI_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|i
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ALI_CHANNEL_REGS
suffix:semicolon
id|j
op_increment
)paren
id|outl
c_func
(paren
id|ali_registers.channel_regs
(braket
id|i
)braket
(braket
id|j
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|j
op_star
l_int|4
op_plus
l_int|0xe0
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ALI_GLOBAL_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_MISCINT
)paren
op_logical_or
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_STOP_A
)paren
op_logical_or
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_START_A
)paren
)paren
r_continue
suffix:semicolon
id|ali_registers.global_regs
(braket
id|i
)braket
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|i
op_star
l_int|4
)paren
)paren
suffix:semicolon
)brace
singleline_comment|//start HW channel
id|outl
c_func
(paren
id|ali_registers.global_regs
(braket
l_int|0x20
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_START_A
)paren
)paren
suffix:semicolon
singleline_comment|//restore IRQ enable bits
id|outl
c_func
(paren
id|ali_registers.global_regs
(braket
l_int|0x2c
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ali_pm_callback
r_static
r_int
id|ali_pm_callback
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|dev-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
(brace
r_switch
c_cond
(paren
id|rqst
)paren
(brace
r_case
id|PM_SUSPEND
suffix:colon
id|ali_save_regs
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PM_RESUME
suffix:colon
id|ali_restore_regs
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ali_alloc_pcm_channel
r_static
r_struct
id|trident_channel
op_star
id|ali_alloc_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_A
)braket
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
op_amp
(paren
id|ALI_SPDIF_OUT_CH_ENABLE
)paren
)paren
(brace
id|idx
op_assign
id|ALI_SPDIF_OUT_CHANNEL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|idx
op_assign
id|ALI_PCM_OUT_CHANNEL_FIRST
suffix:semicolon
id|idx
op_le
id|ALI_PCM_OUT_CHANNEL_LAST
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
)brace
multiline_comment|/* no more free channels avaliable */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali: no more channels available on Bank A.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ali_alloc_rec_pcm_channel
r_static
r_struct
id|trident_channel
op_star
id|ali_alloc_rec_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
op_amp
id|ALI_SPDIF_IN_SUPPORT
)paren
id|idx
op_assign
id|ALI_SPDIF_IN_CHANNEL
suffix:semicolon
r_else
id|idx
op_assign
id|ALI_PCM_IN_CHANNEL
suffix:semicolon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_A
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
multiline_comment|/* no free recordable channels avaliable */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali: no recordable channels available on Bank A.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ali_set_spdif_out_rate
r_static
r_void
id|ali_set_spdif_out_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|rate
)paren
(brace
r_int
r_char
id|ch_st_sel
suffix:semicolon
r_int
r_int
id|status_rate
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ali: spdif out rate =%d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|rate
)paren
(brace
r_case
l_int|44100
suffix:colon
id|status_rate
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32000
suffix:colon
id|status_rate
op_assign
l_int|0x300
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|48000
suffix:colon
r_default
suffix:colon
id|status_rate
op_assign
l_int|0x200
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ch_st_sel
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
op_amp
id|ALI_SPDIF_OUT_CH_STATUS
suffix:semicolon
singleline_comment|//select spdif_out
id|ch_st_sel
op_or_assign
l_int|0x80
suffix:semicolon
singleline_comment|//select right
id|outb
c_func
(paren
id|ch_st_sel
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|status_rate
op_or
l_int|0x20
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|ch_st_sel
op_and_assign
(paren
op_complement
l_int|0x80
)paren
suffix:semicolon
singleline_comment|//select left
id|outb
c_func
(paren
id|ch_st_sel
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|status_rate
op_or
l_int|0x10
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|2
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ali: SPDIF_CS=%lxh&bslash;n&quot;
comma
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ali_address_interrupt
r_static
r_void
id|ali_address_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
id|i
comma
id|channel
suffix:semicolon
r_struct
id|trident_state
op_star
id|state
suffix:semicolon
id|u32
id|mask
comma
id|channel_mask
suffix:semicolon
id|mask
op_assign
id|trident_get_interrupt_mask
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|state
op_assign
id|card-&gt;states
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|channel
op_assign
id|state-&gt;dmabuf.channel-&gt;num
suffix:semicolon
r_if
c_cond
(paren
(paren
id|channel_mask
op_assign
l_int|1
op_lshift
id|channel
)paren
op_amp
id|mask
)paren
(brace
id|mask
op_and_assign
op_complement
id|channel_mask
suffix:semicolon
id|trident_ack_channel_interrupt
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
id|state-&gt;dmabuf.update_flag
op_or_assign
id|ALI_ADDRESS_INT_UPDATE
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mask
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ali: spurious channel irq %d.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|trident_ack_channel_interrupt
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Updating the values of counters of other_states&squot; DMAs without lock &n;protection is no harm because all DMAs of multi-channels and interrupt&n;depend on a master state&squot;s DMA, and changing the counters of the master&n;state DMA is protected by a spinlock.&n;*/
DECL|function|ali_write_5_1
r_static
r_int
id|ali_write_5_1
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|cnt_for_multi_channel
comma
r_int
r_int
op_star
id|copy_count
comma
r_int
r_int
op_star
id|state_cnt
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf_temp
suffix:semicolon
r_const
r_char
op_star
id|buffer
op_assign
id|buf
suffix:semicolon
r_int
id|swptr
comma
id|other_dma_nums
comma
id|sample_s
suffix:semicolon
r_int
r_int
id|i
comma
id|loop
suffix:semicolon
id|other_dma_nums
op_assign
l_int|4
suffix:semicolon
id|sample_s
op_assign
id|sample_size
(braket
id|dmabuf-&gt;fmt
)braket
op_rshift
l_int|1
suffix:semicolon
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|state-&gt;multi_channels_adjust_count
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
(paren
op_star
id|state_cnt
)paren
op_add_assign
id|sample_s
suffix:semicolon
id|state-&gt;multi_channels_adjust_count
op_increment
suffix:semicolon
)brace
r_else
id|i
op_assign
id|i
op_minus
(paren
id|state-&gt;chans_num
op_minus
id|other_dma_nums
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|i
OL
id|other_dma_nums
)paren
op_logical_and
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
id|i
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt_for_multi_channel
op_eq
l_int|0
)paren
id|state-&gt;multi_channels_adjust_count
op_add_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
(brace
id|loop
op_assign
id|cnt_for_multi_channel
op_div
(paren
id|state-&gt;chans_num
op_star
id|sample_s
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|loop
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|sample_s
op_star
l_int|2
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
op_star
l_int|2
comma
op_star
id|copy_count
)paren
suffix:semicolon
(paren
op_star
id|state_cnt
)paren
op_add_assign
(paren
id|sample_s
op_star
l_int|2
)paren
suffix:semicolon
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
(brace
id|state-&gt;multi_channels_adjust_count
op_assign
id|cnt_for_multi_channel
op_div
id|sample_s
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
(paren
op_star
id|state_cnt
)paren
op_add_assign
id|sample_s
suffix:semicolon
r_if
c_cond
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
(paren
op_star
id|state_cnt
)paren
op_add_assign
id|sample_s
suffix:semicolon
r_if
c_cond
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
(brace
id|loop
op_assign
id|state-&gt;multi_channels_adjust_count
op_minus
(paren
id|state-&gt;chans_num
op_minus
id|other_dma_nums
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|loop
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
id|i
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
id|state-&gt;multi_channels_adjust_count
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|other_dma_nums
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
id|i
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
id|dmabuf_temp-&gt;swptr
op_assign
id|dmabuf_temp-&gt;swptr
op_mod
id|dmabuf_temp-&gt;dmasize
suffix:semicolon
)brace
r_return
op_star
id|state_cnt
suffix:semicolon
)brace
DECL|function|ali_free_other_states_resources
r_static
r_void
id|ali_free_other_states_resources
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_struct
id|trident_state
op_star
id|s
suffix:semicolon
r_int
id|other_states_count
suffix:semicolon
id|other_states_count
op_assign
id|state-&gt;chans_num
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* except PCM L/R channels*/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|other_states_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|s
op_assign
id|state-&gt;other_states
(braket
id|i
)braket
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
id|s
)paren
suffix:semicolon
id|ali_disable_special_channel
c_func
(paren
id|s-&gt;card
comma
id|s-&gt;dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|state-&gt;card
op_member_access_from_pointer
id|free_pcm_channel
c_func
(paren
id|s-&gt;card
comma
id|s-&gt;dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|card-&gt;states
(braket
id|s-&gt;virt
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|res
r_struct
id|proc_dir_entry
op_star
id|res
op_assign
l_int|NULL
suffix:semicolon
DECL|function|ali_write_proc
r_static
r_int
id|ali_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|buffer
op_eq
l_char|&squot;0&squot;
)paren
(brace
singleline_comment|//default
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_PCM_TO_SPDIF_OUT
)paren
suffix:semicolon
id|ali_disable_special_channel
c_func
(paren
id|card
comma
id|ALI_SPDIF_OUT_CHANNEL
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|buffer
op_eq
l_char|&squot;1&squot;
)paren
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_SPDIF_OUT_TO_SPDIF_OUT
op_or
id|ALI_SPDIF_OUT_PCM
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|buffer
op_eq
l_char|&squot;2&squot;
)paren
singleline_comment|//AC3 data
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_SPDIF_OUT_TO_SPDIF_OUT
op_or
id|ALI_SPDIF_OUT_NON_PCM
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|buffer
op_eq
l_char|&squot;3&squot;
)paren
id|ali_disable_spdif_in
c_func
(paren
id|card
)paren
suffix:semicolon
singleline_comment|//default
r_else
r_if
c_cond
(paren
op_star
id|buffer
op_eq
l_char|&squot;4&squot;
)paren
id|ali_setup_spdif_in
c_func
(paren
id|card
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* OSS /dev/mixer file operation methods */
DECL|function|trident_open_mixdev
r_static
r_int
id|trident_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|devs
suffix:semicolon
r_for
c_loop
(paren
id|card
op_assign
id|devs
suffix:semicolon
id|card
op_ne
l_int|NULL
suffix:semicolon
id|card
op_assign
id|card-&gt;next
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_AC97
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_ne
l_int|NULL
op_logical_and
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
op_eq
id|minor
)paren
r_goto
id|match
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|match
suffix:colon
id|file-&gt;private_data
op_assign
id|card-&gt;ac97_codec
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_ioctl_mixdev
r_static
r_int
id|trident_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ac97_codec
op_star
id|codec
op_assign
(paren
r_struct
id|ac97_codec
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_return
id|codec
op_member_access_from_pointer
id|mixer_ioctl
c_func
(paren
id|codec
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|variable|trident_mixer_fops
r_static
multiline_comment|/*const*/
r_struct
id|file_operations
id|trident_mixer_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|llseek
suffix:colon
id|trident_llseek
comma
id|ioctl
suffix:colon
id|trident_ioctl_mixdev
comma
id|open
suffix:colon
id|trident_open_mixdev
comma
)brace
suffix:semicolon
multiline_comment|/* AC97 codec initialisation. */
DECL|function|trident_ac97_init
r_static
r_int
id|__init
id|trident_ac97_init
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
id|num_ac97
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ready_2nd
op_assign
l_int|0
suffix:semicolon
r_struct
id|ac97_codec
op_star
id|codec
suffix:semicolon
multiline_comment|/* initialize controller side of AC link, and find out if secondary codes&n;&t;   really exist */
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|ready_2nd
op_or
id|PCMOUT
op_or
id|SECONDARY_ID
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
id|SI_AC97_SECONDARY_READY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
multiline_comment|/* disable AC97 GPIO interrupt */
id|outl
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_AC97_GPIO
)paren
)paren
suffix:semicolon
multiline_comment|/* when power up the AC link is in cold reset mode so stop it */
id|outl
c_func
(paren
id|PCMOUT
op_or
id|SURROUT
op_or
id|CENTEROUT
op_or
id|LFEOUT
op_or
id|SECONDARY_ID
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_SERIAL_INTF_CTRL
)paren
)paren
suffix:semicolon
multiline_comment|/* it take a long time to recover from a cold reset (especially when you have&n;&t;&t;   more than one codec) */
id|udelay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_SERIAL_INTF_CTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
id|SI_AC97_SECONDARY_READY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
multiline_comment|/* playback on */
id|outl
c_func
(paren
id|DX_AC97_PLAYBACK
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
multiline_comment|/* enable AC97 Output Slot 3,4 (PCM Left/Right Playback) */
id|outl
c_func
(paren
id|NX_AC97_PCM_OUTPUT
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
id|NX_AC97_SECONDARY_READY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|num_ac97
op_assign
l_int|0
suffix:semicolon
id|num_ac97
OL
id|NR_AC97
suffix:semicolon
id|num_ac97
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|codec
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ac97_codec
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|codec
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ac97_codec
)paren
)paren
suffix:semicolon
multiline_comment|/* initialize some basic codec information, other fields will be filled&n;&t;&t;   in ac97_probe_codec */
id|codec-&gt;private_data
op_assign
id|card
suffix:semicolon
id|codec-&gt;id
op_assign
id|num_ac97
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
id|codec-&gt;codec_read
op_assign
id|ali_ac97_get
suffix:semicolon
id|codec-&gt;codec_write
op_assign
id|ali_ac97_set
suffix:semicolon
)brace
r_else
(brace
id|codec-&gt;codec_read
op_assign
id|trident_ac97_get
suffix:semicolon
id|codec-&gt;codec_write
op_assign
id|trident_ac97_set
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ac97_probe_codec
c_func
(paren
id|codec
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|codec-&gt;dev_mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|trident_mixer_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: couldn&squot;t register mixer!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|codec
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;ac97_codec
(braket
id|num_ac97
)braket
op_assign
id|codec
suffix:semicolon
multiline_comment|/* if there is no secondary codec at all, don&squot;t probe any more */
r_if
c_cond
(paren
op_logical_neg
id|ready_2nd
)paren
r_return
id|num_ac97
op_plus
l_int|1
suffix:semicolon
)brace
r_return
id|num_ac97
suffix:semicolon
)brace
multiline_comment|/* install the driver, we do not allocate hardware channel nor DMA buffer now, they are defered &n;   untill &quot;ACCESS&quot; time (in prog_dmabuf called by open/read/write/ioctl/mmap) */
DECL|function|trident_probe
r_static
r_int
id|__init
id|trident_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|pci_id
)paren
(brace
r_int
r_int
id|iobase
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
id|u8
id|revision
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_dma_supported
c_func
(paren
id|pci_dev
comma
id|TRIDENT_DMA_MASK
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: architecture does not support&quot;
l_string|&quot; 30bit PCI busmaster DMA&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|revision
)paren
suffix:semicolon
id|iobase
op_assign
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
l_int|256
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: can&squot;t allocate I/O space at 0x%4.4lx&bslash;n&quot;
comma
id|iobase
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pci_dev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|trident_card
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|card
)paren
)paren
suffix:semicolon
id|card-&gt;iobase
op_assign
id|iobase
suffix:semicolon
id|card-&gt;pci_dev
op_assign
id|pci_dev
suffix:semicolon
id|card-&gt;pci_id
op_assign
id|pci_id-&gt;device
suffix:semicolon
id|card-&gt;revision
op_assign
id|revision
suffix:semicolon
id|card-&gt;irq
op_assign
id|pci_dev-&gt;irq
suffix:semicolon
id|card-&gt;next
op_assign
id|devs
suffix:semicolon
id|card-&gt;magic
op_assign
id|TRIDENT_CARD_MAGIC
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_A
)braket
dot
id|addresses
op_assign
op_amp
id|bank_a_addrs
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_A
)braket
dot
id|bitmap
op_assign
l_int|0UL
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_B
)braket
dot
id|addresses
op_assign
op_amp
id|bank_b_addrs
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_B
)braket
dot
id|bitmap
op_assign
l_int|0UL
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|devs
op_assign
id|card
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;trident: %s found at IO 0x%04lx, IRQ %d&bslash;n&quot;
comma
id|card_names
(braket
id|pci_id-&gt;driver_data
)braket
comma
id|card-&gt;iobase
comma
id|card-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
multiline_comment|/* ALi Power Management */
r_struct
id|pm_dev
op_star
id|pmdev
suffix:semicolon
id|pmdev
op_assign
id|pm_register
c_func
(paren
id|PM_PCI_DEV
comma
id|PM_PCI_ID
c_func
(paren
id|pci_dev
)paren
comma
id|ali_pm_callback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmdev
)paren
id|pmdev-&gt;data
op_assign
id|card
suffix:semicolon
multiline_comment|/* ALi channel Management */
id|card-&gt;alloc_pcm_channel
op_assign
id|ali_alloc_pcm_channel
suffix:semicolon
id|card-&gt;alloc_rec_pcm_channel
op_assign
id|ali_alloc_rec_pcm_channel
suffix:semicolon
id|card-&gt;free_pcm_channel
op_assign
id|ali_free_pcm_channel
suffix:semicolon
id|card-&gt;address_interrupt
op_assign
id|ali_address_interrupt
suffix:semicolon
multiline_comment|/* ALi SPDIF OUT function */
r_if
c_cond
(paren
id|card-&gt;revision
op_eq
id|ALI_5451_V02
)paren
(brace
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_PCM_TO_SPDIF_OUT
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|res
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ALi5451&quot;
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|res-&gt;write_proc
op_assign
id|ali_write_proc
suffix:semicolon
id|res-&gt;data
op_assign
id|card
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
r_else
(brace
id|card-&gt;alloc_pcm_channel
op_assign
id|trident_alloc_pcm_channel
suffix:semicolon
id|card-&gt;alloc_rec_pcm_channel
op_assign
id|trident_alloc_pcm_channel
suffix:semicolon
id|card-&gt;free_pcm_channel
op_assign
id|trident_free_pcm_channel
suffix:semicolon
id|card-&gt;address_interrupt
op_assign
id|trident_address_interrupt
suffix:semicolon
)brace
multiline_comment|/* claim our iospace and irq */
id|request_region
c_func
(paren
id|card-&gt;iobase
comma
l_int|256
comma
id|card_names
(braket
id|pci_id-&gt;driver_data
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|card-&gt;irq
comma
op_amp
id|trident_interrupt
comma
id|SA_SHIRQ
comma
id|card_names
(braket
id|pci_id-&gt;driver_data
)braket
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: unable to allocate irq %d&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|card-&gt;iobase
comma
l_int|256
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* register /dev/dsp */
r_if
c_cond
(paren
(paren
id|card-&gt;dev_audio
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|trident_audio_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: couldn&squot;t register DSP device!&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|iobase
comma
l_int|256
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* initilize AC97 codec and register /dev/mixer */
r_if
c_cond
(paren
id|trident_ac97_init
c_func
(paren
id|card
)paren
op_le
l_int|0
)paren
(brace
id|unregister_sound_dsp
c_func
(paren
id|card-&gt;dev_audio
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|iobase
comma
l_int|256
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|outl
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MUSICVOL_WAVEVOL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
multiline_comment|/* edited by HMSEO for GT sound */
macro_line|#ifdef CONFIG_ALPHA_NAUTILUS
id|u16
id|ac97_data
suffix:semicolon
id|ac97_data
op_assign
id|ali_ac97_get
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
id|AC97_POWER_CONTROL
)paren
suffix:semicolon
id|ali_ac97_set
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
id|AC97_POWER_CONTROL
comma
id|ac97_data
op_or
id|ALI_EAPD_POWER_DOWN
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* edited by HMSEO for GT sound*/
)brace
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
id|card
)paren
suffix:semicolon
id|pci_dev-&gt;dma_mask
op_assign
id|TRIDENT_DMA_MASK
suffix:semicolon
multiline_comment|/* Enable Address Engine Interrupts */
id|trident_enable_loop_interrupts
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_remove
r_static
r_void
id|__exit
id|trident_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
multiline_comment|/* ALi S/PDIF and Power Management */
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_PCM_TO_SPDIF_OUT
)paren
suffix:semicolon
id|ali_disable_special_channel
c_func
(paren
id|card
comma
id|ALI_SPDIF_OUT_CHANNEL
)paren
suffix:semicolon
id|ali_disable_spdif_in
c_func
(paren
id|card
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|remove_proc_entry
c_func
(paren
l_string|&quot;ALi5451&quot;
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
id|pm_unregister_all
c_func
(paren
id|ali_pm_callback
)paren
suffix:semicolon
)brace
multiline_comment|/* Kill interrupts, and SP/DIF */
id|trident_disable_loop_interrupts
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* free hardware resources */
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|card-&gt;iobase
comma
l_int|256
)paren
suffix:semicolon
multiline_comment|/* unregister audio devices */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_AC97
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|unregister_sound_mixer
c_func
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
)paren
suffix:semicolon
id|kfree
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|unregister_sound_dsp
c_func
(paren
id|card-&gt;dev_audio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alan Cox, Aaron Holtzman, Ollie Lho, Ching Ling Lee&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Trident 4DWave/SiS 7018/ALi 5451 PCI Audio Driver&quot;
)paren
suffix:semicolon
DECL|macro|TRIDENT_MODULE_NAME
mdefine_line|#define TRIDENT_MODULE_NAME &quot;trident&quot;
DECL|variable|trident_pci_driver
r_static
r_struct
id|pci_driver
id|trident_pci_driver
op_assign
(brace
id|name
suffix:colon
id|TRIDENT_MODULE_NAME
comma
id|id_table
suffix:colon
id|trident_pci_tbl
comma
id|probe
suffix:colon
id|trident_probe
comma
id|remove
suffix:colon
id|trident_remove
comma
)brace
suffix:semicolon
DECL|function|trident_init_module
r_static
r_int
id|__init
id|trident_init_module
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
multiline_comment|/* No PCI bus in this machine! */
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Trident 4DWave/SiS 7018/ALi 5451 PCI Audio, version &quot;
id|DRIVER_VERSION
l_string|&quot;, &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_register_driver
c_func
(paren
op_amp
id|trident_pci_driver
)paren
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|trident_pci_driver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trident_cleanup_module
r_static
r_void
id|__exit
id|trident_cleanup_module
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|trident_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|trident_init_module
id|module_init
c_func
(paren
id|trident_init_module
)paren
suffix:semicolon
DECL|variable|trident_cleanup_module
id|module_exit
c_func
(paren
id|trident_cleanup_module
)paren
suffix:semicolon
eof
