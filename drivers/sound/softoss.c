multiline_comment|/* &n; * sound/softoss.c&n; *&n; * Software based MIDI synthsesizer driver.&n; *&n; *&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; *&n; *&n; * Thomas Sailer&t;: ioctl code reworked (vmalloc/vfree removed)&n; * Christoph Hellwig&t;: adapted to module_init/module_exit&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
multiline_comment|/*&n; * When POLLED_MODE is defined, the resampling loop is run using a timer&n; * callback routine. Normally the resampling loop is executed inside&n; * audio buffer interrupt handler which doesn&squot;t work with single mode DMA.&n; */
DECL|macro|SOFTSYN_MAIN
mdefine_line|#define SOFTSYN_MAIN
DECL|macro|POLLED_MODE
macro_line|#undef  POLLED_MODE
DECL|macro|HANDLE_LFO
mdefine_line|#define HANDLE_LFO
DECL|macro|ENVELOPE_SCALE
mdefine_line|#define ENVELOPE_SCALE&t;&t;8
DECL|macro|NO_SAMPLE
mdefine_line|#define NO_SAMPLE&t;&t;0xffff
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;softoss.h&quot;
macro_line|#include &lt;linux/ultrasound.h&gt;
DECL|variable|softsynth_disabled
r_int
id|softsynth_disabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|intr_pending
r_static
r_volatile
r_int
id|intr_pending
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef POLLED_MODE
DECL|variable|poll_timer
r_static
r_struct
id|timer_list
id|poll_timer
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
comma
id|softsyn_poll
)brace
suffix:semicolon
macro_line|#else
macro_line|#endif
macro_line|#ifdef HANDLE_LFO
multiline_comment|/*&n; * LFO table. Playback at 128 Hz gives 1 Hz LFO frequency.&n; */
DECL|variable|tremolo_table
r_static
r_int
id|tremolo_table
(braket
l_int|128
)braket
op_assign
(brace
l_int|0
comma
l_int|39
comma
l_int|158
comma
l_int|355
comma
l_int|630
comma
l_int|982
comma
l_int|1411
comma
l_int|1915
comma
l_int|2494
comma
l_int|3146
comma
l_int|3869
comma
l_int|4662
comma
l_int|5522
comma
l_int|6448
comma
l_int|7438
comma
l_int|8489
comma
l_int|9598
comma
l_int|10762
comma
l_int|11980
comma
l_int|13248
comma
l_int|14563
comma
l_int|15922
comma
l_int|17321
comma
l_int|18758
comma
l_int|20228
comma
l_int|21729
comma
l_int|23256
comma
l_int|24806
comma
l_int|26375
comma
l_int|27960
comma
l_int|29556
comma
l_int|31160
comma
l_int|32768
comma
l_int|34376
comma
l_int|35980
comma
l_int|37576
comma
l_int|39161
comma
l_int|40730
comma
l_int|42280
comma
l_int|43807
comma
l_int|45308
comma
l_int|46778
comma
l_int|48215
comma
l_int|49614
comma
l_int|50973
comma
l_int|52288
comma
l_int|53556
comma
l_int|54774
comma
l_int|55938
comma
l_int|57047
comma
l_int|58098
comma
l_int|59088
comma
l_int|60014
comma
l_int|60874
comma
l_int|61667
comma
l_int|62390
comma
l_int|63042
comma
l_int|63621
comma
l_int|64125
comma
l_int|64554
comma
l_int|64906
comma
l_int|65181
comma
l_int|65378
comma
l_int|65497
comma
l_int|65536
comma
l_int|65497
comma
l_int|65378
comma
l_int|65181
comma
l_int|64906
comma
l_int|64554
comma
l_int|64125
comma
l_int|63621
comma
l_int|63042
comma
l_int|62390
comma
l_int|61667
comma
l_int|60874
comma
l_int|60014
comma
l_int|59087
comma
l_int|58098
comma
l_int|57047
comma
l_int|55938
comma
l_int|54774
comma
l_int|53556
comma
l_int|52288
comma
l_int|50973
comma
l_int|49614
comma
l_int|48215
comma
l_int|46778
comma
l_int|45308
comma
l_int|43807
comma
l_int|42280
comma
l_int|40730
comma
l_int|39161
comma
l_int|37576
comma
l_int|35980
comma
l_int|34376
comma
l_int|32768
comma
l_int|31160
comma
l_int|29556
comma
l_int|27960
comma
l_int|26375
comma
l_int|24806
comma
l_int|23256
comma
l_int|21729
comma
l_int|20228
comma
l_int|18758
comma
l_int|17321
comma
l_int|15922
comma
l_int|14563
comma
l_int|13248
comma
l_int|11980
comma
l_int|10762
comma
l_int|9598
comma
l_int|8489
comma
l_int|7438
comma
l_int|6448
comma
l_int|5522
comma
l_int|4662
comma
l_int|3869
comma
l_int|3146
comma
l_int|2494
comma
l_int|1915
comma
l_int|1411
comma
l_int|982
comma
l_int|630
comma
l_int|355
comma
l_int|158
comma
l_int|39
)brace
suffix:semicolon
DECL|variable|vibrato_table
r_static
r_int
id|vibrato_table
(braket
l_int|128
)braket
op_assign
(brace
l_int|0
comma
l_int|1608
comma
l_int|3212
comma
l_int|4808
comma
l_int|6393
comma
l_int|7962
comma
l_int|9512
comma
l_int|11039
comma
l_int|12540
comma
l_int|14010
comma
l_int|15447
comma
l_int|16846
comma
l_int|18205
comma
l_int|19520
comma
l_int|20788
comma
l_int|22006
comma
l_int|23170
comma
l_int|24279
comma
l_int|25330
comma
l_int|26320
comma
l_int|27246
comma
l_int|28106
comma
l_int|28899
comma
l_int|29622
comma
l_int|30274
comma
l_int|30853
comma
l_int|31357
comma
l_int|31786
comma
l_int|32138
comma
l_int|32413
comma
l_int|32610
comma
l_int|32729
comma
l_int|32768
comma
l_int|32729
comma
l_int|32610
comma
l_int|32413
comma
l_int|32138
comma
l_int|31786
comma
l_int|31357
comma
l_int|30853
comma
l_int|30274
comma
l_int|29622
comma
l_int|28899
comma
l_int|28106
comma
l_int|27246
comma
l_int|26320
comma
l_int|25330
comma
l_int|24279
comma
l_int|23170
comma
l_int|22006
comma
l_int|20788
comma
l_int|19520
comma
l_int|18205
comma
l_int|16846
comma
l_int|15447
comma
l_int|14010
comma
l_int|12540
comma
l_int|11039
comma
l_int|9512
comma
l_int|7962
comma
l_int|6393
comma
l_int|4808
comma
l_int|3212
comma
l_int|1608
comma
l_int|0
comma
op_minus
l_int|1608
comma
op_minus
l_int|3212
comma
op_minus
l_int|4808
comma
op_minus
l_int|6393
comma
op_minus
l_int|7962
comma
op_minus
l_int|9512
comma
op_minus
l_int|11039
comma
op_minus
l_int|12540
comma
op_minus
l_int|14010
comma
op_minus
l_int|15447
comma
op_minus
l_int|16846
comma
op_minus
l_int|18205
comma
op_minus
l_int|19520
comma
op_minus
l_int|20788
comma
op_minus
l_int|22006
comma
op_minus
l_int|23170
comma
op_minus
l_int|24279
comma
op_minus
l_int|25330
comma
op_minus
l_int|26320
comma
op_minus
l_int|27246
comma
op_minus
l_int|28106
comma
op_minus
l_int|28899
comma
op_minus
l_int|29622
comma
op_minus
l_int|30274
comma
op_minus
l_int|30853
comma
op_minus
l_int|31357
comma
op_minus
l_int|31786
comma
op_minus
l_int|32138
comma
op_minus
l_int|32413
comma
op_minus
l_int|32610
comma
op_minus
l_int|32729
comma
op_minus
l_int|32768
comma
op_minus
l_int|32729
comma
op_minus
l_int|32610
comma
op_minus
l_int|32413
comma
op_minus
l_int|32138
comma
op_minus
l_int|31786
comma
op_minus
l_int|31357
comma
op_minus
l_int|30853
comma
op_minus
l_int|30274
comma
op_minus
l_int|29622
comma
op_minus
l_int|28899
comma
op_minus
l_int|28106
comma
op_minus
l_int|27246
comma
op_minus
l_int|26320
comma
op_minus
l_int|25330
comma
op_minus
l_int|24279
comma
op_minus
l_int|23170
comma
op_minus
l_int|22006
comma
op_minus
l_int|20788
comma
op_minus
l_int|19520
comma
op_minus
l_int|18205
comma
op_minus
l_int|16846
comma
op_minus
l_int|15447
comma
op_minus
l_int|14010
comma
op_minus
l_int|12540
comma
op_minus
l_int|11039
comma
op_minus
l_int|9512
comma
op_minus
l_int|7962
comma
op_minus
l_int|6393
comma
op_minus
l_int|4808
comma
op_minus
l_int|3212
comma
op_minus
l_int|1608
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|last_resample_jiffies
r_static
r_int
r_int
id|last_resample_jiffies
suffix:semicolon
DECL|variable|resample_counter
r_static
r_int
r_int
id|resample_counter
suffix:semicolon
r_extern
r_int
op_star
id|sound_osp
suffix:semicolon
DECL|variable|is_running
r_static
r_volatile
r_int
id|is_running
op_assign
l_int|0
suffix:semicolon
DECL|variable|softsynth_loaded
r_static
r_int
id|softsynth_loaded
op_assign
l_int|0
suffix:semicolon
DECL|variable|softsyn_info
r_static
r_struct
id|synth_info
id|softsyn_info
op_assign
(brace
l_string|&quot;SoftOSS&quot;
comma
l_int|0
comma
id|SYNTH_TYPE_SAMPLE
comma
id|SAMPLE_TYPE_GUS
comma
l_int|0
comma
l_int|16
comma
l_int|0
comma
id|MAX_PATCH
)brace
suffix:semicolon
DECL|variable|sdev_info
r_static
r_struct
id|softsyn_devc
id|sdev_info
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|devc
id|softsyn_devc
op_star
id|devc
op_assign
op_amp
id|sdev_info
suffix:semicolon
multiline_comment|/* used in softoss_rs.c */
DECL|variable|voice_alloc
r_static
r_struct
id|voice_alloc_info
op_star
id|voice_alloc
suffix:semicolon
r_static
r_int
id|softsyn_open
c_func
(paren
r_int
id|synthdev
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|init_voice
c_func
(paren
id|softsyn_devc
op_star
id|devc
comma
r_int
id|voice
)paren
suffix:semicolon
r_static
r_void
id|compute_step
c_func
(paren
r_int
id|voice
)paren
suffix:semicolon
DECL|variable|tmr_running
r_static
r_volatile
r_int
id|tmr_running
op_assign
l_int|0
suffix:semicolon
DECL|variable|voice_limit
r_static
r_int
id|voice_limit
op_assign
l_int|24
suffix:semicolon
DECL|function|set_max_voices
r_static
r_void
id|set_max_voices
c_func
(paren
r_int
id|nr
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|nr
OL
l_int|4
)paren
id|nr
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|nr
OG
id|voice_limit
)paren
id|nr
op_assign
id|voice_limit
suffix:semicolon
id|voice_alloc-&gt;max_voice
op_assign
id|devc-&gt;maxvoice
op_assign
id|nr
suffix:semicolon
id|devc-&gt;afterscale
op_assign
l_int|5
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|31
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
id|nr
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|devc-&gt;afterscale
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
DECL|function|update_vibrato
r_static
r_void
id|update_vibrato
c_func
(paren
r_int
id|voice
)paren
(brace
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
macro_line|#ifdef HANDLE_LFO
r_int
id|x
suffix:semicolon
id|x
op_assign
id|vibrato_table
(braket
id|v-&gt;vibrato_phase
op_rshift
l_int|8
)braket
suffix:semicolon
id|v-&gt;vibrato_phase
op_assign
(paren
id|v-&gt;vibrato_phase
op_plus
id|v-&gt;vibrato_step
)paren
op_amp
l_int|0x7fff
suffix:semicolon
id|x
op_assign
(paren
id|x
op_star
id|v-&gt;vibrato_depth
)paren
op_rshift
l_int|15
suffix:semicolon
id|v-&gt;vibrato_level
op_assign
(paren
id|x
op_star
l_int|600
)paren
op_rshift
l_int|8
suffix:semicolon
id|compute_step
c_func
(paren
id|voice
)paren
suffix:semicolon
macro_line|#else
id|v-&gt;vibrato_level
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef HANDLE_LFO
DECL|function|update_tremolo
r_static
r_void
id|update_tremolo
c_func
(paren
r_int
id|voice
)paren
(brace
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
r_int
id|x
suffix:semicolon
id|x
op_assign
id|tremolo_table
(braket
id|v-&gt;tremolo_phase
op_rshift
l_int|8
)braket
suffix:semicolon
id|v-&gt;tremolo_phase
op_assign
(paren
id|v-&gt;tremolo_phase
op_plus
id|v-&gt;tremolo_step
)paren
op_amp
l_int|0x7fff
suffix:semicolon
id|v-&gt;tremolo_level
op_assign
(paren
id|x
op_star
id|v-&gt;tremolo_depth
)paren
op_rshift
l_int|20
suffix:semicolon
)brace
macro_line|#endif
DECL|function|start_vibrato
r_static
r_void
id|start_vibrato
c_func
(paren
r_int
id|voice
)paren
(brace
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
r_int
id|rate
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|v-&gt;vibrato_depth
)paren
r_return
suffix:semicolon
id|rate
op_assign
id|v-&gt;vibrato_rate
op_star
l_int|6
op_star
l_int|128
suffix:semicolon
id|v-&gt;vibrato_step
op_assign
(paren
id|rate
op_star
id|devc-&gt;control_rate
)paren
op_div
id|devc-&gt;speed
suffix:semicolon
id|devc-&gt;vibratomap
op_or_assign
(paren
l_int|1
op_lshift
id|voice
)paren
suffix:semicolon
multiline_comment|/* Enable vibrato */
)brace
DECL|function|start_tremolo
r_static
r_void
id|start_tremolo
c_func
(paren
r_int
id|voice
)paren
(brace
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
r_int
id|rate
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|v-&gt;tremolo_depth
)paren
r_return
suffix:semicolon
id|rate
op_assign
id|v-&gt;tremolo_rate
op_star
l_int|6
op_star
l_int|128
suffix:semicolon
id|v-&gt;tremolo_step
op_assign
(paren
id|rate
op_star
id|devc-&gt;control_rate
)paren
op_div
id|devc-&gt;speed
suffix:semicolon
id|devc-&gt;tremolomap
op_or_assign
(paren
l_int|1
op_lshift
id|voice
)paren
suffix:semicolon
multiline_comment|/* Enable tremolo */
)brace
DECL|function|update_volume
r_static
r_void
id|update_volume
c_func
(paren
r_int
id|voice
)paren
(brace
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
r_int
r_int
id|vol
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Compute plain volume&n;&t; */
id|vol
op_assign
(paren
id|v-&gt;velocity
op_star
id|v-&gt;expression_vol
op_star
id|v-&gt;main_vol
)paren
op_rshift
l_int|12
suffix:semicolon
macro_line|#ifdef HANDLE_LFO
multiline_comment|/*&n;&t; *&t;Handle LFO&n;&t; */
r_if
c_cond
(paren
id|devc-&gt;tremolomap
op_amp
(paren
l_int|1
op_lshift
id|voice
)paren
)paren
(brace
r_int
id|t
suffix:semicolon
id|t
op_assign
l_int|32768
op_minus
id|v-&gt;tremolo_level
suffix:semicolon
id|vol
op_assign
(paren
id|vol
op_star
id|t
)paren
op_rshift
l_int|15
suffix:semicolon
id|update_tremolo
c_func
(paren
id|voice
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; *&t;Envelope&n;&t; */
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_ENVELOPES
op_logical_and
op_logical_neg
id|v-&gt;percussive_voice
)paren
id|vol
op_assign
(paren
id|vol
op_star
(paren
id|v-&gt;envelope_vol
op_rshift
l_int|16
)paren
)paren
op_rshift
l_int|19
suffix:semicolon
r_else
id|vol
op_rshift_assign
l_int|4
suffix:semicolon
multiline_comment|/*&n;&t; * Handle panning&n;&t; */
r_if
c_cond
(paren
id|v-&gt;panning
OL
l_int|0
)paren
multiline_comment|/* Pan left */
id|v-&gt;rightvol
op_assign
(paren
id|vol
op_star
(paren
l_int|128
op_plus
id|v-&gt;panning
)paren
)paren
op_div
l_int|128
suffix:semicolon
r_else
id|v-&gt;rightvol
op_assign
id|vol
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;panning
OG
l_int|0
)paren
multiline_comment|/* Pan right */
id|v-&gt;leftvol
op_assign
(paren
id|vol
op_star
(paren
l_int|128
op_minus
id|v-&gt;panning
)paren
)paren
op_div
l_int|128
suffix:semicolon
r_else
id|v-&gt;leftvol
op_assign
id|vol
suffix:semicolon
)brace
DECL|function|step_envelope
r_static
r_void
id|step_envelope
c_func
(paren
r_int
id|voice
comma
r_int
id|do_release
comma
r_int
id|velocity
)paren
(brace
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
r_int
id|r
comma
id|rate
comma
id|time
comma
id|dif
suffix:semicolon
r_int
r_int
id|vol
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|voice_active
(braket
id|voice
)braket
op_logical_or
id|v-&gt;sample
op_eq
l_int|NULL
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|do_release
)paren
(brace
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_SUSTAIN_ON
op_logical_and
id|v-&gt;envelope_phase
op_eq
l_int|2
)paren
(brace
multiline_comment|/* Stop envelope until note off */
id|v-&gt;envelope_volstep
op_assign
l_int|0
suffix:semicolon
id|v-&gt;envelope_time
op_assign
l_int|0x7fffffff
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_VIBRATO
)paren
id|start_vibrato
c_func
(paren
id|voice
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_TREMOLO
)paren
id|start_tremolo
c_func
(paren
id|voice
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|do_release
)paren
id|v-&gt;envelope_phase
op_assign
l_int|3
suffix:semicolon
r_else
id|v-&gt;envelope_phase
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;envelope_phase
op_ge
l_int|5
)paren
multiline_comment|/* Finished */
(brace
id|init_voice
c_func
(paren
id|devc
comma
id|voice
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|vol
op_assign
id|v-&gt;envelope_target
op_assign
id|v-&gt;sample-&gt;env_offset
(braket
id|v-&gt;envelope_phase
)braket
op_lshift
l_int|22
suffix:semicolon
id|rate
op_assign
id|v-&gt;sample-&gt;env_rate
(braket
id|v-&gt;envelope_phase
)braket
suffix:semicolon
id|r
op_assign
l_int|3
op_minus
(paren
(paren
id|rate
op_rshift
l_int|6
)paren
op_amp
l_int|0x3
)paren
suffix:semicolon
id|r
op_mul_assign
l_int|3
suffix:semicolon
id|r
op_assign
(paren
r_int
)paren
(paren
id|rate
op_amp
l_int|0x3f
)paren
op_lshift
id|r
suffix:semicolon
id|rate
op_assign
(paren
(paren
(paren
id|r
op_star
l_int|44100
)paren
op_div
id|devc-&gt;speed
)paren
op_star
id|devc-&gt;control_rate
)paren
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
(paren
l_int|1
op_lshift
l_int|20
)paren
)paren
multiline_comment|/* Avoid infinitely &quot;releasing&quot; voices */
id|rate
op_assign
l_int|1
op_lshift
l_int|20
suffix:semicolon
id|dif
op_assign
(paren
id|v-&gt;envelope_vol
op_minus
id|vol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dif
OL
l_int|0
)paren
id|dif
op_mul_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dif
OL
id|rate
op_star
l_int|2
)paren
multiline_comment|/* Too close */
(brace
id|step_envelope
c_func
(paren
id|voice
comma
l_int|0
comma
l_int|60
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vol
OG
id|v-&gt;envelope_vol
)paren
(brace
id|v-&gt;envelope_volstep
op_assign
id|rate
suffix:semicolon
id|time
op_assign
(paren
id|vol
op_minus
id|v-&gt;envelope_vol
)paren
op_div
id|rate
suffix:semicolon
)brace
r_else
(brace
id|v-&gt;envelope_volstep
op_assign
op_minus
id|rate
suffix:semicolon
id|time
op_assign
(paren
id|v-&gt;envelope_vol
op_minus
id|vol
)paren
op_div
id|rate
suffix:semicolon
)brace
id|time
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|time
op_le
l_int|0
)paren
id|time
op_assign
l_int|1
suffix:semicolon
id|v-&gt;envelope_time
op_assign
id|time
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|step_envelope_lfo
r_static
r_void
id|step_envelope_lfo
c_func
(paren
r_int
id|voice
)paren
(brace
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Update pitch (vibrato) LFO &n;&t; */
r_if
c_cond
(paren
id|devc-&gt;vibratomap
op_amp
(paren
l_int|1
op_lshift
id|voice
)paren
)paren
id|update_vibrato
c_func
(paren
id|voice
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Update envelope&n;&t; */
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_ENVELOPES
)paren
(brace
id|v-&gt;envelope_vol
op_add_assign
id|v-&gt;envelope_volstep
suffix:semicolon
multiline_comment|/* Overshoot protection */
r_if
c_cond
(paren
id|v-&gt;envelope_vol
OL
l_int|0
)paren
(brace
id|v-&gt;envelope_vol
op_assign
id|v-&gt;envelope_target
suffix:semicolon
id|v-&gt;envelope_volstep
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v-&gt;envelope_time
op_decrement
op_le
l_int|0
)paren
(brace
id|v-&gt;envelope_vol
op_assign
id|v-&gt;envelope_target
suffix:semicolon
id|step_envelope
c_func
(paren
id|voice
comma
l_int|0
comma
l_int|60
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|compute_step
r_static
r_void
id|compute_step
c_func
(paren
r_int
id|voice
)paren
(brace
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Since the pitch bender may have been set before playing the note, we&n;&t; *&t;have to calculate the bending now.&n;&t; */
id|v-&gt;current_freq
op_assign
id|compute_finetune
c_func
(paren
id|v-&gt;orig_freq
comma
id|v-&gt;bender
comma
id|v-&gt;bender_range
comma
id|v-&gt;vibrato_level
)paren
suffix:semicolon
id|v-&gt;step
op_assign
(paren
(paren
(paren
id|v-&gt;current_freq
op_lshift
l_int|9
)paren
op_plus
(paren
id|devc-&gt;speed
op_rshift
l_int|1
)paren
)paren
op_div
id|devc-&gt;speed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_LOOP_BACK
)paren
id|v-&gt;step
op_mul_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Reversed playback */
)brace
DECL|function|init_voice
r_static
r_void
id|init_voice
c_func
(paren
id|softsyn_devc
op_star
id|devc
comma
r_int
id|voice
)paren
(brace
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|voice_active
(braket
id|voice
)braket
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;vibratomap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|voice
)paren
suffix:semicolon
id|devc-&gt;tremolomap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|voice
)paren
suffix:semicolon
id|v-&gt;mode
op_assign
l_int|0
suffix:semicolon
id|v-&gt;wave
op_assign
l_int|NULL
suffix:semicolon
id|v-&gt;sample
op_assign
l_int|NULL
suffix:semicolon
id|v-&gt;ptr
op_assign
l_int|0
suffix:semicolon
id|v-&gt;step
op_assign
l_int|0
suffix:semicolon
id|v-&gt;startloop
op_assign
l_int|0
suffix:semicolon
id|v-&gt;startbackloop
op_assign
l_int|0
suffix:semicolon
id|v-&gt;endloop
op_assign
l_int|0
suffix:semicolon
id|v-&gt;looplen
op_assign
l_int|0
suffix:semicolon
id|v-&gt;bender
op_assign
l_int|0
suffix:semicolon
id|v-&gt;bender_range
op_assign
l_int|200
suffix:semicolon
id|v-&gt;panning
op_assign
l_int|0
suffix:semicolon
id|v-&gt;main_vol
op_assign
l_int|127
suffix:semicolon
id|v-&gt;expression_vol
op_assign
l_int|127
suffix:semicolon
id|v-&gt;patch_vol
op_assign
l_int|127
suffix:semicolon
id|v-&gt;percussive_voice
op_assign
l_int|0
suffix:semicolon
id|v-&gt;sustain_mode
op_assign
l_int|0
suffix:semicolon
id|v-&gt;envelope_phase
op_assign
l_int|1
suffix:semicolon
id|v-&gt;envelope_vol
op_assign
l_int|1
op_lshift
l_int|24
suffix:semicolon
id|v-&gt;envelope_volstep
op_assign
l_int|256
suffix:semicolon
id|v-&gt;envelope_time
op_assign
l_int|0
suffix:semicolon
id|v-&gt;vibrato_phase
op_assign
l_int|0
suffix:semicolon
id|v-&gt;vibrato_step
op_assign
l_int|0
suffix:semicolon
id|v-&gt;vibrato_level
op_assign
l_int|0
suffix:semicolon
id|v-&gt;vibrato_rate
op_assign
l_int|0
suffix:semicolon
id|v-&gt;vibrato_depth
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_phase
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_step
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_level
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_rate
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_depth
op_assign
l_int|0
suffix:semicolon
id|voice_alloc-&gt;map
(braket
id|voice
)braket
op_assign
l_int|0
suffix:semicolon
id|voice_alloc-&gt;alloc_times
(braket
id|voice
)braket
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|reset_samples
r_static
r_void
id|reset_samples
c_func
(paren
id|softsyn_devc
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_VOICE
suffix:semicolon
id|i
op_increment
)paren
id|voice_active
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devc-&gt;maxvoice
suffix:semicolon
id|i
op_increment
)paren
(brace
id|init_voice
c_func
(paren
id|devc
comma
id|i
)paren
suffix:semicolon
id|softoss_voices
(braket
id|i
)braket
dot
id|instr
op_assign
l_int|0
suffix:semicolon
)brace
id|devc-&gt;ram_used
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PATCH
suffix:semicolon
id|i
op_increment
)paren
id|devc-&gt;programs
(braket
id|i
)braket
op_assign
id|NO_SAMPLE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devc-&gt;nrsamples
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vfree
c_func
(paren
id|devc-&gt;samples
(braket
id|i
)braket
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|devc-&gt;wave
(braket
id|i
)braket
)paren
suffix:semicolon
id|devc-&gt;samples
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|devc-&gt;wave
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|devc-&gt;nrsamples
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|init_engine
r_static
r_void
id|init_engine
c_func
(paren
id|softsyn_devc
op_star
id|devc
)paren
(brace
r_int
id|i
comma
id|fz
comma
id|srate
comma
id|sz
op_assign
id|devc-&gt;channels
suffix:semicolon
id|set_max_voices
c_func
(paren
id|devc-&gt;default_max_voices
)paren
suffix:semicolon
id|voice_alloc-&gt;timestamp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;bits
op_eq
l_int|16
)paren
id|sz
op_mul_assign
l_int|2
suffix:semicolon
id|fz
op_assign
id|devc-&gt;fragsize
op_div
id|sz
suffix:semicolon
multiline_comment|/* Samples per fragment */
id|devc-&gt;samples_per_fragment
op_assign
id|fz
suffix:semicolon
id|devc-&gt;usecs
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;usecs_per_frag
op_assign
(paren
l_int|1000000
op_star
id|fz
)paren
op_div
id|devc-&gt;speed
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devc-&gt;maxvoice
suffix:semicolon
id|i
op_increment
)paren
(brace
id|init_voice
c_func
(paren
id|devc
comma
id|i
)paren
suffix:semicolon
id|softoss_voices
(braket
id|i
)braket
dot
id|instr
op_assign
l_int|0
suffix:semicolon
)brace
id|devc-&gt;engine_state
op_assign
id|ES_STOPPED
suffix:semicolon
multiline_comment|/*&n;&t; *    Initialize delay&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DELAY_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|left_delay
(braket
id|i
)braket
op_assign
id|right_delay
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|delayp
op_assign
l_int|0
suffix:semicolon
id|srate
op_assign
(paren
id|devc-&gt;speed
op_div
l_int|10000
)paren
suffix:semicolon
multiline_comment|/* 1 to 4 */
r_if
c_cond
(paren
id|srate
op_le
l_int|0
)paren
id|srate
op_assign
l_int|1
suffix:semicolon
id|devc-&gt;delay_size
op_assign
(paren
id|DELAY_SIZE
op_star
id|srate
)paren
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;delay_size
op_eq
l_int|0
op_logical_or
id|devc-&gt;delay_size
OG
id|DELAY_SIZE
)paren
id|devc-&gt;delay_size
op_assign
id|DELAY_SIZE
suffix:semicolon
)brace
DECL|function|softsyn_control_loop
r_void
id|softsyn_control_loop
c_func
(paren
r_void
)paren
(brace
r_int
id|voice
suffix:semicolon
multiline_comment|/*&n;&t; *    Recompute envlope, LFO, etc.&n;&t; */
r_for
c_loop
(paren
id|voice
op_assign
l_int|0
suffix:semicolon
id|voice
OL
id|devc-&gt;maxvoice
suffix:semicolon
id|voice
op_increment
)paren
(brace
r_if
c_cond
(paren
id|voice_active
(braket
id|voice
)braket
)paren
(brace
id|update_volume
c_func
(paren
id|voice
)paren
suffix:semicolon
id|step_envelope_lfo
c_func
(paren
id|voice
)paren
suffix:semicolon
)brace
r_else
id|voice_alloc-&gt;map
(braket
id|voice
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_void
id|start_engine
c_func
(paren
id|softsyn_devc
op_star
id|devc
)paren
suffix:semicolon
DECL|function|do_resample
r_static
r_void
id|do_resample
c_func
(paren
r_int
id|dummy
)paren
(brace
r_struct
id|dma_buffparms
op_star
id|dmap
op_assign
id|audio_devs
(braket
id|devc-&gt;audiodev
)braket
op_member_access_from_pointer
id|dmap_out
suffix:semicolon
r_struct
id|voice_info
op_star
id|vinfo
suffix:semicolon
r_int
r_int
id|flags
comma
id|jif
suffix:semicolon
r_int
id|voice
comma
id|loops
suffix:semicolon
r_int
op_star
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|softsynth_disabled
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_running
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SoftOSS: Playback overrun&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|jif
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|jif
op_eq
id|last_resample_jiffies
)paren
(brace
r_if
c_cond
(paren
id|resample_counter
op_increment
OG
l_int|50
)paren
(brace
r_for
c_loop
(paren
id|voice
op_assign
l_int|0
suffix:semicolon
id|voice
OL
id|devc-&gt;maxvoice
suffix:semicolon
id|voice
op_increment
)paren
id|init_voice
c_func
(paren
id|devc
comma
id|voice
)paren
suffix:semicolon
id|voice_limit
op_decrement
suffix:semicolon
id|resample_counter
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SoftOSS: CPU overload. Limiting # of voices to %d&bslash;n&quot;
comma
id|voice_limit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|voice_limit
OL
l_int|10
)paren
(brace
id|voice_limit
op_assign
l_int|10
suffix:semicolon
id|devc-&gt;speed
op_assign
(paren
id|devc-&gt;speed
op_star
l_int|2
)paren
op_div
l_int|3
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SoftOSS: Dropping sampling rate and stopping the device.&bslash;n&quot;
)paren
suffix:semicolon
id|softsynth_disabled
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|last_resample_jiffies
op_assign
id|jif
suffix:semicolon
id|resample_counter
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* is_running = 1; */
r_if
c_cond
(paren
id|dmap-&gt;qlen
OG
id|devc-&gt;max_playahead
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SoftOSS: audio buffers full&bslash;n&quot;
)paren
suffix:semicolon
id|is_running
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * First verify that all active voices are valid (do this just once per block).&n;&t; */
r_for
c_loop
(paren
id|voice
op_assign
l_int|0
suffix:semicolon
id|voice
OL
id|devc-&gt;maxvoice
suffix:semicolon
id|voice
op_increment
)paren
(brace
r_if
c_cond
(paren
id|voice_active
(braket
id|voice
)braket
)paren
(brace
r_int
id|ptr
suffix:semicolon
id|vinfo
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
id|ptr
op_assign
id|vinfo-&gt;ptr
op_rshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|vinfo-&gt;wave
op_eq
l_int|NULL
op_logical_or
id|ptr
template_param
id|vinfo-&gt;sample-&gt;len
)paren
id|init_voice
c_func
(paren
id|devc
comma
id|voice
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|vinfo-&gt;mode
op_amp
id|WAVE_LOOPING
)paren
op_logical_and
(paren
id|vinfo-&gt;ptr
op_plus
id|vinfo-&gt;step
)paren
OG
id|vinfo-&gt;endloop
)paren
id|voice_active
(braket
id|voice
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *    Start the resampling process&n;&t; */
id|loops
op_assign
id|devc-&gt;samples_per_fragment
suffix:semicolon
id|buf
op_assign
(paren
r_int
op_star
)paren
(paren
id|dmap-&gt;raw_buf
op_plus
(paren
id|dmap-&gt;qtail
op_star
id|dmap-&gt;fragment_size
)paren
)paren
suffix:semicolon
id|softsynth_resample_loop
c_func
(paren
id|buf
comma
id|loops
)paren
suffix:semicolon
multiline_comment|/* In Xsoftsynth_rs.c */
id|dmap-&gt;qtail
op_assign
(paren
id|dmap-&gt;qtail
op_plus
l_int|1
)paren
op_mod
id|dmap-&gt;nbufs
suffix:semicolon
id|dmap-&gt;qlen
op_increment
suffix:semicolon
id|dmap-&gt;user_counter
op_add_assign
id|dmap-&gt;fragment_size
suffix:semicolon
id|devc-&gt;usecs
op_add_assign
id|devc-&gt;usecs_per_frag
suffix:semicolon
r_if
c_cond
(paren
id|tmr_running
)paren
id|sound_timer_interrupt
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *    Execute timer&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|tmr_running
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;usecs
op_ge
id|devc-&gt;next_event_usecs
)paren
(brace
id|devc-&gt;next_event_usecs
op_assign
op_complement
l_int|0
suffix:semicolon
id|sequencer_timer
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|is_running
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|delayed_resample
r_static
r_void
id|delayed_resample
c_func
(paren
r_int
id|dummy
)paren
(brace
r_struct
id|dma_buffparms
op_star
id|dmap
op_assign
id|audio_devs
(braket
id|devc-&gt;audiodev
)braket
op_member_access_from_pointer
id|dmap_out
suffix:semicolon
r_int
id|n
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|is_running
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|devc-&gt;engine_state
op_ne
id|ES_STOPPED
op_logical_and
id|dmap-&gt;qlen
OL
id|devc-&gt;max_playahead
op_logical_and
id|n
op_increment
OL
l_int|2
)paren
id|do_resample
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|intr_pending
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef POLLED_MODE
DECL|function|softsyn_poll
r_static
r_void
id|softsyn_poll
c_func
(paren
r_int
r_int
id|dummy
)paren
(brace
id|delayed_resample
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;engine_state
op_ne
id|ES_STOPPED
)paren
(brace
id|poll_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|poll_timer
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
DECL|function|softsyn_callback
r_static
r_void
id|softsyn_callback
c_func
(paren
r_int
id|dev
comma
r_int
id|parm
)paren
(brace
id|delayed_resample
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|start_engine
r_static
r_void
id|start_engine
c_func
(paren
id|softsyn_devc
op_star
id|devc
)paren
(brace
r_struct
id|dma_buffparms
op_star
id|dmap
suffix:semicolon
r_int
id|trig
comma
id|n
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|devc-&gt;audio_opened
)paren
r_if
c_cond
(paren
id|softsyn_open
c_func
(paren
id|devc-&gt;synthdev
comma
l_int|0
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;audiodev
op_ge
id|num_audiodevs
)paren
r_return
suffix:semicolon
id|dmap
op_assign
id|audio_devs
(braket
id|devc-&gt;audiodev
)braket
op_member_access_from_pointer
id|dmap_out
suffix:semicolon
id|devc-&gt;usecs
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;next_event_usecs
op_assign
op_complement
l_int|0
suffix:semicolon
id|devc-&gt;control_rate
op_assign
l_int|64
suffix:semicolon
id|devc-&gt;control_counter
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;engine_state
op_eq
id|ES_STOPPED
)paren
(brace
id|n
op_assign
id|trig
op_assign
l_int|0
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|dma_ioctl
c_func
(paren
id|devc-&gt;audiodev
comma
id|SNDCTL_DSP_SETTRIGGER
comma
(paren
id|caddr_t
)paren
op_amp
id|trig
)paren
suffix:semicolon
macro_line|#ifdef POLLED_MODE
id|poll_timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|poll_timer
)paren
suffix:semicolon
multiline_comment|/* Start polling */
macro_line|#else
id|dmap-&gt;audio_callback
op_assign
id|softsyn_callback
suffix:semicolon
id|dmap-&gt;qhead
op_assign
id|dmap-&gt;qtail
op_assign
id|dmap-&gt;qlen
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|dmap-&gt;qlen
OL
id|devc-&gt;max_playahead
op_logical_and
id|n
op_increment
OL
l_int|2
)paren
id|do_resample
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|devc-&gt;engine_state
op_assign
id|ES_STARTED
suffix:semicolon
id|last_resample_jiffies
op_assign
id|jiffies
suffix:semicolon
id|resample_counter
op_assign
l_int|0
suffix:semicolon
id|trig
op_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
r_if
c_cond
(paren
id|dma_ioctl
c_func
(paren
id|devc-&gt;audiodev
comma
id|SNDCTL_DSP_SETTRIGGER
comma
(paren
id|caddr_t
)paren
op_amp
id|trig
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SoftOSS: Trigger failed&bslash;n&quot;
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
)brace
DECL|function|stop_engine
r_static
r_void
id|stop_engine
c_func
(paren
id|softsyn_devc
op_star
id|devc
)paren
(brace
)brace
DECL|function|request_engine
r_static
r_void
id|request_engine
c_func
(paren
id|softsyn_devc
op_star
id|devc
comma
r_int
id|ticks
)paren
(brace
r_if
c_cond
(paren
id|ticks
OL
l_int|0
)paren
multiline_comment|/* Relative time */
id|devc-&gt;next_event_usecs
op_assign
id|devc-&gt;usecs
op_minus
id|ticks
op_star
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
r_else
id|devc-&gt;next_event_usecs
op_assign
id|ticks
op_star
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Softsync hook serves mode1 (timing) calls made by sequencer.c&n; */
DECL|function|softsynth_hook
r_static
r_int
id|softsynth_hook
c_func
(paren
r_int
id|cmd
comma
r_int
id|parm1
comma
r_int
id|parm2
comma
r_int
r_int
id|parm3
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SSYN_START
suffix:colon
id|start_engine
c_func
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SSYN_STOP
suffix:colon
id|stop_engine
c_func
(paren
id|devc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SSYN_REQUEST
suffix:colon
id|request_engine
c_func
(paren
id|devc
comma
id|parm1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SSYN_GETTIME
suffix:colon
r_return
id|devc-&gt;usecs
op_div
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SoftOSS: Unknown request %d&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|softsyn_ioctl
r_static
r_int
id|softsyn_ioctl
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDCTL_SYNTH_INFO
suffix:colon
id|softsyn_info.nr_voices
op_assign
id|devc-&gt;maxvoice
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|softsyn_info
comma
r_sizeof
(paren
id|softsyn_info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_SEQ_RESETSAMPLES
suffix:colon
id|stop_engine
c_func
(paren
id|devc
)paren
suffix:semicolon
id|reset_samples
c_func
(paren
id|devc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_SYNTH_MEMAVL
suffix:colon
r_return
id|devc-&gt;ram_size
op_minus
id|devc-&gt;ram_used
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|softsyn_kill_note
r_static
r_int
id|softsyn_kill_note
c_func
(paren
r_int
id|devno
comma
r_int
id|voice
comma
r_int
id|note
comma
r_int
id|velocity
)paren
(brace
r_if
c_cond
(paren
id|voice
template_param
id|devc-&gt;maxvoice
)paren
r_return
l_int|0
suffix:semicolon
id|voice_alloc-&gt;map
(braket
id|voice
)braket
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* Releasing */
r_if
c_cond
(paren
id|softoss_voices
(braket
id|voice
)braket
dot
id|sustain_mode
op_amp
l_int|1
)paren
multiline_comment|/* Sustain controller on */
(brace
id|softoss_voices
(braket
id|voice
)braket
dot
id|sustain_mode
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Note off pending */
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|velocity
OG
l_int|127
op_logical_or
id|softoss_voices
(braket
id|voice
)braket
dot
id|mode
op_amp
id|WAVE_FAST_RELEASE
)paren
(brace
id|init_voice
c_func
(paren
id|devc
comma
id|voice
)paren
suffix:semicolon
multiline_comment|/* Mark it inactive */
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|softoss_voices
(braket
id|voice
)braket
dot
id|mode
op_amp
id|WAVE_ENVELOPES
)paren
id|step_envelope
c_func
(paren
id|voice
comma
l_int|1
comma
id|velocity
)paren
suffix:semicolon
multiline_comment|/* Enter sustain phase */
r_else
id|init_voice
c_func
(paren
id|devc
comma
id|voice
)paren
suffix:semicolon
multiline_comment|/* Mark it inactive */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|softsyn_set_instr
r_static
r_int
id|softsyn_set_instr
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|instr
)paren
(brace
r_if
c_cond
(paren
id|voice
template_param
id|devc-&gt;maxvoice
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|instr
template_param
id|MAX_PATCH
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SoftOSS: Invalid instrument number %d&bslash;n&quot;
comma
id|instr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|softoss_voices
(braket
id|voice
)braket
dot
id|instr
op_assign
id|instr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|softsyn_start_note
r_static
r_int
id|softsyn_start_note
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|note
comma
r_int
id|volume
)paren
(brace
r_int
id|instr
op_assign
l_int|0
suffix:semicolon
r_int
id|best_sample
comma
id|best_delta
comma
id|delta_freq
comma
id|selected
suffix:semicolon
r_int
r_int
id|note_freq
comma
id|freq
comma
id|base_note
comma
id|flags
suffix:semicolon
id|voice_info
op_star
id|v
op_assign
op_amp
id|softoss_voices
(braket
id|voice
)braket
suffix:semicolon
r_struct
id|patch_info
op_star
id|sample
suffix:semicolon
r_if
c_cond
(paren
id|voice
template_param
id|devc-&gt;maxvoice
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|volume
op_eq
l_int|0
)paren
multiline_comment|/* Actually note off */
id|softsyn_kill_note
c_func
(paren
id|dev
comma
id|voice
comma
id|note
comma
id|volume
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|note
op_eq
l_int|255
)paren
(brace
multiline_comment|/* Just volume update */
id|v-&gt;velocity
op_assign
id|volume
suffix:semicolon
r_if
c_cond
(paren
id|voice_active
(braket
id|voice
)braket
)paren
id|update_volume
c_func
(paren
id|voice
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|voice_active
(braket
id|voice
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Stop the voice for a while */
id|devc-&gt;vibratomap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|voice
)paren
suffix:semicolon
id|devc-&gt;tremolomap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|voice
)paren
suffix:semicolon
id|instr
op_assign
id|v-&gt;instr
suffix:semicolon
r_if
c_cond
(paren
id|instr
template_param
id|MAX_PATCH
op_logical_or
id|devc-&gt;programs
(braket
id|instr
)braket
op_eq
id|NO_SAMPLE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SoftOSS: Undefined MIDI instrument %d&bslash;n&quot;
comma
id|instr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|instr
op_assign
id|devc-&gt;programs
(braket
id|instr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|instr
OL
l_int|0
op_logical_or
id|instr
op_ge
id|devc-&gt;nrsamples
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SoftOSS: Corrupted MIDI instrument %d (%d)&bslash;n&quot;
comma
id|v-&gt;instr
comma
id|instr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|note_freq
op_assign
id|note_to_freq
c_func
(paren
id|note
)paren
suffix:semicolon
id|selected
op_assign
op_minus
l_int|1
suffix:semicolon
id|best_sample
op_assign
id|instr
suffix:semicolon
id|best_delta
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
id|instr
op_ne
id|NO_SAMPLE
op_logical_and
id|instr
op_ge
l_int|0
op_logical_and
id|selected
op_eq
op_minus
l_int|1
)paren
(brace
id|delta_freq
op_assign
id|note_freq
op_minus
id|devc-&gt;samples
(braket
id|instr
)braket
op_member_access_from_pointer
id|base_note
suffix:semicolon
r_if
c_cond
(paren
id|delta_freq
OL
l_int|0
)paren
id|delta_freq
op_assign
op_minus
id|delta_freq
suffix:semicolon
r_if
c_cond
(paren
id|delta_freq
OL
id|best_delta
)paren
(brace
id|best_sample
op_assign
id|instr
suffix:semicolon
id|best_delta
op_assign
id|delta_freq
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;samples
(braket
id|instr
)braket
op_member_access_from_pointer
id|low_note
op_le
id|note_freq
op_logical_and
id|note_freq
op_le
id|devc-&gt;samples
(braket
id|instr
)braket
op_member_access_from_pointer
id|high_note
)paren
(brace
id|selected
op_assign
id|instr
suffix:semicolon
)brace
r_else
id|instr
op_assign
id|devc-&gt;samples
(braket
id|instr
)braket
op_member_access_from_pointer
id|key
suffix:semicolon
multiline_comment|/* Link to next sample */
r_if
c_cond
(paren
id|instr
OL
l_int|0
op_logical_or
id|instr
op_ge
id|devc-&gt;nrsamples
)paren
id|instr
op_assign
id|NO_SAMPLE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|selected
op_eq
op_minus
l_int|1
)paren
id|instr
op_assign
id|best_sample
suffix:semicolon
r_else
id|instr
op_assign
id|selected
suffix:semicolon
r_if
c_cond
(paren
id|instr
template_param
id|devc-&gt;nrsamples
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SoftOSS: Unresolved MIDI instrument %d&bslash;n&quot;
comma
id|v-&gt;instr
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sample
op_assign
id|devc-&gt;samples
(braket
id|instr
)braket
suffix:semicolon
id|v-&gt;sample
op_assign
id|sample
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;percussive_voice
)paren
multiline_comment|/* No key tracking */
id|v-&gt;orig_freq
op_assign
id|sample-&gt;base_freq
suffix:semicolon
multiline_comment|/* Fixed pitch */
r_else
(brace
id|base_note
op_assign
id|sample-&gt;base_note
op_div
l_int|100
suffix:semicolon
id|note_freq
op_div_assign
l_int|100
suffix:semicolon
id|freq
op_assign
id|sample-&gt;base_freq
op_star
id|note_freq
op_div
id|base_note
suffix:semicolon
id|v-&gt;orig_freq
op_assign
id|freq
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sample-&gt;mode
op_amp
id|WAVE_LOOPING
)paren
)paren
id|sample-&gt;loop_end
op_assign
id|sample-&gt;len
suffix:semicolon
id|v-&gt;wave
op_assign
id|devc-&gt;wave
(braket
id|instr
)braket
suffix:semicolon
r_if
c_cond
(paren
id|volume
OL
l_int|0
)paren
id|volume
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|volume
OG
l_int|127
)paren
id|volume
op_assign
l_int|127
suffix:semicolon
id|v-&gt;ptr
op_assign
l_int|0
suffix:semicolon
id|v-&gt;startloop
op_assign
id|sample-&gt;loop_start
op_star
l_int|512
suffix:semicolon
id|v-&gt;startbackloop
op_assign
l_int|0
suffix:semicolon
id|v-&gt;endloop
op_assign
id|sample-&gt;loop_end
op_star
l_int|512
suffix:semicolon
id|v-&gt;looplen
op_assign
(paren
id|sample-&gt;loop_end
op_minus
id|sample-&gt;loop_start
)paren
op_star
l_int|512
suffix:semicolon
id|v-&gt;leftvol
op_assign
l_int|64
suffix:semicolon
id|v-&gt;rightvol
op_assign
l_int|64
suffix:semicolon
id|v-&gt;patch_vol
op_assign
id|sample-&gt;volume
suffix:semicolon
id|v-&gt;velocity
op_assign
id|volume
suffix:semicolon
id|v-&gt;mode
op_assign
id|sample-&gt;mode
suffix:semicolon
id|v-&gt;vibrato_phase
op_assign
l_int|0
suffix:semicolon
id|v-&gt;vibrato_step
op_assign
l_int|0
suffix:semicolon
id|v-&gt;vibrato_level
op_assign
l_int|0
suffix:semicolon
id|v-&gt;vibrato_rate
op_assign
l_int|0
suffix:semicolon
id|v-&gt;vibrato_depth
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_phase
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_step
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_level
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_rate
op_assign
l_int|0
suffix:semicolon
id|v-&gt;tremolo_depth
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|v-&gt;mode
op_amp
id|WAVE_LOOPING
)paren
)paren
id|v-&gt;mode
op_and_assign
op_complement
(paren
id|WAVE_BIDIR_LOOP
op_or
id|WAVE_LOOP_BACK
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_LOOP_BACK
)paren
(brace
id|v-&gt;ptr
op_assign
id|sample-&gt;len
suffix:semicolon
id|v-&gt;startbackloop
op_assign
id|v-&gt;startloop
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_VIBRATO
)paren
(brace
id|v-&gt;vibrato_rate
op_assign
id|sample-&gt;vibrato_rate
suffix:semicolon
id|v-&gt;vibrato_depth
op_assign
id|sample-&gt;vibrato_depth
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_TREMOLO
)paren
(brace
id|v-&gt;tremolo_rate
op_assign
id|sample-&gt;tremolo_rate
suffix:semicolon
id|v-&gt;tremolo_depth
op_assign
id|sample-&gt;tremolo_depth
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v-&gt;mode
op_amp
id|WAVE_ENVELOPES
)paren
(brace
id|v-&gt;envelope_phase
op_assign
op_minus
l_int|1
suffix:semicolon
id|v-&gt;envelope_vol
op_assign
l_int|0
suffix:semicolon
id|step_envelope
c_func
(paren
id|voice
comma
l_int|0
comma
l_int|60
)paren
suffix:semicolon
)brace
id|update_volume
c_func
(paren
id|voice
)paren
suffix:semicolon
id|compute_step
c_func
(paren
id|voice
)paren
suffix:semicolon
id|voice_active
(braket
id|voice
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Mark it active */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|softsyn_open
r_static
r_int
id|softsyn_open
c_func
(paren
r_int
id|synthdev
comma
r_int
id|mode
)paren
(brace
r_int
id|err
suffix:semicolon
r_extern
r_int
id|softoss_dev
suffix:semicolon
r_int
id|frags
op_assign
l_int|0x7fff0007
suffix:semicolon
multiline_comment|/* fragment size of 128 bytes */
id|mm_segment_t
id|fs
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;audio_opened
)paren
multiline_comment|/* Already opened */
r_return
l_int|0
suffix:semicolon
id|softsynth_disabled
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;finfo.f_mode
op_assign
id|FMODE_WRITE
suffix:semicolon
id|devc-&gt;finfo.f_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|softoss_dev
op_ge
id|num_audiodevs
)paren
id|softoss_dev
op_assign
id|num_audiodevs
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|softoss_dev
OL
l_int|0
)paren
id|softoss_dev
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|softoss_dev
op_ge
id|num_audiodevs
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|devc-&gt;audiodev
op_assign
id|softoss_dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|audio_devs
(braket
id|devc-&gt;audiodev
)braket
op_member_access_from_pointer
id|format_mask
op_amp
id|AFMT_S16_LE
)paren
)paren
(brace
multiline_comment|/*&t;&t;printk(KERN_ERR &quot;SoftOSS: The audio device doesn&squot;t support 16 bits&bslash;n&quot;); */
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|audio_open
c_func
(paren
(paren
id|devc-&gt;audiodev
op_lshift
l_int|4
)paren
op_or
id|SND_DEV_DSP16
comma
op_amp
id|devc-&gt;finfo
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|devc-&gt;speed
op_assign
id|audio_devs
(braket
id|devc-&gt;audiodev
)braket
op_member_access_from_pointer
id|d
op_member_access_from_pointer
id|set_speed
c_func
(paren
id|devc-&gt;audiodev
comma
id|devc-&gt;speed
)paren
suffix:semicolon
id|devc-&gt;channels
op_assign
id|audio_devs
(braket
id|devc-&gt;audiodev
)braket
op_member_access_from_pointer
id|d
op_member_access_from_pointer
id|set_channels
c_func
(paren
id|devc-&gt;audiodev
comma
id|devc-&gt;channels
)paren
suffix:semicolon
id|devc-&gt;bits
op_assign
id|audio_devs
(braket
id|devc-&gt;audiodev
)braket
op_member_access_from_pointer
id|d
op_member_access_from_pointer
id|set_bits
c_func
(paren
id|devc-&gt;audiodev
comma
id|devc-&gt;bits
)paren
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;SoftOSS: Using audio dev %d, speed %d, bits %d, channels %d&bslash;n&quot;
comma
id|devc-&gt;audiodev
comma
id|devc-&gt;speed
comma
id|devc-&gt;bits
comma
id|devc-&gt;channels
)paren
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|dma_ioctl
c_func
(paren
id|devc-&gt;audiodev
comma
id|SNDCTL_DSP_SETFRAGMENT
comma
(paren
id|caddr_t
)paren
op_amp
id|frags
)paren
suffix:semicolon
id|dma_ioctl
c_func
(paren
id|devc-&gt;audiodev
comma
id|SNDCTL_DSP_GETBLKSIZE
comma
(paren
id|caddr_t
)paren
op_amp
id|devc-&gt;fragsize
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;bits
op_ne
l_int|16
op_logical_or
id|devc-&gt;channels
op_ne
l_int|2
)paren
(brace
id|audio_release
c_func
(paren
(paren
id|devc-&gt;audiodev
op_lshift
l_int|4
)paren
op_or
id|SND_DEV_DSP16
comma
op_amp
id|devc-&gt;finfo
)paren
suffix:semicolon
multiline_comment|/*&t;&t;printk(&quot;SoftOSS: A 16 bit stereo sound card is required&bslash;n&quot;);*/
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;max_playahead
op_ge
id|audio_devs
(braket
id|devc-&gt;audiodev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;nbufs
)paren
id|devc-&gt;max_playahead
op_assign
id|audio_devs
(braket
id|devc-&gt;audiodev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;nbufs
suffix:semicolon
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;SoftOSS: Using %d fragments of %d bytes&bslash;n&quot;
comma
id|devc-&gt;max_playahead
comma
id|devc-&gt;fragsize
)paren
)paren
suffix:semicolon
id|init_engine
c_func
(paren
id|devc
)paren
suffix:semicolon
id|devc-&gt;audio_opened
op_assign
l_int|1
suffix:semicolon
id|devc-&gt;sequencer_mode
op_assign
id|mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|softsyn_close
r_static
r_void
id|softsyn_close
c_func
(paren
r_int
id|synthdev
)paren
(brace
id|mm_segment_t
id|fs
suffix:semicolon
id|devc-&gt;engine_state
op_assign
id|ES_STOPPED
suffix:semicolon
macro_line|#ifdef POLLED_MODE
id|del_timer
c_func
(paren
op_amp
id|poll_timer
)paren
suffix:semicolon
macro_line|#endif
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|dma_ioctl
c_func
(paren
id|devc-&gt;audiodev
comma
id|SNDCTL_DSP_RESET
comma
l_int|0
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;audio_opened
)paren
id|audio_release
c_func
(paren
(paren
id|devc-&gt;audiodev
op_lshift
l_int|4
)paren
op_or
id|SND_DEV_DSP16
comma
op_amp
id|devc-&gt;finfo
)paren
suffix:semicolon
id|devc-&gt;audio_opened
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|softsyn_hw_control
r_static
r_void
id|softsyn_hw_control
c_func
(paren
r_int
id|dev
comma
r_int
r_char
op_star
id|event_rec
)paren
(brace
r_int
id|voice
comma
id|cmd
suffix:semicolon
r_int
r_int
id|p1
comma
id|p2
suffix:semicolon
r_int
r_int
id|plong
suffix:semicolon
id|cmd
op_assign
id|event_rec
(braket
l_int|2
)braket
suffix:semicolon
id|voice
op_assign
id|event_rec
(braket
l_int|3
)braket
suffix:semicolon
id|p1
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|event_rec
(braket
l_int|4
)braket
suffix:semicolon
id|p2
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|event_rec
(braket
l_int|6
)braket
suffix:semicolon
id|plong
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|event_rec
(braket
l_int|4
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|_GUS_NUMVOICES
suffix:colon
id|set_max_voices
c_func
(paren
id|p1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
)brace
DECL|function|softsyn_load_patch
r_static
r_int
id|softsyn_load_patch
c_func
(paren
r_int
id|dev
comma
r_int
id|format
comma
r_const
r_char
op_star
id|addr
comma
r_int
id|offs
comma
r_int
id|count
comma
r_int
id|pmgr_flag
)paren
(brace
r_struct
id|patch_info
op_star
id|patch
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|p
comma
id|instr
suffix:semicolon
r_int
id|sizeof_patch
suffix:semicolon
r_int
id|memlen
comma
id|adj
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
r_int
op_star
id|wave
op_assign
l_int|NULL
suffix:semicolon
id|sizeof_patch
op_assign
(paren
r_int
)paren
op_amp
id|patch-&gt;data
(braket
l_int|0
)braket
op_minus
(paren
r_int
)paren
id|patch
suffix:semicolon
multiline_comment|/* Header size */
r_if
c_cond
(paren
id|format
op_ne
id|GUS_PATCH
)paren
(brace
multiline_comment|/*&t;&t;printk(KERN_ERR &quot;SoftOSS: Invalid patch format (key) 0x%x&bslash;n&quot;, format);*/
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
id|sizeof_patch
)paren
(brace
multiline_comment|/*&t;&t;printk(KERN_ERR &quot;SoftOSS: Patch header too short&bslash;n&quot;);*/
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|count
op_sub_assign
id|sizeof_patch
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;nrsamples
op_ge
id|MAX_SAMPLE
)paren
(brace
multiline_comment|/*&t;&t;  printk(KERN_ERR &quot;SoftOSS: Sample table full&bslash;n&quot;);*/
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Copy the header from user space but ignore the first bytes which have&n;&t; * been transferred already.&n;&t; */
id|patch
op_assign
id|vmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|patch
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|patch
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&t;&t;printk(KERN_ERR &quot;SoftOSS: Out of memory&bslash;n&quot;);*/
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
(paren
(paren
r_char
op_star
)paren
id|patch
)paren
(braket
id|offs
)braket
comma
op_amp
(paren
id|addr
)paren
(braket
id|offs
)braket
comma
id|sizeof_patch
op_minus
id|offs
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|patch-&gt;mode
op_amp
id|WAVE_ROM
)paren
(brace
id|vfree
c_func
(paren
id|patch
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|instr
op_assign
id|patch-&gt;instr_no
suffix:semicolon
r_if
c_cond
(paren
id|instr
template_param
id|MAX_PATCH
)paren
(brace
multiline_comment|/*&t;&t;printk(KERN_ERR &quot;SoftOSS: Invalid patch number %d&bslash;n&quot;, instr);*/
id|vfree
c_func
(paren
id|patch
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
id|patch-&gt;len
)paren
(brace
multiline_comment|/*&t;&t;printk(KERN_ERR &quot;SoftOSS: Patch record too short (%d&lt;%d)&bslash;n&quot;, count, (int) patch-&gt;len);*/
id|patch-&gt;len
op_assign
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|patch-&gt;len
op_le
l_int|0
op_logical_or
id|patch-&gt;len
OG
(paren
id|devc-&gt;ram_size
op_minus
id|devc-&gt;ram_used
)paren
)paren
(brace
multiline_comment|/*&t;&t;printk(KERN_ERR &quot;SoftOSS: Invalid sample length %d&bslash;n&quot;, (int) patch-&gt;len); */
id|vfree
c_func
(paren
id|patch
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|patch-&gt;mode
op_amp
id|WAVE_LOOPING
)paren
(brace
r_if
c_cond
(paren
id|patch-&gt;loop_start
OL
l_int|0
op_logical_or
id|patch-&gt;loop_start
op_ge
id|patch-&gt;len
)paren
(brace
multiline_comment|/*&t;&t;&t;printk(KERN_ERR &quot;SoftOSS: Invalid loop start %d&bslash;n&quot;, patch-&gt;loop_start);*/
id|vfree
c_func
(paren
id|patch
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|patch-&gt;loop_end
template_param
id|patch-&gt;len
)paren
(brace
multiline_comment|/*&t;&t;&t;printk(KERN_ERR &quot;SoftOSS: Invalid loop start or end point (%d, %d)&bslash;n&quot;, patch-&gt;loop_start, patch-&gt;loop_end);*/
id|vfree
c_func
(paren
id|patch
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* &n;&t; *&t;Next load the wave data to memory&n;&t; */
id|memlen
op_assign
id|patch-&gt;len
suffix:semicolon
id|adj
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|patch-&gt;mode
op_amp
id|WAVE_16_BITS
)paren
)paren
id|memlen
op_mul_assign
l_int|2
suffix:semicolon
r_else
id|adj
op_assign
l_int|2
suffix:semicolon
id|wave
op_assign
id|vmalloc
c_func
(paren
id|memlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wave
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&t;&t;printk(KERN_ERR &quot;SoftOSS: Can&squot;t allocate %d bytes of mem for a sample&bslash;n&quot;, memlen);*/
id|vfree
c_func
(paren
id|patch
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|p
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|memlen
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Handle words */
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|data
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|patch-&gt;mode
op_amp
id|WAVE_16_BITS
)paren
(brace
id|get_user
c_func
(paren
op_star
(paren
r_int
r_char
op_star
)paren
op_amp
id|tmp
comma
(paren
r_int
r_char
op_star
)paren
op_amp
(paren
(paren
id|addr
)paren
(braket
id|sizeof_patch
op_plus
id|p
op_increment
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* Get lsb */
id|data
op_assign
id|tmp
suffix:semicolon
id|get_user
c_func
(paren
op_star
(paren
r_int
r_char
op_star
)paren
op_amp
id|tmp
comma
(paren
r_int
r_char
op_star
)paren
op_amp
(paren
(paren
id|addr
)paren
(braket
id|sizeof_patch
op_plus
id|p
op_increment
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* Get msb */
r_if
c_cond
(paren
id|patch-&gt;mode
op_amp
id|WAVE_UNSIGNED
)paren
id|tmp
op_xor_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Convert to signed */
id|data
op_or_assign
(paren
id|tmp
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|get_user
c_func
(paren
op_star
(paren
r_int
r_char
op_star
)paren
op_amp
id|tmp
comma
(paren
r_int
r_char
op_star
)paren
op_amp
(paren
(paren
id|addr
)paren
(braket
id|sizeof_patch
op_plus
id|p
op_increment
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|patch-&gt;mode
op_amp
id|WAVE_UNSIGNED
)paren
id|tmp
op_xor_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* Convert to signed */
id|data
op_assign
(paren
id|tmp
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Convert to 16 bits */
)brace
id|wave
(braket
id|i
)braket
op_assign
(paren
r_int
)paren
id|data
suffix:semicolon
)brace
id|devc-&gt;ram_used
op_add_assign
id|patch-&gt;len
suffix:semicolon
multiline_comment|/*&n;&t; * Convert pointers to 16 bit indexes&n;&t; */
id|patch-&gt;len
op_div_assign
id|adj
suffix:semicolon
id|patch-&gt;loop_start
op_div_assign
id|adj
suffix:semicolon
id|patch-&gt;loop_end
op_div_assign
id|adj
suffix:semicolon
multiline_comment|/*&n;&t; * Finally link the loaded patch to the chain&n;&t; */
id|patch-&gt;key
op_assign
id|devc-&gt;programs
(braket
id|instr
)braket
suffix:semicolon
id|devc-&gt;programs
(braket
id|instr
)braket
op_assign
id|devc-&gt;nrsamples
suffix:semicolon
id|devc-&gt;wave
(braket
id|devc-&gt;nrsamples
)braket
op_assign
(paren
r_int
op_star
)paren
id|wave
suffix:semicolon
id|devc-&gt;samples
(braket
id|devc-&gt;nrsamples
op_increment
)braket
op_assign
id|patch
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|softsyn_panning
r_static
r_void
id|softsyn_panning
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|pan
)paren
(brace
r_if
c_cond
(paren
id|voice
template_param
id|devc-&gt;maxvoice
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pan
OL
op_minus
l_int|128
)paren
id|pan
op_assign
op_minus
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|pan
OG
l_int|127
)paren
id|pan
op_assign
l_int|127
suffix:semicolon
id|softoss_voices
(braket
id|voice
)braket
dot
id|panning
op_assign
id|pan
suffix:semicolon
r_if
c_cond
(paren
id|voice_active
(braket
id|voice
)braket
)paren
id|update_volume
c_func
(paren
id|voice
)paren
suffix:semicolon
)brace
DECL|function|softsyn_volume_method
r_static
r_void
id|softsyn_volume_method
c_func
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
)brace
DECL|function|softsyn_aftertouch
r_static
r_void
id|softsyn_aftertouch
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|pressure
)paren
(brace
r_if
c_cond
(paren
id|voice
template_param
id|devc-&gt;maxvoice
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|voice_active
(braket
id|voice
)braket
)paren
id|update_volume
c_func
(paren
id|voice
)paren
suffix:semicolon
)brace
DECL|function|softsyn_controller
r_static
r_void
id|softsyn_controller
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|ctrl_num
comma
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|voice
template_param
id|devc-&gt;maxvoice
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ctrl_num
)paren
(brace
r_case
id|CTRL_PITCH_BENDER
suffix:colon
id|softoss_voices
(braket
id|voice
)braket
dot
id|bender
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|voice_active
(braket
id|voice
)braket
)paren
id|compute_step
c_func
(paren
id|voice
)paren
suffix:semicolon
multiline_comment|/* Update pitch */
r_break
suffix:semicolon
r_case
id|CTRL_PITCH_BENDER_RANGE
suffix:colon
id|softoss_voices
(braket
id|voice
)braket
dot
id|bender_range
op_assign
id|value
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTL_EXPRESSION
suffix:colon
id|value
op_div_assign
l_int|128
suffix:semicolon
r_case
id|CTRL_EXPRESSION
suffix:colon
id|softoss_voices
(braket
id|voice
)braket
dot
id|expression_vol
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|voice_active
(braket
id|voice
)braket
)paren
id|update_volume
c_func
(paren
id|voice
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTL_PAN
suffix:colon
id|softsyn_panning
c_func
(paren
id|dev
comma
id|voice
comma
(paren
id|value
op_star
l_int|2
)paren
op_minus
l_int|128
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTL_MAIN_VOLUME
suffix:colon
id|value
op_assign
(paren
id|value
op_star
l_int|100
)paren
op_div
l_int|16383
suffix:semicolon
r_case
id|CTRL_MAIN_VOLUME
suffix:colon
id|softoss_voices
(braket
id|voice
)braket
dot
id|main_vol
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|voice_active
(braket
id|voice
)braket
)paren
id|update_volume
c_func
(paren
id|voice
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|softsyn_bender
r_static
r_void
id|softsyn_bender
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|value
)paren
(brace
r_if
c_cond
(paren
id|voice
template_param
id|devc-&gt;maxvoice
)paren
r_return
suffix:semicolon
id|softoss_voices
(braket
id|voice
)braket
dot
id|bender
op_assign
id|value
op_minus
l_int|8192
suffix:semicolon
r_if
c_cond
(paren
id|voice_active
(braket
id|voice
)braket
)paren
id|compute_step
c_func
(paren
id|voice
)paren
suffix:semicolon
multiline_comment|/* Update pitch */
)brace
DECL|function|softsyn_alloc_voice
r_static
r_int
id|softsyn_alloc_voice
c_func
(paren
r_int
id|dev
comma
r_int
id|chn
comma
r_int
id|note
comma
r_struct
id|voice_alloc_info
op_star
id|alloc
)paren
(brace
r_int
id|i
comma
id|p
comma
id|best
op_assign
op_minus
l_int|1
comma
id|best_time
op_assign
l_int|0x7fffffff
suffix:semicolon
id|p
op_assign
id|alloc-&gt;ptr
suffix:semicolon
multiline_comment|/*&n;&t; * First look for a completely stopped voice&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|alloc-&gt;max_voice
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|alloc-&gt;map
(braket
id|p
)braket
op_eq
l_int|0
)paren
(brace
id|alloc-&gt;ptr
op_assign
id|p
suffix:semicolon
id|voice_active
(braket
id|p
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
r_if
c_cond
(paren
id|alloc-&gt;alloc_times
(braket
id|p
)braket
OL
id|best_time
)paren
(brace
id|best
op_assign
id|p
suffix:semicolon
id|best_time
op_assign
id|alloc-&gt;alloc_times
(braket
id|p
)braket
suffix:semicolon
)brace
id|p
op_assign
(paren
id|p
op_plus
l_int|1
)paren
op_mod
id|alloc-&gt;max_voice
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Then look for a releasing voice&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|alloc-&gt;max_voice
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|alloc-&gt;map
(braket
id|p
)braket
op_eq
l_int|0xffff
)paren
(brace
id|alloc-&gt;ptr
op_assign
id|p
suffix:semicolon
id|voice_active
(braket
id|p
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
id|p
op_assign
(paren
id|p
op_plus
l_int|1
)paren
op_mod
id|alloc-&gt;max_voice
suffix:semicolon
)brace
r_if
c_cond
(paren
id|best
op_ge
l_int|0
)paren
id|p
op_assign
id|best
suffix:semicolon
id|alloc-&gt;ptr
op_assign
id|p
suffix:semicolon
id|voice_active
(braket
id|p
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
DECL|function|softsyn_setup_voice
r_static
r_void
id|softsyn_setup_voice
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|chn
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|channel_info
op_star
id|info
op_assign
op_amp
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|chn_info
(braket
id|chn
)braket
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* init_voice(devc, voice); */
id|softsyn_set_instr
c_func
(paren
id|dev
comma
id|voice
comma
id|info-&gt;pgm_num
)paren
suffix:semicolon
id|softoss_voices
(braket
id|voice
)braket
dot
id|expression_vol
op_assign
id|info-&gt;controllers
(braket
id|CTL_EXPRESSION
)braket
suffix:semicolon
multiline_comment|/* Just MSB */
id|softoss_voices
(braket
id|voice
)braket
dot
id|main_vol
op_assign
(paren
id|info-&gt;controllers
(braket
id|CTL_MAIN_VOLUME
)braket
op_star
l_int|100
)paren
op_div
(paren
r_int
)paren
l_int|128
suffix:semicolon
id|softsyn_panning
c_func
(paren
id|dev
comma
id|voice
comma
(paren
id|info-&gt;controllers
(braket
id|CTL_PAN
)braket
op_star
l_int|2
)paren
op_minus
l_int|128
)paren
suffix:semicolon
id|softoss_voices
(braket
id|voice
)braket
dot
id|bender
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* info-&gt;bender_value; */
id|softoss_voices
(braket
id|voice
)braket
dot
id|bender_range
op_assign
id|info-&gt;bender_range
suffix:semicolon
r_if
c_cond
(paren
id|chn
op_eq
l_int|9
)paren
id|softoss_voices
(braket
id|voice
)braket
dot
id|percussive_voice
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|softsyn_reset
r_static
r_void
id|softsyn_reset
c_func
(paren
r_int
id|devno
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devc-&gt;maxvoice
suffix:semicolon
id|i
op_increment
)paren
id|init_voice
c_func
(paren
id|devc
comma
id|i
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|softsyn_operations
r_static
r_struct
id|synth_operations
id|softsyn_operations
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|id
suffix:colon
l_string|&quot;SoftOSS&quot;
comma
id|info
suffix:colon
op_amp
id|softsyn_info
comma
id|midi_dev
suffix:colon
l_int|0
comma
id|synth_type
suffix:colon
id|SYNTH_TYPE_SAMPLE
comma
id|synth_subtype
suffix:colon
l_int|0
comma
id|open
suffix:colon
id|softsyn_open
comma
id|close
suffix:colon
id|softsyn_close
comma
id|ioctl
suffix:colon
id|softsyn_ioctl
comma
id|kill_note
suffix:colon
id|softsyn_kill_note
comma
id|start_note
suffix:colon
id|softsyn_start_note
comma
id|set_instr
suffix:colon
id|softsyn_set_instr
comma
id|reset
suffix:colon
id|softsyn_reset
comma
id|hw_control
suffix:colon
id|softsyn_hw_control
comma
id|load_patch
suffix:colon
id|softsyn_load_patch
comma
id|aftertouch
suffix:colon
id|softsyn_aftertouch
comma
id|controller
suffix:colon
id|softsyn_controller
comma
id|panning
suffix:colon
id|softsyn_panning
comma
id|volume_method
suffix:colon
id|softsyn_volume_method
comma
id|bender
suffix:colon
id|softsyn_bender
comma
id|alloc_voice
suffix:colon
id|softsyn_alloc_voice
comma
id|setup_voice
suffix:colon
id|softsyn_setup_voice
)brace
suffix:semicolon
multiline_comment|/*&n; * Timer stuff (for /dev/music).&n; */
DECL|function|soft_tmr_start
r_static
r_int
r_int
id|soft_tmr_start
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|usecs
)paren
(brace
id|tmr_running
op_assign
l_int|1
suffix:semicolon
id|start_engine
c_func
(paren
id|devc
)paren
suffix:semicolon
r_return
id|devc-&gt;usecs_per_frag
suffix:semicolon
)brace
DECL|function|soft_tmr_disable
r_static
r_void
id|soft_tmr_disable
c_func
(paren
r_int
id|dev
)paren
(brace
id|stop_engine
c_func
(paren
id|devc
)paren
suffix:semicolon
id|tmr_running
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|soft_tmr_restart
r_static
r_void
id|soft_tmr_restart
c_func
(paren
r_int
id|dev
)paren
(brace
id|tmr_running
op_assign
l_int|1
suffix:semicolon
)brace
DECL|variable|soft_tmr
r_static
r_struct
id|sound_lowlev_timer
id|soft_tmr
op_assign
(brace
l_int|0
comma
l_int|9999
comma
id|soft_tmr_start
comma
id|soft_tmr_disable
comma
id|soft_tmr_restart
)brace
suffix:semicolon
DECL|function|probe_softsyn
r_static
r_int
id|__init
id|probe_softsyn
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|softsynth_loaded
)paren
r_return
l_int|0
suffix:semicolon
id|devc-&gt;ram_size
op_assign
l_int|8
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
id|devc-&gt;ram_used
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;nrsamples
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PATCH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|devc-&gt;programs
(braket
id|i
)braket
op_assign
id|NO_SAMPLE
suffix:semicolon
id|devc-&gt;wave
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|devc-&gt;maxvoice
op_assign
id|DEFAULT_VOICES
suffix:semicolon
id|devc-&gt;audiodev
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;audio_opened
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;channels
op_assign
l_int|2
suffix:semicolon
id|devc-&gt;bits
op_assign
l_int|16
suffix:semicolon
id|devc-&gt;max_playahead
op_assign
l_int|32
suffix:semicolon
macro_line|#ifdef CONFIG_SOFTOSS_RATE
id|devc-&gt;speed
op_assign
id|CONFIG_SOFTOSS_RATE
suffix:semicolon
macro_line|#else
id|devc-&gt;speed
op_assign
l_int|32000
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SOFTOSS_VOICES
id|devc-&gt;default_max_voices
op_assign
id|CONFIG_SOFTOSS_VOICES
suffix:semicolon
macro_line|#else
id|devc-&gt;default_max_voices
op_assign
l_int|32
suffix:semicolon
macro_line|#endif
id|softsynth_loaded
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|attach_softsyn_card
r_static
r_void
id|__init
id|attach_softsyn_card
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|voice_alloc
op_assign
op_amp
id|softsyn_operations.alloc
suffix:semicolon
id|synth_devs
(braket
id|devc-&gt;synthdev
op_assign
id|num_synths
op_increment
)braket
op_assign
op_amp
id|softsyn_operations
suffix:semicolon
id|sequencer_init
c_func
(paren
)paren
suffix:semicolon
id|sound_timer_init
c_func
(paren
op_amp
id|soft_tmr
comma
l_string|&quot;SoftOSS&quot;
)paren
suffix:semicolon
id|devc-&gt;timerdev
op_assign
id|num_sound_timers
suffix:semicolon
id|softsynthp
op_assign
id|softsynth_hook
suffix:semicolon
macro_line|#ifndef POLLED_MODE
macro_line|#endif
)brace
DECL|function|unload_softsyn
r_static
r_void
id|__exit
id|unload_softsyn
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|softsynth_loaded
)paren
r_return
suffix:semicolon
id|softsynthp
op_assign
l_int|NULL
suffix:semicolon
id|softsynth_loaded
op_assign
l_int|0
suffix:semicolon
id|reset_samples
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
DECL|variable|cfg
r_static
r_struct
id|address_info
id|cfg
suffix:semicolon
DECL|function|init_softoss
r_static
r_int
id|__init
id|init_softoss
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SoftOSS driver Copyright (C) by Hannu Savolainen 1993-1997&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|probe_softsyn
c_func
(paren
op_amp
id|cfg
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|attach_softsyn_card
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_softoss
r_static
r_void
id|__exit
id|cleanup_softoss
c_func
(paren
r_void
)paren
(brace
id|unload_softsyn
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
id|sound_unload_synthdev
c_func
(paren
id|devc-&gt;synthdev
)paren
suffix:semicolon
id|sound_unload_timerdev
c_func
(paren
id|devc-&gt;timerdev
)paren
suffix:semicolon
)brace
DECL|variable|init_softoss
id|module_init
c_func
(paren
id|init_softoss
)paren
suffix:semicolon
DECL|variable|cleanup_softoss
id|module_exit
c_func
(paren
id|cleanup_softoss
)paren
suffix:semicolon
eof
