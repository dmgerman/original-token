multiline_comment|/*&n; * Support for VIA 82Cxxx Audio Codecs&n; * Copyright 1999 Jeff Garzik &lt;jgarzik@pobox.com&gt;&n; *&n; * Distributed under the GNU GENERAL PUBLIC LICENSE (GPL) Version 2.&n; * See the &quot;COPYING&quot; file distributed with this software for more info.&n; *&n; ********************************************************************&n; *&n; * TODO:&n; *&n; *&t;- Integrate AC&squot;97 support, when AC&squot;97 interface released&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;soundmodule.h&quot;
macro_line|#include &quot;sb.h&quot;
macro_line|#ifndef SOUND_LOCK
DECL|macro|SOUND_LOCK
mdefine_line|#define SOUND_LOCK do {} while (0)
DECL|macro|SOUND_LOCK_END
mdefine_line|#define SOUND_LOCK_END do {} while (0)
macro_line|#endif
DECL|macro|MAX_CARDS
mdefine_line|#define MAX_CARDS&t;2
DECL|macro|PFX
mdefine_line|#define PFX&t;&t;&quot;via82cxxx: &quot;
DECL|macro|VIA_VERSION
mdefine_line|#define VIA_VERSION&t;&quot;1.0.0&quot;
DECL|macro|VIA_CARD_NAME
mdefine_line|#define VIA_CARD_NAME&t;&quot;VIA 82Cxxx Audio driver &quot; VIA_VERSION
DECL|macro|VIA_FUNC_ENABLE
mdefine_line|#define VIA_FUNC_ENABLE&t;&t;0x42
DECL|macro|VIA_PNP_CONTROL
mdefine_line|#define VIA_PNP_CONTROL&t;&t;0x43
DECL|macro|VIA_CR42_SB_ENABLE
mdefine_line|#define VIA_CR42_SB_ENABLE&t;0x01
DECL|macro|VIA_CR42_MIDI_ENABLE
mdefine_line|#define VIA_CR42_MIDI_ENABLE&t;0x02
DECL|macro|VIA_CR42_FM_ENABLE
mdefine_line|#define VIA_CR42_FM_ENABLE&t;0x04
DECL|macro|via_probe_midi
mdefine_line|#define via_probe_midi probe_uart401
DECL|macro|via_attach_midi
mdefine_line|#define via_attach_midi attach_uart401
DECL|macro|via_unload_midi
mdefine_line|#define via_unload_midi unload_uart401
DECL|variable|sb_data
r_static
r_struct
id|address_info
id|sb_data
(braket
id|MAX_CARDS
)braket
suffix:semicolon
DECL|variable|opl3_data
r_static
r_struct
id|address_info
id|opl3_data
(braket
id|MAX_CARDS
)braket
suffix:semicolon
DECL|variable|cards
r_static
r_int
id|cards
op_assign
l_int|0
suffix:semicolon
DECL|function|via_attach_sb
r_static
r_void
id|__init
id|via_attach_sb
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_init
c_func
(paren
id|hw_config
)paren
)paren
(brace
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|via_probe_sb
r_static
r_int
id|__init
id|via_probe_sb
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;SBPro port 0x%x is already in use&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|sb_dsp_detect
c_func
(paren
id|hw_config
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|via_unload_sb
r_static
r_void
id|__exit
id|via_unload_sb
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
comma
r_int
id|unload_mpu
)paren
(brace
r_if
c_cond
(paren
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_ne
op_minus
l_int|1
)paren
(brace
id|sb_dsp_unload
c_func
(paren
id|hw_config
comma
id|unload_mpu
)paren
suffix:semicolon
)brace
)brace
DECL|function|via82cxxx_install
r_static
r_int
id|__init
id|via82cxxx_install
(paren
r_struct
id|pci_dev
op_star
id|pcidev
)paren
(brace
r_int
id|sb_io_base
op_assign
l_int|0
suffix:semicolon
r_int
id|sb_irq
op_assign
l_int|0
suffix:semicolon
r_int
id|sb_dma
op_assign
l_int|0
suffix:semicolon
r_int
id|midi_base
op_assign
l_int|0
suffix:semicolon
id|u8
id|tmp8
suffix:semicolon
id|memset
(paren
op_amp
id|sb_data
(braket
id|cards
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|address_info
)paren
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|opl3_data
(braket
id|cards
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|address_info
)paren
)paren
suffix:semicolon
id|sb_data
(braket
id|cards
)braket
dot
id|name
op_assign
id|opl3_data
(braket
id|cards
)braket
dot
id|name
op_assign
id|VIA_CARD_NAME
suffix:semicolon
id|opl3_data
(braket
id|cards
)braket
dot
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* turn on features, if not already */
id|pci_read_config_byte
(paren
id|pcidev
comma
id|VIA_FUNC_ENABLE
comma
op_amp
id|tmp8
)paren
suffix:semicolon
id|tmp8
op_or_assign
id|VIA_CR42_SB_ENABLE
op_or
id|VIA_CR42_MIDI_ENABLE
op_or
id|VIA_CR42_FM_ENABLE
suffix:semicolon
id|pci_write_config_byte
(paren
id|pcidev
comma
id|VIA_FUNC_ENABLE
comma
id|tmp8
)paren
suffix:semicolon
multiline_comment|/* read legacy PNP info byte */
id|pci_read_config_byte
(paren
id|pcidev
comma
id|VIA_PNP_CONTROL
comma
op_amp
id|tmp8
)paren
suffix:semicolon
id|pci_write_config_byte
(paren
id|pcidev
comma
id|VIA_PNP_CONTROL
comma
id|tmp8
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|tmp8
op_rshift
l_int|6
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0
suffix:colon
id|sb_irq
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|sb_irq
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|sb_irq
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|sb_irq
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
(paren
id|tmp8
op_rshift
l_int|4
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0
suffix:colon
id|sb_dma
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|sb_dma
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|sb_dma
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|sb_dma
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
(paren
id|tmp8
op_rshift
l_int|2
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0
suffix:colon
id|midi_base
op_assign
l_int|0x300
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|midi_base
op_assign
l_int|0x310
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|midi_base
op_assign
l_int|0x320
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|midi_base
op_assign
l_int|0x330
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|tmp8
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0
suffix:colon
id|sb_io_base
op_assign
l_int|0x220
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|sb_io_base
op_assign
l_int|0x240
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|sb_io_base
op_assign
l_int|0x260
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|sb_io_base
op_assign
l_int|0x280
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;legacy &quot;
l_string|&quot;MIDI: 0x%X, SB: 0x%X / %d IRQ / %d DMA&bslash;n&quot;
comma
id|midi_base
comma
id|sb_io_base
comma
id|sb_irq
comma
id|sb_dma
)paren
suffix:semicolon
id|sb_data
(braket
id|cards
)braket
dot
id|card_subtype
op_assign
id|MDL_SBPRO
suffix:semicolon
id|sb_data
(braket
id|cards
)braket
dot
id|io_base
op_assign
id|sb_io_base
suffix:semicolon
id|sb_data
(braket
id|cards
)braket
dot
id|irq
op_assign
id|sb_irq
suffix:semicolon
id|sb_data
(braket
id|cards
)braket
dot
id|dma
op_assign
id|sb_dma
suffix:semicolon
id|opl3_data
(braket
id|cards
)braket
dot
id|io_base
op_assign
id|midi_base
suffix:semicolon
multiline_comment|/* register legacy SoundBlaster Pro */
r_if
c_cond
(paren
op_logical_neg
id|via_probe_sb
(paren
op_amp
id|sb_data
(braket
id|cards
)braket
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;SB probe @ 0x%X failed, aborting&bslash;n&quot;
comma
id|sb_io_base
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|via_attach_sb
(paren
op_amp
id|sb_data
(braket
id|cards
)braket
)paren
suffix:semicolon
multiline_comment|/* register legacy MIDI */
r_if
c_cond
(paren
op_logical_neg
id|via_probe_midi
(paren
op_amp
id|opl3_data
(braket
id|cards
)braket
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;MIDI probe @ 0x%X failed, aborting&bslash;n&quot;
comma
id|midi_base
)paren
suffix:semicolon
id|via_unload_sb
(paren
op_amp
id|sb_data
(braket
id|cards
)braket
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|via_attach_midi
(paren
op_amp
id|opl3_data
(braket
id|cards
)braket
)paren
suffix:semicolon
id|cards
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * &t;This loop walks the PCI configuration database and finds where&n; *&t;the sound cards are.&n; */
DECL|function|probe_via82cxxx
r_static
r_int
id|__init
id|probe_via82cxxx
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pcidev
op_assign
id|pci_find_device
(paren
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_82C686_5
comma
id|pcidev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|via82cxxx_install
(paren
id|pcidev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;audio init failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cards
op_eq
id|MAX_CARDS
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;maximum number of cards reached&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This function is called when the user or kernel loads the &n; *&t;module into memory.&n; */
DECL|function|init_via82cxxx_module
r_static
r_int
id|__init
id|init_via82cxxx_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pci_present
(paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;PCI not present, exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|probe_via82cxxx
c_func
(paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;probe failed, aborting&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX unload cards registered so far, if any */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cards
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;No chips found, aborting&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
id|PFX
id|VIA_CARD_NAME
l_string|&quot; loaded&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Binds us to the sound subsystem&t;&n;&t; */
id|SOUND_LOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This is called when it is removed. It will only be removed &n; *&t;when its use count is 0. For sound the SOUND_LOCK/SOUND_UNLOCK&n; *&t;macros hide the entire work for this.&n; */
DECL|function|cleanup_via82cxxx_module
r_static
r_void
id|__exit
id|cleanup_via82cxxx_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cards
suffix:semicolon
id|i
op_increment
)paren
id|via_unload_sb
(paren
op_amp
id|sb_data
(braket
id|i
)braket
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Final clean up with the sound layer&n;&t; */
id|SOUND_LOCK_END
suffix:semicolon
)brace
DECL|variable|init_via82cxxx_module
id|module_init
c_func
(paren
id|init_via82cxxx_module
)paren
suffix:semicolon
DECL|variable|cleanup_via82cxxx_module
id|module_exit
c_func
(paren
id|cleanup_via82cxxx_module
)paren
suffix:semicolon
eof
