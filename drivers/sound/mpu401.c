multiline_comment|/*&n; * sound/mpu401.c&n; *&n; * The low level driver for Roland MPU-401 compatible Midi cards.&n; */
multiline_comment|/*&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; *&n; *&n; * Thomas Sailer&t;ioctl code reworked (vmalloc/vfree removed)&n; * Alan Cox&t;&t;modularisation, use normal request_irq, use dev_id&n; * Bartlomiej Zolnierkiewicz&t;removed some __init to allow using many drivers&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|USE_SEQ_MACROS
mdefine_line|#define USE_SEQ_MACROS
DECL|macro|USE_SIMPLE_MACROS
mdefine_line|#define USE_SIMPLE_MACROS
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;coproc.h&quot;
macro_line|#include &quot;mpu401.h&quot;
DECL|variable|timer_mode
DECL|variable|timer_caps
r_static
r_int
id|timer_mode
op_assign
id|TMR_INTERNAL
comma
id|timer_caps
op_assign
id|TMR_INTERNAL
suffix:semicolon
DECL|struct|mpu_config
r_struct
id|mpu_config
(brace
DECL|member|base
r_int
id|base
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * I/O base&n;&t;&t;&t;&t; */
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|opened
r_int
id|opened
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Open mode&n;&t;&t;&t;&t; */
DECL|member|devno
r_int
id|devno
suffix:semicolon
DECL|member|synthno
r_int
id|synthno
suffix:semicolon
DECL|member|uart_mode
r_int
id|uart_mode
suffix:semicolon
DECL|member|initialized
r_int
id|initialized
suffix:semicolon
DECL|member|mode
r_int
id|mode
suffix:semicolon
DECL|macro|MODE_MIDI
mdefine_line|#define MODE_MIDI&t;1
DECL|macro|MODE_SYNTH
mdefine_line|#define MODE_SYNTH&t;2
DECL|member|version
DECL|member|revision
r_int
r_char
id|version
comma
id|revision
suffix:semicolon
DECL|member|capabilities
r_int
r_int
id|capabilities
suffix:semicolon
DECL|macro|MPU_CAP_INTLG
mdefine_line|#define MPU_CAP_INTLG&t;0x10000000
DECL|macro|MPU_CAP_SYNC
mdefine_line|#define MPU_CAP_SYNC&t;0x00000010
DECL|macro|MPU_CAP_FSK
mdefine_line|#define MPU_CAP_FSK&t;0x00000020
DECL|macro|MPU_CAP_CLS
mdefine_line|#define MPU_CAP_CLS&t;0x00000040
DECL|macro|MPU_CAP_SMPTE
mdefine_line|#define MPU_CAP_SMPTE &t;0x00000080
DECL|macro|MPU_CAP_2PORT
mdefine_line|#define MPU_CAP_2PORT&t;0x00000001
DECL|member|timer_flag
r_int
id|timer_flag
suffix:semicolon
DECL|macro|MBUF_MAX
mdefine_line|#define MBUF_MAX&t;10
DECL|macro|BUFTEST
mdefine_line|#define BUFTEST(dc) if (dc-&gt;m_ptr &gt;= MBUF_MAX || dc-&gt;m_ptr &lt; 0) &bslash;&n;&t;{printk( &quot;MPU: Invalid buffer pointer %d/%d, s=%d&bslash;n&quot;,  dc-&gt;m_ptr,  dc-&gt;m_left,  dc-&gt;m_state);dc-&gt;m_ptr--;}
DECL|member|m_busy
r_int
id|m_busy
suffix:semicolon
DECL|member|m_buf
r_int
r_char
id|m_buf
(braket
id|MBUF_MAX
)braket
suffix:semicolon
DECL|member|m_ptr
r_int
id|m_ptr
suffix:semicolon
DECL|member|m_state
r_int
id|m_state
suffix:semicolon
DECL|member|m_left
r_int
id|m_left
suffix:semicolon
DECL|member|last_status
r_int
r_char
id|last_status
suffix:semicolon
DECL|member|inputintr
r_void
(paren
op_star
id|inputintr
)paren
(paren
r_int
id|dev
comma
r_int
r_char
id|data
)paren
suffix:semicolon
DECL|member|shared_irq
r_int
id|shared_irq
suffix:semicolon
DECL|member|osp
r_int
op_star
id|osp
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|DATAPORT
mdefine_line|#define&t;DATAPORT(base)   (base)
DECL|macro|COMDPORT
mdefine_line|#define&t;COMDPORT(base)   (base+1)
DECL|macro|STATPORT
mdefine_line|#define&t;STATPORT(base)   (base+1)
DECL|function|mpu401_status
r_static
r_int
id|mpu401_status
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
)paren
(brace
r_return
id|inb
c_func
(paren
id|STATPORT
c_func
(paren
id|devc-&gt;base
)paren
)paren
suffix:semicolon
)brace
DECL|macro|input_avail
mdefine_line|#define input_avail(devc)&t;&t;(!(mpu401_status(devc)&amp;INPUT_AVAIL))
DECL|macro|output_ready
mdefine_line|#define output_ready(devc)&t;&t;(!(mpu401_status(devc)&amp;OUTPUT_READY))
DECL|function|write_command
r_static
r_void
id|write_command
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
comma
r_int
r_char
id|cmd
)paren
(brace
id|outb
c_func
(paren
id|cmd
comma
id|COMDPORT
c_func
(paren
id|devc-&gt;base
)paren
)paren
suffix:semicolon
)brace
DECL|function|read_data
r_static
r_int
id|read_data
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
)paren
(brace
r_return
id|inb
c_func
(paren
id|DATAPORT
c_func
(paren
id|devc-&gt;base
)paren
)paren
suffix:semicolon
)brace
DECL|function|write_data
r_static
r_void
id|write_data
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
comma
r_int
r_char
id|byte
)paren
(brace
id|outb
c_func
(paren
id|byte
comma
id|DATAPORT
c_func
(paren
id|devc-&gt;base
)paren
)paren
suffix:semicolon
)brace
DECL|macro|OUTPUT_READY
mdefine_line|#define&t;OUTPUT_READY&t;0x40
DECL|macro|INPUT_AVAIL
mdefine_line|#define&t;INPUT_AVAIL&t;0x80
DECL|macro|MPU_ACK
mdefine_line|#define&t;MPU_ACK&t;&t;0xFE
DECL|macro|MPU_RESET
mdefine_line|#define&t;MPU_RESET&t;0xFF
DECL|macro|UART_MODE_ON
mdefine_line|#define&t;UART_MODE_ON&t;0x3F
DECL|variable|dev_conf
r_static
r_struct
id|mpu_config
id|dev_conf
(braket
id|MAX_MIDI_DEV
)braket
op_assign
(brace
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|n_mpu_devs
r_static
r_int
id|n_mpu_devs
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|reset_mpu401
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
)paren
suffix:semicolon
r_static
r_void
id|set_uart_mode
c_func
(paren
r_int
id|dev
comma
r_struct
id|mpu_config
op_star
id|devc
comma
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mpu_timer_init
c_func
(paren
r_int
id|midi_dev
)paren
suffix:semicolon
r_static
r_void
id|mpu_timer_interrupt
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|timer_ext_event
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
comma
r_int
id|event
comma
r_int
id|parm
)paren
suffix:semicolon
DECL|variable|mpu_synth_info_proto
r_static
r_struct
id|synth_info
id|mpu_synth_info_proto
op_assign
(brace
l_string|&quot;MPU-401 MIDI interface&quot;
comma
l_int|0
comma
id|SYNTH_TYPE_MIDI
comma
id|MIDI_TYPE_MPU401
comma
l_int|0
comma
l_int|128
comma
l_int|0
comma
l_int|128
comma
id|SYNTH_CAP_INPUT
)brace
suffix:semicolon
DECL|variable|mpu_synth_info
r_static
r_struct
id|synth_info
id|mpu_synth_info
(braket
id|MAX_MIDI_DEV
)braket
suffix:semicolon
multiline_comment|/*&n; * States for the input scanner&n; */
DECL|macro|ST_INIT
mdefine_line|#define ST_INIT&t;&t;&t;0&t;/* Ready for timing byte or msg */
DECL|macro|ST_TIMED
mdefine_line|#define ST_TIMED&t;&t;1&t;/* Leading timing byte rcvd */
DECL|macro|ST_DATABYTE
mdefine_line|#define ST_DATABYTE&t;&t;2&t;/* Waiting for (nr_left) data bytes */
DECL|macro|ST_SYSMSG
mdefine_line|#define ST_SYSMSG&t;&t;100&t;/* System message (sysx etc). */
DECL|macro|ST_SYSEX
mdefine_line|#define ST_SYSEX&t;&t;101&t;/* System exclusive msg */
DECL|macro|ST_MTC
mdefine_line|#define ST_MTC&t;&t;&t;102&t;/* Midi Time Code (MTC) qframe msg */
DECL|macro|ST_SONGSEL
mdefine_line|#define ST_SONGSEL&t;&t;103&t;/* Song select */
DECL|macro|ST_SONGPOS
mdefine_line|#define ST_SONGPOS&t;&t;104&t;/* Song position pointer */
DECL|variable|len_tab
r_static
r_int
r_char
id|len_tab
(braket
)braket
op_assign
multiline_comment|/* # of data bytes following a status&n;&t;&t;&t;&t;&t; */
(brace
l_int|2
comma
multiline_comment|/* 8x */
l_int|2
comma
multiline_comment|/* 9x */
l_int|2
comma
multiline_comment|/* Ax */
l_int|2
comma
multiline_comment|/* Bx */
l_int|1
comma
multiline_comment|/* Cx */
l_int|1
comma
multiline_comment|/* Dx */
l_int|2
comma
multiline_comment|/* Ex */
l_int|0
multiline_comment|/* Fx */
)brace
suffix:semicolon
DECL|macro|STORE
mdefine_line|#define STORE(cmd) &bslash;&n;{ &bslash;&n;&t;int len; &bslash;&n;&t;unsigned char obuf[8]; &bslash;&n;&t;cmd; &bslash;&n;&t;seq_input_event(obuf, len); &bslash;&n;}
DECL|macro|_seqbuf
mdefine_line|#define _seqbuf obuf
DECL|macro|_seqbufptr
mdefine_line|#define _seqbufptr 0
DECL|macro|_SEQ_ADVBUF
mdefine_line|#define _SEQ_ADVBUF(x) len=x
DECL|function|mpu_input_scanner
r_static
r_int
id|mpu_input_scanner
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
comma
r_int
r_char
id|midic
)paren
(brace
r_switch
c_cond
(paren
id|devc-&gt;m_state
)paren
(brace
r_case
id|ST_INIT
suffix:colon
r_switch
c_cond
(paren
id|midic
)paren
(brace
r_case
l_int|0xf8
suffix:colon
multiline_comment|/* Timer overflow */
r_break
suffix:semicolon
r_case
l_int|0xfc
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&lt;all end&gt;&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xfd
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;timer_flag
)paren
id|mpu_timer_interrupt
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xfe
suffix:colon
r_return
id|MPU_ACK
suffix:semicolon
r_case
l_int|0xf0
suffix:colon
r_case
l_int|0xf1
suffix:colon
r_case
l_int|0xf2
suffix:colon
r_case
l_int|0xf3
suffix:colon
r_case
l_int|0xf4
suffix:colon
r_case
l_int|0xf5
suffix:colon
r_case
l_int|0xf6
suffix:colon
r_case
l_int|0xf7
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&lt;Trk data rq #%d&gt;&quot;
comma
id|midic
op_amp
l_int|0x0f
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf9
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&lt;conductor rq&gt;&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xff
suffix:colon
id|devc-&gt;m_state
op_assign
id|ST_SYSMSG
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|midic
op_le
l_int|0xef
)paren
(brace
multiline_comment|/* printk( &quot;mpu time: %d &quot;,  midic); */
id|devc-&gt;m_state
op_assign
id|ST_TIMED
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;&lt;MPU: Unknown event %02x&gt; &quot;
comma
id|midic
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ST_TIMED
suffix:colon
(brace
r_int
id|msg
op_assign
(paren
(paren
r_int
)paren
(paren
id|midic
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|devc-&gt;m_state
op_assign
id|ST_DATABYTE
suffix:semicolon
r_if
c_cond
(paren
id|msg
OL
l_int|8
)paren
multiline_comment|/* Data byte */
(brace
multiline_comment|/* printk( &quot;midi msg (running status) &quot;); */
id|msg
op_assign
(paren
(paren
r_int
)paren
(paren
id|devc-&gt;last_status
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|msg
op_sub_assign
l_int|8
suffix:semicolon
id|devc-&gt;m_left
op_assign
id|len_tab
(braket
id|msg
)braket
op_minus
l_int|1
suffix:semicolon
id|devc-&gt;m_ptr
op_assign
l_int|2
suffix:semicolon
id|devc-&gt;m_buf
(braket
l_int|0
)braket
op_assign
id|devc-&gt;last_status
suffix:semicolon
id|devc-&gt;m_buf
(braket
l_int|1
)braket
op_assign
id|midic
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;m_left
op_le
l_int|0
)paren
(brace
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|do_midi_msg
c_func
(paren
id|devc-&gt;synthno
comma
id|devc-&gt;m_buf
comma
id|devc-&gt;m_ptr
)paren
suffix:semicolon
id|devc-&gt;m_ptr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|msg
op_eq
l_int|0xf
)paren
multiline_comment|/* MPU MARK */
(brace
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
r_switch
c_cond
(paren
id|midic
)paren
(brace
r_case
l_int|0xf8
suffix:colon
multiline_comment|/* printk( &quot;NOP &quot;); */
r_break
suffix:semicolon
r_case
l_int|0xf9
suffix:colon
multiline_comment|/* printk( &quot;meas end &quot;); */
r_break
suffix:semicolon
r_case
l_int|0xfc
suffix:colon
multiline_comment|/* printk( &quot;data end &quot;); */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Unknown MPU mark %02x&bslash;n&quot;
comma
id|midic
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|devc-&gt;last_status
op_assign
id|midic
suffix:semicolon
multiline_comment|/* printk( &quot;midi msg &quot;); */
id|msg
op_sub_assign
l_int|8
suffix:semicolon
id|devc-&gt;m_left
op_assign
id|len_tab
(braket
id|msg
)braket
suffix:semicolon
id|devc-&gt;m_ptr
op_assign
l_int|1
suffix:semicolon
id|devc-&gt;m_buf
(braket
l_int|0
)braket
op_assign
id|midic
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;m_left
op_le
l_int|0
)paren
(brace
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|do_midi_msg
c_func
(paren
id|devc-&gt;synthno
comma
id|devc-&gt;m_buf
comma
id|devc-&gt;m_ptr
)paren
suffix:semicolon
id|devc-&gt;m_ptr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|ST_SYSMSG
suffix:colon
r_switch
c_cond
(paren
id|midic
)paren
(brace
r_case
l_int|0xf0
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&lt;SYX&gt;&quot;
)paren
suffix:semicolon
id|devc-&gt;m_state
op_assign
id|ST_SYSEX
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf1
suffix:colon
id|devc-&gt;m_state
op_assign
id|ST_MTC
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf2
suffix:colon
id|devc-&gt;m_state
op_assign
id|ST_SONGPOS
suffix:semicolon
id|devc-&gt;m_ptr
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf3
suffix:colon
id|devc-&gt;m_state
op_assign
id|ST_SONGSEL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf6
suffix:colon
multiline_comment|/* printk( &quot;tune_request&bslash;n&quot;); */
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; *    Real time messages&n;&t;&t;&t;&t;&t; */
r_case
l_int|0xf8
suffix:colon
multiline_comment|/* midi clock */
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|timer_ext_event
c_func
(paren
id|devc
comma
id|TMR_CLOCK
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xfA
suffix:colon
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|timer_ext_event
c_func
(paren
id|devc
comma
id|TMR_START
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xFB
suffix:colon
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|timer_ext_event
c_func
(paren
id|devc
comma
id|TMR_CONTINUE
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xFC
suffix:colon
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|timer_ext_event
c_func
(paren
id|devc
comma
id|TMR_STOP
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xFE
suffix:colon
multiline_comment|/* active sensing */
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xff
suffix:colon
multiline_comment|/* printk( &quot;midi hard reset&quot;); */
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;unknown MIDI sysmsg %0x&bslash;n&quot;
comma
id|midic
)paren
suffix:semicolon
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ST_MTC
suffix:colon
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MTC frame %x02&bslash;n&quot;
comma
id|midic
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_SYSEX
suffix:colon
r_if
c_cond
(paren
id|midic
op_eq
l_int|0xf7
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&lt;EOX&gt;&quot;
)paren
suffix:semicolon
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|midic
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_SONGPOS
suffix:colon
id|BUFTEST
c_func
(paren
id|devc
)paren
suffix:semicolon
id|devc-&gt;m_buf
(braket
id|devc-&gt;m_ptr
op_increment
)braket
op_assign
id|midic
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;m_ptr
op_eq
l_int|2
)paren
(brace
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|devc-&gt;m_ptr
op_assign
l_int|0
suffix:semicolon
id|timer_ext_event
c_func
(paren
id|devc
comma
id|TMR_SPP
comma
(paren
(paren
id|devc-&gt;m_buf
(braket
l_int|1
)braket
op_amp
l_int|0x7f
)paren
op_lshift
l_int|7
)paren
op_or
(paren
id|devc-&gt;m_buf
(braket
l_int|0
)braket
op_amp
l_int|0x7f
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ST_DATABYTE
suffix:colon
id|BUFTEST
c_func
(paren
id|devc
)paren
suffix:semicolon
id|devc-&gt;m_buf
(braket
id|devc-&gt;m_ptr
op_increment
)braket
op_assign
id|midic
suffix:semicolon
r_if
c_cond
(paren
(paren
op_decrement
id|devc-&gt;m_left
)paren
op_le
l_int|0
)paren
(brace
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|do_midi_msg
c_func
(paren
id|devc-&gt;synthno
comma
id|devc-&gt;m_buf
comma
id|devc-&gt;m_ptr
)paren
suffix:semicolon
id|devc-&gt;m_ptr
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Bad state %d &quot;
comma
id|devc-&gt;m_state
)paren
suffix:semicolon
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|mpu401_input_loop
r_static
r_void
id|mpu401_input_loop
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|busy
suffix:semicolon
r_int
id|n
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|busy
op_assign
id|devc-&gt;m_busy
suffix:semicolon
id|devc-&gt;m_busy
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busy
)paren
multiline_comment|/* Already inside the scanner */
r_return
suffix:semicolon
id|n
op_assign
l_int|50
suffix:semicolon
r_while
c_loop
(paren
id|input_avail
c_func
(paren
id|devc
)paren
op_logical_and
id|n
op_decrement
OG
l_int|0
)paren
(brace
r_int
r_char
id|c
op_assign
id|read_data
c_func
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;mode
op_eq
id|MODE_SYNTH
)paren
(brace
id|mpu_input_scanner
c_func
(paren
id|devc
comma
id|c
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|devc-&gt;opened
op_amp
id|OPEN_READ
op_logical_and
id|devc-&gt;inputintr
op_ne
l_int|NULL
)paren
id|devc
op_member_access_from_pointer
id|inputintr
c_func
(paren
id|devc-&gt;devno
comma
id|c
)paren
suffix:semicolon
)brace
id|devc-&gt;m_busy
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|intchk_mpu401
r_int
id|intchk_mpu401
c_func
(paren
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
r_int
id|dev
op_assign
(paren
r_int
)paren
id|dev_id
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|dev
)braket
suffix:semicolon
r_return
id|input_avail
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
DECL|function|mpuintr
r_void
id|mpuintr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
r_int
id|dev
op_assign
(paren
r_int
)paren
id|dev_id
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|input_avail
c_func
(paren
id|devc
)paren
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;base
op_ne
l_int|0
op_logical_and
(paren
id|devc-&gt;opened
op_amp
id|OPEN_READ
op_logical_or
id|devc-&gt;mode
op_eq
id|MODE_SYNTH
)paren
)paren
id|mpu401_input_loop
c_func
(paren
id|devc
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* Dummy read (just to acknowledge the interrupt) */
id|read_data
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|mpu401_open
r_static
r_int
id|mpu401_open
c_func
(paren
r_int
id|dev
comma
r_int
id|mode
comma
r_void
(paren
op_star
id|input
)paren
(paren
r_int
id|dev
comma
r_int
r_char
id|data
)paren
comma
r_void
(paren
op_star
id|output
)paren
(paren
r_int
id|dev
)paren
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_midis
op_logical_or
id|midi_devs
(braket
id|dev
)braket
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;opened
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/*&n;&t; *  Verify that the device is really running.&n;&t; *  Some devices (such as Ensoniq SoundScape don&squot;t&n;&t; *  work before the on board processor (OBP) is initialized&n;&t; *  by downloading its microcode.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|devc-&gt;initialized
)paren
(brace
r_if
c_cond
(paren
id|mpu401_status
c_func
(paren
id|devc
)paren
op_eq
l_int|0xff
)paren
multiline_comment|/* Bus float */
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mpu401: Device not initialized properly&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|reset_mpu401
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|coproc
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|coproc
op_member_access_from_pointer
id|open
c_func
(paren
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|coproc-&gt;devc
comma
id|COPR_MIDI
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;MPU-401: Can&squot;t access coprocessor device&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
id|set_uart_mode
c_func
(paren
id|dev
comma
id|devc
comma
l_int|1
)paren
suffix:semicolon
id|devc-&gt;mode
op_assign
id|MODE_MIDI
suffix:semicolon
id|devc-&gt;synthno
op_assign
l_int|0
suffix:semicolon
id|mpu401_input_loop
c_func
(paren
id|devc
)paren
suffix:semicolon
id|devc-&gt;inputintr
op_assign
id|input
suffix:semicolon
id|devc-&gt;opened
op_assign
id|mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mpu401_close
r_static
r_void
id|mpu401_close
c_func
(paren
r_int
id|dev
)paren
(brace
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;uart_mode
)paren
id|reset_mpu401
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * This disables the UART mode&n;&t;&t;&t;&t;&t; */
id|devc-&gt;mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;inputintr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|coproc
)paren
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|coproc
op_member_access_from_pointer
id|close
c_func
(paren
id|midi_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|coproc-&gt;devc
comma
id|COPR_MIDI
)paren
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|mpu401_out
r_static
r_int
id|mpu401_out
c_func
(paren
r_int
id|dev
comma
r_int
r_char
id|midi_byte
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|dev
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Sometimes it takes about 30000 loops before the output becomes ready&n;&t; * (After reset). Normally it takes just about 10 loops.&n;&t; */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|30000
suffix:semicolon
id|timeout
OG
l_int|0
op_logical_and
op_logical_neg
id|output_ready
c_func
(paren
id|devc
)paren
suffix:semicolon
id|timeout
op_decrement
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|output_ready
c_func
(paren
id|devc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Send data timeout&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|write_data
c_func
(paren
id|devc
comma
id|midi_byte
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|mpu401_command
r_static
r_int
id|mpu401_command
c_func
(paren
r_int
id|dev
comma
id|mpu_command_rec
op_star
id|cmd
)paren
(brace
r_int
id|i
comma
id|timeout
comma
id|ok
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;uart_mode
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * Not possible in UART mode&n;&t;&t;&t;&t; */
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: commands not possible in the UART mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Test for input since pending input seems to block the output.&n;&t; */
r_if
c_cond
(paren
id|input_avail
c_func
(paren
id|devc
)paren
)paren
id|mpu401_input_loop
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Sometimes it takes about 50000 loops before the output becomes ready&n;&t; * (After reset). Normally it takes just about 10 loops.&n;&t; */
id|timeout
op_assign
l_int|50000
suffix:semicolon
id|retry
suffix:colon
r_if
c_cond
(paren
id|timeout
op_decrement
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Command (0x%x) timeout&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmd-&gt;cmd
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|output_ready
c_func
(paren
id|devc
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
id|write_command
c_func
(paren
id|devc
comma
id|cmd-&gt;cmd
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|50000
suffix:semicolon
id|timeout
OG
l_int|0
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|input_avail
c_func
(paren
id|devc
)paren
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;opened
op_logical_and
id|devc-&gt;mode
op_eq
id|MODE_SYNTH
)paren
(brace
r_if
c_cond
(paren
id|mpu_input_scanner
c_func
(paren
id|devc
comma
id|read_data
c_func
(paren
id|devc
)paren
)paren
op_eq
id|MPU_ACK
)paren
id|ok
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Device is not currently open. Use simpler method */
r_if
c_cond
(paren
id|read_data
c_func
(paren
id|devc
)paren
op_eq
id|MPU_ACK
)paren
id|ok
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd-&gt;nr_args
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;nr_args
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|timeout
op_assign
l_int|3000
suffix:semicolon
id|timeout
OG
l_int|0
op_logical_and
op_logical_neg
id|output_ready
c_func
(paren
id|devc
)paren
suffix:semicolon
id|timeout
op_decrement
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mpu401_out
c_func
(paren
id|dev
comma
id|cmd-&gt;data
(braket
id|i
)braket
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Command (0x%x), parm send failed.&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmd-&gt;cmd
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|cmd-&gt;data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;nr_returns
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;nr_returns
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ok
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|5000
suffix:semicolon
id|timeout
OG
l_int|0
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|timeout
op_decrement
)paren
r_if
c_cond
(paren
id|input_avail
c_func
(paren
id|devc
)paren
)paren
(brace
id|cmd-&gt;data
(braket
id|i
)braket
op_assign
id|read_data
c_func
(paren
id|devc
)paren
suffix:semicolon
id|ok
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|mpu_cmd
r_static
r_int
id|mpu_cmd
c_func
(paren
r_int
id|dev
comma
r_int
id|cmd
comma
r_int
id|data
)paren
(brace
r_int
id|ret
suffix:semicolon
r_static
id|mpu_command_rec
id|rec
suffix:semicolon
id|rec.cmd
op_assign
id|cmd
op_amp
l_int|0xff
suffix:semicolon
id|rec.nr_args
op_assign
(paren
(paren
id|cmd
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xE0
)paren
suffix:semicolon
id|rec.nr_returns
op_assign
(paren
(paren
id|cmd
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xA0
)paren
suffix:semicolon
id|rec.data
(braket
l_int|0
)braket
op_assign
id|data
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mpu401_command
c_func
(paren
id|dev
comma
op_amp
id|rec
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_return
(paren
r_int
r_char
)paren
id|rec.data
(braket
l_int|0
)braket
suffix:semicolon
)brace
DECL|function|mpu401_prefix_cmd
r_static
r_int
id|mpu401_prefix_cmd
c_func
(paren
r_int
id|dev
comma
r_int
r_char
id|status
)paren
(brace
r_struct
id|mpu_config
op_star
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;uart_mode
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0xf0
)paren
(brace
r_if
c_cond
(paren
id|mpu_cmd
c_func
(paren
id|dev
comma
l_int|0xD0
comma
l_int|0
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
l_int|0xF0
suffix:colon
r_if
c_cond
(paren
id|mpu_cmd
c_func
(paren
id|dev
comma
l_int|0xDF
comma
l_int|0
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|mpu401_start_read
r_static
r_int
id|mpu401_start_read
c_func
(paren
r_int
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mpu401_end_read
r_static
r_int
id|mpu401_end_read
c_func
(paren
r_int
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mpu401_ioctl
r_static
r_int
id|mpu401_ioctl
c_func
(paren
r_int
id|dev
comma
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
id|mpu_command_rec
id|rec
suffix:semicolon
r_int
id|val
comma
id|ret
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|dev
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDCTL_MIDI_MPUMODE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;capabilities
op_amp
id|MPU_CAP_INTLG
)paren
)paren
(brace
multiline_comment|/* No intelligent mode */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Intelligent mode not supported by the HW&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|set_uart_mode
c_func
(paren
id|dev
comma
id|devc
comma
op_logical_neg
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_MIDI_MPUCMD
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|rec
comma
id|arg
comma
r_sizeof
(paren
id|rec
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mpu401_command
c_func
(paren
id|dev
comma
op_amp
id|rec
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|rec
comma
r_sizeof
(paren
id|rec
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|mpu401_kick
r_static
r_void
id|mpu401_kick
c_func
(paren
r_int
id|dev
)paren
(brace
)brace
DECL|function|mpu401_buffer_status
r_static
r_int
id|mpu401_buffer_status
c_func
(paren
r_int
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * No data in buffers&n;&t;&t;&t;&t; */
)brace
DECL|function|mpu_synth_ioctl
r_static
r_int
id|mpu_synth_ioctl
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
r_int
id|midi_dev
suffix:semicolon
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
id|midi_dev
op_assign
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|midi_dev
suffix:semicolon
r_if
c_cond
(paren
id|midi_dev
template_param
id|num_midis
op_logical_or
id|midi_devs
(braket
id|midi_dev
)braket
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|midi_dev
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDCTL_SYNTH_INFO
suffix:colon
id|memcpy
c_func
(paren
(paren
op_amp
(paren
(paren
r_char
op_star
)paren
id|arg
)paren
(braket
l_int|0
)braket
)paren
comma
(paren
r_char
op_star
)paren
op_amp
id|mpu_synth_info
(braket
id|midi_dev
)braket
comma
r_sizeof
(paren
r_struct
id|synth_info
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_SYNTH_MEMAVL
suffix:colon
r_return
l_int|0x7fffffff
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|mpu_synth_open
r_static
r_int
id|mpu_synth_open
c_func
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
id|midi_dev
comma
id|err
suffix:semicolon
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
id|midi_dev
op_assign
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|midi_dev
suffix:semicolon
r_if
c_cond
(paren
id|midi_dev
template_param
id|num_midis
op_logical_or
id|midi_devs
(braket
id|midi_dev
)braket
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|midi_dev
)braket
suffix:semicolon
multiline_comment|/*&n;&t; *  Verify that the device is really running.&n;&t; *  Some devices (such as Ensoniq SoundScape don&squot;t&n;&t; *  work before the on board processor (OBP) is initialized&n;&t; *  by downloading its microcode.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|devc-&gt;initialized
)paren
(brace
r_if
c_cond
(paren
id|mpu401_status
c_func
(paren
id|devc
)paren
op_eq
l_int|0xff
)paren
multiline_comment|/* Bus float */
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mpu401: Device not initialized properly&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|reset_mpu401
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;opened
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|devc-&gt;mode
op_assign
id|MODE_SYNTH
suffix:semicolon
id|devc-&gt;synthno
op_assign
id|dev
suffix:semicolon
id|devc-&gt;inputintr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|midi_devs
(braket
id|midi_dev
)braket
op_member_access_from_pointer
id|coproc
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|midi_devs
(braket
id|midi_dev
)braket
op_member_access_from_pointer
id|coproc
op_member_access_from_pointer
id|open
c_func
(paren
id|midi_devs
(braket
id|midi_dev
)braket
op_member_access_from_pointer
id|coproc-&gt;devc
comma
id|COPR_MIDI
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Can&squot;t access coprocessor device&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|devc-&gt;opened
op_assign
id|mode
suffix:semicolon
id|reset_mpu401
c_func
(paren
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|OPEN_READ
)paren
(brace
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x8B
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable data in stop mode */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x34
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Return timing bytes in stop mode */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x87
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable pitch &amp; controller */
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mpu_synth_close
r_static
r_void
id|mpu_synth_close
c_func
(paren
r_int
id|dev
)paren
(brace
r_int
id|midi_dev
suffix:semicolon
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
id|midi_dev
op_assign
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|midi_dev
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|midi_dev
)braket
suffix:semicolon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x15
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Stop recording, playback and MIDI */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x8a
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable data in stopped mode */
id|devc-&gt;inputintr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|midi_devs
(braket
id|midi_dev
)braket
op_member_access_from_pointer
id|coproc
)paren
id|midi_devs
(braket
id|midi_dev
)braket
op_member_access_from_pointer
id|coproc
op_member_access_from_pointer
id|close
c_func
(paren
id|midi_devs
(braket
id|midi_dev
)braket
op_member_access_from_pointer
id|coproc-&gt;devc
comma
id|COPR_MIDI
)paren
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;mode
op_assign
l_int|0
suffix:semicolon
)brace
DECL|macro|MIDI_SYNTH_NAME
mdefine_line|#define MIDI_SYNTH_NAME&t;&quot;MPU-401 UART Midi&quot;
DECL|macro|MIDI_SYNTH_CAPS
mdefine_line|#define MIDI_SYNTH_CAPS&t;SYNTH_CAP_INPUT
macro_line|#include &quot;midi_synth.h&quot;
DECL|variable|mpu401_synth_proto
r_static
r_struct
id|synth_operations
id|mpu401_synth_proto
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|id
suffix:colon
l_string|&quot;MPU401&quot;
comma
id|info
suffix:colon
l_int|NULL
comma
id|midi_dev
suffix:colon
l_int|0
comma
id|synth_type
suffix:colon
id|SYNTH_TYPE_MIDI
comma
id|synth_subtype
suffix:colon
l_int|0
comma
id|open
suffix:colon
id|mpu_synth_open
comma
id|close
suffix:colon
id|mpu_synth_close
comma
id|ioctl
suffix:colon
id|mpu_synth_ioctl
comma
id|kill_note
suffix:colon
id|midi_synth_kill_note
comma
id|start_note
suffix:colon
id|midi_synth_start_note
comma
id|set_instr
suffix:colon
id|midi_synth_set_instr
comma
id|reset
suffix:colon
id|midi_synth_reset
comma
id|hw_control
suffix:colon
id|midi_synth_hw_control
comma
id|load_patch
suffix:colon
id|midi_synth_load_patch
comma
id|aftertouch
suffix:colon
id|midi_synth_aftertouch
comma
id|controller
suffix:colon
id|midi_synth_controller
comma
id|panning
suffix:colon
id|midi_synth_panning
comma
id|bender
suffix:colon
id|midi_synth_bender
comma
id|setup_voice
suffix:colon
id|midi_synth_setup_voice
comma
id|send_sysex
suffix:colon
id|midi_synth_send_sysex
)brace
suffix:semicolon
DECL|variable|mpu401_synth_operations
r_static
r_struct
id|synth_operations
op_star
id|mpu401_synth_operations
(braket
id|MAX_MIDI_DEV
)braket
suffix:semicolon
DECL|variable|mpu401_midi_proto
r_static
r_struct
id|midi_operations
id|mpu401_midi_proto
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|info
suffix:colon
(brace
l_string|&quot;MPU-401 Midi&quot;
comma
l_int|0
comma
id|MIDI_CAP_MPU401
comma
id|SNDCARD_MPU401
)brace
comma
id|in_info
suffix:colon
(brace
l_int|0
)brace
comma
id|open
suffix:colon
id|mpu401_open
comma
id|close
suffix:colon
id|mpu401_close
comma
id|ioctl
suffix:colon
id|mpu401_ioctl
comma
id|outputc
suffix:colon
id|mpu401_out
comma
id|start_read
suffix:colon
id|mpu401_start_read
comma
id|end_read
suffix:colon
id|mpu401_end_read
comma
id|kick
suffix:colon
id|mpu401_kick
comma
id|buffer_status
suffix:colon
id|mpu401_buffer_status
comma
id|prefix_cmd
suffix:colon
id|mpu401_prefix_cmd
)brace
suffix:semicolon
DECL|variable|mpu401_midi_operations
r_static
r_struct
id|midi_operations
id|mpu401_midi_operations
(braket
id|MAX_MIDI_DEV
)braket
suffix:semicolon
DECL|function|mpu401_chk_version
r_static
r_void
id|mpu401_chk_version
c_func
(paren
r_int
id|n
comma
r_struct
id|mpu_config
op_star
id|devc
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|devc-&gt;version
op_assign
id|devc-&gt;revision
op_assign
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|mpu_cmd
c_func
(paren
id|n
comma
l_int|0xAC
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0xf0
)paren
OG
l_int|0x20
)paren
multiline_comment|/* Why it&squot;s larger than 2.x ??? */
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|devc-&gt;version
op_assign
id|tmp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|mpu_cmd
c_func
(paren
id|n
comma
l_int|0xAD
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|devc-&gt;version
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|devc-&gt;revision
op_assign
id|tmp
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|attach_mpu401
r_void
id|attach_mpu401
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
comma
r_struct
id|module
op_star
id|owner
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_char
id|revision_char
suffix:semicolon
r_int
id|m
suffix:semicolon
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
id|hw_config-&gt;slots
(braket
l_int|1
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
id|m
op_assign
id|sound_alloc_mididev
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;MPU-401: Too many midi devices detected&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|m
)braket
suffix:semicolon
id|devc-&gt;base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|devc-&gt;osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
id|devc-&gt;irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;uart_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;initialized
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;version
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;revision
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;capabilities
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;timer_flag
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;m_busy
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|devc-&gt;shared_irq
op_assign
id|hw_config-&gt;always_detect
suffix:semicolon
id|devc-&gt;irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;irq
OL
l_int|0
)paren
(brace
id|devc-&gt;irq
op_mul_assign
op_minus
l_int|1
suffix:semicolon
id|devc-&gt;shared_irq
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hw_config-&gt;always_detect
)paren
(brace
multiline_comment|/* Verify the hardware again */
r_if
c_cond
(paren
op_logical_neg
id|reset_mpu401
c_func
(paren
id|devc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Device didn&squot;t respond&bslash;n&quot;
)paren
suffix:semicolon
id|sound_unload_mididev
c_func
(paren
id|m
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|devc-&gt;shared_irq
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|devc-&gt;irq
comma
id|mpuintr
comma
l_int|0
comma
l_string|&quot;mpu401&quot;
comma
(paren
r_void
op_star
)paren
id|m
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Failed to allocate IRQ%d&bslash;n&quot;
comma
id|devc-&gt;irq
)paren
suffix:semicolon
id|sound_unload_mididev
c_func
(paren
id|m
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mpu401_chk_version
c_func
(paren
id|m
comma
id|devc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;version
op_eq
l_int|0
)paren
id|mpu401_chk_version
c_func
(paren
id|m
comma
id|devc
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|2
comma
l_string|&quot;mpu401&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;version
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|mpu_cmd
c_func
(paren
id|m
comma
l_int|0xC5
comma
l_int|0
)paren
op_ge
l_int|0
)paren
multiline_comment|/* Set timebase OK */
r_if
c_cond
(paren
id|mpu_cmd
c_func
(paren
id|m
comma
l_int|0xE0
comma
l_int|120
)paren
op_ge
l_int|0
)paren
multiline_comment|/* Set tempo OK */
id|devc-&gt;capabilities
op_or_assign
id|MPU_CAP_INTLG
suffix:semicolon
multiline_comment|/* Supports intelligent mode */
id|mpu401_synth_operations
(braket
id|m
)braket
op_assign
(paren
r_struct
id|synth_operations
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|synth_operations
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mpu401_synth_operations
(braket
id|m
)braket
op_eq
l_int|NULL
)paren
(brace
id|sound_unload_mididev
c_func
(paren
id|m
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mpu401: Can&squot;t allocate memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;capabilities
op_amp
id|MPU_CAP_INTLG
)paren
)paren
multiline_comment|/* No intelligent mode */
(brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|mpu401_synth_operations
(braket
id|m
)braket
comma
(paren
r_char
op_star
)paren
op_amp
id|std_midi_synth
comma
r_sizeof
(paren
r_struct
id|synth_operations
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|mpu401_synth_operations
(braket
id|m
)braket
comma
(paren
r_char
op_star
)paren
op_amp
id|mpu401_synth_proto
comma
r_sizeof
(paren
r_struct
id|synth_operations
)paren
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|mpu401_midi_operations
(braket
id|m
)braket
comma
(paren
r_char
op_star
)paren
op_amp
id|mpu401_midi_proto
comma
r_sizeof
(paren
r_struct
id|midi_operations
)paren
)paren
suffix:semicolon
id|mpu401_midi_operations
(braket
id|m
)braket
dot
id|converter
op_assign
id|mpu401_synth_operations
(braket
id|m
)braket
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|mpu_synth_info
(braket
id|m
)braket
comma
(paren
r_char
op_star
)paren
op_amp
id|mpu_synth_info_proto
comma
r_sizeof
(paren
r_struct
id|synth_info
)paren
)paren
suffix:semicolon
id|n_mpu_devs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;version
op_eq
l_int|0x20
op_logical_and
id|devc-&gt;revision
op_ge
l_int|0x07
)paren
multiline_comment|/* MusicQuest interface */
(brace
r_int
id|ports
op_assign
(paren
id|devc-&gt;revision
op_amp
l_int|0x08
)paren
ques
c_cond
l_int|32
suffix:colon
l_int|16
suffix:semicolon
id|devc-&gt;capabilities
op_or_assign
id|MPU_CAP_SYNC
op_or
id|MPU_CAP_SMPTE
op_or
id|MPU_CAP_CLS
op_or
id|MPU_CAP_2PORT
suffix:semicolon
id|revision_char
op_assign
(paren
id|devc-&gt;revision
op_eq
l_int|0x7f
)paren
ques
c_cond
l_char|&squot;M&squot;
suffix:colon
l_char|&squot; &squot;
suffix:semicolon
id|sprintf
c_func
(paren
id|mpu_synth_info
(braket
id|m
)braket
dot
id|name
comma
l_string|&quot;MQX-%d%c MIDI Interface #%d&quot;
comma
id|ports
comma
id|revision_char
comma
id|n_mpu_devs
)paren
suffix:semicolon
)brace
r_else
(brace
id|revision_char
op_assign
id|devc-&gt;revision
ques
c_cond
id|devc-&gt;revision
op_plus
l_char|&squot;@&squot;
suffix:colon
l_char|&squot; &squot;
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|devc-&gt;revision
OG
(paren
l_char|&squot;Z&squot;
op_minus
l_char|&squot;@&squot;
)paren
)paren
id|revision_char
op_assign
l_char|&squot;+&squot;
suffix:semicolon
id|devc-&gt;capabilities
op_or_assign
id|MPU_CAP_SYNC
op_or
id|MPU_CAP_FSK
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;name
)paren
id|sprintf
c_func
(paren
id|mpu_synth_info
(braket
id|m
)braket
dot
id|name
comma
l_string|&quot;%s (MPU401)&quot;
comma
id|hw_config-&gt;name
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|mpu_synth_info
(braket
id|m
)braket
dot
id|name
comma
l_string|&quot;MPU-401 %d.%d%c Midi interface #%d&quot;
comma
(paren
r_int
)paren
(paren
id|devc-&gt;version
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
comma
id|devc-&gt;version
op_amp
l_int|0x0f
comma
id|revision_char
comma
id|n_mpu_devs
)paren
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|mpu401_midi_operations
(braket
id|m
)braket
dot
id|info.name
comma
id|mpu_synth_info
(braket
id|m
)braket
dot
id|name
)paren
suffix:semicolon
id|conf_printf
c_func
(paren
id|mpu_synth_info
(braket
id|m
)braket
dot
id|name
comma
id|hw_config
)paren
suffix:semicolon
id|mpu401_synth_operations
(braket
id|m
)braket
op_member_access_from_pointer
id|midi_dev
op_assign
id|devc-&gt;devno
op_assign
id|m
suffix:semicolon
id|mpu401_synth_operations
(braket
id|devc-&gt;devno
)braket
op_member_access_from_pointer
id|info
op_assign
op_amp
id|mpu_synth_info
(braket
id|devc-&gt;devno
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;capabilities
op_amp
id|MPU_CAP_INTLG
)paren
multiline_comment|/* Intelligent mode */
id|hw_config-&gt;slots
(braket
l_int|2
)braket
op_assign
id|mpu_timer_init
c_func
(paren
id|m
)paren
suffix:semicolon
id|midi_devs
(braket
id|m
)braket
op_assign
op_amp
id|mpu401_midi_operations
(braket
id|devc-&gt;devno
)braket
suffix:semicolon
r_if
c_cond
(paren
id|owner
)paren
id|midi_devs
(braket
id|m
)braket
op_member_access_from_pointer
id|owner
op_assign
id|owner
suffix:semicolon
id|hw_config-&gt;slots
(braket
l_int|1
)braket
op_assign
id|m
suffix:semicolon
id|sequencer_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|reset_mpu401
r_static
r_int
id|reset_mpu401
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ok
comma
id|timeout
comma
id|n
suffix:semicolon
r_int
id|timeout_limit
suffix:semicolon
multiline_comment|/*&n;&t; * Send the RESET command. Try again if no success at the first time.&n;&t; * (If the device is in the UART mode, it will not ack the reset cmd).&n;&t; */
id|ok
op_assign
l_int|0
suffix:semicolon
id|timeout_limit
op_assign
id|devc-&gt;initialized
ques
c_cond
l_int|30000
suffix:colon
l_int|100000
suffix:semicolon
id|devc-&gt;initialized
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|2
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|n
op_increment
)paren
(brace
r_for
c_loop
(paren
id|timeout
op_assign
id|timeout_limit
suffix:semicolon
id|timeout
OG
l_int|0
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|timeout
op_decrement
)paren
id|ok
op_assign
id|output_ready
c_func
(paren
id|devc
)paren
suffix:semicolon
id|write_command
c_func
(paren
id|devc
comma
id|MPU_RESET
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t;   * Send MPU-401 RESET Command&n;&t;&t;&t;&t;&t;&t;&t; */
multiline_comment|/*&n;&t;&t; * Wait at least 25 msec. This method is not accurate so let&squot;s make the&n;&t;&t; * loop bit longer. Cannot sleep since this is called during boot.&n;&t;&t; */
r_for
c_loop
(paren
id|timeout
op_assign
id|timeout_limit
op_star
l_int|2
suffix:semicolon
id|timeout
OG
l_int|0
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input_avail
c_func
(paren
id|devc
)paren
)paren
r_if
c_cond
(paren
id|read_data
c_func
(paren
id|devc
)paren
op_eq
id|MPU_ACK
)paren
id|ok
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
id|devc-&gt;m_state
op_assign
id|ST_INIT
suffix:semicolon
id|devc-&gt;m_ptr
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;m_left
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;last_status
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;uart_mode
op_assign
l_int|0
suffix:semicolon
r_return
id|ok
suffix:semicolon
)brace
DECL|function|set_uart_mode
r_static
r_void
id|set_uart_mode
c_func
(paren
r_int
id|dev
comma
r_struct
id|mpu_config
op_star
id|devc
comma
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|arg
op_logical_and
(paren
id|devc-&gt;capabilities
op_amp
id|MPU_CAP_INTLG
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|devc-&gt;uart_mode
op_eq
l_int|0
)paren
op_eq
(paren
id|arg
op_eq
l_int|0
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Already set */
id|reset_mpu401
c_func
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* This exits the uart mode */
r_if
c_cond
(paren
id|arg
)paren
(brace
r_if
c_cond
(paren
id|mpu_cmd
c_func
(paren
id|dev
comma
id|UART_MODE_ON
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mpu401: Can&squot;t enter UART mode&bslash;n&quot;
)paren
suffix:semicolon
id|devc-&gt;uart_mode
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|devc-&gt;uart_mode
op_assign
id|arg
suffix:semicolon
)brace
DECL|function|probe_mpu401
r_int
id|probe_mpu401
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|ok
op_assign
l_int|0
suffix:semicolon
r_struct
id|mpu_config
id|tmp_devc
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mpu401: I/O port %x already in use&bslash;n&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tmp_devc.base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|tmp_devc.irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|tmp_devc.initialized
op_assign
l_int|0
suffix:semicolon
id|tmp_devc.opened
op_assign
l_int|0
suffix:semicolon
id|tmp_devc.osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;always_detect
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|1
)paren
op_eq
l_int|0xff
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;MPU401: Port %x looks dead.&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Just bus float? */
)brace
id|ok
op_assign
id|reset_mpu401
c_func
(paren
op_amp
id|tmp_devc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
id|DDB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;MPU401: Reset failed on port %x&bslash;n&quot;
comma
id|hw_config-&gt;io_base
)paren
)paren
suffix:semicolon
)brace
r_return
id|ok
suffix:semicolon
)brace
DECL|function|unload_mpu401
r_void
id|__exit
id|unload_mpu401
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_void
op_star
id|p
suffix:semicolon
r_int
id|n
op_assign
id|hw_config-&gt;slots
(braket
l_int|1
)braket
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;always_detect
op_eq
l_int|0
op_logical_and
id|hw_config-&gt;irq
OG
l_int|0
)paren
id|free_irq
c_func
(paren
id|hw_config-&gt;irq
comma
(paren
r_void
op_star
)paren
id|n
)paren
suffix:semicolon
id|p
op_assign
id|mpu401_synth_operations
(braket
id|n
)braket
suffix:semicolon
id|sound_unload_mididev
c_func
(paren
id|n
)paren
suffix:semicolon
id|sound_unload_timerdev
c_func
(paren
id|hw_config-&gt;slots
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*****************************************************&n; *      Timer stuff&n; ****************************************************/
DECL|variable|timer_initialized
DECL|variable|timer_open
DECL|variable|tmr_running
r_static
r_volatile
r_int
id|timer_initialized
op_assign
l_int|0
comma
id|timer_open
op_assign
l_int|0
comma
id|tmr_running
op_assign
l_int|0
suffix:semicolon
DECL|variable|curr_tempo
DECL|variable|curr_timebase
DECL|variable|hw_timebase
r_static
r_volatile
r_int
id|curr_tempo
comma
id|curr_timebase
comma
id|hw_timebase
suffix:semicolon
DECL|variable|max_timebase
r_static
r_int
id|max_timebase
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* 8*24=192 ppqn */
DECL|variable|next_event_time
r_static
r_volatile
r_int
r_int
id|next_event_time
suffix:semicolon
DECL|variable|curr_ticks
DECL|variable|curr_clocks
r_static
r_volatile
r_int
r_int
id|curr_ticks
comma
id|curr_clocks
suffix:semicolon
DECL|variable|prev_event_time
r_static
r_int
r_int
id|prev_event_time
suffix:semicolon
DECL|variable|metronome_mode
r_static
r_int
id|metronome_mode
suffix:semicolon
DECL|function|clocks2ticks
r_static
r_int
r_int
id|clocks2ticks
c_func
(paren
r_int
r_int
id|clocks
)paren
(brace
multiline_comment|/*&n;&t; * The MPU-401 supports just a limited set of possible timebase values.&n;&t; * Since the applications require more choices, the driver has to&n;&t; * program the HW to do its best and to convert between the HW and&n;&t; * actual timebases.&n;&t; */
r_return
(paren
(paren
id|clocks
op_star
id|curr_timebase
)paren
op_plus
(paren
id|hw_timebase
op_div
l_int|2
)paren
)paren
op_div
id|hw_timebase
suffix:semicolon
)brace
DECL|function|set_timebase
r_static
r_void
id|set_timebase
c_func
(paren
r_int
id|midi_dev
comma
r_int
id|val
)paren
(brace
r_int
id|hw_val
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|48
)paren
id|val
op_assign
l_int|48
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
l_int|1000
)paren
id|val
op_assign
l_int|1000
suffix:semicolon
id|hw_val
op_assign
id|val
suffix:semicolon
id|hw_val
op_assign
(paren
id|hw_val
op_plus
l_int|12
)paren
op_div
l_int|24
suffix:semicolon
r_if
c_cond
(paren
id|hw_val
OG
id|max_timebase
)paren
id|hw_val
op_assign
id|max_timebase
suffix:semicolon
r_if
c_cond
(paren
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0xC0
op_or
(paren
id|hw_val
op_amp
l_int|0x0f
)paren
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Can&squot;t set HW timebase to %d&bslash;n&quot;
comma
id|hw_val
op_star
l_int|24
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|hw_timebase
op_assign
id|hw_val
op_star
l_int|24
suffix:semicolon
id|curr_timebase
op_assign
id|val
suffix:semicolon
)brace
DECL|function|tmr_reset
r_static
r_void
id|tmr_reset
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|next_event_time
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|prev_event_time
op_assign
l_int|0
suffix:semicolon
id|curr_ticks
op_assign
id|curr_clocks
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|set_timer_mode
r_static
r_void
id|set_timer_mode
c_func
(paren
r_int
id|midi_dev
)paren
(brace
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_MODE_CLS
)paren
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x3c
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use CLS sync */
r_else
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_MODE_SMPTE
)paren
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x3d
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use SMPTE sync */
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_INTERNAL
)paren
(brace
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x80
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use MIDI sync */
)brace
r_else
(brace
r_if
c_cond
(paren
id|timer_mode
op_amp
(paren
id|TMR_MODE_MIDI
op_or
id|TMR_MODE_CLS
)paren
)paren
(brace
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x82
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use MIDI sync */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x91
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable ext MIDI ctrl */
)brace
r_else
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_MODE_FSK
)paren
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x81
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use FSK sync */
)brace
)brace
DECL|function|stop_metronome
r_static
r_void
id|stop_metronome
c_func
(paren
r_int
id|midi_dev
)paren
(brace
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x84
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable metronome */
)brace
DECL|function|setup_metronome
r_static
r_void
id|setup_metronome
c_func
(paren
r_int
id|midi_dev
)paren
(brace
r_int
id|numerator
comma
id|denominator
suffix:semicolon
r_int
id|clks_per_click
comma
id|num_32nds_per_beat
suffix:semicolon
r_int
id|beats_per_measure
suffix:semicolon
id|numerator
op_assign
(paren
(paren
r_int
)paren
id|metronome_mode
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
id|denominator
op_assign
(paren
(paren
r_int
)paren
id|metronome_mode
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|clks_per_click
op_assign
(paren
(paren
r_int
)paren
id|metronome_mode
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|num_32nds_per_beat
op_assign
(paren
r_int
)paren
id|metronome_mode
op_amp
l_int|0xff
suffix:semicolon
id|beats_per_measure
op_assign
(paren
id|numerator
op_star
l_int|4
)paren
op_rshift
id|denominator
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|metronome_mode
)paren
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x84
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable metronome */
r_else
(brace
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0xE4
comma
id|clks_per_click
)paren
suffix:semicolon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0xE6
comma
id|beats_per_measure
)paren
suffix:semicolon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x83
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable metronome without accents */
)brace
)brace
DECL|function|mpu_start_timer
r_static
r_int
id|mpu_start_timer
c_func
(paren
r_int
id|midi_dev
)paren
(brace
id|tmr_reset
c_func
(paren
)paren
suffix:semicolon
id|set_timer_mode
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmr_running
)paren
r_return
id|TIMER_NOT_ARMED
suffix:semicolon
multiline_comment|/* Already running */
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_INTERNAL
)paren
(brace
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x02
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Send MIDI start */
id|tmr_running
op_assign
l_int|1
suffix:semicolon
r_return
id|TIMER_NOT_ARMED
suffix:semicolon
)brace
r_else
(brace
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x35
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable mode messages to PC */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x38
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable sys common messages to PC */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x39
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable real time messages to PC */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x97
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable system exclusive messages to PC */
)brace
r_return
id|TIMER_ARMED
suffix:semicolon
)brace
DECL|function|mpu_timer_open
r_static
r_int
id|mpu_timer_open
c_func
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
id|midi_dev
op_assign
id|sound_timer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devlink
suffix:semicolon
r_if
c_cond
(paren
id|timer_open
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|tmr_reset
c_func
(paren
)paren
suffix:semicolon
id|curr_tempo
op_assign
l_int|50
suffix:semicolon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0xE0
comma
l_int|50
)paren
suffix:semicolon
id|curr_timebase
op_assign
id|hw_timebase
op_assign
l_int|120
suffix:semicolon
id|set_timebase
c_func
(paren
id|midi_dev
comma
l_int|120
)paren
suffix:semicolon
id|timer_open
op_assign
l_int|1
suffix:semicolon
id|metronome_mode
op_assign
l_int|0
suffix:semicolon
id|set_timer_mode
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0xe7
comma
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* Send all clocks to host */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x95
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable clock to host */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mpu_timer_close
r_static
r_void
id|mpu_timer_close
c_func
(paren
r_int
id|dev
)paren
(brace
r_int
id|midi_dev
op_assign
id|sound_timer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devlink
suffix:semicolon
id|timer_open
op_assign
id|tmr_running
op_assign
l_int|0
suffix:semicolon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x15
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Stop all */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x94
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable clock to host */
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x8c
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Disable measure end messages to host */
id|stop_metronome
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
)brace
DECL|function|mpu_timer_event
r_static
r_int
id|mpu_timer_event
c_func
(paren
r_int
id|dev
comma
r_int
r_char
op_star
id|event
)paren
(brace
r_int
r_char
id|command
op_assign
id|event
(braket
l_int|1
)braket
suffix:semicolon
r_int
r_int
id|parm
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
op_amp
id|event
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|midi_dev
op_assign
id|sound_timer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devlink
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|TMR_WAIT_REL
suffix:colon
id|parm
op_add_assign
id|prev_event_time
suffix:semicolon
r_case
id|TMR_WAIT_ABS
suffix:colon
r_if
c_cond
(paren
id|parm
OG
l_int|0
)paren
(brace
r_int
id|time
suffix:semicolon
r_if
c_cond
(paren
id|parm
op_le
id|curr_ticks
)paren
multiline_comment|/* It&squot;s the time */
r_return
id|TIMER_NOT_ARMED
suffix:semicolon
id|time
op_assign
id|parm
suffix:semicolon
id|next_event_time
op_assign
id|prev_event_time
op_assign
id|time
suffix:semicolon
r_return
id|TIMER_ARMED
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TMR_START
suffix:colon
r_if
c_cond
(paren
id|tmr_running
)paren
r_break
suffix:semicolon
r_return
id|mpu_start_timer
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
r_case
id|TMR_STOP
suffix:colon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x01
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Send MIDI stop */
id|stop_metronome
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
id|tmr_running
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TMR_CONTINUE
suffix:colon
r_if
c_cond
(paren
id|tmr_running
)paren
r_break
suffix:semicolon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x03
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Send MIDI continue */
id|setup_metronome
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
id|tmr_running
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TMR_TEMPO
suffix:colon
r_if
c_cond
(paren
id|parm
)paren
(brace
r_if
c_cond
(paren
id|parm
OL
l_int|8
)paren
id|parm
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|parm
OG
l_int|250
)paren
id|parm
op_assign
l_int|250
suffix:semicolon
r_if
c_cond
(paren
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0xE0
comma
id|parm
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Can&squot;t set tempo to %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|parm
)paren
suffix:semicolon
id|curr_tempo
op_assign
id|parm
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TMR_ECHO
suffix:colon
id|seq_copy_to_input
c_func
(paren
id|event
comma
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TMR_TIMESIG
suffix:colon
r_if
c_cond
(paren
id|metronome_mode
)paren
multiline_comment|/* Metronome enabled */
(brace
id|metronome_mode
op_assign
id|parm
suffix:semicolon
id|setup_metronome
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
r_return
id|TIMER_NOT_ARMED
suffix:semicolon
)brace
DECL|function|mpu_timer_get_time
r_static
r_int
r_int
id|mpu_timer_get_time
c_func
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|timer_open
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|curr_ticks
suffix:semicolon
)brace
DECL|function|mpu_timer_ioctl
r_static
r_int
id|mpu_timer_ioctl
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|command
comma
id|caddr_t
id|arg
)paren
(brace
r_int
id|midi_dev
op_assign
id|sound_timer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devlink
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|SNDCTL_TMR_SOURCE
suffix:colon
(brace
r_int
id|parm
suffix:semicolon
id|parm
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
id|parm
op_and_assign
id|timer_caps
suffix:semicolon
r_if
c_cond
(paren
id|parm
op_ne
l_int|0
)paren
(brace
id|timer_mode
op_assign
id|parm
suffix:semicolon
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_MODE_CLS
)paren
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x3c
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use CLS sync */
r_else
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_MODE_SMPTE
)paren
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x3d
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use SMPTE sync */
)brace
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|timer_mode
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_TMR_START
suffix:colon
id|mpu_start_timer
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_TMR_STOP
suffix:colon
id|tmr_running
op_assign
l_int|0
suffix:semicolon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x01
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Send MIDI stop */
id|stop_metronome
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_TMR_CONTINUE
suffix:colon
r_if
c_cond
(paren
id|tmr_running
)paren
r_return
l_int|0
suffix:semicolon
id|tmr_running
op_assign
l_int|1
suffix:semicolon
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0x03
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Send MIDI continue */
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_TMR_TIMEBASE
suffix:colon
(brace
r_int
id|val
suffix:semicolon
id|val
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|set_timebase
c_func
(paren
id|midi_dev
comma
id|val
)paren
suffix:semicolon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|curr_timebase
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_TMR_TEMPO
suffix:colon
(brace
r_int
id|val
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|val
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
r_if
c_cond
(paren
id|val
OL
l_int|8
)paren
id|val
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
l_int|250
)paren
id|val
op_assign
l_int|250
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|mpu_cmd
c_func
(paren
id|midi_dev
comma
l_int|0xE0
comma
id|val
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpu401: Can&squot;t set tempo to %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|val
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|curr_tempo
op_assign
id|val
suffix:semicolon
)brace
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|curr_tempo
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_CTRLRATE
suffix:colon
(brace
r_int
id|val
suffix:semicolon
id|val
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
multiline_comment|/* Can&squot;t change */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
(paren
(paren
id|curr_tempo
op_star
id|curr_timebase
)paren
op_plus
l_int|30
)paren
op_div
l_int|60
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_SEQ_GETTIME
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|curr_ticks
)paren
suffix:semicolon
r_case
id|SNDCTL_TMR_METRONOME
suffix:colon
id|metronome_mode
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
id|setup_metronome
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|mpu_timer_arm
r_static
r_void
id|mpu_timer_arm
c_func
(paren
r_int
id|dev
comma
r_int
id|time
)paren
(brace
r_if
c_cond
(paren
id|time
OL
l_int|0
)paren
id|time
op_assign
id|curr_ticks
op_plus
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|time
op_le
id|curr_ticks
)paren
multiline_comment|/* It&squot;s the time */
r_return
suffix:semicolon
id|next_event_time
op_assign
id|prev_event_time
op_assign
id|time
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|mpu_timer
r_static
r_struct
id|sound_timer_operations
id|mpu_timer
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|info
suffix:colon
(brace
l_string|&quot;MPU-401 Timer&quot;
comma
l_int|0
)brace
comma
id|priority
suffix:colon
l_int|10
comma
multiline_comment|/* Priority */
id|devlink
suffix:colon
l_int|0
comma
multiline_comment|/* Local device link */
id|open
suffix:colon
id|mpu_timer_open
comma
id|close
suffix:colon
id|mpu_timer_close
comma
id|event
suffix:colon
id|mpu_timer_event
comma
id|get_time
suffix:colon
id|mpu_timer_get_time
comma
id|ioctl
suffix:colon
id|mpu_timer_ioctl
comma
id|arm_timer
suffix:colon
id|mpu_timer_arm
)brace
suffix:semicolon
DECL|function|mpu_timer_interrupt
r_static
r_void
id|mpu_timer_interrupt
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|timer_open
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmr_running
)paren
r_return
suffix:semicolon
id|curr_clocks
op_increment
suffix:semicolon
id|curr_ticks
op_assign
id|clocks2ticks
c_func
(paren
id|curr_clocks
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curr_ticks
op_ge
id|next_event_time
)paren
(brace
id|next_event_time
op_assign
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
id|sequencer_timer
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|timer_ext_event
r_static
r_void
id|timer_ext_event
c_func
(paren
r_struct
id|mpu_config
op_star
id|devc
comma
r_int
id|event
comma
r_int
id|parm
)paren
(brace
r_int
id|midi_dev
op_assign
id|devc-&gt;devno
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|devc-&gt;timer_flag
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|TMR_CLOCK
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&lt;MIDI clk&gt;&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TMR_START
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Ext MIDI start&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmr_running
)paren
(brace
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_EXTERNAL
)paren
(brace
id|tmr_running
op_assign
l_int|1
suffix:semicolon
id|setup_metronome
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
id|next_event_time
op_assign
l_int|0
suffix:semicolon
id|STORE
c_func
(paren
id|SEQ_START_TIMER
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|TMR_STOP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Ext MIDI stop&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_EXTERNAL
)paren
(brace
id|tmr_running
op_assign
l_int|0
suffix:semicolon
id|stop_metronome
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|SEQ_STOP_TIMER
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TMR_CONTINUE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Ext MIDI continue&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_EXTERNAL
)paren
(brace
id|tmr_running
op_assign
l_int|1
suffix:semicolon
id|setup_metronome
c_func
(paren
id|midi_dev
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|SEQ_CONTINUE_TIMER
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TMR_SPP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Songpos: %d&bslash;n&quot;
comma
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_mode
op_amp
id|TMR_EXTERNAL
)paren
(brace
id|STORE
c_func
(paren
id|SEQ_SONGPOS
c_func
(paren
id|parm
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
DECL|function|mpu_timer_init
r_static
r_int
id|mpu_timer_init
c_func
(paren
r_int
id|midi_dev
)paren
(brace
r_struct
id|mpu_config
op_star
id|devc
suffix:semicolon
r_int
id|n
suffix:semicolon
id|devc
op_assign
op_amp
id|dev_conf
(braket
id|midi_dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|timer_initialized
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* There is already a similar timer */
id|timer_initialized
op_assign
l_int|1
suffix:semicolon
id|mpu_timer.devlink
op_assign
id|midi_dev
suffix:semicolon
id|dev_conf
(braket
id|midi_dev
)braket
dot
id|timer_flag
op_assign
l_int|1
suffix:semicolon
id|n
op_assign
id|sound_alloc_timerdev
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
op_minus
l_int|1
)paren
id|n
op_assign
l_int|0
suffix:semicolon
id|sound_timer_devs
(braket
id|n
)braket
op_assign
op_amp
id|mpu_timer
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;version
OL
l_int|0x20
)paren
multiline_comment|/* Original MPU-401 */
id|timer_caps
op_assign
id|TMR_INTERNAL
op_or
id|TMR_EXTERNAL
op_or
id|TMR_MODE_FSK
op_or
id|TMR_MODE_MIDI
suffix:semicolon
r_else
(brace
multiline_comment|/*&n;&t;&t; * The version number 2.0 is used (at least) by the&n;&t;&t; * MusicQuest cards and the Roland Super-MPU.&n;&t;&t; *&n;&t;&t; * MusicQuest has given a special meaning to the bits of the&n;&t;&t; * revision number. The Super-MPU returns 0.&n;&t;&t; */
r_if
c_cond
(paren
id|devc-&gt;revision
)paren
id|timer_caps
op_or_assign
id|TMR_EXTERNAL
op_or
id|TMR_MODE_MIDI
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;revision
op_amp
l_int|0x02
)paren
id|timer_caps
op_or_assign
id|TMR_MODE_CLS
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;revision
op_amp
l_int|0x40
)paren
id|max_timebase
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* Has the 216 and 240 ppqn modes */
)brace
id|timer_mode
op_assign
(paren
id|TMR_INTERNAL
op_or
id|TMR_MODE_MIDI
)paren
op_amp
id|timer_caps
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
DECL|variable|probe_mpu401
id|EXPORT_SYMBOL
c_func
(paren
id|probe_mpu401
)paren
suffix:semicolon
DECL|variable|attach_mpu401
id|EXPORT_SYMBOL
c_func
(paren
id|attach_mpu401
)paren
suffix:semicolon
DECL|variable|unload_mpu401
id|EXPORT_SYMBOL
c_func
(paren
id|unload_mpu401
)paren
suffix:semicolon
DECL|variable|intchk_mpu401
id|EXPORT_SYMBOL
c_func
(paren
id|intchk_mpu401
)paren
suffix:semicolon
DECL|variable|mpuintr
id|EXPORT_SYMBOL
c_func
(paren
id|mpuintr
)paren
suffix:semicolon
DECL|variable|cfg
r_static
r_struct
id|address_info
id|cfg
suffix:semicolon
DECL|variable|io
r_static
r_int
id|__initdata
id|io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|__initdata
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_mpu401
r_int
id|__init
id|init_mpu401
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Can be loaded either for module use or to provide functions&n;&t;   to others */
r_if
c_cond
(paren
id|io
op_ne
op_minus
l_int|1
op_logical_and
id|irq
op_ne
op_minus
l_int|1
)paren
(brace
id|cfg.irq
op_assign
id|irq
suffix:semicolon
id|cfg.io_base
op_assign
id|io
suffix:semicolon
r_if
c_cond
(paren
id|probe_mpu401
c_func
(paren
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|attach_mpu401
c_func
(paren
op_amp
id|cfg
comma
id|THIS_MODULE
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_mpu401
r_void
id|__exit
id|cleanup_mpu401
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|io
op_ne
op_minus
l_int|1
op_logical_and
id|irq
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Check for use by, for example, sscape driver */
id|unload_mpu401
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
)brace
)brace
DECL|variable|init_mpu401
id|module_init
c_func
(paren
id|init_mpu401
)paren
suffix:semicolon
DECL|variable|cleanup_mpu401
id|module_exit
c_func
(paren
id|cleanup_mpu401
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|setup_mpu401
r_static
r_int
id|__init
id|setup_mpu401
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/* io, irq */
r_int
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|io
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|irq
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;mpu401=&quot;
comma
id|setup_mpu401
)paren
suffix:semicolon
macro_line|#endif
eof
