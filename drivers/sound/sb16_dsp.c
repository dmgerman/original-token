multiline_comment|/*&n; * sound/sb16_dsp.c&n; *&n; * The low level driver for the SoundBlaster DSP chip.&n; *&n; * (C) 1993 J. Schubert (jsb@sth.ruhr-uni-bochum.de)&n; *&n; * based on SB-driver by (C) Hannu Savolainen&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; */
DECL|macro|DEB
mdefine_line|#define DEB(x)
DECL|macro|DEB1
mdefine_line|#define DEB1(x)
multiline_comment|/*&n;   #define DEB_DMARES&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;sb.h&quot;
macro_line|#include &quot;sb_mixer.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_SB16) &amp;&amp; !defined(EXCLUDE_SB) &amp;&amp; !defined(EXCLUDE_AUDIO) &amp;&amp; !defined(EXCLUDE_SBPRO)
r_extern
r_int
id|sbc_base
comma
id|sbc_minor
comma
id|sbc_major
suffix:semicolon
DECL|variable|sb16_dsp_ok
r_static
r_int
id|sb16_dsp_ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set to 1 after successful initialization */
DECL|variable|dsp_16bit
r_static
r_int
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_stereo
r_static
r_int
id|dsp_stereo
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_current_speed
r_static
r_int
id|dsp_current_speed
op_assign
l_int|8000
suffix:semicolon
multiline_comment|/*DSP_DEFAULT_SPEED; */
DECL|variable|dsp_busy
r_static
r_int
id|dsp_busy
op_assign
l_int|0
suffix:semicolon
DECL|variable|dma16
DECL|variable|dma8
r_static
r_int
id|dma16
comma
id|dma8
suffix:semicolon
DECL|variable|dsp_count
r_static
r_int
r_int
id|dsp_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq_mode
r_static
r_int
id|irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
multiline_comment|/* IMODE_INPUT, IMODE_OUTPUT or&n;&n;&t;&t;&t;&t;&t;   IMODE_NONE */
DECL|variable|my_dev
r_static
r_int
id|my_dev
op_assign
l_int|0
suffix:semicolon
DECL|variable|intr_active
r_static
r_volatile
r_int
id|intr_active
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|sb16_dsp_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|sb16_dsp_close
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|sb16_dsp_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|dma_restart
)paren
suffix:semicolon
r_static
r_void
id|sb16_dsp_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|dma_restart
)paren
suffix:semicolon
r_static
r_int
id|sb16_dsp_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|local
)paren
suffix:semicolon
r_static
r_int
id|sb16_dsp_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
suffix:semicolon
r_static
r_int
id|sb16_dsp_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
suffix:semicolon
r_static
r_void
id|sb16_dsp_reset
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|sb16_dsp_halt
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_int
id|dsp_set_speed
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|dsp_set_stereo
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|dsp_cleanup
(paren
r_void
)paren
suffix:semicolon
r_int
id|sb_reset_dsp
(paren
r_void
)paren
suffix:semicolon
DECL|variable|sb16_dsp_operations
r_static
r_struct
id|audio_operations
id|sb16_dsp_operations
op_assign
(brace
l_string|&quot;SoundBlaster 16&quot;
comma
id|NOTHING_SPECIAL
comma
id|sb16_dsp_open
comma
id|sb16_dsp_close
comma
id|sb16_dsp_output_block
comma
id|sb16_dsp_start_input
comma
id|sb16_dsp_ioctl
comma
id|sb16_dsp_prepare_for_input
comma
id|sb16_dsp_prepare_for_output
comma
id|sb16_dsp_reset
comma
id|sb16_dsp_halt
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
r_static
r_int
DECL|function|sb_dsp_command01
id|sb_dsp_command01
(paren
r_int
r_char
id|val
)paren
(brace
r_int
id|i
op_assign
l_int|1
op_lshift
l_int|16
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
op_amp
(paren
op_logical_neg
id|INB
(paren
id|DSP_STATUS
)paren
op_amp
l_int|0x80
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
id|printk
(paren
l_string|&quot;SB16 sb_dsp_command01 Timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|sb_dsp_command
(paren
id|val
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|wait_data_avail
id|wait_data_avail
(paren
r_int
r_int
id|t
)paren
(brace
r_int
id|loopc
op_assign
l_int|5000000
suffix:semicolon
id|t
op_add_assign
id|GET_TIME
(paren
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|loopc
op_logical_and
id|GET_TIME
(paren
)paren
OL
id|t
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;!data_avail l=%d&bslash;n&quot;
comma
id|loopc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|read_dsp
id|read_dsp
(paren
r_int
id|t
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|wait_data_avail
(paren
(paren
r_int
r_int
)paren
id|t
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_else
r_return
id|INB
(paren
id|DSP_READ
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_ini2
id|dsp_ini2
(paren
r_void
)paren
(brace
macro_line|#if 0
multiline_comment|/* sb_setmixer(0x83, sb_getmixer(0x83) | 0x03);       */
id|sb_dsp_command
(paren
l_int|0xe2
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0x76
)paren
suffix:semicolon
multiline_comment|/* E0 ??? */
id|sb_dsp_command
(paren
l_int|0xe2
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* A0 ??? */
id|sb_dsp_command
(paren
l_int|0xe4
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0xaa
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0xe8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_dsp
(paren
l_int|100
)paren
op_ne
l_int|0xaa
)paren
id|printk
(paren
l_string|&quot;Error dsp_ini2&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;   static char *dsp_getmessage(unsigned char command,int maxn)&n;   {&n;   static char buff[100];&n;   int n=0;&n;&n;   sb_dsp_command(command);&n;   while(n&lt;maxn &amp;&amp; wait_data_avail(2L)) {&n;   buff[++n]=INB(DSP_READ);&n;   if(!buff[n])&n;   break;&n;   }&n;   buff[0]=n;&n;   return buff;&n;   }&n;&n;   static void dsp_showmessage(unsigned char command,int len)&n;   {&n;   int n;&n;   unsigned char *c;&n;   c=dsp_getmessage(command,len);&n;   printk(&quot;DSP C=%x l=%d,lr=%d b=&quot;,command,len,c[0]);&n;   for(n=1;n&lt;=c[0];n++)&n;   if(c[n]&gt;=&squot; &squot; &amp; c[n]&lt;=&squot;z&squot;)&n;   printk(&quot;%c&quot;,c[n]);&n;   else&n;   printk(&quot;|%x|&quot;,c[n]);&n;   printk(&quot;&bslash;n&quot;);&n;   }&n; */
r_static
r_int
DECL|function|dsp_set_speed
id|dsp_set_speed
(paren
r_int
id|mode
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;dsp_set_speed(%d)&bslash;n&quot;
comma
id|mode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
)paren
(brace
r_if
c_cond
(paren
id|mode
OL
l_int|5000
)paren
id|mode
op_assign
l_int|5000
suffix:semicolon
r_if
c_cond
(paren
id|mode
OG
l_int|44100
)paren
id|mode
op_assign
l_int|44100
suffix:semicolon
id|dsp_current_speed
op_assign
id|mode
suffix:semicolon
)brace
r_return
id|mode
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_set_stereo
id|dsp_set_stereo
(paren
r_int
id|mode
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;dsp_set_stereo(%d)&bslash;n&quot;
comma
id|mode
)paren
)paren
suffix:semicolon
id|dsp_stereo
op_assign
id|mode
suffix:semicolon
r_return
id|mode
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_set_bits
id|dsp_set_bits
(paren
r_int
id|arg
)paren
(brace
id|DEB
(paren
id|printk
(paren
l_string|&quot;dsp_set_bits(%d)&bslash;n&quot;
comma
id|arg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
)paren
r_switch
c_cond
(paren
id|arg
)paren
(brace
r_case
l_int|8
suffix:colon
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|dsp_16bit
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
id|dsp_16bit
ques
c_cond
l_int|16
suffix:colon
l_int|8
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb16_dsp_ioctl
id|sb16_dsp_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|local
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SOUND_PCM_WRITE_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_speed
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_speed
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_current_speed
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_current_speed
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_stereo
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_stereo
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_stereo
(paren
id|arg
op_minus
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_stereo
(paren
id|IOCTL_IN
(paren
id|arg
)paren
op_minus
l_int|1
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_stereo
op_plus
l_int|1
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_stereo
op_plus
l_int|1
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SAMPLESIZE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_bits
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_bits
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_16bit
ques
c_cond
l_int|16
suffix:colon
l_int|8
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_16bit
ques
c_cond
l_int|16
suffix:colon
l_int|8
)paren
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
multiline_comment|/* NOT YET IMPLEMENTED */
r_if
c_cond
(paren
id|IOCTL_IN
(paren
id|arg
)paren
OG
l_int|1
)paren
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|RET_ERROR
(paren
id|EINVAL
)paren
)paren
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb16_dsp_open
id|sb16_dsp_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
id|retval
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;sb16_dsp_open()&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb16_dsp_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB16 Error: SoundBlaster board not installed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_active
)paren
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
id|retval
op_assign
id|sb_get_irq
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|ALLOC_DMA_CHN
(paren
id|dma8
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;SB16: Unable to grab DMA%d&bslash;n&quot;
comma
id|dma8
)paren
suffix:semicolon
id|sb_free_irq
(paren
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma16
op_ne
id|dma8
)paren
r_if
c_cond
(paren
id|ALLOC_DMA_CHN
(paren
id|dma16
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;SB16: Unable to grab DMA%d&bslash;n&quot;
comma
id|dma16
)paren
suffix:semicolon
id|sb_free_irq
(paren
)paren
suffix:semicolon
id|RELEASE_DMA_CHN
(paren
id|dma8
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
id|dsp_ini2
(paren
)paren
suffix:semicolon
id|irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
id|dsp_busy
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb16_dsp_close
id|sb16_dsp_close
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;sb16_dsp_close()&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sb_dsp_command01
(paren
l_int|0xd9
)paren
suffix:semicolon
id|sb_dsp_command01
(paren
l_int|0xd5
)paren
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|RELEASE_DMA_CHN
(paren
id|dma8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma16
op_ne
id|dma8
)paren
id|RELEASE_DMA_CHN
(paren
id|dma16
)paren
suffix:semicolon
id|sb_free_irq
(paren
)paren
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_busy
op_assign
l_int|0
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb16_dsp_output_block
id|sb16_dsp_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|dma_restart
)paren
(brace
r_int
r_int
id|flags
comma
id|cnt
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|dsp_16bit
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
macro_line|#ifdef DEB_DMARES
id|printk
(paren
l_string|&quot;output_block: %x %d %d&bslash;n&quot;
comma
id|buf
comma
id|count
comma
id|intrflag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intrflag
)paren
(brace
r_int
id|pos
comma
id|chan
op_assign
id|sound_dsp_dmachan
(braket
id|dev
)braket
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|clear_dma_ff
(paren
id|chan
)paren
suffix:semicolon
id|disable_dma
(paren
id|chan
)paren
suffix:semicolon
id|pos
op_assign
id|get_dma_residue
(paren
id|chan
)paren
suffix:semicolon
id|enable_dma
(paren
id|chan
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;dmapos=%d %x&bslash;n&quot;
comma
id|pos
comma
id|pos
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|sound_dma_automode
(braket
id|dev
)braket
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|dsp_count
)paren
(brace
id|irq_mode
op_assign
id|IMODE_OUTPUT
suffix:semicolon
id|intr_active
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Auto mode on. No need to react */
)brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_restart
)paren
(brace
id|sb16_dsp_halt
(paren
id|dev
)paren
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
)brace
id|sb_dsp_command
(paren
l_int|0x41
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|dsp_current_speed
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|dsp_current_speed
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|dsp_16bit
ques
c_cond
l_int|0xb6
suffix:colon
l_int|0xc6
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|dsp_stereo
ques
c_cond
l_int|0x20
suffix:colon
l_int|0
)paren
op_plus
(paren
id|dsp_16bit
ques
c_cond
l_int|0x10
suffix:colon
l_int|0
)paren
)paren
)paren
suffix:semicolon
id|sb_dsp_command01
(paren
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|cnt
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* sb_dsp_command (0);&n;     sb_dsp_command (0); */
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|dsp_count
op_assign
id|cnt
suffix:semicolon
id|irq_mode
op_assign
id|IMODE_OUTPUT
suffix:semicolon
id|intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb16_dsp_start_input
id|sb16_dsp_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|dma_restart
)paren
(brace
r_int
r_int
id|flags
comma
id|cnt
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|dsp_16bit
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
id|cnt
op_decrement
suffix:semicolon
macro_line|#ifdef DEB_DMARES
id|printk
(paren
l_string|&quot;start_input: %x %d %d&bslash;n&quot;
comma
id|buf
comma
id|count
comma
id|intrflag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intrflag
)paren
(brace
r_int
id|pos
comma
id|chan
op_assign
id|sound_dsp_dmachan
(braket
id|dev
)braket
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|clear_dma_ff
(paren
id|chan
)paren
suffix:semicolon
id|disable_dma
(paren
id|chan
)paren
suffix:semicolon
id|pos
op_assign
id|get_dma_residue
(paren
id|chan
)paren
suffix:semicolon
id|enable_dma
(paren
id|chan
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;dmapos=%d %x&bslash;n&quot;
comma
id|pos
comma
id|pos
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|sound_dma_automode
(braket
id|dev
)braket
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|dsp_count
)paren
(brace
id|irq_mode
op_assign
id|IMODE_INPUT
suffix:semicolon
id|intr_active
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Auto mode on. No need to react */
)brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_restart
)paren
(brace
id|sb16_dsp_halt
(paren
id|dev
)paren
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
)brace
id|sb_dsp_command
(paren
l_int|0x42
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|dsp_current_speed
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|dsp_current_speed
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|dsp_16bit
ques
c_cond
l_int|0xbe
suffix:colon
l_int|0xce
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|dsp_stereo
ques
c_cond
l_int|0x20
suffix:colon
l_int|0
)paren
op_plus
(paren
id|dsp_16bit
ques
c_cond
l_int|0x10
suffix:colon
l_int|0
)paren
)paren
)paren
suffix:semicolon
id|sb_dsp_command01
(paren
(paren
r_int
r_char
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|cnt
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* sb_dsp_command (0);&n;     sb_dsp_command (0); */
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|dsp_count
op_assign
id|cnt
suffix:semicolon
id|irq_mode
op_assign
id|IMODE_INPUT
suffix:semicolon
id|intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb16_dsp_prepare_for_input
id|sb16_dsp_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
id|sound_dsp_dmachan
(braket
id|my_dev
)braket
op_assign
id|dsp_16bit
ques
c_cond
id|dma16
suffix:colon
id|dma8
suffix:semicolon
id|dsp_count
op_assign
l_int|0
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb16_dsp_prepare_for_output
id|sb16_dsp_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
id|sound_dsp_dmachan
(braket
id|my_dev
)braket
op_assign
id|dsp_16bit
ques
c_cond
id|dma16
suffix:colon
id|dma8
suffix:semicolon
id|dsp_count
op_assign
l_int|0
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|dsp_cleanup
id|dsp_cleanup
(paren
r_void
)paren
(brace
id|irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
id|intr_active
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb16_dsp_reset
id|sb16_dsp_reset
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb16_dsp_halt
id|sb16_dsp_halt
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dsp_16bit
)paren
(brace
id|sb_dsp_command01
(paren
l_int|0xd9
)paren
suffix:semicolon
id|sb_dsp_command01
(paren
l_int|0xd5
)paren
suffix:semicolon
)brace
r_else
(brace
id|sb_dsp_command01
(paren
l_int|0xda
)paren
suffix:semicolon
id|sb_dsp_command01
(paren
l_int|0xd0
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|set_irq_hw
id|set_irq_hw
(paren
r_int
id|level
)paren
(brace
r_int
id|ival
suffix:semicolon
r_switch
c_cond
(paren
id|level
)paren
(brace
r_case
l_int|5
suffix:colon
id|ival
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|ival
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|ival
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;SB16_IRQ_LEVEL %d does not exist&bslash;n&quot;
comma
id|level
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sb_setmixer
(paren
id|IRQ_NR
comma
id|ival
)paren
suffix:semicolon
)brace
r_int
DECL|function|sb16_dsp_init
id|sb16_dsp_init
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_if
c_cond
(paren
id|sbc_major
OL
l_int|4
)paren
r_return
id|mem_start
suffix:semicolon
macro_line|#ifndef SCO
id|sprintf
(paren
id|sb16_dsp_operations.name
comma
l_string|&quot;SoundBlaster 16 %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
macro_line|#endif
id|printk
(paren
l_string|&quot; &lt;%s&gt;&quot;
comma
id|sb16_dsp_operations.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_dspdevs
OL
id|MAX_DSP_DEV
)paren
(brace
id|dsp_devs
(braket
id|my_dev
op_assign
id|num_dspdevs
op_increment
)braket
op_assign
op_amp
id|sb16_dsp_operations
suffix:semicolon
id|sound_dsp_dmachan
(braket
id|my_dev
)braket
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|sound_buffcounts
(braket
id|my_dev
)braket
op_assign
l_int|1
suffix:semicolon
id|sound_buffsizes
(braket
id|my_dev
)braket
op_assign
id|DSP_BUFFSIZE
suffix:semicolon
id|sound_dma_automode
(braket
id|my_dev
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB: Too many DSP devices available&bslash;n&quot;
)paren
suffix:semicolon
id|sb16_dsp_ok
op_assign
l_int|1
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_int
DECL|function|sb16_dsp_detect
id|sb16_dsp_detect
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_struct
id|address_info
op_star
id|sb_config
suffix:semicolon
r_if
c_cond
(paren
id|sb16_dsp_ok
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Already initialized */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb_config
op_assign
id|sound_getconf
(paren
id|SNDCARD_SB
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;SB16 Error: Plain SB not configured&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* sb_setmixer(OPSW,0xf);&n;     if(sb_getmixer(OPSW)!=0xf)&n;     return 0; */
r_if
c_cond
(paren
op_logical_neg
id|sb_reset_dsp
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;dma
OL
l_int|4
)paren
r_if
c_cond
(paren
id|hw_config-&gt;dma
op_ne
id|sb_config-&gt;dma
)paren
(brace
id|printk
(paren
l_string|&quot;SB16 Error: Invalid DMA channel %d/%d&bslash;n&quot;
comma
id|sb_config-&gt;dma
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dma16
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|dma8
op_assign
id|sb_config-&gt;dma
suffix:semicolon
id|set_irq_hw
(paren
id|sb_config-&gt;irq
)paren
suffix:semicolon
id|sb_setmixer
(paren
id|DMA_NR
comma
(paren
l_int|1
op_lshift
id|hw_config-&gt;dma
)paren
op_or
(paren
l_int|1
op_lshift
id|sb_config-&gt;dma
)paren
)paren
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;SoundBlaster 16: IRQ %d DMA %d OK&bslash;n&quot;
comma
id|sb_config-&gt;irq
comma
id|hw_config-&gt;dma
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;   dsp_showmessage(0xe3,99);&n; */
id|sb16_dsp_ok
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|sb16_dsp_interrupt
id|sb16_dsp_interrupt
(paren
r_int
id|unused
)paren
(brace
r_int
id|data
suffix:semicolon
id|data
op_assign
id|INB
(paren
id|DSP_DATA_AVL16
)paren
suffix:semicolon
multiline_comment|/* Interrupt acknowledge */
r_if
c_cond
(paren
id|intr_active
)paren
r_switch
c_cond
(paren
id|irq_mode
)paren
(brace
r_case
id|IMODE_OUTPUT
suffix:colon
id|intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_outputintr
(paren
id|my_dev
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INPUT
suffix:colon
id|intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_inputintr
(paren
id|my_dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;SoundBlaster: Unexpected interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
