DECL|macro|_PAS2_PCM_C_
mdefine_line|#define _PAS2_PCM_C_
multiline_comment|/*&n; * sound/pas2_pcm.c&n; * &n; * The low level driver for the Pro Audio Spectrum ADC/DAC.&n; * &n; * Copyright by Hannu Savolainen 1993&n; * &n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; * &n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; * &n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#ifdef CONFIGURE_SOUNDCARD
macro_line|#include &quot;pas.h&quot;
macro_line|#if !defined(EXCLUDE_PAS) &amp;&amp; !defined(EXCLUDE_AUDIO)
DECL|macro|TRACE
mdefine_line|#define TRACE(WHAT)&t;&t;/* (WHAT) */
DECL|macro|PAS_PCM_INTRBITS
mdefine_line|#define PAS_PCM_INTRBITS (0x08)
multiline_comment|/* Sample buffer timer interrupt enable */
DECL|macro|PCM_NON
mdefine_line|#define PCM_NON&t;0
DECL|macro|PCM_DAC
mdefine_line|#define PCM_DAC&t;1
DECL|macro|PCM_ADC
mdefine_line|#define PCM_ADC&t;2
DECL|variable|pcm_speed
r_static
r_int
r_int
id|pcm_speed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sampling rate */
DECL|variable|pcm_channels
r_static
r_int
r_char
id|pcm_channels
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* channels/sample (1 or 2) */
DECL|variable|pcm_bits
r_static
r_int
r_char
id|pcm_bits
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* bits/sample (8 or 16) */
DECL|variable|pcm_filter
r_static
r_int
r_char
id|pcm_filter
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* filter FLAG */
DECL|variable|pcm_mode
r_static
r_int
r_char
id|pcm_mode
op_assign
id|PCM_NON
suffix:semicolon
DECL|variable|pcm_count
r_static
r_int
r_int
id|pcm_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|pcm_bitsok
r_static
r_int
r_int
id|pcm_bitsok
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* mask of OK bits */
DECL|variable|my_devnum
r_static
r_int
id|my_devnum
op_assign
l_int|0
suffix:semicolon
r_int
DECL|function|pcm_set_speed
id|pcm_set_speed
(paren
r_int
id|arg
)paren
(brace
r_int
id|foo
comma
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|44100
)paren
id|arg
op_assign
l_int|44100
suffix:semicolon
r_if
c_cond
(paren
id|arg
OL
l_int|5000
)paren
id|arg
op_assign
l_int|5000
suffix:semicolon
id|foo
op_assign
l_int|1193180
op_div
id|arg
suffix:semicolon
id|arg
op_assign
l_int|1193180
op_div
id|foo
suffix:semicolon
r_if
c_cond
(paren
id|pcm_channels
op_amp
l_int|2
)paren
id|foo
op_assign
id|foo
op_rshift
l_int|1
suffix:semicolon
id|pcm_speed
op_assign
id|arg
suffix:semicolon
id|tmp
op_assign
id|pas_read
(paren
id|FILTER_FREQUENCY
)paren
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|pas_write
(paren
id|tmp
op_amp
op_complement
(paren
id|F_F_PCM_RATE_COUNTER
op_or
id|F_F_PCM_BUFFER_COUNTER
)paren
comma
id|FILTER_FREQUENCY
)paren
suffix:semicolon
id|pas_write
(paren
id|S_C_C_SAMPLE_RATE
op_or
id|S_C_C_LSB_THEN_MSB
op_or
id|S_C_C_SQUARE_WAVE
comma
id|SAMPLE_COUNTER_CONTROL
)paren
suffix:semicolon
id|pas_write
(paren
id|foo
op_amp
l_int|0xff
comma
id|SAMPLE_RATE_TIMER
)paren
suffix:semicolon
id|pas_write
(paren
(paren
id|foo
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|SAMPLE_RATE_TIMER
)paren
suffix:semicolon
id|pas_write
(paren
id|tmp
comma
id|FILTER_FREQUENCY
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_return
id|pcm_speed
suffix:semicolon
)brace
r_int
DECL|function|pcm_set_channels
id|pcm_set_channels
(paren
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
(paren
id|arg
op_ne
l_int|1
)paren
op_logical_and
(paren
id|arg
op_ne
l_int|2
)paren
)paren
r_return
id|pcm_channels
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_ne
id|pcm_channels
)paren
(brace
id|pas_write
(paren
id|pas_read
(paren
id|PCM_CONTROL
)paren
op_xor
id|P_C_PCM_MONO
comma
id|PCM_CONTROL
)paren
suffix:semicolon
id|pcm_channels
op_assign
id|arg
suffix:semicolon
id|pcm_set_speed
(paren
id|pcm_speed
)paren
suffix:semicolon
multiline_comment|/* The speed must be reinitialized */
)brace
r_return
id|pcm_channels
suffix:semicolon
)brace
r_int
DECL|function|pcm_set_bits
id|pcm_set_bits
(paren
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
(paren
id|arg
op_amp
id|pcm_bitsok
)paren
op_ne
id|arg
)paren
r_return
id|pcm_bits
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_ne
id|pcm_bits
)paren
(brace
id|pas_write
(paren
id|pas_read
(paren
id|SYSTEM_CONFIGURATION_2
)paren
op_xor
id|S_C_2_PCM_16_BIT
comma
id|SYSTEM_CONFIGURATION_2
)paren
suffix:semicolon
id|pcm_bits
op_assign
id|arg
suffix:semicolon
)brace
r_return
id|pcm_bits
suffix:semicolon
)brace
r_static
r_int
DECL|function|pas_pcm_ioctl
id|pas_pcm_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|local
)paren
(brace
id|TRACE
(paren
id|printk
(paren
l_string|&quot;pas2_pcm.c: static int pas_pcm_ioctl(unsigned int cmd = %X, unsigned int arg = %X)&bslash;n&quot;
comma
id|cmd
comma
id|arg
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SOUND_PCM_WRITE_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|pcm_set_speed
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|pcm_set_speed
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|pcm_speed
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|pcm_speed
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|pcm_set_channels
(paren
id|arg
op_plus
l_int|1
)paren
op_minus
l_int|1
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|pcm_set_channels
(paren
id|IOCTL_IN
(paren
id|arg
)paren
op_plus
l_int|1
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|pcm_set_channels
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|pcm_set_channels
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|pcm_channels
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|pcm_channels
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SAMPLESIZE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|pcm_set_bits
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|pcm_set_bits
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|pcm_bits
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|pcm_bits
)paren
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
multiline_comment|/* NOT YET IMPLEMENTED */
r_if
c_cond
(paren
id|IOCTL_IN
(paren
id|arg
)paren
OG
l_int|1
)paren
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|RET_ERROR
(paren
id|EINVAL
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
id|pcm_filter
op_assign
id|IOCTL_IN
(paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|pcm_filter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|pas_pcm_reset
id|pas_pcm_reset
(paren
r_int
id|dev
)paren
(brace
id|TRACE
(paren
id|printk
(paren
l_string|&quot;pas2_pcm.c: static void pas_pcm_reset(void)&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|pas_write
(paren
id|pas_read
(paren
id|PCM_CONTROL
)paren
op_amp
op_complement
id|P_C_PCM_ENABLE
comma
id|PCM_CONTROL
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|pas_pcm_open
id|pas_pcm_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
id|err
suffix:semicolon
id|TRACE
(paren
id|printk
(paren
l_string|&quot;pas2_pcm.c: static int pas_pcm_open(int mode = %X)&bslash;n&quot;
comma
id|mode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pas_set_intr
(paren
id|PAS_PCM_INTRBITS
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DMAbuf_open_dma
(paren
id|dev
)paren
)paren
(brace
id|pas_remove_intr
(paren
id|PAS_PCM_INTRBITS
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
id|pcm_count
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|pas_pcm_close
id|pas_pcm_close
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|TRACE
(paren
id|printk
(paren
l_string|&quot;pas2_pcm.c: static void pas_pcm_close(void)&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|pas_pcm_reset
(paren
id|dev
)paren
suffix:semicolon
id|DMAbuf_close_dma
(paren
id|dev
)paren
suffix:semicolon
id|pas_remove_intr
(paren
id|PAS_PCM_INTRBITS
)paren
suffix:semicolon
id|pcm_mode
op_assign
id|PCM_NON
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|pas_pcm_output_block
id|pas_pcm_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
r_int
r_int
id|flags
comma
id|cnt
suffix:semicolon
id|TRACE
(paren
id|printk
(paren
l_string|&quot;pas2_pcm.c: static void pas_pcm_output_block(char *buf = %P, int count = %X)&bslash;n&quot;
comma
id|buf
comma
id|count
)paren
)paren
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|sound_dsp_dmachan
(braket
id|dev
)braket
OG
l_int|3
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sound_dma_automode
(braket
id|dev
)braket
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|pcm_count
)paren
r_return
suffix:semicolon
multiline_comment|/* Auto mode on. No need to react */
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|pas_write
(paren
id|pas_read
(paren
id|PCM_CONTROL
)paren
op_amp
op_complement
id|P_C_PCM_ENABLE
comma
id|PCM_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|restart_dma
)paren
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound_dsp_dmachan
(braket
id|dev
)braket
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
id|pcm_count
)paren
(brace
id|pas_write
(paren
id|pas_read
(paren
id|FILTER_FREQUENCY
)paren
op_amp
op_complement
id|F_F_PCM_BUFFER_COUNTER
comma
id|FILTER_FREQUENCY
)paren
suffix:semicolon
id|pas_write
(paren
id|S_C_C_SAMPLE_BUFFER
op_or
id|S_C_C_LSB_THEN_MSB
op_or
id|S_C_C_SQUARE_WAVE
comma
id|SAMPLE_COUNTER_CONTROL
)paren
suffix:semicolon
id|pas_write
(paren
id|count
op_amp
l_int|0xff
comma
id|SAMPLE_BUFFER_COUNTER
)paren
suffix:semicolon
id|pas_write
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|SAMPLE_BUFFER_COUNTER
)paren
suffix:semicolon
id|pas_write
(paren
id|pas_read
(paren
id|FILTER_FREQUENCY
)paren
op_or
id|F_F_PCM_BUFFER_COUNTER
comma
id|FILTER_FREQUENCY
)paren
suffix:semicolon
id|pcm_count
op_assign
id|count
suffix:semicolon
)brace
id|pas_write
(paren
id|pas_read
(paren
id|FILTER_FREQUENCY
)paren
op_or
id|F_F_PCM_BUFFER_COUNTER
op_or
id|F_F_PCM_RATE_COUNTER
comma
id|FILTER_FREQUENCY
)paren
suffix:semicolon
id|pas_write
(paren
id|pas_read
(paren
id|PCM_CONTROL
)paren
op_or
id|P_C_PCM_ENABLE
op_or
id|P_C_PCM_DAC_MODE
comma
id|PCM_CONTROL
)paren
suffix:semicolon
id|pcm_mode
op_assign
id|PCM_DAC
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|pas_pcm_start_input
id|pas_pcm_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|TRACE
(paren
id|printk
(paren
l_string|&quot;pas2_pcm.c: static void pas_pcm_start_input(char *buf = %P, int count = %X)&bslash;n&quot;
comma
id|buf
comma
id|count
)paren
)paren
suffix:semicolon
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|sound_dsp_dmachan
(braket
id|dev
)braket
OG
l_int|3
)paren
id|cnt
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sound_dma_automode
(braket
id|my_devnum
)braket
op_logical_and
id|intrflag
op_logical_and
id|cnt
op_eq
id|pcm_count
)paren
r_return
suffix:semicolon
multiline_comment|/* Auto mode on. No need to react */
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|restart_dma
)paren
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound_dsp_dmachan
(braket
id|dev
)braket
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
id|pcm_count
)paren
(brace
id|pas_write
(paren
id|pas_read
(paren
id|FILTER_FREQUENCY
)paren
op_amp
op_complement
id|F_F_PCM_BUFFER_COUNTER
comma
id|FILTER_FREQUENCY
)paren
suffix:semicolon
id|pas_write
(paren
id|S_C_C_SAMPLE_BUFFER
op_or
id|S_C_C_LSB_THEN_MSB
op_or
id|S_C_C_SQUARE_WAVE
comma
id|SAMPLE_COUNTER_CONTROL
)paren
suffix:semicolon
id|pas_write
(paren
id|count
op_amp
l_int|0xff
comma
id|SAMPLE_BUFFER_COUNTER
)paren
suffix:semicolon
id|pas_write
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|SAMPLE_BUFFER_COUNTER
)paren
suffix:semicolon
id|pas_write
(paren
id|pas_read
(paren
id|FILTER_FREQUENCY
)paren
op_or
id|F_F_PCM_BUFFER_COUNTER
comma
id|FILTER_FREQUENCY
)paren
suffix:semicolon
id|pcm_count
op_assign
id|count
suffix:semicolon
)brace
id|pas_write
(paren
id|pas_read
(paren
id|FILTER_FREQUENCY
)paren
op_or
id|F_F_PCM_BUFFER_COUNTER
op_or
id|F_F_PCM_RATE_COUNTER
comma
id|FILTER_FREQUENCY
)paren
suffix:semicolon
id|pas_write
(paren
(paren
id|pas_read
(paren
id|PCM_CONTROL
)paren
op_or
id|P_C_PCM_ENABLE
)paren
op_amp
op_complement
id|P_C_PCM_DAC_MODE
comma
id|PCM_CONTROL
)paren
suffix:semicolon
id|pcm_mode
op_assign
id|PCM_ADC
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|pas_pcm_prepare_for_input
id|pas_pcm_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|pas_pcm_prepare_for_output
id|pas_pcm_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pas_pcm_operations
r_static
r_struct
id|audio_operations
id|pas_pcm_operations
op_assign
(brace
l_string|&quot;Pro Audio Spectrum&quot;
comma
id|pas_pcm_open
comma
multiline_comment|/* */
id|pas_pcm_close
comma
multiline_comment|/* */
id|pas_pcm_output_block
comma
multiline_comment|/* */
id|pas_pcm_start_input
comma
multiline_comment|/* */
id|pas_pcm_ioctl
comma
multiline_comment|/* */
id|pas_pcm_prepare_for_input
comma
multiline_comment|/* */
id|pas_pcm_prepare_for_output
comma
multiline_comment|/* */
id|pas_pcm_reset
comma
multiline_comment|/* */
id|pas_pcm_reset
comma
multiline_comment|/* halt_xfer */
l_int|NULL
comma
multiline_comment|/* has_output_drained */
l_int|NULL
multiline_comment|/* copy_from_user */
)brace
suffix:semicolon
r_int
DECL|function|pas_pcm_init
id|pas_pcm_init
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|TRACE
(paren
id|printk
(paren
l_string|&quot;pas2_pcm.c: long pas_pcm_init(long mem_start = %X)&bslash;n&quot;
comma
id|mem_start
)paren
)paren
suffix:semicolon
id|pcm_bitsok
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|pas_read
(paren
id|OPERATION_MODE_1
)paren
op_amp
id|O_M_1_PCM_TYPE
)paren
id|pcm_bitsok
op_or_assign
l_int|16
suffix:semicolon
id|pcm_set_speed
(paren
id|DSP_DEFAULT_SPEED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_dspdevs
OL
id|MAX_DSP_DEV
)paren
(brace
id|dsp_devs
(braket
id|my_devnum
op_assign
id|num_dspdevs
op_increment
)braket
op_assign
op_amp
id|pas_pcm_operations
suffix:semicolon
id|sound_dsp_dmachan
(braket
id|my_devnum
)braket
op_assign
id|hw_config-&gt;dma
suffix:semicolon
macro_line|#ifndef PAS_NO_AUTODMA
r_if
c_cond
(paren
id|hw_config-&gt;dma
OG
l_int|3
)paren
(brace
id|sound_buffcounts
(braket
id|my_devnum
)braket
op_assign
l_int|1
suffix:semicolon
id|sound_buffsizes
(braket
id|my_devnum
)braket
op_assign
l_int|2
op_star
l_int|65536
suffix:semicolon
id|sound_dma_automode
(braket
id|my_devnum
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|sound_buffcounts
(braket
id|my_devnum
)braket
op_assign
l_int|1
suffix:semicolon
id|sound_buffsizes
(braket
id|my_devnum
)braket
op_assign
id|DSP_BUFFSIZE
suffix:semicolon
id|sound_dma_automode
(braket
id|my_devnum
)braket
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#else
id|sound_buffcounts
(braket
id|my_devnum
)braket
op_assign
l_int|2
suffix:semicolon
id|sound_buffsizes
(braket
id|my_devnum
)braket
op_assign
id|DSP_BUFFSIZE
suffix:semicolon
id|sound_dma_automode
(braket
id|my_devnum
)braket
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_else
id|printk
(paren
l_string|&quot;PAS2: Too many PCM devices available&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_void
DECL|function|pas_pcm_interrupt
id|pas_pcm_interrupt
(paren
r_int
r_char
id|status
comma
r_int
id|cause
)paren
(brace
r_if
c_cond
(paren
id|cause
op_eq
l_int|1
)paren
multiline_comment|/* PCM buffer done */
(brace
multiline_comment|/*&n;       * Halt the PCM first. Otherwise we don&squot;t have time to start a new&n;       * block before the PCM chip proceeds to the next sample&n;       */
r_if
c_cond
(paren
op_logical_neg
id|sound_dma_automode
(braket
id|my_devnum
)braket
)paren
(brace
id|pas_write
(paren
id|pas_read
(paren
id|PCM_CONTROL
)paren
op_amp
op_complement
id|P_C_PCM_ENABLE
comma
id|PCM_CONTROL
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pcm_mode
)paren
(brace
r_case
id|PCM_DAC
suffix:colon
id|DMAbuf_outputintr
(paren
id|my_devnum
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCM_ADC
suffix:colon
id|DMAbuf_inputintr
(paren
id|my_devnum
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;PAS: Unexpected PCM interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
macro_line|#endif
eof
