multiline_comment|/*&n; * sound/sound_pnp.c&n; *&n; * PnP soundcard support (Linux spesific)&n; *&n; * Copyright by Hannu Savolainen 1995&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_PNP)
macro_line|#include &lt;linux/pnp.h&gt;
DECL|variable|pnp_devs
r_static
r_struct
id|pnp_sounddev
op_star
id|pnp_devs
(braket
l_int|20
)braket
op_assign
(brace
l_int|NULL
)brace
suffix:semicolon
DECL|variable|max_pnpdevs
r_static
r_int
id|max_pnpdevs
op_assign
l_int|20
suffix:semicolon
DECL|variable|nr_pnpdevs
r_static
r_int
id|nr_pnpdevs
op_assign
l_int|0
suffix:semicolon
DECL|variable|pnp_sig
r_static
r_int
id|pnp_sig
op_assign
l_int|0
suffix:semicolon
r_void
DECL|function|install_pnp_sounddrv
id|install_pnp_sounddrv
(paren
r_struct
id|pnp_sounddev
op_star
id|drv
)paren
(brace
r_if
c_cond
(paren
id|nr_pnpdevs
OL
id|max_pnpdevs
)paren
(brace
id|pnp_devs
(braket
id|nr_pnpdevs
op_increment
)braket
op_assign
id|drv
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;Sound: More than 20 PnP drivers defined&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_void
DECL|function|cs4232_pnp
id|cs4232_pnp
(paren
r_void
op_star
id|parm
)paren
(brace
r_struct
id|pnp_dev
op_star
id|dev
op_assign
(paren
r_struct
id|pnp_dev
op_star
)paren
id|parm
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
id|portmask
op_assign
l_int|0x00
comma
id|irqmask
op_assign
l_int|0x01
comma
id|dmamask
op_assign
l_int|0x03
suffix:semicolon
r_int
id|opl3_driver
comma
id|wss_driver
suffix:semicolon
id|printk
(paren
l_string|&quot;CS4232 driver waking up&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;card
op_logical_and
id|dev-&gt;card-&gt;name
)paren
id|name
op_assign
id|dev-&gt;card-&gt;name
suffix:semicolon
r_else
id|name
op_assign
l_string|&quot;PnP WSS&quot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wss_driver
op_assign
id|sndtable_identify_card
(paren
l_string|&quot;AD1848&quot;
)paren
)paren
)paren
id|portmask
op_or_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* MSS */
r_else
id|printk
(paren
l_string|&quot;Sound: MSS/WSS device detected but no driver enabled&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|opl3_driver
op_assign
id|sndtable_identify_card
(paren
l_string|&quot;OPL3&quot;
)paren
)paren
)paren
id|portmask
op_or_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* OPL3 */
r_else
id|printk
(paren
l_string|&quot;Sound: OPL3/4 device detected but no driver enabled&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;WSS driver %d, OPL3 driver %d&bslash;n&quot;
comma
id|wss_driver
comma
id|opl3_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|portmask
)paren
multiline_comment|/* No drivers available */
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pnp_allocate_device
(paren
id|pnp_sig
comma
id|dev
comma
id|portmask
comma
id|irqmask
comma
id|dmamask
comma
l_int|0x00
)paren
)paren
id|printk
(paren
l_string|&quot;Device activation failed&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_struct
id|address_info
id|hw_config
suffix:semicolon
r_int
id|wss_base
comma
id|opl3_base
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_int
id|dma1
comma
id|dma2
suffix:semicolon
id|printk
(paren
l_string|&quot;Device activation OK&bslash;n&quot;
)paren
suffix:semicolon
id|wss_base
op_assign
id|pnp_get_port
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|opl3_base
op_assign
id|pnp_get_port
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|irq
op_assign
id|pnp_get_irq
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|dma1
op_assign
id|pnp_get_dma
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|dma2
op_assign
id|pnp_get_dma
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;I/O0 %03x&bslash;n&quot;
comma
id|wss_base
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;I/O1 %03x&bslash;n&quot;
comma
id|opl3_base
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;IRQ %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DMA0 %d&bslash;n&quot;
comma
id|dma1
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;DMA1 %d&bslash;n&quot;
comma
id|dma2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opl3_base
op_logical_and
id|opl3_driver
)paren
(brace
id|hw_config.io_base
op_assign
id|opl3_base
suffix:semicolon
id|hw_config.irq
op_assign
l_int|0
suffix:semicolon
id|hw_config.dma
op_assign
op_minus
l_int|1
suffix:semicolon
id|hw_config.dma2
op_assign
op_minus
l_int|1
suffix:semicolon
id|hw_config.always_detect
op_assign
l_int|0
suffix:semicolon
id|hw_config.name
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|hw_config.driver_use_1
op_assign
l_int|0
suffix:semicolon
id|hw_config.driver_use_2
op_assign
l_int|0
suffix:semicolon
id|hw_config.osp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sndtable_probe
(paren
id|opl3_driver
comma
op_amp
id|hw_config
)paren
)paren
id|sndtable_init_card
(paren
id|opl3_driver
comma
op_amp
id|hw_config
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wss_base
op_logical_and
id|wss_driver
)paren
(brace
id|hw_config.io_base
op_assign
id|wss_base
suffix:semicolon
id|hw_config.irq
op_assign
id|irq
suffix:semicolon
id|hw_config.dma
op_assign
id|dma1
suffix:semicolon
id|hw_config.dma2
op_assign
(paren
id|dma2
op_eq
id|NO_DMA
)paren
ques
c_cond
id|dma1
suffix:colon
id|dma2
suffix:semicolon
id|hw_config.always_detect
op_assign
l_int|0
suffix:semicolon
id|hw_config.name
op_assign
id|name
suffix:semicolon
id|hw_config.driver_use_1
op_assign
l_int|0
suffix:semicolon
id|hw_config.driver_use_2
op_assign
l_int|0
suffix:semicolon
id|hw_config.osp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sndtable_probe
(paren
id|wss_driver
comma
op_amp
id|hw_config
)paren
)paren
id|sndtable_init_card
(paren
id|wss_driver
comma
op_amp
id|hw_config
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_int
DECL|function|pnp_activate
id|pnp_activate
(paren
r_int
id|id
comma
r_struct
id|pnp_dev
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_pnpdevs
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pnp_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|id
op_eq
id|id
)paren
(brace
id|printk
(paren
l_string|&quot;PnP dev: %08x, %s&bslash;n&quot;
comma
id|id
comma
id|pnp_devid2asc
(paren
id|id
)paren
)paren
suffix:semicolon
id|pnp_devs
(braket
id|i
)braket
op_member_access_from_pointer
id|setup
(paren
(paren
r_void
op_star
)paren
id|dev
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|sound_pnp_init
id|sound_pnp_init
(paren
r_void
)paren
(brace
r_static
r_struct
id|pnp_sounddev
id|cs4232_dev
op_assign
(brace
id|PNP_DEVID
(paren
l_char|&squot;C&squot;
comma
l_char|&squot;S&squot;
comma
l_char|&squot;C&squot;
comma
l_int|0x0000
)paren
comma
id|cs4232_pnp
comma
l_string|&quot;CS4232&quot;
)brace
suffix:semicolon
r_struct
id|pnp_dev
op_star
id|dev
suffix:semicolon
id|install_pnp_sounddrv
(paren
op_amp
id|cs4232_dev
)paren
suffix:semicolon
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pnp_sig
op_assign
id|pnp_connect
(paren
l_string|&quot;sound&quot;
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;Sound: Can&squot;t connect to kernel PnP services.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pnp_get_next_device
(paren
id|pnp_sig
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pnp_activate
(paren
id|dev-&gt;key
comma
id|dev
)paren
)paren
(brace
multiline_comment|/* Scan all compatible devices */
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;ncompat
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pnp_activate
(paren
id|dev-&gt;compat_keys
(braket
id|i
)braket
comma
id|dev
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
)brace
r_void
DECL|function|sound_pnp_disconnect
id|sound_pnp_disconnect
(paren
r_void
)paren
(brace
id|pnp_disconnect
(paren
id|pnp_sig
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
