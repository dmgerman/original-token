multiline_comment|/*&n; * sound/sb_mixer.c&n; *&n; * The low level mixer driver for the SoundBlaster Pro and SB16 cards.&n; *&n; * Copyright by Hannu Savolainen 1994&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; * Modified:&n; *      Hunyue Yau      Jan 6 1994&n; *      Added code to support the Sound Galaxy NX Pro mixer.&n; *&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_SB) &amp;&amp; !defined(EXCLUDE_SBPRO)
DECL|macro|__SB_MIXER_C__
mdefine_line|#define __SB_MIXER_C__
macro_line|#include &quot;sb.h&quot;
macro_line|#include &quot;sb_mixer.h&quot;
DECL|macro|SB_TEST_IRQ
macro_line|#undef SB_TEST_IRQ
r_extern
r_int
id|sbc_base
suffix:semicolon
r_extern
r_int
id|Jazz16_detected
suffix:semicolon
DECL|variable|mixer_initialized
r_static
r_int
id|mixer_initialized
op_assign
l_int|0
suffix:semicolon
DECL|variable|supported_rec_devices
r_static
r_int
id|supported_rec_devices
suffix:semicolon
DECL|variable|supported_devices
r_static
r_int
id|supported_devices
suffix:semicolon
DECL|variable|recmask
r_static
r_int
id|recmask
op_assign
l_int|0
suffix:semicolon
DECL|variable|mixer_model
r_static
r_int
id|mixer_model
suffix:semicolon
DECL|variable|mixer_caps
r_static
r_int
id|mixer_caps
suffix:semicolon
DECL|variable|iomap
r_static
id|mixer_tab
op_star
id|iomap
suffix:semicolon
r_void
DECL|function|sb_setmixer
id|sb_setmixer
(paren
r_int
r_int
id|port
comma
r_int
r_int
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|OUTB
(paren
(paren
r_int
r_char
)paren
(paren
id|port
op_amp
l_int|0xff
)paren
comma
id|MIXER_ADDR
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t; * Select register&n;&t;&t;&t;&t;&t;&t;&t; */
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|OUTB
(paren
(paren
r_int
r_char
)paren
(paren
id|value
op_amp
l_int|0xff
)paren
comma
id|MIXER_DATA
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_int
DECL|function|sb_getmixer
id|sb_getmixer
(paren
r_int
r_int
id|port
)paren
(brace
r_int
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|OUTB
(paren
(paren
r_int
r_char
)paren
(paren
id|port
op_amp
l_int|0xff
)paren
comma
id|MIXER_ADDR
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t; * Select register&n;&t;&t;&t;&t;&t;&t;&t; */
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|val
op_assign
id|INB
(paren
id|MIXER_DATA
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_void
DECL|function|sb_mixer_set_stereo
id|sb_mixer_set_stereo
(paren
r_int
id|mode
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mixer_initialized
)paren
r_return
suffix:semicolon
id|sb_setmixer
(paren
id|OUT_FILTER
comma
(paren
(paren
id|sb_getmixer
(paren
id|OUT_FILTER
)paren
op_amp
op_complement
id|STEREO_DAC
)paren
op_or
(paren
id|mode
ques
c_cond
id|STEREO_DAC
suffix:colon
id|MONO_DAC
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns:&n; *      0       No mixer detected.&n; *      1       Only a plain Sound Blaster Pro style mixer detected.&n; *      2       The Sound Galaxy NX Pro mixer detected.&n; */
r_static
r_int
DECL|function|detect_mixer
id|detect_mixer
(paren
r_void
)paren
(brace
macro_line|#ifdef __SGNXPRO__
r_int
id|oldbass
comma
id|oldtreble
suffix:semicolon
macro_line|#endif
r_int
id|retcode
op_assign
l_int|1
suffix:semicolon
r_extern
r_int
id|sbc_major
suffix:semicolon
multiline_comment|/*&n;   * Detect the mixer by changing parameters of two volume channels. If the&n;   * values read back match with the values written, the mixer is there (is&n;   * it?)&n;   */
id|sb_setmixer
(paren
id|FM_VOL
comma
l_int|0xff
)paren
suffix:semicolon
id|sb_setmixer
(paren
id|VOC_VOL
comma
l_int|0x33
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_getmixer
(paren
id|FM_VOL
)paren
op_ne
l_int|0xff
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * No match&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|sb_getmixer
(paren
id|VOC_VOL
)paren
op_ne
l_int|0x33
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef __SGNXPRO__
multiline_comment|/* Attempt to detect the SG NX Pro by check for valid bass/treble&n;     * registers.&n;   */
id|oldbass
op_assign
id|sb_getmixer
(paren
id|BASS_LVL
)paren
suffix:semicolon
id|oldtreble
op_assign
id|sb_getmixer
(paren
id|TREBLE_LVL
)paren
suffix:semicolon
id|sb_setmixer
(paren
id|BASS_LVL
comma
l_int|0xaa
)paren
suffix:semicolon
id|sb_setmixer
(paren
id|TREBLE_LVL
comma
l_int|0x55
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sb_getmixer
(paren
id|BASS_LVL
)paren
op_ne
l_int|0xaa
)paren
op_logical_or
(paren
id|sb_getmixer
(paren
id|TREBLE_LVL
)paren
op_ne
l_int|0x55
)paren
)paren
(brace
id|retcode
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 == Only SB Pro detected */
)brace
r_else
id|retcode
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* 2 == SG NX Pro detected */
multiline_comment|/* Restore register in either case since SG NX Pro has EEPROM with&n;   * &squot;preferred&squot; values stored.&n;   */
id|sb_setmixer
(paren
id|BASS_LVL
comma
id|oldbass
)paren
suffix:semicolon
id|sb_setmixer
(paren
id|TREBLE_LVL
comma
id|oldtreble
)paren
suffix:semicolon
multiline_comment|/*&n;     * If the SB version is 3.X (SB Pro), assume we have a SG NX Pro 16.&n;     * In this case it&squot;s good idea to disable the Disney Sound Source&n;     * compatibility mode. It&squot;s useless and just causes noise every time the&n;     * LPT-port is accessed.&n;     *&n;     * Also place the card into WSS mode.&n;   */
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|3
)paren
(brace
id|OUTB
(paren
l_int|0x01
comma
id|sbc_base
op_plus
l_int|0x1c
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0x00
comma
id|sbc_base
op_plus
l_int|0x1a
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|retcode
suffix:semicolon
)brace
r_static
r_void
DECL|function|change_bits
id|change_bits
(paren
r_int
r_char
op_star
id|regval
comma
r_int
id|dev
comma
r_int
id|chn
comma
r_int
id|newval
)paren
(brace
r_int
r_char
id|mask
suffix:semicolon
r_int
id|shift
suffix:semicolon
id|mask
op_assign
(paren
l_int|1
op_lshift
(paren
op_star
id|iomap
)paren
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|nbits
)paren
op_minus
l_int|1
suffix:semicolon
id|newval
op_assign
(paren
r_int
)paren
(paren
(paren
id|newval
op_star
id|mask
)paren
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * Scale it&n;&t;&t;&t;&t;&t;&t; */
id|shift
op_assign
(paren
op_star
id|iomap
)paren
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|bitoffs
op_minus
(paren
op_star
id|iomap
)paren
(braket
id|dev
)braket
(braket
id|LEFT_CHN
)braket
dot
id|nbits
op_plus
l_int|1
suffix:semicolon
op_star
id|regval
op_and_assign
op_complement
(paren
id|mask
op_lshift
id|shift
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Filter out the previous value&n;&t;&t;&t;&t; */
op_star
id|regval
op_or_assign
(paren
id|newval
op_amp
id|mask
)paren
op_lshift
id|shift
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Set the new value&n;&t;&t;&t;&t;&t; */
)brace
r_static
r_int
DECL|function|sb_mixer_get
id|sb_mixer_get
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|1
op_lshift
id|dev
)paren
op_amp
id|supported_devices
)paren
)paren
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
r_return
id|levels
(braket
id|dev
)braket
suffix:semicolon
)brace
macro_line|#ifdef JAZZ16
DECL|variable|smw_mix_regs
r_static
r_char
id|smw_mix_regs
(braket
)braket
op_assign
multiline_comment|/* Left mixer registers */
(brace
l_int|0x0b
comma
multiline_comment|/* SOUND_MIXER_VOLUME */
l_int|0x0d
comma
multiline_comment|/* SOUND_MIXER_BASS */
l_int|0x0d
comma
multiline_comment|/* SOUND_MIXER_TREBLE */
l_int|0x05
comma
multiline_comment|/* SOUND_MIXER_SYNTH */
l_int|0x09
comma
multiline_comment|/* SOUND_MIXER_PCM */
l_int|0x00
comma
multiline_comment|/* SOUND_MIXER_SPEAKER */
l_int|0x03
comma
multiline_comment|/* SOUND_MIXER_LINE */
l_int|0x01
comma
multiline_comment|/* SOUND_MIXER_MIC */
l_int|0x07
comma
multiline_comment|/* SOUND_MIXER_CD */
l_int|0x00
comma
multiline_comment|/* SOUND_MIXER_IMIX */
l_int|0x00
comma
multiline_comment|/* SOUND_MIXER_ALTPCM */
l_int|0x00
comma
multiline_comment|/* SOUND_MIXER_RECLEV */
l_int|0x00
comma
multiline_comment|/* SOUND_MIXER_IGAIN */
l_int|0x00
comma
multiline_comment|/* SOUND_MIXER_OGAIN */
l_int|0x00
comma
multiline_comment|/* SOUND_MIXER_LINE1 */
l_int|0x00
comma
multiline_comment|/* SOUND_MIXER_LINE2 */
l_int|0x00
multiline_comment|/* SOUND_MIXER_LINE3 */
)brace
suffix:semicolon
r_static
r_void
DECL|function|smw_mixer_init
id|smw_mixer_init
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|sb_setmixer
(paren
l_int|0x00
comma
l_int|0x18
)paren
suffix:semicolon
multiline_comment|/* Mute unused (Telephone) line */
id|sb_setmixer
(paren
l_int|0x10
comma
l_int|0x38
)paren
suffix:semicolon
multiline_comment|/* Config register 2 */
id|supported_devices
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|smw_mix_regs
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|smw_mix_regs
(braket
id|i
)braket
op_ne
l_int|0
)paren
id|supported_devices
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|supported_rec_devices
op_assign
id|supported_devices
op_amp
op_complement
(paren
id|SOUND_MASK_BASS
op_or
id|SOUND_MASK_TREBLE
op_or
id|SOUND_MASK_PCM
op_or
id|SOUND_MASK_VOLUME
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|smw_mixer_set
id|smw_mixer_set
(paren
r_int
id|dev
comma
r_int
id|value
)paren
(brace
r_int
id|left
op_assign
id|value
op_amp
l_int|0x000000ff
suffix:semicolon
r_int
id|right
op_assign
(paren
id|value
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
r_int
id|reg
comma
id|val
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
id|right
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
l_int|31
)paren
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|supported_devices
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
)paren
multiline_comment|/* Not supported */
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev
)paren
(brace
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
id|sb_setmixer
(paren
l_int|0x0b
comma
l_int|96
op_minus
(paren
l_int|96
op_star
id|left
op_div
l_int|100
)paren
)paren
suffix:semicolon
multiline_comment|/* 96=mute, 0=max */
id|sb_setmixer
(paren
l_int|0x0c
comma
l_int|96
op_minus
(paren
l_int|96
op_star
id|right
op_div
l_int|100
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_BASS
suffix:colon
r_case
id|SOUND_MIXER_TREBLE
suffix:colon
id|levels
(braket
id|dev
)braket
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Set left bass and treble values */
id|val
op_assign
(paren
(paren
id|levels
(braket
id|SOUND_MIXER_TREBLE
)braket
op_amp
l_int|0xff
)paren
op_star
l_int|16
op_div
l_int|100
)paren
op_lshift
l_int|4
suffix:semicolon
id|val
op_or_assign
(paren
(paren
id|levels
(braket
id|SOUND_MIXER_BASS
)braket
op_amp
l_int|0xff
)paren
op_star
l_int|16
op_div
l_int|100
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|sb_setmixer
(paren
l_int|0x0d
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* Set right bass and treble values */
id|val
op_assign
(paren
(paren
(paren
id|levels
(braket
id|SOUND_MIXER_TREBLE
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_star
l_int|16
op_div
l_int|100
)paren
op_lshift
l_int|4
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
id|levels
(braket
id|SOUND_MIXER_BASS
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_star
l_int|16
op_div
l_int|100
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|sb_setmixer
(paren
l_int|0x0e
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|reg
op_assign
id|smw_mix_regs
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_eq
l_int|0
)paren
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
id|sb_setmixer
(paren
id|reg
comma
(paren
l_int|24
op_minus
(paren
l_int|24
op_star
id|left
op_div
l_int|100
)paren
)paren
op_or
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* 24=mute, 0=max */
id|sb_setmixer
(paren
id|reg
op_plus
l_int|1
comma
(paren
l_int|24
op_minus
(paren
l_int|24
op_star
id|right
op_div
l_int|100
)paren
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
)brace
id|levels
(braket
id|dev
)braket
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
r_return
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|sb_mixer_set
id|sb_mixer_set
(paren
r_int
id|dev
comma
r_int
id|value
)paren
(brace
r_int
id|left
op_assign
id|value
op_amp
l_int|0x000000ff
suffix:semicolon
r_int
id|right
op_assign
(paren
id|value
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
r_int
id|regoffs
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
macro_line|#ifdef JAZZ16
r_if
c_cond
(paren
id|Jazz16_detected
op_eq
l_int|2
)paren
r_return
id|smw_mixer_set
(paren
id|dev
comma
id|value
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
id|right
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|dev
OG
l_int|31
)paren
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|supported_devices
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * Not supported&n;&t;&t;&t;&t;&t;&t; */
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
id|regoffs
op_assign
(paren
op_star
id|iomap
)paren
(braket
id|dev
)braket
(braket
id|LEFT_CHN
)braket
dot
id|regno
suffix:semicolon
r_if
c_cond
(paren
id|regoffs
op_eq
l_int|0
)paren
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
id|val
op_assign
id|sb_getmixer
(paren
id|regoffs
)paren
suffix:semicolon
id|change_bits
(paren
op_amp
id|val
comma
id|dev
comma
id|LEFT_CHN
comma
id|left
)paren
suffix:semicolon
id|levels
(braket
id|dev
)braket
op_assign
id|left
op_or
(paren
id|left
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|iomap
)paren
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|regno
op_ne
id|regoffs
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t; * Change register&n;&t;&t;&t;&t;&t;&t;&t; */
(brace
id|sb_setmixer
(paren
id|regoffs
comma
id|val
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Save the old one&n;&t;&t;&t;&t;&t; */
id|regoffs
op_assign
(paren
op_star
id|iomap
)paren
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|regno
suffix:semicolon
r_if
c_cond
(paren
id|regoffs
op_eq
l_int|0
)paren
r_return
id|left
op_or
(paren
id|left
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Just left channel present&n;&t;&t;&t;&t;&t; */
id|val
op_assign
id|sb_getmixer
(paren
id|regoffs
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Read the new one&n;&t;&t;&t;&t;&t; */
)brace
id|change_bits
(paren
op_amp
id|val
comma
id|dev
comma
id|RIGHT_CHN
comma
id|right
)paren
suffix:semicolon
id|sb_setmixer
(paren
id|regoffs
comma
id|val
)paren
suffix:semicolon
id|levels
(braket
id|dev
)braket
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
r_return
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_recsrc
id|set_recsrc
(paren
r_int
id|src
)paren
(brace
id|sb_setmixer
(paren
id|RECORD_SRC
comma
(paren
id|sb_getmixer
(paren
id|RECORD_SRC
)paren
op_amp
op_complement
l_int|7
)paren
op_or
(paren
id|src
op_amp
l_int|0x7
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|set_recmask
id|set_recmask
(paren
r_int
id|mask
)paren
(brace
r_int
id|devmask
comma
id|i
suffix:semicolon
r_int
r_char
id|regimageL
comma
id|regimageR
suffix:semicolon
id|devmask
op_assign
id|mask
op_amp
id|supported_rec_devices
suffix:semicolon
r_switch
c_cond
(paren
id|mixer_model
)paren
(brace
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
id|devmask
op_ne
id|SOUND_MASK_MIC
op_logical_and
id|devmask
op_ne
id|SOUND_MASK_LINE
op_logical_and
id|devmask
op_ne
id|SOUND_MASK_CD
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * More than one devices selected. Drop the *&n;&t;&t;&t;&t; * previous selection&n;&t;&t;&t;&t; */
id|devmask
op_and_assign
op_complement
id|recmask
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devmask
op_ne
id|SOUND_MASK_MIC
op_logical_and
id|devmask
op_ne
id|SOUND_MASK_LINE
op_logical_and
id|devmask
op_ne
id|SOUND_MASK_CD
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * More than one devices selected. Default to&n;&t;&t;&t;&t; * * mic&n;&t;&t;&t;&t; */
id|devmask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devmask
op_xor
id|recmask
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * Input source changed&n;&t;&t;&t;&t; */
(brace
r_switch
c_cond
(paren
id|devmask
)paren
(brace
r_case
id|SOUND_MASK_MIC
suffix:colon
id|set_recsrc
(paren
id|SRC_MIC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_LINE
suffix:colon
id|set_recsrc
(paren
id|SRC_LINE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_CD
suffix:colon
id|set_recsrc
(paren
id|SRC_CD
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|set_recsrc
(paren
id|SRC_MIC
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|devmask
)paren
id|devmask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
id|regimageL
op_assign
id|regimageR
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_amp
id|devmask
)paren
(brace
id|regimageL
op_or_assign
id|sb16_recmasks_L
(braket
id|i
)braket
suffix:semicolon
id|regimageR
op_or_assign
id|sb16_recmasks_R
(braket
id|i
)braket
suffix:semicolon
)brace
id|sb_setmixer
(paren
id|SB16_IMASK_L
comma
id|regimageL
)paren
suffix:semicolon
id|sb_setmixer
(paren
id|SB16_IMASK_R
comma
id|regimageR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|recmask
op_assign
id|devmask
suffix:semicolon
r_return
id|recmask
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_mixer_ioctl
id|sb_mixer_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|cmd
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_eq
l_char|&squot;M&squot;
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_amp
id|IOC_IN
)paren
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|set_recmask
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|sb_mixer_set
(paren
id|cmd
op_amp
l_int|0xff
comma
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * Return parameters&n;&t;&t;&t;&t; */
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|recmask
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|supported_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
r_if
c_cond
(paren
id|Jazz16_detected
)paren
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|supported_devices
)paren
suffix:semicolon
r_else
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|supported_devices
op_amp
op_complement
(paren
id|SOUND_MASK_MIC
op_or
id|SOUND_MASK_SPEAKER
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|supported_rec_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|mixer_caps
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|sb_mixer_get
(paren
id|cmd
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
DECL|variable|sb_mixer_operations
r_static
r_struct
id|mixer_operations
id|sb_mixer_operations
op_assign
(brace
l_string|&quot;SoundBlaster&quot;
comma
id|sb_mixer_ioctl
)brace
suffix:semicolon
r_static
r_void
DECL|function|sb_mixer_reset
id|sb_mixer_reset
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
id|sb_mixer_set
(paren
id|i
comma
id|levels
(braket
id|i
)braket
)paren
suffix:semicolon
id|set_recmask
(paren
id|SOUND_MASK_MIC
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns a code depending on whether a SG NX Pro was detected.&n; * 1 == Plain SB Pro&n; * 2 == SG NX Pro detected.&n; * 3 == SB16&n; *&n; * Used to update message.&n; */
r_int
DECL|function|sb_mixer_init
id|sb_mixer_init
(paren
r_int
id|major_model
)paren
(brace
r_int
id|mixer_type
op_assign
l_int|0
suffix:semicolon
id|sb_setmixer
(paren
l_int|0x00
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Reset mixer */
r_if
c_cond
(paren
op_logical_neg
(paren
id|mixer_type
op_assign
id|detect_mixer
(paren
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No mixer. Why? */
id|mixer_initialized
op_assign
l_int|1
suffix:semicolon
id|mixer_model
op_assign
id|major_model
suffix:semicolon
r_switch
c_cond
(paren
id|major_model
)paren
(brace
r_case
l_int|3
suffix:colon
id|mixer_caps
op_assign
id|SOUND_CAP_EXCL_INPUT
suffix:semicolon
macro_line|#ifdef JAZZ16
r_if
c_cond
(paren
id|Jazz16_detected
op_eq
l_int|2
)paren
multiline_comment|/* SM Wave */
(brace
id|supported_devices
op_assign
l_int|0
suffix:semicolon
id|supported_rec_devices
op_assign
l_int|0
suffix:semicolon
id|iomap
op_assign
op_amp
id|sbpro_mix
suffix:semicolon
id|smw_mixer_init
(paren
)paren
suffix:semicolon
id|mixer_type
op_assign
l_int|1
suffix:semicolon
)brace
r_else
macro_line|#endif
macro_line|#ifdef __SGNXPRO__
r_if
c_cond
(paren
id|mixer_type
op_eq
l_int|2
)paren
multiline_comment|/* A SGNXPRO was detected */
(brace
id|supported_devices
op_assign
id|SGNXPRO_MIXER_DEVICES
suffix:semicolon
id|supported_rec_devices
op_assign
id|SGNXPRO_RECORDING_DEVICES
suffix:semicolon
id|iomap
op_assign
op_amp
id|sgnxpro_mix
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
id|supported_devices
op_assign
id|SBPRO_MIXER_DEVICES
suffix:semicolon
id|supported_rec_devices
op_assign
id|SBPRO_RECORDING_DEVICES
suffix:semicolon
id|iomap
op_assign
op_amp
id|sbpro_mix
suffix:semicolon
id|mixer_type
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|mixer_caps
op_assign
l_int|0
suffix:semicolon
id|supported_devices
op_assign
id|SB16_MIXER_DEVICES
suffix:semicolon
id|supported_rec_devices
op_assign
id|SB16_RECORDING_DEVICES
suffix:semicolon
id|iomap
op_assign
op_amp
id|sb16_mix
suffix:semicolon
id|mixer_type
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;SB Warning: Unsupported mixer type&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|num_mixers
OL
id|MAX_MIXER_DEV
)paren
id|mixer_devs
(braket
id|num_mixers
op_increment
)braket
op_assign
op_amp
id|sb_mixer_operations
suffix:semicolon
id|sb_mixer_reset
(paren
)paren
suffix:semicolon
r_return
id|mixer_type
suffix:semicolon
)brace
macro_line|#endif
eof
