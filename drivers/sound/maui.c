multiline_comment|/*&n; * sound/maui.c&n; *&n; * The low level driver for Turtle Beach Maui and Tropez.&n; *&n; *&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; *&n; *&t;Changes:&n; *&t;&t;Alan Cox&t;&t;General clean up, use kernel IRQ &n; *&t;&t;&t;&t;&t;system&n; *&t;&t;Christoph Hellwig&t;Adapted to module_init/module_exit&n; *&t;&t;Bartlomiej Zolnierkiewicz&n; *&t;&t;&t;&t;&t;Added __init to download_code()&n; *&n; *&t;Status:&n; *&t;&t;Andrew J. Kroll&t;&t;Tested 06/01/1999 with:&n; *&t;&t;&t;&t;&t;* OSWF.MOT File Version: 1.15&n; *&t;&t;&t;&t;&t;* OSWF.MOT File Dated: 09/12/94&n; *&t;&t;&t;&t;&t;* Older versions will cause problems.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|USE_SEQ_MACROS
mdefine_line|#define USE_SEQ_MACROS
DECL|macro|USE_SIMPLE_MACROS
mdefine_line|#define USE_SIMPLE_MACROS
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;sound_firmware.h&quot;
macro_line|#include &quot;mpu401.h&quot;
DECL|variable|maui_base
r_static
r_int
id|maui_base
op_assign
l_int|0x330
suffix:semicolon
DECL|variable|irq_ok
r_static
r_volatile
r_int
id|irq_ok
op_assign
l_int|0
suffix:semicolon
DECL|variable|maui_osp
r_static
r_int
op_star
id|maui_osp
suffix:semicolon
DECL|macro|HOST_DATA_PORT
mdefine_line|#define HOST_DATA_PORT&t;(maui_base + 2)
DECL|macro|HOST_STAT_PORT
mdefine_line|#define HOST_STAT_PORT&t;(maui_base + 3)
DECL|macro|HOST_CTRL_PORT
mdefine_line|#define HOST_CTRL_PORT&t;(maui_base + 3)
DECL|macro|STAT_TX_INTR
mdefine_line|#define STAT_TX_INTR&t;0x40
DECL|macro|STAT_TX_AVAIL
mdefine_line|#define STAT_TX_AVAIL&t;0x20
DECL|macro|STAT_TX_IENA
mdefine_line|#define STAT_TX_IENA&t;0x10
DECL|macro|STAT_RX_INTR
mdefine_line|#define STAT_RX_INTR&t;0x04
DECL|macro|STAT_RX_AVAIL
mdefine_line|#define STAT_RX_AVAIL&t;0x02
DECL|macro|STAT_RX_IENA
mdefine_line|#define STAT_RX_IENA&t;0x01
DECL|variable|orig_load_patch
r_static
r_int
(paren
op_star
id|orig_load_patch
)paren
(paren
r_int
id|dev
comma
r_int
id|format
comma
r_const
r_char
op_star
id|addr
comma
r_int
id|offs
comma
r_int
id|count
comma
r_int
id|pmgr_flag
)paren
op_assign
l_int|NULL
suffix:semicolon
macro_line|#include &quot;maui_boot.h&quot;
DECL|function|maui_wait
r_static
r_int
id|maui_wait
c_func
(paren
r_int
id|mask
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Perform a short initial wait without sleeping&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|inb
c_func
(paren
id|HOST_STAT_PORT
)paren
op_amp
id|mask
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Wait up to 15 seconds with sleeping&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|150
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|HOST_STAT_PORT
)paren
op_amp
id|mask
)paren
r_return
l_int|1
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|maui_read
r_static
r_int
id|maui_read
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|maui_wait
c_func
(paren
id|STAT_RX_AVAIL
)paren
)paren
r_return
id|inb
c_func
(paren
id|HOST_DATA_PORT
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|maui_write
r_static
r_int
id|maui_write
c_func
(paren
r_int
r_char
id|data
)paren
(brace
r_if
c_cond
(paren
id|maui_wait
c_func
(paren
id|STAT_TX_AVAIL
)paren
)paren
(brace
id|outb
c_func
(paren
(paren
id|data
)paren
comma
id|HOST_DATA_PORT
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Maui: Write timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mauiintr
r_static
r_void
id|mauiintr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
id|irq_ok
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|download_code
r_static
r_int
id|__init
id|download_code
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|lines
op_assign
l_int|0
suffix:semicolon
r_int
id|eol_seen
op_assign
l_int|0
comma
id|done
op_assign
l_int|0
suffix:semicolon
r_int
id|skip
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Code download (%d bytes): &quot;
comma
id|maui_osLen
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|maui_osLen
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|maui_os
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;r&squot;
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|skip
op_logical_or
(paren
id|maui_os
(braket
id|i
)braket
op_eq
l_char|&squot;S&squot;
op_logical_and
(paren
id|i
op_eq
l_int|0
op_logical_or
id|maui_os
(braket
id|i
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
)paren
)paren
(brace
id|skip
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|maui_os
(braket
id|i
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|eol_seen
op_assign
id|skip
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|maui_os
(braket
id|i
)braket
op_eq
l_char|&squot;S&squot;
)paren
(brace
r_if
c_cond
(paren
id|maui_os
(braket
id|i
op_plus
l_int|1
)braket
op_eq
l_char|&squot;8&squot;
)paren
id|done
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maui_write
c_func
(paren
l_int|0xF1
)paren
)paren
r_goto
id|failure
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maui_write
c_func
(paren
l_char|&squot;S&squot;
)paren
)paren
r_goto
id|failure
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|maui_write
c_func
(paren
id|maui_os
(braket
id|i
)braket
)paren
)paren
r_goto
id|failure
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eol_seen
)paren
(brace
r_int
id|c
op_assign
l_int|0
suffix:semicolon
r_int
id|n
suffix:semicolon
id|eol_seen
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|2
suffix:semicolon
id|n
op_increment
)paren
(brace
r_if
c_cond
(paren
id|maui_wait
c_func
(paren
id|STAT_RX_AVAIL
)paren
)paren
(brace
id|c
op_assign
id|inb
c_func
(paren
id|HOST_DATA_PORT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|c
op_ne
l_int|0x80
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Download not acknowledged&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|lines
op_increment
op_mod
l_int|10
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|done
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Download complete&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
id|failure
suffix:colon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Download failed!!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|maui_init
r_static
r_int
id|__init
id|maui_init
c_func
(paren
r_int
id|irq
)paren
(brace
r_int
r_char
id|bits
suffix:semicolon
r_switch
c_cond
(paren
id|irq
)paren
(brace
r_case
l_int|9
suffix:colon
id|bits
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|bits
op_assign
l_int|0x08
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
id|bits
op_assign
l_int|0x10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|15
suffix:colon
id|bits
op_assign
l_int|0x18
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Maui: Invalid IRQ %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outb
c_func
(paren
(paren
l_int|0x00
)paren
comma
id|HOST_CTRL_PORT
)paren
suffix:semicolon
multiline_comment|/* Reset */
id|outb
c_func
(paren
(paren
id|bits
)paren
comma
id|HOST_DATA_PORT
)paren
suffix:semicolon
multiline_comment|/* Set the IRQ bits */
id|outb
c_func
(paren
(paren
id|bits
op_or
l_int|0x80
)paren
comma
id|HOST_DATA_PORT
)paren
suffix:semicolon
multiline_comment|/* Set the IRQ bits again? */
id|outb
c_func
(paren
(paren
l_int|0x80
)paren
comma
id|HOST_CTRL_PORT
)paren
suffix:semicolon
multiline_comment|/* Leave reset */
id|outb
c_func
(paren
(paren
l_int|0x80
)paren
comma
id|HOST_CTRL_PORT
)paren
suffix:semicolon
multiline_comment|/* Leave reset */
id|outb
c_func
(paren
(paren
l_int|0xD0
)paren
comma
id|HOST_CTRL_PORT
)paren
suffix:semicolon
multiline_comment|/* Cause interrupt */
macro_line|#ifdef CONFIG_SMP
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000000
op_logical_and
op_logical_neg
id|irq_ok
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_ok
)paren
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
id|outb
c_func
(paren
(paren
l_int|0x80
)paren
comma
id|HOST_CTRL_PORT
)paren
suffix:semicolon
multiline_comment|/* Leave reset */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Turtle Beach Maui initialization&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|download_code
c_func
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0xE0
)paren
comma
id|HOST_CTRL_PORT
)paren
suffix:semicolon
multiline_comment|/* Normal operation */
multiline_comment|/* Select mpu401 mode */
id|maui_write
c_func
(paren
l_int|0xf0
)paren
suffix:semicolon
id|maui_write
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maui_read
c_func
(paren
)paren
op_ne
l_int|0x80
)paren
(brace
id|maui_write
c_func
(paren
l_int|0xf0
)paren
suffix:semicolon
id|maui_write
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maui_read
c_func
(paren
)paren
op_ne
l_int|0x80
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Maui didn&squot;t acknowledge set HW mode command&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Maui initialized OK&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|maui_short_wait
r_static
r_int
id|maui_short_wait
c_func
(paren
r_int
id|mask
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|HOST_STAT_PORT
)paren
op_amp
id|mask
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|maui_load_patch
r_static
r_int
id|maui_load_patch
c_func
(paren
r_int
id|dev
comma
r_int
id|format
comma
r_const
r_char
op_star
id|addr
comma
r_int
id|offs
comma
r_int
id|count
comma
r_int
id|pmgr_flag
)paren
(brace
r_struct
id|sysex_info
id|header
suffix:semicolon
r_int
r_int
id|left
comma
id|src_offs
suffix:semicolon
r_int
id|hdr_size
op_assign
(paren
r_int
r_int
)paren
op_amp
id|header.data
(braket
l_int|0
)braket
op_minus
(paren
r_int
r_int
)paren
op_amp
id|header
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|format
op_eq
id|SYSEX_PATCH
)paren
multiline_comment|/* Handled by midi_synth.c */
r_return
id|orig_load_patch
c_func
(paren
id|dev
comma
id|format
comma
id|addr
comma
id|offs
comma
id|count
comma
id|pmgr_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|format
op_ne
id|MAUI_PATCH
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Maui: Unknown patch format&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
id|hdr_size
)paren
(brace
multiline_comment|/*&t;&t;  printk(&quot;Maui error: Patch header too short&bslash;n&quot;);*/
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|count
op_sub_assign
id|hdr_size
suffix:semicolon
multiline_comment|/*&n;&t; * Copy the header from user space but ignore the first bytes which have&n;&t; * been transferred already.&n;&t; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
(paren
(paren
r_char
op_star
)paren
op_amp
id|header
)paren
(braket
id|offs
)braket
comma
op_amp
(paren
id|addr
)paren
(braket
id|offs
)braket
comma
id|hdr_size
op_minus
id|offs
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
id|header.len
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Maui warning: Host command record too short (%d&lt;%d)&bslash;n&quot;
comma
id|count
comma
(paren
r_int
)paren
id|header.len
)paren
suffix:semicolon
id|header.len
op_assign
id|count
suffix:semicolon
)brace
id|left
op_assign
id|header.len
suffix:semicolon
id|src_offs
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|left
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|data
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
op_star
(paren
r_int
r_char
op_star
)paren
op_amp
id|data
comma
(paren
r_int
r_char
op_star
)paren
op_amp
(paren
(paren
id|addr
)paren
(braket
id|hdr_size
op_plus
id|i
)braket
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
op_logical_and
op_logical_neg
(paren
id|data
op_amp
l_int|0x80
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|maui_write
c_func
(paren
id|data
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|maui_read
c_func
(paren
)paren
)paren
op_ne
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|i
op_ne
op_minus
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;Maui: Error status %02x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|probe_maui
r_static
r_int
id|__init
id|probe_maui
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|tmp1
comma
id|tmp2
comma
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|8
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|maui_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|maui_osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hw_config-&gt;irq
comma
id|mauiintr
comma
l_int|0
comma
l_string|&quot;Maui&quot;
comma
l_int|NULL
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the processor if necessary&n;&t; */
r_if
c_cond
(paren
id|maui_osLen
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|HOST_STAT_PORT
)paren
op_amp
id|STAT_TX_AVAIL
)paren
op_logical_or
op_logical_neg
id|maui_write
c_func
(paren
l_int|0x9F
)paren
op_logical_or
multiline_comment|/* Report firmware version */
op_logical_neg
id|maui_short_wait
c_func
(paren
id|STAT_RX_AVAIL
)paren
op_logical_or
id|maui_read
c_func
(paren
)paren
op_eq
op_minus
l_int|1
op_logical_or
id|maui_read
c_func
(paren
)paren
op_eq
op_minus
l_int|1
)paren
r_if
c_cond
(paren
op_logical_neg
id|maui_init
c_func
(paren
id|hw_config-&gt;irq
)paren
)paren
(brace
id|free_irq
c_func
(paren
id|hw_config-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|maui_write
c_func
(paren
l_int|0xCF
)paren
)paren
multiline_comment|/* Report hardware version */
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No WaveFront firmware detected (card uninitialized?)&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|hw_config-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|maui_read
c_func
(paren
)paren
)paren
op_eq
op_minus
l_int|1
op_logical_or
(paren
id|tmp2
op_assign
id|maui_read
c_func
(paren
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No WaveFront firmware detected (card uninitialized?)&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|hw_config-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp1
op_eq
l_int|0xff
op_logical_or
id|tmp2
op_eq
l_int|0xff
)paren
(brace
id|free_irq
c_func
(paren
id|hw_config-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;WaveFront hardware version %d.%d&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maui_write
c_func
(paren
l_int|0x9F
)paren
)paren
multiline_comment|/* Report firmware version */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|maui_read
c_func
(paren
)paren
)paren
op_eq
op_minus
l_int|1
op_logical_or
(paren
id|tmp2
op_assign
id|maui_read
c_func
(paren
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;WaveFront firmware version %d.%d&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maui_write
c_func
(paren
l_int|0x85
)paren
)paren
multiline_comment|/* Report free DRAM */
r_return
l_int|0
suffix:semicolon
id|tmp1
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp1
op_or_assign
id|maui_read
c_func
(paren
)paren
op_lshift
(paren
l_int|7
op_star
id|i
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Available DRAM %dk&bslash;n&quot;
comma
id|tmp1
op_div
l_int|1024
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|probe_mpu401
c_func
(paren
id|hw_config
)paren
)paren
r_break
suffix:semicolon
id|ret
op_assign
id|probe_mpu401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|request_region
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|2
comma
l_int|6
comma
l_string|&quot;Maui&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|attach_maui
r_static
r_void
id|__init
id|attach_maui
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|this_dev
suffix:semicolon
id|conf_printf
c_func
(paren
l_string|&quot;Maui&quot;
comma
id|hw_config
)paren
suffix:semicolon
id|hw_config-&gt;irq
op_mul_assign
op_minus
l_int|1
suffix:semicolon
id|hw_config-&gt;name
op_assign
l_string|&quot;Maui&quot;
suffix:semicolon
id|attach_mpu401
c_func
(paren
id|hw_config
comma
id|THIS_MODULE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;slots
(braket
l_int|1
)braket
op_ne
op_minus
l_int|1
)paren
multiline_comment|/* The MPU401 driver installed itself */
(brace
r_struct
id|synth_operations
op_star
id|synth
suffix:semicolon
id|this_dev
op_assign
id|hw_config-&gt;slots
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Intercept patch loading calls so that they can be handled&n;&t;&t; * by the Maui driver.&n;&t;&t; */
id|synth
op_assign
id|midi_devs
(braket
id|this_dev
)braket
op_member_access_from_pointer
id|converter
suffix:semicolon
id|synth-&gt;id
op_assign
l_string|&quot;MAUI&quot;
suffix:semicolon
r_if
c_cond
(paren
id|synth
op_ne
l_int|NULL
)paren
(brace
id|orig_load_patch
op_assign
id|synth-&gt;load_patch
suffix:semicolon
id|synth-&gt;load_patch
op_assign
op_amp
id|maui_load_patch
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Maui: Can&squot;t install patch loader&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|unload_maui
r_static
r_void
id|__exit
id|unload_maui
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|2
comma
l_int|6
)paren
suffix:semicolon
id|unload_mpu401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
id|irq
op_assign
op_minus
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
id|free_irq
c_func
(paren
id|irq
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|fw_load
r_static
r_int
id|fw_load
op_assign
l_int|0
suffix:semicolon
DECL|variable|cfg
r_static
r_struct
id|address_info
id|cfg
suffix:semicolon
DECL|variable|io
r_static
r_int
id|__initdata
id|io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|__initdata
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Install a Maui card. Needs mpu401 loaded already.&n; */
DECL|function|init_maui
r_static
r_int
id|__init
id|init_maui
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Turtle beach Maui and Tropez driver, Copyright (C) by Hannu Savolainen 1993-1996&bslash;n&quot;
)paren
suffix:semicolon
id|cfg.io_base
op_assign
id|io
suffix:semicolon
id|cfg.irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|cfg.io_base
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.irq
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;maui: irq and io must be set.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|maui_os
op_eq
l_int|NULL
)paren
(brace
id|fw_load
op_assign
l_int|1
suffix:semicolon
id|maui_osLen
op_assign
id|mod_firmware_load
c_func
(paren
l_string|&quot;/etc/sound/oswf.mot&quot;
comma
(paren
r_char
op_star
op_star
)paren
op_amp
id|maui_os
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|probe_maui
c_func
(paren
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|attach_maui
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_maui
r_static
r_void
id|__exit
id|cleanup_maui
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|fw_load
op_logical_and
id|maui_os
)paren
id|vfree
c_func
(paren
id|maui_os
)paren
suffix:semicolon
id|unload_maui
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
)brace
DECL|variable|init_maui
id|module_init
c_func
(paren
id|init_maui
)paren
suffix:semicolon
DECL|variable|cleanup_maui
id|module_exit
c_func
(paren
id|cleanup_maui
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|setup_maui
r_static
r_int
id|__init
id|setup_maui
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/* io, irq */
r_int
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|io
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|irq
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;maui=&quot;
comma
id|setup_maui
)paren
suffix:semicolon
macro_line|#endif
eof
