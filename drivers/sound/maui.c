multiline_comment|/*&n; * sound/maui.c&n; *&n; * The low level driver for Turtle Beach Maui and Tropez.&n; *&n; * Copyright by Hannu Savolainen 1995&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; */
DECL|macro|USE_SEQ_MACROS
mdefine_line|#define USE_SEQ_MACROS
DECL|macro|USE_SIMPLE_MACROS
mdefine_line|#define USE_SIMPLE_MACROS
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_MAUI)
DECL|variable|maui_base
r_static
r_int
id|maui_base
op_assign
l_int|0x330
suffix:semicolon
DECL|variable|irq_ok
r_static
r_volatile
r_int
id|irq_ok
op_assign
l_int|0
suffix:semicolon
DECL|variable|maui_osp
r_static
id|sound_os_info
op_star
id|maui_osp
suffix:semicolon
DECL|macro|HOST_DATA_PORT
mdefine_line|#define HOST_DATA_PORT&t;(maui_base + 2)
DECL|macro|HOST_STAT_PORT
mdefine_line|#define HOST_STAT_PORT&t;(maui_base + 3)
DECL|macro|HOST_CTRL_PORT
mdefine_line|#define HOST_CTRL_PORT&t;(maui_base + 3)
DECL|macro|STAT_TX_INTR
mdefine_line|#define STAT_TX_INTR&t;0x40
DECL|macro|STAT_TX_AVAIL
mdefine_line|#define STAT_TX_AVAIL&t;0x20
DECL|macro|STAT_TX_IENA
mdefine_line|#define STAT_TX_IENA&t;0x10
DECL|macro|STAT_RX_INTR
mdefine_line|#define STAT_RX_INTR&t;0x04
DECL|macro|STAT_RX_AVAIL
mdefine_line|#define STAT_RX_AVAIL&t;0x02
DECL|macro|STAT_RX_IENA
mdefine_line|#define STAT_RX_IENA&t;0x01
DECL|variable|orig_load_patch
r_static
r_int
(paren
op_star
id|orig_load_patch
)paren
(paren
r_int
id|dev
comma
r_int
id|format
comma
r_const
id|snd_rw_buf
op_star
id|addr
comma
r_int
id|offs
comma
r_int
id|count
comma
r_int
id|pmgr_flag
)paren
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
DECL|function|maui_read
id|maui_read
(paren
r_void
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
id|timeout
OL
l_int|1000000
suffix:semicolon
id|timeout
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inb
(paren
id|HOST_STAT_PORT
)paren
op_amp
id|STAT_RX_AVAIL
)paren
(brace
r_return
id|inb
(paren
id|HOST_DATA_PORT
)paren
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;Maui: Receive timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|maui_write
id|maui_write
(paren
r_int
r_char
id|data
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
id|timeout
OL
l_int|10000000
suffix:semicolon
id|timeout
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inb
(paren
id|HOST_STAT_PORT
)paren
op_amp
id|STAT_TX_AVAIL
)paren
(brace
id|outb
(paren
id|data
comma
id|HOST_DATA_PORT
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;Maui: Transmit timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|mauiintr
id|mauiintr
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
id|irq_ok
op_assign
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|maui_load_patch
id|maui_load_patch
(paren
r_int
id|dev
comma
r_int
id|format
comma
r_const
id|snd_rw_buf
op_star
id|addr
comma
r_int
id|offs
comma
r_int
id|count
comma
r_int
id|pmgr_flag
)paren
(brace
r_struct
id|sysex_info
id|header
suffix:semicolon
r_int
r_int
id|left
comma
id|src_offs
suffix:semicolon
r_int
id|hdr_size
op_assign
(paren
r_int
r_int
)paren
op_amp
id|header.data
(braket
l_int|0
)braket
op_minus
(paren
r_int
r_int
)paren
op_amp
id|header
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|format
op_eq
id|SYSEX_PATCH
)paren
multiline_comment|/* Handled by midi_synth.c */
r_return
id|orig_load_patch
(paren
id|dev
comma
id|format
comma
id|addr
comma
id|offs
comma
id|count
comma
id|pmgr_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|format
op_ne
id|MAUI_PATCH
)paren
(brace
id|printk
(paren
l_string|&quot;Maui: Unknown patch format&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
id|hdr_size
)paren
(brace
id|printk
(paren
l_string|&quot;Maui error: Patch header too short&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|count
op_sub_assign
id|hdr_size
suffix:semicolon
multiline_comment|/*&n;   * Copy the header from user space but ignore the first bytes which have&n;   * been transferred already.&n;   */
id|memcpy_fromfs
(paren
(paren
op_amp
(paren
(paren
r_char
op_star
)paren
op_amp
id|header
)paren
(braket
id|offs
)braket
)paren
comma
op_amp
(paren
(paren
id|addr
)paren
(braket
id|offs
)braket
)paren
comma
(paren
id|hdr_size
op_minus
id|offs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|header.len
)paren
(brace
id|printk
(paren
l_string|&quot;Maui warning: Host command record too short (%d&lt;%d)&bslash;n&quot;
comma
id|count
comma
(paren
r_int
)paren
id|header.len
)paren
suffix:semicolon
id|header.len
op_assign
id|count
suffix:semicolon
)brace
id|left
op_assign
id|header.len
suffix:semicolon
id|src_offs
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|left
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|data
suffix:semicolon
id|data
op_assign
id|get_fs_byte
(paren
op_amp
(paren
(paren
id|addr
)paren
(braket
id|hdr_size
op_plus
id|i
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
op_logical_and
op_logical_neg
(paren
id|data
op_amp
l_int|0x80
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|maui_write
(paren
id|data
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|maui_read
(paren
)paren
)paren
op_ne
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|i
op_ne
op_minus
l_int|1
)paren
id|printk
(paren
l_string|&quot;Maui: Error status %02x&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|probe_maui
id|probe_maui
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|tmp1
comma
id|tmp2
suffix:semicolon
r_if
c_cond
(paren
id|check_region
(paren
id|hw_config-&gt;io_base
comma
l_int|8
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|maui_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|maui_osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
r_if
c_cond
(paren
id|snd_set_irq_handler
(paren
id|hw_config-&gt;irq
comma
id|mauiintr
comma
l_string|&quot;Maui&quot;
comma
id|maui_osp
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maui_write
(paren
l_int|0xCF
)paren
)paren
multiline_comment|/* Report hardware version */
(brace
id|snd_release_irq
(paren
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|maui_read
(paren
)paren
)paren
op_eq
op_minus
l_int|1
op_logical_or
(paren
id|tmp2
op_assign
id|maui_read
(paren
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|snd_release_irq
(paren
id|hw_config-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;WaveFront hardware version %d.%d&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maui_write
(paren
l_int|0x9F
)paren
)paren
multiline_comment|/* Report firmware version */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp1
op_assign
id|maui_read
(paren
)paren
)paren
op_eq
op_minus
l_int|1
op_logical_or
(paren
id|tmp2
op_assign
id|maui_read
(paren
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
id|printk
(paren
l_string|&quot;WaveFront firmware version %d.%d&bslash;n&quot;
comma
id|tmp1
comma
id|tmp2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maui_write
(paren
l_int|0x85
)paren
)paren
multiline_comment|/* Report free DRAM */
r_return
l_int|0
suffix:semicolon
id|tmp1
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp1
op_or_assign
id|maui_read
(paren
)paren
op_lshift
(paren
l_int|7
op_star
id|i
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;Available DRAM %dk&bslash;n&quot;
comma
id|tmp1
op_div
l_int|1024
)paren
suffix:semicolon
id|request_region
(paren
id|hw_config-&gt;io_base
op_plus
l_int|2
comma
l_int|6
comma
l_string|&quot;Maui&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|probe_mpu401
(paren
id|hw_config
)paren
)paren
r_break
suffix:semicolon
r_return
id|probe_mpu401
(paren
id|hw_config
)paren
suffix:semicolon
)brace
r_int
DECL|function|attach_maui
id|attach_maui
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|this_dev
op_assign
id|num_midis
suffix:semicolon
id|printk
(paren
l_string|&quot; &lt;Maui&gt;&quot;
)paren
suffix:semicolon
id|hw_config-&gt;irq
op_mul_assign
op_minus
l_int|1
suffix:semicolon
id|mem_start
op_assign
id|attach_mpu401
(paren
id|mem_start
comma
id|hw_config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_midis
OG
id|this_dev
)paren
multiline_comment|/* The MPU401 driver installed itself */
(brace
r_struct
id|synth_operations
op_star
id|synth
suffix:semicolon
multiline_comment|/*&n;       * Intercept patch loading calls so that they canbe handled&n;       * by the Maui driver.&n;       */
id|synth
op_assign
id|midi_devs
(braket
id|this_dev
)braket
op_member_access_from_pointer
id|converter
suffix:semicolon
r_if
c_cond
(paren
id|synth
op_ne
l_int|NULL
)paren
(brace
id|orig_load_patch
op_assign
id|synth-&gt;load_patch
suffix:semicolon
id|synth-&gt;load_patch
op_assign
op_amp
id|maui_load_patch
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;Maui: Can&squot;t install patch loader&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|mem_start
suffix:semicolon
)brace
r_void
DECL|function|unload_maui
id|unload_maui
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|release_region
(paren
id|hw_config-&gt;io_base
op_plus
l_int|2
comma
l_int|6
)paren
suffix:semicolon
id|unload_mpu401
(paren
id|hw_config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
id|irq
op_assign
op_minus
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
id|snd_release_irq
(paren
id|irq
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
