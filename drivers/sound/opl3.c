multiline_comment|/*&n; * linux/kernel/chr_drv/sound/opl3.c&n; * &n; * A low level driver for Yamaha YM3812 and OPL-3 -chips&n; * &n; * Copyright by Hannu Savolainen 1993&n; * &n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; * &n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; * &n; */
multiline_comment|/* Major improvements to the FM handling 30AUG92 by Rob Hooft, */
multiline_comment|/* hooft@chem.ruu.nl */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_YM3812)
macro_line|#include &quot;opl3.h&quot;
DECL|macro|MAX_VOICE
mdefine_line|#define MAX_VOICE&t;18
DECL|macro|OFFS_4OP
mdefine_line|#define OFFS_4OP&t;11&t;/* Definitions for the operators OP3 and OP4&n;&t;&t;&t;&t; * begin here */
DECL|variable|opl3_enabled
r_static
r_int
id|opl3_enabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|left_address
DECL|variable|right_address
DECL|variable|both_address
r_static
r_int
id|left_address
op_assign
l_int|0x388
comma
id|right_address
op_assign
l_int|0x388
comma
id|both_address
op_assign
l_int|0
suffix:semicolon
DECL|variable|nr_voices
r_static
r_int
id|nr_voices
op_assign
l_int|9
suffix:semicolon
DECL|variable|logical_voices
r_static
r_int
id|logical_voices
(braket
id|MAX_VOICE
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
l_int|12
comma
l_int|13
comma
l_int|14
comma
l_int|15
comma
l_int|16
comma
l_int|17
)brace
suffix:semicolon
DECL|struct|voice_info
r_struct
id|voice_info
(brace
DECL|member|keyon_byte
r_int
r_char
id|keyon_byte
suffix:semicolon
DECL|member|bender
r_int
id|bender
suffix:semicolon
DECL|member|bender_range
r_int
id|bender_range
suffix:semicolon
DECL|member|orig_freq
r_int
r_int
id|orig_freq
suffix:semicolon
DECL|member|current_freq
r_int
r_int
id|current_freq
suffix:semicolon
DECL|member|mode
r_int
id|mode
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|voices
r_static
r_struct
id|voice_info
id|voices
(braket
id|MAX_VOICE
)braket
suffix:semicolon
DECL|typedef|instr_array
r_typedef
r_struct
id|sbi_instrument
id|instr_array
(braket
id|SBFM_MAXINSTR
)braket
suffix:semicolon
DECL|variable|instrmap
r_static
id|instr_array
id|instrmap
suffix:semicolon
DECL|variable|active_instrument
r_static
r_struct
id|sbi_instrument
op_star
id|active_instrument
(braket
id|MAX_VOICE
)braket
op_assign
(brace
l_int|NULL
)brace
suffix:semicolon
DECL|variable|fm_info
r_static
r_struct
id|synth_info
id|fm_info
op_assign
(brace
l_string|&quot;AdLib&quot;
comma
l_int|0
comma
id|SYNTH_TYPE_FM
comma
id|FM_TYPE_ADLIB
comma
l_int|0
comma
l_int|9
comma
l_int|0
comma
id|SBFM_MAXINSTR
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|already_initialized
r_static
r_int
id|already_initialized
op_assign
l_int|0
suffix:semicolon
DECL|variable|opl3_ok
r_static
r_int
id|opl3_ok
op_assign
l_int|0
suffix:semicolon
DECL|variable|opl3_busy
r_static
r_int
id|opl3_busy
op_assign
l_int|0
suffix:semicolon
DECL|variable|fm_model
r_static
r_int
id|fm_model
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0=no fm, 1=mono, 2=SB Pro 1, 3=SB Pro 2&t; */
r_static
r_int
id|store_instr
(paren
r_int
id|instr_no
comma
r_struct
id|sbi_instrument
op_star
id|instr
)paren
suffix:semicolon
r_static
r_void
id|freq_to_fnum
(paren
r_int
id|freq
comma
r_int
op_star
id|block
comma
r_int
op_star
id|fnum
)paren
suffix:semicolon
r_static
r_void
id|opl3_command
(paren
r_int
id|io_addr
comma
r_const
r_int
r_char
id|addr
comma
r_const
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_int
id|opl3_kill_note
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|velocity
)paren
suffix:semicolon
DECL|variable|connection_mask
r_static
r_int
r_char
id|connection_mask
op_assign
l_int|0x00
suffix:semicolon
r_void
DECL|function|enable_opl3_mode
id|enable_opl3_mode
(paren
r_int
id|left
comma
r_int
id|right
comma
r_int
id|both
)paren
(brace
id|opl3_enabled
op_assign
l_int|1
suffix:semicolon
id|left_address
op_assign
id|left
suffix:semicolon
id|right_address
op_assign
id|right
suffix:semicolon
id|both_address
op_assign
id|both
suffix:semicolon
id|fm_info.capabilities
op_assign
id|SYNTH_CAP_OPL3
suffix:semicolon
id|fm_info.synth_subtype
op_assign
id|FM_TYPE_OPL3
suffix:semicolon
)brace
r_static
r_void
DECL|function|enter_4op_mode
id|enter_4op_mode
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|voices_4op
(braket
id|MAX_VOICE
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|15
comma
l_int|16
comma
l_int|17
)brace
suffix:semicolon
id|connection_mask
op_assign
l_int|0x3f
suffix:semicolon
id|opl3_command
(paren
id|right_address
comma
id|CONNECTION_SELECT_REGISTER
comma
l_int|0x3f
)paren
suffix:semicolon
multiline_comment|/* Select all 4-OP&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * voices */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|physical_voices
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|3
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|physical_voices
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|9
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|physical_voices
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|12
suffix:semicolon
id|i
OL
l_int|15
suffix:semicolon
id|i
op_increment
)paren
id|physical_voices
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|logical_voices
(braket
id|i
)braket
op_assign
id|voices_4op
(braket
id|i
)braket
suffix:semicolon
id|nr_voices
op_assign
l_int|12
suffix:semicolon
)brace
r_static
r_int
DECL|function|opl3_ioctl
id|opl3_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDCTL_FM_LOAD_INSTR
suffix:colon
(brace
r_struct
id|sbi_instrument
id|ins
suffix:semicolon
id|IOCTL_FROM_USER
(paren
(paren
r_char
op_star
)paren
op_amp
id|ins
comma
(paren
r_char
op_star
)paren
id|arg
comma
l_int|0
comma
r_sizeof
(paren
id|ins
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ins.channel
OL
l_int|0
op_logical_or
id|ins.channel
op_ge
id|SBFM_MAXINSTR
)paren
(brace
id|printk
(paren
l_string|&quot;FM Error: Invalid instrument number %d&bslash;n&quot;
comma
id|ins.channel
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|pmgr_inform
(paren
id|dev
comma
id|PM_E_PATCH_LOADED
comma
id|ins.channel
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|store_instr
(paren
id|ins.channel
comma
op_amp
id|ins
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_SYNTH_INFO
suffix:colon
id|fm_info.nr_voices
op_assign
(paren
id|nr_voices
op_eq
l_int|12
)paren
ques
c_cond
l_int|6
suffix:colon
id|nr_voices
suffix:semicolon
id|IOCTL_TO_USER
(paren
(paren
r_char
op_star
)paren
id|arg
comma
l_int|0
comma
op_amp
id|fm_info
comma
r_sizeof
(paren
id|fm_info
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_SYNTH_MEMAVL
suffix:colon
r_return
l_int|0x7fffffff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_FM_4OP_ENABLE
suffix:colon
r_if
c_cond
(paren
id|opl3_enabled
)paren
id|enter_4op_mode
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|opl3_detect
id|opl3_detect
(paren
r_int
id|ioaddr
)paren
(brace
multiline_comment|/*&n;   * This function returns 1 if the FM chicp is present at the given I/O port&n;   * The detection algorithm plays with the timer built in the FM chip and&n;   * looks for a change in the status register.&n;   * &n;   * Note! The timers of the FM chip are not connected to AdLib (and compatible)&n;   * boards.&n;   * &n;   * Note2! The chip is initialized if detected.&n;   */
r_int
r_char
id|stat1
comma
id|stat2
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|already_initialized
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Do avoid duplicate initializations */
)brace
r_if
c_cond
(paren
id|opl3_enabled
)paren
id|ioaddr
op_assign
id|left_address
suffix:semicolon
id|opl3_command
(paren
id|ioaddr
comma
id|TIMER_CONTROL_REGISTER
comma
id|TIMER1_MASK
op_or
id|TIMER2_MASK
)paren
suffix:semicolon
multiline_comment|/* Reset timers 1 and 2 */
id|opl3_command
(paren
id|ioaddr
comma
id|TIMER_CONTROL_REGISTER
comma
id|IRQ_RESET
)paren
suffix:semicolon
multiline_comment|/* Reset the IRQ of FM&n;&t;&t;&t;&t;&t;&t;&t;&t; * chicp */
id|stat1
op_assign
id|INB
(paren
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Read status register */
r_if
c_cond
(paren
(paren
id|stat1
op_amp
l_int|0xE0
)paren
op_ne
l_int|0x00
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Should be 0x00&t; */
)brace
id|opl3_command
(paren
id|ioaddr
comma
id|TIMER1_REGISTER
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Set timer 1 to 0xff */
id|opl3_command
(paren
id|ioaddr
comma
id|TIMER_CONTROL_REGISTER
comma
id|TIMER2_MASK
op_or
id|TIMER1_START
)paren
suffix:semicolon
multiline_comment|/* Unmask and start timer 1 */
multiline_comment|/*&n;   * Now we have to delay at least 80 msec&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|50
suffix:semicolon
id|i
op_increment
)paren
id|tenmicrosec
(paren
)paren
suffix:semicolon
multiline_comment|/* To be sure */
id|stat2
op_assign
id|INB
(paren
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Read status after timers have expired */
multiline_comment|/* Stop the timers */
id|opl3_command
(paren
id|ioaddr
comma
id|TIMER_CONTROL_REGISTER
comma
id|TIMER1_MASK
op_or
id|TIMER2_MASK
)paren
suffix:semicolon
multiline_comment|/* Reset timers 1 and 2 */
id|opl3_command
(paren
id|ioaddr
comma
id|TIMER_CONTROL_REGISTER
comma
id|IRQ_RESET
)paren
suffix:semicolon
multiline_comment|/* Reset the IRQ of FM&n;&t;&t;&t;&t;&t;&t;&t;&t; * chicp */
r_if
c_cond
(paren
(paren
id|stat2
op_amp
l_int|0xE0
)paren
op_ne
l_int|0xc0
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* There is no YM3812 */
)brace
multiline_comment|/* There is a FM chicp in this address. Now set some default values. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
id|opl3_command
(paren
id|ioaddr
comma
id|KEYON_BLOCK
op_plus
id|i
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Note off */
id|opl3_command
(paren
id|ioaddr
comma
id|TEST_REGISTER
comma
id|ENABLE_WAVE_SELECT
)paren
suffix:semicolon
id|opl3_command
(paren
id|ioaddr
comma
id|PERCUSSION_REGISTER
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Melodic mode. */
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|opl3_kill_note
id|opl3_kill_note
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|velocity
)paren
(brace
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|nr_voices
)paren
r_return
l_int|0
suffix:semicolon
id|map
op_assign
op_amp
id|physical_voices
(braket
id|logical_voices
(braket
id|voice
)braket
)braket
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;Kill note %d&bslash;n&quot;
comma
id|voice
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
comma
id|voices
(braket
id|voice
)braket
dot
id|keyon_byte
op_amp
op_complement
l_int|0x20
)paren
suffix:semicolon
id|voices
(braket
id|voice
)braket
dot
id|keyon_byte
op_assign
l_int|0
suffix:semicolon
id|voices
(braket
id|voice
)braket
dot
id|bender
op_assign
l_int|0
suffix:semicolon
id|voices
(braket
id|voice
)braket
dot
id|bender_range
op_assign
l_int|200
suffix:semicolon
multiline_comment|/* 200 cents = 2 semitones */
id|voices
(braket
id|voice
)braket
dot
id|orig_freq
op_assign
l_int|0
suffix:semicolon
id|voices
(braket
id|voice
)braket
dot
id|current_freq
op_assign
l_int|0
suffix:semicolon
id|voices
(braket
id|voice
)braket
dot
id|mode
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|HIHAT
mdefine_line|#define HIHAT&t;&t;&t;0
DECL|macro|CYMBAL
mdefine_line|#define CYMBAL&t;&t;&t;1
DECL|macro|TOMTOM
mdefine_line|#define TOMTOM&t;&t;&t;2
DECL|macro|SNARE
mdefine_line|#define SNARE&t;&t;&t;3
DECL|macro|BDRUM
mdefine_line|#define BDRUM&t;&t;&t;4
DECL|macro|UNDEFINED
mdefine_line|#define UNDEFINED&t;&t;TOMTOM
DECL|macro|DEFAULT
mdefine_line|#define DEFAULT&t;&t;&t;TOMTOM
r_static
r_int
DECL|function|store_instr
id|store_instr
(paren
r_int
id|instr_no
comma
r_struct
id|sbi_instrument
op_star
id|instr
)paren
(brace
r_if
c_cond
(paren
id|instr-&gt;key
op_ne
id|FM_PATCH
op_logical_and
(paren
id|instr-&gt;key
op_ne
id|OPL3_PATCH
op_logical_or
op_logical_neg
id|opl3_enabled
)paren
)paren
id|printk
(paren
l_string|&quot;FM warning: Invalid patch format field (key) 0x%04x&bslash;n&quot;
comma
id|instr-&gt;key
)paren
suffix:semicolon
id|memcpy
(paren
(paren
r_char
op_star
)paren
op_amp
(paren
id|instrmap
(braket
id|instr_no
)braket
)paren
comma
(paren
r_char
op_star
)paren
id|instr
comma
r_sizeof
(paren
op_star
id|instr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|opl3_set_instr
id|opl3_set_instr
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|instr_no
)paren
(brace
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|nr_voices
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|instr_no
OL
l_int|0
op_logical_or
id|instr_no
op_ge
id|SBFM_MAXINSTR
)paren
r_return
l_int|0
suffix:semicolon
id|active_instrument
(braket
id|voice
)braket
op_assign
op_amp
id|instrmap
(braket
id|instr_no
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The next table looks magical, but it certainly is not. Its values have&n; * been calculated as table[i]=8*log(i/64)/log(2) with an obvious exception&n; * for i=0. This log-table converts a linear volume-scaling (0..127) to a&n; * logarithmic scaling as present in the FM-synthesizer chips. so :    Volume&n; * 64 =  0 db = relative volume  0 and:    Volume 32 = -6 db = relative&n; * volume -8 it was implemented as a table because it is only 128 bytes and&n; * it saves a lot of log() calculations. (RH)&n; */
DECL|variable|fm_volume_table
r_char
id|fm_volume_table
(braket
l_int|128
)braket
op_assign
(brace
op_minus
l_int|64
comma
op_minus
l_int|48
comma
op_minus
l_int|40
comma
op_minus
l_int|35
comma
op_minus
l_int|32
comma
op_minus
l_int|29
comma
op_minus
l_int|27
comma
op_minus
l_int|26
comma
multiline_comment|/* 0 -   7 */
op_minus
l_int|24
comma
op_minus
l_int|23
comma
op_minus
l_int|21
comma
op_minus
l_int|20
comma
op_minus
l_int|19
comma
op_minus
l_int|18
comma
op_minus
l_int|18
comma
op_minus
l_int|17
comma
multiline_comment|/* 8 -  15 */
op_minus
l_int|16
comma
op_minus
l_int|15
comma
op_minus
l_int|15
comma
op_minus
l_int|14
comma
op_minus
l_int|13
comma
op_minus
l_int|13
comma
op_minus
l_int|12
comma
op_minus
l_int|12
comma
multiline_comment|/* 16 -  23 */
op_minus
l_int|11
comma
op_minus
l_int|11
comma
op_minus
l_int|10
comma
op_minus
l_int|10
comma
op_minus
l_int|10
comma
op_minus
l_int|9
comma
op_minus
l_int|9
comma
op_minus
l_int|8
comma
multiline_comment|/* 24 -  31 */
op_minus
l_int|8
comma
op_minus
l_int|8
comma
op_minus
l_int|7
comma
op_minus
l_int|7
comma
op_minus
l_int|7
comma
op_minus
l_int|6
comma
op_minus
l_int|6
comma
op_minus
l_int|6
comma
multiline_comment|/* 32 -  39 */
op_minus
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|4
comma
op_minus
l_int|4
comma
op_minus
l_int|4
comma
op_minus
l_int|4
comma
multiline_comment|/* 40 -  47 */
op_minus
l_int|3
comma
op_minus
l_int|3
comma
op_minus
l_int|3
comma
op_minus
l_int|3
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
multiline_comment|/* 48 -  55 */
op_minus
l_int|2
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 56 -  63 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
multiline_comment|/* 64 -  71 */
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
multiline_comment|/* 72 -  79 */
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|4
comma
multiline_comment|/* 80 -  87 */
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|5
comma
multiline_comment|/* 88 -  95 */
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
multiline_comment|/* 96 - 103 */
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
multiline_comment|/* 104 - 111 */
l_int|6
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
multiline_comment|/* 112 - 119 */
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|8
)brace
suffix:semicolon
multiline_comment|/* 120 - 127 */
r_static
r_void
DECL|function|calc_vol
id|calc_vol
(paren
r_int
r_char
op_star
id|regbyte
comma
r_int
id|volume
)paren
(brace
r_int
id|level
op_assign
(paren
op_complement
op_star
id|regbyte
op_amp
l_int|0x3f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|level
)paren
id|level
op_add_assign
id|fm_volume_table
(braket
id|volume
)braket
suffix:semicolon
r_if
c_cond
(paren
id|level
OG
l_int|0x3f
)paren
id|level
op_assign
l_int|0x3f
suffix:semicolon
r_if
c_cond
(paren
id|level
OL
l_int|0
)paren
id|level
op_assign
l_int|0
suffix:semicolon
op_star
id|regbyte
op_assign
(paren
op_star
id|regbyte
op_amp
l_int|0xc0
)paren
op_or
(paren
op_complement
id|level
op_amp
l_int|0x3f
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_voice_volume
id|set_voice_volume
(paren
r_int
id|voice
comma
r_int
id|volume
)paren
(brace
r_int
r_char
id|vol1
comma
id|vol2
comma
id|vol3
comma
id|vol4
suffix:semicolon
r_struct
id|sbi_instrument
op_star
id|instr
suffix:semicolon
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|nr_voices
)paren
r_return
suffix:semicolon
id|map
op_assign
op_amp
id|physical_voices
(braket
id|logical_voices
(braket
id|voice
)braket
)braket
suffix:semicolon
id|instr
op_assign
id|active_instrument
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instr
)paren
id|instr
op_assign
op_amp
id|instrmap
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;channel
OL
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|voices
(braket
id|voice
)braket
dot
id|mode
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|voices
(braket
id|voice
)braket
dot
id|mode
op_eq
l_int|2
)paren
(brace
multiline_comment|/* 2 OP voice */
id|vol1
op_assign
id|instr-&gt;operators
(braket
l_int|2
)braket
suffix:semicolon
id|vol2
op_assign
id|instr-&gt;operators
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|instr-&gt;operators
(braket
l_int|10
)braket
op_amp
l_int|0x01
)paren
)paren
(brace
multiline_comment|/* Additive synthesis&t; */
id|calc_vol
(paren
op_amp
id|vol1
comma
id|volume
)paren
suffix:semicolon
id|calc_vol
(paren
op_amp
id|vol2
comma
id|volume
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FM synthesis */
id|calc_vol
(paren
op_amp
id|vol2
comma
id|volume
)paren
suffix:semicolon
)brace
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|vol1
)paren
suffix:semicolon
multiline_comment|/* Modulator volume */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|vol2
)paren
suffix:semicolon
multiline_comment|/* Carrier volume */
)brace
r_else
(brace
multiline_comment|/* 4 OP voice */
r_int
id|connection
suffix:semicolon
id|vol1
op_assign
id|instr-&gt;operators
(braket
l_int|2
)braket
suffix:semicolon
id|vol2
op_assign
id|instr-&gt;operators
(braket
l_int|3
)braket
suffix:semicolon
id|vol3
op_assign
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|2
)braket
suffix:semicolon
id|vol4
op_assign
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|3
)braket
suffix:semicolon
multiline_comment|/*&n;       * The connection method for 4 OP voices is defined by the rightmost&n;       * bits at the offsets 10 and 10+OFFS_4OP&n;       */
id|connection
op_assign
(paren
(paren
id|instr-&gt;operators
(braket
l_int|10
)braket
op_amp
l_int|0x01
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|instr-&gt;operators
(braket
l_int|10
op_plus
id|OFFS_4OP
)braket
op_amp
l_int|0x01
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|connection
)paren
(brace
r_case
l_int|0
suffix:colon
id|calc_vol
(paren
op_amp
id|vol4
comma
id|volume
)paren
suffix:semicolon
multiline_comment|/* Just the OP 4 is carrier */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|calc_vol
(paren
op_amp
id|vol2
comma
id|volume
)paren
suffix:semicolon
id|calc_vol
(paren
op_amp
id|vol4
comma
id|volume
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|calc_vol
(paren
op_amp
id|vol1
comma
id|volume
)paren
suffix:semicolon
id|calc_vol
(paren
op_amp
id|vol4
comma
id|volume
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|calc_vol
(paren
op_amp
id|vol1
comma
id|volume
)paren
suffix:semicolon
id|calc_vol
(paren
op_amp
id|vol3
comma
id|volume
)paren
suffix:semicolon
id|calc_vol
(paren
op_amp
id|vol4
comma
id|volume
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Why ?? */
suffix:semicolon
)brace
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|vol1
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|vol2
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|vol3
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|vol4
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|opl3_start_note
id|opl3_start_note
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|note
comma
r_int
id|volume
)paren
(brace
r_int
r_char
id|data
comma
id|fpc
suffix:semicolon
r_int
id|block
comma
id|fnum
comma
id|freq
comma
id|voice_mode
suffix:semicolon
r_struct
id|sbi_instrument
op_star
id|instr
suffix:semicolon
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|nr_voices
)paren
r_return
l_int|0
suffix:semicolon
id|map
op_assign
op_amp
id|physical_voices
(braket
id|logical_voices
(braket
id|voice
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|note
op_eq
l_int|255
)paren
multiline_comment|/* Just change the volume */
(brace
id|set_voice_volume
(paren
id|voice
comma
id|volume
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Kill previous note before playing */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Carrier volume to min */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Modulator volume to */
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|4
)paren
(brace
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
l_int|0xff
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
l_int|0xff
)paren
suffix:semicolon
)brace
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Note off */
id|instr
op_assign
id|active_instrument
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instr
)paren
id|instr
op_assign
op_amp
id|instrmap
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;channel
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;OPL3: Initializing voice %d with undefined instrument&bslash;n&quot;
comma
id|voice
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|2
op_logical_and
id|instr-&gt;key
op_eq
id|OPL3_PATCH
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Cannot play */
id|voice_mode
op_assign
id|map-&gt;voice_mode
suffix:semicolon
r_if
c_cond
(paren
id|voice_mode
op_eq
l_int|4
)paren
(brace
r_int
id|voice_shift
suffix:semicolon
id|voice_shift
op_assign
(paren
id|map-&gt;ioaddr
op_eq
id|left_address
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|3
suffix:semicolon
id|voice_shift
op_add_assign
id|map-&gt;voice_num
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;key
op_ne
id|OPL3_PATCH
)paren
multiline_comment|/* Just 2 OP patch */
(brace
id|voice_mode
op_assign
l_int|2
suffix:semicolon
id|connection_mask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|voice_shift
)paren
suffix:semicolon
)brace
r_else
(brace
id|connection_mask
op_or_assign
(paren
l_int|1
op_lshift
id|voice_shift
)paren
suffix:semicolon
)brace
id|opl3_command
(paren
id|right_address
comma
id|CONNECTION_SELECT_REGISTER
comma
id|connection_mask
)paren
suffix:semicolon
)brace
multiline_comment|/* Set Sound Characteristics */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|AM_VIB
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|instr-&gt;operators
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|AM_VIB
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|instr-&gt;operators
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* Set Attack/Decay */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|ATTACK_DECAY
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|instr-&gt;operators
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|ATTACK_DECAY
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|instr-&gt;operators
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/* Set Sustain/Release */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|SUSTAIN_RELEASE
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|instr-&gt;operators
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|SUSTAIN_RELEASE
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|instr-&gt;operators
(braket
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/* Set Wave Select */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|WAVE_SELECT
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|instr-&gt;operators
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|WAVE_SELECT
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|instr-&gt;operators
(braket
l_int|9
)braket
)paren
suffix:semicolon
multiline_comment|/* Set Feedback/Connection */
id|fpc
op_assign
id|instr-&gt;operators
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fpc
op_amp
l_int|0x30
)paren
)paren
id|fpc
op_or_assign
l_int|0x30
suffix:semicolon
multiline_comment|/* Ensure that at least one chn is enabled */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|FEEDBACK_CONNECTION
op_plus
id|map-&gt;voice_num
comma
id|fpc
)paren
suffix:semicolon
multiline_comment|/*&n;   * If the voice is a 4 OP one, initialize the operators 3 and 4 also&n;   */
r_if
c_cond
(paren
id|voice_mode
op_eq
l_int|4
)paren
(brace
multiline_comment|/* Set Sound Characteristics */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|AM_VIB
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|0
)braket
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|AM_VIB
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* Set Attack/Decay */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|ATTACK_DECAY
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|4
)braket
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|ATTACK_DECAY
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/* Set Sustain/Release */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|SUSTAIN_RELEASE
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|6
)braket
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|SUSTAIN_RELEASE
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/* Set Wave Select */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|WAVE_SELECT
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|8
)braket
)paren
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|WAVE_SELECT
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|9
)braket
)paren
suffix:semicolon
multiline_comment|/* Set Feedback/Connection */
id|fpc
op_assign
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fpc
op_amp
l_int|0x30
)paren
)paren
id|fpc
op_or_assign
l_int|0x30
suffix:semicolon
multiline_comment|/* Ensure that at least one chn is enabled */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|FEEDBACK_CONNECTION
op_plus
id|map-&gt;voice_num
op_plus
l_int|3
comma
id|fpc
)paren
suffix:semicolon
)brace
id|voices
(braket
id|voice
)braket
dot
id|mode
op_assign
id|voice_mode
suffix:semicolon
id|set_voice_volume
(paren
id|voice
comma
id|volume
)paren
suffix:semicolon
id|freq
op_assign
id|voices
(braket
id|voice
)braket
dot
id|orig_freq
op_assign
id|note_to_freq
(paren
id|note
)paren
op_div
l_int|1000
suffix:semicolon
multiline_comment|/*&n;   * Since the pitch bender may have been set before playing the note, we&n;   * have to calculate the bending now.&n;   */
id|freq
op_assign
id|compute_finetune
(paren
id|voices
(braket
id|voice
)braket
dot
id|orig_freq
comma
id|voices
(braket
id|voice
)braket
dot
id|bender
comma
id|voices
(braket
id|voice
)braket
dot
id|bender_range
)paren
suffix:semicolon
id|voices
(braket
id|voice
)braket
dot
id|current_freq
op_assign
id|freq
suffix:semicolon
id|freq_to_fnum
(paren
id|freq
comma
op_amp
id|block
comma
op_amp
id|fnum
)paren
suffix:semicolon
multiline_comment|/* Play note */
id|data
op_assign
id|fnum
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* Least significant bits of fnumber */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|FNUM_LOW
op_plus
id|map-&gt;voice_num
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
l_int|0x20
op_or
(paren
(paren
id|block
op_amp
l_int|0x7
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|fnum
op_rshift
l_int|8
)paren
op_amp
l_int|0x3
)paren
suffix:semicolon
id|voices
(braket
id|voice
)braket
dot
id|keyon_byte
op_assign
id|data
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|voice_mode
op_eq
l_int|4
)paren
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
op_plus
l_int|3
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|freq_to_fnum
id|freq_to_fnum
(paren
r_int
id|freq
comma
r_int
op_star
id|block
comma
r_int
op_star
id|fnum
)paren
(brace
r_int
id|f
comma
id|octave
suffix:semicolon
multiline_comment|/* Converts the note frequency to block and fnum values for the FM chip */
multiline_comment|/* First try to compute the block -value (octave) where the note belongs */
id|f
op_assign
id|freq
suffix:semicolon
id|octave
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|f
op_eq
l_int|0
)paren
id|octave
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|f
OL
l_int|261
)paren
(brace
r_while
c_loop
(paren
id|f
OL
l_int|261
)paren
(brace
id|octave
op_decrement
suffix:semicolon
id|f
op_lshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|f
OG
l_int|493
)paren
(brace
r_while
c_loop
(paren
id|f
OG
l_int|493
)paren
(brace
id|octave
op_increment
suffix:semicolon
id|f
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|octave
OG
l_int|7
)paren
id|octave
op_assign
l_int|7
suffix:semicolon
op_star
id|fnum
op_assign
id|freq
op_star
(paren
l_int|1
op_lshift
(paren
l_int|20
op_minus
id|octave
)paren
)paren
op_div
l_int|49716
suffix:semicolon
op_star
id|block
op_assign
id|octave
suffix:semicolon
)brace
r_static
r_void
DECL|function|opl3_command
id|opl3_command
(paren
r_int
id|io_addr
comma
r_const
r_int
r_char
id|addr
comma
r_const
r_int
r_char
id|val
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;   * The original 2-OP synth requires a quite long delay after writing to a&n;   * register. The OPL-3 survives with just two INBs&n;   */
id|OUTB
(paren
id|addr
comma
id|io_addr
)paren
suffix:semicolon
multiline_comment|/* Select register&t; */
r_if
c_cond
(paren
op_logical_neg
id|opl3_enabled
)paren
id|tenmicrosec
(paren
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|INB
(paren
id|io_addr
)paren
suffix:semicolon
id|OUTB
(paren
id|val
comma
id|io_addr
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Write to register&t; */
r_if
c_cond
(paren
op_logical_neg
id|opl3_enabled
)paren
(brace
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|INB
(paren
id|io_addr
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|opl3_reset
id|opl3_reset
(paren
r_int
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|opl3_command
(paren
id|physical_voices
(braket
id|logical_voices
(braket
id|i
)braket
)braket
dot
id|ioaddr
comma
id|KSL_LEVEL
op_plus
id|physical_voices
(braket
id|logical_voices
(braket
id|i
)braket
)braket
dot
id|op
(braket
l_int|0
)braket
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* OP1 volume to min */
id|opl3_command
(paren
id|physical_voices
(braket
id|logical_voices
(braket
id|i
)braket
)braket
dot
id|ioaddr
comma
id|KSL_LEVEL
op_plus
id|physical_voices
(braket
id|logical_voices
(braket
id|i
)braket
)braket
dot
id|op
(braket
l_int|1
)braket
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* OP2 volume to min */
r_if
c_cond
(paren
id|physical_voices
(braket
id|logical_voices
(braket
id|i
)braket
)braket
dot
id|voice_mode
op_eq
l_int|4
)paren
multiline_comment|/* 4 OP voice */
(brace
id|opl3_command
(paren
id|physical_voices
(braket
id|logical_voices
(braket
id|i
)braket
)braket
dot
id|ioaddr
comma
id|KSL_LEVEL
op_plus
id|physical_voices
(braket
id|logical_voices
(braket
id|i
)braket
)braket
dot
id|op
(braket
l_int|2
)braket
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* OP3 volume to min */
id|opl3_command
(paren
id|physical_voices
(braket
id|logical_voices
(braket
id|i
)braket
)braket
dot
id|ioaddr
comma
id|KSL_LEVEL
op_plus
id|physical_voices
(braket
id|logical_voices
(braket
id|i
)braket
)braket
dot
id|op
(braket
l_int|3
)braket
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* OP4 volume to min */
)brace
id|opl3_kill_note
(paren
id|dev
comma
id|i
comma
l_int|64
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|opl3_enabled
)paren
(brace
id|nr_voices
op_assign
l_int|18
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
id|logical_voices
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
id|physical_voices
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|2
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|opl3_open
id|opl3_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|opl3_ok
)paren
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opl3_busy
)paren
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
id|opl3_busy
op_assign
l_int|1
suffix:semicolon
id|connection_mask
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Just 2 OP voices */
r_if
c_cond
(paren
id|opl3_enabled
)paren
id|opl3_command
(paren
id|right_address
comma
id|CONNECTION_SELECT_REGISTER
comma
id|connection_mask
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|opl3_close
id|opl3_close
(paren
r_int
id|dev
)paren
(brace
id|opl3_busy
op_assign
l_int|0
suffix:semicolon
id|nr_voices
op_assign
id|opl3_enabled
ques
c_cond
l_int|18
suffix:colon
l_int|9
suffix:semicolon
id|fm_info.nr_drums
op_assign
l_int|0
suffix:semicolon
id|fm_info.perc_mode
op_assign
l_int|0
suffix:semicolon
id|opl3_reset
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|opl3_hw_control
id|opl3_hw_control
(paren
r_int
id|dev
comma
r_int
r_char
op_star
id|event
)paren
(brace
)brace
r_static
r_int
DECL|function|opl3_load_patch
id|opl3_load_patch
(paren
r_int
id|dev
comma
r_int
id|format
comma
id|snd_rw_buf
op_star
id|addr
comma
r_int
id|offs
comma
r_int
id|count
comma
r_int
id|pmgr_flag
)paren
(brace
r_struct
id|sbi_instrument
id|ins
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
r_sizeof
(paren
id|ins
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;FM Error: Patch record too short&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|COPY_FROM_USER
(paren
op_amp
(paren
(paren
r_char
op_star
)paren
op_amp
id|ins
)paren
(braket
id|offs
)braket
comma
(paren
r_char
op_star
)paren
id|addr
comma
id|offs
comma
r_sizeof
(paren
id|ins
)paren
op_minus
id|offs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ins.channel
OL
l_int|0
op_logical_or
id|ins.channel
op_ge
id|SBFM_MAXINSTR
)paren
(brace
id|printk
(paren
l_string|&quot;FM Error: Invalid instrument number %d&bslash;n&quot;
comma
id|ins.channel
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|ins.key
op_assign
id|format
suffix:semicolon
r_return
id|store_instr
(paren
id|ins.channel
comma
op_amp
id|ins
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|opl3_panning
id|opl3_panning
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|pressure
)paren
(brace
)brace
DECL|macro|SET_VIBRATO
mdefine_line|#define SET_VIBRATO(cell) { &bslash;&n;      tmp = instr-&gt;operators[(cell-1)+(((cell-1)/2)*OFFS_4OP)]; &bslash;&n;      if (pressure &gt; 110) &bslash;&n;&t;tmp |= 0x40;&t;&t;/* Vibrato on */ &bslash;&n;      opl3_command (map-&gt;ioaddr, AM_VIB + map-&gt;op[cell-1], tmp);}
r_static
r_void
DECL|function|opl3_aftertouch
id|opl3_aftertouch
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|pressure
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_struct
id|sbi_instrument
op_star
id|instr
suffix:semicolon
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|nr_voices
)paren
r_return
suffix:semicolon
id|map
op_assign
op_amp
id|physical_voices
(braket
id|logical_voices
(braket
id|voice
)braket
)braket
suffix:semicolon
id|DEB
(paren
id|printk
(paren
l_string|&quot;Aftertouch %d&bslash;n&quot;
comma
id|voice
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;   * Adjust the amount of vibrato depending the pressure&n;   */
id|instr
op_assign
id|active_instrument
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instr
)paren
id|instr
op_assign
op_amp
id|instrmap
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|voices
(braket
id|voice
)braket
dot
id|mode
op_eq
l_int|4
)paren
(brace
r_int
id|connection
op_assign
(paren
(paren
id|instr-&gt;operators
(braket
l_int|10
)braket
op_amp
l_int|0x01
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|instr-&gt;operators
(braket
l_int|10
op_plus
id|OFFS_4OP
)braket
op_amp
l_int|0x01
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|connection
)paren
(brace
r_case
l_int|0
suffix:colon
id|SET_VIBRATO
(paren
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|SET_VIBRATO
(paren
l_int|2
)paren
suffix:semicolon
id|SET_VIBRATO
(paren
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|SET_VIBRATO
(paren
l_int|1
)paren
suffix:semicolon
id|SET_VIBRATO
(paren
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|SET_VIBRATO
(paren
l_int|1
)paren
suffix:semicolon
id|SET_VIBRATO
(paren
l_int|3
)paren
suffix:semicolon
id|SET_VIBRATO
(paren
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Not implemented yet */
)brace
r_else
(brace
id|SET_VIBRATO
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|instr-&gt;operators
(braket
l_int|10
)braket
op_amp
l_int|0x01
)paren
)paren
multiline_comment|/* Additive synthesis */
id|SET_VIBRATO
(paren
l_int|2
)paren
suffix:semicolon
)brace
)brace
DECL|macro|SET_VIBRATO
macro_line|#undef SET_VIBRATO
r_static
r_void
DECL|function|opl3_controller
id|opl3_controller
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|ctrl_num
comma
r_int
id|value
)paren
(brace
r_int
r_char
id|data
suffix:semicolon
r_int
id|block
comma
id|fnum
comma
id|freq
suffix:semicolon
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|nr_voices
)paren
r_return
suffix:semicolon
id|map
op_assign
op_amp
id|physical_voices
(braket
id|logical_voices
(braket
id|voice
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|ctrl_num
)paren
(brace
r_case
id|CTRL_PITCH_BENDER
suffix:colon
id|voices
(braket
id|voice
)braket
dot
id|bender
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|voices
(braket
id|voice
)braket
dot
id|keyon_byte
op_amp
l_int|0x20
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Not keyed on */
id|freq
op_assign
id|compute_finetune
(paren
id|voices
(braket
id|voice
)braket
dot
id|orig_freq
comma
id|voices
(braket
id|voice
)braket
dot
id|bender
comma
id|voices
(braket
id|voice
)braket
dot
id|bender_range
)paren
suffix:semicolon
id|voices
(braket
id|voice
)braket
dot
id|current_freq
op_assign
id|freq
suffix:semicolon
id|freq_to_fnum
(paren
id|freq
comma
op_amp
id|block
comma
op_amp
id|fnum
)paren
suffix:semicolon
id|data
op_assign
id|fnum
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* Least significant bits of fnumber */
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|FNUM_LOW
op_plus
id|map-&gt;voice_num
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
l_int|0x20
op_or
(paren
(paren
id|block
op_amp
l_int|0x7
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|fnum
op_rshift
l_int|8
)paren
op_amp
l_int|0x3
)paren
suffix:semicolon
multiline_comment|/* KEYON|OCTAVE|MS bits&n;&t;&t;&t;&t;&t;&t;&t;&t; * of f-num */
id|voices
(braket
id|voice
)braket
dot
id|keyon_byte
op_assign
id|data
suffix:semicolon
id|opl3_command
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTRL_PITCH_BENDER_RANGE
suffix:colon
id|voices
(braket
id|voice
)braket
dot
id|bender_range
op_assign
id|value
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|opl3_patchmgr
id|opl3_patchmgr
(paren
r_int
id|dev
comma
r_struct
id|patmgr_info
op_star
id|rec
)paren
(brace
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
DECL|variable|opl3_operations
r_static
r_struct
id|synth_operations
id|opl3_operations
op_assign
(brace
op_amp
id|fm_info
comma
id|SYNTH_TYPE_FM
comma
id|FM_TYPE_ADLIB
comma
id|opl3_open
comma
id|opl3_close
comma
id|opl3_ioctl
comma
id|opl3_kill_note
comma
id|opl3_start_note
comma
id|opl3_set_instr
comma
id|opl3_reset
comma
id|opl3_hw_control
comma
id|opl3_load_patch
comma
id|opl3_aftertouch
comma
id|opl3_controller
comma
id|opl3_panning
comma
id|opl3_patchmgr
)brace
suffix:semicolon
r_int
DECL|function|opl3_init
id|opl3_init
(paren
r_int
id|mem_start
)paren
(brace
r_int
id|i
suffix:semicolon
id|synth_devs
(braket
id|num_synths
op_increment
)braket
op_assign
op_amp
id|opl3_operations
suffix:semicolon
id|fm_model
op_assign
l_int|0
suffix:semicolon
id|opl3_ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|opl3_enabled
)paren
(brace
id|printk
(paren
l_string|&quot; &lt;Yamaha OPL-3 FM&gt;&quot;
)paren
suffix:semicolon
id|fm_model
op_assign
l_int|2
suffix:semicolon
id|nr_voices
op_assign
l_int|18
suffix:semicolon
id|fm_info.nr_drums
op_assign
l_int|0
suffix:semicolon
id|fm_info.capabilities
op_or_assign
id|SYNTH_CAP_OPL3
suffix:semicolon
macro_line|#ifndef SCO
id|strcpy
(paren
id|fm_info.name
comma
l_string|&quot;Yamaha OPL-3&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|physical_voices
(braket
id|i
)braket
dot
id|ioaddr
op_eq
id|USE_LEFT
)paren
id|physical_voices
(braket
id|i
)braket
dot
id|ioaddr
op_assign
id|left_address
suffix:semicolon
r_else
id|physical_voices
(braket
id|i
)braket
dot
id|ioaddr
op_assign
id|right_address
suffix:semicolon
id|opl3_command
(paren
id|right_address
comma
id|OPL3_MODE_REGISTER
comma
id|OPL3_ENABLE
)paren
suffix:semicolon
multiline_comment|/* Enable OPL-3 mode */
id|opl3_command
(paren
id|right_address
comma
id|CONNECTION_SELECT_REGISTER
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Select all 2-OP&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * voices */
)brace
r_else
(brace
id|printk
(paren
l_string|&quot; &lt;Yamaha 2-OP FM&gt;&quot;
)paren
suffix:semicolon
id|fm_model
op_assign
l_int|1
suffix:semicolon
id|nr_voices
op_assign
l_int|9
suffix:semicolon
id|fm_info.nr_drums
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
id|physical_voices
(braket
id|i
)braket
dot
id|ioaddr
op_assign
id|left_address
suffix:semicolon
)brace
suffix:semicolon
id|already_initialized
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SBFM_MAXINSTR
suffix:semicolon
id|i
op_increment
)paren
id|instrmap
(braket
id|i
)braket
dot
id|channel
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
macro_line|#endif
eof
