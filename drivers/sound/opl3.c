multiline_comment|/*&n; * sound/opl3.c&n; *&n; * A low level driver for Yamaha YM3812 and OPL-3 -chips&n; *&n; *&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; *&n; *&n; * Changes&n; *&t;Thomas Sailer   &t;ioctl code reworked (vmalloc/vfree removed)&n; *&t;Alan Cox&t;&t;modularisation, fixed sound_mem allocs.&n; *&t;Christoph Hellwig&t;Adapted to module_init/module_exit&n; *&t;Arnaldo C. de Melo&t;get rid of check_region, use request_region for&n; *&t;&t;&t;&t;OPL4, release it on exit, some cleanups.&n; *&n; * Status&n; *&t;Believed to work. Badly needs rewriting a bit to support multiple&n; *&t;OPL3 devices.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
multiline_comment|/*&n; * Major improvements to the FM handling 30AUG92 by Rob Hooft,&n; * hooft@chem.ruu.nl&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;opl3.h&quot;
macro_line|#include &quot;opl3_hw.h&quot;
DECL|macro|MAX_VOICE
mdefine_line|#define MAX_VOICE&t;18
DECL|macro|OFFS_4OP
mdefine_line|#define OFFS_4OP&t;11
DECL|struct|voice_info
r_struct
id|voice_info
(brace
DECL|member|keyon_byte
r_int
r_char
id|keyon_byte
suffix:semicolon
DECL|member|bender
r_int
id|bender
suffix:semicolon
DECL|member|bender_range
r_int
id|bender_range
suffix:semicolon
DECL|member|orig_freq
r_int
r_int
id|orig_freq
suffix:semicolon
DECL|member|current_freq
r_int
r_int
id|current_freq
suffix:semicolon
DECL|member|volume
r_int
id|volume
suffix:semicolon
DECL|member|mode
r_int
id|mode
suffix:semicolon
DECL|member|panning
r_int
id|panning
suffix:semicolon
multiline_comment|/* 0xffff means not set */
)brace
suffix:semicolon
DECL|struct|opl_devinfo
r_typedef
r_struct
id|opl_devinfo
(brace
DECL|member|base
r_int
id|base
suffix:semicolon
DECL|member|left_io
DECL|member|right_io
r_int
id|left_io
comma
id|right_io
suffix:semicolon
DECL|member|nr_voice
r_int
id|nr_voice
suffix:semicolon
DECL|member|lv_map
r_int
id|lv_map
(braket
id|MAX_VOICE
)braket
suffix:semicolon
DECL|member|voc
r_struct
id|voice_info
id|voc
(braket
id|MAX_VOICE
)braket
suffix:semicolon
DECL|member|v_alloc
r_struct
id|voice_alloc_info
op_star
id|v_alloc
suffix:semicolon
DECL|member|chn_info
r_struct
id|channel_info
op_star
id|chn_info
suffix:semicolon
DECL|member|i_map
r_struct
id|sbi_instrument
id|i_map
(braket
id|SBFM_MAXINSTR
)braket
suffix:semicolon
DECL|member|act_i
r_struct
id|sbi_instrument
op_star
id|act_i
(braket
id|MAX_VOICE
)braket
suffix:semicolon
DECL|member|fm_info
r_struct
id|synth_info
id|fm_info
suffix:semicolon
DECL|member|busy
r_int
id|busy
suffix:semicolon
DECL|member|model
r_int
id|model
suffix:semicolon
DECL|member|cmask
r_int
r_char
id|cmask
suffix:semicolon
DECL|member|is_opl4
r_int
id|is_opl4
suffix:semicolon
DECL|member|osp
r_int
op_star
id|osp
suffix:semicolon
DECL|typedef|opl_devinfo
)brace
id|opl_devinfo
suffix:semicolon
DECL|variable|devc
r_static
r_struct
id|opl_devinfo
op_star
id|devc
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|detected_model
r_static
r_int
id|detected_model
suffix:semicolon
r_static
r_int
id|store_instr
c_func
(paren
r_int
id|instr_no
comma
r_struct
id|sbi_instrument
op_star
id|instr
)paren
suffix:semicolon
r_static
r_void
id|freq_to_fnum
c_func
(paren
r_int
id|freq
comma
r_int
op_star
id|block
comma
r_int
op_star
id|fnum
)paren
suffix:semicolon
r_static
r_void
id|opl3_command
c_func
(paren
r_int
id|io_addr
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|val
)paren
suffix:semicolon
r_static
r_int
id|opl3_kill_note
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|note
comma
r_int
id|velocity
)paren
suffix:semicolon
DECL|function|enter_4op_mode
r_static
r_void
id|enter_4op_mode
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
id|v4op
(braket
id|MAX_VOICE
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|15
comma
l_int|16
comma
l_int|17
)brace
suffix:semicolon
id|devc-&gt;cmask
op_assign
l_int|0x3f
suffix:semicolon
multiline_comment|/* Connect all possible 4 OP voice operators */
id|opl3_command
c_func
(paren
id|devc-&gt;right_io
comma
id|CONNECTION_SELECT_REGISTER
comma
l_int|0x3f
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|pv_map
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|3
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
id|pv_map
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|9
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|pv_map
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|12
suffix:semicolon
id|i
OL
l_int|15
suffix:semicolon
id|i
op_increment
)paren
id|pv_map
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|devc-&gt;lv_map
(braket
id|i
)braket
op_assign
id|v4op
(braket
id|i
)braket
suffix:semicolon
id|devc-&gt;v_alloc-&gt;max_voice
op_assign
id|devc-&gt;nr_voice
op_assign
l_int|12
suffix:semicolon
)brace
DECL|function|opl3_ioctl
r_static
r_int
id|opl3_ioctl
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
r_struct
id|sbi_instrument
id|ins
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDCTL_FM_LOAD_INSTR
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Warning: Obsolete ioctl(SNDCTL_FM_LOAD_INSTR) used. Fix the program.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ins
comma
id|arg
comma
r_sizeof
(paren
id|ins
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ins.channel
OL
l_int|0
op_logical_or
id|ins.channel
op_ge
id|SBFM_MAXINSTR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;FM Error: Invalid instrument number %d&bslash;n&quot;
comma
id|ins.channel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|store_instr
c_func
(paren
id|ins.channel
comma
op_amp
id|ins
)paren
suffix:semicolon
r_case
id|SNDCTL_SYNTH_INFO
suffix:colon
id|devc-&gt;fm_info.nr_voices
op_assign
(paren
id|devc-&gt;nr_voice
op_eq
l_int|12
)paren
ques
c_cond
l_int|6
suffix:colon
id|devc-&gt;nr_voice
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|devc-&gt;fm_info
comma
r_sizeof
(paren
id|devc-&gt;fm_info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_SYNTH_MEMAVL
suffix:colon
r_return
l_int|0x7fffffff
suffix:semicolon
r_case
id|SNDCTL_FM_4OP_ENABLE
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
l_int|2
)paren
id|enter_4op_mode
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|opl3_detect
r_int
id|opl3_detect
c_func
(paren
r_int
id|ioaddr
comma
r_int
op_star
id|osp
)paren
(brace
multiline_comment|/*&n;&t; * This function returns 1 if the FM chip is present at the given I/O port&n;&t; * The detection algorithm plays with the timer built in the FM chip and&n;&t; * looks for a change in the status register.&n;&t; *&n;&t; * Note! The timers of the FM chip are not connected to AdLib (and compatible)&n;&t; * boards.&n;&t; *&n;&t; * Note2! The chip is initialized if detected.&n;&t; */
r_int
r_char
id|stat1
comma
id|signature
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|devc
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;opl3: Only one OPL3 supported.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|devc
op_assign
(paren
r_struct
id|opl_devinfo
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|devc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;opl3: Can&squot;t allocate memory for the device control &quot;
l_string|&quot;structure &bslash;n &quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|devc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|devc
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|devc-&gt;fm_info.name
comma
l_string|&quot;OPL2&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|ioaddr
comma
l_int|4
comma
id|devc-&gt;fm_info.name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;opl3: I/O port 0x%x already in use&bslash;n&quot;
comma
id|ioaddr
)paren
suffix:semicolon
r_goto
id|cleanup_devc
suffix:semicolon
)brace
id|devc-&gt;osp
op_assign
id|osp
suffix:semicolon
id|devc-&gt;base
op_assign
id|ioaddr
suffix:semicolon
multiline_comment|/* Reset timers 1 and 2 */
id|opl3_command
c_func
(paren
id|ioaddr
comma
id|TIMER_CONTROL_REGISTER
comma
id|TIMER1_MASK
op_or
id|TIMER2_MASK
)paren
suffix:semicolon
multiline_comment|/* Reset the IRQ of the FM chip */
id|opl3_command
c_func
(paren
id|ioaddr
comma
id|TIMER_CONTROL_REGISTER
comma
id|IRQ_RESET
)paren
suffix:semicolon
id|signature
op_assign
id|stat1
op_assign
id|inb
c_func
(paren
id|ioaddr
)paren
suffix:semicolon
multiline_comment|/* Status register */
r_if
c_cond
(paren
id|signature
op_ne
l_int|0x00
op_logical_and
id|signature
op_ne
l_int|0x06
op_logical_and
id|signature
op_ne
l_int|0x02
op_logical_and
id|signature
op_ne
l_int|0x0f
)paren
(brace
id|MDB
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;OPL3 not detected %x&bslash;n&quot;
comma
id|signature
)paren
)paren
suffix:semicolon
r_goto
id|cleanup_region
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signature
op_eq
l_int|0x06
)paren
multiline_comment|/* OPL2 */
(brace
id|detected_model
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|signature
op_eq
l_int|0x00
op_logical_or
id|signature
op_eq
l_int|0x0f
)paren
multiline_comment|/* OPL3 or OPL4 */
(brace
r_int
r_char
id|tmp
suffix:semicolon
id|detected_model
op_assign
l_int|3
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Detect availability of OPL4 (_experimental_). Works probably&n;&t;&t; * only after a cold boot. In addition the OPL4 port&n;&t;&t; * of the chip may not be connected to the PC bus at all.&n;&t;&t; */
id|opl3_command
c_func
(paren
id|ioaddr
op_plus
l_int|2
comma
id|OPL3_MODE_REGISTER
comma
l_int|0x00
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|ioaddr
op_plus
l_int|2
comma
id|OPL3_MODE_REGISTER
comma
id|OPL3_ENABLE
op_or
id|OPL4_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|inb
c_func
(paren
id|ioaddr
)paren
)paren
op_eq
l_int|0x02
)paren
multiline_comment|/* Have a OPL4 */
(brace
id|detected_model
op_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_region
c_func
(paren
id|ioaddr
op_minus
l_int|8
comma
l_int|2
comma
l_string|&quot;OPL4&quot;
)paren
)paren
multiline_comment|/* OPL4 port was free */
(brace
r_int
id|tmp
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0x02
)paren
comma
id|ioaddr
op_minus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Select OPL4 ID register */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|ioaddr
op_minus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Read it */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0x20
)paren
multiline_comment|/* OPL4 should return 0x20 here */
(brace
id|detected_model
op_assign
l_int|4
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0xF8
)paren
comma
id|ioaddr
op_minus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Select OPL4 FM mixer control */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0x1B
)paren
comma
id|ioaddr
op_minus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Write value */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* release OPL4 port */
id|release_region
c_func
(paren
id|ioaddr
op_minus
l_int|8
comma
l_int|2
)paren
suffix:semicolon
id|detected_model
op_assign
l_int|3
suffix:semicolon
)brace
)brace
id|opl3_command
c_func
(paren
id|ioaddr
op_plus
l_int|2
comma
id|OPL3_MODE_REGISTER
comma
l_int|0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
id|opl3_command
c_func
(paren
id|ioaddr
comma
id|KEYON_BLOCK
op_plus
id|i
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t;&t; * Note off&n;&t;&t;&t;&t;&t;&t;&t;&t; */
id|opl3_command
c_func
(paren
id|ioaddr
comma
id|TEST_REGISTER
comma
id|ENABLE_WAVE_SELECT
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|ioaddr
comma
id|PERCOSSION_REGISTER
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t;&t; * Melodic mode.&n;&t;&t;&t;&t;&t;&t;&t;&t; */
r_return
l_int|1
suffix:semicolon
id|cleanup_region
suffix:colon
id|release_region
c_func
(paren
id|ioaddr
comma
l_int|4
)paren
suffix:semicolon
id|cleanup_devc
suffix:colon
id|kfree
c_func
(paren
id|devc
)paren
suffix:semicolon
id|devc
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|opl3_kill_note
r_static
r_int
id|opl3_kill_note
(paren
r_int
id|devno
comma
r_int
id|voice
comma
r_int
id|note
comma
r_int
id|velocity
)paren
(brace
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|devc-&gt;nr_voice
)paren
r_return
l_int|0
suffix:semicolon
id|devc-&gt;v_alloc-&gt;map
(braket
id|voice
)braket
op_assign
l_int|0
suffix:semicolon
id|map
op_assign
op_amp
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|voice
)braket
)braket
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Kill note %d&bslash;n&quot;
comma
id|voice
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
comma
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|keyon_byte
op_amp
op_complement
l_int|0x20
)paren
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|keyon_byte
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|volume
op_assign
l_int|64
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|panning
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* Not set */
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender_range
op_assign
l_int|200
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|orig_freq
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|current_freq
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|mode
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|HIHAT
mdefine_line|#define HIHAT&t;&t;&t;0
DECL|macro|CYMBAL
mdefine_line|#define CYMBAL&t;&t;&t;1
DECL|macro|TOMTOM
mdefine_line|#define TOMTOM&t;&t;&t;2
DECL|macro|SNARE
mdefine_line|#define SNARE&t;&t;&t;3
DECL|macro|BDRUM
mdefine_line|#define BDRUM&t;&t;&t;4
DECL|macro|UNDEFINED
mdefine_line|#define UNDEFINED&t;&t;TOMTOM
DECL|macro|DEFAULT
mdefine_line|#define DEFAULT&t;&t;&t;TOMTOM
DECL|function|store_instr
r_static
r_int
id|store_instr
c_func
(paren
r_int
id|instr_no
comma
r_struct
id|sbi_instrument
op_star
id|instr
)paren
(brace
r_if
c_cond
(paren
id|instr-&gt;key
op_ne
id|FM_PATCH
op_logical_and
(paren
id|instr-&gt;key
op_ne
id|OPL3_PATCH
op_logical_or
id|devc-&gt;model
op_ne
l_int|2
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;FM warning: Invalid patch format field (key) 0x%x&bslash;n&quot;
comma
id|instr-&gt;key
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
(paren
id|devc-&gt;i_map
(braket
id|instr_no
)braket
)paren
comma
(paren
r_char
op_star
)paren
id|instr
comma
r_sizeof
(paren
op_star
id|instr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|opl3_set_instr
r_static
r_int
id|opl3_set_instr
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|instr_no
)paren
(brace
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|devc-&gt;nr_voice
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|instr_no
OL
l_int|0
op_logical_or
id|instr_no
op_ge
id|SBFM_MAXINSTR
)paren
id|instr_no
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Acoustic piano (usually) */
id|devc-&gt;act_i
(braket
id|voice
)braket
op_assign
op_amp
id|devc-&gt;i_map
(braket
id|instr_no
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The next table looks magical, but it certainly is not. Its values have&n; * been calculated as table[i]=8*log(i/64)/log(2) with an obvious exception&n; * for i=0. This log-table converts a linear volume-scaling (0..127) to a&n; * logarithmic scaling as present in the FM-synthesizer chips. so :    Volume&n; * 64 =  0 db = relative volume  0 and:    Volume 32 = -6 db = relative&n; * volume -8 it was implemented as a table because it is only 128 bytes and&n; * it saves a lot of log() calculations. (RH)&n; */
DECL|variable|fm_volume_table
r_static
r_char
id|fm_volume_table
(braket
l_int|128
)braket
op_assign
(brace
op_minus
l_int|64
comma
op_minus
l_int|48
comma
op_minus
l_int|40
comma
op_minus
l_int|35
comma
op_minus
l_int|32
comma
op_minus
l_int|29
comma
op_minus
l_int|27
comma
op_minus
l_int|26
comma
op_minus
l_int|24
comma
op_minus
l_int|23
comma
op_minus
l_int|21
comma
op_minus
l_int|20
comma
op_minus
l_int|19
comma
op_minus
l_int|18
comma
op_minus
l_int|18
comma
op_minus
l_int|17
comma
op_minus
l_int|16
comma
op_minus
l_int|15
comma
op_minus
l_int|15
comma
op_minus
l_int|14
comma
op_minus
l_int|13
comma
op_minus
l_int|13
comma
op_minus
l_int|12
comma
op_minus
l_int|12
comma
op_minus
l_int|11
comma
op_minus
l_int|11
comma
op_minus
l_int|10
comma
op_minus
l_int|10
comma
op_minus
l_int|10
comma
op_minus
l_int|9
comma
op_minus
l_int|9
comma
op_minus
l_int|8
comma
op_minus
l_int|8
comma
op_minus
l_int|8
comma
op_minus
l_int|7
comma
op_minus
l_int|7
comma
op_minus
l_int|7
comma
op_minus
l_int|6
comma
op_minus
l_int|6
comma
op_minus
l_int|6
comma
op_minus
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|4
comma
op_minus
l_int|4
comma
op_minus
l_int|4
comma
op_minus
l_int|4
comma
op_minus
l_int|3
comma
op_minus
l_int|3
comma
op_minus
l_int|3
comma
op_minus
l_int|3
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|8
)brace
suffix:semicolon
DECL|function|calc_vol
r_static
r_void
id|calc_vol
c_func
(paren
r_int
r_char
op_star
id|regbyte
comma
r_int
id|volume
comma
r_int
id|main_vol
)paren
(brace
r_int
id|level
op_assign
(paren
op_complement
op_star
id|regbyte
op_amp
l_int|0x3f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|main_vol
OG
l_int|127
)paren
id|main_vol
op_assign
l_int|127
suffix:semicolon
id|volume
op_assign
(paren
id|volume
op_star
id|main_vol
)paren
op_div
l_int|127
suffix:semicolon
r_if
c_cond
(paren
id|level
)paren
id|level
op_add_assign
id|fm_volume_table
(braket
id|volume
)braket
suffix:semicolon
r_if
c_cond
(paren
id|level
OG
l_int|0x3f
)paren
id|level
op_assign
l_int|0x3f
suffix:semicolon
r_if
c_cond
(paren
id|level
OL
l_int|0
)paren
id|level
op_assign
l_int|0
suffix:semicolon
op_star
id|regbyte
op_assign
(paren
op_star
id|regbyte
op_amp
l_int|0xc0
)paren
op_or
(paren
op_complement
id|level
op_amp
l_int|0x3f
)paren
suffix:semicolon
)brace
DECL|function|set_voice_volume
r_static
r_void
id|set_voice_volume
c_func
(paren
r_int
id|voice
comma
r_int
id|volume
comma
r_int
id|main_vol
)paren
(brace
r_int
r_char
id|vol1
comma
id|vol2
comma
id|vol3
comma
id|vol4
suffix:semicolon
r_struct
id|sbi_instrument
op_star
id|instr
suffix:semicolon
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|devc-&gt;nr_voice
)paren
r_return
suffix:semicolon
id|map
op_assign
op_amp
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|voice
)braket
)braket
suffix:semicolon
id|instr
op_assign
id|devc-&gt;act_i
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instr
)paren
id|instr
op_assign
op_amp
id|devc-&gt;i_map
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;channel
OL
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|mode
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|mode
op_eq
l_int|2
)paren
(brace
id|vol1
op_assign
id|instr-&gt;operators
(braket
l_int|2
)braket
suffix:semicolon
id|vol2
op_assign
id|instr-&gt;operators
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|instr-&gt;operators
(braket
l_int|10
)braket
op_amp
l_int|0x01
)paren
)paren
(brace
id|calc_vol
c_func
(paren
op_amp
id|vol1
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
id|calc_vol
c_func
(paren
op_amp
id|vol2
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
)brace
r_else
(brace
id|calc_vol
c_func
(paren
op_amp
id|vol2
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
)brace
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|vol1
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|vol2
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * 4 OP voice&n;&t;&t; */
r_int
id|connection
suffix:semicolon
id|vol1
op_assign
id|instr-&gt;operators
(braket
l_int|2
)braket
suffix:semicolon
id|vol2
op_assign
id|instr-&gt;operators
(braket
l_int|3
)braket
suffix:semicolon
id|vol3
op_assign
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|2
)braket
suffix:semicolon
id|vol4
op_assign
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|3
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The connection method for 4 OP devc-&gt;voc is defined by the rightmost&n;&t;&t; * bits at the offsets 10 and 10+OFFS_4OP&n;&t;&t; */
id|connection
op_assign
(paren
(paren
id|instr-&gt;operators
(braket
l_int|10
)braket
op_amp
l_int|0x01
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|instr-&gt;operators
(braket
l_int|10
op_plus
id|OFFS_4OP
)braket
op_amp
l_int|0x01
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|connection
)paren
(brace
r_case
l_int|0
suffix:colon
id|calc_vol
c_func
(paren
op_amp
id|vol4
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|calc_vol
c_func
(paren
op_amp
id|vol2
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
id|calc_vol
c_func
(paren
op_amp
id|vol4
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|calc_vol
c_func
(paren
op_amp
id|vol1
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
id|calc_vol
c_func
(paren
op_amp
id|vol4
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|calc_vol
c_func
(paren
op_amp
id|vol1
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
id|calc_vol
c_func
(paren
op_amp
id|vol3
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
id|calc_vol
c_func
(paren
op_amp
id|vol4
comma
id|volume
comma
id|main_vol
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|vol1
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|vol2
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|vol3
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|vol4
)paren
suffix:semicolon
)brace
)brace
DECL|function|opl3_start_note
r_static
r_int
id|opl3_start_note
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|note
comma
r_int
id|volume
)paren
(brace
r_int
r_char
id|data
comma
id|fpc
suffix:semicolon
r_int
id|block
comma
id|fnum
comma
id|freq
comma
id|voice_mode
comma
id|pan
suffix:semicolon
r_struct
id|sbi_instrument
op_star
id|instr
suffix:semicolon
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|devc-&gt;nr_voice
)paren
r_return
l_int|0
suffix:semicolon
id|map
op_assign
op_amp
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|voice
)braket
)braket
suffix:semicolon
id|pan
op_assign
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|panning
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|note
op_eq
l_int|255
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * Just change the volume&n;&t;&t;&t;&t; */
(brace
id|set_voice_volume
c_func
(paren
id|voice
comma
id|volume
comma
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|volume
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Kill previous note before playing&n;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * Carrier&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * volume to&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * min&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * Modulator&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * volume to&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|4
)paren
(brace
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
l_int|0xff
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KSL_LEVEL
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
l_int|0xff
)paren
suffix:semicolon
)brace
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * Note&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; * off&n;&t;&t;&t;&t;&t;&t;&t;&t;&t; */
id|instr
op_assign
id|devc-&gt;act_i
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instr
)paren
id|instr
op_assign
op_amp
id|devc-&gt;i_map
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;channel
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;opl3: Initializing voice %d with undefined instrument&bslash;n&quot;
comma
id|voice
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|2
op_logical_and
id|instr-&gt;key
op_eq
id|OPL3_PATCH
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Cannot play&n;&t;&t;&t;&t; */
id|voice_mode
op_assign
id|map-&gt;voice_mode
suffix:semicolon
r_if
c_cond
(paren
id|voice_mode
op_eq
l_int|4
)paren
(brace
r_int
id|voice_shift
suffix:semicolon
id|voice_shift
op_assign
(paren
id|map-&gt;ioaddr
op_eq
id|devc-&gt;left_io
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|3
suffix:semicolon
id|voice_shift
op_add_assign
id|map-&gt;voice_num
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;key
op_ne
id|OPL3_PATCH
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * Just 2 OP patch&n;&t;&t;&t;&t;&t;&t; */
(brace
id|voice_mode
op_assign
l_int|2
suffix:semicolon
id|devc-&gt;cmask
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|voice_shift
)paren
suffix:semicolon
)brace
r_else
(brace
id|devc-&gt;cmask
op_or_assign
(paren
l_int|1
op_lshift
id|voice_shift
)paren
suffix:semicolon
)brace
id|opl3_command
c_func
(paren
id|devc-&gt;right_io
comma
id|CONNECTION_SELECT_REGISTER
comma
id|devc-&gt;cmask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set Sound Characteristics&n;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|AM_VIB
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|instr-&gt;operators
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|AM_VIB
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|instr-&gt;operators
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set Attack/Decay&n;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|ATTACK_DECAY
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|instr-&gt;operators
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|ATTACK_DECAY
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|instr-&gt;operators
(braket
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set Sustain/Release&n;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|SUSTAIN_RELEASE
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|instr-&gt;operators
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|SUSTAIN_RELEASE
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|instr-&gt;operators
(braket
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set Wave Select&n;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|WAVE_SELECT
op_plus
id|map-&gt;op
(braket
l_int|0
)braket
comma
id|instr-&gt;operators
(braket
l_int|8
)braket
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|WAVE_SELECT
op_plus
id|map-&gt;op
(braket
l_int|1
)braket
comma
id|instr-&gt;operators
(braket
l_int|9
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set Feedback/Connection&n;&t; */
id|fpc
op_assign
id|instr-&gt;operators
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pan
op_ne
l_int|0xffff
)paren
(brace
id|fpc
op_and_assign
op_complement
id|STEREO_BITS
suffix:semicolon
r_if
c_cond
(paren
id|pan
OL
op_minus
l_int|64
)paren
id|fpc
op_or_assign
id|VOICE_TO_LEFT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pan
OG
l_int|64
)paren
id|fpc
op_or_assign
id|VOICE_TO_RIGHT
suffix:semicolon
r_else
id|fpc
op_or_assign
(paren
id|VOICE_TO_LEFT
op_or
id|VOICE_TO_RIGHT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fpc
op_amp
l_int|0x30
)paren
)paren
id|fpc
op_or_assign
l_int|0x30
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Ensure that at least one chn is enabled&n;&t;&t;&t;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|FEEDBACK_CONNECTION
op_plus
id|map-&gt;voice_num
comma
id|fpc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the voice is a 4 OP one, initialize the operators 3 and 4 also&n;&t; */
r_if
c_cond
(paren
id|voice_mode
op_eq
l_int|4
)paren
(brace
multiline_comment|/*&n;&t;&t; * Set Sound Characteristics&n;&t;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|AM_VIB
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|0
)braket
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|AM_VIB
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Set Attack/Decay&n;&t;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|ATTACK_DECAY
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|4
)braket
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|ATTACK_DECAY
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Set Sustain/Release&n;&t;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|SUSTAIN_RELEASE
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|6
)braket
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|SUSTAIN_RELEASE
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|7
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Set Wave Select&n;&t;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|WAVE_SELECT
op_plus
id|map-&gt;op
(braket
l_int|2
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|8
)braket
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|WAVE_SELECT
op_plus
id|map-&gt;op
(braket
l_int|3
)braket
comma
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|9
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Set Feedback/Connection&n;&t;&t; */
id|fpc
op_assign
id|instr-&gt;operators
(braket
id|OFFS_4OP
op_plus
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fpc
op_amp
l_int|0x30
)paren
)paren
id|fpc
op_or_assign
l_int|0x30
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Ensure that at least one chn is enabled&n;&t;&t;&t;&t;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|FEEDBACK_CONNECTION
op_plus
id|map-&gt;voice_num
op_plus
l_int|3
comma
id|fpc
)paren
suffix:semicolon
)brace
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|mode
op_assign
id|voice_mode
suffix:semicolon
id|set_voice_volume
c_func
(paren
id|voice
comma
id|volume
comma
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|volume
)paren
suffix:semicolon
id|freq
op_assign
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|orig_freq
op_assign
id|note_to_freq
c_func
(paren
id|note
)paren
op_div
l_int|1000
suffix:semicolon
multiline_comment|/*&n;&t; * Since the pitch bender may have been set before playing the note, we&n;&t; * have to calculate the bending now.&n;&t; */
id|freq
op_assign
id|compute_finetune
c_func
(paren
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|orig_freq
comma
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender
comma
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender_range
comma
l_int|0
)paren
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|current_freq
op_assign
id|freq
suffix:semicolon
id|freq_to_fnum
c_func
(paren
id|freq
comma
op_amp
id|block
comma
op_amp
id|fnum
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Play note&n;&t; */
id|data
op_assign
id|fnum
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Least significant bits of fnumber&n;&t;&t;&t;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|FNUM_LOW
op_plus
id|map-&gt;voice_num
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
l_int|0x20
op_or
(paren
(paren
id|block
op_amp
l_int|0x7
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|fnum
op_rshift
l_int|8
)paren
op_amp
l_int|0x3
)paren
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|keyon_byte
op_assign
id|data
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|voice_mode
op_eq
l_int|4
)paren
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
op_plus
l_int|3
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|freq_to_fnum
r_static
r_void
id|freq_to_fnum
(paren
r_int
id|freq
comma
r_int
op_star
id|block
comma
r_int
op_star
id|fnum
)paren
(brace
r_int
id|f
comma
id|octave
suffix:semicolon
multiline_comment|/*&n;&t; * Converts the note frequency to block and fnum values for the FM chip&n;&t; */
multiline_comment|/*&n;&t; * First try to compute the block -value (octave) where the note belongs&n;&t; */
id|f
op_assign
id|freq
suffix:semicolon
id|octave
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|f
op_eq
l_int|0
)paren
id|octave
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|f
OL
l_int|261
)paren
(brace
r_while
c_loop
(paren
id|f
OL
l_int|261
)paren
(brace
id|octave
op_decrement
suffix:semicolon
id|f
op_lshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|f
OG
l_int|493
)paren
(brace
r_while
c_loop
(paren
id|f
OG
l_int|493
)paren
(brace
id|octave
op_increment
suffix:semicolon
id|f
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|octave
OG
l_int|7
)paren
id|octave
op_assign
l_int|7
suffix:semicolon
op_star
id|fnum
op_assign
id|freq
op_star
(paren
l_int|1
op_lshift
(paren
l_int|20
op_minus
id|octave
)paren
)paren
op_div
l_int|49716
suffix:semicolon
op_star
id|block
op_assign
id|octave
suffix:semicolon
)brace
DECL|function|opl3_command
r_static
r_void
id|opl3_command
(paren
r_int
id|io_addr
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|val
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * The original 2-OP synth requires a quite long delay after writing to a&n;&t; * register. The OPL-3 survives with just two INBs&n;&t; */
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|addr
op_amp
l_int|0xff
)paren
)paren
comma
id|io_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
l_int|2
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|inb
c_func
(paren
id|io_addr
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
(paren
r_int
r_char
)paren
(paren
id|val
op_amp
l_int|0xff
)paren
)paren
comma
id|io_addr
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_ne
l_int|2
)paren
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|inb
c_func
(paren
id|io_addr
)paren
suffix:semicolon
)brace
DECL|function|opl3_reset
r_static
r_void
id|opl3_reset
c_func
(paren
r_int
id|devno
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
id|devc-&gt;lv_map
(braket
id|i
)braket
op_assign
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devc-&gt;nr_voice
suffix:semicolon
id|i
op_increment
)paren
(brace
id|opl3_command
c_func
(paren
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|i
)braket
)braket
dot
id|ioaddr
comma
id|KSL_LEVEL
op_plus
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|i
)braket
)braket
dot
id|op
(braket
l_int|0
)braket
comma
l_int|0xff
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|i
)braket
)braket
dot
id|ioaddr
comma
id|KSL_LEVEL
op_plus
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|i
)braket
)braket
dot
id|op
(braket
l_int|1
)braket
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|i
)braket
)braket
dot
id|voice_mode
op_eq
l_int|4
)paren
(brace
id|opl3_command
c_func
(paren
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|i
)braket
)braket
dot
id|ioaddr
comma
id|KSL_LEVEL
op_plus
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|i
)braket
)braket
dot
id|op
(braket
l_int|2
)braket
comma
l_int|0xff
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|i
)braket
)braket
dot
id|ioaddr
comma
id|KSL_LEVEL
op_plus
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|i
)braket
)braket
dot
id|op
(braket
l_int|3
)braket
comma
l_int|0xff
)paren
suffix:semicolon
)brace
id|opl3_kill_note
c_func
(paren
id|devno
comma
id|i
comma
l_int|0
comma
l_int|64
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
l_int|2
)paren
(brace
id|devc-&gt;v_alloc-&gt;max_voice
op_assign
id|devc-&gt;nr_voice
op_assign
l_int|18
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
id|pv_map
(braket
id|i
)braket
dot
id|voice_mode
op_assign
l_int|2
suffix:semicolon
)brace
)brace
DECL|function|opl3_open
r_static
r_int
id|opl3_open
c_func
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;busy
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|devc-&gt;busy
op_assign
l_int|1
suffix:semicolon
id|devc-&gt;v_alloc-&gt;max_voice
op_assign
id|devc-&gt;nr_voice
op_assign
(paren
id|devc-&gt;model
op_eq
l_int|2
)paren
ques
c_cond
l_int|18
suffix:colon
l_int|9
suffix:semicolon
id|devc-&gt;v_alloc-&gt;timestamp
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
(brace
id|devc-&gt;v_alloc-&gt;map
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;v_alloc-&gt;alloc_times
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|devc-&gt;cmask
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Just 2 OP mode&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
l_int|2
)paren
id|opl3_command
c_func
(paren
id|devc-&gt;right_io
comma
id|CONNECTION_SELECT_REGISTER
comma
id|devc-&gt;cmask
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|opl3_close
r_static
r_void
id|opl3_close
c_func
(paren
r_int
id|dev
)paren
(brace
id|devc-&gt;busy
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;v_alloc-&gt;max_voice
op_assign
id|devc-&gt;nr_voice
op_assign
(paren
id|devc-&gt;model
op_eq
l_int|2
)paren
ques
c_cond
l_int|18
suffix:colon
l_int|9
suffix:semicolon
id|devc-&gt;fm_info.nr_drums
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;fm_info.perc_mode
op_assign
l_int|0
suffix:semicolon
id|opl3_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|opl3_hw_control
r_static
r_void
id|opl3_hw_control
c_func
(paren
r_int
id|dev
comma
r_int
r_char
op_star
id|event
)paren
(brace
)brace
DECL|function|opl3_load_patch
r_static
r_int
id|opl3_load_patch
c_func
(paren
r_int
id|dev
comma
r_int
id|format
comma
r_const
r_char
op_star
id|addr
comma
r_int
id|offs
comma
r_int
id|count
comma
r_int
id|pmgr_flag
)paren
(brace
r_struct
id|sbi_instrument
id|ins
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
r_sizeof
(paren
id|ins
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;FM Error: Patch record too short&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
(paren
(paren
r_char
op_star
)paren
op_amp
id|ins
)paren
(braket
id|offs
)braket
comma
op_amp
(paren
id|addr
)paren
(braket
id|offs
)braket
comma
r_sizeof
(paren
id|ins
)paren
op_minus
id|offs
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ins.channel
OL
l_int|0
op_logical_or
id|ins.channel
op_ge
id|SBFM_MAXINSTR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;FM Error: Invalid instrument number %d&bslash;n&quot;
comma
id|ins.channel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ins.key
op_assign
id|format
suffix:semicolon
r_return
id|store_instr
c_func
(paren
id|ins.channel
comma
op_amp
id|ins
)paren
suffix:semicolon
)brace
DECL|function|opl3_panning
r_static
r_void
id|opl3_panning
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|value
)paren
(brace
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|panning
op_assign
id|value
suffix:semicolon
)brace
DECL|function|opl3_volume_method
r_static
r_void
id|opl3_volume_method
c_func
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
)brace
DECL|macro|SET_VIBRATO
mdefine_line|#define SET_VIBRATO(cell) { &bslash;&n;&t;tmp = instr-&gt;operators[(cell-1)+(((cell-1)/2)*OFFS_4OP)]; &bslash;&n;&t;if (pressure &gt; 110) &bslash;&n;&t;&t;tmp |= 0x40;&t;&t;/* Vibrato on */ &bslash;&n;&t;opl3_command (map-&gt;ioaddr, AM_VIB + map-&gt;op[cell-1], tmp);}
DECL|function|opl3_aftertouch
r_static
r_void
id|opl3_aftertouch
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|pressure
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_struct
id|sbi_instrument
op_star
id|instr
suffix:semicolon
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|devc-&gt;nr_voice
)paren
r_return
suffix:semicolon
id|map
op_assign
op_amp
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|voice
)braket
)braket
suffix:semicolon
id|DEB
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Aftertouch %d&bslash;n&quot;
comma
id|voice
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Adjust the amount of vibrato depending the pressure&n;&t; */
id|instr
op_assign
id|devc-&gt;act_i
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instr
)paren
id|instr
op_assign
op_amp
id|devc-&gt;i_map
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|mode
op_eq
l_int|4
)paren
(brace
r_int
id|connection
op_assign
(paren
(paren
id|instr-&gt;operators
(braket
l_int|10
)braket
op_amp
l_int|0x01
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|instr-&gt;operators
(braket
l_int|10
op_plus
id|OFFS_4OP
)braket
op_amp
l_int|0x01
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|connection
)paren
(brace
r_case
l_int|0
suffix:colon
id|SET_VIBRATO
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|SET_VIBRATO
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|SET_VIBRATO
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|SET_VIBRATO
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|SET_VIBRATO
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|SET_VIBRATO
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|SET_VIBRATO
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|SET_VIBRATO
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Not implemented yet&n;&t;&t; */
)brace
r_else
(brace
id|SET_VIBRATO
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|instr-&gt;operators
(braket
l_int|10
)braket
op_amp
l_int|0x01
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t; * Additive synthesis&n;&t;&t;&t;&t;&t;&t;&t; */
id|SET_VIBRATO
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
)brace
DECL|macro|SET_VIBRATO
macro_line|#undef SET_VIBRATO
DECL|function|bend_pitch
r_static
r_void
id|bend_pitch
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|value
)paren
(brace
r_int
r_char
id|data
suffix:semicolon
r_int
id|block
comma
id|fnum
comma
id|freq
suffix:semicolon
r_struct
id|physical_voice_info
op_star
id|map
suffix:semicolon
id|map
op_assign
op_amp
id|pv_map
(braket
id|devc-&gt;lv_map
(braket
id|voice
)braket
)braket
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;voice_mode
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|value
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|keyon_byte
op_amp
l_int|0x20
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Not keyed on&n;&t;&t;&t; */
id|freq
op_assign
id|compute_finetune
c_func
(paren
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|orig_freq
comma
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender
comma
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender_range
comma
l_int|0
)paren
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|current_freq
op_assign
id|freq
suffix:semicolon
id|freq_to_fnum
c_func
(paren
id|freq
comma
op_amp
id|block
comma
op_amp
id|fnum
)paren
suffix:semicolon
id|data
op_assign
id|fnum
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Least significant bits of fnumber&n;&t;&t;&t;&t; */
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|FNUM_LOW
op_plus
id|map-&gt;voice_num
comma
id|data
)paren
suffix:semicolon
id|data
op_assign
l_int|0x20
op_or
(paren
(paren
id|block
op_amp
l_int|0x7
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|fnum
op_rshift
l_int|8
)paren
op_amp
l_int|0x3
)paren
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|keyon_byte
op_assign
id|data
suffix:semicolon
id|opl3_command
c_func
(paren
id|map-&gt;ioaddr
comma
id|KEYON_BLOCK
op_plus
id|map-&gt;voice_num
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|opl3_controller
r_static
r_void
id|opl3_controller
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|ctrl_num
comma
r_int
id|value
)paren
(brace
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|devc-&gt;nr_voice
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|ctrl_num
)paren
(brace
r_case
id|CTRL_PITCH_BENDER
suffix:colon
id|bend_pitch
c_func
(paren
id|dev
comma
id|voice
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTRL_PITCH_BENDER_RANGE
suffix:colon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender_range
op_assign
id|value
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTL_MAIN_VOLUME
suffix:colon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|volume
op_assign
id|value
op_div
l_int|128
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTL_PAN
suffix:colon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|panning
op_assign
(paren
id|value
op_star
l_int|2
)paren
op_minus
l_int|128
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|opl3_bender
r_static
r_void
id|opl3_bender
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|value
)paren
(brace
r_if
c_cond
(paren
id|voice
OL
l_int|0
op_logical_or
id|voice
op_ge
id|devc-&gt;nr_voice
)paren
r_return
suffix:semicolon
id|bend_pitch
c_func
(paren
id|dev
comma
id|voice
comma
id|value
op_minus
l_int|8192
)paren
suffix:semicolon
)brace
DECL|function|opl3_alloc_voice
r_static
r_int
id|opl3_alloc_voice
c_func
(paren
r_int
id|dev
comma
r_int
id|chn
comma
r_int
id|note
comma
r_struct
id|voice_alloc_info
op_star
id|alloc
)paren
(brace
r_int
id|i
comma
id|p
comma
id|best
comma
id|first
comma
id|avail
comma
id|best_time
op_assign
l_int|0x7fffffff
suffix:semicolon
r_struct
id|sbi_instrument
op_star
id|instr
suffix:semicolon
r_int
id|is4op
suffix:semicolon
r_int
id|instr_no
suffix:semicolon
r_if
c_cond
(paren
id|chn
template_param
l_int|15
)paren
id|instr_no
op_assign
l_int|0
suffix:semicolon
r_else
id|instr_no
op_assign
id|devc-&gt;chn_info
(braket
id|chn
)braket
dot
id|pgm_num
suffix:semicolon
id|instr
op_assign
op_amp
id|devc-&gt;i_map
(braket
id|instr_no
)braket
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;channel
OL
l_int|0
op_logical_or
multiline_comment|/* Instrument not loaded */
id|devc-&gt;nr_voice
op_ne
l_int|12
)paren
multiline_comment|/* Not in 4 OP mode */
id|is4op
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|devc-&gt;nr_voice
op_eq
l_int|12
)paren
multiline_comment|/* 4 OP mode */
id|is4op
op_assign
(paren
id|instr-&gt;key
op_eq
id|OPL3_PATCH
)paren
suffix:semicolon
r_else
id|is4op
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|is4op
)paren
(brace
id|first
op_assign
id|p
op_assign
l_int|0
suffix:semicolon
id|avail
op_assign
l_int|6
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|devc-&gt;nr_voice
op_eq
l_int|12
)paren
multiline_comment|/* 4 OP mode. Use the &squot;2 OP only&squot; operators first */
id|first
op_assign
id|p
op_assign
l_int|6
suffix:semicolon
r_else
id|first
op_assign
id|p
op_assign
l_int|0
suffix:semicolon
id|avail
op_assign
id|devc-&gt;nr_voice
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *    Now try to find a free voice&n;&t; */
id|best
op_assign
id|first
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|avail
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|alloc-&gt;map
(braket
id|p
)braket
op_eq
l_int|0
)paren
(brace
r_return
id|p
suffix:semicolon
)brace
r_if
c_cond
(paren
id|alloc-&gt;alloc_times
(braket
id|p
)braket
OL
id|best_time
)paren
multiline_comment|/* Find oldest playing note */
(brace
id|best_time
op_assign
id|alloc-&gt;alloc_times
(braket
id|p
)braket
suffix:semicolon
id|best
op_assign
id|p
suffix:semicolon
)brace
id|p
op_assign
(paren
id|p
op_plus
l_int|1
)paren
op_mod
id|avail
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *    Insert some kind of priority mechanism here.&n;&t; */
r_if
c_cond
(paren
id|best
OL
l_int|0
)paren
id|best
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|best
OG
id|devc-&gt;nr_voice
)paren
id|best
op_sub_assign
id|devc-&gt;nr_voice
suffix:semicolon
r_return
id|best
suffix:semicolon
multiline_comment|/* All devc-&gt;voc in use. Select the first one. */
)brace
DECL|function|opl3_setup_voice
r_static
r_void
id|opl3_setup_voice
c_func
(paren
r_int
id|dev
comma
r_int
id|voice
comma
r_int
id|chn
)paren
(brace
r_struct
id|channel_info
op_star
id|info
op_assign
op_amp
id|synth_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|chn_info
(braket
id|chn
)braket
suffix:semicolon
id|opl3_set_instr
c_func
(paren
id|dev
comma
id|voice
comma
id|info-&gt;pgm_num
)paren
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|bender_range
op_assign
id|info-&gt;bender_range
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|volume
op_assign
id|info-&gt;controllers
(braket
id|CTL_MAIN_VOLUME
)braket
suffix:semicolon
id|devc-&gt;voc
(braket
id|voice
)braket
dot
id|panning
op_assign
(paren
id|info-&gt;controllers
(braket
id|CTL_PAN
)braket
op_star
l_int|2
)paren
op_minus
l_int|128
suffix:semicolon
)brace
DECL|variable|opl3_operations
r_static
r_struct
id|synth_operations
id|opl3_operations
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|id
suffix:colon
l_string|&quot;OPL&quot;
comma
id|info
suffix:colon
l_int|NULL
comma
id|midi_dev
suffix:colon
l_int|0
comma
id|synth_type
suffix:colon
id|SYNTH_TYPE_FM
comma
id|synth_subtype
suffix:colon
id|FM_TYPE_ADLIB
comma
id|open
suffix:colon
id|opl3_open
comma
id|close
suffix:colon
id|opl3_close
comma
id|ioctl
suffix:colon
id|opl3_ioctl
comma
id|kill_note
suffix:colon
id|opl3_kill_note
comma
id|start_note
suffix:colon
id|opl3_start_note
comma
id|set_instr
suffix:colon
id|opl3_set_instr
comma
id|reset
suffix:colon
id|opl3_reset
comma
id|hw_control
suffix:colon
id|opl3_hw_control
comma
id|load_patch
suffix:colon
id|opl3_load_patch
comma
id|aftertouch
suffix:colon
id|opl3_aftertouch
comma
id|controller
suffix:colon
id|opl3_controller
comma
id|panning
suffix:colon
id|opl3_panning
comma
id|volume_method
suffix:colon
id|opl3_volume_method
comma
id|bender
suffix:colon
id|opl3_bender
comma
id|alloc_voice
suffix:colon
id|opl3_alloc_voice
comma
id|setup_voice
suffix:colon
id|opl3_setup_voice
)brace
suffix:semicolon
DECL|function|opl3_init
r_int
id|opl3_init
c_func
(paren
r_int
id|ioaddr
comma
r_int
op_star
id|osp
comma
r_struct
id|module
op_star
id|owner
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|me
suffix:semicolon
r_if
c_cond
(paren
id|devc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;opl3: Device control structure not initialized.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|me
op_assign
id|sound_alloc_synthdev
c_func
(paren
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;opl3: Too many synthesizers&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|devc-&gt;nr_voice
op_assign
l_int|9
suffix:semicolon
id|devc-&gt;fm_info.device
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;fm_info.synth_type
op_assign
id|SYNTH_TYPE_FM
suffix:semicolon
id|devc-&gt;fm_info.synth_subtype
op_assign
id|FM_TYPE_ADLIB
suffix:semicolon
id|devc-&gt;fm_info.perc_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;fm_info.nr_voices
op_assign
l_int|9
suffix:semicolon
id|devc-&gt;fm_info.nr_drums
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;fm_info.instr_bank_size
op_assign
id|SBFM_MAXINSTR
suffix:semicolon
id|devc-&gt;fm_info.capabilities
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;left_io
op_assign
id|ioaddr
suffix:semicolon
id|devc-&gt;right_io
op_assign
id|ioaddr
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|detected_model
op_le
l_int|2
)paren
id|devc-&gt;model
op_assign
l_int|1
suffix:semicolon
r_else
(brace
id|devc-&gt;model
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|detected_model
op_eq
l_int|4
)paren
id|devc-&gt;is_opl4
op_assign
l_int|1
suffix:semicolon
)brace
id|opl3_operations.info
op_assign
op_amp
id|devc-&gt;fm_info
suffix:semicolon
id|synth_devs
(braket
id|me
)braket
op_assign
op_amp
id|opl3_operations
suffix:semicolon
r_if
c_cond
(paren
id|owner
)paren
id|synth_devs
(braket
id|me
)braket
op_member_access_from_pointer
id|owner
op_assign
id|owner
suffix:semicolon
id|sequencer_init
c_func
(paren
)paren
suffix:semicolon
id|devc-&gt;v_alloc
op_assign
op_amp
id|opl3_operations.alloc
suffix:semicolon
id|devc-&gt;chn_info
op_assign
op_amp
id|opl3_operations.chn_info
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;model
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;is_opl4
)paren
id|strcpy
c_func
(paren
id|devc-&gt;fm_info.name
comma
l_string|&quot;Yamaha OPL4/OPL3 FM&quot;
)paren
suffix:semicolon
r_else
id|strcpy
c_func
(paren
id|devc-&gt;fm_info.name
comma
l_string|&quot;Yamaha OPL3&quot;
)paren
suffix:semicolon
id|devc-&gt;v_alloc-&gt;max_voice
op_assign
id|devc-&gt;nr_voice
op_assign
l_int|18
suffix:semicolon
id|devc-&gt;fm_info.nr_drums
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;fm_info.synth_subtype
op_assign
id|FM_TYPE_OPL3
suffix:semicolon
id|devc-&gt;fm_info.capabilities
op_or_assign
id|SYNTH_CAP_OPL3
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pv_map
(braket
id|i
)braket
dot
id|ioaddr
op_eq
id|USE_LEFT
)paren
id|pv_map
(braket
id|i
)braket
dot
id|ioaddr
op_assign
id|devc-&gt;left_io
suffix:semicolon
r_else
id|pv_map
(braket
id|i
)braket
dot
id|ioaddr
op_assign
id|devc-&gt;right_io
suffix:semicolon
)brace
id|opl3_command
c_func
(paren
id|devc-&gt;right_io
comma
id|OPL3_MODE_REGISTER
comma
id|OPL3_ENABLE
)paren
suffix:semicolon
id|opl3_command
c_func
(paren
id|devc-&gt;right_io
comma
id|CONNECTION_SELECT_REGISTER
comma
l_int|0x00
)paren
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|devc-&gt;fm_info.name
comma
l_string|&quot;Yamaha OPL2&quot;
)paren
suffix:semicolon
id|devc-&gt;v_alloc-&gt;max_voice
op_assign
id|devc-&gt;nr_voice
op_assign
l_int|9
suffix:semicolon
id|devc-&gt;fm_info.nr_drums
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
id|pv_map
(braket
id|i
)braket
dot
id|ioaddr
op_assign
id|devc-&gt;left_io
suffix:semicolon
)brace
suffix:semicolon
id|conf_printf2
c_func
(paren
id|devc-&gt;fm_info.name
comma
id|ioaddr
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SBFM_MAXINSTR
suffix:semicolon
id|i
op_increment
)paren
id|devc-&gt;i_map
(braket
id|i
)braket
dot
id|channel
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|me
suffix:semicolon
)brace
DECL|variable|opl3_init
id|EXPORT_SYMBOL
c_func
(paren
id|opl3_init
)paren
suffix:semicolon
DECL|variable|opl3_detect
id|EXPORT_SYMBOL
c_func
(paren
id|opl3_detect
)paren
suffix:semicolon
DECL|variable|me
r_static
r_int
id|me
suffix:semicolon
DECL|variable|io
r_static
r_int
id|io
op_assign
op_minus
l_int|1
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|init_opl3
r_static
r_int
id|__init
id|init_opl3
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;YM3812 and OPL-3 driver Copyright (C) by Hannu Savolainen, Rob Hooft 1993-1996&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io
op_ne
op_minus
l_int|1
)paren
multiline_comment|/* User loading pure OPL3 module */
(brace
r_if
c_cond
(paren
op_logical_neg
id|opl3_detect
c_func
(paren
id|io
comma
l_int|NULL
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|me
op_assign
id|opl3_init
c_func
(paren
id|io
comma
l_int|NULL
comma
id|THIS_MODULE
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_opl3
r_static
r_void
id|__exit
id|cleanup_opl3
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|devc
op_logical_and
id|io
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;base
)paren
(brace
id|release_region
c_func
(paren
id|devc-&gt;base
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;is_opl4
)paren
id|release_region
c_func
(paren
id|devc-&gt;base
op_minus
l_int|8
comma
l_int|2
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|devc
)paren
suffix:semicolon
id|devc
op_assign
l_int|NULL
suffix:semicolon
id|sound_unload_synthdev
c_func
(paren
id|me
)paren
suffix:semicolon
)brace
)brace
DECL|variable|init_opl3
id|module_init
c_func
(paren
id|init_opl3
)paren
suffix:semicolon
DECL|variable|cleanup_opl3
id|module_exit
c_func
(paren
id|cleanup_opl3
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|setup_opl3
r_static
r_int
id|__init
id|setup_opl3
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/* io  */
r_int
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|io
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;opl3=&quot;
comma
id|setup_opl3
)paren
suffix:semicolon
macro_line|#endif
eof
