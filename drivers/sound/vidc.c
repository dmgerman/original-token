multiline_comment|/*&n; *&t;drivers/sound/vidc.c&n; *&n; *&t;Detection routine for the VIDC.&n; *&n; *&t;Copyright (C) 1997 by Russell King &lt;rmk@arm.uk.linux.org&gt;&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;soundmodule.h&quot;
macro_line|#include &quot;vidc.h&quot;
DECL|variable|vidc_busy
r_int
id|vidc_busy
suffix:semicolon
DECL|function|vidc_update_filler
r_void
id|vidc_update_filler
c_func
(paren
r_int
id|format
comma
r_int
id|channels
)paren
(brace
r_int
id|fillertype
suffix:semicolon
DECL|macro|TYPE
mdefine_line|#define TYPE(fmt,ch) (((fmt)&lt;&lt;2) | ((ch)&amp;3))
id|fillertype
op_assign
id|TYPE
c_func
(paren
id|format
comma
id|channels
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fillertype
)paren
(brace
r_default
suffix:colon
r_case
id|TYPE
c_func
(paren
id|AFMT_U8
comma
l_int|1
)paren
suffix:colon
id|vidc_filler
op_assign
id|vidc_fill_1x8_u
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE
c_func
(paren
id|AFMT_U8
comma
l_int|2
)paren
suffix:colon
id|vidc_filler
op_assign
id|vidc_fill_2x8_u
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE
c_func
(paren
id|AFMT_S8
comma
l_int|1
)paren
suffix:colon
id|vidc_filler
op_assign
id|vidc_fill_1x8_s
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE
c_func
(paren
id|AFMT_S8
comma
l_int|2
)paren
suffix:colon
id|vidc_filler
op_assign
id|vidc_fill_2x8_s
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE
c_func
(paren
id|AFMT_S16_LE
comma
l_int|1
)paren
suffix:colon
id|vidc_filler
op_assign
id|vidc_fill_1x16_s
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TYPE
c_func
(paren
id|AFMT_S16_LE
comma
l_int|2
)paren
suffix:colon
id|vidc_filler
op_assign
id|vidc_fill_2x16_s
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|attach_vidc
r_void
id|attach_vidc
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;VIDC %d-bit sound&quot;
comma
id|hw_config-&gt;card_subtype
)paren
suffix:semicolon
id|conf_printf
c_func
(paren
id|name
comma
id|hw_config
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dma_buf
comma
l_int|0
comma
r_sizeof
(paren
id|dma_buf
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dma_buf
(braket
id|i
)braket
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma_buf
(braket
id|i
)braket
)paren
r_goto
id|nomem
suffix:semicolon
id|dma_pbuf
(braket
id|i
)braket
op_assign
id|virt_to_phys
c_func
(paren
id|dma_buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sound_alloc_dma
c_func
(paren
id|hw_config-&gt;dma
comma
l_string|&quot;VIDCsound&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VIDCsound: can&squot;t allocate virtual DMA channel&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hw_config-&gt;irq
comma
id|vidc_sound_dma_irq
comma
l_int|0
comma
l_string|&quot;VIDCsound&quot;
comma
op_amp
id|dma_start
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VIDCsound: can&squot;t allocate DMA interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|//&t;vidc_synth_init(hw_config);
id|vidc_audio_init
c_func
(paren
id|hw_config
)paren
suffix:semicolon
id|vidc_mixer_init
c_func
(paren
id|hw_config
)paren
suffix:semicolon
r_return
suffix:semicolon
id|nomem
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|free_page
c_func
(paren
id|dma_buf
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VIDCsound: can&squot;t allocate required buffers&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|probe_vidc
r_int
id|probe_vidc
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|hw_config-&gt;irq
op_assign
id|IRQ_DMAS0
suffix:semicolon
id|hw_config-&gt;dma
op_assign
id|DMA_VIRTUAL_SOUND
suffix:semicolon
id|hw_config-&gt;dma2
op_assign
op_minus
l_int|1
suffix:semicolon
id|hw_config-&gt;card_subtype
op_assign
l_int|16
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|unload_vidc
r_void
id|unload_vidc
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
id|free_irq
c_func
(paren
id|hw_config-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|sound_free_dma
c_func
(paren
id|hw_config-&gt;dma
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|free_page
c_func
(paren
id|dma_buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|config
r_static
r_struct
id|address_info
id|config
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|probe_vidc
c_func
(paren
op_amp
id|config
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VIDC 16-bit serial sound&bslash;n&quot;
)paren
suffix:semicolon
id|SOUND_LOCK
suffix:semicolon
id|attach_vidc
c_func
(paren
op_amp
id|config
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unload_vidc
c_func
(paren
op_amp
id|config
)paren
suffix:semicolon
id|SOUND_LOCK_END
suffix:semicolon
)brace
macro_line|#endif
eof
