multiline_comment|/*&n; **********************************************************************&n; *     cardwi.c - PCM input HAL for emu10k1 driver&n; *     Copyright 1999, 2000 Creative Labs, Inc.&n; *&n; **********************************************************************&n; *&n; *     Date                 Author          Summary of changes&n; *     ----                 ------          ------------------&n; *     October 20, 1999     Bertrand Lee    base code release&n; *&n; **********************************************************************&n; *&n; *     This program is free software; you can redistribute it and/or&n; *     modify it under the terms of the GNU General Public License as&n; *     published by the Free Software Foundation; either version 2 of&n; *     the License, or (at your option) any later version.&n; *&n; *     This program is distributed in the hope that it will be useful,&n; *     but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *     GNU General Public License for more details.&n; *&n; *     You should have received a copy of the GNU General Public&n; *     License along with this program; if not, write to the Free&n; *     Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139,&n; *     USA.&n; *&n; **********************************************************************&n; */
macro_line|#include &quot;hwaccess.h&quot;
macro_line|#include &quot;recmgr.h&quot;
macro_line|#include &quot;audio.h&quot;
macro_line|#include &quot;cardwi.h&quot;
DECL|function|query_format
r_void
id|query_format
c_func
(paren
r_int
id|recsrc
comma
r_struct
id|wave_format
op_star
id|wave_fmt
)paren
(brace
r_switch
c_cond
(paren
id|recsrc
)paren
(brace
r_case
id|WAVERECORD_AC97
suffix:colon
r_if
c_cond
(paren
(paren
id|wave_fmt-&gt;channels
op_ne
l_int|2
)paren
op_logical_and
(paren
id|wave_fmt-&gt;channels
op_ne
l_int|1
)paren
)paren
id|wave_fmt-&gt;channels
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|wave_fmt-&gt;samplingrate
op_ge
(paren
l_int|0xBB80
op_plus
l_int|0xAC44
)paren
op_div
l_int|2
)paren
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0xBB80
suffix:semicolon
r_else
r_if
c_cond
(paren
id|wave_fmt-&gt;samplingrate
op_ge
(paren
l_int|0xAC44
op_plus
l_int|0x7D00
)paren
op_div
l_int|2
)paren
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0xAC44
suffix:semicolon
r_else
r_if
c_cond
(paren
id|wave_fmt-&gt;samplingrate
op_ge
(paren
l_int|0x7D00
op_plus
l_int|0x5DC0
)paren
op_div
l_int|2
)paren
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0x7D00
suffix:semicolon
r_else
r_if
c_cond
(paren
id|wave_fmt-&gt;samplingrate
op_ge
(paren
l_int|0x5DC0
op_plus
l_int|0x5622
)paren
op_div
l_int|2
)paren
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0x5DC0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|wave_fmt-&gt;samplingrate
op_ge
(paren
l_int|0x5622
op_plus
l_int|0x3E80
)paren
op_div
l_int|2
)paren
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0x5622
suffix:semicolon
r_else
r_if
c_cond
(paren
id|wave_fmt-&gt;samplingrate
op_ge
(paren
l_int|0x3E80
op_plus
l_int|0x2B11
)paren
op_div
l_int|2
)paren
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0x3E80
suffix:semicolon
r_else
r_if
c_cond
(paren
id|wave_fmt-&gt;samplingrate
op_ge
(paren
l_int|0x2B11
op_plus
l_int|0x1F40
)paren
op_div
l_int|2
)paren
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0x2B11
suffix:semicolon
r_else
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0x1F40
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wave_fmt-&gt;bitsperchannel
op_ne
l_int|16
)paren
op_logical_and
(paren
id|wave_fmt-&gt;bitsperchannel
op_ne
l_int|8
)paren
)paren
id|wave_fmt-&gt;bitsperchannel
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAVERECORD_MIC
suffix:colon
id|wave_fmt-&gt;channels
op_assign
l_int|1
suffix:semicolon
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0x1F40
suffix:semicolon
id|wave_fmt-&gt;bitsperchannel
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAVERECORD_FX
suffix:colon
id|wave_fmt-&gt;channels
op_assign
l_int|2
suffix:semicolon
id|wave_fmt-&gt;samplingrate
op_assign
l_int|0xBB80
suffix:semicolon
id|wave_fmt-&gt;bitsperchannel
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|alloc_recbuffer
r_static
r_int
id|alloc_recbuffer
c_func
(paren
r_struct
id|wave_in
op_star
id|wave_in
comma
id|u32
op_star
id|bufsize
comma
id|u8
op_star
op_star
id|buffer
)paren
(brace
id|u32
id|reqsize
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|u32
id|size
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* NOTE: record buffer size only can be certain sizes.  If the requested&n;&t; * size is not a nice size, use the smaller nearest size. The minimum size is 1k. */
r_if
c_cond
(paren
op_logical_neg
id|wave_in-&gt;rec_ptr-&gt;is_16bit
)paren
op_star
id|bufsize
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|bufsize
op_ge
l_int|0x10000
)paren
(brace
op_star
id|bufsize
op_assign
id|reqsize
op_assign
l_int|0x10000
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;bufsize
op_assign
l_int|31
suffix:semicolon
)brace
r_else
(brace
id|reqsize
op_assign
l_int|0
suffix:semicolon
id|size
(braket
l_int|0
)braket
op_assign
l_int|384
suffix:semicolon
id|size
(braket
l_int|1
)braket
op_assign
l_int|448
suffix:semicolon
id|size
(braket
l_int|2
)braket
op_assign
l_int|512
suffix:semicolon
id|size
(braket
l_int|3
)braket
op_assign
l_int|640
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
op_star
id|bufsize
op_ge
id|size
(braket
id|j
)braket
)paren
(brace
id|reqsize
op_assign
id|size
(braket
id|j
)braket
suffix:semicolon
id|size
(braket
id|j
)braket
op_assign
id|size
(braket
id|j
)braket
op_star
l_int|2
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;bufsize
op_assign
id|i
op_star
l_int|4
op_plus
id|j
op_plus
l_int|1
suffix:semicolon
)brace
r_else
r_goto
id|exitloop
suffix:semicolon
id|exitloop
suffix:colon
r_if
c_cond
(paren
id|reqsize
op_eq
l_int|0
)paren
(brace
id|reqsize
op_assign
l_int|384
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;bufsize
op_assign
l_int|1
suffix:semicolon
)brace
op_star
id|bufsize
op_assign
id|reqsize
suffix:semicolon
)brace
id|DPD
c_func
(paren
l_int|2
comma
l_string|&quot;bufsizereg: %x&bslash;n&quot;
comma
id|wave_in-&gt;rec_ptr-&gt;bufsize
)paren
suffix:semicolon
multiline_comment|/* Recording buffer must be continuous and page-aligned */
r_if
c_cond
(paren
(paren
id|wave_in-&gt;memhandle
op_assign
id|emu10k1_alloc_memphysical
c_func
(paren
id|reqsize
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|CTSTATUS_ERROR
suffix:semicolon
id|DPD
c_func
(paren
l_int|2
comma
l_string|&quot;recbufsize: %x&bslash;n&quot;
comma
op_star
id|bufsize
)paren
suffix:semicolon
op_star
id|buffer
op_assign
(paren
id|u8
op_star
)paren
id|wave_in-&gt;memhandle-&gt;virtaddx
suffix:semicolon
r_return
id|CTSTATUS_SUCCESS
suffix:semicolon
)brace
DECL|function|get_recbuffer
r_static
r_int
id|get_recbuffer
c_func
(paren
r_struct
id|emu10k1_card
op_star
id|card
comma
r_struct
id|wave_in
op_star
id|wave_in
comma
id|u32
op_star
id|size
)paren
(brace
id|u8
op_star
id|buffer
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;card
op_assign
id|card
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;recpos
op_assign
l_int|0
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;samplingrate
op_assign
id|wave_in-&gt;wave_fmt.samplingrate
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;is_stereo
op_assign
(paren
id|wave_in-&gt;wave_fmt.channels
op_eq
l_int|2
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;is_16bit
op_assign
(paren
id|wave_in-&gt;wave_fmt.bitsperchannel
op_eq
l_int|16
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Allocate buffer here */
r_if
c_cond
(paren
id|alloc_recbuffer
c_func
(paren
id|wave_in
comma
id|size
comma
op_amp
id|buffer
)paren
op_ne
id|CTSTATUS_SUCCESS
)paren
(brace
id|ERROR
c_func
(paren
)paren
suffix:semicolon
r_return
id|CTSTATUS_ERROR
suffix:semicolon
)brace
multiline_comment|/* recbufsize contains actual record buffer size          */
multiline_comment|/* for 8 bit samples the size is twice the requested      */
multiline_comment|/* value since we only make use of one in every two bytes */
id|wave_in-&gt;rec_ptr-&gt;recbufsize
op_assign
op_star
id|size
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;recbuffer
op_assign
id|buffer
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;busaddx
op_assign
id|wave_in-&gt;memhandle-&gt;busaddx
suffix:semicolon
r_return
id|CTSTATUS_SUCCESS
suffix:semicolon
)brace
DECL|function|dealloc_recbuffer
r_static
r_void
id|dealloc_recbuffer
c_func
(paren
r_struct
id|wave_in
op_star
id|wave_in
)paren
(brace
id|emu10k1_free_memphysical
c_func
(paren
id|wave_in-&gt;memhandle
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|emu10k1_wavein_open
r_int
id|emu10k1_wavein_open
c_func
(paren
r_struct
id|emu10k1_wavedevice
op_star
id|wave_dev
)paren
(brace
r_struct
id|emu10k1_card
op_star
id|card
op_assign
id|wave_dev-&gt;card
suffix:semicolon
r_struct
id|wiinst
op_star
id|wiinst
op_assign
id|wave_dev-&gt;wiinst
suffix:semicolon
r_struct
id|wave_in
op_star
id|wave_in
suffix:semicolon
r_struct
id|wave_in
op_star
op_star
id|wave_in_tmp
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|buffsize
comma
id|bytespersec
comma
id|delay
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_wavein_open()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wave_in
op_assign
(paren
r_struct
id|wave_in
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|wave_in
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
)paren
suffix:semicolon
r_return
id|CTSTATUS_ERROR
suffix:semicolon
)brace
id|wave_in-&gt;state
op_assign
id|CARDWAVE_STATE_STOPPED
suffix:semicolon
id|wave_in-&gt;wave_fmt
op_assign
id|wiinst-&gt;wave_fmt
suffix:semicolon
id|wave_in-&gt;memhandle
op_assign
l_int|NULL
suffix:semicolon
id|wave_in-&gt;timer
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|wiinst-&gt;recsrc
)paren
(brace
r_case
id|WAVERECORD_AC97
suffix:colon
id|wave_in_tmp
op_assign
op_amp
id|card-&gt;wavein-&gt;ac97
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAVERECORD_MIC
suffix:colon
id|wave_in_tmp
op_assign
op_amp
id|card-&gt;wavein-&gt;mic
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAVERECORD_FX
suffix:colon
id|wave_in_tmp
op_assign
op_amp
id|card-&gt;wavein-&gt;fx
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|wave_in_tmp
op_ne
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|wave_in
)paren
suffix:semicolon
r_return
id|CTSTATUS_ERROR
suffix:semicolon
)brace
op_star
id|wave_in_tmp
op_assign
id|wave_in
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|wiinst-&gt;wave_in
op_assign
id|wave_in
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wave_in-&gt;rec_ptr
op_assign
(paren
r_struct
id|record
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|record
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
)paren
suffix:semicolon
id|emu10k1_wavein_close
c_func
(paren
id|wave_dev
)paren
suffix:semicolon
r_return
id|CTSTATUS_ERROR
suffix:semicolon
)brace
id|buffsize
op_assign
id|wiinst-&gt;fragment_size
op_star
id|wiinst-&gt;numfrags
suffix:semicolon
r_if
c_cond
(paren
id|get_recbuffer
c_func
(paren
id|card
comma
id|wave_in
comma
op_amp
id|buffsize
)paren
op_ne
id|CTSTATUS_SUCCESS
)paren
(brace
id|ERROR
c_func
(paren
)paren
suffix:semicolon
id|emu10k1_wavein_close
c_func
(paren
id|wave_dev
)paren
suffix:semicolon
r_return
id|CTSTATUS_ERROR
suffix:semicolon
)brace
id|wiinst-&gt;fragment_size
op_assign
id|buffsize
op_div
id|wiinst-&gt;numfrags
suffix:semicolon
multiline_comment|/* This callback size returned is the size in the play buffer.&n;&t; * For 8-bit samples, callbacksize of user buffer should be&n;&t; * half of the callbacksize in play buffer. */
r_if
c_cond
(paren
id|wave_in-&gt;wave_fmt.bitsperchannel
op_eq
l_int|8
)paren
id|wiinst-&gt;fragment_size
op_rshift_assign
l_int|1
suffix:semicolon
id|wave_in-&gt;callbacksize
op_assign
id|wiinst-&gt;fragment_size
suffix:semicolon
id|emu10k1_set_record_src
c_func
(paren
id|wave_in-&gt;rec_ptr
comma
id|wiinst-&gt;recsrc
)paren
suffix:semicolon
id|bytespersec
op_assign
id|wave_in-&gt;wave_fmt.channels
op_star
(paren
id|wave_in-&gt;wave_fmt.bitsperchannel
op_rshift
l_int|3
)paren
op_star
(paren
id|wave_in-&gt;wave_fmt.samplingrate
)paren
suffix:semicolon
id|delay
op_assign
(paren
l_int|48000
op_star
id|wave_in-&gt;callbacksize
)paren
op_div
id|bytespersec
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wave_in-&gt;timer
op_assign
id|emu10k1_timer_install
c_func
(paren
id|card
comma
id|emu10k1_wavein_bh
comma
(paren
r_int
r_int
)paren
id|wave_dev
comma
id|delay
op_div
l_int|2
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
)paren
suffix:semicolon
id|emu10k1_wavein_close
c_func
(paren
id|wave_dev
)paren
suffix:semicolon
r_return
id|CTSTATUS_ERROR
suffix:semicolon
)brace
r_return
id|CTSTATUS_SUCCESS
suffix:semicolon
)brace
DECL|function|emu10k1_wavein_close
r_void
id|emu10k1_wavein_close
c_func
(paren
r_struct
id|emu10k1_wavedevice
op_star
id|wave_dev
)paren
(brace
r_struct
id|emu10k1_card
op_star
id|card
op_assign
id|wave_dev-&gt;card
suffix:semicolon
r_struct
id|wave_in
op_star
id|wave_in
op_assign
id|wave_dev-&gt;wiinst-&gt;wave_in
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|wave_in-&gt;state
op_ne
id|CARDWAVE_STATE_STOPPED
)paren
id|emu10k1_wavein_stop
c_func
(paren
id|wave_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wave_in-&gt;timer
op_ne
l_int|NULL
)paren
id|emu10k1_timer_uninstall
c_func
(paren
id|card
comma
id|wave_in-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wave_in-&gt;memhandle
op_ne
l_int|NULL
)paren
id|dealloc_recbuffer
c_func
(paren
id|wave_in
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wave_in-&gt;rec_ptr
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|wave_in-&gt;rec_ptr
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|wave_dev-&gt;wiinst-&gt;recsrc
)paren
(brace
r_case
id|WAVERECORD_AC97
suffix:colon
id|card-&gt;wavein-&gt;ac97
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAVERECORD_MIC
suffix:colon
id|card-&gt;wavein-&gt;mic
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAVERECORD_FX
suffix:colon
id|card-&gt;wavein-&gt;fx
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|wave_in
)paren
suffix:semicolon
id|wave_dev-&gt;wiinst-&gt;wave_in
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|emu10k1_wavein_start
r_void
id|emu10k1_wavein_start
c_func
(paren
r_struct
id|emu10k1_wavedevice
op_star
id|wave_dev
)paren
(brace
r_struct
id|wave_in
op_star
id|wave_in
op_assign
id|wave_dev-&gt;wiinst-&gt;wave_in
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_wavein_start()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wave_in-&gt;state
op_eq
id|CARDWAVE_STATE_STARTED
)paren
r_return
suffix:semicolon
id|emu10k1_start_record
c_func
(paren
id|wave_in-&gt;rec_ptr
)paren
suffix:semicolon
id|wave_in-&gt;state
op_assign
id|CARDWAVE_STATE_STARTED
suffix:semicolon
id|emu10k1_timer_enable
c_func
(paren
id|wave_dev-&gt;card
comma
id|wave_in-&gt;timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|emu10k1_wavein_stop
r_void
id|emu10k1_wavein_stop
c_func
(paren
r_struct
id|emu10k1_wavedevice
op_star
id|wave_dev
)paren
(brace
r_struct
id|wave_in
op_star
id|wave_in
op_assign
id|wave_dev-&gt;wiinst-&gt;wave_in
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_wavein_stop()&bslash;n&quot;
)paren
suffix:semicolon
id|emu10k1_stop_record
c_func
(paren
id|wave_in-&gt;rec_ptr
)paren
suffix:semicolon
id|emu10k1_timer_disable
c_func
(paren
id|wave_dev-&gt;card
comma
id|wave_in-&gt;timer
)paren
suffix:semicolon
id|wave_in-&gt;rec_ptr-&gt;recpos
op_assign
l_int|0
suffix:semicolon
id|wave_in-&gt;state
op_assign
id|CARDWAVE_STATE_STOPPED
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|emu10k1_wavein_setformat
r_int
id|emu10k1_wavein_setformat
c_func
(paren
r_struct
id|emu10k1_wavedevice
op_star
id|wave_dev
)paren
(brace
r_struct
id|emu10k1_card
op_star
id|card
op_assign
id|wave_dev-&gt;card
suffix:semicolon
r_struct
id|wiinst
op_star
id|wiinst
op_assign
id|wave_dev-&gt;wiinst
suffix:semicolon
r_struct
id|wave_in
op_star
id|wave_in
op_assign
id|wiinst-&gt;wave_in
suffix:semicolon
id|u32
id|bytespersec
comma
id|delay
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_wavein_setformat()&bslash;n&quot;
)paren
suffix:semicolon
id|query_format
c_func
(paren
id|wiinst-&gt;recsrc
comma
op_amp
id|wiinst-&gt;wave_fmt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wave_in
)paren
r_return
id|CTSTATUS_SUCCESS
suffix:semicolon
r_if
c_cond
(paren
id|wave_in-&gt;state
op_eq
id|CARDWAVE_STATE_STARTED
)paren
(brace
id|wiinst-&gt;wave_fmt
op_assign
id|wave_in-&gt;wave_fmt
suffix:semicolon
r_return
id|CTSTATUS_SUCCESS
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|wave_in-&gt;wave_fmt.samplingrate
op_ne
id|wiinst-&gt;wave_fmt.samplingrate
)paren
op_logical_or
(paren
id|wave_in-&gt;wave_fmt.bitsperchannel
op_ne
id|wiinst-&gt;wave_fmt.bitsperchannel
)paren
op_logical_or
(paren
id|wave_in-&gt;wave_fmt.channels
op_ne
id|wiinst-&gt;wave_fmt.channels
)paren
)paren
(brace
id|emu10k1_timer_uninstall
c_func
(paren
id|card
comma
id|wave_in-&gt;timer
)paren
suffix:semicolon
id|wave_in-&gt;wave_fmt
op_assign
id|wiinst-&gt;wave_fmt
suffix:semicolon
id|bytespersec
op_assign
id|wave_in-&gt;wave_fmt.channels
op_star
(paren
id|wave_in-&gt;wave_fmt.bitsperchannel
op_rshift
l_int|3
)paren
op_star
(paren
id|wave_in-&gt;wave_fmt.samplingrate
)paren
suffix:semicolon
id|delay
op_assign
(paren
l_int|48000
op_star
id|wave_in-&gt;callbacksize
)paren
op_div
id|bytespersec
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wave_in-&gt;timer
op_assign
id|emu10k1_timer_install
c_func
(paren
id|card
comma
id|emu10k1_wavein_bh
comma
(paren
r_int
r_int
)paren
id|wave_dev
comma
id|delay
op_div
l_int|2
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
)paren
suffix:semicolon
id|emu10k1_wavein_close
c_func
(paren
id|wave_dev
)paren
suffix:semicolon
r_return
id|CTSTATUS_ERROR
suffix:semicolon
)brace
)brace
r_return
id|CTSTATUS_SUCCESS
suffix:semicolon
)brace
DECL|function|emu10k1_wavein_getxfersize
r_void
id|emu10k1_wavein_getxfersize
c_func
(paren
r_struct
id|wave_in
op_star
id|wave_in
comma
id|u32
op_star
id|size
comma
id|u32
op_star
id|curpos
)paren
(brace
r_struct
id|record
op_star
id|rec_ptr
op_assign
id|wave_in-&gt;rec_ptr
suffix:semicolon
multiline_comment|/* Get position of current address, this is in no. of bytes in play buffer */
id|emu10k1_wavein_getcontrol
c_func
(paren
id|wave_in
comma
id|WAVECURPOS
comma
id|curpos
)paren
suffix:semicolon
op_star
id|size
op_assign
op_star
id|curpos
op_minus
id|rec_ptr-&gt;recpos
suffix:semicolon
multiline_comment|/* Recpos is the actual position in user buffer and play buffer */
r_if
c_cond
(paren
op_star
id|curpos
OL
id|rec_ptr-&gt;recpos
)paren
op_star
id|size
op_add_assign
id|rec_ptr-&gt;recbufsize
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rec_ptr-&gt;is_16bit
)paren
op_star
id|size
op_rshift_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|copy_s16_to_u8
r_static
r_void
id|copy_s16_to_u8
c_func
(paren
id|u8
op_star
id|dstbuf
comma
id|s16
op_star
id|srcbuf
comma
id|u32
id|size
)paren
(brace
id|u16
id|sample
suffix:semicolon
id|u8
id|byte
suffix:semicolon
r_while
c_loop
(paren
id|size
op_decrement
)paren
(brace
id|sample
op_assign
(paren
op_star
id|srcbuf
)paren
op_plus
l_int|32767
suffix:semicolon
id|byte
op_assign
(paren
id|u8
)paren
(paren
id|sample
op_rshift
l_int|8
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|dstbuf
comma
op_amp
id|byte
comma
l_int|1
)paren
suffix:semicolon
id|dstbuf
op_increment
suffix:semicolon
id|srcbuf
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* transfer the data from the wave device.                    */
DECL|function|emu10k1_wavein_xferdata
r_void
id|emu10k1_wavein_xferdata
c_func
(paren
r_struct
id|wiinst
op_star
id|wiinst
comma
id|u8
op_star
id|data
comma
id|u32
op_star
id|size
)paren
(brace
r_struct
id|wave_in
op_star
id|wave_in
op_assign
id|wiinst-&gt;wave_in
suffix:semicolon
r_struct
id|record
op_star
id|rec_ptr
op_assign
id|wave_in-&gt;rec_ptr
suffix:semicolon
id|u32
id|sizetocopy
comma
id|sizetocopy_now
comma
id|start
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|sizetocopy
op_assign
id|min
c_func
(paren
id|rec_ptr-&gt;recbufsize
op_star
(paren
id|rec_ptr-&gt;is_16bit
op_plus
l_int|1
)paren
op_div
l_int|2
comma
op_star
id|size
)paren
suffix:semicolon
op_star
id|size
op_assign
id|sizetocopy
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sizetocopy
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|wiinst-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|sizetocopy_now
op_assign
(paren
id|rec_ptr-&gt;recbufsize
op_minus
id|rec_ptr-&gt;recpos
)paren
op_star
(paren
id|rec_ptr-&gt;is_16bit
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|start
op_assign
id|rec_ptr-&gt;recpos
suffix:semicolon
r_if
c_cond
(paren
id|sizetocopy
OG
id|sizetocopy_now
)paren
(brace
id|sizetocopy
op_sub_assign
id|sizetocopy_now
suffix:semicolon
id|rec_ptr-&gt;recpos
op_assign
id|sizetocopy
op_star
l_int|2
op_div
(paren
id|rec_ptr-&gt;is_16bit
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|wiinst-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec_ptr-&gt;is_16bit
)paren
(brace
id|copy_to_user
c_func
(paren
id|data
comma
id|rec_ptr-&gt;recbuffer
op_plus
id|start
comma
id|sizetocopy_now
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|data
op_plus
id|sizetocopy_now
comma
id|rec_ptr-&gt;recbuffer
comma
id|sizetocopy
)paren
suffix:semicolon
)brace
r_else
(brace
id|copy_s16_to_u8
c_func
(paren
id|data
comma
(paren
id|s16
op_star
)paren
(paren
id|rec_ptr-&gt;recbuffer
op_plus
id|start
)paren
comma
id|sizetocopy_now
)paren
suffix:semicolon
id|copy_s16_to_u8
c_func
(paren
id|data
op_plus
id|sizetocopy_now
comma
(paren
id|s16
op_star
)paren
id|rec_ptr-&gt;recbuffer
comma
id|sizetocopy
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|sizetocopy
op_eq
id|sizetocopy_now
)paren
id|rec_ptr-&gt;recpos
op_assign
l_int|0
suffix:semicolon
r_else
id|rec_ptr-&gt;recpos
op_add_assign
id|sizetocopy
op_star
l_int|2
op_div
(paren
id|rec_ptr-&gt;is_16bit
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|wiinst-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec_ptr-&gt;is_16bit
)paren
id|copy_to_user
c_func
(paren
id|data
comma
id|rec_ptr-&gt;recbuffer
op_plus
id|start
comma
id|sizetocopy
)paren
suffix:semicolon
r_else
id|copy_s16_to_u8
c_func
(paren
id|data
comma
(paren
id|s16
op_star
)paren
(paren
id|rec_ptr-&gt;recbuffer
op_plus
id|start
)paren
comma
id|sizetocopy
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* get the specified control value of the wave device. */
DECL|function|emu10k1_wavein_getcontrol
r_int
id|emu10k1_wavein_getcontrol
c_func
(paren
r_struct
id|wave_in
op_star
id|wave_in
comma
id|u32
id|ctrlid
comma
id|u32
op_star
id|value
)paren
(brace
r_switch
c_cond
(paren
id|ctrlid
)paren
(brace
r_case
id|WAVECURPOS
suffix:colon
multiline_comment|/* There is no actual start yet */
r_if
c_cond
(paren
id|wave_in-&gt;state
op_eq
id|CARDWAVE_STATE_STOPPED
)paren
(brace
op_star
id|value
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* value is in byte units */
op_star
id|value
op_assign
id|sblive_readptr
c_func
(paren
id|wave_in-&gt;rec_ptr-&gt;card
comma
id|wave_in-&gt;rec_ptr-&gt;bufidxreg
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|CTSTATUS_ERROR
suffix:semicolon
)brace
r_return
id|CTSTATUS_SUCCESS
suffix:semicolon
)brace
eof
