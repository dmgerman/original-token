multiline_comment|/*&n; **********************************************************************&n; *     sblive_mi.c - MIDI UART input HAL for emu10k1 driver&n; *     Copyright 1999, 2000 Creative Labs, Inc.&n; *&n; **********************************************************************&n; *&n; *     Date                 Author          Summary of changes&n; *     ----                 ------          ------------------&n; *     October 20, 1999     Bertrand Lee    base code release&n; *     November 2, 1999     Alan Cox        clean up&n; *&n; **********************************************************************&n; *&n; *     This program is free software; you can redistribute it and/or&n; *     modify it under the terms of the GNU General Public License as&n; *     published by the Free Software Foundation; either version 2 of&n; *     the License, or (at your option) any later version.&n; *&n; *     This program is distributed in the hope that it will be useful,&n; *     but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *     GNU General Public License for more details.&n; *&n; *     You should have received a copy of the GNU General Public&n; *     License along with this program; if not, write to the Free&n; *     Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139,&n; *     USA.&n; *&n; **********************************************************************&n; */
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &quot;hwaccess.h&quot;
macro_line|#include &quot;8010.h&quot;
macro_line|#include &quot;cardmi.h&quot;
macro_line|#include &quot;irqmgr.h&quot;
r_static
r_struct
(brace
DECL|member|Fn
r_int
(paren
op_star
id|Fn
)paren
(paren
r_struct
id|emu10k1_mpuin
op_star
comma
id|u8
)paren
suffix:semicolon
DECL|variable|midistatefn
)brace
id|midistatefn
(braket
)braket
op_assign
(brace
(brace
id|sblive_miStateParse
)brace
comma
(brace
id|sblive_miState3Byte
)brace
comma
multiline_comment|/* 0x8n, 0x9n, 0xAn, 0xBn, 0xEn */
(brace
id|sblive_miState3ByteKey
)brace
comma
multiline_comment|/* Byte 1                       */
(brace
id|sblive_miState3ByteVel
)brace
comma
multiline_comment|/* Byte 2                       */
(brace
id|sblive_miState2Byte
)brace
comma
multiline_comment|/* 0xCn, 0xDn                   */
(brace
id|sblive_miState2ByteKey
)brace
comma
multiline_comment|/* Byte 1                       */
(brace
id|sblive_miStateSysCommon2
)brace
comma
multiline_comment|/* 0xF1 , 0xF3                  */
(brace
id|sblive_miStateSysCommon2Key
)brace
comma
multiline_comment|/* 0xF1 , 0xF3, Byte 1          */
(brace
id|sblive_miStateSysCommon3
)brace
comma
multiline_comment|/* 0xF2                         */
(brace
id|sblive_miStateSysCommon3Key
)brace
comma
multiline_comment|/* 0xF2 , Byte 1                */
(brace
id|sblive_miStateSysCommon3Vel
)brace
comma
multiline_comment|/* 0xF2 , Byte 2                */
(brace
id|sblive_miStateSysExNorm
)brace
comma
multiline_comment|/* 0xF0, 0xF7, Normal mode      */
(brace
id|sblive_miStateSysReal
)brace
multiline_comment|/* 0xF4 - 0xF6 ,0xF8 - 0xFF     */
)brace
suffix:semicolon
multiline_comment|/* Installs the IRQ handler for the MPU in port                 */
multiline_comment|/* and initialize parameters                                    */
DECL|function|emu10k1_mpuin_open
r_int
id|emu10k1_mpuin_open
c_func
(paren
r_struct
id|emu10k1_card
op_star
id|card
comma
r_struct
id|midi_openinfo
op_star
id|openinfo
)paren
(brace
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
op_assign
id|card-&gt;mpuin
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_mpuin_open&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|card_mpuin-&gt;status
op_amp
id|FLAGS_AVAILABLE
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Copy open info and mark channel as in use */
id|card_mpuin-&gt;openinfo
op_assign
op_star
id|openinfo
suffix:semicolon
id|card_mpuin-&gt;status
op_and_assign
op_complement
id|FLAGS_AVAILABLE
suffix:semicolon
multiline_comment|/* clear */
id|card_mpuin-&gt;status
op_or_assign
id|FLAGS_READY
suffix:semicolon
multiline_comment|/* set */
id|card_mpuin-&gt;status
op_and_assign
op_complement
id|FLAGS_MIDM_STARTED
suffix:semicolon
multiline_comment|/* clear */
id|card_mpuin-&gt;firstmidiq
op_assign
l_int|NULL
suffix:semicolon
id|card_mpuin-&gt;lastmidiq
op_assign
l_int|NULL
suffix:semicolon
id|card_mpuin-&gt;qhead
op_assign
l_int|0
suffix:semicolon
id|card_mpuin-&gt;qtail
op_assign
l_int|0
suffix:semicolon
id|sblive_miStateInit
c_func
(paren
id|card_mpuin
)paren
suffix:semicolon
id|emu10k1_mpu_reset
c_func
(paren
id|card
)paren
suffix:semicolon
id|emu10k1_mpu_acquire
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emu10k1_mpuin_close
r_int
id|emu10k1_mpuin_close
c_func
(paren
r_struct
id|emu10k1_card
op_star
id|card
)paren
(brace
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
op_assign
id|card-&gt;mpuin
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_mpuin_close()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check if there are pending input SysEx buffers */
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
op_ne
l_int|NULL
)paren
(brace
id|ERROR
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Disable RX interrupt */
id|emu10k1_irq_disable
c_func
(paren
id|card
comma
id|INTE_MIDIRXENABLE
)paren
suffix:semicolon
id|emu10k1_mpu_release
c_func
(paren
id|card
)paren
suffix:semicolon
id|card_mpuin-&gt;status
op_or_assign
id|FLAGS_AVAILABLE
suffix:semicolon
multiline_comment|/* set */
id|card_mpuin-&gt;status
op_and_assign
op_complement
id|FLAGS_MIDM_STARTED
suffix:semicolon
multiline_comment|/* clear */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Adds MIDI buffer to local queue list                         */
DECL|function|emu10k1_mpuin_add_buffer
r_int
id|emu10k1_mpuin_add_buffer
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
r_struct
id|midi_hdr
op_star
id|midihdr
)paren
(brace
r_struct
id|midi_queue
op_star
id|midiq
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_mpuin_add_buffer()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Update MIDI buffer flags */
id|midihdr-&gt;flags
op_or_assign
id|MIDIBUF_INQUEUE
suffix:semicolon
multiline_comment|/* set */
id|midihdr-&gt;flags
op_and_assign
op_complement
id|MIDIBUF_DONE
suffix:semicolon
multiline_comment|/* clear */
r_if
c_cond
(paren
(paren
id|midiq
op_assign
(paren
r_struct
id|midi_queue
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|midi_queue
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Message lost */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|midiq-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|midiq-&gt;qtype
op_assign
l_int|1
suffix:semicolon
id|midiq-&gt;length
op_assign
id|midihdr-&gt;bufferlength
suffix:semicolon
id|midiq-&gt;sizeLeft
op_assign
id|midihdr-&gt;bufferlength
suffix:semicolon
id|midiq-&gt;midibyte
op_assign
id|midihdr-&gt;data
suffix:semicolon
id|midiq-&gt;refdata
op_assign
(paren
r_int
r_int
)paren
id|midihdr
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
op_eq
l_int|NULL
)paren
(brace
id|card_mpuin-&gt;firstmidiq
op_assign
id|midiq
suffix:semicolon
id|card_mpuin-&gt;lastmidiq
op_assign
id|midiq
suffix:semicolon
)brace
r_else
(brace
(paren
id|card_mpuin-&gt;lastmidiq
)paren
op_member_access_from_pointer
id|next
op_assign
id|midiq
suffix:semicolon
id|card_mpuin-&gt;lastmidiq
op_assign
id|midiq
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* First set the Time Stamp if MIDI IN has not started.         */
multiline_comment|/* Then enable RX Irq.                                          */
DECL|function|emu10k1_mpuin_start
r_int
id|emu10k1_mpuin_start
c_func
(paren
r_struct
id|emu10k1_card
op_star
id|card
)paren
(brace
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
op_assign
id|card-&gt;mpuin
suffix:semicolon
id|u8
id|dummy
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_mpuin_start()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Set timestamp if not set */
r_if
c_cond
(paren
id|card_mpuin-&gt;status
op_amp
id|FLAGS_MIDM_STARTED
)paren
(brace
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;Time Stamp not changed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
op_logical_neg
id|emu10k1_mpu_read_data
c_func
(paren
id|card
comma
op_amp
id|dummy
)paren
)paren
suffix:semicolon
id|card_mpuin-&gt;status
op_or_assign
id|FLAGS_MIDM_STARTED
suffix:semicolon
multiline_comment|/* set */
multiline_comment|/* Set new time stamp */
id|card_mpuin-&gt;timestart
op_assign
(paren
id|jiffies
op_star
l_int|1000
)paren
op_div
id|HZ
suffix:semicolon
id|DPD
c_func
(paren
l_int|2
comma
l_string|&quot;New Time Stamp = %d&bslash;n&quot;
comma
id|card_mpuin-&gt;timestart
)paren
suffix:semicolon
id|card_mpuin-&gt;qhead
op_assign
l_int|0
suffix:semicolon
id|card_mpuin-&gt;qtail
op_assign
l_int|0
suffix:semicolon
id|emu10k1_irq_enable
c_func
(paren
id|card
comma
id|INTE_MIDIRXENABLE
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Disable the RX Irq.  If a partial recorded buffer            */
multiline_comment|/* exist, send it up to IMIDI level.                            */
DECL|function|emu10k1_mpuin_stop
r_int
id|emu10k1_mpuin_stop
c_func
(paren
r_struct
id|emu10k1_card
op_star
id|card
)paren
(brace
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
op_assign
id|card-&gt;mpuin
suffix:semicolon
r_struct
id|midi_queue
op_star
id|midiq
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_mpuin_stop()&bslash;n&quot;
)paren
suffix:semicolon
id|emu10k1_irq_disable
c_func
(paren
id|card
comma
id|INTE_MIDIRXENABLE
)paren
suffix:semicolon
id|card_mpuin-&gt;status
op_and_assign
op_complement
id|FLAGS_MIDM_STARTED
suffix:semicolon
multiline_comment|/* clear */
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|midiq
op_assign
id|card_mpuin-&gt;firstmidiq
suffix:semicolon
r_if
c_cond
(paren
id|midiq
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|midiq-&gt;sizeLeft
op_eq
id|midiq-&gt;length
)paren
id|midiq
op_assign
l_int|NULL
suffix:semicolon
r_else
(brace
id|card_mpuin-&gt;firstmidiq
op_assign
id|midiq-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
op_eq
l_int|NULL
)paren
id|card_mpuin-&gt;lastmidiq
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|midiq
)paren
(brace
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INLONGERROR
comma
(paren
r_int
r_int
)paren
id|midiq
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|midiq
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Disable the RX Irq.  If any buffer                           */
multiline_comment|/* exist, send it up to IMIDI level.                            */
DECL|function|emu10k1_mpuin_reset
r_int
id|emu10k1_mpuin_reset
c_func
(paren
r_struct
id|emu10k1_card
op_star
id|card
)paren
(brace
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
op_assign
id|card-&gt;mpuin
suffix:semicolon
r_struct
id|midi_queue
op_star
id|midiq
suffix:semicolon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_mpuin_reset()&bslash;n&quot;
)paren
suffix:semicolon
id|emu10k1_irq_disable
c_func
(paren
id|card
comma
id|INTE_MIDIRXENABLE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|card_mpuin-&gt;firstmidiq
)paren
(brace
id|midiq
op_assign
id|card_mpuin-&gt;firstmidiq
suffix:semicolon
id|card_mpuin-&gt;firstmidiq
op_assign
id|midiq-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|midiq-&gt;sizeLeft
op_eq
id|midiq-&gt;length
)paren
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INLONGDATA
comma
(paren
r_int
r_int
)paren
id|midiq
comma
l_int|0
)paren
suffix:semicolon
r_else
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INLONGERROR
comma
(paren
r_int
r_int
)paren
id|midiq
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|midiq
)paren
suffix:semicolon
)brace
id|card_mpuin-&gt;lastmidiq
op_assign
l_int|NULL
suffix:semicolon
id|card_mpuin-&gt;status
op_and_assign
op_complement
id|FLAGS_MIDM_STARTED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Passes the message with the data back to the client          */
multiline_comment|/* via IRQ &amp; DPC callbacks to Ring 3                            */
DECL|function|emu10k1_mpuin_callback
r_int
id|emu10k1_mpuin_callback
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u32
id|msg
comma
r_int
r_int
id|data
comma
id|u32
id|bytesvalid
)paren
(brace
r_int
r_int
id|timein
suffix:semicolon
r_struct
id|midi_queue
op_star
id|midiq
suffix:semicolon
r_int
r_int
id|callback_msg
(braket
l_int|3
)braket
suffix:semicolon
r_struct
id|midi_hdr
op_star
id|midihdr
suffix:semicolon
multiline_comment|/* Called during ISR. The data &amp; code touched are:&n;&t; * 1. card_mpuin&n;&t; * 2. The function to be called&n;&t; */
id|timein
op_assign
id|card_mpuin-&gt;timein
suffix:semicolon
r_if
c_cond
(paren
id|card_mpuin-&gt;timestart
op_le
id|timein
)paren
id|callback_msg
(braket
l_int|0
)braket
op_assign
id|timein
op_minus
id|card_mpuin-&gt;timestart
suffix:semicolon
r_else
id|callback_msg
(braket
l_int|0
)braket
op_assign
(paren
op_complement
l_int|0x0L
op_minus
id|card_mpuin-&gt;timestart
)paren
op_plus
id|timein
suffix:semicolon
r_if
c_cond
(paren
id|msg
op_eq
id|ICARDMIDI_INDATA
op_logical_or
id|msg
op_eq
id|ICARDMIDI_INDATAERROR
)paren
(brace
id|callback_msg
(braket
l_int|1
)braket
op_assign
id|data
suffix:semicolon
id|callback_msg
(braket
l_int|2
)braket
op_assign
id|bytesvalid
suffix:semicolon
id|DPD
c_func
(paren
l_int|2
comma
l_string|&quot;emu10k1_mpuin_callback: midimsg = %lx&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
)brace
r_else
(brace
id|midiq
op_assign
(paren
r_struct
id|midi_queue
op_star
)paren
id|data
suffix:semicolon
id|midihdr
op_assign
(paren
r_struct
id|midi_hdr
op_star
)paren
id|midiq-&gt;refdata
suffix:semicolon
id|callback_msg
(braket
l_int|1
)braket
op_assign
id|midiq-&gt;length
op_minus
id|midiq-&gt;sizeLeft
suffix:semicolon
id|callback_msg
(braket
l_int|2
)braket
op_assign
id|midiq-&gt;refdata
suffix:semicolon
id|midihdr-&gt;flags
op_and_assign
op_complement
id|MIDIBUF_INQUEUE
suffix:semicolon
id|midihdr-&gt;flags
op_or_assign
id|MIDIBUF_DONE
suffix:semicolon
id|midihdr-&gt;bytesrecorded
op_assign
id|midiq-&gt;length
op_minus
id|midiq-&gt;sizeLeft
suffix:semicolon
)brace
multiline_comment|/* Notify client that Sysex buffer has been sent */
id|emu10k1_midi_callback
c_func
(paren
id|msg
comma
id|card_mpuin-&gt;openinfo.refdata
comma
id|callback_msg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emu10k1_mpuin_bh
r_void
id|emu10k1_mpuin_bh
c_func
(paren
r_int
r_int
id|refdata
)paren
(brace
id|u8
id|data
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
op_assign
(paren
r_struct
id|emu10k1_mpuin
op_star
)paren
id|refdata
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_while
c_loop
(paren
id|card_mpuin-&gt;qhead
op_ne
id|card_mpuin-&gt;qtail
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|idx
op_assign
id|card_mpuin-&gt;qhead
suffix:semicolon
id|data
op_assign
id|card_mpuin-&gt;midiq
(braket
id|idx
)braket
dot
id|data
suffix:semicolon
id|card_mpuin-&gt;timein
op_assign
id|card_mpuin-&gt;midiq
(braket
id|idx
)braket
dot
id|timein
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|MIDIIN_MAX_BUFFER_SIZE
suffix:semicolon
id|card_mpuin-&gt;qhead
op_assign
id|idx
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|sblive_miStateEntry
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* IRQ callback handler routine for the MPU in port */
DECL|function|emu10k1_mpuin_irqhandler
r_int
id|emu10k1_mpuin_irqhandler
c_func
(paren
r_struct
id|emu10k1_card
op_star
id|card
)paren
(brace
r_int
id|idx
suffix:semicolon
r_int
id|count
suffix:semicolon
id|u8
id|MPUIvalue
suffix:semicolon
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
op_assign
id|card-&gt;mpuin
suffix:semicolon
multiline_comment|/* IRQ service routine. The data and code touched are:&n;&t; * 1. card_mpuin&n;&t; */
id|count
op_assign
l_int|0
suffix:semicolon
id|idx
op_assign
id|card_mpuin-&gt;qtail
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|emu10k1_mpu_read_data
c_func
(paren
id|card
comma
op_amp
id|MPUIvalue
)paren
OL
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_else
(brace
op_increment
id|count
suffix:semicolon
id|card_mpuin-&gt;midiq
(braket
id|idx
)braket
dot
id|data
op_assign
id|MPUIvalue
suffix:semicolon
id|card_mpuin-&gt;midiq
(braket
id|idx
)braket
dot
id|timein
op_assign
(paren
id|jiffies
op_star
l_int|1000
)paren
op_div
id|HZ
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|MIDIIN_MAX_BUFFER_SIZE
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|count
)paren
(brace
id|card_mpuin-&gt;qtail
op_assign
id|idx
suffix:semicolon
id|tasklet_hi_schedule
c_func
(paren
op_amp
id|card_mpuin-&gt;tasklet
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*   Supporting functions for Midi-In Interpretation State Machine           */
multiline_comment|/*****************************************************************************/
multiline_comment|/* FIXME: This should be a macro */
DECL|function|sblive_miStateInit
r_int
id|sblive_miStateInit
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
)paren
(brace
id|card_mpuin-&gt;status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* For MIDI running status */
id|card_mpuin-&gt;fstatus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* For 0xFn status only */
id|card_mpuin-&gt;curstate
op_assign
id|STIN_PARSE
suffix:semicolon
id|card_mpuin-&gt;laststate
op_assign
id|STIN_PARSE
suffix:semicolon
id|card_mpuin-&gt;data
op_assign
l_int|0
suffix:semicolon
id|card_mpuin-&gt;timestart
op_assign
l_int|0
suffix:semicolon
id|card_mpuin-&gt;timein
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* FIXME: This should be a macro */
DECL|function|sblive_miStateEntry
r_int
id|sblive_miStateEntry
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
(brace
r_return
id|midistatefn
(braket
id|card_mpuin-&gt;curstate
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|sblive_miStateParse
r_int
id|sblive_miStateParse
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
(brace
r_switch
c_cond
(paren
id|data
op_amp
l_int|0xf0
)paren
(brace
r_case
l_int|0x80
suffix:colon
r_case
l_int|0x90
suffix:colon
r_case
l_int|0xA0
suffix:colon
r_case
l_int|0xB0
suffix:colon
r_case
l_int|0xE0
suffix:colon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_3BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xC0
suffix:colon
r_case
l_int|0xD0
suffix:colon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_2BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xF0
suffix:colon
multiline_comment|/* System messages do not affect the previous running status! */
r_switch
c_cond
(paren
id|data
op_amp
l_int|0x0f
)paren
(brace
r_case
l_int|0x0
suffix:colon
id|card_mpuin-&gt;laststate
op_assign
id|card_mpuin-&gt;curstate
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_SYS_EX_NORM
suffix:semicolon
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
)paren
(brace
r_struct
id|midi_queue
op_star
id|midiq
suffix:semicolon
id|midiq
op_assign
id|card_mpuin-&gt;firstmidiq
suffix:semicolon
op_star
id|midiq-&gt;midibyte
op_assign
id|data
suffix:semicolon
op_decrement
id|midiq-&gt;sizeLeft
suffix:semicolon
op_increment
id|midiq-&gt;midibyte
suffix:semicolon
)brace
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
r_case
l_int|0x7
suffix:colon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATAERROR
comma
l_int|0xf7
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
r_case
l_int|0x2
suffix:colon
id|card_mpuin-&gt;laststate
op_assign
id|card_mpuin-&gt;curstate
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_SYS_COMMON_3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1
suffix:colon
r_case
l_int|0x3
suffix:colon
id|card_mpuin-&gt;laststate
op_assign
id|card_mpuin-&gt;curstate
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_SYS_COMMON_2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* includes 0xF4 - 0xF6, 0xF8 - 0xFF */
r_return
id|midistatefn
(braket
id|STIN_SYS_REAL
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;BUG: default case hit&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|midistatefn
(braket
id|card_mpuin-&gt;curstate
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|sblive_miState3Byte
r_int
id|sblive_miState3Byte
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
(brace
id|u8
id|temp
op_assign
id|data
op_amp
l_int|0xf0
suffix:semicolon
r_if
c_cond
(paren
id|temp
OL
l_int|0x80
)paren
(brace
r_return
id|midistatefn
(braket
id|STIN_3BYTE_KEY
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|temp
op_le
l_int|0xe0
op_logical_and
id|temp
op_ne
l_int|0xc0
op_logical_and
id|temp
op_ne
l_int|0xd0
)paren
(brace
id|card_mpuin-&gt;status
op_assign
id|data
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_3BYTE_KEY
suffix:semicolon
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
)brace
r_return
id|midistatefn
(braket
id|STIN_PARSE
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|sblive_miState3ByteKey
r_int
id|sblive_miState3ByteKey
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
multiline_comment|/* byte 1 */
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|data
OG
l_int|0x7f
)paren
(brace
multiline_comment|/* Real-time messages check */
r_if
c_cond
(paren
id|data
OG
l_int|0xf7
)paren
r_return
id|midistatefn
(braket
id|STIN_SYS_REAL
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Invalid data! */
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;Invalid data!&bslash;n&quot;
)paren
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_PARSE
suffix:semicolon
id|tmp
op_assign
(paren
(paren
r_int
r_int
)paren
id|data
)paren
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;status
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATAERROR
comma
id|tmp
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card_mpuin-&gt;data
op_assign
id|data
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_3BYTE_VEL
suffix:semicolon
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
)brace
DECL|function|sblive_miState3ByteVel
r_int
id|sblive_miState3ByteVel
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
multiline_comment|/* byte 2 */
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|data
OG
l_int|0x7f
)paren
(brace
multiline_comment|/* Real-time messages check */
r_if
c_cond
(paren
id|data
OG
l_int|0xf7
)paren
r_return
id|midistatefn
(braket
id|STIN_SYS_REAL
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Invalid data! */
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;Invalid data!&bslash;n&quot;
)paren
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_PARSE
suffix:semicolon
id|tmp
op_assign
(paren
(paren
r_int
r_int
)paren
id|data
)paren
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
id|card_mpuin-&gt;data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;status
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATAERROR
comma
id|tmp
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card_mpuin-&gt;curstate
op_assign
id|STIN_3BYTE
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;status
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATA
comma
id|tmp
comma
l_int|3
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sblive_miState2Byte
r_int
id|sblive_miState2Byte
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
(brace
id|u8
id|temp
op_assign
id|data
op_amp
l_int|0xf0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_eq
l_int|0xc0
)paren
op_logical_or
(paren
id|temp
op_eq
l_int|0xd0
)paren
)paren
(brace
id|card_mpuin-&gt;status
op_assign
id|data
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_2BYTE_KEY
suffix:semicolon
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|temp
OL
l_int|0x80
)paren
r_return
id|midistatefn
(braket
id|STIN_2BYTE_KEY
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
r_return
id|midistatefn
(braket
id|STIN_PARSE
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|sblive_miState2ByteKey
r_int
id|sblive_miState2ByteKey
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
multiline_comment|/* byte 1 */
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|data
OG
l_int|0x7f
)paren
(brace
multiline_comment|/* Real-time messages check */
r_if
c_cond
(paren
id|data
OG
l_int|0xf7
)paren
r_return
id|midistatefn
(braket
id|STIN_SYS_REAL
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Invalid data! */
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;Invalid data!&bslash;n&quot;
)paren
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_PARSE
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;status
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATAERROR
comma
id|tmp
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card_mpuin-&gt;curstate
op_assign
id|STIN_2BYTE
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;status
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATA
comma
id|tmp
comma
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sblive_miStateSysCommon2
r_int
id|sblive_miStateSysCommon2
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
(brace
id|card_mpuin-&gt;fstatus
op_assign
id|data
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_SYS_COMMON_2_KEY
suffix:semicolon
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
)brace
DECL|function|sblive_miStateSysCommon2Key
r_int
id|sblive_miStateSysCommon2Key
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
multiline_comment|/* byte 1 */
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|data
OG
l_int|0x7f
)paren
(brace
multiline_comment|/* Real-time messages check */
r_if
c_cond
(paren
id|data
OG
l_int|0xf7
)paren
r_return
id|midistatefn
(braket
id|STIN_SYS_REAL
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Invalid data! */
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;Invalid data!&bslash;n&quot;
)paren
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|card_mpuin-&gt;laststate
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;fstatus
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATAERROR
comma
id|tmp
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card_mpuin-&gt;curstate
op_assign
id|card_mpuin-&gt;laststate
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;fstatus
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATA
comma
id|tmp
comma
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sblive_miStateSysCommon3
r_int
id|sblive_miStateSysCommon3
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
(brace
id|card_mpuin-&gt;fstatus
op_assign
id|data
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_SYS_COMMON_3_KEY
suffix:semicolon
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
)brace
DECL|function|sblive_miStateSysCommon3Key
r_int
id|sblive_miStateSysCommon3Key
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
multiline_comment|/* byte 1 */
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|data
OG
l_int|0x7f
)paren
(brace
multiline_comment|/* Real-time messages check */
r_if
c_cond
(paren
id|data
OG
l_int|0xf7
)paren
r_return
id|midistatefn
(braket
id|STIN_SYS_REAL
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Invalid data! */
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;Invalid data!&bslash;n&quot;
)paren
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|card_mpuin-&gt;laststate
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;fstatus
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATAERROR
comma
id|tmp
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card_mpuin-&gt;data
op_assign
id|data
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|STIN_SYS_COMMON_3_VEL
suffix:semicolon
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
)brace
DECL|function|sblive_miStateSysCommon3Vel
r_int
id|sblive_miStateSysCommon3Vel
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
multiline_comment|/* byte 2 */
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|data
OG
l_int|0x7f
)paren
(brace
multiline_comment|/* Real-time messages check */
r_if
c_cond
(paren
id|data
OG
l_int|0xf7
)paren
r_return
id|midistatefn
(braket
id|STIN_SYS_REAL
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Invalid data! */
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;Invalid data!&bslash;n&quot;
)paren
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|card_mpuin-&gt;laststate
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;fstatus
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATAERROR
comma
id|tmp
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card_mpuin-&gt;curstate
op_assign
id|card_mpuin-&gt;laststate
suffix:semicolon
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;data
suffix:semicolon
id|tmp
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
id|tmp
op_or_assign
(paren
r_int
r_int
)paren
id|card_mpuin-&gt;fstatus
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATA
comma
id|tmp
comma
l_int|3
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sblive_miStateSysExNorm
r_int
id|sblive_miStateSysExNorm
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
OG
l_int|0x7f
)paren
op_logical_and
(paren
id|data
op_ne
l_int|0xf7
)paren
)paren
(brace
multiline_comment|/* Real-time messages check */
r_if
c_cond
(paren
id|data
OG
l_int|0xf7
)paren
r_return
id|midistatefn
(braket
id|STIN_SYS_REAL
)braket
dot
id|Fn
c_func
(paren
id|card_mpuin
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Invalid Data! */
id|DPF
c_func
(paren
l_int|2
comma
l_string|&quot;Invalid data!&bslash;n&quot;
)paren
suffix:semicolon
id|card_mpuin-&gt;curstate
op_assign
id|card_mpuin-&gt;laststate
suffix:semicolon
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
)paren
(brace
r_struct
id|midi_queue
op_star
id|midiq
suffix:semicolon
id|midiq
op_assign
id|card_mpuin-&gt;firstmidiq
suffix:semicolon
op_star
id|midiq-&gt;midibyte
op_assign
id|data
suffix:semicolon
op_decrement
id|midiq-&gt;sizeLeft
suffix:semicolon
op_increment
id|midiq-&gt;midibyte
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|card_mpuin-&gt;firstmidiq
op_assign
id|midiq-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
op_eq
l_int|NULL
)paren
id|card_mpuin-&gt;lastmidiq
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INLONGERROR
comma
(paren
r_int
r_int
)paren
id|midiq
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|midiq
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
)paren
(brace
r_struct
id|midi_queue
op_star
id|midiq
suffix:semicolon
id|midiq
op_assign
id|card_mpuin-&gt;firstmidiq
suffix:semicolon
op_star
id|midiq-&gt;midibyte
op_assign
id|data
suffix:semicolon
op_decrement
id|midiq-&gt;sizeLeft
suffix:semicolon
op_increment
id|midiq-&gt;midibyte
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
op_eq
l_int|0xf7
)paren
(brace
multiline_comment|/* End of Sysex buffer */
multiline_comment|/* Send down the buffer */
id|card_mpuin-&gt;curstate
op_assign
id|card_mpuin-&gt;laststate
suffix:semicolon
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
)paren
(brace
r_struct
id|midi_queue
op_star
id|midiq
suffix:semicolon
id|midiq
op_assign
id|card_mpuin-&gt;firstmidiq
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|card_mpuin-&gt;firstmidiq
op_assign
id|midiq-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
op_eq
l_int|NULL
)paren
id|card_mpuin-&gt;lastmidiq
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INLONGDATA
comma
(paren
r_int
r_int
)paren
id|midiq
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|midiq
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
)paren
(brace
r_struct
id|midi_queue
op_star
id|midiq
suffix:semicolon
id|midiq
op_assign
id|card_mpuin-&gt;firstmidiq
suffix:semicolon
r_if
c_cond
(paren
id|midiq-&gt;sizeLeft
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Special case */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|card_mpuin-&gt;firstmidiq
op_assign
id|midiq-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|card_mpuin-&gt;firstmidiq
op_eq
l_int|NULL
)paren
id|card_mpuin-&gt;lastmidiq
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card_mpuin-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INLONGDATA
comma
(paren
r_int
r_int
)paren
id|midiq
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|midiq
)paren
suffix:semicolon
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
)brace
)brace
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
)brace
DECL|function|sblive_miStateSysReal
r_int
id|sblive_miStateSysReal
c_func
(paren
r_struct
id|emu10k1_mpuin
op_star
id|card_mpuin
comma
id|u8
id|data
)paren
(brace
id|emu10k1_mpuin_callback
c_func
(paren
id|card_mpuin
comma
id|ICARDMIDI_INDATA
comma
id|data
comma
l_int|1
)paren
suffix:semicolon
r_return
id|CTSTATUS_NEXT_BYTE
suffix:semicolon
)brace
eof
