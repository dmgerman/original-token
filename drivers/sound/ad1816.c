multiline_comment|/*&n; *&n; * AD1816 lowlevel sound driver for Linux 2.2.0 and above&n; *&n; * Copyright (C) 1998 by Thorsten Knabe &lt;tek@rbg.informatik.tu-darmstadt.de&gt;&n; *&n; * Based on the CS4232/AD1848 driver Copyright (C) by Hannu Savolainen 1993-1996&n; *&n; *&n; * version: 1.3.1&n; * status: experimental&n; * date: 1999/4/18&n; *&n; * Changes:&n; *&t;Oleg Drokin: Some cleanup of load/unload functions.&t;1998/11/24&n; *&t;&n; *&t;Thorsten Knabe: attach and unload rewritten, &n; *&t;some argument checks added&t;&t;&t;&t;1998/11/30&n; *&n; *&t;Thorsten Knabe: Buggy isa bridge workaround added&t;1999/01/16&n; *&t;&n; *&t;David Moews/Thorsten Knabe: Introduced options &n; *&t;parameter. Added slightly modified patch from &n; *&t;David Moews to disable dsp audio sources by setting &n; *&t;bit 0 of options parameter. This seems to be&n; *&t;required by some Aztech/Newcom SC-16 cards.&t;&t;1999/04/18&n; *&n; *&t;Christoph Hellwig: Adapted to module_init/module_exit.&t;2000/03/03&n; *&n; *&t;Christoph Hellwig: Added isapnp support&t;&t;&t;2000/03/15&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/isapnp.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &quot;sound_config.h&quot;
DECL|macro|DEBUGNOISE
mdefine_line|#define DEBUGNOISE(x)
DECL|macro|DEBUGINFO
mdefine_line|#define DEBUGINFO(x)
DECL|macro|DEBUGLOG
mdefine_line|#define DEBUGLOG(x)
DECL|macro|DEBUGWARN
mdefine_line|#define DEBUGWARN(x)
DECL|macro|CHECK_FOR_POWER
mdefine_line|#define CHECK_FOR_POWER { int timeout=100; &bslash;&n;  while (timeout &gt; 0 &amp;&amp; (inb(devc-&gt;base)&amp;0x80)!= 0x80) {&bslash;&n;          timeout--; &bslash;&n;  } &bslash;&n;  if (timeout==0) {&bslash;&n;          printk(&quot;ad1816: Check for power failed in %s line: %d&bslash;n&quot;,__FILE__,__LINE__); &bslash;&n;  } &bslash;&n;}
multiline_comment|/* structure to hold device specific information */
r_typedef
r_struct
(brace
DECL|member|base
r_int
id|base
suffix:semicolon
multiline_comment|/* set in attach */
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|dma_playback
r_int
id|dma_playback
suffix:semicolon
DECL|member|dma_capture
r_int
id|dma_capture
suffix:semicolon
DECL|member|speed
r_int
id|speed
suffix:semicolon
multiline_comment|/* open */
DECL|member|channels
r_int
id|channels
suffix:semicolon
DECL|member|audio_format
r_int
id|audio_format
suffix:semicolon
DECL|member|format_bits
r_int
r_char
id|format_bits
suffix:semicolon
DECL|member|audio_mode
r_int
id|audio_mode
suffix:semicolon
DECL|member|opened
r_int
id|opened
suffix:semicolon
DECL|member|recmask
r_int
id|recmask
suffix:semicolon
multiline_comment|/* setup */
DECL|member|supported_devices
r_int
id|supported_devices
suffix:semicolon
DECL|member|supported_rec_devices
r_int
id|supported_rec_devices
suffix:semicolon
DECL|member|levels
r_int
r_int
id|levels
(braket
id|SOUND_MIXER_NRDEVICES
)braket
suffix:semicolon
DECL|member|dev_no
r_int
id|dev_no
suffix:semicolon
multiline_comment|/* this is the # in audio_devs and NOT &n;&t;&t;&t;&t;    in ad1816_info */
DECL|member|irq_ok
r_int
id|irq_ok
suffix:semicolon
DECL|member|osp
r_int
op_star
id|osp
suffix:semicolon
DECL|typedef|ad1816_info
)brace
id|ad1816_info
suffix:semicolon
DECL|variable|nr_ad1816_devs
r_static
r_int
id|nr_ad1816_devs
op_assign
l_int|0
suffix:semicolon
DECL|variable|ad1816_clockfreq
r_static
r_int
id|ad1816_clockfreq
op_assign
l_int|33000
suffix:semicolon
DECL|variable|options
r_static
r_int
id|options
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* for backward mapping of irq to sound device */
DECL|variable|irq2dev
r_static
r_volatile
r_char
id|irq2dev
(braket
l_int|17
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* supported audio formats */
DECL|variable|ad_format_mask
r_static
r_int
id|ad_format_mask
op_assign
id|AFMT_U8
op_or
id|AFMT_S16_LE
op_or
id|AFMT_S16_BE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
suffix:semicolon
multiline_comment|/* array of device info structures */
DECL|variable|dev_info
r_static
id|ad1816_info
id|dev_info
(braket
id|MAX_AUDIO_DEV
)braket
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------- */
multiline_comment|/* functions for easier access to inderect registers */
DECL|function|ad_read
r_static
r_int
id|ad_read
(paren
id|ad1816_info
op_star
id|devc
comma
r_int
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|result
suffix:semicolon
id|CHECK_FOR_POWER
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* make register access atomic */
id|cli
(paren
)paren
suffix:semicolon
id|outb
(paren
(paren
r_int
r_char
)paren
(paren
id|reg
op_amp
l_int|0x3f
)paren
comma
id|devc-&gt;base
op_plus
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|2
)paren
suffix:semicolon
id|result
op_add_assign
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|3
)paren
op_lshift
l_int|8
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
id|result
)paren
suffix:semicolon
)brace
DECL|function|ad_write
r_static
r_void
id|ad_write
(paren
id|ad1816_info
op_star
id|devc
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|CHECK_FOR_POWER
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* make register access atomic */
id|cli
(paren
)paren
suffix:semicolon
id|outb
(paren
(paren
r_int
r_char
)paren
(paren
id|reg
op_amp
l_int|0xff
)paren
comma
id|devc-&gt;base
op_plus
l_int|0
)paren
suffix:semicolon
id|outb
(paren
(paren
r_int
r_char
)paren
(paren
id|data
op_amp
l_int|0xff
)paren
comma
id|devc-&gt;base
op_plus
l_int|2
)paren
suffix:semicolon
id|outb
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|data
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
comma
id|devc-&gt;base
op_plus
l_int|3
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------- */
multiline_comment|/* function interface required by struct audio_driver */
DECL|function|ad1816_halt_input
r_static
r_void
id|ad1816_halt_input
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_char
id|buffer
suffix:semicolon
id|DEBUGINFO
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: halt_input called&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|disable_dma
c_func
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_in-&gt;dma
)paren
suffix:semicolon
)brace
id|buffer
op_assign
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* disable capture */
id|outb
c_func
(paren
id|buffer
op_amp
op_complement
l_int|0x01
comma
id|devc-&gt;base
op_plus
l_int|9
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|enable_dma
c_func
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_in-&gt;dma
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear interrupt status */
id|outb
(paren
op_complement
l_int|0x40
comma
id|devc-&gt;base
op_plus
l_int|1
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_INPUT
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1816_halt_output
r_static
r_void
id|ad1816_halt_output
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_char
id|buffer
suffix:semicolon
id|DEBUGINFO
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: halt_output called!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/* Mute pcm output */
id|ad_write
c_func
(paren
id|devc
comma
l_int|4
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|4
)paren
op_or
l_int|0x8080
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|disable_dma
c_func
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;dma
)paren
suffix:semicolon
)brace
id|buffer
op_assign
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* disable capture */
id|outb
c_func
(paren
id|buffer
op_amp
op_complement
l_int|0x01
comma
id|devc-&gt;base
op_plus
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|isa_dma_bridge_buggy
)paren
(brace
id|enable_dma
c_func
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmap_out-&gt;dma
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear interrupt status */
id|outb
(paren
(paren
r_int
r_char
)paren
op_complement
l_int|0x80
comma
id|devc-&gt;base
op_plus
l_int|1
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_and_assign
op_complement
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1816_output_block
r_static
r_void
id|ad1816_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|cnt
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|DEBUGINFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: output_block called buf=%ld count=%d flags=%d&bslash;n&quot;
comma
id|buf
comma
id|count
comma
id|intrflag
)paren
)paren
suffix:semicolon
id|cnt
op_assign
id|count
op_div
l_int|4
op_minus
l_int|1
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/* set transfer count */
id|ad_write
(paren
id|devc
comma
l_int|8
comma
id|cnt
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1816_start_input
r_static
r_void
id|ad1816_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|cnt
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|DEBUGINFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: start_input called buf=%ld count=%d flags=%d&bslash;n&quot;
comma
id|buf
comma
id|count
comma
id|intrflag
)paren
)paren
suffix:semicolon
id|cnt
op_assign
id|count
op_div
l_int|4
op_minus
l_int|1
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* make register access atomic */
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/* set transfer count */
id|ad_write
(paren
id|devc
comma
l_int|10
comma
id|cnt
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|devc-&gt;audio_mode
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1816_prepare_for_input
r_static
r_int
id|ad1816_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|freq
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_char
id|fmt_bits
suffix:semicolon
id|DEBUGINFO
(paren
id|printk
(paren
l_string|&quot;ad1816: prepare_for_input called: bsize=%d bcount=%d&bslash;n&quot;
comma
id|bsize
comma
id|bcount
)paren
)paren
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|fmt_bits
op_assign
(paren
id|devc-&gt;format_bits
op_amp
l_int|0x7
)paren
op_lshift
l_int|3
suffix:semicolon
multiline_comment|/* set mono/stereo mode */
r_if
c_cond
(paren
id|devc-&gt;channels
OG
l_int|1
)paren
(brace
id|fmt_bits
op_or_assign
l_int|0x4
suffix:semicolon
)brace
multiline_comment|/* set Mono/Stereo in playback/capture register */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|8
)paren
op_amp
op_complement
l_int|0x3C
)paren
op_or
id|fmt_bits
comma
id|devc-&gt;base
op_plus
l_int|8
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|9
)paren
op_amp
op_complement
l_int|0x3C
)paren
op_or
id|fmt_bits
comma
id|devc-&gt;base
op_plus
l_int|9
)paren
suffix:semicolon
multiline_comment|/* If compiled into kernel, AD1816_CLOCK is defined, so use it */
macro_line|#ifdef AD1816_CLOCK 
id|ad1816_clockfreq
op_assign
id|AD1816_CLOCK
suffix:semicolon
macro_line|#endif
multiline_comment|/* capture/playback frequency correction for soundcards &n;&t;   with clock chips != 33MHz (allowed range 5 - 100 kHz) */
r_if
c_cond
(paren
id|ad1816_clockfreq
l_int|100000
)paren
(brace
id|ad1816_clockfreq
op_assign
l_int|33000
suffix:semicolon
)brace
id|freq
op_assign
(paren
(paren
r_int
r_int
)paren
id|devc-&gt;speed
op_star
l_int|33000
)paren
op_div
id|ad1816_clockfreq
suffix:semicolon
multiline_comment|/* write playback/capture speeds */
id|ad_write
(paren
id|devc
comma
l_int|2
comma
id|freq
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|3
comma
id|freq
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|ad1816_halt_input
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1816_prepare_for_output
r_static
r_int
id|ad1816_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|freq
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_char
id|fmt_bits
suffix:semicolon
id|DEBUGINFO
(paren
id|printk
(paren
l_string|&quot;ad1816: prepare_for_output called: bsize=%d bcount=%d&bslash;n&quot;
comma
id|bsize
comma
id|bcount
)paren
)paren
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* make register access atomic */
id|cli
(paren
)paren
suffix:semicolon
id|fmt_bits
op_assign
(paren
id|devc-&gt;format_bits
op_amp
l_int|0x7
)paren
op_lshift
l_int|3
suffix:semicolon
multiline_comment|/* set mono/stereo mode */
r_if
c_cond
(paren
id|devc-&gt;channels
OG
l_int|1
)paren
(brace
id|fmt_bits
op_or_assign
l_int|0x4
suffix:semicolon
)brace
multiline_comment|/* write format bits to playback/capture registers */
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|8
)paren
op_amp
op_complement
l_int|0x3C
)paren
op_or
id|fmt_bits
comma
id|devc-&gt;base
op_plus
l_int|8
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|9
)paren
op_amp
op_complement
l_int|0x3C
)paren
op_or
id|fmt_bits
comma
id|devc-&gt;base
op_plus
l_int|9
)paren
suffix:semicolon
macro_line|#ifdef AD1816_CLOCK 
id|ad1816_clockfreq
op_assign
id|AD1816_CLOCK
suffix:semicolon
macro_line|#endif
multiline_comment|/* capture/playback frequency correction for soundcards &n;&t;   with clock chips != 33MHz (allowed range 5 - 100 kHz)*/
r_if
c_cond
(paren
id|ad1816_clockfreq
l_int|100000
)paren
(brace
id|ad1816_clockfreq
op_assign
l_int|33000
suffix:semicolon
)brace
id|freq
op_assign
(paren
(paren
r_int
r_int
)paren
id|devc-&gt;speed
op_star
l_int|33000
)paren
op_div
id|ad1816_clockfreq
suffix:semicolon
multiline_comment|/* write playback/capture speeds */
id|ad_write
(paren
id|devc
comma
l_int|2
comma
id|freq
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|3
comma
id|freq
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|ad1816_halt_output
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1816_trigger
r_static
r_void
id|ad1816_trigger
(paren
r_int
id|dev
comma
r_int
id|state
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|DEBUGINFO
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: trigger called! (devc=%d,devc-&gt;base=%d&bslash;n&quot;
comma
id|devc
comma
id|devc-&gt;base
)paren
)paren
suffix:semicolon
multiline_comment|/* mode may have changed */
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* make register access atomic */
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/* mask out modes not specified on open call */
id|state
op_and_assign
id|devc-&gt;audio_mode
suffix:semicolon
multiline_comment|/* setup soundchip to new io-mode */
r_if
c_cond
(paren
id|state
op_amp
id|PCM_ENABLE_INPUT
)paren
(brace
multiline_comment|/* enable capture */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|9
)paren
op_or
l_int|0x01
comma
id|devc-&gt;base
op_plus
l_int|9
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* disable capture */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|9
)paren
op_amp
op_complement
l_int|0x01
comma
id|devc-&gt;base
op_plus
l_int|9
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
op_amp
id|PCM_ENABLE_OUTPUT
)paren
(brace
multiline_comment|/* enable playback */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|8
)paren
op_or
l_int|0x01
comma
id|devc-&gt;base
op_plus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* unmute pcm output */
id|ad_write
c_func
(paren
id|devc
comma
l_int|4
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|4
)paren
op_amp
op_complement
l_int|0x8080
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* mute pcm output */
id|ad_write
c_func
(paren
id|devc
comma
l_int|4
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|4
)paren
op_or
l_int|0x8080
)paren
suffix:semicolon
multiline_comment|/* disable capture */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|8
)paren
op_amp
op_complement
l_int|0x01
comma
id|devc-&gt;base
op_plus
l_int|8
)paren
suffix:semicolon
)brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* halt input &amp; output */
DECL|function|ad1816_halt
r_static
r_void
id|ad1816_halt
(paren
r_int
id|dev
)paren
(brace
id|ad1816_halt_input
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ad1816_halt_output
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ad1816_reset
r_static
r_void
id|ad1816_reset
(paren
r_int
id|dev
)paren
(brace
id|ad1816_halt
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* set playback speed */
DECL|function|ad1816_set_speed
r_static
r_int
id|ad1816_set_speed
(paren
r_int
id|dev
comma
r_int
id|arg
)paren
(brace
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_eq
l_int|0
)paren
(brace
r_return
id|devc-&gt;speed
suffix:semicolon
)brace
multiline_comment|/* range checking */
r_if
c_cond
(paren
id|arg
OL
l_int|4000
)paren
(brace
id|arg
op_assign
l_int|4000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
OG
l_int|55000
)paren
(brace
id|arg
op_assign
l_int|55000
suffix:semicolon
)brace
id|devc-&gt;speed
op_assign
id|arg
suffix:semicolon
r_return
id|devc-&gt;speed
suffix:semicolon
)brace
DECL|function|ad1816_set_bits
r_static
r_int
r_int
id|ad1816_set_bits
(paren
r_int
id|dev
comma
r_int
r_int
id|arg
)paren
(brace
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_static
r_struct
id|format_tbl
(brace
r_int
id|format
suffix:semicolon
r_int
r_char
id|bits
suffix:semicolon
)brace
id|format2bits
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
id|AFMT_MU_LAW
comma
l_int|1
)brace
comma
(brace
id|AFMT_A_LAW
comma
l_int|3
)brace
comma
(brace
id|AFMT_IMA_ADPCM
comma
l_int|0
)brace
comma
(brace
id|AFMT_U8
comma
l_int|0
)brace
comma
(brace
id|AFMT_S16_LE
comma
l_int|2
)brace
comma
(brace
id|AFMT_S16_BE
comma
l_int|6
)brace
comma
(brace
id|AFMT_S8
comma
l_int|0
)brace
comma
(brace
id|AFMT_U16_LE
comma
l_int|0
)brace
comma
(brace
id|AFMT_U16_BE
comma
l_int|0
)brace
)brace
suffix:semicolon
r_int
id|i
comma
id|n
op_assign
r_sizeof
(paren
id|format2bits
)paren
op_div
r_sizeof
(paren
r_struct
id|format_tbl
)paren
suffix:semicolon
multiline_comment|/* return current format */
r_if
c_cond
(paren
id|arg
op_eq
l_int|0
)paren
r_return
id|devc-&gt;audio_format
suffix:semicolon
id|devc-&gt;audio_format
op_assign
id|arg
suffix:semicolon
multiline_comment|/* search matching format bits */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|format2bits
(braket
id|i
)braket
dot
id|format
op_eq
id|arg
)paren
(brace
id|devc-&gt;format_bits
op_assign
id|format2bits
(braket
id|i
)braket
dot
id|bits
suffix:semicolon
id|devc-&gt;audio_format
op_assign
id|arg
suffix:semicolon
r_return
id|arg
suffix:semicolon
)brace
multiline_comment|/* Still hanging here. Something must be terribly wrong */
id|devc-&gt;format_bits
op_assign
l_int|0
suffix:semicolon
r_return
id|devc-&gt;audio_format
op_assign
id|AFMT_U8
suffix:semicolon
)brace
DECL|function|ad1816_set_channels
r_static
r_int
id|ad1816_set_channels
(paren
r_int
id|dev
comma
r_int
id|arg
)paren
(brace
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_if
c_cond
(paren
id|arg
op_ne
l_int|1
op_logical_and
id|arg
op_ne
l_int|2
)paren
r_return
id|devc-&gt;channels
suffix:semicolon
id|devc-&gt;channels
op_assign
id|arg
suffix:semicolon
r_return
id|arg
suffix:semicolon
)brace
multiline_comment|/* open device */
DECL|function|ad1816_open
r_static
r_int
id|ad1816_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
id|ad1816_info
op_star
id|devc
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* is device number valid ? */
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_audiodevs
)paren
r_return
op_minus
(paren
id|ENXIO
)paren
suffix:semicolon
multiline_comment|/* get device info of this dev */
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
multiline_comment|/* make check if device already open atomic */
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;opened
)paren
(brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
multiline_comment|/* mark device as open */
id|devc-&gt;opened
op_assign
l_int|1
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;speed
op_assign
l_int|8000
suffix:semicolon
id|devc-&gt;audio_format
op_assign
id|AFMT_U8
suffix:semicolon
id|devc-&gt;channels
op_assign
l_int|1
suffix:semicolon
id|ad1816_reset
c_func
(paren
id|devc-&gt;dev_no
)paren
suffix:semicolon
multiline_comment|/* halt all pending output */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1816_close
r_static
r_void
id|ad1816_close
(paren
r_int
id|dev
)paren
multiline_comment|/* close device */
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
multiline_comment|/* halt all pending output */
id|ad1816_reset
c_func
(paren
id|devc-&gt;dev_no
)paren
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;speed
op_assign
l_int|8000
suffix:semicolon
id|devc-&gt;audio_format
op_assign
id|AFMT_U8
suffix:semicolon
id|devc-&gt;format_bits
op_assign
l_int|0
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------- */
multiline_comment|/* Audio driver structure */
DECL|variable|ad1816_audio_driver
r_static
r_struct
id|audio_driver
id|ad1816_audio_driver
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|open
suffix:colon
id|ad1816_open
comma
id|close
suffix:colon
id|ad1816_close
comma
id|output_block
suffix:colon
id|ad1816_output_block
comma
id|start_input
suffix:colon
id|ad1816_start_input
comma
id|prepare_for_input
suffix:colon
id|ad1816_prepare_for_input
comma
id|prepare_for_output
suffix:colon
id|ad1816_prepare_for_output
comma
id|halt_io
suffix:colon
id|ad1816_halt
comma
id|halt_input
suffix:colon
id|ad1816_halt_input
comma
id|halt_output
suffix:colon
id|ad1816_halt_output
comma
id|trigger
suffix:colon
id|ad1816_trigger
comma
id|set_speed
suffix:colon
id|ad1816_set_speed
comma
id|set_bits
suffix:colon
id|ad1816_set_bits
comma
id|set_channels
suffix:colon
id|ad1816_set_channels
comma
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------- */
multiline_comment|/* Interrupt handler */
DECL|function|ad1816_interrupt
r_static
r_void
id|ad1816_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|ad1816_info
op_star
id|devc
suffix:semicolon
r_int
id|dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|irq
template_param
l_int|15
)paren
(brace
id|printk
(paren
l_string|&quot;ad1816: Got bogus interrupt %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|irq2dev
(braket
id|irq
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|num_audiodevs
)paren
(brace
id|printk
(paren
l_string|&quot;ad1816: IRQ2AD1816-mapping failed for irq %d device %d&bslash;n&quot;
comma
id|irq
comma
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|devc
op_assign
(paren
id|ad1816_info
op_star
)paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* read interrupt register */
id|status
op_assign
id|inb
(paren
id|devc-&gt;base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Clear all interrupt  */
id|outb
(paren
op_complement
id|status
comma
id|devc-&gt;base
op_plus
l_int|1
)paren
suffix:semicolon
id|DEBUGNOISE
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: Got interrupt subclass %d&bslash;n&quot;
comma
id|status
)paren
)paren
suffix:semicolon
id|devc-&gt;irq_ok
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|DEBUGWARN
c_func
(paren
id|printk
(paren
l_string|&quot;ad1816: interrupt: Got interrupt, but no reason?&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;opened
op_logical_and
(paren
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_INPUT
)paren
op_logical_and
(paren
id|status
op_amp
l_int|64
)paren
)paren
id|DMAbuf_inputintr
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;opened
op_logical_and
(paren
id|devc-&gt;audio_mode
op_amp
id|PCM_ENABLE_OUTPUT
)paren
op_logical_and
(paren
id|status
op_amp
l_int|128
)paren
)paren
id|DMAbuf_outputintr
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------- */
multiline_comment|/* Mixer stuff */
DECL|struct|mixer_def
r_struct
id|mixer_def
(brace
DECL|member|regno
r_int
r_int
id|regno
suffix:colon
l_int|7
suffix:semicolon
DECL|member|polarity
r_int
r_int
id|polarity
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* 0=normal, 1=reversed */
DECL|member|bitpos
r_int
r_int
id|bitpos
suffix:colon
l_int|4
suffix:semicolon
DECL|member|nbits
r_int
r_int
id|nbits
suffix:colon
l_int|4
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|mix_cvt
r_static
r_char
id|mix_cvt
(braket
l_int|101
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|7
comma
l_int|10
comma
l_int|13
comma
l_int|16
comma
l_int|19
comma
l_int|21
comma
l_int|23
comma
l_int|26
comma
l_int|28
comma
l_int|30
comma
l_int|32
comma
l_int|34
comma
l_int|35
comma
l_int|37
comma
l_int|39
comma
l_int|40
comma
l_int|42
comma
l_int|43
comma
l_int|45
comma
l_int|46
comma
l_int|47
comma
l_int|49
comma
l_int|50
comma
l_int|51
comma
l_int|52
comma
l_int|53
comma
l_int|55
comma
l_int|56
comma
l_int|57
comma
l_int|58
comma
l_int|59
comma
l_int|60
comma
l_int|61
comma
l_int|62
comma
l_int|63
comma
l_int|64
comma
l_int|65
comma
l_int|65
comma
l_int|66
comma
l_int|67
comma
l_int|68
comma
l_int|69
comma
l_int|70
comma
l_int|70
comma
l_int|71
comma
l_int|72
comma
l_int|73
comma
l_int|73
comma
l_int|74
comma
l_int|75
comma
l_int|75
comma
l_int|76
comma
l_int|77
comma
l_int|77
comma
l_int|78
comma
l_int|79
comma
l_int|79
comma
l_int|80
comma
l_int|81
comma
l_int|81
comma
l_int|82
comma
l_int|82
comma
l_int|83
comma
l_int|84
comma
l_int|84
comma
l_int|85
comma
l_int|85
comma
l_int|86
comma
l_int|86
comma
l_int|87
comma
l_int|87
comma
l_int|88
comma
l_int|88
comma
l_int|89
comma
l_int|89
comma
l_int|90
comma
l_int|90
comma
l_int|91
comma
l_int|91
comma
l_int|92
comma
l_int|92
comma
l_int|93
comma
l_int|93
comma
l_int|94
comma
l_int|94
comma
l_int|95
comma
l_int|95
comma
l_int|96
comma
l_int|96
comma
l_int|96
comma
l_int|97
comma
l_int|97
comma
l_int|98
comma
l_int|98
comma
l_int|98
comma
l_int|99
comma
l_int|99
comma
l_int|100
)brace
suffix:semicolon
DECL|typedef|mixer_ent
r_typedef
r_struct
id|mixer_def
id|mixer_ent
suffix:semicolon
multiline_comment|/*&n; * Most of the mixer entries work in backwards. Setting the polarity field&n; * makes them to work correctly.&n; *&n; * The channel numbering used by individual soundcards is not fixed. Some&n; * cards have assigned different meanings for the AUX1, AUX2 and LINE inputs.&n; * The current version doesn&squot;t try to compensate this.&n; */
DECL|macro|MIX_ENT
mdefine_line|#define MIX_ENT(name, reg_l, pola_l, pos_l, len_l, reg_r, pola_r, pos_r, len_r)&t;&bslash;&n;  {{reg_l, pola_l, pos_l, len_l}, {reg_r, pola_r, pos_r, len_r}}
DECL|variable|mix_devices
id|mixer_ent
id|mix_devices
(braket
id|SOUND_MIXER_NRDEVICES
)braket
(braket
l_int|2
)braket
op_assign
(brace
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_VOLUME
comma
l_int|14
comma
l_int|1
comma
l_int|8
comma
l_int|5
comma
l_int|14
comma
l_int|1
comma
l_int|0
comma
l_int|5
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_BASS
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_TREBLE
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_SYNTH
comma
l_int|5
comma
l_int|1
comma
l_int|8
comma
l_int|6
comma
l_int|5
comma
l_int|1
comma
l_int|0
comma
l_int|6
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_PCM
comma
l_int|4
comma
l_int|1
comma
l_int|8
comma
l_int|6
comma
l_int|4
comma
l_int|1
comma
l_int|0
comma
l_int|6
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_SPEAKER
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_LINE
comma
l_int|18
comma
l_int|1
comma
l_int|8
comma
l_int|5
comma
l_int|18
comma
l_int|1
comma
l_int|0
comma
l_int|5
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_MIC
comma
l_int|19
comma
l_int|1
comma
l_int|8
comma
l_int|5
comma
l_int|19
comma
l_int|1
comma
l_int|0
comma
l_int|5
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_CD
comma
l_int|15
comma
l_int|1
comma
l_int|8
comma
l_int|5
comma
l_int|15
comma
l_int|1
comma
l_int|0
comma
l_int|5
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_IMIX
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_ALTPCM
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_RECLEV
comma
l_int|20
comma
l_int|0
comma
l_int|8
comma
l_int|4
comma
l_int|20
comma
l_int|0
comma
l_int|0
comma
l_int|4
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_IGAIN
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_OGAIN
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_LINE1
comma
l_int|17
comma
l_int|1
comma
l_int|8
comma
l_int|5
comma
l_int|17
comma
l_int|1
comma
l_int|0
comma
l_int|5
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_LINE2
comma
l_int|16
comma
l_int|1
comma
l_int|8
comma
l_int|5
comma
l_int|16
comma
l_int|1
comma
l_int|0
comma
l_int|5
)paren
comma
id|MIX_ENT
c_func
(paren
id|SOUND_MIXER_LINE3
comma
l_int|39
comma
l_int|0
comma
l_int|9
comma
l_int|4
comma
l_int|39
comma
l_int|1
comma
l_int|0
comma
l_int|5
)paren
)brace
suffix:semicolon
DECL|variable|default_mixer_levels
r_static
r_int
r_int
id|default_mixer_levels
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
l_int|0x4343
comma
multiline_comment|/* Master Volume */
l_int|0x3232
comma
multiline_comment|/* Bass */
l_int|0x3232
comma
multiline_comment|/* Treble */
l_int|0x0000
comma
multiline_comment|/* FM */
l_int|0x4343
comma
multiline_comment|/* PCM */
l_int|0x0000
comma
multiline_comment|/* PC Speaker */
l_int|0x0000
comma
multiline_comment|/* Ext Line */
l_int|0x0000
comma
multiline_comment|/* Mic */
l_int|0x0000
comma
multiline_comment|/* CD */
l_int|0x0000
comma
multiline_comment|/* Recording monitor */
l_int|0x0000
comma
multiline_comment|/* SB PCM */
l_int|0x0000
comma
multiline_comment|/* Recording level */
l_int|0x0000
comma
multiline_comment|/* Input gain */
l_int|0x0000
comma
multiline_comment|/* Output gain */
l_int|0x0000
comma
multiline_comment|/* Line1 */
l_int|0x0000
comma
multiline_comment|/* Line2 */
l_int|0x0000
multiline_comment|/* Line3 (usually line in)*/
)brace
suffix:semicolon
DECL|macro|LEFT_CHN
mdefine_line|#define LEFT_CHN&t;0
DECL|macro|RIGHT_CHN
mdefine_line|#define RIGHT_CHN&t;1
r_static
r_int
DECL|function|ad1816_set_recmask
id|ad1816_set_recmask
(paren
id|ad1816_info
op_star
id|devc
comma
r_int
id|mask
)paren
(brace
r_int
r_char
id|recdev
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
id|mask
op_and_assign
id|devc-&gt;supported_rec_devices
suffix:semicolon
id|n
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Count selected device bits */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
r_else
r_if
c_cond
(paren
id|n
op_ne
l_int|1
)paren
(brace
multiline_comment|/* Too many devices selected */
multiline_comment|/* Filter out active settings */
id|mask
op_and_assign
op_complement
id|devc-&gt;recmask
suffix:semicolon
id|n
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Count selected device bits */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|n
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
l_int|1
)paren
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mask
)paren
(brace
r_case
id|SOUND_MASK_MIC
suffix:colon
id|recdev
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_LINE
suffix:colon
id|recdev
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_CD
suffix:colon
id|recdev
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_LINE1
suffix:colon
id|recdev
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_LINE2
suffix:colon
id|recdev
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_VOLUME
suffix:colon
id|recdev
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
id|recdev
op_assign
l_int|5
suffix:semicolon
)brace
id|recdev
op_lshift_assign
l_int|4
suffix:semicolon
id|ad_write
(paren
id|devc
comma
l_int|20
comma
(paren
id|ad_read
(paren
id|devc
comma
l_int|20
)paren
op_amp
l_int|0x8f8f
)paren
op_or
id|recdev
op_or
(paren
id|recdev
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|devc-&gt;recmask
op_assign
id|mask
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
r_static
r_void
DECL|function|change_bits
id|change_bits
(paren
r_int
op_star
id|regval
comma
r_int
id|dev
comma
r_int
id|chn
comma
r_int
id|newval
)paren
(brace
r_int
r_char
id|mask
suffix:semicolon
r_int
id|shift
suffix:semicolon
multiline_comment|/* Reverse polarity*/
r_if
c_cond
(paren
id|mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|polarity
op_eq
l_int|1
)paren
id|newval
op_assign
l_int|100
op_minus
id|newval
suffix:semicolon
id|mask
op_assign
(paren
l_int|1
op_lshift
id|mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|nbits
)paren
op_minus
l_int|1
suffix:semicolon
id|shift
op_assign
id|mix_devices
(braket
id|dev
)braket
(braket
id|chn
)braket
dot
id|bitpos
suffix:semicolon
multiline_comment|/* Scale it */
id|newval
op_assign
(paren
r_int
)paren
(paren
(paren
id|newval
op_star
id|mask
)paren
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
multiline_comment|/* Clear bits */
op_star
id|regval
op_and_assign
op_complement
(paren
id|mask
op_lshift
id|shift
)paren
suffix:semicolon
multiline_comment|/* Set new value */
op_star
id|regval
op_or_assign
(paren
id|newval
op_amp
id|mask
)paren
op_lshift
id|shift
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1816_mixer_get
id|ad1816_mixer_get
(paren
id|ad1816_info
op_star
id|devc
comma
r_int
id|dev
)paren
(brace
id|DEBUGINFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: mixer_get called!&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* range check + supported mixer check */
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|SOUND_MIXER_NRDEVICES
)paren
r_return
(paren
op_minus
(paren
id|EINVAL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|1
op_lshift
id|dev
)paren
op_amp
id|devc-&gt;supported_devices
)paren
)paren
r_return
op_minus
(paren
id|EINVAL
)paren
suffix:semicolon
r_return
id|devc-&gt;levels
(braket
id|dev
)braket
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1816_mixer_set
id|ad1816_mixer_set
(paren
id|ad1816_info
op_star
id|devc
comma
r_int
id|dev
comma
r_int
id|value
)paren
(brace
r_int
id|left
op_assign
id|value
op_amp
l_int|0x000000ff
suffix:semicolon
r_int
id|right
op_assign
(paren
id|value
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
r_int
id|retvol
suffix:semicolon
r_int
id|regoffs
suffix:semicolon
r_int
id|val
suffix:semicolon
r_int
id|valmute
suffix:semicolon
id|DEBUGINFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: mixer_set called!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
OL
l_int|0
op_logical_or
id|dev
op_ge
id|SOUND_MIXER_NRDEVICES
)paren
r_return
op_minus
(paren
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|left
OL
l_int|0
)paren
id|left
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
id|right
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|right
OL
l_int|0
)paren
id|right
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Mono control */
r_if
c_cond
(paren
id|mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
id|right
op_assign
id|left
suffix:semicolon
id|retvol
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Scale it */
id|left
op_assign
id|mix_cvt
(braket
id|left
)braket
suffix:semicolon
id|right
op_assign
id|mix_cvt
(braket
id|right
)braket
suffix:semicolon
multiline_comment|/* reject all mixers that are not supported */
r_if
c_cond
(paren
op_logical_neg
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|dev
)paren
)paren
)paren
r_return
op_minus
(paren
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|mix_devices
(braket
id|dev
)braket
(braket
id|LEFT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
r_return
op_minus
(paren
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* keep precise volume internal */
id|devc-&gt;levels
(braket
id|dev
)braket
op_assign
id|retvol
suffix:semicolon
multiline_comment|/* Set the left channel */
id|regoffs
op_assign
id|mix_devices
(braket
id|dev
)braket
(braket
id|LEFT_CHN
)braket
dot
id|regno
suffix:semicolon
id|val
op_assign
id|ad_read
(paren
id|devc
comma
id|regoffs
)paren
suffix:semicolon
id|change_bits
(paren
op_amp
id|val
comma
id|dev
comma
id|LEFT_CHN
comma
id|left
)paren
suffix:semicolon
id|valmute
op_assign
id|val
suffix:semicolon
multiline_comment|/* Mute bit masking on some registers */
r_if
c_cond
(paren
id|regoffs
op_eq
l_int|5
op_logical_or
id|regoffs
op_eq
l_int|14
op_logical_or
id|regoffs
op_eq
l_int|15
op_logical_or
id|regoffs
op_eq
l_int|16
op_logical_or
id|regoffs
op_eq
l_int|17
op_logical_or
id|regoffs
op_eq
l_int|18
op_logical_or
id|regoffs
op_eq
l_int|19
op_logical_or
id|regoffs
op_eq
l_int|39
)paren
(brace
r_if
c_cond
(paren
id|left
op_eq
l_int|0
)paren
id|valmute
op_or_assign
l_int|0x8000
suffix:semicolon
r_else
id|valmute
op_and_assign
op_complement
l_int|0x8000
suffix:semicolon
)brace
id|ad_write
(paren
id|devc
comma
id|regoffs
comma
id|valmute
)paren
suffix:semicolon
multiline_comment|/* mute */
multiline_comment|/*&n;&t; * Set the right channel&n;&t; */
multiline_comment|/* Was just a mono channel */
r_if
c_cond
(paren
id|mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|nbits
op_eq
l_int|0
)paren
r_return
id|retvol
suffix:semicolon
id|regoffs
op_assign
id|mix_devices
(braket
id|dev
)braket
(braket
id|RIGHT_CHN
)braket
dot
id|regno
suffix:semicolon
id|val
op_assign
id|ad_read
(paren
id|devc
comma
id|regoffs
)paren
suffix:semicolon
id|change_bits
(paren
op_amp
id|val
comma
id|dev
comma
id|RIGHT_CHN
comma
id|right
)paren
suffix:semicolon
id|valmute
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|regoffs
op_eq
l_int|5
op_logical_or
id|regoffs
op_eq
l_int|14
op_logical_or
id|regoffs
op_eq
l_int|15
op_logical_or
id|regoffs
op_eq
l_int|16
op_logical_or
id|regoffs
op_eq
l_int|17
op_logical_or
id|regoffs
op_eq
l_int|18
op_logical_or
id|regoffs
op_eq
l_int|19
op_logical_or
id|regoffs
op_eq
l_int|39
)paren
(brace
r_if
c_cond
(paren
id|right
op_eq
l_int|0
)paren
id|valmute
op_or_assign
l_int|0x80
suffix:semicolon
r_else
id|valmute
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
)brace
id|ad_write
(paren
id|devc
comma
id|regoffs
comma
id|valmute
)paren
suffix:semicolon
multiline_comment|/* mute */
r_return
id|retvol
suffix:semicolon
)brace
DECL|macro|MIXER_DEVICES
mdefine_line|#define MIXER_DEVICES ( SOUND_MASK_VOLUME | &bslash;&n;&t;&t;&t;SOUND_MASK_SYNTH | &bslash;&n;&t;&t;&t;SOUND_MASK_PCM | &bslash;&n;&t;&t;&t;SOUND_MASK_LINE | &bslash;&n;&t;&t;&t;SOUND_MASK_LINE1 | &bslash;&n;&t;&t;&t;SOUND_MASK_LINE2 | &bslash;&n;&t;&t;&t;SOUND_MASK_LINE3 | &bslash;&n;&t;&t;&t;SOUND_MASK_MIC | &bslash;&n;&t;&t;&t;SOUND_MASK_CD | &bslash;&n;&t;&t;&t;SOUND_MASK_RECLEV  &bslash;&n;&t;&t;&t;)
DECL|macro|REC_DEVICES
mdefine_line|#define REC_DEVICES ( SOUND_MASK_LINE2 |&bslash;&n;&t;&t;      SOUND_MASK_LINE |&bslash;&n;&t;&t;      SOUND_MASK_LINE1 |&bslash;&n;&t;&t;      SOUND_MASK_MIC |&bslash;&n;&t;&t;      SOUND_MASK_CD |&bslash;&n;&t;&t;      SOUND_MASK_VOLUME &bslash;&n;&t;&t;      )
r_static
r_void
DECL|function|ad1816_mixer_reset
id|ad1816_mixer_reset
(paren
id|ad1816_info
op_star
id|devc
)paren
(brace
r_int
id|i
suffix:semicolon
id|devc-&gt;supported_devices
op_assign
id|MIXER_DEVICES
suffix:semicolon
id|devc-&gt;supported_rec_devices
op_assign
id|REC_DEVICES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|devc-&gt;supported_devices
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|ad1816_mixer_set
(paren
id|devc
comma
id|i
comma
id|default_mixer_levels
(braket
id|i
)braket
)paren
suffix:semicolon
id|ad1816_set_recmask
(paren
id|devc
comma
id|SOUND_MASK_MIC
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ad1816_mixer_ioctl
id|ad1816_mixer_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
id|ad1816_info
op_star
id|devc
op_assign
id|mixer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
id|val
suffix:semicolon
id|DEBUGINFO
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: mixer_ioctl called!&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Mixer ioctl */
r_if
c_cond
(paren
(paren
(paren
id|cmd
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_eq
l_char|&squot;M&squot;
)paren
(brace
multiline_comment|/* set ioctl */
r_if
c_cond
(paren
id|_SIOC_DIR
(paren
id|cmd
)paren
op_amp
id|_SIOC_WRITE
)paren
(brace
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_assign
id|ad1816_set_recmask
(paren
id|devc
comma
id|val
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_assign
id|ad1816_mixer_set
(paren
id|devc
comma
id|cmd
op_amp
l_int|0xff
comma
id|val
)paren
)paren
OL
l_int|0
)paren
r_return
id|val
suffix:semicolon
r_else
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* read ioctl */
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
id|val
op_assign
id|devc-&gt;recmask
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
id|val
op_assign
id|devc-&gt;supported_devices
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
id|val
op_assign
id|devc-&gt;supported_devices
op_amp
op_complement
(paren
id|SOUND_MASK_SPEAKER
op_or
id|SOUND_MASK_IMIX
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
id|val
op_assign
id|devc-&gt;supported_rec_devices
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
id|val
op_assign
id|SOUND_CAP_EXCL_INPUT
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|ad1816_mixer_get
(paren
id|devc
comma
id|cmd
op_amp
l_int|0xff
)paren
)paren
OL
l_int|0
)paren
r_return
id|val
suffix:semicolon
r_else
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
multiline_comment|/* not for mixer */
r_return
op_minus
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------- */
multiline_comment|/* Mixer structure */
DECL|variable|ad1816_mixer_operations
r_static
r_struct
id|mixer_operations
id|ad1816_mixer_operations
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|id
suffix:colon
l_string|&quot;AD1816&quot;
comma
id|name
suffix:colon
l_string|&quot;AD1816 Mixer&quot;
comma
id|ioctl
suffix:colon
id|ad1816_mixer_ioctl
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------- */
multiline_comment|/* stuff for card recognition, init and unloading */
multiline_comment|/* replace with probe routine */
DECL|function|probe_ad1816
r_static
r_int
id|__init
id|probe_ad1816
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|ad1816_info
op_star
id|devc
op_assign
op_amp
id|dev_info
(braket
id|nr_ad1816_devs
)braket
suffix:semicolon
r_int
id|io_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
r_int
op_star
id|osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
r_int
id|tmp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ad1816: AD1816 sounddriver Copyright (C) 1998 by Thorsten Knabe&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ad1816: io=0x%x, irq=%d, dma=%d, dma2=%d, clockfreq=%d, options=%d isadmabug=%d&bslash;n&quot;
comma
id|hw_config-&gt;io_base
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
comma
id|ad1816_clockfreq
comma
id|options
comma
id|isa_dma_bridge_buggy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check_region
(paren
id|io_base
comma
l_int|16
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;ad1816: I/O port 0x%03x not free&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DEBUGLOG
c_func
(paren
id|printk
(paren
l_string|&quot;ad1816: detect(%x)&bslash;n&quot;
comma
id|io_base
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr_ad1816_devs
op_ge
id|MAX_AUDIO_DEV
)paren
(brace
id|printk
(paren
l_string|&quot;ad1816: detect error - step 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|devc-&gt;base
op_assign
id|io_base
suffix:semicolon
id|devc-&gt;irq_ok
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;osp
op_assign
id|osp
suffix:semicolon
multiline_comment|/* base+0: bit 1 must be set but not 255 */
id|tmp
op_assign
id|inb
c_func
(paren
id|devc-&gt;base
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x80
)paren
op_eq
l_int|0
op_logical_or
id|tmp
op_eq
l_int|255
)paren
(brace
id|DEBUGLOG
(paren
id|printk
(paren
l_string|&quot;ad1816: Chip is not an AD1816 or chip is not active (Test 0)&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* writes to ireg 8 are copied to ireg 9 */
id|ad_write
c_func
(paren
id|devc
comma
l_int|8
comma
l_int|12345
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
op_ne
l_int|12345
)paren
(brace
id|DEBUGLOG
(paren
id|printk
(paren
l_string|&quot;ad1816: Chip is not an AD1816 (Test 1)&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* writes to ireg 8 are copied to ireg 9 */
id|ad_write
c_func
(paren
id|devc
comma
l_int|8
comma
l_int|54321
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|9
)paren
op_ne
l_int|54321
)paren
(brace
id|DEBUGLOG
(paren
id|printk
(paren
l_string|&quot;ad1816: Chip is not an AD1816 (Test 2)&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* writes to ireg 10 are copied to ireg 11 */
id|ad_write
c_func
(paren
id|devc
comma
l_int|10
comma
l_int|54321
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|11
)paren
op_ne
l_int|54321
)paren
(brace
id|DEBUGLOG
(paren
id|printk
(paren
l_string|&quot;ad1816: Chip is not an AD1816 (Test 3)&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* writes to ireg 10 are copied to ireg 11 */
id|ad_write
c_func
(paren
id|devc
comma
l_int|10
comma
l_int|12345
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad_read
c_func
(paren
id|devc
comma
l_int|11
)paren
op_ne
l_int|12345
)paren
(brace
id|DEBUGLOG
(paren
id|printk
(paren
l_string|&quot;ad1816: Chip is not an AD1816 (Test 4)&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* bit in base +1 cannot be set to 1 */
id|tmp
op_assign
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|devc-&gt;base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|devc-&gt;base
op_plus
l_int|1
)paren
op_ne
id|tmp
)paren
(brace
id|DEBUGLOG
(paren
id|printk
(paren
l_string|&quot;ad1816: Chip is not an AD1816 (Test 5)&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DEBUGLOG
(paren
id|printk
(paren
l_string|&quot;ad1816: detect() - Detected OK&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DEBUGLOG
(paren
id|printk
(paren
l_string|&quot;ad1816: AD1816 Version: %d&bslash;n&quot;
comma
id|ad_read
c_func
(paren
id|devc
comma
l_int|45
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/*  detection was successful */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* allocate resources from the kernel. If any allocation fails, free&n;   all allocated resources and exit attach.&n;  &n; */
DECL|function|attach_ad1816
r_static
r_void
id|__init
id|attach_ad1816
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|my_dev
suffix:semicolon
r_char
id|dev_name
(braket
l_int|100
)braket
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
op_amp
id|dev_info
(braket
id|nr_ad1816_devs
)braket
suffix:semicolon
multiline_comment|/* allocate i/o ports */
id|request_region
(paren
id|hw_config-&gt;io_base
comma
l_int|16
comma
l_string|&quot;AD1816 Sound&quot;
)paren
suffix:semicolon
id|devc-&gt;base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
multiline_comment|/* disable all interrupts */
id|ad_write
c_func
(paren
id|devc
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Clear pending interrupts */
id|outb
(paren
l_int|0
comma
id|devc-&gt;base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* allocate irq */
r_if
c_cond
(paren
id|hw_config-&gt;irq
template_param
l_int|15
)paren
(brace
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hw_config-&gt;irq
comma
id|ad1816_interrupt
comma
l_int|0
comma
l_string|&quot;SoundPort&quot;
comma
id|hw_config-&gt;osp
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;ad1816: IRQ in use&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|devc-&gt;irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
multiline_comment|/* DMA stuff */
r_if
c_cond
(paren
id|sound_alloc_dma
(paren
id|hw_config-&gt;dma
comma
l_string|&quot;Sound System&quot;
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;ad1816: Can&squot;t allocate DMA%d&bslash;n&quot;
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|hw_config-&gt;irq
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|devc-&gt;dma_playback
op_assign
id|hw_config-&gt;dma
suffix:semicolon
r_if
c_cond
(paren
id|hw_config-&gt;dma2
op_ne
op_minus
l_int|1
op_logical_and
id|hw_config-&gt;dma2
op_ne
id|hw_config-&gt;dma
)paren
(brace
r_if
c_cond
(paren
id|sound_alloc_dma
(paren
id|hw_config-&gt;dma2
comma
l_string|&quot;Sound System (capture)&quot;
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;ad1816: Can&squot;t allocate DMA%d&bslash;n&quot;
comma
id|hw_config-&gt;dma2
)paren
suffix:semicolon
id|sound_free_dma
c_func
(paren
id|hw_config-&gt;dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|hw_config-&gt;irq
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|devc-&gt;dma_capture
op_assign
id|hw_config-&gt;dma2
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
id|DMA_AUTOMODE
op_or
id|DMA_DUPLEX
suffix:semicolon
)brace
r_else
(brace
id|devc-&gt;dma_capture
op_assign
op_minus
l_int|1
suffix:semicolon
id|devc-&gt;audio_mode
op_assign
id|DMA_AUTOMODE
suffix:semicolon
)brace
id|sprintf
(paren
id|dev_name
comma
l_string|&quot;AD1816 audio driver&quot;
)paren
suffix:semicolon
id|conf_printf2
(paren
id|dev_name
comma
id|devc-&gt;base
comma
id|devc-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
)paren
suffix:semicolon
multiline_comment|/* register device */
r_if
c_cond
(paren
(paren
id|my_dev
op_assign
id|sound_install_audiodrv
(paren
id|AUDIO_DRIVER_VERSION
comma
id|dev_name
comma
op_amp
id|ad1816_audio_driver
comma
r_sizeof
(paren
r_struct
id|audio_driver
)paren
comma
id|devc-&gt;audio_mode
comma
id|ad_format_mask
comma
id|devc
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;ad1816: Can&squot;t install sound driver&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;dma_capture
op_ge
l_int|0
)paren
(brace
id|sound_free_dma
c_func
(paren
id|hw_config-&gt;dma2
)paren
suffix:semicolon
)brace
id|sound_free_dma
c_func
(paren
id|hw_config-&gt;dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|hw_config-&gt;irq
comma
id|hw_config-&gt;osp
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* fill rest of structure with reasonable default values */
id|irq2dev
(braket
id|hw_config-&gt;irq
)braket
op_assign
id|devc-&gt;dev_no
op_assign
id|my_dev
suffix:semicolon
id|devc-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;irq_ok
op_assign
l_int|0
suffix:semicolon
id|devc-&gt;osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
id|nr_ad1816_devs
op_increment
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|32
comma
l_int|0x80f0
)paren
suffix:semicolon
multiline_comment|/* sound system mode */
r_if
c_cond
(paren
id|options
op_amp
l_int|1
)paren
(brace
id|ad_write
c_func
(paren
id|devc
comma
l_int|33
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable all audiosources for dsp */
)brace
r_else
(brace
id|ad_write
c_func
(paren
id|devc
comma
l_int|33
comma
l_int|0x03f8
)paren
suffix:semicolon
multiline_comment|/* enable all audiosources for dsp */
)brace
id|ad_write
c_func
(paren
id|devc
comma
l_int|4
comma
l_int|0x8080
)paren
suffix:semicolon
multiline_comment|/* default values for volumes (muted)*/
id|ad_write
c_func
(paren
id|devc
comma
l_int|5
comma
l_int|0x8080
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|6
comma
l_int|0x8080
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|7
comma
l_int|0x8080
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|15
comma
l_int|0x8888
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|16
comma
l_int|0x8888
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|17
comma
l_int|0x8888
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|18
comma
l_int|0x8888
)paren
suffix:semicolon
id|ad_write
c_func
(paren
id|devc
comma
l_int|19
comma
l_int|0xc888
)paren
suffix:semicolon
multiline_comment|/* +20db mic active */
id|ad_write
c_func
(paren
id|devc
comma
l_int|14
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* Master volume unmuted */
id|ad_write
c_func
(paren
id|devc
comma
l_int|39
comma
l_int|0x009f
)paren
suffix:semicolon
multiline_comment|/* 3D effect on 0% phone out muted */
id|ad_write
c_func
(paren
id|devc
comma
l_int|44
comma
l_int|0x0080
)paren
suffix:semicolon
multiline_comment|/* everything on power, 3d enabled for d/a */
id|outb
c_func
(paren
l_int|0x10
comma
id|devc-&gt;base
op_plus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* set dma mode */
id|outb
c_func
(paren
l_int|0x10
comma
id|devc-&gt;base
op_plus
l_int|9
)paren
suffix:semicolon
multiline_comment|/* enable capture + playback interrupt */
id|ad_write
c_func
(paren
id|devc
comma
l_int|1
comma
l_int|0xc000
)paren
suffix:semicolon
multiline_comment|/* set mixer defaults */
id|ad1816_mixer_reset
(paren
id|devc
)paren
suffix:semicolon
multiline_comment|/* register mixer */
r_if
c_cond
(paren
(paren
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|mixer_dev
op_assign
id|sound_install_mixer
c_func
(paren
id|MIXER_DRIVER_VERSION
comma
id|dev_name
comma
op_amp
id|ad1816_mixer_operations
comma
r_sizeof
(paren
r_struct
id|mixer_operations
)paren
comma
id|devc
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|min_fragment
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|unload_card
r_static
r_void
id|__exit
id|unload_card
c_func
(paren
id|ad1816_info
op_star
id|devc
)paren
(brace
r_int
id|mixer
comma
id|dev
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|devc
op_ne
l_int|NULL
)paren
(brace
id|DEBUGLOG
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: Unloading card at base=%x&bslash;n&quot;
comma
id|devc-&gt;base
)paren
)paren
suffix:semicolon
id|dev
op_assign
id|devc-&gt;dev_no
suffix:semicolon
id|mixer
op_assign
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|mixer_dev
suffix:semicolon
multiline_comment|/* unreg mixer*/
r_if
c_cond
(paren
id|mixer
op_ge
l_int|0
)paren
(brace
id|sound_unload_mixerdev
c_func
(paren
id|mixer
)paren
suffix:semicolon
)brace
id|sound_unload_audiodev
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* free dma channels */
r_if
c_cond
(paren
id|devc-&gt;dma_capture
op_ge
l_int|0
)paren
(brace
id|sound_free_dma
c_func
(paren
id|devc-&gt;dma_capture
)paren
suffix:semicolon
)brace
multiline_comment|/* card wont get added if resources could not be allocated&n;&t;&t;   thus we need not ckeck if allocation was successful */
id|sound_free_dma
(paren
id|devc-&gt;dma_playback
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|devc-&gt;irq
comma
id|devc-&gt;osp
)paren
suffix:semicolon
id|release_region
(paren
id|devc-&gt;base
comma
l_int|16
)paren
suffix:semicolon
id|DEBUGLOG
(paren
id|printk
c_func
(paren
l_string|&quot;ad1816: Unloading card at base=%x was successful&bslash;n&quot;
comma
id|devc-&gt;base
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
l_string|&quot;ad1816: no device/card specified&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|variable|cfg
r_static
r_struct
id|address_info
id|cfg
suffix:semicolon
DECL|variable|io
r_static
r_int
id|__initdata
id|io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|__initdata
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma
r_static
r_int
id|__initdata
id|dma
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma2
r_static
r_int
id|__initdata
id|dma2
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#if defined CONFIG_ISAPNP || defined CONFIG_ISAPNP_MODULE
DECL|variable|ad1816_dev
r_struct
id|pci_dev
op_star
id|ad1816_dev
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|activated
r_static
r_int
id|activated
op_assign
l_int|1
suffix:semicolon
DECL|variable|isapnp
r_static
r_int
id|isapnp
op_assign
l_int|1
suffix:semicolon
DECL|variable|isapnpjump
r_static
r_int
id|isapnpjump
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|isapnp
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|isapnpjump
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#else
DECL|variable|isapnp
r_static
r_int
id|isapnp
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma2
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ad1816_clockfreq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|options
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#if defined CONFIG_ISAPNP || defined CONFIG_ISAPNP_MODULE
DECL|function|activate_dev
r_static
r_struct
id|pci_dev
op_star
id|activate_dev
c_func
(paren
r_char
op_star
id|devname
comma
r_char
op_star
id|resname
comma
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;active
)paren
(brace
id|activated
op_assign
l_int|0
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|dev
op_member_access_from_pointer
id|activate
c_func
(paren
id|dev
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ad1816: %s %s config failed (out of resources?)[%d]&bslash;n&quot;
comma
id|devname
comma
id|resname
comma
id|err
)paren
suffix:semicolon
id|dev
op_member_access_from_pointer
id|deactivate
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|dev
suffix:semicolon
)brace
DECL|function|ad1816_init_generic
r_static
r_struct
id|pci_dev
op_star
id|ad1816_init_generic
c_func
(paren
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pci_dev
op_star
id|card
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_if
c_cond
(paren
(paren
id|ad1816_dev
op_assign
id|isapnp_find_dev
c_func
(paren
id|bus
comma
id|card-&gt;vendor
comma
id|card-&gt;device
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|ad1816_dev
op_member_access_from_pointer
id|prepare
c_func
(paren
id|ad1816_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ad1816_dev
op_assign
id|activate_dev
c_func
(paren
l_string|&quot;Analog Devices 1816(A)&quot;
comma
l_string|&quot;ad1816&quot;
comma
id|ad1816_dev
)paren
)paren
)paren
(brace
id|hw_config-&gt;io_base
op_assign
id|ad1816_dev-&gt;resource
(braket
l_int|2
)braket
dot
id|start
suffix:semicolon
id|hw_config-&gt;irq
op_assign
id|ad1816_dev-&gt;irq_resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|hw_config-&gt;dma
op_assign
id|ad1816_dev-&gt;dma_resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|hw_config-&gt;dma2
op_assign
id|ad1816_dev-&gt;dma_resource
(braket
l_int|1
)braket
dot
id|start
suffix:semicolon
)brace
)brace
r_return
id|ad1816_dev
suffix:semicolon
)brace
r_static
r_struct
(brace
DECL|member|vendor
r_int
r_int
id|vendor
suffix:semicolon
DECL|member|function
r_int
r_int
id|function
suffix:semicolon
DECL|member|initfunc
r_struct
id|pci_dev
op_star
(paren
op_star
id|initfunc
)paren
(paren
r_struct
id|pci_bus
op_star
comma
r_struct
id|pci_dev
op_star
comma
r_struct
id|address_info
op_star
)paren
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|variable|__initdata
)brace
id|isapnp_ad1816_list
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|ISAPNP_VENDOR
c_func
(paren
l_char|&squot;A&squot;
comma
l_char|&squot;D&squot;
comma
l_char|&squot;S&squot;
)paren
comma
id|ISAPNP_FUNCTION
c_func
(paren
l_int|0x7150
)paren
comma
op_amp
id|ad1816_init_generic
comma
l_string|&quot;Analog Devices 1815&quot;
)brace
comma
(brace
id|ISAPNP_VENDOR
c_func
(paren
l_char|&squot;A&squot;
comma
l_char|&squot;D&squot;
comma
l_char|&squot;S&squot;
)paren
comma
id|ISAPNP_FUNCTION
c_func
(paren
l_int|0x7180
)paren
comma
op_amp
id|ad1816_init_generic
comma
l_string|&quot;Analog Devices 1816A&quot;
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|function|ad1816_init_isapnp
r_static
r_int
id|__init
id|ad1816_init_isapnp
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
comma
r_struct
id|pci_bus
op_star
id|bus
comma
r_struct
id|pci_dev
op_star
id|card
comma
r_int
id|slot
)paren
(brace
r_struct
id|pci_dev
op_star
id|idev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* You missed the init func? That&squot;s bad. */
r_if
c_cond
(paren
id|isapnp_ad1816_list
(braket
id|slot
)braket
dot
id|initfunc
)paren
(brace
r_char
op_star
id|busname
op_assign
id|bus-&gt;name
(braket
l_int|0
)braket
ques
c_cond
id|bus-&gt;name
suffix:colon
id|isapnp_ad1816_list
(braket
id|slot
)braket
dot
id|name
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ad1816: %s detected&bslash;n&quot;
comma
id|busname
)paren
suffix:semicolon
multiline_comment|/* Initialize this baby. */
r_if
c_cond
(paren
(paren
id|idev
op_assign
id|isapnp_ad1816_list
(braket
id|slot
)braket
dot
id|initfunc
c_func
(paren
id|bus
comma
id|card
comma
id|hw_config
)paren
)paren
)paren
(brace
multiline_comment|/* We got it. */
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ad1816: ISAPnP reports &squot;%s&squot; at i/o %#x, irq %d, dma %d, %d&bslash;n&quot;
comma
id|busname
comma
id|hw_config-&gt;io_base
comma
id|hw_config-&gt;irq
comma
id|hw_config-&gt;dma
comma
id|hw_config-&gt;dma2
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ad1816: Failed to initialize %s&bslash;n&quot;
comma
id|busname
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ad1816: Bad entry in ad1816.c PnP table&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Actually this routine will detect and configure only the first card with successful&n; * initialization. isapnpjump could be used to jump to a specific entry.&n; * Please always add entries at the end of the array.&n; * Should this be fixed? - azummo&n; */
DECL|function|ad1816_probe_isapnp
r_int
id|__init
id|ad1816_probe_isapnp
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Count entries in isapnp_ad1816_list */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|isapnp_ad1816_list
(braket
id|i
)braket
dot
id|vendor
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
multiline_comment|/* Check and adjust isapnpjump */
r_if
c_cond
(paren
id|isapnpjump
template_param
(paren
id|i
op_minus
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ad1816: Valid range for isapnpjump is 0-%d. Adjusted to 0.&bslash;n&quot;
comma
id|i
op_minus
l_int|1
)paren
suffix:semicolon
id|isapnpjump
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|isapnpjump
suffix:semicolon
id|isapnp_ad1816_list
(braket
id|i
)braket
dot
id|vendor
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|pci_dev
op_star
id|card
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|card
op_assign
id|isapnp_find_dev
c_func
(paren
l_int|NULL
comma
id|isapnp_ad1816_list
(braket
id|i
)braket
dot
id|vendor
comma
id|isapnp_ad1816_list
(braket
id|i
)braket
dot
id|function
comma
id|card
)paren
)paren
)paren
r_if
c_cond
(paren
id|ad1816_init_isapnp
c_func
(paren
id|hw_config
comma
id|card-&gt;bus
comma
id|card
comma
id|i
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#endif
DECL|function|init_ad1816
r_static
r_int
id|__init
id|init_ad1816
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined CONFIG_ISAPNP || defined CONFIG_ISAPNP_MODULE
r_if
c_cond
(paren
id|isapnp
op_logical_and
(paren
id|ad1816_probe_isapnp
c_func
(paren
op_amp
id|cfg
)paren
OL
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ad1816: No ISAPnP cards found, trying standard ones...&bslash;n&quot;
)paren
suffix:semicolon
id|isapnp
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|isapnp
op_eq
l_int|0
)paren
(brace
id|cfg.io_base
op_assign
id|io
suffix:semicolon
id|cfg.irq
op_assign
id|irq
suffix:semicolon
id|cfg.dma
op_assign
id|dma
suffix:semicolon
id|cfg.dma2
op_assign
id|dma2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cfg.io_base
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.irq
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.dma
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.dma2
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ad1816: dma, dma2, irq and io must be set.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|probe_ad1816
c_func
(paren
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|attach_ad1816
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_ad1816
r_static
r_void
id|__exit
id|cleanup_ad1816
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|ad1816_info
op_star
id|devc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* remove any soundcard */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_ad1816_devs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|devc
op_assign
op_amp
id|dev_info
(braket
id|i
)braket
suffix:semicolon
id|unload_card
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
id|nr_ad1816_devs
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined CONFIG_ISAPNP || defined CONFIG_ISAPNP_MODULE
r_if
c_cond
(paren
id|activated
)paren
r_if
c_cond
(paren
id|ad1816_dev
)paren
(brace
id|ad1816_dev
op_member_access_from_pointer
id|deactivate
c_func
(paren
id|ad1816_dev
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|variable|init_ad1816
id|module_init
c_func
(paren
id|init_ad1816
)paren
suffix:semicolon
DECL|variable|cleanup_ad1816
id|module_exit
c_func
(paren
id|cleanup_ad1816
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|setup_ad1816
r_static
r_int
id|__init
id|setup_ad1816
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/* io, irq, dma, dma2 */
r_int
id|ints
(braket
l_int|5
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|io
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|irq
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|dma
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|dma2
op_assign
id|ints
(braket
l_int|4
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;ad1816=&quot;
comma
id|setup_ad1816
)paren
suffix:semicolon
macro_line|#endif
eof
