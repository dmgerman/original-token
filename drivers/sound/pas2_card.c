multiline_comment|/*&n; * sound/pas2_card.c&n; *&n; * Detection routine for the Pro Audio Spectrum cards.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIG_PAS)
DECL|variable|dma_bits
r_static
r_int
r_char
id|dma_bits
(braket
)braket
op_assign
(brace
l_int|4
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|0
comma
l_int|5
comma
l_int|6
comma
l_int|7
)brace
suffix:semicolon
DECL|variable|irq_bits
r_static
r_int
r_char
id|irq_bits
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|0
comma
l_int|1
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
l_int|0
comma
l_int|10
comma
l_int|11
)brace
suffix:semicolon
DECL|variable|sb_irq_bits
r_static
r_int
r_char
id|sb_irq_bits
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x08
comma
l_int|0x10
comma
l_int|0x00
comma
l_int|0x18
comma
l_int|0x00
comma
l_int|0x20
comma
l_int|0x00
comma
l_int|0x08
comma
l_int|0x28
comma
l_int|0x30
comma
l_int|0x38
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|sb_dma_bits
r_static
r_int
r_char
id|sb_dma_bits
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x40
comma
l_int|0x80
comma
l_int|0xC0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n; * The Address Translation code is used to convert I/O register addresses to&n; * be relative to the given base -register&n; */
DECL|variable|translate_code
r_int
id|translate_code
suffix:semicolon
DECL|variable|pas_intr_mask
r_static
r_int
id|pas_intr_mask
op_assign
l_int|0
suffix:semicolon
DECL|variable|pas_irq
r_static
r_int
id|pas_irq
op_assign
l_int|0
suffix:semicolon
DECL|variable|pas_sb_base
r_static
r_int
id|pas_sb_base
op_assign
l_int|0
suffix:semicolon
DECL|variable|pas_model
r_char
id|pas_model
suffix:semicolon
DECL|variable|pas_model_names
r_static
r_char
op_star
id|pas_model_names
(braket
)braket
op_assign
(brace
l_string|&quot;&quot;
comma
l_string|&quot;Pro AudioSpectrum+&quot;
comma
l_string|&quot;CDPC&quot;
comma
l_string|&quot;Pro AudioSpectrum 16&quot;
comma
l_string|&quot;Pro AudioSpectrum 16D&quot;
)brace
suffix:semicolon
multiline_comment|/*&n; * pas_read() and pas_write() are equivalents of inb and outb &n; * These routines perform the I/O address translation required&n; * to support other than the default base address&n; */
r_extern
r_void
id|mix_write
(paren
r_int
r_char
id|data
comma
r_int
id|ioaddr
)paren
suffix:semicolon
r_int
r_char
DECL|function|pas_read
id|pas_read
(paren
r_int
id|ioaddr
)paren
(brace
r_return
id|inb
(paren
id|ioaddr
op_xor
id|translate_code
)paren
suffix:semicolon
)brace
r_void
DECL|function|pas_write
id|pas_write
(paren
r_int
r_char
id|data
comma
r_int
id|ioaddr
)paren
(brace
id|outb
(paren
(paren
id|data
)paren
comma
id|ioaddr
op_xor
id|translate_code
)paren
suffix:semicolon
)brace
multiline_comment|/******************* Begin of the Interrupt Handler ********************/
r_static
r_void
DECL|function|pasintr
id|pasintr
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|pas_read
(paren
l_int|0x0B89
)paren
suffix:semicolon
id|pas_write
(paren
id|status
comma
l_int|0x0B89
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x08
)paren
(brace
macro_line|#ifdef CONFIG_AUDIO
id|pas_pcm_interrupt
(paren
id|status
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|status
op_and_assign
op_complement
l_int|0x08
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
l_int|0x10
)paren
(brace
macro_line|#ifdef CONFIG_MIDI
id|pas_midi_interrupt
(paren
)paren
suffix:semicolon
macro_line|#endif
id|status
op_and_assign
op_complement
l_int|0x10
suffix:semicolon
)brace
)brace
r_int
DECL|function|pas_set_intr
id|pas_set_intr
(paren
r_int
id|mask
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mask
)paren
r_return
l_int|0
suffix:semicolon
id|pas_intr_mask
op_or_assign
id|mask
suffix:semicolon
id|pas_write
(paren
id|pas_intr_mask
comma
l_int|0x0B8B
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|pas_remove_intr
id|pas_remove_intr
(paren
r_int
id|mask
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mask
)paren
r_return
l_int|0
suffix:semicolon
id|pas_intr_mask
op_and_assign
op_complement
id|mask
suffix:semicolon
id|pas_write
(paren
id|pas_intr_mask
comma
l_int|0x0B8B
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************* End of the Interrupt handler **********************/
multiline_comment|/******************* Begin of the Initialization Code ******************/
r_static
r_int
DECL|function|config_pas_hw
id|config_pas_hw
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_char
id|ok
op_assign
l_int|1
suffix:semicolon
r_int
id|int_ptrs
suffix:semicolon
multiline_comment|/* scsi/sound interrupt pointers */
id|pas_irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|pas_write
(paren
l_int|0x00
comma
l_int|0x0B8B
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0x36
comma
l_int|0x138B
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0x36
comma
l_int|0x1388
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0
comma
l_int|0x1388
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0x74
comma
l_int|0x138B
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0x74
comma
l_int|0x1389
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0
comma
l_int|0x1389
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0x80
op_or
l_int|0x40
op_or
l_int|0x20
op_or
l_int|1
comma
l_int|0x0B8A
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0x80
op_or
l_int|0x20
op_or
l_int|0x10
op_or
l_int|0x08
op_or
l_int|0x01
comma
l_int|0xF8A
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0x01
op_or
l_int|0x02
op_or
l_int|0x04
op_or
l_int|0x10
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * |&n;&t;&t;&t;&t;&t;   * 0x80&n;&t;&t;&t;&t;&t; */
comma
l_int|0xB88
)paren
suffix:semicolon
id|pas_write
(paren
l_int|0x80
macro_line|#ifdef PAS_JOYSTICK_ENABLE
op_or
l_int|0x40
macro_line|#endif
comma
l_int|0xF388
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pas_irq
template_param
l_int|15
)paren
(brace
id|printk
(paren
l_string|&quot;PAS16: Invalid IRQ %d&quot;
comma
id|pas_irq
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|int_ptrs
op_assign
id|pas_read
(paren
l_int|0xF38A
)paren
suffix:semicolon
id|int_ptrs
op_or_assign
id|irq_bits
(braket
id|pas_irq
)braket
op_amp
l_int|0xf
suffix:semicolon
id|pas_write
(paren
id|int_ptrs
comma
l_int|0xF38A
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_bits
(braket
id|pas_irq
)braket
)paren
(brace
id|printk
(paren
l_string|&quot;PAS16: Invalid IRQ %d&quot;
comma
id|pas_irq
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|snd_set_irq_handler
(paren
id|pas_irq
comma
id|pasintr
comma
l_string|&quot;PAS16&quot;
comma
id|hw_config-&gt;osp
)paren
OL
l_int|0
)paren
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hw_config-&gt;dma
template_param
l_int|7
)paren
(brace
id|printk
(paren
l_string|&quot;PAS16: Invalid DMA selection %d&quot;
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|pas_write
(paren
id|dma_bits
(braket
id|hw_config-&gt;dma
)braket
comma
l_int|0xF389
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma_bits
(braket
id|hw_config-&gt;dma
)braket
)paren
(brace
id|printk
(paren
l_string|&quot;PAS16: Invalid DMA selection %d&quot;
comma
id|hw_config-&gt;dma
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sound_alloc_dma
(paren
id|hw_config-&gt;dma
comma
l_string|&quot;PAS16&quot;
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;pas2_card.c: Can&squot;t allocate DMA channel&bslash;n&quot;
)paren
suffix:semicolon
id|ok
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;     * This fixes the timing problems of the PAS due to the Symphony chipset&n;     * as per Media Vision.  Only define this if your PAS doesn&squot;t work correctly.&n;   */
macro_line|#ifdef SYMPHONY_PAS
id|outb
(paren
(paren
l_int|0x05
)paren
comma
l_int|0xa8
)paren
suffix:semicolon
id|outb
(paren
(paren
l_int|0x60
)paren
comma
l_int|0xa9
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef BROKEN_BUS_CLOCK
id|pas_write
(paren
l_int|0x01
op_or
l_int|0x10
op_or
l_int|0x20
op_or
l_int|0x04
comma
l_int|0x8388
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/*&n;   * pas_write(0x01, 0x8388);&n;   */
id|pas_write
(paren
l_int|0x01
op_or
l_int|0x10
op_or
l_int|0x20
comma
l_int|0x8388
)paren
suffix:semicolon
macro_line|#endif
id|pas_write
(paren
l_int|0x18
comma
l_int|0x838A
)paren
suffix:semicolon
multiline_comment|/* ??? */
id|pas_write
(paren
l_int|0x20
op_or
l_int|0x01
comma
l_int|0x0B8A
)paren
suffix:semicolon
multiline_comment|/* Mute off, filter = 17.897 kHz */
id|pas_write
(paren
l_int|8
comma
l_int|0xBF8A
)paren
suffix:semicolon
id|mix_write
(paren
l_int|0x80
op_or
l_int|5
comma
l_int|0x078B
)paren
suffix:semicolon
id|mix_write
(paren
l_int|5
comma
l_int|0x078B
)paren
suffix:semicolon
macro_line|#if !defined(DISABLE_SB_EMULATION) &amp;&amp; defined(CONFIG_SB)
(brace
r_struct
id|address_info
op_star
id|sb_config
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sb_config
op_assign
id|sound_getconf
(paren
id|SNDCARD_SB
)paren
)paren
)paren
(brace
r_int
r_char
id|irq_dma
suffix:semicolon
multiline_comment|/*&n;&t; * Turn on Sound Blaster compatibility&n;&t; * bit 1 = SB emulation&n;&t; * bit 0 = MPU401 emulation (CDPC only :-( )&n;&t; */
id|pas_write
(paren
l_int|0x02
comma
l_int|0xF788
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * &quot;Emulation address&quot;&n;&t; */
id|pas_write
(paren
(paren
id|sb_config-&gt;io_base
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
comma
l_int|0xF789
)paren
suffix:semicolon
id|pas_sb_base
op_assign
id|sb_config-&gt;io_base
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dma_bits
(braket
id|sb_config-&gt;dma
)braket
)paren
id|printk
(paren
l_string|&quot;&bslash;n&bslash;nPAS16 Warning: Invalid SB DMA %d&bslash;n&bslash;n&quot;
comma
id|sb_config-&gt;dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_bits
(braket
id|sb_config-&gt;irq
)braket
)paren
id|printk
(paren
l_string|&quot;&bslash;n&bslash;nPAS16 Warning: Invalid SB IRQ %d&bslash;n&bslash;n&quot;
comma
id|sb_config-&gt;irq
)paren
suffix:semicolon
id|irq_dma
op_assign
id|sb_dma_bits
(braket
id|sb_config-&gt;dma
)braket
op_or
id|sb_irq_bits
(braket
id|sb_config-&gt;irq
)braket
suffix:semicolon
id|pas_write
(paren
id|irq_dma
comma
l_int|0xFB8A
)paren
suffix:semicolon
)brace
r_else
id|pas_write
(paren
l_int|0x00
comma
l_int|0xF788
)paren
suffix:semicolon
)brace
macro_line|#else
id|pas_write
(paren
l_int|0x00
comma
l_int|0xF788
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
id|printk
(paren
l_string|&quot;PAS16: Driver not enabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ok
suffix:semicolon
)brace
r_static
r_int
DECL|function|detect_pas_hw
id|detect_pas_hw
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|board_id
comma
id|foo
suffix:semicolon
multiline_comment|/*&n;   * WARNING: Setting an option like W:1 or so that disables warm boot reset&n;   * of the card will screw up this detect code something fierce. Adding code&n;   * to handle this means possibly interfering with other cards on the bus if&n;   * you have something on base port 0x388. SO be forewarned.&n;   */
id|outb
(paren
(paren
l_int|0xBC
)paren
comma
l_int|0x9A01
)paren
suffix:semicolon
multiline_comment|/* Activate first board */
id|outb
(paren
(paren
id|hw_config-&gt;io_base
op_rshift
l_int|2
)paren
comma
l_int|0x9A01
)paren
suffix:semicolon
multiline_comment|/* Set base address */
id|translate_code
op_assign
l_int|0x388
op_xor
id|hw_config-&gt;io_base
suffix:semicolon
id|pas_write
(paren
l_int|1
comma
l_int|0xBF88
)paren
suffix:semicolon
multiline_comment|/* Select one wait states */
id|board_id
op_assign
id|pas_read
(paren
l_int|0x0B8B
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board_id
op_eq
l_int|0xff
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;   * We probably have a PAS-series board, now check for a PAS16-series board&n;   * by trying to change the board revision bits. PAS16-series hardware won&squot;t&n;   * let you do this - the bits are read-only.&n;   */
id|foo
op_assign
id|board_id
op_xor
l_int|0xe0
suffix:semicolon
id|pas_write
(paren
id|foo
comma
l_int|0x0B8B
)paren
suffix:semicolon
id|foo
op_assign
id|pas_read
(paren
l_int|0x0B8B
)paren
suffix:semicolon
id|pas_write
(paren
id|board_id
comma
l_int|0x0B8B
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board_id
op_ne
id|foo
)paren
r_return
l_int|0
suffix:semicolon
id|pas_model
op_assign
id|pas_read
(paren
l_int|0xFF88
)paren
suffix:semicolon
r_return
id|pas_model
suffix:semicolon
)brace
r_void
DECL|function|attach_pas_card
id|attach_pas_card
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|pas_irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|detect_pas_hw
(paren
id|hw_config
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|pas_model
op_assign
id|pas_read
(paren
l_int|0xFF88
)paren
)paren
)paren
(brace
r_char
id|temp
(braket
l_int|100
)braket
suffix:semicolon
id|sprintf
(paren
id|temp
comma
l_string|&quot;%s rev %d&quot;
comma
id|pas_model_names
(braket
(paren
r_int
)paren
id|pas_model
)braket
comma
id|pas_read
(paren
l_int|0x2789
)paren
)paren
suffix:semicolon
id|conf_printf
(paren
id|temp
comma
id|hw_config
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|config_pas_hw
(paren
id|hw_config
)paren
)paren
(brace
macro_line|#ifdef CONFIG_AUDIO
id|pas_pcm_init
(paren
id|hw_config
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if !defined(DISABLE_SB_EMULATION) &amp;&amp; defined(CONFIG_SB)
id|sb_dsp_disable_midi
(paren
id|pas_sb_base
)paren
suffix:semicolon
multiline_comment|/* No MIDI capability */
macro_line|#endif
macro_line|#ifdef CONFIG_MIDI
id|pas_midi_init
(paren
)paren
suffix:semicolon
macro_line|#endif
id|pas_init_mixer
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_int
DECL|function|probe_pas
id|probe_pas
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_return
id|detect_pas_hw
(paren
id|hw_config
)paren
suffix:semicolon
)brace
r_void
DECL|function|unload_pas
id|unload_pas
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|sound_free_dma
(paren
id|hw_config-&gt;dma
)paren
suffix:semicolon
id|snd_release_irq
(paren
id|hw_config-&gt;irq
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
