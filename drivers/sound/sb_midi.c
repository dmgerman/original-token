multiline_comment|/*&n; * sound/sb_dsp.c&n; *&n; * The low level driver for the SoundBlaster DS chips.&n; *&n; * Copyright by Hannu Savolainen 1993&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_SB) &amp;&amp; !defined(EXCLUDE_MIDI)
macro_line|#include &quot;sb.h&quot;
DECL|macro|SB_TEST_IRQ
macro_line|#undef SB_TEST_IRQ
multiline_comment|/*&n; * The DSP channel can be used either for input or output. Variable&n; * &squot;sb_irq_mode&squot; will be set when the program calls read or write first time&n; * after open. Current version doesn&squot;t support mode changes without closing&n; * and reopening the device. Support for this feature may be implemented in a&n; * future version of this driver.&n; */
r_extern
r_int
id|sb_dsp_ok
suffix:semicolon
multiline_comment|/* Set to 1 after successful initialization */
r_extern
r_int
id|sb_midi_mode
suffix:semicolon
r_extern
r_int
id|sb_midi_busy
suffix:semicolon
multiline_comment|/* 1 if the process has output to MIDI */
r_extern
r_int
id|sb_dsp_busy
suffix:semicolon
r_extern
r_int
id|sb_dsp_highspeed
suffix:semicolon
r_extern
r_volatile
r_int
id|sb_irq_mode
suffix:semicolon
multiline_comment|/* IMODE_INPUT, IMODE_OUTPUT&n;&n;&t;&t;&t;&t;&t; * or IMODE_NONE */
r_extern
r_int
id|sb_duplex_midi
suffix:semicolon
r_extern
r_int
id|sb_intr_active
suffix:semicolon
r_extern
r_int
id|sbc_base
suffix:semicolon
DECL|variable|input_opened
r_static
r_int
id|input_opened
op_assign
l_int|0
suffix:semicolon
DECL|variable|midi_input_intr
r_static
r_void
(paren
op_star
id|midi_input_intr
)paren
(paren
r_int
id|dev
comma
r_int
r_char
id|data
)paren
suffix:semicolon
DECL|variable|my_dev
r_static
r_int
id|my_dev
op_assign
l_int|0
suffix:semicolon
r_static
r_int
DECL|function|sb_midi_open
id|sb_midi_open
(paren
r_int
id|dev
comma
r_int
id|mode
comma
r_void
(paren
op_star
id|input
)paren
(paren
r_int
id|dev
comma
r_int
r_char
id|data
)paren
comma
r_void
(paren
op_star
id|output
)paren
(paren
r_int
id|dev
)paren
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: MIDI hardware not installed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mode
op_ne
id|OPEN_WRITE
op_logical_and
op_logical_neg
id|sb_duplex_midi
)paren
(brace
r_if
c_cond
(paren
id|num_midis
op_eq
l_int|1
)paren
id|printk
(paren
l_string|&quot;SoundBlaster: MIDI input not supported with plain SB&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EPERM
)paren
suffix:semicolon
)brace
id|sb_midi_mode
op_assign
id|NORMAL_MIDI
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
id|OPEN_WRITE
)paren
(brace
r_if
c_cond
(paren
id|sb_dsp_busy
op_logical_or
id|sb_intr_active
)paren
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
id|sb_midi_mode
op_assign
id|UART_MIDI
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb_dsp_highspeed
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: Midi output not possible during stereo or high speed audio&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb_midi_mode
op_eq
id|UART_MIDI
)paren
(brace
id|sb_irq_mode
op_assign
id|IMODE_MIDI
suffix:semicolon
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
(paren
l_int|0xf2
)paren
)paren
multiline_comment|/* This is undodumented, isn&squot;t it */
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
multiline_comment|/* be nice to DSP */
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
(paren
l_int|0x35
)paren
)paren
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Enter the UART mode */
id|sb_intr_active
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|sb_get_irq
(paren
)paren
)paren
OL
l_int|0
)paren
(brace
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* IRQ not free */
)brace
id|input_opened
op_assign
l_int|1
suffix:semicolon
id|my_dev
op_assign
id|dev
suffix:semicolon
id|midi_input_intr
op_assign
id|input
suffix:semicolon
)brace
id|sb_midi_busy
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_midi_close
id|sb_midi_close
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|sb_midi_mode
op_eq
id|UART_MIDI
)paren
(brace
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
multiline_comment|/* The only way to kill the UART mode */
id|sb_free_irq
(paren
)paren
suffix:semicolon
)brace
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|sb_midi_busy
op_assign
l_int|0
suffix:semicolon
id|input_opened
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_midi_out
id|sb_midi_out
(paren
r_int
id|dev
comma
r_int
r_char
id|midi_byte
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|sb_midi_busy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Kill all notes after close */
r_if
c_cond
(paren
id|sb_midi_mode
op_eq
id|NORMAL_MIDI
)paren
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x38
)paren
)paren
id|sb_dsp_command
(paren
id|midi_byte
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to send a MIDI byte&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
id|sb_dsp_command
(paren
id|midi_byte
)paren
suffix:semicolon
multiline_comment|/* UART write */
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_midi_start_read
id|sb_midi_start_read
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|sb_midi_mode
op_ne
id|UART_MIDI
)paren
(brace
id|printk
(paren
l_string|&quot;SoundBlaster: MIDI input not implemented.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EPERM
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_midi_end_read
id|sb_midi_end_read
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|sb_midi_mode
op_eq
id|UART_MIDI
)paren
(brace
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_midi_ioctl
id|sb_midi_ioctl
(paren
r_int
id|dev
comma
r_int
id|cmd
comma
r_int
id|arg
)paren
(brace
r_return
id|RET_ERROR
(paren
id|EPERM
)paren
suffix:semicolon
)brace
r_void
DECL|function|sb_midi_interrupt
id|sb_midi_interrupt
(paren
r_int
id|dummy
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|data
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|data
op_assign
id|INB
(paren
id|DSP_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input_opened
)paren
id|midi_input_intr
(paren
id|my_dev
comma
id|data
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|sb_midi_operations
r_static
r_struct
id|midi_operations
id|sb_midi_operations
op_assign
(brace
(brace
l_string|&quot;SoundBlaster&quot;
comma
l_int|0
comma
l_int|0
comma
id|SNDCARD_SB
)brace
comma
id|sb_midi_open
comma
id|sb_midi_close
comma
id|sb_midi_ioctl
comma
id|sb_midi_out
comma
id|sb_midi_start_read
comma
id|sb_midi_end_read
comma
l_int|NULL
comma
multiline_comment|/* Kick */
l_int|NULL
comma
multiline_comment|/* command */
l_int|NULL
multiline_comment|/* buffer_status */
)brace
suffix:semicolon
r_void
DECL|function|sb_midi_init
id|sb_midi_init
(paren
r_int
id|model
)paren
(brace
id|midi_devs
(braket
id|num_midis
op_increment
)braket
op_assign
op_amp
id|sb_midi_operations
suffix:semicolon
)brace
macro_line|#endif
eof
