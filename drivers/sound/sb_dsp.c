multiline_comment|/*&n; * sound/sb_dsp.c&n; *&n; * The low level driver for the SoundBlaster DSP chip (SB1.0 to 2.1, SB Pro).&n; */
multiline_comment|/*&n; * Copyright by Hannu Savolainen 1993-1996&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; */
macro_line|#include &lt;linux/config.h&gt;
multiline_comment|/*&n; * Modified:&n; *      Hunyue Yau      Jan 6 1994&n; *      Added code to support Sound Galaxy NX Pro&n; *&n; *      JRA Gibson      April 1995&n; *      Code added for MV ProSonic/Jazz 16 in 16 bit mode&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIG_SB)
macro_line|#include &quot;sb.h&quot;
macro_line|#include &quot;sb_mixer.h&quot;
DECL|macro|SB_TEST_IRQ
macro_line|#undef SB_TEST_IRQ
DECL|variable|sbc_base
r_int
id|sbc_base
op_assign
l_int|0
suffix:semicolon
DECL|variable|sbc_irq
DECL|variable|sbc_dma
r_static
r_int
id|sbc_irq
op_assign
l_int|0
comma
id|sbc_dma
suffix:semicolon
DECL|variable|open_mode
r_static
r_int
id|open_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Read, write or both */
DECL|variable|Jazz16_detected
r_int
id|Jazz16_detected
op_assign
l_int|0
suffix:semicolon
DECL|variable|AudioDrive
r_int
id|AudioDrive
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 1=ES1688 detected */
DECL|variable|ess_mpu_irq
r_static
r_int
id|ess_mpu_irq
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_no_recording
r_int
id|sb_no_recording
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_count
r_static
r_int
id|dsp_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|trigger_bits
r_static
r_int
id|trigger_bits
suffix:semicolon
DECL|variable|mpu_base
DECL|variable|mpu_irq
r_static
r_int
id|mpu_base
op_assign
l_int|0
comma
id|mpu_irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * The DSP channel can be used either for input or output. Variable&n; * &squot;sb_irq_mode&squot; will be set when the program calls read or write first time&n; * after open. Current version doesn&squot;t support mode changes without closing&n; * and reopening the device. Support for this feature may be implemented in a&n; * future version of this driver.&n; */
DECL|variable|sb_dsp_ok
r_int
id|sb_dsp_ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&n;&n;&t;&t;&t;&t; * *  * * Set to 1 after successful&n;&t;&t;&t;&t; * initialization  *  */
DECL|variable|midi_disabled
r_static
r_int
id|midi_disabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_dsp_highspeed
r_int
id|sb_dsp_highspeed
op_assign
l_int|0
suffix:semicolon
DECL|variable|sbc_major
DECL|variable|sbc_minor
r_int
id|sbc_major
op_assign
l_int|0
comma
id|sbc_minor
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_stereo
r_static
r_int
id|dsp_stereo
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_current_speed
r_static
r_int
id|dsp_current_speed
op_assign
id|DSP_DEFAULT_SPEED
suffix:semicolon
DECL|variable|sb16
r_static
r_int
id|sb16
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq_verified
r_static
r_int
id|irq_verified
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_midi_mode
r_int
id|sb_midi_mode
op_assign
id|NORMAL_MIDI
suffix:semicolon
DECL|variable|sb_midi_busy
r_int
id|sb_midi_busy
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_dsp_busy
r_int
id|sb_dsp_busy
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_irq_mode
r_volatile
r_int
id|sb_irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
DECL|variable|irq_ok
r_static
r_volatile
r_int
id|irq_ok
op_assign
l_int|0
suffix:semicolon
DECL|variable|dma8
r_static
r_int
id|dma8
op_assign
l_int|1
suffix:semicolon
DECL|variable|dsp_16bit
r_static
r_int
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 16 bit support&n; */
DECL|variable|dma16
r_static
r_int
id|dma16
op_assign
l_int|1
suffix:semicolon
r_static
r_int
id|dsp_set_bits
(paren
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|initialize_ProSonic16
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* end of 16 bit support&n; */
DECL|variable|sb_duplex_midi
r_int
id|sb_duplex_midi
op_assign
l_int|0
suffix:semicolon
DECL|variable|my_dev
r_static
r_int
id|my_dev
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_intr_active
r_volatile
r_int
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|dsp_speed
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|dsp_set_stereo
(paren
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|sb_dsp_reset
(paren
r_int
id|dev
)paren
suffix:semicolon
r_static
r_void
id|dsp_get_vers
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
suffix:semicolon
DECL|variable|sb_osp
r_int
op_star
id|sb_osp
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if defined(CONFIG_MIDI) || defined(CONFIG_AUDIO)
multiline_comment|/*&n; * Common code for the midi and pcm functions&n; */
r_int
DECL|function|sb_dsp_command
id|sb_dsp_command
(paren
r_int
r_char
id|val
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|limit
suffix:semicolon
id|limit
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;   * The timeout is 0.1 secods&n;&t;&t;&t;&t; */
multiline_comment|/*&n;   * Note! the i&lt;500000 is an emergency exit. The sb_dsp_command() is sometimes&n;   * called while interrupts are disabled. This means that the timer is&n;   * disabled also. However the timeout situation is a abnormal condition.&n;   * Normally the DSP should be ready to accept commands after just couple of&n;   * loops.&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|500000
op_logical_and
id|jiffies
OL
id|limit
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb
(paren
id|DSP_STATUS
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
id|outb
(paren
id|val
comma
id|DSP_COMMAND
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;SoundBlaster: DSP Command(%x) Timeout.&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ess_write
id|ess_write
(paren
r_int
r_char
id|reg
comma
r_int
r_char
id|data
)paren
(brace
multiline_comment|/* Write a byte to an extended mode register of ES1688 */
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
(paren
id|reg
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|sb_dsp_command
(paren
id|data
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ess_read
id|ess_read
(paren
r_int
r_char
id|reg
)paren
(brace
multiline_comment|/* Read a byte from an extended mode register of ES1688 */
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
(paren
l_int|0xc0
)paren
)paren
multiline_comment|/* Read register command */
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
(paren
id|reg
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
r_return
id|inb
(paren
id|DSP_READ
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_void
DECL|function|sbintr
id|sbintr
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|dummy
)paren
(brace
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|sb16
op_logical_and
op_logical_neg
id|AudioDrive
)paren
(brace
r_int
r_char
id|src
op_assign
id|sb_getmixer
(paren
id|IRQ_STAT
)paren
suffix:semicolon
multiline_comment|/* Interrupt source register */
r_if
c_cond
(paren
id|src
op_amp
l_int|3
)paren
id|sb16_dsp_interrupt
(paren
id|irq
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MIDI
r_if
c_cond
(paren
id|src
op_amp
l_int|4
)paren
id|sb16midiintr
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * SB MPU401 interrupt&n;&t;&t;&t;&t; */
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|src
op_amp
l_int|1
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Not a DSP interupt&n;&t;&t;&t;&t; */
)brace
id|status
op_assign
id|inb
(paren
id|DSP_DATA_AVAIL
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * Clear interrupt&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|sb_intr_active
)paren
r_switch
c_cond
(paren
id|sb_irq_mode
)paren
(brace
r_case
id|IMODE_OUTPUT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|AudioDrive
)paren
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_outputintr
(paren
id|my_dev
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INPUT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|AudioDrive
)paren
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_inputintr
(paren
id|my_dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INIT
suffix:colon
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|irq_ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_MIDI
suffix:colon
macro_line|#ifdef CONFIG_MIDI
id|sb_midi_interrupt
(paren
id|irq
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;SoundBlaster: Unexpected interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|sb_get_irq
id|sb_get_irq
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|sb_free_irq
id|sb_free_irq
(paren
r_void
)paren
(brace
)brace
r_int
DECL|function|sb_reset_dsp
id|sb_reset_dsp
(paren
r_void
)paren
(brace
r_int
id|loopc
suffix:semicolon
r_if
c_cond
(paren
id|AudioDrive
)paren
id|outb
(paren
l_int|3
comma
id|DSP_RESET
)paren
suffix:semicolon
multiline_comment|/* Reset FIFO too */
r_else
id|outb
(paren
l_int|1
comma
id|DSP_RESET
)paren
suffix:semicolon
id|tenmicrosec
(paren
id|sb_osp
)paren
suffix:semicolon
id|outb
(paren
l_int|0
comma
id|DSP_RESET
)paren
suffix:semicolon
id|tenmicrosec
(paren
id|sb_osp
)paren
suffix:semicolon
id|tenmicrosec
(paren
id|sb_osp
)paren
suffix:semicolon
id|tenmicrosec
(paren
id|sb_osp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loopc
op_assign
l_int|0
suffix:semicolon
id|loopc
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|inb
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
suffix:semicolon
id|loopc
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
(paren
id|DSP_READ
)paren
op_ne
l_int|0xAA
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Sorry */
r_if
c_cond
(paren
id|AudioDrive
)paren
id|sb_dsp_command
(paren
l_int|0xc6
)paren
suffix:semicolon
multiline_comment|/* Enable extended mode */
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_AUDIO
r_static
r_void
DECL|function|dsp_speaker
id|dsp_speaker
(paren
r_char
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
id|sb_dsp_command
(paren
id|DSP_CMD_SPKON
)paren
suffix:semicolon
r_else
id|sb_dsp_command
(paren
id|DSP_CMD_SPKOFF
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ess_speed
id|ess_speed
(paren
r_int
id|speed
)paren
(brace
r_int
id|divider
suffix:semicolon
r_int
r_char
id|bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|speed
OL
l_int|4000
)paren
id|speed
op_assign
l_int|4000
suffix:semicolon
r_else
r_if
c_cond
(paren
id|speed
OG
l_int|48000
)paren
id|speed
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
l_int|22000
)paren
(brace
id|bits
op_assign
l_int|0x80
suffix:semicolon
id|divider
op_assign
l_int|256
op_minus
(paren
l_int|795500
op_plus
id|speed
op_div
l_int|2
)paren
op_div
id|speed
suffix:semicolon
id|dsp_current_speed
op_assign
l_int|795500
op_div
(paren
l_int|256
op_minus
id|divider
)paren
suffix:semicolon
)brace
r_else
(brace
id|divider
op_assign
l_int|128
op_minus
(paren
l_int|397700
op_plus
id|speed
op_div
l_int|2
)paren
op_div
id|speed
suffix:semicolon
id|dsp_current_speed
op_assign
l_int|397700
op_div
(paren
l_int|128
op_minus
id|divider
)paren
suffix:semicolon
)brace
id|bits
op_or_assign
(paren
r_int
r_char
)paren
id|divider
suffix:semicolon
id|ess_write
(paren
l_int|0xa1
comma
id|bits
)paren
suffix:semicolon
multiline_comment|/*&n; * Set filter divider register&n; */
id|speed
op_assign
(paren
id|speed
op_star
l_int|9
)paren
op_div
l_int|20
suffix:semicolon
multiline_comment|/* Set filter rolloff to 90% of speed/2 */
id|divider
op_assign
l_int|256
op_minus
l_int|7160000
op_div
(paren
id|speed
op_star
l_int|82
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xa2
comma
id|divider
)paren
suffix:semicolon
r_return
id|dsp_current_speed
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_speed
id|dsp_speed
(paren
r_int
id|speed
)paren
(brace
r_int
r_char
id|tconst
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|max_speed
op_assign
l_int|44100
suffix:semicolon
r_if
c_cond
(paren
id|AudioDrive
)paren
r_return
id|ess_speed
(paren
id|speed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|speed
OL
l_int|4000
)paren
id|speed
op_assign
l_int|4000
suffix:semicolon
multiline_comment|/*&n;     * Older SB models don&squot;t support higher speeds than 22050.&n;   */
r_if
c_cond
(paren
id|sbc_major
OL
l_int|2
op_logical_or
(paren
id|sbc_major
op_eq
l_int|2
op_logical_and
id|sbc_minor
op_eq
l_int|0
)paren
)paren
id|max_speed
op_assign
l_int|22050
suffix:semicolon
multiline_comment|/*&n;     * SB models earlier than SB Pro have low limit for the input speed.&n;   */
r_if
c_cond
(paren
id|open_mode
op_ne
id|OPEN_WRITE
)paren
multiline_comment|/* Recording is possible */
r_if
c_cond
(paren
id|sbc_major
OL
l_int|3
)paren
multiline_comment|/* Limited input speed with these cards */
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|2
op_logical_and
id|sbc_minor
OG
l_int|0
)paren
id|max_speed
op_assign
l_int|15000
suffix:semicolon
r_else
id|max_speed
op_assign
l_int|13000
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
id|max_speed
)paren
id|speed
op_assign
id|max_speed
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Invalid speed&n;&t;&t;&t;&t; */
multiline_comment|/* Logitech SoundMan Games and Jazz16 cards can support 44.1kHz stereo */
macro_line|#if !defined (SM_GAMES)
multiline_comment|/*&n;   * Max. stereo speed is 22050&n;   */
r_if
c_cond
(paren
id|dsp_stereo
op_logical_and
id|speed
OG
l_int|22050
op_logical_and
id|Jazz16_detected
op_eq
l_int|0
op_logical_and
id|AudioDrive
op_eq
l_int|0
)paren
id|speed
op_assign
l_int|22050
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|speed
OG
l_int|22050
)paren
op_logical_and
id|sb_midi_busy
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: High speed DSP not possible simultaneously with MIDI output&bslash;n&quot;
)paren
suffix:semicolon
id|speed
op_assign
l_int|22050
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|speed
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/*&n;   * Now the speed should be valid&n;   */
r_if
c_cond
(paren
id|speed
OG
l_int|22050
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * High speed mode&n;&t;&t;&t;&t; */
r_int
id|tmp
suffix:semicolon
id|tconst
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
l_int|65536
op_minus
(paren
(paren
l_int|256000000
op_plus
id|speed
op_div
l_int|2
)paren
op_div
id|speed
)paren
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sb_dsp_highspeed
op_assign
l_int|1
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x40
)paren
)paren
id|sb_dsp_command
(paren
id|tconst
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
l_int|65536
op_minus
(paren
id|tconst
op_lshift
l_int|8
)paren
suffix:semicolon
id|speed
op_assign
(paren
l_int|256000000
op_plus
id|tmp
op_div
l_int|2
)paren
op_div
id|tmp
suffix:semicolon
)brace
r_else
(brace
r_int
id|tmp
suffix:semicolon
id|sb_dsp_highspeed
op_assign
l_int|0
suffix:semicolon
id|tconst
op_assign
(paren
l_int|256
op_minus
(paren
(paren
l_int|1000000
op_plus
id|speed
op_div
l_int|2
)paren
op_div
id|speed
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x40
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Set time constant&n;&t;&t;&t;&t;&t; */
id|sb_dsp_command
(paren
id|tconst
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
l_int|256
op_minus
id|tconst
suffix:semicolon
id|speed
op_assign
(paren
l_int|1000000
op_plus
id|tmp
op_div
l_int|2
)paren
op_div
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|speed
op_div_assign
l_int|2
suffix:semicolon
id|dsp_current_speed
op_assign
id|speed
suffix:semicolon
r_return
id|speed
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_set_stereo
id|dsp_set_stereo
(paren
r_int
id|mode
)paren
(brace
id|dsp_stereo
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
OL
l_int|3
op_logical_or
id|sb16
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Sorry no stereo&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|mode
op_logical_and
id|sb_midi_busy
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: Stereo DSP not possible simultaneously with MIDI output&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dsp_stereo
op_assign
op_logical_neg
op_logical_neg
id|mode
suffix:semicolon
r_return
id|dsp_stereo
suffix:semicolon
)brace
DECL|variable|trg_buf
r_static
r_int
r_int
id|trg_buf
suffix:semicolon
DECL|variable|trg_bytes
r_static
r_int
id|trg_bytes
suffix:semicolon
DECL|variable|trg_intrflag
r_static
r_int
id|trg_intrflag
suffix:semicolon
DECL|variable|trg_restart
r_static
r_int
id|trg_restart
suffix:semicolon
r_static
r_void
DECL|function|sb_dsp_output_block
id|sb_dsp_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|nr_bytes
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
id|trg_buf
op_assign
id|buf
suffix:semicolon
id|trg_bytes
op_assign
id|nr_bytes
suffix:semicolon
id|trg_intrflag
op_assign
id|intrflag
suffix:semicolon
id|trg_restart
op_assign
id|restart_dma
suffix:semicolon
id|sb_irq_mode
op_assign
id|IMODE_OUTPUT
suffix:semicolon
)brace
r_static
r_void
DECL|function|actually_output_block
id|actually_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|nr_bytes
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
op_assign
id|nr_bytes
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_mode
)paren
id|dsp_speaker
(paren
id|ON
)paren
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
id|sb_irq_mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan1
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
id|count
op_decrement
suffix:semicolon
id|dsp_count
op_assign
id|count
suffix:semicolon
id|sb_irq_mode
op_assign
id|IMODE_OUTPUT
suffix:semicolon
r_if
c_cond
(paren
id|AudioDrive
)paren
(brace
r_int
id|c
op_assign
op_minus
id|nr_bytes
suffix:semicolon
id|ess_write
(paren
l_int|0xa4
comma
(paren
r_int
r_char
)paren
(paren
(paren
r_int
r_int
)paren
id|c
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xa5
comma
(paren
r_int
r_char
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|c
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb8
comma
id|ess_read
(paren
l_int|0xb8
)paren
op_or
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Go */
)brace
r_else
r_if
c_cond
(paren
id|sb_dsp_highspeed
)paren
(brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x48
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * High speed size&n;&t;&t;&t;&t;&t; */
(brace
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|dsp_count
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|dsp_count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0x91
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * High speed 8 bit DAC&n;&t;&t;&t;&t;&t; */
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start (high speed) DAC&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x14
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * 8-bit DAC (DMA)&n;&t;&t;&t;&t;&t; */
(brace
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|dsp_count
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|dsp_count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start DAC&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
id|sb_intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_start_input
id|sb_dsp_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
r_if
c_cond
(paren
id|sb_no_recording
)paren
(brace
r_return
suffix:semicolon
)brace
id|trg_buf
op_assign
id|buf
suffix:semicolon
id|trg_bytes
op_assign
id|count
suffix:semicolon
id|trg_intrflag
op_assign
id|intrflag
suffix:semicolon
id|trg_restart
op_assign
id|restart_dma
suffix:semicolon
id|sb_irq_mode
op_assign
id|IMODE_INPUT
suffix:semicolon
)brace
r_static
r_void
DECL|function|actually_start_input
id|actually_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|nr_bytes
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
op_assign
id|nr_bytes
suffix:semicolon
r_if
c_cond
(paren
id|sb_no_recording
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;   * Start a DMA input to the buffer pointed by dmaqtail&n;   */
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_mode
)paren
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
id|sb_irq_mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan1
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
id|count
op_decrement
suffix:semicolon
id|dsp_count
op_assign
id|count
suffix:semicolon
id|sb_irq_mode
op_assign
id|IMODE_INPUT
suffix:semicolon
r_if
c_cond
(paren
id|AudioDrive
)paren
(brace
r_int
id|c
op_assign
op_minus
id|nr_bytes
suffix:semicolon
id|ess_write
(paren
l_int|0xa4
comma
(paren
r_int
r_char
)paren
(paren
(paren
r_int
r_int
)paren
id|c
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xa5
comma
(paren
r_int
r_char
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|c
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb8
comma
id|ess_read
(paren
l_int|0xb8
)paren
op_or
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Go */
)brace
r_else
r_if
c_cond
(paren
id|sb_dsp_highspeed
)paren
(brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x48
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * High speed size&n;&t;&t;&t;&t;&t; */
(brace
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|dsp_count
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|dsp_count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0x99
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * High speed 8 bit ADC&n;&t;&t;&t;&t;&t; */
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start (high speed) ADC&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x24
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * 8-bit ADC (DMA)&n;&t;&t;&t;&t;&t; */
(brace
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|dsp_count
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|dsp_count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start ADC&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
id|sb_intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_trigger
id|sb_dsp_trigger
(paren
r_int
id|dev
comma
r_int
id|bits
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bits
)paren
id|sb_dsp_command
(paren
l_int|0xd0
)paren
suffix:semicolon
multiline_comment|/* Halt DMA */
r_else
r_if
c_cond
(paren
id|bits
op_amp
id|sb_irq_mode
)paren
(brace
r_switch
c_cond
(paren
id|sb_irq_mode
)paren
(brace
r_case
id|IMODE_INPUT
suffix:colon
id|actually_start_input
(paren
id|my_dev
comma
id|trg_buf
comma
id|trg_bytes
comma
id|trg_intrflag
comma
id|trg_restart
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_OUTPUT
suffix:colon
id|actually_output_block
(paren
id|my_dev
comma
id|trg_buf
comma
id|trg_bytes
comma
id|trg_intrflag
comma
id|trg_restart
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|trigger_bits
op_assign
id|bits
suffix:semicolon
)brace
r_static
r_void
DECL|function|dsp_cleanup
id|dsp_cleanup
(paren
r_void
)paren
(brace
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_prepare_for_input
id|sb_dsp_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
r_if
c_cond
(paren
id|sb_no_recording
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: This device doesn&squot;t support recording&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|3
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * SB Pro&n;&t;&t;&t;&t; */
(brace
r_if
c_cond
(paren
id|AudioDrive
)paren
(brace
id|ess_write
(paren
l_int|0xb8
comma
l_int|0x0e
)paren
suffix:semicolon
multiline_comment|/* Auto init DMA mode */
id|ess_write
(paren
l_int|0xa8
comma
(paren
id|ess_read
(paren
l_int|0xa8
)paren
op_amp
op_complement
l_int|0x04
)paren
op_or
(paren
l_int|2
op_minus
id|dsp_stereo
)paren
)paren
suffix:semicolon
multiline_comment|/* Mono/stereo */
id|ess_write
(paren
l_int|0xb9
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Demand mode (2 bytes/xfer) */
r_if
c_cond
(paren
op_logical_neg
id|dsp_stereo
)paren
(brace
r_if
c_cond
(paren
id|dsp_16bit
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8 bit mono */
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x51
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0xd0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 16 bit mono */
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x71
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0xf4
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Stereo */
r_if
c_cond
(paren
op_logical_neg
id|dsp_16bit
)paren
(brace
multiline_comment|/* 8 bit stereo */
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x51
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x98
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 16 bit stereo */
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x71
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0xbc
)paren
suffix:semicolon
)brace
)brace
id|ess_write
(paren
l_int|0xb1
comma
(paren
id|ess_read
(paren
l_int|0xb1
)paren
op_amp
l_int|0x0f
)paren
op_or
l_int|0x50
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb2
comma
(paren
id|ess_read
(paren
l_int|0xb2
)paren
op_amp
l_int|0x0f
)paren
op_or
l_int|0x50
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* !AudioDrive */
multiline_comment|/* Select correct dma channel&n;&t;     * for 16/8 bit acccess&n;&t;   */
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan1
op_assign
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan2
op_assign
id|dsp_16bit
ques
c_cond
id|dma16
suffix:colon
id|dma8
suffix:semicolon
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|sb_dsp_command
(paren
id|dsp_16bit
ques
c_cond
l_int|0xac
suffix:colon
l_int|0xa8
)paren
suffix:semicolon
r_else
id|sb_dsp_command
(paren
id|dsp_16bit
ques
c_cond
l_int|0xa4
suffix:colon
l_int|0xa0
)paren
suffix:semicolon
id|dsp_speed
(paren
id|dsp_current_speed
)paren
suffix:semicolon
)brace
multiline_comment|/* !AudioDrive */
)brace
id|trigger_bits
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_prepare_for_output
id|sb_dsp_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|3
)paren
multiline_comment|/* SB Pro (at least ) */
(brace
r_if
c_cond
(paren
id|AudioDrive
)paren
(brace
id|ess_write
(paren
l_int|0xb8
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Auto init DMA mode */
id|ess_write
(paren
l_int|0xa8
comma
id|ess_read
(paren
l_int|0xa8
)paren
op_or
(paren
l_int|2
op_minus
id|dsp_stereo
)paren
)paren
suffix:semicolon
multiline_comment|/* Mono/stereo */
id|ess_write
(paren
l_int|0xb9
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Demand mode (2 bytes/xfer) */
r_if
c_cond
(paren
op_logical_neg
id|dsp_stereo
)paren
(brace
r_if
c_cond
(paren
id|dsp_16bit
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8 bit mono */
id|ess_write
(paren
l_int|0xb6
comma
l_int|0x80
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x51
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0xd0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 16 bit mono */
id|ess_write
(paren
l_int|0xb6
comma
l_int|0x00
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x71
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0xf4
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Stereo */
r_if
c_cond
(paren
op_logical_neg
id|dsp_16bit
)paren
(brace
multiline_comment|/* 8 bit stereo */
id|ess_write
(paren
l_int|0xb6
comma
l_int|0x80
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x51
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x98
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 16 bit stereo */
id|ess_write
(paren
l_int|0xb6
comma
l_int|0x00
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0x71
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb7
comma
l_int|0xbc
)paren
suffix:semicolon
)brace
)brace
id|ess_write
(paren
l_int|0xb1
comma
(paren
id|ess_read
(paren
l_int|0xb1
)paren
op_amp
l_int|0x0f
)paren
op_or
l_int|0x50
)paren
suffix:semicolon
id|ess_write
(paren
l_int|0xb2
comma
(paren
id|ess_read
(paren
l_int|0xb2
)paren
op_amp
l_int|0x0f
)paren
op_or
l_int|0x50
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* !AudioDrive */
multiline_comment|/* 16 bit specific instructions (Jazz16)&n;&t;   */
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan1
op_assign
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan2
op_assign
id|dsp_16bit
ques
c_cond
id|dma16
suffix:colon
id|dma8
suffix:semicolon
r_if
c_cond
(paren
id|Jazz16_detected
op_ne
l_int|2
)paren
multiline_comment|/* SM Wave */
id|sb_mixer_set_stereo
(paren
id|dsp_stereo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|sb_dsp_command
(paren
id|dsp_16bit
ques
c_cond
l_int|0xac
suffix:colon
l_int|0xa8
)paren
suffix:semicolon
r_else
id|sb_dsp_command
(paren
id|dsp_16bit
ques
c_cond
l_int|0xa4
suffix:colon
l_int|0xa0
)paren
suffix:semicolon
)brace
multiline_comment|/* !AudioDrive */
)brace
id|trigger_bits
op_assign
l_int|0
suffix:semicolon
id|dsp_speaker
(paren
id|ON
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_halt_xfer
id|sb_dsp_halt_xfer
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|AudioDrive
)paren
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|verify_irq
id|verify_irq
(paren
r_void
)paren
(brace
id|irq_ok
op_assign
l_int|1
suffix:semicolon
r_return
id|irq_ok
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_open
id|sb_dsp_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: SoundBlaster board not installed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb_no_recording
op_logical_and
id|mode
op_amp
id|OPEN_READ
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: Recording not supported by this device&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb_intr_active
op_logical_or
(paren
id|sb_midi_busy
op_logical_and
id|sb_midi_mode
op_eq
id|UART_MIDI
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;SB: PCM not possible during MIDI input&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|irq_verified
)paren
(brace
id|verify_irq
(paren
)paren
suffix:semicolon
id|irq_verified
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|irq_ok
)paren
id|printk
(paren
l_string|&quot;SB Warning: Incorrect IRQ setting %d&bslash;n&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
id|retval
op_assign
id|sb_get_irq
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
multiline_comment|/* Allocate 8 bit dma&n;   */
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan1
op_assign
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan2
op_assign
id|dma8
suffix:semicolon
multiline_comment|/* Allocate 16 bit dma (jazz16)&n;   */
r_if
c_cond
(paren
id|Jazz16_detected
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|dma16
op_ne
id|dma8
)paren
(brace
r_if
c_cond
(paren
id|sound_open_dma
(paren
id|dma16
comma
l_string|&quot;Jazz16 16 bit&quot;
)paren
)paren
(brace
id|sb_free_irq
(paren
)paren
suffix:semicolon
multiline_comment|/* DMAbuf_close_dma (dev); */
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
id|sb_irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
id|sb_dsp_busy
op_assign
l_int|1
suffix:semicolon
id|open_mode
op_assign
id|mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_close
id|sb_dsp_close
(paren
r_int
id|dev
)paren
(brace
multiline_comment|/* Release 16 bit dma channel&n;   */
r_if
c_cond
(paren
id|Jazz16_detected
)paren
(brace
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan1
op_assign
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan2
op_assign
id|dma8
suffix:semicolon
r_if
c_cond
(paren
id|dma16
op_ne
id|dma8
)paren
id|sound_close_dma
(paren
id|dma16
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|AudioDrive
)paren
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
multiline_comment|/* DMAbuf_close_dma (dev); */
id|sb_free_irq
(paren
)paren
suffix:semicolon
multiline_comment|/* sb_dsp_command (0xd4); */
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
id|sb_dsp_busy
op_assign
l_int|0
suffix:semicolon
id|sb_dsp_highspeed
op_assign
l_int|0
suffix:semicolon
id|open_mode
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_set_bits
id|dsp_set_bits
(paren
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
id|arg
)paren
r_if
c_cond
(paren
id|Jazz16_detected
op_eq
l_int|0
op_logical_and
id|AudioDrive
op_eq
l_int|0
)paren
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
r_else
r_switch
c_cond
(paren
id|arg
)paren
(brace
r_case
l_int|8
suffix:colon
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|dsp_16bit
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|dsp_16bit
ques
c_cond
l_int|16
suffix:colon
l_int|8
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_ioctl
id|sb_dsp_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
comma
r_int
id|local
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SOUND_PCM_WRITE_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_speed
(paren
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|dsp_speed
(paren
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_current_speed
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|dsp_current_speed
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_stereo
(paren
(paren
r_int
)paren
id|arg
op_minus
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|dsp_set_stereo
(paren
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
op_minus
l_int|1
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_stereo
op_plus
l_int|1
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|dsp_stereo
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_stereo
(paren
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|dsp_set_stereo
(paren
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Word size specific cases here.&n;         * SNDCTL_DSP_SETFMT=SOUND_PCM_WRITE_BITS&n;       */
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_bits
(paren
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|dsp_set_bits
(paren
id|get_fs_long
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_16bit
ques
c_cond
l_int|16
suffix:colon
l_int|8
suffix:semicolon
r_return
id|snd_ioctl_return
(paren
(paren
r_int
op_star
)paren
id|arg
comma
id|dsp_16bit
ques
c_cond
l_int|16
suffix:colon
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_reset
id|sb_dsp_reset
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
id|dsp_speed
(paren
id|dsp_current_speed
)paren
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Initialization of a Media Vision ProSonic 16 Soundcard.&n; * The function initializes a ProSonic 16 like PROS.EXE does for DOS. It sets&n; * the base address, the DMA-channels, interrupts and enables the joystickport.&n; *&n; * Also used by Jazz 16 (same card, different name)&n; *&n; * written 1994 by Rainer Vranken&n; * E-Mail: rvranken@polaris.informatik.uni-essen.de&n; */
r_int
r_int
DECL|function|get_sb_byte
id|get_sb_byte
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
id|inb
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
(brace
r_return
id|inb
(paren
id|DSP_READ
)paren
suffix:semicolon
)brace
r_return
l_int|0xffff
suffix:semicolon
)brace
multiline_comment|/*&n; * Logitech Soundman Wave detection and initialization by Hannu Savolainen.&n; *&n; * There is a microcontroller (8031) in the SM Wave card for MIDI emulation.&n; * it&squot;s located at address MPU_BASE+4.  MPU_BASE+7 is a SM Wave specific&n; * control register for MC reset, SCSI, OPL4 and DSP (future expansion)&n; * address decoding. Otherwise the SM Wave is just a ordinary MV Jazz16&n; * based soundcard.&n; */
r_static
r_void
DECL|function|smw_putmem
id|smw_putmem
(paren
r_int
id|base
comma
r_int
id|addr
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|outb
(paren
id|addr
op_amp
l_int|0xff
comma
id|base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Low address bits */
id|outb
(paren
id|addr
op_rshift
l_int|8
comma
id|base
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* High address bits */
id|outb
(paren
id|val
comma
id|base
)paren
suffix:semicolon
multiline_comment|/* Data */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
r_char
DECL|function|smw_getmem
id|smw_getmem
(paren
r_int
id|base
comma
r_int
id|addr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|outb
(paren
id|addr
op_amp
l_int|0xff
comma
id|base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Low address bits */
id|outb
(paren
id|addr
op_rshift
l_int|8
comma
id|base
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* High address bits */
id|val
op_assign
id|inb
(paren
id|base
)paren
suffix:semicolon
multiline_comment|/* Data */
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
macro_line|#ifdef SMW_MIDI0001_INCLUDED
macro_line|#include &quot;smw-midi0001.h&quot;
macro_line|#else
DECL|variable|smw_ucode
r_int
r_char
op_star
id|smw_ucode
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|smw_ucodeLen
r_int
id|smw_ucodeLen
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_static
r_int
DECL|function|initialize_smw
id|initialize_smw
(paren
r_int
id|mpu_base
)paren
(brace
r_int
id|mp_base
op_assign
id|mpu_base
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* Microcontroller base */
r_int
id|i
suffix:semicolon
r_int
r_char
id|control
suffix:semicolon
multiline_comment|/*&n;     *  Reset the microcontroller so that the RAM can be accessed&n;   */
id|control
op_assign
id|inb
(paren
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
id|outb
(paren
id|control
op_or
l_int|3
comma
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Set last two bits to 1 (?) */
id|outb
(paren
(paren
id|control
op_amp
l_int|0xfe
)paren
op_or
l_int|2
comma
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* xxxxxxx0 resets the mc */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|300
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Wait at least 1ms */
id|tenmicrosec
(paren
id|sb_osp
)paren
suffix:semicolon
id|outb
(paren
id|control
op_amp
l_int|0xfc
comma
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* xxxxxx00 enables RAM */
multiline_comment|/*&n;     *  Detect microcontroller by probing the 8k RAM area&n;   */
id|smw_putmem
(paren
id|mp_base
comma
l_int|0
comma
l_int|0x00
)paren
suffix:semicolon
id|smw_putmem
(paren
id|mp_base
comma
l_int|1
comma
l_int|0xff
)paren
suffix:semicolon
id|tenmicrosec
(paren
id|sb_osp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smw_getmem
(paren
id|mp_base
comma
l_int|0
)paren
op_ne
l_int|0x00
op_logical_or
id|smw_getmem
(paren
id|mp_base
comma
l_int|1
)paren
op_ne
l_int|0xff
)paren
(brace
id|printk
(paren
l_string|&quot;&bslash;nSM Wave: No microcontroller RAM detected (%02x, %02x)&bslash;n&quot;
comma
id|smw_getmem
(paren
id|mp_base
comma
l_int|0
)paren
comma
id|smw_getmem
(paren
id|mp_base
comma
l_int|1
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No RAM */
)brace
multiline_comment|/*&n;     *  There is RAM so assume it&squot;s really a SM Wave&n;   */
r_if
c_cond
(paren
id|smw_ucodeLen
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|smw_ucodeLen
op_ne
l_int|8192
)paren
(brace
id|printk
(paren
l_string|&quot;&bslash;nSM Wave: Invalid microcode (MIDI0001.BIN) length&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;         *  Download microcode&n;       */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8192
suffix:semicolon
id|i
op_increment
)paren
id|smw_putmem
(paren
id|mp_base
comma
id|i
comma
id|smw_ucode
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;         *  Verify microcode&n;       */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8192
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|smw_getmem
(paren
id|mp_base
comma
id|i
)paren
op_ne
id|smw_ucode
(braket
id|i
)braket
)paren
(brace
id|printk
(paren
l_string|&quot;SM Wave: Microcode verification failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|control
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef SMW_SCSI_IRQ
multiline_comment|/*&n;     * Set the SCSI interrupt (IRQ2/9, IRQ3 or IRQ10). The SCSI interrupt&n;     * is disabled by default.&n;     *&n;     * Btw the Zilog 5380 SCSI controller is located at MPU base + 0x10.&n;   */
(brace
r_static
r_int
r_char
id|scsi_irq_bits
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|control
op_or_assign
id|scsi_irq_bits
(braket
id|SMW_SCSI_IRQ
)braket
op_lshift
l_int|6
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef SMW_OPL4_ENABLE
multiline_comment|/*&n;     *  Make the OPL4 chip visible on the PC bus at 0x380.&n;     *&n;     *  There is no need to enable this feature since this driver&n;     *  doesn&squot;t support OPL4 yet. Also there is no RAM in SM Wave so&n;     *  enabling OPL4 is pretty useless.&n;   */
id|control
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Uses IRQ12 if bit 0x20 == 0 */
multiline_comment|/* control |= 0x20;      Uncomment this if you want to use IRQ7 */
macro_line|#endif
id|outb
(paren
id|control
op_or
l_int|0x03
comma
id|mpu_base
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* xxxxxx11 restarts */
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|initialize_ProSonic16
id|initialize_ProSonic16
(paren
r_void
)paren
(brace
r_int
id|x
suffix:semicolon
r_static
r_int
r_char
id|int_translat
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|3
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|2
comma
l_int|5
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|6
)brace
comma
id|dma_translat
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|4
)brace
suffix:semicolon
id|outb
(paren
l_int|0xAF
comma
l_int|0x201
)paren
suffix:semicolon
multiline_comment|/* ProSonic/Jazz16 wakeup */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
l_int|1000
suffix:semicolon
op_increment
id|x
)paren
multiline_comment|/* wait 10 milliseconds */
id|tenmicrosec
(paren
id|sb_osp
)paren
suffix:semicolon
id|outb
(paren
l_int|0x50
comma
l_int|0x201
)paren
suffix:semicolon
id|outb
(paren
(paren
id|sbc_base
op_amp
l_int|0x70
)paren
op_or
(paren
(paren
id|mpu_base
op_amp
l_int|0x30
)paren
op_rshift
l_int|4
)paren
comma
l_int|0x201
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_reset_dsp
(paren
)paren
)paren
(brace
multiline_comment|/* OK. We have at least a SB */
multiline_comment|/* Check the version number of ProSonic (I guess) */
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
(paren
l_int|0xFA
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|get_sb_byte
(paren
)paren
op_ne
l_int|0x12
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0xFB
)paren
op_logical_and
multiline_comment|/* set DMA-channels and Interrupts */
id|sb_dsp_command
(paren
(paren
id|dma_translat
(braket
id|dma16
)braket
op_lshift
l_int|4
)paren
op_or
id|dma_translat
(braket
id|dma8
)braket
)paren
op_logical_and
id|sb_dsp_command
(paren
(paren
id|int_translat
(braket
id|mpu_irq
)braket
op_lshift
l_int|4
)paren
op_or
id|int_translat
(braket
id|sbc_irq
)braket
)paren
)paren
(brace
id|Jazz16_detected
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mpu_base
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|initialize_smw
(paren
id|mpu_base
)paren
)paren
id|Jazz16_detected
op_assign
l_int|2
suffix:semicolon
id|sb_dsp_disable_midi
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* There was at least a SB */
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No SB or ProSonic16 detected */
)brace
r_int
DECL|function|sb_dsp_detect
id|sb_dsp_detect
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_if
c_cond
(paren
id|sb_dsp_ok
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Already initialized&n;&t;&t;&t;&t; */
id|sbc_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|sbc_irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|sbc_dma
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|sb_osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
id|dma8
op_assign
id|dma16
op_assign
id|hw_config-&gt;dma
suffix:semicolon
r_if
c_cond
(paren
id|sb_reset_dsp
(paren
)paren
)paren
id|dsp_get_vers
(paren
id|hw_config
)paren
suffix:semicolon
r_else
id|sbc_major
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|3
op_logical_or
id|sbc_major
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|initialize_ProSonic16
(paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_reset_dsp
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Detected&n;&t;&t;&t;&t; */
)brace
macro_line|#ifdef CONFIG_AUDIO
DECL|variable|sb_dsp_operations
r_static
r_struct
id|audio_operations
id|sb_dsp_operations
op_assign
(brace
l_string|&quot;SoundBlaster&quot;
comma
id|NOTHING_SPECIAL
comma
id|AFMT_U8
comma
multiline_comment|/* Just 8 bits. Poor old SB */
l_int|NULL
comma
id|sb_dsp_open
comma
id|sb_dsp_close
comma
id|sb_dsp_output_block
comma
id|sb_dsp_start_input
comma
id|sb_dsp_ioctl
comma
id|sb_dsp_prepare_for_input
comma
id|sb_dsp_prepare_for_output
comma
id|sb_dsp_reset
comma
id|sb_dsp_halt_xfer
comma
l_int|NULL
comma
multiline_comment|/* local_qlen */
l_int|NULL
comma
multiline_comment|/* copy_from_user */
l_int|NULL
comma
l_int|NULL
comma
id|sb_dsp_trigger
)brace
suffix:semicolon
macro_line|#endif
r_static
r_void
DECL|function|ess_init
id|ess_init
(paren
r_int
id|ess_minor
)paren
multiline_comment|/* ESS1688 Initialization */
(brace
r_int
r_char
id|cfg
comma
id|irq_bits
op_assign
l_int|0
comma
id|dma_bits
op_assign
l_int|0
suffix:semicolon
id|AudioDrive
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ess_minor
op_ge
l_int|8
)paren
multiline_comment|/* ESS1688 doesn&squot;t support SB MIDI */
id|midi_disabled
op_assign
l_int|1
suffix:semicolon
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
multiline_comment|/* Turn on extended mode */
multiline_comment|/*&n; *    Set IRQ configuration register&n; */
id|cfg
op_assign
l_int|0x50
suffix:semicolon
multiline_comment|/* Enable only DMA counter interrupt */
r_switch
c_cond
(paren
id|sbc_irq
)paren
(brace
r_case
l_int|2
suffix:colon
r_case
l_int|9
suffix:colon
id|irq_bits
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|irq_bits
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|irq_bits
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|irq_bits
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|irq_bits
op_assign
l_int|0
suffix:semicolon
id|cfg
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Disable all interrupts */
id|printk
(paren
l_string|&quot;&bslash;nESS1688: Invalid IRQ %d&bslash;n&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ess_write
(paren
l_int|0xb1
comma
id|cfg
op_or
(paren
id|irq_bits
op_lshift
l_int|2
)paren
)paren
)paren
id|printk
(paren
l_string|&quot;&bslash;nESS1688: Failed to write to IRQ config register&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *    Set DMA configuration register&n; */
id|cfg
op_assign
l_int|0x50
suffix:semicolon
multiline_comment|/* Extended mode DMA ebable */
r_if
c_cond
(paren
id|sbc_dma
OG
l_int|3
op_logical_or
id|sbc_dma
OL
l_int|0
op_logical_or
id|sbc_dma
op_eq
l_int|2
)paren
(brace
id|dma_bits
op_assign
l_int|0
suffix:semicolon
id|cfg
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* Disable all DMA */
id|printk
(paren
l_string|&quot;&bslash;nESS1688: Invalid DMA %d&bslash;n&quot;
comma
id|sbc_dma
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sbc_dma
op_eq
l_int|3
)paren
id|dma_bits
op_assign
l_int|3
suffix:semicolon
r_else
id|dma_bits
op_assign
id|sbc_dma
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ess_write
(paren
l_int|0xb2
comma
id|cfg
op_or
(paren
id|dma_bits
op_lshift
l_int|2
)paren
)paren
)paren
id|printk
(paren
l_string|&quot;&bslash;nESS1688: Failed to write to DMA config register&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Enable joystick and OPL3&n; */
id|cfg
op_assign
id|sb_getmixer
(paren
l_int|0x40
)paren
suffix:semicolon
id|sb_setmixer
(paren
l_int|0x40
comma
id|cfg
op_or
l_int|0x03
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_MIDI
r_void
DECL|function|ess_midi_init
id|ess_midi_init
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
multiline_comment|/* called from sb16_midi.c */
(brace
r_int
r_char
id|cfg
comma
id|tmp
suffix:semicolon
id|cfg
op_assign
id|sb_getmixer
(paren
l_int|0x40
)paren
op_amp
l_int|0x03
suffix:semicolon
id|tmp
op_assign
(paren
id|hw_config-&gt;io_base
op_amp
l_int|0x0f0
)paren
op_rshift
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OG
l_int|3
)paren
(brace
id|sb_setmixer
(paren
l_int|0x40
comma
id|cfg
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cfg
op_or_assign
id|tmp
op_lshift
l_int|3
suffix:semicolon
id|tmp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* MPU enabled without interrupts */
r_switch
c_cond
(paren
id|hw_config-&gt;irq
)paren
(brace
r_case
l_int|9
suffix:colon
id|tmp
op_assign
l_int|0x4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|tmp
op_assign
l_int|0x5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|tmp
op_assign
l_int|0x6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|10
suffix:colon
id|tmp
op_assign
l_int|0x7
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cfg
op_or_assign
id|tmp
op_lshift
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
l_int|1
)paren
(brace
id|ess_mpu_irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|snd_set_irq_handler
(paren
id|ess_mpu_irq
comma
id|sbmidiintr
comma
l_string|&quot;ES1688 MIDI&quot;
comma
id|sb_osp
)paren
OL
l_int|0
)paren
id|printk
(paren
l_string|&quot;ES1688: Can&squot;t allocate IRQ%d&bslash;n&quot;
comma
id|ess_mpu_irq
)paren
suffix:semicolon
)brace
id|sb_setmixer
(paren
l_int|0x40
comma
id|cfg
)paren
suffix:semicolon
)brace
macro_line|#endif
r_void
DECL|function|Jazz16_midi_init
id|Jazz16_midi_init
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_extern
r_void
id|smw_mixer_init
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|sb_mixer_reset
(paren
r_void
)paren
suffix:semicolon
id|mpu_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|mpu_irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|initialize_ProSonic16
(paren
)paren
suffix:semicolon
id|smw_mixer_init
(paren
)paren
suffix:semicolon
id|sb_mixer_reset
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|Jazz16_set_dma16
id|Jazz16_set_dma16
(paren
r_int
id|dma
)paren
(brace
id|dma16
op_assign
id|dma
suffix:semicolon
multiline_comment|/* Allocate 16 bit dma (Jazz16)&n; */
r_if
c_cond
(paren
id|dma16
op_ne
id|dma8
)paren
(brace
r_if
c_cond
(paren
id|sound_alloc_dma
(paren
id|dma16
comma
l_string|&quot;Jazz16 16 bit&quot;
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;Jazz16: Can&squot;t allocate 16 bit DMA channel&bslash;n&quot;
)paren
suffix:semicolon
id|Jazz16_detected
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|initialize_ProSonic16
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dsp_get_vers
id|dsp_get_vers
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
(paren
id|flags
)paren
suffix:semicolon
id|cli
(paren
)paren
suffix:semicolon
id|sb_osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
id|sbc_major
op_assign
id|sbc_minor
op_assign
l_int|0
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0xe1
)paren
suffix:semicolon
multiline_comment|/* Get version */
r_for
c_loop
(paren
id|i
op_assign
l_int|100000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
(brace
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|0
)paren
id|sbc_major
op_assign
id|inb
(paren
id|DSP_READ
)paren
suffix:semicolon
r_else
(brace
id|sbc_minor
op_assign
id|inb
(paren
id|DSP_READ
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
)brace
r_int
DECL|function|sb_dsp_init
id|sb_dsp_init
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ess_major
op_assign
l_int|0
comma
id|ess_minor
op_assign
l_int|0
suffix:semicolon
r_int
id|mixer_type
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|0
)paren
id|dsp_get_vers
(paren
id|hw_config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|0
)paren
(brace
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
id|dsp_get_vers
(paren
id|hw_config
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;&bslash;n&bslash;nFailed to get SB version (%x) - possible I/O conflict?&bslash;n&bslash;n&quot;
comma
id|inb
(paren
id|DSP_DATA_AVAIL
)paren
)paren
suffix:semicolon
id|sbc_major
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|2
op_logical_or
id|sbc_major
op_eq
l_int|3
)paren
id|sb_duplex_midi
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|4
)paren
id|sb16
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|3
op_logical_and
id|sbc_minor
op_eq
l_int|1
)paren
(brace
multiline_comment|/*&n; * Try to detect ESS chips.&n; */
id|sb_dsp_command
(paren
l_int|0xe7
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Return identification bytes.&n;&t;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * wait for Data Ready&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|ess_major
op_eq
l_int|0
)paren
id|ess_major
op_assign
id|inb
(paren
id|DSP_READ
)paren
suffix:semicolon
r_else
(brace
id|ess_minor
op_assign
id|inb
(paren
id|DSP_READ
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|snd_set_irq_handler
(paren
id|sbc_irq
comma
id|sbintr
comma
l_string|&quot;SoundBlaster&quot;
comma
id|sb_osp
)paren
OL
l_int|0
)paren
id|printk
(paren
l_string|&quot;sb_dsp: Can&squot;t allocate IRQ&bslash;n&quot;
)paren
suffix:semicolon
suffix:semicolon
macro_line|#ifdef CONFIG_AUDIO
r_if
c_cond
(paren
id|sbc_major
op_ge
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|Jazz16_detected
)paren
(brace
r_if
c_cond
(paren
id|Jazz16_detected
op_eq
l_int|2
)paren
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundMan Wave %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
r_else
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;MV Jazz16 %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
id|sb_dsp_operations.format_mask
op_or_assign
id|AFMT_S16_LE
suffix:semicolon
multiline_comment|/* Hurrah, 16 bits          */
)brace
r_else
macro_line|#ifdef __SGNXPRO__
r_if
c_cond
(paren
id|mixer_type
op_eq
l_int|2
)paren
(brace
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;Sound Galaxy NX Pro %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|4
)paren
(brace
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster 16 %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ess_major
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ess_major
op_eq
l_int|0x48
op_logical_and
(paren
id|ess_minor
op_amp
l_int|0xf0
)paren
op_eq
l_int|0x80
)paren
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;ESS ES488 AudioDrive (rev %d)&quot;
comma
id|ess_minor
op_amp
l_int|0x0f
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ess_major
op_eq
l_int|0x68
op_logical_and
(paren
id|ess_minor
op_amp
l_int|0xf0
)paren
op_eq
l_int|0x80
)paren
(brace
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;ESS ES1688 AudioDrive (rev %d)&quot;
comma
id|ess_minor
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|sb_dsp_operations.format_mask
op_or_assign
id|AFMT_S16_LE
suffix:semicolon
id|ess_init
(paren
id|ess_minor
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster Pro %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
)brace
id|conf_printf
(paren
id|sb_dsp_operations.name
comma
id|hw_config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_ge
l_int|3
)paren
id|mixer_type
op_assign
id|sb_mixer_init
(paren
id|sbc_major
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb16
)paren
r_if
c_cond
(paren
id|num_audiodevs
OL
id|MAX_AUDIO_DEV
)paren
(brace
id|audio_devs
(braket
id|my_dev
op_assign
id|num_audiodevs
op_increment
)braket
op_assign
op_amp
id|sb_dsp_operations
suffix:semicolon
r_if
c_cond
(paren
id|AudioDrive
)paren
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|flags
op_or_assign
id|DMA_AUTOMODE
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|buffsize
op_assign
id|DSP_BUFFSIZE
suffix:semicolon
id|dma8
op_assign
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan1
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|dma16
op_assign
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan2
op_assign
id|hw_config-&gt;dma
suffix:semicolon
r_if
c_cond
(paren
id|sound_alloc_dma
(paren
id|hw_config-&gt;dma
comma
l_string|&quot;SoundBlaster&quot;
)paren
)paren
id|printk
(paren
l_string|&quot;sb_dsp.c: Can&squot;t allocate DMA channel&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB: Too many DSP devices available&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
id|conf_printf
(paren
l_string|&quot;SoundBlaster (configured without audio support)&quot;
comma
id|hw_config
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_MIDI
r_if
c_cond
(paren
op_logical_neg
id|midi_disabled
op_logical_and
op_logical_neg
id|sb16
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * Midi don&squot;t work in the SB emulation mode *&n;&t;&t;&t;&t; * of PAS, SB16 has better midi interface&n;&t;&t;&t;&t; */
id|sb_midi_init
(paren
id|sbc_major
)paren
suffix:semicolon
macro_line|#endif
id|sb_dsp_ok
op_assign
l_int|1
suffix:semicolon
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_void
DECL|function|sb_dsp_unload
id|sb_dsp_unload
(paren
r_void
)paren
(brace
id|sound_free_dma
(paren
id|dma8
)paren
suffix:semicolon
multiline_comment|/* Free 16 bit dma (Jazz16)&n;   */
r_if
c_cond
(paren
id|Jazz16_detected
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|dma16
op_ne
id|dma8
)paren
(brace
id|sound_free_dma
(paren
id|dma16
)paren
suffix:semicolon
)brace
id|snd_release_irq
(paren
id|sbc_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AudioDrive
op_logical_and
id|ess_mpu_irq
)paren
(brace
id|snd_release_irq
(paren
id|ess_mpu_irq
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|sb_dsp_disable_midi
id|sb_dsp_disable_midi
(paren
r_void
)paren
(brace
id|midi_disabled
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
eof
