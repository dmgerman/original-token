multiline_comment|/*&n; * sound/sb_dsp.c&n; *&n; * The low level driver for the SoundBlaster DSP chip (SB1.0 to 2.1, SB Pro).&n; *&n; * Copyright by Hannu Savolainen 1994&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; * Modified:&n; *      Hunyue Yau      Jan 6 1994&n; *      Added code to support Sound Galaxy NX Pro&n; *&n; *      JRA Gibson      April 1995&n; *      Code added for MV ProSonic/Jazz 16 in 16 bit mode&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_SB)
macro_line|#include &quot;sb.h&quot;
macro_line|#include &quot;sb_mixer.h&quot;
DECL|macro|SB_TEST_IRQ
macro_line|#undef SB_TEST_IRQ
DECL|variable|sbc_base
r_int
id|sbc_base
op_assign
l_int|0
suffix:semicolon
DECL|variable|sbc_irq
r_static
r_int
id|sbc_irq
op_assign
l_int|0
suffix:semicolon
DECL|variable|open_mode
r_static
r_int
id|open_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Read, write or both */
DECL|variable|Jazz16_detected
r_int
id|Jazz16_detected
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_no_recording
r_int
id|sb_no_recording
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * The DSP channel can be used either for input or output. Variable&n; * &squot;sb_irq_mode&squot; will be set when the program calls read or write first time&n; * after open. Current version doesn&squot;t support mode changes without closing&n; * and reopening the device. Support for this feature may be implemented in a&n; * future version of this driver.&n; */
DECL|variable|sb_dsp_ok
r_int
id|sb_dsp_ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&n;&n;&t;&t;&t;&t; * *  * * Set to 1 after successful&n;&t;&t;&t;&t; * initialization  *  */
DECL|variable|midi_disabled
r_static
r_int
id|midi_disabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_dsp_highspeed
r_int
id|sb_dsp_highspeed
op_assign
l_int|0
suffix:semicolon
DECL|variable|sbc_major
DECL|variable|sbc_minor
r_int
id|sbc_major
op_assign
l_int|1
comma
id|sbc_minor
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&n;&n;&t;&t;&t;&t;&t;&t;   * *  * * DSP version   */
DECL|variable|dsp_stereo
r_static
r_int
id|dsp_stereo
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_current_speed
r_static
r_int
id|dsp_current_speed
op_assign
id|DSP_DEFAULT_SPEED
suffix:semicolon
DECL|variable|sb16
r_static
r_int
id|sb16
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq_verified
r_static
r_int
id|irq_verified
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_midi_mode
r_int
id|sb_midi_mode
op_assign
id|NORMAL_MIDI
suffix:semicolon
DECL|variable|sb_midi_busy
r_int
id|sb_midi_busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&n;&n;&t;&t;&t;&t;&t; * *  * * 1 if the process has output&n;&t;&t;&t;&t;&t; * to *  * MIDI   */
DECL|variable|sb_dsp_busy
r_int
id|sb_dsp_busy
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_irq_mode
r_volatile
r_int
id|sb_irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
multiline_comment|/*&n;&n;&n;&t;&t;&t;&t;&t;&t; * *  * * IMODE_INPUT, *&n;&t;&t;&t;&t;&t;&t; * IMODE_OUTPUT * * or *&n;&t;&t;&t;&t;&t;&t; * IMODE_NONE   */
DECL|variable|irq_ok
r_static
r_volatile
r_int
id|irq_ok
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef JAZZ16
multiline_comment|/* 16 bit support&n; */
DECL|variable|dsp_16bit
r_static
r_int
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
DECL|variable|dma8
r_static
r_int
id|dma8
op_assign
l_int|1
suffix:semicolon
DECL|variable|dma16
r_static
r_int
id|dma16
op_assign
l_int|5
suffix:semicolon
r_static
r_int
id|dsp_set_bits
(paren
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|initialize_ProSonic16
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* end of 16 bit support&n; */
macro_line|#endif
DECL|variable|sb_duplex_midi
r_int
id|sb_duplex_midi
op_assign
l_int|0
suffix:semicolon
DECL|variable|my_dev
r_static
r_int
id|my_dev
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_intr_active
r_volatile
r_int
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|dsp_speed
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|dsp_set_stereo
(paren
r_int
id|mode
)paren
suffix:semicolon
r_int
id|sb_dsp_command
(paren
r_int
r_char
id|val
)paren
suffix:semicolon
macro_line|#if !defined(EXCLUDE_MIDI) || !defined(EXCLUDE_AUDIO)
multiline_comment|/*&n; * Common code for the midi and pcm functions&n; */
r_int
DECL|function|sb_dsp_command
id|sb_dsp_command
(paren
r_int
r_char
id|val
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|limit
suffix:semicolon
id|limit
op_assign
id|GET_TIME
(paren
)paren
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * The timeout is 0.1 secods&n;&t;&t;&t;&t;&t; */
multiline_comment|/*&n;   * Note! the i&lt;500000 is an emergency exit. The sb_dsp_command() is sometimes&n;   * called while interrupts are disabled. This means that the timer is&n;   * disabled also. However the timeout situation is a abnormal condition.&n;   * Normally the DSP should be ready to accept commands after just couple of&n;   * loops.&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|500000
op_logical_and
id|GET_TIME
(paren
)paren
OL
id|limit
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|INB
(paren
id|DSP_STATUS
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
id|OUTB
(paren
id|val
comma
id|DSP_COMMAND
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;SoundBlaster: DSP Command(%x) Timeout.&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;IRQ conflict???&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|INT_HANDLER_PARMS
id|sbintr
(paren
id|INT_HANDLER_PARMS
(paren
id|irq
comma
id|dummy
)paren
)paren
(brace
r_int
id|status
suffix:semicolon
macro_line|#ifndef EXCLUDE_SBPRO
r_if
c_cond
(paren
id|sb16
)paren
(brace
r_int
r_char
id|src
op_assign
id|sb_getmixer
(paren
id|IRQ_STAT
)paren
suffix:semicolon
multiline_comment|/* Interrupt source register */
macro_line|#ifndef EXCLUDE_SB16
r_if
c_cond
(paren
id|src
op_amp
l_int|3
)paren
id|sb16_dsp_interrupt
(paren
id|irq
)paren
suffix:semicolon
macro_line|#ifndef EXCLUDE_MIDI
r_if
c_cond
(paren
id|src
op_amp
l_int|4
)paren
id|sb16midiintr
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * SB MPU401 interrupt&n;&t;&t;&t;&t; */
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|src
op_amp
l_int|1
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Not a DSP interupt&n;&t;&t;&t;&t; */
)brace
macro_line|#endif
id|status
op_assign
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * Clear interrupt&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|sb_intr_active
)paren
r_switch
c_cond
(paren
id|sb_irq_mode
)paren
(brace
r_case
id|IMODE_OUTPUT
suffix:colon
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_outputintr
(paren
id|my_dev
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INPUT
suffix:colon
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_inputintr
(paren
id|my_dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * A complete buffer has been input. Let&squot;s start new one&n;&t; */
r_break
suffix:semicolon
r_case
id|IMODE_INIT
suffix:colon
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|irq_ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_MIDI
suffix:colon
macro_line|#ifndef EXCLUDE_MIDI
id|sb_midi_interrupt
(paren
id|irq
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;SoundBlaster: Unexpected interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|variable|sb_irq_usecount
r_static
r_int
id|sb_irq_usecount
op_assign
l_int|0
suffix:semicolon
r_int
DECL|function|sb_get_irq
id|sb_get_irq
(paren
r_void
)paren
(brace
r_int
id|ok
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_usecount
)paren
r_if
c_cond
(paren
(paren
id|ok
op_assign
id|snd_set_irq_handler
(paren
id|sbc_irq
comma
id|sbintr
comma
l_string|&quot;SoundBlaster&quot;
)paren
)paren
OL
l_int|0
)paren
r_return
id|ok
suffix:semicolon
id|sb_irq_usecount
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|sb_free_irq
id|sb_free_irq
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_usecount
)paren
r_return
suffix:semicolon
id|sb_irq_usecount
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_usecount
)paren
id|snd_release_irq
(paren
id|sbc_irq
)paren
suffix:semicolon
)brace
r_int
DECL|function|sb_reset_dsp
id|sb_reset_dsp
(paren
r_void
)paren
(brace
r_int
id|loopc
suffix:semicolon
id|OUTB
(paren
l_int|1
comma
id|DSP_RESET
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0
comma
id|DSP_RESET
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loopc
op_assign
l_int|0
suffix:semicolon
id|loopc
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
suffix:semicolon
id|loopc
op_increment
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; * Wait&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; * for&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; * data&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; * *&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; * available&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; * status&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|INB
(paren
id|DSP_READ
)paren
op_ne
l_int|0xAA
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Sorry&n;&t;&t;&t;&t; */
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifndef EXCLUDE_AUDIO
r_static
r_void
DECL|function|dsp_speaker
id|dsp_speaker
(paren
r_char
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
id|sb_dsp_command
(paren
id|DSP_CMD_SPKON
)paren
suffix:semicolon
r_else
id|sb_dsp_command
(paren
id|DSP_CMD_SPKOFF
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_speed
id|dsp_speed
(paren
r_int
id|speed
)paren
(brace
r_int
r_char
id|tconst
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|max_speed
op_assign
l_int|44100
suffix:semicolon
r_if
c_cond
(paren
id|speed
OL
l_int|4000
)paren
id|speed
op_assign
l_int|4000
suffix:semicolon
multiline_comment|/*&n;     * Older SB models don&squot;t support higher speeds than 22050.&n;   */
r_if
c_cond
(paren
id|sbc_major
OL
l_int|2
op_logical_or
(paren
id|sbc_major
op_eq
l_int|2
op_logical_and
id|sbc_minor
op_eq
l_int|0
)paren
)paren
id|max_speed
op_assign
l_int|22050
suffix:semicolon
multiline_comment|/*&n;     * SB models earlier than SB Pro have low limit for the input speed.&n;   */
r_if
c_cond
(paren
id|open_mode
op_ne
id|OPEN_WRITE
)paren
multiline_comment|/* Recording is possible */
r_if
c_cond
(paren
id|sbc_major
OL
l_int|3
)paren
multiline_comment|/* Limited input speed with these cards */
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|2
op_logical_and
id|sbc_minor
OG
l_int|0
)paren
id|max_speed
op_assign
l_int|15000
suffix:semicolon
r_else
id|max_speed
op_assign
l_int|13000
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
id|max_speed
)paren
id|speed
op_assign
id|max_speed
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Invalid speed&n;&t;&t;&t;&t; */
multiline_comment|/* Logitech SoundMan Games and Jazz16 cards can support 44.1kHz stereo */
macro_line|#if !defined (SM_GAMES)
multiline_comment|/*&n;   * Max. stereo speed is 22050&n;   */
r_if
c_cond
(paren
id|dsp_stereo
op_logical_and
id|speed
OG
l_int|22050
op_logical_and
id|Jazz16_detected
op_eq
l_int|0
)paren
id|speed
op_assign
l_int|22050
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|speed
OG
l_int|22050
)paren
op_logical_and
id|sb_midi_busy
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: High speed DSP not possible simultaneously with MIDI output&bslash;n&quot;
)paren
suffix:semicolon
id|speed
op_assign
l_int|22050
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|speed
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/*&n;   * Now the speed should be valid&n;   */
r_if
c_cond
(paren
id|speed
OG
l_int|22050
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * High speed mode&n;&t;&t;&t;&t; */
r_int
id|tmp
suffix:semicolon
id|tconst
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
l_int|65536
op_minus
(paren
(paren
l_int|256000000
op_plus
id|speed
op_div
l_int|2
)paren
op_div
id|speed
)paren
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sb_dsp_highspeed
op_assign
l_int|1
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x40
)paren
)paren
id|sb_dsp_command
(paren
id|tconst
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
l_int|65536
op_minus
(paren
id|tconst
op_lshift
l_int|8
)paren
suffix:semicolon
id|speed
op_assign
(paren
l_int|256000000
op_plus
id|tmp
op_div
l_int|2
)paren
op_div
id|tmp
suffix:semicolon
)brace
r_else
(brace
r_int
id|tmp
suffix:semicolon
id|sb_dsp_highspeed
op_assign
l_int|0
suffix:semicolon
id|tconst
op_assign
(paren
l_int|256
op_minus
(paren
(paren
l_int|1000000
op_plus
id|speed
op_div
l_int|2
)paren
op_div
id|speed
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x40
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Set time constant&n;&t;&t;&t;&t;&t; */
id|sb_dsp_command
(paren
id|tconst
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
l_int|256
op_minus
id|tconst
suffix:semicolon
id|speed
op_assign
(paren
l_int|1000000
op_plus
id|tmp
op_div
l_int|2
)paren
op_div
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|speed
op_div_assign
l_int|2
suffix:semicolon
id|dsp_current_speed
op_assign
id|speed
suffix:semicolon
r_return
id|speed
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_set_stereo
id|dsp_set_stereo
(paren
r_int
id|mode
)paren
(brace
id|dsp_stereo
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef EXCLUDE_SBPRO
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|sbc_major
OL
l_int|3
op_logical_or
id|sb16
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Sorry no stereo&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|mode
op_logical_and
id|sb_midi_busy
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: Stereo DSP not possible simultaneously with MIDI output&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dsp_stereo
op_assign
op_logical_neg
op_logical_neg
id|mode
suffix:semicolon
r_return
id|dsp_stereo
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
DECL|function|sb_dsp_output_block
id|sb_dsp_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_mode
)paren
id|dsp_speaker
(paren
id|ON
)paren
suffix:semicolon
id|sb_irq_mode
op_assign
id|IMODE_OUTPUT
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_highspeed
)paren
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x48
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * High speed size&n;&t;&t;&t;&t;&t; */
(brace
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|count
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0x91
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * High speed 8 bit DAC&n;&t;&t;&t;&t;&t; */
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start (high speed) DAC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x14
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * 8-bit DAC (DMA)&n;&t;&t;&t;&t;&t; */
(brace
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|count
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start DAC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
id|sb_intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_start_input
id|sb_dsp_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
multiline_comment|/*&n;   * Start a DMA input to the buffer pointed by dmaqtail&n;   */
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_mode
)paren
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
id|sb_irq_mode
op_assign
id|IMODE_INPUT
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|audio_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|dmachan
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_highspeed
)paren
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x48
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * High speed size&n;&t;&t;&t;&t;&t; */
(brace
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|count
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0x99
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * High speed 8 bit ADC&n;&t;&t;&t;&t;&t; */
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start (high speed) ADC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x24
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * 8-bit ADC (DMA)&n;&t;&t;&t;&t;&t; */
(brace
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
id|count
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
r_int
r_char
)paren
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start ADC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
id|sb_intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|dsp_cleanup
id|dsp_cleanup
(paren
r_void
)paren
(brace
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_prepare_for_input
id|sb_dsp_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|3
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * SB Pro&n;&t;&t;&t;&t; */
(brace
macro_line|#ifdef JAZZ16
multiline_comment|/* Select correct dma channel&n;         * for 16/8 bit acccess&n;       */
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan
op_assign
id|dsp_16bit
ques
c_cond
id|dma16
suffix:colon
id|dma8
suffix:semicolon
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|sb_dsp_command
(paren
id|dsp_16bit
ques
c_cond
l_int|0xac
suffix:colon
l_int|0xa8
)paren
suffix:semicolon
r_else
id|sb_dsp_command
(paren
id|dsp_16bit
ques
c_cond
l_int|0xa4
suffix:colon
l_int|0xa0
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* 8 bit only cards use this&n;       */
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|sb_dsp_command
(paren
l_int|0xa8
)paren
suffix:semicolon
r_else
id|sb_dsp_command
(paren
l_int|0xa0
)paren
suffix:semicolon
macro_line|#endif
id|dsp_speed
(paren
id|dsp_current_speed
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Speed must be recalculated if&n;&t;&t;&t;&t;&t; * #channels * changes&n;&t;&t;&t;&t;&t; */
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_prepare_for_output
id|sb_dsp_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|ON
)paren
suffix:semicolon
macro_line|#ifndef EXCLUDE_SBPRO
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|3
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * SB Pro&n;&t;&t;&t;&t; */
(brace
macro_line|#ifdef JAZZ16
multiline_comment|/* 16 bit specific instructions&n;       */
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan
op_assign
id|dsp_16bit
ques
c_cond
id|dma16
suffix:colon
id|dma8
suffix:semicolon
r_if
c_cond
(paren
id|Jazz16_detected
op_ne
l_int|2
)paren
multiline_comment|/* SM Wave */
id|sb_mixer_set_stereo
(paren
id|dsp_stereo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|sb_dsp_command
(paren
id|dsp_16bit
ques
c_cond
l_int|0xac
suffix:colon
l_int|0xa8
)paren
suffix:semicolon
r_else
id|sb_dsp_command
(paren
id|dsp_16bit
ques
c_cond
l_int|0xa4
suffix:colon
l_int|0xa0
)paren
suffix:semicolon
macro_line|#else
id|sb_mixer_set_stereo
(paren
id|dsp_stereo
)paren
suffix:semicolon
macro_line|#endif
id|dsp_speed
(paren
id|dsp_current_speed
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t; * Speed must be recalculated if&n;&t;&t;&t;&t;&t; * #channels * changes&n;&t;&t;&t;&t;&t; */
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_halt_xfer
id|sb_dsp_halt_xfer
(paren
r_int
id|dev
)paren
(brace
)brace
r_static
r_int
DECL|function|verify_irq
id|verify_irq
(paren
r_void
)paren
(brace
macro_line|#if 0
id|DEFINE_WAIT_QUEUE
(paren
id|testq
comma
id|testf
)paren
suffix:semicolon
id|irq_ok
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sb_get_irq
(paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;*** SB Error: Irq %d already in use&bslash;n&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sb_irq_mode
op_assign
id|IMODE_INIT
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0xf2
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * This should cause immediate interrupt&n;&t;&t;&t;&t; */
id|DO_SLEEP
(paren
id|testq
comma
id|testf
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
id|sb_free_irq
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: IRQ%d test not passed!&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
id|irq_ok
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#else
id|irq_ok
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_return
id|irq_ok
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_open
id|sb_dsp_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: SoundBlaster board not installed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb_no_recording
op_logical_and
id|mode
op_amp
id|OPEN_READ
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: Recording not supported by this device&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENOTTY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb_intr_active
op_logical_or
(paren
id|sb_midi_busy
op_logical_and
id|sb_midi_mode
op_eq
id|UART_MIDI
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;SB: PCM not possible during MIDI input&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|irq_verified
)paren
(brace
id|verify_irq
(paren
)paren
suffix:semicolon
id|irq_verified
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|irq_ok
)paren
id|printk
(paren
l_string|&quot;SB Warning: Incorrect IRQ setting %d&bslash;n&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
id|retval
op_assign
id|sb_get_irq
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
multiline_comment|/* Allocate 8 bit dma&n;   */
macro_line|#ifdef JAZZ16
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan
op_assign
id|dma8
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|DMAbuf_open_dma
(paren
id|dev
)paren
OL
l_int|0
)paren
(brace
id|sb_free_irq
(paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;SB: DMA Busy&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
macro_line|#ifdef JAZZ16
multiline_comment|/* Allocate 16 bit dma&n;   */
r_if
c_cond
(paren
id|Jazz16_detected
op_ne
l_int|0
)paren
r_if
c_cond
(paren
id|dma16
op_ne
id|dma8
)paren
(brace
r_if
c_cond
(paren
id|ALLOC_DMA_CHN
(paren
id|dma16
comma
l_string|&quot;Jazz16 16 bit&quot;
)paren
)paren
(brace
id|sb_free_irq
(paren
)paren
suffix:semicolon
id|DMAbuf_close_dma
(paren
id|dev
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|sb_irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
id|sb_dsp_busy
op_assign
l_int|1
suffix:semicolon
id|open_mode
op_assign
id|mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_close
id|sb_dsp_close
(paren
r_int
id|dev
)paren
(brace
macro_line|#ifdef JAZZ16
multiline_comment|/* Release 16 bit dma channel&n;   */
r_if
c_cond
(paren
id|Jazz16_detected
)paren
(brace
r_if
c_cond
(paren
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan
op_eq
id|dma8
)paren
id|RELEASE_DMA_CHN
(paren
id|dma16
)paren
suffix:semicolon
r_else
id|RELEASE_DMA_CHN
(paren
id|dma8
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DMAbuf_close_dma
(paren
id|dev
)paren
suffix:semicolon
id|sb_free_irq
(paren
)paren
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
id|sb_dsp_busy
op_assign
l_int|0
suffix:semicolon
id|sb_dsp_highspeed
op_assign
l_int|0
suffix:semicolon
id|open_mode
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef JAZZ16
multiline_comment|/* Function dsp_set_bits() only required for 16 bit cards&n; */
r_static
r_int
DECL|function|dsp_set_bits
id|dsp_set_bits
(paren
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
id|arg
)paren
r_if
c_cond
(paren
id|Jazz16_detected
op_eq
l_int|0
)paren
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
r_else
r_switch
c_cond
(paren
id|arg
)paren
(brace
r_case
l_int|8
suffix:colon
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|dsp_16bit
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dsp_16bit
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|dsp_16bit
ques
c_cond
l_int|16
suffix:colon
l_int|8
suffix:semicolon
)brace
macro_line|#endif /* ifdef JAZZ16 */
r_static
r_int
DECL|function|sb_dsp_ioctl
id|sb_dsp_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|local
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SOUND_PCM_WRITE_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_speed
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_speed
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_current_speed
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_current_speed
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_stereo
(paren
id|arg
op_minus
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_stereo
(paren
id|IOCTL_IN
(paren
id|arg
)paren
op_minus
l_int|1
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_stereo
op_plus
l_int|1
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_stereo
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_stereo
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_stereo
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef JAZZ16
multiline_comment|/* Word size specific cases here.&n;         * SNDCTL_DSP_SETFMT=SOUND_PCM_WRITE_BITS&n;       */
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_bits
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_bits
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_16bit
ques
c_cond
l_int|16
suffix:colon
l_int|8
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_16bit
ques
c_cond
l_int|16
suffix:colon
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
r_case
id|SOUND_PCM_WRITE_BITS
suffix:colon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
l_int|8
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;   * Only 8 bits/sample supported&n;&t;&t;&t;&t;&t; */
r_break
suffix:semicolon
macro_line|#endif /* ifdef JAZZ16  */
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_reset
id|sb_dsp_reset
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
id|dsp_speed
(paren
id|dsp_current_speed
)paren
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef JAZZ16
multiline_comment|/*&n; * Initialization of a Media Vision ProSonic 16 Soundcard.&n; * The function initializes a ProSonic 16 like PROS.EXE does for DOS. It sets&n; * the base address, the DMA-channels, interrupts and enables the joystickport.&n; *&n; * Also used by Jazz 16 (same card, different name)&n; *&n; * written 1994 by Rainer Vranken&n; * E-Mail: rvranken@polaris.informatik.uni-essen.de&n; */
macro_line|#ifndef MPU_BASE&t;&t;/* take default values if not specified */
DECL|macro|MPU_BASE
mdefine_line|#define MPU_BASE 0x330
macro_line|#endif
macro_line|#ifndef MPU_IRQ
DECL|macro|MPU_IRQ
mdefine_line|#define MPU_IRQ 9
macro_line|#endif
r_int
r_int
DECL|function|get_sb_byte
id|get_sb_byte
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
r_if
c_cond
(paren
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
(brace
r_return
id|INB
(paren
id|DSP_READ
)paren
suffix:semicolon
)brace
r_return
l_int|0xffff
suffix:semicolon
)brace
macro_line|#ifdef SM_WAVE
multiline_comment|/*&n; * Logitech Soundman Wave detection and initialization by Hannu Savolainen.&n; *&n; * There is a microcontroller (8031) in the SM Wave card for MIDI emulation.&n; * it&squot;s located at address MPU_BASE+4.  MPU_BASE+7 is a SM Wave specific&n; * control register for MC reset, SCSI, OPL4 and DSP (future expansion)&n; * address decoding. Otherwise the SM Wave is just a ordinary MV Jazz16&n; * based soundcard.&n; */
r_static
r_void
DECL|function|smw_putmem
id|smw_putmem
(paren
r_int
id|base
comma
r_int
id|addr
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|OUTB
(paren
id|addr
op_amp
l_int|0xff
comma
id|base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Low address bits */
id|OUTB
(paren
id|addr
op_rshift
l_int|8
comma
id|base
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* High address bits */
id|OUTB
(paren
id|val
comma
id|base
)paren
suffix:semicolon
multiline_comment|/* Data */
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
r_char
DECL|function|smw_getmem
id|smw_getmem
(paren
r_int
id|base
comma
r_int
id|addr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|OUTB
(paren
id|addr
op_amp
l_int|0xff
comma
id|base
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Low address bits */
id|OUTB
(paren
id|addr
op_rshift
l_int|8
comma
id|base
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* High address bits */
id|val
op_assign
id|INB
(paren
id|base
)paren
suffix:semicolon
multiline_comment|/* Data */
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_int
DECL|function|initialize_smw
id|initialize_smw
(paren
r_void
)paren
(brace
macro_line|#ifdef SMW_MIDI0001_INCLUDED
macro_line|#include &quot;smw-midi0001.h&quot;
macro_line|#else
r_int
r_char
id|smw_ucode
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|smw_ucodeLen
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_int
id|mp_base
op_assign
id|MPU_BASE
op_plus
l_int|4
suffix:semicolon
multiline_comment|/* Microcontroller base */
r_int
id|i
suffix:semicolon
r_int
r_char
id|control
suffix:semicolon
multiline_comment|/*&n;     *  Reset the microcontroller so that the RAM can be accessed&n;   */
id|control
op_assign
id|INB
(paren
id|MPU_BASE
op_plus
l_int|7
)paren
suffix:semicolon
id|OUTB
(paren
id|control
op_or
l_int|3
comma
id|MPU_BASE
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Set last two bits to 1 (?) */
id|OUTB
(paren
(paren
id|control
op_amp
l_int|0xfe
)paren
op_or
l_int|2
comma
id|MPU_BASE
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* xxxxxxx0 resets the mc */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|300
suffix:semicolon
id|i
op_increment
)paren
multiline_comment|/* Wait at least 1ms */
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|OUTB
(paren
id|control
op_amp
l_int|0xfc
comma
id|MPU_BASE
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* xxxxxx00 enables RAM */
multiline_comment|/*&n;     *  Detect microcontroller by probing the 8k RAM area&n;   */
id|smw_putmem
(paren
id|mp_base
comma
l_int|0
comma
l_int|0x00
)paren
suffix:semicolon
id|smw_putmem
(paren
id|mp_base
comma
l_int|1
comma
l_int|0xff
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smw_getmem
(paren
id|mp_base
comma
l_int|0
)paren
op_ne
l_int|0x00
op_logical_or
id|smw_getmem
(paren
id|mp_base
comma
l_int|1
)paren
op_ne
l_int|0xff
)paren
(brace
id|printk
(paren
l_string|&quot;&bslash;nSM Wave: No microcontroller RAM detected (%02x, %02x)&bslash;n&quot;
comma
id|smw_getmem
(paren
id|mp_base
comma
l_int|0
)paren
comma
id|smw_getmem
(paren
id|mp_base
comma
l_int|1
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No RAM */
)brace
multiline_comment|/*&n;     *  There is RAM so assume it&squot;s really a SM Wave&n;   */
macro_line|#ifdef SMW_MIDI0001_INCLUDED
r_if
c_cond
(paren
id|smw_ucodeLen
op_ne
l_int|8192
)paren
(brace
id|printk
(paren
l_string|&quot;&bslash;nSM Wave: Invalid microcode (MIDI0001.BIN) length&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;     *  Download microcode&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8192
suffix:semicolon
id|i
op_increment
)paren
id|smw_putmem
(paren
id|mp_base
comma
id|i
comma
id|smw_ucode
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;     *  Verify microcode&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8192
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|smw_getmem
(paren
id|mp_base
comma
id|i
)paren
op_ne
id|smw_ucode
(braket
id|i
)braket
)paren
(brace
id|printk
(paren
l_string|&quot;SM Wave: Microcode verification failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|control
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef SMW_SCSI_IRQ
multiline_comment|/*&n;     * Set the SCSI interrupt (IRQ2/9, IRQ3 or IRQ10). The SCSI interrupt&n;     * is disabled by default.&n;     *&n;     * Btw the Zilog 5380 SCSI controller is located at MPU base + 0x10.&n;   */
(brace
r_static
r_int
r_char
id|scsi_irq_bits
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|3
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|control
op_or_assign
id|scsi_irq_bits
(braket
id|SMW_SCSI_IRQ
)braket
op_lshift
l_int|6
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef SMW_OPL4_ENABLE
multiline_comment|/*&n;     *  Make the OPL4 chip visible on the PC bus at 0x380.&n;     *&n;     *  There is no need to enable this feature since VoxWare&n;     *  doesn&squot;t support OPL4 yet. Also there is no RAM in SM Wave so&n;     *  enabling OPL4 is pretty useless.&n;   */
id|control
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Uses IRQ12 if bit 0x20 == 0 */
multiline_comment|/* control |= 0x20;      Uncomment this if you want to use IRQ7 */
macro_line|#endif
id|OUTB
(paren
id|control
op_or
l_int|0x03
comma
id|MPU_BASE
op_plus
l_int|7
)paren
suffix:semicolon
multiline_comment|/* xxxxxx11 restarts */
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|initialize_ProSonic16
id|initialize_ProSonic16
(paren
r_void
)paren
(brace
r_int
id|x
suffix:semicolon
r_static
r_int
r_char
id|int_translat
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|3
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|2
comma
l_int|5
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|6
)brace
comma
id|dma_translat
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|4
)brace
suffix:semicolon
id|OUTB
(paren
l_int|0xAF
comma
l_int|0x201
)paren
suffix:semicolon
multiline_comment|/* ProSonic/Jazz16 wakeup */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
l_int|1000
suffix:semicolon
op_increment
id|x
)paren
multiline_comment|/* wait 10 milliseconds */
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0x50
comma
l_int|0x201
)paren
suffix:semicolon
id|OUTB
(paren
(paren
id|sbc_base
op_amp
l_int|0x70
)paren
op_or
(paren
(paren
id|MPU_BASE
op_amp
l_int|0x30
)paren
op_rshift
l_int|4
)paren
comma
l_int|0x201
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_reset_dsp
(paren
)paren
)paren
(brace
multiline_comment|/* OK. We have at least a SB */
multiline_comment|/* Check the version number of ProSonic (I guess) */
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_command
(paren
l_int|0xFA
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|get_sb_byte
(paren
)paren
op_ne
l_int|0x12
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0xFB
)paren
op_logical_and
multiline_comment|/* set DMA-channels and Interrupts */
id|sb_dsp_command
(paren
(paren
id|dma_translat
(braket
id|JAZZ_DMA16
)braket
op_lshift
l_int|4
)paren
op_or
id|dma_translat
(braket
id|SBC_DMA
)braket
)paren
op_logical_and
id|sb_dsp_command
(paren
(paren
id|int_translat
(braket
id|MPU_IRQ
)braket
op_lshift
l_int|4
)paren
op_or
id|int_translat
(braket
id|sbc_irq
)braket
)paren
)paren
(brace
id|Jazz16_detected
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef SM_WAVE
r_if
c_cond
(paren
id|initialize_smw
(paren
)paren
)paren
id|Jazz16_detected
op_assign
l_int|2
suffix:semicolon
macro_line|#endif
id|sb_dsp_disable_midi
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* There was at least a SB */
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No SB or ProSonic16 detected */
)brace
macro_line|#endif /* ifdef JAZZ16  */
r_int
DECL|function|sb_dsp_detect
id|sb_dsp_detect
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|sbc_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|sbc_irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_ok
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Already initialized&n;&t;&t;&t;&t; */
macro_line|#ifdef JAZZ16
id|dma8
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|dma16
op_assign
id|JAZZ_DMA16
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|initialize_ProSonic16
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|sb_reset_dsp
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Detected&n;&t;&t;&t;&t; */
)brace
macro_line|#ifndef EXCLUDE_AUDIO
DECL|variable|sb_dsp_operations
r_static
r_struct
id|audio_operations
id|sb_dsp_operations
op_assign
(brace
l_string|&quot;SoundBlaster&quot;
comma
id|NOTHING_SPECIAL
comma
id|AFMT_U8
comma
multiline_comment|/* Just 8 bits. Poor old SB */
l_int|NULL
comma
id|sb_dsp_open
comma
id|sb_dsp_close
comma
id|sb_dsp_output_block
comma
id|sb_dsp_start_input
comma
id|sb_dsp_ioctl
comma
id|sb_dsp_prepare_for_input
comma
id|sb_dsp_prepare_for_output
comma
id|sb_dsp_reset
comma
id|sb_dsp_halt_xfer
comma
l_int|NULL
comma
multiline_comment|/* local_qlen */
l_int|NULL
multiline_comment|/* copy_from_user */
)brace
suffix:semicolon
macro_line|#endif
r_int
DECL|function|sb_dsp_init
id|sb_dsp_init
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|mixer_type
op_assign
l_int|0
suffix:semicolon
id|sbc_major
op_assign
id|sbc_minor
op_assign
l_int|0
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0xe1
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Get version&n;&t;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * wait for Data Ready&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|0
)paren
id|sbc_major
op_assign
id|INB
(paren
id|DSP_READ
)paren
suffix:semicolon
r_else
(brace
id|sbc_minor
op_assign
id|INB
(paren
id|DSP_READ
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|2
op_logical_or
id|sbc_major
op_eq
l_int|3
)paren
id|sb_duplex_midi
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|4
)paren
id|sb16
op_assign
l_int|1
suffix:semicolon
macro_line|#ifndef EXCLUDE_SBPRO
r_if
c_cond
(paren
id|sbc_major
op_ge
l_int|3
)paren
id|mixer_type
op_assign
id|sb_mixer_init
(paren
id|sbc_major
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|sbc_major
op_ge
l_int|3
)paren
id|printk
(paren
l_string|&quot;&bslash;n&bslash;n&bslash;n&bslash;nNOTE! SB Pro support is required with your soundcard!&bslash;n&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef EXCLUDE_YM3812
r_if
c_cond
(paren
id|sbc_major
OG
l_int|3
op_logical_or
(paren
id|sbc_major
op_eq
l_int|3
op_logical_and
id|INB
(paren
l_int|0x388
)paren
op_eq
l_int|0x00
)paren
)paren
multiline_comment|/* Should be 0x06 if not OPL-3 */
id|enable_opl3_mode
(paren
id|OPL3_LEFT
comma
id|OPL3_RIGHT
comma
id|OPL3_BOTH
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef EXCLUDE_AUDIO
r_if
c_cond
(paren
id|sbc_major
op_ge
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|Jazz16_detected
)paren
(brace
r_if
c_cond
(paren
id|Jazz16_detected
op_eq
l_int|2
)paren
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundMan Wave %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
r_else
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;MV Jazz16 %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
id|sb_dsp_operations.format_mask
op_or_assign
id|AFMT_S16_LE
suffix:semicolon
multiline_comment|/* Hurrah, 16 bits          */
)brace
r_else
macro_line|#ifdef __SGNXPRO__
r_if
c_cond
(paren
id|mixer_type
op_eq
l_int|2
)paren
(brace
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;Sound Galaxy NX Pro %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
id|sbc_major
op_eq
l_int|4
)paren
(brace
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster 16 %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
)brace
r_else
(brace
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster Pro %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster %d.%d&quot;
comma
id|sbc_major
comma
id|sbc_minor
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot; &lt;%s&gt;&quot;
comma
id|sb_dsp_operations.name
)paren
suffix:semicolon
macro_line|#if !defined(EXCLUDE_SB16) &amp;&amp; !defined(EXCLUDE_SBPRO)
r_if
c_cond
(paren
op_logical_neg
id|sb16
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * There is a better driver for SB16&n;&t;&t;&t;&t; */
macro_line|#endif
r_if
c_cond
(paren
id|num_audiodevs
OL
id|MAX_AUDIO_DEV
)paren
(brace
id|audio_devs
(braket
id|my_dev
op_assign
id|num_audiodevs
op_increment
)braket
op_assign
op_amp
id|sb_dsp_operations
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|buffcount
op_assign
id|DSP_BUFFCOUNT
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|buffsize
op_assign
id|DSP_BUFFSIZE
suffix:semicolon
id|audio_devs
(braket
id|my_dev
)braket
op_member_access_from_pointer
id|dmachan
op_assign
id|hw_config-&gt;dma
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB: Too many DSP devices available&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
id|printk
(paren
l_string|&quot; &lt;SoundBlaster (configured without audio support)&gt;&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef EXCLUDE_MIDI
r_if
c_cond
(paren
op_logical_neg
id|midi_disabled
op_logical_and
op_logical_neg
id|sb16
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * Midi don&squot;t work in the SB emulation mode *&n;&t;&t;&t;&t; * of PAS, SB16 has better midi interface&n;&t;&t;&t;&t; */
id|sb_midi_init
(paren
id|sbc_major
)paren
suffix:semicolon
macro_line|#endif
id|sb_dsp_ok
op_assign
l_int|1
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_void
DECL|function|sb_dsp_disable_midi
id|sb_dsp_disable_midi
(paren
r_void
)paren
(brace
id|midi_disabled
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
eof
