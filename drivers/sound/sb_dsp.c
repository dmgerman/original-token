multiline_comment|/*&n; * linux/kernel/chr_drv/sound/sb_dsp.c&n; * &n; * The low level driver for the SoundBlaster DS chips.&n; * &n; * Copyright by Hannu Savolainen 1993&n; * &n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; * &n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; * &n; * The mixer support is based on the SB-BSD 1.5 driver by (C) Steve Haehnichen&n; * &lt;shaehnic@ucsd.edu&gt;&n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_SB)
DECL|macro|SB_TEST_IRQ
macro_line|#undef SB_TEST_IRQ
DECL|macro|DSP_RESET
mdefine_line|#define DSP_RESET&t;(sbc_base + 0x6)
DECL|macro|DSP_READ
mdefine_line|#define DSP_READ&t;(sbc_base + 0xA)
DECL|macro|DSP_WRITE
mdefine_line|#define DSP_WRITE&t;(sbc_base + 0xC)
DECL|macro|DSP_COMMAND
mdefine_line|#define DSP_COMMAND&t;(sbc_base + 0xC)
DECL|macro|DSP_STATUS
mdefine_line|#define DSP_STATUS&t;(sbc_base + 0xC)
DECL|macro|DSP_DATA_AVAIL
mdefine_line|#define DSP_DATA_AVAIL&t;(sbc_base + 0xE)
DECL|macro|MIXER_ADDR
mdefine_line|#define MIXER_ADDR&t;(sbc_base + 0x4)
DECL|macro|MIXER_DATA
mdefine_line|#define MIXER_DATA&t;(sbc_base + 0x5)
DECL|macro|OPL3_LEFT
mdefine_line|#define OPL3_LEFT&t;(sbc_base + 0x0)
DECL|macro|OPL3_RIGHT
mdefine_line|#define OPL3_RIGHT&t;(sbc_base + 0x2)
DECL|macro|OPL3_BOTH
mdefine_line|#define OPL3_BOTH&t;(sbc_base + 0x8)
DECL|variable|sbc_base
r_static
r_int
id|sbc_base
op_assign
l_int|0
suffix:semicolon
DECL|variable|sbc_irq
r_static
r_int
id|sbc_irq
op_assign
l_int|0
suffix:semicolon
DECL|macro|POSSIBLE_RECORDING_DEVICES
mdefine_line|#define POSSIBLE_RECORDING_DEVICES&t;(SOUND_MASK_LINE | SOUND_MASK_MIC | SOUND_MASK_CD)
DECL|macro|SUPPORTED_MIXER_DEVICES
mdefine_line|#define SUPPORTED_MIXER_DEVICES&t;&t;(SOUND_MASK_SYNTH | SOUND_MASK_PCM | SOUND_MASK_LINE | SOUND_MASK_MIC | &bslash;&n;&t;&t;&t;&t;&t; SOUND_MASK_CD | SOUND_MASK_VOLUME)
multiline_comment|/*&n; * Mixer registers&n; * &n; * NOTE!&t;RECORD_SRC == IN_FILTER&n; */
DECL|macro|VOC_VOL
mdefine_line|#define VOC_VOL&t;&t;0x04
DECL|macro|MIC_VOL
mdefine_line|#define MIC_VOL&t;&t;0x0A
DECL|macro|MIC_MIX
mdefine_line|#define MIC_MIX&t;&t;0x0A
DECL|macro|RECORD_SRC
mdefine_line|#define RECORD_SRC&t;0x0C
DECL|macro|IN_FILTER
mdefine_line|#define IN_FILTER&t;0x0C
DECL|macro|OUT_FILTER
mdefine_line|#define OUT_FILTER&t;0x0E
DECL|macro|MASTER_VOL
mdefine_line|#define MASTER_VOL&t;0x22
DECL|macro|FM_VOL
mdefine_line|#define FM_VOL&t;&t;0x26
DECL|macro|CD_VOL
mdefine_line|#define CD_VOL&t;&t;0x28
DECL|macro|LINE_VOL
mdefine_line|#define LINE_VOL&t;0x2E
DECL|macro|FREQ_HI
mdefine_line|#define FREQ_HI         (1 &lt;&lt; 3)/* Use High-frequency ANFI filters */
DECL|macro|FREQ_LOW
mdefine_line|#define FREQ_LOW        0&t;/* Use Low-frequency ANFI filters */
DECL|macro|FILT_ON
mdefine_line|#define FILT_ON         0&t;/* Yes, 0 to turn it on, 1 for off */
DECL|macro|FILT_OFF
mdefine_line|#define FILT_OFF        (1 &lt;&lt; 5)
multiline_comment|/* Convenient byte masks */
DECL|macro|B1
mdefine_line|#define B1(x)&t;((x) &amp; 0x01)
DECL|macro|B2
mdefine_line|#define B2(x)&t;((x) &amp; 0x03)
DECL|macro|B3
mdefine_line|#define B3(x)&t;((x) &amp; 0x07)
DECL|macro|B4
mdefine_line|#define B4(x)&t;((x) &amp; 0x0f)
DECL|macro|B5
mdefine_line|#define B5(x)&t;((x) &amp; 0x1f)
DECL|macro|B6
mdefine_line|#define B6(x)&t;((x) &amp; 0x3f)
DECL|macro|B7
mdefine_line|#define B7(x)&t;((x) &amp; 0x7f)
DECL|macro|B8
mdefine_line|#define B8(x)&t;((x) &amp; 0xff)
DECL|macro|F
mdefine_line|#define F(x)&t;(!!(x))&t;&t;/* 0 or 1 only */
DECL|macro|MONO_DAC
mdefine_line|#define MONO_DAC&t;0x00
DECL|macro|STEREO_DAC
mdefine_line|#define STEREO_DAC&t;0x02
multiline_comment|/* DSP Commands */
DECL|macro|DSP_CMD_SPKON
mdefine_line|#define DSP_CMD_SPKON&t;&t;0xD1
DECL|macro|DSP_CMD_SPKOFF
mdefine_line|#define DSP_CMD_SPKOFF&t;&t;0xD3
multiline_comment|/*&n; * The DSP channel can be used either for input or output. Variable&n; * &squot;irq_mode&squot; will be set when the program calls read or write first time&n; * after open. Current version doesn&squot;t support mode changes without closing&n; * and reopening the device. Support for this feature may be implemented in a&n; * future version of this driver.&n; */
DECL|macro|IMODE_NONE
mdefine_line|#define IMODE_NONE&t;&t;0
DECL|macro|IMODE_OUTPUT
mdefine_line|#define IMODE_OUTPUT&t;&t;1
DECL|macro|IMODE_INPUT
mdefine_line|#define IMODE_INPUT&t;&t;2
DECL|macro|IMODE_INIT
mdefine_line|#define IMODE_INIT&t;&t;3
DECL|macro|IMODE_MIDI
mdefine_line|#define IMODE_MIDI&t;&t;4
DECL|macro|NORMAL_MIDI
mdefine_line|#define NORMAL_MIDI&t;0
DECL|macro|UART_MIDI
mdefine_line|#define UART_MIDI&t;1
DECL|variable|sb_dsp_ok
r_static
r_int
id|sb_dsp_ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set to 1 after successful initialization */
DECL|variable|midi_disabled
r_static
r_int
id|midi_disabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_highspeed
DECL|variable|dsp_stereo
r_static
r_int
id|dsp_highspeed
op_assign
l_int|0
comma
id|dsp_stereo
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_current_speed
r_static
r_int
id|dsp_current_speed
op_assign
id|DSP_DEFAULT_SPEED
suffix:semicolon
DECL|variable|sb16
r_static
r_int
id|sb16
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef EXCLUDE_SBPRO
DECL|variable|rec_devices
r_static
r_int
id|rec_devices
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
DECL|variable|hi_filter
DECL|variable|filter_in
DECL|variable|filter_out
r_static
r_int
id|hi_filter
op_assign
l_int|0
comma
id|filter_in
op_assign
l_int|0
comma
id|filter_out
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|variable|midi_mode
r_static
r_int
id|midi_mode
op_assign
id|NORMAL_MIDI
suffix:semicolon
DECL|variable|midi_busy
r_static
r_int
id|midi_busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 1 if the process has output to MIDI */
DECL|variable|dsp_busy
r_static
r_int
id|dsp_busy
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq_mode
r_static
r_volatile
r_int
id|irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
multiline_comment|/* IMODE_INPUT, IMODE_OUTPUT&n;&t;&t;&t;&t;&t;&t; * or IMODE_NONE */
DECL|variable|irq_ok
r_static
r_volatile
r_int
id|irq_ok
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_model
r_static
r_int
id|dsp_model
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1=SB, 2=SB Pro */
DECL|variable|duplex_midi
r_static
r_int
id|duplex_midi
op_assign
l_int|0
suffix:semicolon
DECL|variable|my_dev
r_static
r_int
id|my_dev
op_assign
l_int|0
suffix:semicolon
DECL|variable|intr_active
r_static
r_volatile
r_int
id|intr_active
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|dsp_speed
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|dsp_set_stereo
(paren
r_int
id|mode
)paren
suffix:semicolon
r_static
r_int
id|dsp_command
(paren
r_int
r_char
id|val
)paren
suffix:semicolon
macro_line|#ifndef EXCLUDE_SBPRO
r_static
r_void
id|setmixer
(paren
r_int
r_char
id|port
comma
r_int
r_char
id|value
)paren
suffix:semicolon
r_static
r_int
id|getmixer
(paren
r_int
r_char
id|port
)paren
suffix:semicolon
r_static
r_void
id|init_mixer
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|detect_mixer
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if !defined(EXCLUDE_MIDI) || !defined(EXCLUDE_AUDIO)
multiline_comment|/* Common code for the midi and pcm functions */
r_static
r_int
DECL|function|dsp_command
id|dsp_command
(paren
r_int
r_char
id|val
)paren
(brace
r_int
id|i
comma
id|limit
suffix:semicolon
id|limit
op_assign
id|GET_TIME
(paren
)paren
op_plus
l_int|10
suffix:semicolon
multiline_comment|/* The timeout is 0.1 secods */
multiline_comment|/*&n;   * Note! the i&lt;5000000 is an emergency exit. The dsp_command() is sometimes&n;   * called while interrupts are disabled. This means that the timer is&n;   * disabled also. However the timeout situation is a abnormal condition.&n;   * Normally the DSP should be ready to accept commands after just couple of&n;   * loops.&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5000000
op_logical_and
id|GET_TIME
(paren
)paren
OL
id|limit
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|INB
(paren
id|DSP_STATUS
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
id|OUTB
(paren
id|val
comma
id|DSP_COMMAND
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;SoundBlaster: DSP Command(%02x) Timeout.&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;IRQ conflict???&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|sbintr
id|sbintr
(paren
r_int
id|unused
)paren
(brace
r_int
id|status
comma
id|data
suffix:semicolon
macro_line|#ifndef EXCLUDE_SBPRO
r_if
c_cond
(paren
id|sb16
)paren
(brace
r_int
r_char
id|src
op_assign
id|getmixer
(paren
l_int|0x82
)paren
suffix:semicolon
multiline_comment|/* Interrupt status register */
r_if
c_cond
(paren
op_logical_neg
(paren
id|src
op_amp
l_int|1
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Not a DSP interupt */
)brace
macro_line|#endif
id|status
op_assign
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt */
r_if
c_cond
(paren
id|intr_active
)paren
r_switch
c_cond
(paren
id|irq_mode
)paren
(brace
r_case
id|IMODE_OUTPUT
suffix:colon
id|intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_outputintr
(paren
id|my_dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INPUT
suffix:colon
id|intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_inputintr
(paren
id|my_dev
)paren
suffix:semicolon
multiline_comment|/* A complete buffer has been input. Let&squot;s start new one */
r_break
suffix:semicolon
r_case
id|IMODE_INIT
suffix:colon
id|intr_active
op_assign
l_int|0
suffix:semicolon
id|irq_ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_MIDI
suffix:colon
id|printk
(paren
l_string|&quot;+&quot;
)paren
suffix:semicolon
id|data
op_assign
id|INB
(paren
id|DSP_READ
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%02x&quot;
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;SoundBlaster: Unexpected interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|set_dsp_irq
id|set_dsp_irq
(paren
r_int
id|interrupt_level
)paren
(brace
r_int
id|retcode
suffix:semicolon
macro_line|#ifdef linux
r_struct
id|sigaction
id|sa
suffix:semicolon
id|sa.sa_handler
op_assign
id|sbintr
suffix:semicolon
macro_line|#ifdef SND_SA_INTERRUPT
id|sa.sa_flags
op_assign
id|SA_INTERRUPT
suffix:semicolon
macro_line|#else
id|sa.sa_flags
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|sa.sa_mask
op_assign
l_int|0
suffix:semicolon
id|sa.sa_restorer
op_assign
l_int|NULL
suffix:semicolon
id|retcode
op_assign
id|irqaction
(paren
id|interrupt_level
comma
op_amp
id|sa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retcode
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;SoundBlaster: IRQ%d already in use&bslash;n&quot;
comma
id|interrupt_level
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* #  error Unimplemented for this OS&t; */
macro_line|#endif
r_return
id|retcode
suffix:semicolon
)brace
r_static
r_int
DECL|function|reset_dsp
id|reset_dsp
(paren
r_void
)paren
(brace
r_int
id|loopc
suffix:semicolon
id|OUTB
(paren
l_int|1
comma
id|DSP_RESET
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0
comma
id|DSP_RESET
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loopc
op_assign
l_int|0
suffix:semicolon
id|loopc
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
suffix:semicolon
id|loopc
op_increment
)paren
suffix:semicolon
multiline_comment|/* Wait for data&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; * available status */
r_if
c_cond
(paren
id|INB
(paren
id|DSP_READ
)paren
op_ne
l_int|0xAA
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Sorry */
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifndef EXCLUDE_AUDIO
r_static
r_void
DECL|function|dsp_speaker
id|dsp_speaker
(paren
r_char
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
id|dsp_command
(paren
id|DSP_CMD_SPKON
)paren
suffix:semicolon
r_else
id|dsp_command
(paren
id|DSP_CMD_SPKOFF
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_speed
id|dsp_speed
(paren
r_int
id|speed
)paren
(brace
r_int
r_char
id|tconst
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|speed
OL
l_int|4000
)paren
id|speed
op_assign
l_int|4000
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
l_int|44100
)paren
id|speed
op_assign
l_int|44100
suffix:semicolon
multiline_comment|/* Invalid speed */
r_if
c_cond
(paren
id|dsp_model
op_eq
l_int|1
op_logical_and
id|speed
OG
l_int|22050
)paren
id|speed
op_assign
l_int|22050
suffix:semicolon
multiline_comment|/* SB Classic doesn&squot;t support higher speed */
r_if
c_cond
(paren
id|dsp_stereo
op_logical_and
id|speed
OG
l_int|22050
)paren
id|speed
op_assign
l_int|22050
suffix:semicolon
multiline_comment|/* Max. stereo speed is 22050 */
r_if
c_cond
(paren
(paren
id|speed
OG
l_int|22050
)paren
op_logical_and
id|midi_busy
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: High speed DSP not possible simultaneously with MIDI output&bslash;n&quot;
)paren
suffix:semicolon
id|speed
op_assign
l_int|22050
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|speed
op_lshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now the speed should be valid */
r_if
c_cond
(paren
id|speed
OG
l_int|22050
)paren
(brace
multiline_comment|/* High speed mode */
id|tconst
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
l_int|65536
op_minus
(paren
l_int|256000000
op_div
id|speed
)paren
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|dsp_highspeed
op_assign
l_int|1
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_command
(paren
l_int|0x40
)paren
)paren
id|dsp_command
(paren
id|tconst
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|speed
op_assign
(paren
l_int|256000000
op_div
(paren
l_int|65536
op_minus
(paren
id|tconst
op_lshift
l_int|8
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|dsp_highspeed
op_assign
l_int|0
suffix:semicolon
id|tconst
op_assign
(paren
l_int|256
op_minus
(paren
l_int|1000000
op_div
id|speed
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_command
(paren
l_int|0x40
)paren
)paren
multiline_comment|/* Set time constant */
id|dsp_command
(paren
id|tconst
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|speed
op_assign
l_int|1000000
op_div
(paren
l_int|256
op_minus
id|tconst
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|speed
op_rshift_assign
l_int|1
suffix:semicolon
id|dsp_current_speed
op_assign
id|speed
suffix:semicolon
r_return
id|speed
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_set_stereo
id|dsp_set_stereo
(paren
r_int
id|mode
)paren
(brace
id|dsp_stereo
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dsp_model
op_eq
l_int|1
op_logical_or
id|sb16
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Sorry no stereo */
r_if
c_cond
(paren
id|mode
op_logical_and
id|midi_busy
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: Stereo DSP not possible simultaneously with MIDI output&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dsp_stereo
op_assign
op_logical_neg
op_logical_neg
id|mode
suffix:semicolon
macro_line|#ifndef EXCLUDE_SBPRO
id|setmixer
(paren
id|OUT_FILTER
comma
(paren
(paren
id|getmixer
(paren
id|OUT_FILTER
)paren
op_amp
op_complement
id|STEREO_DAC
)paren
op_or
(paren
id|mode
ques
c_cond
id|STEREO_DAC
suffix:colon
id|MONO_DAC
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|dsp_speed
(paren
id|dsp_current_speed
)paren
suffix:semicolon
multiline_comment|/* Speed must be recalculated if #channels&n;&t;&t;&t;&t; * changes */
r_return
id|mode
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_output_block
id|sb_dsp_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_mode
)paren
id|dsp_speaker
(paren
id|ON
)paren
suffix:semicolon
id|irq_mode
op_assign
id|IMODE_OUTPUT
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound_dsp_dmachan
(braket
id|dev
)braket
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|dsp_highspeed
)paren
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_command
(paren
l_int|0x48
)paren
)paren
multiline_comment|/* High speed size */
(brace
id|dsp_command
(paren
id|count
op_amp
l_int|0xff
)paren
suffix:semicolon
id|dsp_command
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|dsp_command
(paren
l_int|0x91
)paren
suffix:semicolon
multiline_comment|/* High speed 8 bit DAC */
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start (high speed) DAC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_command
(paren
l_int|0x14
)paren
)paren
multiline_comment|/* 8-bit DAC (DMA) */
(brace
id|dsp_command
(paren
id|count
op_amp
l_int|0xff
)paren
suffix:semicolon
id|dsp_command
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start DAC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
id|intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_start_input
id|sb_dsp_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
)paren
(brace
multiline_comment|/* Start a DMA input to the buffer pointed by dmaqtail */
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_mode
)paren
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
id|irq_mode
op_assign
id|IMODE_INPUT
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound_dsp_dmachan
(braket
id|dev
)braket
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|dsp_highspeed
)paren
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_command
(paren
l_int|0x48
)paren
)paren
multiline_comment|/* High speed size */
(brace
id|dsp_command
(paren
id|count
op_amp
l_int|0xff
)paren
suffix:semicolon
id|dsp_command
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|dsp_command
(paren
l_int|0x99
)paren
suffix:semicolon
multiline_comment|/* High speed 8 bit ADC */
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start (high speed) ADC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_command
(paren
l_int|0x24
)paren
)paren
multiline_comment|/* 8-bit ADC (DMA) */
(brace
id|dsp_command
(paren
id|count
op_amp
l_int|0xff
)paren
suffix:semicolon
id|dsp_command
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start ADC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
id|intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|dsp_cleanup
id|dsp_cleanup
(paren
r_void
)paren
(brace
id|intr_active
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_prepare_for_input
id|sb_dsp_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_prepare_for_output
id|sb_dsp_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|ON
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_halt_xfer
id|sb_dsp_halt_xfer
(paren
r_int
id|dev
)paren
(brace
)brace
r_static
r_int
DECL|function|sb_dsp_open
id|sb_dsp_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: SoundBlaster board not installed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|irq_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: Incorrect IRQ setting (%d)&bslash;n&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_active
op_logical_or
(paren
id|midi_busy
op_logical_and
id|midi_mode
op_eq
id|UART_MIDI
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;SB: PCM not possible during MIDI input&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mode
op_ne
id|OPEN_READ
op_logical_and
id|mode
op_ne
id|OPEN_WRITE
)paren
(brace
id|printk
(paren
l_string|&quot;SoundBlaster error: DAC and ACD not possible simultaneously&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|retval
op_assign
id|set_dsp_irq
(paren
id|sbc_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DMAbuf_open_dma
(paren
id|dev
)paren
)paren
(brace
id|RELEASE_IRQ
(paren
id|sbc_irq
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;SB: DMA Busy&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
id|dsp_set_stereo
(paren
id|OFF
)paren
suffix:semicolon
id|dsp_speed
(paren
id|DSP_DEFAULT_SPEED
)paren
suffix:semicolon
id|irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
id|dsp_busy
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_close
id|sb_dsp_close
(paren
r_int
id|dev
)paren
(brace
id|DMAbuf_close_dma
(paren
id|dev
)paren
suffix:semicolon
id|RELEASE_IRQ
(paren
id|sbc_irq
)paren
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speed
(paren
id|DSP_DEFAULT_SPEED
)paren
suffix:semicolon
id|dsp_set_stereo
(paren
id|OFF
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
id|dsp_busy
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_ioctl
id|sb_dsp_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|local
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SOUND_PCM_WRITE_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_speed
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_speed
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_current_speed
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_current_speed
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_CHANNELS
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_stereo
(paren
id|IOCTL_IN
(paren
id|arg
)paren
op_minus
l_int|1
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_stereo
op_plus
l_int|1
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_stereo
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_stereo
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_stereo
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_BITS
suffix:colon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
l_int|8
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Only 8 bits/sample supported */
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_reset
id|sb_dsp_reset
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|reset_dsp
(paren
)paren
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
r_int
DECL|function|sb_dsp_detect
id|sb_dsp_detect
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|sbc_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|sbc_irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_ok
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Already initialized */
r_if
c_cond
(paren
op_logical_neg
id|reset_dsp
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Detected */
)brace
macro_line|#ifndef EXCLUDE_SBPRO
r_static
r_void
DECL|function|setmixer
id|setmixer
(paren
r_int
r_char
id|port
comma
r_int
r_char
id|value
)paren
(brace
id|OUTB
(paren
id|port
comma
id|MIXER_ADDR
)paren
suffix:semicolon
multiline_comment|/* Select register */
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|OUTB
(paren
id|value
comma
id|MIXER_DATA
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|getmixer
id|getmixer
(paren
r_int
r_char
id|port
)paren
(brace
r_int
id|val
suffix:semicolon
id|OUTB
(paren
id|port
comma
id|MIXER_ADDR
)paren
suffix:semicolon
multiline_comment|/* Select register */
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|val
op_assign
id|INB
(paren
id|MIXER_DATA
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_int
DECL|function|detect_mixer
id|detect_mixer
(paren
r_void
)paren
(brace
multiline_comment|/*&n;   * Detect the mixer by changing parameters of two volume channels. If the&n;   * values read back match with the values written, the mixer is there (is&n;   * it?)&n;   */
id|setmixer
(paren
id|FM_VOL
comma
l_int|0xff
)paren
suffix:semicolon
id|setmixer
(paren
id|VOC_VOL
comma
l_int|0x33
)paren
suffix:semicolon
r_if
c_cond
(paren
id|getmixer
(paren
id|FM_VOL
)paren
op_ne
l_int|0xff
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* No match */
r_if
c_cond
(paren
id|getmixer
(paren
id|VOC_VOL
)paren
op_ne
l_int|0x33
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|init_mixer
id|init_mixer
(paren
r_void
)paren
(brace
id|setmixer
(paren
id|MASTER_VOL
comma
l_int|0xbb
)paren
suffix:semicolon
id|setmixer
(paren
id|VOC_VOL
comma
l_int|0x99
)paren
suffix:semicolon
id|setmixer
(paren
id|LINE_VOL
comma
l_int|0xbb
)paren
suffix:semicolon
id|setmixer
(paren
id|FM_VOL
comma
l_int|0x99
)paren
suffix:semicolon
id|setmixer
(paren
id|CD_VOL
comma
l_int|0x11
)paren
suffix:semicolon
id|setmixer
(paren
id|MIC_MIX
comma
l_int|0x11
)paren
suffix:semicolon
id|setmixer
(paren
id|RECORD_SRC
comma
l_int|0x31
)paren
suffix:semicolon
id|setmixer
(paren
id|OUT_FILTER
comma
l_int|0x31
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_filter
id|set_filter
(paren
r_int
id|record_source
comma
r_int
id|hifreq_filter
comma
r_int
id|filter_input
comma
r_int
id|filter_output
)paren
(brace
id|setmixer
(paren
id|RECORD_SRC
comma
(paren
id|record_source
op_or
(paren
id|hifreq_filter
ques
c_cond
id|FREQ_HI
suffix:colon
id|FREQ_LOW
)paren
op_or
(paren
id|filter_input
ques
c_cond
id|FILT_ON
suffix:colon
id|FILT_OFF
)paren
)paren
)paren
suffix:semicolon
id|setmixer
(paren
id|OUT_FILTER
comma
(paren
(paren
id|dsp_stereo
ques
c_cond
id|STEREO_DAC
suffix:colon
id|MONO_DAC
)paren
op_or
(paren
id|filter_output
ques
c_cond
id|FILT_ON
suffix:colon
id|FILT_OFF
)paren
)paren
)paren
suffix:semicolon
id|hi_filter
op_assign
id|hifreq_filter
suffix:semicolon
id|filter_in
op_assign
id|filter_input
suffix:semicolon
id|filter_out
op_assign
id|filter_output
suffix:semicolon
)brace
r_static
r_int
DECL|function|mixer_output
id|mixer_output
(paren
r_int
id|right_vol
comma
r_int
id|left_vol
comma
r_int
id|div
comma
r_int
id|device
)paren
(brace
r_int
id|left
op_assign
(paren
(paren
id|left_vol
op_star
id|div
)paren
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
r_int
id|right
op_assign
(paren
(paren
id|right_vol
op_star
id|div
)paren
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
id|setmixer
(paren
id|device
comma
(paren
(paren
id|left
op_amp
l_int|0xf
)paren
op_lshift
l_int|4
)paren
op_or
(paren
id|right
op_amp
l_int|0xf
)paren
)paren
suffix:semicolon
r_return
(paren
id|left_vol
op_or
(paren
id|right_vol
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sbp_mixer_set
id|sbp_mixer_set
(paren
r_int
id|whichDev
comma
r_int
r_int
id|level
)paren
(brace
r_int
id|left
comma
id|right
comma
id|devmask
suffix:semicolon
id|left
op_assign
id|level
op_amp
l_int|0x7f
suffix:semicolon
id|right
op_assign
(paren
id|level
op_amp
l_int|0x7f00
)paren
op_rshift
l_int|8
suffix:semicolon
r_switch
c_cond
(paren
id|whichDev
)paren
(brace
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
multiline_comment|/* Master volume (0-15) */
r_return
id|mixer_output
(paren
id|right
comma
id|left
comma
l_int|15
comma
id|MASTER_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_SYNTH
suffix:colon
multiline_comment|/* Internal synthesizer (0-15) */
r_return
id|mixer_output
(paren
id|right
comma
id|left
comma
l_int|15
comma
id|FM_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_PCM
suffix:colon
multiline_comment|/* PAS PCM (0-15) */
r_return
id|mixer_output
(paren
id|right
comma
id|left
comma
l_int|15
comma
id|VOC_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_LINE
suffix:colon
multiline_comment|/* External line (0-15) */
r_return
id|mixer_output
(paren
id|right
comma
id|left
comma
l_int|15
comma
id|LINE_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CD
suffix:colon
multiline_comment|/* CD (0-15) */
r_return
id|mixer_output
(paren
id|right
comma
id|left
comma
l_int|15
comma
id|CD_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_MIC
suffix:colon
multiline_comment|/* External microphone (0-7) */
r_return
id|mixer_output
(paren
id|right
comma
id|left
comma
l_int|7
comma
id|MIC_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
id|devmask
op_assign
id|level
op_amp
id|POSSIBLE_RECORDING_DEVICES
suffix:semicolon
r_if
c_cond
(paren
id|devmask
op_ne
id|SOUND_MASK_MIC
op_logical_and
id|devmask
op_ne
id|SOUND_MASK_LINE
op_logical_and
id|devmask
op_ne
id|SOUND_MASK_CD
)paren
(brace
multiline_comment|/* More than one devices selected. Drop the&n;&t;&t;&t;&t; * previous selection */
id|devmask
op_and_assign
op_complement
id|rec_devices
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devmask
op_ne
id|SOUND_MASK_MIC
op_logical_and
id|devmask
op_ne
id|SOUND_MASK_LINE
op_logical_and
id|devmask
op_ne
id|SOUND_MASK_CD
)paren
(brace
multiline_comment|/* More than one devices selected. Default to&n;&t;&t;&t;&t; * mic */
id|devmask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devmask
op_xor
id|rec_devices
)paren
multiline_comment|/* Input source changed */
(brace
r_switch
c_cond
(paren
id|devmask
)paren
(brace
r_case
id|SOUND_MASK_MIC
suffix:colon
id|set_filter
(paren
id|SRC_MIC
comma
id|hi_filter
comma
id|filter_in
comma
id|filter_out
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_LINE
suffix:colon
id|set_filter
(paren
id|SRC_LINE
comma
id|hi_filter
comma
id|filter_in
comma
id|filter_out
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MASK_CD
suffix:colon
id|set_filter
(paren
id|SRC_CD
comma
id|hi_filter
comma
id|filter_in
comma
id|filter_out
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|set_filter
(paren
id|SRC_MIC
comma
id|hi_filter
comma
id|filter_in
comma
id|filter_out
)paren
suffix:semicolon
)brace
)brace
id|rec_devices
op_assign
id|devmask
suffix:semicolon
r_return
id|rec_devices
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|mixer_input
id|mixer_input
(paren
r_int
id|div
comma
r_int
id|device
)paren
(brace
r_int
id|level
comma
id|left
comma
id|right
comma
id|half
suffix:semicolon
id|level
op_assign
id|getmixer
(paren
id|device
)paren
suffix:semicolon
id|half
op_assign
id|div
op_div
l_int|2
suffix:semicolon
id|left
op_assign
(paren
(paren
(paren
(paren
id|level
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
op_star
l_int|100
)paren
op_plus
id|half
)paren
op_div
id|div
suffix:semicolon
id|right
op_assign
(paren
(paren
(paren
id|level
op_amp
l_int|0x0f
)paren
op_star
l_int|100
)paren
op_plus
id|half
)paren
op_div
id|div
suffix:semicolon
r_return
(paren
id|right
op_lshift
l_int|8
)paren
op_or
id|left
suffix:semicolon
)brace
r_static
r_int
DECL|function|sbp_mixer_get
id|sbp_mixer_get
(paren
r_int
id|whichDev
)paren
(brace
r_switch
c_cond
(paren
id|whichDev
)paren
(brace
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
multiline_comment|/* Master volume (0-15) */
r_return
id|mixer_input
(paren
l_int|15
comma
id|MASTER_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_SYNTH
suffix:colon
multiline_comment|/* Internal synthesizer (0-15) */
r_return
id|mixer_input
(paren
l_int|15
comma
id|FM_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_PCM
suffix:colon
multiline_comment|/* PAS PCM (0-15) */
r_return
id|mixer_input
(paren
l_int|15
comma
id|VOC_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_LINE
suffix:colon
multiline_comment|/* External line (0-15) */
r_return
id|mixer_input
(paren
l_int|15
comma
id|LINE_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CD
suffix:colon
multiline_comment|/* CD (0-15) */
r_return
id|mixer_input
(paren
l_int|15
comma
id|CD_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_MIC
suffix:colon
multiline_comment|/* External microphone (0-7) */
r_return
id|mixer_input
(paren
l_int|7
comma
id|MIC_VOL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Sets mixer volume levels. All levels except mic are 0 to 15, mic is 7. See&n; * sbinfo.doc for details on granularity and such. Basically, the mixer&n; * forces the lowest bit high, effectively reducing the possible settings by&n; * one half.  Yes, that&squot;s right, volume levels have 8 settings, and&n; * microphone has four.  Sucks.&n; */
r_static
r_int
DECL|function|mixer_set_levels
id|mixer_set_levels
(paren
r_struct
id|sb_mixer_levels
op_star
id|user_l
)paren
(brace
r_struct
id|sb_mixer_levels
id|l
suffix:semicolon
id|IOCTL_FROM_USER
(paren
(paren
r_char
op_star
)paren
op_amp
id|l
comma
(paren
(paren
r_char
op_star
)paren
id|user_l
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|l
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|l.master.l
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.master.r
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.line.l
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.line.r
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.voc.l
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.voc.r
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.fm.l
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.fm.r
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.cd.l
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.cd.r
op_amp
op_complement
l_int|0xF
op_logical_or
id|l.mic
op_amp
op_complement
l_int|0x7
)paren
r_return
(paren
id|RET_ERROR
(paren
id|EINVAL
)paren
)paren
suffix:semicolon
id|setmixer
(paren
id|MASTER_VOL
comma
(paren
id|l.master.l
op_lshift
l_int|4
)paren
op_or
id|l.master.r
)paren
suffix:semicolon
id|setmixer
(paren
id|LINE_VOL
comma
(paren
id|l.line.l
op_lshift
l_int|4
)paren
op_or
id|l.line.r
)paren
suffix:semicolon
id|setmixer
(paren
id|VOC_VOL
comma
(paren
id|l.voc.l
op_lshift
l_int|4
)paren
op_or
id|l.voc.r
)paren
suffix:semicolon
id|setmixer
(paren
id|FM_VOL
comma
(paren
id|l.fm.l
op_lshift
l_int|4
)paren
op_or
id|l.fm.r
)paren
suffix:semicolon
id|setmixer
(paren
id|CD_VOL
comma
(paren
id|l.cd.l
op_lshift
l_int|4
)paren
op_or
id|l.cd.r
)paren
suffix:semicolon
id|setmixer
(paren
id|MIC_VOL
comma
id|l.mic
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This sets aspects of the Mixer that are not volume levels. (Recording&n; * source, filter level, I/O filtering, and stereo.)&n; */
r_static
r_int
DECL|function|mixer_set_params
id|mixer_set_params
(paren
r_struct
id|sb_mixer_params
op_star
id|user_p
)paren
(brace
r_struct
id|sb_mixer_params
id|p
suffix:semicolon
id|IOCTL_FROM_USER
(paren
(paren
r_char
op_star
)paren
op_amp
id|p
comma
(paren
r_char
op_star
)paren
id|user_p
comma
l_int|0
comma
r_sizeof
(paren
id|p
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p.record_source
op_ne
id|SRC_MIC
op_logical_and
id|p.record_source
op_ne
id|SRC_CD
op_logical_and
id|p.record_source
op_ne
id|SRC_LINE
)paren
r_return
(paren
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/*&n;   * I&squot;m not sure if this is The Right Thing.  Should stereo be entirely&n;   * under control of DSP?  I like being able to toggle it while a sound is&n;   * playing, so I do this... because I can.&n;   */
id|dsp_stereo
op_assign
op_logical_neg
op_logical_neg
id|p.dsp_stereo
suffix:semicolon
id|set_filter
(paren
id|p.record_source
comma
id|p.hifreq_filter
comma
id|p.filter_input
comma
id|p.filter_output
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|p.record_source
)paren
(brace
r_case
id|SRC_MIC
suffix:colon
id|rec_devices
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SRC_LINE
suffix:colon
id|rec_devices
op_assign
id|SOUND_MASK_LINE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SRC_CD
suffix:colon
id|rec_devices
op_assign
id|SOUND_MASK_CD
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Read the current mixer level settings into the user&squot;s struct. */
r_static
r_int
DECL|function|mixer_get_levels
id|mixer_get_levels
(paren
r_struct
id|sb_mixer_levels
op_star
id|user_l
)paren
(brace
id|S_BYTE
id|val
suffix:semicolon
r_struct
id|sb_mixer_levels
id|l
suffix:semicolon
id|val
op_assign
id|getmixer
(paren
id|MASTER_VOL
)paren
suffix:semicolon
multiline_comment|/* Master */
id|l.master.l
op_assign
id|B4
(paren
id|val
op_rshift
l_int|4
)paren
suffix:semicolon
id|l.master.r
op_assign
id|B4
(paren
id|val
)paren
suffix:semicolon
id|val
op_assign
id|getmixer
(paren
id|LINE_VOL
)paren
suffix:semicolon
multiline_comment|/* FM */
id|l.line.l
op_assign
id|B4
(paren
id|val
op_rshift
l_int|4
)paren
suffix:semicolon
id|l.line.r
op_assign
id|B4
(paren
id|val
)paren
suffix:semicolon
id|val
op_assign
id|getmixer
(paren
id|VOC_VOL
)paren
suffix:semicolon
multiline_comment|/* DAC */
id|l.voc.l
op_assign
id|B4
(paren
id|val
op_rshift
l_int|4
)paren
suffix:semicolon
id|l.voc.r
op_assign
id|B4
(paren
id|val
)paren
suffix:semicolon
id|val
op_assign
id|getmixer
(paren
id|FM_VOL
)paren
suffix:semicolon
multiline_comment|/* FM */
id|l.fm.l
op_assign
id|B4
(paren
id|val
op_rshift
l_int|4
)paren
suffix:semicolon
id|l.fm.r
op_assign
id|B4
(paren
id|val
)paren
suffix:semicolon
id|val
op_assign
id|getmixer
(paren
id|CD_VOL
)paren
suffix:semicolon
multiline_comment|/* CD */
id|l.cd.l
op_assign
id|B4
(paren
id|val
op_rshift
l_int|4
)paren
suffix:semicolon
id|l.cd.r
op_assign
id|B4
(paren
id|val
)paren
suffix:semicolon
id|val
op_assign
id|getmixer
(paren
id|MIC_VOL
)paren
suffix:semicolon
multiline_comment|/* Microphone */
id|l.mic
op_assign
id|B3
(paren
id|val
)paren
suffix:semicolon
id|IOCTL_TO_USER
(paren
(paren
r_char
op_star
)paren
id|user_l
comma
l_int|0
comma
(paren
r_char
op_star
)paren
op_amp
id|l
comma
r_sizeof
(paren
id|l
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Read the current mixer parameters into the user&squot;s struct. */
r_static
r_int
DECL|function|mixer_get_params
id|mixer_get_params
(paren
r_struct
id|sb_mixer_params
op_star
id|user_params
)paren
(brace
id|S_BYTE
id|val
suffix:semicolon
r_struct
id|sb_mixer_params
id|params
suffix:semicolon
id|val
op_assign
id|getmixer
(paren
id|RECORD_SRC
)paren
suffix:semicolon
id|params.record_source
op_assign
id|val
op_amp
l_int|0x07
suffix:semicolon
id|params.hifreq_filter
op_assign
op_logical_neg
op_logical_neg
(paren
id|val
op_amp
id|FREQ_HI
)paren
suffix:semicolon
id|params.filter_input
op_assign
(paren
id|val
op_amp
id|FILT_OFF
)paren
ques
c_cond
id|OFF
suffix:colon
id|ON
suffix:semicolon
id|params.filter_output
op_assign
(paren
id|getmixer
(paren
id|OUT_FILTER
)paren
op_amp
id|FILT_OFF
)paren
ques
c_cond
id|OFF
suffix:colon
id|ON
suffix:semicolon
id|params.dsp_stereo
op_assign
id|dsp_stereo
suffix:semicolon
id|IOCTL_TO_USER
(paren
(paren
r_char
op_star
)paren
id|user_params
comma
l_int|0
comma
(paren
r_char
op_star
)paren
op_amp
id|params
comma
r_sizeof
(paren
id|params
)paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_mixer_ioctl
id|sb_mixer_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|cmd
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_eq
l_char|&squot;M&squot;
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_amp
id|IOC_IN
)paren
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|sbp_mixer_set
(paren
id|cmd
op_amp
l_int|0xff
comma
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* Read parameters */
r_switch
c_cond
(paren
id|cmd
op_amp
l_int|0xff
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|rec_devices
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|SUPPORTED_MIXER_DEVICES
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|SUPPORTED_MIXER_DEVICES
op_amp
op_complement
id|SOUND_MASK_MIC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|POSSIBLE_RECORDING_DEVICES
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|SOUND_CAP_EXCL_INPUT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|sbp_mixer_get
(paren
id|cmd
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MIXER_IOCTL_SET_LEVELS
suffix:colon
r_return
(paren
id|mixer_set_levels
(paren
(paren
r_struct
id|sb_mixer_levels
op_star
)paren
id|arg
)paren
)paren
suffix:semicolon
r_case
id|MIXER_IOCTL_SET_PARAMS
suffix:colon
r_return
(paren
id|mixer_set_params
(paren
(paren
r_struct
id|sb_mixer_params
op_star
)paren
id|arg
)paren
)paren
suffix:semicolon
r_case
id|MIXER_IOCTL_READ_LEVELS
suffix:colon
r_return
(paren
id|mixer_get_levels
(paren
(paren
r_struct
id|sb_mixer_levels
op_star
)paren
id|arg
)paren
)paren
suffix:semicolon
r_case
id|MIXER_IOCTL_READ_PARAMS
suffix:colon
r_return
(paren
id|mixer_get_params
(paren
(paren
r_struct
id|sb_mixer_params
op_star
)paren
id|arg
)paren
)paren
suffix:semicolon
r_case
id|MIXER_IOCTL_RESET
suffix:colon
id|init_mixer
(paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* End of mixer code */
macro_line|#endif
macro_line|#ifndef EXCLUDE_MIDI
multiline_comment|/* Midi code */
r_static
r_int
DECL|function|sb_midi_open
id|sb_midi_open
(paren
r_int
id|dev
comma
r_int
id|mode
comma
r_void
(paren
op_star
id|input
)paren
(paren
r_int
id|dev
comma
r_int
r_char
id|data
)paren
comma
r_void
(paren
op_star
id|output
)paren
(paren
r_int
id|dev
)paren
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: MIDI hardware not installed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mode
op_ne
id|OPEN_WRITE
op_logical_and
op_logical_neg
id|duplex_midi
)paren
(brace
r_if
c_cond
(paren
id|num_midis
op_eq
l_int|1
)paren
id|printk
(paren
l_string|&quot;SoundBlaster: Midi input not currently supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EPERM
)paren
suffix:semicolon
)brace
id|midi_mode
op_assign
id|NORMAL_MIDI
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
id|OPEN_WRITE
)paren
(brace
r_if
c_cond
(paren
id|dsp_busy
op_logical_or
id|intr_active
)paren
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
id|midi_mode
op_assign
id|UART_MIDI
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp_highspeed
op_logical_or
id|dsp_stereo
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: Midi output not possible during stereo or high speed audio&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|midi_mode
op_eq
id|UART_MIDI
)paren
(brace
id|irq_mode
op_assign
id|IMODE_MIDI
suffix:semicolon
id|reset_dsp
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dsp_command
(paren
l_int|0x35
)paren
)paren
r_return
id|RET_ERROR
(paren
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Enter the UART mode */
id|intr_active
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|set_dsp_irq
(paren
id|sbc_irq
)paren
)paren
OL
l_int|0
)paren
(brace
id|reset_dsp
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* IRQ not free */
)brace
)brace
id|midi_busy
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_midi_close
id|sb_midi_close
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|midi_mode
op_eq
id|UART_MIDI
)paren
(brace
id|reset_dsp
(paren
)paren
suffix:semicolon
multiline_comment|/* The only way to kill the UART mode */
id|RELEASE_IRQ
(paren
id|sbc_irq
)paren
suffix:semicolon
)brace
id|intr_active
op_assign
l_int|0
suffix:semicolon
id|midi_busy
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_midi_out
id|sb_midi_out
(paren
r_int
id|dev
comma
r_int
r_char
id|midi_byte
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|midi_busy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Kill all notes after close */
r_if
c_cond
(paren
id|midi_mode
op_eq
id|NORMAL_MIDI
)paren
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp_command
(paren
l_int|0x38
)paren
)paren
id|dsp_command
(paren
id|midi_byte
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to send a MIDI byte&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
id|dsp_command
(paren
id|midi_byte
)paren
suffix:semicolon
multiline_comment|/* UART write */
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_midi_start_read
id|sb_midi_start_read
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|midi_mode
op_ne
id|UART_MIDI
)paren
(brace
id|printk
(paren
l_string|&quot;SoundBlaster: MIDI input not implemented.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EPERM
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_midi_end_read
id|sb_midi_end_read
(paren
r_int
id|dev
)paren
(brace
r_if
c_cond
(paren
id|midi_mode
op_eq
id|UART_MIDI
)paren
(brace
id|reset_dsp
(paren
)paren
suffix:semicolon
id|intr_active
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_midi_ioctl
id|sb_midi_ioctl
(paren
r_int
id|dev
comma
r_int
id|cmd
comma
r_int
id|arg
)paren
(brace
r_return
id|RET_ERROR
(paren
id|EPERM
)paren
suffix:semicolon
)brace
multiline_comment|/* End of midi code */
macro_line|#endif
macro_line|#ifndef EXCLUDE_AUDIO
DECL|variable|sb_dsp_operations
r_static
r_struct
id|audio_operations
id|sb_dsp_operations
op_assign
(brace
l_string|&quot;SoundBlaster&quot;
comma
id|sb_dsp_open
comma
id|sb_dsp_close
comma
id|sb_dsp_output_block
comma
id|sb_dsp_start_input
comma
id|sb_dsp_ioctl
comma
id|sb_dsp_prepare_for_input
comma
id|sb_dsp_prepare_for_output
comma
id|sb_dsp_reset
comma
id|sb_dsp_halt_xfer
comma
l_int|NULL
comma
multiline_comment|/* has_output_drained */
l_int|NULL
multiline_comment|/* copy_from_user */
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifndef EXCLUDE_SBPRO
DECL|variable|sb_mixer_operations
r_static
r_struct
id|mixer_operations
id|sb_mixer_operations
op_assign
(brace
id|sb_mixer_ioctl
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifndef EXCLUDE_MIDI
DECL|variable|sb_midi_operations
r_static
r_struct
id|midi_operations
id|sb_midi_operations
op_assign
(brace
(brace
l_string|&quot;SoundBlaster&quot;
comma
l_int|0
)brace
comma
id|sb_midi_open
comma
id|sb_midi_close
comma
id|sb_midi_ioctl
comma
id|sb_midi_out
comma
id|sb_midi_start_read
comma
id|sb_midi_end_read
comma
l_int|NULL
comma
multiline_comment|/* Kick */
l_int|NULL
comma
multiline_comment|/* command */
l_int|NULL
multiline_comment|/* buffer_status */
)brace
suffix:semicolon
macro_line|#endif
r_static
r_int
DECL|function|verify_irq
id|verify_irq
(paren
r_void
)paren
(brace
macro_line|#if 0
r_int
r_int
id|loop
suffix:semicolon
id|irq_ok
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|set_dsp_irq
(paren
id|sbc_irq
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;*** SB Error: Irq %d already in use&bslash;n&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|irq_mode
op_assign
id|IMODE_INIT
suffix:semicolon
id|dsp_command
(paren
l_int|0xf2
)paren
suffix:semicolon
multiline_comment|/* This should cause immediate interrupt */
r_for
c_loop
(paren
id|loop
op_assign
l_int|100000
suffix:semicolon
id|loop
OG
l_int|0
op_logical_and
op_logical_neg
id|irq_ok
suffix:semicolon
id|loop
op_decrement
)paren
suffix:semicolon
id|RELEASE_IRQ
(paren
id|sbc_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: IRQ test not passed!&quot;
)paren
suffix:semicolon
id|irq_ok
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#else
id|irq_ok
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_return
id|irq_ok
suffix:semicolon
)brace
r_int
DECL|function|sb_dsp_init
id|sb_dsp_init
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
comma
id|major
comma
id|minor
suffix:semicolon
id|major
op_assign
id|minor
op_assign
l_int|0
suffix:semicolon
id|dsp_command
(paren
l_int|0xe1
)paren
suffix:semicolon
multiline_comment|/* Get version */
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|inb
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* wait for Data Ready */
r_if
c_cond
(paren
id|major
op_eq
l_int|0
)paren
id|major
op_assign
id|inb
(paren
id|DSP_READ
)paren
suffix:semicolon
r_else
(brace
id|minor
op_assign
id|inb
(paren
id|DSP_READ
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifndef EXCLUDE_SBPRO
r_if
c_cond
(paren
id|detect_mixer
(paren
)paren
)paren
(brace
macro_line|#ifndef SCO
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster Pro %d.%d&quot;
comma
id|major
comma
id|minor
)paren
suffix:semicolon
macro_line|#endif
id|init_mixer
(paren
)paren
suffix:semicolon
id|mixer_devs
(braket
id|num_mixers
op_increment
)braket
op_assign
op_amp
id|sb_mixer_operations
suffix:semicolon
r_if
c_cond
(paren
id|major
op_eq
l_int|2
op_logical_or
id|major
op_eq
l_int|3
)paren
id|duplex_midi
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|major
op_eq
l_int|4
)paren
id|sb16
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|major
op_ge
l_int|3
)paren
id|dsp_model
op_assign
l_int|2
suffix:semicolon
macro_line|#ifndef EXCLUDE_YM8312
r_if
c_cond
(paren
id|major
OG
l_int|3
op_logical_or
(paren
id|major
op_eq
l_int|3
op_logical_and
id|minor
OG
l_int|0
)paren
)paren
multiline_comment|/* SB Pro2 or later */
(brace
id|enable_opl3_mode
(paren
id|OPL3_LEFT
comma
id|OPL3_RIGHT
comma
id|OPL3_BOTH
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_else
macro_line|#endif
macro_line|#ifndef SCO
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster %d.%d&quot;
comma
id|major
comma
id|minor
)paren
suffix:semicolon
macro_line|#endif
id|printk
(paren
l_string|&quot; &lt;%s&gt;&quot;
comma
id|sb_dsp_operations.name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|verify_irq
(paren
)paren
)paren
r_return
id|mem_start
suffix:semicolon
macro_line|#ifndef EXCLUDE_AUDIO
r_if
c_cond
(paren
id|num_dspdevs
OL
id|MAX_DSP_DEV
)paren
(brace
id|dsp_devs
(braket
id|my_dev
op_assign
id|num_dspdevs
op_increment
)braket
op_assign
op_amp
id|sb_dsp_operations
suffix:semicolon
id|sound_buffcounts
(braket
id|my_dev
)braket
op_assign
id|DSP_BUFFCOUNT
suffix:semicolon
id|sound_buffsizes
(braket
id|my_dev
)braket
op_assign
id|DSP_BUFFSIZE
suffix:semicolon
id|sound_dsp_dmachan
(braket
id|my_dev
)braket
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|sound_dma_automode
(braket
id|my_dev
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB: Too many DSP devices available&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef EXCLUDE_MIDI
r_if
c_cond
(paren
op_logical_neg
id|midi_disabled
)paren
multiline_comment|/* Midi don&squot;t work in the SB emulation mode&n;&t;&t;&t;&t; * of PAS */
id|midi_devs
(braket
id|num_midis
op_increment
)braket
op_assign
op_amp
id|sb_midi_operations
suffix:semicolon
macro_line|#endif
id|sb_dsp_ok
op_assign
l_int|1
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_void
DECL|function|sb_dsp_disable_midi
id|sb_dsp_disable_midi
(paren
r_void
)paren
(brace
id|midi_disabled
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
eof
