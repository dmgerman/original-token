multiline_comment|/*&n; * sound/sb_dsp.c&n; * &n; * The low level driver for the SoundBlaster DS chips.&n; * &n; * Copyright by Hannu Savolainen 1993&n; * &n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; * &n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; * &n; */
macro_line|#include &quot;sound_config.h&quot;
macro_line|#if defined(CONFIGURE_SOUNDCARD) &amp;&amp; !defined(EXCLUDE_SB)
macro_line|#include &quot;sb.h&quot;
macro_line|#include &quot;sb_mixer.h&quot;
DECL|macro|SB_TEST_IRQ
macro_line|#undef SB_TEST_IRQ
DECL|variable|sbc_base
r_int
id|sbc_base
op_assign
l_int|0
suffix:semicolon
DECL|variable|sbc_irq
r_static
r_int
id|sbc_irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * The DSP channel can be used either for input or output. Variable&n; * &squot;sb_irq_mode&squot; will be set when the program calls read or write first time&n; * after open. Current version doesn&squot;t support mode changes without closing&n; * and reopening the device. Support for this feature may be implemented in a&n; * future version of this driver.&n; */
DECL|variable|sb_dsp_ok
r_int
id|sb_dsp_ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set to 1 after successful initialization */
DECL|variable|midi_disabled
r_static
r_int
id|midi_disabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_dsp_highspeed
r_int
id|sb_dsp_highspeed
op_assign
l_int|0
suffix:semicolon
DECL|variable|major
DECL|variable|minor
r_static
r_int
id|major
op_assign
l_int|1
comma
id|minor
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* DSP version */
DECL|variable|dsp_stereo
r_static
r_int
id|dsp_stereo
op_assign
l_int|0
suffix:semicolon
DECL|variable|dsp_current_speed
r_static
r_int
id|dsp_current_speed
op_assign
id|DSP_DEFAULT_SPEED
suffix:semicolon
DECL|variable|sb16
r_static
r_int
id|sb16
op_assign
l_int|0
suffix:semicolon
DECL|variable|irq_verified
r_static
r_int
id|irq_verified
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_midi_mode
r_int
id|sb_midi_mode
op_assign
id|NORMAL_MIDI
suffix:semicolon
DECL|variable|sb_midi_busy
r_int
id|sb_midi_busy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 1 if the process has output to MIDI */
DECL|variable|sb_dsp_busy
r_int
id|sb_dsp_busy
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_irq_mode
r_volatile
r_int
id|sb_irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
multiline_comment|/* IMODE_INPUT, IMODE_OUTPUT&n;&t;&t;&t;&t;&t;&t; * or IMODE_NONE */
DECL|variable|irq_ok
r_static
r_volatile
r_int
id|irq_ok
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_dsp_model
r_int
id|sb_dsp_model
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1=SB, 2=SB Pro */
DECL|variable|sb_duplex_midi
r_int
id|sb_duplex_midi
op_assign
l_int|0
suffix:semicolon
DECL|variable|my_dev
r_static
r_int
id|my_dev
op_assign
l_int|0
suffix:semicolon
DECL|variable|sb_intr_active
r_volatile
r_int
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|dsp_speed
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|dsp_set_stereo
(paren
r_int
id|mode
)paren
suffix:semicolon
r_int
id|sb_dsp_command
(paren
r_int
r_char
id|val
)paren
suffix:semicolon
macro_line|#if !defined(EXCLUDE_MIDI) || !defined(EXCLUDE_AUDIO)
multiline_comment|/* Common code for the midi and pcm functions */
r_int
DECL|function|sb_dsp_command
id|sb_dsp_command
(paren
r_int
r_char
id|val
)paren
(brace
r_int
id|i
comma
id|limit
suffix:semicolon
id|limit
op_assign
id|GET_TIME
(paren
)paren
op_plus
l_int|10
suffix:semicolon
multiline_comment|/* The timeout is 0.1 secods */
multiline_comment|/*&n;   * Note! the i&lt;500000 is an emergency exit. The sb_dsp_command() is sometimes&n;   * called while interrupts are disabled. This means that the timer is&n;   * disabled also. However the timeout situation is a abnormal condition.&n;   * Normally the DSP should be ready to accept commands after just couple of&n;   * loops.&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|500000
op_logical_and
id|GET_TIME
(paren
)paren
OL
id|limit
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|INB
(paren
id|DSP_STATUS
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
id|OUTB
(paren
id|val
comma
id|DSP_COMMAND
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;SoundBlaster: DSP Command(%02x) Timeout.&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;IRQ conflict???&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|sbintr
id|sbintr
(paren
r_int
id|unit
)paren
(brace
r_int
id|status
comma
id|data
suffix:semicolon
macro_line|#ifndef EXCLUDE_SBPRO
r_if
c_cond
(paren
id|sb16
)paren
(brace
r_int
r_char
id|src
op_assign
id|sb_getmixer
(paren
id|IRQ_STAT
)paren
suffix:semicolon
multiline_comment|/* Interrupt status register */
macro_line|#ifndef EXCLUDE_SB16
r_if
c_cond
(paren
id|src
op_amp
l_int|2
)paren
id|sb16_dsp_interrupt
c_func
(paren
id|unit
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|src
op_amp
l_int|1
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Not a DSP interupt */
)brace
macro_line|#endif
id|status
op_assign
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt */
r_if
c_cond
(paren
id|sb_intr_active
)paren
r_switch
c_cond
(paren
id|sb_irq_mode
)paren
(brace
r_case
id|IMODE_OUTPUT
suffix:colon
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_outputintr
(paren
id|my_dev
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_INPUT
suffix:colon
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|DMAbuf_inputintr
(paren
id|my_dev
)paren
suffix:semicolon
multiline_comment|/* A complete buffer has been input. Let&squot;s start new one */
r_break
suffix:semicolon
r_case
id|IMODE_INIT
suffix:colon
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
id|irq_ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IMODE_MIDI
suffix:colon
id|printk
(paren
l_string|&quot;+&quot;
)paren
suffix:semicolon
id|data
op_assign
id|INB
(paren
id|DSP_READ
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%02x&quot;
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;SoundBlaster: Unexpected interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|variable|sb_irq_usecount
r_static
r_int
id|sb_irq_usecount
op_assign
l_int|0
suffix:semicolon
r_int
DECL|function|sb_get_irq
id|sb_get_irq
c_func
(paren
r_void
)paren
(brace
r_int
id|ok
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_usecount
)paren
r_if
c_cond
(paren
(paren
id|ok
op_assign
id|snd_set_irq_handler
c_func
(paren
id|sbc_irq
comma
id|sbintr
)paren
)paren
OL
l_int|0
)paren
r_return
id|ok
suffix:semicolon
id|sb_irq_usecount
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|sb_free_irq
id|sb_free_irq
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_usecount
)paren
r_return
suffix:semicolon
id|sb_irq_usecount
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_usecount
)paren
id|snd_release_irq
c_func
(paren
id|sbc_irq
)paren
suffix:semicolon
)brace
r_int
DECL|function|sb_reset_dsp
id|sb_reset_dsp
(paren
r_void
)paren
(brace
r_int
id|loopc
suffix:semicolon
id|OUTB
(paren
l_int|1
comma
id|DSP_RESET
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|OUTB
(paren
l_int|0
comma
id|DSP_RESET
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
id|tenmicrosec
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loopc
op_assign
l_int|0
suffix:semicolon
id|loopc
OL
l_int|1000
op_logical_and
op_logical_neg
(paren
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
suffix:semicolon
id|loopc
op_increment
)paren
suffix:semicolon
multiline_comment|/* Wait for data&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; * available status */
r_if
c_cond
(paren
id|INB
(paren
id|DSP_READ
)paren
op_ne
l_int|0xAA
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Sorry */
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifndef EXCLUDE_AUDIO
r_static
r_void
DECL|function|dsp_speaker
id|dsp_speaker
(paren
r_char
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
id|sb_dsp_command
(paren
id|DSP_CMD_SPKON
)paren
suffix:semicolon
r_else
id|sb_dsp_command
(paren
id|DSP_CMD_SPKOFF
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_speed
id|dsp_speed
(paren
r_int
id|speed
)paren
(brace
r_int
r_char
id|tconst
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|speed
OL
l_int|4000
)paren
id|speed
op_assign
l_int|4000
suffix:semicolon
r_if
c_cond
(paren
id|speed
OG
l_int|44100
)paren
id|speed
op_assign
l_int|44100
suffix:semicolon
multiline_comment|/* Invalid speed */
r_if
c_cond
(paren
id|sb_dsp_model
op_eq
l_int|1
op_logical_and
id|speed
OG
l_int|22050
)paren
id|speed
op_assign
l_int|22050
suffix:semicolon
multiline_comment|/* SB Classic doesn&squot;t support higher speed */
r_if
c_cond
(paren
id|dsp_stereo
op_logical_and
id|speed
OG
l_int|22050
)paren
id|speed
op_assign
l_int|22050
suffix:semicolon
multiline_comment|/* Max. stereo speed is 22050 */
r_if
c_cond
(paren
(paren
id|speed
OG
l_int|22050
)paren
op_logical_and
id|sb_midi_busy
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: High speed DSP not possible simultaneously with MIDI output&bslash;n&quot;
)paren
suffix:semicolon
id|speed
op_assign
l_int|22050
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|speed
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/* Now the speed should be valid */
r_if
c_cond
(paren
id|speed
OG
l_int|22050
)paren
(brace
multiline_comment|/* High speed mode */
r_int
id|tmp
suffix:semicolon
id|tconst
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
l_int|65536
op_minus
(paren
(paren
l_int|256000000
op_plus
id|speed
op_div
l_int|2
)paren
op_div
id|speed
)paren
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|sb_dsp_highspeed
op_assign
l_int|1
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x40
)paren
)paren
id|sb_dsp_command
(paren
id|tconst
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
l_int|65536
op_minus
(paren
id|tconst
op_lshift
l_int|8
)paren
suffix:semicolon
id|speed
op_assign
(paren
l_int|256000000
op_plus
id|tmp
op_div
l_int|2
)paren
op_div
id|tmp
suffix:semicolon
)brace
r_else
(brace
r_int
id|tmp
suffix:semicolon
id|sb_dsp_highspeed
op_assign
l_int|0
suffix:semicolon
id|tconst
op_assign
(paren
l_int|256
op_minus
(paren
(paren
l_int|1000000
op_plus
id|speed
op_div
l_int|2
)paren
op_div
id|speed
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x40
)paren
)paren
multiline_comment|/* Set time constant */
id|sb_dsp_command
(paren
id|tconst
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
l_int|256
op_minus
id|tconst
suffix:semicolon
id|speed
op_assign
(paren
l_int|1000000
op_plus
id|tmp
op_div
l_int|2
)paren
op_div
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|speed
op_div_assign
l_int|2
suffix:semicolon
id|dsp_current_speed
op_assign
id|speed
suffix:semicolon
r_return
id|speed
suffix:semicolon
)brace
r_static
r_int
DECL|function|dsp_set_stereo
id|dsp_set_stereo
(paren
r_int
id|mode
)paren
(brace
id|dsp_stereo
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef EXCLUDE_SBPRO
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|sb_dsp_model
op_eq
l_int|1
op_logical_or
id|sb16
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Sorry no stereo */
r_if
c_cond
(paren
id|mode
op_logical_and
id|sb_midi_busy
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: Stereo DSP not possible simultaneously with MIDI output&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dsp_stereo
op_assign
op_logical_neg
op_logical_neg
id|mode
suffix:semicolon
r_return
id|dsp_stereo
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
DECL|function|sb_dsp_output_block
id|sb_dsp_output_block
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_mode
)paren
id|dsp_speaker
(paren
id|ON
)paren
suffix:semicolon
id|sb_irq_mode
op_assign
id|IMODE_OUTPUT
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound_dsp_dmachan
(braket
id|dev
)braket
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_highspeed
)paren
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x48
)paren
)paren
multiline_comment|/* High speed size */
(brace
id|sb_dsp_command
(paren
id|count
op_amp
l_int|0xff
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0x91
)paren
suffix:semicolon
multiline_comment|/* High speed 8 bit DAC */
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start (high speed) DAC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x14
)paren
)paren
multiline_comment|/* 8-bit DAC (DMA) */
(brace
id|sb_dsp_command
(paren
id|count
op_amp
l_int|0xff
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start DAC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
id|sb_intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_start_input
id|sb_dsp_start_input
(paren
r_int
id|dev
comma
r_int
r_int
id|buf
comma
r_int
id|count
comma
r_int
id|intrflag
comma
r_int
id|restart_dma
)paren
(brace
multiline_comment|/* Start a DMA input to the buffer pointed by dmaqtail */
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_irq_mode
)paren
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
id|sb_irq_mode
op_assign
id|IMODE_INPUT
suffix:semicolon
id|DMAbuf_start_dma
(paren
id|dev
comma
id|buf
comma
id|count
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound_dsp_dmachan
(braket
id|dev
)braket
OG
l_int|3
)paren
id|count
op_rshift_assign
l_int|1
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_highspeed
)paren
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x48
)paren
)paren
multiline_comment|/* High speed size */
(brace
id|sb_dsp_command
(paren
id|count
op_amp
l_int|0xff
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0x99
)paren
suffix:semicolon
multiline_comment|/* High speed 8 bit ADC */
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start (high speed) ADC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_command
(paren
l_int|0x24
)paren
)paren
multiline_comment|/* 8-bit ADC (DMA) */
(brace
id|sb_dsp_command
(paren
id|count
op_amp
l_int|0xff
)paren
suffix:semicolon
id|sb_dsp_command
(paren
(paren
id|count
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB Error: Unable to start ADC&bslash;n&quot;
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
id|sb_intr_active
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|dsp_cleanup
id|dsp_cleanup
(paren
r_void
)paren
(brace
id|sb_intr_active
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_prepare_for_input
id|sb_dsp_prepare_for_input
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|major
op_eq
l_int|3
)paren
multiline_comment|/* SB Pro */
(brace
r_if
c_cond
(paren
id|dsp_stereo
)paren
id|sb_dsp_command
c_func
(paren
l_int|0xa8
)paren
suffix:semicolon
r_else
id|sb_dsp_command
c_func
(paren
l_int|0xa0
)paren
suffix:semicolon
id|dsp_speed
(paren
id|dsp_current_speed
)paren
suffix:semicolon
multiline_comment|/* Speed must be recalculated if #channels&n;&t;&t;&t;&t;   * changes */
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_prepare_for_output
id|sb_dsp_prepare_for_output
(paren
r_int
id|dev
comma
r_int
id|bsize
comma
r_int
id|bcount
)paren
(brace
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|ON
)paren
suffix:semicolon
r_if
c_cond
(paren
id|major
op_eq
l_int|3
)paren
multiline_comment|/* SB Pro */
(brace
id|sb_mixer_set_stereo
c_func
(paren
id|dsp_stereo
)paren
suffix:semicolon
id|dsp_speed
(paren
id|dsp_current_speed
)paren
suffix:semicolon
multiline_comment|/* Speed must be recalculated if #channels&n;&t;&t;&t;&t;   * changes */
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_halt_xfer
id|sb_dsp_halt_xfer
(paren
r_int
id|dev
)paren
(brace
)brace
r_static
r_int
DECL|function|verify_irq
id|verify_irq
(paren
r_void
)paren
(brace
macro_line|#if 0
id|DEFINE_WAIT_QUEUE
c_func
(paren
id|testq
comma
id|testf
)paren
suffix:semicolon
id|irq_ok
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sb_get_irq
(paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;*** SB Error: Irq %d already in use&bslash;n&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sb_irq_mode
op_assign
id|IMODE_INIT
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0xf2
)paren
suffix:semicolon
multiline_comment|/* This should cause immediate interrupt */
id|DO_SLEEP
c_func
(paren
id|testq
comma
id|testf
comma
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
id|sb_free_irq
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Warning: IRQ%d test not passed!&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
id|irq_ok
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#else
id|irq_ok
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_return
id|irq_ok
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_open
id|sb_dsp_open
(paren
r_int
id|dev
comma
r_int
id|mode
)paren
(brace
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_dsp_ok
)paren
(brace
id|printk
(paren
l_string|&quot;SB Error: SoundBlaster board not installed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|ENXIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb_intr_active
op_logical_or
(paren
id|sb_midi_busy
op_logical_and
id|sb_midi_mode
op_eq
id|UART_MIDI
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;SB: PCM not possible during MIDI input&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|irq_verified
)paren
(brace
id|verify_irq
c_func
(paren
)paren
suffix:semicolon
id|irq_verified
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|irq_ok
)paren
id|printk
c_func
(paren
l_string|&quot;SB Warning: Incorrect IRQ setting %d&bslash;n&quot;
comma
id|sbc_irq
)paren
suffix:semicolon
id|retval
op_assign
id|sb_get_irq
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|DMAbuf_open_dma
(paren
id|dev
)paren
)paren
(brace
id|sb_free_irq
(paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;SB: DMA Busy&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RET_ERROR
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
id|sb_irq_mode
op_assign
id|IMODE_NONE
suffix:semicolon
id|sb_dsp_busy
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_close
id|sb_dsp_close
(paren
r_int
id|dev
)paren
(brace
id|DMAbuf_close_dma
(paren
id|dev
)paren
suffix:semicolon
id|sb_free_irq
(paren
)paren
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|dsp_speaker
(paren
id|OFF
)paren
suffix:semicolon
id|sb_dsp_busy
op_assign
l_int|0
suffix:semicolon
id|sb_dsp_highspeed
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sb_dsp_ioctl
id|sb_dsp_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|local
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SOUND_PCM_WRITE_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_speed
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_speed
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_current_speed
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_current_speed
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_CHANNELS
suffix:colon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_stereo
(paren
id|IOCTL_IN
(paren
id|arg
)paren
op_minus
l_int|1
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_stereo
op_plus
l_int|1
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_stereo
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
id|dsp_set_stereo
(paren
id|arg
)paren
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
id|dsp_set_stereo
(paren
id|IOCTL_IN
(paren
id|arg
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_BITS
suffix:colon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_if
c_cond
(paren
id|local
)paren
r_return
l_int|8
suffix:semicolon
r_return
id|IOCTL_OUT
(paren
id|arg
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Only 8 bits/sample supported */
r_break
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_return
id|RET_ERROR
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sb_dsp_reset
id|sb_dsp_reset
(paren
r_int
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|DISABLE_INTR
(paren
id|flags
)paren
suffix:semicolon
id|sb_reset_dsp
(paren
)paren
suffix:semicolon
id|dsp_cleanup
(paren
)paren
suffix:semicolon
id|RESTORE_INTR
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
r_int
DECL|function|sb_dsp_detect
id|sb_dsp_detect
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|sbc_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|sbc_irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_ok
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Already initialized */
r_if
c_cond
(paren
op_logical_neg
id|sb_reset_dsp
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Detected */
)brace
macro_line|#ifndef EXCLUDE_AUDIO
DECL|variable|sb_dsp_operations
r_static
r_struct
id|audio_operations
id|sb_dsp_operations
op_assign
(brace
l_string|&quot;SoundBlaster&quot;
comma
id|sb_dsp_open
comma
id|sb_dsp_close
comma
id|sb_dsp_output_block
comma
id|sb_dsp_start_input
comma
id|sb_dsp_ioctl
comma
id|sb_dsp_prepare_for_input
comma
id|sb_dsp_prepare_for_output
comma
id|sb_dsp_reset
comma
id|sb_dsp_halt_xfer
comma
l_int|NULL
comma
multiline_comment|/* has_output_drained */
l_int|NULL
multiline_comment|/* copy_from_user */
)brace
suffix:semicolon
macro_line|#endif
r_int
DECL|function|sb_dsp_init
id|sb_dsp_init
(paren
r_int
id|mem_start
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
suffix:semicolon
id|major
op_assign
id|minor
op_assign
l_int|0
suffix:semicolon
id|sb_dsp_command
(paren
l_int|0xe1
)paren
suffix:semicolon
multiline_comment|/* Get version */
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|INB
(paren
id|DSP_DATA_AVAIL
)paren
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* wait for Data Ready */
r_if
c_cond
(paren
id|major
op_eq
l_int|0
)paren
id|major
op_assign
id|INB
(paren
id|DSP_READ
)paren
suffix:semicolon
r_else
(brace
id|minor
op_assign
id|INB
(paren
id|DSP_READ
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|major
op_eq
l_int|2
op_logical_or
id|major
op_eq
l_int|3
)paren
id|sb_duplex_midi
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|major
op_eq
l_int|4
)paren
id|sb16
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|major
op_ge
l_int|3
)paren
id|sb_dsp_model
op_assign
l_int|2
suffix:semicolon
macro_line|#ifndef EXCLUDE_SBPRO
r_if
c_cond
(paren
id|major
op_ge
l_int|3
)paren
id|sb_mixer_init
c_func
(paren
id|major
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef EXCLUDE_YM8312
r_if
c_cond
(paren
id|major
OG
l_int|3
op_logical_or
(paren
id|major
op_eq
l_int|3
op_logical_and
id|minor
OG
l_int|0
)paren
)paren
multiline_comment|/* SB Pro2 or later */
(brace
id|enable_opl3_mode
(paren
id|OPL3_LEFT
comma
id|OPL3_RIGHT
comma
id|OPL3_BOTH
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|major
op_ge
l_int|3
)paren
(brace
macro_line|#ifndef SCO
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster Pro %d.%d&quot;
comma
id|major
comma
id|minor
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#ifndef SCO
id|sprintf
(paren
id|sb_dsp_operations.name
comma
l_string|&quot;SoundBlaster %d.%d&quot;
comma
id|major
comma
id|minor
)paren
suffix:semicolon
macro_line|#endif
)brace
id|printk
(paren
l_string|&quot; &lt;%s&gt;&quot;
comma
id|sb_dsp_operations.name
)paren
suffix:semicolon
macro_line|#ifndef EXCLUDE_AUDIO
r_if
c_cond
(paren
id|num_dspdevs
OL
id|MAX_DSP_DEV
)paren
(brace
id|dsp_devs
(braket
id|my_dev
op_assign
id|num_dspdevs
op_increment
)braket
op_assign
op_amp
id|sb_dsp_operations
suffix:semicolon
id|sound_buffcounts
(braket
id|my_dev
)braket
op_assign
id|DSP_BUFFCOUNT
suffix:semicolon
id|sound_buffsizes
(braket
id|my_dev
)braket
op_assign
id|DSP_BUFFSIZE
suffix:semicolon
id|sound_dsp_dmachan
(braket
id|my_dev
)braket
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|sound_dma_automode
(braket
id|my_dev
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|printk
(paren
l_string|&quot;SB: Too many DSP devices available&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifndef EXCLUDE_MIDI
r_if
c_cond
(paren
op_logical_neg
id|midi_disabled
)paren
multiline_comment|/* Midi don&squot;t work in the SB emulation mode&n;&t;&t;&t;&t; * of PAS */
id|sb_midi_init
c_func
(paren
id|major
)paren
suffix:semicolon
macro_line|#endif
id|sb_dsp_ok
op_assign
l_int|1
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_void
DECL|function|sb_dsp_disable_midi
id|sb_dsp_disable_midi
(paren
r_void
)paren
(brace
id|midi_disabled
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
eof
