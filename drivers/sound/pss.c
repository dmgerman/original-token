multiline_comment|/*&n; * sound/pss.c&n; *&n; * The low level driver for the Personal Sound System (ECHO ESC614).&n; *&n; *&n; * Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; * for more info.&n; *&n; *&n; * Thomas Sailer&t;ioctl code reworked (vmalloc/vfree removed)&n; * Alan Cox&t;&t;modularisation, clean up.&n; *&n; * 98-02-21: Vladimir Michl &lt;vladimir.michl@upol.cz&gt;&n; *          Added mixer device for Beethoven ADSP-16 (master volume,&n; *&t;    bass, treble, synth), only for speakers.&n; *          Fixed bug in pss_write (exchange parameters)&n; *          Fixed config port of SB&n; *          Requested two regions for PSS (PSS mixer, PSS config)&n; *          Modified pss_download_boot&n; *          To probe_pss_mss added test for initialize AD1848&n; * 98-05-28: Vladimir Michl &lt;vladimir.michl@upol.cz&gt;&n; *          Fixed computation of mixer volumes&n; * 04-05-1999: Anthony Barbachan &lt;barbcode@xmen.cis.fordham.edu&gt;&n; *          Added code that allows the user to enable his cdrom and/or &n; *          joystick through the module parameters pss_cdrom_port and &n; *          pss_enable_joystick.  pss_cdrom_port takes a port address as its&n; *          argument.  pss_enable_joystick takes either a 0 or a non-0 as its&n; *          argument.&n; * 04-06-1999: Anthony Barbachan &lt;barbcode@xmen.cis.fordham.edu&gt;&n; *          Separated some code into new functions for easier reuse.  &n; *          Cleaned up and streamlined new code.  Added code to allow a user &n; *          to only use this driver for enabling non-sound components &n; *          through the new module parameter pss_no_sound (flag).  Added &n; *          code that would allow a user to decide whether the driver should &n; *          reset the configured hardware settings for the PSS board through &n; *          the module parameter pss_keep_settings (flag).   This flag will &n; *          allow a user to free up resources in use by this card if needbe, &n; *          furthermore it allows him to use this driver to just enable the &n; *          emulations and then be unloaded as it is no longer needed.  Both &n; *          new settings are only available to this driver if compiled as a &n; *          module.  The default settings of all new parameters are set to &n; *          load the driver as it did in previous versions.&n; * 04-07-1999: Anthony Barbachan &lt;barbcode@xmen.cis.fordham.edu&gt;&n; *          Added module parameter pss_firmware to allow the user to tell &n; *          the driver where the fireware file is located.  The default &n; *          setting is the previous hardcoded setting &quot;/etc/sound/pss_synth&quot;.&n; * 00-03-03: Christoph Hellwig &lt;chhellwig@gmx.net&gt;&n; *&t;    Adapted to module_init/module_exit&n; * 11-10-2000: Bartlomiej Zolnierkiewicz &lt;bkz@linux-ide.org&gt;&n; *&t;    Added __init to probe_pss(), attach_pss() and probe_pss_mpu()&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;sound_firmware.h&quot;
macro_line|#include &quot;ad1848.h&quot;
macro_line|#include &quot;mpu401.h&quot;
multiline_comment|/*&n; * PSS registers.&n; */
DECL|macro|REG
mdefine_line|#define REG(x)&t;(devc-&gt;base+x)
DECL|macro|PSS_DATA
mdefine_line|#define&t;PSS_DATA&t;0
DECL|macro|PSS_STATUS
mdefine_line|#define&t;PSS_STATUS&t;2
DECL|macro|PSS_CONTROL
mdefine_line|#define PSS_CONTROL&t;2
DECL|macro|PSS_ID
mdefine_line|#define&t;PSS_ID&t;&t;4
DECL|macro|PSS_IRQACK
mdefine_line|#define&t;PSS_IRQACK&t;4
DECL|macro|PSS_PIO
mdefine_line|#define&t;PSS_PIO&t;&t;0x1a
multiline_comment|/*&n; * Config registers&n; */
DECL|macro|CONF_PSS
mdefine_line|#define CONF_PSS&t;0x10
DECL|macro|CONF_WSS
mdefine_line|#define CONF_WSS&t;0x12
DECL|macro|CONF_SB
mdefine_line|#define CONF_SB&t;&t;0x14
DECL|macro|CONF_CDROM
mdefine_line|#define CONF_CDROM&t;0x16
DECL|macro|CONF_MIDI
mdefine_line|#define CONF_MIDI&t;0x18
multiline_comment|/*&n; * Status bits.&n; */
DECL|macro|PSS_FLAG3
mdefine_line|#define PSS_FLAG3     0x0800
DECL|macro|PSS_FLAG2
mdefine_line|#define PSS_FLAG2     0x0400
DECL|macro|PSS_FLAG1
mdefine_line|#define PSS_FLAG1     0x1000
DECL|macro|PSS_FLAG0
mdefine_line|#define PSS_FLAG0     0x0800
DECL|macro|PSS_WRITE_EMPTY
mdefine_line|#define PSS_WRITE_EMPTY  0x8000
DECL|macro|PSS_READ_FULL
mdefine_line|#define PSS_READ_FULL    0x4000
multiline_comment|/*&n; * WSS registers&n; */
DECL|macro|WSS_INDEX
mdefine_line|#define WSS_INDEX 4
DECL|macro|WSS_DATA
mdefine_line|#define WSS_DATA 5
multiline_comment|/*&n; * WSS status bits&n; */
DECL|macro|WSS_INITIALIZING
mdefine_line|#define WSS_INITIALIZING 0x80
DECL|macro|WSS_AUTOCALIBRATION
mdefine_line|#define WSS_AUTOCALIBRATION 0x20
DECL|macro|NO_WSS_MIXER
mdefine_line|#define NO_WSS_MIXER&t;-1
macro_line|#include &quot;coproc.h&quot;
macro_line|#include &quot;pss_boot.h&quot;
multiline_comment|/* If compiled into kernel, it enable or disable pss mixer */
macro_line|#ifdef CONFIG_PSS_MIXER
DECL|variable|pss_mixer
r_static
r_int
r_char
id|pss_mixer
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|pss_mixer
r_static
r_int
r_char
id|pss_mixer
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|struct|pss_mixerdata
r_typedef
r_struct
id|pss_mixerdata
(brace
DECL|member|volume_l
r_int
r_int
id|volume_l
suffix:semicolon
DECL|member|volume_r
r_int
r_int
id|volume_r
suffix:semicolon
DECL|member|bass
r_int
r_int
id|bass
suffix:semicolon
DECL|member|treble
r_int
r_int
id|treble
suffix:semicolon
DECL|member|synth
r_int
r_int
id|synth
suffix:semicolon
DECL|typedef|pss_mixerdata
)brace
id|pss_mixerdata
suffix:semicolon
DECL|struct|pss_confdata
r_typedef
r_struct
id|pss_confdata
(brace
DECL|member|base
r_int
id|base
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|dma
r_int
id|dma
suffix:semicolon
DECL|member|osp
r_int
op_star
id|osp
suffix:semicolon
DECL|member|mixer
id|pss_mixerdata
id|mixer
suffix:semicolon
DECL|member|ad_mixer_dev
r_int
id|ad_mixer_dev
suffix:semicolon
DECL|typedef|pss_confdata
)brace
id|pss_confdata
suffix:semicolon
DECL|variable|pss_data
r_static
id|pss_confdata
id|pss_data
suffix:semicolon
DECL|variable|devc
r_static
id|pss_confdata
op_star
id|devc
op_assign
op_amp
id|pss_data
suffix:semicolon
DECL|variable|pss_initialized
r_static
r_int
id|pss_initialized
op_assign
l_int|0
suffix:semicolon
DECL|variable|nonstandard_microcode
r_static
r_int
id|nonstandard_microcode
op_assign
l_int|0
suffix:semicolon
DECL|variable|pss_cdrom_port
r_static
r_int
id|pss_cdrom_port
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Parameter for the PSS cdrom port */
DECL|variable|pss_enable_joystick
r_static
r_int
id|pss_enable_joystick
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Parameter for enabling the joystick */
DECL|function|pss_write
r_static
r_void
id|pss_write
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
id|data
)paren
(brace
r_int
id|i
comma
id|limit
suffix:semicolon
id|limit
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
multiline_comment|/* The timeout is 0.1 seconds */
multiline_comment|/*&n;&t; * Note! the i&lt;5000000 is an emergency exit. The dsp_command() is sometimes&n;&t; * called while interrupts are disabled. This means that the timer is&n;&t; * disabled also. However the timeout situation is a abnormal condition.&n;&t; * Normally the DSP should be ready to accept commands after just couple of&n;&t; * loops.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5000000
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|limit
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_STATUS
)paren
)paren
op_amp
id|PSS_WRITE_EMPTY
)paren
(brace
id|outw
c_func
(paren
id|data
comma
id|REG
c_func
(paren
id|PSS_DATA
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;PSS: DSP Command (%04x) Timeout.&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|probe_pss
r_int
id|__init
id|probe_pss
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_int
id|id
suffix:semicolon
r_int
id|irq
comma
id|dma
suffix:semicolon
id|devc-&gt;base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|irq
op_assign
id|devc-&gt;irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|dma
op_assign
id|devc-&gt;dma
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|devc-&gt;osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
r_if
c_cond
(paren
id|devc-&gt;base
op_ne
l_int|0x220
op_logical_and
id|devc-&gt;base
op_ne
l_int|0x240
)paren
r_if
c_cond
(paren
id|devc-&gt;base
op_ne
l_int|0x230
op_logical_and
id|devc-&gt;base
op_ne
l_int|0x250
)paren
multiline_comment|/* Some cards use these */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|devc-&gt;base
comma
l_int|0x19
multiline_comment|/*16*/
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: I/O port conflict&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|id
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_ID
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_rshift
l_int|8
)paren
op_ne
l_char|&squot;E&squot;
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No PSS signature detected at 0x%x (0x%x)&bslash;n&quot;
comma
id|devc-&gt;base
comma
id|id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|set_irq
r_static
r_int
id|set_irq
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
id|dev
comma
r_int
id|irq
)paren
(brace
r_static
r_int
r_int
id|irq_bits
(braket
l_int|16
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0008
comma
l_int|0x0000
comma
l_int|0x0010
comma
l_int|0x0000
comma
l_int|0x0018
comma
l_int|0x0000
comma
l_int|0x0020
comma
l_int|0x0028
comma
l_int|0x0030
comma
l_int|0x0038
comma
l_int|0x0000
comma
l_int|0x0000
comma
l_int|0x0000
)brace
suffix:semicolon
r_int
r_int
id|tmp
comma
id|bits
suffix:semicolon
r_if
c_cond
(paren
id|irq
template_param
l_int|15
)paren
r_return
l_int|0
suffix:semicolon
id|tmp
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|dev
)paren
)paren
op_amp
op_complement
l_int|0x38
suffix:semicolon
multiline_comment|/* Load confreg, mask IRQ bits out */
r_if
c_cond
(paren
(paren
id|bits
op_assign
id|irq_bits
(braket
id|irq
)braket
)paren
op_eq
l_int|0
op_logical_and
id|irq
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: Invalid IRQ %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outw
c_func
(paren
id|tmp
op_or
id|bits
comma
id|REG
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|set_io_base
r_static
r_int
id|set_io_base
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
id|dev
comma
r_int
id|base
)paren
(brace
r_int
r_int
id|tmp
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|dev
)paren
)paren
op_amp
l_int|0x003f
suffix:semicolon
r_int
r_int
id|bits
op_assign
(paren
id|base
op_amp
l_int|0x0ffc
)paren
op_lshift
l_int|4
suffix:semicolon
id|outw
c_func
(paren
id|bits
op_or
id|tmp
comma
id|REG
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|set_dma
r_static
r_int
id|set_dma
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
id|dev
comma
r_int
id|dma
)paren
(brace
r_static
r_int
r_int
id|dma_bits
(braket
l_int|8
)braket
op_assign
(brace
l_int|0x0001
comma
l_int|0x0002
comma
l_int|0x0000
comma
l_int|0x0003
comma
l_int|0x0000
comma
l_int|0x0005
comma
l_int|0x0006
comma
l_int|0x0007
)brace
suffix:semicolon
r_int
r_int
id|tmp
comma
id|bits
suffix:semicolon
r_if
c_cond
(paren
id|dma
template_param
l_int|7
)paren
r_return
l_int|0
suffix:semicolon
id|tmp
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|dev
)paren
)paren
op_amp
op_complement
l_int|0x07
suffix:semicolon
multiline_comment|/* Load confreg, mask DMA bits out */
r_if
c_cond
(paren
(paren
id|bits
op_assign
id|dma_bits
(braket
id|dma
)braket
)paren
op_eq
l_int|0
op_logical_and
id|dma
op_ne
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: Invalid DMA %d&bslash;n&quot;
comma
id|dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|outw
c_func
(paren
id|tmp
op_or
id|bits
comma
id|REG
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pss_reset_dsp
r_static
r_int
id|pss_reset_dsp
c_func
(paren
id|pss_confdata
op_star
id|devc
)paren
(brace
r_int
r_int
id|i
comma
id|limit
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
id|outw
c_func
(paren
l_int|0x2000
comma
id|REG
c_func
(paren
id|PSS_CONTROL
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32768
op_logical_and
(paren
id|limit
op_minus
id|jiffies
op_ge
l_int|0
)paren
suffix:semicolon
id|i
op_increment
)paren
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_CONTROL
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|REG
c_func
(paren
id|PSS_CONTROL
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pss_put_dspword
r_static
r_int
id|pss_put_dspword
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
r_int
id|word
)paren
(brace
r_int
id|i
comma
id|val
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|327680
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_STATUS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|PSS_WRITE_EMPTY
)paren
(brace
id|outw
c_func
(paren
id|word
comma
id|REG
c_func
(paren
id|PSS_DATA
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pss_get_dspword
r_static
r_int
id|pss_get_dspword
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
r_int
op_star
id|word
)paren
(brace
r_int
id|i
comma
id|val
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|327680
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_STATUS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|PSS_READ_FULL
)paren
(brace
op_star
id|word
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_DATA
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pss_download_boot
r_static
r_int
id|pss_download_boot
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
r_char
op_star
id|block
comma
r_int
id|size
comma
r_int
id|flags
)paren
(brace
r_int
id|i
comma
id|limit
comma
id|val
comma
id|count
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|CPF_FIRST
)paren
(brace
multiline_comment|/*_____ Warn DSP software that a boot is coming */
id|outw
c_func
(paren
l_int|0x00fe
comma
id|REG
c_func
(paren
id|PSS_DATA
)paren
)paren
suffix:semicolon
id|limit
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32768
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|limit
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_DATA
)paren
)paren
op_eq
l_int|0x5500
)paren
r_break
suffix:semicolon
id|outw
c_func
(paren
op_star
id|block
op_increment
comma
id|REG
c_func
(paren
id|PSS_DATA
)paren
)paren
suffix:semicolon
id|pss_reset_dsp
c_func
(paren
id|devc
)paren
suffix:semicolon
)brace
id|count
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|flags
op_amp
id|CPF_LAST
)paren
op_logical_or
id|count
OL
id|size
)paren
(brace
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|327670
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/*_____ Wait for BG to appear */
r_if
c_cond
(paren
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_STATUS
)paren
)paren
op_amp
id|PSS_FLAG3
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
l_int|327670
)paren
(brace
multiline_comment|/* It&squot;s ok we timed out when the file was empty */
r_if
c_cond
(paren
id|count
op_ge
id|size
op_logical_and
id|flags
op_amp
id|CPF_LAST
)paren
r_break
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: Download timeout problems, byte %d=%d&bslash;n&quot;
comma
id|count
comma
id|size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*_____ Send the next byte */
r_if
c_cond
(paren
id|count
op_ge
id|size
)paren
(brace
multiline_comment|/* If not data in block send 0xffff */
id|outw
(paren
l_int|0xffff
comma
id|REG
(paren
id|PSS_DATA
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*_____ Send the next byte */
id|outw
(paren
op_star
id|block
op_increment
comma
id|REG
(paren
id|PSS_DATA
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|CPF_LAST
)paren
(brace
multiline_comment|/*_____ Why */
id|outw
c_func
(paren
l_int|0
comma
id|REG
c_func
(paren
id|PSS_DATA
)paren
)paren
suffix:semicolon
id|limit
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32768
op_logical_and
(paren
id|limit
op_minus
id|jiffies
op_ge
l_int|0
)paren
suffix:semicolon
id|i
op_increment
)paren
id|val
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_STATUS
)paren
)paren
suffix:semicolon
id|limit
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32768
op_logical_and
(paren
id|limit
op_minus
id|jiffies
op_ge
l_int|0
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_STATUS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
l_int|0x4000
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* now read the version */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_STATUS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|PSS_READ_FULL
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|32000
)paren
r_return
l_int|0
suffix:semicolon
id|val
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_DATA
)paren
)paren
suffix:semicolon
multiline_comment|/* printk( &quot;&lt;PSS: microcode version %d.%d loaded&gt;&quot;,  val/16,  val % 16); */
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Mixer */
DECL|function|set_master_volume
r_static
r_void
id|set_master_volume
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
id|left
comma
r_int
id|right
)paren
(brace
r_static
r_int
r_char
id|log_scale
(braket
l_int|101
)braket
op_assign
(brace
l_int|0xdb
comma
l_int|0xe0
comma
l_int|0xe3
comma
l_int|0xe5
comma
l_int|0xe7
comma
l_int|0xe9
comma
l_int|0xea
comma
l_int|0xeb
comma
l_int|0xec
comma
l_int|0xed
comma
l_int|0xed
comma
l_int|0xee
comma
l_int|0xef
comma
l_int|0xef
comma
l_int|0xf0
comma
l_int|0xf0
comma
l_int|0xf1
comma
l_int|0xf1
comma
l_int|0xf2
comma
l_int|0xf2
comma
l_int|0xf2
comma
l_int|0xf3
comma
l_int|0xf3
comma
l_int|0xf3
comma
l_int|0xf4
comma
l_int|0xf4
comma
l_int|0xf4
comma
l_int|0xf5
comma
l_int|0xf5
comma
l_int|0xf5
comma
l_int|0xf5
comma
l_int|0xf6
comma
l_int|0xf6
comma
l_int|0xf6
comma
l_int|0xf6
comma
l_int|0xf7
comma
l_int|0xf7
comma
l_int|0xf7
comma
l_int|0xf7
comma
l_int|0xf7
comma
l_int|0xf8
comma
l_int|0xf8
comma
l_int|0xf8
comma
l_int|0xf8
comma
l_int|0xf8
comma
l_int|0xf9
comma
l_int|0xf9
comma
l_int|0xf9
comma
l_int|0xf9
comma
l_int|0xf9
comma
l_int|0xf9
comma
l_int|0xfa
comma
l_int|0xfa
comma
l_int|0xfa
comma
l_int|0xfa
comma
l_int|0xfa
comma
l_int|0xfa
comma
l_int|0xfa
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
)brace
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
l_int|0x0010
)paren
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
id|log_scale
(braket
id|left
)braket
op_or
l_int|0x0000
)paren
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
l_int|0x0010
)paren
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
id|log_scale
(braket
id|right
)braket
op_or
l_int|0x0100
)paren
suffix:semicolon
)brace
DECL|function|set_synth_volume
r_static
r_void
id|set_synth_volume
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
id|volume
)paren
(brace
r_int
id|vol
op_assign
(paren
(paren
l_int|0x8000
op_star
id|volume
)paren
op_div
l_int|100L
)paren
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
l_int|0x0080
)paren
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
id|vol
)paren
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
l_int|0x0081
)paren
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
id|vol
)paren
suffix:semicolon
)brace
DECL|function|set_bass
r_static
r_void
id|set_bass
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
id|level
)paren
(brace
r_int
id|vol
op_assign
(paren
r_int
)paren
(paren
(paren
(paren
l_int|0xfd
op_minus
l_int|0xf0
)paren
op_star
id|level
)paren
op_div
l_int|100L
)paren
op_plus
l_int|0xf0
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
l_int|0x0010
)paren
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
id|vol
op_or
l_int|0x0200
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|function|set_treble
r_static
r_void
id|set_treble
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
id|level
)paren
(brace
r_int
id|vol
op_assign
(paren
(paren
(paren
l_int|0xfd
op_minus
l_int|0xf0
)paren
op_star
id|level
)paren
op_div
l_int|100L
)paren
op_plus
l_int|0xf0
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
l_int|0x0010
)paren
suffix:semicolon
id|pss_write
c_func
(paren
id|devc
comma
id|vol
op_or
l_int|0x0300
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|function|pss_mixer_reset
r_static
r_void
id|pss_mixer_reset
c_func
(paren
id|pss_confdata
op_star
id|devc
)paren
(brace
id|set_master_volume
c_func
(paren
id|devc
comma
l_int|33
comma
l_int|33
)paren
suffix:semicolon
id|set_bass
c_func
(paren
id|devc
comma
l_int|50
)paren
suffix:semicolon
id|set_treble
c_func
(paren
id|devc
comma
l_int|50
)paren
suffix:semicolon
id|set_synth_volume
c_func
(paren
id|devc
comma
l_int|30
)paren
suffix:semicolon
id|pss_write
(paren
id|devc
comma
l_int|0x0010
)paren
suffix:semicolon
id|pss_write
(paren
id|devc
comma
l_int|0x0800
op_or
l_int|0xce
)paren
suffix:semicolon
multiline_comment|/* Stereo */
r_if
c_cond
(paren
id|pss_mixer
)paren
(brace
id|devc-&gt;mixer.volume_l
op_assign
id|devc-&gt;mixer.volume_r
op_assign
l_int|33
suffix:semicolon
id|devc-&gt;mixer.bass
op_assign
l_int|50
suffix:semicolon
id|devc-&gt;mixer.treble
op_assign
l_int|50
suffix:semicolon
id|devc-&gt;mixer.synth
op_assign
l_int|30
suffix:semicolon
)brace
)brace
DECL|function|arg_to_volume_mono
r_static
r_void
id|arg_to_volume_mono
c_func
(paren
r_int
r_int
id|volume
comma
r_int
op_star
id|aleft
)paren
(brace
r_int
id|left
suffix:semicolon
id|left
op_assign
id|volume
op_amp
l_int|0x00ff
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
op_star
id|aleft
op_assign
id|left
suffix:semicolon
)brace
DECL|function|arg_to_volume_stereo
r_static
r_void
id|arg_to_volume_stereo
c_func
(paren
r_int
r_int
id|volume
comma
r_int
op_star
id|aleft
comma
r_int
op_star
id|aright
)paren
(brace
id|arg_to_volume_mono
c_func
(paren
id|volume
comma
id|aleft
)paren
suffix:semicolon
id|arg_to_volume_mono
c_func
(paren
id|volume
op_rshift
l_int|8
comma
id|aright
)paren
suffix:semicolon
)brace
DECL|function|ret_vol_mono
r_static
r_int
id|ret_vol_mono
c_func
(paren
r_int
id|left
)paren
(brace
r_return
(paren
(paren
id|left
op_lshift
l_int|8
)paren
op_or
id|left
)paren
suffix:semicolon
)brace
DECL|function|ret_vol_stereo
r_static
r_int
id|ret_vol_stereo
c_func
(paren
r_int
id|left
comma
r_int
id|right
)paren
(brace
r_return
(paren
(paren
id|right
op_lshift
l_int|8
)paren
op_or
id|left
)paren
suffix:semicolon
)brace
DECL|function|call_ad_mixer
r_static
r_int
id|call_ad_mixer
c_func
(paren
id|pss_confdata
op_star
id|devc
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
id|NO_WSS_MIXER
)paren
r_return
id|mixer_devs
(braket
id|devc-&gt;ad_mixer_dev
)braket
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|devc-&gt;ad_mixer_dev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|pss_mixer_ioctl
r_static
r_int
id|pss_mixer_ioctl
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
id|pss_confdata
op_star
id|devc
op_assign
id|mixer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
id|cmdf
op_assign
id|cmd
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmdf
op_ne
id|SOUND_MIXER_VOLUME
)paren
op_logical_and
(paren
id|cmdf
op_ne
id|SOUND_MIXER_BASS
)paren
op_logical_and
(paren
id|cmdf
op_ne
id|SOUND_MIXER_TREBLE
)paren
op_logical_and
(paren
id|cmdf
op_ne
id|SOUND_MIXER_SYNTH
)paren
op_logical_and
(paren
id|cmdf
op_ne
id|SOUND_MIXER_DEVMASK
)paren
op_logical_and
(paren
id|cmdf
op_ne
id|SOUND_MIXER_STEREODEVS
)paren
op_logical_and
(paren
id|cmdf
op_ne
id|SOUND_MIXER_RECMASK
)paren
op_logical_and
(paren
id|cmdf
op_ne
id|SOUND_MIXER_CAPS
)paren
op_logical_and
(paren
id|cmdf
op_ne
id|SOUND_MIXER_RECSRC
)paren
)paren
(brace
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|cmd
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_ne
l_char|&squot;M&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|_SIOC_DIR
(paren
id|cmd
)paren
op_amp
id|_SIOC_WRITE
)paren
(brace
r_switch
c_cond
(paren
id|cmdf
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
id|NO_WSS_MIXER
)paren
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
id|arg_to_volume_stereo
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|devc-&gt;mixer.volume_l
comma
op_amp
id|devc-&gt;mixer.volume_r
)paren
suffix:semicolon
id|set_master_volume
c_func
(paren
id|devc
comma
id|devc-&gt;mixer.volume_l
comma
id|devc-&gt;mixer.volume_r
)paren
suffix:semicolon
r_return
id|ret_vol_stereo
c_func
(paren
id|devc-&gt;mixer.volume_l
comma
id|devc-&gt;mixer.volume_r
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_BASS
suffix:colon
id|arg_to_volume_mono
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|devc-&gt;mixer.bass
)paren
suffix:semicolon
id|set_bass
c_func
(paren
id|devc
comma
id|devc-&gt;mixer.bass
)paren
suffix:semicolon
r_return
id|ret_vol_mono
c_func
(paren
id|devc-&gt;mixer.bass
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_TREBLE
suffix:colon
id|arg_to_volume_mono
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|devc-&gt;mixer.treble
)paren
suffix:semicolon
id|set_treble
c_func
(paren
id|devc
comma
id|devc-&gt;mixer.treble
)paren
suffix:semicolon
r_return
id|ret_vol_mono
c_func
(paren
id|devc-&gt;mixer.treble
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_SYNTH
suffix:colon
id|arg_to_volume_mono
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|devc-&gt;mixer.synth
)paren
suffix:semicolon
id|set_synth_volume
c_func
(paren
id|devc
comma
id|devc-&gt;mixer.synth
)paren
suffix:semicolon
r_return
id|ret_vol_mono
c_func
(paren
id|devc-&gt;mixer.synth
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Return parameters&n;&t;&t; */
r_switch
c_cond
(paren
id|cmdf
)paren
(brace
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
r_if
c_cond
(paren
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
op_eq
op_minus
id|EINVAL
)paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no mixer devices */
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_or_assign
id|SOUND_MASK_VOLUME
op_or
id|SOUND_MASK_BASS
op_or
id|SOUND_MASK_TREBLE
op_or
id|SOUND_MASK_SYNTH
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
r_if
c_cond
(paren
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
op_eq
op_minus
id|EINVAL
)paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no stereo devices */
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_or_assign
id|SOUND_MASK_VOLUME
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
id|NO_WSS_MIXER
)paren
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_else
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
l_int|0
)paren
suffix:semicolon
multiline_comment|/* no record devices */
r_case
id|SOUND_MIXER_CAPS
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
id|NO_WSS_MIXER
)paren
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_else
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|SOUND_CAP_EXCL_INPUT
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
id|NO_WSS_MIXER
)paren
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_else
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
l_int|0
)paren
suffix:semicolon
multiline_comment|/* no record source */
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_stereo
c_func
(paren
id|devc-&gt;mixer.volume_l
comma
id|devc-&gt;mixer.volume_r
)paren
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_BASS
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_mono
c_func
(paren
id|devc-&gt;mixer.bass
)paren
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_TREBLE
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_mono
c_func
(paren
id|devc-&gt;mixer.treble
)paren
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_SYNTH
suffix:colon
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_mono
c_func
(paren
id|devc-&gt;mixer.synth
)paren
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
DECL|variable|pss_mixer_operations
r_static
r_struct
id|mixer_operations
id|pss_mixer_operations
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|id
suffix:colon
l_string|&quot;SOUNDPORT&quot;
comma
id|name
suffix:colon
l_string|&quot;PSS-AD1848&quot;
comma
id|ioctl
suffix:colon
id|pss_mixer_ioctl
)brace
suffix:semicolon
DECL|function|disable_all_emulations
r_void
id|disable_all_emulations
c_func
(paren
r_void
)paren
(brace
id|outw
c_func
(paren
l_int|0x0000
comma
id|REG
c_func
(paren
id|CONF_PSS
)paren
)paren
suffix:semicolon
multiline_comment|/* 0x0400 enables joystick */
id|outw
c_func
(paren
l_int|0x0000
comma
id|REG
c_func
(paren
id|CONF_WSS
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|REG
c_func
(paren
id|CONF_SB
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|REG
c_func
(paren
id|CONF_MIDI
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|REG
c_func
(paren
id|CONF_CDROM
)paren
)paren
suffix:semicolon
)brace
DECL|function|configure_nonsound_components
r_void
id|configure_nonsound_components
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Configure Joystick port */
r_if
c_cond
(paren
id|pss_enable_joystick
)paren
(brace
id|outw
c_func
(paren
l_int|0x0400
comma
id|REG
c_func
(paren
id|CONF_PSS
)paren
)paren
suffix:semicolon
multiline_comment|/* 0x0400 enables joystick */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PSS: joystick enabled.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PSS: joystick port not enabled.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Configure CDROM port */
r_if
c_cond
(paren
id|pss_cdrom_port
op_eq
op_minus
l_int|1
)paren
multiline_comment|/* If cdrom port enablation wasn&squot;t requested */
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PSS: CDROM port not enabled.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|pss_cdrom_port
comma
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: CDROM I/O port conflict.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|set_io_base
c_func
(paren
id|devc
comma
id|CONF_CDROM
comma
id|pss_cdrom_port
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: CDROM I/O port could not be set.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* CDROM port successfully configured */
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PSS: CDROM I/O port set to 0x%x.&bslash;n&quot;
comma
id|pss_cdrom_port
)paren
suffix:semicolon
)brace
)brace
DECL|function|attach_pss
r_void
id|__init
id|attach_pss
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_int
id|id
suffix:semicolon
r_char
id|tmp
(braket
l_int|100
)braket
suffix:semicolon
id|devc-&gt;base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|devc-&gt;irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|devc-&gt;dma
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|devc-&gt;osp
op_assign
id|hw_config-&gt;osp
suffix:semicolon
id|devc-&gt;ad_mixer_dev
op_assign
id|NO_WSS_MIXER
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|probe_pss
c_func
(paren
id|hw_config
)paren
)paren
r_return
suffix:semicolon
id|request_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|0x10
comma
l_string|&quot;PSS mixer, SB emulation&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|0x10
comma
l_int|0x9
comma
l_string|&quot;PSS config&quot;
)paren
suffix:semicolon
id|id
op_assign
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_ID
)paren
)paren
op_amp
l_int|0x00ff
suffix:semicolon
multiline_comment|/*&n;&t; * Disable all emulations. Will be enabled later (if required).&n;&t; */
id|disable_all_emulations
c_func
(paren
)paren
suffix:semicolon
macro_line|#if YOU_REALLY_WANT_TO_ALLOCATE_THESE_RESOURCES
r_if
c_cond
(paren
id|sound_alloc_dma
c_func
(paren
id|hw_config-&gt;dma
comma
l_string|&quot;PSS&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pss.c: Can&squot;t allocate DMA channel.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|set_irq
c_func
(paren
id|devc
comma
id|CONF_PSS
comma
id|devc-&gt;irq
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PSS: IRQ allocation error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|set_dma
c_func
(paren
id|devc
comma
id|CONF_PSS
comma
id|devc-&gt;dma
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: DMA allocation error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
id|configure_nonsound_components
c_func
(paren
)paren
suffix:semicolon
id|pss_initialized
op_assign
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|tmp
comma
l_string|&quot;ECHO-PSS  Rev. %d&quot;
comma
id|id
)paren
suffix:semicolon
id|conf_printf
c_func
(paren
id|tmp
comma
id|hw_config
)paren
suffix:semicolon
)brace
DECL|function|probe_pss_mpu
r_int
id|__init
id|probe_pss_mpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_initialized
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: MPU I/O port conflict&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|set_io_base
c_func
(paren
id|devc
comma
id|CONF_MIDI
comma
id|hw_config-&gt;io_base
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: MIDI base could not be set.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|set_irq
c_func
(paren
id|devc
comma
id|CONF_MIDI
comma
id|hw_config-&gt;irq
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: MIDI IRQ allocation error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_synthLen
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: Can&squot;t enable MPU. MIDI synth microcode not available.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_download_boot
c_func
(paren
id|devc
comma
id|pss_synth
comma
id|pss_synthLen
comma
id|CPF_FIRST
op_or
id|CPF_LAST
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: Unable to load MIDI synth microcode to DSP.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Finally wait until the DSP algorithm has initialized itself and&n;&t; * deactivates receive interrupt.&n;&t; */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|900000
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|1
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Input data avail */
id|inb
c_func
(paren
id|hw_config-&gt;io_base
)paren
suffix:semicolon
multiline_comment|/* Discard it */
r_else
r_break
suffix:semicolon
multiline_comment|/* No more input */
)brace
r_return
id|probe_mpu401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|function|pss_coproc_open
r_static
r_int
id|pss_coproc_open
c_func
(paren
r_void
op_star
id|dev_info
comma
r_int
id|sub_device
)paren
(brace
r_switch
c_cond
(paren
id|sub_device
)paren
(brace
r_case
id|COPR_MIDI
suffix:colon
r_if
c_cond
(paren
id|pss_synthLen
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: MIDI synth microcode not available.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nonstandard_microcode
)paren
r_if
c_cond
(paren
op_logical_neg
id|pss_download_boot
c_func
(paren
id|devc
comma
id|pss_synth
comma
id|pss_synthLen
comma
id|CPF_FIRST
op_or
id|CPF_LAST
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: Unable to load MIDI synth microcode to DSP.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|nonstandard_microcode
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pss_coproc_close
r_static
r_void
id|pss_coproc_close
c_func
(paren
r_void
op_star
id|dev_info
comma
r_int
id|sub_device
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|pss_coproc_reset
r_static
r_void
id|pss_coproc_reset
c_func
(paren
r_void
op_star
id|dev_info
)paren
(brace
r_if
c_cond
(paren
id|pss_synthLen
)paren
r_if
c_cond
(paren
op_logical_neg
id|pss_download_boot
c_func
(paren
id|devc
comma
id|pss_synth
comma
id|pss_synthLen
comma
id|CPF_FIRST
op_or
id|CPF_LAST
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: Unable to load MIDI synth microcode to DSP.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|nonstandard_microcode
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|download_boot_block
r_static
r_int
id|download_boot_block
c_func
(paren
r_void
op_star
id|dev_info
comma
id|copr_buffer
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|buf-&gt;len
op_le
l_int|0
op_logical_or
id|buf-&gt;len
OG
r_sizeof
(paren
id|buf-&gt;data
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_download_boot
c_func
(paren
id|devc
comma
id|buf-&gt;data
comma
id|buf-&gt;len
comma
id|buf-&gt;flags
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: Unable to load microcode block to DSP.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|nonstandard_microcode
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* The MIDI microcode has been overwritten */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pss_coproc_ioctl
r_static
r_int
id|pss_coproc_ioctl
c_func
(paren
r_void
op_star
id|dev_info
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
comma
r_int
id|local
)paren
(brace
id|copr_buffer
op_star
id|buf
suffix:semicolon
id|copr_msg
op_star
id|mbuf
suffix:semicolon
id|copr_debug_buf
id|dbuf
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
op_star
id|data
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
multiline_comment|/* printk( &quot;PSS coproc ioctl %x %x %d&bslash;n&quot;,  cmd,  arg,  local); */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDCTL_COPR_RESET
suffix:colon
id|pss_coproc_reset
c_func
(paren
id|dev_info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_COPR_LOAD
suffix:colon
id|buf
op_assign
(paren
id|copr_buffer
op_star
)paren
id|vmalloc
c_func
(paren
r_sizeof
(paren
id|copr_buffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buf
comma
id|arg
comma
r_sizeof
(paren
id|copr_buffer
)paren
)paren
)paren
(brace
id|vfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|err
op_assign
id|download_boot_block
c_func
(paren
id|dev_info
comma
id|buf
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
r_case
id|SNDCTL_COPR_SENDMSG
suffix:colon
id|mbuf
op_assign
(paren
id|copr_msg
op_star
)paren
id|vmalloc
c_func
(paren
r_sizeof
(paren
id|copr_msg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbuf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|mbuf
comma
id|arg
comma
r_sizeof
(paren
id|copr_msg
)paren
)paren
)paren
(brace
id|vfree
c_func
(paren
id|mbuf
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|data
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|mbuf-&gt;data
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mbuf-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
op_star
id|data
op_increment
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|mbuf-&gt;len
op_assign
id|i
suffix:semicolon
multiline_comment|/* feed back number of WORDs sent */
id|err
op_assign
id|copy_to_user
c_func
(paren
id|arg
comma
id|mbuf
comma
r_sizeof
(paren
id|copr_msg
)paren
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|mbuf
)paren
suffix:semicolon
r_return
id|err
ques
c_cond
op_minus
id|EFAULT
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|mbuf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_COPR_RCVMSG
suffix:colon
id|err
op_assign
l_int|0
suffix:semicolon
id|mbuf
op_assign
(paren
id|copr_msg
op_star
)paren
id|vmalloc
c_func
(paren
r_sizeof
(paren
id|copr_msg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mbuf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
id|data
op_assign
(paren
r_int
r_int
op_star
)paren
id|mbuf-&gt;data
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|mbuf-&gt;data
)paren
op_div
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mbuf-&gt;len
op_assign
id|i
suffix:semicolon
multiline_comment|/* feed back number of WORDs read */
r_if
c_cond
(paren
op_logical_neg
id|pss_get_dspword
c_func
(paren
id|devc
comma
id|data
op_increment
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
id|mbuf
comma
r_sizeof
(paren
id|copr_msg
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|vfree
c_func
(paren
id|mbuf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
r_case
id|SNDCTL_COPR_RDATA
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dbuf
comma
id|arg
comma
r_sizeof
(paren
id|dbuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
l_int|0x00d0
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
(paren
r_int
r_int
)paren
(paren
id|dbuf.parm1
op_amp
l_int|0xffff
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_get_dspword
c_func
(paren
id|devc
comma
op_amp
id|tmp
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|dbuf.parm1
op_assign
id|tmp
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|dbuf
comma
r_sizeof
(paren
id|dbuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_COPR_WDATA
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dbuf
comma
id|arg
comma
r_sizeof
(paren
id|dbuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
l_int|0x00d1
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
(paren
r_int
r_int
)paren
(paren
id|dbuf.parm1
op_amp
l_int|0xffff
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|dbuf.parm2
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
id|tmp
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_COPR_WCODE
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dbuf
comma
id|arg
comma
r_sizeof
(paren
id|dbuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
l_int|0x00d3
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
(paren
r_int
r_int
)paren
(paren
id|dbuf.parm1
op_amp
l_int|0xffff
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|tmp
op_assign
(paren
r_int
r_int
)paren
id|dbuf.parm2
op_amp
l_int|0x00ff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
id|tmp
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|tmp
op_assign
(paren
(paren
r_int
r_int
)paren
id|dbuf.parm2
op_rshift
l_int|8
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
id|tmp
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_COPR_RCODE
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dbuf
comma
id|arg
comma
r_sizeof
(paren
id|dbuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
l_int|0x00d2
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_put_dspword
c_func
(paren
id|devc
comma
(paren
r_int
r_int
)paren
(paren
id|dbuf.parm1
op_amp
l_int|0xffff
)paren
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_get_dspword
c_func
(paren
id|devc
comma
op_amp
id|tmp
)paren
)paren
(brace
multiline_comment|/* Read MSB */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|dbuf.parm1
op_assign
id|tmp
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_get_dspword
c_func
(paren
id|devc
comma
op_amp
id|tmp
)paren
)paren
(brace
multiline_comment|/* Read LSB */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|dbuf.parm1
op_or_assign
id|tmp
op_amp
l_int|0x00ff
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|dbuf
comma
r_sizeof
(paren
id|dbuf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|pss_coproc_operations
r_static
id|coproc_operations
id|pss_coproc_operations
op_assign
(brace
l_string|&quot;ADSP-2115&quot;
comma
id|pss_coproc_open
comma
id|pss_coproc_close
comma
id|pss_coproc_ioctl
comma
id|pss_coproc_reset
comma
op_amp
id|pss_data
)brace
suffix:semicolon
DECL|function|attach_pss_mpu
r_static
r_void
id|__init
id|attach_pss_mpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|attach_mpu401
c_func
(paren
id|hw_config
comma
id|THIS_MODULE
)paren
suffix:semicolon
multiline_comment|/* Slot 1 */
r_if
c_cond
(paren
id|hw_config-&gt;slots
(braket
l_int|1
)braket
op_ne
op_minus
l_int|1
)paren
multiline_comment|/* The MPU driver installed itself */
id|midi_devs
(braket
id|hw_config-&gt;slots
(braket
l_int|1
)braket
)braket
op_member_access_from_pointer
id|coproc
op_assign
op_amp
id|pss_coproc_operations
suffix:semicolon
)brace
DECL|function|probe_pss_mss
r_static
r_int
id|__init
id|probe_pss_mss
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_volatile
r_int
id|timeout
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pss_initialized
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|8
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: WSS I/O port conflicts.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|set_io_base
c_func
(paren
id|devc
comma
id|CONF_WSS
comma
id|hw_config-&gt;io_base
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PSS: WSS base not settable.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|set_irq
c_func
(paren
id|devc
comma
id|CONF_WSS
comma
id|hw_config-&gt;irq
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PSS: WSS IRQ allocation error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|set_dma
c_func
(paren
id|devc
comma
id|CONF_WSS
comma
id|hw_config-&gt;dma
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PSS: WSS DMA allocation error&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * For some reason the card returns 0xff in the WSS status register&n;&t; * immediately after boot. Probably MIDI+SB emulation algorithm&n;&t; * downloaded to the ADSP2115 spends some time initializing the card.&n;&t; * Let&squot;s try to wait until it finishes this task.&n;&t; */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
id|timeout
OL
l_int|100000
op_logical_and
(paren
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
id|WSS_INDEX
)paren
op_amp
id|WSS_INITIALIZING
)paren
suffix:semicolon
id|timeout
op_increment
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
l_int|0x0b
)paren
comma
id|hw_config-&gt;io_base
op_plus
id|WSS_INDEX
)paren
suffix:semicolon
multiline_comment|/* Required by some cards */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|0
suffix:semicolon
(paren
id|inb
c_func
(paren
id|hw_config-&gt;io_base
op_plus
id|WSS_DATA
)paren
op_amp
id|WSS_AUTOCALIBRATION
)paren
op_logical_and
(paren
id|timeout
OL
l_int|100000
)paren
suffix:semicolon
id|timeout
op_increment
)paren
suffix:semicolon
r_return
id|probe_ms_sound
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|function|attach_pss_mss
r_static
r_void
id|__init
id|attach_pss_mss
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|my_mix
op_assign
op_minus
l_int|999
suffix:semicolon
multiline_comment|/* gcc shut up */
id|devc-&gt;ad_mixer_dev
op_assign
id|NO_WSS_MIXER
suffix:semicolon
r_if
c_cond
(paren
id|pss_mixer
)paren
(brace
r_if
c_cond
(paren
(paren
id|my_mix
op_assign
id|sound_install_mixer
(paren
id|MIXER_DRIVER_VERSION
comma
l_string|&quot;PSS-SPEAKERS and AD1848 (through MSS audio codec)&quot;
comma
op_amp
id|pss_mixer_operations
comma
r_sizeof
(paren
r_struct
id|mixer_operations
)paren
comma
id|devc
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not install PSS mixer&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|pss_mixer_reset
c_func
(paren
id|devc
)paren
suffix:semicolon
id|attach_ms_sound
c_func
(paren
id|hw_config
comma
id|THIS_MODULE
)paren
suffix:semicolon
multiline_comment|/* Slot 0 */
r_if
c_cond
(paren
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* The MSS driver installed itself */
id|audio_devs
(braket
id|hw_config-&gt;slots
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|coproc
op_assign
op_amp
id|pss_coproc_operations
suffix:semicolon
r_if
c_cond
(paren
id|pss_mixer
op_logical_and
(paren
id|num_mixers
op_eq
(paren
id|my_mix
op_plus
l_int|2
)paren
)paren
)paren
(brace
multiline_comment|/* The MSS mixer installed */
id|devc-&gt;ad_mixer_dev
op_assign
id|audio_devs
(braket
id|hw_config-&gt;slots
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|mixer_dev
suffix:semicolon
)brace
)brace
)brace
DECL|function|unload_pss
r_static
r_inline
r_void
id|__exit
id|unload_pss
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|0x10
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
op_plus
l_int|0x10
comma
l_int|0x9
)paren
suffix:semicolon
)brace
DECL|function|unload_pss_mpu
r_static
r_inline
r_void
id|__exit
id|unload_pss_mpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|unload_mpu401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|function|unload_pss_mss
r_static
r_inline
r_void
id|__exit
id|unload_pss_mss
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|unload_ms_sound
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|variable|cfg
r_static
r_struct
id|address_info
id|cfg
suffix:semicolon
DECL|variable|cfg2
r_static
r_struct
id|address_info
id|cfg2
suffix:semicolon
DECL|variable|cfg_mpu
r_static
r_struct
id|address_info
id|cfg_mpu
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|pss_io
id|__initdata
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|mss_io
id|__initdata
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|mss_irq
id|__initdata
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|mss_dma
id|__initdata
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|mpu_io
id|__initdata
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|mpu_irq
id|__initdata
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|pss_no_sound
id|__initdata
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Just configure non-sound components */
DECL|variable|pss_keep_settings
r_static
r_int
id|pss_keep_settings
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Keep hardware settings at module exit */
DECL|variable|pss_firmware
r_static
r_char
op_star
id|pss_firmware
op_assign
l_string|&quot;/etc/sound/pss_synth&quot;
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pss_io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pss_io
comma
l_string|&quot;Set i/o base of PSS card (probably 0x220 or 0x240)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mss_io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mss_io
comma
l_string|&quot;Set WSS (audio) i/o base (0x530, 0x604, 0xE80, 0xF40, or other. Address must end in 0 or 4 and must be from 0x100 to 0xFF4)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mss_irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mss_irq
comma
l_string|&quot;Set WSS (audio) IRQ (3, 5, 7, 9, 10, 11, 12)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mss_dma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mss_dma
comma
l_string|&quot;Set WSS (audio) DMA (0, 1, 3)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mpu_io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mpu_io
comma
l_string|&quot;Set MIDI i/o base (0x330 or other. Address must be on 4 location boundaries and must be from 0x100 to 0xFFC)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mpu_irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mpu_irq
comma
l_string|&quot;Set MIDI IRQ (3, 5, 7, 9, 10, 11, 12)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pss_cdrom_port
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pss_cdrom_port
comma
l_string|&quot;Set the PSS CDROM port i/o base (0x340 or other)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pss_enable_joystick
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pss_enable_joystick
comma
l_string|&quot;Enables the PSS joystick port (1 to enable, 0 to disable)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pss_no_sound
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pss_no_sound
comma
l_string|&quot;Configure sound compoents (0 - no, 1 - yes)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pss_keep_settings
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pss_keep_settings
comma
l_string|&quot;Keep hardware setting at driver unloading (0 - no, 1 - yes)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pss_firmware
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pss_firmware
comma
l_string|&quot;Location of the firmware file (default - /etc/sound/pss_synth)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pss_mixer
comma
l_string|&quot;b&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pss_mixer
comma
l_string|&quot;Enable (1) or disable (0) PSS mixer (controlling of output volume, bass, treble, synth volume). The mixer is not available on all PSS cards.&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Hannu Savolainen, Vladimir Michl&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Module for PSS sound cards (based on AD1848, ADSP-2115 and ESC614). This module includes control of output amplifier and synth volume of the Beethoven ADSP-16 card (this may work with other PSS cards).&bslash;n&quot;
)paren
suffix:semicolon
DECL|variable|fw_load
r_static
r_int
id|fw_load
op_assign
l_int|0
suffix:semicolon
DECL|variable|pssmpu
DECL|variable|pssmss
r_static
r_int
id|pssmpu
op_assign
l_int|0
comma
id|pssmss
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; *    Load a PSS sound card module&n; */
DECL|function|init_pss
r_static
r_int
id|__init
id|init_pss
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pss_no_sound
)paren
multiline_comment|/* If configuring only nonsound components */
(brace
id|cfg.io_base
op_assign
id|pss_io
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|probe_pss
c_func
(paren
op_amp
id|cfg
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ECHO-PSS  Rev. %d&bslash;n&quot;
comma
id|inw
c_func
(paren
id|REG
c_func
(paren
id|PSS_ID
)paren
)paren
op_amp
l_int|0x00ff
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PSS: loading in no sound mode.&bslash;n&quot;
)paren
suffix:semicolon
id|disable_all_emulations
c_func
(paren
)paren
suffix:semicolon
id|configure_nonsound_components
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cfg.io_base
op_assign
id|pss_io
suffix:semicolon
id|cfg2.io_base
op_assign
id|mss_io
suffix:semicolon
id|cfg2.irq
op_assign
id|mss_irq
suffix:semicolon
id|cfg2.dma
op_assign
id|mss_dma
suffix:semicolon
id|cfg_mpu.io_base
op_assign
id|mpu_io
suffix:semicolon
id|cfg_mpu.irq
op_assign
id|mpu_irq
suffix:semicolon
r_if
c_cond
(paren
id|cfg.io_base
op_eq
op_minus
l_int|1
op_logical_or
id|cfg2.io_base
op_eq
op_minus
l_int|1
op_logical_or
id|cfg2.irq
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.dma
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pss: mss_io, mss_dma, mss_irq and pss_io must be set.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_synth
)paren
(brace
id|fw_load
op_assign
l_int|1
suffix:semicolon
id|pss_synthLen
op_assign
id|mod_firmware_load
c_func
(paren
id|pss_firmware
comma
(paren
r_void
op_star
)paren
op_amp
id|pss_synth
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|probe_pss
c_func
(paren
op_amp
id|cfg
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|attach_pss
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *    Attach stuff&n;&t; */
r_if
c_cond
(paren
id|probe_pss_mpu
c_func
(paren
op_amp
id|cfg_mpu
)paren
)paren
(brace
id|pssmpu
op_assign
l_int|1
suffix:semicolon
id|attach_pss_mpu
c_func
(paren
op_amp
id|cfg_mpu
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|probe_pss_mss
c_func
(paren
op_amp
id|cfg2
)paren
)paren
(brace
id|pssmss
op_assign
l_int|1
suffix:semicolon
id|attach_pss_mss
c_func
(paren
op_amp
id|cfg2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_pss
r_static
r_void
id|__exit
id|cleanup_pss
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pss_no_sound
)paren
(brace
r_if
c_cond
(paren
id|fw_load
op_logical_and
id|pss_synth
)paren
(brace
id|vfree
c_func
(paren
id|pss_synth
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pssmss
)paren
(brace
id|unload_pss_mss
c_func
(paren
op_amp
id|cfg2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pssmpu
)paren
(brace
id|unload_pss_mpu
c_func
(paren
op_amp
id|cfg_mpu
)paren
suffix:semicolon
)brace
id|unload_pss
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pss_keep_settings
)paren
multiline_comment|/* Keep hardware settings if asked */
(brace
id|disable_all_emulations
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Resetting PSS sound card configurations.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|variable|init_pss
id|module_init
c_func
(paren
id|init_pss
)paren
suffix:semicolon
DECL|variable|cleanup_pss
id|module_exit
c_func
(paren
id|cleanup_pss
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|setup_pss
r_static
r_int
id|__init
id|setup_pss
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/* io, mss_io, mss_irq, mss_dma, mpu_io, mpu_irq */
r_int
id|ints
(braket
l_int|7
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|pss_io
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|mss_io
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|mss_irq
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|mss_dma
op_assign
id|ints
(braket
l_int|4
)braket
suffix:semicolon
id|mpu_io
op_assign
id|ints
(braket
l_int|5
)braket
suffix:semicolon
id|mpu_irq
op_assign
id|ints
(braket
l_int|6
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;pss=&quot;
comma
id|setup_pss
)paren
suffix:semicolon
macro_line|#endif
eof
