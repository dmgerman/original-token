multiline_comment|/*&n; * ac97_codec.c: Generic AC97 mixer module&n; *&n; * Derived from ac97 mixer in maestro and trident driver.&n; *&n; * Copyright 2000 Silicon Integrated System Corporation&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  History&n; *&t;Jan 14 2000 Ollie Lho &lt;ollie@sis.com.tw&gt; &n; *&t;Isloated from trident.c to support multiple ac97 codec&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &quot;ac97_codec.h&quot;
r_static
r_int
id|ac97_read_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|oss_channel
)paren
suffix:semicolon
r_static
r_void
id|ac97_write_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|oss_channel
comma
r_int
r_int
id|left
comma
r_int
r_int
id|right
)paren
suffix:semicolon
r_static
r_void
id|ac97_set_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
r_int
id|oss_mixer
comma
r_int
r_int
id|val
)paren
suffix:semicolon
r_static
r_int
id|ac97_recmask_io
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|rw
comma
r_int
id|mask
)paren
suffix:semicolon
r_static
r_int
id|ac97_mixer_ioctl
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_struct
(brace
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|init
r_int
(paren
op_star
id|init
)paren
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
suffix:semicolon
DECL|variable|snd_ac97_codec_ids
)brace
id|snd_ac97_codec_ids
(braket
)braket
op_assign
(brace
(brace
l_int|0x414B4D00
comma
l_string|&quot;Asahi Kasei AK4540&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x41445340
comma
l_string|&quot;Analog Devices AD1881&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x43525900
comma
l_string|&quot;Cirrus Logic CS4297&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x43525913
comma
l_string|&quot;Cirrus Logic CS4297A&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x43525931
comma
l_string|&quot;Cirrus Logic CS4299&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x4e534331
comma
l_string|&quot;National Semiconductor LM4549&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847600
comma
l_string|&quot;SigmaTel STAC????&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847604
comma
l_string|&quot;SigmaTel STAC9701/3/4/5&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847605
comma
l_string|&quot;SigmaTel STAC9704&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847608
comma
l_string|&quot;SigmaTel STAC9708&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847609
comma
l_string|&quot;SigmaTel STAC9721/23&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x00000000
comma
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* this table has default mixer values for all OSS mixers. */
DECL|struct|mixer_defaults
r_static
r_struct
id|mixer_defaults
(brace
DECL|member|mixer
r_int
id|mixer
suffix:semicolon
DECL|member|value
r_int
r_int
id|value
suffix:semicolon
DECL|variable|mixer_defaults
)brace
id|mixer_defaults
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
multiline_comment|/* all values 0 -&gt; 100 in bytes */
(brace
id|SOUND_MIXER_VOLUME
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_BASS
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_TREBLE
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_PCM
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_SPEAKER
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_LINE
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_MIC
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_CD
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_ALTPCM
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_IGAIN
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_LINE1
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_PHONEIN
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_PHONEOUT
comma
l_int|0x3232
)brace
comma
(brace
id|SOUND_MIXER_VIDEO
comma
l_int|0x3232
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* table to scale scale from OSS mixer value to AC97 mixer register value */
DECL|struct|ac97_mixer_hw
r_static
r_struct
id|ac97_mixer_hw
(brace
DECL|member|offset
r_int
r_char
id|offset
suffix:semicolon
DECL|member|scale
r_int
id|scale
suffix:semicolon
DECL|variable|ac97_hw
)brace
id|ac97_hw
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_VOLUME
)braket
op_assign
(brace
id|AC97_MASTER_VOL_STEREO
comma
l_int|63
)brace
comma
(braket
id|SOUND_MIXER_BASS
)braket
op_assign
(brace
id|AC97_MASTER_TONE
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_TREBLE
)braket
op_assign
(brace
id|AC97_MASTER_TONE
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_PCM
)braket
op_assign
(brace
id|AC97_PCMOUT_VOL
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_SPEAKER
)braket
op_assign
(brace
id|AC97_PCBEEP_VOL
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_LINE
)braket
op_assign
(brace
id|AC97_LINEIN_VOL
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
(brace
id|AC97_MIC_VOL
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_CD
)braket
op_assign
(brace
id|AC97_CD_VOL
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_ALTPCM
)braket
op_assign
(brace
id|AC97_HEADPHONE_VOL
comma
l_int|63
)brace
comma
(braket
id|SOUND_MIXER_IGAIN
)braket
op_assign
(brace
id|AC97_RECORD_GAIN
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_LINE1
)braket
op_assign
(brace
id|AC97_AUX_VOL
comma
l_int|31
)brace
comma
(braket
id|SOUND_MIXER_PHONEIN
)braket
op_assign
(brace
id|AC97_PHONE_VOL
comma
l_int|15
)brace
comma
(braket
id|SOUND_MIXER_PHONEOUT
)braket
op_assign
(brace
id|AC97_MASTER_VOL_MONO
comma
l_int|63
)brace
comma
(braket
id|SOUND_MIXER_VIDEO
)braket
op_assign
(brace
id|AC97_VIDEO_VOL
comma
l_int|31
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* the following tables allow us to go from OSS &lt;-&gt; ac97 quickly. */
DECL|enum|ac97_recsettings
r_enum
id|ac97_recsettings
(brace
DECL|enumerator|AC97_REC_MIC
id|AC97_REC_MIC
op_assign
l_int|0
comma
DECL|enumerator|AC97_REC_CD
id|AC97_REC_CD
comma
DECL|enumerator|AC97_REC_VIDEO
id|AC97_REC_VIDEO
comma
DECL|enumerator|AC97_REC_AUX
id|AC97_REC_AUX
comma
DECL|enumerator|AC97_REC_LINE
id|AC97_REC_LINE
comma
DECL|enumerator|AC97_REC_STEREO
id|AC97_REC_STEREO
comma
multiline_comment|/* combination of all enabled outputs..  */
DECL|enumerator|AC97_REC_MONO
id|AC97_REC_MONO
comma
multiline_comment|/*.. or the mono equivalent */
DECL|enumerator|AC97_REC_PHONE
id|AC97_REC_PHONE
)brace
suffix:semicolon
DECL|variable|ac97_rm2oss
r_static
r_int
r_int
id|ac97_rm2oss
(braket
)braket
op_assign
(brace
(braket
id|AC97_REC_MIC
)braket
op_assign
id|SOUND_MIXER_MIC
comma
(braket
id|AC97_REC_CD
)braket
op_assign
id|SOUND_MIXER_CD
comma
(braket
id|AC97_REC_VIDEO
)braket
op_assign
id|SOUND_MIXER_VIDEO
comma
(braket
id|AC97_REC_AUX
)braket
op_assign
id|SOUND_MIXER_LINE1
comma
(braket
id|AC97_REC_LINE
)braket
op_assign
id|SOUND_MIXER_LINE
comma
(braket
id|AC97_REC_PHONE
)braket
op_assign
id|SOUND_MIXER_PHONEIN
)brace
suffix:semicolon
multiline_comment|/* indexed by bit position */
DECL|variable|ac97_oss_rm
r_static
r_int
r_int
id|ac97_oss_rm
(braket
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
id|AC97_REC_MIC
comma
(braket
id|SOUND_MIXER_CD
)braket
op_assign
id|AC97_REC_CD
comma
(braket
id|SOUND_MIXER_VIDEO
)braket
op_assign
id|AC97_REC_VIDEO
comma
(braket
id|SOUND_MIXER_LINE1
)braket
op_assign
id|AC97_REC_AUX
comma
(braket
id|SOUND_MIXER_LINE
)braket
op_assign
id|AC97_REC_LINE
comma
(braket
id|SOUND_MIXER_PHONEIN
)braket
op_assign
id|AC97_REC_PHONE
)brace
suffix:semicolon
multiline_comment|/* reads the given OSS mixer from the ac97 the caller must have insured that the ac97 knows&n;   about that given mixer, and should be holding a spinlock for the card */
DECL|function|ac97_read_mixer
r_static
r_int
id|ac97_read_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|oss_channel
)paren
(brace
id|u16
id|val
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|ac97_mixer_hw
op_star
id|mh
op_assign
op_amp
id|ac97_hw
(braket
id|oss_channel
)braket
suffix:semicolon
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AC97_STEREO_MASK
op_amp
(paren
l_int|1
op_lshift
id|oss_channel
)paren
)paren
(brace
multiline_comment|/* nice stereo mixers .. */
r_int
id|left
comma
id|right
suffix:semicolon
id|left
op_assign
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|right
op_assign
id|val
op_amp
l_int|0x7f
suffix:semicolon
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_IGAIN
)paren
(brace
id|right
op_assign
(paren
id|right
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
suffix:semicolon
id|left
op_assign
(paren
id|left
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
suffix:semicolon
)brace
r_else
(brace
id|right
op_assign
l_int|100
op_minus
(paren
(paren
id|right
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
id|left
op_assign
l_int|100
op_minus
(paren
(paren
id|left
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_SPEAKER
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
(paren
id|val
op_amp
l_int|0x1e
)paren
op_rshift
l_int|1
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_MIC
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0x1f
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
multiline_comment|/*  the low bit is optional in the tone sliders and masking&n;&t;&t;    it lets us avoid the 0xf &squot;bypass&squot;.. */
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_BASS
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xe
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_TREBLE
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0xe
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ac97_codec: read OSS mixer %2d (ac97 register 0x%02x), &quot;
l_string|&quot;0x%04x -&gt; 0x%04x&bslash;n&quot;
comma
id|oss_channel
comma
id|mh-&gt;offset
comma
id|val
comma
id|ret
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* write the OSS encoded volume to the given OSS encoded mixer, again caller&squot;s job to&n;   make sure all is well in arg land, call with spinlock held */
DECL|function|ac97_write_mixer
r_static
r_void
id|ac97_write_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|oss_channel
comma
r_int
r_int
id|left
comma
r_int
r_int
id|right
)paren
(brace
id|u16
id|val
op_assign
l_int|0
suffix:semicolon
r_struct
id|ac97_mixer_hw
op_star
id|mh
op_assign
op_amp
id|ac97_hw
(braket
id|oss_channel
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ac97_codec: wrote OSS mixer %2d (%s ac97 register 0x%02x), &quot;
l_string|&quot;left vol:%2d, right vol:%2d:&quot;
comma
id|oss_channel
comma
id|codec-&gt;id
ques
c_cond
l_string|&quot;Secondary&quot;
suffix:colon
l_string|&quot;Primary&quot;
comma
id|mh-&gt;offset
comma
id|left
comma
id|right
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|AC97_STEREO_MASK
op_amp
(paren
l_int|1
op_lshift
id|oss_channel
)paren
)paren
(brace
multiline_comment|/* stereo mixers */
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_IGAIN
)paren
(brace
id|right
op_assign
(paren
id|right
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
id|left
op_assign
(paren
id|left
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
)brace
r_else
(brace
id|right
op_assign
(paren
(paren
l_int|100
op_minus
id|right
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
)brace
id|val
op_assign
(paren
id|left
op_lshift
l_int|8
)paren
op_or
id|right
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_SPEAKER
)paren
(brace
id|val
op_assign
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
op_lshift
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_MIC
)paren
(brace
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x801f
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
suffix:semicolon
multiline_comment|/*  the low bit is optional in the tone sliders and masking&n;&t;&t;    it lets us avoid the 0xf &squot;bypass&squot;.. */
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_BASS
)paren
(brace
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x0f00
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
op_lshift
l_int|8
)paren
op_amp
l_int|0x0e00
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_TREBLE
)paren
(brace
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x000f
suffix:semicolon
id|val
op_or_assign
(paren
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
)paren
op_amp
l_int|0x000e
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot; 0x%04x&quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|mh-&gt;offset
comma
id|val
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; -&gt; 0x%04x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* a thin wrapper for write_mixer */
DECL|function|ac97_set_mixer
r_static
r_void
id|ac97_set_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
r_int
id|oss_mixer
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|left
comma
id|right
suffix:semicolon
multiline_comment|/* cleanse input a little */
id|right
op_assign
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|left
op_assign
(paren
id|val
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
id|right
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
id|codec-&gt;mixer_state
(braket
id|oss_mixer
)braket
op_assign
(paren
id|right
op_lshift
l_int|8
)paren
op_or
id|left
suffix:semicolon
id|codec
op_member_access_from_pointer
id|write_mixer
c_func
(paren
id|codec
comma
id|oss_mixer
comma
id|left
comma
id|right
)paren
suffix:semicolon
)brace
multiline_comment|/* read or write the recmask, the ac97 can really have left and right recording&n;   inputs independantly set, but OSS doesn&squot;t seem to want us to express that to&n;   the user. the caller guarantees that we have a supported bit set, and they&n;   must be holding the card&squot;s spinlock */
DECL|function|ac97_recmask_io
r_static
r_int
id|ac97_recmask_io
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|rw
comma
r_int
id|mask
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|rw
)paren
(brace
multiline_comment|/* read it from the card */
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
l_int|0x1a
)paren
op_amp
l_int|0x7
suffix:semicolon
r_return
id|ac97_rm2oss
(braket
id|val
)braket
suffix:semicolon
)brace
multiline_comment|/* else, write the first set in the mask as the&n;&t;   output */
id|val
op_assign
id|ffs
c_func
(paren
id|mask
)paren
suffix:semicolon
id|val
op_assign
id|ac97_oss_rm
(braket
id|val
op_minus
l_int|1
)braket
suffix:semicolon
id|val
op_or_assign
id|val
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* set both channels */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ac97_codec: setting ac97 recmask to 0x%x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
l_int|0x1a
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|ac97_mixer_ioctl
r_static
r_int
id|ac97_mixer_ioctl
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|i
comma
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_INFO
)paren
(brace
id|mixer_info
id|info
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
id|codec-&gt;name
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
id|codec-&gt;name
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
id|info.modify_counter
op_assign
id|codec-&gt;modcnt
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_OLD_MIXER_INFO
)paren
(brace
id|_old_mixer_info
id|info
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
id|codec-&gt;name
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
id|codec-&gt;name
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
op_ne
l_char|&squot;M&squot;
op_logical_or
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
op_ne
r_sizeof
(paren
r_int
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|OSS_GETVERSION
)paren
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
id|_IOC_READ
)paren
(brace
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
multiline_comment|/* give them the current record source */
r_if
c_cond
(paren
op_logical_neg
id|codec-&gt;recmask_io
)paren
(brace
id|val
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|codec
op_member_access_from_pointer
id|recmask_io
c_func
(paren
id|codec
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
multiline_comment|/* give them the supported mixers */
id|val
op_assign
id|codec-&gt;supported_mixers
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
multiline_comment|/* Arg contains a bit for each supported recording source */
id|val
op_assign
id|codec-&gt;record_sources
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
multiline_comment|/* Mixer channels supporting stereo */
id|val
op_assign
id|codec-&gt;stereo_mixers
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
id|val
op_assign
id|SOUND_CAP_EXCL_INPUT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* read a specific mixer */
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|codec
comma
id|i
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* do we ever want to touch the hardware? */
multiline_comment|/* val = codec-&gt;read_mixer(card,i); */
id|val
op_assign
id|codec-&gt;mixer_state
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
(paren
id|_IOC_WRITE
op_or
id|_IOC_READ
)paren
)paren
(brace
id|codec-&gt;modcnt
op_increment
suffix:semicolon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
multiline_comment|/* Arg contains a bit for each recording source */
r_if
c_cond
(paren
op_logical_neg
id|codec-&gt;recmask_io
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_and_assign
id|codec-&gt;record_sources
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|codec
op_member_access_from_pointer
id|recmask_io
c_func
(paren
id|codec
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* write a specific mixer */
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|codec
comma
id|i
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ac97_set_mixer
c_func
(paren
id|codec
comma
id|i
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ac97_probe_codec
r_int
id|ac97_probe_codec
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
(brace
id|u16
id|id1
comma
id|id2
comma
id|cap
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* probing AC97 codec, AC97 2.0 says that bit 15 of register 0x00 (reset) should &n;&t;   be read zero. Probing of AC97 in this way is not reliable, it is not even SAFE !! */
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_RESET
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cap
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_RESET
)paren
)paren
op_amp
l_int|0x8000
)paren
r_return
l_int|0
suffix:semicolon
id|id1
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_VENDOR_ID1
)paren
suffix:semicolon
id|id2
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_VENDOR_ID2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|snd_ac97_codec_ids
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|snd_ac97_codec_ids
(braket
id|i
)braket
dot
id|id
op_eq
(paren
(paren
id|id1
op_lshift
l_int|16
)paren
op_or
id|id2
)paren
)paren
(brace
id|codec-&gt;name
op_assign
id|snd_ac97_codec_ids
(braket
id|i
)braket
dot
id|name
suffix:semicolon
id|codec-&gt;codec_init
op_assign
id|snd_ac97_codec_ids
(braket
id|i
)braket
dot
id|init
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|codec-&gt;name
op_eq
l_int|NULL
)paren
id|codec-&gt;name
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ac97_codec: ac97 vendor id1: 0x%04x, id2: 0x%04x (%s)&bslash;n&quot;
comma
id|id1
comma
id|id2
comma
id|codec-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ac97_codec: capability: 0x%04x&bslash;n&quot;
comma
id|cap
)paren
suffix:semicolon
multiline_comment|/* mixer masks */
id|codec-&gt;supported_mixers
op_assign
id|AC97_SUPPORTED_MASK
suffix:semicolon
id|codec-&gt;stereo_mixers
op_assign
id|AC97_STEREO_MASK
suffix:semicolon
id|codec-&gt;record_sources
op_assign
id|AC97_RECORD_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cap
op_amp
l_int|0x04
)paren
)paren
id|codec-&gt;supported_mixers
op_and_assign
op_complement
(paren
id|SOUND_MASK_BASS
op_or
id|SOUND_MASK_TREBLE
)paren
suffix:semicolon
multiline_comment|/* generic OSS to AC97 wrapper */
id|codec-&gt;read_mixer
op_assign
id|ac97_read_mixer
suffix:semicolon
id|codec-&gt;write_mixer
op_assign
id|ac97_write_mixer
suffix:semicolon
id|codec-&gt;recmask_io
op_assign
id|ac97_recmask_io
suffix:semicolon
id|codec-&gt;mixer_ioctl
op_assign
id|ac97_mixer_ioctl
suffix:semicolon
multiline_comment|/* initialize volume level */
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_MASTER_VOL_STEREO
comma
l_int|0L
)paren
suffix:semicolon
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_PCMOUT_VOL
comma
l_int|0L
)paren
suffix:semicolon
multiline_comment|/* codec specific initialization for 4-6 channel output */
r_if
c_cond
(paren
id|codec-&gt;id
op_ne
l_int|0
op_logical_and
id|codec-&gt;codec_init
op_ne
l_int|NULL
)paren
(brace
id|codec
op_member_access_from_pointer
id|codec_init
c_func
(paren
id|codec
)paren
suffix:semicolon
)brace
multiline_comment|/* initilize mixer channel volumes */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|mixer_defaults
op_star
id|md
op_assign
op_amp
id|mixer_defaults
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;mixer
op_eq
op_minus
l_int|1
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|codec
comma
id|md-&gt;mixer
)paren
)paren
r_continue
suffix:semicolon
id|ac97_set_mixer
c_func
(paren
id|codec
comma
id|md-&gt;mixer
comma
id|md-&gt;value
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sigmatel_init
r_static
r_int
id|sigmatel_init
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
(brace
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_SURROUND_MASTER
comma
l_int|0L
)paren
suffix:semicolon
multiline_comment|/* initialize SigmaTel STAC9721/23 */
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
l_int|0x74
comma
l_int|0x01
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|ac97_probe_codec
id|EXPORT_SYMBOL
c_func
(paren
id|ac97_probe_codec
)paren
suffix:semicolon
eof
