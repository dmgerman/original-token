multiline_comment|/*&n; * ac97_codec.c: Generic AC97 mixer/modem module&n; *&n; * Derived from ac97 mixer in maestro and trident driver.&n; *&n; * Copyright 2000 Silicon Integrated System Corporation&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * History&n; * v0.4 Mar 15 2000 Ollie Lho&n; *&t;dual codecs support verified with 4 channels output&n; * v0.3 Feb 22 2000 Ollie Lho&n; *&t;bug fix for record mask setting&n; * v0.2 Feb 10 2000 Ollie Lho&n; *&t;add ac97_read_proc for /proc/driver/{vendor}/ac97&n; * v0.1 Jan 14 2000 Ollie Lho &lt;ollie@sis.com.tw&gt; &n; *&t;Isolated from trident.c to support multiple ac97 codec&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ac97_codec.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
r_static
r_int
id|ac97_read_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|oss_channel
)paren
suffix:semicolon
r_static
r_void
id|ac97_write_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|oss_channel
comma
r_int
r_int
id|left
comma
r_int
r_int
id|right
)paren
suffix:semicolon
r_static
r_void
id|ac97_set_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
r_int
id|oss_mixer
comma
r_int
r_int
id|val
)paren
suffix:semicolon
r_static
r_int
id|ac97_recmask_io
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|rw
comma
r_int
id|mask
)paren
suffix:semicolon
r_static
r_int
id|ac97_mixer_ioctl
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ac97_init_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
suffix:semicolon
r_static
r_int
id|sigmatel_init
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
suffix:semicolon
r_static
r_int
id|enable_eapd
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
suffix:semicolon
DECL|macro|arraysize
mdefine_line|#define arraysize(x)   (sizeof(x)/sizeof((x)[0]))
r_static
r_struct
(brace
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|init
r_int
(paren
op_star
id|init
)paren
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
suffix:semicolon
DECL|variable|ac97_codec_ids
)brace
id|ac97_codec_ids
(braket
)braket
op_assign
(brace
(brace
l_int|0x414B4D00
comma
l_string|&quot;Asahi Kasei AK4540 rev 0&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x414B4D01
comma
l_string|&quot;Asahi Kasei AK4540 rev 1&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x41445340
comma
l_string|&quot;Analog Devices AD1881&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x41445360
comma
l_string|&quot;Analog Devices AD1885&quot;
comma
id|enable_eapd
)brace
comma
(brace
l_int|0x43525900
comma
l_string|&quot;Cirrus Logic CS4297&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x43525903
comma
l_string|&quot;Cirrus Logic CS4297&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x43525913
comma
l_string|&quot;Cirrus Logic CS4297A&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x43525923
comma
l_string|&quot;Cirrus Logic CS4298&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x4352592B
comma
l_string|&quot;Cirrus Logic CS4294&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x43525931
comma
l_string|&quot;Cirrus Logic CS4299&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x43525934
comma
l_string|&quot;Cirrus Logic CS4299&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x4e534331
comma
l_string|&quot;National Semiconductor LM4549&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x53494c22
comma
l_string|&quot;Silicon Laboratory Si3036&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x53494c23
comma
l_string|&quot;Silicon Laboratory Si3038&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847600
comma
l_string|&quot;SigmaTel STAC????&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847604
comma
l_string|&quot;SigmaTel STAC9701/3/4/5&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847605
comma
l_string|&quot;SigmaTel STAC9704&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847608
comma
l_string|&quot;SigmaTel STAC9708&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x83847609
comma
l_string|&quot;SigmaTel STAC9721/23&quot;
comma
id|sigmatel_init
)brace
comma
(brace
l_int|0x54524103
comma
l_string|&quot;TriTech TR?????&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x54524106
comma
l_string|&quot;TriTech TR28026&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x54524108
comma
l_string|&quot;TriTech TR28028&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x54524123
comma
l_string|&quot;TriTech TR?????&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x574D4C00
comma
l_string|&quot;Wolfson WM9704&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|0x00000000
comma
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|ac97_stereo_enhancements
r_static
r_const
r_char
op_star
id|ac97_stereo_enhancements
(braket
)braket
op_assign
(brace
multiline_comment|/*   0 */
l_string|&quot;No 3D Stereo Enhancement&quot;
comma
multiline_comment|/*   1 */
l_string|&quot;Analog Devices Phat Stereo&quot;
comma
multiline_comment|/*   2 */
l_string|&quot;Creative Stereo Enhancement&quot;
comma
multiline_comment|/*   3 */
l_string|&quot;National Semi 3D Stereo Enhancement&quot;
comma
multiline_comment|/*   4 */
l_string|&quot;YAMAHA Ymersion&quot;
comma
multiline_comment|/*   5 */
l_string|&quot;BBE 3D Stereo Enhancement&quot;
comma
multiline_comment|/*   6 */
l_string|&quot;Crystal Semi 3D Stereo Enhancement&quot;
comma
multiline_comment|/*   7 */
l_string|&quot;Qsound QXpander&quot;
comma
multiline_comment|/*   8 */
l_string|&quot;Spatializer 3D Stereo Enhancement&quot;
comma
multiline_comment|/*   9 */
l_string|&quot;SRS 3D Stereo Enhancement&quot;
comma
multiline_comment|/*  10 */
l_string|&quot;Platform Tech 3D Stereo Enhancement&quot;
comma
multiline_comment|/*  11 */
l_string|&quot;AKM 3D Audio&quot;
comma
multiline_comment|/*  12 */
l_string|&quot;Aureal Stereo Enhancement&quot;
comma
multiline_comment|/*  13 */
l_string|&quot;Aztech 3D Enhancement&quot;
comma
multiline_comment|/*  14 */
l_string|&quot;Binaura 3D Audio Enhancement&quot;
comma
multiline_comment|/*  15 */
l_string|&quot;ESS Technology Stereo Enhancement&quot;
comma
multiline_comment|/*  16 */
l_string|&quot;Harman International VMAx&quot;
comma
multiline_comment|/*  17 */
l_string|&quot;Nvidea 3D Stereo Enhancement&quot;
comma
multiline_comment|/*  18 */
l_string|&quot;Philips Incredible Sound&quot;
comma
multiline_comment|/*  19 */
l_string|&quot;Texas Instruments 3D Stereo Enhancement&quot;
comma
multiline_comment|/*  20 */
l_string|&quot;VLSI Technology 3D Stereo Enhancement&quot;
comma
multiline_comment|/*  21 */
l_string|&quot;TriTech 3D Stereo Enhancement&quot;
comma
multiline_comment|/*  22 */
l_string|&quot;Realtek 3D Stereo Enhancement&quot;
comma
multiline_comment|/*  23 */
l_string|&quot;Samsung 3D Stereo Enhancement&quot;
comma
multiline_comment|/*  24 */
l_string|&quot;Wolfson Microelectronics 3D Enhancement&quot;
comma
multiline_comment|/*  25 */
l_string|&quot;Delta Integration 3D Enhancement&quot;
comma
multiline_comment|/*  26 */
l_string|&quot;SigmaTel 3D Enhancement&quot;
comma
multiline_comment|/*  27 */
l_string|&quot;Reserved 27&quot;
comma
multiline_comment|/*  28 */
l_string|&quot;Rockwell 3D Stereo Enhancement&quot;
comma
multiline_comment|/*  29 */
l_string|&quot;Reserved 29&quot;
comma
multiline_comment|/*  30 */
l_string|&quot;Reserved 30&quot;
comma
multiline_comment|/*  31 */
l_string|&quot;Reserved 31&quot;
)brace
suffix:semicolon
multiline_comment|/* this table has default mixer values for all OSS mixers. */
DECL|struct|mixer_defaults
r_static
r_struct
id|mixer_defaults
(brace
DECL|member|mixer
r_int
id|mixer
suffix:semicolon
DECL|member|value
r_int
r_int
id|value
suffix:semicolon
DECL|variable|mixer_defaults
)brace
id|mixer_defaults
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
multiline_comment|/* all values 0 -&gt; 100 in bytes */
(brace
id|SOUND_MIXER_VOLUME
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_BASS
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_TREBLE
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_PCM
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_SPEAKER
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_LINE
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_MIC
comma
l_int|0x0000
)brace
comma
(brace
id|SOUND_MIXER_CD
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_ALTPCM
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_IGAIN
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_LINE1
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_PHONEIN
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_PHONEOUT
comma
l_int|0x4343
)brace
comma
(brace
id|SOUND_MIXER_VIDEO
comma
l_int|0x4343
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* table to scale scale from OSS mixer value to AC97 mixer register value */
DECL|struct|ac97_mixer_hw
r_static
r_struct
id|ac97_mixer_hw
(brace
DECL|member|offset
r_int
r_char
id|offset
suffix:semicolon
DECL|member|scale
r_int
id|scale
suffix:semicolon
DECL|variable|ac97_hw
)brace
id|ac97_hw
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_VOLUME
)braket
op_assign
(brace
id|AC97_MASTER_VOL_STEREO
comma
l_int|64
)brace
comma
(braket
id|SOUND_MIXER_BASS
)braket
op_assign
(brace
id|AC97_MASTER_TONE
comma
l_int|16
)brace
comma
(braket
id|SOUND_MIXER_TREBLE
)braket
op_assign
(brace
id|AC97_MASTER_TONE
comma
l_int|16
)brace
comma
(braket
id|SOUND_MIXER_PCM
)braket
op_assign
(brace
id|AC97_PCMOUT_VOL
comma
l_int|32
)brace
comma
(braket
id|SOUND_MIXER_SPEAKER
)braket
op_assign
(brace
id|AC97_PCBEEP_VOL
comma
l_int|16
)brace
comma
(braket
id|SOUND_MIXER_LINE
)braket
op_assign
(brace
id|AC97_LINEIN_VOL
comma
l_int|32
)brace
comma
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
(brace
id|AC97_MIC_VOL
comma
l_int|32
)brace
comma
(braket
id|SOUND_MIXER_CD
)braket
op_assign
(brace
id|AC97_CD_VOL
comma
l_int|32
)brace
comma
(braket
id|SOUND_MIXER_ALTPCM
)braket
op_assign
(brace
id|AC97_HEADPHONE_VOL
comma
l_int|64
)brace
comma
(braket
id|SOUND_MIXER_IGAIN
)braket
op_assign
(brace
id|AC97_RECORD_GAIN
comma
l_int|16
)brace
comma
(braket
id|SOUND_MIXER_LINE1
)braket
op_assign
(brace
id|AC97_AUX_VOL
comma
l_int|32
)brace
comma
(braket
id|SOUND_MIXER_PHONEIN
)braket
op_assign
(brace
id|AC97_PHONE_VOL
comma
l_int|32
)brace
comma
(braket
id|SOUND_MIXER_PHONEOUT
)braket
op_assign
(brace
id|AC97_MASTER_VOL_MONO
comma
l_int|64
)brace
comma
(braket
id|SOUND_MIXER_VIDEO
)braket
op_assign
(brace
id|AC97_VIDEO_VOL
comma
l_int|32
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* the following tables allow us to go from OSS &lt;-&gt; ac97 quickly. */
DECL|enum|ac97_recsettings
r_enum
id|ac97_recsettings
(brace
DECL|enumerator|AC97_REC_MIC
id|AC97_REC_MIC
op_assign
l_int|0
comma
DECL|enumerator|AC97_REC_CD
id|AC97_REC_CD
comma
DECL|enumerator|AC97_REC_VIDEO
id|AC97_REC_VIDEO
comma
DECL|enumerator|AC97_REC_AUX
id|AC97_REC_AUX
comma
DECL|enumerator|AC97_REC_LINE
id|AC97_REC_LINE
comma
DECL|enumerator|AC97_REC_STEREO
id|AC97_REC_STEREO
comma
multiline_comment|/* combination of all enabled outputs..  */
DECL|enumerator|AC97_REC_MONO
id|AC97_REC_MONO
comma
multiline_comment|/*.. or the mono equivalent */
DECL|enumerator|AC97_REC_PHONE
id|AC97_REC_PHONE
)brace
suffix:semicolon
DECL|variable|ac97_rm2oss
r_static
r_int
r_int
id|ac97_rm2oss
(braket
)braket
op_assign
(brace
(braket
id|AC97_REC_MIC
)braket
op_assign
id|SOUND_MIXER_MIC
comma
(braket
id|AC97_REC_CD
)braket
op_assign
id|SOUND_MIXER_CD
comma
(braket
id|AC97_REC_VIDEO
)braket
op_assign
id|SOUND_MIXER_VIDEO
comma
(braket
id|AC97_REC_AUX
)braket
op_assign
id|SOUND_MIXER_LINE1
comma
(braket
id|AC97_REC_LINE
)braket
op_assign
id|SOUND_MIXER_LINE
comma
(braket
id|AC97_REC_STEREO
)braket
op_assign
id|SOUND_MIXER_IGAIN
comma
(braket
id|AC97_REC_PHONE
)braket
op_assign
id|SOUND_MIXER_PHONEIN
)brace
suffix:semicolon
multiline_comment|/* indexed by bit position */
DECL|variable|ac97_oss_rm
r_static
r_int
r_int
id|ac97_oss_rm
(braket
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
id|AC97_REC_MIC
comma
(braket
id|SOUND_MIXER_CD
)braket
op_assign
id|AC97_REC_CD
comma
(braket
id|SOUND_MIXER_VIDEO
)braket
op_assign
id|AC97_REC_VIDEO
comma
(braket
id|SOUND_MIXER_LINE1
)braket
op_assign
id|AC97_REC_AUX
comma
(braket
id|SOUND_MIXER_LINE
)braket
op_assign
id|AC97_REC_LINE
comma
(braket
id|SOUND_MIXER_IGAIN
)braket
op_assign
id|AC97_REC_STEREO
comma
(braket
id|SOUND_MIXER_PHONEIN
)braket
op_assign
id|AC97_REC_PHONE
)brace
suffix:semicolon
multiline_comment|/* reads the given OSS mixer from the ac97 the caller must have insured that the ac97 knows&n;   about that given mixer, and should be holding a spinlock for the card */
DECL|function|ac97_read_mixer
r_static
r_int
id|ac97_read_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|oss_channel
)paren
(brace
id|u16
id|val
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|scale
suffix:semicolon
r_struct
id|ac97_mixer_hw
op_star
id|mh
op_assign
op_amp
id|ac97_hw
(braket
id|oss_channel
)braket
suffix:semicolon
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|AC97_MUTE
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|AC97_STEREO_MASK
op_amp
(paren
l_int|1
op_lshift
id|oss_channel
)paren
)paren
(brace
multiline_comment|/* nice stereo mixers .. */
r_int
id|left
comma
id|right
suffix:semicolon
id|left
op_assign
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|right
op_assign
id|val
op_amp
l_int|0x7f
suffix:semicolon
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_IGAIN
)paren
(brace
id|right
op_assign
(paren
id|right
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
suffix:semicolon
id|left
op_assign
(paren
id|left
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* these may have 5 or 6 bit resolution */
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_VOLUME
op_logical_or
id|oss_channel
op_eq
id|SOUND_MIXER_ALTPCM
)paren
(brace
id|scale
op_assign
(paren
l_int|1
op_lshift
id|codec-&gt;bit_resolution
)paren
suffix:semicolon
)brace
r_else
id|scale
op_assign
id|mh-&gt;scale
suffix:semicolon
id|right
op_assign
l_int|100
op_minus
(paren
(paren
id|right
op_star
l_int|100
)paren
op_div
id|scale
)paren
suffix:semicolon
id|left
op_assign
l_int|100
op_minus
(paren
(paren
id|left
op_star
l_int|100
)paren
op_div
id|scale
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|left
op_or
(paren
id|right
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_SPEAKER
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
(paren
id|val
op_amp
l_int|0x1e
)paren
op_rshift
l_int|1
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_PHONEIN
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0x1f
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_PHONEOUT
)paren
(brace
id|scale
op_assign
(paren
l_int|1
op_lshift
id|codec-&gt;bit_resolution
)paren
suffix:semicolon
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0x1f
)paren
op_star
l_int|100
)paren
op_div
id|scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_MIC
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0x1f
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
multiline_comment|/*  the low bit is optional in the tone sliders and masking&n;&t;&t;    it lets us avoid the 0xf &squot;bypass&squot;.. */
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_BASS
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xe
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_TREBLE
)paren
(brace
id|ret
op_assign
l_int|100
op_minus
(paren
(paren
(paren
id|val
op_amp
l_int|0xe
)paren
op_star
l_int|100
)paren
op_div
id|mh-&gt;scale
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ac97_codec: read OSS mixer %2d (%s ac97 register 0x%02x), &quot;
l_string|&quot;0x%04x -&gt; 0x%04x&bslash;n&quot;
comma
id|oss_channel
comma
id|codec-&gt;id
ques
c_cond
l_string|&quot;Secondary&quot;
suffix:colon
l_string|&quot;Primary&quot;
comma
id|mh-&gt;offset
comma
id|val
comma
id|ret
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* write the OSS encoded volume to the given OSS encoded mixer, again caller&squot;s job to&n;   make sure all is well in arg land, call with spinlock held */
DECL|function|ac97_write_mixer
r_static
r_void
id|ac97_write_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|oss_channel
comma
r_int
r_int
id|left
comma
r_int
r_int
id|right
)paren
(brace
id|u16
id|val
op_assign
l_int|0
suffix:semicolon
r_int
id|scale
suffix:semicolon
r_struct
id|ac97_mixer_hw
op_star
id|mh
op_assign
op_amp
id|ac97_hw
(braket
id|oss_channel
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ac97_codec: wrote OSS mixer %2d (%s ac97 register 0x%02x), &quot;
l_string|&quot;left vol:%2d, right vol:%2d:&quot;
comma
id|oss_channel
comma
id|codec-&gt;id
ques
c_cond
l_string|&quot;Secondary&quot;
suffix:colon
l_string|&quot;Primary&quot;
comma
id|mh-&gt;offset
comma
id|left
comma
id|right
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|AC97_STEREO_MASK
op_amp
(paren
l_int|1
op_lshift
id|oss_channel
)paren
)paren
(brace
multiline_comment|/* stereo mixers */
r_if
c_cond
(paren
id|left
op_eq
l_int|0
op_logical_and
id|right
op_eq
l_int|0
)paren
(brace
id|val
op_assign
id|AC97_MUTE
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_IGAIN
)paren
(brace
id|right
op_assign
(paren
id|right
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
id|left
op_assign
(paren
id|left
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|right
op_ge
id|mh-&gt;scale
)paren
id|right
op_assign
id|mh-&gt;scale
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|left
op_ge
id|mh-&gt;scale
)paren
id|left
op_assign
id|mh-&gt;scale
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* these may have 5 or 6 bit resolution */
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_VOLUME
op_logical_or
id|oss_channel
op_eq
id|SOUND_MIXER_ALTPCM
)paren
id|scale
op_assign
(paren
l_int|1
op_lshift
id|codec-&gt;bit_resolution
)paren
suffix:semicolon
r_else
id|scale
op_assign
id|mh-&gt;scale
suffix:semicolon
id|right
op_assign
(paren
(paren
l_int|100
op_minus
id|right
)paren
op_star
id|scale
)paren
op_div
l_int|100
suffix:semicolon
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|scale
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|right
op_ge
id|scale
)paren
id|right
op_assign
id|scale
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|left
op_ge
id|scale
)paren
id|left
op_assign
id|scale
op_minus
l_int|1
suffix:semicolon
)brace
id|val
op_assign
(paren
id|left
op_lshift
l_int|8
)paren
op_or
id|right
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_BASS
)paren
(brace
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x0f00
suffix:semicolon
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|left
op_ge
id|mh-&gt;scale
)paren
id|left
op_assign
id|mh-&gt;scale
op_minus
l_int|1
suffix:semicolon
id|val
op_or_assign
(paren
id|left
op_lshift
l_int|8
)paren
op_amp
l_int|0x0e00
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_TREBLE
)paren
(brace
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x000f
suffix:semicolon
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|left
op_ge
id|mh-&gt;scale
)paren
id|left
op_assign
id|mh-&gt;scale
op_minus
l_int|1
suffix:semicolon
id|val
op_or_assign
id|left
op_amp
l_int|0x000e
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|left
op_eq
l_int|0
)paren
(brace
id|val
op_assign
id|AC97_MUTE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_SPEAKER
)paren
(brace
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|left
op_ge
id|mh-&gt;scale
)paren
id|left
op_assign
id|mh-&gt;scale
op_minus
l_int|1
suffix:semicolon
id|val
op_assign
id|left
op_lshift
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_PHONEIN
)paren
(brace
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|left
op_ge
id|mh-&gt;scale
)paren
id|left
op_assign
id|mh-&gt;scale
op_minus
l_int|1
suffix:semicolon
id|val
op_assign
id|left
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_PHONEOUT
)paren
(brace
id|scale
op_assign
(paren
l_int|1
op_lshift
id|codec-&gt;bit_resolution
)paren
suffix:semicolon
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|scale
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|left
op_ge
id|mh-&gt;scale
)paren
id|left
op_assign
id|mh-&gt;scale
op_minus
l_int|1
suffix:semicolon
id|val
op_assign
id|left
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|oss_channel
op_eq
id|SOUND_MIXER_MIC
)paren
(brace
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
op_amp
op_complement
l_int|0x801f
suffix:semicolon
id|left
op_assign
(paren
(paren
l_int|100
op_minus
id|left
)paren
op_star
id|mh-&gt;scale
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|left
op_ge
id|mh-&gt;scale
)paren
id|left
op_assign
id|mh-&gt;scale
op_minus
l_int|1
suffix:semicolon
id|val
op_or_assign
id|left
suffix:semicolon
multiline_comment|/*  the low bit is optional in the tone sliders and masking&n;&t;&t;    it lets us avoid the 0xf &squot;bypass&squot;.. */
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot; 0x%04x&quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|mh-&gt;offset
comma
id|val
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|mh-&gt;offset
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; -&gt; 0x%04x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* a thin wrapper for write_mixer */
DECL|function|ac97_set_mixer
r_static
r_void
id|ac97_set_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
r_int
id|oss_mixer
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|left
comma
id|right
suffix:semicolon
multiline_comment|/* cleanse input a little */
id|right
op_assign
(paren
(paren
id|val
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|left
op_assign
(paren
id|val
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|right
OG
l_int|100
)paren
id|right
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
id|codec-&gt;mixer_state
(braket
id|oss_mixer
)braket
op_assign
(paren
id|right
op_lshift
l_int|8
)paren
op_or
id|left
suffix:semicolon
id|codec
op_member_access_from_pointer
id|write_mixer
c_func
(paren
id|codec
comma
id|oss_mixer
comma
id|left
comma
id|right
)paren
suffix:semicolon
)brace
multiline_comment|/* read or write the recmask, the ac97 can really have left and right recording&n;   inputs independantly set, but OSS doesn&squot;t seem to want us to express that to&n;   the user. the caller guarantees that we have a supported bit set, and they&n;   must be holding the card&squot;s spinlock */
DECL|function|ac97_recmask_io
r_static
r_int
id|ac97_recmask_io
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
id|rw
comma
r_int
id|mask
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|rw
)paren
(brace
multiline_comment|/* read it from the card */
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_RECORD_SELECT
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ac97_codec: ac97 recmask to set to 0x%04x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
l_int|1
op_lshift
id|ac97_rm2oss
(braket
id|val
op_amp
l_int|0x07
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* else, write the first set in the mask as the&n;&t;   output */
multiline_comment|/* clear out current set value first (AC97 supports only 1 input!) */
id|val
op_assign
(paren
l_int|1
op_lshift
id|ac97_rm2oss
(braket
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_RECORD_SELECT
)paren
op_amp
l_int|0x07
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_ne
id|val
)paren
id|mask
op_and_assign
op_complement
id|val
suffix:semicolon
id|val
op_assign
id|ffs
c_func
(paren
id|mask
)paren
suffix:semicolon
id|val
op_assign
id|ac97_oss_rm
(braket
id|val
op_minus
l_int|1
)braket
suffix:semicolon
id|val
op_or_assign
id|val
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* set both channels */
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;ac97_codec: setting ac97 recmask to 0x%04x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_RECORD_SELECT
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|ac97_mixer_ioctl
r_static
r_int
id|ac97_mixer_ioctl
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|i
comma
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_INFO
)paren
(brace
id|mixer_info
id|info
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
id|codec-&gt;name
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
id|codec-&gt;name
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
id|info.modify_counter
op_assign
id|codec-&gt;modcnt
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_OLD_MIXER_INFO
)paren
(brace
id|_old_mixer_info
id|info
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
id|codec-&gt;name
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
id|codec-&gt;name
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
op_ne
l_char|&squot;M&squot;
op_logical_or
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
op_ne
r_sizeof
(paren
r_int
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|OSS_GETVERSION
)paren
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
id|_IOC_READ
)paren
(brace
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
multiline_comment|/* give them the current record source */
r_if
c_cond
(paren
op_logical_neg
id|codec-&gt;recmask_io
)paren
(brace
id|val
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|codec
op_member_access_from_pointer
id|recmask_io
c_func
(paren
id|codec
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
multiline_comment|/* give them the supported mixers */
id|val
op_assign
id|codec-&gt;supported_mixers
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
multiline_comment|/* Arg contains a bit for each supported recording source */
id|val
op_assign
id|codec-&gt;record_sources
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
multiline_comment|/* Mixer channels supporting stereo */
id|val
op_assign
id|codec-&gt;stereo_mixers
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
id|val
op_assign
id|SOUND_CAP_EXCL_INPUT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* read a specific mixer */
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|codec
comma
id|i
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* do we ever want to touch the hardware? */
multiline_comment|/* val = codec-&gt;read_mixer(codec, i); */
id|val
op_assign
id|codec-&gt;mixer_state
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
(paren
id|_IOC_WRITE
op_or
id|_IOC_READ
)paren
)paren
(brace
id|codec-&gt;modcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
multiline_comment|/* Arg contains a bit for each recording source */
r_if
c_cond
(paren
op_logical_neg
id|codec-&gt;recmask_io
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_and_assign
id|codec-&gt;record_sources
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|codec
op_member_access_from_pointer
id|recmask_io
c_func
(paren
id|codec
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* write a specific mixer */
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|codec
comma
id|i
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ac97_set_mixer
c_func
(paren
id|codec
comma
id|i
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* entry point for /proc/driver/controller_vendor/ac97/%d */
DECL|function|ac97_read_proc
r_int
id|ac97_read_proc
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
comma
id|cap
comma
id|extid
comma
id|val
comma
id|id1
comma
id|id2
suffix:semicolon
r_struct
id|ac97_codec
op_star
id|codec
suffix:semicolon
r_int
id|is_ac97_20
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|codec
op_assign
id|data
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|id1
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_VENDOR_ID1
)paren
suffix:semicolon
id|id2
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_VENDOR_ID2
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Vendor name      : %s&bslash;n&quot;
comma
id|codec-&gt;name
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Vendor id        : %04X %04X&bslash;n&quot;
comma
id|id1
comma
id|id2
)paren
suffix:semicolon
id|extid
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_EXTENDED_ID
)paren
suffix:semicolon
id|extid
op_and_assign
op_complement
(paren
(paren
l_int|1
op_lshift
l_int|2
)paren
op_or
(paren
l_int|1
op_lshift
l_int|4
)paren
op_or
(paren
l_int|1
op_lshift
l_int|5
)paren
op_or
(paren
l_int|1
op_lshift
l_int|10
)paren
op_or
(paren
l_int|1
op_lshift
l_int|11
)paren
op_or
(paren
l_int|1
op_lshift
l_int|12
)paren
op_or
(paren
l_int|1
op_lshift
l_int|13
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;AC97 Version     : %s&bslash;n&quot;
comma
id|extid
ques
c_cond
l_string|&quot;2.0 or later&quot;
suffix:colon
l_string|&quot;1.0&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|extid
)paren
id|is_ac97_20
op_assign
l_int|1
suffix:semicolon
id|cap
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_RESET
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Capabilities     :%s%s%s%s%s%s&bslash;n&quot;
comma
id|cap
op_amp
l_int|0x0001
ques
c_cond
l_string|&quot; -dedicated MIC PCM IN channel-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0002
ques
c_cond
l_string|&quot; -reserved1-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0004
ques
c_cond
l_string|&quot; -bass &amp; treble-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0008
ques
c_cond
l_string|&quot; -simulated stereo-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0010
ques
c_cond
l_string|&quot; -headphone out-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0020
ques
c_cond
l_string|&quot; -loudness-&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|val
op_assign
id|cap
op_amp
l_int|0x00c0
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;DAC resolutions  :%s%s%s&bslash;n&quot;
comma
l_string|&quot; -16-bit-&quot;
comma
id|val
op_amp
l_int|0x0040
ques
c_cond
l_string|&quot; -18-bit-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|val
op_amp
l_int|0x0080
ques
c_cond
l_string|&quot; -20-bit-&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|val
op_assign
id|cap
op_amp
l_int|0x0300
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;ADC resolutions  :%s%s%s&bslash;n&quot;
comma
l_string|&quot; -16-bit-&quot;
comma
id|val
op_amp
l_int|0x0100
ques
c_cond
l_string|&quot; -18-bit-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|val
op_amp
l_int|0x0200
ques
c_cond
l_string|&quot; -20-bit-&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;3D enhancement   : %s&bslash;n&quot;
comma
id|ac97_stereo_enhancements
(braket
(paren
id|cap
op_rshift
l_int|10
)paren
op_amp
l_int|0x1f
)braket
)paren
suffix:semicolon
id|val
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_GENERAL_PURPOSE
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;POP path         : %s 3D&bslash;n&quot;
l_string|&quot;Sim. stereo      : %s&bslash;n&quot;
l_string|&quot;3D enhancement   : %s&bslash;n&quot;
l_string|&quot;Loudness         : %s&bslash;n&quot;
l_string|&quot;Mono output      : %s&bslash;n&quot;
l_string|&quot;MIC select       : %s&bslash;n&quot;
l_string|&quot;ADC/DAC loopback : %s&bslash;n&quot;
comma
id|val
op_amp
l_int|0x8000
ques
c_cond
l_string|&quot;post&quot;
suffix:colon
l_string|&quot;pre&quot;
comma
id|val
op_amp
l_int|0x4000
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
id|val
op_amp
l_int|0x2000
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
id|val
op_amp
l_int|0x1000
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
id|val
op_amp
l_int|0x0200
ques
c_cond
l_string|&quot;MIC&quot;
suffix:colon
l_string|&quot;MIX&quot;
comma
id|val
op_amp
l_int|0x0100
ques
c_cond
l_string|&quot;MIC2&quot;
suffix:colon
l_string|&quot;MIC1&quot;
comma
id|val
op_amp
l_int|0x0080
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|extid
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_EXTENDED_ID
)paren
suffix:semicolon
id|cap
op_assign
id|extid
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Ext Capabilities :%s%s%s%s%s%s%s&bslash;n&quot;
comma
id|cap
op_amp
l_int|0x0001
ques
c_cond
l_string|&quot; -var rate PCM audio-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0002
ques
c_cond
l_string|&quot; -2x PCM audio out-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0008
ques
c_cond
l_string|&quot; -var rate MIC in-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0040
ques
c_cond
l_string|&quot; -PCM center DAC-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0080
ques
c_cond
l_string|&quot; -PCM surround DAC-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0100
ques
c_cond
l_string|&quot; -PCM LFE DAC-&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|cap
op_amp
l_int|0x0200
ques
c_cond
l_string|&quot; -slot/DAC mappings-&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_ac97_20
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Front DAC rate   : %d&bslash;n&quot;
comma
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_PCM_FRONT_DAC_RATE
)paren
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;ac97_probe_codec - Initialize and setup AC97-compatible codec&n; *&t;@codec: (in/out) Kernel info for a single AC97 codec&n; *&n; *&t;Reset the AC97 codec, then initialize the mixer and&n; *&t;the rest of the @codec structure.&n; *&n; *&t;The codec_read and codec_write fields of @codec are&n; *&t;required to be setup and working when this function&n; *&t;is called.  All other fields are set by this function.&n; *&n; *&t;codec_wait field of @codec can optionally be provided&n; *&t;when calling this function.  If codec_wait is not %NULL,&n; *&t;this function will call codec_wait any time it is&n; *&t;necessary to wait for the audio chip to reach the&n; *&t;codec-ready state.  If codec_wait is %NULL, then&n; *&t;the default behavior is to call schedule_timeout.&n; *&t;Currently codec_wait is used to wait for AC97 codec&n; *&t;reset to complete. &n; *&n; *&t;Returns 1 (true) on success, or 0 (false) on failure.&n; */
DECL|function|ac97_probe_codec
r_int
id|ac97_probe_codec
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
(brace
id|u16
id|id1
comma
id|id2
suffix:semicolon
id|u16
id|audio
comma
id|modem
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* probing AC97 codec, AC97 2.0 says that bit 15 of register 0x00 (reset) should &n;&t; * be read zero.&n;&t; *&n;&t; * FIXME: is the following comment outdated?  -jgarzik &n;&t; * Probing of AC97 in this way is not reliable, it is not even SAFE !!&n;&t; */
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_RESET
comma
l_int|0L
)paren
suffix:semicolon
multiline_comment|/* also according to spec, we wait for codec-ready state */
r_if
c_cond
(paren
id|codec-&gt;codec_wait
)paren
id|codec
op_member_access_from_pointer
id|codec_wait
c_func
(paren
id|codec
)paren
suffix:semicolon
r_else
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|audio
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_RESET
)paren
)paren
op_amp
l_int|0x8000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ac97_codec: %s ac97 codec not present&bslash;n&quot;
comma
id|codec-&gt;id
ques
c_cond
l_string|&quot;Secondary&quot;
suffix:colon
l_string|&quot;Primary&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* probe for Modem Codec */
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_EXTENDED_MODEM_ID
comma
l_int|0L
)paren
suffix:semicolon
id|modem
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_EXTENDED_MODEM_ID
)paren
suffix:semicolon
id|codec-&gt;name
op_assign
l_int|NULL
suffix:semicolon
id|codec-&gt;codec_init
op_assign
l_int|NULL
suffix:semicolon
id|id1
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_VENDOR_ID1
)paren
suffix:semicolon
id|id2
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_VENDOR_ID2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|arraysize
c_func
(paren
id|ac97_codec_ids
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ac97_codec_ids
(braket
id|i
)braket
dot
id|id
op_eq
(paren
(paren
id|id1
op_lshift
l_int|16
)paren
op_or
id|id2
)paren
)paren
(brace
id|codec-&gt;type
op_assign
id|ac97_codec_ids
(braket
id|i
)braket
dot
id|id
suffix:semicolon
id|codec-&gt;name
op_assign
id|ac97_codec_ids
(braket
id|i
)braket
dot
id|name
suffix:semicolon
id|codec-&gt;codec_init
op_assign
id|ac97_codec_ids
(braket
id|i
)braket
dot
id|init
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|codec-&gt;name
op_eq
l_int|NULL
)paren
id|codec-&gt;name
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ac97_codec: AC97 %s codec, id: 0x%04x:&quot;
l_string|&quot;0x%04x (%s)&bslash;n&quot;
comma
id|audio
ques
c_cond
l_string|&quot;Audio&quot;
suffix:colon
(paren
id|modem
ques
c_cond
l_string|&quot;Modem&quot;
suffix:colon
l_string|&quot;&quot;
)paren
comma
id|id1
comma
id|id2
comma
id|codec-&gt;name
)paren
suffix:semicolon
r_return
id|ac97_init_mixer
c_func
(paren
id|codec
)paren
suffix:semicolon
)brace
DECL|function|ac97_init_mixer
r_static
r_int
id|ac97_init_mixer
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
(brace
id|u16
id|cap
suffix:semicolon
r_int
id|i
suffix:semicolon
id|cap
op_assign
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_RESET
)paren
suffix:semicolon
multiline_comment|/* mixer masks */
id|codec-&gt;supported_mixers
op_assign
id|AC97_SUPPORTED_MASK
suffix:semicolon
id|codec-&gt;stereo_mixers
op_assign
id|AC97_STEREO_MASK
suffix:semicolon
id|codec-&gt;record_sources
op_assign
id|AC97_RECORD_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cap
op_amp
l_int|0x04
)paren
)paren
id|codec-&gt;supported_mixers
op_and_assign
op_complement
(paren
id|SOUND_MASK_BASS
op_or
id|SOUND_MASK_TREBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cap
op_amp
l_int|0x10
)paren
)paren
id|codec-&gt;supported_mixers
op_and_assign
op_complement
id|SOUND_MASK_ALTPCM
suffix:semicolon
multiline_comment|/* detect bit resolution */
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_MASTER_VOL_STEREO
comma
l_int|0x2020
)paren
suffix:semicolon
r_if
c_cond
(paren
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_MASTER_VOL_STEREO
)paren
op_eq
l_int|0x1f1f
)paren
(brace
id|codec-&gt;bit_resolution
op_assign
l_int|5
suffix:semicolon
)brace
r_else
id|codec-&gt;bit_resolution
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* generic OSS to AC97 wrapper */
id|codec-&gt;read_mixer
op_assign
id|ac97_read_mixer
suffix:semicolon
id|codec-&gt;write_mixer
op_assign
id|ac97_write_mixer
suffix:semicolon
id|codec-&gt;recmask_io
op_assign
id|ac97_recmask_io
suffix:semicolon
id|codec-&gt;mixer_ioctl
op_assign
id|ac97_mixer_ioctl
suffix:semicolon
multiline_comment|/* codec specific initialization for 4-6 channel output or secondary codec stuff */
r_if
c_cond
(paren
id|codec-&gt;codec_init
op_ne
l_int|NULL
)paren
(brace
id|codec
op_member_access_from_pointer
id|codec_init
c_func
(paren
id|codec
)paren
suffix:semicolon
)brace
multiline_comment|/* initilize mixer channel volumes */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|mixer_defaults
op_star
id|md
op_assign
op_amp
id|mixer_defaults
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;mixer
op_eq
op_minus
l_int|1
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|codec
comma
id|md-&gt;mixer
)paren
)paren
r_continue
suffix:semicolon
id|ac97_set_mixer
c_func
(paren
id|codec
comma
id|md-&gt;mixer
comma
id|md-&gt;value
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sigmatel_init
r_static
r_int
id|sigmatel_init
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
(brace
multiline_comment|/* Only set up secondary codec */
r_if
c_cond
(paren
id|codec-&gt;id
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_SURROUND_MASTER
comma
l_int|0L
)paren
suffix:semicolon
multiline_comment|/* initialize SigmaTel STAC9721/23 as secondary codec, decoding AC link&n;&t;   sloc 3,4 = 0x01, slot 7,8 = 0x00, */
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
l_int|0x74
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* we don&squot;t have the crystal when we are on an AMR card, so use&n;&t;   BIT_CLK as our clock source. Write the magic word ABBA and read&n;&t;   back to enable register 0x78 */
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
l_int|0x76
comma
l_int|0xabba
)paren
suffix:semicolon
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
l_int|0x76
)paren
suffix:semicolon
multiline_comment|/* sync all the clocks*/
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
l_int|0x78
comma
l_int|0x3802
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Bring up an AD1885&n; */
DECL|function|enable_eapd
r_static
r_int
id|enable_eapd
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
)paren
(brace
id|codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|codec
comma
id|AC97_POWER_CONTROL
comma
id|codec
op_member_access_from_pointer
id|codec_read
c_func
(paren
id|codec
comma
id|AC97_POWER_CONTROL
)paren
op_or
l_int|0x8000
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ac97_read_proc
id|EXPORT_SYMBOL
c_func
(paren
id|ac97_read_proc
)paren
suffix:semicolon
DECL|variable|ac97_probe_codec
id|EXPORT_SYMBOL
c_func
(paren
id|ac97_probe_codec
)paren
suffix:semicolon
eof
