multiline_comment|/*&n; * sound/opl3sa2.c&n; *&n; * A low level driver for Yamaha OPL3-SA2 and SA3 cards.&n; * SAx cards should work, as they are just variants of the SA3.&n; *&n; * Copyright 1998, 1999 Scott Murray &lt;scottm@interlog.com&gt;&n; *&n; * Originally based on the CS4232 driver (in cs4232.c) by Hannu Savolainen&n; * and others.  Now incorporates code/ideas from pss.c, also by Hannu&n; * Savolainen.  Both of those files are distributed with the following&n; * license:&n; *&n; * &quot;Copyright (C) by Hannu Savolainen 1993-1997&n; *&n; *  OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; *  Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software&n; *  for more info.&quot;&n; *&n; * As such, in accordance with the above license, this file, opl3sa2.c, is&n; * distributed under the GNU GENERAL PUBLIC LICENSE (GPL) Version 2 (June 1991).&n; * See the &quot;COPYING&quot; file distributed with this software for more information.&n; *&n; * Change History&n; * --------------&n; * Scott Murray            Original driver (Jun 14, 1998)&n; * Paul J.Y. Lahaie        Changed probing / attach code order&n; * Scott Murray            Added mixer support (Dec 03, 1998)&n; * Scott Murray            Changed detection code to be more forgiving,&n; *                         added force option as last resort,&n; *                         fixed ioctl return values. (Dec 30, 1998)&n; * Scott Murray            Simpler detection code should work all the time now&n; *                         (with thanks to Ben Hutchings for the heuristic),&n; *                         removed now unnecessary force option. (Jan 5, 1999)&n; * Christoph Hellwig&t;   Adapted to module_init/module_exit (Mar 4, 2000)&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;ad1848.h&quot;
macro_line|#include &quot;mpu401.h&quot;
multiline_comment|/* Useful control port indexes: */
DECL|macro|OPL3SA2_MASTER_LEFT
mdefine_line|#define OPL3SA2_MASTER_LEFT  0x07
DECL|macro|OPL3SA2_MASTER_RIGHT
mdefine_line|#define OPL3SA2_MASTER_RIGHT 0x08
DECL|macro|OPL3SA2_MIC
mdefine_line|#define OPL3SA2_MIC          0x09
DECL|macro|OPL3SA2_MISC
mdefine_line|#define OPL3SA2_MISC         0x0A
DECL|macro|OPL3SA3_WIDE
mdefine_line|#define OPL3SA3_WIDE         0x14
DECL|macro|OPL3SA3_BASS
mdefine_line|#define OPL3SA3_BASS         0x15
DECL|macro|OPL3SA3_TREBLE
mdefine_line|#define OPL3SA3_TREBLE       0x16
multiline_comment|/* Useful constants: */
DECL|macro|DEFAULT_VOLUME
mdefine_line|#define DEFAULT_VOLUME 50
DECL|macro|DEFAULT_MIC
mdefine_line|#define DEFAULT_MIC    50
DECL|macro|DEFAULT_TIMBRE
mdefine_line|#define DEFAULT_TIMBRE 0
DECL|macro|CHIPSET_UNKNOWN
mdefine_line|#define CHIPSET_UNKNOWN -1
multiline_comment|/*&n; * These are used both as masks against what the card returns,&n; * and as constants.&n; */
DECL|macro|CHIPSET_OPL3SA2
mdefine_line|#define CHIPSET_OPL3SA2  1
DECL|macro|CHIPSET_OPL3SA3
mdefine_line|#define CHIPSET_OPL3SA3  2
DECL|macro|CHIPSET_OPL3SAX
mdefine_line|#define CHIPSET_OPL3SAX  4
multiline_comment|/* What&squot;s my version? */
DECL|variable|chipset
r_static
r_int
id|chipset
op_assign
id|CHIPSET_UNKNOWN
suffix:semicolon
multiline_comment|/* Oh well, let&squot;s just cache the name */
DECL|variable|chipset_name
r_static
r_char
id|chipset_name
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* Where&squot;s my mixer */
DECL|variable|opl3sa2_mixer
r_static
r_int
id|opl3sa2_mixer
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Bag o&squot; mixer data */
DECL|struct|opl3sa2_mixerdata
r_typedef
r_struct
id|opl3sa2_mixerdata
(brace
DECL|member|cfg_port
r_int
r_int
id|cfg_port
suffix:semicolon
DECL|member|padding
r_int
r_int
id|padding
suffix:semicolon
DECL|member|ad_mixer_dev
r_int
id|ad_mixer_dev
suffix:semicolon
DECL|member|volume_l
r_int
r_int
id|volume_l
suffix:semicolon
DECL|member|volume_r
r_int
r_int
id|volume_r
suffix:semicolon
DECL|member|mic
r_int
r_int
id|mic
suffix:semicolon
DECL|member|bass
r_int
r_int
id|bass
suffix:semicolon
DECL|member|treble
r_int
r_int
id|treble
suffix:semicolon
DECL|typedef|opl3sa2_mixerdata
)brace
id|opl3sa2_mixerdata
suffix:semicolon
macro_line|#ifdef CONFIG_OPL3SA2_CTRL_BASE
multiline_comment|/* Set control port if compiled into the kernel */
DECL|variable|opl3sa2_data
r_static
id|opl3sa2_mixerdata
id|opl3sa2_data
op_assign
(brace
id|CONFIG_OPL3SA2_CTRL_BASE
comma
)brace
suffix:semicolon
macro_line|#else
DECL|variable|opl3sa2_data
r_static
id|opl3sa2_mixerdata
id|opl3sa2_data
suffix:semicolon
macro_line|#endif
DECL|variable|devc
r_static
id|opl3sa2_mixerdata
op_star
id|devc
op_assign
op_amp
id|opl3sa2_data
suffix:semicolon
multiline_comment|/* Standard read and write functions */
DECL|function|opl3sa2_write
r_static
r_void
id|opl3sa2_write
c_func
(paren
r_int
r_int
id|port
comma
r_int
r_char
id|index
comma
r_int
r_char
id|data
)paren
(brace
id|outb_p
c_func
(paren
id|index
comma
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|data
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|opl3sa2_read
r_static
r_void
id|opl3sa2_read
c_func
(paren
r_int
r_int
id|port
comma
r_int
r_char
id|index
comma
r_int
r_char
op_star
id|data
)paren
(brace
id|outb_p
c_func
(paren
id|index
comma
id|port
)paren
suffix:semicolon
op_star
id|data
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* All of the mixer functions... */
DECL|function|opl3sa2_set_volume
r_static
r_void
id|opl3sa2_set_volume
c_func
(paren
id|opl3sa2_mixerdata
op_star
id|devc
comma
r_int
id|left
comma
r_int
id|right
)paren
(brace
r_static
r_int
r_char
id|scale
(braket
l_int|101
)braket
op_assign
(brace
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x00
)brace
suffix:semicolon
r_int
r_char
id|vol
suffix:semicolon
id|vol
op_assign
id|scale
(braket
id|left
)braket
suffix:semicolon
multiline_comment|/* If level is zero, turn on mute */
r_if
c_cond
(paren
op_logical_neg
id|left
)paren
(brace
id|vol
op_or_assign
l_int|0x80
suffix:semicolon
)brace
id|opl3sa2_write
c_func
(paren
id|devc-&gt;cfg_port
comma
id|OPL3SA2_MASTER_LEFT
comma
id|vol
)paren
suffix:semicolon
id|vol
op_assign
id|scale
(braket
id|right
)braket
suffix:semicolon
multiline_comment|/* If level is zero, turn on mute */
r_if
c_cond
(paren
op_logical_neg
id|right
)paren
(brace
id|vol
op_or_assign
l_int|0x80
suffix:semicolon
)brace
id|opl3sa2_write
c_func
(paren
id|devc-&gt;cfg_port
comma
id|OPL3SA2_MASTER_RIGHT
comma
id|vol
)paren
suffix:semicolon
)brace
DECL|function|opl3sa2_set_mic
r_static
r_void
id|opl3sa2_set_mic
c_func
(paren
id|opl3sa2_mixerdata
op_star
id|devc
comma
r_int
id|level
)paren
(brace
r_int
r_char
id|vol
op_assign
l_int|0x1F
suffix:semicolon
r_if
c_cond
(paren
(paren
id|level
op_ge
l_int|0
)paren
op_logical_and
(paren
id|level
op_le
l_int|100
)paren
)paren
(brace
id|vol
op_assign
l_int|0x1F
op_minus
(paren
r_int
r_char
)paren
(paren
l_int|0x1F
op_star
id|level
op_div
l_int|100L
)paren
suffix:semicolon
)brace
multiline_comment|/* If level is zero, turn on mute */
r_if
c_cond
(paren
op_logical_neg
id|level
)paren
(brace
id|vol
op_or_assign
l_int|0x80
suffix:semicolon
)brace
id|opl3sa2_write
c_func
(paren
id|devc-&gt;cfg_port
comma
id|OPL3SA2_MIC
comma
id|vol
)paren
suffix:semicolon
)brace
DECL|function|opl3sa3_set_bass
r_static
r_void
id|opl3sa3_set_bass
c_func
(paren
id|opl3sa2_mixerdata
op_star
id|devc
comma
r_int
id|level
)paren
(brace
r_int
r_char
id|bass
suffix:semicolon
id|bass
op_assign
id|level
ques
c_cond
(paren
(paren
r_int
r_char
)paren
(paren
l_int|0x07
op_star
id|level
op_div
l_int|100L
)paren
)paren
suffix:colon
l_int|0
suffix:semicolon
id|bass
op_or_assign
(paren
id|bass
op_lshift
l_int|4
)paren
suffix:semicolon
id|opl3sa2_write
c_func
(paren
id|devc-&gt;cfg_port
comma
id|OPL3SA3_BASS
comma
id|bass
)paren
suffix:semicolon
)brace
DECL|function|opl3sa3_set_treble
r_static
r_void
id|opl3sa3_set_treble
c_func
(paren
id|opl3sa2_mixerdata
op_star
id|devc
comma
r_int
id|level
)paren
(brace
r_int
r_char
id|treble
suffix:semicolon
id|treble
op_assign
id|level
ques
c_cond
(paren
(paren
r_int
r_char
)paren
(paren
l_int|0x07
op_star
id|level
op_div
l_int|100L
)paren
)paren
suffix:colon
l_int|0
suffix:semicolon
id|treble
op_or_assign
(paren
id|treble
op_lshift
l_int|4
)paren
suffix:semicolon
id|opl3sa2_write
c_func
(paren
id|devc-&gt;cfg_port
comma
id|OPL3SA3_TREBLE
comma
id|treble
)paren
suffix:semicolon
)brace
DECL|function|opl3sa2_mixer_reset
r_static
r_void
id|opl3sa2_mixer_reset
c_func
(paren
id|opl3sa2_mixerdata
op_star
id|devc
)paren
(brace
r_if
c_cond
(paren
id|devc
)paren
(brace
id|opl3sa2_set_volume
c_func
(paren
id|devc
comma
id|DEFAULT_VOLUME
comma
id|DEFAULT_VOLUME
)paren
suffix:semicolon
id|devc-&gt;volume_l
op_assign
id|devc-&gt;volume_r
op_assign
id|DEFAULT_VOLUME
suffix:semicolon
id|opl3sa2_set_mic
c_func
(paren
id|devc
comma
id|DEFAULT_MIC
)paren
suffix:semicolon
id|devc-&gt;mic
op_assign
id|DEFAULT_MIC
suffix:semicolon
id|opl3sa3_set_bass
c_func
(paren
id|devc
comma
id|DEFAULT_TIMBRE
)paren
suffix:semicolon
id|opl3sa3_set_treble
c_func
(paren
id|devc
comma
id|DEFAULT_TIMBRE
)paren
suffix:semicolon
id|devc-&gt;bass
op_assign
id|devc-&gt;treble
op_assign
id|DEFAULT_TIMBRE
suffix:semicolon
)brace
)brace
DECL|function|arg_to_volume_mono
r_static
r_void
id|arg_to_volume_mono
c_func
(paren
r_int
r_int
id|volume
comma
r_int
op_star
id|aleft
)paren
(brace
r_int
id|left
suffix:semicolon
id|left
op_assign
id|volume
op_amp
l_int|0x00ff
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|100
)paren
id|left
op_assign
l_int|100
suffix:semicolon
op_star
id|aleft
op_assign
id|left
suffix:semicolon
)brace
DECL|function|arg_to_volume_stereo
r_static
r_void
id|arg_to_volume_stereo
c_func
(paren
r_int
r_int
id|volume
comma
r_int
op_star
id|aleft
comma
r_int
op_star
id|aright
)paren
(brace
id|arg_to_volume_mono
c_func
(paren
id|volume
comma
id|aleft
)paren
suffix:semicolon
id|arg_to_volume_mono
c_func
(paren
id|volume
op_rshift
l_int|8
comma
id|aright
)paren
suffix:semicolon
)brace
DECL|function|ret_vol_mono
r_static
r_int
id|ret_vol_mono
c_func
(paren
r_int
id|left
)paren
(brace
r_return
(paren
(paren
id|left
op_lshift
l_int|8
)paren
op_or
id|left
)paren
suffix:semicolon
)brace
DECL|function|ret_vol_stereo
r_static
r_int
id|ret_vol_stereo
c_func
(paren
r_int
id|left
comma
r_int
id|right
)paren
(brace
r_return
(paren
(paren
id|right
op_lshift
l_int|8
)paren
op_or
id|left
)paren
suffix:semicolon
)brace
DECL|function|call_ad_mixer
r_static
r_int
id|call_ad_mixer
c_func
(paren
id|opl3sa2_mixerdata
op_star
id|devc
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
op_minus
l_int|1
)paren
(brace
r_return
id|mixer_devs
(braket
id|devc-&gt;ad_mixer_dev
)braket
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|devc-&gt;ad_mixer_dev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|opl3sa2_mixer_ioctl
r_static
r_int
id|opl3sa2_mixer_ioctl
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
r_int
id|cmdf
op_assign
id|cmd
op_amp
l_int|0xff
suffix:semicolon
id|opl3sa2_mixerdata
op_star
id|devc
op_assign
(paren
id|opl3sa2_mixerdata
op_star
)paren
id|mixer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_switch
c_cond
(paren
id|cmdf
)paren
(brace
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
r_case
id|SOUND_MIXER_MIC
suffix:colon
r_case
id|SOUND_MIXER_BASS
suffix:colon
r_case
id|SOUND_MIXER_TREBLE
suffix:colon
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|cmd
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_ne
l_char|&squot;M&squot;
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_SIOC_DIR
(paren
id|cmd
)paren
op_amp
id|_SIOC_WRITE
)paren
(brace
r_switch
c_cond
(paren
id|cmdf
)paren
(brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
op_minus
l_int|1
)paren
(brace
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
id|arg_to_volume_stereo
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|devc-&gt;volume_l
comma
op_amp
id|devc-&gt;volume_r
)paren
suffix:semicolon
id|opl3sa2_set_volume
c_func
(paren
id|devc
comma
id|devc-&gt;volume_l
comma
id|devc-&gt;volume_r
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_stereo
c_func
(paren
id|devc-&gt;volume_l
comma
id|devc-&gt;volume_r
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_MIXER_MIC
suffix:colon
id|arg_to_volume_mono
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|devc-&gt;mic
)paren
suffix:semicolon
id|opl3sa2_set_mic
c_func
(paren
id|devc
comma
id|devc-&gt;mic
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_mono
c_func
(paren
id|devc-&gt;mic
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_MIXER_BASS
suffix:colon
r_if
c_cond
(paren
id|chipset
op_ne
id|CHIPSET_OPL3SA2
)paren
(brace
id|arg_to_volume_mono
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|devc-&gt;bass
)paren
suffix:semicolon
id|opl3sa3_set_bass
c_func
(paren
id|devc
comma
id|devc-&gt;bass
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_mono
c_func
(paren
id|devc-&gt;bass
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|SOUND_MIXER_TREBLE
suffix:colon
r_if
c_cond
(paren
id|chipset
op_ne
id|CHIPSET_OPL3SA2
)paren
(brace
id|arg_to_volume_mono
c_func
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|devc-&gt;treble
)paren
suffix:semicolon
id|opl3sa3_set_treble
c_func
(paren
id|devc
comma
id|devc-&gt;treble
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_mono
c_func
(paren
id|devc-&gt;treble
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Return parameters&n;&t;&t; */
r_switch
c_cond
(paren
id|cmdf
)paren
(brace
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
r_if
c_cond
(paren
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
op_eq
op_minus
id|EINVAL
)paren
(brace
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* no mixer devices */
op_star
(paren
r_int
op_star
)paren
id|arg
op_or_assign
(paren
id|SOUND_MASK_VOLUME
op_or
id|SOUND_MASK_MIC
)paren
suffix:semicolon
multiline_comment|/* OPL3-SA2 has no bass and treble mixers */
r_if
c_cond
(paren
id|chipset
op_ne
id|CHIPSET_OPL3SA2
)paren
(brace
op_star
(paren
r_int
op_star
)paren
id|arg
op_or_assign
(paren
id|SOUND_MASK_BASS
op_or
id|SOUND_MASK_TREBLE
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
r_if
c_cond
(paren
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
op_eq
op_minus
id|EINVAL
)paren
(brace
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* no stereo devices */
op_star
(paren
r_int
op_star
)paren
id|arg
op_or_assign
id|SOUND_MASK_VOLUME
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
op_minus
l_int|1
)paren
(brace
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No recording devices */
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
l_int|0
)paren
suffix:semicolon
)brace
r_case
id|SOUND_MIXER_CAPS
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
op_minus
l_int|1
)paren
(brace
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|SOUND_CAP_EXCL_INPUT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_if
c_cond
(paren
id|devc-&gt;ad_mixer_dev
op_ne
op_minus
l_int|1
)paren
(brace
r_return
id|call_ad_mixer
c_func
(paren
id|devc
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No recording source */
r_return
(paren
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
l_int|0
)paren
suffix:semicolon
)brace
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_stereo
c_func
(paren
id|devc-&gt;volume_l
comma
id|devc-&gt;volume_r
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_MIXER_MIC
suffix:colon
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_mono
c_func
(paren
id|devc-&gt;mic
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_MIXER_BASS
suffix:colon
r_if
c_cond
(paren
id|chipset
op_ne
id|CHIPSET_OPL3SA2
)paren
(brace
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_mono
c_func
(paren
id|devc-&gt;bass
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
id|SOUND_MIXER_TREBLE
suffix:colon
r_if
c_cond
(paren
id|chipset
op_ne
id|CHIPSET_OPL3SA2
)paren
(brace
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ret_vol_mono
c_func
(paren
id|devc-&gt;treble
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
DECL|variable|opl3sa2_mixer_operations
r_static
r_struct
id|mixer_operations
id|opl3sa2_mixer_operations
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|id
suffix:colon
l_string|&quot;Yamaha&quot;
comma
id|name
suffix:colon
l_string|&quot;&quot;
comma
multiline_comment|/* hmm? */
id|ioctl
suffix:colon
id|opl3sa2_mixer_ioctl
)brace
suffix:semicolon
multiline_comment|/* End of mixer-related stuff */
DECL|function|probe_opl3sa2_mpu
r_static
r_inline
r_int
id|__init
id|probe_opl3sa2_mpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_return
id|probe_mpu401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|function|attach_opl3sa2_mpu
r_static
r_inline
r_void
id|__init
id|attach_opl3sa2_mpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|attach_mpu401
c_func
(paren
id|hw_config
comma
id|THIS_MODULE
)paren
suffix:semicolon
)brace
DECL|function|unload_opl3sa2_mpu
r_static
r_inline
r_void
id|__exit
id|unload_opl3sa2_mpu
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|unload_mpu401
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|function|probe_opl3sa2_mss
r_static
r_inline
r_int
id|__init
id|probe_opl3sa2_mss
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_return
id|probe_ms_sound
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|function|attach_opl3sa2_mss
r_static
r_void
id|__init
id|attach_opl3sa2_mss
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_char
id|mixer_name
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* Create pretty names for mixer stuff */
id|strncpy
c_func
(paren
id|mixer_name
comma
id|chipset_name
comma
l_int|16
)paren
suffix:semicolon
id|strncat
c_func
(paren
id|mixer_name
comma
l_string|&quot; and AD1848 (through MSS)&quot;
comma
l_int|64
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|opl3sa2_mixer_operations.name
comma
id|chipset_name
comma
l_int|16
)paren
suffix:semicolon
id|strncat
c_func
(paren
id|opl3sa2_mixer_operations.name
comma
l_string|&quot;-AD1848&quot;
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* Install master mixer */
id|devc-&gt;ad_mixer_dev
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|opl3sa2_mixer
op_assign
id|sound_install_mixer
c_func
(paren
id|MIXER_DRIVER_VERSION
comma
id|mixer_name
comma
op_amp
id|opl3sa2_mixer_operations
comma
r_sizeof
(paren
r_struct
id|mixer_operations
)paren
comma
id|devc
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not install %s master mixer&bslash;n&quot;
comma
id|chipset_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|opl3sa2_mixer_reset
c_func
(paren
id|devc
)paren
suffix:semicolon
id|attach_ms_sound
c_func
(paren
id|hw_config
comma
id|THIS_MODULE
)paren
suffix:semicolon
multiline_comment|/* Slot 0 */
r_if
c_cond
(paren
id|hw_config-&gt;slots
(braket
l_int|0
)braket
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Did the MSS driver install? */
r_if
c_cond
(paren
id|num_mixers
op_eq
(paren
id|opl3sa2_mixer
op_plus
l_int|2
)paren
)paren
(brace
multiline_comment|/* The MSS mixer is installed */
id|devc-&gt;ad_mixer_dev
op_assign
id|audio_devs
(braket
id|hw_config-&gt;slots
(braket
l_int|0
)braket
)braket
op_member_access_from_pointer
id|mixer_dev
suffix:semicolon
multiline_comment|/* Reroute mixers appropiately */
id|AD1848_REROUTE
c_func
(paren
id|SOUND_MIXER_LINE1
comma
id|SOUND_MIXER_CD
)paren
suffix:semicolon
id|AD1848_REROUTE
c_func
(paren
id|SOUND_MIXER_LINE2
comma
id|SOUND_MIXER_SYNTH
)paren
suffix:semicolon
id|AD1848_REROUTE
c_func
(paren
id|SOUND_MIXER_LINE3
comma
id|SOUND_MIXER_LINE
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|unload_opl3sa2_mss
r_static
r_inline
r_void
id|__exit
id|unload_opl3sa2_mss
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|unload_ms_sound
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
DECL|function|probe_opl3sa2
r_static
r_int
id|__init
id|probe_opl3sa2
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
r_char
id|version
op_assign
l_int|0
suffix:semicolon
r_char
id|tag
suffix:semicolon
multiline_comment|/*&n;&t; * Verify that the I/O port range is free.&n;&t; */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Control I/O port 0x%03x not free&bslash;n&quot;
comma
id|__FILE__
comma
id|hw_config-&gt;io_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Determine chipset type (SA2, SA3, or SAx)&n;&t; */
multiline_comment|/*&n;&t; * Look at chipset version in lower 3 bits of index 0x0A, miscellaneous&n;&t; */
id|opl3sa2_read
c_func
(paren
id|hw_config-&gt;io_base
comma
id|OPL3SA2_MISC
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|version
)paren
suffix:semicolon
id|version
op_and_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* Match version number to appropiate chipset */
r_if
c_cond
(paren
id|version
op_amp
id|CHIPSET_OPL3SAX
)paren
(brace
id|chipset
op_assign
id|CHIPSET_OPL3SAX
suffix:semicolon
id|tag
op_assign
l_char|&squot;x&squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Found OPL3-SAx (YMF719)&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|version
op_amp
id|CHIPSET_OPL3SA3
)paren
(brace
id|chipset
op_assign
id|CHIPSET_OPL3SA3
suffix:semicolon
id|tag
op_assign
l_char|&squot;3&squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Found OPL3-SA3 (YMF715)&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|version
op_amp
id|CHIPSET_OPL3SA2
)paren
(brace
id|chipset
op_assign
id|CHIPSET_OPL3SA2
suffix:semicolon
id|tag
op_assign
l_char|&squot;2&squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Found OPL3-SA2 (YMF711)&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|chipset
op_assign
id|CHIPSET_UNKNOWN
suffix:semicolon
id|tag
op_assign
l_char|&squot;?&squot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unknown Yamaha audio controller version&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: chipset version = %x&bslash;n&quot;
comma
id|__FILE__
comma
id|version
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|chipset
op_ne
id|CHIPSET_UNKNOWN
)paren
(brace
multiline_comment|/* Generate a pretty name */
id|sprintf
c_func
(paren
id|chipset_name
comma
l_string|&quot;OPL3-SA%c&quot;
comma
id|tag
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|attach_opl3sa2
r_static
r_void
id|__init
id|attach_opl3sa2
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
id|request_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|2
comma
id|chipset_name
)paren
suffix:semicolon
id|devc-&gt;cfg_port
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
)brace
DECL|function|unload_opl3sa2
r_static
r_void
id|__exit
id|unload_opl3sa2
c_func
(paren
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
multiline_comment|/* Release control ports */
id|release_region
c_func
(paren
id|hw_config-&gt;io_base
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Unload mixer */
r_if
c_cond
(paren
id|opl3sa2_mixer
op_ge
l_int|0
)paren
(brace
id|sound_unload_mixerdev
c_func
(paren
id|opl3sa2_mixer
)paren
suffix:semicolon
)brace
)brace
DECL|variable|cfg
r_static
r_struct
id|address_info
id|cfg
suffix:semicolon
DECL|variable|cfg2
r_static
r_struct
id|address_info
id|cfg2
suffix:semicolon
DECL|variable|cfg_mpu
r_static
r_struct
id|address_info
id|cfg_mpu
suffix:semicolon
DECL|variable|io
r_static
r_int
id|__initdata
id|io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mss_io
r_static
r_int
id|__initdata
id|mss_io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|mpu_io
r_static
r_int
id|__initdata
id|mpu_io
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|__initdata
id|irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma
r_static
r_int
id|__initdata
id|dma
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|dma2
r_static
r_int
id|__initdata
id|dma2
op_assign
op_minus
l_int|1
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|io
comma
l_string|&quot;Set i/o base of OPL3-SA2 or SA3 card (usually 0x370)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mss_io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mss_io
comma
l_string|&quot;Set MSS (audio) I/O base (0x530, 0xE80, or other. Address must end in 0 or 4 and must be from 0x530 to 0xF48)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mpu_io
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mpu_io
comma
l_string|&quot;Set MIDI I/O base (0x330 or other. Address must be on 4 location boundaries and must be from 0x300 to 0x334)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mss_irq
comma
l_string|&quot;Set MSS (audio) IRQ (5, 7, 9, 10, 11, 12)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dma
comma
l_string|&quot;Set MSS (audio) first DMA channel (0, 1, 3)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma2
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dma2
comma
l_string|&quot;Set MSS (audio) second DMA channel (0, 1, 3)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Module for OPL3-SA2 and SA3 sound cards (uses AD1848 MSS driver).&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Scott Murray &lt;scottm@interlog.com&gt;&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Install a OPL3SA2 based card.&n; *&n; * Need to have ad1848 and mpu401 loaded ready.&n; */
DECL|function|init_opl3sa2
r_static
r_int
id|__init
id|init_opl3sa2
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Our own config: */
id|cfg.io_base
op_assign
id|io
suffix:semicolon
id|cfg.irq
op_assign
id|irq
suffix:semicolon
id|cfg.dma
op_assign
id|dma
suffix:semicolon
id|cfg.dma2
op_assign
id|dma2
suffix:semicolon
multiline_comment|/* The MSS config: */
id|cfg2.io_base
op_assign
id|mss_io
suffix:semicolon
id|cfg2.irq
op_assign
id|irq
suffix:semicolon
id|cfg2.dma
op_assign
id|dma
suffix:semicolon
id|cfg2.dma2
op_assign
id|dma2
suffix:semicolon
id|cfg2.card_subtype
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* No IRQ or DMA setup */
id|cfg_mpu.io_base
op_assign
id|mpu_io
suffix:semicolon
id|cfg_mpu.irq
op_assign
id|irq
suffix:semicolon
id|cfg_mpu.dma
op_assign
id|dma
suffix:semicolon
id|cfg_mpu.always_detect
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* It&squot;s there, so use shared IRQs */
r_if
c_cond
(paren
id|cfg.io_base
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.irq
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.dma
op_eq
op_minus
l_int|1
op_logical_or
id|cfg.dma2
op_eq
op_minus
l_int|1
op_logical_or
id|cfg2.io_base
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;opl3sa2: io, mss_io, irq, dma, and dma2 must be set.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Call me paranoid: */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cfg.slots
(braket
id|i
)braket
op_assign
id|cfg2.slots
(braket
id|i
)braket
op_assign
id|cfg_mpu.slots
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|probe_opl3sa2
c_func
(paren
op_amp
id|cfg
)paren
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|probe_opl3sa2_mss
c_func
(paren
op_amp
id|cfg2
)paren
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|attach_opl3sa2
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
id|attach_opl3sa2_mss
c_func
(paren
op_amp
id|cfg2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cfg_mpu.io_base
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|probe_opl3sa2_mpu
c_func
(paren
op_amp
id|cfg_mpu
)paren
)paren
(brace
id|attach_opl3sa2_mpu
c_func
(paren
op_amp
id|cfg_mpu
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_opl3sa2
r_static
r_void
id|__exit
id|cleanup_opl3sa2
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|cfg_mpu.slots
(braket
l_int|1
)braket
op_ne
op_minus
l_int|1
)paren
(brace
id|unload_opl3sa2_mpu
c_func
(paren
op_amp
id|cfg_mpu
)paren
suffix:semicolon
)brace
id|unload_opl3sa2_mss
c_func
(paren
op_amp
id|cfg2
)paren
suffix:semicolon
id|unload_opl3sa2
c_func
(paren
op_amp
id|cfg
)paren
suffix:semicolon
)brace
DECL|variable|init_opl3sa2
id|module_init
c_func
(paren
id|init_opl3sa2
)paren
suffix:semicolon
DECL|variable|cleanup_opl3sa2
id|module_exit
c_func
(paren
id|cleanup_opl3sa2
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|setup_opl3sa2
r_static
r_int
id|__init
id|setup_opl3sa2
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/* io, irq, dma, dma2 */
r_int
id|ints
(braket
l_int|7
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
id|io
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|irq
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|dma
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|dma2
op_assign
id|ints
(braket
l_int|4
)braket
suffix:semicolon
id|mss_io
op_assign
id|ints
(braket
l_int|5
)braket
suffix:semicolon
id|mpu_io
op_assign
id|ints
(braket
l_int|6
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;opl3sa2=&quot;
comma
id|setup_opl3sa2
)paren
suffix:semicolon
macro_line|#endif
eof
