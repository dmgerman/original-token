multiline_comment|/*&n; * sound/dev_table.c&n; *&n; * Device call tables.&n; *&n; * Copyright by Hannu Savolainen 1993&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions are&n; * met: 1. Redistributions of source code must retain the above copyright&n; * notice, this list of conditions and the following disclaimer. 2.&n; * Redistributions in binary form must reproduce the above copyright notice,&n; * this list of conditions and the following disclaimer in the documentation&n; * and/or other materials provided with the distribution.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND ANY&n; * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED&n; * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER&n; * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; *&n; */
DECL|macro|_DEV_TABLE_C_
mdefine_line|#define _DEV_TABLE_C_
macro_line|#include &quot;sound_config.h&quot;
macro_line|#ifdef CONFIGURE_SOUNDCARD
r_int
DECL|function|snd_find_driver
id|snd_find_driver
(paren
r_int
id|type
)paren
(brace
r_int
id|i
comma
id|n
op_assign
id|num_sound_drivers
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sound_drivers
(braket
id|i
)braket
dot
id|card_type
op_eq
id|type
)paren
r_return
id|i
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Not found&n;&t;&t;&t;&t; */
)brace
r_int
DECL|function|sndtable_init
id|sndtable_init
(paren
r_int
id|mem_start
)paren
(brace
r_int
id|i
comma
id|n
op_assign
id|num_sound_cards
suffix:semicolon
r_int
id|drv
suffix:semicolon
id|printk
(paren
l_string|&quot;Sound initialization started&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Check the number of cards actually defined in the table&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
op_logical_and
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
suffix:semicolon
id|i
op_increment
)paren
id|num_sound_cards
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
op_logical_and
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|enabled
)paren
(brace
id|snd_installed_cards
(braket
id|i
)braket
dot
id|for_driver_use
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|drv
op_assign
id|snd_find_driver
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
)paren
)paren
op_eq
op_minus
l_int|1
)paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * Mark as not detected&n;&t;&t;&t;&t;&t;&t; */
r_else
r_if
c_cond
(paren
id|sound_drivers
(braket
id|drv
)braket
dot
id|probe
(paren
op_amp
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config
)paren
)paren
(brace
macro_line|#ifndef SHORT_BANNERS
id|printk
(paren
l_string|&quot;snd%d&quot;
comma
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
)paren
suffix:semicolon
macro_line|#endif
id|mem_start
op_assign
id|sound_drivers
(braket
id|drv
)braket
dot
id|attach
(paren
id|mem_start
comma
op_amp
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config
)paren
suffix:semicolon
macro_line|#ifndef SHORT_BANNERS
id|printk
(paren
l_string|&quot; at 0x%x irq %d drq %d&quot;
comma
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.io_base
comma
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.irq
comma
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.dma2
op_ne
op_minus
l_int|1
)paren
id|printk
(paren
l_string|&quot;,%d&bslash;n&quot;
comma
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.dma2
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
id|snd_installed_cards
(braket
id|i
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * Mark as not detected&n;&t;&t;&t;&t;&t;&t; */
)brace
id|printk
(paren
l_string|&quot;Sound initialization complete&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|mem_start
suffix:semicolon
)brace
r_void
DECL|function|sound_unload_drivers
id|sound_unload_drivers
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|n
op_assign
id|num_sound_cards
suffix:semicolon
r_int
id|drv
suffix:semicolon
id|printk
(paren
l_string|&quot;Sound unload started&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
op_logical_and
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|enabled
)paren
r_if
c_cond
(paren
(paren
id|drv
op_assign
id|snd_find_driver
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
)paren
)paren
op_ne
op_minus
l_int|1
)paren
r_if
c_cond
(paren
id|sound_drivers
(braket
id|drv
)braket
dot
id|unload
)paren
id|sound_drivers
(braket
id|drv
)braket
dot
id|unload
(paren
op_amp
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;Sound unload complete&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_int
DECL|function|sndtable_probe
id|sndtable_probe
(paren
r_int
id|unit
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
comma
id|sel
op_assign
op_minus
l_int|1
comma
id|n
op_assign
id|num_sound_cards
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unit
)paren
r_return
id|TRUE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
op_logical_and
id|sel
op_eq
op_minus
l_int|1
op_logical_and
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|enabled
)paren
r_if
c_cond
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
op_eq
id|unit
)paren
id|sel
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sel
op_eq
op_minus
l_int|1
op_logical_and
id|num_sound_cards
OL
id|max_sound_cards
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|sel
op_assign
(paren
id|num_sound_cards
op_increment
)paren
suffix:semicolon
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|card_type
op_assign
id|unit
suffix:semicolon
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|enabled
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sel
op_ne
op_minus
l_int|1
)paren
(brace
r_int
id|drv
suffix:semicolon
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|for_driver_use
op_assign
l_int|NULL
suffix:semicolon
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|config.io_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|config.irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|config.dma
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|config.dma2
op_assign
id|hw_config-&gt;dma2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|drv
op_assign
id|snd_find_driver
(paren
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|card_type
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sound_drivers
(braket
id|drv
)braket
dot
id|probe
(paren
id|hw_config
)paren
)paren
r_return
id|TRUE
suffix:semicolon
id|snd_installed_cards
(braket
id|sel
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * Mark as not detected&n;&t;&t;&t;&t;&t;&t; */
r_return
id|FALSE
suffix:semicolon
)brace
r_return
id|FALSE
suffix:semicolon
)brace
r_int
DECL|function|sndtable_init_card
id|sndtable_init_card
(paren
r_int
id|unit
comma
r_struct
id|address_info
op_star
id|hw_config
)paren
(brace
r_int
id|i
comma
id|n
op_assign
id|num_sound_cards
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;sndtable_init_card(%d) entered&bslash;n&quot;
comma
id|unit
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unit
)paren
(brace
r_if
c_cond
(paren
id|sndtable_init
(paren
l_int|0
)paren
op_ne
l_int|0
)paren
id|panic
(paren
l_string|&quot;sound: Invalid memory allocation&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
op_logical_and
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
op_eq
id|unit
)paren
(brace
r_int
id|drv
suffix:semicolon
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.io_base
op_assign
id|hw_config-&gt;io_base
suffix:semicolon
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.irq
op_assign
id|hw_config-&gt;irq
suffix:semicolon
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.dma
op_assign
id|hw_config-&gt;dma
suffix:semicolon
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.dma2
op_assign
id|hw_config-&gt;dma2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|drv
op_assign
id|snd_find_driver
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
)paren
)paren
op_eq
op_minus
l_int|1
)paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * Mark as not detected&n;&t;&t;&t;&t;&t;&t; */
r_else
(brace
id|DDB
(paren
id|printk
(paren
l_string|&quot;Located card - calling attach routine&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;snd%d&quot;
comma
id|unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sound_drivers
(braket
id|drv
)braket
dot
id|attach
(paren
l_int|0
comma
id|hw_config
)paren
op_ne
l_int|0
)paren
id|panic
(paren
l_string|&quot;sound: Invalid memory allocation&bslash;n&quot;
)paren
suffix:semicolon
id|DDB
(paren
id|printk
(paren
l_string|&quot;attach routine finished&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot; at 0x%x irq %d drq %d&quot;
comma
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.io_base
comma
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.irq
comma
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.dma2
op_ne
op_minus
l_int|1
)paren
id|printk
(paren
l_string|&quot;,%d&bslash;n&quot;
comma
id|snd_installed_cards
(braket
id|i
)braket
dot
id|config.dma2
)paren
suffix:semicolon
r_else
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;sndtable_init_card: No card defined with type=%d, num cards: %d&bslash;n&quot;
comma
id|unit
comma
id|num_sound_cards
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_int
DECL|function|sndtable_get_cardcount
id|sndtable_get_cardcount
(paren
r_void
)paren
(brace
r_return
id|num_audiodevs
op_plus
id|num_mixers
op_plus
id|num_synths
op_plus
id|num_midis
suffix:semicolon
)brace
r_int
DECL|function|sndtable_identify_card
id|sndtable_identify_card
(paren
r_char
op_star
id|name
)paren
(brace
r_int
id|i
comma
id|n
op_assign
id|num_sound_drivers
suffix:semicolon
r_if
c_cond
(paren
id|name
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sound_drivers
(braket
id|i
)braket
dot
id|driver_id
op_ne
l_int|NULL
)paren
(brace
r_char
op_star
id|id
op_assign
id|sound_drivers
(braket
id|i
)braket
dot
id|driver_id
suffix:semicolon
r_int
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|80
op_logical_and
id|name
(braket
id|j
)braket
op_eq
id|id
(braket
id|j
)braket
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|id
(braket
id|j
)braket
op_eq
l_int|0
op_logical_and
id|name
(braket
id|j
)braket
op_eq
l_int|0
)paren
multiline_comment|/* Match */
r_return
id|sound_drivers
(braket
id|i
)braket
dot
id|card_type
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|sound_setup
id|sound_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|i
comma
id|n
op_assign
id|num_sound_cards
suffix:semicolon
multiline_comment|/*&n;     * First disable all drivers&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
op_logical_and
id|snd_installed_cards
(braket
id|i
)braket
dot
id|card_type
suffix:semicolon
id|i
op_increment
)paren
id|snd_installed_cards
(braket
id|i
)braket
dot
id|enabled
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_eq
l_int|0
op_logical_or
id|ints
(braket
l_int|1
)braket
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;     * Then enable them one by time&n;   */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|ints
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|card_type
comma
id|ioaddr
comma
id|irq
comma
id|dma
comma
id|ptr
comma
id|j
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
id|val
op_assign
(paren
r_int
r_int
)paren
id|ints
(braket
id|i
)braket
suffix:semicolon
id|card_type
op_assign
(paren
id|val
op_amp
l_int|0x0ff00000
)paren
op_rshift
l_int|20
suffix:semicolon
r_if
c_cond
(paren
id|card_type
OG
l_int|127
)paren
(brace
multiline_comment|/*&n;&t;   * Add any future extensions here&n;&t;   */
r_return
suffix:semicolon
)brace
id|ioaddr
op_assign
(paren
id|val
op_amp
l_int|0x000fff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|irq
op_assign
(paren
id|val
op_amp
l_int|0x000000f0
)paren
op_rshift
l_int|4
suffix:semicolon
id|dma
op_assign
(paren
id|val
op_amp
l_int|0x0000000f
)paren
suffix:semicolon
id|ptr
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|n
op_logical_and
id|ptr
op_eq
op_minus
l_int|1
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|snd_installed_cards
(braket
id|j
)braket
dot
id|card_type
op_eq
id|card_type
op_logical_and
op_logical_neg
id|snd_installed_cards
(braket
id|j
)braket
dot
id|enabled
)paren
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t; * Not already found&n;&t;&t;&t;&t;&t;&t; */
id|ptr
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_eq
op_minus
l_int|1
)paren
id|printk
(paren
l_string|&quot;Sound: Invalid setup parameter 0x%08x&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_else
(brace
id|snd_installed_cards
(braket
id|ptr
)braket
dot
id|enabled
op_assign
l_int|1
suffix:semicolon
id|snd_installed_cards
(braket
id|ptr
)braket
dot
id|config.io_base
op_assign
id|ioaddr
suffix:semicolon
id|snd_installed_cards
(braket
id|ptr
)braket
dot
id|config.irq
op_assign
id|irq
suffix:semicolon
id|snd_installed_cards
(braket
id|ptr
)braket
dot
id|config.dma
op_assign
id|dma
suffix:semicolon
id|snd_installed_cards
(braket
id|ptr
)braket
dot
id|config.dma2
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_struct
id|address_info
op_star
DECL|function|sound_getconf
id|sound_getconf
(paren
r_int
id|card_type
)paren
(brace
r_int
id|j
comma
id|ptr
suffix:semicolon
r_int
id|n
op_assign
id|num_sound_cards
suffix:semicolon
id|ptr
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|n
op_logical_and
id|ptr
op_eq
op_minus
l_int|1
op_logical_and
id|snd_installed_cards
(braket
id|j
)braket
dot
id|card_type
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|snd_installed_cards
(braket
id|j
)braket
dot
id|card_type
op_eq
id|card_type
)paren
id|ptr
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_eq
op_minus
l_int|1
)paren
r_return
(paren
r_struct
id|address_info
op_star
)paren
l_int|NULL
suffix:semicolon
r_return
op_amp
id|snd_installed_cards
(braket
id|ptr
)braket
dot
id|config
suffix:semicolon
)brace
macro_line|#else
r_void
DECL|function|sound_setup
id|sound_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
)brace
macro_line|#endif
eof
