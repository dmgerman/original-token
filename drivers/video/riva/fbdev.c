multiline_comment|/*&n; * linux/drivers/video/riva/fbdev.c - nVidia RIVA 128/TNT/TNT2 fb driver&n; *&n; * Maintained by Ani Joshi &lt;ajoshi@shell.unixbox.com&gt;&n; *&n; * Copyright 1999-2000 Jeff Garzik&n; *&n; * Contributors:&n; *&n; *&t;Ani Joshi:  Lots of debugging and cleanup work, really helped&n; *&t;get the driver going&n; *&n; *&t;Ferenc Bakonyi:  Bug fixes, cleanup, modularization&n; *&n; * Initial template from skeletonfb.c, created 28 Dec 1997 by Geert Uytterhoeven&n; * Includes riva_hw.c from nVidia, see copyright below.&n; * KGI code provided the basis for state storage, init, and mode switching.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; */
multiline_comment|/* version number of this driver */
DECL|macro|RIVAFB_VERSION
mdefine_line|#define RIVAFB_VERSION &quot;0.7.3&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &quot;riva_hw.h&quot;
macro_line|#include &quot;nv4ref.h&quot;
macro_line|#include &quot;nvreg.h&quot;
macro_line|#include &quot;../vga.h&quot;
macro_line|#include &lt;video/fbcon-cfb4.h&gt;
macro_line|#include &lt;video/fbcon-cfb8.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
macro_line|#include &lt;video/fbcon-cfb32.h&gt;
macro_line|#ifndef CONFIG_PCI&t;&t;/* sanity check */
macro_line|#error This driver requires PCI support.
macro_line|#endif
multiline_comment|/*****************************************************************&n; *&n; * various helpful macros and constants&n; *&n; */
multiline_comment|/* #define RIVAFBDEBUG */
macro_line|#ifdef RIVAFBDEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...) printk(KERN_DEBUG &quot;%s: &quot; fmt, __FUNCTION__ , ## args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...)
macro_line|#endif
macro_line|#ifndef RIVA_NDEBUG
DECL|macro|assert
mdefine_line|#define assert(expr) &bslash;&n;&t;if(!(expr)) { &bslash;&n;        printk( &quot;Assertion failed! %s,%s,%s,line=%d&bslash;n&quot;,&bslash;&n;        #expr,__FILE__,__FUNCTION__,__LINE__); &bslash;&n;&t;BUG(); &bslash;&n;        }
macro_line|#else
DECL|macro|assert
mdefine_line|#define assert(expr)
macro_line|#endif
multiline_comment|/* GGI compatibility macros */
DECL|macro|io_out8
mdefine_line|#define io_out8&t;&t;&t;outb
DECL|macro|io_in8
mdefine_line|#define io_in8&t;&t;&t;inb
DECL|macro|NUM_SEQ_REGS
mdefine_line|#define NUM_SEQ_REGS&t;&t;0x05
DECL|macro|NUM_CRT_REGS
mdefine_line|#define NUM_CRT_REGS&t;&t;0x41
DECL|macro|NUM_GRC_REGS
mdefine_line|#define NUM_GRC_REGS&t;&t;0x09
DECL|macro|NUM_ATC_REGS
mdefine_line|#define NUM_ATC_REGS&t;&t;0x15
DECL|macro|PFX
mdefine_line|#define PFX &quot;rivafb: &quot;
DECL|macro|CNVT_TOHW
mdefine_line|#define CNVT_TOHW(val,width)&t;((((val)&lt;&lt;(width))+0x7FFF-(val))&gt;&gt;16)
multiline_comment|/* macro that allows you to set overflow bits */
DECL|macro|SetBitField
mdefine_line|#define SetBitField(value,from,to) SetBF(to,GetBF(value,from))
DECL|macro|SetBit
mdefine_line|#define SetBit(n)&t;&t;(1&lt;&lt;(n))
DECL|macro|Set8Bits
mdefine_line|#define Set8Bits(value)&t;&t;((value)&amp;0xff)
DECL|enum|riva_chips
r_enum
id|riva_chips
(brace
DECL|enumerator|CH_RIVA_128
id|CH_RIVA_128
op_assign
l_int|0
comma
DECL|enumerator|CH_RIVA_TNT
id|CH_RIVA_TNT
comma
DECL|enumerator|CH_RIVA_TNT2
id|CH_RIVA_TNT2
comma
DECL|enumerator|CH_RIVA_UTNT2
id|CH_RIVA_UTNT2
comma
multiline_comment|/* UTNT2 */
DECL|enumerator|CH_RIVA_VTNT2
id|CH_RIVA_VTNT2
comma
multiline_comment|/* VTNT2 */
DECL|enumerator|CH_RIVA_UVTNT2
id|CH_RIVA_UVTNT2
comma
multiline_comment|/* VTNT2 */
DECL|enumerator|CH_RIVA_ITNT2
id|CH_RIVA_ITNT2
comma
multiline_comment|/* ITNT2 */
)brace
suffix:semicolon
multiline_comment|/* directly indexed by riva_chips enum, above */
DECL|struct|riva_chip_info
r_static
r_struct
id|riva_chip_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|arch_rev
r_int
id|arch_rev
suffix:semicolon
DECL|variable|__devinitdata
)brace
id|riva_chip_info
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_string|&quot;RIVA-128&quot;
comma
l_int|3
)brace
comma
(brace
l_string|&quot;RIVA-TNT&quot;
comma
l_int|4
)brace
comma
(brace
l_string|&quot;RIVA-TNT2&quot;
comma
l_int|5
)brace
comma
(brace
l_string|&quot;RIVA-UTNT2&quot;
comma
l_int|5
)brace
comma
(brace
l_string|&quot;RIVA-VTNT2&quot;
comma
l_int|5
)brace
comma
(brace
l_string|&quot;RIVA-UVTNT2&quot;
comma
l_int|5
)brace
comma
(brace
l_string|&quot;RIVA-ITNT2&quot;
comma
l_int|5
)brace
comma
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|rivafb_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_NVIDIA_SGS
comma
id|PCI_DEVICE_ID_NVIDIA_SGS_RIVA128
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_RIVA_128
)brace
comma
(brace
id|PCI_VENDOR_ID_NVIDIA
comma
id|PCI_DEVICE_ID_NVIDIA_TNT
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_RIVA_TNT
)brace
comma
(brace
id|PCI_VENDOR_ID_NVIDIA
comma
id|PCI_DEVICE_ID_NVIDIA_TNT2
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_RIVA_TNT2
)brace
comma
(brace
id|PCI_VENDOR_ID_NVIDIA
comma
id|PCI_DEVICE_ID_NVIDIA_UTNT2
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_RIVA_UTNT2
)brace
comma
(brace
id|PCI_VENDOR_ID_NVIDIA
comma
id|PCI_DEVICE_ID_NVIDIA_VTNT2
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_RIVA_VTNT2
)brace
comma
(brace
id|PCI_VENDOR_ID_NVIDIA
comma
id|PCI_DEVICE_ID_NVIDIA_UVTNT2
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_RIVA_VTNT2
)brace
comma
(brace
id|PCI_VENDOR_ID_NVIDIA
comma
id|PCI_DEVICE_ID_NVIDIA_ITNT2
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CH_RIVA_ITNT2
)brace
comma
(brace
l_int|0
comma
)brace
multiline_comment|/* terminate list */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|rivafb_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* holds the state of the VGA core and extended Riva hw state from riva_hw.c.&n; * From KGI originally. */
DECL|struct|riva_regs
r_struct
id|riva_regs
(brace
DECL|member|attr
id|u8
id|attr
(braket
id|NUM_ATC_REGS
)braket
suffix:semicolon
DECL|member|crtc
id|u8
id|crtc
(braket
id|NUM_CRT_REGS
)braket
suffix:semicolon
DECL|member|gra
id|u8
id|gra
(braket
id|NUM_GRC_REGS
)braket
suffix:semicolon
DECL|member|seq
id|u8
id|seq
(braket
id|NUM_SEQ_REGS
)braket
suffix:semicolon
DECL|member|misc_output
id|u8
id|misc_output
suffix:semicolon
DECL|member|ext
id|RIVA_HW_STATE
id|ext
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * describes the state of a Riva board&n; */
DECL|struct|rivafb_par
r_struct
id|rivafb_par
(brace
DECL|member|state
r_struct
id|riva_regs
id|state
suffix:semicolon
multiline_comment|/* state of hw board */
DECL|member|visual
id|__u32
id|visual
suffix:semicolon
multiline_comment|/* FB_VISUAL_xxx */
DECL|member|depth
r_int
id|depth
suffix:semicolon
multiline_comment|/* bpp of current mode */
)brace
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|transp
r_int
r_char
id|red
comma
id|green
comma
id|blue
comma
id|transp
suffix:semicolon
DECL|typedef|riva_cfb8_cmap_t
)brace
id|riva_cfb8_cmap_t
suffix:semicolon
r_struct
id|rivafb_info
suffix:semicolon
DECL|struct|rivafb_info
r_struct
id|rivafb_info
(brace
DECL|member|info
r_struct
id|fb_info
id|info
suffix:semicolon
multiline_comment|/* kernel framebuffer info */
DECL|member|riva
id|RIVA_HW_INST
id|riva
suffix:semicolon
multiline_comment|/* interface to riva_hw.c */
DECL|member|drvr_name
r_const
r_char
op_star
id|drvr_name
suffix:semicolon
multiline_comment|/* Riva hardware board type */
DECL|member|ctrl_base_phys
r_int
r_int
id|ctrl_base_phys
suffix:semicolon
multiline_comment|/* physical control register base addr */
DECL|member|fb_base_phys
r_int
r_int
id|fb_base_phys
suffix:semicolon
multiline_comment|/* physical framebuffer base addr */
DECL|member|ctrl_base
id|caddr_t
id|ctrl_base
suffix:semicolon
multiline_comment|/* virtual control register base addr */
DECL|member|fb_base
id|caddr_t
id|fb_base
suffix:semicolon
multiline_comment|/* virtual framebuffer base addr */
DECL|member|ram_amount
r_int
id|ram_amount
suffix:semicolon
multiline_comment|/* amount of RAM on card, in bytes */
DECL|member|dclk_max
r_int
id|dclk_max
suffix:semicolon
multiline_comment|/* max DCLK */
DECL|member|initial_state
r_struct
id|riva_regs
id|initial_state
suffix:semicolon
multiline_comment|/* initial startup video mode */
DECL|member|disp
r_struct
id|display
id|disp
suffix:semicolon
DECL|member|currcon
r_int
id|currcon
suffix:semicolon
DECL|member|currcon_display
r_struct
id|display
op_star
id|currcon_display
suffix:semicolon
DECL|member|next
r_struct
id|rivafb_info
op_star
id|next
suffix:semicolon
DECL|member|pd
r_struct
id|pci_dev
op_star
id|pd
suffix:semicolon
multiline_comment|/* pointer to board&squot;s pci info */
DECL|member|base0_region_size
r_int
id|base0_region_size
suffix:semicolon
multiline_comment|/* size of control register region */
DECL|member|base1_region_size
r_int
id|base1_region_size
suffix:semicolon
multiline_comment|/* size of framebuffer region */
DECL|member|palette
id|riva_cfb8_cmap_t
id|palette
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/* VGA DAC palette cache */
macro_line|#if defined(FBCON_HAS_CFB16) || defined(FBCON_HAS_CFB32)
r_union
(brace
macro_line|#ifdef FBCON_HAS_CFB16
DECL|member|cfb16
id|u_int16_t
id|cfb16
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
DECL|member|cfb32
id|u_int32_t
id|cfb32
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
DECL|member|con_cmap
)brace
id|con_cmap
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* FBCON_HAS_CFB16 | FBCON_HAS_CFB32 */
)brace
suffix:semicolon
multiline_comment|/* ------------------- global variables ------------------------ */
DECL|variable|riva_boards
r_static
r_struct
id|rivafb_info
op_star
id|riva_boards
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* command line data, set in rivafb_setup() */
DECL|variable|__initdata
r_static
r_char
id|fontname
(braket
l_int|40
)braket
id|__initdata
op_assign
(brace
l_int|0
)brace
suffix:semicolon
macro_line|#ifndef MODULE
DECL|variable|__initdata
r_static
r_char
id|noaccel
id|__initdata
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* unused */
DECL|variable|__initdata
r_static
r_const
r_char
op_star
id|mode_option
id|__initdata
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
DECL|variable|rivafb_default_var
r_static
r_struct
id|fb_var_screeninfo
id|rivafb_default_var
op_assign
(brace
multiline_comment|/* 640x480-8@60, yres_virtual=2400 (fits for all Riva cards */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|2400
comma
l_int|0
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|39721
comma
l_int|40
comma
l_int|24
comma
l_int|32
comma
l_int|11
comma
l_int|96
comma
l_int|2
comma
l_int|0
comma
id|FB_VMODE_NONINTERLACED
)brace
suffix:semicolon
multiline_comment|/* ------------------- prototypes ------------------------------ */
r_static
r_int
id|rivafb_get_fix
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rivafb_get_var
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rivafb_set_var
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rivafb_get_cmap
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rivafb_set_cmap
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rivafb_pan_display
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rivafb_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rivafb_switch
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rivafb_updatevar
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|rivafb_blank
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|riva_load_video_mode
(paren
r_struct
id|rivafb_info
op_star
id|rivainfo
comma
r_struct
id|fb_var_screeninfo
op_star
id|video_mode
)paren
suffix:semicolon
r_static
r_int
id|riva_getcolreg
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|riva_setcolreg
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|riva_get_cmap_len
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
suffix:semicolon
r_static
r_int
id|riva_set_fbinfo
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
)paren
suffix:semicolon
r_static
r_void
id|riva_save_state
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
comma
r_struct
id|riva_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|riva_load_state
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
comma
r_struct
id|riva_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_struct
id|rivafb_info
op_star
id|riva_board_list_add
(paren
r_struct
id|rivafb_info
op_star
id|board_list
comma
r_struct
id|rivafb_info
op_star
id|new_node
)paren
suffix:semicolon
r_static
r_struct
id|rivafb_info
op_star
id|riva_board_list_del
(paren
r_struct
id|rivafb_info
op_star
id|board_list
comma
r_struct
id|rivafb_info
op_star
id|del_node
)paren
suffix:semicolon
r_static
r_void
id|riva_wclut
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|red
comma
r_int
r_char
id|green
comma
r_int
r_char
id|blue
)paren
suffix:semicolon
multiline_comment|/* kernel interface */
DECL|variable|riva_fb_ops
r_static
r_struct
id|fb_ops
id|riva_fb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_get_fix
suffix:colon
id|rivafb_get_fix
comma
id|fb_get_var
suffix:colon
id|rivafb_get_var
comma
id|fb_set_var
suffix:colon
id|rivafb_set_var
comma
id|fb_get_cmap
suffix:colon
id|rivafb_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|rivafb_set_cmap
comma
id|fb_pan_display
suffix:colon
id|rivafb_pan_display
comma
id|fb_ioctl
suffix:colon
id|rivafb_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/* from GGI */
DECL|variable|reg_template
r_static
r_const
r_struct
id|riva_regs
id|reg_template
op_assign
(brace
(brace
l_int|0x00
comma
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x05
comma
l_int|0x06
comma
l_int|0x07
comma
multiline_comment|/* ATTR */
l_int|0x08
comma
l_int|0x09
comma
l_int|0x0A
comma
l_int|0x0B
comma
l_int|0x0C
comma
l_int|0x0D
comma
l_int|0x0E
comma
l_int|0x0F
comma
l_int|0x41
comma
l_int|0x01
comma
l_int|0x0F
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/* CRT  */
l_int|0x00
comma
l_int|0x00
comma
l_int|0x20
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xE3
comma
multiline_comment|/* 0x10 */
l_int|0xFF
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/* 0x20 */
l_int|0x40
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/* 0x30 */
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/* 0x40 */
)brace
comma
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x40
comma
l_int|0x05
comma
l_int|0x0F
comma
multiline_comment|/* GRA  */
l_int|0xFF
)brace
comma
(brace
l_int|0x03
comma
l_int|0x01
comma
l_int|0x0F
comma
l_int|0x00
comma
l_int|0x0E
)brace
comma
multiline_comment|/* SEQ  */
l_int|0xEB
multiline_comment|/* MISC */
)brace
suffix:semicolon
multiline_comment|/* ------------------- general utility functions -------------------------- */
multiline_comment|/**&n; * riva_set_dispsw&n; * @rinfo: pointer to internal driver struct for a given Riva card&n; *&n; * DESCRIPTION:&n; * Sets up console Low level operations depending on the current? color depth&n; * of the display&n; */
DECL|function|riva_set_dispsw
r_static
r_void
id|riva_set_dispsw
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
)paren
(brace
r_struct
id|display
op_star
id|disp
op_assign
op_amp
id|rinfo-&gt;disp
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|rinfo
op_ne
l_int|NULL
)paren
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|disp-&gt;var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_MFB
r_case
l_int|1
suffix:colon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_mfb
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB4
r_case
l_int|4
suffix:colon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|15
suffix:colon
r_case
l_int|16
suffix:colon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
op_amp
id|rinfo-&gt;con_cmap.cfb16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB24
r_case
l_int|24
suffix:colon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb24
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
id|rinfo-&gt;con_cmap.cfb24
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|32
suffix:colon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb32
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
id|rinfo-&gt;con_cmap.cfb32
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|DPRINTK
(paren
l_string|&quot;Setting fbcon_dummy renderer&bslash;n&quot;
)paren
suffix:semicolon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|riva_init_disp_var
r_static
r_int
id|riva_init_disp_var
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
)paren
(brace
macro_line|#ifndef MODULE
r_if
c_cond
(paren
id|mode_option
)paren
id|fb_find_mode
(paren
op_amp
id|rinfo-&gt;disp.var
comma
op_amp
id|rinfo-&gt;info
comma
id|mode_option
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|8
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* !MODULE */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|riva_init_disp
r_static
r_int
id|__devinit
id|riva_init_disp
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
)paren
(brace
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
r_struct
id|display
op_star
id|disp
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|rinfo
op_ne
l_int|NULL
)paren
suffix:semicolon
id|info
op_assign
op_amp
id|rinfo-&gt;info
suffix:semicolon
id|disp
op_assign
op_amp
id|rinfo-&gt;disp
suffix:semicolon
id|disp-&gt;var
op_assign
id|rivafb_default_var
suffix:semicolon
id|info-&gt;disp
op_assign
id|disp
suffix:semicolon
multiline_comment|/* FIXME: assure that disp-&gt;cmap is completely filled out */
id|disp-&gt;screen_base
op_assign
id|rinfo-&gt;fb_base
suffix:semicolon
id|disp-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|disp-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|disp-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|disp-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
id|disp-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|disp-&gt;next_line
op_assign
id|disp-&gt;line_length
op_assign
(paren
id|disp-&gt;var.xres_virtual
op_star
id|disp-&gt;var.bits_per_pixel
)paren
op_rshift
l_int|3
suffix:semicolon
id|disp-&gt;can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|disp-&gt;inverse
op_assign
l_int|0
suffix:semicolon
id|riva_set_dispsw
(paren
id|rinfo
)paren
suffix:semicolon
id|disp-&gt;scrollmode
op_assign
l_int|0
suffix:semicolon
id|rinfo-&gt;currcon_display
op_assign
id|disp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|riva_init_disp_var
(paren
id|rinfo
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* must be done last */
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -1&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|riva_set_fbinfo
r_static
r_int
id|__devinit
id|riva_set_fbinfo
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
)paren
(brace
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
m_assert
(paren
id|rinfo
op_ne
l_int|NULL
)paren
suffix:semicolon
id|info
op_assign
op_amp
id|rinfo-&gt;info
suffix:semicolon
id|strcpy
(paren
id|info-&gt;modename
comma
id|rinfo-&gt;drvr_name
)paren
suffix:semicolon
id|info-&gt;node
op_assign
op_minus
l_int|1
suffix:semicolon
id|info-&gt;flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|info-&gt;fbops
op_assign
op_amp
id|riva_fb_ops
suffix:semicolon
multiline_comment|/* FIXME: set monspecs to what??? */
id|info-&gt;display_fg
op_assign
l_int|NULL
suffix:semicolon
id|strncpy
(paren
id|info-&gt;fontname
comma
id|fontname
comma
r_sizeof
(paren
id|info-&gt;fontname
)paren
)paren
suffix:semicolon
id|info-&gt;fontname
(braket
r_sizeof
(paren
id|info-&gt;fontname
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|info-&gt;changevar
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;switch_con
op_assign
id|rivafb_switch
suffix:semicolon
id|info-&gt;updatevar
op_assign
id|rivafb_updatevar
suffix:semicolon
id|info-&gt;blank
op_assign
id|rivafb_blank
suffix:semicolon
r_if
c_cond
(paren
id|riva_init_disp
(paren
id|rinfo
)paren
OL
l_int|0
)paren
multiline_comment|/* must be done last */
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----------------------------- PCI bus ----------------------------- */
DECL|function|rivafb_init_one
r_static
r_int
id|__devinit
id|rivafb_init_one
(paren
r_struct
id|pci_dev
op_star
id|pd
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rinfo
suffix:semicolon
r_struct
id|riva_chip_info
op_star
id|rci
op_assign
op_amp
id|riva_chip_info
(braket
id|ent-&gt;driver_data
)braket
suffix:semicolon
m_assert
(paren
id|pd
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|rci
op_ne
l_int|NULL
)paren
suffix:semicolon
id|rinfo
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|rivafb_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rinfo
)paren
r_goto
id|err_out
suffix:semicolon
id|memset
(paren
id|rinfo
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rivafb_info
)paren
)paren
suffix:semicolon
id|rinfo-&gt;drvr_name
op_assign
id|rci-&gt;name
suffix:semicolon
id|rinfo-&gt;riva.Architecture
op_assign
id|rci-&gt;arch_rev
suffix:semicolon
id|rinfo-&gt;pd
op_assign
id|pd
suffix:semicolon
id|rinfo-&gt;base0_region_size
op_assign
id|pci_resource_len
(paren
id|pd
comma
l_int|0
)paren
suffix:semicolon
id|rinfo-&gt;base1_region_size
op_assign
id|pci_resource_len
(paren
id|pd
comma
l_int|1
)paren
suffix:semicolon
m_assert
(paren
id|rinfo-&gt;base0_region_size
op_ge
l_int|0x00800000
)paren
suffix:semicolon
multiline_comment|/* from GGI */
m_assert
(paren
id|rinfo-&gt;base1_region_size
op_ge
l_int|0x01000000
)paren
suffix:semicolon
multiline_comment|/* from GGI */
id|rinfo-&gt;ctrl_base_phys
op_assign
id|pci_resource_start
(paren
id|rinfo-&gt;pd
comma
l_int|0
)paren
suffix:semicolon
id|rinfo-&gt;fb_base_phys
op_assign
id|pci_resource_start
(paren
id|rinfo-&gt;pd
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
(paren
id|rinfo-&gt;ctrl_base_phys
comma
id|rinfo-&gt;base0_region_size
comma
l_string|&quot;rivafb&quot;
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot reserve MMIO region&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_kfree
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
(paren
id|rinfo-&gt;fb_base_phys
comma
id|rinfo-&gt;base1_region_size
comma
l_string|&quot;rivafb&quot;
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot reserve FB region&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_base0
suffix:semicolon
)brace
id|rinfo-&gt;ctrl_base
op_assign
id|ioremap
(paren
id|rinfo-&gt;ctrl_base_phys
comma
id|rinfo-&gt;base0_region_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;ctrl_base
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot ioremap MMIO base&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_base1
suffix:semicolon
)brace
id|rinfo-&gt;fb_base
op_assign
id|ioremap
(paren
id|rinfo-&gt;fb_base_phys
comma
id|rinfo-&gt;base1_region_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rinfo-&gt;fb_base
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot ioremap FB base&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_iounmap_ctrl
suffix:semicolon
)brace
id|rinfo-&gt;riva.EnableIRQ
op_assign
l_int|0
suffix:semicolon
id|rinfo-&gt;riva.IO
op_assign
(paren
id|inb
(paren
l_int|0x3CC
)paren
op_amp
l_int|0x01
)paren
ques
c_cond
l_int|0x3D0
suffix:colon
l_int|0x3B0
suffix:semicolon
id|rinfo-&gt;riva.PRAMDAC
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00680000
)paren
suffix:semicolon
id|rinfo-&gt;riva.PFB
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00100000
)paren
suffix:semicolon
id|rinfo-&gt;riva.PFIFO
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00002000
)paren
suffix:semicolon
id|rinfo-&gt;riva.PGRAPH
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00400000
)paren
suffix:semicolon
id|rinfo-&gt;riva.PEXTDEV
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00101000
)paren
suffix:semicolon
id|rinfo-&gt;riva.PTIMER
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00009000
)paren
suffix:semicolon
id|rinfo-&gt;riva.PMC
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00000000
)paren
suffix:semicolon
id|rinfo-&gt;riva.FIFO
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00800000
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rinfo-&gt;riva.Architecture
)paren
(brace
r_case
l_int|3
suffix:colon
id|rinfo-&gt;riva.PRAMIN
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;fb_base
op_plus
l_int|0x00C00000
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_case
l_int|5
suffix:colon
id|rinfo-&gt;riva.PCRTC
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00600000
)paren
suffix:semicolon
id|rinfo-&gt;riva.PRAMIN
op_assign
(paren
r_int
op_star
)paren
(paren
id|rinfo-&gt;ctrl_base
op_plus
l_int|0x00710000
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|RivaGetConfig
(paren
op_amp
id|rinfo-&gt;riva
)paren
suffix:semicolon
multiline_comment|/* back to normal */
m_assert
(paren
id|rinfo-&gt;pd
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* unlock io */
id|vga_io_wcrt
(paren
l_int|0x11
comma
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/* vgaHWunlock() + riva unlock (0x7F) */
id|outb
(paren
id|rinfo-&gt;riva.LockUnlockIndex
comma
id|rinfo-&gt;riva.LockUnlockIO
)paren
suffix:semicolon
id|outb
(paren
l_int|0x57
comma
id|rinfo-&gt;riva.LockUnlockIO
op_plus
l_int|1
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|rinfo-&gt;initial_state
comma
op_amp
id|reg_template
comma
r_sizeof
(paren
id|reg_template
)paren
)paren
suffix:semicolon
id|riva_save_state
(paren
id|rinfo
comma
op_amp
id|rinfo-&gt;initial_state
)paren
suffix:semicolon
id|rinfo-&gt;ram_amount
op_assign
id|rinfo-&gt;riva.RamAmountKBytes
op_star
l_int|1024
suffix:semicolon
id|rinfo-&gt;dclk_max
op_assign
id|rinfo-&gt;riva.MaxVClockFreqKHz
op_star
l_int|1000
suffix:semicolon
id|riva_set_fbinfo
(paren
id|rinfo
)paren
suffix:semicolon
id|fb_memset
(paren
id|rinfo-&gt;fb_base
comma
l_int|0
comma
id|rinfo-&gt;ram_amount
)paren
suffix:semicolon
id|riva_load_video_mode
(paren
id|rinfo
comma
op_amp
id|rinfo-&gt;disp.var
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
(paren
(paren
r_struct
id|fb_info
op_star
)paren
id|rinfo
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;error registering riva framebuffer&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_iounmap_fb
suffix:semicolon
)brace
id|riva_boards
op_assign
id|riva_board_list_add
c_func
(paren
id|riva_boards
comma
id|rinfo
)paren
suffix:semicolon
id|pci_set_drvdata
(paren
id|pd
comma
id|rinfo
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;PCI Riva NV%d framebuffer ver %s (%s, %dMB @ 0x%lX)&bslash;n&quot;
comma
id|rinfo-&gt;riva.Architecture
comma
id|RIVAFB_VERSION
comma
id|rinfo-&gt;drvr_name
comma
id|rinfo-&gt;ram_amount
op_div
(paren
l_int|1024
op_star
l_int|1024
)paren
op_plus
l_int|1
comma
id|rinfo-&gt;fb_base_phys
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_iounmap_fb
suffix:colon
id|iounmap
(paren
id|rinfo-&gt;fb_base
)paren
suffix:semicolon
id|err_out_iounmap_ctrl
suffix:colon
id|iounmap
(paren
id|rinfo-&gt;ctrl_base
)paren
suffix:semicolon
id|err_out_free_base1
suffix:colon
id|release_mem_region
(paren
id|rinfo-&gt;fb_base_phys
comma
id|rinfo-&gt;base1_region_size
)paren
suffix:semicolon
id|err_out_free_base0
suffix:colon
id|release_mem_region
(paren
id|rinfo-&gt;ctrl_base_phys
comma
id|rinfo-&gt;base0_region_size
)paren
suffix:semicolon
id|err_out_kfree
suffix:colon
id|kfree
(paren
id|rinfo
)paren
suffix:semicolon
id|err_out
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|rivafb_remove_one
r_static
r_void
id|__devexit
id|rivafb_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pd
)paren
(brace
r_struct
id|rivafb_info
op_star
id|board
op_assign
id|pci_get_drvdata
(paren
id|pd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|board
)paren
r_return
suffix:semicolon
id|riva_boards
op_assign
id|riva_board_list_del
c_func
(paren
id|riva_boards
comma
id|board
)paren
suffix:semicolon
id|riva_load_state
(paren
id|board
comma
op_amp
id|board-&gt;initial_state
)paren
suffix:semicolon
id|unregister_framebuffer
(paren
(paren
r_struct
id|fb_info
op_star
)paren
id|board
)paren
suffix:semicolon
id|iounmap
(paren
id|board-&gt;ctrl_base
)paren
suffix:semicolon
id|iounmap
(paren
id|board-&gt;fb_base
)paren
suffix:semicolon
id|release_mem_region
(paren
id|board-&gt;ctrl_base_phys
comma
id|board-&gt;base0_region_size
)paren
suffix:semicolon
id|release_mem_region
(paren
id|board-&gt;fb_base_phys
comma
id|board-&gt;base1_region_size
)paren
suffix:semicolon
id|kfree
(paren
id|board
)paren
suffix:semicolon
id|pci_set_drvdata
(paren
id|pd
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*** riva_wclut - set CLUT entry ***/
DECL|function|riva_wclut
r_static
r_void
id|riva_wclut
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|red
comma
r_int
r_char
id|green
comma
r_int
r_char
id|blue
)paren
(brace
r_int
r_int
id|data
op_assign
id|VGA_PEL_D
suffix:semicolon
multiline_comment|/* address write mode register is not translated.. */
id|vga_io_w
(paren
id|VGA_PEL_IW
comma
id|regnum
)paren
suffix:semicolon
id|vga_io_w
(paren
id|data
comma
id|red
)paren
suffix:semicolon
id|vga_io_w
(paren
id|data
comma
id|green
)paren
suffix:semicolon
id|vga_io_w
(paren
id|data
comma
id|blue
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------ Hardware Independent Functions ------------ */
macro_line|#ifndef MODULE
DECL|function|rivafb_setup
r_int
id|__init
id|rivafb_setup
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|this_opt
op_assign
id|strtok
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_opt
suffix:semicolon
id|this_opt
op_assign
id|strtok
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
(paren
id|this_opt
comma
l_string|&quot;font:&quot;
comma
l_int|5
)paren
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|p
op_assign
id|this_opt
op_plus
l_int|5
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|fontname
)paren
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
op_star
id|p
op_logical_or
op_star
id|p
op_eq
l_char|&squot; &squot;
op_logical_or
op_star
id|p
op_eq
l_char|&squot;,&squot;
)paren
r_break
suffix:semicolon
id|memcpy
(paren
id|fontname
comma
id|this_opt
op_plus
l_int|5
comma
id|i
)paren
suffix:semicolon
id|fontname
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
(paren
id|this_opt
comma
l_string|&quot;noaccel&quot;
comma
l_int|7
)paren
)paren
(brace
id|noaccel
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|mode_option
op_assign
id|this_opt
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* !MODULE */
multiline_comment|/*&n;     *  Initialization&n;     */
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/*&n;     *  Frame buffer operations&n;     */
DECL|function|rivafb_get_fix
r_static
r_int
id|rivafb_get_fix
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
r_struct
id|display
op_star
id|p
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|fix
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|info
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo-&gt;drvr_name
op_logical_and
id|rivainfo-&gt;drvr_name
(braket
l_int|0
)braket
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo-&gt;fb_base_phys
OG
l_int|0
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo-&gt;ram_amount
OG
l_int|0
)paren
suffix:semicolon
id|p
op_assign
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
id|rivainfo-&gt;info.disp
suffix:colon
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
id|memset
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_fix_screeninfo
)paren
)paren
suffix:semicolon
id|sprintf
(paren
id|fix-&gt;id
comma
l_string|&quot;Riva %s&quot;
comma
id|rivainfo-&gt;drvr_name
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
id|rivainfo-&gt;fb_base_phys
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|rivainfo-&gt;ram_amount
suffix:semicolon
id|fix-&gt;type
op_assign
id|p-&gt;type
suffix:semicolon
id|fix-&gt;type_aux
op_assign
id|p-&gt;type_aux
suffix:semicolon
id|fix-&gt;visual
op_assign
id|p-&gt;visual
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: no ywrap for now */
id|fix-&gt;line_length
op_assign
id|p-&gt;line_length
suffix:semicolon
multiline_comment|/* FIXME: set up MMIO region, export via FB_ACCEL_xxx */
id|fix-&gt;mmio_start
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;mmio_len
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rivafb_get_var
r_static
r_int
id|rivafb_get_var
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|info
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|var
op_ne
l_int|NULL
)paren
suffix:semicolon
op_star
id|var
op_assign
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
id|rivainfo-&gt;disp.var
suffix:colon
id|fb_display
(braket
id|con
)braket
dot
id|var
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rivafb_set_var
r_static
r_int
id|rivafb_set_var
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
r_struct
id|display
op_star
id|dsp
suffix:semicolon
r_struct
id|fb_var_screeninfo
id|v
suffix:semicolon
r_int
id|nom
comma
id|den
suffix:semicolon
multiline_comment|/* translating from pixels-&gt;bytes */
r_int
id|i
suffix:semicolon
r_int
id|chgvar
op_assign
l_int|0
suffix:semicolon
r_static
r_struct
(brace
r_int
id|xres
comma
id|yres
suffix:semicolon
)brace
id|modes
(braket
)braket
op_assign
(brace
(brace
l_int|1600
comma
l_int|1280
)brace
comma
(brace
l_int|1280
comma
l_int|1024
)brace
comma
(brace
l_int|1024
comma
l_int|768
)brace
comma
(brace
l_int|800
comma
l_int|600
)brace
comma
(brace
l_int|640
comma
l_int|480
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|info
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|var
op_ne
l_int|NULL
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;Requested: %dx%dx%d&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;  virtual: %dx%d&bslash;n&quot;
comma
id|var-&gt;xres_virtual
comma
id|var-&gt;yres_virtual
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;   offset: (%d,%d)&bslash;n&quot;
comma
id|var-&gt;xoffset
comma
id|var-&gt;yoffset
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;grayscale: %d&bslash;n&quot;
comma
id|var-&gt;grayscale
)paren
suffix:semicolon
id|dsp
op_assign
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
id|rivainfo-&gt;info.disp
suffix:colon
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
m_assert
(paren
id|dsp
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* if var has changed, we should call changevar() later */
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
(brace
id|chgvar
op_assign
(paren
(paren
id|dsp-&gt;var.xres
op_ne
id|var-&gt;xres
)paren
op_logical_or
(paren
id|dsp-&gt;var.yres
op_ne
id|var-&gt;yres
)paren
op_logical_or
(paren
id|dsp-&gt;var.xres_virtual
op_ne
id|var-&gt;xres_virtual
)paren
op_logical_or
(paren
id|dsp-&gt;var.yres_virtual
op_ne
id|var-&gt;yres_virtual
)paren
op_logical_or
(paren
id|dsp-&gt;var.bits_per_pixel
op_ne
id|var-&gt;bits_per_pixel
)paren
op_logical_or
id|memcmp
(paren
op_amp
id|dsp-&gt;var.red
comma
op_amp
id|var-&gt;red
comma
r_sizeof
(paren
id|var-&gt;red
)paren
)paren
op_logical_or
id|memcmp
(paren
op_amp
id|dsp-&gt;var.green
comma
op_amp
id|var-&gt;green
comma
r_sizeof
(paren
id|var-&gt;green
)paren
)paren
op_logical_or
id|memcmp
(paren
op_amp
id|dsp-&gt;var.blue
comma
op_amp
id|var-&gt;blue
comma
r_sizeof
(paren
id|var-&gt;blue
)paren
)paren
)paren
suffix:semicolon
)brace
id|memcpy
(paren
op_amp
id|v
comma
id|var
comma
r_sizeof
(paren
id|v
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|v.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_MFB
r_case
l_int|1
suffix:colon
id|dsp-&gt;dispsw
op_assign
op_amp
id|fbcon_mfb
suffix:semicolon
id|dsp-&gt;line_length
op_assign
id|v.xres_virtual
op_div
l_int|8
suffix:semicolon
id|dsp-&gt;visual
op_assign
id|FB_VISUAL_MONO10
suffix:semicolon
id|nom
op_assign
l_int|4
suffix:semicolon
id|den
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|2
dot
dot
dot
l_int|8
suffix:colon
id|v.bits_per_pixel
op_assign
l_int|8
suffix:semicolon
id|dsp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
id|nom
op_assign
l_int|1
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
id|dsp-&gt;line_length
op_assign
id|v.xres_virtual
suffix:semicolon
id|dsp-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|v.red.offset
op_assign
l_int|0
suffix:semicolon
id|v.red.length
op_assign
l_int|6
suffix:semicolon
id|v.green.offset
op_assign
l_int|0
suffix:semicolon
id|v.green.length
op_assign
l_int|6
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
id|v.blue.length
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|9
dot
dot
dot
l_int|16
suffix:colon
id|v.bits_per_pixel
op_assign
l_int|16
suffix:semicolon
id|dsp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|dsp-&gt;dispsw_data
op_assign
op_amp
id|rivainfo-&gt;con_cmap.cfb16
suffix:semicolon
id|nom
op_assign
l_int|2
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
id|dsp-&gt;line_length
op_assign
id|v.xres_virtual
op_star
l_int|2
suffix:semicolon
id|dsp-&gt;visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
macro_line|#ifdef CONFIG_PREP
id|v.red.offset
op_assign
l_int|2
suffix:semicolon
id|v.green.offset
op_assign
op_minus
l_int|3
suffix:semicolon
id|v.blue.offset
op_assign
l_int|8
suffix:semicolon
macro_line|#else
id|v.red.offset
op_assign
l_int|10
suffix:semicolon
id|v.green.offset
op_assign
l_int|5
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|v.red.length
op_assign
l_int|5
suffix:semicolon
id|v.green.length
op_assign
l_int|5
suffix:semicolon
id|v.blue.length
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|17
dot
dot
dot
l_int|32
suffix:colon
id|v.bits_per_pixel
op_assign
l_int|32
suffix:semicolon
id|dsp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb32
suffix:semicolon
id|dsp-&gt;dispsw_data
op_assign
id|rivainfo-&gt;con_cmap.cfb32
suffix:semicolon
id|nom
op_assign
l_int|4
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
id|dsp-&gt;line_length
op_assign
id|v.xres_virtual
op_star
l_int|4
suffix:semicolon
id|dsp-&gt;visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
macro_line|#ifdef CONFIG_PREP
id|v.red.offset
op_assign
l_int|8
suffix:semicolon
id|v.green.offset
op_assign
l_int|16
suffix:semicolon
id|v.blue.offset
op_assign
l_int|24
suffix:semicolon
macro_line|#else
id|v.red.offset
op_assign
l_int|16
suffix:semicolon
id|v.green.offset
op_assign
l_int|8
suffix:semicolon
id|v.blue.offset
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|v.red.length
op_assign
l_int|8
suffix:semicolon
id|v.green.length
op_assign
l_int|8
suffix:semicolon
id|v.blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;mode %dx%dx%d rejected...color depth not supported.&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -EINVAL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.xres
op_star
id|nom
op_div
id|den
op_star
id|v.yres
OG
id|rivainfo-&gt;ram_amount
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;mode %dx%dx%d rejected...resolution too high to fit into video memory!&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - EINVAL error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* use highest possible virtual resolution */
r_if
c_cond
(paren
id|v.xres_virtual
op_eq
op_minus
l_int|1
op_logical_and
id|v.yres_virtual
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;using maximum available virtual resolution&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|modes
(braket
id|i
)braket
dot
id|xres
op_ne
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|modes
(braket
id|i
)braket
dot
id|xres
op_star
id|nom
op_div
id|den
op_star
id|modes
(braket
id|i
)braket
dot
id|yres
OL
id|rivainfo-&gt;ram_amount
op_div
l_int|2
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modes
(braket
id|i
)braket
dot
id|xres
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;could not find a virtual resolution that fits into video memory!!&bslash;n&quot;
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - EINVAL error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|v.xres_virtual
op_assign
id|modes
(braket
id|i
)braket
dot
id|xres
suffix:semicolon
id|v.yres_virtual
op_assign
id|modes
(braket
id|i
)braket
dot
id|yres
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;virtual resolution set to maximum of %dx%d&bslash;n&quot;
comma
id|v.xres_virtual
comma
id|v.yres_virtual
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|v.xres_virtual
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* FIXME: maximize X virtual resolution only */
)brace
r_else
r_if
c_cond
(paren
id|v.yres_virtual
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* FIXME: maximize Y virtual resolution only */
)brace
r_if
c_cond
(paren
id|v.xoffset
OL
l_int|0
)paren
id|v.xoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|v.yoffset
OL
l_int|0
)paren
id|v.yoffset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* truncate xoffset and yoffset to maximum if too high */
r_if
c_cond
(paren
id|v.xoffset
OG
id|v.xres_virtual
op_minus
id|v.xres
)paren
id|v.xoffset
op_assign
id|v.xres_virtual
op_minus
id|v.xres
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|v.yoffset
OG
id|v.yres_virtual
op_minus
id|v.yres
)paren
id|v.yoffset
op_assign
id|v.yres_virtual
op_minus
id|v.yres
op_minus
l_int|1
suffix:semicolon
id|v.red.msb_right
op_assign
id|v.green.msb_right
op_assign
id|v.blue.msb_right
op_assign
id|v.transp.offset
op_assign
id|v.transp.length
op_assign
id|v.transp.msb_right
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|v.activate
op_amp
id|FB_ACTIVATE_MASK
)paren
(brace
r_case
id|FB_ACTIVATE_TEST
suffix:colon
id|DPRINTK
(paren
l_string|&quot;EXIT - FB_ACTIVATE_TEST&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|FB_ACTIVATE_NXTOPEN
suffix:colon
multiline_comment|/* ?? */
r_case
id|FB_ACTIVATE_NOW
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* continue */
r_default
suffix:colon
id|DPRINTK
(paren
l_string|&quot;EXIT - unknown activation type&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* unknown */
)brace
id|dsp-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
multiline_comment|/* FIXME: verify that the above code sets dsp-&gt;* fields correctly */
id|memcpy
(paren
op_amp
id|dsp-&gt;var
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
suffix:semicolon
id|riva_load_video_mode
(paren
id|rivainfo
comma
op_amp
id|v
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chgvar
op_logical_and
id|info
op_logical_and
id|info-&gt;changevar
)paren
id|info-&gt;changevar
(paren
id|con
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rivafb_get_cmap
r_static
r_int
id|rivafb_get_cmap
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
r_struct
id|display
op_star
id|dsp
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|cmap
op_ne
l_int|NULL
)paren
suffix:semicolon
id|dsp
op_assign
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
id|rivainfo-&gt;info.disp
suffix:colon
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
id|rivainfo-&gt;currcon
)paren
(brace
multiline_comment|/* current console? */
r_int
id|rc
op_assign
id|fb_get_cmap
(paren
id|cmap
comma
id|kspc
comma
id|riva_getcolreg
comma
id|info
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dsp-&gt;cmap.len
)paren
multiline_comment|/* non default colormap? */
id|fb_copy_cmap
(paren
op_amp
id|dsp-&gt;cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
(paren
id|fb_default_cmap
(paren
id|riva_get_cmap_len
(paren
op_amp
id|dsp-&gt;var
)paren
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rivafb_set_cmap
r_static
r_int
id|rivafb_set_cmap
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
r_struct
id|display
op_star
id|dsp
suffix:semicolon
r_int
r_int
id|cmap_len
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|cmap
op_ne
l_int|NULL
)paren
suffix:semicolon
id|dsp
op_assign
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
id|rivainfo-&gt;info.disp
suffix:colon
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
id|cmap_len
op_assign
id|riva_get_cmap_len
(paren
op_amp
id|dsp-&gt;var
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp-&gt;cmap.len
op_ne
id|cmap_len
)paren
(brace
r_int
id|err
op_assign
id|fb_alloc_cmap
(paren
op_amp
id|dsp-&gt;cmap
comma
id|cmap_len
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;EXIT - returning %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|con
op_eq
id|rivainfo-&gt;currcon
)paren
(brace
multiline_comment|/* current console? */
r_int
id|rc
op_assign
id|fb_set_cmap
(paren
id|cmap
comma
id|kspc
comma
id|riva_setcolreg
comma
id|info
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT - returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
id|fb_copy_cmap
(paren
id|cmap
comma
op_amp
id|dsp-&gt;cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * rivafb_pan_display&n; * @var: standard kernel fb changeable data&n; * @con:&n; * @info: pointer to rivafb_info object containing info for current riva board&n; *&n; * DESCRIPTION:&n; * Pan (or wrap, depending on the `vmode&squot; field) the display using the&n; * `xoffset&squot; and `yoffset&squot; fields of the `var&squot; structure.&n; * If the values don&squot;t fit, return -EINVAL.&n; *&n; * This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag&n; */
DECL|function|rivafb_pan_display
r_static
r_int
id|rivafb_pan_display
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_int
id|base
suffix:semicolon
r_struct
id|display
op_star
id|dsp
suffix:semicolon
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo
op_ne
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xoffset
OG
(paren
id|var-&gt;xres_virtual
op_minus
id|var-&gt;xres
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
OG
(paren
id|var-&gt;yres_virtual
op_minus
id|var-&gt;yres
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dsp
op_assign
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
id|rivainfo-&gt;info.disp
suffix:colon
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;yoffset
OL
l_int|0
op_logical_or
id|var-&gt;yoffset
op_ge
id|dsp-&gt;var.yres_virtual
op_logical_or
id|var-&gt;xoffset
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|var-&gt;xoffset
op_plus
id|dsp-&gt;var.xres
OG
id|dsp-&gt;var.xres_virtual
op_logical_or
id|var-&gt;yoffset
op_plus
id|dsp-&gt;var.yres
OG
id|dsp-&gt;var.yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|base
op_assign
id|var-&gt;yoffset
op_star
id|dsp-&gt;line_length
op_plus
id|var-&gt;xoffset
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
id|rivainfo-&gt;currcon
)paren
(brace
id|rivainfo-&gt;riva.SetStartAddress
(paren
op_amp
id|rivainfo-&gt;riva
comma
id|base
)paren
suffix:semicolon
)brace
id|dsp-&gt;var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|dsp-&gt;var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
id|dsp-&gt;var.vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
r_else
id|dsp-&gt;var.vmode
op_and_assign
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rivafb_ioctl
r_static
r_int
id|rivafb_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* no rivafb-specific ioctls */
id|DPRINTK
(paren
l_string|&quot;EXIT, returning -EINVAL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|rivafb_switch
r_static
r_int
id|rivafb_switch
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
r_struct
id|fb_cmap
op_star
id|cmap
suffix:semicolon
r_struct
id|display
op_star
id|dsp
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo
op_ne
l_int|NULL
)paren
suffix:semicolon
id|dsp
op_assign
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
id|rivainfo-&gt;info.disp
suffix:colon
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
r_if
c_cond
(paren
id|rivainfo-&gt;currcon
op_ge
l_int|0
)paren
(brace
multiline_comment|/* Do we have to save the colormap? */
id|cmap
op_assign
op_amp
(paren
id|rivainfo-&gt;currcon_display-&gt;cmap
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;switch1: con = %d, cmap.len = %d&bslash;n&quot;
comma
id|rivainfo-&gt;currcon
comma
id|cmap-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmap-&gt;len
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;switch1a: %p %p %p %p&bslash;n&quot;
comma
id|cmap-&gt;red
comma
id|cmap-&gt;green
comma
id|cmap-&gt;blue
comma
id|cmap-&gt;transp
)paren
suffix:semicolon
id|fb_get_cmap
(paren
id|cmap
comma
l_int|1
comma
id|riva_getcolreg
comma
id|info
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|cmap-&gt;red
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;switch1r: %X&bslash;n&quot;
comma
id|cmap-&gt;red
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
id|rivainfo-&gt;currcon
op_assign
id|con
suffix:semicolon
id|rivainfo-&gt;currcon_display
op_assign
id|dsp
suffix:semicolon
id|dsp-&gt;var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
macro_line|#ifdef riva_DEBUG
id|cmap
op_assign
op_amp
id|dsp-&gt;cmap
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;switch2: con = %d, cmap.len = %d&bslash;n&quot;
comma
id|con
comma
id|cmap-&gt;len
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;switch2a: %p %p %p %p&bslash;n&quot;
comma
id|cmap-&gt;red
comma
id|cmap-&gt;green
comma
id|cmap-&gt;blue
comma
id|cmap-&gt;transp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp-&gt;cmap.red
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;switch2r: %X&bslash;n&quot;
comma
id|cmap-&gt;red
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
id|rivafb_set_var
(paren
op_amp
id|dsp-&gt;var
comma
id|con
comma
id|info
)paren
suffix:semicolon
macro_line|#ifdef riva_DEBUG
id|DPRINTK
(paren
l_string|&quot;switch3: con = %d, cmap.len = %d&bslash;n&quot;
comma
id|con
comma
id|cmap-&gt;len
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;switch3a: %p %p %p %p&bslash;n&quot;
comma
id|cmap-&gt;red
comma
id|cmap-&gt;green
comma
id|cmap-&gt;blue
comma
id|cmap-&gt;transp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsp-&gt;cmap.red
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;switch3r: %X&bslash;n&quot;
comma
id|cmap-&gt;red
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DPRINTK
(paren
l_string|&quot;EXIT, returning 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rivafb_updatevar
r_static
r_int
id|rivafb_updatevar
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|rc
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
op_minus
id|EINVAL
suffix:colon
id|rivafb_pan_display
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
id|con
comma
id|info
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT, returning %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|rivafb_blank
r_static
r_void
id|rivafb_blank
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo
op_ne
l_int|NULL
)paren
suffix:semicolon
id|tmp
op_assign
id|vga_io_rseq
(paren
id|VGA_SEQ_CLOCK_MODE
)paren
op_amp
op_complement
id|VGA_SR01_SCREEN_OFF
suffix:semicolon
r_if
c_cond
(paren
id|blank
)paren
id|tmp
op_or_assign
id|VGA_SR01_SCREEN_OFF
suffix:semicolon
id|vga_io_wseq
(paren
id|VGA_SEQ_CLOCK_MODE
comma
id|tmp
)paren
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------------------------&n; *&n; * internal fb_ops helper functions&n; *&n; * -------------------------------------------------------------------------&n; */
multiline_comment|/**&n; * riva_get_cmap_len&n; * @var:&n; *&n; * DESCRIPTION:&n; */
DECL|function|riva_get_cmap_len
r_static
r_int
id|riva_get_cmap_len
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_int
id|rc
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* reasonable default */
m_assert
(paren
id|var
op_ne
l_int|NULL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB4
r_case
l_int|4
suffix:colon
id|rc
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* pseudocolor... 16 entries HW palette */
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|rc
op_assign
l_int|256
suffix:semicolon
multiline_comment|/* pseudocolor... 256 entries HW palette */
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|rc
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* directcolor... 16 entries SW palette */
r_break
suffix:semicolon
multiline_comment|/* Mystique: truecolor, 16 entries SW palette, HW palette hardwired into 1:1 mapping */
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|32
suffix:colon
id|rc
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* directcolor... 16 entries SW palette */
r_break
suffix:semicolon
multiline_comment|/* Mystique: truecolor, 16 entries SW palette, HW palette hardwired into 1:1 mapping */
macro_line|#endif
r_default
suffix:colon
m_assert
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* should not occur */
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * riva_getcolreg&n; * @regno:&n; * @red:&n; * @green:&n; * @blue:&n; * @transp:&n; * @info: pointer to rivafb_info object containing info for current riva board&n; *&n; * DESCRIPTION:&n; * Read a single color register and split it into colors/transparent.&n; * The return values must have a 16 bit magnitude.&n; * Return != 0 for invalid regno.&n; *&n; * CALLED FROM:&n; * fbcmap.c:fb_get_cmap()&n; *&t;fbgen.c:fbgen_get_cmap()&n; *&t;fbgen.c:fbgen_switch()&n; */
DECL|function|riva_getcolreg
r_static
r_int
id|riva_getcolreg
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
id|riva_get_cmap_len
c_func
(paren
op_amp
id|rivainfo-&gt;currcon_display-&gt;var
)paren
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
id|rivainfo-&gt;palette
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
id|rivainfo-&gt;palette
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
id|rivainfo-&gt;palette
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * riva_setcolreg&n; * @regno:&n; * @red:&n; * @green:&n; * @blue:&n; * @transp:&n; * @info: pointer to rivafb_info object containing info for current riva board&n; *&n; * DESCRIPTION:&n; * Set a single color register. The values supplied have a 16 bit&n; * magnitude.&n; * Return != 0 for invalid regno.&n; *&n; * CALLED FROM:&n; * fbcmap.c:fb_set_cmap()&n; *&t;fbgen.c:fbgen_get_cmap()&n; *&t;fbgen.c:fbgen_install_cmap()&n; *&t;&t;fbgen.c:fbgen_set_var()&n; *&t;&t;fbgen.c:fbgen_switch()&n; *&t;&t;fbgen.c:fbgen_blank()&n; *&t;fbgen.c:fbgen_blank()&n; */
DECL|function|riva_setcolreg
r_static
r_int
id|riva_setcolreg
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|rivafb_info
op_star
id|rivainfo
op_assign
(paren
r_struct
id|rivafb_info
op_star
)paren
id|info
suffix:semicolon
r_struct
id|display
op_star
id|p
suffix:semicolon
r_int
id|shift
op_assign
l_int|8
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|rivainfo-&gt;currcon_display
op_ne
l_int|NULL
)paren
suffix:semicolon
id|p
op_assign
id|rivainfo-&gt;currcon_display
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
id|riva_get_cmap_len
c_func
(paren
op_amp
id|p-&gt;var
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|rivainfo-&gt;palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|rivainfo-&gt;palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|rivainfo-&gt;palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;var.grayscale
)paren
(brace
multiline_comment|/* gray = 0.30*R + 0.59*G + 0.11*B */
id|red
op_assign
id|green
op_assign
id|blue
op_assign
(paren
id|red
op_star
l_int|77
op_plus
id|green
op_star
l_int|151
op_plus
id|blue
op_star
l_int|28
)paren
op_rshift
l_int|8
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rivainfo-&gt;riva.Architecture
)paren
(brace
r_case
l_int|3
suffix:colon
id|shift
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_case
l_int|5
suffix:colon
id|shift
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|p-&gt;var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
multiline_comment|/* &quot;transparent&quot; stuff is completely ignored. */
id|riva_wclut
(paren
id|regno
comma
id|red
op_rshift
id|shift
comma
id|green
op_rshift
id|shift
comma
id|blue
op_rshift
id|shift
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* FBCON_HAS_CFB8 */
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
m_assert
(paren
id|regno
OL
l_int|16
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PREP
id|rivainfo-&gt;con_cmap.cfb16
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xf800
)paren
op_rshift
l_int|9
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xf800
)paren
op_rshift
l_int|14
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xf800
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf800
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
macro_line|#else
id|rivainfo-&gt;con_cmap.cfb16
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xf800
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xf800
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf800
)paren
op_rshift
l_int|11
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* FBCON_HAS_CFB16 */
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|32
suffix:colon
m_assert
(paren
id|regno
OL
l_int|16
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PREP
id|rivainfo-&gt;con_cmap.cfb32
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xff00
)paren
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xff00
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
macro_line|#else
id|rivainfo-&gt;con_cmap.cfb32
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xff00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xff00
)paren
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* FBCON_HAS_CFB32 */
r_default
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * riva_load_video_mode()&n; *&n; * calculate some timings and then send em off to riva_load_state()&n; */
DECL|function|riva_load_video_mode
r_static
r_void
id|riva_load_video_mode
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
comma
r_struct
id|fb_var_screeninfo
op_star
id|video_mode
)paren
(brace
r_struct
id|riva_regs
id|newmode
suffix:semicolon
r_int
id|bpp
comma
id|width
comma
id|hDisplaySize
comma
id|hDisplay
comma
id|hStart
comma
id|hEnd
comma
id|hTotal
comma
id|height
comma
id|vDisplay
comma
id|vStart
comma
id|vEnd
comma
id|vTotal
comma
id|dotClock
suffix:semicolon
multiline_comment|/* time to calculate */
id|bpp
op_assign
id|video_mode-&gt;bits_per_pixel
suffix:semicolon
id|width
op_assign
id|hDisplaySize
op_assign
id|video_mode-&gt;xres
suffix:semicolon
id|hDisplay
op_assign
(paren
id|hDisplaySize
op_div
l_int|8
)paren
op_minus
l_int|1
suffix:semicolon
id|hStart
op_assign
(paren
id|hDisplaySize
op_plus
id|video_mode-&gt;right_margin
)paren
op_div
l_int|8
op_plus
l_int|2
suffix:semicolon
id|hEnd
op_assign
(paren
id|hDisplaySize
op_plus
id|video_mode-&gt;right_margin
op_plus
id|video_mode-&gt;hsync_len
)paren
op_div
l_int|8
op_minus
l_int|1
suffix:semicolon
id|hTotal
op_assign
(paren
id|hDisplaySize
op_plus
id|video_mode-&gt;right_margin
op_plus
id|video_mode-&gt;hsync_len
op_plus
id|video_mode-&gt;left_margin
)paren
op_div
l_int|8
op_minus
l_int|1
suffix:semicolon
id|height
op_assign
id|video_mode-&gt;yres
suffix:semicolon
id|vDisplay
op_assign
id|video_mode-&gt;yres
op_minus
l_int|1
suffix:semicolon
id|vStart
op_assign
id|video_mode-&gt;yres
op_plus
id|video_mode-&gt;lower_margin
op_minus
l_int|1
suffix:semicolon
id|vEnd
op_assign
id|video_mode-&gt;yres
op_plus
id|video_mode-&gt;lower_margin
op_plus
id|video_mode-&gt;vsync_len
op_minus
l_int|1
suffix:semicolon
id|vTotal
op_assign
id|video_mode-&gt;yres
op_plus
id|video_mode-&gt;lower_margin
op_plus
id|video_mode-&gt;vsync_len
op_plus
id|video_mode-&gt;upper_margin
op_plus
l_int|2
suffix:semicolon
id|dotClock
op_assign
l_int|1000000000
op_div
id|video_mode-&gt;pixclock
suffix:semicolon
id|memcpy
(paren
op_amp
id|newmode
comma
op_amp
id|reg_template
comma
r_sizeof
(paren
r_struct
id|riva_regs
)paren
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x0
)braket
op_assign
id|Set8Bits
(paren
id|hTotal
op_minus
l_int|4
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x1
)braket
op_assign
id|Set8Bits
(paren
id|hDisplay
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x2
)braket
op_assign
id|Set8Bits
(paren
id|hDisplay
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x3
)braket
op_assign
id|SetBitField
(paren
id|hTotal
comma
l_int|4
suffix:colon
l_int|0
comma
l_int|4
suffix:colon
l_int|0
)paren
op_or
id|SetBit
(paren
l_int|7
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x4
)braket
op_assign
id|Set8Bits
(paren
id|hStart
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x5
)braket
op_assign
id|SetBitField
(paren
id|hTotal
comma
l_int|5
suffix:colon
l_int|5
comma
l_int|7
suffix:colon
l_int|7
)paren
op_or
id|SetBitField
(paren
id|hEnd
comma
l_int|4
suffix:colon
l_int|0
comma
l_int|4
suffix:colon
l_int|0
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x6
)braket
op_assign
id|SetBitField
(paren
id|vTotal
comma
l_int|7
suffix:colon
l_int|0
comma
l_int|7
suffix:colon
l_int|0
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x7
)braket
op_assign
id|SetBitField
(paren
id|vTotal
comma
l_int|8
suffix:colon
l_int|8
comma
l_int|0
suffix:colon
l_int|0
)paren
op_or
id|SetBitField
(paren
id|vDisplay
comma
l_int|8
suffix:colon
l_int|8
comma
l_int|1
suffix:colon
l_int|1
)paren
op_or
id|SetBitField
(paren
id|vStart
comma
l_int|8
suffix:colon
l_int|8
comma
l_int|2
suffix:colon
l_int|2
)paren
op_or
id|SetBitField
(paren
id|vDisplay
comma
l_int|8
suffix:colon
l_int|8
comma
l_int|3
suffix:colon
l_int|3
)paren
op_or
id|SetBit
(paren
l_int|4
)paren
op_or
id|SetBitField
(paren
id|vTotal
comma
l_int|9
suffix:colon
l_int|9
comma
l_int|5
suffix:colon
l_int|5
)paren
op_or
id|SetBitField
(paren
id|vDisplay
comma
l_int|9
suffix:colon
l_int|9
comma
l_int|6
suffix:colon
l_int|6
)paren
op_or
id|SetBitField
(paren
id|vStart
comma
l_int|9
suffix:colon
l_int|9
comma
l_int|7
suffix:colon
l_int|7
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x9
)braket
op_assign
id|SetBitField
(paren
id|vDisplay
comma
l_int|9
suffix:colon
l_int|9
comma
l_int|5
suffix:colon
l_int|5
)paren
op_or
id|SetBit
(paren
l_int|6
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x10
)braket
op_assign
id|Set8Bits
(paren
id|vStart
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x11
)braket
op_assign
id|SetBitField
(paren
id|vEnd
comma
l_int|3
suffix:colon
l_int|0
comma
l_int|3
suffix:colon
l_int|0
)paren
op_or
id|SetBit
(paren
l_int|5
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x12
)braket
op_assign
id|Set8Bits
(paren
id|vDisplay
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x13
)braket
op_assign
(paren
(paren
id|width
op_div
l_int|8
)paren
op_star
(paren
id|bpp
op_div
l_int|8
)paren
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x15
)braket
op_assign
id|Set8Bits
(paren
id|vDisplay
)paren
suffix:semicolon
id|newmode.crtc
(braket
l_int|0x16
)braket
op_assign
id|Set8Bits
(paren
id|vTotal
op_plus
l_int|1
)paren
suffix:semicolon
id|newmode.ext.bpp
op_assign
id|bpp
suffix:semicolon
id|newmode.ext.width
op_assign
id|width
suffix:semicolon
id|newmode.ext.height
op_assign
id|height
suffix:semicolon
id|rinfo-&gt;riva.CalcStateExt
(paren
op_amp
id|rinfo-&gt;riva
comma
op_amp
id|newmode.ext
comma
id|bpp
comma
id|width
comma
id|hDisplaySize
comma
id|hDisplay
comma
id|hStart
comma
id|hEnd
comma
id|hTotal
comma
id|height
comma
id|vDisplay
comma
id|vStart
comma
id|vEnd
comma
id|vTotal
comma
id|dotClock
)paren
suffix:semicolon
id|rinfo-&gt;initial_state
op_assign
id|newmode
suffix:semicolon
id|riva_load_state
(paren
id|rinfo
comma
op_amp
id|newmode
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/*&n;     *  Modularization&n;     */
DECL|variable|rivafb_driver
r_static
r_struct
id|pci_driver
id|rivafb_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;rivafb&quot;
comma
id|id_table
suffix:colon
id|rivafb_pci_tbl
comma
id|probe
suffix:colon
id|rivafb_init_one
comma
id|remove
suffix:colon
id|rivafb_remove_one
comma
)brace
suffix:semicolon
DECL|function|rivafb_init
r_int
id|__init
id|rivafb_init
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
(paren
op_amp
id|rivafb_driver
)paren
suffix:semicolon
)brace
DECL|function|rivafb_exit
r_static
r_void
id|__exit
id|rivafb_exit
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|rivafb_driver
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|rivafb_init
id|module_init
c_func
(paren
id|rivafb_init
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* MODULE */
DECL|variable|rivafb_exit
id|module_exit
c_func
(paren
id|rivafb_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ani Joshi, maintainer&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Framebuffer driver for nVidia Riva 128, TNT, TNT2&quot;
)paren
suffix:semicolon
multiline_comment|/* from GGI */
DECL|function|riva_save_state
r_static
r_void
id|riva_save_state
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
comma
r_struct
id|riva_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
id|outb
(paren
id|rinfo-&gt;riva.LockUnlockIndex
comma
id|rinfo-&gt;riva.LockUnlockIO
)paren
suffix:semicolon
id|outb
(paren
l_int|0x57
comma
id|rinfo-&gt;riva.LockUnlockIO
op_plus
l_int|1
)paren
suffix:semicolon
id|rinfo-&gt;riva.UnloadStateExt
(paren
op_amp
id|rinfo-&gt;riva
comma
op_amp
id|regs-&gt;ext
)paren
suffix:semicolon
id|regs-&gt;misc_output
op_assign
id|io_in8
(paren
l_int|0x3CC
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CRT_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io_out8
(paren
id|i
comma
l_int|0x3D4
)paren
suffix:semicolon
id|regs-&gt;crtc
(braket
id|i
)braket
op_assign
id|io_in8
(paren
l_int|0x3D5
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ATC_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io_out8
(paren
id|i
comma
l_int|0x3C0
)paren
suffix:semicolon
id|regs-&gt;attr
(braket
id|i
)braket
op_assign
id|io_in8
(paren
l_int|0x3C1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_GRC_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io_out8
(paren
id|i
comma
l_int|0x3CE
)paren
suffix:semicolon
id|regs-&gt;gra
(braket
id|i
)braket
op_assign
id|io_in8
(paren
l_int|0x3CF
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_SEQ_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io_out8
(paren
id|i
comma
l_int|0x3C4
)paren
suffix:semicolon
id|regs-&gt;seq
(braket
id|i
)braket
op_assign
id|io_in8
(paren
l_int|0x3C5
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* from GGI */
r_static
DECL|function|riva_load_state
r_void
id|riva_load_state
(paren
r_struct
id|rivafb_info
op_star
id|rinfo
comma
r_struct
id|riva_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
id|RIVA_HW_STATE
op_star
id|state
op_assign
op_amp
id|regs-&gt;ext
suffix:semicolon
id|io_out8
(paren
l_int|0x11
comma
l_int|0x3D4
)paren
suffix:semicolon
id|io_out8
(paren
l_int|0x00
comma
l_int|0x3D5
)paren
suffix:semicolon
id|outb
(paren
id|rinfo-&gt;riva.LockUnlockIndex
comma
id|rinfo-&gt;riva.LockUnlockIO
)paren
suffix:semicolon
id|outb
(paren
l_int|0x57
comma
id|rinfo-&gt;riva.LockUnlockIO
op_plus
l_int|1
)paren
suffix:semicolon
id|rinfo-&gt;riva.LoadStateExt
(paren
op_amp
id|rinfo-&gt;riva
comma
id|state
)paren
suffix:semicolon
id|io_out8
(paren
id|regs-&gt;misc_output
comma
l_int|0x3C2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CRT_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|0x19
)paren
(brace
id|io_out8
(paren
id|i
comma
l_int|0x3D4
)paren
suffix:semicolon
id|io_out8
(paren
id|regs-&gt;crtc
(braket
id|i
)braket
comma
l_int|0x3D5
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|i
)paren
(brace
r_case
l_int|0x19
suffix:colon
r_case
l_int|0x20
suffix:colon
r_case
l_int|0x21
suffix:colon
r_case
l_int|0x22
suffix:colon
r_case
l_int|0x23
suffix:colon
r_case
l_int|0x24
suffix:colon
r_case
l_int|0x25
suffix:colon
r_case
l_int|0x26
suffix:colon
r_case
l_int|0x27
suffix:colon
r_case
l_int|0x28
suffix:colon
r_case
l_int|0x29
suffix:colon
r_case
l_int|0x2a
suffix:colon
r_case
l_int|0x2b
suffix:colon
r_case
l_int|0x2c
suffix:colon
r_case
l_int|0x2d
suffix:colon
r_case
l_int|0x2e
suffix:colon
r_case
l_int|0x2f
suffix:colon
r_case
l_int|0x30
suffix:colon
r_case
l_int|0x31
suffix:colon
r_case
l_int|0x32
suffix:colon
r_case
l_int|0x33
suffix:colon
r_case
l_int|0x34
suffix:colon
r_case
l_int|0x35
suffix:colon
r_case
l_int|0x36
suffix:colon
r_case
l_int|0x37
suffix:colon
r_case
l_int|0x38
suffix:colon
r_case
l_int|0x39
suffix:colon
r_case
l_int|0x3a
suffix:colon
r_case
l_int|0x3b
suffix:colon
r_case
l_int|0x3c
suffix:colon
r_case
l_int|0x3d
suffix:colon
r_case
l_int|0x3e
suffix:colon
r_case
l_int|0x3f
suffix:colon
r_case
l_int|0x40
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|io_out8
(paren
id|i
comma
l_int|0x3D4
)paren
suffix:semicolon
id|io_out8
(paren
id|regs-&gt;crtc
(braket
id|i
)braket
comma
l_int|0x3D5
)paren
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ATC_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io_out8
(paren
id|i
comma
l_int|0x3C0
)paren
suffix:semicolon
id|io_out8
(paren
id|regs-&gt;attr
(braket
id|i
)braket
comma
l_int|0x3C0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_GRC_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io_out8
(paren
id|i
comma
l_int|0x3CE
)paren
suffix:semicolon
id|io_out8
(paren
id|regs-&gt;gra
(braket
id|i
)braket
comma
l_int|0x3CF
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_SEQ_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io_out8
(paren
id|i
comma
l_int|0x3C4
)paren
suffix:semicolon
id|io_out8
(paren
id|regs-&gt;seq
(braket
id|i
)braket
comma
l_int|0x3C5
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * riva_board_list_add&n; * @board_list: Root node of list of boards&n; * @new_node: New node to be added&n; *&n; * DESCRIPTION:&n; * Adds @new_node to the list referenced by @board_list&n; *&n; * RETURNS:&n; * New root node&n; */
r_static
DECL|function|riva_board_list_add
r_struct
id|rivafb_info
op_star
id|riva_board_list_add
(paren
r_struct
id|rivafb_info
op_star
id|board_list
comma
r_struct
id|rivafb_info
op_star
id|new_node
)paren
(brace
r_struct
id|rivafb_info
op_star
id|i_p
op_assign
id|board_list
suffix:semicolon
id|new_node-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|board_list
op_eq
l_int|NULL
)paren
r_return
id|new_node
suffix:semicolon
r_while
c_loop
(paren
id|i_p-&gt;next
op_ne
l_int|NULL
)paren
id|i_p
op_assign
id|i_p-&gt;next
suffix:semicolon
id|i_p-&gt;next
op_assign
id|new_node
suffix:semicolon
r_return
id|board_list
suffix:semicolon
)brace
multiline_comment|/**&n; * riva_board_list_del&n; * @board_list: Root node of list of boards&n; * @del_node: Node to be removed&n; *&n; * DESCRIPTION:&n; * Removes @del_node from the list referenced by @board_list&n; *&n; * RETURNS:&n; * New root node&n; */
r_static
DECL|function|riva_board_list_del
r_struct
id|rivafb_info
op_star
id|riva_board_list_del
(paren
r_struct
id|rivafb_info
op_star
id|board_list
comma
r_struct
id|rivafb_info
op_star
id|del_node
)paren
(brace
r_struct
id|rivafb_info
op_star
id|i_p
op_assign
id|board_list
suffix:semicolon
r_if
c_cond
(paren
id|board_list
op_eq
id|del_node
)paren
r_return
id|del_node-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|i_p-&gt;next
op_ne
id|del_node
)paren
id|i_p
op_assign
id|i_p-&gt;next
suffix:semicolon
id|i_p-&gt;next
op_assign
id|del_node-&gt;next
suffix:semicolon
r_return
id|board_list
suffix:semicolon
)brace
eof
