multiline_comment|/*&n; *  linux/drivers/video/fbcon.c -- Low level frame buffer based console driver&n; *&n; *&t;Copyright (C) 1995 Geert Uytterhoeven&n; *&n; *&n; *  This file is based on the original Amiga console driver (amicon.c):&n; *&n; *&t;Copyright (C) 1993 Hamish Macdonald&n; *&t;&t;&t;   Greg Harp&n; *&t;Copyright (C) 1994 David Carter [carter@compsci.bristol.ac.uk]&n; *&n; *&t;      with work by William Rucklidge (wjr@cs.cornell.edu)&n; *&t;&t;&t;   Geert Uytterhoeven&n; *&t;&t;&t;   Jes Sorensen (jds@kom.auc.dk)&n; *&t;&t;&t;   Martin Apel&n; *&n; *  and on the original Atari console driver (atacon.c):&n; *&n; *&t;Copyright (C) 1993 Bjoern Brauel&n; *&t;&t;&t;   Roman Hodek&n; *&n; *&t;      with work by Guenther Kelleter&n; *&t;&t;&t;   Martin Schaller&n; *&t;&t;&t;   Andreas Schwab&n; *&n; *&n; *  The low level operations for the various display memory organizations are&n; *  now in separate source files.&n; *&n; *  Currently the following organizations are supported:&n; *&n; *    o afb&t;&t;&t;Amiga bitplanes&n; *    o cfb{2,4,8,16,24,32}&t;Packed pixels&n; *    o ilbm&t;&t;&t;Amiga interleaved bitplanes&n; *    o iplan2p[248]&t;&t;Atari interleaved bitplanes&n; *    o mfb&t;&t;&t;Monochrome&n; *&n; *  To do:&n; *&n; *    - Implement 16 plane mode (iplan2p16)&n; *    - Hardware cursor&n; *&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
DECL|macro|FBCONDEBUG
macro_line|#undef FBCONDEBUG
DECL|macro|SUPPORT_SCROLLBACK
mdefine_line|#define SUPPORT_SCROLLBACK&t;0
DECL|macro|FLASHING_CURSOR
mdefine_line|#define FLASHING_CURSOR&t;&t;1
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;&t;/* MSch: for IRQ probe */
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#ifdef CONFIG_AMIGA
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;asm/amigaints.h&gt;
macro_line|#endif /* CONFIG_AMIGA */
macro_line|#ifdef CONFIG_ATARI
macro_line|#include &lt;asm/atariints.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_MAC
macro_line|#include &lt;asm/macints.h&gt;
macro_line|#endif
macro_line|#ifdef __mc68000__
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/linux_logo.h&gt;
macro_line|#include &quot;fbcon.h&quot;
macro_line|#include &quot;fbcon-mac.h&quot;&t;/* for 6x11 font on mac */
macro_line|#include &quot;font.h&quot;
macro_line|#ifdef FBCONDEBUG
DECL|macro|DPRINTK
macro_line|#  define DPRINTK(fmt, args...) printk(KERN_DEBUG &quot;%s: &quot; fmt, __FUNCTION__ , ## args)
macro_line|#else
DECL|macro|DPRINTK
macro_line|#  define DPRINTK(fmt, args...)
macro_line|#endif
DECL|variable|fb_display
r_struct
id|display
id|fb_display
(braket
id|MAX_NR_CONSOLES
)braket
suffix:semicolon
multiline_comment|/* ++Geert: Sorry, no hardware cursor support at the moment;&n;   use Atari alike software cursor */
macro_line|#if FLASHING_CURSOR
DECL|variable|cursor_drawn
r_static
r_int
id|cursor_drawn
op_assign
l_int|0
suffix:semicolon
DECL|macro|CURSOR_DRAW_DELAY
mdefine_line|#define CURSOR_DRAW_DELAY&t;&t;(2)
multiline_comment|/* # VBL ints between cursor state changes */
DECL|macro|AMIGA_CURSOR_BLINK_RATE
mdefine_line|#define AMIGA_CURSOR_BLINK_RATE&t;&t;(20)
DECL|macro|ATARI_CURSOR_BLINK_RATE
mdefine_line|#define ATARI_CURSOR_BLINK_RATE&t;&t;(42)
DECL|macro|MAC_CURSOR_BLINK_RATE
mdefine_line|#define MAC_CURSOR_BLINK_RATE&t;&t;(32)
DECL|macro|DEFAULT_CURSOR_BLINK_RATE
mdefine_line|#define DEFAULT_CURSOR_BLINK_RATE&t;(20)
DECL|variable|vbl_cursor_cnt
r_static
r_int
id|vbl_cursor_cnt
op_assign
l_int|0
suffix:semicolon
DECL|variable|cursor_on
r_static
r_int
id|cursor_on
op_assign
l_int|0
suffix:semicolon
DECL|variable|cursor_blink_rate
r_static
r_int
id|cursor_blink_rate
suffix:semicolon
DECL|function|CURSOR_UNDRAWN
r_static
id|__inline__
r_int
id|CURSOR_UNDRAWN
c_func
(paren
r_void
)paren
(brace
r_int
id|cursor_was_drawn
suffix:semicolon
id|vbl_cursor_cnt
op_assign
l_int|0
suffix:semicolon
id|cursor_was_drawn
op_assign
id|cursor_drawn
suffix:semicolon
id|cursor_drawn
op_assign
l_int|0
suffix:semicolon
r_return
id|cursor_was_drawn
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *  Scroll Method&n; */
DECL|macro|SCROLL_YWRAP
mdefine_line|#define SCROLL_YWRAP&t;(0)
DECL|macro|SCROLL_YPAN
mdefine_line|#define SCROLL_YPAN&t;(1)
DECL|macro|SCROLL_YMOVE
mdefine_line|#define SCROLL_YMOVE&t;(2)
DECL|macro|divides
mdefine_line|#define divides(a, b)&t;((!(a) || (b)%(a)) ? 0 : 1)
multiline_comment|/*&n; *  Interface used by the world&n; */
r_static
r_int
r_int
id|fbcon_startup
c_func
(paren
r_int
r_int
id|kmem_start
comma
r_const
r_char
op_star
op_star
id|display_desc
)paren
suffix:semicolon
r_static
r_void
id|fbcon_init
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
suffix:semicolon
r_static
r_void
id|fbcon_deinit
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
suffix:semicolon
r_static
r_int
id|fbcon_changevar
c_func
(paren
r_int
id|con
)paren
suffix:semicolon
r_static
r_void
id|fbcon_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
suffix:semicolon
r_static
r_void
id|fbcon_putc
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|c
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
suffix:semicolon
r_static
r_void
id|fbcon_putcs
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_const
r_char
op_star
id|s
comma
r_int
id|count
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
suffix:semicolon
r_static
r_void
id|fbcon_cursor
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_void
id|fbcon_scroll
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|t
comma
r_int
id|b
comma
r_int
id|dir
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|fbcon_bmove
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
suffix:semicolon
r_static
r_int
id|fbcon_switch
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
suffix:semicolon
r_static
r_int
id|fbcon_blank
c_func
(paren
r_int
id|blank
)paren
suffix:semicolon
r_static
r_int
id|fbcon_get_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
op_star
id|w
comma
r_int
op_star
id|h
comma
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|fbcon_set_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|w
comma
r_int
id|h
comma
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|fbcon_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
r_char
op_star
id|table
)paren
suffix:semicolon
r_static
r_int
id|fbcon_scrolldelta
c_func
(paren
r_int
id|lines
)paren
suffix:semicolon
r_static
r_int
id|fbcon_set_mode
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|mode
)paren
suffix:semicolon
multiline_comment|/*&n; *  Internal routines&n; */
r_static
r_void
id|fbcon_setup
c_func
(paren
r_int
id|con
comma
r_int
id|setcol
comma
r_int
id|init
)paren
suffix:semicolon
r_static
id|__inline__
r_int
id|real_y
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|ypos
)paren
suffix:semicolon
macro_line|#if FLASHING_CURSOR
r_static
r_void
id|fbcon_vbl_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dummy
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
macro_line|#endif
r_static
id|__inline__
r_void
id|updatescrollmode
c_func
(paren
r_struct
id|display
op_star
id|p
)paren
suffix:semicolon
macro_line|#if SUPPORT_SCROLLBACK
r_static
id|__inline__
r_void
id|ywrap_up
c_func
(paren
r_int
id|unit
comma
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|ywrap_down
c_func
(paren
r_int
id|unit
comma
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
suffix:semicolon
macro_line|#else
r_static
id|__inline__
r_void
id|ywrap_up
c_func
(paren
r_int
id|unit
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|ywrap_down
c_func
(paren
r_int
id|unit
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
suffix:semicolon
macro_line|#endif
r_static
id|__inline__
r_void
id|ypan_up
c_func
(paren
r_int
id|unit
comma
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|ypan_down
c_func
(paren
r_int
id|unit
comma
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|fbcon_bmove_rec
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
comma
id|u_int
id|y_break
)paren
suffix:semicolon
r_static
r_int
id|fbcon_show_logo
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#if FLASHING_CURSOR
macro_line|#ifdef CONFIG_MAC
multiline_comment|/*&n; * On the Macintoy, there may or may not be a working VBL int. We need to prob&n; */
DECL|variable|vbl_detected
r_static
r_int
id|vbl_detected
op_assign
l_int|0
suffix:semicolon
DECL|function|fbcon_vbl_detect
r_static
r_void
id|fbcon_vbl_detect
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dummy
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
id|vbl_detected
op_increment
suffix:semicolon
)brace
macro_line|#endif
r_static
r_void
id|cursor_timer_handler
c_func
(paren
r_int
r_int
id|dev_addr
)paren
suffix:semicolon
DECL|variable|cursor_timer
r_static
r_struct
id|timer_list
id|cursor_timer
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
l_int|0L
comma
id|cursor_timer_handler
)brace
suffix:semicolon
DECL|function|cursor_timer_handler
r_static
r_void
id|cursor_timer_handler
c_func
(paren
r_int
r_int
id|dev_addr
)paren
(brace
id|fbcon_vbl_handler
c_func
(paren
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|cursor_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|50
suffix:semicolon
id|cursor_timer.data
op_assign
l_int|0
suffix:semicolon
id|cursor_timer.next
op_assign
id|cursor_timer.next
op_assign
l_int|NULL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cursor_timer
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *  Low Level Operations&n; */
DECL|variable|fbcon_dummy
r_static
r_struct
id|display_switch
id|fbcon_dummy
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
r_int
id|fbcon_startup
c_func
(paren
r_int
r_int
id|kmem_start
comma
r_const
r_char
op_star
op_star
id|display_desc
)paren
)paren
(brace
r_int
id|irqres
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Probe all frame buffer devices */
id|kmem_start
op_assign
id|probe_framebuffers
c_func
(paren
id|kmem_start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|num_registered_fb
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;no framebuffer registered&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|kmem_start
suffix:semicolon
)brace
op_star
id|display_desc
op_assign
l_string|&quot;frame buffer device&quot;
suffix:semicolon
macro_line|#ifdef CONFIG_AMIGA
r_if
c_cond
(paren
id|MACH_IS_AMIGA
)paren
(brace
id|cursor_blink_rate
op_assign
id|AMIGA_CURSOR_BLINK_RATE
suffix:semicolon
id|irqres
op_assign
id|request_irq
c_func
(paren
id|IRQ_AMIGA_VERTB
comma
id|fbcon_vbl_handler
comma
l_int|0
comma
l_string|&quot;console/cursor&quot;
comma
id|fbcon_vbl_handler
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_AMIGA */
macro_line|#ifdef CONFIG_ATARI
r_if
c_cond
(paren
id|MACH_IS_ATARI
)paren
(brace
id|cursor_blink_rate
op_assign
id|ATARI_CURSOR_BLINK_RATE
suffix:semicolon
id|irqres
op_assign
id|request_irq
c_func
(paren
id|IRQ_AUTO_4
comma
id|fbcon_vbl_handler
comma
id|IRQ_TYPE_PRIO
comma
l_string|&quot;console/cursor&quot;
comma
id|fbcon_vbl_handler
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ATARI */
macro_line|#ifdef CONFIG_MAC
multiline_comment|/*&n;     * On a Macintoy, the VBL interrupt may or may not be active. &n;     * As interrupt based cursor is more reliable and race free, we &n;     * probe for VBL interrupts.&n;     */
r_if
c_cond
(paren
id|MACH_IS_MAC
)paren
(brace
r_int
id|ct
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;        * Probe for VBL: set temp. handler ...&n;        */
id|irqres
op_assign
id|request_irq
c_func
(paren
id|IRQ_MAC_VBL
comma
id|fbcon_vbl_detect
comma
l_int|0
comma
l_string|&quot;console/cursor&quot;
comma
id|fbcon_vbl_detect
)paren
suffix:semicolon
multiline_comment|/*&n;        * ... and spin for 20 ms ...&n;        */
r_while
c_loop
(paren
op_logical_neg
id|vbl_detected
op_logical_and
op_increment
id|ct
OL
l_int|1000
)paren
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ct
op_eq
l_int|1000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;fbcon_startup: No VBL detected, using timer based cursor.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vbl_detected
)paren
(brace
multiline_comment|/*&n;          * interrupt based cursor ok&n;          */
id|cursor_blink_rate
op_assign
id|MAC_CURSOR_BLINK_RATE
suffix:semicolon
id|irqres
op_assign
id|request_irq
c_func
(paren
id|IRQ_MAC_VBL
comma
id|fbcon_vbl_handler
comma
l_int|0
comma
l_string|&quot;console/cursor&quot;
comma
id|fbcon_vbl_handler
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;           * VBL not detected: fall through, use timer based cursor&n;           */
id|irqres
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* free interrupt here ?? */
)brace
)brace
macro_line|#endif /* CONFIG_MAC */
r_if
c_cond
(paren
id|irqres
)paren
(brace
id|cursor_blink_rate
op_assign
id|DEFAULT_CURSOR_BLINK_RATE
suffix:semicolon
id|cursor_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|50
suffix:semicolon
id|cursor_timer.data
op_assign
l_int|0
suffix:semicolon
id|cursor_timer.next
op_assign
id|cursor_timer.prev
op_assign
l_int|NULL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cursor_timer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|console_show_logo
)paren
id|console_show_logo
op_assign
id|fbcon_show_logo
suffix:semicolon
r_return
id|kmem_start
suffix:semicolon
)brace
DECL|function|fbcon_init
r_static
r_void
id|fbcon_init
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
suffix:semicolon
multiline_comment|/* on which frame buffer will we open this console? */
id|info
op_assign
id|registered_fb
(braket
(paren
r_int
)paren
id|con2fb_map
(braket
id|unit
)braket
)braket
suffix:semicolon
id|info-&gt;changevar
op_assign
op_amp
id|fbcon_changevar
suffix:semicolon
id|fb_display
(braket
id|unit
)braket
op_assign
op_star
(paren
id|info-&gt;disp
)paren
suffix:semicolon
multiline_comment|/* copy from default */
id|DPRINTK
c_func
(paren
l_string|&quot;mode:   %s&bslash;n&quot;
comma
id|info-&gt;modename
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;visual: %d&bslash;n&quot;
comma
id|fb_display
(braket
id|unit
)braket
dot
id|visual
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;res:    %dx%d-%d&bslash;n&quot;
comma
id|fb_display
(braket
id|unit
)braket
dot
id|var.xres
comma
id|fb_display
(braket
id|unit
)braket
dot
id|var.yres
comma
id|fb_display
(braket
id|unit
)braket
dot
id|var.bits_per_pixel
)paren
suffix:semicolon
id|fb_display
(braket
id|unit
)braket
dot
id|conp
op_assign
id|conp
suffix:semicolon
id|fb_display
(braket
id|unit
)braket
dot
id|fb_info
op_assign
id|info
suffix:semicolon
id|fbcon_setup
c_func
(paren
id|unit
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|fbcon_deinit
r_static
r_void
id|fbcon_deinit
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
id|p-&gt;dispsw
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;conp
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|fbcon_changevar
r_static
r_int
id|fbcon_changevar
c_func
(paren
r_int
id|con
)paren
(brace
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|conp
)paren
id|fbcon_setup
c_func
(paren
id|con
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|updatescrollmode
r_static
id|__inline__
r_void
id|updatescrollmode
c_func
(paren
r_struct
id|display
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
id|divides
c_func
(paren
id|p-&gt;ywrapstep
comma
id|p-&gt;fontheight
)paren
op_logical_and
id|divides
c_func
(paren
id|p-&gt;fontheight
comma
id|p-&gt;var.yres_virtual
)paren
)paren
id|p-&gt;scrollmode
op_assign
id|SCROLL_YWRAP
suffix:semicolon
r_else
r_if
c_cond
(paren
id|divides
c_func
(paren
id|p-&gt;ypanstep
comma
id|p-&gt;fontheight
)paren
op_logical_and
id|p-&gt;var.yres_virtual
op_ge
id|p-&gt;var.yres
op_plus
id|p-&gt;fontheight
)paren
id|p-&gt;scrollmode
op_assign
id|SCROLL_YPAN
suffix:semicolon
r_else
id|p-&gt;scrollmode
op_assign
id|SCROLL_YMOVE
suffix:semicolon
)brace
DECL|function|fbcon_setup
r_static
r_void
id|fbcon_setup
c_func
(paren
r_int
id|con
comma
r_int
id|setcol
comma
r_int
id|init
)paren
(brace
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
r_struct
id|vc_data
op_star
id|conp
op_assign
id|p-&gt;conp
suffix:semicolon
r_int
id|nr_rows
comma
id|nr_cols
suffix:semicolon
id|p-&gt;var.xoffset
op_assign
id|p-&gt;var.yoffset
op_assign
id|p-&gt;yscroll
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset wrap/pan */
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;fb_info-&gt;fontname
(braket
l_int|0
)braket
op_logical_or
op_logical_neg
id|findsoftfont
c_func
(paren
id|p-&gt;fb_info-&gt;fontname
comma
op_amp
id|p-&gt;fontwidth
comma
op_amp
id|p-&gt;fontheight
comma
op_amp
id|p-&gt;fontdata
)paren
op_logical_or
id|p-&gt;fontwidth
op_ne
l_int|8
)paren
id|getdefaultfont
c_func
(paren
id|p-&gt;var.xres
comma
id|p-&gt;var.yres
comma
l_int|NULL
comma
op_amp
id|p-&gt;fontwidth
comma
op_amp
id|p-&gt;fontheight
comma
op_amp
id|p-&gt;fontdata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;fontwidth
op_ne
l_int|8
)paren
(brace
macro_line|#ifdef CONFIG_MAC
r_if
c_cond
(paren
id|MACH_IS_MAC
)paren
multiline_comment|/* ++Geert: hack to make 6x11 fonts work on mac */
id|p-&gt;dispsw
op_assign
op_amp
id|fbcon_mac
suffix:semicolon
r_else
macro_line|#endif
(brace
multiline_comment|/* ++Geert: changed from panic() to `correct and continue&squot; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;fbcon_setup: No support for fontwidth != 8&quot;
)paren
suffix:semicolon
id|p-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
)brace
)brace
id|updatescrollmode
c_func
(paren
id|p
)paren
suffix:semicolon
id|nr_cols
op_assign
id|p-&gt;var.xres
op_div
id|p-&gt;fontwidth
suffix:semicolon
id|nr_rows
op_assign
id|p-&gt;var.yres
op_div
id|p-&gt;fontheight
suffix:semicolon
multiline_comment|/*&n;     *  ++guenther: console.c:vc_allocate() relies on initializing&n;     *  vc_{cols,rows}, but we must not set those if we are only&n;     *  resizing the console.&n;     */
r_if
c_cond
(paren
id|init
)paren
(brace
id|conp-&gt;vc_cols
op_assign
id|nr_cols
suffix:semicolon
id|conp-&gt;vc_rows
op_assign
id|nr_rows
suffix:semicolon
)brace
id|p-&gt;vrows
op_assign
id|p-&gt;var.yres_virtual
op_div
id|p-&gt;fontheight
suffix:semicolon
id|conp-&gt;vc_can_do_color
op_assign
id|p-&gt;var.bits_per_pixel
op_ne
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;dispsw
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;fbcon_setup: type %d (aux %d, depth %d) not &quot;
l_string|&quot;supported&bslash;n&quot;
comma
id|p-&gt;type
comma
id|p-&gt;type_aux
comma
id|p-&gt;var.bits_per_pixel
)paren
suffix:semicolon
id|p-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
)brace
id|p-&gt;dispsw
op_member_access_from_pointer
id|setup
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|setcol
)paren
(brace
id|p-&gt;fgcol
op_assign
id|p-&gt;var.bits_per_pixel
OG
l_int|2
ques
c_cond
l_int|7
suffix:colon
(paren
l_int|1
op_lshift
id|p-&gt;var.bits_per_pixel
)paren
op_minus
l_int|1
suffix:semicolon
id|p-&gt;bgcol
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|init
)paren
id|vc_resize_con
c_func
(paren
id|nr_rows
comma
id|nr_cols
comma
id|con
)paren
suffix:semicolon
)brace
multiline_comment|/* ====================================================================== */
multiline_comment|/*  fbcon_XXX routines - interface used by the world&n; *&n; *  This system is now divided into two levels because of complications&n; *  caused by hardware scrolling. Top level functions:&n; *&n; *&t;fbcon_bmove(), fbcon_clear(), fbcon_putc()&n; *&n; *  handles y values in range [0, scr_height-1] that correspond to real&n; *  screen positions. y_wrap shift means that first line of bitmap may be&n; *  anywhere on this display. These functions convert lineoffsets to&n; *  bitmap offsets and deal with the wrap-around case by splitting blits.&n; *&n; *&t;fbcon_bmove_physical_8()    -- These functions fast implementations&n; *&t;fbcon_clear_physical_8()    -- of original fbcon_XXX fns.&n; *&t;fbcon_putc_physical_8()&t;    -- (fontwidth != 8) may be added later&n; *&n; *  WARNING:&n; *&n; *  At the moment fbcon_putc() cannot blit across vertical wrap boundary&n; *  Implies should only really hardware scroll in rows. Only reason for&n; *  restriction is simplicity &amp; efficiency at the moment.&n; */
DECL|function|real_y
r_static
id|__inline__
r_int
id|real_y
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|ypos
)paren
(brace
r_int
id|rows
op_assign
id|p-&gt;vrows
suffix:semicolon
id|ypos
op_add_assign
id|p-&gt;yscroll
suffix:semicolon
r_return
id|ypos
OL
id|rows
ques
c_cond
id|ypos
suffix:colon
id|ypos
op_minus
id|rows
suffix:semicolon
)brace
DECL|function|fbcon_clear
r_static
r_void
id|fbcon_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
id|u_int
id|y_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;can_soft_blank
op_logical_and
id|console_blanked
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|height
op_logical_or
op_logical_neg
id|width
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sy
op_le
id|p-&gt;cursor_y
)paren
op_logical_and
(paren
id|p-&gt;cursor_y
OL
id|sy
op_plus
id|height
)paren
op_logical_and
(paren
id|sx
op_le
id|p-&gt;cursor_x
)paren
op_logical_and
(paren
id|p-&gt;cursor_x
OL
id|sx
op_plus
id|width
)paren
)paren
id|CURSOR_UNDRAWN
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Split blits that cross physical y_wrap boundary */
id|y_break
op_assign
id|p-&gt;vrows
op_minus
id|p-&gt;yscroll
suffix:semicolon
r_if
c_cond
(paren
id|sy
OL
id|y_break
op_logical_and
id|sy
op_plus
id|height
op_minus
l_int|1
op_ge
id|y_break
)paren
(brace
id|u_int
id|b
op_assign
id|y_break
op_minus
id|sy
suffix:semicolon
id|p-&gt;dispsw
op_member_access_from_pointer
id|clear
c_func
(paren
id|conp
comma
id|p
comma
id|real_y
c_func
(paren
id|p
comma
id|sy
)paren
comma
id|sx
comma
id|b
comma
id|width
)paren
suffix:semicolon
id|p-&gt;dispsw
op_member_access_from_pointer
id|clear
c_func
(paren
id|conp
comma
id|p
comma
id|real_y
c_func
(paren
id|p
comma
id|sy
op_plus
id|b
)paren
comma
id|sx
comma
id|height
op_minus
id|b
comma
id|width
)paren
suffix:semicolon
)brace
r_else
id|p-&gt;dispsw
op_member_access_from_pointer
id|clear
c_func
(paren
id|conp
comma
id|p
comma
id|real_y
c_func
(paren
id|p
comma
id|sy
)paren
comma
id|sx
comma
id|height
comma
id|width
)paren
suffix:semicolon
)brace
DECL|function|fbcon_putc
r_static
r_void
id|fbcon_putc
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|c
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;can_soft_blank
op_logical_and
id|console_blanked
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p-&gt;cursor_x
op_eq
id|xpos
)paren
op_logical_and
(paren
id|p-&gt;cursor_y
op_eq
id|ypos
)paren
)paren
id|CURSOR_UNDRAWN
c_func
(paren
)paren
suffix:semicolon
id|p-&gt;dispsw
op_member_access_from_pointer
id|putc
c_func
(paren
id|conp
comma
id|p
comma
id|c
comma
id|real_y
c_func
(paren
id|p
comma
id|ypos
)paren
comma
id|xpos
)paren
suffix:semicolon
)brace
DECL|function|fbcon_putcs
r_static
r_void
id|fbcon_putcs
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_const
r_char
op_star
id|s
comma
r_int
id|count
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;can_soft_blank
op_logical_and
id|console_blanked
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p-&gt;cursor_y
op_eq
id|ypos
)paren
op_logical_and
(paren
id|xpos
op_le
id|p-&gt;cursor_x
)paren
op_logical_and
(paren
id|p-&gt;cursor_x
OL
(paren
id|xpos
op_plus
id|count
)paren
)paren
)paren
id|CURSOR_UNDRAWN
c_func
(paren
)paren
suffix:semicolon
id|p-&gt;dispsw
op_member_access_from_pointer
id|putcs
c_func
(paren
id|conp
comma
id|p
comma
id|s
comma
id|count
comma
id|real_y
c_func
(paren
id|p
comma
id|ypos
)paren
comma
id|xpos
)paren
suffix:semicolon
)brace
DECL|function|fbcon_cursor
r_static
r_void
id|fbcon_cursor
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|mode
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
multiline_comment|/* Avoid flickering if there&squot;s no real change. */
r_if
c_cond
(paren
id|p-&gt;cursor_x
op_eq
id|conp-&gt;vc_x
op_logical_and
id|p-&gt;cursor_y
op_eq
id|conp-&gt;vc_y
op_logical_and
(paren
id|mode
op_eq
id|CM_ERASE
)paren
op_eq
op_logical_neg
id|cursor_on
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|CURSOR_UNDRAWN
(paren
)paren
)paren
id|p-&gt;dispsw
op_member_access_from_pointer
id|revc
c_func
(paren
id|p
comma
id|p-&gt;cursor_x
comma
id|real_y
c_func
(paren
id|p
comma
id|p-&gt;cursor_y
)paren
)paren
suffix:semicolon
id|p-&gt;cursor_x
op_assign
id|conp-&gt;vc_x
suffix:semicolon
id|p-&gt;cursor_y
op_assign
id|conp-&gt;vc_y
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|CM_ERASE
suffix:colon
id|cursor_on
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CM_MOVE
suffix:colon
r_case
id|CM_DRAW
suffix:colon
id|vbl_cursor_cnt
op_assign
id|CURSOR_DRAW_DELAY
suffix:semicolon
id|cursor_on
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#if FLASHING_CURSOR
DECL|function|fbcon_vbl_handler
r_static
r_void
id|fbcon_vbl_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dummy
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_struct
id|display
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cursor_on
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|vbl_cursor_cnt
op_logical_and
op_decrement
id|vbl_cursor_cnt
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Here no check is possible for console changing. The console&n;&t; * switching code should set vbl_cursor_cnt to an appropriate value.&n;&t; */
id|p
op_assign
op_amp
id|fb_display
(braket
id|fg_console
)braket
suffix:semicolon
id|p-&gt;dispsw
op_member_access_from_pointer
id|revc
c_func
(paren
id|p
comma
id|p-&gt;cursor_x
comma
id|real_y
c_func
(paren
id|p
comma
id|p-&gt;cursor_y
)paren
)paren
suffix:semicolon
id|cursor_drawn
op_xor_assign
l_int|1
suffix:semicolon
id|vbl_cursor_cnt
op_assign
id|cursor_blink_rate
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#if SUPPORT_SCROLLBACK
DECL|variable|scrollback_max
r_static
r_int
id|scrollback_max
op_assign
l_int|0
suffix:semicolon
DECL|variable|scrollback_current
r_static
r_int
id|scrollback_current
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if SUPPORT_SCROLLBACK
DECL|function|ywrap_up
r_static
id|__inline__
r_void
id|ywrap_up
c_func
(paren
r_int
id|unit
comma
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
macro_line|#else
r_static
id|__inline__
r_void
id|ywrap_up
c_func
(paren
r_int
id|unit
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
macro_line|#endif
(brace
id|p-&gt;yscroll
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;yscroll
op_ge
id|p-&gt;vrows
)paren
multiline_comment|/* Deal with wrap */
id|p-&gt;yscroll
op_sub_assign
id|p-&gt;vrows
suffix:semicolon
id|p-&gt;var.xoffset
op_assign
l_int|0
suffix:semicolon
id|p-&gt;var.yoffset
op_assign
id|p-&gt;yscroll
op_star
id|p-&gt;fontheight
suffix:semicolon
id|p-&gt;var.vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
id|p-&gt;fb_info
op_member_access_from_pointer
id|updatevar
c_func
(paren
id|unit
comma
id|p-&gt;fb_info
)paren
suffix:semicolon
macro_line|#if SUPPORT_SCROLLBACK
id|scrollback_max
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|scrollback_max
OG
id|p-&gt;vrows
op_minus
id|conp-&gt;vc_rows
)paren
id|scrollback_max
op_assign
id|p-&gt;vrows
op_minus
id|conp-&gt;vc_rows
suffix:semicolon
id|scrollback_current
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if SUPPORT_SCROLLBACK
DECL|function|ywrap_down
r_static
id|__inline__
r_void
id|ywrap_down
c_func
(paren
r_int
id|unit
comma
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
macro_line|#else
r_static
id|__inline__
r_void
id|ywrap_down
c_func
(paren
r_int
id|unit
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
macro_line|#endif
(brace
id|p-&gt;yscroll
op_sub_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;yscroll
OL
l_int|0
)paren
multiline_comment|/* Deal with wrap */
id|p-&gt;yscroll
op_add_assign
id|p-&gt;vrows
suffix:semicolon
id|p-&gt;var.xoffset
op_assign
l_int|0
suffix:semicolon
id|p-&gt;var.yoffset
op_assign
id|p-&gt;yscroll
op_star
id|p-&gt;fontheight
suffix:semicolon
id|p-&gt;var.vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
id|p-&gt;fb_info
op_member_access_from_pointer
id|updatevar
c_func
(paren
id|unit
comma
id|p-&gt;fb_info
)paren
suffix:semicolon
macro_line|#if SUPPORT_SCROLLBACK
id|scrollback_max
op_sub_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|scrollback_max
OL
l_int|0
)paren
id|scrollback_max
op_assign
l_int|0
suffix:semicolon
id|scrollback_current
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ypan_up
r_static
id|__inline__
r_void
id|ypan_up
c_func
(paren
r_int
id|unit
comma
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
(brace
id|p-&gt;yscroll
op_add_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;yscroll
op_plus
id|conp-&gt;vc_rows
OG
id|p-&gt;vrows
)paren
(brace
id|p-&gt;dispsw
op_member_access_from_pointer
id|bmove
c_func
(paren
id|p
comma
id|p-&gt;yscroll
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|conp-&gt;vc_rows
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|p-&gt;yscroll
op_assign
l_int|0
suffix:semicolon
)brace
id|p-&gt;var.xoffset
op_assign
l_int|0
suffix:semicolon
id|p-&gt;var.yoffset
op_assign
id|p-&gt;yscroll
op_star
id|p-&gt;fontheight
suffix:semicolon
id|p-&gt;var.vmode
op_and_assign
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
id|p-&gt;fb_info
op_member_access_from_pointer
id|updatevar
c_func
(paren
id|unit
comma
id|p-&gt;fb_info
)paren
suffix:semicolon
)brace
DECL|function|ypan_down
r_static
id|__inline__
r_void
id|ypan_down
c_func
(paren
r_int
id|unit
comma
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|count
)paren
(brace
id|p-&gt;yscroll
op_sub_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;yscroll
OL
l_int|0
)paren
(brace
id|p-&gt;yscroll
op_assign
id|p-&gt;vrows
op_minus
id|conp-&gt;vc_rows
suffix:semicolon
id|p-&gt;dispsw
op_member_access_from_pointer
id|bmove
c_func
(paren
id|p
comma
l_int|0
comma
l_int|0
comma
id|p-&gt;yscroll
op_plus
id|count
comma
l_int|0
comma
id|conp-&gt;vc_rows
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
)brace
id|p-&gt;var.xoffset
op_assign
l_int|0
suffix:semicolon
id|p-&gt;var.yoffset
op_assign
id|p-&gt;yscroll
op_star
id|p-&gt;fontheight
suffix:semicolon
id|p-&gt;var.vmode
op_and_assign
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
id|p-&gt;fb_info
op_member_access_from_pointer
id|updatevar
c_func
(paren
id|unit
comma
id|p-&gt;fb_info
)paren
suffix:semicolon
)brace
DECL|function|fbcon_scroll
r_static
r_void
id|fbcon_scroll
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|t
comma
r_int
id|b
comma
r_int
id|dir
comma
r_int
id|count
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;can_soft_blank
op_logical_and
id|console_blanked
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
suffix:semicolon
id|fbcon_cursor
c_func
(paren
id|conp
comma
id|CM_ERASE
)paren
suffix:semicolon
multiline_comment|/*&n;     * ++Geert: Only use ywrap/ypan if the console is in text mode&n;     */
r_switch
c_cond
(paren
id|dir
)paren
(brace
r_case
id|SM_UP
suffix:colon
r_if
c_cond
(paren
id|count
OG
id|conp-&gt;vc_rows
)paren
multiline_comment|/* Maximum realistic size */
id|count
op_assign
id|conp-&gt;vc_rows
suffix:semicolon
r_if
c_cond
(paren
id|vt_cons
(braket
id|unit
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_TEXT
)paren
r_switch
c_cond
(paren
id|p-&gt;scrollmode
)paren
(brace
r_case
id|SCROLL_YWRAP
suffix:colon
r_if
c_cond
(paren
id|b
op_minus
id|t
op_minus
id|count
OG
l_int|3
op_star
id|conp-&gt;vc_rows
op_rshift
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|t
OG
l_int|0
)paren
id|fbcon_bmove
c_func
(paren
id|conp
comma
l_int|0
comma
l_int|0
comma
id|count
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
macro_line|#if SUPPORT_SCROLLBACK
id|ywrap_up
c_func
(paren
id|unit
comma
id|conp
comma
id|p
comma
id|count
)paren
suffix:semicolon
macro_line|#else
id|ywrap_up
c_func
(paren
id|unit
comma
id|p
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|conp-&gt;vc_rows
op_minus
id|b
OG
l_int|0
)paren
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|b
comma
l_int|0
comma
id|conp-&gt;vc_rows
op_minus
id|b
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
)brace
r_else
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|fbcon_clear
c_func
(paren
id|conp
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCROLL_YPAN
suffix:colon
r_if
c_cond
(paren
id|b
op_minus
id|t
op_minus
id|count
OG
l_int|3
op_star
id|conp-&gt;vc_rows
op_rshift
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|t
OG
l_int|0
)paren
id|fbcon_bmove
c_func
(paren
id|conp
comma
l_int|0
comma
l_int|0
comma
id|count
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|ypan_up
c_func
(paren
id|unit
comma
id|conp
comma
id|p
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conp-&gt;vc_rows
op_minus
id|b
OG
l_int|0
)paren
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|b
comma
l_int|0
comma
id|conp-&gt;vc_rows
op_minus
id|b
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
)brace
r_else
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|fbcon_clear
c_func
(paren
id|conp
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCROLL_YMOVE
suffix:colon
id|p-&gt;dispsw
op_member_access_from_pointer
id|bmove
c_func
(paren
id|p
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|p-&gt;dispsw
op_member_access_from_pointer
id|clear
c_func
(paren
id|conp
comma
id|p
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|fbcon_clear
c_func
(paren
id|conp
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SM_DOWN
suffix:colon
r_if
c_cond
(paren
id|count
OG
id|conp-&gt;vc_rows
)paren
multiline_comment|/* Maximum realistic size */
id|count
op_assign
id|conp-&gt;vc_rows
suffix:semicolon
r_if
c_cond
(paren
id|vt_cons
(braket
id|unit
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_TEXT
)paren
r_switch
c_cond
(paren
id|p-&gt;scrollmode
)paren
(brace
r_case
id|SCROLL_YWRAP
suffix:colon
r_if
c_cond
(paren
id|b
op_minus
id|t
op_minus
id|count
OG
l_int|3
op_star
id|conp-&gt;vc_rows
op_rshift
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|conp-&gt;vc_rows
op_minus
id|b
OG
l_int|0
)paren
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|b
comma
l_int|0
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|conp-&gt;vc_rows
op_minus
id|b
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
macro_line|#if SUPPORT_SCROLLBACK
id|ywrap_down
c_func
(paren
id|unit
comma
id|conp
comma
id|p
comma
id|count
)paren
suffix:semicolon
macro_line|#else
id|ywrap_down
c_func
(paren
id|unit
comma
id|p
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|t
OG
l_int|0
)paren
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|count
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
)brace
r_else
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|fbcon_clear
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCROLL_YPAN
suffix:colon
r_if
c_cond
(paren
id|b
op_minus
id|t
op_minus
id|count
OG
l_int|3
op_star
id|conp-&gt;vc_rows
op_rshift
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|conp-&gt;vc_rows
op_minus
id|b
OG
l_int|0
)paren
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|b
comma
l_int|0
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|conp-&gt;vc_rows
op_minus
id|b
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|ypan_down
c_func
(paren
id|unit
comma
id|conp
comma
id|p
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
OG
l_int|0
)paren
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|count
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
)brace
r_else
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|fbcon_clear
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCROLL_YMOVE
suffix:colon
id|p-&gt;dispsw
op_member_access_from_pointer
id|bmove
c_func
(paren
id|p
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|p-&gt;dispsw
op_member_access_from_pointer
id|clear
c_func
(paren
id|conp
comma
id|p
comma
id|t
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; *  Fixed bmove() should end Arno&squot;s frustration with copying?&n;&t;&t; *  Confucius says:&n;&t;&t; *&t;Man who copies in wrong direction, end up with trashed&n;&t;&t; *&t;data&n;&t;&t; */
id|fbcon_bmove
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|fbcon_clear
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SM_LEFT
suffix:colon
id|fbcon_bmove
c_func
(paren
id|conp
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_rows
comma
id|b
op_minus
id|t
op_minus
id|count
)paren
suffix:semicolon
id|fbcon_clear
c_func
(paren
id|conp
comma
l_int|0
comma
id|b
op_minus
id|count
comma
id|conp-&gt;vc_rows
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_RIGHT
suffix:colon
id|fbcon_bmove
c_func
(paren
id|conp
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
id|conp-&gt;vc_rows
comma
id|b
op_minus
id|t
op_minus
id|count
)paren
suffix:semicolon
id|fbcon_clear
c_func
(paren
id|conp
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_rows
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|fbcon_bmove
r_static
r_void
id|fbcon_bmove
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;can_soft_blank
op_logical_and
id|console_blanked
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|width
op_logical_or
op_logical_neg
id|height
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|sy
op_le
id|p-&gt;cursor_y
)paren
op_logical_and
(paren
id|p-&gt;cursor_y
OL
id|sy
op_plus
id|height
)paren
op_logical_and
(paren
id|sx
op_le
id|p-&gt;cursor_x
)paren
op_logical_and
(paren
id|p-&gt;cursor_x
OL
id|sx
op_plus
id|width
)paren
)paren
op_logical_or
(paren
(paren
id|dy
op_le
id|p-&gt;cursor_y
)paren
op_logical_and
(paren
id|p-&gt;cursor_y
OL
id|dy
op_plus
id|height
)paren
op_logical_and
(paren
id|dx
op_le
id|p-&gt;cursor_x
)paren
op_logical_and
(paren
id|p-&gt;cursor_x
OL
id|dx
op_plus
id|width
)paren
)paren
)paren
id|fbcon_cursor
c_func
(paren
id|conp
comma
id|CM_ERASE
)paren
suffix:semicolon
multiline_comment|/*  Split blits that cross physical y_wrap case.&n;     *  Pathological case involves 4 blits, better to use recursive&n;     *  code rather than unrolled case&n;     *&n;     *  Recursive invocations don&squot;t need to erase the cursor over and&n;     *  over again, so we use fbcon_bmove_rec()&n;     */
id|fbcon_bmove_rec
c_func
(paren
id|p
comma
id|sy
comma
id|sx
comma
id|dy
comma
id|dx
comma
id|height
comma
id|width
comma
id|p-&gt;vrows
op_minus
id|p-&gt;yscroll
)paren
suffix:semicolon
)brace
DECL|function|fbcon_bmove_rec
r_static
r_void
id|fbcon_bmove_rec
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
comma
id|u_int
id|y_break
)paren
(brace
id|u_int
id|b
suffix:semicolon
r_if
c_cond
(paren
id|sy
template_param
id|y_break
)paren
(brace
id|b
op_assign
id|y_break
op_minus
id|sy
suffix:semicolon
r_if
c_cond
(paren
id|dy
OL
id|sy
)paren
(brace
multiline_comment|/* Avoid trashing self */
id|fbcon_bmove_rec
c_func
(paren
id|p
comma
id|sy
comma
id|sx
comma
id|dy
comma
id|dx
comma
id|b
comma
id|width
comma
id|y_break
)paren
suffix:semicolon
id|fbcon_bmove_rec
c_func
(paren
id|p
comma
id|sy
op_plus
id|b
comma
id|sx
comma
id|dy
op_plus
id|b
comma
id|dx
comma
id|height
op_minus
id|b
comma
id|width
comma
id|y_break
)paren
suffix:semicolon
)brace
r_else
(brace
id|fbcon_bmove_rec
c_func
(paren
id|p
comma
id|sy
op_plus
id|b
comma
id|sx
comma
id|dy
op_plus
id|b
comma
id|dx
comma
id|height
op_minus
id|b
comma
id|width
comma
id|y_break
)paren
suffix:semicolon
id|fbcon_bmove_rec
c_func
(paren
id|p
comma
id|sy
comma
id|sx
comma
id|dy
comma
id|dx
comma
id|b
comma
id|width
comma
id|y_break
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dy
template_param
id|y_break
)paren
(brace
id|b
op_assign
id|y_break
op_minus
id|dy
suffix:semicolon
r_if
c_cond
(paren
id|dy
OL
id|sy
)paren
(brace
multiline_comment|/* Avoid trashing self */
id|fbcon_bmove_rec
c_func
(paren
id|p
comma
id|sy
comma
id|sx
comma
id|dy
comma
id|dx
comma
id|b
comma
id|width
comma
id|y_break
)paren
suffix:semicolon
id|fbcon_bmove_rec
c_func
(paren
id|p
comma
id|sy
op_plus
id|b
comma
id|sx
comma
id|dy
op_plus
id|b
comma
id|dx
comma
id|height
op_minus
id|b
comma
id|width
comma
id|y_break
)paren
suffix:semicolon
)brace
r_else
(brace
id|fbcon_bmove_rec
c_func
(paren
id|p
comma
id|sy
op_plus
id|b
comma
id|sx
comma
id|dy
op_plus
id|b
comma
id|dx
comma
id|height
op_minus
id|b
comma
id|width
comma
id|y_break
)paren
suffix:semicolon
id|fbcon_bmove_rec
c_func
(paren
id|p
comma
id|sy
comma
id|sx
comma
id|dy
comma
id|dx
comma
id|b
comma
id|width
comma
id|y_break
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|p-&gt;dispsw
op_member_access_from_pointer
id|bmove
c_func
(paren
id|p
comma
id|real_y
c_func
(paren
id|p
comma
id|sy
)paren
comma
id|sx
comma
id|real_y
c_func
(paren
id|p
comma
id|dy
)paren
comma
id|dx
comma
id|height
comma
id|width
)paren
suffix:semicolon
)brace
DECL|function|fbcon_switch
r_static
r_int
id|fbcon_switch
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
op_assign
id|p-&gt;fb_info
suffix:semicolon
r_if
c_cond
(paren
id|info
op_logical_and
id|info-&gt;switch_con
)paren
(paren
op_star
id|info-&gt;switch_con
)paren
(paren
id|conp-&gt;vc_num
comma
id|info
)paren
suffix:semicolon
macro_line|#if SUPPORT_SCROLLBACK
id|scrollback_max
op_assign
l_int|0
suffix:semicolon
id|scrollback_current
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fbcon_blank
r_static
r_int
id|fbcon_blank
c_func
(paren
r_int
id|blank
)paren
(brace
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|fg_console
)braket
suffix:semicolon
r_struct
id|fb_info
op_star
id|info
op_assign
id|p-&gt;fb_info
suffix:semicolon
id|fbcon_cursor
c_func
(paren
id|p-&gt;conp
comma
id|blank
ques
c_cond
id|CM_ERASE
suffix:colon
id|CM_DRAW
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;can_soft_blank
)paren
(brace
r_if
c_cond
(paren
id|blank
)paren
(brace
macro_line|#ifdef CONFIG_MAC
r_if
c_cond
(paren
id|MACH_IS_MAC
)paren
id|mymemset
c_func
(paren
id|p-&gt;screen_base
comma
id|p-&gt;var.xres_virtual
op_star
id|p-&gt;var.yres_virtual
op_star
id|p-&gt;var.bits_per_pixel
op_rshift
l_int|3
)paren
suffix:semicolon
r_else
macro_line|#endif
r_if
c_cond
(paren
id|p-&gt;visual
op_eq
id|FB_VISUAL_MONO01
)paren
id|mymemset
c_func
(paren
id|p-&gt;screen_base
comma
id|p-&gt;var.xres_virtual
op_star
id|p-&gt;var.yres_virtual
op_star
id|p-&gt;var.bits_per_pixel
op_rshift
l_int|3
)paren
suffix:semicolon
r_else
id|mymemclear
c_func
(paren
id|p-&gt;screen_base
comma
id|p-&gt;var.xres_virtual
op_star
id|p-&gt;var.yres_virtual
op_star
id|p-&gt;var.bits_per_pixel
op_rshift
l_int|3
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Tell console.c that it has to restore the screen itself */
r_return
l_int|1
suffix:semicolon
)brace
)brace
(paren
op_star
id|info-&gt;blank
)paren
(paren
id|blank
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fbcon_get_font
r_static
r_int
id|fbcon_get_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
op_star
id|w
comma
r_int
op_star
id|h
comma
r_char
op_star
id|data
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|size
comma
id|alloc
suffix:semicolon
id|size
op_assign
(paren
id|p-&gt;fontwidth
op_plus
l_int|7
)paren
op_div
l_int|8
op_star
id|p-&gt;fontheight
op_star
l_int|256
suffix:semicolon
id|alloc
op_assign
(paren
op_star
id|w
op_plus
l_int|7
)paren
op_div
l_int|8
op_star
op_star
id|h
op_star
l_int|256
suffix:semicolon
op_star
id|w
op_assign
id|p-&gt;fontwidth
suffix:semicolon
op_star
id|h
op_assign
id|p-&gt;fontheight
suffix:semicolon
r_if
c_cond
(paren
id|alloc
OL
id|size
)paren
multiline_comment|/* allocation length not sufficient */
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|p-&gt;fontheight
suffix:semicolon
id|j
op_increment
)paren
id|data
(braket
id|i
op_star
l_int|32
op_plus
id|j
)braket
op_assign
id|p-&gt;fontdata
(braket
id|i
op_star
id|p-&gt;fontheight
op_plus
id|j
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|REFCOUNT
mdefine_line|#define REFCOUNT(fd)&t;(((int *)(fd))[-1])
DECL|function|fbcon_set_font
r_static
r_int
id|fbcon_set_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|w
comma
r_int
id|h
comma
r_char
op_star
id|data
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|size
comma
id|userspace
op_assign
l_int|1
comma
id|resize
suffix:semicolon
r_char
op_star
id|old_data
op_assign
l_int|NULL
comma
op_star
id|new_data
suffix:semicolon
r_if
c_cond
(paren
id|w
OL
l_int|0
)paren
id|w
op_assign
id|p-&gt;fontwidth
suffix:semicolon
r_if
c_cond
(paren
id|h
OL
l_int|0
)paren
id|h
op_assign
id|p-&gt;fontheight
suffix:semicolon
r_if
c_cond
(paren
id|w
op_eq
l_int|0
)paren
(brace
multiline_comment|/* engage predefined font, name in &squot;data&squot; */
r_char
id|name
(braket
id|MAX_FONT_NAME
op_plus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|data
comma
id|MAX_FONT_NAME
)paren
)paren
)paren
r_return
id|i
suffix:semicolon
id|copy_from_user
c_func
(paren
id|name
comma
id|data
comma
id|MAX_FONT_NAME
)paren
suffix:semicolon
id|name
(braket
r_sizeof
(paren
id|name
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|findsoftfont
c_func
(paren
id|name
comma
op_amp
id|w
comma
op_amp
id|h
comma
(paren
id|u8
op_star
op_star
)paren
op_amp
id|data
)paren
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|userspace
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|w
op_eq
l_int|1
)paren
(brace
multiline_comment|/* copy font from some other console in &squot;h&squot;*/
r_struct
id|display
op_star
id|op
suffix:semicolon
r_if
c_cond
(paren
id|h
OL
l_int|0
op_logical_or
op_logical_neg
id|vc_cons_allocated
c_func
(paren
id|h
)paren
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_if
c_cond
(paren
id|h
op_eq
id|unit
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* nothing to do */
id|op
op_assign
op_amp
id|fb_display
(braket
id|h
)braket
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;fontdata
op_eq
id|p-&gt;fontdata
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* already the same font... */
id|resize
op_assign
(paren
id|op-&gt;fontwidth
op_ne
id|p-&gt;fontwidth
)paren
op_logical_or
(paren
id|op-&gt;fontheight
op_ne
id|p-&gt;fontheight
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;userfont
)paren
id|old_data
op_assign
id|p-&gt;fontdata
suffix:semicolon
id|p-&gt;fontdata
op_assign
id|op-&gt;fontdata
suffix:semicolon
id|w
op_assign
id|p-&gt;fontwidth
op_assign
id|op-&gt;fontwidth
suffix:semicolon
id|h
op_assign
id|p-&gt;fontheight
op_assign
id|op-&gt;fontheight
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p-&gt;userfont
op_assign
id|op-&gt;userfont
)paren
)paren
id|REFCOUNT
c_func
(paren
id|p-&gt;fontdata
)paren
op_increment
suffix:semicolon
multiline_comment|/* increment usage counter */
r_goto
id|activate
suffix:semicolon
)brace
r_if
c_cond
(paren
id|w
op_ne
l_int|8
)paren
multiline_comment|/* Currently only fontwidth == 8 supported */
r_return
op_minus
id|ENXIO
suffix:semicolon
id|resize
op_assign
(paren
id|w
op_ne
id|p-&gt;fontwidth
)paren
op_logical_or
(paren
id|h
op_ne
id|p-&gt;fontheight
)paren
suffix:semicolon
id|size
op_assign
(paren
id|w
op_plus
l_int|7
)paren
op_div
l_int|8
op_star
id|h
op_star
l_int|256
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;userfont
)paren
id|old_data
op_assign
id|p-&gt;fontdata
suffix:semicolon
r_if
c_cond
(paren
id|userspace
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|new_data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_int
)paren
op_plus
id|size
comma
id|GFP_USER
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|new_data
op_add_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|REFCOUNT
c_func
(paren
id|new_data
)paren
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* usage counter */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|h
suffix:semicolon
id|j
op_increment
)paren
id|new_data
(braket
id|i
op_star
id|h
op_plus
id|j
)braket
op_assign
id|data
(braket
id|i
op_star
l_int|32
op_plus
id|j
)braket
suffix:semicolon
id|p-&gt;fontdata
op_assign
id|new_data
suffix:semicolon
id|p-&gt;userfont
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;fontdata
op_assign
id|data
suffix:semicolon
id|p-&gt;userfont
op_assign
l_int|0
suffix:semicolon
)brace
id|p-&gt;fontwidth
op_assign
id|w
suffix:semicolon
id|p-&gt;fontheight
op_assign
id|h
suffix:semicolon
id|activate
suffix:colon
r_if
c_cond
(paren
id|resize
)paren
(brace
multiline_comment|/* reset wrap/pan */
id|p-&gt;var.xoffset
op_assign
id|p-&gt;var.yoffset
op_assign
id|p-&gt;yscroll
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Adjust the virtual screen-size to fontheight*rows */
id|p-&gt;var.yres_virtual
op_assign
(paren
id|p-&gt;var.yres
op_div
id|h
)paren
op_star
id|h
suffix:semicolon
id|p-&gt;vrows
op_assign
id|p-&gt;var.yres_virtual
op_div
id|h
suffix:semicolon
id|updatescrollmode
c_func
(paren
id|p
)paren
suffix:semicolon
id|vc_resize_con
c_func
(paren
id|p-&gt;var.yres
op_div
id|h
comma
id|p-&gt;var.xres
op_div
id|w
comma
id|unit
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|unit
op_eq
id|fg_console
)paren
id|update_screen
c_func
(paren
id|unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_data
op_logical_and
(paren
op_decrement
id|REFCOUNT
c_func
(paren
id|old_data
)paren
op_eq
l_int|0
)paren
)paren
id|kfree
c_func
(paren
id|old_data
op_minus
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|palette_red
r_static
id|u16
id|palette_red
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|palette_green
r_static
id|u16
id|palette_green
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|palette_blue
r_static
id|u16
id|palette_blue
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|palette_cmap
r_static
r_struct
id|fb_cmap
id|palette_cmap
op_assign
(brace
l_int|0
comma
l_int|16
comma
id|palette_red
comma
id|palette_green
comma
id|palette_blue
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|fbcon_set_palette
r_static
r_int
id|fbcon_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
r_char
op_star
id|table
)paren
(brace
r_int
id|unit
op_assign
id|conp-&gt;vc_num
suffix:semicolon
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|u8
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conp-&gt;vc_can_do_color
op_logical_or
(paren
op_logical_neg
id|p-&gt;can_soft_blank
op_logical_and
id|console_blanked
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|k
op_assign
id|table
(braket
id|i
)braket
suffix:semicolon
id|val
op_assign
id|conp-&gt;vc_palette
(braket
id|j
op_increment
)braket
suffix:semicolon
id|palette_red
(braket
id|k
)braket
op_assign
(paren
id|val
op_lshift
l_int|8
)paren
op_or
id|val
suffix:semicolon
id|val
op_assign
id|conp-&gt;vc_palette
(braket
id|j
op_increment
)braket
suffix:semicolon
id|palette_green
(braket
id|k
)braket
op_assign
(paren
id|val
op_lshift
l_int|8
)paren
op_or
id|val
suffix:semicolon
id|val
op_assign
id|conp-&gt;vc_palette
(braket
id|j
op_increment
)braket
suffix:semicolon
id|palette_blue
(braket
id|k
)braket
op_assign
(paren
id|val
op_lshift
l_int|8
)paren
op_or
id|val
suffix:semicolon
)brace
id|palette_cmap.len
op_assign
l_int|1
op_lshift
id|p-&gt;var.bits_per_pixel
suffix:semicolon
r_if
c_cond
(paren
id|palette_cmap.len
OG
l_int|16
)paren
id|palette_cmap.len
op_assign
l_int|16
suffix:semicolon
r_return
id|p-&gt;fb_info-&gt;fbops
op_member_access_from_pointer
id|fb_set_cmap
c_func
(paren
op_amp
id|palette_cmap
comma
l_int|1
comma
id|unit
comma
id|p-&gt;fb_info
)paren
suffix:semicolon
)brace
DECL|function|fbcon_scrolldelta
r_static
r_int
id|fbcon_scrolldelta
c_func
(paren
r_int
id|lines
)paren
(brace
macro_line|#if SUPPORT_SCROLLBACK
r_int
id|unit
op_assign
id|fg_console
suffix:semicolon
multiline_comment|/* xxx */
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|unit
)braket
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;can_soft_blank
op_logical_and
id|console_blanked
op_logical_or
id|vt_cons
(braket
id|unit
)braket
op_member_access_from_pointer
id|vc_mode
op_ne
id|KD_TEXT
op_logical_or
op_logical_neg
id|lines
op_logical_or
id|p-&gt;scrollmode
op_ne
id|SCROLL_YWRAP
)paren
r_return
l_int|0
suffix:semicolon
id|fbcon_cursor
c_func
(paren
id|conp
comma
id|CM_ERASE
)paren
suffix:semicolon
id|scrollback_current
op_sub_assign
id|lines
suffix:semicolon
r_if
c_cond
(paren
id|scrollback_current
OL
l_int|0
)paren
id|scrollback_current
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|scrollback_current
OG
id|scrollback_max
)paren
id|scrollback_current
op_assign
id|scrollback_max
suffix:semicolon
id|offset
op_assign
id|p-&gt;yscroll
op_minus
id|scrollback_current
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
id|offset
op_add_assign
id|p-&gt;vrows
suffix:semicolon
r_else
r_if
c_cond
(paren
id|offset
OG
id|p-&gt;vrows
)paren
id|offset
op_sub_assign
id|p-&gt;vrows
suffix:semicolon
id|p-&gt;var.vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
id|p-&gt;var.xoffset
op_assign
l_int|0
suffix:semicolon
id|p-&gt;var.yoffset
op_assign
id|offset
op_star
id|p-&gt;fontheight
suffix:semicolon
id|p-&gt;fb_info
op_member_access_from_pointer
id|updatevar
c_func
(paren
id|unit
comma
id|p-&gt;fb_info
)paren
suffix:semicolon
macro_line|#else
r_return
op_minus
id|ENOSYS
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;     *  Switch between `text&squot; (emulated and accelerated) and `graphics&squot;&n;     *  (unaccelerated text) mode&n;     */
DECL|function|fbcon_set_mode
r_static
r_int
id|fbcon_set_mode
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|mode
)paren
(brace
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|conp-&gt;vc_num
)braket
suffix:semicolon
r_struct
id|fb_ops
op_star
id|ops
op_assign
id|p-&gt;fb_info-&gt;fbops
suffix:semicolon
r_return
id|ops-&gt;fb_set_mode
ques
c_cond
id|ops
op_member_access_from_pointer
id|fb_set_mode
c_func
(paren
id|mode
comma
id|p-&gt;fb_info
)paren
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|macro|LOGO_H
mdefine_line|#define LOGO_H&t;&t;&t;80
DECL|macro|LOGO_W
mdefine_line|#define LOGO_W&t;&t;&t;80
DECL|macro|LOGO_LINE
mdefine_line|#define LOGO_LINE&t;(LOGO_W/8)
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|fbcon_show_logo
c_func
(paren
r_void
)paren
)paren
(brace
r_struct
id|display
op_star
id|p
op_assign
op_amp
id|fb_display
(braket
id|fg_console
)braket
suffix:semicolon
multiline_comment|/* draw to vt in foreground */
r_int
id|depth
op_assign
id|p-&gt;var.bits_per_pixel
suffix:semicolon
r_int
id|line
op_assign
id|p-&gt;next_line
suffix:semicolon
r_int
r_char
op_star
id|fb
op_assign
id|p-&gt;screen_base
suffix:semicolon
r_int
r_char
op_star
id|logo
suffix:semicolon
r_int
r_char
op_star
id|dst
comma
op_star
id|src
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|n
comma
id|x1
comma
id|y1
suffix:semicolon
r_int
id|logo_depth
comma
id|done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set colors if visual is PSEUDOCOLOR and we have enough colors */
r_if
c_cond
(paren
id|p-&gt;visual
op_eq
id|FB_VISUAL_PSEUDOCOLOR
op_logical_and
id|depth
op_ge
l_int|4
)paren
(brace
r_int
id|first_col
op_assign
id|depth
op_ge
l_int|8
ques
c_cond
l_int|32
suffix:colon
id|depth
OG
l_int|4
ques
c_cond
l_int|16
suffix:colon
l_int|0
suffix:semicolon
r_int
id|num_cols
op_assign
id|depth
op_ge
l_int|8
ques
c_cond
id|LINUX_LOGO_COLORS
suffix:colon
l_int|16
suffix:semicolon
r_int
r_char
op_star
id|red
comma
op_star
id|green
comma
op_star
id|blue
suffix:semicolon
r_int
id|old_cmap_len
suffix:semicolon
r_if
c_cond
(paren
id|depth
op_ge
l_int|8
)paren
(brace
id|red
op_assign
id|linux_logo_red
suffix:semicolon
id|green
op_assign
id|linux_logo_green
suffix:semicolon
id|blue
op_assign
id|linux_logo_blue
suffix:semicolon
)brace
r_else
(brace
id|red
op_assign
id|linux_logo16_red
suffix:semicolon
id|green
op_assign
id|linux_logo16_green
suffix:semicolon
id|blue
op_assign
id|linux_logo16_blue
suffix:semicolon
)brace
multiline_comment|/* dirty trick to avoid setcmap calling kmalloc which isn&squot;t&n;&t; * initialized yet... */
id|old_cmap_len
op_assign
id|fb_display
(braket
id|fg_console
)braket
dot
id|cmap.len
suffix:semicolon
id|fb_display
(braket
id|fg_console
)braket
dot
id|cmap.len
op_assign
l_int|1
op_lshift
id|depth
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_cols
suffix:semicolon
id|i
op_add_assign
id|n
)paren
(brace
id|n
op_assign
id|num_cols
op_minus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|16
)paren
multiline_comment|/* palette_cmap provides space for only 16 colors at once */
id|n
op_assign
l_int|16
suffix:semicolon
id|palette_cmap.start
op_assign
id|first_col
op_plus
id|i
suffix:semicolon
id|palette_cmap.len
op_assign
id|n
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|n
suffix:semicolon
op_increment
id|j
)paren
(brace
id|palette_cmap.red
(braket
id|j
)braket
op_assign
(paren
id|red
(braket
id|i
op_plus
id|j
)braket
op_lshift
l_int|8
)paren
op_or
id|red
(braket
id|i
op_plus
id|j
)braket
suffix:semicolon
id|palette_cmap.green
(braket
id|j
)braket
op_assign
(paren
id|green
(braket
id|i
op_plus
id|j
)braket
op_lshift
l_int|8
)paren
op_or
id|green
(braket
id|i
op_plus
id|j
)braket
suffix:semicolon
id|palette_cmap.blue
(braket
id|j
)braket
op_assign
(paren
id|blue
(braket
id|i
op_plus
id|j
)braket
op_lshift
l_int|8
)paren
op_or
id|blue
(braket
id|i
op_plus
id|j
)braket
suffix:semicolon
)brace
id|p-&gt;fb_info-&gt;fbops
op_member_access_from_pointer
id|fb_set_cmap
c_func
(paren
op_amp
id|palette_cmap
comma
l_int|1
comma
id|fg_console
comma
id|p-&gt;fb_info
)paren
suffix:semicolon
)brace
id|fb_display
(braket
id|fg_console
)braket
dot
id|cmap.len
op_assign
id|old_cmap_len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|depth
op_ge
l_int|8
)paren
(brace
id|logo
op_assign
id|linux_logo
suffix:semicolon
id|logo_depth
op_assign
l_int|8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|depth
op_ge
l_int|4
)paren
(brace
id|logo
op_assign
id|linux_logo16
suffix:semicolon
id|logo_depth
op_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|logo
op_assign
id|linux_logo_bw
suffix:semicolon
id|logo_depth
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_FBCON_CFB16) || defined(CONFIG_FBCON_CFB24) || &bslash;&n;    defined(CONFIG_FBCON_CFB32)
r_if
c_cond
(paren
id|p-&gt;visual
op_eq
id|FB_VISUAL_TRUECOLOR
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
multiline_comment|/* max. depth 32! */
r_int
id|bdepth
suffix:semicolon
r_int
id|redshift
comma
id|greenshift
comma
id|blueshift
suffix:semicolon
multiline_comment|/* Bug: Doesn&squot;t obey msb_right ... (who needs that?) */
id|redshift
op_assign
id|p-&gt;var.red.offset
suffix:semicolon
id|greenshift
op_assign
id|p-&gt;var.green.offset
suffix:semicolon
id|blueshift
op_assign
id|p-&gt;var.blue.offset
suffix:semicolon
r_if
c_cond
(paren
id|depth
op_ge
l_int|24
op_logical_and
(paren
id|depth
op_mod
l_int|8
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* have at least 8 bits per color */
id|src
op_assign
id|logo
suffix:semicolon
id|bdepth
op_assign
id|depth
op_div
l_int|8
suffix:semicolon
r_for
c_loop
(paren
id|y1
op_assign
l_int|0
suffix:semicolon
id|y1
OL
id|LOGO_H
suffix:semicolon
id|y1
op_increment
)paren
(brace
id|dst
op_assign
id|fb
op_plus
id|y1
op_star
id|line
suffix:semicolon
r_for
c_loop
(paren
id|x1
op_assign
l_int|0
suffix:semicolon
id|x1
OL
id|LOGO_W
suffix:semicolon
id|x1
op_increment
comma
id|src
op_increment
)paren
(brace
id|val
op_assign
(paren
(paren
id|linux_logo_red
(braket
op_star
id|src
)braket
op_amp
id|redmask
)paren
op_lshift
id|redshift
)paren
op_or
(paren
(paren
id|linux_logo_green
(braket
op_star
id|src
)braket
op_amp
id|greenmask
)paren
op_lshift
id|greenshift
)paren
op_or
(paren
(paren
id|linux_logo_blue
(braket
op_star
id|src
)braket
op_amp
id|bluemask
)paren
op_lshift
id|blueshift
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|bdepth
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
(brace
op_star
id|dst
op_increment
op_assign
id|val
op_rshift
(paren
id|i
op_star
l_int|8
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|depth
op_ge
l_int|15
op_logical_and
id|depth
op_le
l_int|23
)paren
(brace
multiline_comment|/* have 5..7 bits per color, using 16 color image */
r_int
r_int
id|pix
suffix:semicolon
id|src
op_assign
id|linux_logo16
suffix:semicolon
id|bdepth
op_assign
(paren
id|depth
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
r_for
c_loop
(paren
id|y1
op_assign
l_int|0
suffix:semicolon
id|y1
OL
id|LOGO_H
suffix:semicolon
id|y1
op_increment
)paren
(brace
id|dst
op_assign
id|fb
op_plus
id|y1
op_star
id|line
suffix:semicolon
r_for
c_loop
(paren
id|x1
op_assign
l_int|0
suffix:semicolon
id|x1
OL
id|LOGO_W
op_div
l_int|2
suffix:semicolon
id|x1
op_increment
comma
id|src
op_increment
)paren
(brace
id|pix
op_assign
(paren
op_star
id|src
op_rshift
l_int|4
)paren
op_or
l_int|0x10
suffix:semicolon
multiline_comment|/* upper nibble */
id|val
op_assign
(paren
id|pix
op_lshift
id|redshift
)paren
op_or
(paren
id|pix
op_lshift
id|greenshift
)paren
op_or
(paren
id|pix
op_lshift
id|blueshift
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bdepth
suffix:semicolon
op_increment
id|i
)paren
(brace
op_star
id|dst
op_increment
op_assign
id|val
op_rshift
(paren
id|i
op_star
l_int|8
)paren
suffix:semicolon
)brace
id|pix
op_assign
(paren
op_star
id|src
op_amp
l_int|0x0f
)paren
op_or
l_int|0x10
suffix:semicolon
multiline_comment|/* lower nibble */
id|val
op_assign
(paren
id|pix
op_lshift
id|redshift
)paren
op_or
(paren
id|pix
op_lshift
id|greenshift
)paren
op_or
(paren
id|pix
op_lshift
id|blueshift
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|bdepth
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
(brace
op_star
id|dst
op_increment
op_assign
id|val
op_rshift
(paren
id|i
op_star
l_int|8
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|done
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_FBCON_CFB16) || defined(CONFIG_FBCON_CFB24) || &bslash;&n;    defined(CONFIG_FBCON_CFB32)
r_if
c_cond
(paren
(paren
id|depth
op_mod
l_int|8
op_eq
l_int|0
)paren
op_logical_and
(paren
id|p-&gt;visual
op_eq
id|FB_VISUAL_DIRECTCOLOR
)paren
)paren
(brace
multiline_comment|/* Modes without color mapping, needs special data transformation... */
r_int
r_int
id|val
suffix:semicolon
multiline_comment|/* max. depth 32! */
r_int
id|bdepth
op_assign
id|depth
op_div
l_int|8
suffix:semicolon
r_int
r_char
id|mask
(braket
l_int|9
)braket
op_assign
(brace
l_int|0
comma
l_int|0x80
comma
l_int|0xc0
comma
l_int|0xe0
comma
l_int|0xf0
comma
l_int|0xf8
comma
l_int|0xfc
comma
l_int|0xfe
comma
l_int|0xff
)brace
suffix:semicolon
r_int
r_char
id|redmask
comma
id|greenmask
comma
id|bluemask
suffix:semicolon
r_int
id|redshift
comma
id|greenshift
comma
id|blueshift
suffix:semicolon
multiline_comment|/* Bug: Doesn&squot;t obey msb_right ... (who needs that?) */
id|redmask
op_assign
id|mask
(braket
id|p-&gt;var.red.length
OL
l_int|8
ques
c_cond
id|p-&gt;var.red.length
suffix:colon
l_int|8
)braket
suffix:semicolon
id|greenmask
op_assign
id|mask
(braket
id|p-&gt;var.green.length
OL
l_int|8
ques
c_cond
id|p-&gt;var.green.length
suffix:colon
l_int|8
)braket
suffix:semicolon
id|bluemask
op_assign
id|mask
(braket
id|p-&gt;var.blue.length
OL
l_int|8
ques
c_cond
id|p-&gt;var.blue.length
suffix:colon
l_int|8
)braket
suffix:semicolon
id|redshift
op_assign
id|p-&gt;var.red.offset
op_minus
(paren
l_int|8
op_minus
id|p-&gt;var.red.length
)paren
suffix:semicolon
id|greenshift
op_assign
id|p-&gt;var.green.offset
op_minus
(paren
l_int|8
op_minus
id|p-&gt;var.green.length
)paren
suffix:semicolon
id|blueshift
op_assign
id|p-&gt;var.blue.offset
op_minus
(paren
l_int|8
op_minus
id|p-&gt;var.blue.length
)paren
suffix:semicolon
id|src
op_assign
id|logo
suffix:semicolon
r_for
c_loop
(paren
id|y1
op_assign
l_int|0
suffix:semicolon
id|y1
OL
id|LOGO_H
suffix:semicolon
id|y1
op_increment
)paren
(brace
id|dst
op_assign
id|fb
op_plus
id|y1
op_star
id|line
suffix:semicolon
r_for
c_loop
(paren
id|x1
op_assign
l_int|0
suffix:semicolon
id|x1
OL
id|LOGO_W
suffix:semicolon
id|x1
op_increment
comma
id|src
op_increment
)paren
(brace
id|val
op_assign
(paren
(paren
id|linux_logo_red
(braket
op_star
id|src
)braket
op_amp
id|redmask
)paren
op_lshift
id|redshift
)paren
op_or
(paren
(paren
id|linux_logo_green
(braket
op_star
id|src
)braket
op_amp
id|greenmask
)paren
op_lshift
id|greenshift
)paren
op_or
(paren
(paren
id|linux_logo_blue
(braket
op_star
id|src
)braket
op_amp
id|bluemask
)paren
op_lshift
id|blueshift
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bdepth
suffix:semicolon
op_increment
id|i
)paren
(brace
op_star
id|dst
op_increment
op_assign
id|val
op_rshift
(paren
id|i
op_star
l_int|8
)paren
suffix:semicolon
)brace
)brace
)brace
id|done
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_FBCON_CFB8)
r_if
c_cond
(paren
id|depth
op_eq
l_int|8
op_logical_and
id|p-&gt;type
op_eq
id|FB_TYPE_PACKED_PIXELS
)paren
(brace
multiline_comment|/* depth 8 or more, packed, with color registers */
id|src
op_assign
id|logo
suffix:semicolon
r_for
c_loop
(paren
id|y1
op_assign
l_int|0
suffix:semicolon
id|y1
OL
id|LOGO_H
suffix:semicolon
id|y1
op_increment
)paren
(brace
id|dst
op_assign
id|fb
op_plus
id|y1
op_star
id|line
suffix:semicolon
r_for
c_loop
(paren
id|x1
op_assign
l_int|0
suffix:semicolon
id|x1
OL
id|LOGO_W
suffix:semicolon
id|x1
op_increment
)paren
(brace
op_star
id|dst
op_increment
op_assign
op_star
id|src
op_increment
suffix:semicolon
)brace
)brace
id|done
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_FBCON_AFB) || defined(CONFIG_FBCON_ILBM) || &bslash;&n;    defined(CONFIG_FBCON_IPLAN2P2) || defined(CONFIG_FBCON_IPLAN2P4) || &bslash;&n;    defined(CONFIG_FBCON_IPLAN2P8)
r_if
c_cond
(paren
id|depth
op_ge
l_int|2
op_logical_and
(paren
id|p-&gt;type
op_eq
id|FB_TYPE_PLANES
op_logical_or
id|p-&gt;type
op_eq
id|FB_TYPE_INTERLEAVED_PLANES
)paren
)paren
(brace
multiline_comment|/* planes (normal or interleaved), with color registers */
r_int
id|bit
suffix:semicolon
r_int
r_char
id|val
comma
id|mask
suffix:semicolon
r_int
id|plane
op_assign
id|p-&gt;next_plane
suffix:semicolon
multiline_comment|/* for support of Atari interleaved planes */
DECL|macro|MAP_X
mdefine_line|#define MAP_X(x)&t;(plane &gt; line ? x : (x &amp; ~1)*depth + (x &amp; 1))
multiline_comment|/* extract a bit from the source image */
DECL|macro|BIT
mdefine_line|#define&t;BIT(p,pix,bit)&t;(p[pix*logo_depth/8] &amp; &bslash;&n;&t;&t;&t; (1 &lt;&lt; ((8-((pix*logo_depth)&amp;7)-logo_depth) + bit)))
id|src
op_assign
id|logo
suffix:semicolon
r_for
c_loop
(paren
id|y1
op_assign
l_int|0
suffix:semicolon
id|y1
OL
id|LOGO_H
suffix:semicolon
id|y1
op_increment
)paren
(brace
r_for
c_loop
(paren
id|x1
op_assign
l_int|0
suffix:semicolon
id|x1
OL
id|LOGO_LINE
suffix:semicolon
id|x1
op_increment
comma
id|src
op_add_assign
id|logo_depth
)paren
(brace
id|dst
op_assign
id|fb
op_plus
id|y1
op_star
id|line
op_plus
id|MAP_X
c_func
(paren
id|x1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|0
suffix:semicolon
id|bit
OL
id|logo_depth
suffix:semicolon
id|bit
op_increment
)paren
(brace
id|val
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|mask
op_assign
l_int|0x80
comma
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|mask
op_rshift_assign
l_int|1
comma
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|BIT
c_func
(paren
id|src
comma
id|i
comma
id|bit
)paren
)paren
id|val
op_or_assign
id|mask
suffix:semicolon
)brace
op_star
id|dst
op_assign
id|val
suffix:semicolon
id|dst
op_add_assign
id|plane
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* fill remaining planes&n;&t; * special case for logo_depth == 4: we used color registers 16..31,&n;&t; * so fill plane 4 with 1 bits instead of 0 */
r_if
c_cond
(paren
id|depth
OG
id|logo_depth
)paren
(brace
r_for
c_loop
(paren
id|y1
op_assign
l_int|0
suffix:semicolon
id|y1
OL
id|LOGO_H
suffix:semicolon
id|y1
op_increment
)paren
(brace
r_for
c_loop
(paren
id|x1
op_assign
l_int|0
suffix:semicolon
id|x1
OL
id|LOGO_LINE
suffix:semicolon
id|x1
op_increment
)paren
(brace
id|dst
op_assign
id|fb
op_plus
id|y1
op_star
id|line
op_plus
id|MAP_X
c_func
(paren
id|x1
)paren
op_plus
id|logo_depth
op_star
id|plane
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|logo_depth
suffix:semicolon
id|i
OL
id|depth
suffix:semicolon
id|i
op_increment
comma
id|dst
op_add_assign
id|plane
)paren
(brace
op_star
id|dst
op_assign
(paren
id|i
op_eq
id|logo_depth
op_logical_and
id|logo_depth
op_eq
l_int|4
)paren
ques
c_cond
l_int|0xff
suffix:colon
l_int|0x00
suffix:semicolon
)brace
)brace
)brace
)brace
id|done
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_FBCON_MFB) || defined(CONFIG_FBCON_AFB) || &bslash;&n;    defined(CONFIG_FBCON_ILBM)
r_if
c_cond
(paren
id|depth
op_eq
l_int|1
)paren
(brace
multiline_comment|/* monochrome */
r_int
r_char
id|inverse
op_assign
id|p-&gt;inverse
ques
c_cond
l_int|0x00
suffix:colon
l_int|0xff
suffix:semicolon
multiline_comment|/* can&squot;t use simply memcpy because need to apply inverse */
r_for
c_loop
(paren
id|y1
op_assign
l_int|0
suffix:semicolon
id|y1
OL
id|LOGO_H
suffix:semicolon
id|y1
op_increment
)paren
(brace
id|src
op_assign
id|logo
op_plus
id|y1
op_star
id|LOGO_LINE
suffix:semicolon
id|dst
op_assign
id|fb
op_plus
id|y1
op_star
id|line
suffix:semicolon
r_for
c_loop
(paren
id|x1
op_assign
l_int|0
suffix:semicolon
id|x1
OL
id|LOGO_LINE
suffix:semicolon
op_increment
id|x1
)paren
(brace
op_star
id|dst
op_increment
op_assign
op_star
id|src
op_increment
op_xor
id|inverse
suffix:semicolon
)brace
)brace
id|done
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Modes not yet supported: packed pixels with depth != 8 (does such a&n;     * thing exist in reality?) */
r_return
id|done
ques
c_cond
id|LOGO_H
op_div
id|p-&gt;fontheight
op_plus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  The console `switch&squot; structure for the frame buffer based console&n; */
DECL|variable|fb_con
r_struct
id|consw
id|fb_con
op_assign
(brace
id|fbcon_startup
comma
id|fbcon_init
comma
id|fbcon_deinit
comma
id|fbcon_clear
comma
id|fbcon_putc
comma
id|fbcon_putcs
comma
id|fbcon_cursor
comma
id|fbcon_scroll
comma
id|fbcon_bmove
comma
id|fbcon_switch
comma
id|fbcon_blank
comma
id|fbcon_get_font
comma
id|fbcon_set_font
comma
id|fbcon_set_palette
comma
id|fbcon_scrolldelta
comma
id|fbcon_set_mode
)brace
suffix:semicolon
multiline_comment|/*&n; *  Dummy Low Level Operations&n; */
DECL|function|fbcon_dummy_op
r_static
r_void
id|fbcon_dummy_op
c_func
(paren
r_void
)paren
(brace
)brace
DECL|variable|fbcon_dummy
r_static
r_struct
id|display_switch
id|fbcon_dummy
op_assign
(brace
(paren
r_void
op_star
)paren
id|fbcon_dummy_op
comma
multiline_comment|/* fbcon_dummy_setup */
(paren
r_void
op_star
)paren
id|fbcon_dummy_op
comma
multiline_comment|/* fbcon_dummy_bmove */
(paren
r_void
op_star
)paren
id|fbcon_dummy_op
comma
multiline_comment|/* fbcon_dummy_clear */
(paren
r_void
op_star
)paren
id|fbcon_dummy_op
comma
multiline_comment|/* fbcon_dummy_putc */
(paren
r_void
op_star
)paren
id|fbcon_dummy_op
comma
multiline_comment|/* fbcon_dummy_putcs */
(paren
r_void
op_star
)paren
id|fbcon_dummy_op
comma
multiline_comment|/* fbcon_dummy_revc */
)brace
suffix:semicolon
multiline_comment|/*&n; *  Visible symbols for modules&n; */
DECL|variable|fb_display
id|EXPORT_SYMBOL
c_func
(paren
id|fb_display
)paren
suffix:semicolon
eof
