multiline_comment|/*&n; *  linux/drivers/video/compatcon.c -- Console wrapper&n; *&n; *&t;Created 26 Apr 1998 by Geert Uytterhoeven&n; *&n; *  This will be removed once there are frame buffer devices for all supported&n; *  graphics hardware&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/linux_logo.h&gt;
macro_line|#include &lt;linux/console_compat.h&gt;
multiline_comment|/*&n;     *  Interface used by the world&n;     */
r_static
r_const
r_char
op_star
id|compatcon_startup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|compatcon_init
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
suffix:semicolon
r_static
r_void
id|compatcon_deinit
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
suffix:semicolon
r_static
r_void
id|compatcon_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
suffix:semicolon
r_static
r_void
id|compatcon_putc
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|c
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
suffix:semicolon
r_static
r_void
id|compatcon_putcs
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_const
r_int
r_int
op_star
id|s
comma
r_int
id|count
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
suffix:semicolon
r_static
r_void
id|compatcon_cursor
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_int
id|compatcon_scroll
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|t
comma
r_int
id|b
comma
r_int
id|dir
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|compatcon_bmove
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
suffix:semicolon
r_static
r_int
id|compatcon_switch
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
suffix:semicolon
r_static
r_int
id|compatcon_blank
c_func
(paren
r_int
id|blank
)paren
suffix:semicolon
r_static
r_int
id|compatcon_get_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
op_star
id|w
comma
r_int
op_star
id|h
comma
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|compatcon_set_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|w
comma
r_int
id|h
comma
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|compatcon_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
r_char
op_star
id|table
)paren
suffix:semicolon
r_static
r_int
id|compatcon_scrolldelta
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|lines
)paren
suffix:semicolon
multiline_comment|/*&n;     *  Internal routines&n;     */
DECL|variable|video_num_columns
r_int
r_int
id|video_num_columns
suffix:semicolon
DECL|variable|video_num_lines
r_int
r_int
id|video_num_lines
suffix:semicolon
DECL|variable|video_size_row
r_int
r_int
id|video_size_row
suffix:semicolon
DECL|variable|video_type
r_int
r_char
id|video_type
suffix:semicolon
DECL|variable|video_mem_base
r_int
r_int
id|video_mem_base
suffix:semicolon
DECL|variable|video_mem_term
r_int
r_int
id|video_mem_term
suffix:semicolon
DECL|variable|video_screen_size
r_int
r_int
id|video_screen_size
suffix:semicolon
DECL|variable|can_do_color
r_int
id|can_do_color
suffix:semicolon
r_extern
r_void
id|set_cursor
c_func
(paren
r_int
id|currcons
)paren
suffix:semicolon
r_extern
r_void
id|hide_cursor
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|set_get_cmap
c_func
(paren
r_int
r_char
op_star
id|arg
comma
r_int
id|set
)paren
suffix:semicolon
r_extern
r_void
id|set_palette
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|set_get_font
c_func
(paren
r_int
r_char
op_star
id|arg
comma
r_int
id|set
comma
r_int
id|ch512
)paren
suffix:semicolon
r_extern
r_void
id|set_vesa_blanking
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_extern
r_void
id|vesa_blank
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|vesa_powerdown
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|con_adjust_height
c_func
(paren
r_int
r_int
id|fontheight
)paren
suffix:semicolon
r_extern
r_void
id|con_type_init
c_func
(paren
r_const
r_char
op_star
op_star
)paren
suffix:semicolon
r_extern
r_void
id|con_type_init_finish
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|macro|BLANK
mdefine_line|#define BLANK&t;0x0020
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_const
r_char
op_star
id|compatcon_startup
c_func
(paren
r_void
)paren
)paren
(brace
r_const
r_char
op_star
id|display_desc
op_assign
l_string|&quot;????&quot;
suffix:semicolon
id|video_num_lines
op_assign
id|ORIG_VIDEO_LINES
suffix:semicolon
id|video_num_columns
op_assign
id|ORIG_VIDEO_COLS
suffix:semicolon
id|video_size_row
op_assign
l_int|2
op_star
id|video_num_columns
suffix:semicolon
id|video_screen_size
op_assign
id|video_num_lines
op_star
id|video_size_row
suffix:semicolon
id|con_type_init
c_func
(paren
op_amp
id|display_desc
)paren
suffix:semicolon
r_return
id|display_desc
suffix:semicolon
)brace
DECL|function|compatcon_init
r_static
r_void
id|compatcon_init
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
id|conp-&gt;vc_cols
op_assign
id|video_num_columns
suffix:semicolon
id|conp-&gt;vc_rows
op_assign
id|video_num_lines
suffix:semicolon
id|conp-&gt;vc_can_do_color
op_assign
id|can_do_color
suffix:semicolon
r_if
c_cond
(paren
id|first
)paren
(brace
id|con_type_init_finish
c_func
(paren
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|compatcon_deinit
r_static
r_void
id|compatcon_deinit
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
)brace
DECL|function|compatcon_clear
r_static
r_void
id|compatcon_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_int
id|rows
suffix:semicolon
r_int
r_int
id|dest
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
suffix:semicolon
id|dest
op_assign
id|video_mem_base
op_plus
id|sy
op_star
id|video_size_row
op_plus
id|sx
op_star
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|sx
op_eq
l_int|0
op_logical_and
id|width
op_eq
id|video_num_columns
)paren
id|memsetw
c_func
(paren
(paren
r_void
op_star
)paren
id|dest
comma
id|conp-&gt;vc_video_erase_char
comma
id|height
op_star
id|video_size_row
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|rows
op_assign
id|height
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
id|dest
op_add_assign
id|video_size_row
)paren
id|memsetw
c_func
(paren
(paren
r_void
op_star
)paren
id|dest
comma
id|conp-&gt;vc_video_erase_char
comma
id|width
op_star
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|compatcon_putc
r_static
r_void
id|compatcon_putc
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|c
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
(brace
id|u16
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
suffix:semicolon
id|p
op_assign
(paren
id|u16
op_star
)paren
(paren
id|video_mem_base
op_plus
id|ypos
op_star
id|video_size_row
op_plus
id|xpos
op_star
l_int|2
)paren
suffix:semicolon
id|scr_writew
c_func
(paren
id|c
comma
id|p
)paren
suffix:semicolon
)brace
DECL|function|compatcon_putcs
r_static
r_void
id|compatcon_putcs
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_const
r_int
r_int
op_star
id|s
comma
r_int
id|count
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
(brace
id|u16
op_star
id|p
suffix:semicolon
id|u16
id|sattr
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
suffix:semicolon
id|p
op_assign
(paren
id|u16
op_star
)paren
(paren
id|video_mem_base
op_plus
id|ypos
op_star
id|video_size_row
op_plus
id|xpos
op_star
l_int|2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
id|scr_writew
c_func
(paren
op_star
id|s
op_increment
comma
id|p
op_increment
)paren
suffix:semicolon
)brace
DECL|function|compatcon_cursor
r_static
r_void
id|compatcon_cursor
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|mode
)paren
(brace
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|CM_ERASE
suffix:colon
id|hide_cursor
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CM_MOVE
suffix:colon
r_case
id|CM_DRAW
suffix:colon
id|set_cursor
c_func
(paren
id|conp-&gt;vc_num
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|compatcon_scroll
r_static
r_int
id|compatcon_scroll
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|t
comma
r_int
id|b
comma
r_int
id|dir
comma
r_int
id|count
)paren
(brace
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
l_int|0
suffix:semicolon
id|compatcon_cursor
c_func
(paren
id|conp
comma
id|CM_ERASE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dir
)paren
(brace
r_case
id|SM_UP
suffix:colon
r_if
c_cond
(paren
id|count
OG
id|conp-&gt;vc_rows
)paren
multiline_comment|/* Maximum realistic size */
id|count
op_assign
id|conp-&gt;vc_rows
suffix:semicolon
id|compatcon_bmove
c_func
(paren
id|conp
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|compatcon_clear
c_func
(paren
id|conp
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_DOWN
suffix:colon
r_if
c_cond
(paren
id|count
OG
id|conp-&gt;vc_rows
)paren
multiline_comment|/* Maximum realistic size */
id|count
op_assign
id|conp-&gt;vc_rows
suffix:semicolon
multiline_comment|/*&n;&t;     *  Fixed bmove() should end Arno&squot;s frustration with copying?&n;&t;     *  Confucius says:&n;&t;     *&t;Man who copies in wrong direction, end up with trashed&n;&t;     *&t;data&n;&t;     */
id|compatcon_bmove
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|compatcon_clear
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_LEFT
suffix:colon
id|compatcon_bmove
c_func
(paren
id|conp
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_rows
comma
id|b
op_minus
id|t
op_minus
id|count
)paren
suffix:semicolon
id|compatcon_clear
c_func
(paren
id|conp
comma
l_int|0
comma
id|b
op_minus
id|count
comma
id|conp-&gt;vc_rows
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_RIGHT
suffix:colon
id|compatcon_bmove
c_func
(paren
id|conp
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
id|conp-&gt;vc_rows
comma
id|b
op_minus
id|t
op_minus
id|count
)paren
suffix:semicolon
id|compatcon_clear
c_func
(paren
id|conp
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_rows
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|memmovew
r_static
r_inline
r_void
id|memmovew
c_func
(paren
id|u16
op_star
id|to
comma
id|u16
op_star
id|from
comma
r_int
r_int
id|count
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|to
OL
(paren
r_int
r_int
)paren
id|from
)paren
id|memcpyw
c_func
(paren
id|to
comma
id|from
comma
id|count
)paren
suffix:semicolon
r_else
(brace
id|count
op_div_assign
l_int|2
suffix:semicolon
id|to
op_add_assign
id|count
suffix:semicolon
id|from
op_add_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|scr_writew
c_func
(paren
id|scr_readw
c_func
(paren
op_decrement
id|from
)paren
comma
op_decrement
id|to
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|compatcon_bmove
r_static
r_void
id|compatcon_bmove
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_int
r_int
id|src
comma
id|dst
suffix:semicolon
r_int
id|rows
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|sx
op_eq
l_int|0
op_logical_and
id|dx
op_eq
l_int|0
op_logical_and
id|width
op_eq
id|video_num_columns
)paren
(brace
id|src
op_assign
id|video_mem_base
op_plus
id|sy
op_star
id|video_size_row
suffix:semicolon
id|dst
op_assign
id|video_mem_base
op_plus
id|dy
op_star
id|video_size_row
suffix:semicolon
id|memmovew
c_func
(paren
(paren
id|u16
op_star
)paren
id|dst
comma
(paren
id|u16
op_star
)paren
id|src
comma
id|height
op_star
id|video_size_row
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dy
OL
id|sy
op_logical_or
(paren
id|dy
op_eq
id|sy
op_logical_and
id|dx
OL
id|sx
)paren
)paren
(brace
id|src
op_assign
id|video_mem_base
op_plus
id|sy
op_star
id|video_size_row
op_plus
id|sx
op_star
l_int|2
suffix:semicolon
id|dst
op_assign
id|video_mem_base
op_plus
id|dy
op_star
id|video_size_row
op_plus
id|dx
op_star
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|rows
op_assign
id|height
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
)paren
(brace
id|memmovew
c_func
(paren
(paren
id|u16
op_star
)paren
id|dst
comma
(paren
id|u16
op_star
)paren
id|src
comma
id|width
op_star
l_int|2
)paren
suffix:semicolon
id|src
op_add_assign
id|video_size_row
suffix:semicolon
id|dst
op_add_assign
id|video_size_row
suffix:semicolon
)brace
)brace
r_else
(brace
id|src
op_assign
id|video_mem_base
op_plus
(paren
id|sy
op_plus
id|height
op_minus
l_int|1
)paren
op_star
id|video_size_row
op_plus
id|sx
op_star
l_int|2
suffix:semicolon
id|dst
op_assign
id|video_mem_base
op_plus
(paren
id|dy
op_plus
id|height
op_minus
l_int|1
)paren
op_star
id|video_size_row
op_plus
id|dx
op_star
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|rows
op_assign
id|height
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
)paren
(brace
id|memmovew
c_func
(paren
(paren
id|u16
op_star
)paren
id|dst
comma
(paren
id|u16
op_star
)paren
id|src
comma
id|width
op_star
l_int|2
)paren
suffix:semicolon
id|src
op_sub_assign
id|video_size_row
suffix:semicolon
id|dst
op_sub_assign
id|video_size_row
suffix:semicolon
)brace
)brace
)brace
DECL|function|compatcon_switch
r_static
r_int
id|compatcon_switch
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|compatcon_blank
r_static
r_int
id|compatcon_blank
c_func
(paren
r_int
id|blank
)paren
(brace
r_if
c_cond
(paren
id|blank
)paren
(brace
id|set_vesa_blanking
c_func
(paren
id|blank
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blank
op_minus
l_int|1
op_eq
l_int|0
)paren
id|vesa_blank
c_func
(paren
)paren
suffix:semicolon
r_else
id|vesa_powerdown
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Tell console.c that it has to restore the screen itself */
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|compatcon_get_font
r_static
r_int
id|compatcon_get_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
op_star
id|w
comma
r_int
op_star
id|h
comma
r_char
op_star
id|data
)paren
(brace
multiline_comment|/* this is not supported: data already points to a kernel space copy */
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
DECL|function|compatcon_set_font
r_static
r_int
id|compatcon_set_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|w
comma
r_int
id|h
comma
r_char
op_star
id|data
)paren
(brace
multiline_comment|/* this is not supported: data already points to a kernel space copy */
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
DECL|function|compatcon_set_palette
r_static
r_int
id|compatcon_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
r_char
op_star
id|table
)paren
(brace
r_if
c_cond
(paren
id|console_blanked
op_logical_or
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_GRAPHICS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|set_palette
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|compatcon_scrolldelta
r_static
r_int
id|compatcon_scrolldelta
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|lines
)paren
(brace
multiline_comment|/* TODO */
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
multiline_comment|/*&n;     *  The console `switch&squot; structure for the console wrapper&n;     */
DECL|variable|compat_con
r_struct
id|consw
id|compat_con
op_assign
(brace
id|compatcon_startup
comma
id|compatcon_init
comma
id|compatcon_deinit
comma
id|compatcon_clear
comma
id|compatcon_putc
comma
id|compatcon_putcs
comma
id|compatcon_cursor
comma
id|compatcon_scroll
comma
id|compatcon_bmove
comma
id|compatcon_switch
comma
id|compatcon_blank
comma
id|compatcon_get_font
comma
id|compatcon_set_font
comma
id|compatcon_set_palette
comma
id|compatcon_scrolldelta
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
eof
