multiline_comment|/*&n; *  linux/drivers/video/ilbm.c -- Low level frame buffer operations for&n; *&t;&t;&t;&t;  interleaved bitplanes &#xfffd; la Amiga&n; *&n; *&t;Created 5 Apr 1997 by Geert Uytterhoeven&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-ilbm.h&gt;
multiline_comment|/*&n;     *  Interleaved bitplanes &#xfffd; la Amiga&n;     *&n;     *  This code heavily relies on the fact that&n;     *&n;     *      next_line == interleave == next_plane*bits_per_pixel&n;     *&n;     *  But maybe it can be merged with the code for normal bitplanes without&n;     *  much performance loss?&n;     */
DECL|function|fbcon_ilbm_setup
r_void
id|fbcon_ilbm_setup
c_func
(paren
r_struct
id|display
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;line_length
)paren
(brace
id|p-&gt;next_line
op_assign
id|p-&gt;line_length
op_star
id|p-&gt;var.bits_per_pixel
suffix:semicolon
id|p-&gt;next_plane
op_assign
id|p-&gt;line_length
suffix:semicolon
)brace
r_else
(brace
id|p-&gt;next_line
op_assign
id|p-&gt;type_aux
suffix:semicolon
id|p-&gt;next_plane
op_assign
id|p-&gt;type_aux
op_div
id|p-&gt;var.bits_per_pixel
suffix:semicolon
)brace
)brace
DECL|function|fbcon_ilbm_bmove
r_void
id|fbcon_ilbm_bmove
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_if
c_cond
(paren
id|sx
op_eq
l_int|0
op_logical_and
id|dx
op_eq
l_int|0
op_logical_and
id|width
op_eq
id|p-&gt;next_plane
)paren
id|fb_memmove
c_func
(paren
id|p-&gt;screen_base
op_plus
id|dy
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
comma
id|p-&gt;screen_base
op_plus
id|sy
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
comma
id|height
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
)paren
suffix:semicolon
r_else
(brace
id|u8
op_star
id|src
comma
op_star
id|dest
suffix:semicolon
id|u_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dy
op_le
id|sy
)paren
(brace
id|src
op_assign
id|p-&gt;screen_base
op_plus
id|sy
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
op_plus
id|sx
suffix:semicolon
id|dest
op_assign
id|p-&gt;screen_base
op_plus
id|dy
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
op_plus
id|dx
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|p-&gt;var.bits_per_pixel
op_star
id|height
op_star
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
id|fb_memmove
c_func
(paren
id|dest
comma
id|src
comma
id|width
)paren
suffix:semicolon
id|src
op_add_assign
id|p-&gt;next_plane
suffix:semicolon
id|dest
op_add_assign
id|p-&gt;next_plane
suffix:semicolon
)brace
)brace
r_else
(brace
id|src
op_assign
id|p-&gt;screen_base
op_plus
(paren
id|sy
op_plus
id|height
)paren
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
op_plus
id|sx
suffix:semicolon
id|dest
op_assign
id|p-&gt;screen_base
op_plus
(paren
id|dy
op_plus
id|height
)paren
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
op_plus
id|dx
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|p-&gt;var.bits_per_pixel
op_star
id|height
op_star
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
id|src
op_sub_assign
id|p-&gt;next_plane
suffix:semicolon
id|dest
op_sub_assign
id|p-&gt;next_plane
suffix:semicolon
id|fb_memmove
c_func
(paren
id|dest
comma
id|src
comma
id|width
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|fbcon_ilbm_clear
r_void
id|fbcon_ilbm_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
id|u8
op_star
id|dest
suffix:semicolon
id|u_int
id|i
comma
id|rows
suffix:semicolon
r_int
id|bg
comma
id|bg0
suffix:semicolon
id|dest
op_assign
id|p-&gt;screen_base
op_plus
id|sy
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
op_plus
id|sx
suffix:semicolon
id|bg0
op_assign
id|attr_bgcol_ec
c_func
(paren
id|p
comma
id|conp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rows
op_assign
id|height
op_star
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
)paren
(brace
id|bg
op_assign
id|bg0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|p-&gt;var.bits_per_pixel
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|dest
op_add_assign
id|p-&gt;next_plane
)paren
(brace
r_if
c_cond
(paren
id|bg
op_amp
l_int|1
)paren
id|fb_memset255
c_func
(paren
id|dest
comma
id|width
)paren
suffix:semicolon
r_else
id|fb_memclear
c_func
(paren
id|dest
comma
id|width
)paren
suffix:semicolon
id|bg
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
DECL|function|fbcon_ilbm_putc
r_void
id|fbcon_ilbm_putc
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|c
comma
r_int
id|yy
comma
r_int
id|xx
)paren
(brace
id|u8
op_star
id|dest
comma
op_star
id|cdat
suffix:semicolon
id|u_int
id|rows
comma
id|i
suffix:semicolon
id|u8
id|d
suffix:semicolon
r_int
id|fg0
comma
id|bg0
comma
id|fg
comma
id|bg
suffix:semicolon
id|dest
op_assign
id|p-&gt;screen_base
op_plus
id|yy
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
op_plus
id|xx
suffix:semicolon
id|cdat
op_assign
id|p-&gt;fontdata
op_plus
(paren
id|c
op_amp
id|p-&gt;charmask
)paren
op_star
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|fg0
op_assign
id|attr_fgcol
c_func
(paren
id|p
comma
id|c
)paren
suffix:semicolon
id|bg0
op_assign
id|attr_bgcol
c_func
(paren
id|p
comma
id|c
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rows
op_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
)paren
(brace
id|d
op_assign
op_star
id|cdat
op_increment
suffix:semicolon
id|fg
op_assign
id|fg0
suffix:semicolon
id|bg
op_assign
id|bg0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|p-&gt;var.bits_per_pixel
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|dest
op_add_assign
id|p-&gt;next_plane
)paren
(brace
r_if
c_cond
(paren
id|bg
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|fg
op_amp
l_int|1
)paren
op_star
id|dest
op_assign
l_int|0xff
suffix:semicolon
r_else
op_star
id|dest
op_assign
op_complement
id|d
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|fg
op_amp
l_int|1
)paren
op_star
id|dest
op_assign
id|d
suffix:semicolon
r_else
op_star
id|dest
op_assign
l_int|0x00
suffix:semicolon
)brace
id|bg
op_rshift_assign
l_int|1
suffix:semicolon
id|fg
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;     *  I&squot;ve split the console character loop in two parts:&n;     *&n;     *      - slow version: this blits one character at a time&n;     *&n;     *      - fast version: this blits 4 characters at a time at a longword&n;     *&t;&t;&t;    aligned address, to reduce the number of expensive&n;     *&t;&t;&t;    Chip RAM accesses.&n;     *&n;     *  Experiments on my A4000/040 revealed that this makes a console switch&n;     *  on a 640x400 screen with 256 colors about 3 times faster.&n;     *&n;     *  -- Geert&n;     */
DECL|function|fbcon_ilbm_putcs
r_void
id|fbcon_ilbm_putcs
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_const
r_int
r_int
op_star
id|s
comma
r_int
id|count
comma
r_int
id|yy
comma
r_int
id|xx
)paren
(brace
id|u8
op_star
id|dest0
comma
op_star
id|dest
comma
op_star
id|cdat1
comma
op_star
id|cdat2
comma
op_star
id|cdat3
comma
op_star
id|cdat4
suffix:semicolon
id|u_int
id|rows
comma
id|i
suffix:semicolon
id|u16
id|c1
comma
id|c2
comma
id|c3
comma
id|c4
suffix:semicolon
id|u32
id|d
suffix:semicolon
r_int
id|fg0
comma
id|bg0
comma
id|fg
comma
id|bg
suffix:semicolon
id|dest0
op_assign
id|p-&gt;screen_base
op_plus
id|yy
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
op_plus
id|xx
suffix:semicolon
id|fg0
op_assign
id|attr_fgcol
c_func
(paren
id|p
comma
id|scr_readw
c_func
(paren
id|s
)paren
)paren
suffix:semicolon
id|bg0
op_assign
id|attr_bgcol
c_func
(paren
id|p
comma
id|scr_readw
c_func
(paren
id|s
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
r_if
c_cond
(paren
id|xx
op_amp
l_int|3
op_logical_or
id|count
OL
l_int|3
)paren
(brace
multiline_comment|/* Slow version */
id|c1
op_assign
id|scr_readw
c_func
(paren
id|s
op_increment
)paren
op_amp
id|p-&gt;charmask
suffix:semicolon
id|dest
op_assign
id|dest0
op_increment
suffix:semicolon
id|xx
op_increment
suffix:semicolon
id|cdat1
op_assign
id|p-&gt;fontdata
op_plus
id|c1
op_star
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rows
op_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
)paren
(brace
id|d
op_assign
op_star
id|cdat1
op_increment
suffix:semicolon
id|fg
op_assign
id|fg0
suffix:semicolon
id|bg
op_assign
id|bg0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|p-&gt;var.bits_per_pixel
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|dest
op_add_assign
id|p-&gt;next_plane
)paren
(brace
r_if
c_cond
(paren
id|bg
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|fg
op_amp
l_int|1
)paren
op_star
id|dest
op_assign
l_int|0xff
suffix:semicolon
r_else
op_star
id|dest
op_assign
op_complement
id|d
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|fg
op_amp
l_int|1
)paren
op_star
id|dest
op_assign
id|d
suffix:semicolon
r_else
op_star
id|dest
op_assign
l_int|0x00
suffix:semicolon
)brace
id|bg
op_rshift_assign
l_int|1
suffix:semicolon
id|fg
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Fast version */
id|c1
op_assign
id|scr_readw
c_func
(paren
op_amp
id|s
(braket
l_int|0
)braket
)paren
op_amp
id|p-&gt;charmask
suffix:semicolon
id|c2
op_assign
id|scr_readw
c_func
(paren
op_amp
id|s
(braket
l_int|1
)braket
)paren
op_amp
id|p-&gt;charmask
suffix:semicolon
id|c3
op_assign
id|scr_readw
c_func
(paren
op_amp
id|s
(braket
l_int|2
)braket
)paren
op_amp
id|p-&gt;charmask
suffix:semicolon
id|c4
op_assign
id|scr_readw
c_func
(paren
op_amp
id|s
(braket
l_int|3
)braket
)paren
op_amp
id|p-&gt;charmask
suffix:semicolon
id|dest
op_assign
id|dest0
suffix:semicolon
id|cdat1
op_assign
id|p-&gt;fontdata
op_plus
id|c1
op_star
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|cdat2
op_assign
id|p-&gt;fontdata
op_plus
id|c2
op_star
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|cdat3
op_assign
id|p-&gt;fontdata
op_plus
id|c3
op_star
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|cdat4
op_assign
id|p-&gt;fontdata
op_plus
id|c4
op_star
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rows
op_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
)paren
(brace
macro_line|#if defined(__BIG_ENDIAN)
id|d
op_assign
op_star
id|cdat1
op_increment
op_lshift
l_int|24
op_or
op_star
id|cdat2
op_increment
op_lshift
l_int|16
op_or
op_star
id|cdat3
op_increment
op_lshift
l_int|8
op_or
op_star
id|cdat4
op_increment
suffix:semicolon
macro_line|#elif defined(__LITTLE_ENDIAN)
id|d
op_assign
op_star
id|cdat1
op_increment
op_or
op_star
id|cdat2
op_increment
op_lshift
l_int|8
op_or
op_star
id|cdat3
op_increment
op_lshift
l_int|16
op_or
op_star
id|cdat4
op_increment
op_lshift
l_int|24
suffix:semicolon
macro_line|#else
macro_line|#error FIXME: No endianness??
macro_line|#endif
id|fg
op_assign
id|fg0
suffix:semicolon
id|bg
op_assign
id|bg0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|p-&gt;var.bits_per_pixel
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|dest
op_add_assign
id|p-&gt;next_plane
)paren
(brace
r_if
c_cond
(paren
id|bg
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|fg
op_amp
l_int|1
)paren
op_star
(paren
id|u32
op_star
)paren
id|dest
op_assign
l_int|0xffffffff
suffix:semicolon
r_else
op_star
(paren
id|u32
op_star
)paren
id|dest
op_assign
op_complement
id|d
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|fg
op_amp
l_int|1
)paren
op_star
(paren
id|u32
op_star
)paren
id|dest
op_assign
id|d
suffix:semicolon
r_else
op_star
(paren
id|u32
op_star
)paren
id|dest
op_assign
l_int|0x00000000
suffix:semicolon
)brace
id|bg
op_rshift_assign
l_int|1
suffix:semicolon
id|fg
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
id|s
op_add_assign
l_int|4
suffix:semicolon
id|dest0
op_add_assign
l_int|4
suffix:semicolon
id|xx
op_add_assign
l_int|4
suffix:semicolon
id|count
op_sub_assign
l_int|3
suffix:semicolon
)brace
)brace
DECL|function|fbcon_ilbm_revc
r_void
id|fbcon_ilbm_revc
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|xx
comma
r_int
id|yy
)paren
(brace
id|u8
op_star
id|dest
comma
op_star
id|dest0
suffix:semicolon
id|u_int
id|rows
comma
id|i
suffix:semicolon
r_int
id|mask
suffix:semicolon
id|dest0
op_assign
id|p-&gt;screen_base
op_plus
id|yy
op_star
id|fontheight
c_func
(paren
id|p
)paren
op_star
id|p-&gt;next_line
op_plus
id|xx
suffix:semicolon
id|mask
op_assign
id|p-&gt;fgcol
op_xor
id|p-&gt;bgcol
suffix:semicolon
multiline_comment|/*&n;     *  This should really obey the individual character&squot;s&n;     *  background and foreground colors instead of simply&n;     *  inverting.&n;     */
r_for
c_loop
(paren
id|i
op_assign
id|p-&gt;var.bits_per_pixel
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|dest0
op_add_assign
id|p-&gt;next_plane
)paren
(brace
r_if
c_cond
(paren
id|mask
op_amp
l_int|1
)paren
(brace
id|dest
op_assign
id|dest0
suffix:semicolon
r_for
c_loop
(paren
id|rows
op_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
id|dest
op_add_assign
id|p-&gt;next_line
)paren
op_star
id|dest
op_assign
op_complement
op_star
id|dest
suffix:semicolon
)brace
id|mask
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;     *  `switch&squot; for the low level operations&n;     */
DECL|variable|fbcon_ilbm
r_struct
id|display_switch
id|fbcon_ilbm
op_assign
(brace
id|setup
suffix:colon
id|fbcon_ilbm_setup
comma
id|bmove
suffix:colon
id|fbcon_ilbm_bmove
comma
id|clear
suffix:colon
id|fbcon_ilbm_clear
comma
id|putc
suffix:colon
id|fbcon_ilbm_putc
comma
id|putcs
suffix:colon
id|fbcon_ilbm_putcs
comma
id|revc
suffix:colon
id|fbcon_ilbm_revc
comma
id|fontwidthmask
suffix:colon
id|FONTWIDTH
c_func
(paren
l_int|8
)paren
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif /* MODULE */
multiline_comment|/*&n;     *  Visible symbols for modules&n;     */
DECL|variable|fbcon_ilbm
id|EXPORT_SYMBOL
c_func
(paren
id|fbcon_ilbm
)paren
suffix:semicolon
DECL|variable|fbcon_ilbm_setup
id|EXPORT_SYMBOL
c_func
(paren
id|fbcon_ilbm_setup
)paren
suffix:semicolon
DECL|variable|fbcon_ilbm_bmove
id|EXPORT_SYMBOL
c_func
(paren
id|fbcon_ilbm_bmove
)paren
suffix:semicolon
DECL|variable|fbcon_ilbm_clear
id|EXPORT_SYMBOL
c_func
(paren
id|fbcon_ilbm_clear
)paren
suffix:semicolon
DECL|variable|fbcon_ilbm_putc
id|EXPORT_SYMBOL
c_func
(paren
id|fbcon_ilbm_putc
)paren
suffix:semicolon
DECL|variable|fbcon_ilbm_putcs
id|EXPORT_SYMBOL
c_func
(paren
id|fbcon_ilbm_putcs
)paren
suffix:semicolon
DECL|variable|fbcon_ilbm_revc
id|EXPORT_SYMBOL
c_func
(paren
id|fbcon_ilbm_revc
)paren
suffix:semicolon
eof
