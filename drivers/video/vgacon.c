multiline_comment|/*&n; *  linux/drivers/video/vgacon.c -- Low level VGA based console driver&n; *&n; *&t;Created 28 Sep 1997 by Geert Uytterhoeven&n; *&n; *  This file is based on the old console.c, vga.c and vesa_blank.c drivers.&n; *&n; *&t;Copyright (C) 1991, 1992  Linus Torvalds&n; *&t;&t;&t;    1995  Jay Estabrook&n; *&n; *&t;User definable mapping table and font loading by Eugene G. Crosser,&n; *&t;&lt;crosser@pccross.msk.su&gt;&n; *&n; *&t;Improved loadable font/UTF-8 support by H. Peter Anvin&n; *&t;Feb-Sep 1995 &lt;peter.anvin@linux.org&gt;&n; *&n; *&t;Colour palette handling, by Simon Tatham&n; *&t;17-Jun-95 &lt;sgt20@cam.ac.uk&gt;&n; *&n; *&t;if 512 char mode is already enabled don&squot;t re-enable it,&n; *&t;because it causes screen to flicker, by Mitja Horvat&n; *&t;5-May-96 &lt;mitja.horvat@guest.arnes.si&gt;&n; *&n; *&t;Use 2 outw instead of 4 outb_p to reduce erroneous text&n; *&t;flashing on RHS of screen during heavy console scrolling .&n; *&t;Oct 1996, Paul Gortmaker.&n; *&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
multiline_comment|/* KNOWN PROBLEMS/TO DO ===================================================== *&n; *&n; *&t;- monochrome attribute encoding (convert abscon &lt;-&gt; VGA style)&n; *&n; *&t;- speed up scrolling by changing the screen origin&n; *&n; *&t;- add support for palette, loadable fonts and VESA blanking&n; *&n; * KNOWN PROBLEMS/TO DO ==================================================== */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/linux_logo.h&gt;
DECL|macro|BLANK
mdefine_line|#define BLANK 0x0020
DECL|macro|CAN_LOAD_EGA_FONTS
mdefine_line|#define CAN_LOAD_EGA_FONTS&t;/* undefine if the user must not do this */
DECL|macro|CAN_LOAD_PALETTE
mdefine_line|#define CAN_LOAD_PALETTE&t;/* undefine if the user must not do this */
DECL|macro|dac_reg
mdefine_line|#define dac_reg&t;(0x3c8)
DECL|macro|dac_val
mdefine_line|#define dac_val&t;(0x3c9)
macro_line|#ifdef __powerpc__
DECL|macro|VGA_OFFSET
mdefine_line|#define VGA_OFFSET _ISA_MEM_BASE;
macro_line|#else
DECL|macro|VGA_OFFSET
mdefine_line|#define VGA_OFFSET 0x0
macro_line|#endif
multiline_comment|/*&n; *  Interface used by the world&n; */
r_static
r_int
r_int
id|vgacon_startup
c_func
(paren
r_int
r_int
id|kmem_start
comma
r_const
r_char
op_star
op_star
id|display_desc
)paren
suffix:semicolon
r_static
r_void
id|vgacon_init
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
suffix:semicolon
r_static
r_int
id|vgacon_deinit
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
suffix:semicolon
r_static
r_int
id|vgacon_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
suffix:semicolon
r_static
r_int
id|vgacon_putc
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|c
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
suffix:semicolon
r_static
r_int
id|vgacon_putcs
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_const
r_char
op_star
id|s
comma
r_int
id|count
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
suffix:semicolon
r_static
r_int
id|vgacon_cursor
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_int
id|vgacon_scroll
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|t
comma
r_int
id|b
comma
r_int
id|dir
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|vgacon_bmove
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
suffix:semicolon
r_static
r_int
id|vgacon_switch
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
suffix:semicolon
r_static
r_int
id|vgacon_blank
c_func
(paren
r_int
id|blank
)paren
suffix:semicolon
r_static
r_int
id|vgacon_get_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
op_star
id|w
comma
r_int
op_star
id|h
comma
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|vgacon_set_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|w
comma
r_int
id|h
comma
r_char
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|vgacon_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
r_char
op_star
id|table
)paren
suffix:semicolon
r_static
r_int
id|vgacon_scrolldelta
c_func
(paren
r_int
id|lines
)paren
suffix:semicolon
multiline_comment|/*&n; *  Internal routines&n; */
r_static
r_int
id|vgacon_show_logo
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Description of the hardware situation */
DECL|variable|vga_video_mem_base
r_static
r_int
r_int
id|vga_video_mem_base
suffix:semicolon
multiline_comment|/* Base of video memory */
DECL|variable|vga_video_mem_term
r_static
r_int
r_int
id|vga_video_mem_term
suffix:semicolon
multiline_comment|/* End of video memory */
DECL|variable|vga_video_port_reg
r_static
r_int
r_int
id|vga_video_port_reg
suffix:semicolon
multiline_comment|/* Video register select port */
DECL|variable|vga_video_port_val
r_static
r_int
r_int
id|vga_video_port_val
suffix:semicolon
multiline_comment|/* Video register value port */
DECL|variable|vga_video_num_columns
r_static
r_int
r_int
id|vga_video_num_columns
suffix:semicolon
multiline_comment|/* Number of text columns */
DECL|variable|vga_video_num_lines
r_static
r_int
r_int
id|vga_video_num_lines
suffix:semicolon
multiline_comment|/* Number of text lines */
DECL|variable|vga_video_size_row
r_static
r_int
r_int
id|vga_video_size_row
suffix:semicolon
DECL|variable|vga_video_screen_size
r_static
r_int
r_int
id|vga_video_screen_size
suffix:semicolon
DECL|variable|vga_can_do_color
r_static
r_int
id|vga_can_do_color
op_assign
l_int|0
suffix:semicolon
DECL|variable|vga_default_font_height
r_static
r_int
r_int
id|vga_default_font_height
suffix:semicolon
multiline_comment|/* Height of default screen font */
DECL|variable|vga_video_type
r_static
r_int
r_char
id|vga_video_type
suffix:semicolon
DECL|variable|vga_has_wrapped
r_static
r_int
r_char
id|vga_has_wrapped
suffix:semicolon
multiline_comment|/* all of videomem is data of fg_console */
DECL|variable|vga_hardscroll_enabled
r_static
r_int
r_char
id|vga_hardscroll_enabled
suffix:semicolon
DECL|variable|vga_hardscroll_disabled_by_init
r_static
r_int
r_char
id|vga_hardscroll_disabled_by_init
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;     *  VGA screen access&n;     */
DECL|function|vga_writew
r_static
r_inline
r_void
id|vga_writew
c_func
(paren
r_int
r_int
id|val
comma
r_int
r_int
op_star
id|addr
)paren
(brace
macro_line|#ifdef __powerpc__
id|st_le16
c_func
(paren
id|addr
comma
id|val
)paren
suffix:semicolon
macro_line|#else
id|writew
c_func
(paren
id|val
comma
(paren
r_int
r_int
)paren
id|addr
)paren
suffix:semicolon
macro_line|#endif /* !__powerpc__ */
)brace
DECL|function|vga_readw
r_static
r_inline
r_int
r_int
id|vga_readw
c_func
(paren
r_int
r_int
op_star
id|addr
)paren
(brace
macro_line|#ifdef __powerpc__
r_return
id|ld_le16
c_func
(paren
id|addr
)paren
suffix:semicolon
macro_line|#else
r_return
id|readw
c_func
(paren
(paren
r_int
r_int
)paren
id|addr
)paren
suffix:semicolon
macro_line|#endif /* !__powerpc__ */&t;
)brace
DECL|function|vga_memsetw
r_static
r_inline
r_void
id|vga_memsetw
c_func
(paren
r_void
op_star
id|s
comma
r_int
r_int
id|c
comma
r_int
r_int
id|count
)paren
(brace
r_int
r_int
op_star
id|addr
op_assign
(paren
r_int
r_int
op_star
)paren
id|s
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|vga_writew
c_func
(paren
id|c
comma
id|addr
op_increment
)paren
suffix:semicolon
)brace
)brace
DECL|function|vga_memmovew
r_static
r_inline
r_void
id|vga_memmovew
c_func
(paren
r_int
r_int
op_star
id|to
comma
r_int
r_int
op_star
id|from
comma
r_int
r_int
id|count
)paren
(brace
r_if
c_cond
(paren
id|to
OL
id|from
)paren
(brace
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|vga_writew
c_func
(paren
id|vga_readw
c_func
(paren
id|from
op_increment
)paren
comma
id|to
op_increment
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|from
op_add_assign
id|count
suffix:semicolon
id|to
op_add_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|vga_writew
c_func
(paren
id|vga_readw
c_func
(paren
op_decrement
id|from
)paren
comma
op_decrement
id|to
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * By replacing the four outb_p with two back to back outw, we can reduce&n; * the window of opportunity to see text mislocated to the RHS of the&n; * console during heavy scrolling activity. However there is the remote&n; * possibility that some pre-dinosaur hardware won&squot;t like the back to back&n; * I/O. Since the Xservers get away with it, we should be able to as well.&n; */
DECL|function|write_vga
r_static
r_inline
r_void
id|write_vga
c_func
(paren
r_int
r_char
id|reg
comma
r_int
r_int
id|val
)paren
(brace
macro_line|#ifndef SLOW_VGA
r_int
r_int
id|v1
comma
id|v2
suffix:semicolon
id|v1
op_assign
id|reg
op_plus
(paren
id|val
op_amp
l_int|0xff00
)paren
suffix:semicolon
id|v2
op_assign
id|reg
op_plus
l_int|1
op_plus
(paren
(paren
id|val
op_lshift
l_int|8
)paren
op_amp
l_int|0xff00
)paren
suffix:semicolon
id|outw
c_func
(paren
id|v1
comma
id|vga_video_port_reg
)paren
suffix:semicolon
id|outw
c_func
(paren
id|v2
comma
id|vga_video_port_reg
)paren
suffix:semicolon
macro_line|#else
id|outb_p
c_func
(paren
id|reg
comma
id|vga_video_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|val
op_rshift
l_int|8
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|reg
op_plus
l_int|1
comma
id|vga_video_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|val
op_amp
l_int|0xff
comma
id|vga_video_port_val
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
r_int
id|vgacon_startup
c_func
(paren
r_int
r_int
id|kmem_start
comma
r_const
r_char
op_star
op_star
id|display_desc
)paren
)paren
(brace
r_int
r_int
id|saved
suffix:semicolon
r_int
r_int
op_star
id|p
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Find out if there is a graphics card present.&n;&t; *&t;Are there smarter methods around?&n;&t; */
id|p
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
(paren
id|ORIG_VIDEO_MODE
op_eq
l_int|7
)paren
ques
c_cond
l_int|0xb0000
suffix:colon
l_int|0xb8000
)paren
op_plus
op_plus
id|VGA_OFFSET
)paren
suffix:semicolon
id|saved
op_assign
id|vga_readw
c_func
(paren
id|p
)paren
suffix:semicolon
id|vga_writew
c_func
(paren
l_int|0xAA55
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vga_readw
c_func
(paren
id|p
)paren
op_ne
l_int|0xAA55
)paren
(brace
id|vga_writew
c_func
(paren
id|saved
comma
id|p
)paren
suffix:semicolon
r_return
id|kmem_start
suffix:semicolon
)brace
id|vga_writew
c_func
(paren
l_int|0x55AA
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vga_readw
c_func
(paren
id|p
)paren
op_ne
l_int|0x55AA
)paren
(brace
id|vga_writew
c_func
(paren
id|saved
comma
id|p
)paren
suffix:semicolon
r_return
id|kmem_start
suffix:semicolon
)brace
id|vga_writew
c_func
(paren
id|saved
comma
id|p
)paren
suffix:semicolon
id|vga_video_num_lines
op_assign
id|ORIG_VIDEO_LINES
suffix:semicolon
id|vga_video_num_columns
op_assign
id|ORIG_VIDEO_COLS
suffix:semicolon
id|vga_video_size_row
op_assign
l_int|2
op_star
id|ORIG_VIDEO_COLS
suffix:semicolon
id|vga_video_screen_size
op_assign
id|vga_video_num_lines
op_star
id|vga_video_size_row
suffix:semicolon
r_if
c_cond
(paren
id|ORIG_VIDEO_MODE
op_eq
l_int|7
)paren
multiline_comment|/* Is this a monochrome display? */
(brace
id|vga_video_mem_base
op_assign
l_int|0xb0000
op_plus
id|VGA_OFFSET
suffix:semicolon
id|vga_video_port_reg
op_assign
l_int|0x3b4
suffix:semicolon
id|vga_video_port_val
op_assign
l_int|0x3b5
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ORIG_VIDEO_EGA_BX
op_amp
l_int|0xff
)paren
op_ne
l_int|0x10
)paren
(brace
id|vga_video_type
op_assign
id|VIDEO_TYPE_EGAM
suffix:semicolon
id|vga_video_mem_term
op_assign
l_int|0xb8000
op_plus
id|VGA_OFFSET
suffix:semicolon
op_star
id|display_desc
op_assign
l_string|&quot;EGA+&quot;
suffix:semicolon
id|request_region
c_func
(paren
l_int|0x3b0
comma
l_int|16
comma
l_string|&quot;ega&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|vga_video_type
op_assign
id|VIDEO_TYPE_MDA
suffix:semicolon
id|vga_video_mem_term
op_assign
l_int|0xb2000
op_plus
id|VGA_OFFSET
suffix:semicolon
op_star
id|display_desc
op_assign
l_string|&quot;*MDA&quot;
suffix:semicolon
id|request_region
c_func
(paren
l_int|0x3b0
comma
l_int|12
comma
l_string|&quot;mda&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
l_int|0x3bf
comma
l_int|1
comma
l_string|&quot;mda&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* If not, it is color. */
(brace
id|vga_can_do_color
op_assign
l_int|1
suffix:semicolon
id|vga_video_mem_base
op_assign
l_int|0xb8000
op_plus
id|VGA_OFFSET
suffix:semicolon
id|vga_video_port_reg
op_assign
l_int|0x3d4
suffix:semicolon
id|vga_video_port_val
op_assign
l_int|0x3d5
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ORIG_VIDEO_EGA_BX
op_amp
l_int|0xff
)paren
op_ne
l_int|0x10
)paren
(brace
r_int
id|i
suffix:semicolon
id|vga_video_mem_term
op_assign
l_int|0xc0000
op_plus
id|VGA_OFFSET
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ORIG_VIDEO_ISVGA
)paren
(brace
id|vga_video_type
op_assign
id|VIDEO_TYPE_EGAC
suffix:semicolon
op_star
id|display_desc
op_assign
l_string|&quot;EGA&quot;
suffix:semicolon
id|request_region
c_func
(paren
l_int|0x3c0
comma
l_int|32
comma
l_string|&quot;ega&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|vga_video_type
op_assign
id|VIDEO_TYPE_VGAC
suffix:semicolon
op_star
id|display_desc
op_assign
l_string|&quot;VGA+&quot;
suffix:semicolon
id|request_region
c_func
(paren
l_int|0x3c0
comma
l_int|32
comma
l_string|&quot;vga+&quot;
)paren
suffix:semicolon
macro_line|#ifdef VGA_CAN_DO_64KB
multiline_comment|/*&n;&t;&t;&t;&t; * get 64K rather than 32K of video RAM.&n;&t;&t;&t;&t; * This doesn&squot;t actually work on all &quot;VGA&quot;&n;&t;&t;&t;&t; * controllers (it seems like setting MM=01&n;&t;&t;&t;&t; * and COE=1 isn&squot;t necessarily a good idea)&n;&t;&t;&t;&t; */
id|vga_video_mem_base
op_assign
l_int|0xa0000
op_plus
id|VGA_OFFSET
suffix:semicolon
id|vga_video_mem_term
op_assign
l_int|0xb0000
op_plus
id|VGA_OFFSET
suffix:semicolon
id|outb_p
(paren
l_int|6
comma
l_int|0x3ce
)paren
suffix:semicolon
id|outb_p
(paren
l_int|6
comma
l_int|0x3cf
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t;&t; * Normalise the palette registers, to point&n;&t;&t;&t;&t; * the 16 screen colours to the first 16&n;&t;&t;&t;&t; * DAC entries.&n;&t;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|inb_p
(paren
l_int|0x3da
)paren
suffix:semicolon
id|outb_p
(paren
id|i
comma
l_int|0x3c0
)paren
suffix:semicolon
id|outb_p
(paren
id|i
comma
l_int|0x3c0
)paren
suffix:semicolon
)brace
id|outb_p
(paren
l_int|0x20
comma
l_int|0x3c0
)paren
suffix:semicolon
multiline_comment|/* now set the DAC registers back to their&n;&t;&t;&t;&t; * default values */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_p
(paren
id|color_table
(braket
id|i
)braket
comma
l_int|0x3c8
)paren
suffix:semicolon
id|outb_p
(paren
id|default_red
(braket
id|i
)braket
comma
l_int|0x3c9
)paren
suffix:semicolon
id|outb_p
(paren
id|default_grn
(braket
id|i
)braket
comma
l_int|0x3c9
)paren
suffix:semicolon
id|outb_p
(paren
id|default_blu
(braket
id|i
)braket
comma
l_int|0x3c9
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|vga_video_type
op_assign
id|VIDEO_TYPE_CGA
suffix:semicolon
id|vga_video_mem_term
op_assign
l_int|0xba000
op_plus
id|VGA_OFFSET
suffix:semicolon
op_star
id|display_desc
op_assign
l_string|&quot;*CGA&quot;
suffix:semicolon
id|request_region
c_func
(paren
l_int|0x3d4
comma
l_int|2
comma
l_string|&quot;cga&quot;
)paren
suffix:semicolon
)brace
)brace
id|vga_hardscroll_enabled
op_assign
(paren
id|vga_hardscroll_disabled_by_init
ques
c_cond
l_int|0
suffix:colon
(paren
id|vga_video_type
op_eq
id|VIDEO_TYPE_EGAC
op_logical_or
id|vga_video_type
op_eq
id|VIDEO_TYPE_VGAC
op_logical_or
id|vga_video_type
op_eq
id|VIDEO_TYPE_EGAM
)paren
)paren
suffix:semicolon
id|vga_has_wrapped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vga_video_type
op_eq
id|VIDEO_TYPE_VGAC
op_logical_or
id|vga_video_type
op_eq
id|VIDEO_TYPE_EGAC
op_logical_or
id|vga_video_type
op_eq
id|VIDEO_TYPE_EGAM
)paren
(brace
id|vga_default_font_height
op_assign
id|ORIG_VIDEO_POINTS
suffix:semicolon
id|video_font_height
op_assign
id|ORIG_VIDEO_POINTS
suffix:semicolon
multiline_comment|/* This may be suboptimal but is a safe bet - go with it */
id|video_scan_lines
op_assign
id|video_font_height
op_star
id|vga_video_num_lines
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|console_show_logo
)paren
id|console_show_logo
op_assign
id|vgacon_show_logo
suffix:semicolon
r_return
id|kmem_start
suffix:semicolon
)brace
DECL|function|vgacon_init
r_static
r_void
id|vgacon_init
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
id|conp-&gt;vc_cols
op_assign
id|vga_video_num_columns
suffix:semicolon
id|conp-&gt;vc_rows
op_assign
id|vga_video_num_lines
suffix:semicolon
id|conp-&gt;vc_can_do_color
op_assign
id|vga_can_do_color
suffix:semicolon
)brace
DECL|function|vgacon_deinit
r_static
r_int
id|vgacon_deinit
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ====================================================================== */
DECL|function|vgacon_clear
r_static
r_int
id|vgacon_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_int
id|rows
suffix:semicolon
r_int
r_int
id|dest
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
l_int|0
suffix:semicolon
id|dest
op_assign
id|vga_video_mem_base
op_plus
id|sy
op_star
id|vga_video_size_row
op_plus
id|sx
op_star
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|sx
op_eq
l_int|0
op_logical_and
id|width
op_eq
id|vga_video_num_columns
)paren
id|vga_memsetw
c_func
(paren
(paren
r_void
op_star
)paren
id|dest
comma
id|conp-&gt;vc_video_erase_char
comma
id|height
op_star
id|width
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|rows
op_assign
id|height
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
id|dest
op_add_assign
id|vga_video_size_row
)paren
id|vga_memsetw
c_func
(paren
(paren
r_void
op_star
)paren
id|dest
comma
id|conp-&gt;vc_video_erase_char
comma
id|width
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_putc
r_static
r_int
id|vgacon_putc
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|c
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
(brace
id|u_short
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
l_int|0
suffix:semicolon
id|p
op_assign
(paren
id|u_short
op_star
)paren
(paren
id|vga_video_mem_base
op_plus
id|ypos
op_star
id|vga_video_size_row
op_plus
id|xpos
op_star
l_int|2
)paren
suffix:semicolon
id|vga_writew
c_func
(paren
id|conp-&gt;vc_attr
op_lshift
l_int|8
op_or
id|c
comma
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_putcs
r_static
r_int
id|vgacon_putcs
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_const
r_char
op_star
id|s
comma
r_int
id|count
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
(brace
id|u_short
op_star
id|p
suffix:semicolon
id|u_short
id|sattr
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
l_int|0
suffix:semicolon
id|p
op_assign
(paren
id|u_short
op_star
)paren
(paren
id|vga_video_mem_base
op_plus
id|ypos
op_star
id|vga_video_size_row
op_plus
id|xpos
op_star
l_int|2
)paren
suffix:semicolon
id|sattr
op_assign
id|conp-&gt;vc_attr
op_lshift
l_int|8
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
id|vga_writew
c_func
(paren
id|sattr
op_or
op_star
id|s
op_increment
comma
id|p
op_increment
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_cursor
r_static
r_int
id|vgacon_cursor
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|mode
)paren
(brace
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|CM_ERASE
suffix:colon
id|write_vga
c_func
(paren
l_int|14
comma
(paren
id|vga_video_mem_term
op_minus
id|vga_video_mem_base
op_minus
l_int|1
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CM_MOVE
suffix:colon
r_case
id|CM_DRAW
suffix:colon
id|write_vga
c_func
(paren
l_int|14
comma
id|conp-&gt;vc_y
op_star
id|vga_video_num_columns
op_plus
id|conp-&gt;vc_x
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_scroll
r_static
r_int
id|vgacon_scroll
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|t
comma
r_int
id|b
comma
r_int
id|dir
comma
r_int
id|count
)paren
(brace
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
l_int|0
suffix:semicolon
id|vgacon_cursor
c_func
(paren
id|conp
comma
id|CM_ERASE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dir
)paren
(brace
r_case
id|SM_UP
suffix:colon
r_if
c_cond
(paren
id|count
OG
id|conp-&gt;vc_rows
)paren
multiline_comment|/* Maximum realistic size */
id|count
op_assign
id|conp-&gt;vc_rows
suffix:semicolon
id|vgacon_bmove
c_func
(paren
id|conp
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|vgacon_clear
c_func
(paren
id|conp
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_DOWN
suffix:colon
r_if
c_cond
(paren
id|count
OG
id|conp-&gt;vc_rows
)paren
multiline_comment|/* Maximum realistic size */
id|count
op_assign
id|conp-&gt;vc_rows
suffix:semicolon
multiline_comment|/*&n;&t;     *  Fixed bmove() should end Arno&squot;s frustration with copying?&n;&t;     *  Confucius says:&n;&t;     *&t;Man who copies in wrong direction, end up with trashed&n;&t;     *&t;data&n;&t;     */
id|vgacon_bmove
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|vgacon_clear
c_func
(paren
id|conp
comma
id|t
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_LEFT
suffix:colon
id|vgacon_bmove
c_func
(paren
id|conp
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_rows
comma
id|b
op_minus
id|t
op_minus
id|count
)paren
suffix:semicolon
id|vgacon_clear
c_func
(paren
id|conp
comma
l_int|0
comma
id|b
op_minus
id|count
comma
id|conp-&gt;vc_rows
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_RIGHT
suffix:colon
id|vgacon_bmove
c_func
(paren
id|conp
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
id|conp-&gt;vc_rows
comma
id|b
op_minus
id|t
op_minus
id|count
)paren
suffix:semicolon
id|vgacon_clear
c_func
(paren
id|conp
comma
l_int|0
comma
id|t
comma
id|conp-&gt;vc_rows
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_bmove
r_static
r_int
id|vgacon_bmove
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_int
r_int
id|src
comma
id|dst
suffix:semicolon
r_int
id|rows
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sx
op_eq
l_int|0
op_logical_and
id|dx
op_eq
l_int|0
op_logical_and
id|width
op_eq
id|vga_video_num_columns
)paren
(brace
id|src
op_assign
id|vga_video_mem_base
op_plus
id|sy
op_star
id|vga_video_size_row
suffix:semicolon
id|dst
op_assign
id|vga_video_mem_base
op_plus
id|dy
op_star
id|vga_video_size_row
suffix:semicolon
id|vga_memmovew
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
comma
(paren
r_int
r_int
op_star
)paren
id|src
comma
id|height
op_star
id|width
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dy
OL
id|sy
op_logical_or
(paren
id|dy
op_eq
id|sy
op_logical_and
id|dx
OL
id|sx
)paren
)paren
(brace
id|src
op_assign
id|vga_video_mem_base
op_plus
id|sy
op_star
id|vga_video_size_row
op_plus
id|sx
op_star
l_int|2
suffix:semicolon
id|dst
op_assign
id|vga_video_mem_base
op_plus
id|dy
op_star
id|vga_video_size_row
op_plus
id|dx
op_star
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|rows
op_assign
id|height
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
)paren
(brace
id|vga_memmovew
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
comma
(paren
r_int
r_int
op_star
)paren
id|src
comma
id|width
)paren
suffix:semicolon
id|src
op_add_assign
id|vga_video_size_row
suffix:semicolon
id|dst
op_add_assign
id|vga_video_size_row
suffix:semicolon
)brace
)brace
r_else
(brace
id|src
op_assign
id|vga_video_mem_base
op_plus
(paren
id|sy
op_plus
id|height
op_minus
l_int|1
)paren
op_star
id|vga_video_size_row
op_plus
id|sx
op_star
l_int|2
suffix:semicolon
id|dst
op_assign
id|vga_video_mem_base
op_plus
(paren
id|dy
op_plus
id|height
op_minus
l_int|1
)paren
op_star
id|vga_video_size_row
op_plus
id|dx
op_star
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|rows
op_assign
id|height
suffix:semicolon
id|rows
op_decrement
suffix:semicolon
)paren
(brace
id|vga_memmovew
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|dst
comma
(paren
r_int
r_int
op_star
)paren
id|src
comma
id|width
)paren
suffix:semicolon
id|src
op_sub_assign
id|vga_video_size_row
suffix:semicolon
id|dst
op_sub_assign
id|vga_video_size_row
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_switch
r_static
r_int
id|vgacon_switch
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_blank
r_static
r_int
id|vgacon_blank
c_func
(paren
r_int
id|blank
)paren
(brace
r_if
c_cond
(paren
id|blank
)paren
(brace
id|vga_memsetw
c_func
(paren
(paren
r_void
op_star
)paren
id|vga_video_mem_base
comma
id|BLANK
comma
id|vga_video_screen_size
op_div
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Tell console.c that it has to restore the screen itself */
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_get_font
r_static
r_int
id|vgacon_get_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
op_star
id|w
comma
r_int
op_star
id|h
comma
r_char
op_star
id|data
)paren
(brace
multiline_comment|/* TODO */
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
DECL|function|vgacon_set_font
r_static
r_int
id|vgacon_set_font
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|w
comma
r_int
id|h
comma
r_char
op_star
id|data
)paren
(brace
multiline_comment|/* TODO */
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
DECL|function|vgacon_set_palette
r_static
r_int
id|vgacon_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
r_char
op_star
id|table
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|vga_video_type
op_ne
id|VIDEO_TYPE_VGAC
op_logical_or
id|console_blanked
op_logical_or
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_GRAPHICS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_p
(paren
id|table
(braket
id|i
)braket
comma
id|dac_reg
)paren
suffix:semicolon
id|outb_p
(paren
id|vc_cons
(braket
id|fg_console
)braket
dot
id|d-&gt;vc_palette
(braket
id|j
op_increment
)braket
op_rshift
l_int|2
comma
id|dac_val
)paren
suffix:semicolon
id|outb_p
(paren
id|vc_cons
(braket
id|fg_console
)braket
dot
id|d-&gt;vc_palette
(braket
id|j
op_increment
)braket
op_rshift
l_int|2
comma
id|dac_val
)paren
suffix:semicolon
id|outb_p
(paren
id|vc_cons
(braket
id|fg_console
)braket
dot
id|d-&gt;vc_palette
(braket
id|j
op_increment
)braket
op_rshift
l_int|2
comma
id|dac_val
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_scrolldelta
r_static
r_int
id|vgacon_scrolldelta
c_func
(paren
r_int
id|lines
)paren
(brace
multiline_comment|/* TODO */
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|vgacon_show_logo
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|height
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|printk
c_func
(paren
id|linux_serial_image
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|linux_serial_image
suffix:semicolon
op_star
id|p
suffix:semicolon
id|p
op_increment
)paren
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|height
op_increment
suffix:semicolon
r_return
id|height
suffix:semicolon
)brace
multiline_comment|/*&n; *  The console `switch&squot; structure for the VGA based console&n; */
DECL|variable|vga_con
r_struct
id|consw
id|vga_con
op_assign
(brace
id|vgacon_startup
comma
id|vgacon_init
comma
id|vgacon_deinit
comma
id|vgacon_clear
comma
id|vgacon_putc
comma
id|vgacon_putcs
comma
id|vgacon_cursor
comma
id|vgacon_scroll
comma
id|vgacon_bmove
comma
id|vgacon_switch
comma
id|vgacon_blank
comma
id|vgacon_get_font
comma
id|vgacon_set_font
comma
id|vgacon_set_palette
comma
id|vgacon_scrolldelta
)brace
suffix:semicolon
eof
