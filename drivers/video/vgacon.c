multiline_comment|/*&n; *  linux/drivers/video/vgacon.c -- Low level VGA based console driver&n; *&n; *&t;Created 28 Sep 1997 by Geert Uytterhoeven&n; *&n; *&t;Rewritten by Martin Mares &lt;mj@ucw.cz&gt;, July 1998&n; *&n; *  This file is based on the old console.c, vga.c and vesa_blank.c drivers.&n; *&n; *&t;Copyright (C) 1991, 1992  Linus Torvalds&n; *&t;&t;&t;    1995  Jay Estabrook&n; *&n; *&t;User definable mapping table and font loading by Eugene G. Crosser,&n; *&t;&lt;crosser@average.org&gt;&n; *&n; *&t;Improved loadable font/UTF-8 support by H. Peter Anvin&n; *&t;Feb-Sep 1995 &lt;peter.anvin@linux.org&gt;&n; *&n; *&t;Colour palette handling, by Simon Tatham&n; *&t;17-Jun-95 &lt;sgt20@cam.ac.uk&gt;&n; *&n; *&t;if 512 char mode is already enabled don&squot;t re-enable it,&n; *&t;because it causes screen to flicker, by Mitja Horvat&n; *&t;5-May-96 &lt;mitja.horvat@guest.arnes.si&gt;&n; *&n; *&t;Use 2 outw instead of 4 outb_p to reduce erroneous text&n; *&t;flashing on RHS of screen during heavy console scrolling .&n; *&t;Oct 1996, Paul Gortmaker.&n; *&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|variable|vga_lock
r_static
id|spinlock_t
id|vga_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|macro|BLANK
mdefine_line|#define BLANK 0x0020
DECL|macro|CAN_LOAD_EGA_FONTS
mdefine_line|#define CAN_LOAD_EGA_FONTS&t;/* undefine if the user must not do this */
DECL|macro|CAN_LOAD_PALETTE
mdefine_line|#define CAN_LOAD_PALETTE&t;/* undefine if the user must not do this */
multiline_comment|/* You really do _NOT_ want to define this, unless you have buggy&n; * Trident VGA which will resize cursor when moving it between column&n; * 15 &amp; 16. If you define this and your VGA is OK, inverse bug will&n; * appear.&n; */
DECL|macro|TRIDENT_GLITCH
macro_line|#undef TRIDENT_GLITCH
DECL|macro|dac_reg
mdefine_line|#define dac_reg&t;&t;0x3c8
DECL|macro|dac_val
mdefine_line|#define dac_val&t;&t;0x3c9
DECL|macro|attrib_port
mdefine_line|#define attrib_port&t;0x3c0
DECL|macro|seq_port_reg
mdefine_line|#define seq_port_reg&t;0x3c4
DECL|macro|seq_port_val
mdefine_line|#define seq_port_val&t;0x3c5
DECL|macro|gr_port_reg
mdefine_line|#define gr_port_reg&t;0x3ce
DECL|macro|gr_port_val
mdefine_line|#define gr_port_val&t;0x3cf
DECL|macro|video_misc_rd
mdefine_line|#define video_misc_rd&t;0x3cc
DECL|macro|video_misc_wr
mdefine_line|#define video_misc_wr&t;0x3c2
multiline_comment|/*&n; *  Interface used by the world&n; */
r_static
r_const
r_char
op_star
id|vgacon_startup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|vgacon_init
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|init
)paren
suffix:semicolon
r_static
r_void
id|vgacon_deinit
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
suffix:semicolon
r_static
r_void
id|vgacon_cursor
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|mode
)paren
suffix:semicolon
r_static
r_int
id|vgacon_switch
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
suffix:semicolon
r_static
r_int
id|vgacon_blank
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|blank
)paren
suffix:semicolon
r_static
r_int
id|vgacon_font_op
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_struct
id|console_font_op
op_star
id|op
)paren
suffix:semicolon
r_static
r_int
id|vgacon_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
r_char
op_star
id|table
)paren
suffix:semicolon
r_static
r_int
id|vgacon_scrolldelta
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|lines
)paren
suffix:semicolon
r_static
r_int
id|vgacon_set_origin
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
suffix:semicolon
r_static
r_void
id|vgacon_save_screen
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
suffix:semicolon
r_static
r_int
id|vgacon_scroll
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|t
comma
r_int
id|b
comma
r_int
id|dir
comma
r_int
id|lines
)paren
suffix:semicolon
r_static
id|u8
id|vgacon_build_attr
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
id|u8
id|color
comma
id|u8
id|intensity
comma
id|u8
id|blink
comma
id|u8
id|underline
comma
id|u8
id|reverse
)paren
suffix:semicolon
r_static
r_void
id|vgacon_invert_region
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
id|u16
op_star
id|p
comma
r_int
id|count
)paren
suffix:semicolon
DECL|variable|vgacon_uni_pagedir
r_static
r_int
r_int
id|vgacon_uni_pagedir
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Description of the hardware situation */
DECL|variable|vga_vram_base
r_static
r_int
r_int
id|vga_vram_base
suffix:semicolon
multiline_comment|/* Base of video memory */
DECL|variable|vga_vram_end
r_static
r_int
r_int
id|vga_vram_end
suffix:semicolon
multiline_comment|/* End of video memory */
DECL|variable|vga_video_port_reg
r_static
id|u16
id|vga_video_port_reg
suffix:semicolon
multiline_comment|/* Video register select port */
DECL|variable|vga_video_port_val
r_static
id|u16
id|vga_video_port_val
suffix:semicolon
multiline_comment|/* Video register value port */
DECL|variable|vga_video_num_columns
r_static
r_int
r_int
id|vga_video_num_columns
suffix:semicolon
multiline_comment|/* Number of text columns */
DECL|variable|vga_video_num_lines
r_static
r_int
r_int
id|vga_video_num_lines
suffix:semicolon
multiline_comment|/* Number of text lines */
DECL|variable|vga_can_do_color
r_static
r_int
id|vga_can_do_color
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Do we support colors? */
DECL|variable|vga_default_font_height
r_static
r_int
r_int
id|vga_default_font_height
suffix:semicolon
multiline_comment|/* Height of default screen font */
DECL|variable|vga_video_type
r_static
r_int
r_char
id|vga_video_type
suffix:semicolon
multiline_comment|/* Card type */
DECL|variable|vga_hardscroll_enabled
r_static
r_int
r_char
id|vga_hardscroll_enabled
suffix:semicolon
macro_line|#ifdef CONFIG_IA64_SOFTSDV_HACKS
multiline_comment|/*&n; * SoftSDV doesn&squot;t have hardware assist VGA scrolling &n; */
DECL|variable|vga_hardscroll_user_enable
r_static
r_int
r_char
id|vga_hardscroll_user_enable
op_assign
l_int|0
suffix:semicolon
macro_line|#else
DECL|variable|vga_hardscroll_user_enable
r_static
r_int
r_char
id|vga_hardscroll_user_enable
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
DECL|variable|vga_font_is_default
r_static
r_int
r_char
id|vga_font_is_default
op_assign
l_int|1
suffix:semicolon
DECL|variable|vga_vesa_blanked
r_static
r_int
id|vga_vesa_blanked
suffix:semicolon
DECL|variable|vga_palette_blanked
r_static
r_int
id|vga_palette_blanked
suffix:semicolon
DECL|variable|vga_is_gfx
r_static
r_int
id|vga_is_gfx
suffix:semicolon
DECL|variable|vga_512_chars
r_static
r_int
id|vga_512_chars
suffix:semicolon
DECL|variable|vga_video_font_height
r_static
r_int
id|vga_video_font_height
suffix:semicolon
DECL|variable|vga_rolled_over
r_static
r_int
r_int
id|vga_rolled_over
op_assign
l_int|0
suffix:semicolon
DECL|function|no_scroll
r_static
r_int
id|__init
id|no_scroll
c_func
(paren
r_char
op_star
id|str
)paren
(brace
multiline_comment|/*&n;&t; * Disabling scrollback is required for the Braillex ib80-piezo&n;&t; * Braille reader made by F.H. Papenmeier (Germany).&n;&t; * Use the &quot;no-scroll&quot; bootflag.&n;&t; */
id|vga_hardscroll_user_enable
op_assign
id|vga_hardscroll_enabled
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;no-scroll&quot;
comma
id|no_scroll
)paren
suffix:semicolon
multiline_comment|/*&n; * By replacing the four outb_p with two back to back outw, we can reduce&n; * the window of opportunity to see text mislocated to the RHS of the&n; * console during heavy scrolling activity. However there is the remote&n; * possibility that some pre-dinosaur hardware won&squot;t like the back to back&n; * I/O. Since the Xservers get away with it, we should be able to as well.&n; */
DECL|function|write_vga
r_static
r_inline
r_void
id|write_vga
c_func
(paren
r_int
r_char
id|reg
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|v1
comma
id|v2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;&t; * ddprintk might set the console position from interrupt&n;&t; * handlers, thus the write has to be IRQ-atomic.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|vga_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifndef SLOW_VGA
id|v1
op_assign
id|reg
op_plus
(paren
id|val
op_amp
l_int|0xff00
)paren
suffix:semicolon
id|v2
op_assign
id|reg
op_plus
l_int|1
op_plus
(paren
(paren
id|val
op_lshift
l_int|8
)paren
op_amp
l_int|0xff00
)paren
suffix:semicolon
id|outw
c_func
(paren
id|v1
comma
id|vga_video_port_reg
)paren
suffix:semicolon
id|outw
c_func
(paren
id|v2
comma
id|vga_video_port_reg
)paren
suffix:semicolon
macro_line|#else
id|outb_p
c_func
(paren
id|reg
comma
id|vga_video_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|val
op_rshift
l_int|8
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|reg
op_plus
l_int|1
comma
id|vga_video_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|val
op_amp
l_int|0xff
comma
id|vga_video_port_val
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|vga_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|vgacon_startup
r_static
r_const
r_char
id|__init
op_star
id|vgacon_startup
c_func
(paren
r_void
)paren
(brace
r_const
r_char
op_star
id|display_desc
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|saved1
comma
id|saved2
suffix:semicolon
r_volatile
id|u16
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|ORIG_VIDEO_ISVGA
op_eq
id|VIDEO_TYPE_VLFB
)paren
(brace
id|no_vga
suffix:colon
macro_line|#ifdef CONFIG_DUMMY_CONSOLE
id|conswitchp
op_assign
op_amp
id|dummy_con
suffix:semicolon
r_return
id|conswitchp
op_member_access_from_pointer
id|con_startup
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
r_return
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
id|vga_video_num_lines
op_assign
id|ORIG_VIDEO_LINES
suffix:semicolon
id|vga_video_num_columns
op_assign
id|ORIG_VIDEO_COLS
suffix:semicolon
r_if
c_cond
(paren
id|ORIG_VIDEO_MODE
op_eq
l_int|7
)paren
multiline_comment|/* Is this a monochrome display? */
(brace
id|vga_vram_base
op_assign
l_int|0xb0000
suffix:semicolon
id|vga_video_port_reg
op_assign
l_int|0x3b4
suffix:semicolon
id|vga_video_port_val
op_assign
l_int|0x3b5
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ORIG_VIDEO_EGA_BX
op_amp
l_int|0xff
)paren
op_ne
l_int|0x10
)paren
(brace
r_static
r_struct
id|resource
id|ega_console_resource
op_assign
(brace
l_string|&quot;ega&quot;
comma
l_int|0x3B0
comma
l_int|0x3BF
)brace
suffix:semicolon
id|vga_video_type
op_assign
id|VIDEO_TYPE_EGAM
suffix:semicolon
id|vga_vram_end
op_assign
l_int|0xb8000
suffix:semicolon
id|display_desc
op_assign
l_string|&quot;EGA+&quot;
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|ega_console_resource
)paren
suffix:semicolon
)brace
r_else
(brace
r_static
r_struct
id|resource
id|mda1_console_resource
op_assign
(brace
l_string|&quot;mda&quot;
comma
l_int|0x3B0
comma
l_int|0x3BB
)brace
suffix:semicolon
r_static
r_struct
id|resource
id|mda2_console_resource
op_assign
(brace
l_string|&quot;mda&quot;
comma
l_int|0x3BF
comma
l_int|0x3BF
)brace
suffix:semicolon
id|vga_video_type
op_assign
id|VIDEO_TYPE_MDA
suffix:semicolon
id|vga_vram_end
op_assign
l_int|0xb2000
suffix:semicolon
id|display_desc
op_assign
l_string|&quot;*MDA&quot;
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|mda1_console_resource
)paren
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|mda2_console_resource
)paren
suffix:semicolon
id|vga_video_font_height
op_assign
l_int|14
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* If not, it is color. */
(brace
id|vga_can_do_color
op_assign
l_int|1
suffix:semicolon
id|vga_vram_base
op_assign
l_int|0xb8000
suffix:semicolon
id|vga_video_port_reg
op_assign
l_int|0x3d4
suffix:semicolon
id|vga_video_port_val
op_assign
l_int|0x3d5
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ORIG_VIDEO_EGA_BX
op_amp
l_int|0xff
)paren
op_ne
l_int|0x10
)paren
(brace
r_int
id|i
suffix:semicolon
id|vga_vram_end
op_assign
l_int|0xc0000
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ORIG_VIDEO_ISVGA
)paren
(brace
r_static
r_struct
id|resource
id|ega_console_resource
op_assign
(brace
l_string|&quot;ega&quot;
comma
l_int|0x3C0
comma
l_int|0x3DF
)brace
suffix:semicolon
id|vga_video_type
op_assign
id|VIDEO_TYPE_EGAC
suffix:semicolon
id|display_desc
op_assign
l_string|&quot;EGA&quot;
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|ega_console_resource
)paren
suffix:semicolon
)brace
r_else
(brace
r_static
r_struct
id|resource
id|vga_console_resource
op_assign
(brace
l_string|&quot;vga+&quot;
comma
l_int|0x3C0
comma
l_int|0x3DF
)brace
suffix:semicolon
id|vga_video_type
op_assign
id|VIDEO_TYPE_VGAC
suffix:semicolon
id|display_desc
op_assign
l_string|&quot;VGA+&quot;
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|vga_console_resource
)paren
suffix:semicolon
macro_line|#ifdef VGA_CAN_DO_64KB
multiline_comment|/*&n;&t;&t;&t;&t; * get 64K rather than 32K of video RAM.&n;&t;&t;&t;&t; * This doesn&squot;t actually work on all &quot;VGA&quot;&n;&t;&t;&t;&t; * controllers (it seems like setting MM=01&n;&t;&t;&t;&t; * and COE=1 isn&squot;t necessarily a good idea)&n;&t;&t;&t;&t; */
id|vga_vram_base
op_assign
l_int|0xa0000
suffix:semicolon
id|vga_vram_end
op_assign
l_int|0xb0000
suffix:semicolon
id|outb_p
(paren
l_int|6
comma
l_int|0x3ce
)paren
suffix:semicolon
id|outb_p
(paren
l_int|6
comma
l_int|0x3cf
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;&t;&t; * Normalise the palette registers, to point&n;&t;&t;&t;&t; * the 16 screen colours to the first 16&n;&t;&t;&t;&t; * DAC entries.&n;&t;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|inb_p
(paren
l_int|0x3da
)paren
suffix:semicolon
id|outb_p
(paren
id|i
comma
l_int|0x3c0
)paren
suffix:semicolon
id|outb_p
(paren
id|i
comma
l_int|0x3c0
)paren
suffix:semicolon
)brace
id|outb_p
(paren
l_int|0x20
comma
l_int|0x3c0
)paren
suffix:semicolon
multiline_comment|/* now set the DAC registers back to their&n;&t;&t;&t;&t; * default values */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_p
(paren
id|color_table
(braket
id|i
)braket
comma
l_int|0x3c8
)paren
suffix:semicolon
id|outb_p
(paren
id|default_red
(braket
id|i
)braket
comma
l_int|0x3c9
)paren
suffix:semicolon
id|outb_p
(paren
id|default_grn
(braket
id|i
)braket
comma
l_int|0x3c9
)paren
suffix:semicolon
id|outb_p
(paren
id|default_blu
(braket
id|i
)braket
comma
l_int|0x3c9
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_static
r_struct
id|resource
id|cga_console_resource
op_assign
(brace
l_string|&quot;cga&quot;
comma
l_int|0x3D4
comma
l_int|0x3D5
)brace
suffix:semicolon
id|vga_video_type
op_assign
id|VIDEO_TYPE_CGA
suffix:semicolon
id|vga_vram_end
op_assign
l_int|0xba000
suffix:semicolon
id|display_desc
op_assign
l_string|&quot;*CGA&quot;
suffix:semicolon
id|request_resource
c_func
(paren
op_amp
id|ioport_resource
comma
op_amp
id|cga_console_resource
)paren
suffix:semicolon
id|vga_video_font_height
op_assign
l_int|8
suffix:semicolon
)brace
)brace
id|vga_vram_base
op_assign
id|VGA_MAP_MEM
c_func
(paren
id|vga_vram_base
)paren
suffix:semicolon
id|vga_vram_end
op_assign
id|VGA_MAP_MEM
c_func
(paren
id|vga_vram_end
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Find out if there is a graphics card present.&n;&t; *&t;Are there smarter methods around?&n;&t; */
id|p
op_assign
(paren
r_volatile
id|u16
op_star
)paren
id|vga_vram_base
suffix:semicolon
id|saved1
op_assign
id|scr_readw
c_func
(paren
id|p
)paren
suffix:semicolon
id|saved2
op_assign
id|scr_readw
c_func
(paren
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|scr_writew
c_func
(paren
l_int|0xAA55
comma
id|p
)paren
suffix:semicolon
id|scr_writew
c_func
(paren
l_int|0x55AA
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scr_readw
c_func
(paren
id|p
)paren
op_ne
l_int|0xAA55
op_logical_or
id|scr_readw
c_func
(paren
id|p
op_plus
l_int|1
)paren
op_ne
l_int|0x55AA
)paren
(brace
id|scr_writew
c_func
(paren
id|saved1
comma
id|p
)paren
suffix:semicolon
id|scr_writew
c_func
(paren
id|saved2
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
r_goto
id|no_vga
suffix:semicolon
)brace
id|scr_writew
c_func
(paren
l_int|0x55AA
comma
id|p
)paren
suffix:semicolon
id|scr_writew
c_func
(paren
l_int|0xAA55
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scr_readw
c_func
(paren
id|p
)paren
op_ne
l_int|0x55AA
op_logical_or
id|scr_readw
c_func
(paren
id|p
op_plus
l_int|1
)paren
op_ne
l_int|0xAA55
)paren
(brace
id|scr_writew
c_func
(paren
id|saved1
comma
id|p
)paren
suffix:semicolon
id|scr_writew
c_func
(paren
id|saved2
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
r_goto
id|no_vga
suffix:semicolon
)brace
id|scr_writew
c_func
(paren
id|saved1
comma
id|p
)paren
suffix:semicolon
id|scr_writew
c_func
(paren
id|saved2
comma
id|p
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vga_video_type
op_eq
id|VIDEO_TYPE_EGAC
op_logical_or
id|vga_video_type
op_eq
id|VIDEO_TYPE_VGAC
op_logical_or
id|vga_video_type
op_eq
id|VIDEO_TYPE_EGAM
)paren
(brace
id|vga_hardscroll_enabled
op_assign
id|vga_hardscroll_user_enable
suffix:semicolon
id|vga_default_font_height
op_assign
id|ORIG_VIDEO_POINTS
suffix:semicolon
id|vga_video_font_height
op_assign
id|ORIG_VIDEO_POINTS
suffix:semicolon
multiline_comment|/* This may be suboptimal but is a safe bet - go with it */
id|video_scan_lines
op_assign
id|vga_video_font_height
op_star
id|vga_video_num_lines
suffix:semicolon
)brace
id|video_font_height
op_assign
id|vga_video_font_height
suffix:semicolon
r_return
id|display_desc
suffix:semicolon
)brace
DECL|function|vgacon_init
r_static
r_void
id|vgacon_init
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|init
)paren
(brace
r_int
r_int
id|p
suffix:semicolon
multiline_comment|/* We cannot be loaded as a module, therefore init is always 1 */
id|c-&gt;vc_can_do_color
op_assign
id|vga_can_do_color
suffix:semicolon
id|c-&gt;vc_cols
op_assign
id|vga_video_num_columns
suffix:semicolon
id|c-&gt;vc_rows
op_assign
id|vga_video_num_lines
suffix:semicolon
id|c-&gt;vc_complement_mask
op_assign
l_int|0x7700
suffix:semicolon
id|p
op_assign
op_star
id|c-&gt;vc_uni_pagedir_loc
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;vc_uni_pagedir_loc
op_eq
op_amp
id|c-&gt;vc_uni_pagedir
op_logical_or
op_logical_neg
op_decrement
id|c-&gt;vc_uni_pagedir_loc
(braket
l_int|1
)braket
)paren
id|con_free_unimap
c_func
(paren
id|c-&gt;vc_num
)paren
suffix:semicolon
id|c-&gt;vc_uni_pagedir_loc
op_assign
id|vgacon_uni_pagedir
suffix:semicolon
id|vgacon_uni_pagedir
(braket
l_int|1
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vgacon_uni_pagedir
(braket
l_int|0
)braket
op_logical_and
id|p
)paren
id|con_set_default_unimap
c_func
(paren
id|c-&gt;vc_num
)paren
suffix:semicolon
)brace
DECL|function|vga_set_mem_top
r_static
r_inline
r_void
id|vga_set_mem_top
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
(brace
id|write_vga
c_func
(paren
l_int|12
comma
(paren
id|c-&gt;vc_visible_origin
op_minus
id|vga_vram_base
)paren
op_div
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|vgacon_deinit
r_static
r_void
id|vgacon_deinit
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
(brace
multiline_comment|/* When closing the last console, reset video origin */
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|vgacon_uni_pagedir
(braket
l_int|1
)braket
)paren
(brace
id|c-&gt;vc_visible_origin
op_assign
id|vga_vram_base
suffix:semicolon
id|vga_set_mem_top
c_func
(paren
id|c
)paren
suffix:semicolon
id|con_free_unimap
c_func
(paren
id|c-&gt;vc_num
)paren
suffix:semicolon
)brace
id|c-&gt;vc_uni_pagedir_loc
op_assign
op_amp
id|c-&gt;vc_uni_pagedir
suffix:semicolon
id|con_set_default_unimap
c_func
(paren
id|c-&gt;vc_num
)paren
suffix:semicolon
)brace
DECL|function|vgacon_build_attr
r_static
id|u8
id|vgacon_build_attr
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
id|u8
id|color
comma
id|u8
id|intensity
comma
id|u8
id|blink
comma
id|u8
id|underline
comma
id|u8
id|reverse
)paren
(brace
id|u8
id|attr
op_assign
id|color
suffix:semicolon
r_if
c_cond
(paren
id|vga_can_do_color
)paren
(brace
r_if
c_cond
(paren
id|underline
)paren
id|attr
op_assign
(paren
id|attr
op_amp
l_int|0xf0
)paren
op_or
id|c-&gt;vc_ulcolor
suffix:semicolon
r_else
r_if
c_cond
(paren
id|intensity
op_eq
l_int|0
)paren
id|attr
op_assign
(paren
id|attr
op_amp
l_int|0xf0
)paren
op_or
id|c-&gt;vc_halfcolor
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reverse
)paren
id|attr
op_assign
(paren
(paren
id|attr
)paren
op_amp
l_int|0x88
)paren
op_or
(paren
(paren
(paren
(paren
id|attr
)paren
op_rshift
l_int|4
)paren
op_or
(paren
(paren
id|attr
)paren
op_lshift
l_int|4
)paren
)paren
op_amp
l_int|0x77
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blink
)paren
id|attr
op_xor_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|intensity
op_eq
l_int|2
)paren
id|attr
op_xor_assign
l_int|0x08
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vga_can_do_color
)paren
(brace
r_if
c_cond
(paren
id|underline
)paren
id|attr
op_assign
(paren
id|attr
op_amp
l_int|0xf8
)paren
op_or
l_int|0x01
suffix:semicolon
r_else
r_if
c_cond
(paren
id|intensity
op_eq
l_int|0
)paren
id|attr
op_assign
(paren
id|attr
op_amp
l_int|0xf0
)paren
op_or
l_int|0x08
suffix:semicolon
)brace
r_return
id|attr
suffix:semicolon
)brace
DECL|function|vgacon_invert_region
r_static
r_void
id|vgacon_invert_region
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
id|u16
op_star
id|p
comma
r_int
id|count
)paren
(brace
r_int
id|col
op_assign
id|vga_can_do_color
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|u16
id|a
op_assign
id|scr_readw
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|col
)paren
id|a
op_assign
(paren
(paren
id|a
)paren
op_amp
l_int|0x88ff
)paren
op_or
(paren
(paren
(paren
id|a
)paren
op_amp
l_int|0x7000
)paren
op_rshift
l_int|4
)paren
op_or
(paren
(paren
(paren
id|a
)paren
op_amp
l_int|0x0700
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
r_else
id|a
op_xor_assign
(paren
(paren
id|a
op_amp
l_int|0x0700
)paren
op_eq
l_int|0x0100
)paren
ques
c_cond
l_int|0x7000
suffix:colon
l_int|0x7700
suffix:semicolon
id|scr_writew
c_func
(paren
id|a
comma
id|p
op_increment
)paren
suffix:semicolon
)brace
)brace
DECL|function|vgacon_set_cursor_size
r_static
r_void
id|vgacon_set_cursor_size
c_func
(paren
r_int
id|xpos
comma
r_int
id|from
comma
r_int
id|to
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|curs
comma
id|cure
suffix:semicolon
r_static
r_int
id|lastfrom
comma
id|lastto
suffix:semicolon
macro_line|#ifdef TRIDENT_GLITCH
r_if
c_cond
(paren
id|xpos
OL
l_int|16
)paren
id|from
op_decrement
comma
id|to
op_decrement
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|from
op_eq
id|lastfrom
)paren
op_logical_and
(paren
id|to
op_eq
id|lastto
)paren
)paren
r_return
suffix:semicolon
id|lastfrom
op_assign
id|from
suffix:semicolon
id|lastto
op_assign
id|to
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|vga_lock
comma
id|flags
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x0a
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Cursor start */
id|curs
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x0b
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Cursor end */
id|cure
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|curs
op_assign
(paren
id|curs
op_amp
l_int|0xc0
)paren
op_or
id|from
suffix:semicolon
id|cure
op_assign
(paren
id|cure
op_amp
l_int|0xe0
)paren
op_or
id|to
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x0a
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Cursor start */
id|outb_p
c_func
(paren
id|curs
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x0b
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Cursor end */
id|outb_p
c_func
(paren
id|cure
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|vga_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|vgacon_cursor
r_static
r_void
id|vgacon_cursor
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|mode
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;vc_origin
op_ne
id|c-&gt;vc_visible_origin
)paren
id|vgacon_scrolldelta
c_func
(paren
id|c
comma
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|CM_ERASE
suffix:colon
id|write_vga
c_func
(paren
l_int|14
comma
(paren
id|vga_vram_end
op_minus
id|vga_vram_base
op_minus
l_int|1
)paren
op_div
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CM_MOVE
suffix:colon
r_case
id|CM_DRAW
suffix:colon
id|write_vga
c_func
(paren
l_int|14
comma
(paren
id|c-&gt;vc_pos
op_minus
id|vga_vram_base
)paren
op_div
l_int|2
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;vc_cursor_type
op_amp
l_int|0x0f
)paren
(brace
r_case
id|CUR_UNDERLINE
suffix:colon
id|vgacon_set_cursor_size
c_func
(paren
id|c-&gt;vc_x
comma
id|video_font_height
op_minus
(paren
id|video_font_height
OL
l_int|10
ques
c_cond
l_int|2
suffix:colon
l_int|3
)paren
comma
id|video_font_height
op_minus
(paren
id|video_font_height
OL
l_int|10
ques
c_cond
l_int|1
suffix:colon
l_int|2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CUR_TWO_THIRDS
suffix:colon
id|vgacon_set_cursor_size
c_func
(paren
id|c-&gt;vc_x
comma
id|video_font_height
op_div
l_int|3
comma
id|video_font_height
op_minus
(paren
id|video_font_height
OL
l_int|10
ques
c_cond
l_int|1
suffix:colon
l_int|2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CUR_LOWER_THIRD
suffix:colon
id|vgacon_set_cursor_size
c_func
(paren
id|c-&gt;vc_x
comma
(paren
id|video_font_height
op_star
l_int|2
)paren
op_div
l_int|3
comma
id|video_font_height
op_minus
(paren
id|video_font_height
OL
l_int|10
ques
c_cond
l_int|1
suffix:colon
l_int|2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CUR_LOWER_HALF
suffix:colon
id|vgacon_set_cursor_size
c_func
(paren
id|c-&gt;vc_x
comma
id|video_font_height
op_div
l_int|2
comma
id|video_font_height
op_minus
(paren
id|video_font_height
OL
l_int|10
ques
c_cond
l_int|1
suffix:colon
l_int|2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CUR_NONE
suffix:colon
id|vgacon_set_cursor_size
c_func
(paren
id|c-&gt;vc_x
comma
l_int|31
comma
l_int|30
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|vgacon_set_cursor_size
c_func
(paren
id|c-&gt;vc_x
comma
l_int|1
comma
id|video_font_height
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
DECL|function|vgacon_switch
r_static
r_int
id|vgacon_switch
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
(brace
multiline_comment|/*&n;&t; * We need to save screen size here as it&squot;s the only way&n;&t; * we can spot the screen has been resized and we need to&n;&t; * set size of freshly allocated screens ourselves.&n;&t; */
id|vga_video_num_columns
op_assign
id|c-&gt;vc_cols
suffix:semicolon
id|vga_video_num_lines
op_assign
id|c-&gt;vc_rows
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vga_is_gfx
)paren
id|scr_memcpyw_to
c_func
(paren
(paren
id|u16
op_star
)paren
id|c-&gt;vc_origin
comma
(paren
id|u16
op_star
)paren
id|c-&gt;vc_screenbuf
comma
id|c-&gt;vc_screenbuf_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Redrawing not needed */
)brace
DECL|function|vga_set_palette
r_static
r_void
id|vga_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
r_char
op_star
id|table
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_p
(paren
id|table
(braket
id|i
)braket
comma
id|dac_reg
)paren
suffix:semicolon
id|outb_p
(paren
id|c-&gt;vc_palette
(braket
id|j
op_increment
)braket
op_rshift
l_int|2
comma
id|dac_val
)paren
suffix:semicolon
id|outb_p
(paren
id|c-&gt;vc_palette
(braket
id|j
op_increment
)braket
op_rshift
l_int|2
comma
id|dac_val
)paren
suffix:semicolon
id|outb_p
(paren
id|c-&gt;vc_palette
(braket
id|j
op_increment
)braket
op_rshift
l_int|2
comma
id|dac_val
)paren
suffix:semicolon
)brace
)brace
DECL|function|vgacon_set_palette
r_static
r_int
id|vgacon_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
r_char
op_star
id|table
)paren
(brace
macro_line|#ifdef CAN_LOAD_PALETTE
r_if
c_cond
(paren
id|vga_video_type
op_ne
id|VIDEO_TYPE_VGAC
op_logical_or
id|vga_palette_blanked
op_logical_or
op_logical_neg
id|CON_IS_VISIBLE
c_func
(paren
id|c
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|vga_set_palette
c_func
(paren
id|c
comma
id|table
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* structure holding original VGA register settings */
r_static
r_struct
(brace
DECL|member|SeqCtrlIndex
r_int
r_char
id|SeqCtrlIndex
suffix:semicolon
multiline_comment|/* Sequencer Index reg.   */
DECL|member|CrtCtrlIndex
r_int
r_char
id|CrtCtrlIndex
suffix:semicolon
multiline_comment|/* CRT-Contr. Index reg.  */
DECL|member|CrtMiscIO
r_int
r_char
id|CrtMiscIO
suffix:semicolon
multiline_comment|/* Miscellaneous register */
DECL|member|HorizontalTotal
r_int
r_char
id|HorizontalTotal
suffix:semicolon
multiline_comment|/* CRT-Controller:00h */
DECL|member|HorizDisplayEnd
r_int
r_char
id|HorizDisplayEnd
suffix:semicolon
multiline_comment|/* CRT-Controller:01h */
DECL|member|StartHorizRetrace
r_int
r_char
id|StartHorizRetrace
suffix:semicolon
multiline_comment|/* CRT-Controller:04h */
DECL|member|EndHorizRetrace
r_int
r_char
id|EndHorizRetrace
suffix:semicolon
multiline_comment|/* CRT-Controller:05h */
DECL|member|Overflow
r_int
r_char
id|Overflow
suffix:semicolon
multiline_comment|/* CRT-Controller:07h */
DECL|member|StartVertRetrace
r_int
r_char
id|StartVertRetrace
suffix:semicolon
multiline_comment|/* CRT-Controller:10h */
DECL|member|EndVertRetrace
r_int
r_char
id|EndVertRetrace
suffix:semicolon
multiline_comment|/* CRT-Controller:11h */
DECL|member|ModeControl
r_int
r_char
id|ModeControl
suffix:semicolon
multiline_comment|/* CRT-Controller:17h */
DECL|member|ClockingMode
r_int
r_char
id|ClockingMode
suffix:semicolon
multiline_comment|/* Seq-Controller:01h */
DECL|variable|vga_state
)brace
id|vga_state
suffix:semicolon
DECL|function|vga_vesa_blank
r_static
r_void
id|vga_vesa_blank
c_func
(paren
r_int
id|mode
)paren
(brace
multiline_comment|/* save original values of VGA controller registers */
r_if
c_cond
(paren
op_logical_neg
id|vga_vesa_blanked
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|vga_state.SeqCtrlIndex
op_assign
id|inb_p
c_func
(paren
id|seq_port_reg
)paren
suffix:semicolon
id|vga_state.CrtCtrlIndex
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_reg
)paren
suffix:semicolon
id|vga_state.CrtMiscIO
op_assign
id|inb_p
c_func
(paren
id|video_misc_rd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* HorizontalTotal */
id|vga_state.HorizontalTotal
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* HorizDisplayEnd */
id|vga_state.HorizDisplayEnd
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x04
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartHorizRetrace */
id|vga_state.StartHorizRetrace
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x05
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndHorizRetrace */
id|vga_state.EndHorizRetrace
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x07
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Overflow */
id|vga_state.Overflow
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x10
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartVertRetrace */
id|vga_state.StartVertRetrace
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x11
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndVertRetrace */
id|vga_state.EndVertRetrace
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x17
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* ModeControl */
id|vga_state.ModeControl
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|seq_port_reg
)paren
suffix:semicolon
multiline_comment|/* ClockingMode */
id|vga_state.ClockingMode
op_assign
id|inb_p
c_func
(paren
id|seq_port_val
)paren
suffix:semicolon
)brace
multiline_comment|/* assure that video is enabled */
multiline_comment|/* &quot;0x20&quot; is VIDEO_ENABLE_bit in register 01 of sequencer */
id|spin_lock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|vga_state.ClockingMode
op_or
l_int|0x20
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* test for vertical retrace in process.... */
r_if
c_cond
(paren
(paren
id|vga_state.CrtMiscIO
op_amp
l_int|0x80
)paren
op_eq
l_int|0x80
)paren
id|outb_p
c_func
(paren
id|vga_state.CrtMiscIO
op_amp
l_int|0xef
comma
id|video_misc_wr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set &lt;End of vertical retrace&gt; to minimum (0) and&n;&t; * &lt;Start of vertical Retrace&gt; to maximum (incl. overflow)&n;&t; * Result: turn off vertical sync (VSync) pulse.&n;&t; */
r_if
c_cond
(paren
id|mode
op_amp
id|VESA_VSYNC_SUSPEND
)paren
(brace
id|outb_p
c_func
(paren
l_int|0x10
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartVertRetrace */
id|outb_p
c_func
(paren
l_int|0xff
comma
id|vga_video_port_val
)paren
suffix:semicolon
multiline_comment|/* maximum value */
id|outb_p
c_func
(paren
l_int|0x11
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndVertRetrace */
id|outb_p
c_func
(paren
l_int|0x40
comma
id|vga_video_port_val
)paren
suffix:semicolon
multiline_comment|/* minimum (bits 0..3)  */
id|outb_p
c_func
(paren
l_int|0x07
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Overflow */
id|outb_p
c_func
(paren
id|vga_state.Overflow
op_or
l_int|0x84
comma
id|vga_video_port_val
)paren
suffix:semicolon
multiline_comment|/* bits 9,10 of vert. retrace */
)brace
r_if
c_cond
(paren
id|mode
op_amp
id|VESA_HSYNC_SUSPEND
)paren
(brace
multiline_comment|/*&n;&t;&t; * Set &lt;End of horizontal retrace&gt; to minimum (0) and&n;&t;&t; *  &lt;Start of horizontal Retrace&gt; to maximum&n;&t;&t; * Result: turn off horizontal sync (HSync) pulse.&n;&t;&t; */
id|outb_p
c_func
(paren
l_int|0x04
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartHorizRetrace */
id|outb_p
c_func
(paren
l_int|0xff
comma
id|vga_video_port_val
)paren
suffix:semicolon
multiline_comment|/* maximum */
id|outb_p
c_func
(paren
l_int|0x05
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndHorizRetrace */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|vga_video_port_val
)paren
suffix:semicolon
multiline_comment|/* minimum (0) */
)brace
multiline_comment|/* restore both index registers */
id|outb_p
c_func
(paren
id|vga_state.SeqCtrlIndex
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|vga_state.CrtCtrlIndex
comma
id|vga_video_port_reg
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
)brace
DECL|function|vga_vesa_unblank
r_static
r_void
id|vga_vesa_unblank
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* restore original values of VGA controller registers */
id|spin_lock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|vga_state.CrtMiscIO
comma
id|video_misc_wr
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* HorizontalTotal */
id|outb_p
c_func
(paren
id|vga_state.HorizontalTotal
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* HorizDisplayEnd */
id|outb_p
c_func
(paren
id|vga_state.HorizDisplayEnd
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x04
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartHorizRetrace */
id|outb_p
c_func
(paren
id|vga_state.StartHorizRetrace
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x05
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndHorizRetrace */
id|outb_p
c_func
(paren
id|vga_state.EndHorizRetrace
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x07
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Overflow */
id|outb_p
c_func
(paren
id|vga_state.Overflow
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x10
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* StartVertRetrace */
id|outb_p
c_func
(paren
id|vga_state.StartVertRetrace
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x11
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* EndVertRetrace */
id|outb_p
c_func
(paren
id|vga_state.EndVertRetrace
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x17
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* ModeControl */
id|outb_p
c_func
(paren
id|vga_state.ModeControl
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x01
comma
id|seq_port_reg
)paren
suffix:semicolon
multiline_comment|/* ClockingMode */
id|outb_p
c_func
(paren
id|vga_state.ClockingMode
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* restore index/control registers */
id|outb_p
c_func
(paren
id|vga_state.SeqCtrlIndex
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|vga_state.CrtCtrlIndex
comma
id|vga_video_port_reg
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
)brace
DECL|function|vga_pal_blank
r_static
r_void
id|vga_pal_blank
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb_p
(paren
id|i
comma
id|dac_reg
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|dac_val
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|dac_val
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0
comma
id|dac_val
)paren
suffix:semicolon
)brace
)brace
DECL|function|vgacon_blank
r_static
r_int
id|vgacon_blank
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|blank
)paren
(brace
r_switch
c_cond
(paren
id|blank
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Unblank */
r_if
c_cond
(paren
id|vga_vesa_blanked
)paren
(brace
id|vga_vesa_unblank
c_func
(paren
)paren
suffix:semicolon
id|vga_vesa_blanked
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vga_palette_blanked
)paren
(brace
id|vga_set_palette
c_func
(paren
id|c
comma
id|color_table
)paren
suffix:semicolon
id|vga_palette_blanked
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|vga_is_gfx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Tell console.c that it has to restore the screen itself */
r_return
l_int|1
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Normal blanking */
r_if
c_cond
(paren
id|vga_video_type
op_eq
id|VIDEO_TYPE_VGAC
)paren
(brace
id|vga_pal_blank
c_func
(paren
)paren
suffix:semicolon
id|vga_palette_blanked
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|vgacon_set_origin
c_func
(paren
id|c
)paren
suffix:semicolon
id|scr_memsetw
c_func
(paren
(paren
r_void
op_star
)paren
id|vga_vram_base
comma
id|BLANK
comma
id|c-&gt;vc_screenbuf_size
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_case
op_minus
l_int|1
suffix:colon
multiline_comment|/* Entering graphic mode */
id|scr_memsetw
c_func
(paren
(paren
r_void
op_star
)paren
id|vga_vram_base
comma
id|BLANK
comma
id|c-&gt;vc_screenbuf_size
)paren
suffix:semicolon
id|vga_is_gfx
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* VESA blanking */
r_if
c_cond
(paren
id|vga_video_type
op_eq
id|VIDEO_TYPE_VGAC
)paren
(brace
id|vga_vesa_blank
c_func
(paren
id|blank
op_minus
l_int|1
)paren
suffix:semicolon
id|vga_vesa_blanked
op_assign
id|blank
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * PIO_FONT support.&n; *&n; * The font loading code goes back to the codepage package by&n; * Joel Hoffman (joel@wam.umd.edu). (He reports that the original&n; * reference is: &quot;From: p. 307 of _Programmer&squot;s Guide to PC &amp; PS/2&n; * Video Systems_ by Richard Wilton. 1987.  Microsoft Press&quot;.)&n; *&n; * Change for certain monochrome monitors by Yury Shevchuck&n; * (sizif@botik.yaroslavl.su).&n; */
macro_line|#ifdef CAN_LOAD_EGA_FONTS
DECL|macro|colourmap
mdefine_line|#define colourmap 0xa0000
multiline_comment|/* Pauline Middelink &lt;middelin@polyware.iaf.nl&gt; reports that we&n;   should use 0xA0000 for the bwmap as well.. */
DECL|macro|blackwmap
mdefine_line|#define blackwmap 0xa0000
DECL|macro|cmapsz
mdefine_line|#define cmapsz 8192
r_static
r_int
DECL|function|vgacon_do_font_op
id|vgacon_do_font_op
c_func
(paren
r_char
op_star
id|arg
comma
r_int
id|set
comma
r_int
id|ch512
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|charmap
suffix:semicolon
r_int
id|beg
suffix:semicolon
r_int
r_int
id|video_port_status
op_assign
id|vga_video_port_reg
op_plus
l_int|6
suffix:semicolon
r_int
id|font_select
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|vga_video_type
op_ne
id|VIDEO_TYPE_EGAM
)paren
(brace
id|charmap
op_assign
(paren
r_char
op_star
)paren
id|VGA_MAP_MEM
c_func
(paren
id|colourmap
)paren
suffix:semicolon
id|beg
op_assign
l_int|0x0e
suffix:semicolon
macro_line|#ifdef VGA_CAN_DO_64KB
r_if
c_cond
(paren
id|vga_video_type
op_eq
id|VIDEO_TYPE_VGAC
)paren
id|beg
op_assign
l_int|0x06
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|charmap
op_assign
(paren
r_char
op_star
)paren
id|VGA_MAP_MEM
c_func
(paren
id|blackwmap
)paren
suffix:semicolon
id|beg
op_assign
l_int|0x0a
suffix:semicolon
)brace
macro_line|#ifdef BROKEN_GRAPHICS_PROGRAMS
multiline_comment|/*&n;&t; * All fonts are loaded in slot 0 (0:1 for 512 ch)&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Return to default font not supported */
id|vga_font_is_default
op_assign
l_int|0
suffix:semicolon
id|font_select
op_assign
id|ch512
ques
c_cond
l_int|0x04
suffix:colon
l_int|0x00
suffix:semicolon
macro_line|#else&t;
multiline_comment|/*&n;&t; * The default font is kept in slot 0 and is never touched.&n;&t; * A custom font is loaded in slot 2 (256 ch) or 2:3 (512 ch)&n;&t; */
r_if
c_cond
(paren
id|set
)paren
(brace
id|vga_font_is_default
op_assign
op_logical_neg
id|arg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
id|ch512
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Default font is always 256 */
id|font_select
op_assign
id|arg
ques
c_cond
(paren
id|ch512
ques
c_cond
l_int|0x0e
suffix:colon
l_int|0x0a
)paren
suffix:colon
l_int|0x00
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|vga_font_is_default
)paren
id|charmap
op_add_assign
l_int|4
op_star
id|cmapsz
suffix:semicolon
macro_line|#endif
id|spin_lock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|seq_port_reg
)paren
suffix:semicolon
multiline_comment|/* First, the sequencer */
id|outb_p
c_func
(paren
l_int|0x01
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* Synchronous reset */
id|outb_p
c_func
(paren
l_int|0x02
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x04
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* CPU writes only to map 2 */
id|outb_p
c_func
(paren
l_int|0x04
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x07
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* Sequential addressing */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x03
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* Clear synchronous reset */
id|outb_p
c_func
(paren
l_int|0x04
comma
id|gr_port_reg
)paren
suffix:semicolon
multiline_comment|/* Now, the graphics controller */
id|outb_p
c_func
(paren
l_int|0x02
comma
id|gr_port_val
)paren
suffix:semicolon
multiline_comment|/* select map 2 */
id|outb_p
c_func
(paren
l_int|0x05
comma
id|gr_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|gr_port_val
)paren
suffix:semicolon
multiline_comment|/* disable odd-even addressing */
id|outb_p
c_func
(paren
l_int|0x06
comma
id|gr_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|gr_port_val
)paren
suffix:semicolon
multiline_comment|/* map start at A000:0000 */
id|spin_unlock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
)paren
(brace
r_if
c_cond
(paren
id|set
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmapsz
suffix:semicolon
id|i
op_increment
)paren
id|vga_writeb
c_func
(paren
id|arg
(braket
id|i
)braket
comma
id|charmap
op_plus
id|i
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmapsz
suffix:semicolon
id|i
op_increment
)paren
id|arg
(braket
id|i
)braket
op_assign
id|vga_readb
c_func
(paren
id|charmap
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * In 512-character mode, the character map is not contiguous if&n;&t;&t; * we want to remain EGA compatible -- which we do&n;&t;&t; */
r_if
c_cond
(paren
id|ch512
)paren
(brace
id|charmap
op_add_assign
l_int|2
op_star
id|cmapsz
suffix:semicolon
id|arg
op_add_assign
id|cmapsz
suffix:semicolon
r_if
c_cond
(paren
id|set
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmapsz
suffix:semicolon
id|i
op_increment
)paren
id|vga_writeb
c_func
(paren
id|arg
(braket
id|i
)braket
comma
id|charmap
op_plus
id|i
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmapsz
suffix:semicolon
id|i
op_increment
)paren
id|arg
(braket
id|i
)braket
op_assign
id|vga_readb
c_func
(paren
id|charmap
op_plus
id|i
)paren
suffix:semicolon
)brace
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|seq_port_reg
)paren
suffix:semicolon
multiline_comment|/* First, the sequencer */
id|outb_p
c_func
(paren
l_int|0x01
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* Synchronous reset */
id|outb_p
c_func
(paren
l_int|0x02
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x03
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* CPU writes to maps 0 and 1 */
id|outb_p
c_func
(paren
l_int|0x04
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x03
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* odd-even addressing */
r_if
c_cond
(paren
id|set
)paren
(brace
id|outb_p
c_func
(paren
l_int|0x03
comma
id|seq_port_reg
)paren
suffix:semicolon
multiline_comment|/* Character Map Select */
id|outb_p
c_func
(paren
id|font_select
comma
id|seq_port_val
)paren
suffix:semicolon
)brace
id|outb_p
c_func
(paren
l_int|0x00
comma
id|seq_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x03
comma
id|seq_port_val
)paren
suffix:semicolon
multiline_comment|/* clear synchronous reset */
id|outb_p
c_func
(paren
l_int|0x04
comma
id|gr_port_reg
)paren
suffix:semicolon
multiline_comment|/* Now, the graphics controller */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|gr_port_val
)paren
suffix:semicolon
multiline_comment|/* select map 0 for CPU */
id|outb_p
c_func
(paren
l_int|0x05
comma
id|gr_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x10
comma
id|gr_port_val
)paren
suffix:semicolon
multiline_comment|/* enable even-odd addressing */
id|outb_p
c_func
(paren
l_int|0x06
comma
id|gr_port_reg
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|beg
comma
id|gr_port_val
)paren
suffix:semicolon
multiline_comment|/* map starts at b800:0 or b000:0 */
multiline_comment|/* if 512 char mode is already enabled don&squot;t re-enable it. */
r_if
c_cond
(paren
(paren
id|set
)paren
op_logical_and
(paren
id|ch512
op_ne
id|vga_512_chars
)paren
)paren
(brace
multiline_comment|/* attribute controller */
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_NR_CONSOLES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|vc_data
op_star
id|c
op_assign
id|vc_cons
(braket
id|i
)braket
dot
id|d
suffix:semicolon
r_if
c_cond
(paren
id|c
op_logical_and
id|c-&gt;vc_sw
op_eq
op_amp
id|vga_con
)paren
id|c-&gt;vc_hi_font_mask
op_assign
id|ch512
ques
c_cond
l_int|0x0800
suffix:colon
l_int|0
suffix:semicolon
)brace
id|vga_512_chars
op_assign
id|ch512
suffix:semicolon
multiline_comment|/* 256-char: enable intensity bit&n;&t;&t;   512-char: disable intensity bit */
id|inb_p
c_func
(paren
id|video_port_status
)paren
suffix:semicolon
multiline_comment|/* clear address flip-flop */
id|outb_p
(paren
l_int|0x12
comma
id|attrib_port
)paren
suffix:semicolon
multiline_comment|/* color plane enable register */
id|outb_p
(paren
id|ch512
ques
c_cond
l_int|0x07
suffix:colon
l_int|0x0f
comma
id|attrib_port
)paren
suffix:semicolon
multiline_comment|/* Wilton (1987) mentions the following; I don&squot;t know what&n;&t;&t;   it means, but it works, and it appears necessary */
id|inb_p
c_func
(paren
id|video_port_status
)paren
suffix:semicolon
id|outb_p
(paren
l_int|0x20
comma
id|attrib_port
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Adjust the screen to fit a font of a certain height&n; */
r_static
r_int
DECL|function|vgacon_adjust_height
id|vgacon_adjust_height
c_func
(paren
r_int
id|fontheight
)paren
(brace
r_int
id|rows
comma
id|maxscan
suffix:semicolon
r_int
r_char
id|ovr
comma
id|vde
comma
id|fsr
suffix:semicolon
r_if
c_cond
(paren
id|fontheight
op_eq
id|vga_video_font_height
)paren
r_return
l_int|0
suffix:semicolon
id|vga_video_font_height
op_assign
id|video_font_height
op_assign
id|fontheight
suffix:semicolon
id|rows
op_assign
id|video_scan_lines
op_div
id|fontheight
suffix:semicolon
multiline_comment|/* Number of video rows we end up with */
id|maxscan
op_assign
id|rows
op_star
id|fontheight
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Scan lines to actually display-1 */
multiline_comment|/* Reprogram the CRTC for the new font size&n;&t;   Note: the attempt to read the overflow register will fail&n;&t;   on an EGA, but using 0xff for the previous value appears to&n;&t;   be OK for EGA text modes in the range 257-512 scan lines, so I&n;&t;   guess we don&squot;t need to worry about it.&n;&n;&t;   The same applies for the spill bits in the font size and cursor&n;&t;   registers; they are write-only on EGA, but it appears that they&n;&t;   are all don&squot;t care bits on EGA, so I guess it doesn&squot;t matter. */
id|spin_lock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x07
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* CRTC overflow register */
id|ovr
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x09
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Font size register */
id|fsr
op_assign
id|inb_p
c_func
(paren
id|vga_video_port_val
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|vde
op_assign
id|maxscan
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* Vertical display end reg */
id|ovr
op_assign
(paren
id|ovr
op_amp
l_int|0xbd
)paren
op_plus
multiline_comment|/* Overflow register */
(paren
(paren
id|maxscan
op_amp
l_int|0x100
)paren
op_rshift
l_int|7
)paren
op_plus
(paren
(paren
id|maxscan
op_amp
l_int|0x200
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
id|fsr
op_assign
(paren
id|fsr
op_amp
l_int|0xe0
)paren
op_plus
(paren
id|fontheight
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*  Font size register */
id|spin_lock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x07
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* CRTC overflow register */
id|outb_p
c_func
(paren
id|ovr
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x09
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Font size */
id|outb_p
c_func
(paren
id|fsr
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x12
comma
id|vga_video_port_reg
)paren
suffix:semicolon
multiline_comment|/* Vertical display limit */
id|outb_p
c_func
(paren
id|vde
comma
id|vga_video_port_val
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|vga_lock
)paren
suffix:semicolon
id|vc_resize_all
c_func
(paren
id|rows
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Adjust console size */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vgacon_font_op
r_static
r_int
id|vgacon_font_op
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_struct
id|console_font_op
op_star
id|op
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|vga_video_type
OL
id|VIDEO_TYPE_EGAM
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;op
op_eq
id|KD_FONT_OP_SET
)paren
(brace
r_if
c_cond
(paren
id|op-&gt;width
op_ne
l_int|8
op_logical_or
(paren
id|op-&gt;charcount
op_ne
l_int|256
op_logical_and
id|op-&gt;charcount
op_ne
l_int|512
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|rc
op_assign
id|vgacon_do_font_op
c_func
(paren
id|op-&gt;data
comma
l_int|1
comma
id|op-&gt;charcount
op_eq
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
op_logical_and
op_logical_neg
(paren
id|op-&gt;flags
op_amp
id|KD_FONT_FLAG_DONT_RECALC
)paren
)paren
id|rc
op_assign
id|vgacon_adjust_height
c_func
(paren
id|op-&gt;height
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|op-&gt;op
op_eq
id|KD_FONT_OP_GET
)paren
(brace
id|op-&gt;width
op_assign
l_int|8
suffix:semicolon
id|op-&gt;height
op_assign
id|vga_video_font_height
suffix:semicolon
id|op-&gt;charcount
op_assign
id|vga_512_chars
ques
c_cond
l_int|512
suffix:colon
l_int|256
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op-&gt;data
)paren
r_return
l_int|0
suffix:semicolon
id|rc
op_assign
id|vgacon_do_font_op
c_func
(paren
id|op-&gt;data
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|rc
op_assign
op_minus
id|ENOSYS
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#else
DECL|function|vgacon_font_op
r_static
r_int
id|vgacon_font_op
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_struct
id|console_font_op
op_star
id|op
)paren
(brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
macro_line|#endif
DECL|function|vgacon_scrolldelta
r_static
r_int
id|vgacon_scrolldelta
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|lines
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|lines
)paren
multiline_comment|/* Turn scrollback off */
id|c-&gt;vc_visible_origin
op_assign
id|c-&gt;vc_origin
suffix:semicolon
r_else
(brace
r_int
id|vram_size
op_assign
id|vga_vram_end
op_minus
id|vga_vram_base
suffix:semicolon
r_int
id|margin
op_assign
id|c-&gt;vc_size_row
op_star
l_int|4
suffix:semicolon
r_int
id|ul
comma
id|we
comma
id|p
comma
id|st
suffix:semicolon
r_if
c_cond
(paren
id|vga_rolled_over
OG
(paren
id|c-&gt;vc_scr_end
op_minus
id|vga_vram_base
)paren
op_plus
id|margin
)paren
(brace
id|ul
op_assign
id|c-&gt;vc_scr_end
op_minus
id|vga_vram_base
suffix:semicolon
id|we
op_assign
id|vga_rolled_over
op_plus
id|c-&gt;vc_size_row
suffix:semicolon
)brace
r_else
(brace
id|ul
op_assign
l_int|0
suffix:semicolon
id|we
op_assign
id|vram_size
suffix:semicolon
)brace
id|p
op_assign
(paren
id|c-&gt;vc_visible_origin
op_minus
id|vga_vram_base
op_minus
id|ul
op_plus
id|we
)paren
op_mod
id|we
op_plus
id|lines
op_star
id|c-&gt;vc_size_row
suffix:semicolon
id|st
op_assign
(paren
id|c-&gt;vc_origin
op_minus
id|vga_vram_base
op_minus
id|ul
op_plus
id|we
)paren
op_mod
id|we
suffix:semicolon
r_if
c_cond
(paren
id|p
OL
id|margin
)paren
id|p
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|p
OG
id|st
op_minus
id|margin
)paren
id|p
op_assign
id|st
suffix:semicolon
id|c-&gt;vc_visible_origin
op_assign
id|vga_vram_base
op_plus
(paren
id|p
op_plus
id|ul
)paren
op_mod
id|we
suffix:semicolon
)brace
id|vga_set_mem_top
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|vgacon_set_origin
r_static
r_int
id|vgacon_set_origin
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
(brace
r_if
c_cond
(paren
id|vga_is_gfx
op_logical_or
multiline_comment|/* We don&squot;t play origin tricks in graphic modes */
(paren
id|console_blanked
op_logical_and
op_logical_neg
id|vga_palette_blanked
)paren
)paren
multiline_comment|/* Nor we write to blanked screens */
r_return
l_int|0
suffix:semicolon
id|c-&gt;vc_origin
op_assign
id|c-&gt;vc_visible_origin
op_assign
id|vga_vram_base
suffix:semicolon
id|vga_set_mem_top
c_func
(paren
id|c
)paren
suffix:semicolon
id|vga_rolled_over
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|vgacon_save_screen
r_static
r_void
id|vgacon_save_screen
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
(brace
r_static
r_int
id|vga_bootup_console
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vga_bootup_console
)paren
(brace
multiline_comment|/* This is a gross hack, but here is the only place we can&n;&t;&t; * set bootup console parameters without messing up generic&n;&t;&t; * console initialization routines.&n;&t;&t; */
id|vga_bootup_console
op_assign
l_int|1
suffix:semicolon
id|c-&gt;vc_x
op_assign
id|ORIG_X
suffix:semicolon
id|c-&gt;vc_y
op_assign
id|ORIG_Y
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|vga_is_gfx
)paren
id|scr_memcpyw_from
c_func
(paren
(paren
id|u16
op_star
)paren
id|c-&gt;vc_screenbuf
comma
(paren
id|u16
op_star
)paren
id|c-&gt;vc_origin
comma
id|c-&gt;vc_screenbuf_size
)paren
suffix:semicolon
)brace
DECL|function|vgacon_scroll
r_static
r_int
id|vgacon_scroll
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|t
comma
r_int
id|b
comma
r_int
id|dir
comma
r_int
id|lines
)paren
(brace
r_int
r_int
id|oldo
suffix:semicolon
r_int
r_int
id|delta
suffix:semicolon
r_if
c_cond
(paren
id|t
op_logical_or
id|b
op_ne
id|c-&gt;vc_rows
op_logical_or
id|vga_is_gfx
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;vc_origin
op_ne
id|c-&gt;vc_visible_origin
)paren
id|vgacon_scrolldelta
c_func
(paren
id|c
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vga_hardscroll_enabled
op_logical_or
id|lines
op_ge
id|c-&gt;vc_rows
op_div
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
id|oldo
op_assign
id|c-&gt;vc_origin
suffix:semicolon
id|delta
op_assign
id|lines
op_star
id|c-&gt;vc_size_row
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_eq
id|SM_UP
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;vc_scr_end
op_plus
id|delta
op_ge
id|vga_vram_end
)paren
(brace
id|scr_memcpyw
c_func
(paren
(paren
id|u16
op_star
)paren
id|vga_vram_base
comma
(paren
id|u16
op_star
)paren
(paren
id|oldo
op_plus
id|delta
)paren
comma
id|c-&gt;vc_screenbuf_size
op_minus
id|delta
)paren
suffix:semicolon
id|c-&gt;vc_origin
op_assign
id|vga_vram_base
suffix:semicolon
id|vga_rolled_over
op_assign
id|oldo
op_minus
id|vga_vram_base
suffix:semicolon
)brace
r_else
id|c-&gt;vc_origin
op_add_assign
id|delta
suffix:semicolon
id|scr_memsetw
c_func
(paren
(paren
id|u16
op_star
)paren
(paren
id|c-&gt;vc_origin
op_plus
id|c-&gt;vc_screenbuf_size
op_minus
id|delta
)paren
comma
id|c-&gt;vc_video_erase_char
comma
id|delta
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|oldo
op_minus
id|delta
OL
id|vga_vram_base
)paren
(brace
id|scr_memmovew
c_func
(paren
(paren
id|u16
op_star
)paren
(paren
id|vga_vram_end
op_minus
id|c-&gt;vc_screenbuf_size
op_plus
id|delta
)paren
comma
(paren
id|u16
op_star
)paren
id|oldo
comma
id|c-&gt;vc_screenbuf_size
op_minus
id|delta
)paren
suffix:semicolon
id|c-&gt;vc_origin
op_assign
id|vga_vram_end
op_minus
id|c-&gt;vc_screenbuf_size
suffix:semicolon
id|vga_rolled_over
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|c-&gt;vc_origin
op_sub_assign
id|delta
suffix:semicolon
id|c-&gt;vc_scr_end
op_assign
id|c-&gt;vc_origin
op_plus
id|c-&gt;vc_screenbuf_size
suffix:semicolon
id|scr_memsetw
c_func
(paren
(paren
id|u16
op_star
)paren
(paren
id|c-&gt;vc_origin
)paren
comma
id|c-&gt;vc_video_erase_char
comma
id|delta
)paren
suffix:semicolon
)brace
id|c-&gt;vc_scr_end
op_assign
id|c-&gt;vc_origin
op_plus
id|c-&gt;vc_screenbuf_size
suffix:semicolon
id|c-&gt;vc_visible_origin
op_assign
id|c-&gt;vc_origin
suffix:semicolon
id|vga_set_mem_top
c_func
(paren
id|c
)paren
suffix:semicolon
id|c-&gt;vc_pos
op_assign
(paren
id|c-&gt;vc_pos
op_minus
id|oldo
)paren
op_plus
id|c-&gt;vc_origin
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *  The console `switch&squot; structure for the VGA based console&n; */
DECL|function|vgacon_dummy
r_static
r_int
id|vgacon_dummy
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|DUMMY
mdefine_line|#define DUMMY (void *) vgacon_dummy
DECL|variable|vga_con
r_const
r_struct
id|consw
id|vga_con
op_assign
(brace
id|con_startup
suffix:colon
id|vgacon_startup
comma
id|con_init
suffix:colon
id|vgacon_init
comma
id|con_deinit
suffix:colon
id|vgacon_deinit
comma
id|con_clear
suffix:colon
id|DUMMY
comma
id|con_putc
suffix:colon
id|DUMMY
comma
id|con_putcs
suffix:colon
id|DUMMY
comma
id|con_cursor
suffix:colon
id|vgacon_cursor
comma
id|con_scroll
suffix:colon
id|vgacon_scroll
comma
id|con_bmove
suffix:colon
id|DUMMY
comma
id|con_switch
suffix:colon
id|vgacon_switch
comma
id|con_blank
suffix:colon
id|vgacon_blank
comma
id|con_font_op
suffix:colon
id|vgacon_font_op
comma
id|con_set_palette
suffix:colon
id|vgacon_set_palette
comma
id|con_scrolldelta
suffix:colon
id|vgacon_scrolldelta
comma
id|con_set_origin
suffix:colon
id|vgacon_set_origin
comma
id|con_save_screen
suffix:colon
id|vgacon_save_screen
comma
id|con_build_attr
suffix:colon
id|vgacon_build_attr
comma
id|con_invert_region
suffix:colon
id|vgacon_invert_region
comma
)brace
suffix:semicolon
eof
