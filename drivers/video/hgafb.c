multiline_comment|/*&n; * linux/drivers/video/hgafb.c -- Hercules graphics adaptor frame buffer device&n; * &n; *      Created 25 Nov 1999 by Ferenc Bakonyi (fero@drama.obuda.kando.hu)&n; *      Based on skeletonfb.c by Geert Uytterhoeven and&n; *               mdacon.c by Andrew Apted&n; *&n; * History:&n; *&n; * - Revision 0.1.6 (17 Aug 2000): new style structs&n; *                                 documentation&n; * - Revision 0.1.5 (13 Mar 2000): spinlocks instead of saveflags();cli();etc&n; *                                 minor fixes&n; * - Revision 0.1.4 (24 Jan 2000): fixed a bug in hga_card_detect() for &n; *                                  HGA-only systems&n; * - Revision 0.1.3 (22 Jan 2000): modified for the new fb_info structure&n; *                                 screen is cleared after rmmod&n; *                                 virtual resolutions&n; *                                 kernel parameter &squot;video=hga:font:{fontname}&squot;&n; *                                 module parameter &squot;font={fontname}&squot;&n; *                                 module parameter &squot;nologo={0|1}&squot;&n; *                                 the most important: boot logo :)&n; * - Revision 0.1.0  (6 Dec 1999): faster scrolling and minor fixes&n; * - First release  (25 Nov 1999)&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/vga.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-hga.h&gt;
macro_line|#ifdef MODULE
DECL|macro|INCLUDE_LINUX_LOGOBW
mdefine_line|#define INCLUDE_LINUX_LOGOBW
macro_line|#include &lt;linux/linux_logo.h&gt;
macro_line|#endif /* MODULE */
macro_line|#if 0
mdefine_line|#define DPRINTK(args...) printk(KERN_DEBUG __FILE__&quot;: &quot; ##args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(args...)
macro_line|#endif
macro_line|#if 0
mdefine_line|#define CHKINFO(ret) if (info != &amp;fb_info) { printk(KERN_DEBUG __FILE__&quot;: This should never happen, line:%d &bslash;n&quot;, __LINE__); return ret; }
macro_line|#else
DECL|macro|CHKINFO
mdefine_line|#define CHKINFO(ret)
macro_line|#endif
multiline_comment|/* Description of the hardware layout */
DECL|variable|hga_vram_base
r_static
r_int
r_int
id|hga_vram_base
suffix:semicolon
multiline_comment|/* Base of video memory */
DECL|variable|hga_vram_len
r_static
r_int
r_int
id|hga_vram_len
suffix:semicolon
multiline_comment|/* Size of video memory */
DECL|macro|HGA_TXT
mdefine_line|#define HGA_TXT&t;&t;&t;0
DECL|macro|HGA_GFX
mdefine_line|#define HGA_GFX&t;&t;&t;1
DECL|variable|hga_mode
r_static
r_int
id|hga_mode
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* 0 = txt, 1 = gfx mode */
DECL|enumerator|TYPE_HERC
DECL|enumerator|TYPE_HERCPLUS
DECL|enumerator|TYPE_HERCCOLOR
DECL|variable|hga_type
r_static
r_enum
(brace
id|TYPE_HERC
comma
id|TYPE_HERCPLUS
comma
id|TYPE_HERCCOLOR
)brace
id|hga_type
suffix:semicolon
DECL|variable|hga_type_name
r_static
r_char
op_star
id|hga_type_name
suffix:semicolon
DECL|macro|HGA_INDEX_PORT
mdefine_line|#define HGA_INDEX_PORT&t;&t;0x3b4&t;&t;/* Register select port */
DECL|macro|HGA_VALUE_PORT
mdefine_line|#define HGA_VALUE_PORT&t;&t;0x3b5&t;&t;/* Register value port */
DECL|macro|HGA_MODE_PORT
mdefine_line|#define HGA_MODE_PORT&t;&t;0x3b8&t;&t;/* Mode control port */
DECL|macro|HGA_STATUS_PORT
mdefine_line|#define HGA_STATUS_PORT&t;&t;0x3ba&t;&t;/* Status and Config port */
DECL|macro|HGA_GFX_PORT
mdefine_line|#define HGA_GFX_PORT&t;&t;0x3bf&t;&t;/* Graphics control port */
multiline_comment|/* HGA register values */
DECL|macro|HGA_CURSOR_BLINKING
mdefine_line|#define HGA_CURSOR_BLINKING&t;0x00
DECL|macro|HGA_CURSOR_OFF
mdefine_line|#define HGA_CURSOR_OFF&t;&t;0x20
DECL|macro|HGA_CURSOR_SLOWBLINK
mdefine_line|#define HGA_CURSOR_SLOWBLINK&t;0x60
DECL|macro|HGA_MODE_GRAPHICS
mdefine_line|#define HGA_MODE_GRAPHICS&t;0x02
DECL|macro|HGA_MODE_VIDEO_EN
mdefine_line|#define HGA_MODE_VIDEO_EN&t;0x08
DECL|macro|HGA_MODE_BLINK_EN
mdefine_line|#define HGA_MODE_BLINK_EN&t;0x20
DECL|macro|HGA_MODE_GFX_PAGE1
mdefine_line|#define HGA_MODE_GFX_PAGE1&t;0x80
DECL|macro|HGA_STATUS_HSYNC
mdefine_line|#define HGA_STATUS_HSYNC&t;0x01
DECL|macro|HGA_STATUS_VSYNC
mdefine_line|#define HGA_STATUS_VSYNC&t;0x80
DECL|macro|HGA_STATUS_VIDEO
mdefine_line|#define HGA_STATUS_VIDEO&t;0x08
DECL|macro|HGA_CONFIG_COL132
mdefine_line|#define HGA_CONFIG_COL132&t;0x08
DECL|macro|HGA_GFX_MODE_EN
mdefine_line|#define HGA_GFX_MODE_EN&t;&t;0x01
DECL|macro|HGA_GFX_PAGE_EN
mdefine_line|#define HGA_GFX_PAGE_EN&t;&t;0x02
multiline_comment|/* Global locks */
DECL|variable|hga_reg_lock
id|spinlock_t
id|hga_reg_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* Framebuffer driver structures */
DECL|variable|hga_default_var
r_static
r_struct
id|fb_var_screeninfo
id|hga_default_var
op_assign
(brace
id|xres
suffix:colon
l_int|720
comma
id|yres
suffix:colon
l_int|348
comma
id|xres_virtual
suffix:colon
l_int|720
comma
id|yres_virtual
suffix:colon
l_int|348
comma
id|xoffset
suffix:colon
l_int|0
comma
id|yoffset
suffix:colon
l_int|0
comma
id|bits_per_pixel
suffix:colon
l_int|1
comma
id|grayscale
suffix:colon
l_int|0
comma
id|red
suffix:colon
(brace
l_int|0
comma
l_int|1
comma
l_int|0
)brace
comma
id|green
suffix:colon
(brace
l_int|0
comma
l_int|1
comma
l_int|0
)brace
comma
id|blue
suffix:colon
(brace
l_int|0
comma
l_int|1
comma
l_int|0
)brace
comma
id|transp
suffix:colon
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
id|nonstd
suffix:colon
l_int|0
comma
multiline_comment|/* (FB_NONSTD_HGA ?) */
id|activate
suffix:colon
l_int|0
comma
id|height
suffix:colon
op_minus
l_int|1
comma
id|width
suffix:colon
op_minus
l_int|1
comma
id|accel_flags
suffix:colon
l_int|0
comma
multiline_comment|/* pixclock */
multiline_comment|/* left_margin, right_margin */
multiline_comment|/* upper_margin, lower_margin */
multiline_comment|/* hsync_len, vsync_len */
multiline_comment|/* sync */
multiline_comment|/* vmode */
)brace
suffix:semicolon
DECL|variable|hga_fix
r_static
r_struct
id|fb_fix_screeninfo
id|hga_fix
op_assign
(brace
id|id
suffix:colon
l_string|&quot;HGA&quot;
comma
id|smem_start
suffix:colon
(paren
r_int
r_int
)paren
l_int|NULL
comma
id|smem_len
suffix:colon
l_int|0
comma
id|type
suffix:colon
id|FB_TYPE_PACKED_PIXELS
comma
multiline_comment|/* (not sure) */
id|type_aux
suffix:colon
l_int|0
comma
multiline_comment|/* (not sure) */
id|visual
suffix:colon
id|FB_VISUAL_MONO10
comma
id|xpanstep
suffix:colon
l_int|8
comma
id|ypanstep
suffix:colon
l_int|8
comma
id|ywrapstep
suffix:colon
l_int|0
comma
id|line_length
suffix:colon
l_int|90
comma
id|mmio_start
suffix:colon
l_int|0
comma
id|mmio_len
suffix:colon
l_int|0
comma
id|accel
suffix:colon
id|FB_ACCEL_NONE
)brace
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
suffix:semicolon
multiline_comment|/* Don&squot;t assume that tty1 will be the initial current console. */
DECL|variable|currcon
r_static
r_int
id|currcon
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|release_io_port
r_static
r_int
id|release_io_port
op_assign
l_int|0
suffix:semicolon
DECL|variable|release_io_ports
r_static
r_int
id|release_io_ports
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|font
r_static
r_char
op_star
id|font
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|nologo
r_static
r_int
id|nologo
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* -------------------------------------------------------------------------&n; *&n; * Low level hardware functions&n; *&n; * ------------------------------------------------------------------------- */
DECL|function|write_hga_b
r_static
r_void
id|write_hga_b
c_func
(paren
r_int
r_int
id|val
comma
r_int
r_char
id|reg
)paren
(brace
id|outb_p
c_func
(paren
id|reg
comma
id|HGA_INDEX_PORT
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|val
comma
id|HGA_VALUE_PORT
)paren
suffix:semicolon
)brace
DECL|function|write_hga_w
r_static
r_void
id|write_hga_w
c_func
(paren
r_int
r_int
id|val
comma
r_int
r_char
id|reg
)paren
(brace
id|outb_p
c_func
(paren
id|reg
comma
id|HGA_INDEX_PORT
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|val
op_rshift
l_int|8
comma
id|HGA_VALUE_PORT
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|reg
op_plus
l_int|1
comma
id|HGA_INDEX_PORT
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|val
op_amp
l_int|0xff
comma
id|HGA_VALUE_PORT
)paren
suffix:semicolon
)brace
DECL|function|test_hga_b
r_static
r_int
id|test_hga_b
c_func
(paren
r_int
r_char
id|val
comma
r_int
r_char
id|reg
)paren
(brace
id|outb_p
c_func
(paren
id|reg
comma
id|HGA_INDEX_PORT
)paren
suffix:semicolon
id|outb
(paren
id|val
comma
id|HGA_VALUE_PORT
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|val
op_assign
(paren
id|inb_p
c_func
(paren
id|HGA_VALUE_PORT
)paren
op_eq
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|hga_clear_screen
r_static
r_void
id|hga_clear_screen
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|fillchar
op_assign
l_int|0xbf
suffix:semicolon
multiline_comment|/* magic */
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hga_mode
op_eq
id|HGA_TXT
)paren
id|fillchar
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hga_mode
op_eq
id|HGA_GFX
)paren
id|fillchar
op_assign
l_int|0x00
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fillchar
op_ne
l_int|0xbf
)paren
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|hga_vram_base
comma
id|fillchar
comma
id|hga_vram_len
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|hga_txt_mode
r_static
r_void
id|hga_txt_mode
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|HGA_MODE_VIDEO_EN
op_or
id|HGA_MODE_BLINK_EN
comma
id|HGA_MODE_PORT
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|HGA_GFX_PORT
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|HGA_STATUS_PORT
)paren
suffix:semicolon
id|write_hga_b
c_func
(paren
l_int|0x61
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* horizontal total */
id|write_hga_b
c_func
(paren
l_int|0x50
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* horizontal displayed */
id|write_hga_b
c_func
(paren
l_int|0x52
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* horizontal sync pos */
id|write_hga_b
c_func
(paren
l_int|0x0f
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* horizontal sync width */
id|write_hga_b
c_func
(paren
l_int|0x19
comma
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* vertical total */
id|write_hga_b
c_func
(paren
l_int|0x06
comma
l_int|0x05
)paren
suffix:semicolon
multiline_comment|/* vertical total adjust */
id|write_hga_b
c_func
(paren
l_int|0x19
comma
l_int|0x06
)paren
suffix:semicolon
multiline_comment|/* vertical displayed */
id|write_hga_b
c_func
(paren
l_int|0x19
comma
l_int|0x07
)paren
suffix:semicolon
multiline_comment|/* vertical sync pos */
id|write_hga_b
c_func
(paren
l_int|0x02
comma
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* interlace mode */
id|write_hga_b
c_func
(paren
l_int|0x0d
comma
l_int|0x09
)paren
suffix:semicolon
multiline_comment|/* maximum scanline */
id|write_hga_b
c_func
(paren
l_int|0x0c
comma
l_int|0x0a
)paren
suffix:semicolon
multiline_comment|/* cursor start */
id|write_hga_b
c_func
(paren
l_int|0x0d
comma
l_int|0x0b
)paren
suffix:semicolon
multiline_comment|/* cursor end */
id|write_hga_w
c_func
(paren
l_int|0x0000
comma
l_int|0x0c
)paren
suffix:semicolon
multiline_comment|/* start address */
id|write_hga_w
c_func
(paren
l_int|0x0000
comma
l_int|0x0e
)paren
suffix:semicolon
multiline_comment|/* cursor location */
id|hga_mode
op_assign
id|HGA_TXT
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
DECL|function|hga_gfx_mode
r_static
r_void
id|hga_gfx_mode
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|HGA_STATUS_PORT
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|HGA_GFX_MODE_EN
comma
id|HGA_GFX_PORT
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|HGA_MODE_VIDEO_EN
op_or
id|HGA_MODE_GRAPHICS
comma
id|HGA_MODE_PORT
)paren
suffix:semicolon
id|write_hga_b
c_func
(paren
l_int|0x35
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* horizontal total */
id|write_hga_b
c_func
(paren
l_int|0x2d
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* horizontal displayed */
id|write_hga_b
c_func
(paren
l_int|0x2e
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* horizontal sync pos */
id|write_hga_b
c_func
(paren
l_int|0x07
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* horizontal sync width */
id|write_hga_b
c_func
(paren
l_int|0x5b
comma
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* vertical total */
id|write_hga_b
c_func
(paren
l_int|0x02
comma
l_int|0x05
)paren
suffix:semicolon
multiline_comment|/* vertical total adjust */
id|write_hga_b
c_func
(paren
l_int|0x57
comma
l_int|0x06
)paren
suffix:semicolon
multiline_comment|/* vertical displayed */
id|write_hga_b
c_func
(paren
l_int|0x57
comma
l_int|0x07
)paren
suffix:semicolon
multiline_comment|/* vertical sync pos */
id|write_hga_b
c_func
(paren
l_int|0x02
comma
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* interlace mode */
id|write_hga_b
c_func
(paren
l_int|0x03
comma
l_int|0x09
)paren
suffix:semicolon
multiline_comment|/* maximum scanline */
id|write_hga_b
c_func
(paren
l_int|0x00
comma
l_int|0x0a
)paren
suffix:semicolon
multiline_comment|/* cursor start */
id|write_hga_b
c_func
(paren
l_int|0x00
comma
l_int|0x0b
)paren
suffix:semicolon
multiline_comment|/* cursor end */
id|write_hga_w
c_func
(paren
l_int|0x0000
comma
l_int|0x0c
)paren
suffix:semicolon
multiline_comment|/* start address */
id|write_hga_w
c_func
(paren
l_int|0x0000
comma
l_int|0x0e
)paren
suffix:semicolon
multiline_comment|/* cursor location */
id|hga_mode
op_assign
id|HGA_GFX
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|hga_show_logo
r_static
r_void
id|hga_show_logo
c_func
(paren
r_void
)paren
(brace
r_int
id|x
comma
id|y
suffix:semicolon
r_char
op_star
id|dest
op_assign
(paren
r_char
op_star
)paren
id|hga_vram_base
suffix:semicolon
r_char
op_star
id|logo
op_assign
id|linux_logo_bw
suffix:semicolon
r_for
c_loop
(paren
id|y
op_assign
l_int|134
suffix:semicolon
id|y
OL
l_int|134
op_plus
l_int|80
suffix:semicolon
id|y
op_increment
)paren
multiline_comment|/* this needs some cleanup */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
l_int|10
suffix:semicolon
id|x
op_increment
)paren
op_star
(paren
id|dest
op_plus
(paren
id|y
op_mod
l_int|4
)paren
op_star
l_int|8192
op_plus
(paren
id|y
op_rshift
l_int|2
)paren
op_star
l_int|90
op_plus
id|x
op_plus
l_int|40
)paren
op_assign
op_complement
op_star
(paren
id|logo
op_increment
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */&t;
DECL|function|hga_pan
r_static
r_void
id|hga_pan
c_func
(paren
r_int
r_int
id|xoffset
comma
r_int
r_int
id|yoffset
)paren
(brace
r_int
r_int
id|base
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|base
op_assign
(paren
id|yoffset
op_div
l_int|8
)paren
op_star
l_int|90
op_plus
id|xoffset
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|write_hga_w
c_func
(paren
id|base
comma
l_int|0x0c
)paren
suffix:semicolon
multiline_comment|/* start address */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hga_pan: base:%d&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
)brace
DECL|function|hga_blank
r_static
r_void
id|hga_blank
c_func
(paren
r_int
id|blank_mode
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blank_mode
)paren
(brace
id|outb_p
c_func
(paren
l_int|0x00
comma
id|HGA_MODE_PORT
)paren
suffix:semicolon
multiline_comment|/* disable video */
)brace
r_else
(brace
id|outb_p
c_func
(paren
id|HGA_MODE_VIDEO_EN
op_or
id|HGA_MODE_GRAPHICS
comma
id|HGA_MODE_PORT
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hga_reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|hga_card_detect
r_static
r_int
id|__init
id|hga_card_detect
c_func
(paren
r_void
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|u16
op_star
id|p
comma
id|p_save
suffix:semicolon
id|u16
op_star
id|q
comma
id|q_save
suffix:semicolon
id|hga_vram_base
op_assign
id|VGA_MAP_MEM
c_func
(paren
l_int|0xb0000
)paren
suffix:semicolon
id|hga_vram_len
op_assign
l_int|0x08000
suffix:semicolon
r_if
c_cond
(paren
id|request_region
c_func
(paren
l_int|0x3b0
comma
l_int|12
comma
l_string|&quot;hgafb&quot;
)paren
)paren
id|release_io_ports
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|request_region
c_func
(paren
l_int|0x3bf
comma
l_int|1
comma
l_string|&quot;hgafb&quot;
)paren
)paren
id|release_io_port
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* do a memory check */
id|p
op_assign
(paren
id|u16
op_star
)paren
id|hga_vram_base
suffix:semicolon
id|q
op_assign
(paren
id|u16
op_star
)paren
(paren
id|hga_vram_base
op_plus
l_int|0x01000
)paren
suffix:semicolon
id|p_save
op_assign
id|scr_readw
c_func
(paren
id|p
)paren
suffix:semicolon
id|q_save
op_assign
id|scr_readw
c_func
(paren
id|q
)paren
suffix:semicolon
id|scr_writew
c_func
(paren
l_int|0xaa55
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scr_readw
c_func
(paren
id|p
)paren
op_eq
l_int|0xaa55
)paren
id|count
op_increment
suffix:semicolon
id|scr_writew
c_func
(paren
l_int|0x55aa
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scr_readw
c_func
(paren
id|p
)paren
op_eq
l_int|0x55aa
)paren
id|count
op_increment
suffix:semicolon
id|scr_writew
c_func
(paren
id|p_save
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
l_int|2
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Ok, there is definitely a card registering at the correct&n;&t; * memory location, so now we do an I/O port test.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|test_hga_b
c_func
(paren
l_int|0x66
comma
l_int|0x0f
)paren
)paren
(brace
multiline_comment|/* cursor low register */
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|test_hga_b
c_func
(paren
l_int|0x99
comma
l_int|0x0f
)paren
)paren
(brace
multiline_comment|/* cursor low register */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* See if the card is a Hercules, by checking whether the vsync&n;&t; * bit of the status register is changing.  This test lasts for&n;&t; * approximately 1/10th of a second.&n;&t; */
id|p_save
op_assign
id|q_save
op_assign
id|inb_p
c_func
(paren
id|HGA_STATUS_PORT
)paren
op_amp
id|HGA_STATUS_VSYNC
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|50000
op_logical_and
id|p_save
op_eq
id|q_save
suffix:semicolon
id|count
op_increment
)paren
(brace
id|q_save
op_assign
id|inb
c_func
(paren
id|HGA_STATUS_PORT
)paren
op_amp
id|HGA_STATUS_VSYNC
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_save
op_ne
id|q_save
)paren
(brace
r_switch
c_cond
(paren
id|inb_p
c_func
(paren
id|HGA_STATUS_PORT
)paren
op_amp
l_int|0x70
)paren
(brace
r_case
l_int|0x10
suffix:colon
id|hga_type
op_assign
id|TYPE_HERCPLUS
suffix:semicolon
id|hga_type_name
op_assign
l_string|&quot;HerculesPlus&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x50
suffix:colon
id|hga_type
op_assign
id|TYPE_HERCCOLOR
suffix:semicolon
id|hga_type_name
op_assign
l_string|&quot;HerculesColor&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|hga_type
op_assign
id|TYPE_HERC
suffix:semicolon
id|hga_type_name
op_assign
l_string|&quot;Hercules&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- *&n; *&n; * dispsw functions&n; *&n; * ------------------------------------------------------------------------- */
multiline_comment|/**&n; *&t;hga_get_fix - get the fixed part of the display&n; *&t;@fix:struct fb_fix_screeninfo to fill in&n; *&t;@con:unused&n; *&t;@info:pointer to fb_info object containing info for current hga board&n; *&n; *&t;This wrapper function copies @info-&gt;fix to @fix.&n; *&t;A zero is returned on success and %-EINVAL for failure.&n; */
DECL|function|hga_get_fix
r_int
id|hga_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|CHKINFO
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hga_get_fix: con:%d, info:%x, fb_info:%x&bslash;n&quot;
comma
id|con
comma
(paren
r_int
)paren
id|info
comma
(paren
r_int
)paren
op_amp
id|fb_info
)paren
suffix:semicolon
op_star
id|fix
op_assign
id|info-&gt;fix
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;hga_get_var - get the user defined part of the display&n; *&t;@var:struct fb_var_screeninfo to fill in&n; *&t;@con:unused&n; *&t;@info:pointer to fb_info object containing info for current hga board&n; *&n; *&t;This wrapper function copies @info-&gt;var to @var.&n; *&t;A zero is returned on success and %-EINVAL for failure.&n; */
DECL|function|hga_get_var
r_int
id|hga_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|CHKINFO
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hga_get_var: con:%d, info:%x, fb_info:%x&bslash;n&quot;
comma
id|con
comma
(paren
r_int
)paren
id|info
comma
(paren
r_int
)paren
op_amp
id|fb_info
)paren
suffix:semicolon
op_star
id|var
op_assign
id|info-&gt;var
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;hga_set_var - set the user defined part of the display&n; *&t;@var:new video mode&n; *&t;@con:unused&n; *&t;@info:pointer to fb_info object containing info for current hga board&n; *&t;&n; *&t;This function is called for changing video modes. Since HGA cards have&n; *&t;only one fixed mode we have not much to do. After checking input &n; *&t;parameters @var is copied to @info-&gt;var and @info-&gt;changevar is called.&n; *&t;A zero is returned on success and %-EINVAL for failure.&n; *&t;&n; *&t;FIXME:&n; *&t;This is the most mystical function (at least for me).&n; *&t;What is the exact specification of xxx_set_var()?&n; *&t;Should it handle xoffset, yoffset? Should it do panning?&n; *&t;What does vmode mean?&n; */
DECL|function|hga_set_var
r_int
id|hga_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|CHKINFO
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hga_set_var: con:%d, activate:%x, info:0x%x, fb_info:%x&bslash;n&quot;
comma
id|con
comma
id|var-&gt;activate
comma
(paren
r_int
)paren
id|info
comma
(paren
r_int
)paren
op_amp
id|fb_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres
op_ne
l_int|720
op_logical_or
id|var-&gt;yres
op_ne
l_int|348
op_logical_or
id|var-&gt;xres_virtual
op_ne
l_int|720
op_logical_or
id|var-&gt;yres_virtual
template_param
l_int|348
op_plus
l_int|16
op_logical_or
id|var-&gt;bits_per_pixel
op_ne
l_int|1
op_logical_or
id|var-&gt;grayscale
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_NOW
)paren
(brace
id|info-&gt;var
op_assign
op_star
id|var
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;changevar
)paren
(paren
op_star
id|info-&gt;changevar
)paren
(paren
id|con
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;hga_getcolreg - read color registers&n; *&t;@regno:register index to read out&n; *&t;@red:red value&n; *&t;@green:green value&n; *&t;@blue:blue value&n; *&t;@transp:transparency value&n; *&t;@info:unused&n; *&n; *&t;This callback function is used to read the color registers of a HGA&n; *&t;board. Since we have only two fixed colors, RGB values are 0x0000 &n; *&t;for register0 and 0xaaaa for register1.&n; *&t;A zero is returned on success and 1 for failure.&n; */
DECL|function|hga_getcolreg
r_static
r_int
id|hga_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
op_eq
l_int|0
)paren
(brace
op_star
id|red
op_assign
op_star
id|green
op_assign
op_star
id|blue
op_assign
l_int|0x0000
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|regno
op_eq
l_int|1
)paren
(brace
op_star
id|red
op_assign
op_star
id|green
op_assign
op_star
id|blue
op_assign
l_int|0xaaaa
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;hga_get_cmap - get the colormap&n; *&t;@cmap:struct fb_cmap to fill in&n; *&t;@kspc:called from kernel space?&n; *&t;@con:unused&n; *&t;@info:pointer to fb_info object containing info for current hga board&n; *&n; *&t;This wrapper function passes it&squot;s input parameters to fb_get_cmap().&n; *&t;Callback function hga_getcolreg() is used to read the color registers.&n; */
DECL|function|hga_get_cmap
r_int
id|hga_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|CHKINFO
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hga_get_cmap: con:%d&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
r_return
id|fb_get_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|hga_getcolreg
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;hga_setcolreg - set color registers&n; *&t;@regno:register index to set&n; *&t;@red:red value, unused&n; *&t;@green:green value, unused&n; *&t;@blue:blue value, unused&n; *&t;@transp:transparency value, unused&n; *&t;@info:unused&n; *&n; *&t;This callback function is used to set the color registers of a HGA&n; *&t;board. Since we have only two fixed colors only @regno is checked.&n; *&t;A zero is returned on success and 1 for failure.&n; */
DECL|function|hga_setcolreg
r_static
r_int
id|hga_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|1
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;hga_set_cmap - set the colormap&n; *&t;@cmap:struct fb_cmap to set&n; *&t;@kspc:called from kernel space?&n; *&t;@con:unused&n; *&t;@info:pointer to fb_info object containing info for current hga board&n; *&n; *&t;This wrapper function passes it&squot;s input parameters to fb_set_cmap().&n; *&t;Callback function hga_setcolreg() is used to set the color registers.&n; */
DECL|function|hga_set_cmap
r_int
id|hga_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|CHKINFO
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hga_set_cmap: con:%d&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
r_return
id|fb_set_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|hga_setcolreg
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;hga_pan_display - pan or wrap the display&n; *&t;@var:contains new xoffset, yoffset and vmode values&n; *&t;@con:unused&n; *&t;@info:pointer to fb_info object containing info for current hga board&n; *&n; *&t;This function looks only at xoffset, yoffset and the %FB_VMODE_YWRAP&n; *&t;flag in @var. If input parameters are correct it calls hga_pan() to &n; *&t;program the hardware. @info-&gt;var is updated to the new values.&n; *&t;A zero is returned on success and %-EINVAL for failure.&n; */
DECL|function|hga_pan_display
r_int
id|hga_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|CHKINFO
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;pan_disp: con:%d, wrap:%d, xoff:%d, yoff:%d&bslash;n&quot;
comma
id|con
comma
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
comma
id|var-&gt;xoffset
comma
id|var-&gt;yoffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;yoffset
OL
l_int|0
op_logical_or
id|var-&gt;yoffset
op_ge
id|info-&gt;var.yres_virtual
op_logical_or
id|var-&gt;xoffset
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|var-&gt;xoffset
op_plus
id|var-&gt;xres
OG
id|info-&gt;var.xres_virtual
op_logical_or
id|var-&gt;yoffset
op_plus
id|var-&gt;yres
OG
id|info-&gt;var.yres_virtual
op_logical_or
id|var-&gt;yoffset
op_mod
l_int|8
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|hga_pan
c_func
(paren
id|var-&gt;xoffset
comma
id|var-&gt;yoffset
)paren
suffix:semicolon
id|info-&gt;var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|info-&gt;var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
id|info-&gt;var.vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
r_else
id|info-&gt;var.vmode
op_and_assign
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hgafb_ops
r_static
r_struct
id|fb_ops
id|hgafb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_get_fix
suffix:colon
id|hga_get_fix
comma
id|fb_get_var
suffix:colon
id|hga_get_var
comma
id|fb_set_var
suffix:colon
id|hga_set_var
comma
id|fb_get_cmap
suffix:colon
id|hga_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|hga_set_cmap
comma
id|fb_pan_display
suffix:colon
id|hga_pan_display
comma
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------------- *&n; *&n; * Functions in fb_info&n; * &n; * ------------------------------------------------------------------------- */
multiline_comment|/**&n; *&t;hgafbcon_switch - switch console&n; *&t;@con:new console to switch to&n; *&t;@info:pointer to fb_info object containing info for current hga board&n; *&n; *&t;This function should install a new colormap and change the video mode.&n; *&t;Since we have fixed colors and only one video mode we have nothing to &n; *&t;do.&n; *&t;Only console administration is done but it should go to fbcon.c IMHO.&n; *&t;A zero is returned on success and %-EINVAL for failure.&n; */
DECL|function|hgafbcon_switch
r_static
r_int
id|hgafbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|CHKINFO
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hgafbcon_switch: currcon:%d, con:%d, info:%x, fb_info:%x&bslash;n&quot;
comma
id|currcon
comma
id|con
comma
(paren
r_int
)paren
id|info
comma
(paren
r_int
)paren
op_amp
id|fb_info
)paren
suffix:semicolon
multiline_comment|/* Save the colormap and video mode */
macro_line|#if 0&t;/* Not necessary in hgafb, we use fixed colormap */
id|fb_copy_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
op_amp
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|currcon
op_ne
op_minus
l_int|1
)paren
multiline_comment|/* this check is absolute necessary! */
id|memcpy
c_func
(paren
op_amp
id|fb_display
(braket
id|currcon
)braket
dot
id|var
comma
op_amp
id|info-&gt;var
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
multiline_comment|/* Install a new colormap and change the video mode. By default fbcon&n;&t; * sets all the colormaps and video modes to the default values at&n;&t; * bootup.&n;&t; */
macro_line|#if 0
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
op_amp
id|info-&gt;cmap
comma
l_int|0
)paren
suffix:semicolon
id|fb_set_cmap
c_func
(paren
op_amp
id|info-&gt;cmap
comma
l_int|1
comma
id|hga_setcolreg
comma
id|info
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
op_amp
id|info-&gt;var
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
multiline_comment|/* hga_set_var(&amp;info-&gt;var, con, &amp;fb_info); is it necessary? */
id|currcon
op_assign
id|con
suffix:semicolon
multiline_comment|/* Hack to work correctly with XF86_Mono */
id|hga_gfx_mode
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;hgafbcon_updatevar - update the user defined part of the display&n; *&t;@con:console to update or -1 when no consoles defined on this fb&n; *&t;@info:pointer to fb_info object containing info for current hga board&n; *&n; *&t;This function is called when @var is changed by fbcon.c without calling &n; *&t;hga_set_var(). It usually means scrolling.  hga_pan_display() is called&n; *&t;to update the hardware and @info-&gt;var.&n; *&t;A zero is returned on success and %-EINVAL for failure.&n; */
DECL|function|hgafbcon_updatevar
r_static
r_int
id|hgafbcon_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|CHKINFO
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hga_update_var: con:%d, info:%x, fb_info:%x&bslash;n&quot;
comma
id|con
comma
(paren
r_int
)paren
id|info
comma
(paren
r_int
)paren
op_amp
id|fb_info
)paren
suffix:semicolon
r_return
(paren
id|con
OL
l_int|0
)paren
ques
c_cond
op_minus
id|EINVAL
suffix:colon
id|hga_pan_display
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
id|con
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;hgafbcon_blank - (un)blank the screen&n; *&t;@blank_mode:blanking method to use&n; *&t;@info:unused&n; *&t;&n; *&t;Blank the screen if blank_mode != 0, else unblank. &n; *&t;Implements VESA suspend and powerdown modes on hardware that supports &n; *&t;disabling hsync/vsync:&n; *&t;&t;@blank_mode == 2 means suspend vsync,&n; *&t;&t;@blank_mode == 3 means suspend hsync,&n; *&t;&t;@blank_mode == 4 means powerdown.&n; */
DECL|function|hgafbcon_blank
r_static
r_void
id|hgafbcon_blank
c_func
(paren
r_int
id|blank_mode
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|CHKINFO
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hga_blank: blank_mode:%d, info:%x, fb_info:%x&bslash;n&quot;
comma
id|blank_mode
comma
(paren
r_int
)paren
id|info
comma
(paren
r_int
)paren
op_amp
id|fb_info
)paren
suffix:semicolon
id|hga_blank
c_func
(paren
id|blank_mode
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/*&n;&t; *  Initialization&n;&t; */
DECL|function|hgafb_init
r_int
id|__init
id|hgafb_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hga_card_detect
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hgafb: HGA card not detected.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;hgafb: %s with %ldK of memory detected.&bslash;n&quot;
comma
id|hga_type_name
comma
id|hga_vram_len
op_div
l_int|1024
)paren
suffix:semicolon
id|hga_gfx_mode
c_func
(paren
)paren
suffix:semicolon
id|hga_clear_screen
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_if
c_cond
(paren
op_logical_neg
id|nologo
)paren
id|hga_show_logo
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
id|hga_fix.smem_start
op_assign
id|hga_vram_base
suffix:semicolon
id|hga_fix.smem_len
op_assign
id|hga_vram_len
suffix:semicolon
id|disp.var
op_assign
id|hga_default_var
suffix:semicolon
multiline_comment|/*&t;disp.cmap = ???; */
id|disp.screen_base
op_assign
(paren
r_char
op_star
)paren
id|hga_fix.smem_start
suffix:semicolon
id|disp.visual
op_assign
id|hga_fix.visual
suffix:semicolon
id|disp.type
op_assign
id|hga_fix.type
suffix:semicolon
id|disp.type_aux
op_assign
id|hga_fix.type_aux
suffix:semicolon
id|disp.ypanstep
op_assign
id|hga_fix.ypanstep
suffix:semicolon
id|disp.ywrapstep
op_assign
id|hga_fix.ywrapstep
suffix:semicolon
id|disp.line_length
op_assign
id|hga_fix.line_length
suffix:semicolon
id|disp.can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|disp.inverse
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef FBCON_HAS_HGA
id|disp.dispsw
op_assign
op_amp
id|fbcon_hga
suffix:semicolon
macro_line|#else
macro_line|#warning HGAFB will not work as a console!
id|disp.dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
macro_line|#endif
id|disp.dispsw_data
op_assign
l_int|NULL
suffix:semicolon
id|disp.scrollmode
op_assign
id|SCROLL_YREDRAW
suffix:semicolon
id|strcpy
(paren
id|fb_info.modename
comma
id|hga_fix.id
)paren
suffix:semicolon
id|fb_info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
multiline_comment|/*&t;fb_info.open = ??? */
id|fb_info.var
op_assign
id|hga_default_var
suffix:semicolon
id|fb_info.fix
op_assign
id|hga_fix
suffix:semicolon
id|fb_info.monspecs.hfmin
op_assign
l_int|0
suffix:semicolon
id|fb_info.monspecs.hfmax
op_assign
l_int|0
suffix:semicolon
id|fb_info.monspecs.vfmin
op_assign
l_int|10000
suffix:semicolon
id|fb_info.monspecs.vfmax
op_assign
l_int|10000
suffix:semicolon
id|fb_info.monspecs.dpms
op_assign
l_int|0
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|hgafb_ops
suffix:semicolon
id|fb_info.screen_base
op_assign
(paren
r_char
op_star
)paren
id|hga_fix.smem_start
suffix:semicolon
id|fb_info.disp
op_assign
op_amp
id|disp
suffix:semicolon
multiline_comment|/*&t;fb_info.display_fg = ??? */
multiline_comment|/*&t;fb_info.fontname initialized later */
id|fb_info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.switch_con
op_assign
id|hgafbcon_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
id|hgafbcon_updatevar
suffix:semicolon
id|fb_info.blank
op_assign
id|hgafbcon_blank
suffix:semicolon
id|fb_info.pseudo_palette
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* ??? */
id|fb_info.par
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;fb%d: %s frame buffer device&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|fb_info.node
)paren
comma
id|fb_info.modename
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Setup&n;&t; */
macro_line|#ifndef MODULE
DECL|function|hgafb_setup
r_int
id|__init
id|hgafb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
multiline_comment|/* &n;&t; * Parse user speficied options&n;&t; * `video=hga:font:VGA8x16&squot; or&n;&t; * `video=hga:font:SUN8x16&squot; recommended&n;&t; * Other supported fonts: VGA8x8, Acorn8x8, PEARL8x8&n;&t; * More different fonts can be used with the `setfont&squot; utility.&n;&t; */
r_char
op_star
id|this_opt
suffix:semicolon
id|fb_info.fontname
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|this_opt
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_opt
suffix:semicolon
id|this_opt
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;font:&quot;
comma
l_int|5
)paren
)paren
id|strcpy
c_func
(paren
id|fb_info.fontname
comma
id|this_opt
op_plus
l_int|5
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* !MODULE */
multiline_comment|/*&n;&t; * Cleanup&n;&t; */
macro_line|#ifdef MODULE
DECL|function|hgafb_cleanup
r_static
r_void
id|hgafb_cleanup
c_func
(paren
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|hga_txt_mode
c_func
(paren
)paren
suffix:semicolon
id|hga_clear_screen
c_func
(paren
)paren
suffix:semicolon
id|unregister_framebuffer
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|release_io_ports
)paren
id|release_region
c_func
(paren
l_int|0x3b0
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|release_io_port
)paren
id|release_region
c_func
(paren
l_int|0x3bf
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/* -------------------------------------------------------------------------&n; *&n; *  Modularization&n; *&n; * ------------------------------------------------------------------------- */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|font
)paren
id|strncpy
c_func
(paren
id|fb_info.fontname
comma
id|font
comma
r_sizeof
(paren
id|fb_info.fontname
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_else
id|fb_info.fontname
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|hgafb_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|hgafb_cleanup
c_func
(paren
op_amp
id|fb_info
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ferenc Bakonyi (fero@drama.obuda.kando.hu)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;FBDev driver for Hercules Graphics Adaptor&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|font
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|font
comma
l_string|&quot;Specifies one of the compiled-in fonts (VGA8x8, VGA8x16, SUN8x16, Acorn8x8, PEARL8x8) (default=none)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|nologo
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nologo
comma
l_string|&quot;Disables startup logo if != 0 (default=0)&quot;
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
eof
