multiline_comment|/*&n; *  drivers/video/chipsfb.c -- frame buffer device for&n; *  Chips &amp; Technologies 65550 chip.&n; *&n; *  Copyright (C) 1998 Paul Mackerras&n; *&n; *  This file is derived from the Powermac &quot;chips&quot; driver:&n; *  Copyright (C) 1997 Fabio Riccardi.&n; *  And from the frame buffer device for Open Firmware-initialized devices:&n; *  Copyright (C) 1997 Geert Uytterhoeven.&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License. See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#ifdef CONFIG_FB_COMPAT_XPMAC
macro_line|#include &lt;asm/vc_ioctl.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
macro_line|#include &lt;asm/backlight.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-cfb8.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
macro_line|#include &lt;video/macmodes.h&gt;
DECL|variable|currcon
r_static
r_int
id|currcon
op_assign
l_int|0
suffix:semicolon
DECL|struct|fb_info_chips
r_struct
id|fb_info_chips
(brace
DECL|member|info
r_struct
id|fb_info
id|info
suffix:semicolon
DECL|member|fix
r_struct
id|fb_fix_screeninfo
id|fix
suffix:semicolon
DECL|member|var
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
DECL|member|disp
r_struct
id|display
id|disp
suffix:semicolon
r_struct
(brace
DECL|member|red
DECL|member|green
DECL|member|blue
id|__u8
id|red
comma
id|green
comma
id|blue
suffix:semicolon
DECL|member|palette
)brace
id|palette
(braket
l_int|256
)braket
suffix:semicolon
DECL|member|frame_buffer_phys
r_int
r_int
id|frame_buffer_phys
suffix:semicolon
DECL|member|frame_buffer
id|__u8
op_star
id|frame_buffer
suffix:semicolon
DECL|member|blitter_regs_phys
r_int
r_int
id|blitter_regs_phys
suffix:semicolon
DECL|member|blitter_regs
id|__u32
op_star
id|blitter_regs
suffix:semicolon
DECL|member|blitter_data_phys
r_int
r_int
id|blitter_data_phys
suffix:semicolon
DECL|member|blitter_data
id|__u8
op_star
id|blitter_data
suffix:semicolon
DECL|member|io_base_phys
r_int
r_int
id|io_base_phys
suffix:semicolon
DECL|member|io_base
id|__u8
op_star
id|io_base
suffix:semicolon
DECL|member|next
r_struct
id|fb_info_chips
op_star
id|next
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
DECL|member|save_framebuffer
r_int
r_char
op_star
id|save_framebuffer
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
DECL|member|fbcon_cfb16_cmap
id|u16
id|fbcon_cfb16_cmap
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
DECL|macro|write_ind
mdefine_line|#define write_ind(num, val, ap, dp)&t;do { &bslash;&n;&t;out_8(p-&gt;io_base + (ap), (num)); out_8(p-&gt;io_base + (dp), (val)); &bslash;&n;} while (0)
DECL|macro|read_ind
mdefine_line|#define read_ind(num, var, ap, dp)&t;do { &bslash;&n;&t;out_8(p-&gt;io_base + (ap), (num)); var = in_8(p-&gt;io_base + (dp)); &bslash;&n;} while (0);
multiline_comment|/* extension registers */
DECL|macro|write_xr
mdefine_line|#define write_xr(num, val)&t;write_ind(num, val, 0x3d6, 0x3d7)
DECL|macro|read_xr
mdefine_line|#define read_xr(num, var)&t;read_ind(num, var, 0x3d6, 0x3d7)
multiline_comment|/* flat panel registers */
DECL|macro|write_fr
mdefine_line|#define write_fr(num, val)&t;write_ind(num, val, 0x3d0, 0x3d1)
DECL|macro|read_fr
mdefine_line|#define read_fr(num, var)&t;read_ind(num, var, 0x3d0, 0x3d1)
multiline_comment|/* CRTC registers */
DECL|macro|write_cr
mdefine_line|#define write_cr(num, val)&t;write_ind(num, val, 0x3d4, 0x3d5)
DECL|macro|read_cr
mdefine_line|#define read_cr(num, var)&t;read_ind(num, var, 0x3d4, 0x3d5)
multiline_comment|/* graphics registers */
DECL|macro|write_gr
mdefine_line|#define write_gr(num, val)&t;write_ind(num, val, 0x3ce, 0x3cf)
DECL|macro|read_gr
mdefine_line|#define read_gr(num, var)&t;read_ind(num, var, 0x3ce, 0x3cf)
multiline_comment|/* sequencer registers */
DECL|macro|write_sr
mdefine_line|#define write_sr(num, val)&t;write_ind(num, val, 0x3c4, 0x3c5)
DECL|macro|read_sr
mdefine_line|#define read_sr(num, var)&t;read_ind(num, var, 0x3c4, 0x3c5)
multiline_comment|/* attribute registers - slightly strange */
DECL|macro|write_ar
mdefine_line|#define write_ar(num, val)&t;do { &bslash;&n;&t;in_8(p-&gt;io_base + 0x3da); write_ind(num, val, 0x3c0, 0x3c0); &bslash;&n;} while (0)
DECL|macro|read_ar
mdefine_line|#define read_ar(num, var)&t;do { &bslash;&n;&t;in_8(p-&gt;io_base + 0x3da); read_ind(num, var, 0x3c0, 0x3c1); &bslash;&n;} while (0)
DECL|variable|all_chips
r_static
r_struct
id|fb_info_chips
op_star
id|all_chips
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_int
id|chips_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
suffix:semicolon
DECL|variable|chips_sleep_notifier
r_static
r_struct
id|pmu_sleep_notifier
id|chips_sleep_notifier
op_assign
(brace
id|chips_sleep_notify
comma
id|SLEEP_LEVEL_VIDEO
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Exported functions&n; */
r_int
id|chips_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|chips_of_init
c_func
(paren
r_struct
id|device_node
op_star
id|dp
)paren
suffix:semicolon
r_static
r_int
id|chips_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|chips_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|chips_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|chips_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|chips_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
DECL|variable|chipsfb_ops
r_static
r_struct
id|fb_ops
id|chipsfb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_get_fix
suffix:colon
id|chips_get_fix
comma
id|fb_get_var
suffix:colon
id|chips_get_var
comma
id|fb_set_var
suffix:colon
id|chips_set_var
comma
id|fb_get_cmap
suffix:colon
id|chips_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|chips_set_cmap
comma
)brace
suffix:semicolon
r_static
r_int
id|chipsfb_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|chipsfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|chips_set_bitdepth
c_func
(paren
r_struct
id|fb_info_chips
op_star
id|p
comma
r_struct
id|display
op_star
id|disp
comma
r_int
id|con
comma
r_int
id|bpp
)paren
suffix:semicolon
DECL|function|chips_get_fix
r_static
r_int
id|chips_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_info_chips
op_star
id|cp
op_assign
(paren
r_struct
id|fb_info_chips
op_star
)paren
id|info
suffix:semicolon
op_star
id|fix
op_assign
id|cp-&gt;fix
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chips_get_var
r_static
r_int
id|chips_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_info_chips
op_star
id|cp
op_assign
(paren
r_struct
id|fb_info_chips
op_star
)paren
id|info
suffix:semicolon
op_star
id|var
op_assign
id|cp-&gt;var
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chips_set_var
r_static
r_int
id|chips_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_info_chips
op_star
id|cp
op_assign
(paren
r_struct
id|fb_info_chips
op_star
)paren
id|info
suffix:semicolon
r_struct
id|display
op_star
id|disp
op_assign
(paren
id|con
op_ge
l_int|0
)paren
ques
c_cond
op_amp
id|fb_display
(braket
id|con
)braket
suffix:colon
op_amp
id|cp-&gt;disp
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres
OG
l_int|800
op_logical_or
id|var-&gt;yres
OG
l_int|600
op_logical_or
id|var-&gt;xres_virtual
OG
l_int|800
op_logical_or
id|var-&gt;yres_virtual
OG
l_int|600
op_logical_or
(paren
id|var-&gt;bits_per_pixel
op_ne
l_int|8
op_logical_and
id|var-&gt;bits_per_pixel
op_ne
l_int|16
)paren
op_logical_or
id|var-&gt;nonstd
op_logical_or
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
op_ne
id|FB_VMODE_NONINTERLACED
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_NOW
op_logical_and
id|var-&gt;bits_per_pixel
op_ne
id|disp-&gt;var.bits_per_pixel
)paren
(brace
id|chips_set_bitdepth
c_func
(paren
id|cp
comma
id|disp
comma
id|con
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chips_get_cmap
r_static
r_int
id|chips_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console? */
r_return
id|fb_get_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|chipsfb_getcolreg
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
multiline_comment|/* non default colormap? */
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
(brace
r_int
id|size
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
op_eq
l_int|16
ques
c_cond
l_int|32
suffix:colon
l_int|256
suffix:semicolon
id|fb_copy_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
id|size
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chips_set_cmap
r_static
r_int
id|chips_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
(brace
multiline_comment|/* no colormap allocated? */
r_int
id|size
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
op_eq
l_int|16
ques
c_cond
l_int|32
suffix:colon
l_int|256
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|size
comma
l_int|0
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console? */
r_return
id|fb_set_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|chipsfb_setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chipsfbcon_switch
r_static
r_int
id|chipsfbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_info_chips
op_star
id|p
op_assign
(paren
r_struct
id|fb_info_chips
op_star
)paren
id|info
suffix:semicolon
r_int
id|new_bpp
comma
id|old_bpp
suffix:semicolon
multiline_comment|/* Do we have to save the colormap? */
r_if
c_cond
(paren
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap.len
)paren
id|fb_get_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap
comma
l_int|1
comma
id|chipsfb_getcolreg
comma
id|info
)paren
suffix:semicolon
id|new_bpp
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
suffix:semicolon
id|old_bpp
op_assign
id|fb_display
(braket
id|currcon
)braket
dot
id|var.bits_per_pixel
suffix:semicolon
id|currcon
op_assign
id|con
suffix:semicolon
r_if
c_cond
(paren
id|new_bpp
op_ne
id|old_bpp
)paren
id|chips_set_bitdepth
c_func
(paren
id|p
comma
op_amp
id|fb_display
(braket
id|con
)braket
comma
id|con
comma
id|new_bpp
)paren
suffix:semicolon
id|do_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chipsfb_updatevar
r_static
r_int
id|chipsfb_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chipsfb_blank
r_static
r_void
id|chipsfb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_info_chips
op_star
id|p
op_assign
(paren
r_struct
id|fb_info_chips
op_star
)paren
id|info
suffix:semicolon
r_int
id|i
suffix:semicolon
singleline_comment|// used to disable backlight only for blank &gt; 1, but it seems
singleline_comment|// useful at blank = 1 too (saves battery, extends backlight life)
r_if
c_cond
(paren
id|blank
)paren
(brace
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
id|set_backlight_enable
c_func
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
multiline_comment|/* get the palette from the chip */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
op_increment
id|i
)paren
(brace
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c7
comma
id|i
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|p-&gt;palette
(braket
id|i
)braket
dot
id|red
op_assign
id|in_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
)paren
suffix:semicolon
id|p-&gt;palette
(braket
id|i
)braket
dot
id|green
op_assign
id|in_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
)paren
suffix:semicolon
id|p-&gt;palette
(braket
id|i
)braket
dot
id|blue
op_assign
id|in_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
op_increment
id|i
)paren
(brace
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c8
comma
id|i
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
comma
l_int|0
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
id|set_backlight_enable
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
op_increment
id|i
)paren
(brace
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c8
comma
id|i
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
comma
id|p-&gt;palette
(braket
id|i
)braket
dot
id|red
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
comma
id|p-&gt;palette
(braket
id|i
)braket
dot
id|green
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
comma
id|p-&gt;palette
(braket
id|i
)braket
dot
id|blue
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|chipsfb_getcolreg
r_static
r_int
id|chipsfb_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_info_chips
op_star
id|p
op_assign
(paren
r_struct
id|fb_info_chips
op_star
)paren
id|info
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
(paren
id|p-&gt;palette
(braket
id|regno
)braket
dot
id|red
op_lshift
l_int|8
)paren
op_or
id|p-&gt;palette
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
(paren
id|p-&gt;palette
(braket
id|regno
)braket
dot
id|green
op_lshift
l_int|8
)paren
op_or
id|p-&gt;palette
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
(paren
id|p-&gt;palette
(braket
id|regno
)braket
dot
id|blue
op_lshift
l_int|8
)paren
op_or
id|p-&gt;palette
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chipsfb_setcolreg
r_static
r_int
id|chipsfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_info_chips
op_star
id|p
op_assign
(paren
r_struct
id|fb_info_chips
op_star
)paren
id|info
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|p-&gt;palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|p-&gt;palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|p-&gt;palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c8
comma
id|regno
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
comma
id|red
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
comma
id|green
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c9
comma
id|blue
)paren
suffix:semicolon
macro_line|#ifdef FBCON_HAS_CFB16
r_if
c_cond
(paren
id|regno
OL
l_int|16
)paren
id|p-&gt;fbcon_cfb16_cmap
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xf8
)paren
op_lshift
l_int|7
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xf8
)paren
op_lshift
l_int|2
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf8
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_install_cmap
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_ne
id|currcon
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_set_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
comma
id|chipsfb_setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
(brace
r_int
id|size
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
op_eq
l_int|16
ques
c_cond
l_int|32
suffix:colon
l_int|256
suffix:semicolon
id|fb_set_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
id|size
)paren
comma
l_int|1
comma
id|chipsfb_setcolreg
comma
id|info
)paren
suffix:semicolon
)brace
)brace
DECL|function|chips_set_bitdepth
r_static
r_void
id|chips_set_bitdepth
c_func
(paren
r_struct
id|fb_info_chips
op_star
id|p
comma
r_struct
id|display
op_star
id|disp
comma
r_int
id|con
comma
r_int
id|bpp
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|fb_fix_screeninfo
op_star
id|fix
op_assign
op_amp
id|p-&gt;fix
suffix:semicolon
r_struct
id|fb_var_screeninfo
op_star
id|var
op_assign
op_amp
id|p-&gt;var
suffix:semicolon
r_if
c_cond
(paren
id|bpp
op_eq
l_int|16
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
(brace
id|write_cr
c_func
(paren
l_int|0x13
comma
l_int|200
)paren
suffix:semicolon
singleline_comment|// Set line length (doublewords)
id|write_xr
c_func
(paren
l_int|0x81
comma
l_int|0x14
)paren
suffix:semicolon
singleline_comment|// 15 bit (555) color mode
id|write_xr
c_func
(paren
l_int|0x82
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// Disable palettes
id|write_xr
c_func
(paren
l_int|0x20
comma
l_int|0x10
)paren
suffix:semicolon
singleline_comment|// 16 bit blitter mode
)brace
id|fix-&gt;line_length
op_assign
l_int|800
op_star
l_int|2
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|10
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
id|var-&gt;green.length
op_assign
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
macro_line|#ifdef FBCON_HAS_CFB16
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
id|p-&gt;fbcon_cfb16_cmap
suffix:semicolon
macro_line|#else
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|bpp
op_eq
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
(brace
id|write_cr
c_func
(paren
l_int|0x13
comma
l_int|100
)paren
suffix:semicolon
singleline_comment|// Set line length (doublewords)
id|write_xr
c_func
(paren
l_int|0x81
comma
l_int|0x12
)paren
suffix:semicolon
singleline_comment|// 8 bit color mode
id|write_xr
c_func
(paren
l_int|0x82
comma
l_int|0x08
)paren
suffix:semicolon
singleline_comment|// Graphics gamma enable
id|write_xr
c_func
(paren
l_int|0x20
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// 8 bit blitter mode
)brace
id|fix-&gt;line_length
op_assign
l_int|800
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|var-&gt;red.offset
op_assign
id|var-&gt;green.offset
op_assign
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
id|var-&gt;green.length
op_assign
id|var-&gt;blue.length
op_assign
l_int|8
suffix:semicolon
macro_line|#ifdef FBCON_HAS_CFB8
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
macro_line|#else
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
macro_line|#endif
)brace
id|var-&gt;bits_per_pixel
op_assign
id|bpp
suffix:semicolon
id|disp-&gt;line_length
op_assign
id|p-&gt;fix.line_length
suffix:semicolon
id|disp-&gt;visual
op_assign
id|fix-&gt;visual
suffix:semicolon
id|disp-&gt;var
op_assign
op_star
id|var
suffix:semicolon
macro_line|#if (defined(CONFIG_PMAC_PBOOK) || defined(CONFIG_FB_COMPAT_XPMAC))
id|display_info.depth
op_assign
id|bpp
suffix:semicolon
id|display_info.pitch
op_assign
id|fix-&gt;line_length
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|p-&gt;info.changevar
)paren
(paren
op_star
id|p-&gt;info.changevar
)paren
(paren
id|con
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|disp-&gt;cmap
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
r_return
suffix:semicolon
id|do_install_cmap
c_func
(paren
id|con
comma
(paren
r_struct
id|fb_info
op_star
)paren
id|p
)paren
suffix:semicolon
)brace
DECL|struct|chips_init_reg
r_struct
id|chips_init_reg
(brace
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|N_ELTS
mdefine_line|#define N_ELTS(x)&t;(sizeof(x) / sizeof(x[0]))
DECL|variable|chips_init_sr
r_static
r_struct
id|chips_init_reg
id|chips_init_sr
(braket
)braket
op_assign
(brace
(brace
l_int|0x00
comma
l_int|0x03
)brace
comma
(brace
l_int|0x01
comma
l_int|0x01
)brace
comma
(brace
l_int|0x02
comma
l_int|0x0f
)brace
comma
(brace
l_int|0x04
comma
l_int|0x0e
)brace
)brace
suffix:semicolon
DECL|variable|chips_init_gr
r_static
r_struct
id|chips_init_reg
id|chips_init_gr
(braket
)braket
op_assign
(brace
(brace
l_int|0x05
comma
l_int|0x00
)brace
comma
(brace
l_int|0x06
comma
l_int|0x0d
)brace
comma
(brace
l_int|0x08
comma
l_int|0xff
)brace
)brace
suffix:semicolon
DECL|variable|chips_init_ar
r_static
r_struct
id|chips_init_reg
id|chips_init_ar
(braket
)braket
op_assign
(brace
(brace
l_int|0x10
comma
l_int|0x01
)brace
comma
(brace
l_int|0x12
comma
l_int|0x0f
)brace
comma
(brace
l_int|0x13
comma
l_int|0x00
)brace
)brace
suffix:semicolon
DECL|variable|chips_init_cr
r_static
r_struct
id|chips_init_reg
id|chips_init_cr
(braket
)braket
op_assign
(brace
(brace
l_int|0x00
comma
l_int|0x7f
)brace
comma
(brace
l_int|0x01
comma
l_int|0x63
)brace
comma
(brace
l_int|0x02
comma
l_int|0x63
)brace
comma
(brace
l_int|0x03
comma
l_int|0x83
)brace
comma
(brace
l_int|0x04
comma
l_int|0x66
)brace
comma
(brace
l_int|0x05
comma
l_int|0x10
)brace
comma
(brace
l_int|0x06
comma
l_int|0x72
)brace
comma
(brace
l_int|0x07
comma
l_int|0x3e
)brace
comma
(brace
l_int|0x08
comma
l_int|0x00
)brace
comma
(brace
l_int|0x09
comma
l_int|0x40
)brace
comma
(brace
l_int|0x0c
comma
l_int|0x00
)brace
comma
(brace
l_int|0x0d
comma
l_int|0x00
)brace
comma
(brace
l_int|0x10
comma
l_int|0x59
)brace
comma
(brace
l_int|0x11
comma
l_int|0x0d
)brace
comma
(brace
l_int|0x12
comma
l_int|0x57
)brace
comma
(brace
l_int|0x13
comma
l_int|0x64
)brace
comma
(brace
l_int|0x14
comma
l_int|0x00
)brace
comma
(brace
l_int|0x15
comma
l_int|0x57
)brace
comma
(brace
l_int|0x16
comma
l_int|0x73
)brace
comma
(brace
l_int|0x17
comma
l_int|0xe3
)brace
comma
(brace
l_int|0x18
comma
l_int|0xff
)brace
comma
(brace
l_int|0x30
comma
l_int|0x02
)brace
comma
(brace
l_int|0x31
comma
l_int|0x02
)brace
comma
(brace
l_int|0x32
comma
l_int|0x02
)brace
comma
(brace
l_int|0x33
comma
l_int|0x02
)brace
comma
(brace
l_int|0x40
comma
l_int|0x00
)brace
comma
(brace
l_int|0x41
comma
l_int|0x00
)brace
comma
(brace
l_int|0x40
comma
l_int|0x80
)brace
)brace
suffix:semicolon
DECL|variable|chips_init_fr
r_static
r_struct
id|chips_init_reg
id|chips_init_fr
(braket
)braket
op_assign
(brace
(brace
l_int|0x01
comma
l_int|0x02
)brace
comma
(brace
l_int|0x03
comma
l_int|0x08
)brace
comma
(brace
l_int|0x04
comma
l_int|0x81
)brace
comma
(brace
l_int|0x05
comma
l_int|0x21
)brace
comma
(brace
l_int|0x08
comma
l_int|0x0c
)brace
comma
(brace
l_int|0x0a
comma
l_int|0x74
)brace
comma
(brace
l_int|0x0b
comma
l_int|0x11
)brace
comma
(brace
l_int|0x10
comma
l_int|0x0c
)brace
comma
(brace
l_int|0x11
comma
l_int|0xe0
)brace
comma
multiline_comment|/* { 0x12, 0x40 }, -- 3400 needs 40, 2400 needs 48, no way to tell */
(brace
l_int|0x20
comma
l_int|0x63
)brace
comma
(brace
l_int|0x21
comma
l_int|0x68
)brace
comma
(brace
l_int|0x22
comma
l_int|0x19
)brace
comma
(brace
l_int|0x23
comma
l_int|0x7f
)brace
comma
(brace
l_int|0x24
comma
l_int|0x68
)brace
comma
(brace
l_int|0x26
comma
l_int|0x00
)brace
comma
(brace
l_int|0x27
comma
l_int|0x0f
)brace
comma
(brace
l_int|0x30
comma
l_int|0x57
)brace
comma
(brace
l_int|0x31
comma
l_int|0x58
)brace
comma
(brace
l_int|0x32
comma
l_int|0x0d
)brace
comma
(brace
l_int|0x33
comma
l_int|0x72
)brace
comma
(brace
l_int|0x34
comma
l_int|0x02
)brace
comma
(brace
l_int|0x35
comma
l_int|0x22
)brace
comma
(brace
l_int|0x36
comma
l_int|0x02
)brace
comma
(brace
l_int|0x37
comma
l_int|0x00
)brace
)brace
suffix:semicolon
DECL|variable|chips_init_xr
r_static
r_struct
id|chips_init_reg
id|chips_init_xr
(braket
)braket
op_assign
(brace
(brace
l_int|0xce
comma
l_int|0x00
)brace
comma
multiline_comment|/* set default memory clock */
(brace
l_int|0xcc
comma
l_int|0x43
)brace
comma
multiline_comment|/* memory clock ratio */
(brace
l_int|0xcd
comma
l_int|0x18
)brace
comma
(brace
l_int|0xce
comma
l_int|0xa1
)brace
comma
(brace
l_int|0xc8
comma
l_int|0x84
)brace
comma
(brace
l_int|0xc9
comma
l_int|0x0a
)brace
comma
(brace
l_int|0xca
comma
l_int|0x00
)brace
comma
(brace
l_int|0xcb
comma
l_int|0x20
)brace
comma
(brace
l_int|0xcf
comma
l_int|0x06
)brace
comma
(brace
l_int|0xd0
comma
l_int|0x0e
)brace
comma
(brace
l_int|0x09
comma
l_int|0x01
)brace
comma
(brace
l_int|0x0a
comma
l_int|0x02
)brace
comma
(brace
l_int|0x0b
comma
l_int|0x01
)brace
comma
(brace
l_int|0x20
comma
l_int|0x00
)brace
comma
(brace
l_int|0x40
comma
l_int|0x03
)brace
comma
(brace
l_int|0x41
comma
l_int|0x01
)brace
comma
(brace
l_int|0x42
comma
l_int|0x00
)brace
comma
(brace
l_int|0x80
comma
l_int|0x82
)brace
comma
(brace
l_int|0x81
comma
l_int|0x12
)brace
comma
(brace
l_int|0x82
comma
l_int|0x08
)brace
comma
(brace
l_int|0xa0
comma
l_int|0x00
)brace
comma
(brace
l_int|0xa8
comma
l_int|0x00
)brace
)brace
suffix:semicolon
DECL|function|chips_hw_init
r_static
r_void
id|__init
id|chips_hw_init
c_func
(paren
r_struct
id|fb_info_chips
op_star
id|p
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_ELTS
c_func
(paren
id|chips_init_xr
)paren
suffix:semicolon
op_increment
id|i
)paren
id|write_xr
c_func
(paren
id|chips_init_xr
(braket
id|i
)braket
dot
id|addr
comma
id|chips_init_xr
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
id|out_8
c_func
(paren
id|p-&gt;io_base
op_plus
l_int|0x3c2
comma
l_int|0x29
)paren
suffix:semicolon
multiline_comment|/* set misc output reg */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_ELTS
c_func
(paren
id|chips_init_sr
)paren
suffix:semicolon
op_increment
id|i
)paren
id|write_sr
c_func
(paren
id|chips_init_sr
(braket
id|i
)braket
dot
id|addr
comma
id|chips_init_sr
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_ELTS
c_func
(paren
id|chips_init_gr
)paren
suffix:semicolon
op_increment
id|i
)paren
id|write_gr
c_func
(paren
id|chips_init_gr
(braket
id|i
)braket
dot
id|addr
comma
id|chips_init_gr
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_ELTS
c_func
(paren
id|chips_init_ar
)paren
suffix:semicolon
op_increment
id|i
)paren
id|write_ar
c_func
(paren
id|chips_init_ar
(braket
id|i
)braket
dot
id|addr
comma
id|chips_init_ar
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_ELTS
c_func
(paren
id|chips_init_cr
)paren
suffix:semicolon
op_increment
id|i
)paren
id|write_cr
c_func
(paren
id|chips_init_cr
(braket
id|i
)braket
dot
id|addr
comma
id|chips_init_cr
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N_ELTS
c_func
(paren
id|chips_init_fr
)paren
suffix:semicolon
op_increment
id|i
)paren
id|write_fr
c_func
(paren
id|chips_init_fr
(braket
id|i
)braket
dot
id|addr
comma
id|chips_init_fr
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
)brace
DECL|function|init_chips
r_static
r_void
id|__init
id|init_chips
c_func
(paren
r_struct
id|fb_info_chips
op_star
id|p
)paren
(brace
r_int
id|i
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;fix.id
comma
l_string|&quot;C&amp;T 65550&quot;
)paren
suffix:semicolon
id|p-&gt;fix.smem_start
op_assign
id|p-&gt;frame_buffer_phys
suffix:semicolon
singleline_comment|// FIXME: Assumes 1MB frame buffer, but 65550 supports 1MB or 2MB.
singleline_comment|// * &quot;3500&quot; PowerBook G3 (the original PB G3) has 2MB.
singleline_comment|// * 2400 has 1MB composed of 2 Mitsubishi M5M4V4265CTP DRAM chips.
singleline_comment|//   Motherboard actually supports 2MB -- there are two blank locations
singleline_comment|//   for a second pair of DRAMs.  (Thanks, Apple!)
singleline_comment|// * 3400 has 1MB (I think).  Don&squot;t know if it&squot;s expandable.
singleline_comment|// -- Tim Seufert
id|p-&gt;fix.smem_len
op_assign
l_int|0x100000
suffix:semicolon
singleline_comment|// 1MB
id|p-&gt;fix.mmio_start
op_assign
id|p-&gt;io_base_phys
suffix:semicolon
id|p-&gt;fix.type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|p-&gt;fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|p-&gt;fix.line_length
op_assign
l_int|800
suffix:semicolon
id|p-&gt;var.xres
op_assign
l_int|800
suffix:semicolon
id|p-&gt;var.yres
op_assign
l_int|600
suffix:semicolon
id|p-&gt;var.xres_virtual
op_assign
l_int|800
suffix:semicolon
id|p-&gt;var.yres_virtual
op_assign
l_int|600
suffix:semicolon
id|p-&gt;var.bits_per_pixel
op_assign
l_int|8
suffix:semicolon
id|p-&gt;var.red.length
op_assign
id|p-&gt;var.green.length
op_assign
id|p-&gt;var.blue.length
op_assign
l_int|8
suffix:semicolon
id|p-&gt;var.height
op_assign
id|p-&gt;var.width
op_assign
op_minus
l_int|1
suffix:semicolon
id|p-&gt;var.vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
id|p-&gt;var.pixclock
op_assign
l_int|10000
suffix:semicolon
id|p-&gt;var.left_margin
op_assign
id|p-&gt;var.right_margin
op_assign
l_int|16
suffix:semicolon
id|p-&gt;var.upper_margin
op_assign
id|p-&gt;var.lower_margin
op_assign
l_int|16
suffix:semicolon
id|p-&gt;var.hsync_len
op_assign
id|p-&gt;var.vsync_len
op_assign
l_int|8
suffix:semicolon
id|p-&gt;disp.var
op_assign
id|p-&gt;var
suffix:semicolon
id|p-&gt;disp.cmap.red
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;disp.cmap.green
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;disp.cmap.blue
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;disp.cmap.transp
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;disp.screen_base
op_assign
id|p-&gt;frame_buffer
suffix:semicolon
id|p-&gt;disp.visual
op_assign
id|p-&gt;fix.visual
suffix:semicolon
id|p-&gt;disp.type
op_assign
id|p-&gt;fix.type
suffix:semicolon
id|p-&gt;disp.type_aux
op_assign
id|p-&gt;fix.type_aux
suffix:semicolon
id|p-&gt;disp.line_length
op_assign
id|p-&gt;fix.line_length
suffix:semicolon
id|p-&gt;disp.can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|p-&gt;disp.dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
id|p-&gt;disp.scrollmode
op_assign
id|SCROLL_YREDRAW
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;info.modename
comma
id|p-&gt;fix.id
)paren
suffix:semicolon
id|p-&gt;info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|p-&gt;info.fbops
op_assign
op_amp
id|chipsfb_ops
suffix:semicolon
id|p-&gt;info.disp
op_assign
op_amp
id|p-&gt;disp
suffix:semicolon
id|p-&gt;info.fontname
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|p-&gt;info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;info.switch_con
op_assign
op_amp
id|chipsfbcon_switch
suffix:semicolon
id|p-&gt;info.updatevar
op_assign
op_amp
id|chipsfb_updatevar
suffix:semicolon
id|p-&gt;info.blank
op_assign
op_amp
id|chipsfb_blank
suffix:semicolon
id|p-&gt;info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
op_increment
id|i
)paren
(brace
r_int
id|j
op_assign
id|color_table
(braket
id|i
)braket
suffix:semicolon
id|p-&gt;palette
(braket
id|i
)braket
dot
id|red
op_assign
id|default_red
(braket
id|j
)braket
suffix:semicolon
id|p-&gt;palette
(braket
id|i
)braket
dot
id|green
op_assign
id|default_grn
(braket
id|j
)braket
suffix:semicolon
id|p-&gt;palette
(braket
id|i
)braket
dot
id|blue
op_assign
id|default_blu
(braket
id|j
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|p-&gt;info
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;fb%d: Chips 65550 frame buffer (%dK RAM detected)&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|p-&gt;info.node
)paren
comma
id|p-&gt;fix.smem_len
op_div
l_int|1024
)paren
suffix:semicolon
id|chips_hw_init
c_func
(paren
id|p
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FB_COMPAT_XPMAC
r_if
c_cond
(paren
op_logical_neg
id|console_fb_info
)paren
(brace
id|display_info.height
op_assign
id|p-&gt;var.yres
suffix:semicolon
id|display_info.width
op_assign
id|p-&gt;var.xres
suffix:semicolon
id|display_info.depth
op_assign
l_int|8
suffix:semicolon
id|display_info.pitch
op_assign
id|p-&gt;fix.line_length
suffix:semicolon
id|display_info.mode
op_assign
id|VMODE_800_600_60
suffix:semicolon
id|strncpy
c_func
(paren
id|display_info.name
comma
l_string|&quot;chips65550&quot;
comma
r_sizeof
(paren
id|display_info.name
)paren
)paren
suffix:semicolon
id|display_info.fb_address
op_assign
id|p-&gt;frame_buffer_phys
suffix:semicolon
id|display_info.cmap_adr_address
op_assign
id|p-&gt;io_base_phys
op_plus
l_int|0x3c8
suffix:semicolon
id|display_info.cmap_data_address
op_assign
id|p-&gt;io_base_phys
op_plus
l_int|0x3c9
suffix:semicolon
id|display_info.disp_reg_address
op_assign
id|p-&gt;blitter_regs_phys
suffix:semicolon
id|console_fb_info
op_assign
op_amp
id|p-&gt;info
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_FB_COMPAT_XPMAC */
macro_line|#ifdef CONFIG_PMAC_PBOOK
r_if
c_cond
(paren
id|all_chips
op_eq
l_int|NULL
)paren
id|pmu_register_sleep_notifier
c_func
(paren
op_amp
id|chips_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
id|p-&gt;next
op_assign
id|all_chips
suffix:semicolon
id|all_chips
op_assign
id|p
suffix:semicolon
)brace
DECL|function|chips_init
r_int
id|__init
id|chips_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|dp
suffix:semicolon
id|dp
op_assign
id|find_devices
c_func
(paren
l_string|&quot;chips65550&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dp
op_ne
l_int|0
)paren
id|chips_of_init
c_func
(paren
id|dp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|chips_of_init
r_static
r_void
id|__init
id|chips_of_init
c_func
(paren
r_struct
id|device_node
op_star
id|dp
)paren
(brace
r_struct
id|fb_info_chips
op_star
id|p
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
r_int
r_char
id|bus
comma
id|devfn
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|dp-&gt;n_addrs
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|p
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
id|addr
op_assign
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|addr
comma
id|dp-&gt;addrs
(braket
l_int|0
)braket
dot
id|size
comma
l_string|&quot;chipsfb&quot;
)paren
)paren
(brace
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef __BIG_ENDIAN
id|addr
op_add_assign
l_int|0x800000
suffix:semicolon
singleline_comment|// Use big-endian aperture
macro_line|#endif
id|p-&gt;frame_buffer_phys
op_assign
id|addr
suffix:semicolon
id|p-&gt;frame_buffer
op_assign
id|__ioremap
c_func
(paren
id|addr
comma
l_int|0x200000
comma
id|_PAGE_NO_CACHE
)paren
suffix:semicolon
id|p-&gt;blitter_regs_phys
op_assign
id|addr
op_plus
l_int|0x400000
suffix:semicolon
id|p-&gt;blitter_regs
op_assign
id|ioremap
c_func
(paren
id|addr
op_plus
l_int|0x400000
comma
l_int|0x1000
)paren
suffix:semicolon
id|p-&gt;blitter_data_phys
op_assign
id|addr
op_plus
l_int|0x410000
suffix:semicolon
id|p-&gt;blitter_data
op_assign
id|ioremap
c_func
(paren
id|addr
op_plus
l_int|0x410000
comma
l_int|0x10000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_device_loc
c_func
(paren
id|dp
comma
op_amp
id|bus
comma
op_amp
id|devfn
)paren
op_eq
l_int|0
)paren
(brace
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|cmd
op_or_assign
l_int|3
suffix:semicolon
multiline_comment|/* enable memory and IO space */
id|pcibios_write_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_COMMAND
comma
id|cmd
)paren
suffix:semicolon
id|p-&gt;io_base
op_assign
(paren
id|__u8
op_star
)paren
id|pci_io_base
c_func
(paren
id|bus
)paren
suffix:semicolon
multiline_comment|/* XXX really want the physical address here */
id|p-&gt;io_base_phys
op_assign
(paren
r_int
r_int
)paren
id|pci_io_base
c_func
(paren
id|bus
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear the entire framebuffer */
id|memset
c_func
(paren
id|p-&gt;frame_buffer
comma
l_int|0
comma
l_int|0x100000
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_BACKLIGHT
multiline_comment|/* turn on the backlight */
id|set_backlight_enable
c_func
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_BACKLIGHT */
id|init_chips
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
multiline_comment|/*&n; * Save the contents of the frame buffer when we go to sleep,&n; * and restore it when we wake up again.&n; */
r_int
DECL|function|chips_sleep_notify
id|chips_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
(brace
r_struct
id|fb_info_chips
op_star
id|p
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|all_chips
suffix:semicolon
id|p
op_ne
l_int|NULL
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_int
id|nb
op_assign
id|p-&gt;var.yres
op_star
id|p-&gt;fix.line_length
suffix:semicolon
r_switch
c_cond
(paren
id|when
)paren
(brace
r_case
id|PBOOK_SLEEP_REQUEST
suffix:colon
id|p-&gt;save_framebuffer
op_assign
id|vmalloc
c_func
(paren
id|nb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;save_framebuffer
op_eq
l_int|NULL
)paren
r_return
id|PBOOK_SLEEP_REFUSE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_SLEEP_REJECT
suffix:colon
r_if
c_cond
(paren
id|p-&gt;save_framebuffer
)paren
(brace
id|vfree
c_func
(paren
id|p-&gt;save_framebuffer
)paren
suffix:semicolon
id|p-&gt;save_framebuffer
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PBOOK_SLEEP_NOW
suffix:colon
id|chipsfb_blank
c_func
(paren
l_int|1
comma
(paren
r_struct
id|fb_info
op_star
)paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;save_framebuffer
)paren
id|memcpy
c_func
(paren
id|p-&gt;save_framebuffer
comma
id|p-&gt;frame_buffer
comma
id|nb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_WAKE
suffix:colon
r_if
c_cond
(paren
id|p-&gt;save_framebuffer
)paren
(brace
id|memcpy
c_func
(paren
id|p-&gt;frame_buffer
comma
id|p-&gt;save_framebuffer
comma
id|nb
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|p-&gt;save_framebuffer
)paren
suffix:semicolon
id|p-&gt;save_framebuffer
op_assign
l_int|0
suffix:semicolon
)brace
id|chipsfb_blank
c_func
(paren
l_int|0
comma
(paren
r_struct
id|fb_info
op_star
)paren
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PMAC_PBOOK */
eof
