multiline_comment|/*&n; * linux/drivers/video/acorn.c&n; *&n; * Copyright (C) 1998,1999 Russell King&n; *&n; * Frame buffer code for Acorn platforms&n; *&n; * NOTE: Most of the modes with X!=640 will disappear shortly.&n; * NOTE: Startup setting of HS &amp; VS polarity not supported.&n; *       (do we need to support it if we&squot;re coming up in 640x480?)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-mfb.h&gt;
macro_line|#include &lt;video/fbcon-cfb2.h&gt;
macro_line|#include &lt;video/fbcon-cfb4.h&gt;
macro_line|#include &lt;video/fbcon-cfb8.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
multiline_comment|/*&n; * Default resolution.&n; * NOTE that it has to be supported in the table towards&n; * the end of this file.&n; */
DECL|macro|DEFAULT_XRES
mdefine_line|#define DEFAULT_XRES&t;640
DECL|macro|DEFAULT_YRES
mdefine_line|#define DEFAULT_YRES&t;480
multiline_comment|/*&n; * define this to debug the video mode selection&n; */
DECL|macro|DEBUG_MODE_SELECTION
macro_line|#undef DEBUG_MODE_SELECTION
macro_line|#if defined(HAS_VIDC20)
DECL|macro|VIDC_PALETTE_SIZE
mdefine_line|#define VIDC_PALETTE_SIZE&t;256
DECL|macro|VIDC_NAME
mdefine_line|#define VIDC_NAME&t;&t;&quot;VIDC20&quot;
macro_line|#elif defined(HAS_VIDC)
macro_line|#include &lt;asm/memc.h&gt;
DECL|macro|VIDC_PALETTE_SIZE
mdefine_line|#define VIDC_PALETTE_SIZE&t;16
DECL|macro|VIDC_NAME
mdefine_line|#define VIDC_NAME&t;&t;&quot;VIDC&quot;
macro_line|#endif
DECL|macro|EXTEND8
mdefine_line|#define EXTEND8(x) ((x)|(x)&lt;&lt;8)
DECL|macro|EXTEND4
mdefine_line|#define EXTEND4(x) ((x)|(x)&lt;&lt;4|(x)&lt;&lt;8|(x)&lt;&lt;16)
DECL|struct|vidc20_palette
r_struct
id|vidc20_palette
(brace
DECL|member|red
id|u_int
id|red
suffix:colon
l_int|8
suffix:semicolon
DECL|member|green
id|u_int
id|green
suffix:colon
l_int|8
suffix:semicolon
DECL|member|blue
id|u_int
id|blue
suffix:colon
l_int|8
suffix:semicolon
DECL|member|ext
id|u_int
id|ext
suffix:colon
l_int|4
suffix:semicolon
DECL|member|unused
id|u_int
id|unused
suffix:colon
l_int|4
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|vidc_palette
r_struct
id|vidc_palette
(brace
DECL|member|red
id|u_int
id|red
suffix:colon
l_int|4
suffix:semicolon
DECL|member|green
id|u_int
id|green
suffix:colon
l_int|4
suffix:semicolon
DECL|member|blue
id|u_int
id|blue
suffix:colon
l_int|4
suffix:semicolon
DECL|member|trans
id|u_int
id|trans
suffix:colon
l_int|1
suffix:semicolon
DECL|member|sbz1
id|u_int
id|sbz1
suffix:colon
l_int|13
suffix:semicolon
DECL|member|reg
id|u_int
id|reg
suffix:colon
l_int|4
suffix:semicolon
DECL|member|sbz2
id|u_int
id|sbz2
suffix:colon
l_int|2
suffix:semicolon
)brace
suffix:semicolon
DECL|union|palette
r_union
id|palette
(brace
DECL|member|vidc20
r_struct
id|vidc20_palette
id|vidc20
suffix:semicolon
DECL|member|vidc
r_struct
id|vidc_palette
id|vidc
suffix:semicolon
DECL|member|p
id|u_int
id|p
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acornfb_par
r_struct
id|acornfb_par
(brace
DECL|member|screen_base
r_int
r_int
id|screen_base
suffix:semicolon
DECL|member|screen_base_p
r_int
r_int
id|screen_base_p
suffix:semicolon
DECL|member|screen_end
r_int
r_int
id|screen_end
suffix:semicolon
DECL|member|screen_size
r_int
r_int
id|screen_size
suffix:semicolon
DECL|member|dram_size
r_int
r_int
id|dram_size
suffix:semicolon
DECL|member|vram_half_sam
r_int
r_int
id|vram_half_sam
suffix:semicolon
DECL|member|palette_size
r_int
r_int
id|palette_size
suffix:semicolon
DECL|member|montype
r_int
r_int
id|montype
suffix:semicolon
DECL|member|currcon
r_int
r_int
id|currcon
suffix:semicolon
DECL|member|allow_modeset
r_int
r_int
id|allow_modeset
suffix:colon
l_int|1
suffix:semicolon
DECL|member|using_vram
r_int
r_int
id|using_vram
suffix:colon
l_int|1
suffix:semicolon
DECL|member|dpms
r_int
r_int
id|dpms
suffix:colon
l_int|1
suffix:semicolon
DECL|member|palette
r_union
id|palette
id|palette
(braket
id|VIDC_PALETTE_SIZE
)braket
suffix:semicolon
r_union
(brace
DECL|member|cfb16
r_int
r_int
id|cfb16
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|cfb32
r_int
r_int
id|cfb32
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|cmap
)brace
id|cmap
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Translation from RISC OS monitor types to actual&n; * HSYNC and VSYNC frequency ranges.  These are&n; * probably not right...&n; */
DECL|macro|NR_MONTYPES
mdefine_line|#define NR_MONTYPES&t;6
DECL|variable|__initdata
r_static
r_struct
id|fb_monspecs
id|monspecs
(braket
id|NR_MONTYPES
)braket
id|__initdata
op_assign
(brace
(brace
l_int|15625
comma
l_int|15625
comma
l_int|50
comma
l_int|50
comma
l_int|0
)brace
comma
multiline_comment|/* TV&t;&t;*/
(brace
l_int|0
comma
l_int|99999
comma
l_int|0
comma
l_int|99
comma
l_int|0
)brace
comma
multiline_comment|/* Multi Freq&t;*/
(brace
l_int|58608
comma
l_int|58608
comma
l_int|64
comma
l_int|64
comma
l_int|0
)brace
comma
multiline_comment|/* Hi-res mono&t;*/
(brace
l_int|30000
comma
l_int|70000
comma
l_int|60
comma
l_int|60
comma
l_int|0
)brace
comma
multiline_comment|/* VGA&t;&t;*/
(brace
l_int|30000
comma
l_int|70000
comma
l_int|56
comma
l_int|75
comma
l_int|0
)brace
comma
multiline_comment|/* SVGA&t;&t;*/
(brace
l_int|30000
comma
l_int|70000
comma
l_int|60
comma
l_int|60
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|global_disp
r_static
r_struct
id|display
id|global_disp
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|variable|current_par
r_static
r_struct
id|acornfb_par
id|current_par
suffix:semicolon
DECL|variable|init_var
r_static
r_struct
id|fb_var_screeninfo
id|__initdata
id|init_var
op_assign
(brace
)brace
suffix:semicolon
r_extern
r_int
id|acornfb_depth
suffix:semicolon
multiline_comment|/* set by setup.c */
r_extern
r_int
r_int
id|vram_size
suffix:semicolon
multiline_comment|/* set by setup.c */
DECL|struct|vidc_timing
r_static
r_struct
id|vidc_timing
(brace
DECL|member|h_cycle
id|u_int
id|h_cycle
suffix:semicolon
DECL|member|h_sync_width
id|u_int
id|h_sync_width
suffix:semicolon
DECL|member|h_border_start
id|u_int
id|h_border_start
suffix:semicolon
DECL|member|h_display_start
id|u_int
id|h_display_start
suffix:semicolon
DECL|member|h_display_end
id|u_int
id|h_display_end
suffix:semicolon
DECL|member|h_border_end
id|u_int
id|h_border_end
suffix:semicolon
DECL|member|h_interlace
id|u_int
id|h_interlace
suffix:semicolon
DECL|member|v_cycle
id|u_int
id|v_cycle
suffix:semicolon
DECL|member|v_sync_width
id|u_int
id|v_sync_width
suffix:semicolon
DECL|member|v_border_start
id|u_int
id|v_border_start
suffix:semicolon
DECL|member|v_display_start
id|u_int
id|v_display_start
suffix:semicolon
DECL|member|v_display_end
id|u_int
id|v_display_end
suffix:semicolon
DECL|member|v_border_end
id|u_int
id|v_border_end
suffix:semicolon
DECL|member|control
id|u_int
id|control
suffix:semicolon
multiline_comment|/* VIDC20 only */
DECL|member|pll_ctl
id|u_int
id|pll_ctl
suffix:semicolon
DECL|variable|current_vidc
)brace
id|current_vidc
suffix:semicolon
macro_line|#ifdef HAS_VIDC
DECL|macro|VID_CTL_VS_NVSYNC
mdefine_line|#define VID_CTL_VS_NVSYNC&t;(1 &lt;&lt; 3)
DECL|macro|VID_CTL_HS_NHSYNC
mdefine_line|#define VID_CTL_HS_NHSYNC&t;(1 &lt;&lt; 2)
DECL|macro|VID_CTL_24MHz
mdefine_line|#define VID_CTL_24MHz&t;&t;(0)
DECL|macro|VID_CTL_25MHz
mdefine_line|#define VID_CTL_25MHz&t;&t;(1)
DECL|macro|VID_CTL_36MHz
mdefine_line|#define VID_CTL_36MHz&t;&t;(2)
DECL|macro|VIDC_CTRL_INTERLACE
mdefine_line|#define VIDC_CTRL_INTERLACE&t;(1 &lt;&lt; 6)
DECL|macro|VIDC_CTRL_FIFO_0_4
mdefine_line|#define VIDC_CTRL_FIFO_0_4&t;(0 &lt;&lt; 4)
DECL|macro|VIDC_CTRL_FIFO_1_5
mdefine_line|#define VIDC_CTRL_FIFO_1_5&t;(1 &lt;&lt; 4)
DECL|macro|VIDC_CTRL_FIFO_2_6
mdefine_line|#define VIDC_CTRL_FIFO_2_6&t;(2 &lt;&lt; 4)
DECL|macro|VIDC_CTRL_FIFO_3_7
mdefine_line|#define VIDC_CTRL_FIFO_3_7&t;(3 &lt;&lt; 4)
DECL|macro|VIDC_CTRL_1BPP
mdefine_line|#define VIDC_CTRL_1BPP&t;&t;(0 &lt;&lt; 2)
DECL|macro|VIDC_CTRL_2BPP
mdefine_line|#define VIDC_CTRL_2BPP&t;&t;(1 &lt;&lt; 2)
DECL|macro|VIDC_CTRL_4BPP
mdefine_line|#define VIDC_CTRL_4BPP&t;&t;(2 &lt;&lt; 2)
DECL|macro|VIDC_CTRL_8BPP
mdefine_line|#define VIDC_CTRL_8BPP&t;&t;(3 &lt;&lt; 2)
DECL|macro|VIDC_CTRL_DIV3
mdefine_line|#define VIDC_CTRL_DIV3&t;&t;(0 &lt;&lt; 0)
DECL|macro|VIDC_CTRL_DIV2
mdefine_line|#define VIDC_CTRL_DIV2&t;&t;(1 &lt;&lt; 0)
DECL|macro|VIDC_CTRL_DIV1_5
mdefine_line|#define VIDC_CTRL_DIV1_5&t;(2 &lt;&lt; 0)
DECL|macro|VIDC_CTRL_DIV1
mdefine_line|#define VIDC_CTRL_DIV1&t;&t;(3 &lt;&lt; 0)
multiline_comment|/* CTL     VIDC&t;Actual&n; * 24.000  0&t; 8.000&n; * 25.175  0&t; 8.392&n; * 36.000  0&t;12.000&n; * 24.000  1&t;12.000&n; * 25.175  1&t;12.588&n; * 24.000  2&t;16.000&n; * 25.175  2&t;16.783&n; * 36.000  1&t;18.000&n; * 24.000  3&t;24.000&n; * 36.000  2&t;24.000&n; * 25.175  3&t;25.175&n; * 36.000  3&t;36.000&n; */
DECL|struct|pixclock
r_static
r_struct
id|pixclock
(brace
DECL|member|min_clock
id|u_long
id|min_clock
suffix:semicolon
DECL|member|max_clock
id|u_long
id|max_clock
suffix:semicolon
DECL|member|vidc_ctl
id|u_int
id|vidc_ctl
suffix:semicolon
DECL|member|vid_ctl
id|u_int
id|vid_ctl
suffix:semicolon
DECL|variable|pixclocks
)brace
id|pixclocks
(braket
)braket
op_assign
(brace
multiline_comment|/* we allow +/-1% on these */
(brace
l_int|123750
comma
l_int|126250
comma
id|VIDC_CTRL_DIV3
comma
id|VID_CTL_24MHz
)brace
comma
multiline_comment|/*  8.000MHz */
(brace
l_int|82500
comma
l_int|84167
comma
id|VIDC_CTRL_DIV2
comma
id|VID_CTL_24MHz
)brace
comma
multiline_comment|/* 12.000MHz */
(brace
l_int|61875
comma
l_int|63125
comma
id|VIDC_CTRL_DIV1_5
comma
id|VID_CTL_24MHz
)brace
comma
multiline_comment|/* 16.000MHz */
(brace
l_int|41250
comma
l_int|42083
comma
id|VIDC_CTRL_DIV1
comma
id|VID_CTL_24MHz
)brace
comma
multiline_comment|/* 24.000MHz */
macro_line|#ifdef CONFIG_ARCH_A5K
(brace
l_int|117974
comma
l_int|120357
comma
id|VIDC_CTRL_DIV3
comma
id|VID_CTL_25MHz
)brace
comma
multiline_comment|/*  8.392MHz */
(brace
l_int|78649
comma
l_int|80238
comma
id|VIDC_CTRL_DIV2
comma
id|VID_CTL_25MHz
)brace
comma
multiline_comment|/* 12.588MHz */
(brace
l_int|58987
comma
l_int|60178
comma
id|VIDC_CTRL_DIV1_5
comma
id|VID_CTL_25MHz
)brace
comma
multiline_comment|/* 16.588MHz */
(brace
l_int|55000
comma
l_int|56111
comma
id|VIDC_CTRL_DIV2
comma
id|VID_CTL_36MHz
)brace
comma
multiline_comment|/* 18.000MHz */
(brace
l_int|39325
comma
l_int|40119
comma
id|VIDC_CTRL_DIV1
comma
id|VID_CTL_25MHz
)brace
comma
multiline_comment|/* 25.175MHz */
(brace
l_int|27500
comma
l_int|28055
comma
id|VIDC_CTRL_DIV1
comma
id|VID_CTL_36MHz
)brace
comma
multiline_comment|/* 36.000MHz */
macro_line|#endif
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
r_static
r_struct
id|pixclock
op_star
DECL|function|acornfb_valid_pixrate
id|acornfb_valid_pixrate
c_func
(paren
id|u_long
id|pixclock
)paren
(brace
id|u_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|pixclocks
(braket
id|i
)braket
dot
id|min_clock
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pixclock
OG
id|pixclocks
(braket
id|i
)braket
dot
id|min_clock
op_logical_and
id|pixclock
OL
id|pixclocks
(braket
id|i
)braket
dot
id|max_clock
)paren
r_return
id|pixclocks
op_plus
id|i
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* VIDC Rules:&n; * hcr  : must be even (interlace, hcr/2 must be even)&n; * hswr : must be even&n; * hdsr : must be odd&n; * hder : must be odd&n; *&n; * vcr  : must be odd&n; * vswr : &gt;= 1&n; * vdsr : &gt;= 1&n; * vder : &gt;= vdsr&n; * if interlaced, then hcr/2 must be even&n; */
r_static
r_void
DECL|function|acornfb_set_timing
id|acornfb_set_timing
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_struct
id|pixclock
op_star
id|pclk
suffix:semicolon
r_struct
id|vidc_timing
id|vidc
suffix:semicolon
id|u_int
id|horiz_correction
suffix:semicolon
id|u_int
id|sync_len
comma
id|display_start
comma
id|display_end
comma
id|cycle
suffix:semicolon
id|u_int
id|is_interlaced
suffix:semicolon
id|u_int
id|vid_ctl
comma
id|vidc_ctl
suffix:semicolon
id|u_int
id|bandwidth
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vidc
comma
l_int|0
comma
r_sizeof
(paren
id|vidc
)paren
)paren
suffix:semicolon
id|pclk
op_assign
id|acornfb_valid_pixrate
c_func
(paren
id|var-&gt;pixclock
)paren
suffix:semicolon
id|vidc_ctl
op_assign
id|pclk-&gt;vidc_ctl
suffix:semicolon
id|vid_ctl
op_assign
id|pclk-&gt;vid_ctl
suffix:semicolon
id|bandwidth
op_assign
id|var-&gt;pixclock
op_star
l_int|8
op_div
id|var-&gt;bits_per_pixel
suffix:semicolon
multiline_comment|/* 25.175, 4bpp = 79.444ns per byte, 317.776ns per word: fifo = 2,6 */
r_if
c_cond
(paren
id|bandwidth
OG
l_int|143500
)paren
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_FIFO_3_7
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bandwidth
OG
l_int|71750
)paren
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_FIFO_2_6
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bandwidth
OG
l_int|35875
)paren
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_FIFO_1_5
suffix:semicolon
r_else
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_FIFO_0_4
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|horiz_correction
op_assign
l_int|19
suffix:semicolon
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_1BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|horiz_correction
op_assign
l_int|11
suffix:semicolon
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_2BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|horiz_correction
op_assign
l_int|7
suffix:semicolon
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_4BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
l_int|8
suffix:colon
id|horiz_correction
op_assign
l_int|5
suffix:semicolon
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_8BPP
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
)paren
id|vid_ctl
op_or_assign
id|VID_CTL_HS_NHSYNC
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
)paren
id|vid_ctl
op_or_assign
id|VID_CTL_VS_NVSYNC
suffix:semicolon
id|sync_len
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|display_start
op_assign
id|sync_len
op_plus
id|var-&gt;left_margin
suffix:semicolon
id|display_end
op_assign
id|display_start
op_plus
id|var-&gt;xres
suffix:semicolon
id|cycle
op_assign
id|display_end
op_plus
id|var-&gt;right_margin
suffix:semicolon
multiline_comment|/* if interlaced, then hcr/2 must be even */
id|is_interlaced
op_assign
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_INTERLACED
suffix:semicolon
r_if
c_cond
(paren
id|is_interlaced
)paren
(brace
id|vidc_ctl
op_or_assign
id|VIDC_CTRL_INTERLACE
suffix:semicolon
r_if
c_cond
(paren
id|cycle
op_amp
l_int|2
)paren
(brace
id|cycle
op_add_assign
l_int|2
suffix:semicolon
id|var-&gt;right_margin
op_add_assign
l_int|2
suffix:semicolon
)brace
)brace
id|vidc.h_cycle
op_assign
(paren
id|cycle
op_minus
l_int|2
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_sync_width
op_assign
(paren
id|sync_len
op_minus
l_int|2
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_border_start
op_assign
(paren
id|display_start
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_display_start
op_assign
(paren
id|display_start
op_minus
id|horiz_correction
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_display_end
op_assign
(paren
id|display_end
op_minus
id|horiz_correction
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_border_end
op_assign
(paren
id|display_end
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.h_interlace
op_assign
(paren
id|vidc.h_cycle
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|sync_len
op_assign
id|var-&gt;vsync_len
suffix:semicolon
id|display_start
op_assign
id|sync_len
op_plus
id|var-&gt;upper_margin
suffix:semicolon
id|display_end
op_assign
id|display_start
op_plus
id|var-&gt;yres
suffix:semicolon
id|cycle
op_assign
id|display_end
op_plus
id|var-&gt;lower_margin
suffix:semicolon
r_if
c_cond
(paren
id|is_interlaced
)paren
id|cycle
op_assign
(paren
id|cycle
op_minus
l_int|3
)paren
op_div
l_int|2
suffix:semicolon
r_else
id|cycle
op_assign
id|cycle
op_minus
l_int|1
suffix:semicolon
id|vidc.v_cycle
op_assign
id|cycle
suffix:semicolon
id|vidc.v_sync_width
op_assign
id|sync_len
op_minus
l_int|1
suffix:semicolon
id|vidc.v_border_start
op_assign
id|display_start
op_minus
l_int|1
suffix:semicolon
id|vidc.v_display_start
op_assign
id|vidc.v_border_start
suffix:semicolon
id|vidc.v_display_end
op_assign
id|display_end
op_minus
l_int|1
suffix:semicolon
id|vidc.v_border_end
op_assign
id|vidc.v_display_end
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_A5K
id|outb
c_func
(paren
id|vid_ctl
comma
id|IOEB_VID_CTL
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|current_vidc
comma
op_amp
id|vidc
comma
r_sizeof
(paren
id|vidc
)paren
)paren
)paren
(brace
id|current_vidc
op_assign
id|vidc
suffix:semicolon
id|outl
c_func
(paren
l_int|0xe0000000
op_or
id|vidc_ctl
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x80000000
op_or
(paren
id|vidc.h_cycle
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x84000000
op_or
(paren
id|vidc.h_sync_width
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x88000000
op_or
(paren
id|vidc.h_border_start
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x8c000000
op_or
(paren
id|vidc.h_display_start
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x90000000
op_or
(paren
id|vidc.h_display_end
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x94000000
op_or
(paren
id|vidc.h_border_end
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x98000000
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x9c000000
op_or
(paren
id|vidc.h_interlace
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xa0000000
op_or
(paren
id|vidc.v_cycle
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xa4000000
op_or
(paren
id|vidc.v_sync_width
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xa8000000
op_or
(paren
id|vidc.v_border_start
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xac000000
op_or
(paren
id|vidc.v_display_start
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xb0000000
op_or
(paren
id|vidc.v_display_end
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xb4000000
op_or
(paren
id|vidc.v_border_end
op_lshift
l_int|14
)paren
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xb8000000
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xbc000000
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_MODE_SELECTION
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;VIDC registers for %dx%dx%d:&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-cycle          : %d&bslash;n&quot;
comma
id|vidc.h_cycle
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-sync-width     : %d&bslash;n&quot;
comma
id|vidc.h_sync_width
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-border-start   : %d&bslash;n&quot;
comma
id|vidc.h_border_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-display-start  : %d&bslash;n&quot;
comma
id|vidc.h_display_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-display-end    : %d&bslash;n&quot;
comma
id|vidc.h_display_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-border-end     : %d&bslash;n&quot;
comma
id|vidc.h_border_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-interlace      : %d&bslash;n&quot;
comma
id|vidc.h_interlace
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-cycle          : %d&bslash;n&quot;
comma
id|vidc.v_cycle
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-sync-width     : %d&bslash;n&quot;
comma
id|vidc.v_sync_width
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-border-start   : %d&bslash;n&quot;
comma
id|vidc.v_border_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-display-start  : %d&bslash;n&quot;
comma
id|vidc.v_display_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-display-end    : %d&bslash;n&quot;
comma
id|vidc.v_display_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-border-end     : %d&bslash;n&quot;
comma
id|vidc.v_border_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; VIDC Ctrl (E)    : 0x%08X&bslash;n&quot;
comma
id|vidc_ctl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; IOEB Ctrl        : 0x%08X&bslash;n&quot;
comma
id|vid_ctl
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_inline
r_void
DECL|function|acornfb_palette_write
id|acornfb_palette_write
c_func
(paren
id|u_int
id|regno
comma
r_union
id|palette
id|pal
)paren
(brace
id|outl
c_func
(paren
id|pal.p
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
)brace
r_static
r_inline
r_union
id|palette
DECL|function|acornfb_palette_encode
id|acornfb_palette_encode
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|trans
)paren
(brace
r_union
id|palette
id|pal
suffix:semicolon
id|pal.p
op_assign
l_int|0
suffix:semicolon
id|pal.vidc.reg
op_assign
id|regno
suffix:semicolon
id|pal.vidc.red
op_assign
id|red
op_rshift
l_int|12
suffix:semicolon
id|pal.vidc.green
op_assign
id|green
op_rshift
l_int|12
suffix:semicolon
id|pal.vidc.blue
op_assign
id|blue
op_rshift
l_int|12
suffix:semicolon
r_return
id|pal
suffix:semicolon
)brace
r_static
r_void
DECL|function|acornfb_palette_decode
id|acornfb_palette_decode
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|trans
)paren
(brace
op_star
id|red
op_assign
id|EXTEND4
c_func
(paren
id|current_par.palette
(braket
id|regno
)braket
dot
id|vidc.red
)paren
suffix:semicolon
op_star
id|green
op_assign
id|EXTEND4
c_func
(paren
id|current_par.palette
(braket
id|regno
)braket
dot
id|vidc.green
)paren
suffix:semicolon
op_star
id|blue
op_assign
id|EXTEND4
c_func
(paren
id|current_par.palette
(braket
id|regno
)braket
dot
id|vidc.blue
)paren
suffix:semicolon
op_star
id|trans
op_assign
id|current_par.palette
(braket
id|regno
)braket
dot
id|vidc.trans
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef HAS_VIDC20
multiline_comment|/*&n; * VIDC20 registers&n; */
DECL|macro|VIDC20_CTRL
mdefine_line|#define VIDC20_CTRL&t;&t;0xe0000000
DECL|macro|VIDC20_CTRL_PIX_VCLK
mdefine_line|#define VIDC20_CTRL_PIX_VCLK&t;(0 &lt;&lt; 0)
DECL|macro|VIDC20_CTRL_PIX_HCLK
mdefine_line|#define VIDC20_CTRL_PIX_HCLK&t;(1 &lt;&lt; 0)
DECL|macro|VIDC20_CTRL_PIX_RCLK
mdefine_line|#define VIDC20_CTRL_PIX_RCLK&t;(2 &lt;&lt; 0)
DECL|macro|VIDC20_CTRL_PIX_CK
mdefine_line|#define VIDC20_CTRL_PIX_CK&t;(0 &lt;&lt; 2)
DECL|macro|VIDC20_CTRL_PIX_CK2
mdefine_line|#define VIDC20_CTRL_PIX_CK2&t;(1 &lt;&lt; 2)
DECL|macro|VIDC20_CTRL_PIX_CK3
mdefine_line|#define VIDC20_CTRL_PIX_CK3&t;(2 &lt;&lt; 2)
DECL|macro|VIDC20_CTRL_PIX_CK4
mdefine_line|#define VIDC20_CTRL_PIX_CK4&t;(3 &lt;&lt; 2)
DECL|macro|VIDC20_CTRL_PIX_CK5
mdefine_line|#define VIDC20_CTRL_PIX_CK5&t;(4 &lt;&lt; 2)
DECL|macro|VIDC20_CTRL_PIX_CK6
mdefine_line|#define VIDC20_CTRL_PIX_CK6&t;(5 &lt;&lt; 2)
DECL|macro|VIDC20_CTRL_PIX_CK7
mdefine_line|#define VIDC20_CTRL_PIX_CK7&t;(6 &lt;&lt; 2)
DECL|macro|VIDC20_CTRL_PIX_CK8
mdefine_line|#define VIDC20_CTRL_PIX_CK8&t;(7 &lt;&lt; 2)
DECL|macro|VIDC20_CTRL_1BPP
mdefine_line|#define VIDC20_CTRL_1BPP&t;(0 &lt;&lt; 5)
DECL|macro|VIDC20_CTRL_2BPP
mdefine_line|#define VIDC20_CTRL_2BPP&t;(1 &lt;&lt; 5)
DECL|macro|VIDC20_CTRL_4BPP
mdefine_line|#define VIDC20_CTRL_4BPP&t;(2 &lt;&lt; 5)
DECL|macro|VIDC20_CTRL_8BPP
mdefine_line|#define VIDC20_CTRL_8BPP&t;(3 &lt;&lt; 5)
DECL|macro|VIDC20_CTRL_16BPP
mdefine_line|#define VIDC20_CTRL_16BPP&t;(4 &lt;&lt; 5)
DECL|macro|VIDC20_CTRL_32BPP
mdefine_line|#define VIDC20_CTRL_32BPP&t;(6 &lt;&lt; 5)
DECL|macro|VIDC20_CTRL_FIFO_NS
mdefine_line|#define VIDC20_CTRL_FIFO_NS&t;(0 &lt;&lt; 8)
DECL|macro|VIDC20_CTRL_FIFO_4
mdefine_line|#define VIDC20_CTRL_FIFO_4&t;(1 &lt;&lt; 8)
DECL|macro|VIDC20_CTRL_FIFO_8
mdefine_line|#define VIDC20_CTRL_FIFO_8&t;(2 &lt;&lt; 8)
DECL|macro|VIDC20_CTRL_FIFO_12
mdefine_line|#define VIDC20_CTRL_FIFO_12&t;(3 &lt;&lt; 8)
DECL|macro|VIDC20_CTRL_FIFO_16
mdefine_line|#define VIDC20_CTRL_FIFO_16&t;(4 &lt;&lt; 8)
DECL|macro|VIDC20_CTRL_FIFO_20
mdefine_line|#define VIDC20_CTRL_FIFO_20&t;(5 &lt;&lt; 8)
DECL|macro|VIDC20_CTRL_FIFO_24
mdefine_line|#define VIDC20_CTRL_FIFO_24&t;(6 &lt;&lt; 8)
DECL|macro|VIDC20_CTRL_FIFO_28
mdefine_line|#define VIDC20_CTRL_FIFO_28&t;(7 &lt;&lt; 8)
DECL|macro|VIDC20_CTRL_INT
mdefine_line|#define VIDC20_CTRL_INT&t;&t;(1 &lt;&lt; 12)
DECL|macro|VIDC20_CTRL_DUP
mdefine_line|#define VIDC20_CTRL_DUP&t;&t;(1 &lt;&lt; 13)
DECL|macro|VIDC20_CTRL_PDOWN
mdefine_line|#define VIDC20_CTRL_PDOWN&t;(1 &lt;&lt; 14)
DECL|macro|VIDC20_ECTL
mdefine_line|#define VIDC20_ECTL&t;&t;0xc0000000
DECL|macro|VIDC20_ECTL_REG
mdefine_line|#define VIDC20_ECTL_REG(x)&t;((x) &amp; 0xf3)
DECL|macro|VIDC20_ECTL_ECK
mdefine_line|#define VIDC20_ECTL_ECK&t;&t;(1 &lt;&lt; 2)
DECL|macro|VIDC20_ECTL_REDPED
mdefine_line|#define VIDC20_ECTL_REDPED&t;(1 &lt;&lt; 8)
DECL|macro|VIDC20_ECTL_GREENPED
mdefine_line|#define VIDC20_ECTL_GREENPED&t;(1 &lt;&lt; 9)
DECL|macro|VIDC20_ECTL_BLUEPED
mdefine_line|#define VIDC20_ECTL_BLUEPED&t;(1 &lt;&lt; 10)
DECL|macro|VIDC20_ECTL_DAC
mdefine_line|#define VIDC20_ECTL_DAC&t;&t;(1 &lt;&lt; 12)
DECL|macro|VIDC20_ECTL_LCDGS
mdefine_line|#define VIDC20_ECTL_LCDGS&t;(1 &lt;&lt; 13)
DECL|macro|VIDC20_ECTL_HRM
mdefine_line|#define VIDC20_ECTL_HRM&t;&t;(1 &lt;&lt; 14)
DECL|macro|VIDC20_ECTL_HS_MASK
mdefine_line|#define VIDC20_ECTL_HS_MASK&t;(3 &lt;&lt; 16)
DECL|macro|VIDC20_ECTL_HS_HSYNC
mdefine_line|#define VIDC20_ECTL_HS_HSYNC&t;(0 &lt;&lt; 16)
DECL|macro|VIDC20_ECTL_HS_NHSYNC
mdefine_line|#define VIDC20_ECTL_HS_NHSYNC&t;(1 &lt;&lt; 16)
DECL|macro|VIDC20_ECTL_HS_CSYNC
mdefine_line|#define VIDC20_ECTL_HS_CSYNC&t;(2 &lt;&lt; 16)
DECL|macro|VIDC20_ECTL_HS_NCSYNC
mdefine_line|#define VIDC20_ECTL_HS_NCSYNC&t;(3 &lt;&lt; 16)
DECL|macro|VIDC20_ECTL_VS_MASK
mdefine_line|#define VIDC20_ECTL_VS_MASK&t;(3 &lt;&lt; 18)
DECL|macro|VIDC20_ECTL_VS_VSYNC
mdefine_line|#define VIDC20_ECTL_VS_VSYNC&t;(0 &lt;&lt; 18)
DECL|macro|VIDC20_ECTL_VS_NVSYNC
mdefine_line|#define VIDC20_ECTL_VS_NVSYNC&t;(1 &lt;&lt; 18)
DECL|macro|VIDC20_ECTL_VS_CSYNC
mdefine_line|#define VIDC20_ECTL_VS_CSYNC&t;(2 &lt;&lt; 18)
DECL|macro|VIDC20_ECTL_VS_NCSYNC
mdefine_line|#define VIDC20_ECTL_VS_NCSYNC&t;(3 &lt;&lt; 18)
DECL|macro|VIDC20_DCTL
mdefine_line|#define VIDC20_DCTL&t;&t;0xf0000000
multiline_comment|/* 0-9 = number of words in scanline */
DECL|macro|VIDC20_DCTL_SNA
mdefine_line|#define VIDC20_DCTL_SNA&t;&t;(1 &lt;&lt; 12)
DECL|macro|VIDC20_DCTL_HDIS
mdefine_line|#define VIDC20_DCTL_HDIS&t;(1 &lt;&lt; 13)
DECL|macro|VIDC20_DCTL_BUS_NS
mdefine_line|#define VIDC20_DCTL_BUS_NS&t;(0 &lt;&lt; 16)
DECL|macro|VIDC20_DCTL_BUS_D31_0
mdefine_line|#define VIDC20_DCTL_BUS_D31_0&t;(1 &lt;&lt; 16)
DECL|macro|VIDC20_DCTL_BUS_D63_32
mdefine_line|#define VIDC20_DCTL_BUS_D63_32&t;(2 &lt;&lt; 16)
DECL|macro|VIDC20_DCTL_BUS_D63_0
mdefine_line|#define VIDC20_DCTL_BUS_D63_0&t;(3 &lt;&lt; 16)
DECL|macro|VIDC20_DCTL_VRAM_DIS
mdefine_line|#define VIDC20_DCTL_VRAM_DIS&t;(0 &lt;&lt; 18)
DECL|macro|VIDC20_DCTL_VRAM_PXCLK
mdefine_line|#define VIDC20_DCTL_VRAM_PXCLK&t;(1 &lt;&lt; 18)
DECL|macro|VIDC20_DCTL_VRAM_PXCLK2
mdefine_line|#define VIDC20_DCTL_VRAM_PXCLK2&t;(2 &lt;&lt; 18)
DECL|macro|VIDC20_DCTL_VRAM_PXCLK4
mdefine_line|#define VIDC20_DCTL_VRAM_PXCLK4&t;(3 &lt;&lt; 18)
DECL|macro|acornfb_valid_pixrate
mdefine_line|#define acornfb_valid_pixrate(rate) (1)
multiline_comment|/*&n; * Try to find the best PLL parameters for the pixel clock.&n; * This algorithm seems to give best predictable results,&n; * and produces the same values as detailed in the VIDC20&n; * data sheet.&n; */
r_static
r_inline
id|u_int
DECL|function|acornfb_vidc20_find_pll
id|acornfb_vidc20_find_pll
c_func
(paren
id|u_int
id|pixclk
)paren
(brace
id|u_int
id|r
comma
id|best_r
op_assign
l_int|2
comma
id|best_v
op_assign
l_int|2
suffix:semicolon
r_int
id|best_d
op_assign
l_int|0x7fffffff
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
l_int|2
suffix:semicolon
id|r
op_le
l_int|32
suffix:semicolon
id|r
op_increment
)paren
(brace
id|u_int
id|rr
comma
id|v
comma
id|p
suffix:semicolon
r_int
id|d
suffix:semicolon
id|rr
op_assign
l_int|41667
op_star
id|r
suffix:semicolon
id|v
op_assign
(paren
id|rr
op_plus
id|pixclk
op_div
l_int|2
)paren
op_div
id|pixclk
suffix:semicolon
r_if
c_cond
(paren
id|v
OG
l_int|32
op_logical_or
id|v
OL
l_int|2
)paren
r_continue
suffix:semicolon
id|p
op_assign
(paren
id|rr
op_plus
id|v
op_div
l_int|2
)paren
op_div
id|v
suffix:semicolon
id|d
op_assign
id|pixclk
op_minus
id|p
suffix:semicolon
r_if
c_cond
(paren
id|d
OL
l_int|0
)paren
id|d
op_assign
op_minus
id|d
suffix:semicolon
r_if
c_cond
(paren
id|d
OL
id|best_d
)paren
(brace
id|best_d
op_assign
id|d
suffix:semicolon
id|best_v
op_assign
id|v
op_minus
l_int|1
suffix:semicolon
id|best_r
op_assign
id|r
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_return
id|best_v
op_lshift
l_int|8
op_or
id|best_r
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|acornfb_vidc20_find_rates
id|acornfb_vidc20_find_rates
c_func
(paren
r_struct
id|vidc_timing
op_star
id|vidc
comma
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|u_int
id|div
comma
id|bandwidth
suffix:semicolon
multiline_comment|/* Select pixel-clock divisor to keep PLL in range */
id|div
op_assign
id|var-&gt;pixclock
op_div
l_int|9090
suffix:semicolon
multiline_comment|/*9921*/
multiline_comment|/* Limit divisor */
r_if
c_cond
(paren
id|div
op_eq
l_int|0
)paren
id|div
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|div
OG
l_int|8
)paren
id|div
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* Encode divisor to VIDC20 setting */
r_switch
c_cond
(paren
id|div
)paren
(brace
r_case
l_int|1
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK7
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_PIX_CK8
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Calculate bandwidth */
id|bandwidth
op_assign
id|var-&gt;pixclock
op_star
l_int|8
op_div
id|var-&gt;bits_per_pixel
suffix:semicolon
multiline_comment|/* Encode bandwidth as VIDC20 setting */
r_if
c_cond
(paren
id|bandwidth
OG
l_int|16667
op_star
l_int|2
)paren
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_FIFO_16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bandwidth
OG
l_int|13333
op_star
l_int|2
)paren
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_FIFO_20
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bandwidth
OG
l_int|11111
op_star
l_int|2
)paren
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_FIFO_24
suffix:semicolon
r_else
id|vidc-&gt;control
op_or_assign
id|VIDC20_CTRL_FIFO_28
suffix:semicolon
multiline_comment|/* Find the PLL values */
id|vidc-&gt;pll_ctl
op_assign
id|acornfb_vidc20_find_pll
c_func
(paren
id|var-&gt;pixclock
op_div
id|div
)paren
suffix:semicolon
)brace
multiline_comment|/* VIDC20 has a different set of rules from the VIDC:&n; *  hcr  : must be multiple of 4&n; *  hswr : must be even&n; *  hdsr : must be even&n; *  hder : must be even&n; *  vcr  : &gt;= 2, (interlace, must be odd)&n; *  vswr : &gt;= 1&n; *  vdsr : &gt;= 1&n; *  vder : &gt;= vdsr&n; */
r_static
r_void
DECL|function|acornfb_set_timing
id|acornfb_set_timing
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_struct
id|vidc_timing
id|vidc
suffix:semicolon
id|u_int
id|vcr
comma
id|fsize
suffix:semicolon
id|u_int
id|ext_ctl
comma
id|dat_ctl
suffix:semicolon
id|u_int
id|words_per_line
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vidc
comma
l_int|0
comma
r_sizeof
(paren
id|vidc
)paren
)paren
suffix:semicolon
id|vidc.h_sync_width
op_assign
id|var-&gt;hsync_len
op_minus
l_int|8
suffix:semicolon
id|vidc.h_border_start
op_assign
id|vidc.h_sync_width
op_plus
id|var-&gt;left_margin
op_plus
l_int|8
op_minus
l_int|12
suffix:semicolon
id|vidc.h_display_start
op_assign
id|vidc.h_border_start
op_plus
l_int|12
op_minus
l_int|18
suffix:semicolon
id|vidc.h_display_end
op_assign
id|vidc.h_display_start
op_plus
id|var-&gt;xres
suffix:semicolon
id|vidc.h_border_end
op_assign
id|vidc.h_display_end
op_plus
l_int|18
op_minus
l_int|12
suffix:semicolon
id|vidc.h_cycle
op_assign
id|vidc.h_border_end
op_plus
id|var-&gt;right_margin
op_plus
l_int|12
op_minus
l_int|8
suffix:semicolon
id|vidc.h_interlace
op_assign
id|vidc.h_cycle
op_div
l_int|2
suffix:semicolon
id|vidc.v_sync_width
op_assign
id|var-&gt;vsync_len
op_minus
l_int|1
suffix:semicolon
id|vidc.v_border_start
op_assign
id|vidc.v_sync_width
op_plus
id|var-&gt;upper_margin
suffix:semicolon
id|vidc.v_display_start
op_assign
id|vidc.v_border_start
suffix:semicolon
id|vidc.v_display_end
op_assign
id|vidc.v_display_start
op_plus
id|var-&gt;yres
suffix:semicolon
id|vidc.v_border_end
op_assign
id|vidc.v_display_end
suffix:semicolon
id|vidc.control
op_assign
id|VIDC20_CTRL_PIX_VCLK
suffix:semicolon
id|vcr
op_assign
id|var-&gt;vsync_len
op_plus
id|var-&gt;upper_margin
op_plus
id|var-&gt;yres
op_plus
id|var-&gt;lower_margin
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
op_eq
id|FB_VMODE_INTERLACED
)paren
(brace
id|vidc.v_cycle
op_assign
(paren
id|vcr
op_minus
l_int|3
)paren
op_div
l_int|2
suffix:semicolon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_INT
suffix:semicolon
)brace
r_else
id|vidc.v_cycle
op_assign
id|vcr
op_minus
l_int|2
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_1BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_2BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_4BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
l_int|8
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_8BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|vidc.control
op_or_assign
id|VIDC20_CTRL_32BPP
suffix:semicolon
r_break
suffix:semicolon
)brace
id|acornfb_vidc20_find_rates
c_func
(paren
op_amp
id|vidc
comma
id|var
)paren
suffix:semicolon
id|fsize
op_assign
id|var-&gt;vsync_len
op_plus
id|var-&gt;upper_margin
op_plus
id|var-&gt;lower_margin
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|current_vidc
comma
op_amp
id|vidc
comma
r_sizeof
(paren
id|vidc
)paren
)paren
)paren
(brace
id|current_vidc
op_assign
id|vidc
suffix:semicolon
id|outl
c_func
(paren
id|VIDC20_CTRL
op_or
id|vidc.control
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xd0000000
op_or
id|vidc.pll_ctl
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x80000000
op_or
id|vidc.h_cycle
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x81000000
op_or
id|vidc.h_sync_width
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x82000000
op_or
id|vidc.h_border_start
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x83000000
op_or
id|vidc.h_display_start
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x84000000
op_or
id|vidc.h_display_end
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x85000000
op_or
id|vidc.h_border_end
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x86000000
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x87000000
op_or
id|vidc.h_interlace
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x90000000
op_or
id|vidc.v_cycle
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x91000000
op_or
id|vidc.v_sync_width
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x92000000
op_or
id|vidc.v_border_start
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x93000000
op_or
id|vidc.v_display_start
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x94000000
op_or
id|vidc.v_display_end
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x95000000
op_or
id|vidc.v_border_end
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x96000000
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x97000000
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
)brace
id|outl
c_func
(paren
id|fsize
comma
id|IOMD_FSIZE
)paren
suffix:semicolon
id|ext_ctl
op_assign
id|VIDC20_ECTL_DAC
op_or
id|VIDC20_ECTL_REG
c_func
(paren
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
id|ext_ctl
op_or_assign
id|VIDC20_ECTL_HS_HSYNC
suffix:semicolon
r_else
id|ext_ctl
op_or_assign
id|VIDC20_ECTL_HS_NHSYNC
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
id|ext_ctl
op_or_assign
id|VIDC20_ECTL_VS_VSYNC
suffix:semicolon
r_else
id|ext_ctl
op_or_assign
id|VIDC20_ECTL_VS_NVSYNC
suffix:semicolon
id|outl
c_func
(paren
id|VIDC20_ECTL
op_or
id|ext_ctl
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|words_per_line
op_assign
id|var-&gt;xres
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|current_par.using_vram
op_logical_and
id|current_par.screen_size
op_eq
l_int|2048
op_star
l_int|1024
)paren
id|words_per_line
op_div_assign
l_int|2
suffix:semicolon
multiline_comment|/* RiscPC doesn&squot;t use the VIDC&squot;s VRAM control. */
id|dat_ctl
op_assign
id|VIDC20_DCTL_VRAM_DIS
op_or
id|VIDC20_DCTL_SNA
op_or
id|words_per_line
suffix:semicolon
multiline_comment|/* The data bus width is dependent on both the type&n;&t; * and amount of video memory.&n;&t; *     DRAM&t;32bit low&n;&t; * 1MB VRAM&t;32bit&n;&t; * 2MB VRAM&t;64bit&n;&t; */
r_if
c_cond
(paren
id|current_par.using_vram
op_logical_and
id|current_par.vram_half_sam
op_eq
l_int|2048
)paren
(brace
id|dat_ctl
op_or_assign
id|VIDC20_DCTL_BUS_D63_0
suffix:semicolon
)brace
r_else
id|dat_ctl
op_or_assign
id|VIDC20_DCTL_BUS_D31_0
suffix:semicolon
id|outl
c_func
(paren
id|VIDC20_DCTL
op_or
id|dat_ctl
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_MODE_SELECTION
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;VIDC registers for %dx%dx%d:&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-cycle          : %d&bslash;n&quot;
comma
id|vidc.h_cycle
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-sync-width     : %d&bslash;n&quot;
comma
id|vidc.h_sync_width
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-border-start   : %d&bslash;n&quot;
comma
id|vidc.h_border_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-display-start  : %d&bslash;n&quot;
comma
id|vidc.h_display_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-display-end    : %d&bslash;n&quot;
comma
id|vidc.h_display_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-border-end     : %d&bslash;n&quot;
comma
id|vidc.h_border_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; H-interlace      : %d&bslash;n&quot;
comma
id|vidc.h_interlace
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-cycle          : %d&bslash;n&quot;
comma
id|vidc.v_cycle
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-sync-width     : %d&bslash;n&quot;
comma
id|vidc.v_sync_width
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-border-start   : %d&bslash;n&quot;
comma
id|vidc.v_border_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-display-start  : %d&bslash;n&quot;
comma
id|vidc.v_display_start
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-display-end    : %d&bslash;n&quot;
comma
id|vidc.v_display_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; V-border-end     : %d&bslash;n&quot;
comma
id|vidc.v_border_end
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Ext Ctrl  (C)    : 0x%08X&bslash;n&quot;
comma
id|ext_ctl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; PLL Ctrl  (D)    : 0x%08X&bslash;n&quot;
comma
id|vidc.pll_ctl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Ctrl      (E)    : 0x%08X&bslash;n&quot;
comma
id|vidc.control
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Data Ctrl (F)    : 0x%08X&bslash;n&quot;
comma
id|dat_ctl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; Fsize            : 0x%08X&bslash;n&quot;
comma
id|fsize
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_inline
r_void
DECL|function|acornfb_palette_write
id|acornfb_palette_write
c_func
(paren
id|u_int
id|regno
comma
r_union
id|palette
id|pal
)paren
(brace
id|outl
c_func
(paren
l_int|0x10000000
op_or
id|regno
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
id|outl
c_func
(paren
id|pal.p
comma
id|IO_VIDC_BASE
)paren
suffix:semicolon
)brace
r_static
r_inline
r_union
id|palette
DECL|function|acornfb_palette_encode
id|acornfb_palette_encode
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|trans
)paren
(brace
r_union
id|palette
id|pal
suffix:semicolon
id|pal.p
op_assign
l_int|0
suffix:semicolon
id|pal.vidc20.red
op_assign
id|red
op_rshift
l_int|8
suffix:semicolon
id|pal.vidc20.green
op_assign
id|green
op_rshift
l_int|8
suffix:semicolon
id|pal.vidc20.blue
op_assign
id|blue
op_rshift
l_int|8
suffix:semicolon
r_return
id|pal
suffix:semicolon
)brace
r_static
r_void
DECL|function|acornfb_palette_decode
id|acornfb_palette_decode
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|trans
)paren
(brace
op_star
id|red
op_assign
id|EXTEND8
c_func
(paren
id|current_par.palette
(braket
id|regno
)braket
dot
id|vidc20.red
)paren
suffix:semicolon
op_star
id|green
op_assign
id|EXTEND8
c_func
(paren
id|current_par.palette
(braket
id|regno
)braket
dot
id|vidc20.green
)paren
suffix:semicolon
op_star
id|blue
op_assign
id|EXTEND8
c_func
(paren
id|current_par.palette
(braket
id|regno
)braket
dot
id|vidc20.blue
)paren
suffix:semicolon
op_star
id|trans
op_assign
id|EXTEND4
c_func
(paren
id|current_par.palette
(braket
id|regno
)braket
dot
id|vidc20.ext
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Before selecting the timing parameters, adjust&n; * the resolution to fit the rules.&n; */
r_static
r_void
DECL|function|acornfb_pre_adjust_timing
id|acornfb_pre_adjust_timing
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
)paren
(brace
id|u_int
id|font_line_len
suffix:semicolon
id|u_int
id|fontht
suffix:semicolon
id|u_int
id|sam_size
comma
id|min_size
comma
id|size
suffix:semicolon
id|u_int
id|nr_y
suffix:semicolon
multiline_comment|/* xres must be even */
id|var-&gt;xres
op_assign
(paren
id|var-&gt;xres
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * We don&squot;t allow xres_virtual to differ from xres&n;&t; */
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
suffix:semicolon
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Find the font height&n;&t; */
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
id|fontht
op_assign
id|fontheight
c_func
(paren
op_amp
id|global_disp
)paren
suffix:semicolon
r_else
id|fontht
op_assign
id|fontheight
c_func
(paren
id|fb_display
op_plus
id|con
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fontht
op_eq
l_int|0
)paren
id|fontht
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|current_par.using_vram
)paren
id|sam_size
op_assign
id|current_par.vram_half_sam
op_star
l_int|2
suffix:semicolon
r_else
id|sam_size
op_assign
l_int|16
suffix:semicolon
multiline_comment|/*&n;&t; * Now, find a value for yres_virtual which allows&n;&t; * us to do ywrap scrolling.  The value of&n;&t; * yres_virtual must be such that the end of the&n;&t; * displayable frame buffer must be aligned with&n;&t; * the start of a font line.&n;&t; */
id|font_line_len
op_assign
id|var-&gt;xres
op_star
id|var-&gt;bits_per_pixel
op_star
id|fontht
op_div
l_int|8
suffix:semicolon
id|min_size
op_assign
id|var-&gt;xres
op_star
id|var-&gt;yres
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
suffix:semicolon
multiline_comment|/* Find int &squot;y&squot;, such that y * fll == s * sam &lt; maxsize&n;&t; * y = s * sam / fll; s = maxsize / sam&n;&t; */
r_for
c_loop
(paren
id|size
op_assign
id|current_par.screen_size
suffix:semicolon
id|min_size
op_le
id|size
suffix:semicolon
id|size
op_sub_assign
id|sam_size
)paren
(brace
id|nr_y
op_assign
id|size
op_div
id|font_line_len
suffix:semicolon
r_if
c_cond
(paren
id|nr_y
op_star
id|font_line_len
op_eq
id|size
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|min_size
OG
id|size
)paren
(brace
multiline_comment|/*&n;&t;&t; * failed, use ypan&n;&t;&t; */
id|size
op_assign
id|current_par.screen_size
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|size
op_div
(paren
id|font_line_len
op_div
id|fontht
)paren
suffix:semicolon
)brace
r_else
id|var-&gt;yres_virtual
op_assign
id|nr_y
op_star
id|fontht
suffix:semicolon
id|current_par.screen_end
op_assign
id|current_par.screen_base_p
op_plus
id|size
suffix:semicolon
multiline_comment|/*&n;&t; * Fix yres &amp; yoffset if needed.&n;&t; */
r_if
c_cond
(paren
id|var-&gt;yres
OG
id|var-&gt;yres_virtual
)paren
id|var-&gt;yres
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;yoffset
OG
id|var-&gt;yres_virtual
)paren
id|var-&gt;yoffset
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|var-&gt;yoffset
op_plus
id|var-&gt;yres
OG
id|var-&gt;yres_virtual
)paren
id|var-&gt;yoffset
op_assign
id|var-&gt;yres_virtual
op_minus
id|var-&gt;yres
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * After selecting the timing parameters, adjust&n; * the timing to suit the chip.&n; * NOTE! Only minor adjustments should be made here.&n; */
r_static
r_void
DECL|function|acornfb_post_adjust_timing
id|acornfb_post_adjust_timing
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
multiline_comment|/* hsync_len must be even */
id|var-&gt;hsync_len
op_assign
(paren
id|var-&gt;hsync_len
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
macro_line|#ifdef HAS_VIDC
multiline_comment|/* left_margin must be odd */
r_if
c_cond
(paren
(paren
id|var-&gt;left_margin
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|var-&gt;left_margin
op_sub_assign
l_int|1
suffix:semicolon
id|var-&gt;right_margin
op_add_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* right_margin must be odd */
id|var-&gt;right_margin
op_or_assign
l_int|1
suffix:semicolon
macro_line|#elif defined(HAS_VIDC20)
multiline_comment|/* left_margin must be even */
r_if
c_cond
(paren
id|var-&gt;left_margin
op_amp
l_int|1
)paren
(brace
id|var-&gt;left_margin
op_add_assign
l_int|1
suffix:semicolon
id|var-&gt;right_margin
op_sub_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* right_margin must be even */
r_if
c_cond
(paren
id|var-&gt;right_margin
op_amp
l_int|1
)paren
id|var-&gt;right_margin
op_add_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|var-&gt;vsync_len
OL
l_int|1
)paren
id|var-&gt;vsync_len
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|acornfb_update_dma
id|acornfb_update_dma
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_int
id|off
op_assign
(paren
id|var-&gt;yoffset
op_star
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
)paren
op_rshift
l_int|3
suffix:semicolon
macro_line|#if defined(HAS_MEMC)
id|memc_write
c_func
(paren
id|VDMA_INIT
comma
id|off
op_rshift
l_int|2
)paren
suffix:semicolon
macro_line|#elif defined(HAS_IOMD)
id|outl
c_func
(paren
id|current_par.screen_base_p
op_plus
id|off
comma
id|IOMD_VIDINIT
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_int
DECL|function|acornfb_open
id|acornfb_open
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_release
id|acornfb_release
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_getcolreg
id|acornfb_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|trans
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
op_ge
id|current_par.palette_size
)paren
r_return
l_int|1
suffix:semicolon
id|acornfb_palette_decode
c_func
(paren
id|regno
comma
id|red
comma
id|green
comma
id|blue
comma
id|trans
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_setcolreg
id|acornfb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|trans
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_union
id|palette
id|pal
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
id|current_par.palette_size
)paren
r_return
l_int|1
suffix:semicolon
id|pal
op_assign
id|acornfb_palette_encode
c_func
(paren
id|regno
comma
id|red
comma
id|green
comma
id|blue
comma
id|trans
)paren
suffix:semicolon
id|acornfb_palette_write
c_func
(paren
id|regno
comma
id|pal
)paren
suffix:semicolon
id|current_par.palette
(braket
id|regno
)braket
op_assign
id|pal
suffix:semicolon
r_if
c_cond
(paren
id|regno
OL
l_int|16
)paren
(brace
r_switch
c_cond
(paren
id|info-&gt;disp-&gt;var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB555 */
id|current_par.cmap.cfb16
(braket
id|regno
)braket
op_assign
(paren
id|regno
op_lshift
l_int|10
)paren
op_or
(paren
id|regno
op_lshift
l_int|5
)paren
op_or
id|regno
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_get_cmap
id|acornfb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
id|current_par.currcon
)paren
id|err
op_assign
id|fb_get_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|acornfb_getcolreg
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
id|current_par.palette_size
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_set_cmap
id|acornfb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|current_par.palette_size
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|current_par.currcon
)paren
id|err
op_assign
id|fb_set_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|acornfb_setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_decode_var
id|acornfb_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_int
op_star
id|visual
)paren
(brace
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_MFB
r_case
l_int|1
suffix:colon
op_star
id|visual
op_assign
id|FB_VISUAL_MONO10
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
macro_line|#ifdef HAS_VIDC
op_star
id|visual
op_assign
id|FB_VISUAL_STATIC_PSEUDOCOLOR
suffix:semicolon
macro_line|#else
op_star
id|visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB4
r_case
l_int|4
suffix:colon
op_star
id|visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB2
r_case
l_int|2
suffix:colon
op_star
id|visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
l_int|16
suffix:colon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
op_star
id|visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acornfb_valid_pixrate
c_func
(paren
id|var-&gt;pixclock
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * Adjust the resolution before using it.&n;&t; */
id|acornfb_pre_adjust_timing
c_func
(paren
id|var
comma
id|con
)paren
suffix:semicolon
macro_line|#if defined(HAS_VIDC20)
id|var-&gt;red.length
op_assign
l_int|8
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|4
suffix:semicolon
macro_line|#elif defined(HAS_VIDC)
id|var-&gt;red.length
op_assign
l_int|4
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;blue
op_assign
id|var-&gt;red
suffix:semicolon
multiline_comment|/*&n;&t; * Now adjust the timing parameters&n;&t; */
id|acornfb_post_adjust_timing
c_func
(paren
id|var
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_get_fix
id|acornfb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|display
op_star
id|display
suffix:semicolon
id|memset
c_func
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_fix_screeninfo
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
l_string|&quot;Acorn&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
id|display
op_assign
id|fb_display
op_plus
id|con
suffix:semicolon
r_else
id|display
op_assign
op_amp
id|global_disp
suffix:semicolon
id|fix-&gt;smem_start
op_assign
(paren
r_char
op_star
)paren
id|current_par.screen_base_p
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|current_par.screen_size
suffix:semicolon
id|fix-&gt;type
op_assign
id|display-&gt;type
suffix:semicolon
id|fix-&gt;type_aux
op_assign
id|display-&gt;type_aux
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
id|display-&gt;ypanstep
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
id|display-&gt;ywrapstep
suffix:semicolon
id|fix-&gt;visual
op_assign
id|display-&gt;visual
suffix:semicolon
id|fix-&gt;line_length
op_assign
id|display-&gt;line_length
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_get_var
id|acornfb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
(brace
op_star
id|var
op_assign
id|global_disp.var
suffix:semicolon
)brace
r_else
op_star
id|var
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_set_var
id|acornfb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|display
op_star
id|display
suffix:semicolon
r_int
id|err
comma
id|chgvar
op_assign
l_int|0
comma
id|visual
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
id|display
op_assign
id|fb_display
op_plus
id|con
suffix:semicolon
r_else
id|display
op_assign
op_amp
id|global_disp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|current_par.allow_modeset
op_logical_and
id|con
op_ne
op_minus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|acornfb_decode_var
c_func
(paren
id|var
comma
id|con
comma
op_amp
id|visual
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
(brace
r_case
id|FB_ACTIVATE_TEST
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|FB_ACTIVATE_NXTOPEN
suffix:colon
r_case
id|FB_ACTIVATE_NOW
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|display-&gt;var.xres
op_ne
id|var-&gt;xres
)paren
id|chgvar
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|display-&gt;var.yres
op_ne
id|var-&gt;yres
)paren
id|chgvar
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|display-&gt;var.xres_virtual
op_ne
id|var-&gt;xres_virtual
)paren
id|chgvar
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|display-&gt;var.yres_virtual
op_ne
id|var-&gt;yres_virtual
)paren
id|chgvar
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|display-&gt;var.red
comma
op_amp
id|var-&gt;red
comma
r_sizeof
(paren
id|var-&gt;red
)paren
)paren
)paren
id|chgvar
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|display-&gt;var.green
comma
op_amp
id|var-&gt;green
comma
r_sizeof
(paren
id|var-&gt;green
)paren
)paren
)paren
id|chgvar
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|display-&gt;var.blue
comma
op_amp
id|var-&gt;blue
comma
r_sizeof
(paren
id|var-&gt;blue
)paren
)paren
)paren
id|chgvar
op_assign
l_int|1
suffix:semicolon
)brace
id|display-&gt;var
op_assign
op_star
id|var
suffix:semicolon
id|display-&gt;var.activate
op_and_assign
op_complement
id|FB_ACTIVATE_ALL
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_ALL
)paren
id|global_disp.var
op_assign
id|display-&gt;var
suffix:semicolon
id|display-&gt;screen_base
op_assign
(paren
r_char
op_star
)paren
id|current_par.screen_base
suffix:semicolon
id|display-&gt;visual
op_assign
id|visual
suffix:semicolon
id|display-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|display-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|display-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
id|display-&gt;ywrapstep
op_assign
l_int|1
suffix:semicolon
id|display-&gt;line_length
op_assign
id|display-&gt;next_line
op_assign
(paren
id|var-&gt;xres
op_star
id|var-&gt;bits_per_pixel
)paren
op_div
l_int|8
suffix:semicolon
id|display-&gt;can_soft_blank
op_assign
id|visual
op_eq
id|FB_VISUAL_PSEUDOCOLOR
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|display-&gt;inverse
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|display-&gt;var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_MFB
r_case
l_int|1
suffix:colon
id|current_par.palette_size
op_assign
l_int|2
suffix:semicolon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_mfb
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB2
r_case
l_int|2
suffix:colon
id|current_par.palette_size
op_assign
l_int|4
suffix:semicolon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb2
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB4
r_case
l_int|4
suffix:colon
id|current_par.palette_size
op_assign
l_int|16
suffix:semicolon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|current_par.palette_size
op_assign
id|VIDC_PALETTE_SIZE
suffix:semicolon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|current_par.palette_size
op_assign
id|VIDC_PALETTE_SIZE
suffix:semicolon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|current_par.cmap.cfb16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chgvar
op_logical_and
id|info
op_logical_and
id|info-&gt;changevar
)paren
id|info
op_member_access_from_pointer
id|changevar
c_func
(paren
id|con
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
id|current_par.currcon
)paren
(brace
r_struct
id|fb_cmap
op_star
id|cmap
suffix:semicolon
r_int
r_int
id|start
comma
id|size
suffix:semicolon
r_int
id|control
suffix:semicolon
macro_line|#if defined(HAS_MEMC)
id|start
op_assign
l_int|0
suffix:semicolon
id|size
op_assign
id|current_par.screen_size
op_minus
id|VDMA_XFERSIZE
suffix:semicolon
id|control
op_assign
l_int|0
suffix:semicolon
id|memc_write
c_func
(paren
id|VDMA_START
comma
id|start
)paren
suffix:semicolon
id|memc_write
c_func
(paren
id|VDMA_END
comma
id|size
op_rshift
l_int|2
)paren
suffix:semicolon
macro_line|#elif defined(HAS_IOMD)
id|start
op_assign
id|current_par.screen_base_p
suffix:semicolon
id|size
op_assign
id|current_par.screen_end
suffix:semicolon
r_if
c_cond
(paren
id|current_par.using_vram
)paren
(brace
id|size
op_sub_assign
id|current_par.vram_half_sam
suffix:semicolon
id|control
op_assign
id|DMA_CR_E
op_or
(paren
id|current_par.vram_half_sam
op_div
l_int|256
)paren
suffix:semicolon
)brace
r_else
(brace
id|size
op_sub_assign
l_int|16
suffix:semicolon
id|control
op_assign
id|DMA_CR_E
op_or
id|DMA_CR_D
op_or
l_int|16
suffix:semicolon
)brace
id|outl
c_func
(paren
id|start
comma
id|IOMD_VIDSTART
)paren
suffix:semicolon
id|outl
c_func
(paren
id|size
comma
id|IOMD_VIDEND
)paren
suffix:semicolon
id|outl
c_func
(paren
id|control
comma
id|IOMD_VIDCR
)paren
suffix:semicolon
macro_line|#endif
id|acornfb_update_dma
c_func
(paren
id|var
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.allow_modeset
)paren
id|acornfb_set_timing
c_func
(paren
id|var
)paren
suffix:semicolon
r_if
c_cond
(paren
id|display-&gt;cmap.len
)paren
id|cmap
op_assign
op_amp
id|display-&gt;cmap
suffix:semicolon
r_else
id|cmap
op_assign
id|fb_default_cmap
c_func
(paren
id|current_par.palette_size
)paren
suffix:semicolon
id|fb_set_cmap
c_func
(paren
id|cmap
comma
l_int|1
comma
id|acornfb_setcolreg
comma
id|info
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_pan_display
id|acornfb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|u_int
id|y_bottom
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xoffset
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|y_bottom
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
)paren
id|y_bottom
op_add_assign
id|var-&gt;yres
suffix:semicolon
r_if
c_cond
(paren
id|y_bottom
OG
id|fb_display
(braket
id|con
)braket
dot
id|var.yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acornfb_update_dma
c_func
(paren
id|var
)paren
suffix:semicolon
id|fb_display
(braket
id|con
)braket
dot
id|var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_YWRAP
)paren
id|fb_display
(braket
id|con
)braket
dot
id|var.vmode
op_or_assign
id|FB_VMODE_YWRAP
suffix:semicolon
r_else
id|fb_display
(braket
id|con
)braket
dot
id|var.vmode
op_and_assign
op_complement
id|FB_VMODE_YWRAP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_ioctl
id|acornfb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|ino
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|variable|acornfb_ops
r_static
r_struct
id|fb_ops
id|acornfb_ops
op_assign
(brace
id|acornfb_open
comma
id|acornfb_release
comma
id|acornfb_get_fix
comma
id|acornfb_get_var
comma
id|acornfb_set_var
comma
id|acornfb_get_cmap
comma
id|acornfb_set_cmap
comma
id|acornfb_pan_display
comma
id|acornfb_ioctl
)brace
suffix:semicolon
r_static
r_int
DECL|function|acornfb_updatevar
id|acornfb_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|current_par.currcon
)paren
id|acornfb_update_dma
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|acornfb_switch
id|acornfb_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_cmap
op_star
id|cmap
suffix:semicolon
r_if
c_cond
(paren
id|current_par.currcon
op_ge
l_int|0
)paren
(brace
id|cmap
op_assign
op_amp
id|fb_display
(braket
id|current_par.currcon
)braket
dot
id|cmap
suffix:semicolon
r_if
c_cond
(paren
id|cmap-&gt;len
)paren
id|fb_get_cmap
c_func
(paren
id|cmap
comma
l_int|1
comma
id|acornfb_getcolreg
comma
id|info
)paren
suffix:semicolon
)brace
id|current_par.currcon
op_assign
id|con
suffix:semicolon
id|fb_display
(braket
id|con
)braket
dot
id|var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|acornfb_set_var
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
id|con
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|acornfb_blank
id|acornfb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|blank
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|current_par.palette_size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_union
id|palette
id|p
suffix:semicolon
id|p
op_assign
id|acornfb_palette_encode
c_func
(paren
id|i
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|acornfb_palette_write
c_func
(paren
id|i
comma
id|p
)paren
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|current_par.palette_size
suffix:semicolon
id|i
op_increment
)paren
id|acornfb_palette_write
c_func
(paren
id|i
comma
id|current_par.palette
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Everything after here is initialisation!!!&n; */
DECL|struct|modey_params
r_struct
id|modey_params
(brace
DECL|member|y_res
id|u_int
id|y_res
suffix:semicolon
DECL|member|u_margin
id|u_int
id|u_margin
suffix:semicolon
DECL|member|b_margin
id|u_int
id|b_margin
suffix:semicolon
DECL|member|vsync_len
id|u_int
id|vsync_len
suffix:semicolon
DECL|member|vf
id|u_int
id|vf
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|modex_params
r_struct
id|modex_params
(brace
DECL|member|x_res
id|u_int
id|x_res
suffix:semicolon
DECL|member|l_margin
id|u_int
id|l_margin
suffix:semicolon
DECL|member|r_margin
id|u_int
id|r_margin
suffix:semicolon
DECL|member|hsync_len
id|u_int
id|hsync_len
suffix:semicolon
DECL|member|clock
id|u_int
id|clock
suffix:semicolon
DECL|member|hf
id|u_int
id|hf
suffix:semicolon
DECL|member|modey
r_const
r_struct
id|modey_params
op_star
id|modey
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_640_15600
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|250
comma
l_int|38
comma
l_int|21
comma
l_int|3
comma
l_int|50
)brace
comma
multiline_comment|/*  640x 250, 50Hz */
(brace
l_int|256
comma
l_int|35
comma
l_int|18
comma
l_int|3
comma
l_int|50
)brace
comma
multiline_comment|/*  640x 256, 50Hz */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_640_26800
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|512
comma
l_int|18
comma
l_int|1
comma
l_int|3
comma
l_int|50
)brace
comma
multiline_comment|/*  640x 512, 50Hz */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_640_31500
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|250
comma
l_int|109
comma
l_int|88
comma
l_int|2
comma
l_int|70
)brace
comma
multiline_comment|/*  640x 250, 70Hz */
(brace
l_int|256
comma
l_int|106
comma
l_int|85
comma
l_int|2
comma
l_int|70
)brace
comma
multiline_comment|/*  640x 256, 70Hz */
(brace
l_int|352
comma
l_int|58
comma
l_int|37
comma
l_int|2
comma
l_int|70
)brace
comma
multiline_comment|/*  640x 352, 70Hz */
(brace
l_int|480
comma
l_int|32
comma
l_int|11
comma
l_int|2
comma
l_int|60
)brace
comma
multiline_comment|/*  640x 480, 60Hz */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_800_35200
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|600
comma
l_int|22
comma
l_int|1
comma
l_int|2
comma
l_int|56
)brace
comma
multiline_comment|/*  800x 600, 56Hz */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_896_21800
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|352
comma
l_int|9
comma
l_int|0
comma
l_int|3
comma
l_int|60
)brace
comma
multiline_comment|/*  896x 352, 60Hz */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* everything after here is not supported */
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_1024_uk
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|768
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1024x 768 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_1056_uk
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|250
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1056x 250 */
(brace
l_int|256
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1056x 256 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_1152_uk
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|896
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1152x 896 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_1280_63600
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|1024
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|60
)brace
comma
multiline_comment|/* 1280x1024, 60Hz */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_struct
id|modey_params
id|modey_1600_uk
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_int|1280
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1600x1280 */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Horizontal video programming requirements.&n; * This table is searched for the required horizontal&n; * and required frequency, and then the tables above&n; * are then searched for the required vertical&n; * resolution.&n; *&n; * NOTE! we can match multiple entries, so we search&n; * all horizontal entries for which the hfreq is within&n; * the monitor&squot;s range.&n; */
DECL|variable|__initdata
r_static
r_const
r_struct
id|modex_params
id|modex_params
(braket
)braket
id|__initdata
op_assign
(brace
(brace
multiline_comment|/* X:  640, 15.6kHz */
l_int|640
comma
l_int|185
comma
l_int|123
comma
l_int|76
comma
l_int|16000
comma
l_int|15625
comma
id|modey_640_15600
)brace
comma
(brace
multiline_comment|/* X:  640, 26.8kHz */
l_int|640
comma
l_int|113
comma
l_int|87
comma
l_int|56
comma
l_int|24000
comma
l_int|26800
comma
id|modey_640_26800
)brace
comma
(brace
multiline_comment|/* X:  640, 31.5kHz */
l_int|640
comma
l_int|48
comma
l_int|16
comma
l_int|96
comma
l_int|25175
comma
l_int|31500
comma
id|modey_640_31500
)brace
comma
(brace
multiline_comment|/* X:  800, 35.2kHz */
l_int|800
comma
l_int|101
comma
l_int|23
comma
l_int|100
comma
l_int|36000
comma
l_int|35200
comma
id|modey_800_35200
)brace
comma
(brace
multiline_comment|/* X:  896, 21.8kHz */
l_int|896
comma
l_int|59
comma
l_int|27
comma
l_int|118
comma
l_int|24000
comma
l_int|21800
comma
id|modey_896_21800
)brace
comma
(brace
multiline_comment|/* X: 1024 */
l_int|1024
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|modey_1024_uk
)brace
comma
(brace
multiline_comment|/* X: 1056 */
l_int|1056
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|modey_1056_uk
)brace
comma
(brace
multiline_comment|/* X: 1152 */
l_int|1152
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|modey_1152_uk
)brace
comma
(brace
multiline_comment|/* X: 1280, 63.6kHz */
l_int|1280
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|63600
comma
id|modey_1280_63600
)brace
comma
(brace
multiline_comment|/* X: 1600 */
l_int|1600
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|modey_1600_uk
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|acornfb_lookup_timing
id|acornfb_lookup_timing
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
r_const
r_struct
id|modex_params
op_star
id|x
suffix:semicolon
r_const
r_struct
id|modey_params
op_star
id|y
suffix:semicolon
multiline_comment|/*&n;&t; * We must adjust the resolution parameters&n;&t; * before selecting the timing parameters.&n;&t; */
id|acornfb_pre_adjust_timing
c_func
(paren
id|var
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|x
op_assign
id|modex_params
suffix:semicolon
id|x-&gt;x_res
suffix:semicolon
id|x
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; * Is this resolution one we&squot;re looking for?&n;&t;&t; */
r_if
c_cond
(paren
id|x-&gt;x_res
op_ne
id|var-&gt;xres
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Is the hsync frequency ok for our monitor?&n;&t;&t; */
r_if
c_cond
(paren
id|x-&gt;hf
OG
id|fb_info.monspecs.hfmax
op_logical_or
id|x-&gt;hf
OL
id|fb_info.monspecs.hfmin
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Try to find a vertical resolution&n;&t;&t; */
r_for
c_loop
(paren
id|y
op_assign
id|x-&gt;modey
suffix:semicolon
id|y-&gt;y_res
suffix:semicolon
id|y
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Is this resolution one we&squot;re looking for?&n;&t;&t;&t; */
r_if
c_cond
(paren
id|y-&gt;y_res
op_ne
id|var-&gt;yres
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Is the vsync frequency ok for our monitor?&n;&t;&t;&t; */
r_if
c_cond
(paren
id|y-&gt;vf
OG
id|fb_info.monspecs.vfmax
op_logical_or
id|y-&gt;vf
OL
id|fb_info.monspecs.vfmin
)paren
r_continue
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
)brace
id|var-&gt;pixclock
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
id|found
suffix:colon
multiline_comment|/*&n;&t; * Why is pixclock in picoseconds?&n;&t; */
r_switch
c_cond
(paren
id|x-&gt;clock
)paren
(brace
r_case
l_int|36000
suffix:colon
id|var-&gt;pixclock
op_assign
l_int|27778
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|25175
suffix:colon
id|var-&gt;pixclock
op_assign
l_int|39722
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24000
suffix:colon
id|var-&gt;pixclock
op_assign
l_int|41667
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16000
suffix:colon
id|var-&gt;pixclock
op_assign
l_int|62500
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12000
suffix:colon
id|var-&gt;pixclock
op_assign
l_int|83333
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8000
suffix:colon
id|var-&gt;pixclock
op_assign
l_int|125000
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|var-&gt;pixclock
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_MODE_SELECTION
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Found %dx%d at %d.%3dkHz, %dHz, pix %d&bslash;n&quot;
comma
id|x-&gt;x_res
comma
id|y-&gt;y_res
comma
id|x-&gt;hf
op_div
l_int|1000
comma
id|x-&gt;hf
op_mod
l_int|1000
comma
id|y-&gt;vf
comma
id|var-&gt;pixclock
)paren
suffix:semicolon
macro_line|#endif
id|var-&gt;left_margin
op_assign
id|x-&gt;l_margin
suffix:semicolon
id|var-&gt;right_margin
op_assign
id|x-&gt;r_margin
suffix:semicolon
id|var-&gt;upper_margin
op_assign
id|y-&gt;u_margin
suffix:semicolon
id|var-&gt;lower_margin
op_assign
id|y-&gt;b_margin
suffix:semicolon
id|var-&gt;hsync_len
op_assign
id|x-&gt;hsync_len
suffix:semicolon
id|var-&gt;vsync_len
op_assign
id|y-&gt;vsync_len
suffix:semicolon
id|var-&gt;sync
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Now adjust the parameters we found&n;&t; */
id|acornfb_post_adjust_timing
c_func
(paren
id|var
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|acornfb_init_fbinfo
id|acornfb_init_fbinfo
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|first
)paren
r_return
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Acorn&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.fontname
comma
l_string|&quot;Acorn8x8&quot;
)paren
suffix:semicolon
id|fb_info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|acornfb_ops
suffix:semicolon
id|fb_info.disp
op_assign
op_amp
id|global_disp
suffix:semicolon
id|fb_info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.switch_con
op_assign
id|acornfb_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
id|acornfb_updatevar
suffix:semicolon
id|fb_info.blank
op_assign
id|acornfb_blank
suffix:semicolon
id|fb_info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|global_disp.dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
multiline_comment|/*&n;&t; * setup initial parameters&n;&t; */
id|memset
c_func
(paren
op_amp
id|init_var
comma
l_int|0
comma
r_sizeof
(paren
id|init_var
)paren
)paren
suffix:semicolon
id|init_var.xres
op_assign
id|DEFAULT_XRES
suffix:semicolon
id|init_var.yres
op_assign
id|DEFAULT_YRES
suffix:semicolon
macro_line|#if   defined(FBCON_HAS_CFB4)
id|init_var.bits_per_pixel
op_assign
l_int|4
suffix:semicolon
macro_line|#elif defined(FBCON_HAS_CFB8)
id|init_var.bits_per_pixel
op_assign
l_int|8
suffix:semicolon
macro_line|#elif defined(FBCON_HAS_CFB2)
id|init_var.bits_per_pixel
op_assign
l_int|2
suffix:semicolon
macro_line|#elif defined(FBCON_HAS_MFB)
id|init_var.bits_per_pixel
op_assign
l_int|1
suffix:semicolon
macro_line|#else
macro_line|#error No suitable framebuffers configured
macro_line|#endif
macro_line|#if defined(HAS_VIDC20)
id|init_var.red.length
op_assign
l_int|8
suffix:semicolon
id|init_var.transp.length
op_assign
l_int|4
suffix:semicolon
macro_line|#elif defined(HAS_VIDC)
id|init_var.red.length
op_assign
l_int|4
suffix:semicolon
id|init_var.transp.length
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|init_var.green
op_assign
id|init_var.red
suffix:semicolon
id|init_var.blue
op_assign
id|init_var.red
suffix:semicolon
id|init_var.nonstd
op_assign
l_int|0
suffix:semicolon
id|init_var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|init_var.height
op_assign
op_minus
l_int|1
suffix:semicolon
id|init_var.width
op_assign
op_minus
l_int|1
suffix:semicolon
id|init_var.vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
id|current_par.dram_size
op_assign
l_int|0
suffix:semicolon
id|current_par.montype
op_assign
op_minus
l_int|1
suffix:semicolon
id|current_par.dpms
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * setup acornfb options:&n; *&n; *  font:fontname&n; *&t;Set fontname&n; *&n; *  mon:hmin-hmax:vmin-vmax:dpms:width:height&n; *&t;Set monitor parameters:&n; *&t;&t;hmin   = horizontal minimum frequency (Hz)&n; *&t;&t;hmax   = horizontal maximum frequency (Hz)&t;(optional)&n; *&t;&t;vmin   = vertical minimum frequency (Hz)&n; *&t;&t;vmax   = vertical maximum frequency (Hz)&t;(optional)&n; *&t;&t;dpms   = DPMS supported?&t;&t;&t;(optional)&n; *&t;&t;width  = width of picture in mm.&t;&t;(optional)&n; *&t;&t;height = height of picture in mm.&t;&t;(optional)&n; *&n; * montype:type&n; *&t;Set RISC-OS style monitor type:&n; *&t;&t;0 (or tv)&t;- TV frequency&n; *&t;&t;1 (or multi)&t;- Multi frequency&n; *&t;&t;2 (or hires)&t;- Hi-res monochrome&n; *&t;&t;3 (or vga)&t;- VGA&n; *&t;&t;4 (or svga)&t;- SVGA&n; *&t;&t;auto, or option missing&n; *&t;&t;&t;&t;- try hardware detect&n; *&n; * dram:size&n; *&t;Set the amount of DRAM to use for the frame buffer&n; *&t;(even if you have VRAM).&n; *&t;size can optionally be followed by &squot;M&squot; or &squot;K&squot; for&n; *&t;MB or KB respectively.&n; */
r_static
r_void
id|__init
DECL|function|acornfb_parse_font
id|acornfb_parse_font
c_func
(paren
r_char
op_star
id|opt
)paren
(brace
id|strcpy
c_func
(paren
id|fb_info.fontname
comma
id|opt
)paren
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|acornfb_parse_mon
id|acornfb_parse_mon
c_func
(paren
r_char
op_star
id|opt
)paren
(brace
id|fb_info.monspecs.hfmin
op_assign
id|simple_strtoul
c_func
(paren
id|opt
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|opt
op_eq
l_char|&squot;-&squot;
)paren
id|fb_info.monspecs.hfmax
op_assign
id|simple_strtoul
c_func
(paren
id|opt
op_plus
l_int|1
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_else
id|fb_info.monspecs.hfmax
op_assign
id|fb_info.monspecs.hfmin
suffix:semicolon
r_if
c_cond
(paren
op_star
id|opt
op_ne
l_char|&squot;:&squot;
)paren
r_return
suffix:semicolon
id|fb_info.monspecs.vfmin
op_assign
id|simple_strtoul
c_func
(paren
id|opt
op_plus
l_int|1
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|opt
op_eq
l_char|&squot;-&squot;
)paren
id|fb_info.monspecs.vfmax
op_assign
id|simple_strtoul
c_func
(paren
id|opt
op_plus
l_int|1
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_else
id|fb_info.monspecs.vfmax
op_assign
id|fb_info.monspecs.vfmin
suffix:semicolon
r_if
c_cond
(paren
op_star
id|opt
op_ne
l_char|&squot;:&squot;
)paren
r_return
suffix:semicolon
id|fb_info.monspecs.dpms
op_assign
id|simple_strtoul
c_func
(paren
id|opt
op_plus
l_int|1
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|opt
op_ne
l_char|&squot;:&squot;
)paren
r_return
suffix:semicolon
id|init_var.width
op_assign
id|simple_strtoul
c_func
(paren
id|opt
op_plus
l_int|1
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|opt
op_ne
l_char|&squot;:&squot;
)paren
r_return
suffix:semicolon
id|init_var.height
op_assign
id|simple_strtoul
c_func
(paren
id|opt
op_plus
l_int|1
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|acornfb_parse_montype
id|acornfb_parse_montype
c_func
(paren
r_char
op_star
id|opt
)paren
(brace
id|current_par.montype
op_assign
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;tv&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|2
suffix:semicolon
id|current_par.montype
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;multi&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|5
suffix:semicolon
id|current_par.montype
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;hires&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|5
suffix:semicolon
id|current_par.montype
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;vga&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|3
suffix:semicolon
id|current_par.montype
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;svga&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|4
suffix:semicolon
id|current_par.montype
op_assign
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
l_string|&quot;auto&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|opt
op_add_assign
l_int|4
suffix:semicolon
id|current_par.montype
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|isdigit
c_func
(paren
op_star
id|opt
)paren
)paren
id|current_par.montype
op_assign
id|simple_strtoul
c_func
(paren
id|opt
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.montype
op_eq
op_minus
l_int|2
op_logical_or
id|current_par.montype
OG
id|NR_MONTYPES
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;acornfb: unknown monitor type: %s&bslash;n&quot;
comma
id|opt
)paren
suffix:semicolon
id|current_par.montype
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|opt
op_logical_and
op_star
id|opt
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|opt
comma
l_string|&quot;,dpms&quot;
)paren
op_eq
l_int|0
)paren
id|current_par.dpms
op_assign
l_int|1
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;acornfb: unknown monitor option: %s&bslash;n&quot;
comma
id|opt
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|__init
DECL|function|acornfb_parse_dram
id|acornfb_parse_dram
c_func
(paren
r_char
op_star
id|opt
)paren
(brace
r_int
r_int
id|size
suffix:semicolon
id|size
op_assign
id|simple_strtoul
c_func
(paren
id|opt
comma
op_amp
id|opt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
)paren
(brace
r_switch
c_cond
(paren
op_star
id|opt
)paren
(brace
r_case
l_char|&squot;M&squot;
suffix:colon
r_case
l_char|&squot;m&squot;
suffix:colon
id|size
op_mul_assign
l_int|1024
suffix:semicolon
r_case
l_char|&squot;K&squot;
suffix:colon
r_case
l_char|&squot;k&squot;
suffix:colon
id|size
op_mul_assign
l_int|1024
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
id|current_par.dram_size
op_assign
id|size
suffix:semicolon
)brace
DECL|struct|options
r_static
r_struct
id|options
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|parse
r_void
(paren
op_star
id|parse
)paren
(paren
r_char
op_star
id|opt
)paren
suffix:semicolon
DECL|variable|__initdata
)brace
id|opt_table
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_string|&quot;font&quot;
comma
id|acornfb_parse_font
)brace
comma
(brace
l_string|&quot;mon&quot;
comma
id|acornfb_parse_mon
)brace
comma
(brace
l_string|&quot;montype&quot;
comma
id|acornfb_parse_montype
)brace
comma
(brace
l_string|&quot;dram&quot;
comma
id|acornfb_parse_dram
)brace
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
r_void
id|__init
DECL|function|acornfb_setup
id|acornfb_setup
c_func
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
(brace
r_struct
id|options
op_star
id|optp
suffix:semicolon
r_char
op_star
id|opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
suffix:semicolon
id|acornfb_init_fbinfo
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|opt
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|opt
suffix:semicolon
id|opt
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|opt
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|optp
op_assign
id|opt_table
suffix:semicolon
id|optp-&gt;name
suffix:semicolon
id|optp
op_increment
)paren
(brace
r_int
id|optlen
suffix:semicolon
id|optlen
op_assign
id|strlen
c_func
(paren
id|optp-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
id|optp-&gt;name
comma
id|optlen
)paren
op_eq
l_int|0
op_logical_and
id|opt
(braket
id|optlen
)braket
op_eq
l_char|&squot;:&squot;
)paren
(brace
id|optp
op_member_access_from_pointer
id|parse
c_func
(paren
id|opt
op_plus
id|optlen
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|optp-&gt;name
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;acornfb: unknown parameter: %s&bslash;n&quot;
comma
id|opt
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Detect type of monitor connected&n; *  For now, we just assume SVGA&n; */
r_static
r_int
id|__init
DECL|function|acornfb_detect_monitortype
id|acornfb_detect_monitortype
c_func
(paren
r_void
)paren
(brace
r_return
l_int|4
suffix:semicolon
)brace
multiline_comment|/*&n; * This enables the unused memory to be freed on older Acorn machines.&n; */
r_static
r_inline
r_void
DECL|function|free_unused_pages
id|free_unused_pages
c_func
(paren
r_int
r_int
id|virtual_start
comma
r_int
r_int
id|virtual_end
)paren
(brace
r_int
id|mb_freed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Align addresses&n;&t; */
id|virtual_start
op_assign
id|PAGE_ALIGN
c_func
(paren
id|virtual_start
)paren
suffix:semicolon
id|virtual_end
op_assign
id|PAGE_ALIGN
c_func
(paren
id|virtual_end
)paren
suffix:semicolon
r_while
c_loop
(paren
id|virtual_start
OL
id|virtual_end
)paren
(brace
multiline_comment|/*&n;&t;&t; * Clear page reserved bit,&n;&t;&t; * set count to 1, and free&n;&t;&t; * the page.&n;&t;&t; */
id|clear_bit
c_func
(paren
id|PG_reserved
comma
op_amp
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|virtual_start
)paren
)braket
dot
id|flags
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|mem_map
(braket
id|MAP_NR
c_func
(paren
id|virtual_start
)paren
)braket
dot
id|count
comma
l_int|1
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|virtual_start
)paren
suffix:semicolon
id|virtual_start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|mb_freed
op_add_assign
id|PAGE_SIZE
op_div
l_int|1024
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;acornfb: freed %dK memory&bslash;n&quot;
comma
id|mb_freed
)paren
suffix:semicolon
)brace
r_void
id|__init
DECL|function|acornfb_init
id|acornfb_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|size
suffix:semicolon
id|u_int
id|h_sync
comma
id|v_sync
suffix:semicolon
id|acornfb_init_fbinfo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.montype
op_eq
op_minus
l_int|1
)paren
id|current_par.montype
op_assign
id|acornfb_detect_monitortype
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.montype
template_param
id|NR_MONTYPES
)paren
id|current_par.montype
op_assign
l_int|4
suffix:semicolon
id|fb_info.monspecs
op_assign
id|monspecs
(braket
id|current_par.montype
)braket
suffix:semicolon
id|fb_info.monspecs.dpms
op_assign
id|current_par.dpms
suffix:semicolon
id|current_par.currcon
op_assign
op_minus
l_int|1
suffix:semicolon
id|current_par.screen_base
op_assign
id|SCREEN2_BASE
suffix:semicolon
id|current_par.screen_base_p
op_assign
id|SCREEN_START
suffix:semicolon
id|current_par.using_vram
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If vram_size is set, we are using VRAM in&n;&t; * a Risc PC.  However, if the user has specified&n;&t; * an amount of DRAM then use that instead.&n;&t; */
r_if
c_cond
(paren
id|vram_size
op_logical_and
op_logical_neg
id|current_par.dram_size
)paren
(brace
id|size
op_assign
id|vram_size
suffix:semicolon
id|current_par.vram_half_sam
op_assign
id|vram_size
op_div
l_int|1024
suffix:semicolon
id|current_par.using_vram
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|current_par.dram_size
)paren
id|size
op_assign
id|current_par.dram_size
suffix:semicolon
r_else
id|size
op_assign
(paren
id|init_var.xres
op_star
id|init_var.yres
op_star
id|init_var.bits_per_pixel
)paren
op_div
l_int|8
suffix:semicolon
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|size
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_RPC
r_if
c_cond
(paren
op_logical_neg
id|current_par.using_vram
)paren
(brace
multiline_comment|/*&n;&t;&t; * RiscPC needs to allocate the DRAM memory&n;&t;&t; * for the framebuffer if we are not using&n;&t;&t; * VRAM.  Archimedes/A5000 machines use a&n;&t;&t; * fixed address for their framebuffers.&n;&t;&t; */
id|current_par.screen_base
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.screen_base
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;acornfb: unable to allocate screen &quot;
l_string|&quot;memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|current_par.screen_base_p
op_assign
id|virt_to_phys
c_func
(paren
id|current_par.screen_base
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_ARCH_A5K) || defined(CONFIG_ARCH_ARC)
DECL|macro|MAX_SIZE
mdefine_line|#define MAX_SIZE&t;480*1024
multiline_comment|/*&n;&t; * Limit maximum screen size.&n;&t; */
r_if
c_cond
(paren
id|size
OG
id|MAX_SIZE
)paren
id|size
op_assign
id|MAX_SIZE
suffix:semicolon
multiline_comment|/*&n;&t; * Free unused pages&n;&t; */
id|free_unused_pages
c_func
(paren
id|PAGE_OFFSET
op_plus
id|size
comma
id|PAGE_OFFSET
op_plus
id|MAX_SIZE
)paren
suffix:semicolon
macro_line|#endif
id|current_par.screen_size
op_assign
id|size
suffix:semicolon
id|current_par.palette_size
op_assign
id|VIDC_PALETTE_SIZE
suffix:semicolon
id|current_par.allow_modeset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Lookup the timing for this resolution.  If we can&squot;t&n;&t; * find it, then we can&squot;t restore it if we change&n;&t; * the resolution, so we disable this feature.&n;&t; */
r_if
c_cond
(paren
id|acornfb_lookup_timing
c_func
(paren
op_amp
id|init_var
)paren
)paren
id|current_par.allow_modeset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Again, if this does not succeed, then we disallow&n;&t; * changes to the resolution parameters.&n;&t; */
r_if
c_cond
(paren
id|acornfb_set_var
c_func
(paren
op_amp
id|init_var
comma
op_minus
l_int|1
comma
op_amp
id|fb_info
)paren
)paren
id|current_par.allow_modeset
op_assign
l_int|0
suffix:semicolon
id|h_sync
op_assign
l_int|1953125000
op_div
id|init_var.pixclock
suffix:semicolon
id|h_sync
op_assign
id|h_sync
op_star
l_int|512
op_div
(paren
id|init_var.xres
op_plus
id|init_var.left_margin
op_plus
id|init_var.right_margin
op_plus
id|init_var.hsync_len
)paren
suffix:semicolon
id|v_sync
op_assign
id|h_sync
op_div
(paren
id|init_var.yres
op_plus
id|init_var.upper_margin
op_plus
id|init_var.lower_margin
op_plus
id|init_var.vsync_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Acornfb: %ldkB %cRAM, %s, using %dx%d, %d.%03dkHz, %dHz&bslash;n&quot;
comma
id|current_par.screen_size
op_div
l_int|1024
comma
id|current_par.using_vram
ques
c_cond
l_char|&squot;V&squot;
suffix:colon
l_char|&squot;D&squot;
comma
id|VIDC_NAME
comma
id|init_var.xres
comma
id|init_var.yres
comma
id|h_sync
op_div
l_int|1000
comma
id|h_sync
op_mod
l_int|1000
comma
id|v_sync
)paren
suffix:semicolon
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
suffix:semicolon
)brace
eof
