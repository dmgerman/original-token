multiline_comment|/* macfb.c: Generic framebuffer for Macs whose colourmaps/modes we&n;   don&squot;t know how to set */
multiline_comment|/* (c) 1999 David Huggins-Daines &lt;dhd@debian.org&gt;&n;&n;   Primarily based on vesafb.c, by Gerd Knorr&n;   (c) 1998 Gerd Knorr &lt;kraxel@cs.tu-berlin.de&gt;&n;&n;   Also uses information and code from:&n;   &n;   The original macfb.c from Linux/mac68k 2.0, by Alan Cox, Juergen&n;   Mellinger, Mikael Forselius, Michael Schmitz, and others.&n;&n;   valkyriefb.c, by Martin Costabel, Kevin Schoedel, Barry Nathan, Dan&n;   Jacobowitz, Paul Mackerras, Fabio Riccardi, and Geert Uytterhoeven.&n;   &n;   This code is free software.  You may copy, modify, and distribute&n;   it subject to the terms and conditions of the GNU General Public&n;   License, version 2, or any later version, at your convenience. */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/nubus.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/macintosh.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/machw.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-mfb.h&gt;
macro_line|#include &lt;video/fbcon-cfb2.h&gt;
macro_line|#include &lt;video/fbcon-cfb4.h&gt;
macro_line|#include &lt;video/fbcon-cfb8.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
macro_line|#include &lt;video/fbcon-cfb24.h&gt;
macro_line|#include &lt;video/fbcon-cfb32.h&gt;
macro_line|#if defined(FBCON_HAS_CFB8) || defined(FBCON_HAS_CFB4) || defined(FBCON_HAS_CFB2)
multiline_comment|/* Common DAC base address for the LC, RBV, Valkyrie, and IIvx */
DECL|macro|DAC_BASE
mdefine_line|#define DAC_BASE 0x50f24000
multiline_comment|/* Some addresses for the DAFB */
DECL|macro|DAFB_BASE
mdefine_line|#define DAFB_BASE 0xf9800200
multiline_comment|/* Address for the built-in Civic framebuffer in Quadra AVs */
DECL|macro|CIVIC_BASE
mdefine_line|#define CIVIC_BASE 0x50f30800&t;/* Only tested on 660AV! */
multiline_comment|/* GSC (Gray Scale Controller) base address */
DECL|macro|GSC_BASE
mdefine_line|#define GSC_BASE 0x50F20000
multiline_comment|/* CSC (Color Screen Controller) base address */
DECL|macro|CSC_BASE
mdefine_line|#define CSC_BASE 0x50F20000
DECL|variable|macfb_setpalette
r_static
r_int
(paren
op_star
id|macfb_setpalette
)paren
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|valkyrie_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
suffix:semicolon
r_static
r_int
id|dafb_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
suffix:semicolon
r_static
r_int
id|rbv_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
suffix:semicolon
r_static
r_int
id|mdc_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
suffix:semicolon
r_static
r_int
id|toby_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
suffix:semicolon
r_static
r_int
id|civic_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
suffix:semicolon
r_static
r_int
id|csc_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
suffix:semicolon
r_static
r_volatile
r_struct
(brace
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
multiline_comment|/* Note: word-aligned */
DECL|member|pad
r_char
id|pad
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
DECL|variable|valkyrie_cmap_regs
)brace
op_star
id|valkyrie_cmap_regs
suffix:semicolon
r_static
r_volatile
r_struct
(brace
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
DECL|variable|v8_brazil_cmap_regs
)brace
op_star
id|v8_brazil_cmap_regs
suffix:semicolon
r_static
r_volatile
r_struct
(brace
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
DECL|member|pad1
r_char
id|pad1
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* word aligned */
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
DECL|member|pad2
r_char
id|pad2
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* word aligned */
DECL|member|cntl
r_int
r_char
id|cntl
suffix:semicolon
multiline_comment|/* a guess as to purpose */
DECL|variable|rbv_cmap_regs
)brace
op_star
id|rbv_cmap_regs
suffix:semicolon
r_static
r_volatile
r_struct
(brace
DECL|member|reset
r_int
r_int
id|reset
suffix:semicolon
DECL|member|pad1
r_int
r_int
id|pad1
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|pad2
r_int
r_char
id|pad2
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
DECL|variable|dafb_cmap_regs
)brace
op_star
id|dafb_cmap_regs
suffix:semicolon
r_static
r_volatile
r_struct
(brace
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
multiline_comment|/* OFFSET: 0x00 */
DECL|member|pad1
r_int
r_char
id|pad1
(braket
l_int|15
)braket
suffix:semicolon
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
multiline_comment|/* OFFSET: 0x10 */
DECL|member|pad2
r_int
r_char
id|pad2
(braket
l_int|15
)braket
suffix:semicolon
DECL|member|status
r_int
r_char
id|status
suffix:semicolon
multiline_comment|/* OFFSET: 0x20 */
DECL|member|pad3
r_int
r_char
id|pad3
(braket
l_int|7
)braket
suffix:semicolon
DECL|member|vbl_addr
r_int
r_int
id|vbl_addr
suffix:semicolon
multiline_comment|/* OFFSET: 0x28 */
DECL|member|status2
r_int
r_int
id|status2
suffix:semicolon
multiline_comment|/* OFFSET: 0x2C */
DECL|variable|civic_cmap_regs
)brace
op_star
id|civic_cmap_regs
suffix:semicolon
r_static
r_volatile
r_struct
(brace
DECL|member|pad1
r_char
id|pad1
(braket
l_int|0x40
)braket
suffix:semicolon
DECL|member|clut_waddr
r_int
r_char
id|clut_waddr
suffix:semicolon
multiline_comment|/* 0x40 */
DECL|member|pad2
r_char
id|pad2
suffix:semicolon
DECL|member|clut_data
r_int
r_char
id|clut_data
suffix:semicolon
multiline_comment|/* 0x42 */
DECL|member|pad3
r_char
id|pad3
(braket
l_int|0x3
)braket
suffix:semicolon
DECL|member|clut_raddr
r_int
r_char
id|clut_raddr
suffix:semicolon
multiline_comment|/* 0x46 */
DECL|variable|csc_cmap_regs
)brace
op_star
id|csc_cmap_regs
suffix:semicolon
multiline_comment|/* We will leave these the way they are for the time being */
DECL|struct|mdc_cmap_regs
r_struct
id|mdc_cmap_regs
(brace
DECL|member|pad1
r_char
id|pad1
(braket
l_int|0x200200
)braket
suffix:semicolon
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
DECL|member|pad2
r_char
id|pad2
(braket
l_int|6
)braket
suffix:semicolon
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|toby_cmap_regs
r_struct
id|toby_cmap_regs
(brace
DECL|member|pad1
r_char
id|pad1
(braket
l_int|0x90018
)braket
suffix:semicolon
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
multiline_comment|/* TFBClutWDataReg, offset 0x90018 */
DECL|member|pad2
r_char
id|pad2
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
multiline_comment|/* TFBClutAddrReg, offset 0x9001C */
)brace
suffix:semicolon
DECL|struct|jet_cmap_regs
r_struct
id|jet_cmap_regs
(brace
DECL|member|pad1
r_char
id|pad1
(braket
l_int|0xe0e000
)braket
suffix:semicolon
DECL|member|addr
r_int
r_char
id|addr
suffix:semicolon
DECL|member|lut
r_int
r_char
id|lut
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
DECL|macro|PIXEL_TO_MM
mdefine_line|#define PIXEL_TO_MM(a)&t;(((a)*10)/28)&t;/* width in mm at 72 dpi */&t;
DECL|variable|video_base
r_static
r_char
op_star
id|video_base
suffix:semicolon
DECL|variable|video_size
r_static
r_int
id|video_size
suffix:semicolon
DECL|variable|video_vbase
r_static
r_char
op_star
id|video_vbase
suffix:semicolon
multiline_comment|/* mapped */
multiline_comment|/* mode */
DECL|variable|video_bpp
r_static
r_int
id|video_bpp
suffix:semicolon
DECL|variable|video_width
r_static
r_int
id|video_width
suffix:semicolon
DECL|variable|video_height
r_static
r_int
id|video_height
suffix:semicolon
DECL|variable|video_type
r_static
r_int
id|video_type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
DECL|variable|video_visual
r_static
r_int
id|video_visual
suffix:semicolon
DECL|variable|video_linelength
r_static
r_int
id|video_linelength
suffix:semicolon
DECL|variable|video_cmap_len
r_static
r_int
id|video_cmap_len
suffix:semicolon
DECL|variable|video_slot
r_static
r_int
id|video_slot
op_assign
l_int|0
suffix:semicolon
DECL|variable|macfb_defined
r_static
r_struct
id|fb_var_screeninfo
id|macfb_defined
op_assign
initialization_block
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|member|blue
DECL|member|green
DECL|member|red
DECL|member|pad
DECL|variable|palette
r_static
r_struct
(brace
id|u_short
id|blue
comma
id|green
comma
id|red
comma
id|pad
suffix:semicolon
)brace
id|palette
(braket
l_int|256
)braket
suffix:semicolon
r_static
r_union
(brace
macro_line|#ifdef FBCON_HAS_CFB16
DECL|member|cfb16
id|u16
id|cfb16
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB24
DECL|member|cfb24
id|u32
id|cfb24
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
DECL|member|cfb32
id|u32
id|cfb32
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
DECL|variable|fbcon_cmap
)brace
id|fbcon_cmap
suffix:semicolon
DECL|variable|inverse
r_static
r_int
id|inverse
op_assign
l_int|0
suffix:semicolon
DECL|variable|vidtest
r_static
r_int
id|vidtest
op_assign
l_int|0
suffix:semicolon
DECL|variable|currcon
r_static
r_int
id|currcon
op_assign
l_int|0
suffix:semicolon
DECL|function|macfb_update_var
r_static
r_int
id|macfb_update_var
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macfb_get_fix
r_static
r_int
id|macfb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|memset
c_func
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_fix_screeninfo
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
l_string|&quot;Mac Generic&quot;
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
id|video_base
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|video_size
suffix:semicolon
id|fix-&gt;type
op_assign
id|video_type
suffix:semicolon
id|fix-&gt;visual
op_assign
id|video_visual
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;line_length
op_assign
id|video_linelength
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macfb_get_var
r_static
r_int
id|macfb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
(brace
id|memcpy
c_func
(paren
id|var
comma
op_amp
id|macfb_defined
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
)brace
r_else
op_star
id|var
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macfb_set_disp
r_static
r_void
id|macfb_set_disp
c_func
(paren
r_int
id|con
)paren
(brace
r_struct
id|fb_fix_screeninfo
id|fix
suffix:semicolon
r_struct
id|display
op_star
id|display
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
id|display
op_assign
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
r_else
id|display
op_assign
op_amp
id|disp
suffix:semicolon
multiline_comment|/* used during initialization */
id|macfb_get_fix
c_func
(paren
op_amp
id|fix
comma
id|con
comma
op_amp
id|fb_info
)paren
suffix:semicolon
id|memset
c_func
(paren
id|display
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|display
)paren
)paren
suffix:semicolon
id|display-&gt;screen_base
op_assign
id|video_vbase
suffix:semicolon
id|display-&gt;visual
op_assign
id|fix.visual
suffix:semicolon
id|display-&gt;type
op_assign
id|fix.type
suffix:semicolon
id|display-&gt;type_aux
op_assign
id|fix.type_aux
suffix:semicolon
id|display-&gt;ypanstep
op_assign
id|fix.ypanstep
suffix:semicolon
id|display-&gt;ywrapstep
op_assign
id|fix.ywrapstep
suffix:semicolon
id|display-&gt;line_length
op_assign
id|fix.line_length
suffix:semicolon
id|display-&gt;next_line
op_assign
id|fix.line_length
suffix:semicolon
id|display-&gt;can_soft_blank
op_assign
l_int|0
suffix:semicolon
id|display-&gt;inverse
op_assign
id|inverse
suffix:semicolon
id|display-&gt;scrollmode
op_assign
id|SCROLL_YREDRAW
suffix:semicolon
id|macfb_get_var
c_func
(paren
op_amp
id|display-&gt;var
comma
op_minus
l_int|1
comma
op_amp
id|fb_info
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|video_bpp
)paren
(brace
macro_line|#ifdef FBCON_HAS_MFB
r_case
l_int|1
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_mfb
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB2
r_case
l_int|2
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb2
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB4
r_case
l_int|4
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|15
suffix:colon
r_case
l_int|16
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|fbcon_cmap.cfb16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB24
r_case
l_int|24
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb24
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|fbcon_cmap.cfb24
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|32
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb32
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|fbcon_cmap.cfb32
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
DECL|function|macfb_set_var
r_static
r_int
id|macfb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_static
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres
op_ne
id|macfb_defined.xres
op_logical_or
id|var-&gt;yres
op_ne
id|macfb_defined.yres
op_logical_or
id|var-&gt;xres_virtual
op_ne
id|macfb_defined.xres_virtual
op_logical_or
id|var-&gt;yres_virtual
op_ne
id|macfb_defined.yres
op_logical_or
id|var-&gt;xoffset
op_logical_or
id|var-&gt;bits_per_pixel
op_ne
id|macfb_defined.bits_per_pixel
op_logical_or
id|var-&gt;nonstd
)paren
(brace
r_if
c_cond
(paren
id|first
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;macfb does not support changing the video mode&bslash;n&quot;
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_TEST
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(FBCON_HAS_CFB8) || defined(FBCON_HAS_CFB4) || defined(FBCON_HAS_CFB2)
DECL|function|valkyrie_setpalette
r_static
r_int
id|valkyrie_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* tell clut which address to fill */
id|writeb
c_func
(paren
id|regno
comma
op_amp
id|valkyrie_cmap_regs-&gt;addr
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* send one color channel at a time */
id|writeb
c_func
(paren
id|red
comma
op_amp
id|valkyrie_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|green
comma
op_amp
id|valkyrie_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|blue
comma
op_amp
id|valkyrie_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Unlike the Valkyrie, the DAFB cannot set individual colormap&n;   registers.  Therefore, we do what the MacOS driver does (no&n;   kidding!) and simply set them one by one until we hit the one we&n;   want. */
DECL|function|dafb_setpalette
r_static
r_int
id|dafb_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
(brace
multiline_comment|/* FIXME: really, really need to use ioremap() here,&n;           phys_to_virt() doesn&squot;t work anymore */
r_static
r_int
id|lastreg
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* fbcon will set an entire colourmap, but X won&squot;t.  Hopefully&n;&t;   this should accomodate both of them */
r_if
c_cond
(paren
id|regno
op_ne
id|lastreg
op_plus
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Stab in the dark trying to reset the CLUT pointer */
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|dafb_cmap_regs-&gt;reset
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Loop until we get to the register we want */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|regno
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeb
c_func
(paren
id|palette
(braket
id|i
)braket
dot
id|red
op_rshift
l_int|8
comma
op_amp
id|dafb_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|palette
(braket
id|i
)braket
dot
id|green
op_rshift
l_int|8
comma
op_amp
id|dafb_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|palette
(braket
id|i
)braket
dot
id|blue
op_rshift
l_int|8
comma
op_amp
id|dafb_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|writeb
c_func
(paren
id|red
comma
op_amp
id|dafb_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|green
comma
op_amp
id|dafb_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|blue
comma
op_amp
id|dafb_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lastreg
op_assign
id|regno
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* V8 and Brazil seem to use the same DAC.  Sonora does as well. */
DECL|function|v8_brazil_setpalette
r_static
r_int
id|v8_brazil_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
(brace
r_int
r_char
id|_red
op_assign
id|red
op_rshift
l_int|8
suffix:semicolon
r_int
r_char
id|_green
op_assign
id|green
op_rshift
l_int|8
suffix:semicolon
r_int
r_char
id|_blue
op_assign
id|blue
op_rshift
l_int|8
suffix:semicolon
r_int
r_char
id|_regno
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|video_bpp
OG
l_int|8
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* failsafe */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* On these chips, the CLUT register numbers are spread out&n;&t;   across the register space.  Thus:&n;&n;&t;   In 8bpp, all regnos are valid.&n;&t;   &n;&t;   In 4bpp, the regnos are 0x0f, 0x1f, 0x2f, etc, etc&n;&t;   &n;&t;   In 2bpp, the regnos are 0x3f, 0x7f, 0xbf, 0xff */
id|_regno
op_assign
(paren
id|regno
op_lshift
(paren
l_int|8
op_minus
id|video_bpp
)paren
)paren
op_or
(paren
l_int|0xFF
op_rshift
id|video_bpp
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_regno
comma
op_amp
id|v8_brazil_cmap_regs-&gt;addr
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* send one color channel at a time */
id|writeb
c_func
(paren
id|_red
comma
op_amp
id|v8_brazil_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_green
comma
op_amp
id|v8_brazil_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_blue
comma
op_amp
id|v8_brazil_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rbv_setpalette
r_static
r_int
id|rbv_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
(brace
multiline_comment|/* use MSBs */
r_int
r_char
id|_red
op_assign
id|red
op_rshift
l_int|8
suffix:semicolon
r_int
r_char
id|_green
op_assign
id|green
op_rshift
l_int|8
suffix:semicolon
r_int
r_char
id|_blue
op_assign
id|blue
op_rshift
l_int|8
suffix:semicolon
r_int
r_char
id|_regno
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|video_bpp
OG
l_int|8
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* failsafe */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* From the VideoToolbox driver.  Seems to be saying that&n;&t; * regno #254 and #255 are the important ones for 1-bit color,&n;&t; * regno #252-255 are the important ones for 2-bit color, etc.&n;&t; */
id|_regno
op_assign
id|regno
op_plus
(paren
l_int|256
op_minus
(paren
l_int|1
op_lshift
id|video_bpp
)paren
)paren
suffix:semicolon
multiline_comment|/* reset clut? (VideoToolbox sez &quot;not necessary&quot;) */
id|writeb
c_func
(paren
l_int|0xFF
comma
op_amp
id|rbv_cmap_regs-&gt;cntl
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* tell clut which address to use. */
id|writeb
c_func
(paren
id|_regno
comma
op_amp
id|rbv_cmap_regs-&gt;addr
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* send one color channel at a time. */
id|writeb
c_func
(paren
id|_red
comma
op_amp
id|rbv_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_green
comma
op_amp
id|rbv_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_blue
comma
op_amp
id|rbv_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* done. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Macintosh Display Card (8x24) */
DECL|function|mdc_setpalette
r_static
r_int
id|mdc_setpalette
c_func
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
(brace
r_volatile
r_struct
id|mdc_cmap_regs
op_star
id|cmap_regs
op_assign
id|nubus_slot_addr
c_func
(paren
id|video_slot
)paren
suffix:semicolon
multiline_comment|/* use MSBs */
r_int
r_char
id|_red
op_assign
id|red
op_rshift
l_int|8
suffix:semicolon
r_int
r_char
id|_green
op_assign
id|green
op_rshift
l_int|8
suffix:semicolon
r_int
r_char
id|_blue
op_assign
id|blue
op_rshift
l_int|8
suffix:semicolon
r_int
r_char
id|_regno
op_assign
id|regno
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* the nop&squot;s are there to order writes. */
id|writeb
c_func
(paren
id|_regno
comma
op_amp
id|cmap_regs-&gt;addr
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_red
comma
op_amp
id|cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_green
comma
op_amp
id|cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_blue
comma
op_amp
id|cmap_regs-&gt;lut
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Toby frame buffer */
DECL|function|toby_setpalette
r_static
r_int
id|toby_setpalette
c_func
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
(brace
r_volatile
r_struct
id|toby_cmap_regs
op_star
id|cmap_regs
op_assign
id|nubus_slot_addr
c_func
(paren
id|video_slot
)paren
suffix:semicolon
multiline_comment|/* use MSBs */
r_int
r_char
id|_red
op_assign
op_complement
(paren
id|red
op_rshift
l_int|8
)paren
suffix:semicolon
r_int
r_char
id|_green
op_assign
op_complement
(paren
id|green
op_rshift
l_int|8
)paren
suffix:semicolon
r_int
r_char
id|_blue
op_assign
op_complement
(paren
id|blue
op_rshift
l_int|8
)paren
suffix:semicolon
r_int
r_char
id|_regno
op_assign
(paren
id|regno
op_lshift
(paren
l_int|8
op_minus
id|video_bpp
)paren
)paren
op_or
(paren
l_int|0xFF
op_rshift
id|video_bpp
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_regno
comma
op_amp
id|cmap_regs-&gt;addr
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_red
comma
op_amp
id|cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_green
comma
op_amp
id|cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_blue
comma
op_amp
id|cmap_regs-&gt;lut
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Jet frame buffer */
DECL|function|jet_setpalette
r_static
r_int
id|jet_setpalette
c_func
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
(brace
r_volatile
r_struct
id|jet_cmap_regs
op_star
id|cmap_regs
op_assign
id|nubus_slot_addr
c_func
(paren
id|video_slot
)paren
suffix:semicolon
multiline_comment|/* use MSBs */
r_int
r_char
id|_red
op_assign
(paren
id|red
op_rshift
l_int|8
)paren
suffix:semicolon
r_int
r_char
id|_green
op_assign
(paren
id|green
op_rshift
l_int|8
)paren
suffix:semicolon
r_int
r_char
id|_blue
op_assign
(paren
id|blue
op_rshift
l_int|8
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|regno
comma
op_amp
id|cmap_regs-&gt;addr
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_red
comma
op_amp
id|cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_green
comma
op_amp
id|cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|_blue
comma
op_amp
id|cmap_regs-&gt;lut
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Civic framebuffer -- Quadra AV built-in video.  A chip&n; * called Sebastian holds the actual color palettes, and&n; * apparently, there are two different banks of 512K RAM &n; * which can act as separate framebuffers for doing video&n; * input and viewing the screen at the same time!  The 840AV&n; * Can add another 1MB RAM to give the two framebuffers &n; * 1MB RAM apiece.&n; *&n; * FIXME: this doesn&squot;t seem to work anymore.&n; */
DECL|function|civic_setpalette
r_static
r_int
id|civic_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
(brace
r_static
r_int
id|lastreg
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|clut_status
suffix:semicolon
r_if
c_cond
(paren
id|video_bpp
OG
l_int|8
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* failsafe */
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the register address&n;&t; */
id|writeb
c_func
(paren
id|regno
comma
op_amp
id|civic_cmap_regs-&gt;addr
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for VBL interrupt here;&n;&t; * They&squot;re usually not enabled from Penguin, so we won&squot;t check&n;&t; */
macro_line|#if 0
(brace
mdefine_line|#define CIVIC_VBL_OFFSET&t;0x120
r_volatile
r_int
r_int
op_star
id|vbl
op_assign
id|readl
c_func
(paren
id|civic_cmap_regs-&gt;vbl_addr
op_plus
id|CIVIC_VBL_OFFSET
)paren
suffix:semicolon
multiline_comment|/* do interrupt setup stuff here? */
op_star
id|vbl
op_assign
l_int|0L
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* clear */
op_star
id|vbl
op_assign
l_int|1L
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* set */
r_while
c_loop
(paren
op_star
id|vbl
op_ne
l_int|0L
)paren
multiline_comment|/* wait for next vbl */
(brace
id|usleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* needed? */
)brace
multiline_comment|/* do interrupt shutdown stuff here? */
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Grab a status word and do some checking;&n;&t; * Then finally write the clut!&n;&t; */
id|clut_status
op_assign
id|readb
c_func
(paren
op_amp
id|civic_cmap_regs-&gt;status2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|clut_status
op_amp
l_int|0x0008
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|clut_status
op_amp
l_int|0x000D
)paren
op_ne
l_int|0
)paren
(brace
id|writeb
c_func
(paren
l_int|0x00
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|writeb
c_func
(paren
id|red
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|green
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|blue
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
id|junk
suffix:semicolon
id|junk
op_assign
id|readb
c_func
(paren
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|junk
op_assign
id|readb
c_func
(paren
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|junk
op_assign
id|readb
c_func
(paren
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|junk
op_assign
id|readb
c_func
(paren
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|clut_status
op_amp
l_int|0x000D
)paren
op_ne
l_int|0
)paren
(brace
id|writeb
c_func
(paren
l_int|0x00
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x00
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|red
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|green
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|blue
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|junk
comma
op_amp
id|civic_cmap_regs-&gt;lut
)paren
suffix:semicolon
id|nop
c_func
(paren
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|lastreg
op_assign
id|regno
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The CSC is the framebuffer on the PowerBook 190 series&n; * (and the 5300 too, but that&squot;s a PowerMac). This function&n; * brought to you in part by the ECSC driver for MkLinux.&n; */
DECL|function|csc_setpalette
r_static
r_int
id|csc_setpalette
(paren
r_int
r_int
id|regno
comma
r_int
r_int
id|red
comma
r_int
r_int
id|green
comma
r_int
r_int
id|blue
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|csc_cmap_regs-&gt;clut_waddr
op_assign
id|regno
suffix:semicolon
id|csc_cmap_regs-&gt;clut_data
op_assign
id|red
suffix:semicolon
id|csc_cmap_regs-&gt;clut_data
op_assign
id|green
suffix:semicolon
id|csc_cmap_regs-&gt;clut_data
op_assign
id|blue
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* FBCON_HAS_CFB8 || FBCON_HAS_CFB4 || FBCON_HAS_CFB2 */
DECL|function|macfb_getcolreg
r_static
r_int
id|macfb_getcolreg
c_func
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|fb_info
)paren
(brace
multiline_comment|/*&n;&t; *  Read a single color register and split it into colors/transparent.&n;&t; *  Return != 0 for invalid regno.&n;&t; */
r_if
c_cond
(paren
id|regno
op_ge
id|video_cmap_len
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
id|palette
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
id|palette
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
id|palette
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macfb_setcolreg
r_static
r_int
id|macfb_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|fb_info
)paren
(brace
multiline_comment|/*&n;&t; *  Set a single color register. The values supplied are&n;&t; *  already rounded down to the hardware&squot;s capabilities&n;&t; *  (according to the entries in the `var&squot; structure). Return&n;&t; *  != 0 for invalid regno.&n;&t; */
r_if
c_cond
(paren
id|regno
op_ge
id|video_cmap_len
)paren
r_return
l_int|1
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
r_switch
c_cond
(paren
id|video_bpp
)paren
(brace
macro_line|#ifdef FBCON_HAS_MFB
r_case
l_int|1
suffix:colon
multiline_comment|/* We shouldn&squot;t get here */
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB2
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|macfb_setpalette
)paren
id|macfb_setpalette
c_func
(paren
id|regno
comma
id|red
comma
id|green
comma
id|blue
)paren
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB4
r_case
l_int|4
suffix:colon
r_if
c_cond
(paren
id|macfb_setpalette
)paren
id|macfb_setpalette
c_func
(paren
id|regno
comma
id|red
comma
id|green
comma
id|blue
)paren
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
r_if
c_cond
(paren
id|macfb_setpalette
)paren
id|macfb_setpalette
c_func
(paren
id|regno
comma
id|red
comma
id|green
comma
id|blue
)paren
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|15
suffix:colon
r_case
l_int|16
suffix:colon
multiline_comment|/* 1:5:5:5 */
id|fbcon_cmap.cfb16
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xf800
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xf800
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf800
)paren
op_rshift
l_int|11
)paren
op_or
(paren
(paren
id|transp
op_ne
l_int|0
)paren
op_lshift
l_int|15
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
multiline_comment|/* I&squot;m pretty sure that one or the other of these&n;&t;&t;   doesn&squot;t exist on 68k Macs */
macro_line|#ifdef FBCON_HAS_CFB24
r_case
l_int|24
suffix:colon
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|fbcon_cmap.cfb24
(braket
id|regno
)braket
op_assign
(paren
id|red
op_lshift
id|macfb_defined.red.offset
)paren
op_or
(paren
id|green
op_lshift
id|macfb_defined.green.offset
)paren
op_or
(paren
id|blue
op_lshift
id|macfb_defined.blue.offset
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|32
suffix:colon
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|fbcon_cmap.cfb32
(braket
id|regno
)braket
op_assign
(paren
id|red
op_lshift
id|macfb_defined.red.offset
)paren
op_or
(paren
id|green
op_lshift
id|macfb_defined.green.offset
)paren
op_or
(paren
id|blue
op_lshift
id|macfb_defined.blue.offset
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_install_cmap
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_ne
id|currcon
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_set_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
comma
id|macfb_setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_set_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
id|video_cmap_len
)paren
comma
l_int|1
comma
id|macfb_setcolreg
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|macfb_get_cmap
r_static
r_int
id|macfb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console? */
r_return
id|fb_get_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|macfb_getcolreg
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
multiline_comment|/* non default colormap? */
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
id|video_cmap_len
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|macfb_set_cmap
r_static
r_int
id|macfb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
(brace
multiline_comment|/* no colormap allocated? */
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|video_cmap_len
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console? */
r_return
id|fb_set_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|macfb_setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|macfb_ops
r_static
r_struct
id|fb_ops
id|macfb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_get_fix
suffix:colon
id|macfb_get_fix
comma
id|fb_get_var
suffix:colon
id|macfb_get_var
comma
id|fb_set_var
suffix:colon
id|macfb_set_var
comma
id|fb_get_cmap
suffix:colon
id|macfb_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|macfb_set_cmap
comma
)brace
suffix:semicolon
DECL|function|macfb_setup
r_void
id|__init
id|macfb_setup
c_func
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
id|fb_info.fontname
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|this_opt
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_opt
suffix:semicolon
id|this_opt
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;inverse&quot;
)paren
)paren
id|inverse
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;font:&quot;
comma
l_int|5
)paren
)paren
id|strcpy
c_func
(paren
id|fb_info.fontname
comma
id|this_opt
op_plus
l_int|5
)paren
suffix:semicolon
multiline_comment|/* This means &quot;turn on experimental CLUT code&quot; */
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;vidtest&quot;
)paren
)paren
id|vidtest
op_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|macfb_switch
r_static
r_int
id|macfb_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* Do we have to save the colormap? */
r_if
c_cond
(paren
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap.len
)paren
id|fb_get_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap
comma
l_int|1
comma
id|macfb_getcolreg
comma
id|info
)paren
suffix:semicolon
id|currcon
op_assign
id|con
suffix:semicolon
multiline_comment|/* Install new colormap */
id|do_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
id|macfb_update_var
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|macfb_blank
r_static
r_void
id|macfb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* Not supported */
)brace
DECL|function|macfb_init
r_void
id|__init
id|macfb_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|nubus_dev
op_star
id|ndev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|video_is_nubus
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_MAC
)paren
r_return
suffix:semicolon
multiline_comment|/* There can only be one internal video controller anyway so&n;&t;   we&squot;re not too worried about this */
id|video_width
op_assign
id|mac_bi_data.dimensions
op_amp
l_int|0xFFFF
suffix:semicolon
id|video_height
op_assign
id|mac_bi_data.dimensions
op_rshift
l_int|16
suffix:semicolon
id|video_bpp
op_assign
id|mac_bi_data.videodepth
suffix:semicolon
id|video_linelength
op_assign
id|mac_bi_data.videorow
suffix:semicolon
id|video_size
op_assign
id|video_linelength
op_star
id|video_height
suffix:semicolon
multiline_comment|/* Note: physical address (since 2.1.127) */
id|video_base
op_assign
(paren
r_void
op_star
)paren
id|mac_bi_data.videoaddr
suffix:semicolon
multiline_comment|/* This is actually redundant with the initial mappings.&n;&t;   However, there are some non-obvious aspects to the way&n;&t;   those mappings are set up, so this is in fact the safest&n;&t;   way to ensure that this driver will work on every possible&n;&t;   Mac */
id|video_vbase
op_assign
id|ioremap
c_func
(paren
id|mac_bi_data.videoaddr
comma
id|video_size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;macfb: framebuffer at 0x%p, mapped to 0x%p, size %dk&bslash;n&quot;
comma
id|video_base
comma
id|video_vbase
comma
id|video_size
op_div
l_int|1024
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;macfb: mode is %dx%dx%d, linelength=%d&bslash;n&quot;
comma
id|video_width
comma
id|video_height
comma
id|video_bpp
comma
id|video_linelength
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fill in the available video resolution&n;&t; */
id|macfb_defined.xres
op_assign
id|video_width
suffix:semicolon
id|macfb_defined.yres
op_assign
id|video_height
suffix:semicolon
id|macfb_defined.xres_virtual
op_assign
id|video_width
suffix:semicolon
id|macfb_defined.yres_virtual
op_assign
id|video_height
suffix:semicolon
id|macfb_defined.bits_per_pixel
op_assign
id|video_bpp
suffix:semicolon
id|macfb_defined.height
op_assign
id|PIXEL_TO_MM
c_func
(paren
id|macfb_defined.yres
)paren
suffix:semicolon
id|macfb_defined.width
op_assign
id|PIXEL_TO_MM
c_func
(paren
id|macfb_defined.xres
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;macfb: scrolling: redraw&bslash;n&quot;
)paren
suffix:semicolon
id|macfb_defined.yres_virtual
op_assign
id|video_height
suffix:semicolon
multiline_comment|/* some dummy values for timing to make fbset happy */
id|macfb_defined.pixclock
op_assign
l_int|10000000
op_div
id|video_width
op_star
l_int|1000
op_div
id|video_height
suffix:semicolon
id|macfb_defined.left_margin
op_assign
(paren
id|video_width
op_div
l_int|8
)paren
op_amp
l_int|0xf8
suffix:semicolon
id|macfb_defined.right_margin
op_assign
l_int|32
suffix:semicolon
id|macfb_defined.upper_margin
op_assign
l_int|16
suffix:semicolon
id|macfb_defined.lower_margin
op_assign
l_int|4
suffix:semicolon
id|macfb_defined.hsync_len
op_assign
(paren
id|video_width
op_div
l_int|8
)paren
op_amp
l_int|0xf8
suffix:semicolon
id|macfb_defined.vsync_len
op_assign
l_int|4
suffix:semicolon
r_switch
c_cond
(paren
id|video_bpp
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* XXX: I think this will catch any program that tries&n;&t;&t;   to do FBIO_PUTCMAP when the visual is monochrome */
id|video_cmap_len
op_assign
l_int|0
suffix:semicolon
id|video_visual
op_assign
id|FB_VISUAL_MONO01
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|8
suffix:colon
id|macfb_defined.red.length
op_assign
id|video_bpp
suffix:semicolon
id|macfb_defined.green.length
op_assign
id|video_bpp
suffix:semicolon
id|macfb_defined.blue.length
op_assign
id|video_bpp
suffix:semicolon
id|video_cmap_len
op_assign
l_int|1
op_lshift
id|video_bpp
suffix:semicolon
id|video_visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|macfb_defined.transp.offset
op_assign
l_int|15
suffix:semicolon
id|macfb_defined.transp.length
op_assign
l_int|1
suffix:semicolon
id|macfb_defined.red.offset
op_assign
l_int|10
suffix:semicolon
id|macfb_defined.red.length
op_assign
l_int|5
suffix:semicolon
id|macfb_defined.green.offset
op_assign
l_int|5
suffix:semicolon
id|macfb_defined.green.length
op_assign
l_int|5
suffix:semicolon
id|macfb_defined.blue.offset
op_assign
l_int|0
suffix:semicolon
id|macfb_defined.blue.length
op_assign
l_int|5
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;macfb: directcolor: &quot;
l_string|&quot;size=1:5:5:5, shift=15:10:5:0&bslash;n&quot;
)paren
suffix:semicolon
id|video_cmap_len
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* Should actually be FB_VISUAL_DIRECTCOLOR, but this&n;&t;&t;   works too */
id|video_visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
multiline_comment|/* XXX: have to test these... can any 68k Macs&n;&t;&t;   actually do this on internal video? */
id|macfb_defined.red.offset
op_assign
l_int|16
suffix:semicolon
id|macfb_defined.red.length
op_assign
l_int|8
suffix:semicolon
id|macfb_defined.green.offset
op_assign
l_int|8
suffix:semicolon
id|macfb_defined.green.length
op_assign
l_int|8
suffix:semicolon
id|macfb_defined.blue.offset
op_assign
l_int|0
suffix:semicolon
id|macfb_defined.blue.length
op_assign
l_int|8
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;macfb: truecolor: &quot;
l_string|&quot;size=0:8:8:8, shift=0:16:8:0&bslash;n&quot;
)paren
suffix:semicolon
id|video_cmap_len
op_assign
l_int|16
suffix:semicolon
id|video_visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
r_default
suffix:colon
id|video_cmap_len
op_assign
l_int|0
suffix:semicolon
id|video_visual
op_assign
id|FB_VISUAL_MONO01
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;macfb: unknown or unsupported bit depth: %d&bslash;n&quot;
comma
id|video_bpp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Hardware dependent stuff */
multiline_comment|/*  We take a wild guess that if the video physical address is&n;&t; *  in nubus slot space, that the nubus card is driving video.&n;&t; *  Penguin really ought to tell us whether we are using internal&n;&t; *  video or not.&n;&t; */
multiline_comment|/* Hopefully we only find one of them.  Otherwise our NuBus&n;           code is really broken :-) */
r_while
c_loop
(paren
(paren
id|ndev
op_assign
id|nubus_find_type
c_func
(paren
id|NUBUS_CAT_DISPLAY
comma
id|NUBUS_TYPE_VIDEO
comma
id|ndev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mac_bi_data.videoaddr
op_ge
id|ndev-&gt;board-&gt;slot_addr
op_logical_and
(paren
id|mac_bi_data.videoaddr
OL
(paren
r_int
r_int
)paren
id|nubus_slot_addr
c_func
(paren
id|ndev-&gt;board-&gt;slot
op_plus
l_int|1
)paren
)paren
)paren
)paren
r_continue
suffix:semicolon
id|video_is_nubus
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* We should probably just use the slot address... */
id|video_slot
op_assign
id|ndev-&gt;board-&gt;slot
suffix:semicolon
r_switch
c_cond
(paren
id|ndev-&gt;dr_hw
)paren
(brace
r_case
id|NUBUS_DRHW_APPLE_MDC
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Macintosh Display Card&quot;
)paren
suffix:semicolon
id|macfb_setpalette
op_assign
id|mdc_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NUBUS_DRHW_APPLE_TFB
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Toby&quot;
)paren
suffix:semicolon
id|macfb_setpalette
op_assign
id|toby_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NUBUS_DRHW_APPLE_JET
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Jet&quot;
)paren
suffix:semicolon
id|macfb_setpalette
op_assign
id|jet_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Generic NuBus&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* If it&squot;s not a NuBus card, it must be internal video */
multiline_comment|/* FIXME: this function is getting way too big.  (this driver&n;           is too...) */
r_if
c_cond
(paren
op_logical_neg
id|video_is_nubus
)paren
r_switch
c_cond
(paren
id|mac_bi_data.id
)paren
(brace
multiline_comment|/* These don&squot;t have onboard video.  Eventually, we may&n;&t;&t;&t;   be able to write separate framebuffer drivers for&n;&t;&t;&t;   them (tobyfb.c, hiresfb.c, etc, etc) */
r_case
id|MAC_MODEL_II
suffix:colon
r_case
id|MAC_MODEL_IIX
suffix:colon
r_case
id|MAC_MODEL_IICX
suffix:colon
r_case
id|MAC_MODEL_IIFX
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Generic NuBus&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Valkyrie Quadras */
r_case
id|MAC_MODEL_Q630
suffix:colon
multiline_comment|/* I&squot;m not sure about this one */
r_case
id|MAC_MODEL_P588
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Valkyrie built-in&quot;
)paren
suffix:semicolon
id|macfb_setpalette
op_assign
id|valkyrie_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|valkyrie_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|DAC_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* DAFB Quadras */
multiline_comment|/* Note: these first four have the v7 DAFB, which is&n;&t;&t;&t;   known to be rather unlike the ones used in the&n;&t;&t;&t;   other models */
r_case
id|MAC_MODEL_P475
suffix:colon
r_case
id|MAC_MODEL_P475F
suffix:colon
r_case
id|MAC_MODEL_P575
suffix:colon
r_case
id|MAC_MODEL_Q605
suffix:colon
r_case
id|MAC_MODEL_Q800
suffix:colon
r_case
id|MAC_MODEL_Q650
suffix:colon
r_case
id|MAC_MODEL_Q610
suffix:colon
r_case
id|MAC_MODEL_C650
suffix:colon
r_case
id|MAC_MODEL_C610
suffix:colon
r_case
id|MAC_MODEL_Q700
suffix:colon
r_case
id|MAC_MODEL_Q900
suffix:colon
r_case
id|MAC_MODEL_Q950
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;DAFB built-in&quot;
)paren
suffix:semicolon
id|macfb_setpalette
op_assign
id|dafb_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|dafb_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|DAFB_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* LC II uses the V8 framebuffer */
r_case
id|MAC_MODEL_LCII
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;V8 built-in&quot;
)paren
suffix:semicolon
id|macfb_setpalette
op_assign
id|v8_brazil_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|v8_brazil_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|DAC_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* IIvi, IIvx use the &quot;Brazil&quot; framebuffer (which is&n;&t;&t;&t;   very much like the V8, it seems, and probably uses&n;&t;&t;&t;   the same DAC) */
r_case
id|MAC_MODEL_IIVI
suffix:colon
r_case
id|MAC_MODEL_IIVX
suffix:colon
r_case
id|MAC_MODEL_P600
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Brazil built-in&quot;
)paren
suffix:semicolon
id|macfb_setpalette
op_assign
id|v8_brazil_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|v8_brazil_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|DAC_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* LC III (and friends) use the Sonora framebuffer */
multiline_comment|/* Incidentally this is also used in the non-AV models&n;&t;&t;&t;   of the x100 PowerMacs */
multiline_comment|/* These do in fact seem to use the same DAC interface&n;&t;&t;&t;   as the LC II. */
r_case
id|MAC_MODEL_LCIII
suffix:colon
r_case
id|MAC_MODEL_P520
suffix:colon
r_case
id|MAC_MODEL_P550
suffix:colon
r_case
id|MAC_MODEL_P460
suffix:colon
id|macfb_setpalette
op_assign
id|v8_brazil_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Sonora built-in&quot;
)paren
suffix:semicolon
id|v8_brazil_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|DAC_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* IIci and IIsi use the infamous RBV chip&n;                           (the IIsi is just a rebadged and crippled&n;                           IIci in a different case, BTW) */
r_case
id|MAC_MODEL_IICI
suffix:colon
r_case
id|MAC_MODEL_IISI
suffix:colon
id|macfb_setpalette
op_assign
id|rbv_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;RBV built-in&quot;
)paren
suffix:semicolon
id|rbv_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|DAC_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* AVs use the Civic framebuffer */
r_case
id|MAC_MODEL_Q840
suffix:colon
r_case
id|MAC_MODEL_C660
suffix:colon
id|macfb_setpalette
op_assign
id|civic_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Civic built-in&quot;
)paren
suffix:semicolon
id|civic_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|CIVIC_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Write a setpalette function for your machine, then&n;&t;&t;&t;   you can add something similar here.  These are&n;&t;&t;&t;   grouped by classes of video chipsets.  Some of this&n;&t;&t;&t;   information is from the VideoToolbox &quot;Bugs&quot; web&n;&t;&t;&t;   page at&n;&t;&t;&t;   http://rajsky.psych.nyu.edu/Tips/VideoBugs.html */
multiline_comment|/* Assorted weirdos */
multiline_comment|/* We think this may be like the LC II */
r_case
id|MAC_MODEL_LC
suffix:colon
r_if
c_cond
(paren
id|vidtest
)paren
(brace
id|macfb_setpalette
op_assign
id|v8_brazil_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|v8_brazil_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|DAC_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;LC built-in&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* We think this may be like the LC II */
r_case
id|MAC_MODEL_CCL
suffix:colon
r_if
c_cond
(paren
id|vidtest
)paren
(brace
id|macfb_setpalette
op_assign
id|v8_brazil_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|v8_brazil_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|DAC_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Color Classic built-in&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* And we *do* mean &quot;weirdos&quot; */
r_case
id|MAC_MODEL_TV
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Mac TV built-in&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* These don&squot;t have colour, so no need to worry */
r_case
id|MAC_MODEL_SE30
suffix:colon
r_case
id|MAC_MODEL_CLII
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Monochrome built-in&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Powerbooks are particularly difficult.  Many of&n;&t;&t;&t;   them have separate framebuffers for external and&n;&t;&t;&t;   internal video, which is admittedly pretty cool,&n;&t;&t;&t;   but will be a bit of a headache to support here.&n;&t;&t;&t;   Also, many of them are grayscale, and we don&squot;t&n;&t;&t;&t;   really support that. */
r_case
id|MAC_MODEL_PB140
suffix:colon
r_case
id|MAC_MODEL_PB145
suffix:colon
r_case
id|MAC_MODEL_PB170
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;DDC built-in&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Internal is GSC, External (if present) is ViSC */
r_case
id|MAC_MODEL_PB150
suffix:colon
multiline_comment|/* no external video */
r_case
id|MAC_MODEL_PB160
suffix:colon
r_case
id|MAC_MODEL_PB165
suffix:colon
r_case
id|MAC_MODEL_PB180
suffix:colon
r_case
id|MAC_MODEL_PB210
suffix:colon
r_case
id|MAC_MODEL_PB230
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;GSC built-in&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Internal is TIM, External is ViSC */
r_case
id|MAC_MODEL_PB165C
suffix:colon
r_case
id|MAC_MODEL_PB180C
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;TIM built-in&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Internal is CSC, External is Keystone+Ariel. */
r_case
id|MAC_MODEL_PB190
suffix:colon
multiline_comment|/* external video is optional */
r_case
id|MAC_MODEL_PB520
suffix:colon
r_case
id|MAC_MODEL_PB250
suffix:colon
r_case
id|MAC_MODEL_PB270C
suffix:colon
r_case
id|MAC_MODEL_PB280
suffix:colon
r_case
id|MAC_MODEL_PB280C
suffix:colon
id|macfb_setpalette
op_assign
id|csc_setpalette
suffix:semicolon
id|macfb_defined.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;CSC built-in&quot;
)paren
suffix:semicolon
id|csc_cmap_regs
op_assign
id|ioremap
c_func
(paren
id|CSC_BASE
comma
l_int|0x1000
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Unknown/Unsupported built-in&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|fb_info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|macfb_ops
suffix:semicolon
id|fb_info.disp
op_assign
op_amp
id|disp
suffix:semicolon
id|fb_info.switch_con
op_assign
op_amp
id|macfb_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
op_amp
id|macfb_update_var
suffix:semicolon
id|fb_info.blank
op_assign
op_amp
id|macfb_blank
suffix:semicolon
id|fb_info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|macfb_set_disp
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|do_install_cmap
c_func
(paren
l_int|0
comma
op_amp
id|fb_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fb%d: %s frame buffer device&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|fb_info.node
)paren
comma
id|fb_info.modename
)paren
suffix:semicolon
)brace
eof
