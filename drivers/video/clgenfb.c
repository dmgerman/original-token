multiline_comment|/*&n; * Based on retz3fb.c and clgen.c&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/zorro.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-mfb.h&gt;
macro_line|#include &lt;video/fbcon-cfb8.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
macro_line|#include &lt;video/fbcon-cfb24.h&gt;
macro_line|#include &lt;video/fbcon-cfb32.h&gt;
macro_line|#include &quot;clgenfb.h&quot;
DECL|macro|CLGEN_VERSION
mdefine_line|#define CLGEN_VERSION &quot;1.4 ?&quot;
multiline_comment|/* #define DEBUG if(1) */
DECL|macro|DEBUG
mdefine_line|#define DEBUG if(0)
DECL|macro|arraysize
mdefine_line|#define arraysize(x)    (sizeof(x)/sizeof(*(x)))
multiline_comment|/* board types */
DECL|macro|BT_NONE
mdefine_line|#define BT_NONE     0
DECL|macro|BT_SD64
mdefine_line|#define BT_SD64     1
DECL|macro|BT_PICCOLO
mdefine_line|#define BT_PICCOLO  2
DECL|macro|BT_PICASSO
mdefine_line|#define BT_PICASSO  3
DECL|macro|BT_SPECTRUM
mdefine_line|#define BT_SPECTRUM 4
DECL|macro|BT_PICASSO4
mdefine_line|#define BT_PICASSO4 5
DECL|macro|MAX_NUM_BOARDS
mdefine_line|#define MAX_NUM_BOARDS 7
DECL|macro|TRUE
mdefine_line|#define TRUE  1
DECL|macro|FALSE
mdefine_line|#define FALSE 0 
DECL|struct|clgenfb_par
r_struct
id|clgenfb_par
(brace
DECL|member|var
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
DECL|member|line_length
id|__u32
id|line_length
suffix:semicolon
multiline_comment|/* in BYTES! */
DECL|member|visual
id|__u32
id|visual
suffix:semicolon
DECL|member|type
id|__u32
id|type
suffix:semicolon
DECL|member|freq
r_int
id|freq
suffix:semicolon
DECL|member|nom
r_int
id|nom
suffix:semicolon
DECL|member|den
r_int
id|den
suffix:semicolon
DECL|member|div
r_int
id|div
suffix:semicolon
DECL|member|HorizRes
r_int
id|HorizRes
suffix:semicolon
multiline_comment|/* The x resolution in pixel */
DECL|member|HorizTotal
r_int
id|HorizTotal
suffix:semicolon
DECL|member|HorizDispEnd
r_int
id|HorizDispEnd
suffix:semicolon
DECL|member|HorizBlankStart
r_int
id|HorizBlankStart
suffix:semicolon
DECL|member|HorizBlankEnd
r_int
id|HorizBlankEnd
suffix:semicolon
DECL|member|HorizSyncStart
r_int
id|HorizSyncStart
suffix:semicolon
DECL|member|HorizSyncEnd
r_int
id|HorizSyncEnd
suffix:semicolon
DECL|member|VertRes
r_int
id|VertRes
suffix:semicolon
multiline_comment|/* the physical y resolution in scanlines */
DECL|member|VertTotal
r_int
id|VertTotal
suffix:semicolon
DECL|member|VertDispEnd
r_int
id|VertDispEnd
suffix:semicolon
DECL|member|VertSyncStart
r_int
id|VertSyncStart
suffix:semicolon
DECL|member|VertSyncEnd
r_int
id|VertSyncEnd
suffix:semicolon
DECL|member|VertBlankStart
r_int
id|VertBlankStart
suffix:semicolon
DECL|member|VertBlankEnd
r_int
id|VertBlankEnd
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* info about board */
DECL|struct|clgenfb_info
r_struct
id|clgenfb_info
(brace
DECL|member|gen
r_struct
id|fb_info_gen
id|gen
suffix:semicolon
DECL|member|keyRAM
r_int
id|keyRAM
suffix:semicolon
multiline_comment|/* RAM, REG zorro board keys */
DECL|member|keyREG
r_int
id|keyREG
suffix:semicolon
DECL|member|fbmem
r_int
r_int
id|fbmem
suffix:semicolon
DECL|member|regs
r_volatile
r_int
r_char
op_star
id|regs
suffix:semicolon
DECL|member|mem
r_int
r_int
id|mem
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|member|btype
r_int
id|btype
suffix:semicolon
DECL|member|smallboard
r_int
id|smallboard
suffix:semicolon
DECL|member|SFR
r_int
r_char
id|SFR
suffix:semicolon
multiline_comment|/* Shadow of special function register */
DECL|member|currentmode
r_struct
id|clgenfb_par
id|currentmode
suffix:semicolon
r_union
(brace
macro_line|#ifdef FBCON_HAS_CFB16
DECL|member|cfb16
id|u16
id|cfb16
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB24
DECL|member|cfb24
id|u32
id|cfb24
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
DECL|member|cfb32
id|u32
id|cfb32
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
DECL|member|fbcon_cmap
)brace
id|fbcon_cmap
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
suffix:semicolon
DECL|variable|boards
r_static
r_struct
id|clgenfb_info
id|boards
(braket
id|MAX_NUM_BOARDS
)braket
suffix:semicolon
multiline_comment|/* the boards */
DECL|variable|fb_info
r_static
r_struct
id|clgenfb_info
op_star
id|fb_info
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to current board */
multiline_comment|/*&n; *    Predefined Video Modes&n; */
DECL|variable|__initdata
r_static
r_struct
id|fb_videomode
id|clgenfb_predefined
(braket
)braket
id|__initdata
op_assign
(brace
(brace
l_string|&quot;Autodetect&quot;
comma
multiline_comment|/* autodetect mode */
(brace
l_int|0
)brace
)brace
comma
(brace
l_string|&quot;640x480&quot;
comma
multiline_comment|/* 640x480, 31.25 kHz, 60 Hz, 25 MHz PixClock */
(brace
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|480
comma
l_int|0
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
l_int|40000
comma
l_int|32
comma
l_int|32
comma
l_int|33
comma
l_int|10
comma
l_int|96
comma
l_int|2
comma
id|FB_SYNC_HOR_HIGH_ACT
op_or
id|FB_SYNC_VERT_HIGH_ACT
comma
id|FB_VMODE_NONINTERLACED
)brace
)brace
comma
multiline_comment|/* 1024x768, 55.8 kHz, 70 Hz, 80 MHz PixClock */
multiline_comment|/* &n;&t;    Modeline from XF86Config:&n;&t;    Mode &quot;1024x768&quot; 80  1024 1136 1340 1432  768 770 774 805&n;&t;*/
(brace
l_string|&quot;1024x768&quot;
comma
(brace
l_int|1024
comma
l_int|768
comma
l_int|1024
comma
l_int|768
comma
l_int|0
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|8
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|FB_ACCEL_NONE
comma
l_int|12500
comma
l_int|92
comma
l_int|112
comma
l_int|31
comma
l_int|2
comma
l_int|204
comma
l_int|4
comma
id|FB_SYNC_HOR_HIGH_ACT
op_or
id|FB_SYNC_VERT_HIGH_ACT
comma
id|FB_VMODE_NONINTERLACED
)brace
)brace
)brace
suffix:semicolon
DECL|macro|NUM_TOTAL_MODES
mdefine_line|#define NUM_TOTAL_MODES    arraysize(clgenfb_predefined)
DECL|variable|clgenfb_default
r_static
r_struct
id|fb_var_screeninfo
id|clgenfb_default
suffix:semicolon
multiline_comment|/*&n; *    Frame Buffer Name&n; */
DECL|variable|clgenfb_name
r_static
r_char
id|clgenfb_name
(braket
l_int|16
)braket
op_assign
l_string|&quot;CLgen&quot;
suffix:semicolon
multiline_comment|/****************************************************************************/
multiline_comment|/**** BEGIN PROTOTYPES ******************************************************/
multiline_comment|/*--- Interface used by the world ------------------------------------------*/
r_void
id|clgenfb_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|clgenfb_setup
c_func
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
suffix:semicolon
r_int
id|clgenfb_open
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_int
id|clgenfb_release
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_int
id|clgenfb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/* function table of the above functions */
DECL|variable|clgenfb_ops
r_static
r_struct
id|fb_ops
id|clgenfb_ops
op_assign
(brace
id|clgenfb_open
comma
id|clgenfb_release
comma
id|fbgen_get_fix
comma
multiline_comment|/* using the generic functions */
id|fbgen_get_var
comma
multiline_comment|/* makes things much easier... */
id|fbgen_set_var
comma
id|fbgen_get_cmap
comma
id|fbgen_set_cmap
comma
id|fbgen_pan_display
comma
id|clgenfb_ioctl
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*--- Hardware Specific Routines -------------------------------------------*/
r_static
r_void
id|clgen_detect
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|clgen_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_const
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|clgen_decode_var
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|clgen_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_const
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|clgen_get_par
c_func
(paren
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|clgen_set_par
c_func
(paren
r_const
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|clgen_getcolreg
c_func
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|clgen_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|clgen_pan_display
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|clgen_blank
c_func
(paren
r_int
id|blank_mode
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|clgen_set_dispsw
c_func
(paren
r_const
r_void
op_star
id|par
comma
r_struct
id|display
op_star
id|disp
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/* function table of the above functions */
DECL|variable|clgen_hwswitch
r_static
r_struct
id|fbgen_hwswitch
id|clgen_hwswitch
op_assign
(brace
id|clgen_detect
comma
id|clgen_encode_fix
comma
id|clgen_decode_var
comma
id|clgen_encode_var
comma
id|clgen_get_par
comma
id|clgen_set_par
comma
id|clgen_getcolreg
comma
id|clgen_setcolreg
comma
id|clgen_pan_display
comma
id|clgen_blank
comma
id|clgen_set_dispsw
)brace
suffix:semicolon
multiline_comment|/* Text console acceleration */
macro_line|#ifdef FBCON_HAS_CFB8
r_static
r_void
id|fbcon_clgen8_bmove
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
suffix:semicolon
r_static
r_void
id|fbcon_clgen8_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
suffix:semicolon
DECL|variable|fbcon_clgen_8
r_static
r_struct
id|display_switch
id|fbcon_clgen_8
op_assign
(brace
id|fbcon_cfb8_setup
comma
id|fbcon_clgen8_bmove
comma
id|fbcon_clgen8_clear
comma
id|fbcon_cfb8_putc
comma
id|fbcon_cfb8_putcs
comma
id|fbcon_cfb8_revc
comma
l_int|NULL
comma
l_int|NULL
comma
id|fbcon_cfb8_clear_margins
comma
id|FONTWIDTH
c_func
(paren
l_int|4
)paren
op_or
id|FONTWIDTH
c_func
(paren
l_int|8
)paren
op_or
id|FONTWIDTH
c_func
(paren
l_int|12
)paren
op_or
id|FONTWIDTH
c_func
(paren
l_int|16
)paren
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*--- Internal routines ----------------------------------------------------*/
r_static
r_void
id|init_vgachip
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|switch_monitor
c_func
(paren
r_int
id|on
)paren
suffix:semicolon
r_static
r_void
id|WGen
c_func
(paren
r_int
id|regnum
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_int
r_char
id|RGen
c_func
(paren
r_int
id|regnum
)paren
suffix:semicolon
r_static
r_void
id|WSeq
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_int
r_char
id|RSeq
c_func
(paren
r_int
r_char
id|regnum
)paren
suffix:semicolon
r_static
r_void
id|WCrt
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_int
r_char
id|RCrt
c_func
(paren
r_int
r_char
id|regnum
)paren
suffix:semicolon
r_static
r_void
id|WGfx
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_int
r_char
id|RGfx
c_func
(paren
r_int
r_char
id|regnum
)paren
suffix:semicolon
r_static
r_void
id|WAttr
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_void
id|AttrOn
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
r_char
id|RAttr
c_func
(paren
r_int
r_char
id|regnum
)paren
suffix:semicolon
r_static
r_void
id|WHDR
c_func
(paren
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_int
r_char
id|RHDR
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|WSFR
c_func
(paren
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_void
id|WSFR2
c_func
(paren
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
r_void
id|WClut
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|red
comma
r_int
r_char
id|green
comma
r_int
r_char
id|blue
)paren
suffix:semicolon
r_static
r_void
id|RClut
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
op_star
id|red
comma
r_int
r_char
op_star
id|green
comma
r_int
r_char
op_star
id|blue
)paren
suffix:semicolon
r_static
r_void
id|clgen_WaitBLT
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|clgen_BitBLT
(paren
id|u_short
id|curx
comma
id|u_short
id|cury
comma
id|u_short
id|destx
comma
id|u_short
id|desty
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_short
id|line_length
)paren
suffix:semicolon
r_static
r_void
id|clgen_RectFill
(paren
id|u_short
id|x
comma
id|u_short
id|y
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_char
id|color
comma
id|u_short
id|line_length
)paren
suffix:semicolon
r_static
r_void
id|bestclock
c_func
(paren
r_int
id|freq
comma
r_int
op_star
id|best
comma
r_int
op_star
id|nom
comma
r_int
op_star
id|den
comma
r_int
op_star
id|div
comma
r_int
id|maxfreq
)paren
suffix:semicolon
multiline_comment|/*** END   PROTOTYPES ********************************************************/
multiline_comment|/*****************************************************************************/
multiline_comment|/*** BEGIN Interface Used by the World ***************************************/
DECL|variable|opencount
r_static
r_int
id|opencount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*--- Open /dev/fbx ---------------------------------------------------------*/
DECL|function|clgenfb_open
r_int
id|clgenfb_open
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|opencount
op_increment
op_eq
l_int|0
)paren
id|switch_monitor
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--- Close /dev/fbx --------------------------------------------------------*/
DECL|function|clgenfb_release
r_int
id|clgenfb_release
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|opencount
op_eq
l_int|0
)paren
id|switch_monitor
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*--- handle /dev/fbx ioctl calls ------------------------------------------*/
DECL|function|clgenfb_ioctl
r_int
id|clgenfb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&gt;clgenfb_ioctl()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Nothing exciting here... */
id|printk
c_func
(paren
l_string|&quot;&lt;clgenfb_ioctl()&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/**** END   Interface used by the World *************************************/
multiline_comment|/****************************************************************************/
multiline_comment|/**** BEGIN Hardware specific Routines **************************************/
DECL|function|clgen_detect
r_static
r_void
id|clgen_detect
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&gt;clgen_detect()&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&lt;clgen_detect()&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|clgen_encode_fix
r_static
r_int
id|clgen_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_const
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
r_struct
id|clgenfb_par
op_star
id|_par
op_assign
(paren
r_struct
id|clgenfb_par
op_star
)paren
id|par
suffix:semicolon
r_struct
id|clgenfb_info
op_star
id|_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|info
suffix:semicolon
id|memset
c_func
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_fix_screeninfo
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
id|clgenfb_name
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
(paren
r_char
op_star
)paren
id|_info-&gt;fbmem
suffix:semicolon
multiline_comment|/* monochrome: only 1 memory plane */
multiline_comment|/* 8 bit and above: Use whole memory area */
id|fix-&gt;smem_len
op_assign
id|_par-&gt;var.bits_per_pixel
op_eq
l_int|1
ques
c_cond
id|_info-&gt;size
op_div
l_int|4
suffix:colon
id|_info-&gt;size
suffix:semicolon
id|fix-&gt;type
op_assign
id|_par-&gt;type
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;visual
op_assign
id|_par-&gt;visual
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;line_length
op_assign
id|_par-&gt;line_length
suffix:semicolon
id|fix-&gt;mmio_start
op_assign
(paren
r_char
op_star
)paren
id|_info-&gt;regs
suffix:semicolon
id|fix-&gt;mmio_len
op_assign
l_int|0x10000
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|clgen_decode_var
r_static
r_int
id|clgen_decode_var
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
r_int
id|freq
suffix:semicolon
r_int
id|xres
comma
id|hfront
comma
id|hsync
comma
id|hback
suffix:semicolon
r_int
id|yres
comma
id|vfront
comma
id|vsync
comma
id|vback
suffix:semicolon
r_int
id|nom
comma
id|den
suffix:semicolon
multiline_comment|/* translyting from pixels-&gt;bytes */
r_int
id|i
suffix:semicolon
r_static
r_struct
(brace
r_int
id|xres
comma
id|yres
suffix:semicolon
)brace
id|modes
(braket
)braket
op_assign
(brace
(brace
l_int|1600
comma
l_int|1280
)brace
comma
(brace
l_int|1280
comma
l_int|1024
)brace
comma
(brace
l_int|1024
comma
l_int|768
)brace
comma
(brace
l_int|800
comma
l_int|600
)brace
comma
(brace
l_int|640
comma
l_int|480
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
r_struct
id|clgenfb_par
op_star
id|_par
op_assign
(paren
r_struct
id|clgenfb_par
op_star
)paren
id|par
suffix:semicolon
id|fb_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|info
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;clgen_decode_var()&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Requested: %dx%dx%d&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  virtual: %dx%d&bslash;n&quot;
comma
id|var-&gt;xres_virtual
comma
id|var-&gt;yres_virtual
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   offset: (%d,%d)&bslash;n&quot;
comma
id|var-&gt;xoffset
comma
id|var-&gt;yoffset
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;grayscale: %d&bslash;n&quot;
comma
id|var-&gt;grayscale
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot; activate: 0x%x&bslash;n&quot;
comma
id|var-&gt;activate
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; pixclock: %d&bslash;n&quot;
comma
id|var-&gt;pixclock
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  htiming: %d;%d  %d&bslash;n&quot;
comma
id|var-&gt;left_margin
comma
id|var-&gt;right_margin
comma
id|var-&gt;hsync_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  vtiming: %d;%d  %d&bslash;n&quot;
comma
id|var-&gt;upper_margin
comma
id|var-&gt;lower_margin
comma
id|var-&gt;vsync_len
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;     sync: 0x%x&bslash;n&quot;
comma
id|var-&gt;sync
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    vmode: 0x%x&bslash;n&quot;
comma
id|var-&gt;vmode
)paren
suffix:semicolon
macro_line|#endif
id|_par-&gt;var
op_assign
op_star
id|var
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|nom
op_assign
l_int|4
suffix:semicolon
id|den
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 8 pixel per byte, only 1/4th of mem usable */
r_case
l_int|8
suffix:colon
id|nom
op_assign
l_int|1
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 1 pixel == 1 byte */
r_case
l_int|16
suffix:colon
id|nom
op_assign
l_int|2
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 2 bytes per pixel */
r_case
l_int|24
suffix:colon
id|nom
op_assign
l_int|3
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 3 bytes per pixel */
r_case
l_int|32
suffix:colon
id|nom
op_assign
l_int|4
suffix:semicolon
id|den
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 4 bytes per pixel */
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;clgen: mode %dx%dx%d rejected...color depth not supported.&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_par-&gt;var.xres
op_star
id|nom
op_div
id|den
op_star
id|_par-&gt;var.yres
OG
id|fb_info-&gt;size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;clgen: mode %dx%dx%d rejected...resolution too high to fit into video memory!&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* use highest possible virtual resolution */
r_if
c_cond
(paren
id|_par-&gt;var.xres_virtual
op_eq
op_minus
l_int|1
op_logical_and
id|_par-&gt;var.xres_virtual
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;clgen: using maximum available virtual resolution&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|modes
(braket
id|i
)braket
dot
id|xres
op_ne
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|modes
(braket
id|i
)braket
dot
id|xres
op_star
id|nom
op_div
id|den
op_star
id|modes
(braket
id|i
)braket
dot
id|yres
OL
id|fb_info-&gt;size
op_div
l_int|2
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|modes
(braket
id|i
)braket
dot
id|xres
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;clgen: could not find a virtual resolution that fits into video memory!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|_par-&gt;var.xres_virtual
op_assign
id|modes
(braket
id|i
)braket
dot
id|xres
suffix:semicolon
id|_par-&gt;var.yres_virtual
op_assign
id|modes
(braket
id|i
)braket
dot
id|yres
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;clgen: virtual resolution set to maximum of %dx%d&bslash;n&quot;
comma
id|_par-&gt;var.xres_virtual
comma
id|_par-&gt;var.yres_virtual
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|_par-&gt;var.xres_virtual
op_eq
op_minus
l_int|1
)paren
(brace
)brace
r_else
r_if
c_cond
(paren
id|_par-&gt;var.yres_virtual
op_eq
op_minus
l_int|1
)paren
(brace
)brace
r_if
c_cond
(paren
id|_par-&gt;var.xoffset
OL
l_int|0
)paren
id|_par-&gt;var.xoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;var.yoffset
OL
l_int|0
)paren
id|_par-&gt;var.yoffset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* truncate xoffset and yoffset to maximum if too high */
r_if
c_cond
(paren
id|_par-&gt;var.xoffset
OG
id|_par-&gt;var.xres_virtual
op_minus
id|_par-&gt;var.xres
)paren
id|_par-&gt;var.xoffset
op_assign
id|_par-&gt;var.xres_virtual
op_minus
id|_par-&gt;var.xres
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;var.yoffset
OG
id|_par-&gt;var.yres_virtual
op_minus
id|_par-&gt;var.yres
)paren
id|_par-&gt;var.yoffset
op_assign
id|_par-&gt;var.yres_virtual
op_minus
id|_par-&gt;var.yres
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|1
suffix:colon
id|_par-&gt;line_length
op_assign
id|_par-&gt;var.xres_virtual
op_div
l_int|8
suffix:semicolon
id|_par-&gt;visual
op_assign
id|FB_VISUAL_MONO10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|_par-&gt;line_length
op_assign
id|_par-&gt;var.xres_virtual
suffix:semicolon
id|_par-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|_par-&gt;var.red.offset
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.red.length
op_assign
l_int|6
suffix:semicolon
id|_par-&gt;var.green.offset
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.green.length
op_assign
l_int|6
suffix:semicolon
id|_par-&gt;var.blue.offset
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.blue.length
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|_par-&gt;line_length
op_assign
id|_par-&gt;var.xres_virtual
op_star
l_int|2
suffix:semicolon
id|_par-&gt;visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
id|_par-&gt;var.red.offset
op_assign
l_int|10
suffix:semicolon
id|_par-&gt;var.red.length
op_assign
l_int|5
suffix:semicolon
id|_par-&gt;var.green.offset
op_assign
l_int|5
suffix:semicolon
id|_par-&gt;var.green.length
op_assign
l_int|5
suffix:semicolon
id|_par-&gt;var.blue.offset
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.blue.length
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|_par-&gt;line_length
op_assign
id|_par-&gt;var.xres_virtual
op_star
l_int|3
suffix:semicolon
id|_par-&gt;visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
id|_par-&gt;var.red.offset
op_assign
l_int|16
suffix:semicolon
id|_par-&gt;var.red.length
op_assign
l_int|8
suffix:semicolon
id|_par-&gt;var.green.offset
op_assign
l_int|8
suffix:semicolon
id|_par-&gt;var.green.length
op_assign
l_int|8
suffix:semicolon
id|_par-&gt;var.blue.offset
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|_par-&gt;line_length
op_assign
id|_par-&gt;var.xres_virtual
op_star
l_int|4
suffix:semicolon
id|_par-&gt;visual
op_assign
id|FB_VISUAL_DIRECTCOLOR
suffix:semicolon
id|_par-&gt;var.red.offset
op_assign
l_int|16
suffix:semicolon
id|_par-&gt;var.red.length
op_assign
l_int|8
suffix:semicolon
id|_par-&gt;var.green.offset
op_assign
l_int|8
suffix:semicolon
id|_par-&gt;var.green.length
op_assign
l_int|8
suffix:semicolon
id|_par-&gt;var.blue.offset
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.blue.length
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
id|_par-&gt;var.red.msb_right
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.green.msb_right
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.blue.msb_right
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.transp.offset
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.transp.length
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;var.transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|_par-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
multiline_comment|/* convert from ps to kHz */
id|freq
op_assign
l_int|1000000000
op_div
id|var-&gt;pixclock
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;desired pixclock: %ld kHz&bslash;n&quot;
comma
id|freq
)paren
suffix:semicolon
multiline_comment|/* the SD64/P4 have a higher max. videoclock */
id|bestclock
c_func
(paren
id|freq
comma
op_amp
id|_par-&gt;freq
comma
op_amp
id|_par-&gt;nom
comma
op_amp
id|_par-&gt;den
comma
op_amp
id|_par-&gt;div
comma
id|fb_info-&gt;btype
op_eq
id|BT_SD64
op_logical_or
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO4
ques
c_cond
l_int|140000
suffix:colon
l_int|90000
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;Best possible values for given frequency: best: %ld kHz  nom: %ld  den: %ld  div: %ld&bslash;n&quot;
comma
id|_par-&gt;freq
comma
id|_par-&gt;nom
comma
id|_par-&gt;den
comma
id|_par-&gt;div
)paren
suffix:semicolon
id|xres
op_assign
id|_par-&gt;var.xres
suffix:semicolon
id|hfront
op_assign
id|_par-&gt;var.right_margin
suffix:semicolon
id|hsync
op_assign
id|_par-&gt;var.hsync_len
suffix:semicolon
id|hback
op_assign
id|_par-&gt;var.left_margin
suffix:semicolon
id|yres
op_assign
id|_par-&gt;var.yres
suffix:semicolon
id|vfront
op_assign
id|_par-&gt;var.lower_margin
suffix:semicolon
id|vsync
op_assign
id|_par-&gt;var.vsync_len
suffix:semicolon
id|vback
op_assign
id|_par-&gt;var.upper_margin
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;var.vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
(brace
id|yres
op_mul_assign
l_int|2
suffix:semicolon
id|vfront
op_mul_assign
l_int|2
suffix:semicolon
id|vsync
op_mul_assign
l_int|2
suffix:semicolon
id|vback
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|_par-&gt;var.vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
(brace
id|yres
op_assign
op_increment
id|yres
op_div
l_int|2
suffix:semicolon
id|vfront
op_assign
op_increment
id|vfront
op_div
l_int|2
suffix:semicolon
id|vsync
op_assign
op_increment
id|vsync
op_div
l_int|2
suffix:semicolon
id|vback
op_assign
op_increment
id|vback
op_div
l_int|2
suffix:semicolon
)brace
id|_par-&gt;HorizRes
op_assign
id|xres
suffix:semicolon
id|_par-&gt;HorizTotal
op_assign
(paren
id|xres
op_plus
id|hfront
op_plus
id|hsync
op_plus
id|hback
)paren
op_div
l_int|8
op_minus
l_int|5
suffix:semicolon
id|_par-&gt;HorizDispEnd
op_assign
id|xres
op_div
l_int|8
op_minus
l_int|1
suffix:semicolon
id|_par-&gt;HorizBlankStart
op_assign
id|xres
op_div
l_int|8
suffix:semicolon
id|_par-&gt;HorizBlankEnd
op_assign
id|_par-&gt;HorizTotal
op_plus
l_int|5
suffix:semicolon
multiline_comment|/* does not count with &quot;-5&quot; */
id|_par-&gt;HorizSyncStart
op_assign
(paren
id|xres
op_plus
id|hfront
)paren
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
id|_par-&gt;HorizSyncEnd
op_assign
(paren
id|xres
op_plus
id|hfront
op_plus
id|hsync
)paren
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
id|_par-&gt;VertRes
op_assign
id|yres
suffix:semicolon
id|_par-&gt;VertTotal
op_assign
id|yres
op_plus
id|vfront
op_plus
id|vsync
op_plus
id|vback
op_minus
l_int|2
suffix:semicolon
id|_par-&gt;VertDispEnd
op_assign
id|yres
op_minus
l_int|1
suffix:semicolon
id|_par-&gt;VertBlankStart
op_assign
id|yres
suffix:semicolon
id|_par-&gt;VertBlankEnd
op_assign
id|_par-&gt;VertTotal
suffix:semicolon
id|_par-&gt;VertSyncStart
op_assign
id|yres
op_plus
id|vfront
op_minus
l_int|1
suffix:semicolon
id|_par-&gt;VertSyncEnd
op_assign
id|yres
op_plus
id|vfront
op_plus
id|vsync
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;VertTotal
op_ge
l_int|1024
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;clgen: ERROR: VerticalTotal &gt;= 1024; special treatment required! (TODO)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|clgen_encode_var
r_static
r_int
id|clgen_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_const
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
op_star
id|var
op_assign
(paren
(paren
r_struct
id|clgenfb_par
op_star
)paren
id|par
)paren
op_member_access_from_pointer
id|var
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get current video mode */
DECL|function|clgen_get_par
r_static
r_void
id|clgen_get_par
c_func
(paren
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
r_struct
id|clgenfb_par
op_star
id|_par
op_assign
(paren
r_struct
id|clgenfb_par
op_star
)paren
id|par
suffix:semicolon
r_struct
id|clgenfb_info
op_star
id|_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|fb_info
suffix:semicolon
op_star
id|_par
op_assign
id|_info-&gt;currentmode
suffix:semicolon
)brace
multiline_comment|/*************************************************************************&n;&t;clgen_set_par()&n;&n;&t;actually writes the values for a new video mode into the hardware,&n;**************************************************************************/
DECL|function|clgen_set_par
r_static
r_void
id|clgen_set_par
c_func
(paren
r_const
r_void
op_star
id|par
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
r_int
r_char
id|tmp
suffix:semicolon
r_int
id|offset
op_assign
l_int|0
suffix:semicolon
r_struct
id|clgenfb_par
op_star
id|_par
op_assign
(paren
r_struct
id|clgenfb_par
op_star
)paren
id|par
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&gt;clgen_set_par()&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Requested mode: %dx%dx%d&bslash;n&quot;
comma
id|_par-&gt;var.xres
comma
id|_par-&gt;var.yres
comma
id|_par-&gt;var.bits_per_pixel
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pixclock: %d&bslash;n&quot;
comma
id|_par-&gt;var.pixclock
)paren
suffix:semicolon
id|fb_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|info
suffix:semicolon
multiline_comment|/* unlock register CRT0..CRT7 */
id|WCrt
c_func
(paren
id|CRT11
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* previously: 0x00) */
multiline_comment|/* if DEBUG is set, all parameters get output before writing */
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT0: %ld&bslash;n&quot;
comma
id|_par-&gt;HorizTotal
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT0
comma
id|_par-&gt;HorizTotal
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT1: %ld&bslash;n&quot;
comma
id|_par-&gt;HorizDispEnd
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT1
comma
id|_par-&gt;HorizDispEnd
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT2: %ld&bslash;n&quot;
comma
id|_par-&gt;HorizBlankStart
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT2
comma
id|_par-&gt;HorizBlankStart
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT3: 128+%ld&bslash;n&quot;
comma
id|_par-&gt;HorizBlankEnd
op_mod
l_int|32
)paren
suffix:semicolon
multiline_comment|/*  + 128: Compatible read */
id|WCrt
c_func
(paren
id|CRT3
comma
l_int|128
op_plus
(paren
id|_par-&gt;HorizBlankEnd
op_mod
l_int|32
)paren
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT4: %ld&bslash;n&quot;
comma
id|_par-&gt;HorizSyncStart
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT4
comma
id|_par-&gt;HorizSyncStart
)paren
suffix:semicolon
id|tmp
op_assign
id|_par-&gt;HorizSyncEnd
op_mod
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;HorizBlankEnd
op_amp
l_int|32
)paren
id|tmp
op_add_assign
l_int|128
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT5: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT5
comma
id|tmp
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT6: %ld&bslash;n&quot;
comma
id|_par-&gt;VertTotal
op_amp
l_int|0xff
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT6
comma
(paren
id|_par-&gt;VertTotal
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|tmp
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* LineCompare bit #9 */
r_if
c_cond
(paren
id|_par-&gt;VertTotal
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;VertDispEnd
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;VertSyncStart
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;VertBlankStart
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;VertTotal
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;VertDispEnd
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;VertSyncStart
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|128
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT7: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT7
comma
id|tmp
)paren
suffix:semicolon
id|tmp
op_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* LineCompare bit #8 */
r_if
c_cond
(paren
id|_par-&gt;VertBlankStart
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;var.vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
id|tmp
op_or_assign
l_int|0x80
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT9: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT9
comma
id|tmp
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT10: %ld&bslash;n&quot;
comma
id|_par-&gt;VertSyncStart
op_amp
l_int|0xff
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT10
comma
(paren
id|_par-&gt;VertSyncStart
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT11: 64+32+%ld&bslash;n&quot;
comma
id|_par-&gt;VertSyncEnd
op_mod
l_int|16
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT11
comma
(paren
id|_par-&gt;VertSyncEnd
op_mod
l_int|16
op_plus
l_int|64
op_plus
l_int|32
)paren
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT12: %ld&bslash;n&quot;
comma
id|_par-&gt;VertDispEnd
op_amp
l_int|0xff
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT12
comma
(paren
id|_par-&gt;VertDispEnd
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT15: %ld&bslash;n&quot;
comma
id|_par-&gt;VertBlankStart
op_amp
l_int|0xff
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT15
comma
(paren
id|_par-&gt;VertBlankStart
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT16: %ld&bslash;n&quot;
comma
id|_par-&gt;VertBlankEnd
op_amp
l_int|0xff
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT16
comma
(paren
id|_par-&gt;VertBlankEnd
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT18: 0xff&bslash;n&quot;
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT18
comma
l_int|0xff
)paren
suffix:semicolon
id|tmp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;var.vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
id|tmp
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;HorizBlankEnd
op_amp
l_int|64
)paren
id|tmp
op_or_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;HorizBlankEnd
op_amp
l_int|128
)paren
id|tmp
op_or_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;VertBlankEnd
op_amp
l_int|256
)paren
id|tmp
op_or_assign
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;VertBlankEnd
op_amp
l_int|512
)paren
id|tmp
op_or_assign
l_int|128
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;CRT1a: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT1A
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* set VCLK0 */
multiline_comment|/* hardware RefClock: 14.31818 MHz */
multiline_comment|/* formula: VClk = (OSC * N) / (D * (1+P)) */
multiline_comment|/* Example: VClk = (14.31818 * 91) / (23 * (1+1)) = 28.325 MHz */
id|WSeq
c_func
(paren
id|SEQRB
comma
id|_par-&gt;nom
)paren
suffix:semicolon
id|tmp
op_assign
id|_par-&gt;den
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;div
op_ne
l_int|0
)paren
id|tmp
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_SD64
)paren
id|tmp
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* 6 bit denom; ONLY 5434!!! (bugged me 10 days) */
id|WSeq
c_func
(paren
id|SEQR1B
comma
id|tmp
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT17
comma
l_int|0xc3
)paren
suffix:semicolon
multiline_comment|/* mode control: CRTC enable, ROTATE(?), 16bit address wrap, no compat. */
multiline_comment|/* HAEH?&t;WCrt(CRT11, 0x20);  * previously: 0x00  unlock CRT0..CRT7 */
multiline_comment|/* don&squot;t know if it would hurt to also program this if no interlaced */
multiline_comment|/* mode is used, but I feel better this way.. :-) */
r_if
c_cond
(paren
id|_par-&gt;var.vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
id|WCrt
c_func
(paren
id|CRT19
comma
id|_par-&gt;HorizTotal
op_div
l_int|2
)paren
suffix:semicolon
r_else
id|WCrt
c_func
(paren
id|CRT19
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* interlace control */
id|WSeq
c_func
(paren
id|SEQR3
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* adjust horizontal/vertical sync type (low/high) */
id|tmp
op_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* enable display memory &amp; CRTC I/O address for color mode */
r_if
c_cond
(paren
id|_par-&gt;var.sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
id|tmp
op_or_assign
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
id|_par-&gt;var.sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
id|tmp
op_or_assign
l_int|0x80
suffix:semicolon
id|WGen
c_func
(paren
id|MISC_W
comma
id|tmp
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT8
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Screen A Preset Row-Scan register */
id|WCrt
c_func
(paren
id|CRTA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* text cursor on and start line */
id|WCrt
c_func
(paren
id|CRTB
comma
l_int|31
)paren
suffix:semicolon
multiline_comment|/* text cursor end line */
multiline_comment|/* programming for different color depths */
r_if
c_cond
(paren
id|_par-&gt;var.bits_per_pixel
op_eq
l_int|1
)paren
(brace
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: preparing for 1 bit deep display&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* restore first 2 color registers for mono mode */
id|WClut
c_func
(paren
l_int|0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* background: black */
id|WClut
c_func
(paren
l_int|1
comma
l_int|0x3f
comma
l_int|0x3f
comma
l_int|0x3f
)paren
suffix:semicolon
multiline_comment|/* foreground: white */
macro_line|#endif
id|WGfx
c_func
(paren
id|GR5
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* mode register */
multiline_comment|/* Extended Sequencer Mode */
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
multiline_comment|/* setting the SEQRF on SD64 is not necessary (only during init) */
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;(for SD64)&bslash;n&quot;
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0xf0
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x1a
)paren
suffix:semicolon
multiline_comment|/*  MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;(for Piccolo)&bslash;n&quot;
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* ### ueberall 0x22? */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ##vorher 1c MCLK select */
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* evtl d0 bei 1 bit? avoid FIFO underruns..? */
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;(for Picasso)&bslash;n&quot;
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x20
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ##vorher 22 MCLK select */
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xd0
)paren
suffix:semicolon
multiline_comment|/* ## vorher d0 avoid FIFO underruns..? */
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;(for Spectrum)&bslash;n&quot;
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* ### ueberall 0x22? */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ##vorher 1c MCLK select */
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* evtl d0? avoid FIFO underruns..? */
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;(for Picasso 4)&bslash;n&quot;
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/*&t;    WSeq(SEQR1F, 0x1c); */
multiline_comment|/* SEQRF not being set here...&t;WSeq(SEQRF, 0xd0); */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;clgen: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|WGen
c_func
(paren
id|M_3C6
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* pixel mask: pass-through for first plane */
id|WHDR
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* hidden dac reg: nothing special */
id|WSeq
c_func
(paren
id|SEQR4
comma
l_int|0x06
)paren
suffix:semicolon
multiline_comment|/* memory mode: odd/even, ext. memory */
id|WSeq
c_func
(paren
id|SEQR2
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* plane mask: only write to first plane */
id|offset
op_assign
id|_par-&gt;var.xres_virtual
op_div
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|_par-&gt;var.bits_per_pixel
op_eq
l_int|8
)paren
(brace
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: preparing for 8 bit deep display&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0xf1
)paren
suffix:semicolon
multiline_comment|/* Extended Sequencer Mode: 256c col. mode */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x1d
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x81
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ### vorher 1c MCLK select */
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x21
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ### vorher 1c MCLK select */
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x81
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* ### vorher 1c MCLK select */
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x21
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb8
)paren
suffix:semicolon
multiline_comment|/* ### INCOMPLETE!! */
multiline_comment|/*&t;    WSeq(SEQR1F, 0x1c); */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;clgen: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|WGfx
c_func
(paren
id|GR5
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* mode register: 256 color mode */
id|WGen
c_func
(paren
id|M_3C6
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* pixel mask: pass-through all planes */
id|WHDR
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* hidden dac reg: nothing special */
id|WSeq
c_func
(paren
id|SEQR4
comma
l_int|0x0a
)paren
suffix:semicolon
multiline_comment|/* memory mode: chain4, ext. memory */
id|WSeq
c_func
(paren
id|SEQR2
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* plane mask: enable writing to all 4 planes */
id|offset
op_assign
id|_par-&gt;var.xres_virtual
op_div
l_int|8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|_par-&gt;var.bits_per_pixel
op_eq
l_int|16
)paren
(brace
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: preparing for 16 bit deep display&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0xf7
)paren
suffix:semicolon
multiline_comment|/* Extended Sequencer Mode: 256c col. mode */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x1e
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x87
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x27
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x87
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x27
)paren
suffix:semicolon
multiline_comment|/*&t;    WSeq(SEQR1F, 0x1c);  */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CLGEN: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|WGfx
c_func
(paren
id|GR5
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* mode register: 256 color mode */
id|WGen
c_func
(paren
id|M_3C6
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* pixel mask: pass-through all planes */
id|WHDR
c_func
(paren
l_int|0xa0
)paren
suffix:semicolon
multiline_comment|/* hidden dac reg: nothing special */
id|WSeq
c_func
(paren
id|SEQR4
comma
l_int|0x0a
)paren
suffix:semicolon
multiline_comment|/* memory mode: chain4, ext. memory */
id|WSeq
c_func
(paren
id|SEQR2
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* plane mask: enable writing to all 4 planes */
id|offset
op_assign
id|_par-&gt;var.xres_virtual
op_div
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|_par-&gt;var.bits_per_pixel
op_eq
l_int|32
)paren
(brace
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: preparing for 24/32 bit deep display&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0xf9
)paren
suffix:semicolon
multiline_comment|/* Extended Sequencer Mode: 256c col. mode */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x1e
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x85
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x25
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x85
)paren
suffix:semicolon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* Fast Page-Mode writes */
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
multiline_comment|/* MCLK select */
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x25
)paren
suffix:semicolon
multiline_comment|/*&t;    WSeq(SEQR1F, 0x1c);  */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;clgen: unknown Board&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|WGfx
c_func
(paren
id|GR5
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* mode register: 256 color mode */
id|WGen
c_func
(paren
id|M_3C6
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* pixel mask: pass-through all planes */
id|WHDR
c_func
(paren
l_int|0xc5
)paren
suffix:semicolon
multiline_comment|/* hidden dac reg: 8-8-8 mode (24 or 32) */
id|WSeq
c_func
(paren
id|SEQR4
comma
l_int|0x0a
)paren
suffix:semicolon
multiline_comment|/* memory mode: chain4, ext. memory */
id|WSeq
c_func
(paren
id|SEQR2
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* plane mask: enable writing to all 4 planes */
id|offset
op_assign
id|_par-&gt;var.xres_virtual
op_div
l_int|4
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;clgen: What&squot;s this?? requested color depth == %d.&bslash;n&quot;
comma
id|_par-&gt;var.bits_per_pixel
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT13
comma
id|offset
op_amp
l_int|0xff
)paren
suffix:semicolon
id|tmp
op_assign
l_int|0x22
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_amp
l_int|0x100
)paren
id|tmp
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* offset overflow bit */
id|WCrt
c_func
(paren
id|CRT1B
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* screen start addr #16-18, fastpagemode cycles */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_SD64
op_logical_or
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO4
)paren
id|WCrt
c_func
(paren
id|CRT1D
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* screen start address bit 19 */
id|WCrt
c_func
(paren
id|CRTE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* text cursor location high */
id|WCrt
c_func
(paren
id|CRTF
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* text cursor location low */
id|WCrt
c_func
(paren
id|CRT14
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* underline row scanline = at very bottom */
id|WAttr
c_func
(paren
id|AR10
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* controller mode */
id|WAttr
c_func
(paren
id|AR11
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* overscan (border) color */
id|WAttr
c_func
(paren
id|AR12
comma
l_int|15
)paren
suffix:semicolon
multiline_comment|/* color plane enable */
id|WAttr
c_func
(paren
id|AR33
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* pixel panning */
id|WAttr
c_func
(paren
id|AR14
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* color select */
multiline_comment|/* [ EGS: SetOffset(); ] */
multiline_comment|/* From SetOffset(): Turn on VideoEnable bit in Attribute controller */
id|AttrOn
c_func
(paren
)paren
suffix:semicolon
id|WGfx
c_func
(paren
id|GR0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set/reset register */
id|WGfx
c_func
(paren
id|GR1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set/reset enable */
id|WGfx
c_func
(paren
id|GR2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* color compare */
id|WGfx
c_func
(paren
id|GR3
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* data rotate */
id|WGfx
c_func
(paren
id|GR4
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* read map select */
id|WGfx
c_func
(paren
id|GR6
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* miscellaneous register */
id|WGfx
c_func
(paren
id|GR7
comma
l_int|15
)paren
suffix:semicolon
multiline_comment|/* color don&squot;t care */
id|WGfx
c_func
(paren
id|GR8
comma
l_int|255
)paren
suffix:semicolon
multiline_comment|/* bit mask */
id|WSeq
c_func
(paren
id|SEQR12
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* graphics cursor attributes: nothing special */
multiline_comment|/* finally, turn on everything - turn off &quot;FullBandwidth&quot; bit */
multiline_comment|/* also, set &quot;DotClock%2&quot; bit where requested */
id|tmp
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/*** FB_VMODE_CLOCK_HALVE in linux/fb.h not defined anymore ?&n;    if (var-&gt;vmode &amp; FB_VMODE_CLOCK_HALVE)&n;&t;tmp |= 0x08;&n;*/
id|WSeq
c_func
(paren
id|SEQR1
comma
id|tmp
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;SEQR1: %d&bslash;n&quot;
comma
id|tmp
)paren
suffix:semicolon
macro_line|#if 0
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: clearing display...&quot;
)paren
suffix:semicolon
id|clgen_RectFill
c_func
(paren
l_int|0
comma
l_int|0
comma
id|_par-&gt;HorizRes
comma
id|_par-&gt;VertRes
comma
l_int|0
comma
id|_par-&gt;line_length
)paren
suffix:semicolon
id|clgen_WaitBLT
c_func
(paren
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;done.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|fb_info-&gt;currentmode
op_assign
op_star
id|_par
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;virtual offset: (%d,%d)&bslash;n&quot;
comma
id|_par-&gt;var.xoffset
comma
id|_par-&gt;var.yoffset
)paren
suffix:semicolon
multiline_comment|/* pan to requested offset */
id|clgen_pan_display
(paren
op_amp
id|fb_info-&gt;currentmode.var
comma
(paren
r_struct
id|fb_info_gen
op_star
)paren
id|fb_info
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
l_string|&quot;&lt;clgen_set_par()&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|clgen_getcolreg
r_static
r_int
id|clgen_getcolreg
c_func
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_char
id|bred
comma
id|bgreen
comma
id|bblue
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
id|fb_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|info
suffix:semicolon
id|RClut
c_func
(paren
id|regno
comma
op_amp
id|bred
comma
op_amp
id|bgreen
comma
op_amp
id|bblue
)paren
suffix:semicolon
op_star
id|red
op_assign
(paren
id|bred
op_lshift
l_int|10
)paren
op_or
(paren
id|bred
op_lshift
l_int|4
)paren
op_or
(paren
id|bred
op_rshift
l_int|2
)paren
suffix:semicolon
op_star
id|green
op_assign
(paren
id|bgreen
op_lshift
l_int|10
)paren
op_or
(paren
id|bgreen
op_lshift
l_int|4
)paren
op_or
(paren
id|bgreen
op_rshift
l_int|2
)paren
suffix:semicolon
op_star
id|blue
op_assign
(paren
id|bblue
op_lshift
l_int|10
)paren
op_or
(paren
id|bblue
op_lshift
l_int|4
)paren
op_or
(paren
id|bblue
op_rshift
l_int|2
)paren
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|clgen_setcolreg
r_static
r_int
id|clgen_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
id|fb_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|info
suffix:semicolon
multiline_comment|/* &quot;transparent&quot; stuff is completely ignored. */
id|WClut
c_func
(paren
id|regno
comma
id|red
op_rshift
l_int|10
comma
id|green
op_rshift
l_int|10
comma
id|blue
op_rshift
l_int|10
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*************************************************************************&n;&t;clgen_pan_display()&n;&n;&t;performs display panning - provided hardware permits this&n;**************************************************************************/
DECL|function|clgen_pan_display
r_static
r_int
id|clgen_pan_display
c_func
(paren
r_const
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
r_int
id|xoffset
op_assign
l_int|0
suffix:semicolon
r_int
id|yoffset
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
r_int
r_char
id|tmp
op_assign
l_int|0
comma
id|tmp2
op_assign
l_int|0
comma
id|xpix
suffix:semicolon
id|fb_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|fb_info
suffix:semicolon
multiline_comment|/* no range checks for xoffset and yoffset,   */
multiline_comment|/* as fbgen_pan_display has already done this */
id|fb_info-&gt;currentmode.var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|fb_info-&gt;currentmode.var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
id|xoffset
op_assign
id|var-&gt;xoffset
op_star
id|fb_info-&gt;currentmode.var.bits_per_pixel
op_div
l_int|8
suffix:semicolon
id|yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
id|base
op_assign
id|yoffset
op_star
id|fb_info-&gt;currentmode.line_length
op_plus
id|xoffset
suffix:semicolon
r_if
c_cond
(paren
id|fb_info-&gt;currentmode.var.bits_per_pixel
op_eq
l_int|1
)paren
(brace
multiline_comment|/* base is already correct */
id|xpix
op_assign
(paren
r_int
r_char
)paren
(paren
id|var-&gt;xoffset
op_mod
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|base
op_div_assign
l_int|4
suffix:semicolon
id|xpix
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|xoffset
op_mod
l_int|4
)paren
op_star
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* lower 8 + 8 bits of screen start address */
id|WCrt
c_func
(paren
id|CRTD
comma
(paren
r_int
r_char
)paren
(paren
id|base
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|WCrt
c_func
(paren
id|CRTC
comma
(paren
r_int
r_char
)paren
(paren
id|base
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* construct bits 16, 17 and 18 of screen start address */
r_if
c_cond
(paren
id|base
op_amp
l_int|0x10000
)paren
id|tmp
op_or_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|base
op_amp
l_int|0x20000
)paren
id|tmp
op_or_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
id|base
op_amp
l_int|0x40000
)paren
id|tmp
op_or_assign
l_int|0x08
suffix:semicolon
id|tmp2
op_assign
(paren
id|RCrt
c_func
(paren
id|CRT1B
)paren
op_amp
l_int|0xf2
)paren
op_or
id|tmp
suffix:semicolon
multiline_comment|/* 0xf2 is %11110010, exclude tmp bits */
id|WCrt
c_func
(paren
id|CRT1B
comma
id|tmp2
)paren
suffix:semicolon
multiline_comment|/* construct bit 19 of screen start address (only on SD64) */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_SD64
op_logical_or
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO4
)paren
(brace
id|tmp2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|base
op_amp
l_int|0x80000
)paren
id|tmp2
op_assign
l_int|0x80
suffix:semicolon
id|WCrt
c_func
(paren
id|CRT1D
comma
id|tmp2
)paren
suffix:semicolon
)brace
multiline_comment|/* write pixel panning value to AR33; this does not quite work in 8bpp */
multiline_comment|/* ### Piccolo..? Will this work? */
r_if
c_cond
(paren
id|fb_info-&gt;currentmode.var.bits_per_pixel
op_eq
l_int|1
)paren
id|WAttr
c_func
(paren
id|AR33
comma
id|xpix
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|clgen_blank
r_static
r_int
id|clgen_blank
c_func
(paren
r_int
id|blank_mode
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&gt;clgen_blank(%d)&bslash;n&quot;
comma
id|blank_mode
)paren
suffix:semicolon
id|fb_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|info
suffix:semicolon
id|val
op_assign
id|RSeq
c_func
(paren
id|SEQR1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blank_mode
)paren
id|WSeq
c_func
(paren
id|SEQR1
comma
id|val
op_or
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* set &quot;FullBandwidth&quot; bit */
r_else
id|WSeq
c_func
(paren
id|SEQR1
comma
id|val
op_amp
l_int|0xdf
)paren
suffix:semicolon
multiline_comment|/* clear &quot;FullBandwidth&quot; bit */
id|printk
c_func
(paren
l_string|&quot;&lt;clgen_blank()&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**** END   Hardware specific Routines **************************************/
multiline_comment|/****************************************************************************/
multiline_comment|/**** BEGIN Internal Routines ***********************************************/
DECL|function|init_vgachip
r_static
r_void
id|init_vgachip
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&gt;init_vgachip()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* reset board globally */
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSFR
c_func
(paren
l_int|0x1f
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|WSFR
c_func
(paren
l_int|0x4f
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|WSFR
c_func
(paren
l_int|0x01
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|WSFR
c_func
(paren
l_int|0x51
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|WSFR2
c_func
(paren
l_int|0xff
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSFR
c_func
(paren
l_int|0x1f
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|WSFR
c_func
(paren
l_int|0x4f
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
id|WCrt
c_func
(paren
id|CRT51
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* disable flickerfixer */
id|udelay
c_func
(paren
l_int|100000
)paren
suffix:semicolon
id|WGfx
c_func
(paren
id|GR2F
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* from Klaus&squot; NetBSD driver: */
id|WGfx
c_func
(paren
id|GR33
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* put blitter into 542x compat */
id|WGfx
c_func
(paren
id|GR31
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* mode */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;clgen: Warning: Unknown board type&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* &quot;pre-set&quot; a RAMsize; if the test succeeds, double it */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_SD64
op_logical_or
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO4
)paren
id|fb_info-&gt;size
op_assign
l_int|0x400000
suffix:semicolon
r_else
id|fb_info-&gt;size
op_assign
l_int|0x200000
suffix:semicolon
multiline_comment|/* assume it&squot;s a &quot;large memory&quot; board (2/4 MB) */
id|fb_info-&gt;smallboard
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* the P4 is not fully initialized here; I rely on it having been */
multiline_comment|/* inited under AmigaOS already, which seems to work just fine    */
multiline_comment|/* (Klaus advised to do it this way)                              */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_ne
id|BT_PICASSO4
)paren
(brace
id|WGen
c_func
(paren
id|VSSM
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* EGS: 0x16 */
id|WGen
c_func
(paren
id|POS102
comma
l_int|0x01
)paren
suffix:semicolon
id|WGen
c_func
(paren
id|VSSM
comma
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* EGS: 0x0e */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_ne
id|BT_SD64
)paren
(brace
id|WGen
c_func
(paren
id|VSSM2
comma
l_int|0x01
)paren
suffix:semicolon
)brace
id|WSeq
c_func
(paren
id|SEQR0
comma
l_int|0x03
)paren
suffix:semicolon
multiline_comment|/* reset sequencer logic */
id|WSeq
c_func
(paren
id|SEQR1
comma
l_int|0x21
)paren
suffix:semicolon
multiline_comment|/* FullBandwidth (video off) and 8/9 dot clock */
id|WGen
c_func
(paren
id|MISC_W
comma
l_int|0xc1
)paren
suffix:semicolon
multiline_comment|/* polarity (-/-), disable access to display memory, CRTC base address: color */
multiline_comment|/*&t;WGfx(GRA, 0xce);    &quot;magic cookie&quot; - doesn&squot;t make any sense to me.. */
id|WSeq
c_func
(paren
id|SEQR6
comma
l_int|0x12
)paren
suffix:semicolon
multiline_comment|/* unlock all extension registers */
id|WGfx
c_func
(paren
id|GR31
comma
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* reset blitter */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_SD64
)paren
(brace
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb8
)paren
suffix:semicolon
multiline_comment|/* 4 MB Ram SD64, disable CRT fifo(!), 64 bit bus */
)brace
r_else
(brace
id|WSeq
c_func
(paren
id|SEQR16
comma
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* Perf. Tuning: Fix value..(?) */
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0xb0
)paren
suffix:semicolon
multiline_comment|/* 2 MB DRAM, 8level write buffer, 32bit bus */
)brace
)brace
id|WSeq
c_func
(paren
id|SEQR2
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* plane mask: nothing */
id|WSeq
c_func
(paren
id|SEQR3
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* character map select: doesn&squot;t even matter in gx mode */
id|WSeq
c_func
(paren
id|SEQR4
comma
l_int|0x0e
)paren
suffix:semicolon
multiline_comment|/* memory mode: chain-4, no odd/even, ext. memory */
multiline_comment|/* controller-internal base address of video memory */
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0xf0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICASSO
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
id|WSeq
c_func
(paren
id|SEQR7
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*  WSeq(SEQR8, 0x00);*/
multiline_comment|/* EEPROM control: shouldn&squot;t be necessary to write to this at all.. */
id|WSeq
c_func
(paren
id|SEQR10
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* graphics cursor X position (incomplete; position gives rem. 3 bits */
id|WSeq
c_func
(paren
id|SEQR11
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* graphics cursor Y position (...&quot;... ) */
id|WSeq
c_func
(paren
id|SEQR12
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* graphics cursor attributes */
id|WSeq
c_func
(paren
id|SEQR13
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* graphics cursor pattern address */
multiline_comment|/* writing these on a P4 might give problems..  */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_ne
id|BT_PICASSO4
)paren
(brace
id|WSeq
c_func
(paren
id|SEQR17
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* configuration readback and ext. color */
id|WSeq
c_func
(paren
id|SEQR18
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* signature generator */
)brace
multiline_comment|/* MCLK select etc. */
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_PICCOLO
suffix:colon
r_case
id|BT_PICASSO
suffix:colon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x22
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_SD64
suffix:colon
id|WSeq
c_func
(paren
id|SEQR1F
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICASSO4
suffix:colon
multiline_comment|/*WSeq(SEQR1F, 0x1c); */
r_break
suffix:semicolon
)brace
id|WCrt
c_func
(paren
id|CRT8
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Screen A preset row scan: none */
id|WCrt
c_func
(paren
id|CRTA
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* Text cursor start: disable text cursor */
id|WCrt
c_func
(paren
id|CRTB
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Text cursor end: - */
id|WCrt
c_func
(paren
id|CRTC
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Screen start address high: 0 */
id|WCrt
c_func
(paren
id|CRTD
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Screen start address low: 0 */
id|WCrt
c_func
(paren
id|CRTE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* text cursor location high: 0 */
id|WCrt
c_func
(paren
id|CRTF
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* text cursor location low: 0 */
id|WCrt
c_func
(paren
id|CRT14
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Underline Row scanline: - */
id|WCrt
c_func
(paren
id|CRT17
comma
l_int|0xc3
)paren
suffix:semicolon
multiline_comment|/* mode control: timing enable, byte mode, no compat modes */
id|WCrt
c_func
(paren
id|CRT18
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Line Compare: not needed */
multiline_comment|/* ### add 0x40 for text modes with &gt; 30 MHz pixclock */
id|WCrt
c_func
(paren
id|CRT1B
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* ext. display controls: ext.adr. wrap */
id|WGfx
c_func
(paren
id|GR0
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Set/Reset registes: - */
id|WGfx
c_func
(paren
id|GR1
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Set/Reset enable: - */
id|WGfx
c_func
(paren
id|GR2
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Color Compare: - */
id|WGfx
c_func
(paren
id|GR3
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Data Rotate: - */
id|WGfx
c_func
(paren
id|GR4
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Read Map Select: - */
id|WGfx
c_func
(paren
id|GR5
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Mode: conf. for 16/4/2 color mode, no odd/even, read/write mode 0 */
id|WGfx
c_func
(paren
id|GR6
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous: memory map base address, graphics mode */
id|WGfx
c_func
(paren
id|GR7
comma
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* Color Don&squot;t care: involve all planes */
id|WGfx
c_func
(paren
id|GR8
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Bit Mask: no mask at all */
id|WGfx
c_func
(paren
id|GRB
comma
l_int|0x28
)paren
suffix:semicolon
multiline_comment|/* Graphics controller mode extensions: finer granularity, 8byte data latches */
id|WGfx
c_func
(paren
id|GRC
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Color Key compare: - */
id|WGfx
c_func
(paren
id|GRD
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Color Key compare mask: - */
id|WGfx
c_func
(paren
id|GRE
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous control: - */
multiline_comment|/*  WGfx(GR10, 0x00);*/
multiline_comment|/* Background color byte 1: - */
multiline_comment|/*  WGfx(GR11, 0x00); */
id|WAttr
c_func
(paren
id|AR0
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Attribute Controller palette registers: &quot;identity mapping&quot; */
id|WAttr
c_func
(paren
id|AR1
comma
l_int|0x01
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|AR2
comma
l_int|0x02
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|AR3
comma
l_int|0x03
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|AR4
comma
l_int|0x04
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|AR5
comma
l_int|0x05
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|AR6
comma
l_int|0x06
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|AR7
comma
l_int|0x07
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|AR8
comma
l_int|0x08
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|AR9
comma
l_int|0x09
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|ARA
comma
l_int|0x0a
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|ARB
comma
l_int|0x0b
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|ARC
comma
l_int|0x0c
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|ARD
comma
l_int|0x0d
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|ARE
comma
l_int|0x0e
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|ARF
comma
l_int|0x0f
)paren
suffix:semicolon
id|WAttr
c_func
(paren
id|AR10
comma
l_int|0x01
)paren
suffix:semicolon
multiline_comment|/* Attribute Controller mode: graphics mode */
id|WAttr
c_func
(paren
id|AR11
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Overscan color reg.: reg. 0 */
id|WAttr
c_func
(paren
id|AR12
comma
l_int|0x0f
)paren
suffix:semicolon
multiline_comment|/* Color Plane enable: Enable all 4 planes */
multiline_comment|/* ### &t;WAttr(AR33, 0x00); * Pixel Panning: - */
id|WAttr
c_func
(paren
id|AR14
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Color Select: - */
id|WGen
c_func
(paren
id|M_3C6
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Pixel mask: no mask */
id|WGen
c_func
(paren
id|MISC_W
comma
l_int|0xc3
)paren
suffix:semicolon
multiline_comment|/* polarity (-/-), enable display mem, CRTC i/o base = color */
id|WGfx
c_func
(paren
id|GR31
comma
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* BLT Start/status: Blitter reset */
id|WGfx
c_func
(paren
id|GR31
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* - &quot; -           : &quot;end-of-reset&quot; */
multiline_comment|/* CLUT setup */
id|WClut
c_func
(paren
l_int|0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* background: black */
id|WClut
c_func
(paren
l_int|1
comma
l_int|0x3f
comma
l_int|0x3f
comma
l_int|0x3f
)paren
suffix:semicolon
multiline_comment|/* foreground: white */
id|WClut
c_func
(paren
l_int|2
comma
l_int|0x00
comma
l_int|0x20
comma
l_int|0x00
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|3
comma
l_int|0x00
comma
l_int|0x20
comma
l_int|0x20
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|4
comma
l_int|0x20
comma
l_int|0x00
comma
l_int|0x00
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|5
comma
l_int|0x20
comma
l_int|0x00
comma
l_int|0x20
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|6
comma
l_int|0x20
comma
l_int|0x10
comma
l_int|0x00
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|7
comma
l_int|0x20
comma
l_int|0x20
comma
l_int|0x20
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|8
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x10
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|9
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x30
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|10
comma
l_int|0x10
comma
l_int|0x30
comma
l_int|0x10
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|11
comma
l_int|0x10
comma
l_int|0x30
comma
l_int|0x30
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|12
comma
l_int|0x30
comma
l_int|0x10
comma
l_int|0x10
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|13
comma
l_int|0x30
comma
l_int|0x10
comma
l_int|0x30
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|14
comma
l_int|0x30
comma
l_int|0x30
comma
l_int|0x10
)paren
suffix:semicolon
id|WClut
c_func
(paren
l_int|15
comma
l_int|0x30
comma
l_int|0x30
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* the rest a grey ramp */
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
id|WClut
c_func
(paren
id|i
comma
id|i
op_rshift
l_int|2
comma
id|i
op_rshift
l_int|2
comma
id|i
op_rshift
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* misc... */
id|WHDR
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Hidden DAC register: - */
macro_line|#if 0
multiline_comment|/* check for 1/2 MB Piccolo/Picasso/Spectrum resp. 2/4 MB SD64 */
multiline_comment|/* DRAM register has already been pre-set for &quot;large&quot;, so it is*/
multiline_comment|/* only modified if we find that this is a &quot;small&quot; version */
(brace
r_int
r_volatile
r_char
op_star
id|ram
op_assign
id|fb_info-&gt;fbmem
suffix:semicolon
r_int
id|i
comma
id|flag
op_assign
l_int|0
suffix:semicolon
id|ram
op_add_assign
(paren
id|fb_info-&gt;size
op_rshift
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
id|ram
(braket
id|i
)braket
op_assign
(paren
r_int
r_char
)paren
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ram
(braket
id|i
)braket
op_ne
id|i
)paren
id|flag
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* if the DRAM test failed, halve RAM value */
r_if
c_cond
(paren
id|flag
)paren
(brace
id|fb_info-&gt;size
op_div_assign
l_int|2
suffix:semicolon
id|fb_info-&gt;smallboard
op_assign
id|TRUE
suffix:semicolon
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0x38
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 2 MB Ram SD64 */
r_case
id|BT_PICASSO4
suffix:colon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0x38
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* ### like SD64? */
r_case
id|BT_PICCOLO
suffix:colon
r_case
id|BT_PICASSO
suffix:colon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSeq
c_func
(paren
id|SEQRF
comma
l_int|0x30
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 1 MB DRAM */
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;clgen: Uuhh..could not determine RAM size!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: This board has %ld bytes of DRAM memory&bslash;n&quot;
comma
id|fb_info-&gt;size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&lt;init_vgachip()&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|switch_monitor
r_static
r_void
id|switch_monitor
c_func
(paren
r_int
id|on
)paren
(brace
r_static
r_int
id|IsOn
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX not ok for multiple boards */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO4
)paren
r_return
suffix:semicolon
multiline_comment|/* nothing to switch */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
r_if
c_cond
(paren
(paren
id|on
op_logical_and
op_logical_neg
id|IsOn
)paren
op_logical_or
(paren
op_logical_neg
id|on
op_logical_and
id|IsOn
)paren
)paren
id|WSFR
c_func
(paren
l_int|0xff
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|on
)paren
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSFR
c_func
(paren
id|fb_info-&gt;SFR
op_or
l_int|0x21
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|WSFR
c_func
(paren
id|fb_info-&gt;SFR
op_or
l_int|0x28
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSFR
c_func
(paren
l_int|0x6f
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|fb_info-&gt;btype
)paren
(brace
r_case
id|BT_SD64
suffix:colon
id|WSFR
c_func
(paren
id|fb_info-&gt;SFR
op_amp
l_int|0xde
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_PICCOLO
suffix:colon
id|WSFR
c_func
(paren
id|fb_info-&gt;SFR
op_amp
l_int|0xd7
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_SPECTRUM
suffix:colon
id|WSFR
c_func
(paren
l_int|0x4f
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|clgen_set_dispsw
r_static
r_void
id|clgen_set_dispsw
c_func
(paren
r_const
r_void
op_star
id|par
comma
r_struct
id|display
op_star
id|disp
comma
r_struct
id|fb_info_gen
op_star
id|info
)paren
(brace
r_struct
id|clgenfb_par
op_star
id|_par
op_assign
(paren
r_struct
id|clgenfb_par
op_star
)paren
id|par
suffix:semicolon
r_struct
id|clgenfb_info
op_star
id|info2
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|info
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;clgen_get_dispsw(): &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|_par-&gt;var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_MFB
r_case
l_int|1
suffix:colon
id|printk
c_func
(paren
l_string|&quot;monochrome&bslash;n&quot;
)paren
suffix:semicolon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_mfb
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|printk
c_func
(paren
l_string|&quot;8 bit color depth&bslash;n&quot;
)paren
suffix:semicolon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_clgen_8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|printk
c_func
(paren
l_string|&quot;16 bit color depth&bslash;n&quot;
)paren
suffix:semicolon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
id|info2-&gt;fbcon_cmap.cfb16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB24
r_case
l_int|24
suffix:colon
id|printk
c_func
(paren
l_string|&quot;24 bit color depth&bslash;n&quot;
)paren
suffix:semicolon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb24
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
id|info2-&gt;fbcon_cmap.cfb24
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB32
r_case
l_int|32
suffix:colon
id|printk
c_func
(paren
l_string|&quot;32 bit color depth&bslash;n&quot;
)paren
suffix:semicolon
id|disp-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb32
suffix:semicolon
id|disp-&gt;dispsw_data
op_assign
id|info2-&gt;fbcon_cmap.cfb32
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;unsupported color depth&bslash;n&quot;
)paren
suffix:semicolon
id|disp-&gt;dispsw
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|fbcon_clgen8_bmove
r_static
r_void
id|fbcon_clgen8_bmove
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
id|sx
op_mul_assign
id|fontwidth
c_func
(paren
id|p
)paren
suffix:semicolon
id|sy
op_mul_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|dx
op_mul_assign
id|fontwidth
c_func
(paren
id|p
)paren
suffix:semicolon
id|dy
op_mul_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|width
op_mul_assign
id|fontwidth
c_func
(paren
id|p
)paren
suffix:semicolon
id|height
op_mul_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|fb_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|p-&gt;fb_info
suffix:semicolon
id|clgen_BitBLT
c_func
(paren
(paren
r_int
r_int
)paren
id|sx
comma
(paren
r_int
r_int
)paren
id|sy
comma
(paren
r_int
r_int
)paren
id|dx
comma
(paren
r_int
r_int
)paren
id|dy
comma
(paren
r_int
r_int
)paren
id|width
comma
(paren
r_int
r_int
)paren
id|height
comma
id|fb_info-&gt;currentmode.line_length
)paren
suffix:semicolon
id|clgen_WaitBLT
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|fbcon_clgen8_clear
r_static
r_void
id|fbcon_clgen8_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_int
r_int
id|col
suffix:semicolon
id|fb_info
op_assign
(paren
r_struct
id|clgenfb_info
op_star
)paren
id|p-&gt;fb_info
suffix:semicolon
id|sx
op_mul_assign
id|fontwidth
c_func
(paren
id|p
)paren
suffix:semicolon
id|sy
op_mul_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|width
op_mul_assign
id|fontwidth
c_func
(paren
id|p
)paren
suffix:semicolon
id|height
op_mul_assign
id|fontheight
c_func
(paren
id|p
)paren
suffix:semicolon
id|col
op_assign
id|attr_bgcol_ec
c_func
(paren
id|p
comma
id|conp
)paren
suffix:semicolon
id|col
op_and_assign
l_int|0xff
suffix:semicolon
id|clgen_RectFill
c_func
(paren
(paren
r_int
r_int
)paren
id|sx
comma
(paren
r_int
r_int
)paren
id|sy
comma
(paren
r_int
r_int
)paren
id|width
comma
(paren
r_int
r_int
)paren
id|height
comma
id|col
comma
id|fb_info-&gt;currentmode.line_length
)paren
suffix:semicolon
id|clgen_WaitBLT
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/********************************************************************/
multiline_comment|/* clgenfb_init() - master initialization function                  */
multiline_comment|/********************************************************************/
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|clgenfb_init
c_func
(paren
r_void
)paren
)paren
(brace
r_const
r_struct
id|ConfigDev
op_star
id|cd
op_assign
l_int|NULL
suffix:semicolon
r_const
r_struct
id|ConfigDev
op_star
id|cd2
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|btype
suffix:semicolon
r_int
id|key
comma
id|key2
suffix:semicolon
r_int
r_int
id|board_addr
comma
id|board_size
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&gt;clgenfb_init()&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: Driver for Cirrus Logic based graphic boards, v&quot;
id|CLGEN_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|btype
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|key
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_HELFRICH_SD64_RAM
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
(brace
id|key2
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_HELFRICH_SD64_REG
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|btype
op_assign
id|BT_SD64
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: SD64 board detected; &quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|key
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_HELFRICH_PICCOLO_RAM
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
(brace
id|key2
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_HELFRICH_PICCOLO_REG
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|btype
op_assign
id|BT_PICCOLO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: Piccolo board detected; &quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|key
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_VILLAGE_TRONIC_PICASSO_II_II_PLUS_RAM
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
(brace
id|key2
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_VILLAGE_TRONIC_PICASSO_II_II_PLUS_REG
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|btype
op_assign
id|BT_PICASSO
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: Picasso II board detected; &quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|key
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_GVP_EGS_28_24_SPECTRUM_RAM
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
(brace
id|key2
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_GVP_EGS_28_24_SPECTRUM_REG
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|btype
op_assign
id|BT_SPECTRUM
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: Spectrum board detected; &quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|key
op_assign
id|zorro_find
c_func
(paren
id|ZORRO_PROD_VILLAGE_TRONIC_PICASSO_IV_Z3
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
(brace
id|btype
op_assign
id|BT_PICASSO4
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: Picasso 4 board detected; &quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;clgen: no supported board found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|fb_info
op_assign
op_amp
id|boards
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* FIXME support multiple boards ...*/
id|fb_info-&gt;keyRAM
op_assign
id|key
suffix:semicolon
id|fb_info-&gt;keyREG
op_assign
id|key2
suffix:semicolon
id|fb_info-&gt;btype
op_assign
id|btype
suffix:semicolon
id|cd
op_assign
id|zorro_get_board
c_func
(paren
id|key
)paren
suffix:semicolon
id|board_addr
op_assign
(paren
r_int
r_int
)paren
id|cd-&gt;cd_BoardAddr
suffix:semicolon
id|board_size
op_assign
(paren
r_int
r_int
)paren
id|cd-&gt;cd_BoardSize
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; RAM (%lu MB) at $%lx, &quot;
comma
id|board_size
op_div
l_int|0x100000
comma
id|board_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btype
op_eq
id|BT_PICASSO4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; REG at $%lx&bslash;n&quot;
comma
id|board_addr
op_plus
l_int|0x600000
)paren
suffix:semicolon
multiline_comment|/* To be precise, for the P4 this is not the */
multiline_comment|/* begin of the board, but the begin of RAM. */
multiline_comment|/* for P4, map in its address space in 2 chunks (### TEST! ) */
multiline_comment|/* (note the ugly hardcoded 16M number) */
id|fb_info-&gt;regs
op_assign
(paren
r_int
r_char
op_star
)paren
id|kernel_map
c_func
(paren
id|board_addr
comma
l_int|16777216
comma
id|KERNELMAP_NOCACHE_SER
comma
l_int|NULL
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: Virtual address for board set to: $%p&bslash;n&quot;
comma
id|fb_info-&gt;regs
)paren
suffix:semicolon
id|fb_info-&gt;regs
op_add_assign
l_int|0x600000
suffix:semicolon
id|fb_info-&gt;fbmem
op_assign
id|kernel_map
c_func
(paren
id|board_addr
op_plus
l_int|16777216
comma
l_int|16777216
comma
id|KERNELMAP_NOCACHE_SER
comma
l_int|NULL
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: (RAM start set to: $%lx)&bslash;n&quot;
comma
id|fb_info-&gt;fbmem
)paren
suffix:semicolon
)brace
r_else
(brace
id|cd2
op_assign
id|zorro_get_board
c_func
(paren
id|key2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; REG at $%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|cd2-&gt;cd_BoardAddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board_addr
OG
l_int|0x01000000
)paren
id|fb_info-&gt;fbmem
op_assign
id|kernel_map
c_func
(paren
id|board_addr
comma
id|board_size
comma
id|KERNELMAP_NOCACHE_SER
comma
l_int|NULL
)paren
suffix:semicolon
r_else
id|fb_info-&gt;fbmem
op_assign
id|ZTWO_VADDR
c_func
(paren
id|board_addr
)paren
suffix:semicolon
multiline_comment|/* set address for REG area of board */
id|fb_info-&gt;regs
op_assign
(paren
r_int
r_char
op_star
)paren
id|ZTWO_VADDR
c_func
(paren
id|cd2-&gt;cd_BoardAddr
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: Virtual address for board set to: $%p&bslash;n&quot;
comma
id|fb_info-&gt;regs
)paren
suffix:semicolon
id|DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;clgen: (RAM start set to: $%lx)&bslash;n&quot;
comma
id|fb_info-&gt;fbmem
)paren
suffix:semicolon
)brace
id|init_vgachip
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* set up a few more things, register framebuffer driver etc */
id|fb_info-&gt;gen.parsize
op_assign
r_sizeof
(paren
r_struct
id|clgenfb_par
)paren
suffix:semicolon
id|fb_info-&gt;gen.fbhw
op_assign
op_amp
id|clgen_hwswitch
suffix:semicolon
id|strcpy
(paren
id|fb_info-&gt;gen.info.modename
comma
id|clgenfb_name
)paren
suffix:semicolon
id|fb_info-&gt;gen.info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info-&gt;gen.info.fbops
op_assign
op_amp
id|clgenfb_ops
suffix:semicolon
id|fb_info-&gt;gen.info.disp
op_assign
op_amp
id|disp
suffix:semicolon
id|fb_info-&gt;gen.info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info-&gt;gen.info.switch_con
op_assign
op_amp
id|fbgen_switch
suffix:semicolon
id|fb_info-&gt;gen.info.updatevar
op_assign
op_amp
id|fbgen_update_var
suffix:semicolon
id|fb_info-&gt;gen.info.blank
op_assign
op_amp
id|fbgen_blank
suffix:semicolon
multiline_comment|/* mark this board as &quot;autoconfigured&quot; */
id|zorro_config_board
c_func
(paren
id|key
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btype
op_ne
id|BT_PICASSO4
)paren
id|zorro_config_board
c_func
(paren
id|key2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* now that we know the board has been registered n&squot; stuff, we */
multiline_comment|/* can finally initialize it to a default mode (640x480) */
id|clgenfb_default
op_assign
id|clgenfb_predefined
(braket
l_int|1
)braket
dot
id|var
suffix:semicolon
id|clgenfb_default.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|clgenfb_default.yres_virtual
op_assign
l_int|480
op_star
l_int|3
suffix:semicolon
multiline_comment|/* for fast scrolling (YPAN-Mode) */
id|err
op_assign
id|fbgen_do_set_var
c_func
(paren
op_amp
id|clgenfb_default
comma
l_int|1
comma
op_amp
id|fb_info-&gt;gen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
suffix:semicolon
id|disp.var
op_assign
id|clgenfb_default
suffix:semicolon
id|fbgen_set_disp
c_func
(paren
op_minus
l_int|1
comma
op_amp
id|fb_info-&gt;gen
)paren
suffix:semicolon
id|fbgen_install_cmap
c_func
(paren
l_int|0
comma
op_amp
id|fb_info-&gt;gen
)paren
suffix:semicolon
id|err
op_assign
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info-&gt;gen.info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;clgen: ERROR - could not register fb device; err = %d!&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&lt;clgenfb_init()&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Cleanup&n;     */
DECL|function|clgenfb_cleanup
r_void
id|clgenfb_cleanup
c_func
(paren
r_struct
id|clgenfb_info
op_star
id|info
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&gt;clgenfb_cleanup()&bslash;n&quot;
)paren
suffix:semicolon
id|fb_info
op_assign
id|info
suffix:semicolon
id|switch_monitor
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|zorro_unconfig_board
c_func
(paren
id|info-&gt;keyRAM
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_ne
id|BT_PICASSO4
)paren
id|zorro_unconfig_board
c_func
(paren
id|info-&gt;keyREG
comma
l_int|0
)paren
suffix:semicolon
id|unregister_framebuffer
c_func
(paren
op_amp
id|info-&gt;gen.info
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Framebuffer unregistered&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&lt;clgenfb_cleanup()&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* A strtok which returns empty strings, too */
DECL|function|strtoke
r_static
r_char
op_star
id|strtoke
c_func
(paren
r_char
op_star
id|s
comma
r_const
r_char
op_star
id|ct
)paren
(brace
r_char
op_star
id|sbegin
comma
op_star
id|send
suffix:semicolon
r_static
r_char
op_star
id|ssave
op_assign
l_int|NULL
suffix:semicolon
id|sbegin
op_assign
id|s
ques
c_cond
id|s
suffix:colon
id|ssave
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbegin
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_star
id|sbegin
op_eq
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|ssave
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|send
op_assign
id|strpbrk
c_func
(paren
id|sbegin
comma
id|ct
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send
op_logical_and
op_star
id|send
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_star
id|send
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|ssave
op_assign
id|send
suffix:semicolon
r_return
id|sbegin
suffix:semicolon
)brace
multiline_comment|/*****************************************************************/
multiline_comment|/* clgenfb_setup() might be used later for parsing possible      */
multiline_comment|/* arguments to the video= bootstrap parameter. Right now, there */
multiline_comment|/* is nothing I do here.                                         */
multiline_comment|/*****************************************************************/
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|clgenfb_setup
c_func
(paren
r_char
op_star
id|options
comma
r_int
op_star
id|ints
)paren
)paren
(brace
singleline_comment|//    char *this_opt;
singleline_comment|//    printk(&quot;clgenfb_setup(): options: %s&bslash;n&quot;, options);&t;
)brace
multiline_comment|/*&n;     *  Modularization&n;     */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;init_module()&bslash;n&quot;
)paren
suffix:semicolon
id|clgenfb_init
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;module_cleanup()&bslash;n&quot;
)paren
suffix:semicolon
id|clgenfb_cleanup
c_func
(paren
id|fb_info
)paren
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/**********************************************************************/
multiline_comment|/* about the following functions - I have used the same names for the */
multiline_comment|/* functions as Markus Wild did in his Retina driver for NetBSD as    */
multiline_comment|/* they just made sense for this purpose. Apart from that, I wrote    */
multiline_comment|/* these functions myself.                                            */
multiline_comment|/**********************************************************************/
multiline_comment|/*** WGen() - write into one of the external/general registers ***/
DECL|function|WGen
r_void
id|WGen
c_func
(paren
r_int
id|regnum
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_volatile
r_char
op_star
id|reg
op_assign
id|fb_info-&gt;regs
op_plus
id|regnum
suffix:semicolon
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
multiline_comment|/* Picasso II specific hack */
multiline_comment|/*&t;&t;if (regnum == M_3C7_W || regnum == M_3C9 || regnum == VSSM2) */
r_if
c_cond
(paren
id|regnum
op_eq
id|M_3C7_W
op_logical_or
id|regnum
op_eq
id|M_3C9
)paren
id|reg
op_add_assign
l_int|0xfff
suffix:semicolon
)brace
op_star
id|reg
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*** RGen() - read out one of the external/general registers ***/
DECL|function|RGen
r_int
r_char
id|RGen
c_func
(paren
r_int
id|regnum
)paren
(brace
r_int
r_volatile
r_char
op_star
id|reg
op_assign
id|fb_info-&gt;regs
op_plus
id|regnum
suffix:semicolon
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
multiline_comment|/* Picasso II specific hack */
multiline_comment|/*&t;&t;if (regnum == M_3C7_W || regnum == M_3C9 || regnum == VSSM2) */
r_if
c_cond
(paren
id|regnum
op_eq
id|M_3C7_W
op_logical_or
id|regnum
op_eq
id|M_3C9
)paren
id|reg
op_add_assign
l_int|0xfff
suffix:semicolon
)brace
r_return
op_star
id|reg
suffix:semicolon
)brace
multiline_comment|/*** WSeq() - write into a register of the sequencer ***/
DECL|function|WSeq
r_void
id|WSeq
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|val
)paren
(brace
id|fb_info-&gt;regs
(braket
id|SEQRX
)braket
op_assign
id|regnum
suffix:semicolon
id|fb_info-&gt;regs
(braket
id|SEQRX
op_plus
l_int|1
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*** RSeq() - read out one of the Sequencer registers ***/
DECL|function|RSeq
r_int
r_char
id|RSeq
c_func
(paren
r_int
r_char
id|regnum
)paren
(brace
id|fb_info-&gt;regs
(braket
id|SEQRX
)braket
op_assign
id|regnum
suffix:semicolon
r_return
id|fb_info-&gt;regs
(braket
id|SEQRX
op_plus
l_int|1
)braket
suffix:semicolon
)brace
multiline_comment|/*** WCrt() - write into a register of the CRT controller ***/
DECL|function|WCrt
r_void
id|WCrt
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|val
)paren
(brace
id|fb_info-&gt;regs
(braket
id|CRTX
)braket
op_assign
id|regnum
suffix:semicolon
id|fb_info-&gt;regs
(braket
id|CRTX
op_plus
l_int|1
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*** RCrt() - read out one of the CRT controller registers ***/
DECL|function|RCrt
r_int
r_char
id|RCrt
c_func
(paren
r_int
r_char
id|regnum
)paren
(brace
id|fb_info-&gt;regs
(braket
id|CRTX
)braket
op_assign
id|regnum
suffix:semicolon
r_return
id|fb_info-&gt;regs
(braket
id|CRTX
op_plus
l_int|1
)braket
suffix:semicolon
)brace
multiline_comment|/*** WGfx() - write into a register of the Gfx controller ***/
DECL|function|WGfx
r_void
id|WGfx
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|val
)paren
(brace
id|fb_info-&gt;regs
(braket
id|GRX
)braket
op_assign
id|regnum
suffix:semicolon
id|fb_info-&gt;regs
(braket
id|GRX
op_plus
l_int|1
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*** RGfx() - read out one of the Gfx controller registers ***/
DECL|function|RGfx
r_int
r_char
id|RGfx
c_func
(paren
r_int
r_char
id|regnum
)paren
(brace
id|fb_info-&gt;regs
(braket
id|GRX
)braket
op_assign
id|regnum
suffix:semicolon
r_return
id|fb_info-&gt;regs
(braket
id|GRX
op_plus
l_int|1
)braket
suffix:semicolon
)brace
multiline_comment|/*** WAttr() - write into a register of the Attribute controller ***/
DECL|function|WAttr
r_void
id|WAttr
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|val
)paren
(brace
multiline_comment|/* if the next access to the attribute controller is a data write access, */
multiline_comment|/* simply write back the information that was already there before, so that */
multiline_comment|/* the next write access after that will be an index write. */
r_if
c_cond
(paren
id|RCrt
c_func
(paren
id|CRT24
)paren
op_amp
l_int|0x80
)paren
multiline_comment|/* can&squot;t use WAttr() here - we would go into a recursive loop otherwise */
id|fb_info-&gt;regs
(braket
id|ARX
)braket
op_assign
id|fb_info-&gt;regs
(braket
id|ARX
op_plus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|RCrt
c_func
(paren
id|CRT24
)paren
op_amp
l_int|0x80
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;clgen: *** AttrIdx BAD!***&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* now, first set index and after that the value - both to the same address (!) */
id|fb_info-&gt;regs
(braket
id|ARX
)braket
op_assign
id|regnum
suffix:semicolon
id|fb_info-&gt;regs
(braket
id|ARX
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*** AttrOn() - turn on VideoEnable for Attribute controller ***/
DECL|function|AttrOn
r_void
id|AttrOn
c_func
(paren
)paren
(brace
r_if
c_cond
(paren
id|RCrt
c_func
(paren
id|CRT24
)paren
op_amp
l_int|0x80
)paren
multiline_comment|/* if we&squot;re just in &quot;write value&quot; mode, write back the */
multiline_comment|/* same value as before to not modify anything */
id|fb_info-&gt;regs
(braket
id|ARX
)braket
op_assign
id|fb_info-&gt;regs
(braket
id|ARX
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* turn on video bit */
multiline_comment|/*&t;fb_info-&gt;regs[ARX] = 0x20; */
id|fb_info-&gt;regs
(braket
id|ARX
)braket
op_assign
l_int|0x33
suffix:semicolon
multiline_comment|/* dummy write on Reg0 to be on &quot;write index&quot; mode next time */
id|fb_info-&gt;regs
(braket
id|ARX
)braket
op_assign
l_int|0x00
suffix:semicolon
)brace
multiline_comment|/*** RAttr() - read out a register of the Attribute controller ***/
DECL|function|RAttr
r_int
r_char
id|RAttr
c_func
(paren
r_int
r_char
id|regnum
)paren
(brace
multiline_comment|/* (explanation see above in WAttr() ) */
r_if
c_cond
(paren
id|RCrt
c_func
(paren
id|CRT24
)paren
op_amp
l_int|0x80
)paren
id|fb_info-&gt;regs
(braket
id|ARX
)braket
op_assign
id|fb_info-&gt;regs
(braket
id|ARX
op_plus
l_int|1
)braket
suffix:semicolon
id|fb_info-&gt;regs
(braket
id|ARX
)braket
op_assign
id|regnum
suffix:semicolon
r_return
id|fb_info-&gt;regs
(braket
id|ARX
op_plus
l_int|1
)braket
suffix:semicolon
)brace
multiline_comment|/*** WHDR() - write into the Hidden DAC register ***/
multiline_comment|/* as the HDR is the only extension register that requires special treatment &n; * (the other extension registers are accessible just like the &quot;ordinary&quot;&n; * registers of their functional group) here is a specialized routine for &n; * accessing the HDR&n; */
DECL|function|WHDR
r_void
id|WHDR
c_func
(paren
r_int
r_char
id|val
)paren
(brace
r_int
r_char
id|dummy
suffix:semicolon
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
multiline_comment|/* Klaus&squot; hint for correct access to HDR on some boards */
multiline_comment|/* first write 0 to pixel mask (3c6) */
id|WGen
c_func
(paren
id|M_3C6
comma
l_int|0x00
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* next read dummy from pixel address (3c8) */
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C8
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
)brace
multiline_comment|/* now do the usual stuff to access the HDR */
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C6
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C6
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C6
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C6
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|WGen
c_func
(paren
id|M_3C6
comma
id|val
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
multiline_comment|/* now first reset HDR access counter */
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C8
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* and at the end, restore the mask value */
multiline_comment|/* ## is this mask always 0xff? */
id|WGen
c_func
(paren
id|M_3C6
comma
l_int|0xff
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*** RHDR() - read out the Hidden DAC register ***/
multiline_comment|/* I hope this does not break on the GD5428 - cannot test it. */
multiline_comment|/* (Is there any board for the Amiga that uses the 5428 ?) */
DECL|function|RHDR
r_int
r_char
id|RHDR
c_func
(paren
)paren
(brace
r_int
r_char
id|dummy
suffix:semicolon
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C6
)paren
suffix:semicolon
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C6
)paren
suffix:semicolon
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C6
)paren
suffix:semicolon
id|dummy
op_assign
id|RGen
c_func
(paren
id|M_3C6
)paren
suffix:semicolon
r_return
id|RGen
c_func
(paren
id|M_3C6
)paren
suffix:semicolon
)brace
multiline_comment|/*** WSFR() - write to the &quot;special function register&quot; (SFR) ***/
DECL|function|WSFR
r_void
id|WSFR
c_func
(paren
r_int
r_char
id|val
)paren
(brace
id|fb_info-&gt;SFR
op_assign
id|val
suffix:semicolon
id|fb_info-&gt;regs
(braket
l_int|0x8000
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/* The Picasso has a second register for switching the monitor bit */
DECL|function|WSFR2
r_void
id|WSFR2
c_func
(paren
r_int
r_char
id|val
)paren
(brace
multiline_comment|/* writing an arbitrary value to this one causes the monitor switcher */
multiline_comment|/* to flip to Amiga display */
id|fb_info-&gt;SFR
op_assign
id|val
suffix:semicolon
id|fb_info-&gt;regs
(braket
l_int|0x9000
)braket
op_assign
id|val
suffix:semicolon
)brace
multiline_comment|/*** WClut - set CLUT entry (range: 0..63) ***/
DECL|function|WClut
r_void
id|WClut
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
id|red
comma
r_int
r_char
id|green
comma
r_int
r_char
id|blue
)paren
(brace
r_int
r_int
id|data
op_assign
l_int|0x3c9
suffix:semicolon
multiline_comment|/* address write mode register is not translated.. */
id|fb_info-&gt;regs
(braket
l_int|0x3c8
)braket
op_assign
id|regnum
suffix:semicolon
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO
op_logical_or
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO4
)paren
(brace
multiline_comment|/* but DAC data register IS, at least for Picasso II */
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
id|data
op_add_assign
l_int|0xfff
suffix:semicolon
)brace
id|fb_info-&gt;regs
(braket
id|data
)braket
op_assign
id|red
suffix:semicolon
id|fb_info-&gt;regs
(braket
id|data
)braket
op_assign
id|green
suffix:semicolon
id|fb_info-&gt;regs
(braket
id|data
)braket
op_assign
id|blue
suffix:semicolon
)brace
r_else
(brace
id|fb_info-&gt;regs
(braket
id|data
)braket
op_assign
id|blue
suffix:semicolon
id|fb_info-&gt;regs
(braket
id|data
)braket
op_assign
id|green
suffix:semicolon
id|fb_info-&gt;regs
(braket
id|data
)braket
op_assign
id|red
suffix:semicolon
)brace
)brace
multiline_comment|/*** RClut - read CLUT entry (range 0..63) ***/
DECL|function|RClut
r_void
id|RClut
c_func
(paren
r_int
r_char
id|regnum
comma
r_int
r_char
op_star
id|red
comma
r_int
r_char
op_star
id|green
comma
r_int
r_char
op_star
id|blue
)paren
(brace
r_int
r_int
id|data
op_assign
l_int|0x3c9
suffix:semicolon
id|fb_info-&gt;regs
(braket
l_int|0x3c7
)braket
op_assign
id|regnum
suffix:semicolon
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO
op_logical_or
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO4
)paren
(brace
r_if
c_cond
(paren
id|fb_info-&gt;btype
op_eq
id|BT_PICASSO
)paren
(brace
id|data
op_add_assign
l_int|0xfff
suffix:semicolon
)brace
op_star
id|red
op_assign
id|fb_info-&gt;regs
(braket
id|data
)braket
suffix:semicolon
op_star
id|green
op_assign
id|fb_info-&gt;regs
(braket
id|data
)braket
suffix:semicolon
op_star
id|blue
op_assign
id|fb_info-&gt;regs
(braket
id|data
)braket
suffix:semicolon
)brace
r_else
(brace
op_star
id|blue
op_assign
id|fb_info-&gt;regs
(braket
id|data
)braket
suffix:semicolon
op_star
id|green
op_assign
id|fb_info-&gt;regs
(braket
id|data
)braket
suffix:semicolon
op_star
id|red
op_assign
id|fb_info-&gt;regs
(braket
id|data
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/*******************************************************************&n;&t;clgen_WaitBLT()&n;&n;&t;Wait for the BitBLT engine to complete a possible earlier job&n;*********************************************************************/
DECL|function|clgen_WaitBLT
r_void
id|clgen_WaitBLT
c_func
(paren
)paren
(brace
multiline_comment|/* now busy-wait until we&squot;re done */
r_while
c_loop
(paren
id|RGfx
c_func
(paren
id|GR31
)paren
op_amp
l_int|0x08
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************&n;&t;clgen_BitBLT()&n;&n;&t;perform accelerated &quot;scrolling&quot;&n;********************************************************************/
DECL|function|clgen_BitBLT
r_void
id|clgen_BitBLT
(paren
id|u_short
id|curx
comma
id|u_short
id|cury
comma
id|u_short
id|destx
comma
id|u_short
id|desty
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_short
id|line_length
)paren
(brace
id|u_short
id|nwidth
comma
id|nheight
suffix:semicolon
id|u_long
id|nsrc
comma
id|ndest
suffix:semicolon
id|u_char
id|bltmode
suffix:semicolon
id|nwidth
op_assign
id|width
op_minus
l_int|1
suffix:semicolon
id|nheight
op_assign
id|height
op_minus
l_int|1
suffix:semicolon
id|bltmode
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* if source adr &lt; dest addr, do the Blt backwards */
r_if
c_cond
(paren
id|cury
op_le
id|desty
)paren
(brace
r_if
c_cond
(paren
id|cury
op_eq
id|desty
)paren
(brace
multiline_comment|/* if src and dest are on the same line, check x */
r_if
c_cond
(paren
id|curx
OL
id|destx
)paren
id|bltmode
op_or_assign
l_int|0x01
suffix:semicolon
)brace
r_else
id|bltmode
op_or_assign
l_int|0x01
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|bltmode
)paren
(brace
multiline_comment|/* standard case: forward blitting */
id|nsrc
op_assign
(paren
id|cury
op_star
id|line_length
)paren
op_plus
id|curx
suffix:semicolon
id|ndest
op_assign
(paren
id|desty
op_star
id|line_length
)paren
op_plus
id|destx
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* this means start addresses are at the end, counting backwards */
id|nsrc
op_assign
id|cury
op_star
id|line_length
op_plus
id|curx
op_plus
id|nheight
op_star
id|line_length
op_plus
id|nwidth
suffix:semicolon
id|ndest
op_assign
id|desty
op_star
id|line_length
op_plus
id|destx
op_plus
id|nheight
op_star
id|line_length
op_plus
id|nwidth
suffix:semicolon
)brace
singleline_comment|//&t;clgen_WaitBLT(); /* ### NOT OK for multiple boards! */
multiline_comment|/*&n;&t;&t;run-down of registers to be programmed:&n;&t;&t;destination pitch&n;&t;&t;source pitch&n;&t;&t;BLT width/height&n;&t;&t;source start&n;&t;&t;destination start&n;&t;&t;BLT mode&n;&t;&t;BLT ROP&n;&t;&t;GR0 / GR1: &quot;fill color&quot;&n;&t;&t;start/stop&n;&t;*/
multiline_comment|/* pitch: set to line_length */
id|WGfx
c_func
(paren
id|GR24
comma
id|line_length
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* dest pitch low */
id|WGfx
c_func
(paren
id|GR25
comma
(paren
id|line_length
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* dest pitch hi */
id|WGfx
c_func
(paren
id|GR26
comma
id|line_length
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* source pitch low */
id|WGfx
c_func
(paren
id|GR27
comma
(paren
id|line_length
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* source pitch hi */
multiline_comment|/* BLT width: actual number of pixels - 1 */
id|WGfx
c_func
(paren
id|GR20
comma
id|nwidth
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* BLT width low */
id|WGfx
c_func
(paren
id|GR21
comma
(paren
id|nwidth
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT width hi */
multiline_comment|/* BLT height: actual number of lines -1 */
id|WGfx
c_func
(paren
id|GR22
comma
id|nheight
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* BLT height low */
id|WGfx
c_func
(paren
id|GR23
comma
(paren
id|nheight
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT width hi */
multiline_comment|/* BLT destination */
id|WGfx
c_func
(paren
id|GR28
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest low */
id|WGfx
c_func
(paren
id|GR29
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest mid */
id|WGfx
c_func
(paren
id|GR2A
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest hi */
multiline_comment|/* BLT source */
id|WGfx
c_func
(paren
id|GR2C
comma
(paren
id|u_char
)paren
(paren
id|nsrc
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT src low */
id|WGfx
c_func
(paren
id|GR2D
comma
(paren
id|u_char
)paren
(paren
id|nsrc
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT src mid */
id|WGfx
c_func
(paren
id|GR2E
comma
(paren
id|u_char
)paren
(paren
id|nsrc
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT src hi */
multiline_comment|/* BLT mode */
id|WGfx
c_func
(paren
id|GR30
comma
id|bltmode
)paren
suffix:semicolon
multiline_comment|/* BLT mode */
multiline_comment|/* BLT ROP: SrcCopy */
id|WGfx
c_func
(paren
id|GR32
comma
l_int|0x0d
)paren
suffix:semicolon
multiline_comment|/* BLT ROP */
multiline_comment|/* and finally: GO! */
id|WGfx
c_func
(paren
id|GR31
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* BLT Start/status */
)brace
multiline_comment|/*******************************************************************&n;&t;clgen_RectFill()&n;&n;&t;perform accelerated rectangle fill&n;********************************************************************/
DECL|function|clgen_RectFill
r_void
id|clgen_RectFill
(paren
id|u_short
id|x
comma
id|u_short
id|y
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_char
id|color
comma
id|u_short
id|line_length
)paren
(brace
id|u_short
id|nwidth
comma
id|nheight
suffix:semicolon
id|u_long
id|ndest
suffix:semicolon
id|nwidth
op_assign
id|width
op_minus
l_int|1
suffix:semicolon
id|nheight
op_assign
id|height
op_minus
l_int|1
suffix:semicolon
id|ndest
op_assign
(paren
id|y
op_star
id|line_length
)paren
op_plus
id|x
suffix:semicolon
singleline_comment|//&t;clgen_WaitBLT(); /* ### NOT OK for multiple boards! */
multiline_comment|/* pitch: set to line_length */
id|WGfx
c_func
(paren
id|GR24
comma
id|line_length
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* dest pitch low */
id|WGfx
c_func
(paren
id|GR25
comma
(paren
id|line_length
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* dest pitch hi */
id|WGfx
c_func
(paren
id|GR26
comma
id|line_length
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* source pitch low */
id|WGfx
c_func
(paren
id|GR27
comma
(paren
id|line_length
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* source pitch hi */
multiline_comment|/* BLT width: actual number of pixels - 1 */
id|WGfx
c_func
(paren
id|GR20
comma
id|nwidth
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* BLT width low */
id|WGfx
c_func
(paren
id|GR21
comma
(paren
id|nwidth
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT width hi */
multiline_comment|/* BLT height: actual number of lines -1 */
id|WGfx
c_func
(paren
id|GR22
comma
id|nheight
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* BLT height low */
id|WGfx
c_func
(paren
id|GR23
comma
(paren
id|nheight
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT width hi */
multiline_comment|/* BLT destination */
id|WGfx
c_func
(paren
id|GR28
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest low */
id|WGfx
c_func
(paren
id|GR29
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest mid */
id|WGfx
c_func
(paren
id|GR2A
comma
(paren
id|u_char
)paren
(paren
id|ndest
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* BLT dest hi */
multiline_comment|/* BLT source: set to 0 (is a dummy here anyway) */
id|WGfx
c_func
(paren
id|GR2C
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* BLT src low */
id|WGfx
c_func
(paren
id|GR2D
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* BLT src mid */
id|WGfx
c_func
(paren
id|GR2E
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* BLT src hi */
multiline_comment|/* This is a ColorExpand Blt, using the */
multiline_comment|/* same color for foreground and background */
id|WGfx
c_func
(paren
id|GR0
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* foreground color */
id|WGfx
c_func
(paren
id|GR1
comma
id|color
)paren
suffix:semicolon
multiline_comment|/* background color */
multiline_comment|/* BLT mode: color expand, Enable 8x8 copy (faster?) */
id|WGfx
c_func
(paren
id|GR30
comma
l_int|0xc0
)paren
suffix:semicolon
multiline_comment|/* BLT mode */
multiline_comment|/* BLT ROP: SrcCopy */
id|WGfx
c_func
(paren
id|GR32
comma
l_int|0x0d
)paren
suffix:semicolon
multiline_comment|/* BLT ROP */
multiline_comment|/* and finally: GO! */
id|WGfx
c_func
(paren
id|GR31
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/* BLT Start/status */
)brace
multiline_comment|/**************************************************************************&n; * bestclock() - determine closest possible clock lower(?) than the&n; * desired pixel clock&n; **************************************************************************/
DECL|macro|abs
mdefine_line|#define abs(x) ((x)&lt;0 ? -(x) : (x))
DECL|function|bestclock
r_static
r_void
id|bestclock
c_func
(paren
r_int
id|freq
comma
r_int
op_star
id|best
comma
r_int
op_star
id|nom
comma
r_int
op_star
id|den
comma
r_int
op_star
id|div
comma
r_int
id|maxfreq
)paren
(brace
r_int
id|n
comma
id|h
comma
id|d
comma
id|f
suffix:semicolon
op_star
id|nom
op_assign
l_int|0
suffix:semicolon
op_star
id|den
op_assign
l_int|0
suffix:semicolon
op_star
id|div
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|freq
OL
l_int|8000
)paren
id|freq
op_assign
l_int|8000
suffix:semicolon
r_if
c_cond
(paren
id|freq
OG
id|maxfreq
)paren
id|freq
op_assign
id|maxfreq
suffix:semicolon
op_star
id|best
op_assign
l_int|0
suffix:semicolon
id|f
op_assign
id|freq
op_star
l_int|10
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|32
suffix:semicolon
id|n
OL
l_int|128
suffix:semicolon
id|n
op_increment
)paren
(brace
id|d
op_assign
(paren
l_int|143181
op_star
id|n
)paren
op_div
id|f
suffix:semicolon
r_if
c_cond
(paren
(paren
id|d
op_ge
l_int|7
)paren
op_logical_and
(paren
id|d
op_le
l_int|63
)paren
)paren
(brace
r_if
c_cond
(paren
id|d
OG
l_int|31
)paren
id|d
op_assign
(paren
id|d
op_div
l_int|2
)paren
op_star
l_int|2
suffix:semicolon
id|h
op_assign
(paren
l_int|14318
op_star
id|n
)paren
op_div
id|d
suffix:semicolon
r_if
c_cond
(paren
id|abs
c_func
(paren
id|h
op_minus
id|freq
)paren
OL
id|abs
c_func
(paren
op_star
id|best
op_minus
id|freq
)paren
)paren
(brace
op_star
id|best
op_assign
id|h
suffix:semicolon
op_star
id|nom
op_assign
id|n
suffix:semicolon
r_if
c_cond
(paren
id|d
OL
l_int|32
)paren
(brace
op_star
id|den
op_assign
id|d
suffix:semicolon
op_star
id|div
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|den
op_assign
id|d
op_div
l_int|2
suffix:semicolon
op_star
id|div
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
id|d
op_assign
(paren
(paren
l_int|143181
op_star
id|n
)paren
op_plus
id|f
op_minus
l_int|1
)paren
op_div
id|f
suffix:semicolon
r_if
c_cond
(paren
(paren
id|d
op_ge
l_int|7
)paren
op_logical_and
(paren
id|d
op_le
l_int|63
)paren
)paren
(brace
r_if
c_cond
(paren
id|d
OG
l_int|31
)paren
id|d
op_assign
(paren
id|d
op_div
l_int|2
)paren
op_star
l_int|2
suffix:semicolon
id|h
op_assign
(paren
l_int|14318
op_star
id|n
)paren
op_div
id|d
suffix:semicolon
r_if
c_cond
(paren
id|abs
c_func
(paren
id|h
op_minus
id|freq
)paren
OL
id|abs
c_func
(paren
op_star
id|best
op_minus
id|freq
)paren
)paren
(brace
op_star
id|best
op_assign
id|h
suffix:semicolon
op_star
id|nom
op_assign
id|n
suffix:semicolon
r_if
c_cond
(paren
id|d
OL
l_int|32
)paren
(brace
op_star
id|den
op_assign
id|d
suffix:semicolon
op_star
id|div
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|den
op_assign
id|d
op_div
l_int|2
suffix:semicolon
op_star
id|div
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
eof
