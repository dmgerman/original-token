multiline_comment|/*&n; *  linux/drivers/video/S3Triofb.c -- Open Firmware based frame buffer device&n; *&n; *&t;Copyright (C) 1997 Peter De Schrijver&n; *&n; *  This driver is partly based on the PowerMac console driver:&n; *&n; *&t;Copyright (C) 1996 Paul Mackerras&n; *&n; *  and on the Open Firmware based frame buffer device:&n; *&n; *&t;Copyright (C) 1997 Geert Uytterhoeven&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License. See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
multiline_comment|/*&n;&t;Bugs : + OF dependencies should be removed.&n;               + This driver should be merged with the CyberVision driver. The&n;                 CyberVision is a Zorro III implementation of the S3Trio64 chip.&n;&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#ifdef CONFIG_FB_COMPAT_XPMAC
macro_line|#include &lt;asm/vc_ioctl.h&gt;
macro_line|#endif
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-cfb8.h&gt;
macro_line|#include &lt;video/s3blit.h&gt;
DECL|macro|mem_in8
mdefine_line|#define mem_in8(addr)           in_8((void *)(addr))
DECL|macro|mem_in16
mdefine_line|#define mem_in16(addr)          in_le16((void *)(addr))
DECL|macro|mem_in32
mdefine_line|#define mem_in32(addr)          in_le32((void *)(addr))
DECL|macro|mem_out8
mdefine_line|#define mem_out8(val, addr)     out_8((void *)(addr), val)
DECL|macro|mem_out16
mdefine_line|#define mem_out16(val, addr)    out_le16((void *)(addr), val)
DECL|macro|mem_out32
mdefine_line|#define mem_out32(val, addr)    out_le32((void *)(addr), val)
DECL|macro|IO_OUT16VAL
mdefine_line|#define IO_OUT16VAL(v, r)       (((v) &lt;&lt; 8) | (r))
DECL|variable|currcon
r_static
r_int
id|currcon
op_assign
l_int|0
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|pad
DECL|variable|palette
r_static
r_struct
(brace
id|u_char
id|red
comma
id|green
comma
id|blue
comma
id|pad
suffix:semicolon
)brace
id|palette
(braket
l_int|256
)braket
suffix:semicolon
DECL|variable|s3trio_name
r_static
r_char
id|s3trio_name
(braket
l_int|16
)braket
op_assign
l_string|&quot;S3Trio &quot;
suffix:semicolon
DECL|variable|s3trio_base
r_static
r_char
op_star
id|s3trio_base
suffix:semicolon
DECL|variable|fb_fix
r_static
r_struct
id|fb_fix_screeninfo
id|fb_fix
suffix:semicolon
DECL|variable|fb_var
r_static
r_struct
id|fb_var_screeninfo
id|fb_var
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  Interface used by the world&n;     */
r_static
r_void
id|__init
id|s3triofb_of_init
c_func
(paren
r_struct
id|device_node
op_star
id|dp
)paren
suffix:semicolon
r_static
r_int
id|s3trio_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|s3trio_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|s3trio_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|s3trio_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|s3trio_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|s3trio_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;     *  Interface to the low level console driver&n;     */
r_int
id|s3triofb_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|s3triofbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|s3triofbcon_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|s3triofbcon_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|s3triofbcon_setcmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|con
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     *  Text console acceleration&n;     */
macro_line|#ifdef FBCON_HAS_CFB8
DECL|variable|fbcon_trio8
r_static
r_struct
id|display_switch
id|fbcon_trio8
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;     *    Accelerated Functions used by the low level console driver&n;     */
r_static
r_void
id|Trio_WaitQueue
c_func
(paren
id|u_short
id|fifo
)paren
suffix:semicolon
r_static
r_void
id|Trio_WaitBlit
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|Trio_BitBLT
c_func
(paren
id|u_short
id|curx
comma
id|u_short
id|cury
comma
id|u_short
id|destx
comma
id|u_short
id|desty
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_short
id|mode
)paren
suffix:semicolon
r_static
r_void
id|Trio_RectFill
c_func
(paren
id|u_short
id|x
comma
id|u_short
id|y
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_short
id|mode
comma
id|u_short
id|color
)paren
suffix:semicolon
r_static
r_void
id|Trio_MoveCursor
c_func
(paren
id|u_short
id|x
comma
id|u_short
id|y
)paren
suffix:semicolon
multiline_comment|/*&n;     *  Internal routines&n;     */
r_static
r_int
id|s3trio_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|s3trio_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
DECL|variable|s3trio_ops
r_static
r_struct
id|fb_ops
id|s3trio_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_get_fix
suffix:colon
id|s3trio_get_fix
comma
id|fb_get_var
suffix:colon
id|s3trio_get_var
comma
id|fb_set_var
suffix:colon
id|s3trio_set_var
comma
id|fb_get_cmap
suffix:colon
id|s3trio_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|s3trio_set_cmap
comma
id|fb_pan_display
suffix:colon
id|s3trio_pan_display
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  Get the Fixed Part of the Display&n;     */
DECL|function|s3trio_get_fix
r_static
r_int
id|s3trio_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|memcpy
c_func
(paren
id|fix
comma
op_amp
id|fb_fix
comma
r_sizeof
(paren
id|fb_fix
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Get the User Defined Part of the Display&n;     */
DECL|function|s3trio_get_var
r_static
r_int
id|s3trio_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|memcpy
c_func
(paren
id|var
comma
op_amp
id|fb_var
comma
r_sizeof
(paren
id|fb_var
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Set the User Defined Part of the Display&n;     */
DECL|function|s3trio_set_var
r_static
r_int
id|s3trio_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;xres
OG
id|fb_var.xres
op_logical_or
id|var-&gt;yres
OG
id|fb_var.yres
op_logical_or
id|var-&gt;bits_per_pixel
OG
id|fb_var.bits_per_pixel
)paren
multiline_comment|/* || var-&gt;nonstd || var-&gt;vmode != FB_VMODE_NONINTERLACED) */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xres_virtual
OG
id|fb_var.xres_virtual
)paren
(brace
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
(paren
id|var-&gt;xres_virtual
op_div
l_int|8
)paren
op_amp
l_int|0xff
comma
l_int|0x13
)paren
comma
l_int|0x3d4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
(paren
(paren
id|var-&gt;xres_virtual
op_div
l_int|8
)paren
op_amp
l_int|0x300
)paren
op_rshift
l_int|3
comma
l_int|0x51
)paren
comma
l_int|0x3d4
)paren
suffix:semicolon
id|fb_var.xres_virtual
op_assign
id|var-&gt;xres_virtual
suffix:semicolon
id|fb_fix.line_length
op_assign
id|var-&gt;xres_virtual
suffix:semicolon
)brace
id|fb_var.yres_virtual
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
id|memcpy
c_func
(paren
id|var
comma
op_amp
id|fb_var
comma
r_sizeof
(paren
id|fb_var
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Pan or Wrap the Display&n;     *&n;     *  This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag&n;     */
DECL|function|s3trio_pan_display
r_static
r_int
id|s3trio_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_int
id|base
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;xoffset
OG
(paren
id|var-&gt;xres_virtual
op_minus
id|var-&gt;xres
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
OG
(paren
id|var-&gt;yres_virtual
op_minus
id|var-&gt;yres
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|fb_var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|fb_var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
id|base
op_assign
id|var-&gt;yoffset
op_star
id|fb_fix.line_length
op_plus
id|var-&gt;xoffset
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
(paren
id|base
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
l_int|0x0c
)paren
comma
l_int|0x03D4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
id|base
op_amp
l_int|0xff
comma
l_int|0x0d
)paren
comma
l_int|0x03D4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
(paren
id|base
op_rshift
l_int|16
)paren
op_amp
l_int|0xf
comma
l_int|0x69
)paren
comma
l_int|0x03D4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Get the Colormap&n;     */
DECL|function|s3trio_get_cmap
r_static
r_int
id|s3trio_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console? */
r_return
id|fb_get_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|s3trio_getcolreg
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
multiline_comment|/* non default colormap? */
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Set the Colormap&n;     */
DECL|function|s3trio_set_cmap
r_static
r_int
id|s3trio_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
(brace
multiline_comment|/* no colormap allocated? */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
comma
l_int|0
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console? */
r_return
id|fb_set_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|s3trio_setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|s3triofb_init
r_int
id|__init
id|s3triofb_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|dp
suffix:semicolon
id|dp
op_assign
id|find_devices
c_func
(paren
l_string|&quot;S3Trio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dp
op_ne
l_int|0
)paren
id|s3triofb_of_init
c_func
(paren
id|dp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|s3trio_resetaccel
r_void
id|__init
(def_block
id|s3trio_resetaccel
c_func
(paren
r_void
)paren
(brace
DECL|macro|EC01_ENH_ENB
mdefine_line|#define EC01_ENH_ENB    0x0005
DECL|macro|EC01_LAW_ENB
mdefine_line|#define EC01_LAW_ENB    0x0010
DECL|macro|EC01_MMIO_ENB
mdefine_line|#define EC01_MMIO_ENB   0x0020
DECL|macro|EC00_RESET
mdefine_line|#define EC00_RESET      0x8000
DECL|macro|EC00_ENABLE
mdefine_line|#define EC00_ENABLE     0x4000
DECL|macro|MF_MULT_MISC
mdefine_line|#define MF_MULT_MISC    0xE000
DECL|macro|SRC_FOREGROUND
mdefine_line|#define SRC_FOREGROUND  0x0020
DECL|macro|SRC_BACKGROUND
mdefine_line|#define SRC_BACKGROUND  0x0000
DECL|macro|MIX_SRC
mdefine_line|#define MIX_SRC                 0x0007
DECL|macro|MF_T_CLIP
mdefine_line|#define MF_T_CLIP       0x1000
DECL|macro|MF_L_CLIP
mdefine_line|#define MF_L_CLIP       0x2000
DECL|macro|MF_B_CLIP
mdefine_line|#define MF_B_CLIP       0x3000
DECL|macro|MF_R_CLIP
mdefine_line|#define MF_R_CLIP       0x4000
DECL|macro|MF_PIX_CONTROL
mdefine_line|#define MF_PIX_CONTROL  0xA000
DECL|macro|MFA_SRC_FOREGR_MIX
mdefine_line|#define MFA_SRC_FOREGR_MIX      0x0000
DECL|macro|MF_PIX_CONTROL
mdefine_line|#define MF_PIX_CONTROL  0xA000
id|outw
c_func
(paren
id|EC00_RESET
comma
l_int|0x42e8
)paren
suffix:semicolon
id|inw
c_func
(paren
l_int|0x42e8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|EC00_ENABLE
comma
l_int|0x42e8
)paren
suffix:semicolon
id|inw
c_func
(paren
l_int|0x42e8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|EC01_ENH_ENB
op_or
id|EC01_LAW_ENB
comma
l_int|0x4ae8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MF_MULT_MISC
comma
l_int|0xbee8
)paren
suffix:semicolon
multiline_comment|/* 16 bit I/O registers */
multiline_comment|/* Now set some basic accelerator registers */
id|Trio_WaitQueue
c_func
(paren
l_int|0x0400
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SRC_FOREGROUND
op_or
id|MIX_SRC
comma
l_int|0xbae8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|SRC_BACKGROUND
op_or
id|MIX_SRC
comma
l_int|0xb6e8
)paren
suffix:semicolon
multiline_comment|/* direct color*/
id|outw
c_func
(paren
id|MF_T_CLIP
op_or
l_int|0
comma
l_int|0xbee8
)paren
suffix:semicolon
multiline_comment|/* clip virtual area  */
id|outw
c_func
(paren
id|MF_L_CLIP
op_or
l_int|0
comma
l_int|0xbee8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MF_R_CLIP
op_or
(paren
l_int|640
op_minus
l_int|1
)paren
comma
l_int|0xbee8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|MF_B_CLIP
op_or
(paren
l_int|480
op_minus
l_int|1
)paren
comma
l_int|0xbee8
)paren
suffix:semicolon
id|Trio_WaitQueue
c_func
(paren
l_int|0x0400
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xffff
comma
l_int|0xaae8
)paren
suffix:semicolon
multiline_comment|/* Enable all planes */
id|outw
c_func
(paren
l_int|0xffff
comma
l_int|0xaae8
)paren
suffix:semicolon
multiline_comment|/* Enable all planes */
id|outw
c_func
(paren
id|MF_PIX_CONTROL
op_or
id|MFA_SRC_FOREGR_MIX
comma
l_int|0xbee8
)paren
suffix:semicolon
)brace
)def_block
DECL|function|s3trio_init
r_int
id|__init
(def_block
id|s3trio_init
c_func
(paren
r_struct
id|device_node
op_star
id|dp
)paren
(brace
id|u_char
id|bus
comma
id|dev
suffix:semicolon
r_int
r_int
id|t32
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
id|pci_device_loc
c_func
(paren
id|dp
comma
op_amp
id|bus
comma
op_amp
id|dev
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_VENDOR_ID
comma
op_amp
id|t32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t32
op_eq
(paren
id|PCI_DEVICE_ID_S3_TRIO
op_lshift
l_int|16
)paren
op_plus
id|PCI_VENDOR_ID_S3
)paren
(brace
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|t32
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_BASE_ADDRESS_1
comma
op_amp
id|t32
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|pcibios_write_config_word
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_COMMAND
comma
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
)paren
suffix:semicolon
id|pcibios_write_config_dword
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_BASE_ADDRESS_0
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|t32
)paren
suffix:semicolon
multiline_comment|/* This is a gross hack as OF only maps enough memory for the framebuffer and&n;   we want to use MMIO too. We should find out which chunk of address space&n;   we can use here */
id|pcibios_write_config_dword
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_BASE_ADDRESS_0
comma
l_int|0xc6000000
)paren
suffix:semicolon
multiline_comment|/* unlock s3 */
id|outb
c_func
(paren
l_int|0x01
comma
l_int|0x3C3
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
l_int|0x03CC
)paren
op_or
l_int|1
comma
l_int|0x3c2
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
l_int|0x48
comma
l_int|0x38
)paren
comma
l_int|0x03D4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
l_int|0xA0
comma
l_int|0x39
)paren
comma
l_int|0x03D4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x33
comma
l_int|0x3d4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
(paren
id|inb
c_func
(paren
l_int|0x3d5
)paren
op_amp
op_complement
(paren
l_int|0x2
op_or
l_int|0x10
op_or
l_int|0x40
)paren
)paren
op_or
l_int|0x20
comma
l_int|0x33
)paren
comma
l_int|0x3d4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
l_int|0x6
comma
l_int|0x8
)paren
comma
l_int|0x3c4
)paren
suffix:semicolon
multiline_comment|/* switch to MMIO only mode */
id|outb
c_func
(paren
l_int|0x58
comma
l_int|0x3d4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
id|inb
c_func
(paren
l_int|0x3d5
)paren
op_or
l_int|3
op_or
l_int|0x10
comma
l_int|0x58
)paren
comma
l_int|0x3d4
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_OUT16VAL
c_func
(paren
l_int|8
comma
l_int|0x53
)paren
comma
l_int|0x3d4
)paren
suffix:semicolon
multiline_comment|/* switch off I/O accesses */
macro_line|#if 0
id|pcibios_write_config_word
c_func
(paren
id|bus
comma
id|dev
comma
id|PCI_COMMAND
comma
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
)def_block
multiline_comment|/*&n;     *  Initialisation&n;     *  We heavily rely on OF for the moment. This needs fixing.&n;     */
DECL|function|s3triofb_of_init
r_static
r_void
id|__init
id|s3triofb_of_init
c_func
(paren
r_struct
id|device_node
op_star
id|dp
)paren
(brace
r_int
id|i
comma
op_star
id|pp
comma
id|len
suffix:semicolon
r_int
r_int
id|address
comma
id|size
suffix:semicolon
id|u_long
op_star
id|CursorBase
suffix:semicolon
id|strncat
c_func
(paren
id|s3trio_name
comma
id|dp-&gt;name
comma
r_sizeof
(paren
id|s3trio_name
)paren
)paren
suffix:semicolon
id|s3trio_name
(braket
r_sizeof
(paren
id|s3trio_name
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_fix.id
comma
id|s3trio_name
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;vendor-id&quot;
comma
op_amp
id|len
)paren
)paren
op_ne
l_int|NULL
op_logical_and
op_star
id|pp
op_ne
id|PCI_VENDOR_ID_S3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: can&squot;t find S3 Trio board&bslash;n&quot;
comma
id|dp-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;device-id&quot;
comma
op_amp
id|len
)paren
)paren
op_ne
l_int|NULL
op_logical_and
op_star
id|pp
op_ne
id|PCI_DEVICE_ID_S3_TRIO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: can&squot;t find S3 Trio board&bslash;n&quot;
comma
id|dp-&gt;full_name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;depth&quot;
comma
op_amp
id|len
)paren
)paren
op_ne
l_int|NULL
op_logical_and
id|len
op_eq
r_sizeof
(paren
r_int
)paren
op_logical_and
op_star
id|pp
op_ne
l_int|8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: can&squot;t use depth = %d&bslash;n&quot;
comma
id|dp-&gt;full_name
comma
op_star
id|pp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;width&quot;
comma
op_amp
id|len
)paren
)paren
op_ne
l_int|NULL
op_logical_and
id|len
op_eq
r_sizeof
(paren
r_int
)paren
)paren
id|fb_var.xres
op_assign
id|fb_var.xres_virtual
op_assign
op_star
id|pp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;height&quot;
comma
op_amp
id|len
)paren
)paren
op_ne
l_int|NULL
op_logical_and
id|len
op_eq
r_sizeof
(paren
r_int
)paren
)paren
id|fb_var.yres
op_assign
id|fb_var.yres_virtual
op_assign
op_star
id|pp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pp
op_assign
(paren
r_int
op_star
)paren
id|get_property
c_func
(paren
id|dp
comma
l_string|&quot;linebytes&quot;
comma
op_amp
id|len
)paren
)paren
op_ne
l_int|NULL
op_logical_and
id|len
op_eq
r_sizeof
(paren
r_int
)paren
)paren
id|fb_fix.line_length
op_assign
op_star
id|pp
suffix:semicolon
r_else
id|fb_fix.line_length
op_assign
id|fb_var.xres_virtual
suffix:semicolon
id|fb_fix.smem_len
op_assign
id|fb_fix.line_length
op_star
id|fb_var.yres
suffix:semicolon
id|address
op_assign
l_int|0xc6000000
suffix:semicolon
id|size
op_assign
l_int|64
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|address
comma
id|size
comma
l_string|&quot;S3triofb&quot;
)paren
)paren
r_return
suffix:semicolon
id|s3trio_init
c_func
(paren
id|dp
)paren
suffix:semicolon
id|s3trio_base
op_assign
id|ioremap
c_func
(paren
id|address
comma
id|size
)paren
suffix:semicolon
id|fb_fix.smem_start
op_assign
id|address
suffix:semicolon
id|fb_fix.type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fb_fix.type_aux
op_assign
l_int|0
suffix:semicolon
id|fb_fix.accel
op_assign
id|FB_ACCEL_S3_TRIO64
suffix:semicolon
id|fb_fix.mmio_start
op_assign
id|address
op_plus
l_int|0x1000000
suffix:semicolon
id|fb_fix.mmio_len
op_assign
l_int|0x1000000
suffix:semicolon
id|fb_fix.xpanstep
op_assign
l_int|1
suffix:semicolon
id|fb_fix.ypanstep
op_assign
l_int|1
suffix:semicolon
id|s3trio_resetaccel
c_func
(paren
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x30
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x2d
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x2e
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x50
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
multiline_comment|/* disable HW cursor */
id|mem_out8
c_func
(paren
l_int|0x39
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0xa0
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x45
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x4e
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x4f
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
multiline_comment|/* init HW cursor */
id|CursorBase
op_assign
(paren
id|u_long
op_star
)paren
(paren
id|s3trio_base
op_plus
l_int|2
op_star
l_int|1024
op_star
l_int|1024
op_minus
l_int|0x400
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|CursorBase
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
op_assign
l_int|0xffffff00
suffix:semicolon
op_star
(paren
id|CursorBase
op_plus
l_int|1
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
op_assign
l_int|0xffff0000
suffix:semicolon
op_star
(paren
id|CursorBase
op_plus
l_int|2
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
op_assign
l_int|0xffff0000
suffix:semicolon
op_star
(paren
id|CursorBase
op_plus
l_int|3
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
op_assign
l_int|0xffff0000
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|8
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|CursorBase
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
op_assign
l_int|0xffff0000
suffix:semicolon
op_star
(paren
id|CursorBase
op_plus
l_int|1
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
op_assign
l_int|0xffff0000
suffix:semicolon
op_star
(paren
id|CursorBase
op_plus
l_int|2
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
op_assign
l_int|0xffff0000
suffix:semicolon
op_star
(paren
id|CursorBase
op_plus
l_int|3
op_plus
(paren
id|i
op_star
l_int|4
)paren
)paren
op_assign
l_int|0xffff0000
suffix:semicolon
)brace
id|mem_out8
c_func
(paren
l_int|0x4c
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
(paren
(paren
l_int|2
op_star
l_int|1024
op_minus
l_int|1
)paren
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x4d
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
(paren
l_int|2
op_star
l_int|1024
op_minus
l_int|1
)paren
op_amp
l_int|0xff
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x45
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_in8
c_func
(paren
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x4a
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x80
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x80
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x80
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x4b
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x00
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x00
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x00
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x45
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03D5
)paren
suffix:semicolon
multiline_comment|/* setup default color table */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|j
op_assign
id|color_table
(braket
id|i
)braket
suffix:semicolon
id|palette
(braket
id|i
)braket
dot
id|red
op_assign
id|default_red
(braket
id|j
)braket
suffix:semicolon
id|palette
(braket
id|i
)braket
dot
id|green
op_assign
id|default_grn
(braket
id|j
)braket
suffix:semicolon
id|palette
(braket
id|i
)braket
dot
id|blue
op_assign
id|default_blu
(braket
id|j
)braket
suffix:semicolon
)brace
id|s3trio_setcolreg
c_func
(paren
l_int|255
comma
l_int|56
comma
l_int|100
comma
l_int|160
comma
l_int|0
comma
l_int|NULL
multiline_comment|/* not used */
)paren
suffix:semicolon
id|s3trio_setcolreg
c_func
(paren
l_int|254
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
multiline_comment|/* not used */
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|s3trio_base
comma
l_int|0
comma
l_int|640
op_star
l_int|480
)paren
suffix:semicolon
macro_line|#if 0
id|Trio_RectFill
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|90
comma
l_int|90
comma
l_int|7
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|fb_fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|fb_var.xoffset
op_assign
id|fb_var.yoffset
op_assign
l_int|0
suffix:semicolon
id|fb_var.bits_per_pixel
op_assign
l_int|8
suffix:semicolon
id|fb_var.grayscale
op_assign
l_int|0
suffix:semicolon
id|fb_var.red.offset
op_assign
id|fb_var.green.offset
op_assign
id|fb_var.blue.offset
op_assign
l_int|0
suffix:semicolon
id|fb_var.red.length
op_assign
id|fb_var.green.length
op_assign
id|fb_var.blue.length
op_assign
l_int|8
suffix:semicolon
id|fb_var.red.msb_right
op_assign
id|fb_var.green.msb_right
op_assign
id|fb_var.blue.msb_right
op_assign
l_int|0
suffix:semicolon
id|fb_var.transp.offset
op_assign
id|fb_var.transp.length
op_assign
id|fb_var.transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|fb_var.nonstd
op_assign
l_int|0
suffix:semicolon
id|fb_var.activate
op_assign
l_int|0
suffix:semicolon
id|fb_var.height
op_assign
id|fb_var.width
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_var.accel_flags
op_assign
id|FB_ACCELF_TEXT
suffix:semicolon
macro_line|#warning FIXME: always obey fb_var.accel_flags
id|fb_var.pixclock
op_assign
l_int|1
suffix:semicolon
id|fb_var.left_margin
op_assign
id|fb_var.right_margin
op_assign
l_int|0
suffix:semicolon
id|fb_var.upper_margin
op_assign
id|fb_var.lower_margin
op_assign
l_int|0
suffix:semicolon
id|fb_var.hsync_len
op_assign
id|fb_var.vsync_len
op_assign
l_int|0
suffix:semicolon
id|fb_var.sync
op_assign
l_int|0
suffix:semicolon
id|fb_var.vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
id|disp.var
op_assign
id|fb_var
suffix:semicolon
id|disp.cmap.start
op_assign
l_int|0
suffix:semicolon
id|disp.cmap.len
op_assign
l_int|0
suffix:semicolon
id|disp.cmap.red
op_assign
id|disp.cmap.green
op_assign
id|disp.cmap.blue
op_assign
id|disp.cmap.transp
op_assign
l_int|NULL
suffix:semicolon
id|disp.screen_base
op_assign
id|s3trio_base
suffix:semicolon
id|disp.visual
op_assign
id|fb_fix.visual
suffix:semicolon
id|disp.type
op_assign
id|fb_fix.type
suffix:semicolon
id|disp.type_aux
op_assign
id|fb_fix.type_aux
suffix:semicolon
id|disp.ypanstep
op_assign
l_int|0
suffix:semicolon
id|disp.ywrapstep
op_assign
l_int|0
suffix:semicolon
id|disp.line_length
op_assign
id|fb_fix.line_length
suffix:semicolon
id|disp.can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|disp.inverse
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef FBCON_HAS_CFB8
r_if
c_cond
(paren
id|fb_var.accel_flags
op_amp
id|FB_ACCELF_TEXT
)paren
id|disp.dispsw
op_assign
op_amp
id|fbcon_trio8
suffix:semicolon
r_else
id|disp.dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
macro_line|#else
id|disp.dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
macro_line|#endif
id|disp.scrollmode
op_assign
id|fb_var.accel_flags
op_amp
id|FB_ACCELF_TEXT
ques
c_cond
l_int|0
suffix:colon
id|SCROLL_YREDRAW
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Trio64 &quot;
)paren
suffix:semicolon
id|strncat
c_func
(paren
id|fb_info.modename
comma
id|dp-&gt;full_name
comma
r_sizeof
(paren
id|fb_info.modename
)paren
)paren
suffix:semicolon
id|fb_info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|s3trio_ops
suffix:semicolon
macro_line|#if 0
id|fb_info.fbvar_num
op_assign
l_int|1
suffix:semicolon
id|fb_info.fbvar
op_assign
op_amp
id|fb_var
suffix:semicolon
macro_line|#endif
id|fb_info.disp
op_assign
op_amp
id|disp
suffix:semicolon
id|fb_info.fontname
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|fb_info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.switch_con
op_assign
op_amp
id|s3triofbcon_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
op_amp
id|s3triofbcon_updatevar
suffix:semicolon
id|fb_info.blank
op_assign
op_amp
id|s3triofbcon_blank
suffix:semicolon
macro_line|#if 0
id|fb_info.setcmap
op_assign
op_amp
id|s3triofbcon_setcmap
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FB_COMPAT_XPMAC
r_if
c_cond
(paren
op_logical_neg
id|console_fb_info
)paren
(brace
id|display_info.height
op_assign
id|fb_var.yres
suffix:semicolon
id|display_info.width
op_assign
id|fb_var.xres
suffix:semicolon
id|display_info.depth
op_assign
l_int|8
suffix:semicolon
id|display_info.pitch
op_assign
id|fb_fix.line_length
suffix:semicolon
id|display_info.mode
op_assign
l_int|0
suffix:semicolon
id|strncpy
c_func
(paren
id|display_info.name
comma
id|dp-&gt;name
comma
r_sizeof
(paren
id|display_info.name
)paren
)paren
suffix:semicolon
id|display_info.fb_address
op_assign
(paren
r_int
r_int
)paren
id|fb_fix.smem_start
suffix:semicolon
id|display_info.disp_reg_address
op_assign
id|address
op_plus
l_int|0x1008000
suffix:semicolon
id|display_info.cmap_adr_address
op_assign
id|address
op_plus
l_int|0x1008000
op_plus
l_int|0x3c8
suffix:semicolon
id|display_info.cmap_data_address
op_assign
id|address
op_plus
l_int|0x1008000
op_plus
l_int|0x3c9
suffix:semicolon
id|console_fb_info
op_assign
op_amp
id|fb_info
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_FB_COMPAT_XPMAC) */
id|fb_info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fb%d: S3 Trio frame buffer device on %s&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|fb_info.node
)paren
comma
id|dp-&gt;full_name
)paren
suffix:semicolon
)brace
DECL|function|s3triofbcon_switch
r_static
r_int
id|s3triofbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* Do we have to save the colormap? */
r_if
c_cond
(paren
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap.len
)paren
id|fb_get_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap
comma
l_int|1
comma
id|s3trio_getcolreg
comma
id|info
)paren
suffix:semicolon
id|currcon
op_assign
id|con
suffix:semicolon
multiline_comment|/* Install new colormap */
id|do_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Update the `var&squot; structure (called by fbcon.c)&n;     */
DECL|function|s3triofbcon_updatevar
r_static
r_int
id|s3triofbcon_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* Nothing */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Blank the display.&n;     */
DECL|function|s3triofbcon_blank
r_static
r_void
id|s3triofbcon_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_char
id|x
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x1
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03c4
)paren
suffix:semicolon
id|x
op_assign
id|mem_in8
c_func
(paren
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03c5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
(paren
id|x
op_amp
(paren
op_complement
l_int|0x20
)paren
)paren
op_or
(paren
id|blank
op_lshift
l_int|5
)paren
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x03c5
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Set the colormap&n;     */
macro_line|#if 0
r_static
r_int
id|s3triofbcon_setcmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|con
)paren
(brace
r_return
id|s3trio_set_cmap
c_func
(paren
id|cmap
comma
l_int|1
comma
id|con
comma
op_amp
id|fb_info
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;     *  Read a single color register and split it into&n;     *  colors/transparent. Return != 0 for invalid regno.&n;     */
DECL|function|s3trio_getcolreg
r_static
r_int
id|s3trio_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
(paren
id|palette
(braket
id|regno
)braket
dot
id|red
op_lshift
l_int|8
)paren
op_or
id|palette
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
(paren
id|palette
(braket
id|regno
)braket
dot
id|green
op_lshift
l_int|8
)paren
op_or
id|palette
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
(paren
id|palette
(braket
id|regno
)braket
dot
id|blue
op_lshift
l_int|8
)paren
op_or
id|palette
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Set a single color register. Return != 0 for invalid regno.&n;     */
DECL|function|s3trio_setcolreg
r_static
r_int
id|s3trio_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|red
op_rshift_assign
l_int|8
suffix:semicolon
id|green
op_rshift_assign
l_int|8
suffix:semicolon
id|blue
op_rshift_assign
l_int|8
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
id|mem_out8
c_func
(paren
id|regno
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3c8
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
(paren
id|red
op_amp
l_int|0xff
)paren
op_rshift
l_int|2
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3c9
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
(paren
id|green
op_amp
l_int|0xff
)paren
op_rshift
l_int|2
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3c9
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
(paren
id|blue
op_amp
l_int|0xff
)paren
op_rshift
l_int|2
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3c9
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_install_cmap
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_ne
id|currcon
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_set_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
comma
id|s3trio_setcolreg
comma
op_amp
id|fb_info
)paren
suffix:semicolon
r_else
id|fb_set_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
l_int|1
comma
id|s3trio_setcolreg
comma
op_amp
id|fb_info
)paren
suffix:semicolon
)brace
DECL|function|Trio_WaitQueue
r_static
r_void
id|Trio_WaitQueue
c_func
(paren
id|u_short
id|fifo
)paren
(brace
id|u_short
id|status
suffix:semicolon
r_do
(brace
id|status
op_assign
id|mem_in16
c_func
(paren
id|s3trio_base
op_plus
l_int|0x1000000
op_plus
l_int|0x9AE8
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|fifo
)paren
)paren
suffix:semicolon
)brace
DECL|function|Trio_WaitBlit
r_static
r_void
id|Trio_WaitBlit
c_func
(paren
r_void
)paren
(brace
id|u_short
id|status
suffix:semicolon
r_do
(brace
id|status
op_assign
id|mem_in16
c_func
(paren
id|s3trio_base
op_plus
l_int|0x1000000
op_plus
l_int|0x9AE8
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
op_amp
l_int|0x200
)paren
suffix:semicolon
)brace
DECL|function|Trio_BitBLT
r_static
r_void
id|Trio_BitBLT
c_func
(paren
id|u_short
id|curx
comma
id|u_short
id|cury
comma
id|u_short
id|destx
comma
id|u_short
id|desty
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_short
id|mode
)paren
(brace
id|u_short
id|blitcmd
op_assign
l_int|0xc011
suffix:semicolon
multiline_comment|/* Set drawing direction */
multiline_comment|/* -Y, X maj, -X (default) */
r_if
c_cond
(paren
id|curx
OG
id|destx
)paren
id|blitcmd
op_or_assign
l_int|0x0020
suffix:semicolon
multiline_comment|/* Drawing direction +X */
r_else
(brace
id|curx
op_add_assign
(paren
id|width
op_minus
l_int|1
)paren
suffix:semicolon
id|destx
op_add_assign
(paren
id|width
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cury
OG
id|desty
)paren
id|blitcmd
op_or_assign
l_int|0x0080
suffix:semicolon
multiline_comment|/* Drawing direction +Y */
r_else
(brace
id|cury
op_add_assign
(paren
id|height
op_minus
l_int|1
)paren
suffix:semicolon
id|desty
op_add_assign
(paren
id|height
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|Trio_WaitQueue
c_func
(paren
l_int|0x0400
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xa000
comma
l_int|0xBEE8
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x60
op_or
id|mode
comma
l_int|0xBAE8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|curx
comma
l_int|0x86E8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|cury
comma
l_int|0x82E8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|destx
comma
l_int|0x8EE8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|desty
comma
l_int|0x8AE8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|height
op_minus
l_int|1
comma
l_int|0xBEE8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|width
op_minus
l_int|1
comma
l_int|0x96E8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|blitcmd
comma
l_int|0x9AE8
)paren
suffix:semicolon
)brace
DECL|function|Trio_RectFill
r_static
r_void
id|Trio_RectFill
c_func
(paren
id|u_short
id|x
comma
id|u_short
id|y
comma
id|u_short
id|width
comma
id|u_short
id|height
comma
id|u_short
id|mode
comma
id|u_short
id|color
)paren
(brace
id|u_short
id|blitcmd
op_assign
l_int|0x40b1
suffix:semicolon
id|Trio_WaitQueue
c_func
(paren
l_int|0x0400
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xa000
comma
l_int|0xBEE8
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
l_int|0x20
op_or
id|mode
)paren
comma
l_int|0xBAE8
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xe000
comma
l_int|0xBEE8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|color
comma
l_int|0xA6E8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|x
comma
l_int|0x86E8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|y
comma
l_int|0x82E8
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|height
op_minus
l_int|1
)paren
comma
l_int|0xBEE8
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|width
op_minus
l_int|1
)paren
comma
l_int|0x96E8
)paren
suffix:semicolon
id|outw
c_func
(paren
id|blitcmd
comma
l_int|0x9AE8
)paren
suffix:semicolon
)brace
DECL|function|Trio_MoveCursor
r_static
r_void
id|Trio_MoveCursor
c_func
(paren
id|u_short
id|x
comma
id|u_short
id|y
)paren
(brace
id|mem_out8
c_func
(paren
l_int|0x39
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0xa0
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x46
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
(paren
id|x
op_amp
l_int|0x0700
)paren
op_rshift
l_int|8
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x47
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
id|x
op_amp
l_int|0x00ff
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x48
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
(paren
id|y
op_amp
l_int|0x0700
)paren
op_rshift
l_int|8
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d5
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
l_int|0x49
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d4
)paren
suffix:semicolon
id|mem_out8
c_func
(paren
id|y
op_amp
l_int|0x00ff
comma
id|s3trio_base
op_plus
l_int|0x1008000
op_plus
l_int|0x3d5
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Text console acceleration&n;     */
macro_line|#ifdef FBCON_HAS_CFB8
DECL|function|fbcon_trio8_bmove
r_static
r_void
id|fbcon_trio8_bmove
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
id|sx
op_mul_assign
l_int|8
suffix:semicolon
id|dx
op_mul_assign
l_int|8
suffix:semicolon
id|width
op_mul_assign
l_int|8
suffix:semicolon
id|Trio_BitBLT
c_func
(paren
(paren
id|u_short
)paren
id|sx
comma
(paren
id|u_short
)paren
(paren
id|sy
op_star
id|fontheight
c_func
(paren
id|p
)paren
)paren
comma
(paren
id|u_short
)paren
id|dx
comma
(paren
id|u_short
)paren
(paren
id|dy
op_star
id|fontheight
c_func
(paren
id|p
)paren
)paren
comma
(paren
id|u_short
)paren
id|width
comma
(paren
id|u_short
)paren
(paren
id|height
op_star
id|fontheight
c_func
(paren
id|p
)paren
)paren
comma
(paren
id|u_short
)paren
id|S3_NEW
)paren
suffix:semicolon
)brace
DECL|function|fbcon_trio8_clear
r_static
r_void
id|fbcon_trio8_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_int
r_char
id|bg
suffix:semicolon
id|sx
op_mul_assign
l_int|8
suffix:semicolon
id|width
op_mul_assign
l_int|8
suffix:semicolon
id|bg
op_assign
id|attr_bgcol_ec
c_func
(paren
id|p
comma
id|conp
)paren
suffix:semicolon
id|Trio_RectFill
c_func
(paren
(paren
id|u_short
)paren
id|sx
comma
(paren
id|u_short
)paren
(paren
id|sy
op_star
id|fontheight
c_func
(paren
id|p
)paren
)paren
comma
(paren
id|u_short
)paren
id|width
comma
(paren
id|u_short
)paren
(paren
id|height
op_star
id|fontheight
c_func
(paren
id|p
)paren
)paren
comma
(paren
id|u_short
)paren
id|S3_NEW
comma
(paren
id|u_short
)paren
id|bg
)paren
suffix:semicolon
)brace
DECL|function|fbcon_trio8_putc
r_static
r_void
id|fbcon_trio8_putc
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_int
id|c
comma
r_int
id|yy
comma
r_int
id|xx
)paren
(brace
id|Trio_WaitBlit
c_func
(paren
)paren
suffix:semicolon
id|fbcon_cfb8_putc
c_func
(paren
id|conp
comma
id|p
comma
id|c
comma
id|yy
comma
id|xx
)paren
suffix:semicolon
)brace
DECL|function|fbcon_trio8_putcs
r_static
r_void
id|fbcon_trio8_putcs
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_struct
id|display
op_star
id|p
comma
r_const
r_int
r_int
op_star
id|s
comma
r_int
id|count
comma
r_int
id|yy
comma
r_int
id|xx
)paren
(brace
id|Trio_WaitBlit
c_func
(paren
)paren
suffix:semicolon
id|fbcon_cfb8_putcs
c_func
(paren
id|conp
comma
id|p
comma
id|s
comma
id|count
comma
id|yy
comma
id|xx
)paren
suffix:semicolon
)brace
DECL|function|fbcon_trio8_revc
r_static
r_void
id|fbcon_trio8_revc
c_func
(paren
r_struct
id|display
op_star
id|p
comma
r_int
id|xx
comma
r_int
id|yy
)paren
(brace
id|Trio_WaitBlit
c_func
(paren
)paren
suffix:semicolon
id|fbcon_cfb8_revc
c_func
(paren
id|p
comma
id|xx
comma
id|yy
)paren
suffix:semicolon
)brace
DECL|variable|fbcon_trio8
r_static
r_struct
id|display_switch
id|fbcon_trio8
op_assign
(brace
id|setup
suffix:colon
id|fbcon_cfb8_setup
comma
id|bmove
suffix:colon
id|fbcon_trio8_bmove
comma
id|clear
suffix:colon
id|fbcon_trio8_clear
comma
id|putc
suffix:colon
id|fbcon_trio8_putc
comma
id|putcs
suffix:colon
id|fbcon_trio8_putcs
comma
id|revc
suffix:colon
id|fbcon_trio8_revc
comma
id|clear_margins
suffix:colon
id|fbcon_cfb8_clear_margins
comma
id|fontwidthmask
suffix:colon
id|FONTWIDTH
c_func
(paren
l_int|8
)paren
)brace
suffix:semicolon
macro_line|#endif
eof
