multiline_comment|/*&n; *  linux/drivers/video/tgafb.c -- DEC 21030 TGA frame buffer device&n; *&n; *&t;Copyright (C) 1997 Geert Uytterhoeven&n; *&n; *  This driver is partly based on the original TGA console driver&n; *&n; *&t;Copyright (C) 1995  Jay Estabrook&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License. See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
multiline_comment|/* KNOWN PROBLEMS/TO DO ===================================================== *&n; *&n; *&t;- How to set a single color register?&n; *&n; *&t;- Hardware cursor (useful for other graphics boards too)&n; *&n; * KNOWN PROBLEMS/TO DO ==================================================== */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;fbcon.h&quot;
macro_line|#include &quot;fbcon-cfb8.h&quot;
macro_line|#include &quot;fbcon-cfb32.h&quot;
multiline_comment|/* TGA hardware description (minimal) */
multiline_comment|/*&n; * Offsets within Memory Space&n; */
DECL|macro|TGA_ROM_OFFSET
mdefine_line|#define&t;TGA_ROM_OFFSET&t;&t;&t;0x0000000
DECL|macro|TGA_REGS_OFFSET
mdefine_line|#define&t;TGA_REGS_OFFSET&t;&t;&t;0x0100000
DECL|macro|TGA_8PLANE_FB_OFFSET
mdefine_line|#define&t;TGA_8PLANE_FB_OFFSET&t;&t;0x0200000
DECL|macro|TGA_24PLANE_FB_OFFSET
mdefine_line|#define&t;TGA_24PLANE_FB_OFFSET&t;&t;0x0804000
DECL|macro|TGA_24PLUSZ_FB_OFFSET
mdefine_line|#define&t;TGA_24PLUSZ_FB_OFFSET&t;&t;0x1004000
DECL|macro|TGA_PLANEMASK_REG
mdefine_line|#define&t;TGA_PLANEMASK_REG&t;&t;0x0028
DECL|macro|TGA_MODE_REG
mdefine_line|#define&t;TGA_MODE_REG&t;&t;&t;0x0030
DECL|macro|TGA_RASTEROP_REG
mdefine_line|#define&t;TGA_RASTEROP_REG&t;&t;0x0034
DECL|macro|TGA_DEEP_REG
mdefine_line|#define&t;TGA_DEEP_REG&t;&t;&t;0x0050
DECL|macro|TGA_PIXELMASK_REG
mdefine_line|#define&t;TGA_PIXELMASK_REG&t;&t;0x005c
DECL|macro|TGA_CURSOR_BASE_REG
mdefine_line|#define&t;TGA_CURSOR_BASE_REG&t;&t;0x0060
DECL|macro|TGA_HORIZ_REG
mdefine_line|#define&t;TGA_HORIZ_REG&t;&t;&t;0x0064
DECL|macro|TGA_VERT_REG
mdefine_line|#define&t;TGA_VERT_REG&t;&t;&t;0x0068
DECL|macro|TGA_BASE_ADDR_REG
mdefine_line|#define&t;TGA_BASE_ADDR_REG&t;&t;0x006c
DECL|macro|TGA_VALID_REG
mdefine_line|#define&t;TGA_VALID_REG&t;&t;&t;0x0070
DECL|macro|TGA_CURSOR_XY_REG
mdefine_line|#define&t;TGA_CURSOR_XY_REG&t;&t;0x0074
DECL|macro|TGA_INTR_STAT_REG
mdefine_line|#define&t;TGA_INTR_STAT_REG&t;&t;0x007c
DECL|macro|TGA_RAMDAC_SETUP_REG
mdefine_line|#define&t;TGA_RAMDAC_SETUP_REG&t;&t;0x00c0
DECL|macro|TGA_BLOCK_COLOR0_REG
mdefine_line|#define&t;TGA_BLOCK_COLOR0_REG&t;&t;0x0140
DECL|macro|TGA_BLOCK_COLOR1_REG
mdefine_line|#define&t;TGA_BLOCK_COLOR1_REG&t;&t;0x0144
DECL|macro|TGA_CLOCK_REG
mdefine_line|#define&t;TGA_CLOCK_REG&t;&t;&t;0x01e8
DECL|macro|TGA_RAMDAC_REG
mdefine_line|#define&t;TGA_RAMDAC_REG&t;&t;&t;0x01f0
DECL|macro|TGA_CMD_STAT_REG
mdefine_line|#define&t;TGA_CMD_STAT_REG&t;&t;0x01f8
multiline_comment|/*&n; * useful defines for managing the BT485 on the 8-plane TGA&n; */
DECL|macro|BT485_READ_BIT
mdefine_line|#define&t;BT485_READ_BIT&t;&t;&t;0x01
DECL|macro|BT485_WRITE_BIT
mdefine_line|#define&t;BT485_WRITE_BIT&t;&t;&t;0x00
DECL|macro|BT485_ADDR_PAL_WRITE
mdefine_line|#define&t;BT485_ADDR_PAL_WRITE&t;&t;0x00
DECL|macro|BT485_DATA_PAL
mdefine_line|#define&t;BT485_DATA_PAL&t;&t;&t;0x02
DECL|macro|BT485_PIXEL_MASK
mdefine_line|#define&t;BT485_PIXEL_MASK&t;&t;0x04
DECL|macro|BT485_ADDR_PAL_READ
mdefine_line|#define&t;BT485_ADDR_PAL_READ&t;&t;0x06
DECL|macro|BT485_ADDR_CUR_WRITE
mdefine_line|#define&t;BT485_ADDR_CUR_WRITE&t;&t;0x08
DECL|macro|BT485_DATA_CUR
mdefine_line|#define&t;BT485_DATA_CUR&t;&t;&t;0x0a
DECL|macro|BT485_CMD_0
mdefine_line|#define&t;BT485_CMD_0&t;&t;&t;0x0c
DECL|macro|BT485_ADDR_CUR_READ
mdefine_line|#define&t;BT485_ADDR_CUR_READ&t;&t;0x0e
DECL|macro|BT485_CMD_1
mdefine_line|#define&t;BT485_CMD_1&t;&t;&t;0x10
DECL|macro|BT485_CMD_2
mdefine_line|#define&t;BT485_CMD_2&t;&t;&t;0x12
DECL|macro|BT485_STATUS
mdefine_line|#define&t;BT485_STATUS&t;&t;&t;0x14
DECL|macro|BT485_CMD_3
mdefine_line|#define&t;BT485_CMD_3&t;&t;&t;0x14
DECL|macro|BT485_CUR_RAM
mdefine_line|#define&t;BT485_CUR_RAM&t;&t;&t;0x16
DECL|macro|BT485_CUR_LOW_X
mdefine_line|#define&t;BT485_CUR_LOW_X&t;&t;&t;0x18
DECL|macro|BT485_CUR_HIGH_X
mdefine_line|#define&t;BT485_CUR_HIGH_X&t;&t;0x1a
DECL|macro|BT485_CUR_LOW_Y
mdefine_line|#define&t;BT485_CUR_LOW_Y&t;&t;&t;0x1c
DECL|macro|BT485_CUR_HIGH_Y
mdefine_line|#define&t;BT485_CUR_HIGH_Y&t;&t;0x1e
multiline_comment|/*&n; * useful defines for managing the BT463 on the 24-plane TGAs&n; */
DECL|macro|BT463_ADDR_LO
mdefine_line|#define&t;BT463_ADDR_LO&t;&t;0x0
DECL|macro|BT463_ADDR_HI
mdefine_line|#define&t;BT463_ADDR_HI&t;&t;0x1
DECL|macro|BT463_REG_ACC
mdefine_line|#define&t;BT463_REG_ACC&t;&t;0x2
DECL|macro|BT463_PALETTE
mdefine_line|#define&t;BT463_PALETTE&t;&t;0x3
DECL|macro|BT463_CUR_CLR_0
mdefine_line|#define&t;BT463_CUR_CLR_0&t;&t;0x0100
DECL|macro|BT463_CUR_CLR_1
mdefine_line|#define&t;BT463_CUR_CLR_1&t;&t;0x0101
DECL|macro|BT463_CMD_REG_0
mdefine_line|#define&t;BT463_CMD_REG_0&t;&t;0x0201
DECL|macro|BT463_CMD_REG_1
mdefine_line|#define&t;BT463_CMD_REG_1&t;&t;0x0202
DECL|macro|BT463_CMD_REG_2
mdefine_line|#define&t;BT463_CMD_REG_2&t;&t;0x0203
DECL|macro|BT463_READ_MASK_0
mdefine_line|#define&t;BT463_READ_MASK_0&t;0x0205
DECL|macro|BT463_READ_MASK_1
mdefine_line|#define&t;BT463_READ_MASK_1&t;0x0206
DECL|macro|BT463_READ_MASK_2
mdefine_line|#define&t;BT463_READ_MASK_2&t;0x0207
DECL|macro|BT463_READ_MASK_3
mdefine_line|#define&t;BT463_READ_MASK_3&t;0x0208
DECL|macro|BT463_BLINK_MASK_0
mdefine_line|#define&t;BT463_BLINK_MASK_0&t;0x0209
DECL|macro|BT463_BLINK_MASK_1
mdefine_line|#define&t;BT463_BLINK_MASK_1&t;0x020a
DECL|macro|BT463_BLINK_MASK_2
mdefine_line|#define&t;BT463_BLINK_MASK_2&t;0x020b
DECL|macro|BT463_BLINK_MASK_3
mdefine_line|#define&t;BT463_BLINK_MASK_3&t;0x020c
DECL|macro|BT463_WINDOW_TYPE_BASE
mdefine_line|#define&t;BT463_WINDOW_TYPE_BASE&t;0x0300
DECL|variable|tga_type
r_int
id|tga_type
suffix:semicolon
DECL|variable|tga_mem_base
r_int
r_int
id|tga_mem_base
suffix:semicolon
DECL|variable|tga_fb_base
r_int
r_int
id|tga_fb_base
suffix:semicolon
DECL|variable|tga_regs_base
r_int
r_int
id|tga_regs_base
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|fb_offset_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
id|TGA_8PLANE_FB_OFFSET
comma
id|TGA_24PLANE_FB_OFFSET
comma
l_int|0xffffffff
comma
id|TGA_24PLUSZ_FB_OFFSET
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|deep_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
l_int|0x00014000
comma
l_int|0x0001440d
comma
l_int|0xffffffff
comma
l_int|0x0001441d
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|rasterop_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
l_int|0x00000003
comma
l_int|0x00000303
comma
l_int|0xffffffff
comma
l_int|0x00000303
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|mode_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
l_int|0x00002000
comma
l_int|0x00002300
comma
l_int|0xffffffff
comma
l_int|0x00002300
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|base_addr_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
l_int|0x00000000
comma
l_int|0x00000001
comma
l_int|0xffffffff
comma
l_int|0x00000001
)brace
suffix:semicolon
DECL|macro|TGA_WRITE_REG
mdefine_line|#define TGA_WRITE_REG(v,r) &bslash;&n;&t;{ writel((v), tga_regs_base+(r)); mb(); }
DECL|macro|TGA_READ_REG
mdefine_line|#define TGA_READ_REG(r) readl(tga_regs_base+(r))
DECL|macro|BT485_WRITE
mdefine_line|#define BT485_WRITE(v,r) &bslash;&n;&t;  TGA_WRITE_REG((r),TGA_RAMDAC_SETUP_REG);&t;&t;&bslash;&n;&t;  TGA_WRITE_REG(((v)&amp;0xff)|((r)&lt;&lt;8),TGA_RAMDAC_REG);
DECL|macro|BT463_LOAD_ADDR
mdefine_line|#define BT463_LOAD_ADDR(a) &bslash;&n;&t;TGA_WRITE_REG(BT463_ADDR_LO&lt;&lt;2, TGA_RAMDAC_SETUP_REG); &bslash;&n;&t;TGA_WRITE_REG((BT463_ADDR_LO&lt;&lt;10)|((a)&amp;0xff), TGA_RAMDAC_REG); &bslash;&n;&t;TGA_WRITE_REG(BT463_ADDR_HI&lt;&lt;2, TGA_RAMDAC_SETUP_REG); &bslash;&n;&t;TGA_WRITE_REG((BT463_ADDR_HI&lt;&lt;10)|(((a)&gt;&gt;8)&amp;0xff), TGA_RAMDAC_REG);
DECL|macro|BT463_WRITE
mdefine_line|#define BT463_WRITE(m,a,v) &bslash;&n;&t;BT463_LOAD_ADDR((a)); &bslash;&n;&t;TGA_WRITE_REG(((m)&lt;&lt;2),TGA_RAMDAC_SETUP_REG); &bslash;&n;&t;TGA_WRITE_REG(((m)&lt;&lt;10)|((v)&amp;0xff),TGA_RAMDAC_REG);
DECL|variable|__initdata
r_int
r_char
id|PLLbits
(braket
l_int|7
)braket
id|__initdata
op_assign
(brace
l_int|0x80
comma
l_int|0x04
comma
l_int|0x00
comma
l_int|0x24
comma
l_int|0x44
comma
l_int|0x80
comma
l_int|0xb8
)brace
suffix:semicolon
DECL|variable|__initdata
r_const
r_int
r_int
id|bt485_cursor_source
(braket
l_int|64
)braket
id|__initdata
op_assign
(brace
macro_line|#if 1
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
l_int|0x0000000000000000
comma
macro_line|#else
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
macro_line|#endif
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|__initdata
r_const
r_int
r_int
id|bt463_cursor_source
(braket
l_int|256
)braket
id|__initdata
op_assign
(brace
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|arraysize
mdefine_line|#define arraysize(x)&t;(sizeof(x)/sizeof(*(x)))
DECL|variable|currcon
r_static
r_int
id|currcon
op_assign
l_int|0
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
suffix:semicolon
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|pad
DECL|variable|palette
r_static
r_struct
(brace
id|u_char
id|red
comma
id|green
comma
id|blue
comma
id|pad
suffix:semicolon
)brace
id|palette
(braket
l_int|256
)braket
suffix:semicolon
DECL|variable|fb_fix
r_static
r_struct
id|fb_fix_screeninfo
id|fb_fix
op_assign
(brace
(brace
l_string|&quot;DEC TGA &quot;
comma
)brace
)brace
suffix:semicolon
DECL|variable|fb_var
r_static
r_struct
id|fb_var_screeninfo
id|fb_var
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/*&n;     *  Interface used by the world&n;     */
r_static
r_int
id|tgafb_open
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_static
r_int
id|tgafb_release
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
suffix:semicolon
r_static
r_int
id|tgafb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tgafb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tgafb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tgafb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tgafb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tgafb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tgafb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;     *  Interface to the low level console driver&n;     */
r_void
id|tgafb_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|tgafbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tgafbcon_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tgafbcon_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/*&n;     *  Internal routines&n;     */
r_static
r_int
id|tgafb_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|tgafb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
macro_line|#if 1
r_static
r_void
id|tga_update_palette
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
DECL|variable|tgafb_ops
r_static
r_struct
id|fb_ops
id|tgafb_ops
op_assign
(brace
id|tgafb_open
comma
id|tgafb_release
comma
id|tgafb_get_fix
comma
id|tgafb_get_var
comma
id|tgafb_set_var
comma
id|tgafb_get_cmap
comma
id|tgafb_set_cmap
comma
id|tgafb_pan_display
comma
id|tgafb_ioctl
)brace
suffix:semicolon
multiline_comment|/*&n;     *  Open/Release the frame buffer device&n;     */
DECL|function|tgafb_open
r_static
r_int
id|tgafb_open
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
multiline_comment|/*                                                                     &n;     *  Nothing, only a usage count for the moment                          &n;     */
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tgafb_release
r_static
r_int
id|tgafb_release
c_func
(paren
r_struct
id|fb_info
op_star
id|info
comma
r_int
id|user
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Get the Fixed Part of the Display&n;     */
DECL|function|tgafb_get_fix
r_static
r_int
id|tgafb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|memcpy
c_func
(paren
id|fix
comma
op_amp
id|fb_fix
comma
r_sizeof
(paren
id|fb_fix
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Get the User Defined Part of the Display&n;     */
DECL|function|tgafb_get_var
r_static
r_int
id|tgafb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|memcpy
c_func
(paren
id|var
comma
op_amp
id|fb_var
comma
r_sizeof
(paren
id|fb_var
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Set the User Defined Part of the Display&n;     */
DECL|function|tgafb_set_var
r_static
r_int
id|tgafb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|display
op_star
id|display
suffix:semicolon
r_int
id|oldbpp
op_assign
op_minus
l_int|1
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
id|display
op_assign
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
r_else
id|display
op_assign
op_amp
id|disp
suffix:semicolon
multiline_comment|/* used during initialization */
r_if
c_cond
(paren
id|var-&gt;xres
OG
id|fb_var.xres
op_logical_or
id|var-&gt;yres
OG
id|fb_var.yres
op_logical_or
id|var-&gt;xres_virtual
OG
id|fb_var.xres_virtual
op_logical_or
id|var-&gt;yres_virtual
OG
id|fb_var.yres_virtual
op_logical_or
id|var-&gt;bits_per_pixel
OG
id|fb_var.bits_per_pixel
op_logical_or
id|var-&gt;nonstd
op_logical_or
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_MASK
)paren
op_ne
id|FB_VMODE_NONINTERLACED
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
id|var
comma
op_amp
id|fb_var
comma
r_sizeof
(paren
id|fb_var
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_NOW
)paren
(brace
id|oldbpp
op_assign
id|display-&gt;var.bits_per_pixel
suffix:semicolon
id|display-&gt;var
op_assign
op_star
id|var
suffix:semicolon
)brace
r_if
c_cond
(paren
id|oldbpp
op_ne
id|var-&gt;bits_per_pixel
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|display-&gt;cmap
comma
l_int|0
comma
l_int|0
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|do_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Pan or Wrap the Display&n;     *&n;     *  This call looks only at xoffset, yoffset and the FB_VMODE_YWRAP flag&n;     */
DECL|function|tgafb_pan_display
r_static
r_int
id|tgafb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|var-&gt;xoffset
op_logical_or
id|var-&gt;yoffset
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Get the Colormap&n;     */
DECL|function|tgafb_get_cmap
r_static
r_int
id|tgafb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console? */
r_return
id|fb_get_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
id|kspc
comma
id|tgafb_getcolreg
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
multiline_comment|/* non default colormap? */
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Set the Colormap&n;     */
DECL|function|tgafb_set_cmap
r_static
r_int
id|tgafb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
(brace
multiline_comment|/* no colormap allocated? */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
comma
l_int|0
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
(brace
multiline_comment|/* current console? */
id|err
op_assign
id|fb_set_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
id|kspc
comma
id|tgafb_setcolreg
comma
id|info
)paren
suffix:semicolon
macro_line|#if 1
id|tga_update_palette
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|err
suffix:semicolon
)brace
r_else
id|fb_copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tgafb_ioctl
r_static
r_int
id|tgafb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Initialisation&n;     */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|tgafb_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|j
comma
id|temp
suffix:semicolon
r_int
r_char
op_star
id|cbp
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_DEC
comma
id|PCI_DEVICE_ID_DEC_TGA
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
r_return
suffix:semicolon
id|tga_mem_base
op_assign
id|pdev-&gt;base_address
(braket
l_int|0
)braket
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;tgafb_init: mem_base 0x%x&bslash;n&quot;
comma
id|tga_mem_base
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
id|tga_type
op_assign
(paren
id|readl
c_func
(paren
(paren
r_int
r_int
)paren
id|tga_mem_base
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_switch
c_cond
(paren
id|tga_type
)paren
(brace
r_case
l_int|0
suffix:colon
id|strcat
c_func
(paren
id|fb_fix.id
comma
l_string|&quot;8plane&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|strcat
c_func
(paren
id|fb_fix.id
comma
l_string|&quot;24plane&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|strcat
c_func
(paren
id|fb_fix.id
comma
l_string|&quot;24plusZ&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;TGA type (0x%x) unrecognized!&bslash;n&quot;
comma
id|tga_type
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tga_regs_base
op_assign
(paren
(paren
r_int
r_int
)paren
id|tga_mem_base
op_plus
id|TGA_REGS_OFFSET
)paren
suffix:semicolon
id|tga_fb_base
op_assign
(paren
(paren
r_int
r_int
)paren
id|tga_mem_base
op_plus
id|fb_offset_presets
(braket
id|tga_type
)braket
)paren
suffix:semicolon
multiline_comment|/* first, disable video timing */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x03
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING and BLANK */
multiline_comment|/* write the DEEP register */
r_while
c_loop
(paren
id|TGA_READ_REG
c_func
(paren
id|TGA_CMD_STAT_REG
)paren
op_amp
l_int|1
)paren
multiline_comment|/* wait for not busy */
r_continue
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|deep_presets
(braket
id|tga_type
)braket
comma
id|TGA_DEEP_REG
)paren
suffix:semicolon
r_while
c_loop
(paren
id|TGA_READ_REG
c_func
(paren
id|TGA_CMD_STAT_REG
)paren
op_amp
l_int|1
)paren
multiline_comment|/* wait for not busy */
r_continue
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* write some more registers */
id|TGA_WRITE_REG
c_func
(paren
id|rasterop_presets
(braket
id|tga_type
)braket
comma
id|TGA_RASTEROP_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|mode_presets
(braket
id|tga_type
)braket
comma
id|TGA_MODE_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|base_addr_presets
(braket
id|tga_type
)braket
comma
id|TGA_BASE_ADDR_REG
)paren
suffix:semicolon
multiline_comment|/* write the PLL for 640x480 @ 60Hz */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
l_int|7
suffix:semicolon
id|j
op_increment
)paren
(brace
id|temp
op_assign
(paren
id|PLLbits
(braket
id|i
)braket
op_rshift
(paren
l_int|7
op_minus
id|j
)paren
)paren
op_amp
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|6
op_logical_and
id|j
op_eq
l_int|7
)paren
id|temp
op_or_assign
l_int|2
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|temp
comma
id|TGA_CLOCK_REG
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* write some more registers */
id|TGA_WRITE_REG
c_func
(paren
l_int|0xffffffff
comma
id|TGA_PLANEMASK_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0xffffffff
comma
id|TGA_PIXELMASK_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x12345678
comma
id|TGA_BLOCK_COLOR0_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x12345678
comma
id|TGA_BLOCK_COLOR1_REG
)paren
suffix:semicolon
multiline_comment|/* init video timing regs for 640x480 @ 60 Hz */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x018608a0
comma
id|TGA_HORIZ_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x084251e0
comma
id|TGA_VERT_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8-plane */
id|fb_var.bits_per_pixel
op_assign
l_int|8
suffix:semicolon
id|fb_fix.visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
multiline_comment|/* init BT485 RAMDAC registers */
id|BT485_WRITE
c_func
(paren
l_int|0xa2
comma
id|BT485_CMD_0
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
l_int|0x01
comma
id|BT485_ADDR_PAL_WRITE
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
l_int|0x14
comma
id|BT485_CMD_3
)paren
suffix:semicolon
multiline_comment|/* cursor 64x64 */
id|BT485_WRITE
c_func
(paren
l_int|0x40
comma
id|BT485_CMD_1
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
l_int|0x22
comma
id|BT485_CMD_2
)paren
suffix:semicolon
multiline_comment|/* WIN cursor type */
id|BT485_WRITE
c_func
(paren
l_int|0xff
comma
id|BT485_PIXEL_MASK
)paren
suffix:semicolon
multiline_comment|/* fill palette registers */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_ADDR_PAL_WRITE
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|BT485_DATA_PAL
comma
id|TGA_RAMDAC_SETUP_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
id|color_table
(braket
id|i
)braket
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_red
(braket
id|j
)braket
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_grn
(braket
id|j
)braket
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_blu
(braket
id|j
)braket
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|palette
(braket
id|i
)braket
dot
id|red
op_assign
id|default_red
(braket
id|j
)braket
suffix:semicolon
id|palette
(braket
id|i
)braket
dot
id|green
op_assign
id|default_grn
(braket
id|j
)braket
suffix:semicolon
id|palette
(braket
id|i
)braket
dot
id|blue
op_assign
id|default_blu
(braket
id|j
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|240
op_star
l_int|3
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|TGA_WRITE_REG
c_func
(paren
l_int|0x55
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
multiline_comment|/* initialize RAMDAC cursor colors */
id|BT485_WRITE
c_func
(paren
l_int|0
comma
id|BT485_ADDR_CUR_WRITE
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* overscan WHITE */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* overscan WHITE */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* overscan WHITE */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 1 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 1 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 1 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 2 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 2 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 2 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 3 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 3 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 3 BLACK */
multiline_comment|/* initialize RAMDAC cursor RAM */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_ADDR_PAL_WRITE
)paren
suffix:semicolon
id|cbp
op_assign
(paren
r_int
r_char
op_star
)paren
id|bt485_cursor_source
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BT485_WRITE
c_func
(paren
op_star
id|cbp
op_increment
comma
id|BT485_CUR_RAM
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BT485_WRITE
c_func
(paren
l_int|0xff
comma
id|BT485_CUR_RAM
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* 24-plane or 24plusZ */
id|fb_var.bits_per_pixel
op_assign
l_int|32
suffix:semicolon
id|fb_fix.visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x01
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING */
multiline_comment|/*&n;&t; * init some registers&n;&t; */
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_CMD_REG_0
comma
l_int|0x40
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_CMD_REG_1
comma
l_int|0x08
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_CMD_REG_2
comma
l_int|0x40
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_READ_MASK_0
comma
l_int|0xff
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_READ_MASK_1
comma
l_int|0xff
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_READ_MASK_2
comma
l_int|0xff
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_READ_MASK_3
comma
l_int|0x0f
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_BLINK_MASK_0
comma
l_int|0x00
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_BLINK_MASK_1
comma
l_int|0x00
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_BLINK_MASK_2
comma
l_int|0x00
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_BLINK_MASK_3
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * fill the palette&n;&t; */
id|BT463_LOAD_ADDR
c_func
(paren
l_int|0x0000
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
(paren
id|BT463_PALETTE
op_lshift
l_int|2
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
id|color_table
(braket
id|i
)braket
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_red
(braket
id|j
)braket
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_grn
(braket
id|j
)braket
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_blu
(braket
id|j
)braket
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
op_star
l_int|3
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|TGA_WRITE_REG
c_func
(paren
l_int|0x55
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * fill window type table after start of vertical retrace&n;&t; */
r_while
c_loop
(paren
op_logical_neg
(paren
id|TGA_READ_REG
c_func
(paren
id|TGA_INTR_STAT_REG
)paren
op_amp
l_int|0x01
)paren
)paren
r_continue
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x01
comma
id|TGA_INTR_STAT_REG
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|TGA_READ_REG
c_func
(paren
id|TGA_INTR_STAT_REG
)paren
op_amp
l_int|0x01
)paren
)paren
r_continue
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x01
comma
id|TGA_INTR_STAT_REG
)paren
suffix:semicolon
id|BT463_LOAD_ADDR
c_func
(paren
id|BT463_WINDOW_TYPE_BASE
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
(paren
id|BT463_REG_ACC
op_lshift
l_int|2
)paren
comma
id|TGA_RAMDAC_SETUP_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x01
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x80
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * init cursor colors&n;&t; */
id|BT463_LOAD_ADDR
c_func
(paren
id|BT463_CUR_CLR_0
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* background */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* background */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* background */
id|TGA_WRITE_REG
c_func
(paren
l_int|0xff
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* foreground */
id|TGA_WRITE_REG
c_func
(paren
l_int|0xff
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* foreground */
id|TGA_WRITE_REG
c_func
(paren
l_int|0xff
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* foreground */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * finally, init the cursor shape&n;&t; */
id|temp
op_assign
id|tga_fb_base
op_minus
l_int|1024
suffix:semicolon
multiline_comment|/* this assumes video starts at base&n;&t;&t;&t;&t;     and base is beyond memory start*/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
id|bt463_cursor_source
(braket
id|i
)braket
comma
id|temp
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
id|TGA_WRITE_REG
c_func
(paren
id|temp
op_amp
l_int|0x000fffff
comma
id|TGA_CURSOR_BASE_REG
)paren
suffix:semicolon
)brace
multiline_comment|/* finally, enable video scan &amp; cursor&n;       (and pray for the monitor... :-) */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x05
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING and CURSOR */
id|fb_var.xres
op_assign
id|fb_var.xres_virtual
op_assign
l_int|640
suffix:semicolon
id|fb_var.yres
op_assign
id|fb_var.yres_virtual
op_assign
l_int|480
suffix:semicolon
id|fb_fix.line_length
op_assign
l_int|80
op_star
id|fb_var.bits_per_pixel
suffix:semicolon
id|fb_fix.smem_start
op_assign
(paren
r_char
op_star
)paren
id|__pa
c_func
(paren
id|tga_fb_base
op_plus
id|DENSE_MEM
c_func
(paren
id|tga_fb_base
)paren
)paren
suffix:semicolon
id|fb_fix.smem_len
op_assign
id|fb_fix.line_length
op_star
id|fb_var.yres
suffix:semicolon
id|fb_fix.type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fb_fix.type_aux
op_assign
l_int|0
suffix:semicolon
id|fb_fix.mmio_start
op_assign
(paren
r_char
op_star
)paren
id|__pa
c_func
(paren
id|tga_regs_base
)paren
suffix:semicolon
id|fb_fix.mmio_len
op_assign
l_int|0x1000
suffix:semicolon
multiline_comment|/* Is this sufficient? */
id|fb_fix.accel
op_assign
id|FB_ACCEL_DEC_TGA
suffix:semicolon
id|fb_var.xoffset
op_assign
id|fb_var.yoffset
op_assign
l_int|0
suffix:semicolon
id|fb_var.grayscale
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8-plane */
id|fb_var.red.offset
op_assign
l_int|0
suffix:semicolon
id|fb_var.green.offset
op_assign
l_int|0
suffix:semicolon
id|fb_var.blue.offset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 24-plane or 24plusZ */
multiline_comment|/* XXX: is this correct?? */
id|fb_var.red.offset
op_assign
l_int|16
suffix:semicolon
id|fb_var.green.offset
op_assign
l_int|8
suffix:semicolon
id|fb_var.blue.offset
op_assign
l_int|0
suffix:semicolon
)brace
id|fb_var.red.length
op_assign
id|fb_var.green.length
op_assign
id|fb_var.blue.length
op_assign
l_int|8
suffix:semicolon
id|fb_var.red.msb_right
op_assign
id|fb_var.green.msb_right
op_assign
id|fb_var.blue.msb_right
op_assign
l_int|0
suffix:semicolon
id|fb_var.transp.offset
op_assign
id|fb_var.transp.length
op_assign
id|fb_var.transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|fb_var.nonstd
op_assign
l_int|0
suffix:semicolon
id|fb_var.activate
op_assign
l_int|0
suffix:semicolon
id|fb_var.height
op_assign
id|fb_var.width
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_var.accel_flags
op_assign
l_int|0
suffix:semicolon
id|fb_var.pixclock
op_assign
l_int|39722
suffix:semicolon
id|fb_var.left_margin
op_assign
l_int|40
suffix:semicolon
id|fb_var.right_margin
op_assign
l_int|24
suffix:semicolon
id|fb_var.upper_margin
op_assign
l_int|32
suffix:semicolon
id|fb_var.lower_margin
op_assign
l_int|11
suffix:semicolon
id|fb_var.hsync_len
op_assign
l_int|96
suffix:semicolon
id|fb_var.vsync_len
op_assign
l_int|2
suffix:semicolon
id|fb_var.sync
op_assign
l_int|0
suffix:semicolon
id|fb_var.vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
id|disp.var
op_assign
id|fb_var
suffix:semicolon
id|disp.cmap.start
op_assign
l_int|0
suffix:semicolon
id|disp.cmap.len
op_assign
l_int|0
suffix:semicolon
id|disp.cmap.red
op_assign
id|disp.cmap.green
op_assign
id|disp.cmap.blue
op_assign
id|disp.cmap.transp
op_assign
l_int|NULL
suffix:semicolon
id|disp.screen_base
op_assign
(paren
r_char
op_star
)paren
id|tga_fb_base
op_plus
id|DENSE_MEM
c_func
(paren
id|tga_fb_base
)paren
suffix:semicolon
id|disp.visual
op_assign
id|fb_fix.visual
suffix:semicolon
id|disp.type
op_assign
id|fb_fix.type
suffix:semicolon
id|disp.type_aux
op_assign
id|fb_fix.type_aux
suffix:semicolon
id|disp.ypanstep
op_assign
l_int|0
suffix:semicolon
id|disp.ywrapstep
op_assign
l_int|0
suffix:semicolon
id|disp.line_length
op_assign
id|fb_fix.line_length
suffix:semicolon
id|disp.can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|disp.inverse
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|tga_type
)paren
(brace
macro_line|#ifdef CONFIG_FBCON_CFB8
r_case
l_int|0
suffix:colon
multiline_comment|/* 8-plane */
id|disp.dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
id|disp.scrollmode
op_assign
id|SCROLL_YREDRAW
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FBCON_CFB32
r_case
l_int|1
suffix:colon
multiline_comment|/* 24-plane */
r_case
l_int|3
suffix:colon
multiline_comment|/* 24plusZ */
id|disp.dispsw
op_assign
op_amp
id|fbcon_cfb32
suffix:semicolon
id|disp.scrollmode
op_assign
id|SCROLL_YREDRAW
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|disp.dispsw
op_assign
l_int|NULL
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|fb_info.modename
comma
id|fb_fix.id
)paren
suffix:semicolon
id|fb_info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|tgafb_ops
suffix:semicolon
id|fb_info.disp
op_assign
op_amp
id|disp
suffix:semicolon
id|fb_info.fontname
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|fb_info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.switch_con
op_assign
op_amp
id|tgafbcon_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
op_amp
id|tgafbcon_updatevar
suffix:semicolon
id|fb_info.blank
op_assign
op_amp
id|tgafbcon_blank
suffix:semicolon
id|tgafb_set_var
c_func
(paren
op_amp
id|fb_var
comma
op_minus
l_int|1
comma
op_amp
id|fb_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fb%d: %s frame buffer device&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|fb_info.node
)paren
comma
id|fb_fix.id
)paren
suffix:semicolon
)brace
DECL|function|tgafbcon_switch
r_static
r_int
id|tgafbcon_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* Do we have to save the colormap? */
r_if
c_cond
(paren
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap.len
)paren
id|fb_get_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap
comma
op_amp
id|fb_display
(braket
id|currcon
)braket
dot
id|var
comma
l_int|1
comma
id|tgafb_getcolreg
comma
id|info
)paren
suffix:semicolon
id|currcon
op_assign
id|con
suffix:semicolon
multiline_comment|/* Install new colormap */
id|do_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Update the `var&squot; structure (called by fbcon.c)&n;     */
DECL|function|tgafbcon_updatevar
r_static
r_int
id|tgafbcon_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* Nothing */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Blank the display.&n;     */
DECL|function|tgafbcon_blank
r_static
r_void
id|tgafbcon_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* Nothing */
)brace
multiline_comment|/*&n;     *  Read a single color register and split it into&n;     *  colors/transparent. Return != 0 for invalid regno.&n;     */
DECL|function|tgafb_getcolreg
r_static
r_int
id|tgafb_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
id|palette
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
id|palette
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
id|palette
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     *  Set a single color register. The values supplied are already&n;     *  rounded down to the hardware&squot;s capabilities (according to the&n;     *  entries in the var structure). Return != 0 for invalid regno.&n;     */
DECL|function|tgafb_setcolreg
r_static
r_int
id|tgafb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|palette
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
macro_line|#ifdef CONFIG_FBCON_CFB32
r_if
c_cond
(paren
id|regno
OL
l_int|16
op_logical_and
id|tga_type
op_ne
l_int|0
)paren
id|fbcon_cfb32_cmap
(braket
id|regno
)braket
op_assign
(paren
id|red
op_lshift
l_int|16
)paren
op_or
(paren
id|green
op_lshift
l_int|8
)paren
op_or
id|blue
suffix:semicolon
macro_line|#endif /* CONFIG_FBCON_CFB32 */
multiline_comment|/* How to set a single color register?? */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 1
multiline_comment|/*&n;     *&t;FIXME: since I don&squot;t know how to set a single arbitrary color register,&n;     *  all color palette registers have to be updated&n;     */
DECL|function|tga_update_palette
r_static
r_void
id|tga_update_palette
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8-plane */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_ADDR_PAL_WRITE
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|BT485_DATA_PAL
comma
id|TGA_RAMDAC_SETUP_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TGA_WRITE_REG
c_func
(paren
id|palette
(braket
id|i
)braket
dot
id|red
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|palette
(braket
id|i
)braket
dot
id|green
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|palette
(braket
id|i
)braket
dot
id|blue
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|BT463_LOAD_ADDR
c_func
(paren
l_int|0x0000
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
(paren
id|BT463_PALETTE
op_lshift
l_int|2
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TGA_WRITE_REG
c_func
(paren
id|palette
(braket
id|i
)braket
dot
id|red
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|palette
(braket
id|i
)braket
dot
id|green
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|palette
(braket
id|i
)braket
dot
id|blue
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
DECL|function|do_install_cmap
r_static
r_void
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_ne
id|currcon
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_set_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
l_int|1
comma
id|tgafb_setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_set_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
l_int|1
comma
id|tgafb_setcolreg
comma
id|info
)paren
suffix:semicolon
macro_line|#if 1
id|tga_update_palette
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if 0&t;/* No cursor stuff yet */
multiline_comment|/*&n; * Hide the cursor from view, during blanking, usually...&n; */
r_void
id|hide_cursor
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
id|BT485_WRITE
c_func
(paren
l_int|0x20
comma
id|BT485_CMD_2
)paren
suffix:semicolon
)brace
r_else
(brace
id|TGA_WRITE_REG
c_func
(paren
l_int|0x03
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING and BLANK */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_void
id|set_cursor
c_func
(paren
r_int
id|currcons
)paren
(brace
r_int
r_int
id|idx
comma
id|xt
comma
id|yt
comma
id|row
comma
id|col
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|currcons
op_ne
id|fg_console
op_logical_or
id|console_blanked
op_logical_or
id|vcmode
op_eq
id|KD_GRAPHICS
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|deccm
)paren
(brace
id|idx
op_assign
(paren
id|pos
op_minus
id|video_mem_base
)paren
op_rshift
l_int|1
suffix:semicolon
id|col
op_assign
id|idx
op_mod
l_int|80
suffix:semicolon
id|row
op_assign
(paren
id|idx
op_minus
id|col
)paren
op_div
l_int|80
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8-plane */
id|xt
op_assign
id|col
op_star
id|TGA_F_WIDTH
op_plus
l_int|64
suffix:semicolon
id|yt
op_assign
id|row
op_star
id|TGA_F_HEIGHT_PADDED
op_plus
l_int|64
suffix:semicolon
multiline_comment|/* make sure it&squot;s enabled */
id|BT485_WRITE
c_func
(paren
l_int|0x22
comma
id|BT485_CMD_2
)paren
suffix:semicolon
multiline_comment|/* WIN cursor type */
id|BT485_WRITE
c_func
(paren
id|xt
comma
id|BT485_CUR_LOW_X
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
(paren
id|xt
op_rshift
l_int|8
)paren
comma
id|BT485_CUR_HIGH_X
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
id|yt
comma
id|BT485_CUR_LOW_Y
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
(paren
id|yt
op_rshift
l_int|8
)paren
comma
id|BT485_CUR_HIGH_Y
)paren
suffix:semicolon
)brace
r_else
(brace
id|xt
op_assign
id|col
op_star
id|TGA_F_WIDTH
op_plus
l_int|144
suffix:semicolon
id|yt
op_assign
id|row
op_star
id|TGA_F_HEIGHT_PADDED
op_plus
l_int|35
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x05
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING and CURSOR */
id|TGA_WRITE_REG
c_func
(paren
id|xt
op_or
(paren
id|yt
op_lshift
l_int|12
)paren
comma
id|TGA_CURSOR_XY_REG
)paren
suffix:semicolon
)brace
)brace
r_else
id|hide_cursor
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
