multiline_comment|/*&n; * linux/drivers/video/atafb.c -- Atari builtin chipset frame buffer device&n; *&n; *  Copyright (C) 1994 Martin Schaller &amp; Roman Hodek&n; *  &n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; *&n; * History:&n; *   - 03 Jan 95: Original version by Martin Schaller: The TT driver and&n; *                all the device independent stuff&n; *   - 09 Jan 95: Roman: I&squot;ve added the hardware abstraction (hw_switch)&n; *                and wrote the Falcon, ST(E), and External drivers&n; *                based on the original TT driver.&n; *   - 07 May 95: Martin: Added colormap operations for the external driver&n; *   - 21 May 95: Martin: Added support for overscan&n; *&t;&t;  Andreas: some bug fixes for this&n; *   -    Jul 95: Guenther Kelleter &lt;guenther@pool.informatik.rwth-aachen.de&gt;:&n; *                Programmable Falcon video modes&n; *                (thanks to Christian Cartus for documentation&n; *                of VIDEL registers).&n; *   - 27 Dec 95: Guenther: Implemented user definable video modes &quot;user[0-7]&quot;&n; *                on minor 24...31. &quot;user0&quot; may be set on commandline by&n; *                &quot;R&lt;x&gt;;&lt;y&gt;;&lt;depth&gt;&quot;. (Makes sense only on Falcon)&n; *                Video mode switch on Falcon now done at next VBL interrupt&n; *                to avoid the annoying right shift of the screen.&n; *   - 23 Sep 97: Juergen: added xres_virtual for cards like ProMST&n; *                The external-part is legacy, therefore hardware-specific&n; *                functions like panning/hardwarescrolling/blanking isn&squot;t&n; *&t;&t;&t;&t;  supported.&n; *   - 29 Sep 97: Juergen: added Romans suggestion for pan_display&n; *&t;&t;&t;&t;  (var-&gt;xoffset was changed even if no set_screen_base avail.)&n; *&t; - 05 Oct 97: Juergen: extfb (PACKED_PIXEL) is FB_PSEUDOCOLOR &squot;cause&n; *&t;&t;&t;&t;  we know how to set the colors&n; *&t;&t;&t;&t;  ext_*palette: read from ext_colors (former MV300_colors)&n; *&t;&t;&t;&t;&t;&t;&t;    write to ext_colors and RAMDAC&n; *&n; * To do:&n; *   - For the Falcon it is not possible to set random video modes on&n; *     SM124 and SC/TV, only the bootup resolution is supported.&n; *&n; */
DECL|macro|ATAFB_TT
mdefine_line|#define ATAFB_TT
DECL|macro|ATAFB_STE
mdefine_line|#define ATAFB_STE
DECL|macro|ATAFB_EXT
mdefine_line|#define ATAFB_EXT
DECL|macro|ATAFB_FALCON
mdefine_line|#define ATAFB_FALCON
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/atarihw.h&gt;
macro_line|#include &lt;asm/atariints.h&gt;
macro_line|#include &lt;asm/atari_stram.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;asm/atarikb.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-cfb8.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
macro_line|#include &lt;video/fbcon-iplan2p2.h&gt;
macro_line|#include &lt;video/fbcon-iplan2p4.h&gt;
macro_line|#include &lt;video/fbcon-iplan2p8.h&gt;
macro_line|#include &lt;video/fbcon-mfb.h&gt;
DECL|macro|SWITCH_ACIA
mdefine_line|#define SWITCH_ACIA 0x01&t;&t;/* modes for switch on OverScan */
DECL|macro|SWITCH_SND6
mdefine_line|#define SWITCH_SND6 0x40
DECL|macro|SWITCH_SND7
mdefine_line|#define SWITCH_SND7 0x80
DECL|macro|SWITCH_NONE
mdefine_line|#define SWITCH_NONE 0x00
DECL|macro|up
mdefine_line|#define up(x, r) (((x) + (r) - 1) &amp; ~((r)-1))
DECL|variable|default_par
r_static
r_int
id|default_par
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* default resolution (0=none) */
DECL|variable|default_mem_req
r_static
r_int
r_int
id|default_mem_req
op_assign
l_int|0
suffix:semicolon
DECL|variable|hwscroll
r_static
r_int
id|hwscroll
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|use_hwscroll
r_static
r_int
id|use_hwscroll
op_assign
l_int|1
suffix:semicolon
DECL|variable|sttt_xres
DECL|variable|st_yres
DECL|variable|tt_yres
r_static
r_int
id|sttt_xres
op_assign
l_int|640
comma
id|st_yres
op_assign
l_int|400
comma
id|tt_yres
op_assign
l_int|480
suffix:semicolon
DECL|variable|sttt_xres_virtual
DECL|variable|sttt_yres_virtual
r_static
r_int
id|sttt_xres_virtual
op_assign
l_int|640
comma
id|sttt_yres_virtual
op_assign
l_int|400
suffix:semicolon
DECL|variable|ovsc_offset
DECL|variable|ovsc_addlen
r_static
r_int
id|ovsc_offset
op_assign
l_int|0
comma
id|ovsc_addlen
op_assign
l_int|0
suffix:semicolon
DECL|struct|atafb_par
r_static
r_struct
id|atafb_par
(brace
DECL|member|screen_base
r_void
op_star
id|screen_base
suffix:semicolon
DECL|member|yres_virtual
r_int
id|yres_virtual
suffix:semicolon
macro_line|#if defined ATAFB_TT || defined ATAFB_STE
r_union
(brace
r_struct
(brace
DECL|member|mode
r_int
id|mode
suffix:semicolon
DECL|member|sync
r_int
id|sync
suffix:semicolon
DECL|member|tt
DECL|member|st
)brace
id|tt
comma
id|st
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ATAFB_FALCON
DECL|struct|falcon_hw
r_struct
id|falcon_hw
(brace
multiline_comment|/* Here are fields for storing a video mode, as direct&n;&t;&t;&t; * parameters for the hardware.&n;&t;&t;&t; */
DECL|member|sync
r_int
id|sync
suffix:semicolon
DECL|member|line_width
r_int
id|line_width
suffix:semicolon
DECL|member|line_offset
r_int
id|line_offset
suffix:semicolon
DECL|member|st_shift
r_int
id|st_shift
suffix:semicolon
DECL|member|f_shift
r_int
id|f_shift
suffix:semicolon
DECL|member|vid_control
r_int
id|vid_control
suffix:semicolon
DECL|member|vid_mode
r_int
id|vid_mode
suffix:semicolon
DECL|member|xoffset
r_int
id|xoffset
suffix:semicolon
DECL|member|hht
DECL|member|hbb
DECL|member|hbe
DECL|member|hdb
DECL|member|hde
DECL|member|hss
r_int
id|hht
comma
id|hbb
comma
id|hbe
comma
id|hdb
comma
id|hde
comma
id|hss
suffix:semicolon
DECL|member|vft
DECL|member|vbb
DECL|member|vbe
DECL|member|vdb
DECL|member|vde
DECL|member|vss
r_int
id|vft
comma
id|vbb
comma
id|vbe
comma
id|vdb
comma
id|vde
comma
id|vss
suffix:semicolon
multiline_comment|/* auxiliary information */
DECL|member|mono
r_int
id|mono
suffix:semicolon
DECL|member|ste_mode
r_int
id|ste_mode
suffix:semicolon
DECL|member|bpp
r_int
id|bpp
suffix:semicolon
DECL|member|falcon
)brace
id|falcon
suffix:semicolon
macro_line|#endif
multiline_comment|/* Nothing needed for external mode */
DECL|member|hw
)brace
id|hw
suffix:semicolon
DECL|variable|current_par
)brace
id|current_par
suffix:semicolon
multiline_comment|/* Don&squot;t calculate an own resolution, and thus don&squot;t change the one found when&n; * booting (currently used for the Falcon to keep settings for internal video&n; * hardware extensions (e.g. ScreenBlaster)  */
DECL|variable|DontCalcRes
r_static
r_int
id|DontCalcRes
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ATAFB_FALCON
DECL|macro|HHT
mdefine_line|#define HHT hw.falcon.hht
DECL|macro|HBB
mdefine_line|#define HBB hw.falcon.hbb
DECL|macro|HBE
mdefine_line|#define HBE hw.falcon.hbe
DECL|macro|HDB
mdefine_line|#define HDB hw.falcon.hdb
DECL|macro|HDE
mdefine_line|#define HDE hw.falcon.hde
DECL|macro|HSS
mdefine_line|#define HSS hw.falcon.hss
DECL|macro|VFT
mdefine_line|#define VFT hw.falcon.vft
DECL|macro|VBB
mdefine_line|#define VBB hw.falcon.vbb
DECL|macro|VBE
mdefine_line|#define VBE hw.falcon.vbe
DECL|macro|VDB
mdefine_line|#define VDB hw.falcon.vdb
DECL|macro|VDE
mdefine_line|#define VDE hw.falcon.vde
DECL|macro|VSS
mdefine_line|#define VSS hw.falcon.vss
DECL|macro|VCO_CLOCK25
mdefine_line|#define VCO_CLOCK25&t;&t;0x04
DECL|macro|VCO_CSYPOS
mdefine_line|#define VCO_CSYPOS&t;&t;0x10
DECL|macro|VCO_VSYPOS
mdefine_line|#define VCO_VSYPOS&t;&t;0x20
DECL|macro|VCO_HSYPOS
mdefine_line|#define VCO_HSYPOS&t;&t;0x40
DECL|macro|VCO_SHORTOFFS
mdefine_line|#define VCO_SHORTOFFS&t;0x100
DECL|macro|VMO_DOUBLE
mdefine_line|#define VMO_DOUBLE&t;&t;0x01
DECL|macro|VMO_INTER
mdefine_line|#define VMO_INTER&t;&t;0x02
DECL|macro|VMO_PREMASK
mdefine_line|#define VMO_PREMASK&t;&t;0x0c
macro_line|#endif
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|variable|screen_base
r_static
r_void
op_star
id|screen_base
suffix:semicolon
multiline_comment|/* base address of screen */
DECL|variable|real_screen_base
r_static
r_void
op_star
id|real_screen_base
suffix:semicolon
multiline_comment|/* (only for Overscan) */
DECL|variable|screen_len
r_static
r_int
id|screen_len
suffix:semicolon
DECL|variable|current_par_valid
r_static
r_int
id|current_par_valid
op_assign
l_int|0
suffix:semicolon
DECL|variable|currcon
r_static
r_int
id|currcon
op_assign
l_int|0
suffix:semicolon
DECL|variable|mono_moni
r_static
r_int
id|mono_moni
op_assign
l_int|0
suffix:semicolon
DECL|variable|disp
r_static
r_struct
id|display
id|disp
suffix:semicolon
macro_line|#ifdef ATAFB_EXT
multiline_comment|/* external video handling */
DECL|variable|external_xres
r_static
r_int
id|external_xres
suffix:semicolon
DECL|variable|external_xres_virtual
r_static
r_int
id|external_xres_virtual
suffix:semicolon
DECL|variable|external_yres
r_static
r_int
id|external_yres
suffix:semicolon
multiline_comment|/* not needed - atafb will never support panning/hardwarescroll with external&n; * static unsigned&t;&t;external_yres_virtual;&t;&n;*/
DECL|variable|external_depth
r_static
r_int
id|external_depth
suffix:semicolon
DECL|variable|external_pmode
r_static
r_int
id|external_pmode
suffix:semicolon
DECL|variable|external_addr
r_static
r_void
op_star
id|external_addr
op_assign
l_int|0
suffix:semicolon
DECL|variable|external_len
r_static
r_int
r_int
id|external_len
suffix:semicolon
DECL|variable|external_vgaiobase
r_static
r_int
r_int
id|external_vgaiobase
op_assign
l_int|0
suffix:semicolon
DECL|variable|external_bitspercol
r_static
r_int
r_int
id|external_bitspercol
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* &n;JOE &lt;joe@amber.dinoco.de&gt;: &n;added card type for external driver, is only needed for&n;colormap handling.&n;*/
DECL|enum|cardtype
DECL|enumerator|IS_VGA
DECL|enumerator|IS_MV300
r_enum
id|cardtype
(brace
id|IS_VGA
comma
id|IS_MV300
)brace
suffix:semicolon
DECL|variable|external_card_type
r_static
r_enum
id|cardtype
id|external_card_type
op_assign
id|IS_VGA
suffix:semicolon
multiline_comment|/*&n;The MV300 mixes the color registers. So we need an array of munged&n;indices in order to acces the correct reg.&n;*/
DECL|variable|MV300_reg_1bit
r_static
r_int
id|MV300_reg_1bit
(braket
l_int|2
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|MV300_reg_4bit
r_static
r_int
id|MV300_reg_4bit
(braket
l_int|16
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|MV300_reg_8bit
r_static
r_int
id|MV300_reg_8bit
(braket
l_int|256
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|MV300_reg
r_static
r_int
op_star
id|MV300_reg
op_assign
id|MV300_reg_8bit
suffix:semicolon
multiline_comment|/*&n;And on the MV300 it&squot;s difficult to read out the hardware palette. So we&n;just keep track of the set colors in our own array here, and use that!&n;*/
DECL|member|red
DECL|member|green
DECL|member|blue
DECL|member|pad
DECL|variable|ext_color
r_static
r_struct
(brace
r_int
r_char
id|red
comma
id|green
comma
id|blue
comma
id|pad
suffix:semicolon
)brace
id|ext_color
(braket
l_int|256
)braket
suffix:semicolon
macro_line|#endif /* ATAFB_EXT */
DECL|variable|inverse
r_static
r_int
id|inverse
op_assign
l_int|0
suffix:semicolon
r_extern
r_int
id|fontheight_8x8
suffix:semicolon
r_extern
r_int
id|fontwidth_8x8
suffix:semicolon
r_extern
r_int
r_char
id|fontdata_8x8
(braket
)braket
suffix:semicolon
r_extern
r_int
id|fontheight_8x16
suffix:semicolon
r_extern
r_int
id|fontwidth_8x16
suffix:semicolon
r_extern
r_int
r_char
id|fontdata_8x16
(braket
)braket
suffix:semicolon
multiline_comment|/* ++roman: This structure abstracts from the underlying hardware (ST(e),&n; * TT, or Falcon.&n; *&n; * int (*detect)( void )&n; *   This function should detect the current video mode settings and&n; *   store them in atafb_predefined[0] for later reference by the&n; *   user. Return the index+1 of an equivalent predefined mode or 0&n; *   if there is no such.&n; * &n; * int (*encode_fix)( struct fb_fix_screeninfo *fix,&n; *                    struct atafb_par *par )&n; *   This function should fill in the &squot;fix&squot; structure based on the&n; *   values in the &squot;par&squot; structure.&n; *   &n; * int (*decode_var)( struct fb_var_screeninfo *var,&n; *                    struct atafb_par *par )&n; *   Get the video params out of &squot;var&squot;. If a value doesn&squot;t fit, round&n; *   it up, if it&squot;s too big, return EINVAL.&n; *   Round up in the following order: bits_per_pixel, xres, yres, &n; *   xres_virtual, yres_virtual, xoffset, yoffset, grayscale, bitfields, &n; *   horizontal timing, vertical timing.&n; *&n; * int (*encode_var)( struct fb_var_screeninfo *var,&n; *                    struct atafb_par *par );&n; *   Fill the &squot;var&squot; structure based on the values in &squot;par&squot; and maybe&n; *   other values read out of the hardware.&n; *   &n; * void (*get_par)( struct atafb_par *par )&n; *   Fill the hardware&squot;s &squot;par&squot; structure.&n; *   &n; * void (*set_par)( struct atafb_par *par )&n; *   Set the hardware according to &squot;par&squot;.&n; *   &n; * int (*setcolreg)( unsigned regno, unsigned red,&n; *                   unsigned green, unsigned blue,&n; *                   unsigned transp, struct fb_info *info )&n; *   Set a single color register. The values supplied are already&n; *   rounded down to the hardware&squot;s capabilities (according to the&n; *   entries in the var structure). Return != 0 for invalid regno.&n; *&n; * int (*getcolreg)( unsigned regno, unsigned *red,&n; *                   unsigned *green, unsigned *blue,&n; *                   unsigned *transp, struct fb_info *info )&n; *   Read a single color register and split it into&n; *   colors/transparent. Return != 0 for invalid regno.&n; *&n; * void (*set_screen_base)(void *s_base)&n; *   Set the base address of the displayed frame buffer. Only called&n; *   if yres_virtual &gt; yres or xres_virtual &gt; xres.&n; *&n; * int (*blank)( int blank_mode )&n; *   Blank the screen if blank_mode!=0, else unblank. If blank==NULL then&n; *   the caller blanks by setting the CLUT to all black. Return 0 if blanking&n; *   succeeded, !=0 if un-/blanking failed due to e.g. a video mode which&n; *   doesn&squot;t support it. Implements VESA suspend and powerdown modes on&n; *   hardware that supports disabling hsync/vsync:&n; *       blank_mode==2: suspend vsync, 3:suspend hsync, 4: powerdown.&n; */
DECL|struct|fb_hwswitch
r_static
r_struct
id|fb_hwswitch
(brace
DECL|member|detect
r_int
(paren
op_star
id|detect
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|member|encode_fix
r_int
(paren
op_star
id|encode_fix
)paren
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|atafb_par
op_star
id|par
)paren
suffix:semicolon
DECL|member|decode_var
r_int
(paren
op_star
id|decode_var
)paren
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
suffix:semicolon
DECL|member|encode_var
r_int
(paren
op_star
id|encode_var
)paren
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
suffix:semicolon
DECL|member|get_par
r_void
(paren
op_star
id|get_par
)paren
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
suffix:semicolon
DECL|member|set_par
r_void
(paren
op_star
id|set_par
)paren
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
suffix:semicolon
DECL|member|getcolreg
r_int
(paren
op_star
id|getcolreg
)paren
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
DECL|member|setcolreg
r_int
(paren
op_star
id|setcolreg
)paren
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
DECL|member|set_screen_base
r_void
(paren
op_star
id|set_screen_base
)paren
(paren
r_void
op_star
id|s_base
)paren
suffix:semicolon
DECL|member|blank
r_int
(paren
op_star
id|blank
)paren
(paren
r_int
id|blank_mode
)paren
suffix:semicolon
DECL|member|pan_display
r_int
(paren
op_star
id|pan_display
)paren
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
suffix:semicolon
DECL|variable|fbhw
)brace
op_star
id|fbhw
suffix:semicolon
DECL|variable|autodetect_names
r_static
r_char
op_star
id|autodetect_names
(braket
)braket
op_assign
(brace
l_string|&quot;autodetect&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|stlow_names
r_static
r_char
op_star
id|stlow_names
(braket
)braket
op_assign
(brace
l_string|&quot;stlow&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|stmid_names
r_static
r_char
op_star
id|stmid_names
(braket
)braket
op_assign
(brace
l_string|&quot;stmid&quot;
comma
l_string|&quot;default5&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|sthigh_names
r_static
r_char
op_star
id|sthigh_names
(braket
)braket
op_assign
(brace
l_string|&quot;sthigh&quot;
comma
l_string|&quot;default4&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|ttlow_names
r_static
r_char
op_star
id|ttlow_names
(braket
)braket
op_assign
(brace
l_string|&quot;ttlow&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|ttmid_names
r_static
r_char
op_star
id|ttmid_names
(braket
)braket
op_assign
(brace
l_string|&quot;ttmid&quot;
comma
l_string|&quot;default1&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|tthigh_names
r_static
r_char
op_star
id|tthigh_names
(braket
)braket
op_assign
(brace
l_string|&quot;tthigh&quot;
comma
l_string|&quot;default2&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|vga2_names
r_static
r_char
op_star
id|vga2_names
(braket
)braket
op_assign
(brace
l_string|&quot;vga2&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|vga4_names
r_static
r_char
op_star
id|vga4_names
(braket
)braket
op_assign
(brace
l_string|&quot;vga4&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|vga16_names
r_static
r_char
op_star
id|vga16_names
(braket
)braket
op_assign
(brace
l_string|&quot;vga16&quot;
comma
l_string|&quot;default3&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|vga256_names
r_static
r_char
op_star
id|vga256_names
(braket
)braket
op_assign
(brace
l_string|&quot;vga256&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|falh2_names
r_static
r_char
op_star
id|falh2_names
(braket
)braket
op_assign
(brace
l_string|&quot;falh2&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|falh16_names
r_static
r_char
op_star
id|falh16_names
(braket
)braket
op_assign
(brace
l_string|&quot;falh16&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|fb_var_names
r_static
r_char
op_star
op_star
id|fb_var_names
(braket
)braket
op_assign
(brace
multiline_comment|/* Writing the name arrays directly in this array (via &quot;(char *[]){...}&quot;)&n;&t; * crashes gcc 2.5.8 (sigsegv) if the inner array&n;&t; * contains more than two items. I&squot;ve also seen that all elements&n;&t; * were identical to the last (my cross-gcc) :-(*/
id|autodetect_names
comma
id|stlow_names
comma
id|stmid_names
comma
id|sthigh_names
comma
id|ttlow_names
comma
id|ttmid_names
comma
id|tthigh_names
comma
id|vga2_names
comma
id|vga4_names
comma
id|vga16_names
comma
id|vga256_names
comma
id|falh2_names
comma
id|falh16_names
comma
l_int|NULL
multiline_comment|/* ,NULL */
multiline_comment|/* this causes a sigsegv on my gcc-2.5.8 */
)brace
suffix:semicolon
DECL|variable|atafb_predefined
r_static
r_struct
id|fb_var_screeninfo
id|atafb_predefined
(braket
)braket
op_assign
(brace
multiline_comment|/*&n; &t; * yres_virtual==0 means use hw-scrolling if possible, else yres&n; &t; */
(brace
multiline_comment|/* autodetect */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* xres-grayscale */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* red green blue tran*/
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* st low */
l_int|320
comma
l_int|200
comma
l_int|320
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* st mid */
l_int|640
comma
l_int|200
comma
l_int|640
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* st high */
l_int|640
comma
l_int|400
comma
l_int|640
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* tt low */
l_int|320
comma
l_int|480
comma
l_int|320
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* tt mid */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* tt high */
l_int|1280
comma
l_int|960
comma
l_int|1280
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* vga2 */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* vga4 */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|4
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* vga16 */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* vga256 */
l_int|640
comma
l_int|480
comma
l_int|640
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|8
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* falh2 */
l_int|896
comma
l_int|608
comma
l_int|896
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
multiline_comment|/* falh16 */
l_int|896
comma
l_int|608
comma
l_int|896
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|6
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|variable|num_atafb_predefined
r_static
r_int
id|num_atafb_predefined
op_assign
id|ARRAY_SIZE
c_func
(paren
id|atafb_predefined
)paren
suffix:semicolon
r_static
r_int
DECL|function|get_video_mode
id|get_video_mode
c_func
(paren
r_char
op_star
id|vname
)paren
(brace
r_char
op_star
op_star
op_star
id|name_list
suffix:semicolon
r_char
op_star
op_star
id|name
suffix:semicolon
r_int
id|i
suffix:semicolon
id|name_list
op_assign
id|fb_var_names
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_atafb_predefined
suffix:semicolon
id|i
op_increment
)paren
(brace
id|name
op_assign
op_star
(paren
id|name_list
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|name
op_logical_or
op_logical_neg
op_star
id|name
)paren
r_break
suffix:semicolon
r_while
c_loop
(paren
op_star
id|name
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|vname
comma
op_star
id|name
)paren
)paren
r_return
id|i
op_plus
l_int|1
suffix:semicolon
id|name
op_increment
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------------- TT specific functions ---------------------- */
macro_line|#ifdef ATAFB_TT
DECL|function|tt_encode_fix
r_static
r_int
id|tt_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
id|mode
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
l_string|&quot;Atari Builtin&quot;
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
(paren
r_int
r_int
)paren
id|real_screen_base
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|screen_len
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_INTERLEAVED_PLANES
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|2
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|mode
op_assign
id|par-&gt;hw.tt.mode
op_amp
id|TT_SHIFTER_MODEMASK
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|TT_SHIFTER_TTHIGH
op_logical_or
id|mode
op_eq
id|TT_SHIFTER_STHIGH
)paren
(brace
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|TT_SHIFTER_TTHIGH
)paren
id|fix-&gt;visual
op_assign
id|FB_VISUAL_MONO01
suffix:semicolon
)brace
id|fix-&gt;xpanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;line_length
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_ATARIBLITT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tt_decode_var
r_static
r_int
id|tt_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
id|xres
op_assign
id|var-&gt;xres
suffix:semicolon
r_int
id|yres
op_assign
id|var-&gt;yres
suffix:semicolon
r_int
id|bpp
op_assign
id|var-&gt;bits_per_pixel
suffix:semicolon
r_int
id|linelen
suffix:semicolon
r_int
id|yres_virtual
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|mono_moni
)paren
(brace
r_if
c_cond
(paren
id|bpp
OG
l_int|1
op_logical_or
id|xres
OG
id|sttt_xres
op_star
l_int|2
op_logical_or
id|yres
OG
id|tt_yres
op_star
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;hw.tt.mode
op_assign
id|TT_SHIFTER_TTHIGH
suffix:semicolon
id|xres
op_assign
id|sttt_xres
op_star
l_int|2
suffix:semicolon
id|yres
op_assign
id|tt_yres
op_star
l_int|2
suffix:semicolon
id|bpp
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|bpp
OG
l_int|8
op_logical_or
id|xres
OG
id|sttt_xres
op_logical_or
id|yres
OG
id|tt_yres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|bpp
OG
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|xres
OG
id|sttt_xres
op_div
l_int|2
op_logical_or
id|yres
OG
id|tt_yres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;hw.tt.mode
op_assign
id|TT_SHIFTER_TTLOW
suffix:semicolon
id|xres
op_assign
id|sttt_xres
op_div
l_int|2
suffix:semicolon
id|yres
op_assign
id|tt_yres
suffix:semicolon
id|bpp
op_assign
l_int|8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
OG
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|xres
OG
id|sttt_xres
op_logical_or
id|yres
OG
id|tt_yres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|xres
OG
id|sttt_xres
op_div
l_int|2
op_logical_or
id|yres
OG
id|st_yres
op_div
l_int|2
)paren
(brace
id|par-&gt;hw.tt.mode
op_assign
id|TT_SHIFTER_TTMID
suffix:semicolon
id|xres
op_assign
id|sttt_xres
suffix:semicolon
id|yres
op_assign
id|tt_yres
suffix:semicolon
id|bpp
op_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|par-&gt;hw.tt.mode
op_assign
id|TT_SHIFTER_STLOW
suffix:semicolon
id|xres
op_assign
id|sttt_xres
op_div
l_int|2
suffix:semicolon
id|yres
op_assign
id|st_yres
op_div
l_int|2
suffix:semicolon
id|bpp
op_assign
l_int|4
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|bpp
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|xres
OG
id|sttt_xres
op_logical_or
id|yres
OG
id|st_yres
op_div
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;hw.tt.mode
op_assign
id|TT_SHIFTER_STMID
suffix:semicolon
id|xres
op_assign
id|sttt_xres
suffix:semicolon
id|yres
op_assign
id|st_yres
op_div
l_int|2
suffix:semicolon
id|bpp
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|var-&gt;xres
OG
id|sttt_xres
op_logical_or
id|var-&gt;yres
OG
id|st_yres
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|par-&gt;hw.tt.mode
op_assign
id|TT_SHIFTER_STHIGH
suffix:semicolon
id|xres
op_assign
id|sttt_xres
suffix:semicolon
id|yres
op_assign
id|st_yres
suffix:semicolon
id|bpp
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|yres_virtual
op_le
l_int|0
)paren
id|yres_virtual
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|yres_virtual
OL
id|yres
)paren
id|yres_virtual
op_assign
id|yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_EXT
)paren
id|par-&gt;hw.tt.sync
op_assign
l_int|0
suffix:semicolon
r_else
id|par-&gt;hw.tt.sync
op_assign
l_int|1
suffix:semicolon
id|linelen
op_assign
id|xres
op_star
id|bpp
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|yres_virtual
op_star
id|linelen
OG
id|screen_len
op_logical_and
id|screen_len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|yres
op_star
id|linelen
OG
id|screen_len
op_logical_and
id|screen_len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
op_plus
id|yres
OG
id|yres_virtual
op_logical_and
id|yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;yres_virtual
op_assign
id|yres_virtual
suffix:semicolon
id|par-&gt;screen_base
op_assign
id|screen_base
op_plus
id|var-&gt;yoffset
op_star
id|linelen
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tt_encode_var
r_static
r_int
id|tt_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
id|linelen
suffix:semicolon
id|memset
c_func
(paren
id|var
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|4
suffix:semicolon
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;grayscale
op_assign
l_int|0
suffix:semicolon
id|var-&gt;pixclock
op_assign
l_int|31041
suffix:semicolon
id|var-&gt;left_margin
op_assign
l_int|120
suffix:semicolon
multiline_comment|/* these may be incorrect &t;*/
id|var-&gt;right_margin
op_assign
l_int|100
suffix:semicolon
id|var-&gt;upper_margin
op_assign
l_int|8
suffix:semicolon
id|var-&gt;lower_margin
op_assign
l_int|16
suffix:semicolon
id|var-&gt;hsync_len
op_assign
l_int|140
suffix:semicolon
id|var-&gt;vsync_len
op_assign
l_int|30
suffix:semicolon
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;hw.tt.sync
op_amp
l_int|1
)paren
id|var-&gt;sync
op_assign
l_int|0
suffix:semicolon
r_else
id|var-&gt;sync
op_assign
id|FB_SYNC_EXT
suffix:semicolon
r_switch
c_cond
(paren
id|par-&gt;hw.tt.mode
op_amp
id|TT_SHIFTER_MODEMASK
)paren
(brace
r_case
id|TT_SHIFTER_STLOW
suffix:colon
id|var-&gt;xres
op_assign
id|sttt_xres
op_div
l_int|2
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|sttt_xres_virtual
op_div
l_int|2
suffix:semicolon
id|var-&gt;yres
op_assign
id|st_yres
op_div
l_int|2
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TT_SHIFTER_STMID
suffix:colon
id|var-&gt;xres
op_assign
id|sttt_xres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|sttt_xres_virtual
suffix:semicolon
id|var-&gt;yres
op_assign
id|st_yres
op_div
l_int|2
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TT_SHIFTER_STHIGH
suffix:colon
id|var-&gt;xres
op_assign
id|sttt_xres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|sttt_xres_virtual
suffix:semicolon
id|var-&gt;yres
op_assign
id|st_yres
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TT_SHIFTER_TTLOW
suffix:colon
id|var-&gt;xres
op_assign
id|sttt_xres
op_div
l_int|2
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|sttt_xres_virtual
op_div
l_int|2
suffix:semicolon
id|var-&gt;yres
op_assign
id|tt_yres
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TT_SHIFTER_TTMID
suffix:colon
id|var-&gt;xres
op_assign
id|sttt_xres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|sttt_xres_virtual
suffix:semicolon
id|var-&gt;yres
op_assign
id|tt_yres
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TT_SHIFTER_TTHIGH
suffix:colon
id|var-&gt;red.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;xres
op_assign
id|sttt_xres
op_star
l_int|2
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|sttt_xres_virtual
op_star
l_int|2
suffix:semicolon
id|var-&gt;yres
op_assign
id|tt_yres
op_star
l_int|2
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|var-&gt;blue
op_assign
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|linelen
op_assign
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_hwscroll
)paren
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
r_else
r_if
c_cond
(paren
id|screen_len
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;yres_virtual
)paren
id|var-&gt;yres_virtual
op_assign
id|par-&gt;yres_virtual
suffix:semicolon
r_else
multiline_comment|/* yres_virtual==0 means use maximum */
id|var-&gt;yres_virtual
op_assign
id|screen_len
op_div
id|linelen
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hwscroll
OL
l_int|0
)paren
id|var-&gt;yres_virtual
op_assign
l_int|2
op_star
id|var-&gt;yres
suffix:semicolon
r_else
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
op_plus
id|hwscroll
op_star
l_int|16
suffix:semicolon
)brace
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|screen_base
)paren
id|var-&gt;yoffset
op_assign
(paren
id|par-&gt;screen_base
op_minus
id|screen_base
)paren
op_div
id|linelen
suffix:semicolon
r_else
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;nonstd
op_assign
l_int|0
suffix:semicolon
id|var-&gt;activate
op_assign
l_int|0
suffix:semicolon
id|var-&gt;vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tt_get_par
r_static
r_void
id|tt_get_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
id|par-&gt;hw.tt.mode
op_assign
id|shifter_tt.tt_shiftmode
suffix:semicolon
id|par-&gt;hw.tt.sync
op_assign
id|shifter.syncmode
suffix:semicolon
id|addr
op_assign
(paren
(paren
id|shifter.bas_hi
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|shifter.bas_md
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|shifter.bas_lo
op_amp
l_int|0xff
)paren
)paren
suffix:semicolon
id|par-&gt;screen_base
op_assign
id|phys_to_virt
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|tt_set_par
r_static
r_void
id|tt_set_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
id|shifter_tt.tt_shiftmode
op_assign
id|par-&gt;hw.tt.mode
suffix:semicolon
id|shifter.syncmode
op_assign
id|par-&gt;hw.tt.sync
suffix:semicolon
multiline_comment|/* only set screen_base if really necessary */
r_if
c_cond
(paren
id|current_par.screen_base
op_ne
id|par-&gt;screen_base
)paren
id|fbhw
op_member_access_from_pointer
id|set_screen_base
c_func
(paren
id|par-&gt;screen_base
)paren
suffix:semicolon
)brace
DECL|function|tt_getcolreg
r_static
r_int
id|tt_getcolreg
c_func
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|t
comma
id|col
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shifter_tt.tt_shiftmode
op_amp
id|TT_SHIFTER_MODEMASK
)paren
op_eq
id|TT_SHIFTER_STHIGH
)paren
id|regno
op_add_assign
l_int|254
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|t
op_assign
id|tt_palette
(braket
id|regno
)braket
suffix:semicolon
id|col
op_assign
id|t
op_amp
l_int|15
suffix:semicolon
id|col
op_or_assign
id|col
op_lshift
l_int|4
suffix:semicolon
id|col
op_or_assign
id|col
op_lshift
l_int|8
suffix:semicolon
op_star
id|blue
op_assign
id|col
suffix:semicolon
id|col
op_assign
(paren
id|t
op_rshift
l_int|4
)paren
op_amp
l_int|15
suffix:semicolon
id|col
op_or_assign
id|col
op_lshift
l_int|4
suffix:semicolon
id|col
op_or_assign
id|col
op_lshift
l_int|8
suffix:semicolon
op_star
id|green
op_assign
id|col
suffix:semicolon
id|col
op_assign
(paren
id|t
op_rshift
l_int|8
)paren
op_amp
l_int|15
suffix:semicolon
id|col
op_or_assign
id|col
op_lshift
l_int|4
suffix:semicolon
id|col
op_or_assign
id|col
op_lshift
l_int|8
suffix:semicolon
op_star
id|red
op_assign
id|col
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tt_setcolreg
r_static
r_int
id|tt_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
(paren
id|shifter_tt.tt_shiftmode
op_amp
id|TT_SHIFTER_MODEMASK
)paren
op_eq
id|TT_SHIFTER_STHIGH
)paren
id|regno
op_add_assign
l_int|254
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|tt_palette
(braket
id|regno
)braket
op_assign
(paren
(paren
(paren
id|red
op_rshift
l_int|12
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|green
op_rshift
l_int|12
)paren
op_lshift
l_int|4
)paren
op_or
(paren
id|blue
op_rshift
l_int|12
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|shifter_tt.tt_shiftmode
op_amp
id|TT_SHIFTER_MODEMASK
)paren
op_eq
id|TT_SHIFTER_STHIGH
op_logical_and
id|regno
op_eq
l_int|254
)paren
id|tt_palette
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tt_detect
r_static
r_int
id|tt_detect
c_func
(paren
r_void
)paren
(brace
r_struct
id|atafb_par
id|par
suffix:semicolon
multiline_comment|/* Determine the connected monitor: The DMA sound must be&n;&t; * disabled before reading the MFP GPIP, because the Sound&n;&t; * Done Signal and the Monochrome Detect are XORed together!&n;&t; *&n;&t; * Even on a TT, we should look if there is a DMA sound. It was&n;&t; * announced that the Eagle is TT compatible, but only the PCM is&n;&t; * missing...&n;&t; */
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|PCM_8BIT
)paren
)paren
(brace
id|tt_dmasnd.ctrl
op_assign
id|DMASND_CTRL_OFF
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* wait a while for things to settle down */
)brace
id|mono_moni
op_assign
(paren
id|mfp.par_dt_reg
op_amp
l_int|0x80
)paren
op_eq
l_int|0
suffix:semicolon
id|tt_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
id|tt_encode_var
c_func
(paren
op_amp
id|atafb_predefined
(braket
l_int|0
)braket
comma
op_amp
id|par
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* ATAFB_TT */
multiline_comment|/* ------------------- Falcon specific functions ---------------------- */
macro_line|#ifdef ATAFB_FALCON
DECL|variable|mon_type
r_static
r_int
id|mon_type
suffix:semicolon
multiline_comment|/* Falcon connected monitor */
DECL|variable|f030_bus_width
r_static
r_int
id|f030_bus_width
suffix:semicolon
multiline_comment|/* Falcon ram bus width (for vid_control) */
DECL|macro|F_MON_SM
mdefine_line|#define F_MON_SM&t;0
DECL|macro|F_MON_SC
mdefine_line|#define F_MON_SC&t;1
DECL|macro|F_MON_VGA
mdefine_line|#define F_MON_VGA&t;2
DECL|macro|F_MON_TV
mdefine_line|#define F_MON_TV&t;3
DECL|struct|pixel_clock
r_static
r_struct
id|pixel_clock
(brace
DECL|member|f
r_int
r_int
id|f
suffix:semicolon
multiline_comment|/* f/[Hz] */
DECL|member|t
r_int
r_int
id|t
suffix:semicolon
multiline_comment|/* t/[ps] (=1/f) */
DECL|member|right
DECL|member|hsync
DECL|member|left
r_int
id|right
comma
id|hsync
comma
id|left
suffix:semicolon
multiline_comment|/* standard timing in clock cycles, not pixel */
multiline_comment|/* hsync initialized in falcon_detect() */
DECL|member|sync_mask
r_int
id|sync_mask
suffix:semicolon
multiline_comment|/* or-mask for hw.falcon.sync to set this clock */
DECL|member|control_mask
r_int
id|control_mask
suffix:semicolon
multiline_comment|/* ditto, for hw.falcon.vid_control */
)brace
DECL|variable|f25
id|f25
op_assign
(brace
l_int|25175000
comma
l_int|39721
comma
l_int|18
comma
l_int|0
comma
l_int|42
comma
l_int|0x0
comma
id|VCO_CLOCK25
)brace
comma
DECL|variable|f32
id|f32
op_assign
(brace
l_int|32000000
comma
l_int|31250
comma
l_int|18
comma
l_int|0
comma
l_int|42
comma
l_int|0x0
comma
l_int|0
)brace
comma
DECL|variable|fext
id|fext
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|18
comma
l_int|0
comma
l_int|42
comma
l_int|0x1
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* VIDEL-prescale values [mon_type][pixel_length from VCO] */
DECL|variable|vdl_prescale
r_static
r_int
id|vdl_prescale
(braket
l_int|4
)braket
(braket
l_int|3
)braket
op_assign
(brace
(brace
l_int|4
comma
l_int|2
comma
l_int|1
)brace
comma
(brace
l_int|4
comma
l_int|2
comma
l_int|1
)brace
comma
(brace
l_int|4
comma
l_int|2
comma
l_int|2
)brace
comma
(brace
l_int|4
comma
l_int|2
comma
l_int|1
)brace
)brace
suffix:semicolon
multiline_comment|/* Default hsync timing [mon_type] in picoseconds */
DECL|variable|h_syncs
r_static
r_int
id|h_syncs
(braket
l_int|4
)braket
op_assign
(brace
l_int|3000000
comma
l_int|4875000
comma
l_int|4000000
comma
l_int|4875000
)brace
suffix:semicolon
macro_line|#ifdef FBCON_HAS_CFB16
DECL|variable|fbcon_cfb16_cmap
r_static
id|u16
id|fbcon_cfb16_cmap
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
DECL|function|hxx_prescale
r_static
r_inline
r_int
id|hxx_prescale
c_func
(paren
r_struct
id|falcon_hw
op_star
id|hw
)paren
(brace
r_return
id|hw-&gt;ste_mode
ques
c_cond
l_int|16
suffix:colon
id|vdl_prescale
(braket
id|mon_type
)braket
(braket
id|hw-&gt;vid_mode
op_rshift
l_int|2
op_amp
l_int|0x3
)braket
suffix:semicolon
)brace
DECL|function|falcon_encode_fix
r_static
r_int
id|falcon_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
l_string|&quot;Atari Builtin&quot;
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
(paren
r_int
r_int
)paren
id|real_screen_base
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|screen_len
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_INTERLEAVED_PLANES
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|2
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;hw.falcon.mono
)paren
(brace
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no smooth scrolling with longword aligned video mem */
id|fix-&gt;xpanstep
op_assign
l_int|32
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|par-&gt;hw.falcon.f_shift
op_amp
l_int|0x100
)paren
(brace
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Is this ok or should it be DIRECTCOLOR? */
id|fix-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|2
suffix:semicolon
)brace
id|fix-&gt;line_length
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_ATARIBLITT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|falcon_decode_var
r_static
r_int
id|falcon_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
id|bpp
op_assign
id|var-&gt;bits_per_pixel
suffix:semicolon
r_int
id|xres
op_assign
id|var-&gt;xres
suffix:semicolon
r_int
id|yres
op_assign
id|var-&gt;yres
suffix:semicolon
r_int
id|xres_virtual
op_assign
id|var-&gt;xres_virtual
suffix:semicolon
r_int
id|yres_virtual
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
r_int
id|left_margin
comma
id|right_margin
comma
id|hsync_len
suffix:semicolon
r_int
id|upper_margin
comma
id|lower_margin
comma
id|vsync_len
suffix:semicolon
r_int
id|linelen
suffix:semicolon
r_int
id|interlace
op_assign
l_int|0
comma
id|doubleline
op_assign
l_int|0
suffix:semicolon
r_struct
id|pixel_clock
op_star
id|pclock
suffix:semicolon
r_int
id|plen
suffix:semicolon
multiline_comment|/* width of pixel in clock cycles */
r_int
id|xstretch
suffix:semicolon
r_int
id|prescale
suffix:semicolon
r_int
id|longoffset
op_assign
l_int|0
suffix:semicolon
r_int
id|hfreq
comma
id|vfreq
suffix:semicolon
multiline_comment|/*&n;&t;Get the video params out of &squot;var&squot;. If a value doesn&squot;t fit, round&n;&t;it up, if it&squot;s too big, return EINVAL.&n;&t;Round up in the following order: bits_per_pixel, xres, yres, &n;&t;xres_virtual, yres_virtual, xoffset, yoffset, grayscale, bitfields, &n;&t;horizontal timing, vertical timing.&n;&n;&t;There is a maximum of screen resolution determined by pixelclock&n;&t;and minimum frame rate -- (X+hmarg.)*(Y+vmarg.)*vfmin &lt;= pixelclock.&n;&t;In interlace mode this is     &quot;     *    &quot;     *vfmin &lt;= pixelclock.&n;&t;Additional constraints: hfreq.&n;&t;Frequency range for multisync monitors is given via command line.&n;&t;For TV and SM124 both frequencies are fixed.&n;&n;&t;X % 16 == 0 to fit 8x?? font (except 1 bitplane modes must use X%32==0)&n;&t;Y % 16 == 0 to fit 8x16 font&n;&t;Y % 8 == 0 if Y&lt;400&n;&n;&t;Currently interlace and doubleline mode in var are ignored. &n;&t;On SM124 and TV only the standard resolutions can be used.&n;*/
multiline_comment|/* Reject uninitialized mode */
r_if
c_cond
(paren
op_logical_neg
id|xres
op_logical_or
op_logical_neg
id|yres
op_logical_or
op_logical_neg
id|bpp
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|mon_type
op_eq
id|F_MON_SM
op_logical_and
id|bpp
op_ne
l_int|1
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
op_le
l_int|1
)paren
(brace
id|bpp
op_assign
l_int|1
suffix:semicolon
id|par-&gt;hw.falcon.f_shift
op_assign
l_int|0x400
suffix:semicolon
id|par-&gt;hw.falcon.st_shift
op_assign
l_int|0x200
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
op_le
l_int|2
)paren
(brace
id|bpp
op_assign
l_int|2
suffix:semicolon
id|par-&gt;hw.falcon.f_shift
op_assign
l_int|0x000
suffix:semicolon
id|par-&gt;hw.falcon.st_shift
op_assign
l_int|0x100
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
op_le
l_int|4
)paren
(brace
id|bpp
op_assign
l_int|4
suffix:semicolon
id|par-&gt;hw.falcon.f_shift
op_assign
l_int|0x000
suffix:semicolon
id|par-&gt;hw.falcon.st_shift
op_assign
l_int|0x000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
op_le
l_int|8
)paren
(brace
id|bpp
op_assign
l_int|8
suffix:semicolon
id|par-&gt;hw.falcon.f_shift
op_assign
l_int|0x010
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
op_le
l_int|16
)paren
(brace
id|bpp
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* packed pixel mode */
id|par-&gt;hw.falcon.f_shift
op_assign
l_int|0x100
suffix:semicolon
multiline_comment|/* hicolor, no overlay */
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;hw.falcon.bpp
op_assign
id|bpp
suffix:semicolon
r_if
c_cond
(paren
id|mon_type
op_eq
id|F_MON_SM
op_logical_or
id|DontCalcRes
)paren
(brace
multiline_comment|/* Skip all calculations. VGA/TV/SC1224 only supported. */
r_struct
id|fb_var_screeninfo
op_star
id|myvar
op_assign
op_amp
id|atafb_predefined
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|bpp
OG
id|myvar-&gt;bits_per_pixel
op_logical_or
id|var-&gt;xres
OG
id|myvar-&gt;xres
op_logical_or
id|var-&gt;yres
OG
id|myvar-&gt;yres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|fbhw
op_member_access_from_pointer
id|get_par
c_func
(paren
id|par
)paren
suffix:semicolon
multiline_comment|/* Current par will be new par */
r_goto
id|set_screen_base
suffix:semicolon
multiline_comment|/* Don&squot;t forget this */
)brace
multiline_comment|/* Only some fixed resolutions &lt; 640x400 */
r_if
c_cond
(paren
id|xres
op_le
l_int|320
)paren
id|xres
op_assign
l_int|320
suffix:semicolon
r_else
r_if
c_cond
(paren
id|xres
op_le
l_int|640
op_logical_and
id|bpp
op_ne
l_int|16
)paren
id|xres
op_assign
l_int|640
suffix:semicolon
r_if
c_cond
(paren
id|yres
op_le
l_int|200
)paren
id|yres
op_assign
l_int|200
suffix:semicolon
r_else
r_if
c_cond
(paren
id|yres
op_le
l_int|240
)paren
id|yres
op_assign
l_int|240
suffix:semicolon
r_else
r_if
c_cond
(paren
id|yres
op_le
l_int|400
)paren
id|yres
op_assign
l_int|400
suffix:semicolon
multiline_comment|/* 2 planes must use STE compatibility mode */
id|par-&gt;hw.falcon.ste_mode
op_assign
id|bpp
op_eq
l_int|2
suffix:semicolon
id|par-&gt;hw.falcon.mono
op_assign
id|bpp
op_eq
l_int|1
suffix:semicolon
multiline_comment|/* Total and visible scanline length must be a multiple of one longword,&n;&t; * this and the console fontwidth yields the alignment for xres and&n;&t; * xres_virtual.&n;&t; * TODO: this way &quot;odd&quot; fontheights are not supported&n;&t; *&n;&t; * Special case in STE mode: blank and graphic positions don&squot;t align,&n;&t; * avoid trash at right margin&n;&t; */
r_if
c_cond
(paren
id|par-&gt;hw.falcon.ste_mode
)paren
id|xres
op_assign
(paren
id|xres
op_plus
l_int|63
)paren
op_amp
op_complement
l_int|63
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bpp
op_eq
l_int|1
)paren
id|xres
op_assign
(paren
id|xres
op_plus
l_int|31
)paren
op_amp
op_complement
l_int|31
suffix:semicolon
r_else
id|xres
op_assign
(paren
id|xres
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|yres
op_ge
l_int|400
)paren
id|yres
op_assign
(paren
id|yres
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
suffix:semicolon
r_else
id|yres
op_assign
(paren
id|yres
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|xres_virtual
OL
id|xres
)paren
id|xres_virtual
op_assign
id|xres
suffix:semicolon
r_else
r_if
c_cond
(paren
id|bpp
op_eq
l_int|1
)paren
id|xres_virtual
op_assign
(paren
id|xres_virtual
op_plus
l_int|31
)paren
op_amp
op_complement
l_int|31
suffix:semicolon
r_else
id|xres_virtual
op_assign
(paren
id|xres_virtual
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|yres_virtual
op_le
l_int|0
)paren
id|yres_virtual
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|yres_virtual
OL
id|yres
)paren
id|yres_virtual
op_assign
id|yres
suffix:semicolon
multiline_comment|/* backward bug-compatibility */
r_if
c_cond
(paren
id|var-&gt;pixclock
OG
l_int|1
)paren
id|var-&gt;pixclock
op_sub_assign
l_int|1
suffix:semicolon
id|par-&gt;hw.falcon.line_width
op_assign
id|bpp
op_star
id|xres
op_div
l_int|16
suffix:semicolon
id|par-&gt;hw.falcon.line_offset
op_assign
id|bpp
op_star
(paren
id|xres_virtual
op_minus
id|xres
)paren
op_div
l_int|16
suffix:semicolon
multiline_comment|/* single or double pixel width */
id|xstretch
op_assign
(paren
id|xres
OL
l_int|640
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
macro_line|#if 0 /* SM124 supports only 640x400, this is rejected above */
r_if
c_cond
(paren
id|mon_type
op_eq
id|F_MON_SM
)paren
(brace
r_if
c_cond
(paren
id|xres
op_ne
l_int|640
op_logical_and
id|yres
op_ne
l_int|400
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|plen
op_assign
l_int|1
suffix:semicolon
id|pclock
op_assign
op_amp
id|f32
suffix:semicolon
multiline_comment|/* SM124-mode is special */
id|par-&gt;hw.falcon.ste_mode
op_assign
l_int|1
suffix:semicolon
id|par-&gt;hw.falcon.f_shift
op_assign
l_int|0x000
suffix:semicolon
id|par-&gt;hw.falcon.st_shift
op_assign
l_int|0x200
suffix:semicolon
id|left_margin
op_assign
id|hsync_len
op_assign
l_int|128
op_div
id|plen
suffix:semicolon
id|right_margin
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* TODO set all margins */
)brace
r_else
macro_line|#endif
r_if
c_cond
(paren
id|mon_type
op_eq
id|F_MON_SC
op_logical_or
id|mon_type
op_eq
id|F_MON_TV
)paren
(brace
id|plen
op_assign
l_int|2
op_star
id|xstretch
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;pixclock
OG
id|f32.t
op_star
id|plen
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pclock
op_assign
op_amp
id|f32
suffix:semicolon
r_if
c_cond
(paren
id|yres
OG
l_int|240
)paren
id|interlace
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;pixclock
op_eq
l_int|0
)paren
(brace
multiline_comment|/* set some minimal margins which center the screen */
id|left_margin
op_assign
l_int|32
suffix:semicolon
id|right_margin
op_assign
l_int|18
suffix:semicolon
id|hsync_len
op_assign
id|pclock-&gt;hsync
op_div
id|plen
suffix:semicolon
id|upper_margin
op_assign
l_int|31
suffix:semicolon
id|lower_margin
op_assign
l_int|14
suffix:semicolon
id|vsync_len
op_assign
id|interlace
ques
c_cond
l_int|3
suffix:colon
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|left_margin
op_assign
id|var-&gt;left_margin
suffix:semicolon
id|right_margin
op_assign
id|var-&gt;right_margin
suffix:semicolon
id|hsync_len
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|upper_margin
op_assign
id|var-&gt;upper_margin
suffix:semicolon
id|lower_margin
op_assign
id|var-&gt;lower_margin
suffix:semicolon
id|vsync_len
op_assign
id|var-&gt;vsync_len
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
(brace
id|upper_margin
op_assign
(paren
id|upper_margin
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|lower_margin
op_assign
(paren
id|lower_margin
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|vsync_len
op_assign
(paren
id|vsync_len
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
(brace
id|upper_margin
op_mul_assign
l_int|2
suffix:semicolon
id|lower_margin
op_mul_assign
l_int|2
suffix:semicolon
id|vsync_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* F_MON_VGA */
r_if
c_cond
(paren
id|bpp
op_eq
l_int|16
)paren
id|xstretch
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Double pixel width only for hicolor */
multiline_comment|/* Default values are used for vert./hor. timing if no pixelclock given. */
r_if
c_cond
(paren
id|var-&gt;pixclock
op_eq
l_int|0
)paren
(brace
r_int
id|linesize
suffix:semicolon
multiline_comment|/* Choose master pixelclock depending on hor. timing */
id|plen
op_assign
l_int|1
op_star
id|xstretch
suffix:semicolon
r_if
c_cond
(paren
(paren
id|plen
op_star
id|xres
op_plus
id|f25.right
op_plus
id|f25.hsync
op_plus
id|f25.left
)paren
op_star
id|fb_info.monspecs.hfmin
OL
id|f25.f
)paren
id|pclock
op_assign
op_amp
id|f25
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|plen
op_star
id|xres
op_plus
id|f32.right
op_plus
id|f32.hsync
op_plus
id|f32.left
)paren
op_star
id|fb_info.monspecs.hfmin
OL
id|f32.f
)paren
id|pclock
op_assign
op_amp
id|f32
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|plen
op_star
id|xres
op_plus
id|fext.right
op_plus
id|fext.hsync
op_plus
id|fext.left
)paren
op_star
id|fb_info.monspecs.hfmin
OL
id|fext.f
op_logical_and
id|fext.f
)paren
id|pclock
op_assign
op_amp
id|fext
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
id|left_margin
op_assign
id|pclock-&gt;left
op_div
id|plen
suffix:semicolon
id|right_margin
op_assign
id|pclock-&gt;right
op_div
id|plen
suffix:semicolon
id|hsync_len
op_assign
id|pclock-&gt;hsync
op_div
id|plen
suffix:semicolon
id|linesize
op_assign
id|left_margin
op_plus
id|xres
op_plus
id|right_margin
op_plus
id|hsync_len
suffix:semicolon
id|upper_margin
op_assign
l_int|31
suffix:semicolon
id|lower_margin
op_assign
l_int|11
suffix:semicolon
id|vsync_len
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Choose largest pixelclock &lt;= wanted clock */
r_int
id|i
suffix:semicolon
r_int
r_int
id|pcl
op_assign
id|ULONG_MAX
suffix:semicolon
id|pclock
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
l_int|4
suffix:semicolon
id|i
op_mul_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|f25.t
op_star
id|i
op_ge
id|var-&gt;pixclock
op_logical_and
id|f25.t
op_star
id|i
OL
id|pcl
)paren
(brace
id|pcl
op_assign
id|f25.t
op_star
id|i
suffix:semicolon
id|pclock
op_assign
op_amp
id|f25
suffix:semicolon
)brace
r_if
c_cond
(paren
id|f32.t
op_star
id|i
op_ge
id|var-&gt;pixclock
op_logical_and
id|f32.t
op_star
id|i
OL
id|pcl
)paren
(brace
id|pcl
op_assign
id|f32.t
op_star
id|i
suffix:semicolon
id|pclock
op_assign
op_amp
id|f32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fext.t
op_logical_and
id|fext.t
op_star
id|i
op_ge
id|var-&gt;pixclock
op_logical_and
id|fext.t
op_star
id|i
OL
id|pcl
)paren
(brace
id|pcl
op_assign
id|fext.t
op_star
id|i
suffix:semicolon
id|pclock
op_assign
op_amp
id|fext
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|pclock
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|plen
op_assign
id|pcl
op_div
id|pclock-&gt;t
suffix:semicolon
id|left_margin
op_assign
id|var-&gt;left_margin
suffix:semicolon
id|right_margin
op_assign
id|var-&gt;right_margin
suffix:semicolon
id|hsync_len
op_assign
id|var-&gt;hsync_len
suffix:semicolon
id|upper_margin
op_assign
id|var-&gt;upper_margin
suffix:semicolon
id|lower_margin
op_assign
id|var-&gt;lower_margin
suffix:semicolon
id|vsync_len
op_assign
id|var-&gt;vsync_len
suffix:semicolon
multiline_comment|/* Internal unit is [single lines per (half-)frame] */
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
(brace
multiline_comment|/* # lines in half frame */
multiline_comment|/* External unit is [lines per full frame] */
id|upper_margin
op_assign
(paren
id|upper_margin
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|lower_margin
op_assign
(paren
id|lower_margin
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|vsync_len
op_assign
(paren
id|vsync_len
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
(brace
multiline_comment|/* External unit is [double lines per frame] */
id|upper_margin
op_mul_assign
l_int|2
suffix:semicolon
id|lower_margin
op_mul_assign
l_int|2
suffix:semicolon
id|vsync_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pclock
op_eq
op_amp
id|fext
)paren
id|longoffset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* VIDEL doesn&squot;t synchronize on short offset */
)brace
multiline_comment|/* Is video bus bandwidth (32MB/s) too low for this resolution? */
multiline_comment|/* this is definitely wrong if bus clock != 32MHz */
r_if
c_cond
(paren
id|pclock-&gt;f
op_div
id|plen
op_div
l_int|8
op_star
id|bpp
OG
l_int|32000000L
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vsync_len
OL
l_int|1
)paren
id|vsync_len
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* include sync lengths in right/lower margin for all calculations */
id|right_margin
op_add_assign
id|hsync_len
suffix:semicolon
id|lower_margin
op_add_assign
id|vsync_len
suffix:semicolon
multiline_comment|/* ! In all calculations of margins we use # of lines in half frame&n;&t; * (which is a full frame in non-interlace mode), so we can switch&n;&t; * between interlace and non-interlace without messing around&n;&t; * with these.&n;&t; */
id|again
suffix:colon
multiline_comment|/* Set base_offset 128 and video bus width */
id|par-&gt;hw.falcon.vid_control
op_assign
id|mon_type
op_or
id|f030_bus_width
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|longoffset
)paren
id|par-&gt;hw.falcon.vid_control
op_or_assign
id|VCO_SHORTOFFS
suffix:semicolon
multiline_comment|/* base_offset 64 */
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
id|par-&gt;hw.falcon.vid_control
op_or_assign
id|VCO_HSYPOS
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
id|par-&gt;hw.falcon.vid_control
op_or_assign
id|VCO_VSYPOS
suffix:semicolon
multiline_comment|/* Pixelclock */
id|par-&gt;hw.falcon.vid_control
op_or_assign
id|pclock-&gt;control_mask
suffix:semicolon
multiline_comment|/* External or internal clock */
id|par-&gt;hw.falcon.sync
op_assign
id|pclock-&gt;sync_mask
op_or
l_int|0x2
suffix:semicolon
multiline_comment|/* Pixellength and prescale */
id|par-&gt;hw.falcon.vid_mode
op_assign
(paren
l_int|2
op_div
id|plen
)paren
op_lshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|doubleline
)paren
id|par-&gt;hw.falcon.vid_mode
op_or_assign
id|VMO_DOUBLE
suffix:semicolon
r_if
c_cond
(paren
id|interlace
)paren
id|par-&gt;hw.falcon.vid_mode
op_or_assign
id|VMO_INTER
suffix:semicolon
multiline_comment|/*********************&n;&t;Horizontal timing: unit = [master clock cycles]&n;&t;unit of hxx-registers: [master clock cycles * prescale]&n;&t;Hxx-registers are 9 bit wide&n;&n;&t;1 line = ((hht + 2) * 2 * prescale) clock cycles&n;&n;&t;graphic output = hdb &amp; 0x200 ?&n;&t;       ((hht+2)*2 - hdb + hde) * prescale - hdboff + hdeoff:&n;&t;       ( hht + 2  - hdb + hde) * prescale - hdboff + hdeoff&n;&t;(this must be a multiple of plen*128/bpp, on VGA pixels&n;&t; to the right may be cut off with a bigger right margin)&n;&n;&t;start of graphics relative to start of 1st halfline = hdb &amp; 0x200 ?&n;&t;       (hdb - hht - 2) * prescale + hdboff :&n;&t;       hdb * prescale + hdboff&n;&n;&t;end of graphics relative to start of 1st halfline =&n;&t;       (hde + hht + 2) * prescale + hdeoff&n;&t;*********************/
multiline_comment|/* Calculate VIDEL registers */
(brace
r_int
id|hdb_off
comma
id|hde_off
comma
id|base_off
suffix:semicolon
r_int
id|gstart
comma
id|gend1
comma
id|gend2
comma
id|align
suffix:semicolon
id|prescale
op_assign
id|hxx_prescale
c_func
(paren
op_amp
id|par-&gt;hw.falcon
)paren
suffix:semicolon
id|base_off
op_assign
id|par-&gt;hw.falcon.vid_control
op_amp
id|VCO_SHORTOFFS
ques
c_cond
l_int|64
suffix:colon
l_int|128
suffix:semicolon
multiline_comment|/* Offsets depend on video mode */
multiline_comment|/* Offsets are in clock cycles, divide by prescale to&n;&t; * calculate hd[be]-registers&n;&t; */
r_if
c_cond
(paren
id|par-&gt;hw.falcon.f_shift
op_amp
l_int|0x100
)paren
(brace
id|align
op_assign
l_int|1
suffix:semicolon
id|hde_off
op_assign
l_int|0
suffix:semicolon
id|hdb_off
op_assign
(paren
id|base_off
op_plus
l_int|16
op_star
id|plen
)paren
op_plus
id|prescale
suffix:semicolon
)brace
r_else
(brace
id|align
op_assign
l_int|128
op_div
id|bpp
suffix:semicolon
id|hde_off
op_assign
(paren
(paren
l_int|128
op_div
id|bpp
op_plus
l_int|2
)paren
op_star
id|plen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;hw.falcon.ste_mode
)paren
id|hdb_off
op_assign
(paren
l_int|64
op_plus
id|base_off
op_plus
(paren
l_int|128
op_div
id|bpp
op_plus
l_int|2
)paren
op_star
id|plen
)paren
op_plus
id|prescale
suffix:semicolon
r_else
id|hdb_off
op_assign
(paren
id|base_off
op_plus
(paren
l_int|128
op_div
id|bpp
op_plus
l_int|18
)paren
op_star
id|plen
)paren
op_plus
id|prescale
suffix:semicolon
)brace
id|gstart
op_assign
(paren
id|prescale
op_div
l_int|2
op_plus
id|plen
op_star
id|left_margin
)paren
op_div
id|prescale
suffix:semicolon
multiline_comment|/* gend1 is for hde (gend-gstart multiple of align), shifter&squot;s xres */
id|gend1
op_assign
id|gstart
op_plus
(paren
(paren
id|xres
op_plus
id|align
op_minus
l_int|1
)paren
op_div
id|align
)paren
op_star
id|align
op_star
id|plen
op_div
id|prescale
suffix:semicolon
multiline_comment|/* gend2 is for hbb, visible xres (rest to gend1 is cut off by hblank) */
id|gend2
op_assign
id|gstart
op_plus
id|xres
op_star
id|plen
op_div
id|prescale
suffix:semicolon
id|par-&gt;HHT
op_assign
id|plen
op_star
(paren
id|left_margin
op_plus
id|xres
op_plus
id|right_margin
)paren
op_div
(paren
l_int|2
op_star
id|prescale
)paren
op_minus
l_int|2
suffix:semicolon
multiline_comment|/*&t;par-&gt;HHT = (gend2 + plen * right_margin / prescale) / 2 - 2;*/
id|par-&gt;HDB
op_assign
id|gstart
op_minus
id|hdb_off
op_div
id|prescale
suffix:semicolon
id|par-&gt;HBE
op_assign
id|gstart
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;HDB
OL
l_int|0
)paren
id|par-&gt;HDB
op_add_assign
id|par-&gt;HHT
op_plus
l_int|2
op_plus
l_int|0x200
suffix:semicolon
id|par-&gt;HDE
op_assign
id|gend1
op_minus
id|par-&gt;HHT
op_minus
l_int|2
op_minus
id|hde_off
op_div
id|prescale
suffix:semicolon
id|par-&gt;HBB
op_assign
id|gend2
op_minus
id|par-&gt;HHT
op_minus
l_int|2
suffix:semicolon
macro_line|#if 0
multiline_comment|/* One more Videl constraint: data fetch of two lines must not overlap */
r_if
c_cond
(paren
id|par-&gt;HDB
op_amp
l_int|0x200
op_logical_and
id|par-&gt;HDB
op_amp
op_complement
l_int|0x200
op_minus
id|par-&gt;HDE
op_le
l_int|5
)paren
(brace
multiline_comment|/* if this happens increase margins, decrease hfreq. */
)brace
macro_line|#endif
r_if
c_cond
(paren
id|hde_off
op_mod
id|prescale
)paren
id|par-&gt;HBB
op_increment
suffix:semicolon
multiline_comment|/* compensate for non matching hde and hbb */
id|par-&gt;HSS
op_assign
id|par-&gt;HHT
op_plus
l_int|2
op_minus
id|plen
op_star
id|hsync_len
op_div
id|prescale
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;HSS
OL
id|par-&gt;HBB
)paren
id|par-&gt;HSS
op_assign
id|par-&gt;HBB
suffix:semicolon
)brace
multiline_comment|/*  check hor. frequency */
id|hfreq
op_assign
id|pclock-&gt;f
op_div
(paren
(paren
id|par-&gt;HHT
op_plus
l_int|2
)paren
op_star
id|prescale
op_star
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hfreq
OG
id|fb_info.monspecs.hfmax
op_logical_and
id|mon_type
op_ne
id|F_MON_VGA
)paren
(brace
multiline_comment|/* ++guenther:   ^^^^^^^^^^^^^^^^^^^ can&squot;t remember why I did this */
multiline_comment|/* Too high -&gt; enlarge margin */
id|left_margin
op_add_assign
l_int|1
suffix:semicolon
id|right_margin
op_add_assign
l_int|1
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hfreq
OG
id|fb_info.monspecs.hfmax
op_logical_or
id|hfreq
OL
id|fb_info.monspecs.hfmin
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Vxx-registers */
multiline_comment|/* All Vxx must be odd in non-interlace, since frame starts in the middle&n;&t; * of the first displayed line!&n;&t; * One frame consists of VFT+1 half lines. VFT+1 must be even in&n;&t; * non-interlace, odd in interlace mode for synchronisation.&n;&t; * Vxx-registers are 11 bit wide&n;&t; */
id|par-&gt;VBE
op_assign
(paren
id|upper_margin
op_star
l_int|2
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* must begin on odd halfline */
id|par-&gt;VDB
op_assign
id|par-&gt;VBE
suffix:semicolon
id|par-&gt;VDE
op_assign
id|yres
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|interlace
)paren
id|par-&gt;VDE
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|doubleline
)paren
id|par-&gt;VDE
op_lshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* VDE now half lines per (half-)frame */
id|par-&gt;VDE
op_add_assign
id|par-&gt;VDB
suffix:semicolon
id|par-&gt;VBB
op_assign
id|par-&gt;VDE
suffix:semicolon
id|par-&gt;VFT
op_assign
id|par-&gt;VBB
op_plus
(paren
id|lower_margin
op_star
l_int|2
op_minus
l_int|1
)paren
op_minus
l_int|1
suffix:semicolon
id|par-&gt;VSS
op_assign
id|par-&gt;VFT
op_plus
l_int|1
op_minus
(paren
id|vsync_len
op_star
l_int|2
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* vbb,vss,vft must be even in interlace mode */
r_if
c_cond
(paren
id|interlace
)paren
(brace
id|par-&gt;VBB
op_increment
suffix:semicolon
id|par-&gt;VSS
op_increment
suffix:semicolon
id|par-&gt;VFT
op_increment
suffix:semicolon
)brace
multiline_comment|/* V-frequency check, hope I didn&squot;t create any loop here. */
multiline_comment|/* Interlace and doubleline are mutually exclusive. */
id|vfreq
op_assign
(paren
id|hfreq
op_star
l_int|2
)paren
op_div
(paren
id|par-&gt;VFT
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vfreq
OG
id|fb_info.monspecs.vfmax
op_logical_and
op_logical_neg
id|doubleline
op_logical_and
op_logical_neg
id|interlace
)paren
(brace
multiline_comment|/* Too high -&gt; try again with doubleline */
id|doubleline
op_assign
l_int|1
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vfreq
OL
id|fb_info.monspecs.vfmin
op_logical_and
op_logical_neg
id|interlace
op_logical_and
op_logical_neg
id|doubleline
)paren
(brace
multiline_comment|/* Too low -&gt; try again with interlace */
id|interlace
op_assign
l_int|1
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vfreq
OL
id|fb_info.monspecs.vfmin
op_logical_and
id|doubleline
)paren
(brace
multiline_comment|/* Doubleline too low -&gt; clear doubleline and enlarge margins */
r_int
id|lines
suffix:semicolon
id|doubleline
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|lines
op_assign
l_int|0
suffix:semicolon
(paren
id|hfreq
op_star
l_int|2
)paren
op_div
(paren
id|par-&gt;VFT
op_plus
l_int|1
op_plus
l_int|4
op_star
id|lines
op_minus
l_int|2
op_star
id|yres
)paren
OG
id|fb_info.monspecs.vfmax
suffix:semicolon
id|lines
op_increment
)paren
suffix:semicolon
id|upper_margin
op_add_assign
id|lines
suffix:semicolon
id|lower_margin
op_add_assign
id|lines
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vfreq
OG
id|fb_info.monspecs.vfmax
op_logical_and
id|doubleline
)paren
(brace
multiline_comment|/* Doubleline too high -&gt; enlarge margins */
r_int
id|lines
suffix:semicolon
r_for
c_loop
(paren
id|lines
op_assign
l_int|0
suffix:semicolon
(paren
id|hfreq
op_star
l_int|2
)paren
op_div
(paren
id|par-&gt;VFT
op_plus
l_int|1
op_plus
l_int|4
op_star
id|lines
)paren
OG
id|fb_info.monspecs.vfmax
suffix:semicolon
id|lines
op_add_assign
l_int|2
)paren
suffix:semicolon
id|upper_margin
op_add_assign
id|lines
suffix:semicolon
id|lower_margin
op_add_assign
id|lines
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vfreq
OG
id|fb_info.monspecs.vfmax
op_logical_and
id|interlace
)paren
(brace
multiline_comment|/* Interlace, too high -&gt; enlarge margins */
r_int
id|lines
suffix:semicolon
r_for
c_loop
(paren
id|lines
op_assign
l_int|0
suffix:semicolon
(paren
id|hfreq
op_star
l_int|2
)paren
op_div
(paren
id|par-&gt;VFT
op_plus
l_int|1
op_plus
l_int|4
op_star
id|lines
)paren
OG
id|fb_info.monspecs.vfmax
suffix:semicolon
id|lines
op_increment
)paren
suffix:semicolon
id|upper_margin
op_add_assign
id|lines
suffix:semicolon
id|lower_margin
op_add_assign
id|lines
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vfreq
template_param
id|fb_info.monspecs.vfmax
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|set_screen_base
suffix:colon
id|linelen
op_assign
id|xres_virtual
op_star
id|bpp
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|yres_virtual
op_star
id|linelen
OG
id|screen_len
op_logical_and
id|screen_len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|yres
op_star
id|linelen
OG
id|screen_len
op_logical_and
id|screen_len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
op_plus
id|yres
OG
id|yres_virtual
op_logical_and
id|yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;yres_virtual
op_assign
id|yres_virtual
suffix:semicolon
id|par-&gt;screen_base
op_assign
id|screen_base
op_plus
id|var-&gt;yoffset
op_star
id|linelen
suffix:semicolon
id|par-&gt;hw.falcon.xoffset
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|falcon_encode_var
r_static
r_int
id|falcon_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
multiline_comment|/* !!! only for VGA !!! */
r_int
id|linelen
suffix:semicolon
r_int
id|prescale
comma
id|plen
suffix:semicolon
r_int
id|hdb_off
comma
id|hde_off
comma
id|base_off
suffix:semicolon
r_struct
id|falcon_hw
op_star
id|hw
op_assign
op_amp
id|par-&gt;hw.falcon
suffix:semicolon
id|memset
c_func
(paren
id|var
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
multiline_comment|/* possible frequencies: 25.175 or 32MHz */
id|var-&gt;pixclock
op_assign
id|hw-&gt;sync
op_amp
l_int|0x1
ques
c_cond
id|fext.t
suffix:colon
id|hw-&gt;vid_control
op_amp
id|VCO_CLOCK25
ques
c_cond
id|f25.t
suffix:colon
id|f32.t
suffix:semicolon
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;sync
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;vid_control
op_amp
id|VCO_HSYPOS
)paren
id|var-&gt;sync
op_or_assign
id|FB_SYNC_HOR_HIGH_ACT
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;vid_control
op_amp
id|VCO_VSYPOS
)paren
id|var-&gt;sync
op_or_assign
id|FB_SYNC_VERT_HIGH_ACT
suffix:semicolon
id|var-&gt;vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;vid_mode
op_amp
id|VMO_INTER
)paren
id|var-&gt;vmode
op_or_assign
id|FB_VMODE_INTERLACED
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;vid_mode
op_amp
id|VMO_DOUBLE
)paren
id|var-&gt;vmode
op_or_assign
id|FB_VMODE_DOUBLE
suffix:semicolon
multiline_comment|/* visible y resolution:&n;&t; * Graphics display starts at line VDB and ends at line&n;&t; * VDE. If interlace mode off unit of VC-registers is&n;&t; * half lines, else lines.&n;&t; */
id|var-&gt;yres
op_assign
id|hw-&gt;vde
op_minus
id|hw-&gt;vdb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
)paren
id|var-&gt;yres
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
id|var-&gt;yres
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* to get bpp, we must examine f_shift and st_shift.&n;&t; * f_shift is valid if any of bits no. 10, 8 or 4&n;&t; * is set. Priority in f_shift is: 10 &quot;&gt;&quot; 8 &quot;&gt;&quot; 4, i.e.&n;&t; * if bit 10 set then bit 8 and bit 4 don&squot;t care...&n;&t; * If all these bits are 0 get display depth from st_shift&n;&t; * (as for ST and STE)&n;&t; */
r_if
c_cond
(paren
id|hw-&gt;f_shift
op_amp
l_int|0x400
)paren
multiline_comment|/* 2 colors */
id|var-&gt;bits_per_pixel
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hw-&gt;f_shift
op_amp
l_int|0x100
)paren
multiline_comment|/* hicolor */
id|var-&gt;bits_per_pixel
op_assign
l_int|16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hw-&gt;f_shift
op_amp
l_int|0x010
)paren
multiline_comment|/* 8 bitplanes */
id|var-&gt;bits_per_pixel
op_assign
l_int|8
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hw-&gt;st_shift
op_eq
l_int|0
)paren
id|var-&gt;bits_per_pixel
op_assign
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|hw-&gt;st_shift
op_eq
l_int|0x100
)paren
id|var-&gt;bits_per_pixel
op_assign
l_int|2
suffix:semicolon
r_else
multiline_comment|/* if (hw-&gt;st_shift == 0x200) */
id|var-&gt;bits_per_pixel
op_assign
l_int|1
suffix:semicolon
id|var-&gt;xres
op_assign
id|hw-&gt;line_width
op_star
l_int|16
op_div
id|var-&gt;bits_per_pixel
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|var-&gt;xres
op_plus
id|hw-&gt;line_offset
op_star
l_int|16
op_div
id|var-&gt;bits_per_pixel
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;xoffset
)paren
id|var-&gt;xres_virtual
op_add_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
op_eq
l_int|16
)paren
(brace
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;green.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.msb_right
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
id|hw-&gt;ste_mode
ques
c_cond
l_int|4
suffix:colon
l_int|6
suffix:semicolon
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;grayscale
op_assign
l_int|0
suffix:semicolon
id|var-&gt;blue
op_assign
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
)brace
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|linelen
op_assign
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|screen_len
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;yres_virtual
)paren
id|var-&gt;yres_virtual
op_assign
id|par-&gt;yres_virtual
suffix:semicolon
r_else
multiline_comment|/* yres_virtual==0 means use maximum */
id|var-&gt;yres_virtual
op_assign
id|screen_len
op_div
id|linelen
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hwscroll
OL
l_int|0
)paren
id|var-&gt;yres_virtual
op_assign
l_int|2
op_star
id|var-&gt;yres
suffix:semicolon
r_else
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
op_plus
id|hwscroll
op_star
l_int|16
suffix:semicolon
)brace
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* TODO change this */
multiline_comment|/* hdX-offsets */
id|prescale
op_assign
id|hxx_prescale
c_func
(paren
id|hw
)paren
suffix:semicolon
id|plen
op_assign
l_int|4
op_rshift
(paren
id|hw-&gt;vid_mode
op_rshift
l_int|2
op_amp
l_int|0x3
)paren
suffix:semicolon
id|base_off
op_assign
id|hw-&gt;vid_control
op_amp
id|VCO_SHORTOFFS
ques
c_cond
l_int|64
suffix:colon
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;f_shift
op_amp
l_int|0x100
)paren
(brace
id|hde_off
op_assign
l_int|0
suffix:semicolon
id|hdb_off
op_assign
(paren
id|base_off
op_plus
l_int|16
op_star
id|plen
)paren
op_plus
id|prescale
suffix:semicolon
)brace
r_else
(brace
id|hde_off
op_assign
(paren
(paren
l_int|128
op_div
id|var-&gt;bits_per_pixel
op_plus
l_int|2
)paren
op_star
id|plen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;ste_mode
)paren
id|hdb_off
op_assign
(paren
l_int|64
op_plus
id|base_off
op_plus
(paren
l_int|128
op_div
id|var-&gt;bits_per_pixel
op_plus
l_int|2
)paren
op_star
id|plen
)paren
op_plus
id|prescale
suffix:semicolon
r_else
id|hdb_off
op_assign
(paren
id|base_off
op_plus
(paren
l_int|128
op_div
id|var-&gt;bits_per_pixel
op_plus
l_int|18
)paren
op_star
id|plen
)paren
op_plus
id|prescale
suffix:semicolon
)brace
multiline_comment|/* Right margin includes hsync */
id|var-&gt;left_margin
op_assign
id|hdb_off
op_plus
id|prescale
op_star
(paren
(paren
id|hw-&gt;hdb
op_amp
l_int|0x1ff
)paren
op_minus
(paren
id|hw-&gt;hdb
op_amp
l_int|0x200
ques
c_cond
l_int|2
op_plus
id|hw-&gt;hht
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;ste_mode
op_logical_or
id|mon_type
op_ne
id|F_MON_VGA
)paren
id|var-&gt;right_margin
op_assign
id|prescale
op_star
(paren
id|hw-&gt;hht
op_plus
l_int|2
op_minus
id|hw-&gt;hde
)paren
op_minus
id|hde_off
suffix:semicolon
r_else
multiline_comment|/* can&squot;t use this in ste_mode, because hbb is +1 off */
id|var-&gt;right_margin
op_assign
id|prescale
op_star
(paren
id|hw-&gt;hht
op_plus
l_int|2
op_minus
id|hw-&gt;hbb
)paren
suffix:semicolon
id|var-&gt;hsync_len
op_assign
id|prescale
op_star
(paren
id|hw-&gt;hht
op_plus
l_int|2
op_minus
id|hw-&gt;hss
)paren
suffix:semicolon
multiline_comment|/* Lower margin includes vsync */
id|var-&gt;upper_margin
op_assign
id|hw-&gt;vdb
op_div
l_int|2
suffix:semicolon
multiline_comment|/* round down to full lines */
id|var-&gt;lower_margin
op_assign
(paren
id|hw-&gt;vft
op_plus
l_int|1
op_minus
id|hw-&gt;vde
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
multiline_comment|/* round up */
id|var-&gt;vsync_len
op_assign
(paren
id|hw-&gt;vft
op_plus
l_int|1
op_minus
id|hw-&gt;vss
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
multiline_comment|/* round up */
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_INTERLACED
)paren
(brace
id|var-&gt;upper_margin
op_mul_assign
l_int|2
suffix:semicolon
id|var-&gt;lower_margin
op_mul_assign
l_int|2
suffix:semicolon
id|var-&gt;vsync_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|var-&gt;vmode
op_amp
id|FB_VMODE_DOUBLE
)paren
(brace
id|var-&gt;upper_margin
op_assign
(paren
id|var-&gt;upper_margin
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|var-&gt;lower_margin
op_assign
(paren
id|var-&gt;lower_margin
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|var-&gt;vsync_len
op_assign
(paren
id|var-&gt;vsync_len
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|var-&gt;pixclock
op_mul_assign
id|plen
suffix:semicolon
id|var-&gt;left_margin
op_div_assign
id|plen
suffix:semicolon
id|var-&gt;right_margin
op_div_assign
id|plen
suffix:semicolon
id|var-&gt;hsync_len
op_div_assign
id|plen
suffix:semicolon
id|var-&gt;right_margin
op_sub_assign
id|var-&gt;hsync_len
suffix:semicolon
id|var-&gt;lower_margin
op_sub_assign
id|var-&gt;vsync_len
suffix:semicolon
r_if
c_cond
(paren
id|screen_base
)paren
id|var-&gt;yoffset
op_assign
(paren
id|par-&gt;screen_base
op_minus
id|screen_base
)paren
op_div
id|linelen
suffix:semicolon
r_else
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;nonstd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* what is this for? */
id|var-&gt;activate
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|f_change_mode
r_static
r_int
id|f_change_mode
op_assign
l_int|0
suffix:semicolon
DECL|variable|f_new_mode
r_static
r_struct
id|falcon_hw
id|f_new_mode
suffix:semicolon
DECL|variable|f_pan_display
r_static
r_int
id|f_pan_display
op_assign
l_int|0
suffix:semicolon
DECL|function|falcon_get_par
r_static
r_void
id|falcon_get_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_struct
id|falcon_hw
op_star
id|hw
op_assign
op_amp
id|par-&gt;hw.falcon
suffix:semicolon
id|hw-&gt;line_width
op_assign
id|shifter_f030.scn_width
suffix:semicolon
id|hw-&gt;line_offset
op_assign
id|shifter_f030.off_next
suffix:semicolon
id|hw-&gt;st_shift
op_assign
id|videl.st_shift
op_amp
l_int|0x300
suffix:semicolon
id|hw-&gt;f_shift
op_assign
id|videl.f_shift
suffix:semicolon
id|hw-&gt;vid_control
op_assign
id|videl.control
suffix:semicolon
id|hw-&gt;vid_mode
op_assign
id|videl.mode
suffix:semicolon
id|hw-&gt;sync
op_assign
id|shifter.syncmode
op_amp
l_int|0x1
suffix:semicolon
id|hw-&gt;xoffset
op_assign
id|videl.xoffset
op_amp
l_int|0xf
suffix:semicolon
id|hw-&gt;hht
op_assign
id|videl.hht
suffix:semicolon
id|hw-&gt;hbb
op_assign
id|videl.hbb
suffix:semicolon
id|hw-&gt;hbe
op_assign
id|videl.hbe
suffix:semicolon
id|hw-&gt;hdb
op_assign
id|videl.hdb
suffix:semicolon
id|hw-&gt;hde
op_assign
id|videl.hde
suffix:semicolon
id|hw-&gt;hss
op_assign
id|videl.hss
suffix:semicolon
id|hw-&gt;vft
op_assign
id|videl.vft
suffix:semicolon
id|hw-&gt;vbb
op_assign
id|videl.vbb
suffix:semicolon
id|hw-&gt;vbe
op_assign
id|videl.vbe
suffix:semicolon
id|hw-&gt;vdb
op_assign
id|videl.vdb
suffix:semicolon
id|hw-&gt;vde
op_assign
id|videl.vde
suffix:semicolon
id|hw-&gt;vss
op_assign
id|videl.vss
suffix:semicolon
id|addr
op_assign
(paren
id|shifter.bas_hi
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
op_or
(paren
id|shifter.bas_md
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
op_or
(paren
id|shifter.bas_lo
op_amp
l_int|0xff
)paren
suffix:semicolon
id|par-&gt;screen_base
op_assign
id|phys_to_virt
c_func
(paren
id|addr
)paren
suffix:semicolon
multiline_comment|/* derived parameters */
id|hw-&gt;ste_mode
op_assign
(paren
id|hw-&gt;f_shift
op_amp
l_int|0x510
)paren
op_eq
l_int|0
op_logical_and
id|hw-&gt;st_shift
op_eq
l_int|0x100
suffix:semicolon
id|hw-&gt;mono
op_assign
(paren
id|hw-&gt;f_shift
op_amp
l_int|0x400
)paren
op_logical_or
(paren
(paren
id|hw-&gt;f_shift
op_amp
l_int|0x510
)paren
op_eq
l_int|0
op_logical_and
id|hw-&gt;st_shift
op_eq
l_int|0x200
)paren
suffix:semicolon
)brace
DECL|function|falcon_set_par
r_static
r_void
id|falcon_set_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
id|f_change_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* only set screen_base if really necessary */
r_if
c_cond
(paren
id|current_par.screen_base
op_ne
id|par-&gt;screen_base
)paren
id|fbhw
op_member_access_from_pointer
id|set_screen_base
c_func
(paren
id|par-&gt;screen_base
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t touch any other registers if we keep the default resolution */
r_if
c_cond
(paren
id|DontCalcRes
)paren
r_return
suffix:semicolon
multiline_comment|/* Tell vbl-handler to change video mode.&n;&t; * We change modes only on next VBL, to avoid desynchronisation&n;&t; * (a shift to the right and wrap around by a random number of pixels&n;&t; * in all monochrome modes).&n;&t; * This seems to work on my Falcon.&n;&t; */
id|f_new_mode
op_assign
id|par-&gt;hw.falcon
suffix:semicolon
id|f_change_mode
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|falcon_vbl_switcher
r_static
r_void
id|falcon_vbl_switcher
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dummy
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
r_struct
id|falcon_hw
op_star
id|hw
op_assign
op_amp
id|f_new_mode
suffix:semicolon
r_if
c_cond
(paren
id|f_change_mode
)paren
(brace
id|f_change_mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hw-&gt;sync
op_amp
l_int|0x1
)paren
(brace
multiline_comment|/* Enable external pixelclock. This code only for ScreenWonder */
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
l_int|0xffff9202
op_assign
l_int|0xffbf
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Turn off external clocks. Read sets all output bits to 1. */
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
l_int|0xffff9202
suffix:semicolon
)brace
id|shifter.syncmode
op_assign
id|hw-&gt;sync
suffix:semicolon
id|videl.hht
op_assign
id|hw-&gt;hht
suffix:semicolon
id|videl.hbb
op_assign
id|hw-&gt;hbb
suffix:semicolon
id|videl.hbe
op_assign
id|hw-&gt;hbe
suffix:semicolon
id|videl.hdb
op_assign
id|hw-&gt;hdb
suffix:semicolon
id|videl.hde
op_assign
id|hw-&gt;hde
suffix:semicolon
id|videl.hss
op_assign
id|hw-&gt;hss
suffix:semicolon
id|videl.vft
op_assign
id|hw-&gt;vft
suffix:semicolon
id|videl.vbb
op_assign
id|hw-&gt;vbb
suffix:semicolon
id|videl.vbe
op_assign
id|hw-&gt;vbe
suffix:semicolon
id|videl.vdb
op_assign
id|hw-&gt;vdb
suffix:semicolon
id|videl.vde
op_assign
id|hw-&gt;vde
suffix:semicolon
id|videl.vss
op_assign
id|hw-&gt;vss
suffix:semicolon
id|videl.f_shift
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* write enables Falcon palette, 0: 4 planes */
r_if
c_cond
(paren
id|hw-&gt;ste_mode
)paren
(brace
id|videl.st_shift
op_assign
id|hw-&gt;st_shift
suffix:semicolon
multiline_comment|/* write enables STE palette */
)brace
r_else
(brace
multiline_comment|/* IMPORTANT:&n;&t;&t;&t; * set st_shift 0, so we can tell the screen-depth if f_shift==0.&n;&t;&t;&t; * Writing 0 to f_shift enables 4 plane Falcon mode but&n;&t;&t;&t; * doesn&squot;t set st_shift. st_shift!=0 (!=4planes) is impossible&n;&t;&t;&t; * with Falcon palette.&n;&t;&t;&t; */
id|videl.st_shift
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* now back to Falcon palette mode */
id|videl.f_shift
op_assign
id|hw-&gt;f_shift
suffix:semicolon
)brace
multiline_comment|/* writing to st_shift changed scn_width and vid_mode */
id|videl.xoffset
op_assign
id|hw-&gt;xoffset
suffix:semicolon
id|shifter_f030.scn_width
op_assign
id|hw-&gt;line_width
suffix:semicolon
id|shifter_f030.off_next
op_assign
id|hw-&gt;line_offset
suffix:semicolon
id|videl.control
op_assign
id|hw-&gt;vid_control
suffix:semicolon
id|videl.mode
op_assign
id|hw-&gt;vid_mode
suffix:semicolon
)brace
r_if
c_cond
(paren
id|f_pan_display
)paren
(brace
id|f_pan_display
op_assign
l_int|0
suffix:semicolon
id|videl.xoffset
op_assign
id|current_par.hw.falcon.xoffset
suffix:semicolon
id|shifter_f030.off_next
op_assign
id|current_par.hw.falcon.line_offset
suffix:semicolon
)brace
)brace
DECL|function|falcon_pan_display
r_static
r_int
id|falcon_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
id|xoffset
suffix:semicolon
r_int
id|bpp
op_assign
id|fb_display
(braket
id|currcon
)braket
dot
id|var.bits_per_pixel
suffix:semicolon
r_if
c_cond
(paren
id|bpp
op_eq
l_int|1
)paren
id|var-&gt;xoffset
op_assign
id|up
c_func
(paren
id|var-&gt;xoffset
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bpp
op_ne
l_int|16
)paren
id|par-&gt;hw.falcon.xoffset
op_assign
id|var-&gt;xoffset
op_amp
l_int|15
suffix:semicolon
r_else
(brace
id|par-&gt;hw.falcon.xoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;xoffset
op_assign
id|up
c_func
(paren
id|var-&gt;xoffset
comma
l_int|2
)paren
suffix:semicolon
)brace
id|par-&gt;hw.falcon.line_offset
op_assign
id|bpp
op_star
(paren
id|fb_display
(braket
id|currcon
)braket
dot
id|var.xres_virtual
op_minus
id|fb_display
(braket
id|currcon
)braket
dot
id|var.xres
)paren
op_div
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;hw.falcon.xoffset
)paren
id|par-&gt;hw.falcon.line_offset
op_sub_assign
id|bpp
suffix:semicolon
id|xoffset
op_assign
id|var-&gt;xoffset
op_minus
id|par-&gt;hw.falcon.xoffset
suffix:semicolon
id|par-&gt;screen_base
op_assign
id|screen_base
op_plus
(paren
id|var-&gt;yoffset
op_star
id|fb_display
(braket
id|currcon
)braket
dot
id|var.xres_virtual
op_plus
id|xoffset
)paren
op_star
id|bpp
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|fbhw-&gt;set_screen_base
)paren
id|fbhw-&gt;set_screen_base
(paren
id|par-&gt;screen_base
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* shouldn&squot;t happen */
id|f_pan_display
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|falcon_getcolreg
r_static
r_int
id|falcon_getcolreg
c_func
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_int
id|col
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* This works in STE-mode (with 4bit/color) since f030_col-registers&n;&t; * hold up to 6bit/color.&n;&t; * Even with hicolor r/g/b=5/6/5 bit!&n;&t; */
id|col
op_assign
id|f030_col
(braket
id|regno
)braket
suffix:semicolon
op_star
id|red
op_assign
(paren
id|col
op_rshift
l_int|16
)paren
op_amp
l_int|0xff00
suffix:semicolon
op_star
id|green
op_assign
(paren
id|col
op_rshift
l_int|8
)paren
op_amp
l_int|0xff00
suffix:semicolon
op_star
id|blue
op_assign
(paren
id|col
op_lshift
l_int|8
)paren
op_amp
l_int|0xff00
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|falcon_setcolreg
r_static
r_int
id|falcon_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|255
)paren
r_return
l_int|1
suffix:semicolon
id|f030_col
(braket
id|regno
)braket
op_assign
(paren
(paren
(paren
id|red
op_amp
l_int|0xfc00
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xfc00
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xfc00
)paren
op_rshift
l_int|8
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regno
OL
l_int|16
)paren
(brace
id|shifter_tt.color_reg
(braket
id|regno
)braket
op_assign
(paren
(paren
(paren
id|red
op_amp
l_int|0xe000
)paren
op_rshift
l_int|13
)paren
op_or
(paren
(paren
id|red
op_amp
l_int|0x1000
)paren
op_rshift
l_int|12
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|green
op_amp
l_int|0xe000
)paren
op_rshift
l_int|13
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0x1000
)paren
op_rshift
l_int|12
)paren
op_lshift
l_int|4
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xe000
)paren
op_rshift
l_int|13
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0x1000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
macro_line|#ifdef FBCON_HAS_CFB16
id|fbcon_cfb16_cmap
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xf800
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xfc00
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xf800
)paren
op_rshift
l_int|11
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|falcon_blank
r_static
r_int
id|falcon_blank
c_func
(paren
r_int
id|blank_mode
)paren
(brace
multiline_comment|/* ++guenther: we can switch off graphics by changing VDB and VDE,&n; * so VIDEL doesn&squot;t hog the bus while saving.&n; * (this may affect usleep()).&n; */
r_int
id|vdb
comma
id|vss
comma
id|hbe
comma
id|hss
suffix:semicolon
r_if
c_cond
(paren
id|mon_type
op_eq
id|F_MON_SM
)paren
multiline_comment|/* this doesn&squot;t work on SM124 */
r_return
l_int|1
suffix:semicolon
id|vdb
op_assign
id|current_par.VDB
suffix:semicolon
id|vss
op_assign
id|current_par.VSS
suffix:semicolon
id|hbe
op_assign
id|current_par.HBE
suffix:semicolon
id|hss
op_assign
id|current_par.HSS
suffix:semicolon
r_if
c_cond
(paren
id|blank_mode
op_ge
l_int|1
)paren
(brace
multiline_comment|/* disable graphics output (this speeds up the CPU) ... */
id|vdb
op_assign
id|current_par.VFT
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* ... and blank all lines */
id|hbe
op_assign
id|current_par.HHT
op_plus
l_int|2
suffix:semicolon
)brace
multiline_comment|/* use VESA suspend modes on VGA monitors */
r_if
c_cond
(paren
id|mon_type
op_eq
id|F_MON_VGA
)paren
(brace
r_if
c_cond
(paren
id|blank_mode
op_eq
l_int|2
op_logical_or
id|blank_mode
op_eq
l_int|4
)paren
id|vss
op_assign
id|current_par.VFT
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|blank_mode
op_eq
l_int|3
op_logical_or
id|blank_mode
op_eq
l_int|4
)paren
id|hss
op_assign
id|current_par.HHT
op_plus
l_int|2
suffix:semicolon
)brace
id|videl.vdb
op_assign
id|vdb
suffix:semicolon
id|videl.vss
op_assign
id|vss
suffix:semicolon
id|videl.hbe
op_assign
id|hbe
suffix:semicolon
id|videl.hss
op_assign
id|hss
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|falcon_detect
r_static
r_int
id|falcon_detect
c_func
(paren
r_void
)paren
(brace
r_struct
id|atafb_par
id|par
suffix:semicolon
r_int
r_char
id|fhw
suffix:semicolon
multiline_comment|/* Determine connected monitor and set monitor parameters */
id|fhw
op_assign
op_star
(paren
r_int
r_char
op_star
)paren
l_int|0xffff8006
suffix:semicolon
id|mon_type
op_assign
id|fhw
op_rshift
l_int|6
op_amp
l_int|0x3
suffix:semicolon
multiline_comment|/* bit 1 of fhw: 1=32 bit ram bus, 0=16 bit */
id|f030_bus_width
op_assign
id|fhw
op_lshift
l_int|6
op_amp
l_int|0x80
suffix:semicolon
r_switch
c_cond
(paren
id|mon_type
)paren
(brace
r_case
id|F_MON_SM
suffix:colon
id|fb_info.monspecs.vfmin
op_assign
l_int|70
suffix:semicolon
id|fb_info.monspecs.vfmax
op_assign
l_int|72
suffix:semicolon
id|fb_info.monspecs.hfmin
op_assign
l_int|35713
suffix:semicolon
id|fb_info.monspecs.hfmax
op_assign
l_int|35715
suffix:semicolon
r_break
suffix:semicolon
r_case
id|F_MON_SC
suffix:colon
r_case
id|F_MON_TV
suffix:colon
multiline_comment|/* PAL...NTSC */
id|fb_info.monspecs.vfmin
op_assign
l_int|49
suffix:semicolon
multiline_comment|/* not 50, since TOS defaults to 49.9x Hz */
id|fb_info.monspecs.vfmax
op_assign
l_int|60
suffix:semicolon
id|fb_info.monspecs.hfmin
op_assign
l_int|15620
suffix:semicolon
id|fb_info.monspecs.hfmax
op_assign
l_int|15755
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* initialize hsync-len */
id|f25.hsync
op_assign
id|h_syncs
(braket
id|mon_type
)braket
op_div
id|f25.t
suffix:semicolon
id|f32.hsync
op_assign
id|h_syncs
(braket
id|mon_type
)braket
op_div
id|f32.t
suffix:semicolon
r_if
c_cond
(paren
id|fext.t
)paren
id|fext.hsync
op_assign
id|h_syncs
(braket
id|mon_type
)braket
op_div
id|fext.t
suffix:semicolon
id|falcon_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
id|falcon_encode_var
c_func
(paren
op_amp
id|atafb_predefined
(braket
l_int|0
)braket
comma
op_amp
id|par
)paren
suffix:semicolon
multiline_comment|/* Detected mode is always the &quot;autodetect&quot; slot */
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* ATAFB_FALCON */
multiline_comment|/* ------------------- ST(E) specific functions ---------------------- */
macro_line|#ifdef ATAFB_STE
DECL|function|stste_encode_fix
r_static
r_int
id|stste_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
id|mode
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
l_string|&quot;Atari Builtin&quot;
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
(paren
r_int
r_int
)paren
id|real_screen_base
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|screen_len
suffix:semicolon
id|fix-&gt;type
op_assign
id|FB_TYPE_INTERLEAVED_PLANES
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|2
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|mode
op_assign
id|par-&gt;hw.st.mode
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|ST_HIGH
)paren
(brace
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_MONO10
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|EXTD_SHIFTER
)paren
)paren
(brace
id|fix-&gt;xpanstep
op_assign
l_int|16
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|fix-&gt;xpanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|0
suffix:semicolon
)brace
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;line_length
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_ATARIBLITT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stste_decode_var
r_static
r_int
id|stste_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
id|xres
op_assign
id|var-&gt;xres
suffix:semicolon
r_int
id|yres
op_assign
id|var-&gt;yres
suffix:semicolon
r_int
id|bpp
op_assign
id|var-&gt;bits_per_pixel
suffix:semicolon
r_int
id|linelen
suffix:semicolon
r_int
id|yres_virtual
op_assign
id|var-&gt;yres_virtual
suffix:semicolon
r_if
c_cond
(paren
id|mono_moni
)paren
(brace
r_if
c_cond
(paren
id|bpp
OG
l_int|1
op_logical_or
id|xres
OG
id|sttt_xres
op_logical_or
id|yres
OG
id|st_yres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;hw.st.mode
op_assign
id|ST_HIGH
suffix:semicolon
id|xres
op_assign
id|sttt_xres
suffix:semicolon
id|yres
op_assign
id|st_yres
suffix:semicolon
id|bpp
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|bpp
OG
l_int|4
op_logical_or
id|xres
OG
id|sttt_xres
op_logical_or
id|yres
OG
id|st_yres
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|bpp
OG
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|xres
OG
id|sttt_xres
op_div
l_int|2
op_logical_or
id|yres
OG
id|st_yres
op_div
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;hw.st.mode
op_assign
id|ST_LOW
suffix:semicolon
id|xres
op_assign
id|sttt_xres
op_div
l_int|2
suffix:semicolon
id|yres
op_assign
id|st_yres
op_div
l_int|2
suffix:semicolon
id|bpp
op_assign
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bpp
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|xres
OG
id|sttt_xres
op_logical_or
id|yres
OG
id|st_yres
op_div
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;hw.st.mode
op_assign
id|ST_MID
suffix:semicolon
id|xres
op_assign
id|sttt_xres
suffix:semicolon
id|yres
op_assign
id|st_yres
op_div
l_int|2
suffix:semicolon
id|bpp
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|yres_virtual
op_le
l_int|0
)paren
id|yres_virtual
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|yres_virtual
OL
id|yres
)paren
id|yres_virtual
op_assign
id|yres
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_EXT
)paren
id|par-&gt;hw.st.sync
op_assign
(paren
id|par-&gt;hw.st.sync
op_amp
op_complement
l_int|1
)paren
op_or
l_int|1
suffix:semicolon
r_else
id|par-&gt;hw.st.sync
op_assign
(paren
id|par-&gt;hw.st.sync
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
id|linelen
op_assign
id|xres
op_star
id|bpp
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|yres_virtual
op_star
id|linelen
OG
id|screen_len
op_logical_and
id|screen_len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|yres
op_star
id|linelen
OG
id|screen_len
op_logical_and
id|screen_len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;yoffset
op_plus
id|yres
OG
id|yres_virtual
op_logical_and
id|yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|par-&gt;yres_virtual
op_assign
id|yres_virtual
suffix:semicolon
id|par-&gt;screen_base
op_assign
id|screen_base
op_plus
id|var-&gt;yoffset
op_star
id|linelen
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stste_encode_var
r_static
r_int
id|stste_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
id|linelen
suffix:semicolon
id|memset
c_func
(paren
id|var
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
id|ATARIHW_PRESENT
c_func
(paren
id|EXTD_SHIFTER
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|3
suffix:semicolon
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;grayscale
op_assign
l_int|0
suffix:semicolon
id|var-&gt;pixclock
op_assign
l_int|31041
suffix:semicolon
id|var-&gt;left_margin
op_assign
l_int|120
suffix:semicolon
multiline_comment|/* these are incorrect */
id|var-&gt;right_margin
op_assign
l_int|100
suffix:semicolon
id|var-&gt;upper_margin
op_assign
l_int|8
suffix:semicolon
id|var-&gt;lower_margin
op_assign
l_int|16
suffix:semicolon
id|var-&gt;hsync_len
op_assign
l_int|140
suffix:semicolon
id|var-&gt;vsync_len
op_assign
l_int|30
suffix:semicolon
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|par-&gt;hw.st.sync
op_amp
l_int|1
)paren
)paren
id|var-&gt;sync
op_assign
l_int|0
suffix:semicolon
r_else
id|var-&gt;sync
op_assign
id|FB_SYNC_EXT
suffix:semicolon
r_switch
c_cond
(paren
id|par-&gt;hw.st.mode
op_amp
l_int|3
)paren
(brace
r_case
id|ST_LOW
suffix:colon
id|var-&gt;xres
op_assign
id|sttt_xres
op_div
l_int|2
suffix:semicolon
id|var-&gt;yres
op_assign
id|st_yres
op_div
l_int|2
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_MID
suffix:colon
id|var-&gt;xres
op_assign
id|sttt_xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|st_yres
op_div
l_int|2
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ST_HIGH
suffix:colon
id|var-&gt;xres
op_assign
id|sttt_xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|st_yres
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|var-&gt;blue
op_assign
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|sttt_xres_virtual
suffix:semicolon
id|linelen
op_assign
id|var-&gt;xres_virtual
op_star
id|var-&gt;bits_per_pixel
op_div
l_int|8
suffix:semicolon
id|ovsc_addlen
op_assign
id|linelen
op_star
(paren
id|sttt_yres_virtual
op_minus
id|st_yres
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_hwscroll
)paren
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
r_else
r_if
c_cond
(paren
id|screen_len
)paren
(brace
r_if
c_cond
(paren
id|par-&gt;yres_virtual
)paren
id|var-&gt;yres_virtual
op_assign
id|par-&gt;yres_virtual
suffix:semicolon
r_else
multiline_comment|/* yres_virtual==0 means use maximum */
id|var-&gt;yres_virtual
op_assign
id|screen_len
op_div
id|linelen
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hwscroll
OL
l_int|0
)paren
id|var-&gt;yres_virtual
op_assign
l_int|2
op_star
id|var-&gt;yres
suffix:semicolon
r_else
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
op_plus
id|hwscroll
op_star
l_int|16
suffix:semicolon
)brace
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|screen_base
)paren
id|var-&gt;yoffset
op_assign
(paren
id|par-&gt;screen_base
op_minus
id|screen_base
)paren
op_div
id|linelen
suffix:semicolon
r_else
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;nonstd
op_assign
l_int|0
suffix:semicolon
id|var-&gt;activate
op_assign
l_int|0
suffix:semicolon
id|var-&gt;vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stste_get_par
r_static
r_void
id|stste_get_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
id|par-&gt;hw.st.mode
op_assign
id|shifter_tt.st_shiftmode
suffix:semicolon
id|par-&gt;hw.st.sync
op_assign
id|shifter.syncmode
suffix:semicolon
id|addr
op_assign
(paren
(paren
id|shifter.bas_hi
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|shifter.bas_md
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|EXTD_SHIFTER
)paren
)paren
id|addr
op_or_assign
(paren
id|shifter.bas_lo
op_amp
l_int|0xff
)paren
suffix:semicolon
id|par-&gt;screen_base
op_assign
id|phys_to_virt
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|stste_set_par
r_static
r_void
id|stste_set_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
id|shifter_tt.st_shiftmode
op_assign
id|par-&gt;hw.st.mode
suffix:semicolon
id|shifter.syncmode
op_assign
id|par-&gt;hw.st.sync
suffix:semicolon
multiline_comment|/* only set screen_base if really necessary */
r_if
c_cond
(paren
id|current_par.screen_base
op_ne
id|par-&gt;screen_base
)paren
id|fbhw
op_member_access_from_pointer
id|set_screen_base
c_func
(paren
id|par-&gt;screen_base
)paren
suffix:semicolon
)brace
DECL|function|stste_getcolreg
r_static
r_int
id|stste_getcolreg
c_func
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|col
comma
id|t
suffix:semicolon
r_if
c_cond
(paren
id|regno
OG
l_int|15
)paren
r_return
l_int|1
suffix:semicolon
id|col
op_assign
id|shifter_tt.color_reg
(braket
id|regno
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|EXTD_SHIFTER
)paren
)paren
(brace
id|t
op_assign
(paren
(paren
id|col
op_rshift
l_int|7
)paren
op_amp
l_int|0xe
)paren
op_or
(paren
(paren
id|col
op_rshift
l_int|11
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|t
op_or_assign
id|t
op_lshift
l_int|4
suffix:semicolon
op_star
id|red
op_assign
id|t
op_or
(paren
id|t
op_lshift
l_int|8
)paren
suffix:semicolon
id|t
op_assign
(paren
(paren
id|col
op_rshift
l_int|3
)paren
op_amp
l_int|0xe
)paren
op_or
(paren
(paren
id|col
op_rshift
l_int|7
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|t
op_or_assign
id|t
op_lshift
l_int|4
suffix:semicolon
op_star
id|green
op_assign
id|t
op_or
(paren
id|t
op_lshift
l_int|8
)paren
suffix:semicolon
id|t
op_assign
(paren
(paren
id|col
op_lshift
l_int|1
)paren
op_amp
l_int|0xe
)paren
op_or
(paren
(paren
id|col
op_rshift
l_int|3
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|t
op_or_assign
id|t
op_lshift
l_int|4
suffix:semicolon
op_star
id|blue
op_assign
id|t
op_or
(paren
id|t
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|t
op_assign
(paren
id|col
op_rshift
l_int|7
)paren
op_amp
l_int|0xe
suffix:semicolon
id|t
op_or_assign
id|t
op_lshift
l_int|4
suffix:semicolon
op_star
id|red
op_assign
id|t
op_or
(paren
id|t
op_lshift
l_int|8
)paren
suffix:semicolon
id|t
op_assign
(paren
id|col
op_rshift
l_int|3
)paren
op_amp
l_int|0xe
suffix:semicolon
id|t
op_or_assign
id|t
op_lshift
l_int|4
suffix:semicolon
op_star
id|green
op_assign
id|t
op_or
(paren
id|t
op_lshift
l_int|8
)paren
suffix:semicolon
id|t
op_assign
(paren
id|col
op_lshift
l_int|1
)paren
op_amp
l_int|0xe
suffix:semicolon
id|t
op_or_assign
id|t
op_lshift
l_int|4
suffix:semicolon
op_star
id|blue
op_assign
id|t
op_or
(paren
id|t
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stste_setcolreg
r_static
r_int
id|stste_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
OG
l_int|15
)paren
r_return
l_int|1
suffix:semicolon
id|red
op_rshift_assign
l_int|12
suffix:semicolon
id|blue
op_rshift_assign
l_int|12
suffix:semicolon
id|green
op_rshift_assign
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|EXTD_SHIFTER
)paren
)paren
id|shifter_tt.color_reg
(braket
id|regno
)braket
op_assign
(paren
(paren
(paren
id|red
op_amp
l_int|0xe
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|red
op_amp
l_int|1
)paren
op_lshift
l_int|3
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
(paren
id|green
op_amp
l_int|0xe
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|1
)paren
op_lshift
l_int|3
)paren
op_lshift
l_int|4
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xe
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|1
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
r_else
id|shifter_tt.color_reg
(braket
id|regno
)braket
op_assign
(paren
(paren
id|red
op_amp
l_int|0xe
)paren
op_lshift
l_int|7
)paren
op_or
(paren
(paren
id|green
op_amp
l_int|0xe
)paren
op_lshift
l_int|3
)paren
op_or
(paren
(paren
id|blue
op_amp
l_int|0xe
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stste_detect
r_static
r_int
id|stste_detect
c_func
(paren
r_void
)paren
(brace
r_struct
id|atafb_par
id|par
suffix:semicolon
multiline_comment|/* Determine the connected monitor: The DMA sound must be&n;&t; * disabled before reading the MFP GPIP, because the Sound&n;&t; * Done Signal and the Monochrome Detect are XORed together!&n;&t; */
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|PCM_8BIT
)paren
)paren
(brace
id|tt_dmasnd.ctrl
op_assign
id|DMASND_CTRL_OFF
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/* wait a while for things to settle down */
)brace
id|mono_moni
op_assign
(paren
id|mfp.par_dt_reg
op_amp
l_int|0x80
)paren
op_eq
l_int|0
suffix:semicolon
id|stste_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
id|stste_encode_var
c_func
(paren
op_amp
id|atafb_predefined
(braket
l_int|0
)braket
comma
op_amp
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ATARIHW_PRESENT
c_func
(paren
id|EXTD_SHIFTER
)paren
)paren
id|use_hwscroll
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|stste_set_screen_base
r_static
r_void
id|stste_set_screen_base
c_func
(paren
r_void
op_star
id|s_base
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
id|addr
op_assign
id|virt_to_phys
c_func
(paren
id|s_base
)paren
suffix:semicolon
multiline_comment|/* Setup Screen Memory */
id|shifter.bas_hi
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|addr
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|shifter.bas_md
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|addr
op_amp
l_int|0x00ff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|EXTD_SHIFTER
)paren
)paren
id|shifter.bas_lo
op_assign
(paren
r_int
r_char
)paren
(paren
id|addr
op_amp
l_int|0x0000ff
)paren
suffix:semicolon
)brace
macro_line|#endif /* ATAFB_STE */
multiline_comment|/* Switching the screen size should be done during vsync, otherwise&n; * the margins may get messed up. This is a well known problem of&n; * the ST&squot;s video system.&n; *&n; * Unfortunately there is hardly any way to find the vsync, as the&n; * vertical blank interrupt is no longer in time on machines with&n; * overscan type modifications.&n; *&n; * We can, however, use Timer B to safely detect the black shoulder,&n; * but then we&squot;ve got to guess an appropriate delay to find the vsync.&n; * This might not work on every machine.&n; *&n; * martin_rogge @ ki.maus.de, 8th Aug 1995&n; */
DECL|macro|LINE_DELAY
mdefine_line|#define LINE_DELAY  (mono_moni ? 30 : 70)
DECL|macro|SYNC_DELAY
mdefine_line|#define SYNC_DELAY  (mono_moni ? 1500 : 2000)
multiline_comment|/* SWITCH_ACIA may be used for Falcon (ScreenBlaster III internal!) */
DECL|function|st_ovsc_switch
r_static
r_void
id|st_ovsc_switch
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_register
r_int
r_char
id|old
comma
r_new
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_OVSC_MASK
)paren
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|mfp.tim_ct_b
op_assign
l_int|0x10
suffix:semicolon
id|mfp.active_edge
op_or_assign
l_int|8
suffix:semicolon
id|mfp.tim_ct_b
op_assign
l_int|0
suffix:semicolon
id|mfp.tim_dt_b
op_assign
l_int|0xf0
suffix:semicolon
id|mfp.tim_ct_b
op_assign
l_int|8
suffix:semicolon
r_while
c_loop
(paren
id|mfp.tim_dt_b
OG
l_int|1
)paren
multiline_comment|/* TOS does it this way, don&squot;t ask why */
suffix:semicolon
r_new
op_assign
id|mfp.tim_dt_b
suffix:semicolon
r_do
(brace
id|udelay
c_func
(paren
id|LINE_DELAY
)paren
suffix:semicolon
id|old
op_assign
r_new
suffix:semicolon
r_new
op_assign
id|mfp.tim_dt_b
suffix:semicolon
)brace
r_while
c_loop
(paren
id|old
op_ne
r_new
)paren
suffix:semicolon
id|mfp.tim_ct_b
op_assign
l_int|0x10
suffix:semicolon
id|udelay
c_func
(paren
id|SYNC_DELAY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_OVSC_IKBD
)paren
id|acia.key_ctrl
op_assign
id|ACIA_DIV64
op_or
id|ACIA_D8N1S
op_or
id|ACIA_RHTID
op_or
id|ACIA_RIE
suffix:semicolon
r_if
c_cond
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_OVSC_MIDI
)paren
id|acia.mid_ctrl
op_assign
id|ACIA_DIV16
op_or
id|ACIA_D8N1S
op_or
id|ACIA_RHTID
suffix:semicolon
r_if
c_cond
(paren
id|atari_switches
op_amp
(paren
id|ATARI_SWITCH_OVSC_SND6
op_or
id|ATARI_SWITCH_OVSC_SND7
)paren
)paren
(brace
id|sound_ym.rd_data_reg_sel
op_assign
l_int|14
suffix:semicolon
id|sound_ym.wd_data
op_assign
id|sound_ym.rd_data_reg_sel
op_or
(paren
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_OVSC_SND6
)paren
ques
c_cond
l_int|0x40
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|atari_switches
op_amp
id|ATARI_SWITCH_OVSC_SND7
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------- External Video ---------------------- */
macro_line|#ifdef ATAFB_EXT
DECL|function|ext_encode_fix
r_static
r_int
id|ext_encode_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
l_string|&quot;Unknown Extern&quot;
)paren
suffix:semicolon
id|fix-&gt;smem_start
op_assign
(paren
r_int
r_int
)paren
id|external_addr
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|PAGE_ALIGN
c_func
(paren
id|external_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|external_depth
op_eq
l_int|1
)paren
(brace
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
multiline_comment|/* The letters &squot;n&squot; and &squot;i&squot; in the &quot;atavideo=external:&quot; stand&n;&t;&t; * for &quot;normal&quot; and &quot;inverted&quot;, rsp., in the monochrome case */
id|fix-&gt;visual
op_assign
(paren
id|external_pmode
op_eq
id|FB_TYPE_INTERLEAVED_PLANES
op_logical_or
id|external_pmode
op_eq
id|FB_TYPE_PACKED_PIXELS
)paren
ques
c_cond
id|FB_VISUAL_MONO10
suffix:colon
id|FB_VISUAL_MONO01
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Use STATIC if we don&squot;t know how to access color registers */
r_int
id|visual
op_assign
id|external_vgaiobase
ques
c_cond
id|FB_VISUAL_PSEUDOCOLOR
suffix:colon
id|FB_VISUAL_STATIC_PSEUDOCOLOR
suffix:semicolon
r_switch
c_cond
(paren
id|external_pmode
)paren
(brace
r_case
op_minus
l_int|1
suffix:colon
multiline_comment|/* truecolor */
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_TYPE_PACKED_PIXELS
suffix:colon
id|fix-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|fix-&gt;visual
op_assign
id|visual
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_TYPE_PLANES
suffix:colon
id|fix-&gt;type
op_assign
id|FB_TYPE_PLANES
suffix:semicolon
id|fix-&gt;visual
op_assign
id|visual
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FB_TYPE_INTERLEAVED_PLANES
suffix:colon
id|fix-&gt;type
op_assign
id|FB_TYPE_INTERLEAVED_PLANES
suffix:semicolon
id|fix-&gt;type_aux
op_assign
l_int|2
suffix:semicolon
id|fix-&gt;visual
op_assign
id|visual
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|fix-&gt;xpanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;line_length
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ext_decode_var
r_static
r_int
id|ext_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_struct
id|fb_var_screeninfo
op_star
id|myvar
op_assign
op_amp
id|atafb_predefined
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|var-&gt;bits_per_pixel
OG
id|myvar-&gt;bits_per_pixel
op_logical_or
id|var-&gt;xres
OG
id|myvar-&gt;xres
op_logical_or
id|var-&gt;xres_virtual
OG
id|myvar-&gt;xres_virtual
op_logical_or
id|var-&gt;yres
OG
id|myvar-&gt;yres
op_logical_or
id|var-&gt;xoffset
OG
l_int|0
op_logical_or
id|var-&gt;yoffset
OG
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ext_encode_var
r_static
r_int
id|ext_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
id|memset
c_func
(paren
id|var
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_var_screeninfo
)paren
)paren
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.length
op_assign
(paren
id|external_pmode
op_eq
op_minus
l_int|1
)paren
ques
c_cond
id|external_depth
op_div
l_int|3
suffix:colon
(paren
id|external_vgaiobase
ques
c_cond
id|external_bitspercol
suffix:colon
l_int|0
)paren
suffix:semicolon
id|var-&gt;red.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;grayscale
op_assign
l_int|0
suffix:semicolon
id|var-&gt;pixclock
op_assign
l_int|31041
suffix:semicolon
id|var-&gt;left_margin
op_assign
l_int|120
suffix:semicolon
multiline_comment|/* these are surely incorrect &t;*/
id|var-&gt;right_margin
op_assign
l_int|100
suffix:semicolon
id|var-&gt;upper_margin
op_assign
l_int|8
suffix:semicolon
id|var-&gt;lower_margin
op_assign
l_int|16
suffix:semicolon
id|var-&gt;hsync_len
op_assign
l_int|140
suffix:semicolon
id|var-&gt;vsync_len
op_assign
l_int|30
suffix:semicolon
id|var-&gt;height
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;width
op_assign
op_minus
l_int|1
suffix:semicolon
id|var-&gt;sync
op_assign
l_int|0
suffix:semicolon
id|var-&gt;xres
op_assign
id|external_xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|external_yres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|external_xres_virtual
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
id|external_depth
suffix:semicolon
id|var-&gt;blue
op_assign
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.msb_right
op_assign
l_int|0
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|var-&gt;yres
suffix:semicolon
id|var-&gt;xoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;yoffset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;nonstd
op_assign
l_int|0
suffix:semicolon
id|var-&gt;activate
op_assign
l_int|0
suffix:semicolon
id|var-&gt;vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ext_get_par
r_static
r_void
id|ext_get_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
id|par-&gt;screen_base
op_assign
id|external_addr
suffix:semicolon
)brace
DECL|function|ext_set_par
r_static
r_void
id|ext_set_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
)brace
DECL|macro|OUTB
mdefine_line|#define OUTB(port,val) &bslash;&n;&t;*((unsigned volatile char *) ((port)+external_vgaiobase))=(val)
DECL|macro|INB
mdefine_line|#define INB(port) &bslash;&n;&t;(*((unsigned volatile char *) ((port)+external_vgaiobase)))
DECL|macro|DACDelay
mdefine_line|#define DACDelay &t;&t;&t;&t;&bslash;&n;&t;do {&t;&t;&t;&t;&t;&bslash;&n;&t;&t;unsigned char tmp=INB(0x3da);&t;&bslash;&n;&t;&t;tmp=INB(0x3da);&t;&t;&t;&bslash;&n;&t;} while (0)
DECL|function|ext_getcolreg
r_static
r_int
id|ext_getcolreg
c_func
(paren
r_int
id|regno
comma
r_int
op_star
id|red
comma
r_int
op_star
id|green
comma
r_int
op_star
id|blue
comma
r_int
op_star
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|external_vgaiobase
)paren
r_return
l_int|1
suffix:semicolon
op_star
id|red
op_assign
id|ext_color
(braket
id|regno
)braket
dot
id|red
suffix:semicolon
op_star
id|green
op_assign
id|ext_color
(braket
id|regno
)braket
dot
id|green
suffix:semicolon
op_star
id|blue
op_assign
id|ext_color
(braket
id|regno
)braket
dot
id|blue
suffix:semicolon
op_star
id|transp
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ext_setcolreg
r_static
r_int
id|ext_setcolreg
c_func
(paren
r_int
id|regno
comma
r_int
id|red
comma
r_int
id|green
comma
r_int
id|blue
comma
r_int
id|transp
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_char
id|colmask
op_assign
(paren
l_int|1
op_lshift
id|external_bitspercol
)paren
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|external_vgaiobase
)paren
r_return
l_int|1
suffix:semicolon
id|ext_color
(braket
id|regno
)braket
dot
id|red
op_assign
id|red
suffix:semicolon
id|ext_color
(braket
id|regno
)braket
dot
id|green
op_assign
id|green
suffix:semicolon
id|ext_color
(braket
id|regno
)braket
dot
id|blue
op_assign
id|blue
suffix:semicolon
r_switch
c_cond
(paren
id|external_card_type
)paren
(brace
r_case
id|IS_VGA
suffix:colon
id|OUTB
c_func
(paren
l_int|0x3c8
comma
id|regno
)paren
suffix:semicolon
id|DACDelay
suffix:semicolon
id|OUTB
c_func
(paren
l_int|0x3c9
comma
id|red
op_amp
id|colmask
)paren
suffix:semicolon
id|DACDelay
suffix:semicolon
id|OUTB
c_func
(paren
l_int|0x3c9
comma
id|green
op_amp
id|colmask
)paren
suffix:semicolon
id|DACDelay
suffix:semicolon
id|OUTB
c_func
(paren
l_int|0x3c9
comma
id|blue
op_amp
id|colmask
)paren
suffix:semicolon
id|DACDelay
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IS_MV300
suffix:colon
id|OUTB
c_func
(paren
(paren
id|MV300_reg
(braket
id|regno
)braket
op_lshift
l_int|2
)paren
op_plus
l_int|1
comma
id|red
)paren
suffix:semicolon
id|OUTB
c_func
(paren
(paren
id|MV300_reg
(braket
id|regno
)braket
op_lshift
l_int|2
)paren
op_plus
l_int|1
comma
id|green
)paren
suffix:semicolon
id|OUTB
c_func
(paren
(paren
id|MV300_reg
(braket
id|regno
)braket
op_lshift
l_int|2
)paren
op_plus
l_int|1
comma
id|blue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|ext_detect
r_static
r_int
id|ext_detect
c_func
(paren
r_void
)paren
(brace
r_struct
id|fb_var_screeninfo
op_star
id|myvar
op_assign
op_amp
id|atafb_predefined
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|atafb_par
id|dummy_par
suffix:semicolon
id|myvar-&gt;xres
op_assign
id|external_xres
suffix:semicolon
id|myvar-&gt;xres_virtual
op_assign
id|external_xres_virtual
suffix:semicolon
id|myvar-&gt;yres
op_assign
id|external_yres
suffix:semicolon
id|myvar-&gt;bits_per_pixel
op_assign
id|external_depth
suffix:semicolon
id|ext_encode_var
c_func
(paren
id|myvar
comma
op_amp
id|dummy_par
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* ATAFB_EXT */
multiline_comment|/* ------ This is the same for most hardware types -------- */
DECL|function|set_screen_base
r_static
r_void
id|set_screen_base
c_func
(paren
r_void
op_star
id|s_base
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
id|addr
op_assign
id|virt_to_phys
c_func
(paren
id|s_base
)paren
suffix:semicolon
multiline_comment|/* Setup Screen Memory */
id|shifter.bas_hi
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|addr
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|shifter.bas_md
op_assign
(paren
r_int
r_char
)paren
(paren
(paren
id|addr
op_amp
l_int|0x00ff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|shifter.bas_lo
op_assign
(paren
r_int
r_char
)paren
(paren
id|addr
op_amp
l_int|0x0000ff
)paren
suffix:semicolon
)brace
DECL|function|pan_display
r_static
r_int
id|pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fbhw-&gt;set_screen_base
op_logical_or
(paren
op_logical_neg
id|ATARIHW_PRESENT
c_func
(paren
id|EXTD_SHIFTER
)paren
op_logical_and
id|var-&gt;xoffset
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|var-&gt;xoffset
op_assign
id|up
c_func
(paren
id|var-&gt;xoffset
comma
l_int|16
)paren
suffix:semicolon
id|par-&gt;screen_base
op_assign
id|screen_base
op_plus
(paren
id|var-&gt;yoffset
op_star
id|fb_display
(braket
id|currcon
)braket
dot
id|var.xres_virtual
op_plus
id|var-&gt;xoffset
)paren
op_star
id|fb_display
(braket
id|currcon
)braket
dot
id|var.bits_per_pixel
op_div
l_int|8
suffix:semicolon
id|fbhw-&gt;set_screen_base
(paren
id|par-&gt;screen_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------ Interfaces to hardware functions ------------ */
macro_line|#ifdef ATAFB_TT
DECL|variable|tt_switch
r_static
r_struct
id|fb_hwswitch
id|tt_switch
op_assign
(brace
id|tt_detect
comma
id|tt_encode_fix
comma
id|tt_decode_var
comma
id|tt_encode_var
comma
id|tt_get_par
comma
id|tt_set_par
comma
id|tt_getcolreg
comma
id|tt_setcolreg
comma
id|set_screen_base
comma
l_int|NULL
comma
id|pan_display
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ATAFB_FALCON
DECL|variable|falcon_switch
r_static
r_struct
id|fb_hwswitch
id|falcon_switch
op_assign
(brace
id|falcon_detect
comma
id|falcon_encode_fix
comma
id|falcon_decode_var
comma
id|falcon_encode_var
comma
id|falcon_get_par
comma
id|falcon_set_par
comma
id|falcon_getcolreg
comma
id|falcon_setcolreg
comma
id|set_screen_base
comma
id|falcon_blank
comma
id|falcon_pan_display
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ATAFB_STE
DECL|variable|st_switch
r_static
r_struct
id|fb_hwswitch
id|st_switch
op_assign
(brace
id|stste_detect
comma
id|stste_encode_fix
comma
id|stste_decode_var
comma
id|stste_encode_var
comma
id|stste_get_par
comma
id|stste_set_par
comma
id|stste_getcolreg
comma
id|stste_setcolreg
comma
id|stste_set_screen_base
comma
l_int|NULL
comma
id|pan_display
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ATAFB_EXT
DECL|variable|ext_switch
r_static
r_struct
id|fb_hwswitch
id|ext_switch
op_assign
(brace
id|ext_detect
comma
id|ext_encode_fix
comma
id|ext_decode_var
comma
id|ext_encode_var
comma
id|ext_get_par
comma
id|ext_set_par
comma
id|ext_getcolreg
comma
id|ext_setcolreg
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#endif
DECL|function|atafb_get_par
r_static
r_void
id|atafb_get_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
r_if
c_cond
(paren
id|current_par_valid
)paren
(brace
op_star
id|par
op_assign
id|current_par
suffix:semicolon
)brace
r_else
id|fbhw
op_member_access_from_pointer
id|get_par
c_func
(paren
id|par
)paren
suffix:semicolon
)brace
DECL|function|atafb_set_par
r_static
r_void
id|atafb_set_par
c_func
(paren
r_struct
id|atafb_par
op_star
id|par
)paren
(brace
id|fbhw
op_member_access_from_pointer
id|set_par
c_func
(paren
id|par
)paren
suffix:semicolon
id|current_par
op_assign
op_star
id|par
suffix:semicolon
id|current_par_valid
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* =========================================================== */
multiline_comment|/* ============== Hardware Independent Functions ============= */
multiline_comment|/* =========================================================== */
multiline_comment|/* used for hardware scrolling */
r_static
r_int
DECL|function|fb_update_var
id|fb_update_var
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|off
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.yoffset
op_star
id|fb_display
(braket
id|con
)braket
dot
id|var.xres_virtual
op_star
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
op_rshift
l_int|3
suffix:semicolon
id|current_par.screen_base
op_assign
id|screen_base
op_plus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|fbhw-&gt;set_screen_base
)paren
id|fbhw
op_member_access_from_pointer
id|set_screen_base
c_func
(paren
id|current_par.screen_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|do_fb_set_var
id|do_fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|isactive
)paren
(brace
r_int
id|err
comma
id|activate
suffix:semicolon
r_struct
id|atafb_par
id|par
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fbhw
op_member_access_from_pointer
id|decode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
id|activate
op_assign
id|var-&gt;activate
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_NOW
)paren
op_logical_and
id|isactive
)paren
id|atafb_set_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
id|fbhw
op_member_access_from_pointer
id|encode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
suffix:semicolon
id|var-&gt;activate
op_assign
id|activate
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Functions for handling colormap */
r_static
r_void
DECL|function|do_install_cmap
id|do_install_cmap
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_ne
id|currcon
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_set_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
comma
id|fbhw-&gt;setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_set_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
l_int|1
comma
id|fbhw-&gt;setcolreg
comma
id|info
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|atafb_get_fix
id|atafb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|atafb_par
id|par
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
id|atafb_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
r_else
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fbhw
op_member_access_from_pointer
id|decode_var
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
op_amp
id|par
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
id|memset
c_func
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_fix_screeninfo
)paren
)paren
suffix:semicolon
r_return
id|fbhw
op_member_access_from_pointer
id|encode_fix
c_func
(paren
id|fix
comma
op_amp
id|par
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|atafb_get_var
id|atafb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|atafb_par
id|par
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
(brace
id|atafb_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
id|fbhw
op_member_access_from_pointer
id|encode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
suffix:semicolon
)brace
r_else
op_star
id|var
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|atafb_set_disp
id|atafb_set_disp
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|fb_fix_screeninfo
id|fix
suffix:semicolon
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
r_struct
id|display
op_star
id|display
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
id|display
op_assign
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
r_else
id|display
op_assign
op_amp
id|disp
suffix:semicolon
multiline_comment|/* used during initialization */
id|atafb_get_fix
c_func
(paren
op_amp
id|fix
comma
id|con
comma
id|info
)paren
suffix:semicolon
id|atafb_get_var
c_func
(paren
op_amp
id|var
comma
id|con
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
id|con
op_assign
l_int|0
suffix:semicolon
id|display-&gt;screen_base
op_assign
(paren
r_void
op_star
)paren
id|fix.smem_start
suffix:semicolon
id|display-&gt;visual
op_assign
id|fix.visual
suffix:semicolon
id|display-&gt;type
op_assign
id|fix.type
suffix:semicolon
id|display-&gt;type_aux
op_assign
id|fix.type_aux
suffix:semicolon
id|display-&gt;ypanstep
op_assign
id|fix.ypanstep
suffix:semicolon
id|display-&gt;ywrapstep
op_assign
id|fix.ywrapstep
suffix:semicolon
id|display-&gt;line_length
op_assign
id|fix.line_length
suffix:semicolon
r_if
c_cond
(paren
id|fix.visual
op_ne
id|FB_VISUAL_PSEUDOCOLOR
op_logical_and
id|fix.visual
op_ne
id|FB_VISUAL_DIRECTCOLOR
)paren
id|display-&gt;can_soft_blank
op_assign
l_int|0
suffix:semicolon
r_else
id|display-&gt;can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|display-&gt;inverse
op_assign
(paren
id|fix.visual
op_eq
id|FB_VISUAL_MONO01
ques
c_cond
op_logical_neg
id|inverse
suffix:colon
id|inverse
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fix.type
)paren
(brace
r_case
id|FB_TYPE_INTERLEAVED_PLANES
suffix:colon
r_switch
c_cond
(paren
id|var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_IPLAN2P2
r_case
l_int|2
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_iplan2p2
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_IPLAN2P4
r_case
l_int|4
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_iplan2p4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_IPLAN2P8
r_case
l_int|8
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_iplan2p8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
r_case
id|FB_TYPE_PACKED_PIXELS
suffix:colon
r_switch
c_cond
(paren
id|var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_MFB
r_case
l_int|1
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_mfb
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
id|display-&gt;dispsw_data
op_assign
id|fbcon_cfb16_cmap
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
r_break
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|atafb_set_var
id|atafb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
comma
id|oldxres
comma
id|oldyres
comma
id|oldbpp
comma
id|oldxres_virtual
comma
id|oldyres_virtual
comma
id|oldyoffset
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|do_fb_set_var
c_func
(paren
id|var
comma
id|con
op_eq
id|currcon
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_NOW
)paren
(brace
id|oldxres
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.xres
suffix:semicolon
id|oldyres
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.yres
suffix:semicolon
id|oldxres_virtual
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.xres_virtual
suffix:semicolon
id|oldyres_virtual
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.yres_virtual
suffix:semicolon
id|oldbpp
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
suffix:semicolon
id|oldyoffset
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var.yoffset
suffix:semicolon
id|fb_display
(braket
id|con
)braket
dot
id|var
op_assign
op_star
id|var
suffix:semicolon
r_if
c_cond
(paren
id|oldxres
op_ne
id|var-&gt;xres
op_logical_or
id|oldyres
op_ne
id|var-&gt;yres
op_logical_or
id|oldxres_virtual
op_ne
id|var-&gt;xres_virtual
op_logical_or
id|oldyres_virtual
op_ne
id|var-&gt;yres_virtual
op_logical_or
id|oldbpp
op_ne
id|var-&gt;bits_per_pixel
op_logical_or
id|oldyoffset
op_ne
id|var-&gt;yoffset
)paren
(brace
id|atafb_set_disp
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
(paren
op_star
id|fb_info.changevar
)paren
(paren
id|con
)paren
suffix:semicolon
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|do_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
)brace
)brace
id|var-&gt;activate
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|atafb_get_cmap
id|atafb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console ? */
r_return
id|fb_get_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|fbhw-&gt;getcolreg
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
multiline_comment|/* non default colormap ? */
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|atafb_set_cmap
id|atafb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
(brace
multiline_comment|/* no colormap allocated ? */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
l_int|1
op_lshift
id|fb_display
(braket
id|con
)braket
dot
id|var.bits_per_pixel
comma
l_int|0
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
multiline_comment|/* current console ? */
r_return
id|fb_set_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|fbhw-&gt;setcolreg
comma
id|info
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|atafb_pan_display
id|atafb_pan_display
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
r_int
id|yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|xoffset
template_param
id|fb_display
(braket
id|con
)braket
dot
id|var.xres_virtual
op_logical_or
id|yoffset
template_param
id|fb_display
(braket
id|con
)braket
dot
id|var.yres_virtual
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
id|currcon
)paren
(brace
r_if
c_cond
(paren
id|fbhw-&gt;pan_display
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|fbhw
op_member_access_from_pointer
id|pan_display
c_func
(paren
id|var
comma
op_amp
id|current_par
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|fb_display
(braket
id|con
)braket
dot
id|var.xoffset
op_assign
id|var-&gt;xoffset
suffix:semicolon
id|fb_display
(braket
id|con
)braket
dot
id|var.yoffset
op_assign
id|var-&gt;yoffset
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|atafb_ioctl
id|atafb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
macro_line|#ifdef FBCMD_GET_CURRENTPAR
r_case
id|FBCMD_GET_CURRENTPAR
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|current_par
comma
r_sizeof
(paren
r_struct
id|atafb_par
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCMD_SET_CURRENTPAR
r_case
id|FBCMD_SET_CURRENTPAR
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|current_par
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|atafb_par
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|atafb_set_par
c_func
(paren
op_amp
id|current_par
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|atafb_ops
r_static
r_struct
id|fb_ops
id|atafb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_get_fix
suffix:colon
id|atafb_get_fix
comma
id|fb_get_var
suffix:colon
id|atafb_get_var
comma
id|fb_set_var
suffix:colon
id|atafb_set_var
comma
id|fb_get_cmap
suffix:colon
id|atafb_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|atafb_set_cmap
comma
id|fb_pan_display
suffix:colon
id|atafb_pan_display
comma
id|fb_ioctl
suffix:colon
id|atafb_ioctl
comma
)brace
suffix:semicolon
r_static
r_void
DECL|function|check_default_par
id|check_default_par
c_func
(paren
r_int
id|detected_mode
)paren
(brace
r_char
id|default_name
(braket
l_int|10
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|fb_var_screeninfo
id|var
suffix:semicolon
r_int
r_int
id|min_mem
suffix:semicolon
multiline_comment|/* First try the user supplied mode */
r_if
c_cond
(paren
id|default_par
)paren
(brace
id|var
op_assign
id|atafb_predefined
(braket
id|default_par
op_minus
l_int|1
)braket
suffix:semicolon
id|var.activate
op_assign
id|FB_ACTIVATE_TEST
suffix:semicolon
r_if
c_cond
(paren
id|do_fb_set_var
c_func
(paren
op_amp
id|var
comma
l_int|1
)paren
)paren
id|default_par
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* failed */
)brace
multiline_comment|/* Next is the autodetected one */
r_if
c_cond
(paren
op_logical_neg
id|default_par
)paren
(brace
id|var
op_assign
id|atafb_predefined
(braket
id|detected_mode
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* autodetect */
id|var.activate
op_assign
id|FB_ACTIVATE_TEST
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|do_fb_set_var
c_func
(paren
op_amp
id|var
comma
l_int|1
)paren
)paren
id|default_par
op_assign
id|detected_mode
suffix:semicolon
)brace
multiline_comment|/* If that also failed, try some default modes... */
r_if
c_cond
(paren
op_logical_neg
id|default_par
)paren
(brace
multiline_comment|/* try default1, default2... */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|default_name
comma
l_string|&quot;default%d&quot;
comma
id|i
)paren
suffix:semicolon
id|default_par
op_assign
id|get_video_mode
c_func
(paren
id|default_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|default_par
)paren
id|panic
c_func
(paren
l_string|&quot;can&squot;t set default video mode&quot;
)paren
suffix:semicolon
id|var
op_assign
id|atafb_predefined
(braket
id|default_par
op_minus
l_int|1
)braket
suffix:semicolon
id|var.activate
op_assign
id|FB_ACTIVATE_TEST
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|do_fb_set_var
c_func
(paren
op_amp
id|var
comma
l_int|1
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* ok */
)brace
)brace
id|min_mem
op_assign
id|var.xres_virtual
op_star
id|var.yres_virtual
op_star
id|var.bits_per_pixel
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|default_mem_req
OL
id|min_mem
)paren
id|default_mem_req
op_assign
id|min_mem
suffix:semicolon
)brace
r_static
r_int
DECL|function|atafb_switch
id|atafb_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
multiline_comment|/* Do we have to save the colormap ? */
r_if
c_cond
(paren
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap.len
)paren
id|fb_get_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|currcon
)braket
dot
id|cmap
comma
l_int|1
comma
id|fbhw-&gt;getcolreg
comma
id|info
)paren
suffix:semicolon
id|do_fb_set_var
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
l_int|1
)paren
suffix:semicolon
id|currcon
op_assign
id|con
suffix:semicolon
multiline_comment|/* Install new colormap */
id|do_install_cmap
c_func
(paren
id|con
comma
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* (un)blank/poweroff&n; * 0 = unblank&n; * 1 = blank&n; * 2 = suspend vsync&n; * 3 = suspend hsync&n; * 4 = off&n; */
r_static
r_void
DECL|function|atafb_blank
id|atafb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
r_int
id|black
(braket
l_int|16
)braket
suffix:semicolon
r_struct
id|fb_cmap
id|cmap
suffix:semicolon
r_if
c_cond
(paren
id|fbhw-&gt;blank
op_logical_and
op_logical_neg
id|fbhw
op_member_access_from_pointer
id|blank
c_func
(paren
id|blank
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|blank
)paren
(brace
id|memset
c_func
(paren
id|black
comma
l_int|0
comma
l_int|16
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|cmap.red
op_assign
id|black
suffix:semicolon
id|cmap.green
op_assign
id|black
suffix:semicolon
id|cmap.blue
op_assign
id|black
suffix:semicolon
id|cmap.transp
op_assign
l_int|NULL
suffix:semicolon
id|cmap.start
op_assign
l_int|0
suffix:semicolon
id|cmap.len
op_assign
l_int|16
suffix:semicolon
id|fb_set_cmap
c_func
(paren
op_amp
id|cmap
comma
l_int|1
comma
id|fbhw-&gt;setcolreg
comma
id|info
)paren
suffix:semicolon
)brace
r_else
id|do_install_cmap
c_func
(paren
id|currcon
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|atafb_init
r_int
id|__init
id|atafb_init
c_func
(paren
r_void
)paren
(brace
r_int
id|pad
suffix:semicolon
r_int
id|detected_mode
suffix:semicolon
r_int
r_int
id|mem_req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_ATARI
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_do
(brace
macro_line|#ifdef ATAFB_EXT
r_if
c_cond
(paren
id|external_addr
)paren
(brace
id|fbhw
op_assign
op_amp
id|ext_switch
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef ATAFB_TT
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|TT_SHIFTER
)paren
)paren
(brace
id|fbhw
op_assign
op_amp
id|tt_switch
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef ATAFB_FALCON
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|VIDEL_SHIFTER
)paren
)paren
(brace
id|fbhw
op_assign
op_amp
id|falcon_switch
suffix:semicolon
id|request_irq
c_func
(paren
id|IRQ_AUTO_4
comma
id|falcon_vbl_switcher
comma
id|IRQ_TYPE_PRIO
comma
l_string|&quot;framebuffer/modeswitch&quot;
comma
id|falcon_vbl_switcher
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef ATAFB_STE
r_if
c_cond
(paren
id|ATARIHW_PRESENT
c_func
(paren
id|STND_SHIFTER
)paren
op_logical_or
id|ATARIHW_PRESENT
c_func
(paren
id|EXTD_SHIFTER
)paren
)paren
(brace
id|fbhw
op_assign
op_amp
id|st_switch
suffix:semicolon
r_break
suffix:semicolon
)brace
id|fbhw
op_assign
op_amp
id|st_switch
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cannot determine video hardware; defaulting to ST(e)&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else /* ATAFB_STE */
multiline_comment|/* no default driver included */
multiline_comment|/* Nobody will ever see this message :-) */
id|panic
c_func
(paren
l_string|&quot;Cannot initialize video hardware&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Multisync monitor capabilities */
multiline_comment|/* Atari-TOS defaults if no boot option present */
r_if
c_cond
(paren
id|fb_info.monspecs.hfmin
op_eq
l_int|0
)paren
(brace
id|fb_info.monspecs.hfmin
op_assign
l_int|31000
suffix:semicolon
id|fb_info.monspecs.hfmax
op_assign
l_int|32000
suffix:semicolon
id|fb_info.monspecs.vfmin
op_assign
l_int|58
suffix:semicolon
id|fb_info.monspecs.vfmax
op_assign
l_int|62
suffix:semicolon
)brace
id|detected_mode
op_assign
id|fbhw
op_member_access_from_pointer
id|detect
c_func
(paren
)paren
suffix:semicolon
id|check_default_par
c_func
(paren
id|detected_mode
)paren
suffix:semicolon
macro_line|#ifdef ATAFB_EXT
r_if
c_cond
(paren
op_logical_neg
id|external_addr
)paren
(brace
macro_line|#endif /* ATAFB_EXT */
id|mem_req
op_assign
id|default_mem_req
op_plus
id|ovsc_offset
op_plus
id|ovsc_addlen
suffix:semicolon
id|mem_req
op_assign
id|PAGE_ALIGN
c_func
(paren
id|mem_req
)paren
op_plus
id|PAGE_SIZE
suffix:semicolon
id|screen_base
op_assign
id|atari_stram_alloc
c_func
(paren
id|mem_req
comma
l_string|&quot;atafb&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|screen_base
)paren
id|panic
c_func
(paren
l_string|&quot;Cannot allocate screen memory&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|screen_base
comma
l_int|0
comma
id|mem_req
)paren
suffix:semicolon
id|pad
op_assign
op_minus
(paren
r_int
r_int
)paren
id|screen_base
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|screen_base
op_add_assign
id|pad
suffix:semicolon
id|real_screen_base
op_assign
id|screen_base
op_plus
id|ovsc_offset
suffix:semicolon
id|screen_len
op_assign
(paren
id|mem_req
op_minus
id|pad
op_minus
id|ovsc_offset
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|st_ovsc_switch
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CPU_IS_040_OR_060
)paren
(brace
multiline_comment|/* On a &squot;040+, the cache mode of video RAM must be set to&n;&t;&t;&t; * write-through also for internal video hardware! */
id|cache_push
c_func
(paren
id|virt_to_phys
c_func
(paren
id|screen_base
)paren
comma
id|screen_len
)paren
suffix:semicolon
id|kernel_set_cachemode
c_func
(paren
id|screen_base
comma
id|screen_len
comma
id|IOMAP_WRITETHROUGH
)paren
suffix:semicolon
)brace
macro_line|#ifdef ATAFB_EXT
)brace
r_else
(brace
multiline_comment|/* Map the video memory (physical address given) to somewhere&n;&t;&t; * in the kernel address space.&n;&t;&t; */
id|external_addr
op_assign
id|ioremap_writethrough
c_func
(paren
(paren
r_int
r_int
)paren
id|external_addr
comma
id|external_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|external_vgaiobase
)paren
id|external_vgaiobase
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|external_vgaiobase
comma
l_int|0x10000
)paren
suffix:semicolon
id|screen_base
op_assign
id|real_screen_base
op_assign
id|external_addr
suffix:semicolon
id|screen_len
op_assign
id|external_len
op_amp
id|PAGE_MASK
suffix:semicolon
id|memset
(paren
id|screen_base
comma
l_int|0
comma
id|external_len
)paren
suffix:semicolon
)brace
macro_line|#endif /* ATAFB_EXT */
id|strcpy
c_func
(paren
id|fb_info.modename
comma
l_string|&quot;Atari Builtin &quot;
)paren
suffix:semicolon
id|fb_info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|atafb_ops
suffix:semicolon
id|fb_info.disp
op_assign
op_amp
id|disp
suffix:semicolon
id|fb_info.switch_con
op_assign
op_amp
id|atafb_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
op_amp
id|fb_update_var
suffix:semicolon
id|fb_info.blank
op_assign
op_amp
id|atafb_blank
suffix:semicolon
id|fb_info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|do_fb_set_var
c_func
(paren
op_amp
id|atafb_predefined
(braket
id|default_par
op_minus
l_int|1
)braket
comma
l_int|1
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|fb_info.modename
comma
id|fb_var_names
(braket
id|default_par
op_minus
l_int|1
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|atafb_get_var
c_func
(paren
op_amp
id|disp.var
comma
op_minus
l_int|1
comma
op_amp
id|fb_info
)paren
suffix:semicolon
id|atafb_set_disp
c_func
(paren
op_minus
l_int|1
comma
op_amp
id|fb_info
)paren
suffix:semicolon
id|do_install_cmap
c_func
(paren
l_int|0
comma
op_amp
id|fb_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Determined %dx%d, depth %d&bslash;n&quot;
comma
id|disp.var.xres
comma
id|disp.var.yres
comma
id|disp.var.bits_per_pixel
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|disp.var.xres
op_ne
id|disp.var.xres_virtual
)paren
op_logical_or
(paren
id|disp.var.yres
op_ne
id|disp.var.yres_virtual
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;   virtual %dx%d&bslash;n&quot;
comma
id|disp.var.xres_virtual
comma
id|disp.var.yres_virtual
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;fb%d: %s frame buffer device, using %dK of video memory&bslash;n&quot;
comma
id|GET_FB_IDX
c_func
(paren
id|fb_info.node
)paren
comma
id|fb_info.modename
comma
id|screen_len
op_rshift
l_int|10
)paren
suffix:semicolon
multiline_comment|/* TODO: This driver cannot be unloaded yet */
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* a strtok which returns empty strings, too */
DECL|function|strtoke
r_static
r_char
op_star
id|strtoke
c_func
(paren
r_char
op_star
id|s
comma
r_const
r_char
op_star
id|ct
)paren
(brace
r_char
op_star
id|sbegin
comma
op_star
id|send
suffix:semicolon
r_static
r_char
op_star
id|ssave
op_assign
l_int|NULL
suffix:semicolon
id|sbegin
op_assign
id|s
ques
c_cond
id|s
suffix:colon
id|ssave
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbegin
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|sbegin
op_eq
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|ssave
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|send
op_assign
id|strpbrk
c_func
(paren
id|sbegin
comma
id|ct
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send
op_logical_and
op_star
id|send
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_star
id|send
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|ssave
op_assign
id|send
suffix:semicolon
r_return
id|sbegin
suffix:semicolon
)brace
DECL|function|atafb_setup
r_int
id|__init
id|atafb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_int
id|temp
suffix:semicolon
r_char
id|ext_str
(braket
l_int|80
)braket
comma
id|int_str
(braket
l_int|100
)braket
suffix:semicolon
r_char
id|mcap_spec
(braket
l_int|80
)braket
suffix:semicolon
r_char
id|user_mode
(braket
l_int|80
)braket
suffix:semicolon
id|ext_str
(braket
l_int|0
)braket
op_assign
id|int_str
(braket
l_int|0
)braket
op_assign
id|mcap_spec
(braket
l_int|0
)braket
op_assign
id|user_mode
(braket
l_int|0
)braket
op_assign
id|fb_info.fontname
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|this_opt
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_opt
suffix:semicolon
id|this_opt
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|this_opt
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_assign
id|get_video_mode
c_func
(paren
id|this_opt
)paren
)paren
)paren
id|default_par
op_assign
id|temp
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;inverse&quot;
)paren
)paren
id|inverse
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;font:&quot;
comma
l_int|5
)paren
)paren
id|strcpy
c_func
(paren
id|fb_info.fontname
comma
id|this_opt
op_plus
l_int|5
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;hwscroll_&quot;
comma
l_int|9
)paren
)paren
(brace
id|hwscroll
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|9
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hwscroll
OL
l_int|0
)paren
id|hwscroll
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hwscroll
OG
l_int|200
)paren
id|hwscroll
op_assign
l_int|200
suffix:semicolon
)brace
macro_line|#ifdef ATAFB_EXT
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;mv300&quot;
)paren
)paren
(brace
id|external_bitspercol
op_assign
l_int|8
suffix:semicolon
id|external_card_type
op_assign
id|IS_MV300
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;external:&quot;
comma
l_int|9
)paren
)paren
id|strcpy
c_func
(paren
id|ext_str
comma
id|this_opt
op_plus
l_int|9
)paren
suffix:semicolon
macro_line|#endif
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;internal:&quot;
comma
l_int|9
)paren
)paren
id|strcpy
c_func
(paren
id|int_str
comma
id|this_opt
op_plus
l_int|9
)paren
suffix:semicolon
macro_line|#ifdef ATAFB_FALCON
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;eclock:&quot;
comma
l_int|7
)paren
)paren
(brace
id|fext.f
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|7
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
multiline_comment|/* external pixelclock in kHz --&gt; ps */
id|fext.t
op_assign
l_int|1000000000
op_div
id|fext.f
suffix:semicolon
id|fext.f
op_mul_assign
l_int|1000
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;monitorcap:&quot;
comma
l_int|11
)paren
)paren
id|strcpy
c_func
(paren
id|mcap_spec
comma
id|this_opt
op_plus
l_int|11
)paren
suffix:semicolon
macro_line|#endif
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_opt
comma
l_string|&quot;keep&quot;
)paren
)paren
id|DontCalcRes
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;R&quot;
comma
l_int|1
)paren
)paren
id|strcpy
c_func
(paren
id|user_mode
comma
id|this_opt
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|int_str
)paren
(brace
multiline_comment|/* Format to config extended internal video hardware like OverScan:&n;&t;&quot;internal:&lt;xres&gt;;&lt;yres&gt;;&lt;xres_max&gt;;&lt;yres_max&gt;;&lt;offset&gt;&quot;&n;&t;Explanation:&n;&t;&lt;xres&gt;: x-resolution &n;&t;&lt;yres&gt;: y-resolution&n;&t;The following are only needed if you have an overscan which&n;&t;needs a black border:&n;&t;&lt;xres_max&gt;: max. length of a line in pixels your OverScan hardware would allow&n;&t;&lt;yres_max&gt;: max. number of lines your OverScan hardware would allow&n;&t;&lt;offset&gt;: Offset from physical beginning to visible beginning&n;&t;&t;  of screen in bytes&n;&t;*/
r_int
id|xres
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
id|int_str
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|int_invalid
suffix:semicolon
id|xres
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|int_invalid
suffix:semicolon
id|sttt_xres
op_assign
id|xres
suffix:semicolon
id|tt_yres
op_assign
id|st_yres
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_and
op_star
id|p
)paren
(brace
id|sttt_xres_virtual
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_and
op_star
id|p
)paren
(brace
id|sttt_yres_virtual
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_and
op_star
id|p
)paren
(brace
id|ovsc_offset
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ovsc_offset
op_logical_or
(paren
id|sttt_yres_virtual
op_ne
id|st_yres
)paren
)paren
id|use_hwscroll
op_assign
l_int|0
suffix:semicolon
id|int_invalid
suffix:colon
suffix:semicolon
)brace
macro_line|#ifdef ATAFB_EXT
r_if
c_cond
(paren
op_star
id|ext_str
)paren
(brace
r_int
id|xres
comma
id|xres_virtual
comma
id|yres
comma
id|depth
comma
id|planes
suffix:semicolon
r_int
r_int
id|addr
comma
id|len
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
multiline_comment|/* Format is: &lt;xres&gt;;&lt;yres&gt;;&lt;depth&gt;;&lt;plane organ.&gt;;&n;&t; *            &lt;screen mem addr&gt;&n;&t; *&t;      [;&lt;screen mem length&gt;[;&lt;vgaiobase&gt;[;&lt;bits-per-col&gt;[;&lt;colorreg-type&gt;&n;&t; *&t;      [;&lt;xres-virtual&gt;]]]]]&n;&t; *&n;&t; * 09/23/97&t;Juergen&n;&t; * &lt;xres_virtual&gt;:&t;hardware&squot;s x-resolution (f.e. ProMST)&n;&t; *&n;&t; * Even xres_virtual is available, we neither support panning nor hw-scrolling!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
id|ext_str
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|ext_invalid
suffix:semicolon
id|xres_virtual
op_assign
id|xres
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xres
op_le
l_int|0
)paren
r_goto
id|ext_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|ext_invalid
suffix:semicolon
id|yres
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|yres
op_le
l_int|0
)paren
r_goto
id|ext_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|ext_invalid
suffix:semicolon
id|depth
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|depth
op_ne
l_int|1
op_logical_and
id|depth
op_ne
l_int|2
op_logical_and
id|depth
op_ne
l_int|4
op_logical_and
id|depth
op_ne
l_int|8
op_logical_and
id|depth
op_ne
l_int|16
op_logical_and
id|depth
op_ne
l_int|24
)paren
r_goto
id|ext_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|ext_invalid
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;i&squot;
)paren
id|planes
op_assign
id|FB_TYPE_INTERLEAVED_PLANES
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;p&squot;
)paren
id|planes
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;n&squot;
)paren
id|planes
op_assign
id|FB_TYPE_PLANES
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|p
op_eq
l_char|&squot;t&squot;
)paren
id|planes
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* true color */
r_else
r_goto
id|ext_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|ext_invalid
suffix:semicolon
id|addr
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
id|len
op_assign
id|xres
op_star
id|yres
op_star
id|depth
op_div
l_int|8
suffix:semicolon
r_else
id|len
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_and
op_star
id|p
)paren
(brace
id|external_vgaiobase
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_and
op_star
id|p
)paren
(brace
id|external_bitspercol
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|external_bitspercol
OG
l_int|8
)paren
id|external_bitspercol
op_assign
l_int|8
suffix:semicolon
r_else
r_if
c_cond
(paren
id|external_bitspercol
OL
l_int|1
)paren
id|external_bitspercol
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_and
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;vga&quot;
)paren
)paren
id|external_card_type
op_assign
id|IS_VGA
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|p
comma
l_string|&quot;mv300&quot;
)paren
)paren
id|external_card_type
op_assign
id|IS_MV300
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_and
op_star
id|p
)paren
(brace
id|xres_virtual
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xres_virtual
OL
id|xres
)paren
id|xres_virtual
op_assign
id|xres
suffix:semicolon
r_if
c_cond
(paren
id|xres_virtual
op_star
id|yres
op_star
id|depth
op_div
l_int|8
OG
id|len
)paren
id|len
op_assign
id|xres_virtual
op_star
id|yres
op_star
id|depth
op_div
l_int|8
suffix:semicolon
)brace
id|external_xres
op_assign
id|xres
suffix:semicolon
id|external_xres_virtual
op_assign
id|xres_virtual
suffix:semicolon
id|external_yres
op_assign
id|yres
suffix:semicolon
id|external_depth
op_assign
id|depth
suffix:semicolon
id|external_pmode
op_assign
id|planes
suffix:semicolon
id|external_addr
op_assign
(paren
r_void
op_star
)paren
id|addr
suffix:semicolon
id|external_len
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|external_card_type
op_eq
id|IS_MV300
)paren
r_switch
c_cond
(paren
id|external_depth
)paren
(brace
r_case
l_int|1
suffix:colon
id|MV300_reg
op_assign
id|MV300_reg_1bit
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|MV300_reg
op_assign
id|MV300_reg_4bit
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|MV300_reg
op_assign
id|MV300_reg_8bit
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ext_invalid
suffix:colon
suffix:semicolon
)brace
macro_line|#endif /* ATAFB_EXT */
macro_line|#ifdef ATAFB_FALCON
r_if
c_cond
(paren
op_star
id|mcap_spec
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|vmin
comma
id|vmax
comma
id|hmin
comma
id|hmax
suffix:semicolon
multiline_comment|/* Format for monitor capabilities is: &lt;Vmin&gt;;&lt;Vmax&gt;;&lt;Hmin&gt;;&lt;Hmax&gt;&n;&t; * &lt;V*&gt; vertical freq. in Hz&n;&t; * &lt;H*&gt; horizontal freq. in kHz&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
id|mcap_spec
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|vmin
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vmin
op_le
l_int|0
)paren
r_goto
id|cap_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|vmax
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vmax
op_le
l_int|0
op_logical_or
id|vmax
op_le
id|vmin
)paren
r_goto
id|cap_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|hmin
op_assign
l_int|1000
op_star
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hmin
op_le
l_int|0
)paren
r_goto
id|cap_invalid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|hmax
op_assign
l_int|1000
op_star
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hmax
op_le
l_int|0
op_logical_or
id|hmax
op_le
id|hmin
)paren
r_goto
id|cap_invalid
suffix:semicolon
id|fb_info.monspecs.vfmin
op_assign
id|vmin
suffix:semicolon
id|fb_info.monspecs.vfmax
op_assign
id|vmax
suffix:semicolon
id|fb_info.monspecs.hfmin
op_assign
id|hmin
suffix:semicolon
id|fb_info.monspecs.hfmax
op_assign
id|hmax
suffix:semicolon
id|cap_invalid
suffix:colon
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_star
id|user_mode
)paren
(brace
multiline_comment|/* Format of user defined video mode is: &lt;xres&gt;;&lt;yres&gt;;&lt;depth&gt;&n;&t;&t; */
r_char
op_star
id|p
suffix:semicolon
r_int
id|xres
comma
id|yres
comma
id|depth
comma
id|temp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
id|user_mode
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|user_invalid
suffix:semicolon
id|xres
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|user_invalid
suffix:semicolon
id|yres
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|p
op_assign
id|strtoke
c_func
(paren
l_int|NULL
comma
l_string|&quot;&quot;
)paren
)paren
op_logical_or
op_logical_neg
op_star
id|p
)paren
r_goto
id|user_invalid
suffix:semicolon
id|depth
op_assign
id|simple_strtoul
c_func
(paren
id|p
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_assign
id|get_video_mode
c_func
(paren
l_string|&quot;user0&quot;
)paren
)paren
)paren
(brace
id|default_par
op_assign
id|temp
suffix:semicolon
id|atafb_predefined
(braket
id|default_par
op_minus
l_int|1
)braket
dot
id|xres
op_assign
id|xres
suffix:semicolon
id|atafb_predefined
(braket
id|default_par
op_minus
l_int|1
)braket
dot
id|yres
op_assign
id|yres
suffix:semicolon
id|atafb_predefined
(braket
id|default_par
op_minus
l_int|1
)braket
dot
id|bits_per_pixel
op_assign
id|depth
suffix:semicolon
)brace
id|user_invalid
suffix:colon
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|atafb_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Not reached because the usecount will never&n;&t;   be decremented to zero */
id|unregister_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
suffix:semicolon
multiline_comment|/* atari_stram_free( screen_base ); */
multiline_comment|/* TODO: further clean up ... */
)brace
macro_line|#endif /* MODULE */
eof
