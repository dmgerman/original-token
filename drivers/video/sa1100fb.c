multiline_comment|/*&n; * linux/drivers/video/sa1100fb.c -- StrongARM 1100 LCD Controller Frame Buffer Device&n; *&n; *  Copyright (C) 1999 Eric A. Thomas&n; *  &n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file COPYING in the main directory of this archive&n; * for more details.&n; *&n; */
multiline_comment|/*&n; *   Code Status:&n; * 1999/04/01:&n; * &t;Driver appears to be working for Brutus 320x200x8bpp mode.  Other&n; * &t;resolutions are working, but only the 8bpp mode is supported.&n; * &t;Changes need to be made to the palette encode and decode routines&n; * &t;to support 4 and 16 bpp modes.  &n; * &t;Driver is not designed to be a module.  The FrameBuffer is statically&n; * &t;allocated since dynamic allocation of a 300k buffer cannot be &n; * &t;guaranteed. &n; * &n; * 1999/06/17:&n; * &t;FrameBuffer memory is now allocated at run-time when the&n; * &t;driver is initialized.    &n; *&n; * 2000/04/10:&n; * &t;Big cleanup for dynamic selection of machine type at run time.&n; * &t;&t;Nicolas Pitre &lt;nico@cam.org&gt;&n; * &n; * 2000/07/19:&n; * &t;Support for Bitsy aka Compaq iPAQ H3600 added.&n; * &t;&t;Jamey Hicks &lt;jamey@crl.dec.com&gt;&n; * &n; * 2000/08/07:&n; * &t;Resolved an issue caused by a change made to the Assabet&squot;s PLD &n; * &t;earlier this year which broke the framebuffer driver for newer &n; * &t;Phase 4 Assabets.  Some other parameters were changed to optimize for&n; * &t;the Sharp display.&n; * &t;&t;Tak-Shing Chan &lt;tchan.rd@idthk.com&gt;&n; * &t;&t;Jeff Sutherland &lt;jsutherland@accelent.com&gt;&n; * &n; * 2000/08/09:&n; * &t;XP860 support added&n; * &t;&t;Kunihiko IMAI &lt;imai@vasara.co.jp&gt;&n; *&n; * 2000/08/19:&n; * &t;Allows standard options to be passed on the kernel command line&n; * &t;for most common passive displays.&n; * &t;&t;Mark Huang &lt;mhuang@livetoy.com&gt;&n; *&n; * 2000/08/29:&n; *&t;s/save_flags_cli/local_irq_save/&n; *      remove unneeded extra save_flags_cli in&n; *       sa1100fb_enable_lcd_controller&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/mach-types.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/proc/pgtable.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/fbcon-mfb.h&gt;
macro_line|#include &lt;video/fbcon-cfb4.h&gt;
macro_line|#include &lt;video/fbcon-cfb8.h&gt;
macro_line|#include &lt;video/fbcon-cfb16.h&gt;
multiline_comment|/*&n; *  Debug macros &n; */
singleline_comment|//#define DEBUG 
macro_line|#ifdef DEBUG
DECL|macro|DPRINTK
macro_line|#  define DPRINTK(fmt, args...)&t;printk(&quot;%s: &quot; fmt, __FUNCTION__ , ## args)
macro_line|#else
DECL|macro|DPRINTK
macro_line|#  define DPRINTK(fmt, args...)
macro_line|#endif
multiline_comment|/* Memory size macros for determining required FrameBuffer size */
DECL|macro|MAX_PALETTE_NUM_ENTRIES
mdefine_line|#define MAX_PALETTE_NUM_ENTRIES&t;&t;256
DECL|macro|MAX_PALETTE_MEM_SIZE
mdefine_line|#define MAX_PALETTE_MEM_SIZE&t;&t;(MAX_PALETTE_NUM_ENTRIES * 2)
DECL|macro|MAX_PIXEL_MEM_SIZE
mdefine_line|#define MAX_PIXEL_MEM_SIZE &bslash;&n;&t;((current_par.max_xres * current_par.max_yres * current_par.max_bpp)/8)
DECL|macro|MAX_FRAMEBUFFER_MEM_SIZE
mdefine_line|#define MAX_FRAMEBUFFER_MEM_SIZE &bslash;&n;&t;(MAX_PIXEL_MEM_SIZE + MAX_PALETTE_MEM_SIZE + 32)
DECL|macro|ALLOCATED_FB_MEM_SIZE
mdefine_line|#define ALLOCATED_FB_MEM_SIZE &bslash;&n;&t;(PAGE_ALIGN(MAX_FRAMEBUFFER_MEM_SIZE + PAGE_SIZE * 2))
DECL|macro|SA1100_PALETTE_MEM_SIZE
mdefine_line|#define SA1100_PALETTE_MEM_SIZE(bpp)&t;(((bpp)==8?256:16)*2)
DECL|macro|SA1100_PALETTE_MODE_VAL
mdefine_line|#define SA1100_PALETTE_MODE_VAL(bpp)    (((bpp) &amp; 0x018) &lt;&lt; 9)
multiline_comment|/* Minimum X and Y resolutions */
DECL|macro|MIN_XRES
mdefine_line|#define MIN_XRES&t;64
DECL|macro|MIN_YRES
mdefine_line|#define MIN_YRES&t;64
multiline_comment|/* Possible controller_state modes */
DECL|macro|LCD_MODE_DISABLED
mdefine_line|#define LCD_MODE_DISABLED&t;&t;0    
singleline_comment|// Controller is disabled and Disable Done received
DECL|macro|LCD_MODE_DISABLE_BEFORE_ENABLE
mdefine_line|#define LCD_MODE_DISABLE_BEFORE_ENABLE&t;1    
singleline_comment|// Re-enable after Disable Done IRQ is received
DECL|macro|LCD_MODE_ENABLED
mdefine_line|#define LCD_MODE_ENABLED&t;&t;2    
singleline_comment|// Controller is enabled
DECL|macro|SA1100_NAME
mdefine_line|#define SA1100_NAME&t;&quot;SA1100&quot;
DECL|macro|NR_MONTYPES
mdefine_line|#define NR_MONTYPES&t;1
r_static
r_inline
r_void
DECL|function|sa1100fb_assabet_set_truecolor
id|sa1100fb_assabet_set_truecolor
c_func
(paren
id|u_int
id|is_true_color
)paren
(brace
macro_line|#ifdef CONFIG_SA1100_ASSABET
macro_line|#if 1
singleline_comment|// phase 4 or newer Assabet&squot;s
r_if
c_cond
(paren
id|is_true_color
)paren
id|BCR_set
c_func
(paren
id|BCR_LCD_12RGB
)paren
suffix:semicolon
r_else
id|BCR_clear
c_func
(paren
id|BCR_LCD_12RGB
)paren
suffix:semicolon
macro_line|#else
singleline_comment|// older Assabet&squot;s
r_if
c_cond
(paren
id|is_true_color
)paren
id|BCR_clear
c_func
(paren
id|BCR_LCD_12RGB
)paren
suffix:semicolon
r_else
id|BCR_set
c_func
(paren
id|BCR_LCD_12RGB
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
)brace
DECL|variable|VideoMemRegion
r_static
id|u_char
op_star
id|VideoMemRegion
suffix:semicolon
DECL|variable|VideoMemRegion_phys
r_static
id|u_char
op_star
id|VideoMemRegion_phys
suffix:semicolon
multiline_comment|/* Local LCD controller parameters */
multiline_comment|/* These can be reduced by making better use of fb_var_screeninfo parameters.  */
multiline_comment|/* Several duplicates exist in the two structures. */
DECL|struct|sa1100fb_par
r_struct
id|sa1100fb_par
(brace
DECL|member|p_screen_base
id|u_char
op_star
id|p_screen_base
suffix:semicolon
DECL|member|v_screen_base
id|u_char
op_star
id|v_screen_base
suffix:semicolon
DECL|member|p_palette_base
id|u_short
op_star
id|p_palette_base
suffix:semicolon
DECL|member|v_palette_base
id|u_short
op_star
id|v_palette_base
suffix:semicolon
DECL|member|screen_size
r_int
r_int
id|screen_size
suffix:semicolon
DECL|member|palette_size
r_int
r_int
id|palette_size
suffix:semicolon
DECL|member|max_xres
r_int
r_int
id|max_xres
suffix:semicolon
DECL|member|max_yres
r_int
r_int
id|max_yres
suffix:semicolon
DECL|member|xres
r_int
r_int
id|xres
suffix:semicolon
DECL|member|yres
r_int
r_int
id|yres
suffix:semicolon
DECL|member|xres_virtual
r_int
r_int
id|xres_virtual
suffix:semicolon
DECL|member|yres_virtual
r_int
r_int
id|yres_virtual
suffix:semicolon
DECL|member|max_bpp
r_int
r_int
id|max_bpp
suffix:semicolon
DECL|member|bits_per_pixel
r_int
r_int
id|bits_per_pixel
suffix:semicolon
DECL|member|montype
r_int
r_int
id|montype
suffix:semicolon
DECL|member|currcon
r_int
r_int
id|currcon
suffix:semicolon
DECL|member|visual
r_int
r_int
id|visual
suffix:semicolon
DECL|member|allow_modeset
r_int
r_int
id|allow_modeset
suffix:colon
l_int|1
suffix:semicolon
DECL|member|active_lcd
r_int
r_int
id|active_lcd
suffix:colon
l_int|1
suffix:semicolon
DECL|member|inv_4bpp
r_int
r_int
id|inv_4bpp
suffix:colon
l_int|1
suffix:semicolon
DECL|member|controller_state
r_volatile
id|u_char
id|controller_state
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Shadows for LCD controller registers */
DECL|struct|sa1100fb_lcd_reg
r_struct
id|sa1100fb_lcd_reg
(brace
DECL|member|dbar1
id|Address
id|dbar1
suffix:semicolon
DECL|member|dbar2
id|Address
id|dbar2
suffix:semicolon
DECL|member|lccr0
id|Word
id|lccr0
suffix:semicolon
DECL|member|lccr1
id|Word
id|lccr1
suffix:semicolon
DECL|member|lccr2
id|Word
id|lccr2
suffix:semicolon
DECL|member|lccr3
id|Word
id|lccr3
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Fake monspecs to fill in fbinfo structure */
DECL|variable|__initdata
r_static
r_struct
id|fb_monspecs
id|monspecs
id|__initdata
op_assign
(brace
l_int|30000
comma
l_int|70000
comma
l_int|50
comma
l_int|65
comma
l_int|0
multiline_comment|/* Generic */
)brace
suffix:semicolon
DECL|variable|global_disp
r_static
r_struct
id|display
id|global_disp
suffix:semicolon
multiline_comment|/* Initial (default) Display Settings */
DECL|variable|fb_info
r_static
r_struct
id|fb_info
id|fb_info
suffix:semicolon
DECL|variable|current_par
r_static
r_struct
id|sa1100fb_par
id|current_par
suffix:semicolon
DECL|variable|init_var
r_static
r_struct
id|fb_var_screeninfo
id|__initdata
id|init_var
op_assign
(brace
)brace
suffix:semicolon
DECL|variable|lcd_shadow
r_static
r_struct
id|sa1100fb_lcd_reg
id|lcd_shadow
suffix:semicolon
r_static
r_int
id|sa1100fb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sa1100fb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sa1100fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sa1100fb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sa1100fb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sa1100fb_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|sa1100fb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|sa1100fb_map_video_memory
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|sa1100fb_activate_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
suffix:semicolon
r_static
r_void
id|sa1100fb_enable_lcd_controller
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|sa1100fb_disable_lcd_controller
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|sa1100fb_ops
r_static
r_struct
id|fb_ops
id|sa1100fb_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|fb_get_fix
suffix:colon
id|sa1100fb_get_fix
comma
id|fb_get_var
suffix:colon
id|sa1100fb_get_var
comma
id|fb_set_var
suffix:colon
id|sa1100fb_set_var
comma
id|fb_get_cmap
suffix:colon
id|sa1100fb_get_cmap
comma
id|fb_set_cmap
suffix:colon
id|sa1100fb_set_cmap
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * sa1100fb_palette_write:&n; *    Write palette data to the LCD frame buffer&squot;s palette area&n; */
r_static
r_inline
r_void
DECL|function|sa1100fb_palette_write
id|sa1100fb_palette_write
c_func
(paren
id|u_int
id|regno
comma
id|u_short
id|pal
)paren
(brace
id|current_par.v_palette_base
(braket
id|regno
)braket
op_assign
(paren
id|regno
ques
c_cond
id|pal
suffix:colon
id|pal
op_or
id|SA1100_PALETTE_MODE_VAL
c_func
(paren
id|current_par.bits_per_pixel
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
id|u_short
DECL|function|sa1100fb_palette_encode
id|sa1100fb_palette_encode
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|trans
)paren
(brace
id|u_int
id|pal
suffix:semicolon
r_if
c_cond
(paren
id|current_par.bits_per_pixel
op_eq
l_int|4
)paren
(brace
multiline_comment|/*&n;&t;&t; * RGB -&gt; luminance is defined to be&n;&t;&t; * Y =  0.299 * R + 0.587 * G + 0.114 * B&n;&t;&t; */
id|pal
op_assign
(paren
l_int|19595
op_star
id|red
op_plus
l_int|38470
op_star
id|green
op_plus
l_int|7471
op_star
id|blue
)paren
op_rshift
l_int|28
suffix:semicolon
r_if
c_cond
(paren
id|current_par.inv_4bpp
)paren
(brace
id|pal
op_assign
l_int|15
op_minus
id|pal
suffix:semicolon
)brace
)brace
r_else
(brace
id|pal
op_assign
(paren
(paren
id|red
op_rshift
l_int|4
)paren
op_amp
l_int|0xf00
)paren
suffix:semicolon
id|pal
op_or_assign
(paren
(paren
id|green
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f0
)paren
suffix:semicolon
id|pal
op_or_assign
(paren
(paren
id|blue
op_rshift
l_int|12
)paren
op_amp
l_int|0x00f
)paren
suffix:semicolon
)brace
r_return
id|pal
suffix:semicolon
)brace
r_static
r_inline
id|u_short
DECL|function|sa1100fb_palette_read
id|sa1100fb_palette_read
c_func
(paren
id|u_int
id|regno
)paren
(brace
r_return
(paren
id|current_par.v_palette_base
(braket
id|regno
)braket
op_amp
l_int|0x0FFF
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sa1100fb_palette_decode
id|sa1100fb_palette_decode
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|trans
)paren
(brace
id|u_short
id|pal
suffix:semicolon
id|pal
op_assign
id|sa1100fb_palette_read
c_func
(paren
id|regno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.bits_per_pixel
op_eq
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|current_par.inv_4bpp
)paren
(brace
id|pal
op_assign
l_int|15
op_minus
id|pal
suffix:semicolon
)brace
id|pal
op_and_assign
l_int|0x000f
suffix:semicolon
id|pal
op_or_assign
id|pal
op_lshift
l_int|4
suffix:semicolon
id|pal
op_or_assign
id|pal
op_lshift
l_int|8
suffix:semicolon
op_star
id|blue
op_assign
op_star
id|green
op_assign
op_star
id|red
op_assign
id|pal
suffix:semicolon
)brace
r_else
(brace
op_star
id|blue
op_assign
(paren
id|pal
op_amp
l_int|0x000f
)paren
op_lshift
l_int|12
suffix:semicolon
op_star
id|green
op_assign
(paren
id|pal
op_amp
l_int|0x00f0
)paren
op_lshift
l_int|8
suffix:semicolon
op_star
id|red
op_assign
(paren
id|pal
op_amp
l_int|0x0f00
)paren
op_lshift
l_int|4
suffix:semicolon
)brace
op_star
id|trans
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sa1100fb_getcolreg
id|sa1100fb_getcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
op_star
id|red
comma
id|u_int
op_star
id|green
comma
id|u_int
op_star
id|blue
comma
id|u_int
op_star
id|trans
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|regno
op_ge
id|current_par.palette_size
)paren
r_return
l_int|1
suffix:semicolon
id|sa1100fb_palette_decode
c_func
(paren
id|regno
comma
id|red
comma
id|green
comma
id|blue
comma
id|trans
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sa1100fb_setcolreg
id|sa1100fb_setcolreg
c_func
(paren
id|u_int
id|regno
comma
id|u_int
id|red
comma
id|u_int
id|green
comma
id|u_int
id|blue
comma
id|u_int
id|trans
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|u_short
id|pal
suffix:semicolon
r_if
c_cond
(paren
id|regno
op_ge
id|current_par.palette_size
)paren
r_return
l_int|1
suffix:semicolon
id|pal
op_assign
id|sa1100fb_palette_encode
c_func
(paren
id|regno
comma
id|red
comma
id|green
comma
id|blue
comma
id|trans
)paren
suffix:semicolon
id|sa1100fb_palette_write
c_func
(paren
id|regno
comma
id|pal
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sa1100fb_get_cmap
id|sa1100fb_get_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;current_par.visual=%d&bslash;n&quot;
comma
id|current_par.visual
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
id|current_par.currcon
)paren
id|err
op_assign
id|fb_get_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|sa1100fb_getcolreg
comma
id|info
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|fb_copy_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_else
id|fb_copy_cmap
c_func
(paren
id|fb_default_cmap
c_func
(paren
id|current_par.palette_size
)paren
comma
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|sa1100fb_set_cmap
id|sa1100fb_set_cmap
c_func
(paren
r_struct
id|fb_cmap
op_star
id|cmap
comma
r_int
id|kspc
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;current_par.visual=%d&bslash;n&quot;
comma
id|current_par.visual
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fb_display
(braket
id|con
)braket
dot
id|cmap.len
)paren
id|err
op_assign
id|fb_alloc_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|current_par.palette_size
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
r_if
c_cond
(paren
id|con
op_eq
id|current_par.currcon
)paren
id|err
op_assign
id|fb_set_cmap
c_func
(paren
id|cmap
comma
id|kspc
comma
id|sa1100fb_setcolreg
comma
id|info
)paren
suffix:semicolon
id|fb_copy_cmap
c_func
(paren
id|cmap
comma
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|cmap
comma
id|kspc
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_static
r_void
r_inline
DECL|function|sa1100fb_get_par
id|sa1100fb_get_par
c_func
(paren
r_struct
id|sa1100fb_par
op_star
id|par
)paren
(brace
op_star
id|par
op_assign
id|current_par
suffix:semicolon
)brace
multiline_comment|/*&n; * sa1100fb_encode_var():&n; * &t;Modify var structure using values in par&n; */
r_static
r_int
DECL|function|sa1100fb_encode_var
id|sa1100fb_encode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|sa1100fb_par
op_star
id|par
)paren
(brace
singleline_comment|// Don&squot;t know if really want to zero var on entry.
singleline_comment|// Look at set_var to see.  If so, may need to add extra params to par     
singleline_comment|//&t;memset(var, 0, sizeof(struct fb_var_screeninfo));
id|var-&gt;xres
op_assign
id|par-&gt;xres
suffix:semicolon
id|var-&gt;yres
op_assign
id|par-&gt;yres
suffix:semicolon
id|var-&gt;xres_virtual
op_assign
id|par-&gt;xres_virtual
suffix:semicolon
id|var-&gt;yres_virtual
op_assign
id|par-&gt;yres_virtual
suffix:semicolon
id|var-&gt;bits_per_pixel
op_assign
id|par-&gt;bits_per_pixel
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;var-&gt;bits_per_pixel=%d&bslash;n&quot;
comma
id|var-&gt;bits_per_pixel
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|var-&gt;bits_per_pixel
)paren
(brace
r_case
l_int|2
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|8
suffix:colon
id|var-&gt;red.length
op_assign
l_int|4
suffix:semicolon
id|var-&gt;green
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;blue
op_assign
id|var-&gt;red
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|12
suffix:colon
singleline_comment|// This case should differ for Active/Passive mode  
r_case
l_int|16
suffix:colon
r_if
c_cond
(paren
id|machine_is_bitsy
c_func
(paren
)paren
)paren
(brace
id|var-&gt;red.length
op_assign
l_int|4
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|4
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|4
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|12
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|7
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|1
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|var-&gt;red.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.length
op_assign
l_int|5
suffix:semicolon
id|var-&gt;green.length
op_assign
l_int|6
suffix:semicolon
id|var-&gt;transp.length
op_assign
l_int|0
suffix:semicolon
id|var-&gt;red.offset
op_assign
l_int|11
suffix:semicolon
id|var-&gt;green.offset
op_assign
l_int|5
suffix:semicolon
id|var-&gt;blue.offset
op_assign
l_int|0
suffix:semicolon
id|var-&gt;transp.offset
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  sa1100fb_decode_var():&n; *    Get the video params out of &squot;var&squot;. If a value doesn&squot;t fit, round it up,&n; *    if it&squot;s too big, return -EINVAL.&n; *&n; *    Suggestion: Round up in the following order: bits_per_pixel, xres,&n; *    yres, xres_virtual, yres_virtual, xoffset, yoffset, grayscale,&n; *    bitfields, horizontal timing, vertical timing.&n; */
r_static
r_int
DECL|function|sa1100fb_decode_var
id|sa1100fb_decode_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_struct
id|sa1100fb_par
op_star
id|par
)paren
(brace
id|u_long
id|palette_mem_phys
suffix:semicolon
id|u_long
id|palette_mem_size
suffix:semicolon
op_star
id|par
op_assign
id|current_par
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;xres
op_assign
id|var-&gt;xres
)paren
OL
id|MIN_XRES
)paren
id|par-&gt;xres
op_assign
id|MIN_XRES
suffix:semicolon
r_if
c_cond
(paren
(paren
id|par-&gt;yres
op_assign
id|var-&gt;yres
)paren
OL
id|MIN_YRES
)paren
id|par-&gt;yres
op_assign
id|MIN_YRES
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;xres
OG
id|current_par.max_xres
)paren
id|par-&gt;xres
op_assign
id|current_par.max_xres
suffix:semicolon
r_if
c_cond
(paren
id|par-&gt;yres
OG
id|current_par.max_yres
)paren
id|par-&gt;yres
op_assign
id|current_par.max_yres
suffix:semicolon
id|par-&gt;xres_virtual
op_assign
id|var-&gt;xres_virtual
OL
id|par-&gt;xres
ques
c_cond
id|par-&gt;xres
suffix:colon
id|var-&gt;xres_virtual
suffix:semicolon
id|par-&gt;yres_virtual
op_assign
id|var-&gt;yres_virtual
OL
id|par-&gt;yres
ques
c_cond
id|par-&gt;yres
suffix:colon
id|var-&gt;yres_virtual
suffix:semicolon
id|par-&gt;bits_per_pixel
op_assign
id|var-&gt;bits_per_pixel
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;par-&gt;bits_per_pixel=%d&bslash;n&quot;
comma
id|par-&gt;bits_per_pixel
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|par-&gt;bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB4
r_case
l_int|4
suffix:colon
id|par-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|par-&gt;palette_size
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|par-&gt;visual
op_assign
id|FB_VISUAL_PSEUDOCOLOR
suffix:semicolon
id|par-&gt;palette_size
op_assign
l_int|256
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
multiline_comment|/* RGB 565 */
id|par-&gt;visual
op_assign
id|FB_VISUAL_TRUECOLOR
suffix:semicolon
id|par-&gt;palette_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|palette_mem_size
op_assign
id|SA1100_PALETTE_MEM_SIZE
c_func
(paren
id|par-&gt;bits_per_pixel
)paren
suffix:semicolon
id|palette_mem_phys
op_assign
(paren
id|u_long
)paren
id|VideoMemRegion_phys
op_plus
id|PAGE_SIZE
op_minus
id|palette_mem_size
suffix:semicolon
id|par-&gt;p_palette_base
op_assign
(paren
id|u_short
op_star
)paren
id|palette_mem_phys
suffix:semicolon
id|par-&gt;v_palette_base
op_assign
(paren
id|u_short
op_star
)paren
(paren
(paren
id|u_long
)paren
id|VideoMemRegion
op_plus
id|PAGE_SIZE
op_minus
id|palette_mem_size
)paren
suffix:semicolon
id|par-&gt;p_screen_base
op_assign
(paren
id|u_char
op_star
)paren
(paren
(paren
id|u_long
)paren
id|VideoMemRegion_phys
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
id|par-&gt;v_screen_base
op_assign
(paren
id|u_char
op_star
)paren
(paren
(paren
id|u_long
)paren
id|VideoMemRegion
op_plus
id|PAGE_SIZE
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;p_palette_base = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|par-&gt;p_palette_base
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;v_palette_base = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|par-&gt;v_palette_base
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;palette_size = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|par-&gt;palette_size
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;palette_mem_size = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|palette_mem_size
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;p_screen_base  = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|par-&gt;p_screen_base
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;v_screen_base  = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|par-&gt;v_screen_base
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;VideoMemRegion = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|VideoMemRegion
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;VideoMemRegion_phys = 0x%08lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|VideoMemRegion_phys
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sa1100fb_get_var
id|sa1100fb_get_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|sa1100fb_par
id|par
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;con=%d&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_eq
op_minus
l_int|1
)paren
(brace
id|sa1100fb_get_par
c_func
(paren
op_amp
id|par
)paren
suffix:semicolon
id|sa1100fb_encode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
suffix:semicolon
)brace
r_else
op_star
id|var
op_assign
id|fb_display
(braket
id|con
)braket
dot
id|var
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * sa1100fb_set_var():&n; *&t;Set the user defined part of the display for the specified console&n; */
r_static
r_int
DECL|function|sa1100fb_set_var
id|sa1100fb_set_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|display
op_star
id|display
suffix:semicolon
r_int
id|err
comma
id|chgvar
op_assign
l_int|0
suffix:semicolon
r_struct
id|sa1100fb_par
id|par
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
id|display
op_assign
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
multiline_comment|/* Display settings for console */
r_else
id|display
op_assign
op_amp
id|global_disp
suffix:semicolon
multiline_comment|/* Default display settings */
multiline_comment|/* Decode var contents into a par structure, adjusting any */
multiline_comment|/* out of range values. */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|sa1100fb_decode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
singleline_comment|// Store adjusted par values into var structure
id|sa1100fb_encode_var
c_func
(paren
id|var
comma
op_amp
id|par
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_eq
id|FB_ACTIVATE_TEST
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_ne
id|FB_ACTIVATE_NOW
)paren
op_logical_and
(paren
(paren
id|var-&gt;activate
op_amp
id|FB_ACTIVATE_MASK
)paren
op_ne
id|FB_ACTIVATE_NXTOPEN
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|display-&gt;var.xres
op_ne
id|var-&gt;xres
)paren
op_logical_or
(paren
id|display-&gt;var.yres
op_ne
id|var-&gt;yres
)paren
op_logical_or
(paren
id|display-&gt;var.xres_virtual
op_ne
id|var-&gt;xres_virtual
)paren
op_logical_or
(paren
id|display-&gt;var.yres_virtual
op_ne
id|var-&gt;yres_virtual
)paren
op_logical_or
(paren
id|display-&gt;var.sync
op_ne
id|var-&gt;sync
)paren
op_logical_or
(paren
id|display-&gt;var.bits_per_pixel
op_ne
id|var-&gt;bits_per_pixel
)paren
op_logical_or
(paren
id|memcmp
c_func
(paren
op_amp
id|display-&gt;var.red
comma
op_amp
id|var-&gt;red
comma
r_sizeof
(paren
id|var-&gt;red
)paren
)paren
)paren
op_logical_or
(paren
id|memcmp
c_func
(paren
op_amp
id|display-&gt;var.green
comma
op_amp
id|var-&gt;green
comma
r_sizeof
(paren
id|var-&gt;green
)paren
)paren
)paren
op_logical_or
(paren
id|memcmp
c_func
(paren
op_amp
id|display-&gt;var.blue
comma
op_amp
id|var-&gt;blue
comma
r_sizeof
(paren
id|var-&gt;blue
)paren
)paren
)paren
)paren
id|chgvar
op_assign
l_int|1
suffix:semicolon
)brace
id|display-&gt;var
op_assign
op_star
id|var
suffix:semicolon
id|display-&gt;screen_base
op_assign
id|par.v_screen_base
suffix:semicolon
id|display-&gt;visual
op_assign
id|par.visual
suffix:semicolon
id|display-&gt;type
op_assign
id|FB_TYPE_PACKED_PIXELS
suffix:semicolon
id|display-&gt;type_aux
op_assign
l_int|0
suffix:semicolon
id|display-&gt;ypanstep
op_assign
l_int|0
suffix:semicolon
id|display-&gt;ywrapstep
op_assign
l_int|0
suffix:semicolon
id|display-&gt;line_length
op_assign
id|display-&gt;next_line
op_assign
(paren
id|var-&gt;xres
op_star
id|var-&gt;bits_per_pixel
)paren
op_div
l_int|8
suffix:semicolon
id|display-&gt;can_soft_blank
op_assign
l_int|1
suffix:semicolon
id|display-&gt;inverse
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|display-&gt;var.bits_per_pixel
)paren
(brace
macro_line|#ifdef FBCON_HAS_CFB4
r_case
l_int|4
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb4
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB8
r_case
l_int|8
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb8
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FBCON_HAS_CFB16
r_case
l_int|16
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_cfb16
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|display-&gt;dispsw
op_assign
op_amp
id|fbcon_dummy
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* If the console has changed and the console has defined */
multiline_comment|/* a changevar function, call that function. */
r_if
c_cond
(paren
id|chgvar
op_logical_and
id|info
op_logical_and
id|info-&gt;changevar
)paren
id|info
op_member_access_from_pointer
id|changevar
c_func
(paren
id|con
)paren
suffix:semicolon
multiline_comment|/* If the current console is selected and it&squot;s not truecolor, &n;&t; *  update the palette &n;&t; */
r_if
c_cond
(paren
(paren
id|con
op_eq
id|current_par.currcon
)paren
op_logical_and
(paren
id|current_par.visual
op_ne
id|FB_VISUAL_TRUECOLOR
)paren
)paren
(brace
r_struct
id|fb_cmap
op_star
id|cmap
suffix:semicolon
id|current_par
op_assign
id|par
suffix:semicolon
r_if
c_cond
(paren
id|display-&gt;cmap.len
)paren
id|cmap
op_assign
op_amp
id|display-&gt;cmap
suffix:semicolon
r_else
id|cmap
op_assign
id|fb_default_cmap
c_func
(paren
id|current_par.palette_size
)paren
suffix:semicolon
id|fb_set_cmap
c_func
(paren
id|cmap
comma
l_int|1
comma
id|sa1100fb_setcolreg
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* If the current console is selected, activate the new var. */
r_if
c_cond
(paren
id|con
op_eq
id|current_par.currcon
)paren
id|sa1100fb_activate_var
c_func
(paren
id|var
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sa1100fb_updatevar
id|sa1100fb_updatevar
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;entered&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sa1100fb_get_fix
id|sa1100fb_get_fix
c_func
(paren
r_struct
id|fb_fix_screeninfo
op_star
id|fix
comma
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_struct
id|display
op_star
id|display
suffix:semicolon
id|memset
c_func
(paren
id|fix
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fb_fix_screeninfo
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fix-&gt;id
comma
id|SA1100_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|con
op_ge
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Using console specific display for con=%d&bslash;n&quot;
comma
id|con
)paren
suffix:semicolon
id|display
op_assign
op_amp
id|fb_display
(braket
id|con
)braket
suffix:semicolon
multiline_comment|/* Display settings for console */
)brace
r_else
id|display
op_assign
op_amp
id|global_disp
suffix:semicolon
multiline_comment|/* Default display settings */
id|fix-&gt;smem_start
op_assign
(paren
r_int
r_int
)paren
id|current_par.p_screen_base
suffix:semicolon
id|fix-&gt;smem_len
op_assign
id|current_par.screen_size
suffix:semicolon
id|fix-&gt;type
op_assign
id|display-&gt;type
suffix:semicolon
id|fix-&gt;type_aux
op_assign
id|display-&gt;type_aux
suffix:semicolon
id|fix-&gt;xpanstep
op_assign
l_int|0
suffix:semicolon
id|fix-&gt;ypanstep
op_assign
id|display-&gt;ypanstep
suffix:semicolon
id|fix-&gt;ywrapstep
op_assign
id|display-&gt;ywrapstep
suffix:semicolon
id|fix-&gt;visual
op_assign
id|display-&gt;visual
suffix:semicolon
id|fix-&gt;line_length
op_assign
id|display-&gt;line_length
suffix:semicolon
id|fix-&gt;accel
op_assign
id|FB_ACCEL_NONE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sa1100fb_init_fbinfo
id|__init
id|sa1100fb_init_fbinfo
c_func
(paren
r_void
)paren
(brace
id|strcpy
c_func
(paren
id|fb_info.modename
comma
id|SA1100_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|fb_info.fontname
comma
l_string|&quot;Acorn8x8&quot;
)paren
suffix:semicolon
id|fb_info.node
op_assign
op_minus
l_int|1
suffix:semicolon
id|fb_info.flags
op_assign
id|FBINFO_FLAG_DEFAULT
suffix:semicolon
id|fb_info.fbops
op_assign
op_amp
id|sa1100fb_ops
suffix:semicolon
id|fb_info.monspecs
op_assign
id|monspecs
suffix:semicolon
id|fb_info.disp
op_assign
op_amp
id|global_disp
suffix:semicolon
id|fb_info.changevar
op_assign
l_int|NULL
suffix:semicolon
id|fb_info.switch_con
op_assign
id|sa1100fb_switch
suffix:semicolon
id|fb_info.updatevar
op_assign
id|sa1100fb_updatevar
suffix:semicolon
id|fb_info.blank
op_assign
id|sa1100fb_blank
suffix:semicolon
multiline_comment|/*&n;&t; * setup initial parameters&n;&t; */
id|memset
c_func
(paren
op_amp
id|init_var
comma
l_int|0
comma
r_sizeof
(paren
id|init_var
)paren
)paren
suffix:semicolon
id|init_var.transp.length
op_assign
l_int|0
suffix:semicolon
id|init_var.nonstd
op_assign
l_int|0
suffix:semicolon
id|init_var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|init_var.xoffset
op_assign
l_int|0
suffix:semicolon
id|init_var.yoffset
op_assign
l_int|0
suffix:semicolon
id|init_var.height
op_assign
op_minus
l_int|1
suffix:semicolon
id|init_var.width
op_assign
op_minus
l_int|1
suffix:semicolon
id|init_var.vmode
op_assign
id|FB_VMODE_NONINTERLACED
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_assabet
c_func
(paren
)paren
)paren
(brace
id|current_par.max_xres
op_assign
l_int|320
suffix:semicolon
id|current_par.max_yres
op_assign
l_int|240
suffix:semicolon
id|current_par.max_bpp
op_assign
l_int|16
suffix:semicolon
id|init_var.red.length
op_assign
l_int|5
suffix:semicolon
id|init_var.green.length
op_assign
l_int|6
suffix:semicolon
id|init_var.blue.length
op_assign
l_int|5
suffix:semicolon
id|init_var.grayscale
op_assign
l_int|0
suffix:semicolon
id|init_var.sync
op_assign
l_int|0
suffix:semicolon
id|init_var.pixclock
op_assign
l_int|171521
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_cerf
c_func
(paren
)paren
)paren
(brace
id|current_par.max_xres
op_assign
l_int|320
suffix:semicolon
id|current_par.max_yres
op_assign
l_int|240
suffix:semicolon
id|current_par.max_bpp
op_assign
l_int|8
suffix:semicolon
id|init_var.red.length
op_assign
l_int|4
suffix:semicolon
id|init_var.green.length
op_assign
l_int|4
suffix:semicolon
id|init_var.blue.length
op_assign
l_int|4
suffix:semicolon
id|init_var.grayscale
op_assign
l_int|0
suffix:semicolon
id|init_var.sync
op_assign
l_int|0
suffix:semicolon
id|init_var.pixclock
op_assign
l_int|171521
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_bitsy
c_func
(paren
)paren
)paren
(brace
id|current_par.max_xres
op_assign
l_int|320
suffix:semicolon
id|current_par.max_yres
op_assign
l_int|240
suffix:semicolon
id|current_par.max_bpp
op_assign
l_int|16
suffix:semicolon
id|init_var.red.length
op_assign
l_int|4
suffix:semicolon
id|init_var.green.length
op_assign
l_int|4
suffix:semicolon
id|init_var.blue.length
op_assign
l_int|4
suffix:semicolon
id|init_var.red.offset
op_assign
l_int|12
suffix:semicolon
id|init_var.green.offset
op_assign
l_int|7
suffix:semicolon
id|init_var.blue.offset
op_assign
l_int|1
suffix:semicolon
id|init_var.grayscale
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_brutus
c_func
(paren
)paren
)paren
(brace
id|current_par.max_xres
op_assign
l_int|320
suffix:semicolon
id|current_par.max_yres
op_assign
l_int|240
suffix:semicolon
id|current_par.max_bpp
op_assign
l_int|8
suffix:semicolon
id|init_var.red.length
op_assign
l_int|4
suffix:semicolon
id|init_var.green
op_assign
id|init_var.red
suffix:semicolon
id|init_var.blue
op_assign
id|init_var.red
suffix:semicolon
id|init_var.sync
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_lart
c_func
(paren
)paren
)paren
(brace
id|current_par.max_xres
op_assign
l_int|320
suffix:semicolon
id|current_par.max_yres
op_assign
l_int|240
suffix:semicolon
id|current_par.max_bpp
op_assign
l_int|4
suffix:semicolon
id|init_var.red.length
op_assign
l_int|4
suffix:semicolon
id|init_var.green
op_assign
id|init_var.red
suffix:semicolon
id|init_var.blue
op_assign
id|init_var.red
suffix:semicolon
id|init_var.grayscale
op_assign
l_int|1
suffix:semicolon
id|init_var.pixclock
op_assign
l_int|150000
suffix:semicolon
id|init_var.sync
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_penny
c_func
(paren
)paren
)paren
(brace
id|current_par.max_xres
op_assign
l_int|640
suffix:semicolon
id|current_par.max_yres
op_assign
l_int|480
suffix:semicolon
id|current_par.max_bpp
op_assign
l_int|8
suffix:semicolon
id|init_var.red.length
op_assign
l_int|4
suffix:semicolon
id|init_var.green
op_assign
id|init_var.red
suffix:semicolon
id|init_var.blue
op_assign
id|init_var.red
suffix:semicolon
id|init_var.sync
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_thinclient
c_func
(paren
)paren
op_logical_or
id|machine_is_graphicsclient
c_func
(paren
)paren
)paren
(brace
id|current_par.max_xres
op_assign
l_int|640
suffix:semicolon
id|current_par.max_yres
op_assign
l_int|480
suffix:semicolon
id|current_par.max_bpp
op_assign
l_int|8
suffix:semicolon
id|init_var.red.length
op_assign
l_int|4
suffix:semicolon
id|init_var.green
op_assign
id|init_var.red
suffix:semicolon
id|init_var.blue
op_assign
id|init_var.red
suffix:semicolon
id|init_var.sync
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_tifon
c_func
(paren
)paren
)paren
(brace
id|current_par.max_xres
op_assign
l_int|640
suffix:semicolon
id|current_par.max_yres
op_assign
l_int|200
suffix:semicolon
id|current_par.max_bpp
op_assign
l_int|4
suffix:semicolon
id|current_par.inv_4bpp
op_assign
l_int|1
suffix:semicolon
id|init_var.red.length
op_assign
l_int|4
suffix:semicolon
id|init_var.green
op_assign
id|init_var.red
suffix:semicolon
id|init_var.blue
op_assign
id|init_var.red
suffix:semicolon
id|init_var.grayscale
op_assign
l_int|1
suffix:semicolon
id|init_var.pixclock
op_assign
l_int|150000
suffix:semicolon
id|init_var.left_margin
op_assign
l_int|20
suffix:semicolon
id|init_var.right_margin
op_assign
l_int|255
suffix:semicolon
id|init_var.upper_margin
op_assign
l_int|20
suffix:semicolon
id|init_var.lower_margin
op_assign
l_int|0
suffix:semicolon
id|init_var.hsync_len
op_assign
l_int|2
suffix:semicolon
id|init_var.vsync_len
op_assign
l_int|1
suffix:semicolon
id|init_var.sync
op_assign
id|FB_SYNC_HOR_HIGH_ACT
op_or
id|FB_SYNC_VERT_HIGH_ACT
suffix:semicolon
id|init_var.vmode
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_xp860
c_func
(paren
)paren
)paren
(brace
id|current_par.max_xres
op_assign
l_int|1024
suffix:semicolon
id|current_par.max_yres
op_assign
l_int|768
suffix:semicolon
id|current_par.max_bpp
op_assign
l_int|8
suffix:semicolon
id|init_var.red.length
op_assign
l_int|4
suffix:semicolon
id|init_var.green
op_assign
id|init_var.red
suffix:semicolon
id|init_var.blue
op_assign
id|init_var.red
suffix:semicolon
id|init_var.hsync_len
op_assign
l_int|4
suffix:semicolon
id|init_var.left_margin
op_assign
l_int|3
suffix:semicolon
id|init_var.right_margin
op_assign
l_int|2
suffix:semicolon
id|init_var.vsync_len
op_assign
l_int|3
suffix:semicolon
id|init_var.upper_margin
op_assign
l_int|2
suffix:semicolon
id|init_var.lower_margin
op_assign
l_int|1
suffix:semicolon
)brace
id|current_par.p_palette_base
op_assign
l_int|NULL
suffix:semicolon
id|current_par.v_palette_base
op_assign
l_int|NULL
suffix:semicolon
id|current_par.p_screen_base
op_assign
l_int|NULL
suffix:semicolon
id|current_par.v_screen_base
op_assign
l_int|NULL
suffix:semicolon
id|current_par.palette_size
op_assign
id|MAX_PALETTE_NUM_ENTRIES
suffix:semicolon
id|current_par.screen_size
op_assign
id|MAX_PIXEL_MEM_SIZE
suffix:semicolon
id|current_par.montype
op_assign
op_minus
l_int|1
suffix:semicolon
id|current_par.currcon
op_assign
op_minus
l_int|1
suffix:semicolon
id|current_par.allow_modeset
op_assign
l_int|1
suffix:semicolon
id|current_par.controller_state
op_assign
id|LCD_MODE_DISABLED
suffix:semicolon
id|init_var.xres
op_assign
id|current_par.max_xres
suffix:semicolon
id|init_var.yres
op_assign
id|current_par.max_yres
suffix:semicolon
id|init_var.xres_virtual
op_assign
id|init_var.xres
suffix:semicolon
id|init_var.yres_virtual
op_assign
id|init_var.yres
suffix:semicolon
id|init_var.bits_per_pixel
op_assign
id|current_par.max_bpp
suffix:semicolon
)brace
multiline_comment|/*&n; * sa1100fb_map_video_memory():&n; *      Allocates the DRAM memory for the frame buffer.  This buffer is  &n; *&t;remapped into a non-cached, non-buffered, memory region to  &n; *      allow palette and pixel writes to occur without flushing the &n; *      cache.  Once this area is remapped, all virtual memory&n; *      access to the video memory should occur at the new region.&n; */
r_static
r_int
DECL|function|sa1100fb_map_video_memory
id|__init
id|sa1100fb_map_video_memory
c_func
(paren
r_void
)paren
(brace
id|u_int
id|required_pages
suffix:semicolon
id|u_int
id|extra_pages
suffix:semicolon
id|u_int
id|order
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_char
op_star
id|allocated_region
suffix:semicolon
r_if
c_cond
(paren
id|VideoMemRegion
op_ne
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;-1-&quot;
)paren
suffix:semicolon
multiline_comment|/* Find order required to allocate enough memory for framebuffer */
id|required_pages
op_assign
id|ALLOCATED_FB_MEM_SIZE
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_for
c_loop
(paren
id|order
op_assign
l_int|0
suffix:semicolon
id|required_pages
op_rshift
id|order
suffix:semicolon
id|order
op_increment
)paren
(brace
suffix:semicolon
)brace
id|extra_pages
op_assign
(paren
l_int|1
op_lshift
id|order
)paren
op_minus
id|required_pages
suffix:semicolon
r_if
c_cond
(paren
(paren
id|allocated_region
op_assign
(paren
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
id|order
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|VideoMemRegion
op_assign
(paren
id|u_char
op_star
)paren
id|allocated_region
op_plus
(paren
id|extra_pages
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|VideoMemRegion_phys
op_assign
(paren
id|u_char
op_star
)paren
id|__virt_to_phys
c_func
(paren
(paren
id|u_long
)paren
id|VideoMemRegion
)paren
suffix:semicolon
multiline_comment|/* Free all pages that we don&squot;t need but were given to us because */
multiline_comment|/* __get_free_pages() works on powers of 2. */
r_for
c_loop
(paren
suffix:semicolon
id|extra_pages
suffix:semicolon
id|extra_pages
op_decrement
)paren
id|free_page
c_func
(paren
(paren
id|u_int
)paren
id|allocated_region
op_plus
(paren
(paren
id|extra_pages
op_minus
l_int|1
)paren
op_lshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
multiline_comment|/* Set reserved flag for fb memory to allow it to be remapped into */
multiline_comment|/* user space by the common fbmem driver using remap_page_range(). */
r_for
c_loop
(paren
id|page
op_assign
id|virt_to_page
c_func
(paren
id|VideoMemRegion
)paren
suffix:semicolon
id|page
OL
id|virt_to_page
c_func
(paren
id|VideoMemRegion
op_plus
id|ALLOCATED_FB_MEM_SIZE
)paren
suffix:semicolon
id|page
op_increment
)paren
(brace
id|mem_map_reserve
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
multiline_comment|/* Remap the fb memory to a non-buffered, non-cached region */
id|VideoMemRegion
op_assign
(paren
id|u_char
op_star
)paren
id|__ioremap
c_func
(paren
(paren
id|u_long
)paren
id|VideoMemRegion_phys
comma
id|ALLOCATED_FB_MEM_SIZE
comma
id|L_PTE_PRESENT
op_or
id|L_PTE_YOUNG
op_or
id|L_PTE_DIRTY
op_or
id|L_PTE_WRITE
)paren
suffix:semicolon
r_return
(paren
id|VideoMemRegion
op_eq
l_int|NULL
ques
c_cond
op_minus
id|EINVAL
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|frequency
r_static
r_const
r_int
id|frequency
(braket
l_int|16
)braket
op_assign
(brace
l_int|59000000
comma
l_int|73700000
comma
l_int|88500000
comma
l_int|103200000
comma
l_int|118000000
comma
l_int|132700000
comma
l_int|147500000
comma
l_int|162200000
comma
l_int|176900000
comma
l_int|191700000
comma
l_int|206400000
comma
l_int|230000000
comma
l_int|245000000
comma
l_int|260000000
comma
l_int|275000000
comma
l_int|290000000
)brace
suffix:semicolon
DECL|function|get_pcd
r_static
r_inline
r_int
id|get_pcd
c_func
(paren
r_int
r_int
id|pixclock
)paren
(brace
r_int
r_int
id|pcd
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_tifon
c_func
(paren
)paren
)paren
(brace
id|pcd
op_assign
id|frequency
(braket
id|PPCR
op_amp
l_int|0xf
)braket
op_div
l_int|1000
suffix:semicolon
id|pcd
op_mul_assign
id|pixclock
op_div
l_int|1000
suffix:semicolon
id|pcd
op_assign
id|pcd
op_div
l_int|10000000
op_star
l_int|12
suffix:semicolon
multiline_comment|/* the last multiplication by 1.2 is to handle */
multiline_comment|/* sync problems */
)brace
r_if
c_cond
(paren
id|machine_is_assabet
c_func
(paren
)paren
)paren
(brace
id|pcd
op_assign
id|frequency
(braket
id|PPCR
op_amp
l_int|0xf
)braket
op_div
l_int|1000
suffix:semicolon
id|pcd
op_mul_assign
id|pixclock
op_div
l_int|1000
suffix:semicolon
id|pcd
op_assign
id|pcd
op_div
l_int|1000000
suffix:semicolon
id|pcd
op_increment
suffix:semicolon
multiline_comment|/* make up for integer math truncations */
)brace
r_return
id|pcd
suffix:semicolon
)brace
multiline_comment|/*&n; * sa1100fb_activate_var():&n; *&t;Configures LCD Controller based on entries in var parameter.  Settings are      &n; *      only written to the controller if changes were made.  &n; */
r_static
r_int
DECL|function|sa1100fb_activate_var
id|sa1100fb_activate_var
c_func
(paren
r_struct
id|fb_var_screeninfo
op_star
id|var
)paren
(brace
id|u_long
id|flags
suffix:semicolon
r_int
id|pcd
op_assign
id|get_pcd
c_func
(paren
id|var-&gt;pixclock
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring  SA1100 LCD&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.p_palette_base
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;activating&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts and save status */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
singleline_comment|// disable the interrupts and save flags
multiline_comment|/* Reset the LCD Controller&squot;s DMA address if it has changed */
id|lcd_shadow.dbar1
op_assign
(paren
id|Address
)paren
id|current_par.p_palette_base
suffix:semicolon
id|lcd_shadow.dbar2
op_assign
(paren
id|Address
)paren
(paren
id|current_par.p_screen_base
op_plus
(paren
id|current_par.xres
op_star
id|current_par.yres
op_star
id|current_par.bits_per_pixel
op_div
l_int|8
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring xres = %d, yres = %d&bslash;n&quot;
comma
id|var-&gt;xres
comma
id|var-&gt;yres
)paren
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_assabet
c_func
(paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring  Assabet LCD&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_shadow.lccr0
op_assign
id|LCCR0_LEN
op_plus
id|LCCR0_Color
op_plus
id|LCCR0_Sngl
op_plus
id|LCCR0_LDM
op_plus
id|LCCR0_BAM
op_plus
id|LCCR0_ERM
op_plus
id|LCCR0_Act
op_plus
id|LCCR0_LtlEnd
op_plus
id|LCCR0_DMADel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
l_int|6
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
l_int|61
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
l_int|9
)paren
suffix:semicolon
id|lcd_shadow.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|var-&gt;yres
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
l_int|1
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
l_int|3
)paren
op_plus
id|LCCR2_EndFrmDel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr3
op_assign
id|LCCR3_OutEnH
op_plus
id|LCCR3_PixFlEdg
op_plus
id|LCCR3_VrtSnchH
op_plus
id|LCCR3_HorSnchH
op_plus
id|LCCR3_ACBsCntOff
op_plus
id|LCCR3_ACBsDiv
c_func
(paren
l_int|2
)paren
op_plus
id|LCCR3_PixClkDiv
c_func
(paren
id|pcd
)paren
suffix:semicolon
multiline_comment|/* Set board control register to handle new color depth */
id|sa1100fb_assabet_set_truecolor
c_func
(paren
id|var-&gt;bits_per_pixel
op_ge
l_int|16
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_bitsy
c_func
(paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring  Bitsy LCD&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_shadow.lccr0
op_assign
id|LCCR0_LEN
op_plus
id|LCCR0_Color
op_plus
id|LCCR0_Sngl
op_plus
id|LCCR0_Act
op_plus
id|LCCR0_LtlEnd
op_plus
id|LCCR0_LDM
op_plus
id|LCCR0_BAM
op_plus
id|LCCR0_ERM
op_plus
id|LCCR0_DMADel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
l_int|4
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
l_int|0xC
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
l_int|0x11
)paren
suffix:semicolon
id|lcd_shadow.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|var-&gt;yres
op_plus
l_int|1
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
l_int|3
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
l_int|10
)paren
op_plus
id|LCCR2_EndFrmDel
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|lcd_shadow.lccr3
op_assign
(paren
multiline_comment|/* PCD */
l_int|0x10
op_or
multiline_comment|/* ACB */
l_int|0
op_or
multiline_comment|/* API */
l_int|0
op_or
id|LCCR3_VrtSnchL
op_or
id|LCCR3_HorSnchL
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_brutus
c_func
(paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring  Brutus LCD&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_shadow.lccr0
op_assign
id|LCCR0_LEN
op_plus
id|LCCR0_Color
op_plus
id|LCCR0_Sngl
op_plus
id|LCCR0_Pas
op_plus
id|LCCR0_LtlEnd
op_plus
id|LCCR0_LDM
op_plus
id|LCCR0_BAM
op_plus
id|LCCR0_ERM
op_plus
id|LCCR0_DMADel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
l_int|4
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
l_int|41
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
l_int|101
)paren
suffix:semicolon
id|lcd_shadow.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|var-&gt;yres
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
l_int|1
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
l_int|0
)paren
op_plus
id|LCCR2_EndFrmDel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr3
op_assign
id|LCCR3_OutEnH
op_plus
id|LCCR3_PixFlEdg
op_plus
id|LCCR3_VrtSnchH
op_plus
id|LCCR3_HorSnchH
op_plus
id|LCCR3_ACBsCntOff
op_plus
id|LCCR3_ACBsDiv
c_func
(paren
l_int|2
)paren
op_plus
id|LCCR3_PixClkDiv
c_func
(paren
l_int|44
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_cerf
c_func
(paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring Cerf LCD&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_shadow.lccr0
op_assign
id|LCCR0_LEN
op_plus
id|LCCR0_Color
op_plus
id|LCCR0_Sngl
op_plus
id|LCCR0_LDM
op_plus
id|LCCR0_BAM
op_plus
id|LCCR0_ERM
op_plus
id|LCCR0_Pas
op_plus
id|LCCR0_LtlEnd
op_plus
id|LCCR0_DMADel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
l_int|6
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
l_int|61
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
l_int|9
)paren
suffix:semicolon
id|lcd_shadow.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|var-&gt;yres
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
l_int|1
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
l_int|3
)paren
op_plus
id|LCCR2_EndFrmDel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr3
op_assign
id|LCCR3_OutEnH
op_plus
id|LCCR3_PixFlEdg
op_plus
id|LCCR3_VrtSnchH
op_plus
id|LCCR3_HorSnchH
op_plus
id|LCCR3_ACBsCntOff
op_plus
id|LCCR3_ACBsDiv
c_func
(paren
l_int|2
)paren
op_plus
id|LCCR3_PixClkDiv
c_func
(paren
l_int|38
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_lart
c_func
(paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring LART LCD&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_shadow.lccr0
op_assign
id|LCCR0_LEN
op_plus
id|LCCR0_Mono
op_plus
id|LCCR0_Sngl
op_plus
id|LCCR0_Pas
op_plus
id|LCCR0_LtlEnd
op_plus
id|LCCR0_LDM
op_plus
id|LCCR0_BAM
op_plus
id|LCCR0_ERM
op_plus
id|LCCR0_DMADel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
l_int|2
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
l_int|4
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|lcd_shadow.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|var-&gt;yres
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
l_int|1
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
l_int|0
)paren
op_plus
id|LCCR2_EndFrmDel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr3
op_assign
id|LCCR3_PixClkDiv
c_func
(paren
l_int|34
)paren
op_plus
id|LCCR3_ACBsDiv
c_func
(paren
l_int|512
)paren
op_plus
id|LCCR3_ACBsCntOff
op_plus
id|LCCR3_HorSnchH
op_plus
id|LCCR3_VrtSnchH
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_penny
c_func
(paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring  Penny LCD&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_shadow.lccr0
op_assign
id|LCCR0_LEN
op_plus
id|LCCR0_Color
op_plus
id|LCCR0_Sngl
op_plus
id|LCCR0_Act
op_plus
id|LCCR0_LtlEnd
op_plus
id|LCCR0_LDM
op_plus
id|LCCR0_BAM
op_plus
id|LCCR0_ERM
op_plus
id|LCCR0_DMADel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
l_int|65
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
l_int|43
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
l_int|43
)paren
suffix:semicolon
id|lcd_shadow.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|var-&gt;yres
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
l_int|35
)paren
op_plus
id|LCCR2_EndFrmDel
c_func
(paren
l_int|0
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr3
op_assign
id|LCCR3_PixClkDiv
c_func
(paren
l_int|16
)paren
op_plus
id|LCCR3_ACBsDiv
(paren
l_int|2
)paren
op_plus
id|LCCR3_ACBsCntOff
op_plus
(paren
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_HOR_HIGH_ACT
)paren
ques
c_cond
id|LCCR3_HorSnchH
suffix:colon
id|LCCR3_HorSnchL
)paren
op_plus
(paren
(paren
id|var-&gt;sync
op_amp
id|FB_SYNC_VERT_HIGH_ACT
)paren
ques
c_cond
id|LCCR3_VrtSnchH
suffix:colon
id|LCCR3_VrtSnchL
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_thinclient
c_func
(paren
)paren
op_logical_or
id|machine_is_graphicsclient
c_func
(paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring ThinClient LCD&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_shadow.lccr0
op_assign
id|LCCR0_LEN
op_plus
id|LCCR0_Color
op_plus
id|LCCR0_Sngl
op_plus
id|LCCR0_Act
suffix:semicolon
id|lcd_shadow.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
l_int|10
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
l_int|81
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
l_int|81
)paren
suffix:semicolon
id|lcd_shadow.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|var-&gt;yres
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
l_int|9
)paren
op_plus
id|LCCR2_EndFrmDel
(paren
l_int|20
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|lcd_shadow.lccr3
op_assign
id|LCCR3_PixClkDiv
c_func
(paren
l_int|6
)paren
op_plus
id|LCCR3_ACBsDiv
c_func
(paren
l_int|2
)paren
op_plus
id|LCCR3_ACBsCntOff
op_plus
id|LCCR3_HorSnchL
op_plus
id|LCCR3_VrtSnchL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_tifon
c_func
(paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring TIFON LCD&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_shadow.lccr0
op_assign
id|LCCR0_LEN
op_plus
id|LCCR0_Mono
op_plus
id|LCCR0_Sngl
op_plus
id|LCCR0_Pas
op_plus
id|LCCR0_BigEnd
op_plus
id|LCCR0_LDM
op_plus
id|LCCR0_BAM
op_plus
id|LCCR0_ERM
op_plus
id|LCCR0_8PixMono
op_plus
id|LCCR0_DMADel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
id|var-&gt;hsync_len
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
id|var-&gt;left_margin
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
id|var-&gt;right_margin
)paren
suffix:semicolon
id|lcd_shadow.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|var-&gt;yres
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
id|var-&gt;vsync_len
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
id|var-&gt;upper_margin
)paren
op_plus
id|LCCR2_EndFrmDel
c_func
(paren
id|var-&gt;lower_margin
)paren
suffix:semicolon
id|lcd_shadow.lccr3
op_assign
id|LCCR3_PixClkDiv
c_func
(paren
id|pcd
)paren
op_plus
id|LCCR3_ACBsDiv
c_func
(paren
l_int|512
)paren
op_plus
id|LCCR3_ACBsCnt
c_func
(paren
l_int|0
)paren
op_plus
id|LCCR3_HorSnchH
op_plus
id|LCCR3_VrtSnchH
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;((current_var.sync &amp; FB_SYNC_HOR_HIGH_ACT) ? LCCR3_HorSnchH : LCCR3_HorSnchL) +&n;&t;&t;&t;((current_var.sync &amp; FB_SYNC_VERT_HIGH_ACT) ? LCCR3_VrtSnchH : LCCR3_VrtSnchL);&n;&t;&t;*/
)brace
r_else
r_if
c_cond
(paren
id|machine_is_xp860
c_func
(paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Configuring XP860 LCD&bslash;n&quot;
)paren
suffix:semicolon
id|lcd_shadow.lccr0
op_assign
id|LCCR0_LEN
op_plus
id|LCCR0_Color
op_plus
id|LCCR0_Sngl
op_plus
id|LCCR0_Act
op_plus
id|LCCR0_LtlEnd
op_plus
id|LCCR0_LDM
op_plus
id|LCCR0_ERM
op_plus
id|LCCR0_DMADel
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|lcd_shadow.lccr1
op_assign
id|LCCR1_DisWdth
c_func
(paren
id|var-&gt;xres
)paren
op_plus
id|LCCR1_HorSnchWdth
c_func
(paren
id|var-&gt;hsync_len
)paren
op_plus
id|LCCR1_BegLnDel
c_func
(paren
id|var-&gt;left_margin
)paren
op_plus
id|LCCR1_EndLnDel
c_func
(paren
id|var-&gt;right_margin
)paren
suffix:semicolon
id|lcd_shadow.lccr2
op_assign
id|LCCR2_DisHght
c_func
(paren
id|var-&gt;yres
)paren
op_plus
id|LCCR2_VrtSnchWdth
c_func
(paren
id|var-&gt;vsync_len
)paren
op_plus
id|LCCR2_BegFrmDel
c_func
(paren
id|var-&gt;upper_margin
)paren
op_plus
id|LCCR2_EndFrmDel
c_func
(paren
id|var-&gt;lower_margin
)paren
suffix:semicolon
id|lcd_shadow.lccr3
op_assign
id|LCCR3_PixClkDiv
c_func
(paren
l_int|6
)paren
op_plus
id|LCCR3_HorSnchL
op_plus
id|LCCR3_VrtSnchL
suffix:semicolon
)brace
multiline_comment|/* Restore interrupt status */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|LCCR0
op_ne
id|lcd_shadow.lccr0
)paren
op_logical_or
(paren
id|LCCR1
op_ne
id|lcd_shadow.lccr1
)paren
op_logical_or
(paren
id|LCCR2
op_ne
id|lcd_shadow.lccr2
)paren
op_logical_or
(paren
id|LCCR3
op_ne
id|lcd_shadow.lccr3
)paren
op_logical_or
(paren
id|DBAR1
op_ne
id|lcd_shadow.dbar1
)paren
op_logical_or
(paren
id|DBAR2
op_ne
id|lcd_shadow.dbar2
)paren
)paren
(brace
id|sa1100fb_enable_lcd_controller
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  sa1100fb_inter_handler():&n; *&t;Interrupt handler for LCD controller.  Processes disable done interrupt (LDD)&n; *      to reenable controller if controller was disabled to change register values.&n; */
DECL|function|sa1100fb_inter_handler
r_static
r_void
id|sa1100fb_inter_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
id|LCSR
op_amp
id|LCSR_LDD
)paren
(brace
r_int
id|controller_state
op_assign
id|current_par.controller_state
suffix:semicolon
multiline_comment|/* Disable Done Flag is set */
id|LCCR0
op_or_assign
id|LCCR0_LDM
suffix:semicolon
multiline_comment|/* Mask LCD Disable Done Interrupt */
id|current_par.controller_state
op_assign
id|LCD_MODE_DISABLED
suffix:semicolon
r_if
c_cond
(paren
id|controller_state
op_eq
id|LCD_MODE_DISABLE_BEFORE_ENABLE
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;sa1100fb_inter_handler: re-enabling LCD controller&bslash;n&quot;
)paren
suffix:semicolon
id|sa1100fb_enable_lcd_controller
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * Second half of sa1100fb_disable_lcd_controller()&n;&t;&t;&t; */
r_if
c_cond
(paren
id|machine_is_assabet
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SA1100_ASSABET
id|BCR_clear
c_func
(paren
id|BCR_LCD_ON
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|machine_is_bitsy
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SA1100_BITSY
r_if
c_cond
(paren
id|current_par.controller_state
op_ne
id|LCD_MODE_DISABLE_BEFORE_ENABLE
)paren
id|clr_bitsy_egpio
c_func
(paren
id|EGPIO_BITSY_LCD_ON
op_or
id|EGPIO_BITSY_LCD_PCI
op_or
id|EGPIO_BITSY_LCD_5V_ON
op_or
id|EGPIO_BITSY_LVDD_ON
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|machine_is_penny
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SA1100_PENNY
id|FpgaLcdCS1
op_assign
l_int|0x000
suffix:semicolon
multiline_comment|/* LCD Backlight to 0%    */
id|FpgaPortI
op_and_assign
op_complement
id|LCD_ON
suffix:semicolon
multiline_comment|/* Turn off LCD Backlight */
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|machine_is_tifon
c_func
(paren
)paren
)paren
(brace
id|GPCR
op_assign
id|GPIO_GPIO
c_func
(paren
l_int|24
)paren
suffix:semicolon
multiline_comment|/* turn off display */
)brace
)brace
)brace
id|LCSR
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear LCD Status Register */
)brace
multiline_comment|/*&n; *  sa1100fb_disable_lcd_controller():&n; *    &t;Disables LCD controller by and enables LDD interrupt.  The controller_state&n; *      is not changed until the LDD interrupt is received to indicate the current&n; *      frame has completed.  Platform specific hardware disabling is also included.&n; */
DECL|function|sa1100fb_disable_lcd_controller
r_static
r_void
id|sa1100fb_disable_lcd_controller
c_func
(paren
r_void
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Disabling LCD controller&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Exit if already LCD disabled, or LDD IRQ unmasked */
r_if
c_cond
(paren
(paren
id|current_par.controller_state
op_eq
id|LCD_MODE_DISABLED
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|LCCR0
op_amp
id|LCCR0_LDM
)paren
)paren
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;LCD already disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|LCSR
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear LCD Status Register */
id|LCCR0
op_and_assign
op_complement
(paren
id|LCCR0_LDM
)paren
suffix:semicolon
multiline_comment|/* Enable LCD Disable Done Interrupt */
id|enable_irq
c_func
(paren
id|IRQ_LCD
)paren
suffix:semicolon
multiline_comment|/* Enable LCD IRQ */
id|LCCR0
op_and_assign
op_complement
(paren
id|LCCR0_LEN
)paren
suffix:semicolon
multiline_comment|/* Disable LCD Controller */
)brace
multiline_comment|/*&n; *  sa1100fb_enable_lcd_controller():&n; *    &t;Enables LCD controller.  If the controller is already enabled, it is first disabled.&n; *      This forces all changes to the LCD controller registers to be done when the &n; *      controller is disabled.  Platform specific hardware enabling is also included.&n; */
DECL|function|sa1100fb_enable_lcd_controller
r_static
r_void
id|sa1100fb_enable_lcd_controller
c_func
(paren
r_void
)paren
(brace
id|u_long
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Disable controller before changing parameters */
r_if
c_cond
(paren
id|current_par.controller_state
op_eq
id|LCD_MODE_ENABLED
)paren
(brace
id|current_par.controller_state
op_assign
id|LCD_MODE_DISABLE_BEFORE_ENABLE
suffix:semicolon
id|sa1100fb_disable_lcd_controller
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Enabling LCD controller&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Make sure the mode bits are present in the first palette entry */
id|current_par.v_palette_base
(braket
l_int|0
)braket
op_and_assign
l_int|0x0FFF
suffix:semicolon
id|current_par.v_palette_base
(braket
l_int|0
)braket
op_or_assign
id|SA1100_PALETTE_MODE_VAL
c_func
(paren
id|current_par.bits_per_pixel
)paren
suffix:semicolon
multiline_comment|/* Enable GPIO&lt;9:2&gt; for LCD usage if dual-scan */
r_if
c_cond
(paren
id|lcd_shadow.lccr0
op_amp
id|LCCR0_SDS
)paren
(brace
id|GPDR
op_or_assign
l_int|0x3fc
suffix:semicolon
id|GAFR
op_or_assign
l_int|0x3fc
suffix:semicolon
)brace
multiline_comment|/* Sequence from 11.7.10 */
id|LCCR3
op_assign
id|lcd_shadow.lccr3
suffix:semicolon
id|LCCR2
op_assign
id|lcd_shadow.lccr2
suffix:semicolon
id|LCCR1
op_assign
id|lcd_shadow.lccr1
suffix:semicolon
id|LCCR0
op_assign
id|lcd_shadow.lccr0
op_amp
op_complement
id|LCCR0_LEN
suffix:semicolon
id|DBAR1
op_assign
id|lcd_shadow.dbar1
suffix:semicolon
id|DBAR2
op_assign
id|lcd_shadow.dbar2
suffix:semicolon
id|LCCR0
op_or_assign
id|LCCR0_LEN
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_assabet
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SA1100_ASSABET
id|BCR_set
c_func
(paren
id|BCR_LCD_ON
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|machine_is_bitsy
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SA1100_BITSY
id|set_bitsy_egpio
c_func
(paren
id|EGPIO_BITSY_LCD_ON
op_or
id|EGPIO_BITSY_LCD_PCI
op_or
id|EGPIO_BITSY_LCD_5V_ON
op_or
id|EGPIO_BITSY_LVDD_ON
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;DBAR1=%p&bslash;n&quot;
comma
id|DBAR1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;LCCR0=%x&bslash;n&quot;
comma
id|LCCR0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;LCCR1=%x&bslash;n&quot;
comma
id|LCCR1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;LCCR2=%x&bslash;n&quot;
comma
id|LCCR2
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;LCCR3=%x&bslash;n&quot;
comma
id|LCCR3
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|machine_is_penny
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SA1100_PENNY
id|FpgaLcdCS1
op_assign
l_int|0x0FF
suffix:semicolon
multiline_comment|/* LCD Backlight to 100% */
id|FpgaPortI
op_or_assign
id|LCD_ON
suffix:semicolon
multiline_comment|/* Turn on LCD Backlight */
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|machine_is_tifon
c_func
(paren
)paren
)paren
(brace
id|GPCR
op_assign
id|GPIO_GPIO
c_func
(paren
l_int|24
)paren
suffix:semicolon
multiline_comment|/* cycle on/off-switch */
id|udelay
c_func
(paren
l_int|150
)paren
suffix:semicolon
id|GPSR
op_assign
id|GPIO_GPIO
c_func
(paren
l_int|24
)paren
suffix:semicolon
multiline_comment|/* turn on display */
)brace
id|current_par.controller_state
op_assign
id|LCD_MODE_ENABLED
suffix:semicolon
)brace
multiline_comment|/* Restore interrupt status */
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * sa1100fb_blank():&n; *&t;Blank the display by setting all palette values to zero.  Note, the &n; * &t;12 and 16 bpp modes don&squot;t really use the palette, so this will not&n; *      blank the display in all modes.  &n; */
r_static
r_void
DECL|function|sa1100fb_blank
id|sa1100fb_blank
c_func
(paren
r_int
id|blank
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;blank=%d info-&gt;modename=%s&bslash;n&quot;
comma
id|blank
comma
id|info-&gt;modename
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blank
)paren
(brace
r_if
c_cond
(paren
id|current_par.visual
op_ne
id|FB_VISUAL_TRUECOLOR
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|current_par.palette_size
suffix:semicolon
id|i
op_increment
)paren
id|sa1100fb_palette_write
c_func
(paren
id|i
comma
id|sa1100fb_palette_encode
c_func
(paren
id|i
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
)paren
suffix:semicolon
id|sa1100fb_disable_lcd_controller
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|current_par.visual
op_ne
id|FB_VISUAL_TRUECOLOR
)paren
id|sa1100fb_set_cmap
c_func
(paren
op_amp
id|fb_display
(braket
id|current_par.currcon
)braket
dot
id|cmap
comma
l_int|1
comma
id|current_par.currcon
comma
id|info
)paren
suffix:semicolon
id|sa1100fb_enable_lcd_controller
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* TODO: Bitsy support for blanking display */
)brace
multiline_comment|/*&n; *  sa1100fb_switch():       &n; *&t;Change to the specified console.  Palette and video mode&n; *      are changed to the console&squot;s stored parameters. &n; */
r_static
r_int
DECL|function|sa1100fb_switch
id|sa1100fb_switch
c_func
(paren
r_int
id|con
comma
r_struct
id|fb_info
op_star
id|info
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;con=%d info-&gt;modename=%s&bslash;n&quot;
comma
id|con
comma
id|info-&gt;modename
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current_par.visual
op_ne
id|FB_VISUAL_TRUECOLOR
)paren
(brace
r_struct
id|fb_cmap
op_star
id|cmap
suffix:semicolon
r_if
c_cond
(paren
id|current_par.currcon
op_ge
l_int|0
)paren
(brace
singleline_comment|// Get the colormap for the selected console 
id|cmap
op_assign
op_amp
id|fb_display
(braket
id|current_par.currcon
)braket
dot
id|cmap
suffix:semicolon
r_if
c_cond
(paren
id|cmap-&gt;len
)paren
id|fb_get_cmap
c_func
(paren
id|cmap
comma
l_int|1
comma
id|sa1100fb_getcolreg
comma
id|info
)paren
suffix:semicolon
)brace
)brace
id|current_par.currcon
op_assign
id|con
suffix:semicolon
id|fb_display
(braket
id|con
)braket
dot
id|var.activate
op_assign
id|FB_ACTIVATE_NOW
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;fb_display[%d].var.activate=%x&bslash;n&quot;
comma
id|con
comma
id|fb_display
(braket
id|con
)braket
dot
id|var.activate
)paren
suffix:semicolon
id|sa1100fb_set_var
c_func
(paren
op_amp
id|fb_display
(braket
id|con
)braket
dot
id|var
comma
id|con
comma
id|info
)paren
suffix:semicolon
id|current_par.v_palette_base
(braket
l_int|0
)braket
op_assign
(paren
id|current_par.v_palette_base
(braket
l_int|0
)braket
op_amp
l_int|0xcfff
)paren
op_or
id|SA1100_PALETTE_MODE_VAL
c_func
(paren
id|current_par.bits_per_pixel
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sa1100fb_init
r_int
id|__init
id|sa1100fb_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|sa1100fb_init_fbinfo
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize video memory */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|sa1100fb_map_video_memory
c_func
(paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|current_par.montype
template_param
id|NR_MONTYPES
)paren
id|current_par.montype
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|IRQ_LCD
comma
id|sa1100fb_inter_handler
comma
id|SA_INTERRUPT
comma
l_string|&quot;SA1100 LCD&quot;
comma
l_int|NULL
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sa1100fb: failed in request_irq&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;sa1100fb: request_irq succeeded&bslash;n&quot;
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|IRQ_LCD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_assabet
c_func
(paren
)paren
)paren
(brace
id|GPDR
op_or_assign
l_int|0x3fc
suffix:semicolon
id|GAFR
op_or_assign
l_int|0x3fc
suffix:semicolon
id|sa1100fb_assabet_set_truecolor
c_func
(paren
id|current_par.visual
op_eq
id|FB_VISUAL_TRUECOLOR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_bitsy
c_func
(paren
)paren
)paren
(brace
id|GPDR
op_assign
(paren
id|GPIO_LDD15
op_or
id|GPIO_LDD14
op_or
id|GPIO_LDD13
op_or
id|GPIO_LDD12
op_or
id|GPIO_LDD11
op_or
id|GPIO_LDD10
op_or
id|GPIO_LDD9
op_or
id|GPIO_LDD8
)paren
suffix:semicolon
id|GAFR
op_or_assign
(paren
id|GPIO_LDD15
op_or
id|GPIO_LDD14
op_or
id|GPIO_LDD13
op_or
id|GPIO_LDD12
op_or
id|GPIO_LDD11
op_or
id|GPIO_LDD10
op_or
id|GPIO_LDD9
op_or
id|GPIO_LDD8
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_cerf
c_func
(paren
)paren
)paren
(brace
id|GPDR
op_or_assign
l_int|0x3fc
suffix:semicolon
id|GAFR
op_or_assign
l_int|0x3fc
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|machine_is_penny
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef CONFIG_SA1100_PENNY
id|GPDR
op_or_assign
id|GPIO_GPDR_GFX
suffix:semicolon
multiline_comment|/* GPIO Data Direction register for LCD data bits 8-11 */
id|GAFR
op_or_assign
id|GPIO_GAFR_GFX
suffix:semicolon
multiline_comment|/* GPIO Alternate Function register for LCD data bits 8-11 */
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|machine_is_tifon
c_func
(paren
)paren
)paren
(brace
id|GPDR
op_or_assign
id|GPIO_GPIO
c_func
(paren
l_int|24
)paren
suffix:semicolon
multiline_comment|/* set GPIO24 to output */
)brace
r_else
r_if
c_cond
(paren
id|machine_is_xp860
c_func
(paren
)paren
)paren
(brace
id|GPDR
op_or_assign
l_int|0x3fc
suffix:semicolon
id|GAFR
op_or_assign
l_int|0x3fc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sa1100fb_set_var
c_func
(paren
op_amp
id|init_var
comma
op_minus
l_int|1
comma
op_amp
id|fb_info
)paren
)paren
id|current_par.allow_modeset
op_assign
l_int|0
suffix:semicolon
id|sa1100fb_decode_var
c_func
(paren
op_amp
id|init_var
comma
op_amp
id|current_par
)paren
suffix:semicolon
id|register_framebuffer
c_func
(paren
op_amp
id|fb_info
)paren
suffix:semicolon
multiline_comment|/* This driver cannot be unloaded at the moment */
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sa1100fb_setup
r_int
id|__init
id|sa1100fb_setup
c_func
(paren
r_char
op_star
id|options
)paren
(brace
r_char
op_star
id|this_opt
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
op_star
id|options
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|this_opt
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_opt
suffix:semicolon
id|this_opt
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;bpp:&quot;
comma
l_int|4
)paren
)paren
id|current_par.max_bpp
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|4
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;lccr0:&quot;
comma
l_int|6
)paren
)paren
id|lcd_shadow.lccr0
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;lccr1:&quot;
comma
l_int|6
)paren
)paren
(brace
id|lcd_shadow.lccr1
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|current_par.max_xres
op_assign
(paren
id|lcd_shadow.lccr1
op_amp
l_int|0x3ff
)paren
op_plus
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;lccr2:&quot;
comma
l_int|6
)paren
)paren
(brace
id|lcd_shadow.lccr2
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|current_par.max_yres
op_assign
(paren
id|lcd_shadow.lccr0
op_amp
id|LCCR0_SDS
)paren
ques
c_cond
(paren
(paren
id|lcd_shadow.lccr2
op_amp
l_int|0x3ff
)paren
op_plus
l_int|1
)paren
op_star
l_int|2
suffix:colon
(paren
(paren
id|lcd_shadow.lccr2
op_amp
l_int|0x3ff
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|this_opt
comma
l_string|&quot;lccr3:&quot;
comma
l_int|6
)paren
)paren
id|lcd_shadow.lccr3
op_assign
id|simple_strtoul
c_func
(paren
id|this_opt
op_plus
l_int|6
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
