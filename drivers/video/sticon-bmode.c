multiline_comment|/*&n;TPG CVS users: please don&squot;t commit changes to this file directly, send&n;them to prumpf@tux.org and wait for a new version instead.  Otherwise,&n;your changes will get lost when prumpf releases the next version, as&n;this file *will* be replaced with it.  You have been warned.&n;&n;2000-05-30, &lt;deller@gmx.de&gt;&n;*/
macro_line|#if 1
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(x)&t;printk x
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(x)
macro_line|#endif
multiline_comment|/*&n; *  linux/drivers/video/sticon.c  - console driver using HP&squot;s STI firmware&n; *&n; *&t;Copyright (C) 2000 Philipp Rumpf &lt;prumpf@tux.org&gt;&n; *&n; *  Based on linux/drivers/video/vgacon.c and linux/drivers/video/fbcon.c,&n; *  which were&n; *&n; *&t;Created 28 Sep 1997 by Geert Uytterhoeven&n; *&t;Rewritten by Martin Mares &lt;mj@ucw.cz&gt;, July 1998&n; *&t;Copyright (C) 1991, 1992  Linus Torvalds&n; *&t;&t;&t;    1995  Jay Estabrook&n; *&t;Copyright (C) 1995 Geert Uytterhoeven&n; *&t;Copyright (C) 1993 Bjoern Brauel&n; *&t;&t;&t;   Roman Hodek&n; *&t;Copyright (C) 1993 Hamish Macdonald&n; *&t;&t;&t;   Greg Harp&n; *&t;Copyright (C) 1994 David Carter [carter@compsci.bristol.ac.uk]&n; *&n; *&t;      with work by William Rucklidge (wjr@cs.cornell.edu)&n; *&t;&t;&t;   Geert Uytterhoeven&n; *&t;&t;&t;   Jes Sorensen (jds@kom.auc.dk)&n; *&t;&t;&t;   Martin Apel&n; *&t;      with work by Guenther Kelleter&n; *&t;&t;&t;   Martin Schaller&n; *&t;&t;&t;   Andreas Schwab&n; *&t;&t;&t;   Emmanuel Marty (core@ggi-project.org)&n; *&t;&t;&t;   Jakub Jelinek (jj@ultra.linux.cz)&n; *&t;&t;&t;   Martin Mares &lt;mj@ucw.cz&gt;&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file COPYING in the main directory of this archive for&n; *  more details.&n; */
multiline_comment|/*&n; *  TODO:&n; *   - call STI in virtual mode rather than in real mode&n; *   - support for PCI-only STI ROMs (which don&squot;t have a traditional region&n; *     list)&n; *   - safe detection (i.e. verify there is a graphics device at a given&n; *     address first, not just read a random device&squot;s io space)&n; *   - support for multiple STI devices in one machine&n; *   - support for byte-mode STI ROMs&n; *   - support for just using STI to switch to a colour fb (stifb ?)&n; *   - try to make it work on m68k hp workstations ;)&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/real.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fb.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;video/fbcon.h&gt;
macro_line|#include &lt;video/font.h&gt;
macro_line|#include &quot;sti-bmode.h&quot;
multiline_comment|/* The latency of the STI functions cannot really be reduced by setting&n; * this to 0;  STI doesn&squot;t seem to be designed to allow calling a different&n; * function (or the same function with different arguments) after a&n; * function exited with 1 as return value.&n; *&n; * As all of the functions below could be called from interrupt context,&n; * we have to spin_lock_irqsave around the do { ret = bla(); } while(ret==1)&n; * block.  Really bad latency there.&n; *&n; * Probably the best solution to all this is have the generic code manage&n; * the screen buffer and a kernel thread to call STI occasionally.&n; * &n; * Luckily, the frame buffer guys have the same problem so we can just wait&n; * for them to fix it and steal their solution.   prumpf&n; *&n; * Actually, another long-term viable solution is to completely do STI&n; * support in userspace - that way we avoid the potential license issues&n; * of using proprietary fonts, too. */
DECL|macro|STI_WAIT
mdefine_line|#define STI_WAIT 1
DECL|macro|STI_PTR
mdefine_line|#define STI_PTR(p) ( (typeof(p)) virt_to_phys(p))
DECL|macro|PTR_STI
mdefine_line|#define PTR_STI(p) ( (typeof(p)) phys_to_virt((unsigned long)p) )
DECL|variable|default_sti
r_static
r_struct
id|sti_struct
id|default_sti
op_assign
(brace
id|SPIN_LOCK_UNLOCKED
comma
)brace
suffix:semicolon
DECL|variable|default_font_flags
r_static
r_struct
id|sti_font_flags
id|default_font_flags
op_assign
(brace
id|STI_WAIT
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* The colour indices used by STI are&n; *   0 - Black&n; *   1 - White&n; *   2 - Red&n; *   3 - Yellow/Brown&n; *   4 - Green&n; *   5 - Cyan&n; *   6 - Blue&n; *   7 - Magenta&n; *&n; * So we have the same colours as VGA (basically one bit each for R, G, B),&n; * but have to translate them, anyway. */
DECL|variable|col_trans
r_static
id|u8
id|col_trans
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|6
comma
l_int|4
comma
l_int|5
comma
l_int|2
comma
l_int|7
comma
l_int|3
comma
l_int|1
)brace
suffix:semicolon
DECL|macro|c_fg
mdefine_line|#define c_fg(sti, c) col_trans[((c&gt;&gt; 8) &amp; 7)]
DECL|macro|c_bg
mdefine_line|#define c_bg(sti, c) col_trans[((c&gt;&gt;11) &amp; 7)]
DECL|macro|c_index
mdefine_line|#define c_index(sti, c) (c&amp;0xff)
DECL|macro|sti_onscreen_x
mdefine_line|#define sti_onscreen_x(sti) (PTR_STI(sti-&gt;glob_cfg)-&gt;onscreen_x)
DECL|macro|sti_onscreen_y
mdefine_line|#define sti_onscreen_y(sti) (PTR_STI(sti-&gt;glob_cfg)-&gt;onscreen_y)
DECL|macro|sti_font_x
mdefine_line|#define sti_font_x(sti) (STI_U8(PTR_STI(sti-&gt;font)-&gt;width))
DECL|macro|sti_font_y
mdefine_line|#define sti_font_y(sti) (STI_U8(PTR_STI(sti-&gt;font)-&gt;height))
DECL|variable|default_init_flags
r_static
r_struct
id|sti_init_flags
id|default_init_flags
op_assign
(brace
id|STI_WAIT
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|sti_init_graph
r_static
r_void
id|sti_init_graph
c_func
(paren
r_struct
id|sti_struct
op_star
id|sti
)paren
(brace
r_struct
id|sti_init_inptr_ext
id|inptr_ext
op_assign
(brace
l_int|0
comma
(brace
l_int|0
)brace
comma
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|sti_init_inptr
id|inptr
op_assign
(brace
l_int|3
comma
id|STI_PTR
c_func
(paren
op_amp
id|inptr_ext
)paren
)brace
suffix:semicolon
r_struct
id|sti_init_outptr
id|outptr
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|s32
id|ret
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|STI_CALL
c_func
(paren
id|sti-&gt;init_graph
comma
op_amp
id|default_init_flags
comma
op_amp
id|inptr
comma
op_amp
id|outptr
comma
id|sti-&gt;glob_cfg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|sti-&gt;text_planes
op_assign
id|outptr.text_planes
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_struct
id|sti_conf_flags
id|default_conf_flags
op_assign
(brace
id|STI_WAIT
comma
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
r_static
r_void
id|sti_inq_conf
c_func
(paren
r_struct
id|sti_struct
op_star
id|sti
)paren
(brace
r_struct
id|sti_conf_inptr
id|inptr
op_assign
(brace
l_int|NULL
)brace
suffix:semicolon
r_struct
id|sti_conf_outptr_ext
id|outptr_ext
op_assign
(brace
id|future_ptr
suffix:colon
l_int|NULL
)brace
suffix:semicolon
r_struct
id|sti_conf_outptr
id|outptr
op_assign
(brace
id|ext_ptr
suffix:colon
id|STI_PTR
c_func
(paren
op_amp
id|outptr_ext
)paren
)brace
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|s32
id|ret
suffix:semicolon
r_do
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|STI_CALL
c_func
(paren
id|sti-&gt;inq_conf
comma
op_amp
id|default_conf_flags
comma
op_amp
id|inptr
comma
op_amp
id|outptr
comma
id|sti-&gt;glob_cfg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_eq
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|sti_putc
r_static
r_void
id|sti_putc
c_func
(paren
r_struct
id|sti_struct
op_star
id|sti
comma
r_int
id|c
comma
r_int
id|y
comma
r_int
id|x
)paren
(brace
r_struct
id|sti_font_inptr
id|inptr
op_assign
(brace
(paren
id|u32
)paren
id|sti-&gt;font
comma
id|c_index
c_func
(paren
id|sti
comma
id|c
)paren
comma
id|c_fg
c_func
(paren
id|sti
comma
id|c
)paren
comma
id|c_bg
c_func
(paren
id|sti
comma
id|c
)paren
comma
id|x
op_star
id|sti_font_x
c_func
(paren
id|sti
)paren
comma
id|y
op_star
id|sti_font_y
c_func
(paren
id|sti
)paren
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|sti_font_outptr
id|outptr
op_assign
(brace
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
id|s32
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_do
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|STI_CALL
c_func
(paren
id|sti-&gt;font_unpmv
comma
op_amp
id|default_font_flags
comma
op_amp
id|inptr
comma
op_amp
id|outptr
comma
id|sti-&gt;glob_cfg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_eq
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|variable|clear_blkmv_flags
r_static
r_struct
id|sti_blkmv_flags
id|clear_blkmv_flags
op_assign
(brace
id|STI_WAIT
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|sti_set
r_static
r_void
id|sti_set
c_func
(paren
r_struct
id|sti_struct
op_star
id|sti
comma
r_int
id|src_y
comma
r_int
id|src_x
comma
r_int
id|height
comma
r_int
id|width
comma
id|u8
id|color
)paren
(brace
r_struct
id|sti_blkmv_inptr
id|inptr
op_assign
(brace
id|color
comma
id|color
comma
id|src_x
comma
id|src_y
comma
id|src_x
comma
id|src_y
comma
id|width
comma
id|height
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|sti_blkmv_outptr
id|outptr
op_assign
(brace
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
id|s32
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_do
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|STI_CALL
c_func
(paren
id|sti-&gt;block_move
comma
op_amp
id|clear_blkmv_flags
comma
op_amp
id|inptr
comma
op_amp
id|outptr
comma
id|sti-&gt;glob_cfg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_eq
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|sti_clear
r_static
r_void
id|sti_clear
c_func
(paren
r_struct
id|sti_struct
op_star
id|sti
comma
r_int
id|src_y
comma
r_int
id|src_x
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_struct
id|sti_blkmv_inptr
id|inptr
op_assign
(brace
l_int|0
comma
l_int|0
comma
id|src_x
op_star
id|sti_font_x
c_func
(paren
id|sti
)paren
comma
id|src_y
op_star
id|sti_font_y
c_func
(paren
id|sti
)paren
comma
id|src_x
op_star
id|sti_font_x
c_func
(paren
id|sti
)paren
comma
id|src_y
op_star
id|sti_font_y
c_func
(paren
id|sti
)paren
comma
id|width
op_star
id|sti_font_x
c_func
(paren
id|sti
)paren
comma
id|height
op_star
id|sti_font_y
c_func
(paren
id|sti
)paren
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|sti_blkmv_outptr
id|outptr
op_assign
(brace
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
id|s32
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_do
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|STI_CALL
c_func
(paren
id|sti-&gt;block_move
comma
op_amp
id|clear_blkmv_flags
comma
op_amp
id|inptr
comma
op_amp
id|outptr
comma
id|sti-&gt;glob_cfg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_eq
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|variable|default_blkmv_flags
r_static
r_struct
id|sti_blkmv_flags
id|default_blkmv_flags
op_assign
(brace
id|STI_WAIT
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|sti_bmove
r_static
r_void
id|sti_bmove
c_func
(paren
r_struct
id|sti_struct
op_star
id|sti
comma
r_int
id|src_y
comma
r_int
id|src_x
comma
r_int
id|dst_y
comma
r_int
id|dst_x
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_struct
id|sti_blkmv_inptr
id|inptr
op_assign
(brace
l_int|0
comma
l_int|0
comma
id|src_x
op_star
id|sti_font_x
c_func
(paren
id|sti
)paren
comma
id|src_y
op_star
id|sti_font_y
c_func
(paren
id|sti
)paren
comma
id|dst_x
op_star
id|sti_font_x
c_func
(paren
id|sti
)paren
comma
id|dst_y
op_star
id|sti_font_y
c_func
(paren
id|sti
)paren
comma
id|width
op_star
id|sti_font_x
c_func
(paren
id|sti
)paren
comma
id|height
op_star
id|sti_font_y
c_func
(paren
id|sti
)paren
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|sti_blkmv_outptr
id|outptr
op_assign
(brace
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
id|s32
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_do
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|STI_CALL
c_func
(paren
id|sti-&gt;block_move
comma
op_amp
id|default_blkmv_flags
comma
op_amp
id|inptr
comma
op_amp
id|outptr
comma
id|sti-&gt;glob_cfg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sti-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_eq
l_int|1
)paren
(brace
suffix:semicolon
)brace
)brace
multiline_comment|/* STICON */
DECL|function|sticon_startup
r_static
r_const
r_char
id|__init
op_star
id|sticon_startup
c_func
(paren
r_void
)paren
(brace
r_return
l_string|&quot;STI console&quot;
suffix:semicolon
)brace
DECL|function|sticon_set_palette
r_static
r_int
id|sticon_set_palette
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
r_char
op_star
id|table
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|sticon_font_op
r_static
r_int
id|sticon_font_op
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_struct
id|console_font_op
op_star
id|op
)paren
(brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
DECL|function|sticon_putc
r_static
r_void
id|sticon_putc
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|c
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
(brace
id|sti_putc
c_func
(paren
op_amp
id|default_sti
comma
id|c
comma
id|ypos
comma
id|xpos
)paren
suffix:semicolon
)brace
DECL|function|sticon_putcs
r_static
r_void
id|sticon_putcs
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_const
r_int
r_int
op_star
id|s
comma
r_int
id|count
comma
r_int
id|ypos
comma
r_int
id|xpos
)paren
(brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
(brace
id|sti_putc
c_func
(paren
op_amp
id|default_sti
comma
op_star
id|s
op_increment
comma
id|ypos
comma
id|xpos
op_increment
)paren
suffix:semicolon
)brace
)brace
DECL|function|sticon_cursor
r_static
r_void
id|sticon_cursor
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|mode
)paren
(brace
)brace
DECL|function|sticon_scroll
r_static
r_int
id|sticon_scroll
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|t
comma
r_int
id|b
comma
r_int
id|dir
comma
r_int
id|count
)paren
(brace
r_struct
id|sti_struct
op_star
id|sti
op_assign
op_amp
id|default_sti
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|sticon_cursor
c_func
(paren
id|conp
comma
id|CM_ERASE
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dir
)paren
(brace
r_case
id|SM_UP
suffix:colon
id|sti_bmove
c_func
(paren
id|sti
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|t
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|sti_clear
c_func
(paren
id|sti
comma
id|b
op_minus
id|count
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SM_DOWN
suffix:colon
id|sti_bmove
c_func
(paren
id|sti
comma
id|t
comma
l_int|0
comma
id|t
op_plus
id|count
comma
l_int|0
comma
id|b
op_minus
id|t
op_minus
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
id|sti_clear
c_func
(paren
id|sti
comma
id|t
comma
l_int|0
comma
id|count
comma
id|conp-&gt;vc_cols
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sticon_bmove
r_static
r_void
id|sticon_bmove
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|dy
comma
r_int
id|dx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
id|sti_bmove
c_func
(paren
op_amp
id|default_sti
comma
id|sy
comma
id|sx
comma
id|dy
comma
id|dx
comma
id|height
comma
id|width
)paren
suffix:semicolon
)brace
DECL|function|sticon_init
r_static
r_void
id|sticon_init
c_func
(paren
r_struct
id|vc_data
op_star
id|c
comma
r_int
id|init
)paren
(brace
r_struct
id|sti_struct
op_star
id|sti
op_assign
op_amp
id|default_sti
suffix:semicolon
r_int
id|vc_cols
comma
id|vc_rows
suffix:semicolon
id|sti_set
c_func
(paren
id|sti
comma
l_int|0
comma
l_int|0
comma
id|sti_onscreen_y
c_func
(paren
id|sti
)paren
comma
id|sti_onscreen_x
c_func
(paren
id|sti
)paren
comma
l_int|0
)paren
suffix:semicolon
id|c-&gt;vc_can_do_color
op_assign
l_int|1
suffix:semicolon
id|vc_cols
op_assign
id|PTR_STI
c_func
(paren
id|sti-&gt;glob_cfg
)paren
op_member_access_from_pointer
id|onscreen_x
op_div
id|sti_font_x
c_func
(paren
id|sti
)paren
suffix:semicolon
id|vc_rows
op_assign
id|PTR_STI
c_func
(paren
id|sti-&gt;glob_cfg
)paren
op_member_access_from_pointer
id|onscreen_y
op_div
id|sti_font_y
c_func
(paren
id|sti
)paren
suffix:semicolon
id|vc_resize_con
c_func
(paren
id|vc_rows
comma
id|vc_cols
comma
id|c-&gt;vc_num
)paren
suffix:semicolon
)brace
DECL|function|sticon_deinit
r_static
r_void
id|sticon_deinit
c_func
(paren
r_struct
id|vc_data
op_star
id|c
)paren
(brace
)brace
DECL|function|sticon_clear
r_static
r_void
id|sticon_clear
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|sy
comma
r_int
id|sx
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
id|sti_clear
c_func
(paren
op_amp
id|default_sti
comma
id|sy
comma
id|sx
comma
id|height
comma
id|width
)paren
suffix:semicolon
)brace
DECL|function|sticon_switch
r_static
r_int
id|sticon_switch
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sticon_blank
r_static
r_int
id|sticon_blank
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|blank
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sticon_scrolldelta
r_static
r_int
id|sticon_scrolldelta
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|lines
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sticon_set_origin
r_static
r_int
id|sticon_set_origin
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sticon_screen_pos
r_static
id|u16
op_star
id|sticon_screen_pos
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
id|offset
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|sticon_getxy
r_static
r_int
r_int
id|sticon_getxy
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
r_int
r_int
id|pos
comma
r_int
op_star
id|px
comma
r_int
op_star
id|py
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sticon_build_attr
r_static
id|u8
id|sticon_build_attr
c_func
(paren
r_struct
id|vc_data
op_star
id|conp
comma
id|u8
id|color
comma
id|u8
id|intens
comma
id|u8
id|blink
comma
id|u8
id|underline
comma
id|u8
id|reverse
)paren
(brace
id|u8
id|attr
op_assign
(paren
(paren
id|color
op_amp
l_int|0x70
)paren
op_rshift
l_int|1
)paren
op_or
(paren
(paren
id|color
op_amp
l_int|7
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reverse
)paren
(brace
id|color
op_assign
(paren
(paren
id|color
op_rshift
l_int|3
)paren
op_amp
l_int|0x7
)paren
op_or
(paren
(paren
id|color
op_amp
l_int|0x7
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
)brace
r_return
id|attr
suffix:semicolon
)brace
DECL|variable|sti_con
r_static
r_struct
id|consw
id|sti_con
op_assign
(brace
id|con_startup
suffix:colon
id|sticon_startup
comma
id|con_init
suffix:colon
id|sticon_init
comma
id|con_deinit
suffix:colon
id|sticon_deinit
comma
id|con_clear
suffix:colon
id|sticon_clear
comma
id|con_putc
suffix:colon
id|sticon_putc
comma
id|con_putcs
suffix:colon
id|sticon_putcs
comma
id|con_cursor
suffix:colon
id|sticon_cursor
comma
id|con_scroll
suffix:colon
id|sticon_scroll
comma
id|con_bmove
suffix:colon
id|sticon_bmove
comma
id|con_switch
suffix:colon
id|sticon_switch
comma
id|con_blank
suffix:colon
id|sticon_blank
comma
id|con_font_op
suffix:colon
id|sticon_font_op
comma
id|con_set_palette
suffix:colon
id|sticon_set_palette
comma
id|con_scrolldelta
suffix:colon
id|sticon_scrolldelta
comma
id|con_set_origin
suffix:colon
id|sticon_set_origin
comma
id|con_save_screen
suffix:colon
l_int|NULL
comma
id|con_build_attr
suffix:colon
id|sticon_build_attr
comma
id|con_invert_region
suffix:colon
l_int|NULL
comma
id|con_screen_pos
suffix:colon
id|sticon_screen_pos
comma
id|con_getxy
suffix:colon
id|sticon_getxy
comma
)brace
suffix:semicolon
macro_line|#include &lt;asm/pgalloc.h&gt;&t;/* need cache flush routines */
DECL|function|sti_rom_copy
r_static
r_void
id|__init
id|sti_rom_copy
c_func
(paren
r_int
r_int
id|base
comma
r_int
r_int
id|offset
comma
r_int
r_int
id|count
comma
r_void
op_star
id|dest
)paren
(brace
r_void
op_star
id|savedest
op_assign
id|dest
suffix:semicolon
r_int
id|savecount
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|count
op_ge
l_int|4
)paren
(brace
id|count
op_sub_assign
l_int|4
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
id|dest
op_assign
id|gsc_readl
c_func
(paren
id|base
op_plus
id|offset
)paren
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;%08x&bslash;n&quot;
comma
op_star
(paren
id|u32
op_star
)paren
id|dest
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|u32
op_star
)paren
id|dest
op_eq
l_int|0x64646464
)paren
(brace
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;!!!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
(brace
id|u32
id|foo
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|foo
op_add_assign
l_int|0x100
)paren
(brace
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
id|offset
op_add_assign
l_int|4
suffix:semicolon
id|dest
op_add_assign
l_int|4
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
op_star
(paren
id|u8
op_star
)paren
id|dest
op_assign
id|gsc_readb
c_func
(paren
id|base
op_plus
id|offset
)paren
suffix:semicolon
id|offset
op_increment
suffix:semicolon
id|dest
op_increment
suffix:semicolon
)brace
id|__flush_dcache_range
c_func
(paren
id|dest
comma
id|count
)paren
suffix:semicolon
id|__flush_icache_range
c_func
(paren
id|dest
comma
id|count
)paren
suffix:semicolon
)brace
DECL|function|dump_sti_rom
r_static
r_void
id|dump_sti_rom
c_func
(paren
r_struct
id|sti_rom
op_star
id|rom
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STI byte mode ROM type %d&bslash;n&quot;
comma
id|STI_U8
c_func
(paren
id|rom-&gt;type
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; supports %d monitors&bslash;n&quot;
comma
id|STI_U8
c_func
(paren
id|rom-&gt;num_mons
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; conforms to STI ROM spec revision %d.%02x&bslash;n&quot;
comma
id|STI_U8
c_func
(paren
id|rom-&gt;revno
(braket
l_int|0
)braket
)paren
op_rshift
l_int|4
comma
id|STI_U8
c_func
(paren
id|rom-&gt;revno
(braket
l_int|0
)braket
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; graphics id %02x%02x%02x%02x%02x%02x%02x%02x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|STI_U8
c_func
(paren
id|rom-&gt;graphics_id
(braket
l_int|0
)braket
)paren
comma
(paren
r_int
r_int
)paren
id|STI_U8
c_func
(paren
id|rom-&gt;graphics_id
(braket
l_int|1
)braket
)paren
comma
(paren
r_int
r_int
)paren
id|STI_U8
c_func
(paren
id|rom-&gt;graphics_id
(braket
l_int|2
)braket
)paren
comma
(paren
r_int
r_int
)paren
id|STI_U8
c_func
(paren
id|rom-&gt;graphics_id
(braket
l_int|3
)braket
)paren
comma
(paren
r_int
r_int
)paren
id|STI_U8
c_func
(paren
id|rom-&gt;graphics_id
(braket
l_int|4
)braket
)paren
comma
(paren
r_int
r_int
)paren
id|STI_U8
c_func
(paren
id|rom-&gt;graphics_id
(braket
l_int|5
)braket
)paren
comma
(paren
r_int
r_int
)paren
id|STI_U8
c_func
(paren
id|rom-&gt;graphics_id
(braket
l_int|6
)braket
)paren
comma
(paren
r_int
r_int
)paren
id|STI_U8
c_func
(paren
id|rom-&gt;graphics_id
(braket
l_int|7
)braket
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; font start %08x&bslash;n&quot;
comma
id|STI_U32
c_func
(paren
id|rom-&gt;font_start
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; region list %08x&bslash;n&quot;
comma
id|STI_U32
c_func
(paren
id|rom-&gt;region_list
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; init_graph %08x&bslash;n&quot;
comma
id|STI_U32
c_func
(paren
id|rom-&gt;init_graph
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; alternate code type %d&bslash;n&quot;
comma
id|STI_U8
c_func
(paren
id|rom-&gt;alt_code_type
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: %d&bslash;n&quot;
comma
id|__LINE__
)paren
suffix:semicolon
)brace
DECL|function|sti_cook_fonts
r_static
r_void
id|__init
id|sti_cook_fonts
c_func
(paren
r_struct
id|sti_cooked_rom
op_star
id|cooked_rom
comma
r_struct
id|sti_rom
op_star
id|raw_rom
)paren
(brace
r_struct
id|sti_rom_font
op_star
id|raw_font
suffix:semicolon
r_struct
id|sti_cooked_font
op_star
id|cooked_font
suffix:semicolon
r_struct
id|sti_rom_font
op_star
id|font_start
suffix:semicolon
id|cooked_font
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|cooked_font
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cooked_font
)paren
(brace
r_return
suffix:semicolon
)brace
id|cooked_rom-&gt;font_start
op_assign
id|cooked_font
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;%p = %p + %08x&bslash;n&quot;
comma
(paren
(paren
r_void
op_star
)paren
id|raw_rom
)paren
op_plus
(paren
id|STI_U32
c_func
(paren
id|raw_rom-&gt;font_start
)paren
)paren
comma
(paren
(paren
r_void
op_star
)paren
id|raw_rom
)paren
comma
(paren
id|STI_U32
c_func
(paren
id|raw_rom-&gt;font_start
)paren
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|raw_font
op_assign
(paren
(paren
r_void
op_star
)paren
id|raw_rom
)paren
op_plus
id|STI_U32
c_func
(paren
id|raw_rom-&gt;font_start
)paren
op_minus
l_int|3
suffix:semicolon
id|font_start
op_assign
id|raw_font
suffix:semicolon
id|cooked_font-&gt;raw
op_assign
id|raw_font
suffix:semicolon
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;next font %08x&bslash;n&quot;
comma
id|STI_U32
c_func
(paren
id|raw_font-&gt;next_font
)paren
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|0
op_logical_and
id|STI_U32
c_func
(paren
id|raw_font-&gt;next_font
)paren
)paren
(brace
id|raw_font
op_assign
(paren
(paren
r_void
op_star
)paren
id|font_start
)paren
op_plus
id|STI_U32
c_func
(paren
id|raw_font-&gt;next_font
)paren
suffix:semicolon
id|cooked_font-&gt;next_font
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|cooked_font
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cooked_font-&gt;next_font
)paren
(brace
r_return
suffix:semicolon
)brace
id|cooked_font
op_assign
id|cooked_font-&gt;next_font
suffix:semicolon
singleline_comment|//&t;&t;cooked_font-&gt;raw = raw_font;
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;raw_font %p&bslash;n&quot;
comma
id|raw_font
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;next_font %08x %p&bslash;n&quot;
comma
id|STI_U32
c_func
(paren
id|raw_font-&gt;next_font
)paren
comma
(paren
(paren
r_void
op_star
)paren
id|font_start
)paren
op_plus
id|STI_U32
c_func
(paren
id|raw_font-&gt;next_font
)paren
)paren
)paren
suffix:semicolon
)brace
id|cooked_font-&gt;next_font
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|sti_cook_function
r_static
r_int
r_int
id|__init
id|sti_cook_function
c_func
(paren
r_void
op_star
id|function
comma
id|u32
id|size
)paren
(brace
id|sti_u32
op_star
id|func
op_assign
(paren
id|sti_u32
op_star
)paren
id|function
suffix:semicolon
id|u32
op_star
id|ret
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ret
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|__FILE__
l_string|&quot;: could not get memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|size
op_div
l_int|4
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
(braket
id|i
)braket
op_assign
id|STI_U32
c_func
(paren
id|func
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|flush_all_caches
c_func
(paren
)paren
suffix:semicolon
r_return
id|virt_to_phys
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|variable|font_index
DECL|variable|font_height
DECL|variable|font_width
r_static
r_int
id|font_index
comma
id|font_height
comma
id|font_width
suffix:semicolon
DECL|function|sti_search_font
r_static
r_int
id|__init
id|sti_search_font
c_func
(paren
r_struct
id|sti_cooked_rom
op_star
id|rom
comma
r_int
id|height
comma
r_int
id|width
)paren
(brace
r_struct
id|sti_cooked_font
op_star
id|font
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|font
op_assign
id|rom-&gt;font_start
suffix:semicolon
id|font
suffix:semicolon
id|font
op_assign
id|font-&gt;next_font
comma
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|STI_U8
c_func
(paren
id|font-&gt;raw-&gt;width
)paren
op_eq
id|width
)paren
op_logical_and
(paren
id|STI_U8
c_func
(paren
id|font-&gt;raw-&gt;height
)paren
op_eq
id|height
)paren
)paren
(brace
r_return
id|i
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|sti_cooked_font
op_star
id|__init
DECL|function|sti_select_font
id|sti_select_font
c_func
(paren
r_struct
id|sti_cooked_rom
op_star
id|rom
)paren
(brace
r_struct
id|sti_cooked_font
op_star
id|font
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|font_width
op_logical_and
id|font_height
)paren
(brace
id|font_index
op_assign
id|sti_search_font
c_func
(paren
id|rom
comma
id|font_height
comma
id|font_width
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|font
op_assign
id|rom-&gt;font_start
comma
id|i
op_assign
id|font_index
suffix:semicolon
id|font
op_logical_and
(paren
id|i
OG
l_int|0
)paren
suffix:semicolon
id|font
op_assign
id|font-&gt;next_font
comma
id|i
op_decrement
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|font
)paren
(brace
r_return
id|font
suffix:semicolon
)brace
r_else
r_return
id|rom-&gt;font_start
suffix:semicolon
)brace
multiline_comment|/* address is a pointer to a word mode or pci rom */
DECL|function|sti_read_rom
r_static
r_struct
id|sti_struct
op_star
id|__init
id|sti_read_rom
c_func
(paren
r_int
r_int
id|address
)paren
(brace
r_struct
id|sti_struct
op_star
id|ret
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sti_cooked_rom
op_star
id|cooked
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sti_rom
op_star
id|raw
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|ret
op_assign
op_amp
id|default_sti
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_goto
id|out_err
suffix:semicolon
)brace
id|cooked
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|cooked
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|raw
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|raw
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|raw
op_logical_and
id|cooked
)paren
)paren
(brace
r_goto
id|out_err
suffix:semicolon
)brace
multiline_comment|/* reallocate raw */
id|sti_rom_copy
c_func
(paren
id|address
comma
l_int|0
comma
r_sizeof
op_star
id|raw
comma
id|raw
)paren
suffix:semicolon
id|dump_sti_rom
c_func
(paren
id|raw
)paren
suffix:semicolon
id|size
op_assign
id|STI_U32
c_func
(paren
id|raw-&gt;last_addr
)paren
op_plus
l_int|1
suffix:semicolon
id|size
op_assign
l_int|128
op_star
l_int|1024
suffix:semicolon
singleline_comment|//&t;DPRINTK((&quot;size %08lx&bslash;n&quot;, size));
singleline_comment|//&t;DPRINTK((&quot;font_start %08x&bslash;n&quot;, STI_U32(raw-&gt;font_start)));
singleline_comment|//&t;kfree(raw);
id|raw
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|raw
)paren
(brace
r_goto
id|out_err
suffix:semicolon
)brace
id|sti_rom_copy
c_func
(paren
id|address
comma
l_int|0
comma
id|size
op_minus
l_int|1
comma
id|raw
)paren
suffix:semicolon
id|sti_cook_fonts
c_func
(paren
id|cooked
comma
id|raw
)paren
suffix:semicolon
singleline_comment|//&t;sti_cook_regions(cooked, raw);
singleline_comment|//&t;sti_cook_functions(cooked, raw);
r_if
c_cond
(paren
id|STI_U32
c_func
(paren
id|raw-&gt;region_list
)paren
)paren
(brace
r_struct
id|sti_rom_region
op_star
id|region
op_assign
(paren
(paren
r_void
op_star
)paren
id|raw
)paren
op_plus
id|STI_U32
c_func
(paren
id|raw-&gt;region_list
)paren
op_minus
l_int|3
suffix:semicolon
singleline_comment|//&t;&t;DPRINTK((&quot;region_list %08x&bslash;n&quot;, STI_U32(raw-&gt;region_list)));
id|ret-&gt;regions
op_assign
id|kmalloc
c_func
(paren
l_int|32
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* FIXME!! */
id|ret-&gt;regions
(braket
l_int|0
)braket
op_assign
id|STI_U32
c_func
(paren
id|region
(braket
l_int|0
)braket
dot
id|region
)paren
suffix:semicolon
id|ret-&gt;regions
(braket
l_int|1
)braket
op_assign
id|STI_U32
c_func
(paren
id|region
(braket
l_int|1
)braket
dot
id|region
)paren
suffix:semicolon
id|ret-&gt;regions
(braket
l_int|2
)braket
op_assign
id|STI_U32
c_func
(paren
id|region
(braket
l_int|2
)braket
dot
id|region
)paren
suffix:semicolon
id|ret-&gt;regions
(braket
l_int|3
)braket
op_assign
id|STI_U32
c_func
(paren
id|region
(braket
l_int|3
)braket
dot
id|region
)paren
suffix:semicolon
id|ret-&gt;regions
(braket
l_int|4
)braket
op_assign
id|STI_U32
c_func
(paren
id|region
(braket
l_int|4
)braket
dot
id|region
)paren
suffix:semicolon
id|ret-&gt;regions
(braket
l_int|5
)braket
op_assign
id|STI_U32
c_func
(paren
id|region
(braket
l_int|5
)braket
dot
id|region
)paren
suffix:semicolon
id|ret-&gt;regions
(braket
l_int|6
)braket
op_assign
id|STI_U32
c_func
(paren
id|region
(braket
l_int|6
)braket
dot
id|region
)paren
suffix:semicolon
id|ret-&gt;regions
(braket
l_int|7
)braket
op_assign
id|STI_U32
c_func
(paren
id|region
(braket
l_int|7
)braket
dot
id|region
)paren
suffix:semicolon
)brace
id|address
op_assign
id|virt_to_phys
c_func
(paren
id|raw
)paren
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;init_graph %08x %08x&bslash;n&quot;
l_string|&quot;state_mgmt %08x %08x&bslash;n&quot;
l_string|&quot;font_unpmv %08x %08x&bslash;n&quot;
l_string|&quot;block_move %08x %08x&bslash;n&quot;
l_string|&quot;self_test  %08x %08x&bslash;n&quot;
l_string|&quot;excep_hdlr %08x %08x&bslash;n&quot;
l_string|&quot;irq_conf   %08x %08x&bslash;n&quot;
l_string|&quot;set_cm_e   %08x %08x&bslash;n&quot;
l_string|&quot;dma_ctrl   %08x %08x&bslash;n&quot;
l_string|&quot;flow_ctrl  %08x %08x&bslash;n&quot;
l_string|&quot;user_timin %08x %08x&bslash;n&quot;
l_string|&quot;process_m  %08x %08x&bslash;n&quot;
l_string|&quot;sti_util   %08x %08x&bslash;n&quot;
l_string|&quot;end_addr   %08x %08x&bslash;n&quot;
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;state_mgmt
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;state_mgmt_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;font_unpmv
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;font_unpmv_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;block_move
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;block_move_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;self_test
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;self_test_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;excep_hdlr
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;excep_hdlr_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph_m68k
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;end_addr
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;end_addr_m68k
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|ret-&gt;init_graph
op_assign
id|sti_cook_function
c_func
(paren
(paren
(paren
r_void
op_star
)paren
id|raw
)paren
op_plus
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
op_minus
l_int|3
comma
(paren
id|STI_U32
c_func
(paren
id|raw-&gt;state_mgmt
)paren
op_minus
id|STI_U32
c_func
(paren
id|raw-&gt;init_graph
)paren
)paren
op_div
l_int|4
)paren
suffix:semicolon
id|ret-&gt;font_unpmv
op_assign
id|sti_cook_function
c_func
(paren
(paren
(paren
r_void
op_star
)paren
id|raw
)paren
op_plus
id|STI_U32
c_func
(paren
id|raw-&gt;font_unpmv
)paren
op_minus
l_int|3
comma
(paren
id|STI_U32
c_func
(paren
id|raw-&gt;block_move
)paren
op_minus
id|STI_U32
c_func
(paren
id|raw-&gt;font_unpmv
)paren
)paren
op_div
l_int|4
)paren
suffix:semicolon
id|ret-&gt;block_move
op_assign
id|sti_cook_function
c_func
(paren
(paren
(paren
r_void
op_star
)paren
id|raw
)paren
op_plus
id|STI_U32
c_func
(paren
id|raw-&gt;block_move
)paren
op_minus
l_int|3
comma
(paren
id|STI_U32
c_func
(paren
id|raw-&gt;self_test
)paren
op_minus
id|STI_U32
c_func
(paren
id|raw-&gt;block_move
)paren
)paren
op_div
l_int|4
)paren
suffix:semicolon
id|ret-&gt;inq_conf
op_assign
id|sti_cook_function
c_func
(paren
(paren
(paren
r_void
op_star
)paren
id|raw
)paren
op_plus
id|STI_U32
c_func
(paren
id|raw-&gt;inq_conf
)paren
comma
id|STI_U32
c_func
(paren
id|raw-&gt;set_cm_entry
)paren
op_minus
id|STI_U32
c_func
(paren
id|raw-&gt;inq_conf
)paren
)paren
suffix:semicolon
id|ret-&gt;rom
op_assign
id|cooked
suffix:semicolon
id|ret-&gt;rom-&gt;raw
op_assign
id|raw
suffix:semicolon
id|ret-&gt;font
op_assign
(paren
r_struct
id|sti_rom_font
op_star
)paren
id|virt_to_phys
c_func
(paren
id|sti_select_font
c_func
(paren
id|ret-&gt;rom
)paren
op_member_access_from_pointer
id|raw
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|raw
)paren
(brace
id|kfree
c_func
(paren
id|raw
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cooked
)paren
(brace
id|kfree
c_func
(paren
id|cooked
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|dump_globcfg_ext
c_func
(paren
r_struct
id|sti_glob_cfg_ext
op_star
id|cfg
)paren
(brace
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;monitor %d&bslash;n&quot;
l_string|&quot;in friendly mode: %d&bslash;n&quot;
l_string|&quot;power consumption %d watts&bslash;n&quot;
l_string|&quot;freq ref %d&bslash;n&quot;
l_string|&quot;sti_mem_addr %p&bslash;n&quot;
comma
id|cfg-&gt;curr_mon
comma
id|cfg-&gt;friendly_boot
comma
id|cfg-&gt;power
comma
id|cfg-&gt;freq_ref
comma
id|cfg-&gt;sti_mem_addr
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
id|dump_globcfg
c_func
(paren
r_struct
id|sti_glob_cfg
op_star
id|glob_cfg
)paren
(brace
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;%d text planes&bslash;n&quot;
l_string|&quot;%4d x %4d screen resolution&bslash;n&quot;
l_string|&quot;%4d x %4d offscreen&bslash;n&quot;
l_string|&quot;%4d x %4d layout&bslash;n&quot;
l_string|&quot;regions at %08x %08x %08x %08x&bslash;n&quot;
l_string|&quot;regions at %08x %08x %08x %08x&bslash;n&quot;
l_string|&quot;reent_lvl %d&bslash;n&quot;
l_string|&quot;save_addr %p&bslash;n&quot;
comma
id|glob_cfg-&gt;text_planes
comma
id|glob_cfg-&gt;onscreen_x
comma
id|glob_cfg-&gt;onscreen_y
comma
id|glob_cfg-&gt;offscreen_x
comma
id|glob_cfg-&gt;offscreen_y
comma
id|glob_cfg-&gt;total_x
comma
id|glob_cfg-&gt;total_y
comma
id|glob_cfg-&gt;region_ptrs
(braket
l_int|0
)braket
comma
id|glob_cfg-&gt;region_ptrs
(braket
l_int|1
)braket
comma
id|glob_cfg-&gt;region_ptrs
(braket
l_int|2
)braket
comma
id|glob_cfg-&gt;region_ptrs
(braket
l_int|3
)braket
comma
id|glob_cfg-&gt;region_ptrs
(braket
l_int|4
)braket
comma
id|glob_cfg-&gt;region_ptrs
(braket
l_int|5
)braket
comma
id|glob_cfg-&gt;region_ptrs
(braket
l_int|6
)braket
comma
id|glob_cfg-&gt;region_ptrs
(braket
l_int|7
)braket
comma
id|glob_cfg-&gt;reent_lvl
comma
id|glob_cfg-&gt;save_addr
)paren
)paren
suffix:semicolon
id|dump_globcfg_ext
c_func
(paren
id|PTR_STI
c_func
(paren
id|glob_cfg-&gt;ext_ptr
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|sti_init_glob_cfg
r_static
r_void
id|__init
id|sti_init_glob_cfg
c_func
(paren
r_struct
id|sti_struct
op_star
id|sti
comma
r_int
r_int
id|hpa
comma
r_int
r_int
id|rom_address
)paren
(brace
r_struct
id|sti_glob_cfg
op_star
id|glob_cfg
suffix:semicolon
r_struct
id|sti_glob_cfg_ext
op_star
id|glob_cfg_ext
suffix:semicolon
r_void
op_star
id|save_addr
suffix:semicolon
r_void
op_star
id|sti_mem_addr
suffix:semicolon
id|glob_cfg
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|sti-&gt;glob_cfg
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|glob_cfg_ext
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|glob_cfg_ext
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|save_addr
op_assign
id|kmalloc
c_func
(paren
l_int|1024
multiline_comment|/*XXX*/
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sti_mem_addr
op_assign
id|kmalloc
c_func
(paren
l_int|1024
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|glob_cfg
)paren
op_logical_or
(paren
op_logical_neg
id|glob_cfg_ext
)paren
op_logical_or
(paren
op_logical_neg
id|save_addr
)paren
op_logical_or
(paren
op_logical_neg
id|sti_mem_addr
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|glob_cfg
comma
l_int|0
comma
r_sizeof
op_star
id|glob_cfg
)paren
suffix:semicolon
id|memset
c_func
(paren
id|glob_cfg_ext
comma
l_int|0
comma
r_sizeof
op_star
id|glob_cfg_ext
)paren
suffix:semicolon
id|memset
c_func
(paren
id|save_addr
comma
l_int|0
comma
l_int|1024
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sti_mem_addr
comma
l_int|0
comma
l_int|1024
)paren
suffix:semicolon
id|glob_cfg-&gt;ext_ptr
op_assign
id|STI_PTR
c_func
(paren
id|glob_cfg_ext
)paren
suffix:semicolon
id|glob_cfg-&gt;save_addr
op_assign
id|STI_PTR
c_func
(paren
id|save_addr
)paren
suffix:semicolon
id|glob_cfg-&gt;region_ptrs
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|sti-&gt;regions
(braket
l_int|0
)braket
op_rshift
l_int|18
)paren
op_lshift
l_int|12
)paren
op_plus
id|rom_address
suffix:semicolon
id|glob_cfg-&gt;region_ptrs
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|sti-&gt;regions
(braket
l_int|1
)braket
op_rshift
l_int|18
)paren
op_lshift
l_int|12
)paren
op_plus
id|hpa
suffix:semicolon
id|glob_cfg-&gt;region_ptrs
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|sti-&gt;regions
(braket
l_int|2
)braket
op_rshift
l_int|18
)paren
op_lshift
l_int|12
)paren
op_plus
id|hpa
suffix:semicolon
id|glob_cfg-&gt;region_ptrs
(braket
l_int|3
)braket
op_assign
(paren
(paren
id|sti-&gt;regions
(braket
l_int|3
)braket
op_rshift
l_int|18
)paren
op_lshift
l_int|12
)paren
op_plus
id|hpa
suffix:semicolon
id|glob_cfg-&gt;region_ptrs
(braket
l_int|4
)braket
op_assign
(paren
(paren
id|sti-&gt;regions
(braket
l_int|4
)braket
op_rshift
l_int|18
)paren
op_lshift
l_int|12
)paren
op_plus
id|hpa
suffix:semicolon
id|glob_cfg-&gt;region_ptrs
(braket
l_int|5
)braket
op_assign
(paren
(paren
id|sti-&gt;regions
(braket
l_int|5
)braket
op_rshift
l_int|18
)paren
op_lshift
l_int|12
)paren
op_plus
id|hpa
suffix:semicolon
id|glob_cfg-&gt;region_ptrs
(braket
l_int|6
)braket
op_assign
(paren
(paren
id|sti-&gt;regions
(braket
l_int|6
)braket
op_rshift
l_int|18
)paren
op_lshift
l_int|12
)paren
op_plus
id|hpa
suffix:semicolon
id|glob_cfg-&gt;region_ptrs
(braket
l_int|7
)braket
op_assign
(paren
(paren
id|sti-&gt;regions
(braket
l_int|7
)braket
op_rshift
l_int|18
)paren
op_lshift
l_int|12
)paren
op_plus
id|hpa
suffix:semicolon
id|glob_cfg_ext-&gt;sti_mem_addr
op_assign
id|STI_PTR
c_func
(paren
id|sti_mem_addr
)paren
suffix:semicolon
id|sti-&gt;glob_cfg
op_assign
id|STI_PTR
c_func
(paren
id|glob_cfg
)paren
suffix:semicolon
)brace
DECL|function|sti_try_rom
r_static
r_void
id|__init
id|sti_try_rom
c_func
(paren
r_int
r_int
id|address
comma
r_int
r_int
id|hpa
)paren
(brace
r_struct
id|sti_struct
op_star
id|sti
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|sig
suffix:semicolon
multiline_comment|/* if we can&squot;t read the ROM, bail out early.  Not being able&n;&t; * to read the hpa is okay, for romless sti */
r_if
c_cond
(paren
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
id|address
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;found potential STI ROM at %08lx&bslash;n&quot;
comma
id|address
)paren
suffix:semicolon
id|sig
op_assign
id|le16_to_cpu
c_func
(paren
id|gsc_readw
c_func
(paren
id|address
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sig
op_amp
l_int|0xff
)paren
op_eq
l_int|0x01
)paren
(brace
id|sti
op_assign
id|sti_read_rom
c_func
(paren
id|address
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sig
op_eq
l_int|0x0303
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STI word mode ROM at %08lx, ignored&bslash;n&quot;
comma
id|address
)paren
suffix:semicolon
id|sti
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|sti
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* this is hacked.  We need a better way to find out the HPA for&n;&t; * romless STI (eg search for the graphics devices we know about&n;&t; * by sversion) */
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xf5000000
)paren
)paren
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;f4000000 b&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xf7000000
)paren
)paren
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;f6000000 b&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xf9000000
)paren
)paren
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;f8000000 b&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xfb000000
)paren
)paren
id|DPRINTK
c_func
(paren
(paren
l_string|&quot;fa000000 b&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|sti_init_glob_cfg
c_func
(paren
id|sti
comma
id|hpa
comma
id|address
)paren
suffix:semicolon
id|sti_init_graph
c_func
(paren
id|sti
)paren
suffix:semicolon
singleline_comment|//sti_inq_conf(sti);
macro_line|#if !defined(SERIAL_CONSOLE)&t;
(brace
r_extern
r_void
id|pdc_console_die
c_func
(paren
r_void
)paren
suffix:semicolon
id|pdc_console_die
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|take_over_console
c_func
(paren
op_amp
id|sti_con
comma
l_int|0
comma
id|MAX_NR_CONSOLES
op_minus
l_int|1
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* sti_inq_conf(sti); */
)brace
DECL|variable|sti_address
r_static
r_int
r_int
id|sti_address
suffix:semicolon
DECL|variable|sti_hpa
r_static
r_int
r_int
id|sti_hpa
suffix:semicolon
DECL|function|sti_init_roms
r_static
r_void
id|__init
id|sti_init_roms
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* handle the command line */
r_if
c_cond
(paren
id|sti_address
op_logical_and
id|sti_hpa
)paren
(brace
id|sti_try_rom
c_func
(paren
id|sti_address
comma
id|sti_hpa
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* 712, 715, some other boxes don&squot;t have a separate STI ROM,&n;&t; * but use part of the regular flash */
r_if
c_cond
(paren
id|PAGE0-&gt;proc_sti
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;STI ROM from PDC at %08x&bslash;n&quot;
comma
id|PAGE0-&gt;proc_sti
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xf9000000
)paren
)paren
(brace
id|sti_try_rom
c_func
(paren
id|PAGE0-&gt;proc_sti
comma
l_int|0xf8000000
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xf5000000
)paren
)paren
(brace
id|sti_try_rom
c_func
(paren
id|PAGE0-&gt;proc_sti
comma
l_int|0xf4000000
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xf7000000
)paren
)paren
(brace
id|sti_try_rom
c_func
(paren
id|PAGE0-&gt;proc_sti
comma
l_int|0xf6000000
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xfb000000
)paren
)paren
(brace
id|sti_try_rom
c_func
(paren
id|PAGE0-&gt;proc_sti
comma
l_int|0xfa000000
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* standard locations for GSC graphic devices */
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xf4000000
)paren
)paren
(brace
id|sti_try_rom
c_func
(paren
l_int|0xf4000000
comma
l_int|0xf4000000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xf6000000
)paren
)paren
(brace
id|sti_try_rom
c_func
(paren
l_int|0xf6000000
comma
l_int|0xf6000000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xf8000000
)paren
)paren
(brace
id|sti_try_rom
c_func
(paren
l_int|0xf8000000
comma
l_int|0xf8000000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pdc_add_valid
c_func
(paren
(paren
r_void
op_star
)paren
l_int|0xfa000000
)paren
)paren
(brace
id|sti_try_rom
c_func
(paren
l_int|0xfa000000
comma
l_int|0xfa000000
)paren
suffix:semicolon
)brace
)brace
DECL|function|sti_init
r_static
r_int
id|__init
id|sti_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;searching for byte mode STI ROMs&bslash;n&quot;
)paren
suffix:semicolon
id|sti_init_roms
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|sti_init
)paren
eof
