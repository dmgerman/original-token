multiline_comment|/*&n; * cons_newport.c: Newport graphics console code for the SGI.&n; *&n; * Copyright (C) 1996 David S. Miller (dm@engr.sgi.com)&n; *&n; * $Id: cons_newport.c,v 1.1 1997/12/02 02:28:23 ralf Exp $&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/sgialib.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;linux/kbd_kern.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/consolemap.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
macro_line|#include &quot;gconsole.h&quot;
macro_line|#include &quot;newport.h&quot;
macro_line|#include &quot;graphics.h&quot; /* Just for now */
macro_line|#include &lt;asm/gfx.h&gt;
macro_line|#include &lt;asm/ng1.h&gt;
macro_line|#if 0
macro_line|#include &quot;linux_logo.h&quot;
macro_line|#endif
DECL|macro|BMASK
mdefine_line|#define BMASK(c) (c &lt;&lt; 24)
DECL|macro|RENDER
mdefine_line|#define RENDER(regs, cp) do { &bslash;&n;(regs)-&gt;go.zpattern = BMASK((cp)[0x0]); (regs)-&gt;go.zpattern = BMASK((cp)[0x1]); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((cp)[0x2]); (regs)-&gt;go.zpattern = BMASK((cp)[0x3]); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((cp)[0x4]); (regs)-&gt;go.zpattern = BMASK((cp)[0x5]); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((cp)[0x6]); (regs)-&gt;go.zpattern = BMASK((cp)[0x7]); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((cp)[0x8]); (regs)-&gt;go.zpattern = BMASK((cp)[0x9]); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((cp)[0xa]); (regs)-&gt;go.zpattern = BMASK((cp)[0xb]); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((cp)[0xc]); (regs)-&gt;go.zpattern = BMASK((cp)[0xd]); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((cp)[0xe]); (regs)-&gt;go.zpattern = BMASK((cp)[0xf]); &bslash;&n;} while(0)        
DECL|macro|REVERSE_RENDER
mdefine_line|#define REVERSE_RENDER(regs, cp) do { &bslash;&n;(regs)-&gt;go.zpattern = BMASK((~(cp)[0x0])); (regs)-&gt;go.zpattern = BMASK((~(cp)[0x1])); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((~(cp)[0x2])); (regs)-&gt;go.zpattern = BMASK((~(cp)[0x3])); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((~(cp)[0x4])); (regs)-&gt;go.zpattern = BMASK((~(cp)[0x5])); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((~(cp)[0x6])); (regs)-&gt;go.zpattern = BMASK((~(cp)[0x7])); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((~(cp)[0x8])); (regs)-&gt;go.zpattern = BMASK((~(cp)[0x9])); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((~(cp)[0xa])); (regs)-&gt;go.zpattern = BMASK((~(cp)[0xb])); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((~(cp)[0xc])); (regs)-&gt;go.zpattern = BMASK((~(cp)[0xd])); &bslash;&n;(regs)-&gt;go.zpattern = BMASK((~(cp)[0xe])); (regs)-&gt;go.zpattern = BMASK((~(cp)[0xf])); &bslash;&n;} while(0)        
r_extern
r_int
id|default_red
(braket
l_int|16
)braket
comma
id|default_grn
(braket
l_int|16
)braket
comma
id|default_blu
(braket
l_int|16
)braket
suffix:semicolon
r_extern
r_int
r_char
id|video_type
suffix:semicolon
DECL|variable|cursor_pos
r_static
r_int
id|cursor_pos
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|npregs
r_struct
id|newport_regs
op_star
id|npregs
suffix:semicolon
DECL|macro|TESTVAL
mdefine_line|#define TESTVAL 0xdeadbeef
DECL|macro|XSTI_TO_FXSTART
mdefine_line|#define XSTI_TO_FXSTART(val) (((val) &amp; 0xffff) &lt;&lt; 11)
r_static
r_inline
r_void
DECL|function|newport_disable_video
id|newport_disable_video
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|treg
suffix:semicolon
id|treg
op_assign
id|newport_vc2_get
c_func
(paren
id|npregs
comma
id|VC2_IREG_CONTROL
)paren
suffix:semicolon
id|newport_vc2_set
c_func
(paren
id|npregs
comma
id|VC2_IREG_CONTROL
comma
(paren
id|treg
op_amp
op_complement
(paren
id|VC2_CTRL_EVIDEO
)paren
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|newport_enable_video
id|newport_enable_video
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|treg
suffix:semicolon
id|treg
op_assign
id|newport_vc2_get
c_func
(paren
id|npregs
comma
id|VC2_IREG_CONTROL
)paren
suffix:semicolon
id|newport_vc2_set
c_func
(paren
id|npregs
comma
id|VC2_IREG_CONTROL
comma
(paren
id|treg
op_or
id|VC2_CTRL_EVIDEO
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|newport_disable_cursor
id|newport_disable_cursor
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|treg
suffix:semicolon
id|treg
op_assign
id|newport_vc2_get
c_func
(paren
id|npregs
comma
id|VC2_IREG_CONTROL
)paren
suffix:semicolon
id|newport_vc2_set
c_func
(paren
id|npregs
comma
id|VC2_IREG_CONTROL
comma
(paren
id|treg
op_amp
op_complement
(paren
id|VC2_CTRL_ECDISP
)paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_inline
r_void
id|newport_enable_cursor
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|treg
suffix:semicolon
id|treg
op_assign
id|newport_vc2_get
c_func
(paren
id|npregs
comma
id|VC2_IREG_CONTROL
)paren
suffix:semicolon
id|newport_vc2_set
c_func
(paren
id|npregs
comma
id|VC2_IREG_CONTROL
comma
(paren
id|treg
op_or
id|VC2_CTRL_ECDISP
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_inline
r_void
DECL|function|newport_init_cmap
id|newport_init_cmap
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|newport_bfwait
c_func
(paren
)paren
suffix:semicolon
id|newport_cmap_setaddr
c_func
(paren
id|npregs
comma
id|color_table
(braket
id|i
)braket
)paren
suffix:semicolon
id|newport_cmap_setrgb
c_func
(paren
id|npregs
comma
id|default_red
(braket
id|i
)braket
comma
id|default_grn
(braket
id|i
)braket
comma
id|default_blu
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0
r_static
r_inline
r_void
id|newport_init_cursor
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|cursor
(braket
l_int|256
)braket
suffix:semicolon
r_int
r_int
op_star
id|cookie
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cursor
(braket
id|i
)braket
op_assign
l_int|0x0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|211
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|cursor
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
macro_line|#if 0
id|cursor
(braket
(paren
id|i
op_plus
l_int|128
)paren
op_lshift
l_int|2
)braket
op_assign
l_int|0xff
suffix:semicolon
id|cursor
(braket
(paren
(paren
id|i
op_plus
l_int|128
)paren
op_lshift
l_int|2
)paren
op_plus
l_int|1
)braket
op_assign
l_int|0xff
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Load the SRAM on the VC2 for this new GLYPH. */
id|cookie
op_assign
(paren
r_int
r_int
op_star
)paren
id|cursor
suffix:semicolon
id|newport_vc2_set
c_func
(paren
id|npregs
comma
id|VC2_IREG_RADDR
comma
id|VC2_CGLYPH_ADDR
)paren
suffix:semicolon
id|npregs-&gt;set.dcbmode
op_assign
(paren
id|NPORT_DMODE_AVC2
op_or
id|VC2_REGADDR_RAM
op_or
id|NPORT_DMODE_W2
op_or
id|VC2_PROTOCOL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_increment
)paren
(brace
id|newport_bfwait
c_func
(paren
)paren
suffix:semicolon
id|npregs-&gt;set.dcbdata0.hwords.s1
op_assign
op_star
id|cookie
op_increment
suffix:semicolon
)brace
multiline_comment|/* Place the cursor at origin. */
id|newport_vc2_set
c_func
(paren
id|npregs
comma
id|VC2_IREG_CURSX
comma
l_int|0
)paren
suffix:semicolon
id|newport_vc2_set
c_func
(paren
id|npregs
comma
id|VC2_IREG_CURSY
comma
l_int|0
)paren
suffix:semicolon
id|newport_enable_cursor
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_inline
r_void
DECL|function|newport_clear_screen
id|newport_clear_screen
c_func
(paren
r_void
)paren
(brace
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|npregs-&gt;set.wrmask
op_assign
l_int|0xffffffff
suffix:semicolon
id|npregs-&gt;set.drawmode0
op_assign
(paren
id|NPORT_DMODE0_DRAW
op_or
id|NPORT_DMODE0_BLOCK
op_or
id|NPORT_DMODE0_DOSETUP
op_or
id|NPORT_DMODE0_STOPX
op_or
id|NPORT_DMODE0_STOPY
)paren
suffix:semicolon
id|npregs-&gt;set.colori
op_assign
l_int|0
suffix:semicolon
id|npregs-&gt;set.xystarti
op_assign
l_int|0
suffix:semicolon
id|npregs-&gt;go.xyendi
op_assign
(paren
(paren
(paren
l_int|1280
op_plus
l_int|63
)paren
op_lshift
l_int|16
)paren
op_or
(paren
l_int|1024
)paren
)paren
suffix:semicolon
id|newport_bfwait
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|newport_render_version
id|newport_render_version
c_func
(paren
r_void
)paren
(brace
macro_line|#if 0
r_int
r_int
op_star
id|ush
suffix:semicolon
r_int
id|currcons
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|ush
op_assign
(paren
r_int
r_int
op_star
)paren
id|video_mem_base
op_plus
id|video_num_columns
op_star
l_int|2
op_plus
l_int|20
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_string|&quot;SGI/Linux version &quot;
id|UTS_RELEASE
suffix:semicolon
op_star
id|p
suffix:semicolon
id|p
op_increment
comma
id|ush
op_increment
)paren
(brace
op_star
id|ush
op_assign
(paren
id|attr
op_lshift
l_int|8
)paren
op_plus
op_star
id|p
suffix:semicolon
id|newport_blitc
(paren
op_star
id|ush
comma
(paren
r_int
r_int
)paren
id|ush
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
macro_line|#if 0
r_static
r_inline
r_void
id|newport_render_logo
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|xpos
comma
id|ypos
suffix:semicolon
r_int
r_char
op_star
id|bmap
suffix:semicolon
id|xpos
op_assign
l_int|8
suffix:semicolon
id|ypos
op_assign
l_int|18
suffix:semicolon
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|npregs-&gt;set.colori
op_assign
l_int|9
suffix:semicolon
id|npregs-&gt;set.drawmode0
op_assign
(paren
id|NPORT_DMODE0_DRAW
op_or
id|NPORT_DMODE0_BLOCK
op_or
id|NPORT_DMODE0_STOPX
op_or
id|NPORT_DMODE0_ZPENAB
op_or
id|NPORT_DMODE0_L32
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|80
suffix:semicolon
id|i
op_add_assign
l_int|8
)paren
(brace
multiline_comment|/* Set coordinates for bitmap operation. */
id|npregs-&gt;set.xystarti
op_assign
(paren
(paren
id|xpos
op_plus
id|i
)paren
op_lshift
l_int|16
)paren
op_or
id|ypos
suffix:semicolon
id|npregs-&gt;set.xyendi
op_assign
(paren
(paren
(paren
id|xpos
op_plus
id|i
)paren
op_plus
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|bmap
op_assign
id|linux_logo
op_plus
(paren
id|i
op_star
l_int|80
)paren
suffix:semicolon
id|RENDER
c_func
(paren
id|npregs
comma
id|bmap
)paren
suffix:semicolon
id|bmap
op_add_assign
l_int|0x10
suffix:semicolon
id|RENDER
c_func
(paren
id|npregs
comma
id|bmap
)paren
suffix:semicolon
id|bmap
op_add_assign
l_int|0x10
suffix:semicolon
id|RENDER
c_func
(paren
id|npregs
comma
id|bmap
)paren
suffix:semicolon
id|bmap
op_add_assign
l_int|0x10
suffix:semicolon
id|RENDER
c_func
(paren
id|npregs
comma
id|bmap
)paren
suffix:semicolon
id|bmap
op_add_assign
l_int|0x10
suffix:semicolon
id|RENDER
c_func
(paren
id|npregs
comma
id|bmap
)paren
suffix:semicolon
)brace
id|prom_getchar
c_func
(paren
)paren
suffix:semicolon
id|prom_imode
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_inline
r_void
DECL|function|newport_render_background
id|newport_render_background
c_func
(paren
r_int
id|xpos
comma
r_int
id|ypos
comma
r_int
id|ci
)paren
(brace
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|npregs-&gt;set.wrmask
op_assign
l_int|0xffffffff
suffix:semicolon
id|npregs-&gt;set.drawmode0
op_assign
(paren
id|NPORT_DMODE0_DRAW
op_or
id|NPORT_DMODE0_BLOCK
op_or
id|NPORT_DMODE0_DOSETUP
op_or
id|NPORT_DMODE0_STOPX
op_or
id|NPORT_DMODE0_STOPY
)paren
suffix:semicolon
id|npregs-&gt;set.colori
op_assign
id|ci
suffix:semicolon
id|npregs-&gt;set.xystarti
op_assign
(paren
id|xpos
op_lshift
l_int|16
)paren
op_or
id|ypos
suffix:semicolon
id|npregs-&gt;go.xyendi
op_assign
(paren
(paren
id|xpos
op_plus
l_int|7
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|ypos
op_plus
l_int|15
)paren
suffix:semicolon
)brace
r_void
DECL|function|newport_set_origin
id|newport_set_origin
c_func
(paren
r_int
r_int
id|offset
)paren
(brace
multiline_comment|/* maybe this works... */
id|__origin
op_assign
id|offset
suffix:semicolon
)brace
r_void
DECL|function|newport_hide_cursor
id|newport_hide_cursor
c_func
(paren
r_void
)paren
(brace
r_int
id|xpos
comma
id|ypos
comma
id|idx
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_GRAPHICS
)paren
(brace
r_return
suffix:semicolon
)brace
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|idx
op_assign
id|cursor_pos
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_eq
op_minus
l_int|1
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|xpos
op_assign
l_int|8
op_plus
(paren
(paren
id|idx
op_mod
id|video_num_columns
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|ypos
op_assign
l_int|18
op_plus
(paren
(paren
id|idx
op_div
id|video_num_columns
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
id|newport_render_background
c_func
(paren
id|xpos
comma
id|ypos
comma
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|newport_set_cursor
id|newport_set_cursor
c_func
(paren
r_int
id|currcons
)paren
(brace
r_int
id|xpos
comma
id|ypos
comma
id|idx
comma
id|oldpos
suffix:semicolon
r_int
r_int
op_star
id|sp
comma
op_star
id|osp
comma
id|cattr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|currcons
op_ne
id|fg_console
op_logical_or
id|console_blanked
op_logical_or
id|vcmode
op_eq
id|KD_GRAPHICS
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|__real_origin
op_ne
id|__origin
)paren
id|__set_origin
c_func
(paren
id|__real_origin
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|pos
op_minus
id|video_mem_base
)paren
op_rshift
l_int|1
suffix:semicolon
id|sp
op_assign
(paren
r_int
r_int
op_star
)paren
id|pos
suffix:semicolon
id|oldpos
op_assign
id|cursor_pos
suffix:semicolon
id|cursor_pos
op_assign
id|idx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|deccm
)paren
(brace
id|hide_cursor
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|xpos
op_assign
l_int|8
op_plus
(paren
(paren
id|idx
op_mod
id|video_num_columns
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|ypos
op_assign
l_int|18
op_plus
(paren
(paren
id|idx
op_div
id|video_num_columns
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oldpos
op_ne
op_minus
l_int|1
)paren
(brace
r_int
id|oxpos
comma
id|oypos
suffix:semicolon
multiline_comment|/* Restore old location. */
id|osp
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
id|oldpos
op_lshift
l_int|1
)paren
op_plus
id|video_mem_base
)paren
suffix:semicolon
id|oxpos
op_assign
l_int|8
op_plus
(paren
(paren
id|oldpos
op_mod
id|video_num_columns
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|oypos
op_assign
l_int|18
op_plus
(paren
(paren
id|oldpos
op_div
id|video_num_columns
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
id|cattr
op_assign
op_star
id|osp
suffix:semicolon
id|newport_render_background
c_func
(paren
id|oxpos
comma
id|oypos
comma
(paren
id|cattr
op_amp
l_int|0xf000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|vga_font
(braket
(paren
id|cattr
op_amp
l_int|0xff
)paren
op_lshift
l_int|4
)braket
suffix:semicolon
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|npregs-&gt;set.colori
op_assign
(paren
id|cattr
op_amp
l_int|0x0f00
)paren
op_rshift
l_int|8
suffix:semicolon
id|npregs-&gt;set.drawmode0
op_assign
(paren
id|NPORT_DMODE0_DRAW
op_or
id|NPORT_DMODE0_BLOCK
op_or
id|NPORT_DMODE0_STOPX
op_or
id|NPORT_DMODE0_ZPENAB
op_or
id|NPORT_DMODE0_L32
)paren
suffix:semicolon
id|npregs-&gt;set.xystarti
op_assign
(paren
id|oxpos
op_lshift
l_int|16
)paren
op_or
id|oypos
suffix:semicolon
id|npregs-&gt;set.xyendi
op_assign
(paren
(paren
id|oxpos
op_plus
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|RENDER
c_func
(paren
id|npregs
comma
id|p
)paren
suffix:semicolon
)brace
id|cattr
op_assign
op_star
id|sp
suffix:semicolon
id|newport_render_background
c_func
(paren
id|xpos
comma
id|ypos
comma
(paren
id|cattr
op_amp
l_int|0xf000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|vga_font
(braket
(paren
id|cattr
op_amp
l_int|0xff
)paren
op_lshift
l_int|4
)braket
suffix:semicolon
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|npregs-&gt;set.colori
op_assign
(paren
id|cattr
op_amp
l_int|0x0f00
)paren
op_rshift
l_int|8
suffix:semicolon
id|npregs-&gt;set.drawmode0
op_assign
(paren
id|NPORT_DMODE0_DRAW
op_or
id|NPORT_DMODE0_BLOCK
op_or
id|NPORT_DMODE0_STOPX
op_or
id|NPORT_DMODE0_ZPENAB
op_or
id|NPORT_DMODE0_L32
)paren
suffix:semicolon
id|npregs-&gt;set.xystarti
op_assign
(paren
id|xpos
op_lshift
l_int|16
)paren
op_or
id|ypos
suffix:semicolon
id|npregs-&gt;set.xyendi
op_assign
(paren
(paren
id|xpos
op_plus
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|REVERSE_RENDER
c_func
(paren
id|npregs
comma
id|p
)paren
suffix:semicolon
id|restore_flags
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|newport_get_scrmem
id|newport_get_scrmem
c_func
(paren
r_int
id|currcons
)paren
(brace
id|memcpyw
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|vc_scrbuf
(braket
id|currcons
)braket
comma
(paren
r_int
r_int
op_star
)paren
id|origin
comma
id|video_screen_size
)paren
suffix:semicolon
id|origin
op_assign
id|video_mem_start
op_assign
(paren
r_int
r_int
)paren
id|vc_scrbuf
(braket
id|currcons
)braket
suffix:semicolon
id|scr_end
op_assign
id|video_mem_end
op_assign
id|video_mem_start
op_plus
id|video_screen_size
suffix:semicolon
id|pos
op_assign
id|origin
op_plus
id|y
op_star
id|video_size_row
op_plus
(paren
id|x
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
r_void
DECL|function|newport_set_scrmem
id|newport_set_scrmem
c_func
(paren
r_int
id|currcons
comma
r_int
id|offset
)paren
(brace
r_if
c_cond
(paren
id|video_mem_term
op_minus
id|video_mem_base
OL
id|offset
op_plus
id|video_screen_size
)paren
id|offset
op_assign
l_int|0
suffix:semicolon
id|memcpyw
c_func
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|video_mem_base
op_plus
id|offset
)paren
comma
(paren
r_int
r_int
op_star
)paren
id|origin
comma
id|video_screen_size
)paren
suffix:semicolon
id|video_mem_start
op_assign
id|video_mem_base
suffix:semicolon
id|video_mem_end
op_assign
id|video_mem_term
suffix:semicolon
id|origin
op_assign
id|video_mem_base
op_plus
id|offset
suffix:semicolon
id|scr_end
op_assign
id|origin
op_plus
id|video_screen_size
suffix:semicolon
id|pos
op_assign
id|origin
op_plus
id|y
op_star
id|video_size_row
op_plus
(paren
id|x
op_lshift
l_int|1
)paren
suffix:semicolon
id|has_wrapped
op_assign
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|newport_set_get_cmap
id|newport_set_get_cmap
c_func
(paren
r_int
r_char
op_star
id|arg
comma
r_int
id|set
)paren
(brace
r_int
r_int
id|ent
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|set
ques
c_cond
id|VERIFY_READ
suffix:colon
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
l_int|16
op_star
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|set
)paren
(brace
id|__get_user
c_func
(paren
id|default_red
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
id|__get_user
c_func
(paren
id|default_grn
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
id|__get_user
c_func
(paren
id|default_blu
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
)brace
r_else
(brace
id|__put_user
(paren
id|default_red
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
id|__put_user
(paren
id|default_grn
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
id|__put_user
(paren
id|default_blu
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|set
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_NR_CONSOLES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|vc_cons_allocated
c_func
(paren
id|i
)paren
)paren
(brace
r_int
id|j
comma
id|k
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|k
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|16
suffix:semicolon
id|j
op_increment
)paren
(brace
id|vc_cons
(braket
id|i
)braket
dot
id|d-&gt;vc_palette
(braket
id|k
op_increment
)braket
op_assign
id|default_red
(braket
id|j
)braket
suffix:semicolon
id|vc_cons
(braket
id|i
)braket
dot
id|d-&gt;vc_palette
(braket
id|k
op_increment
)braket
op_assign
id|default_grn
(braket
id|j
)braket
suffix:semicolon
id|vc_cons
(braket
id|i
)braket
dot
id|d-&gt;vc_palette
(braket
id|k
op_increment
)braket
op_assign
id|default_blu
(braket
id|j
)braket
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|console_blanked
op_logical_or
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_GRAPHICS
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ent
op_assign
l_int|0
suffix:semicolon
id|ent
OL
l_int|16
suffix:semicolon
id|ent
op_increment
)paren
(brace
id|newport_bfwait
c_func
(paren
)paren
suffix:semicolon
id|newport_cmap_setaddr
c_func
(paren
id|npregs
comma
id|ent
)paren
suffix:semicolon
id|newport_cmap_setrgb
c_func
(paren
id|npregs
comma
id|default_red
(braket
id|ent
)braket
comma
id|default_grn
(braket
id|ent
)braket
comma
id|default_blu
(braket
id|ent
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|newport_blitc
id|newport_blitc
c_func
(paren
r_int
r_int
id|charattr
comma
r_int
r_int
id|addr
)paren
(brace
r_int
id|idx
comma
id|xpos
comma
id|ypos
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
id|idx
op_assign
(paren
id|addr
op_minus
(paren
id|video_mem_base
op_plus
(paren
id|__origin
op_lshift
l_int|1
)paren
)paren
)paren
op_rshift
l_int|1
suffix:semicolon
id|xpos
op_assign
l_int|8
op_plus
(paren
(paren
id|idx
op_mod
id|video_num_columns
)paren
op_lshift
l_int|3
)paren
suffix:semicolon
id|ypos
op_assign
l_int|18
op_plus
(paren
(paren
id|idx
op_div
id|video_num_columns
)paren
op_lshift
l_int|4
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|vga_font
(braket
(paren
id|charattr
op_amp
l_int|0xff
)paren
op_lshift
l_int|4
)braket
suffix:semicolon
id|charattr
op_assign
(paren
id|charattr
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|newport_render_background
c_func
(paren
id|xpos
comma
id|ypos
comma
(paren
id|charattr
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Set the color and drawing mode. */
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|npregs-&gt;set.colori
op_assign
id|charattr
op_amp
l_int|0xf
suffix:semicolon
id|npregs-&gt;set.drawmode0
op_assign
(paren
id|NPORT_DMODE0_DRAW
op_or
id|NPORT_DMODE0_BLOCK
op_or
id|NPORT_DMODE0_STOPX
op_or
id|NPORT_DMODE0_ZPENAB
op_or
id|NPORT_DMODE0_L32
)paren
suffix:semicolon
multiline_comment|/* Set coordinates for bitmap operation. */
id|npregs-&gt;set.xystarti
op_assign
(paren
id|xpos
op_lshift
l_int|16
)paren
op_or
id|ypos
suffix:semicolon
id|npregs-&gt;set.xyendi
op_assign
(paren
(paren
id|xpos
op_plus
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Go, baby, go... */
id|RENDER
c_func
(paren
id|npregs
comma
id|p
)paren
suffix:semicolon
)brace
r_void
DECL|function|newport_memsetw
id|newport_memsetw
c_func
(paren
r_void
op_star
id|s
comma
r_int
r_int
id|c
comma
r_int
r_int
id|count
)paren
(brace
r_int
r_int
op_star
id|addr
op_assign
(paren
r_int
r_int
op_star
)paren
id|s
suffix:semicolon
id|count
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_GRAPHICS
)paren
(brace
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
op_star
id|addr
op_increment
op_assign
id|c
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|addr
op_plus
id|count
OG
id|video_mem_term
op_logical_or
(paren
r_int
r_int
)paren
id|addr
OL
id|video_mem_base
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|addr
op_plus
id|count
op_le
id|video_mem_term
op_logical_or
(paren
r_int
r_int
)paren
id|addr
OG
id|video_mem_base
)paren
(brace
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
op_star
id|addr
op_increment
op_assign
id|c
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|scr_writew
c_func
(paren
id|c
comma
id|addr
op_increment
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_star
id|addr
op_ne
id|c
)paren
(brace
id|newport_blitc
c_func
(paren
id|c
comma
(paren
r_int
r_int
)paren
id|addr
)paren
suffix:semicolon
op_star
id|addr
op_increment
op_assign
id|c
suffix:semicolon
)brace
r_else
id|addr
op_increment
suffix:semicolon
)brace
)brace
)brace
r_void
DECL|function|newport_memcpyw
id|newport_memcpyw
c_func
(paren
r_int
r_int
op_star
id|to
comma
r_int
r_int
op_star
id|from
comma
r_int
r_int
id|count
)paren
(brace
r_if
c_cond
(paren
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_GRAPHICS
)paren
(brace
id|memcpy
c_func
(paren
id|to
comma
id|from
comma
id|count
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|to
op_plus
id|count
OG
id|video_mem_term
op_logical_or
(paren
r_int
r_int
)paren
id|to
OL
id|video_mem_base
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|to
op_plus
id|count
op_le
id|video_mem_term
op_logical_or
(paren
r_int
r_int
)paren
id|to
OG
id|video_mem_base
)paren
id|memcpy
c_func
(paren
id|to
comma
id|from
comma
id|count
)paren
suffix:semicolon
r_else
(brace
id|count
op_div_assign
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|scr_writew
c_func
(paren
id|scr_readw
c_func
(paren
id|from
op_increment
)paren
comma
id|to
op_increment
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|count
op_div_assign
l_int|2
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_star
id|to
op_ne
op_star
id|from
)paren
(brace
id|newport_blitc
c_func
(paren
op_star
id|from
comma
(paren
r_int
r_int
)paren
id|to
)paren
suffix:semicolon
op_star
id|to
op_increment
op_assign
op_star
id|from
op_increment
suffix:semicolon
)brace
r_else
(brace
id|from
op_increment
suffix:semicolon
id|to
op_increment
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|variable|newport_console
r_struct
id|console_ops
id|newport_console
op_assign
(brace
id|newport_set_origin
comma
id|newport_hide_cursor
comma
id|newport_set_cursor
comma
id|newport_get_scrmem
comma
id|newport_set_scrmem
comma
id|newport_set_get_cmap
comma
id|newport_blitc
comma
id|newport_memsetw
comma
id|newport_memcpyw
)brace
suffix:semicolon
multiline_comment|/* Currently hard-coded values that are the same as those found on my system */
DECL|variable|newport_board_info
r_struct
id|ng1_info
id|newport_board_info
op_assign
(brace
(brace
l_string|&quot;NG1&quot;
comma
l_string|&quot;&quot;
multiline_comment|/* what is the label? */
comma
l_int|1280
comma
l_int|1024
comma
r_sizeof
(paren
r_struct
id|ng1_info
)paren
)brace
comma
l_int|6
comma
multiline_comment|/* boardrev */
l_int|1
comma
multiline_comment|/* rex3rev */
l_int|0
comma
multiline_comment|/* vc2rev */
l_int|2
comma
multiline_comment|/* monitor type */
l_int|0
comma
multiline_comment|/* videoinstalled */
l_int|3
comma
multiline_comment|/* mcrev */
l_int|24
comma
multiline_comment|/* bitplanes */
l_int|0
comma
multiline_comment|/* xmap9rev */
l_int|2
comma
multiline_comment|/* cmaprev */
(brace
l_int|256
comma
l_int|1280
comma
l_int|1024
comma
l_int|76
)brace
comma
multiline_comment|/* ng1_vof_info */
l_int|13
comma
multiline_comment|/* paneltype */
l_int|0
)brace
suffix:semicolon
r_void
DECL|function|newport_reset
id|newport_reset
(paren
r_void
)paren
(brace
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
id|newport_enable_video
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Init the cursor disappear. */
id|newport_wait
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0
id|newport_init_cursor
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|newport_disable_cursor
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|newport_init_cmap
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Clear the screen. */
id|newport_clear_screen
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* right now the newport does not do anything at all */
DECL|variable|newport_graphic_ops
r_struct
id|graphics_ops
id|newport_graphic_ops
op_assign
(brace
l_int|0
comma
multiline_comment|/* owner */
l_int|0
comma
multiline_comment|/* current user */
(paren
r_void
op_star
)paren
op_amp
id|newport_board_info
comma
multiline_comment|/* board info */
r_sizeof
(paren
r_struct
id|ng1_info
)paren
comma
multiline_comment|/* size of our data structure */
l_int|0
comma
l_int|0
comma
multiline_comment|/* g_regs, g_regs_size */
id|newport_save
comma
id|newport_restore
comma
multiline_comment|/* g_save_context, g_restore_context */
id|newport_reset
comma
id|newport_ioctl
multiline_comment|/* g_reset_console, g_ioctl */
)brace
suffix:semicolon
r_struct
id|graphics_ops
op_star
DECL|function|newport_probe
id|newport_probe
(paren
r_int
id|slot
comma
r_const
r_char
op_star
op_star
id|name
)paren
(brace
r_struct
id|newport_regs
op_star
id|p
suffix:semicolon
id|npregs
op_assign
(paren
r_struct
id|newport_regs
op_star
)paren
(paren
id|KSEG1
op_plus
l_int|0x1f0f0000
)paren
suffix:semicolon
id|p
op_assign
id|npregs
suffix:semicolon
id|p-&gt;cset.config
op_assign
id|NPORT_CFG_GD0
suffix:semicolon
r_if
c_cond
(paren
id|newport_wait
c_func
(paren
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;whoops, timeout, no NEWPORT there?&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|p-&gt;set.xstarti
op_assign
id|TESTVAL
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;set._xstart.i
op_ne
id|XSTI_TO_FXSTART
c_func
(paren
id|TESTVAL
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;newport_probe: read back wrong value ;-(&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot
op_eq
l_int|0
)paren
(brace
id|register_gconsole
(paren
op_amp
id|newport_console
)paren
suffix:semicolon
id|video_type
op_assign
id|VIDEO_TYPE_SGI
suffix:semicolon
id|can_do_color
op_assign
l_int|1
suffix:semicolon
op_star
id|name
op_assign
l_string|&quot;NEWPORT&quot;
suffix:semicolon
)brace
id|newport_reset
(paren
)paren
suffix:semicolon
id|newport_render_version
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0
id|newport_render_logo
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|newport_graphic_ops.g_regs
op_assign
l_int|0x1f0f0000
suffix:semicolon
id|newport_graphic_ops.g_regs_size
op_assign
r_sizeof
(paren
r_struct
id|newport_regs
)paren
suffix:semicolon
r_return
op_amp
id|newport_graphic_ops
suffix:semicolon
)brace
eof
