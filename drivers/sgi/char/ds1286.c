multiline_comment|/* $Id: ds1286.c,v 1.6 1999/10/09 00:01:31 ralf Exp $&n; *&n; *&t;Real Time Clock interface for Linux&t;&n; *&n; *&t;Copyright (C) 1998, 1999 Ralf Baechle&n; *&t;&n; *&t;Based on code written by Paul Gortmaker.&n; *&n; *&t;This driver allows use of the real time clock (built into&n; *&t;nearly all computers) from user space. It exports the /dev/rtc&n; *&t;interface supporting various ioctl() and also the /proc/rtc&n; *&t;pseudo-file for status information.&n; *&n; *&t;The ioctls can be used to set the interrupt behaviour and&n; *&t;generation rate from the RTC via IRQ 8. Then the /dev/rtc&n; *&t;interface can be used to make use of these timer interrupts,&n; *&t;be they interval or alarm based.&n; *&n; *&t;The /dev/rtc interface will block on reads until an interrupt&n; *&t;has been received. If a RTC interrupt has already happened,&n; *&t;it will output an unsigned long and then block. The output value&n; *&t;contains the interrupt status in the low byte and the number of&n; *&t;interrupts since the last read in the remaining high bytes. The &n; *&t;/dev/rtc interface can also be used with the select(2) call.&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/rtc.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/ds1286.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
DECL|macro|DS1286_VERSION
mdefine_line|#define DS1286_VERSION&t;&t;&quot;1.0&quot;
multiline_comment|/*&n; *&t;We sponge a minor off of the misc major. No need slurping&n; *&t;up another valuable major dev number for this. If you add&n; *&t;an ioctl, make sure you don&squot;t conflict with SPARC&squot;s RTC&n; *&t;ioctls.&n; */
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|ds1286_wait
)paren
suffix:semicolon
r_static
r_int
r_int
id|ds1286_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
suffix:semicolon
r_static
id|ssize_t
id|ds1286_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
r_int
id|ds1286_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
r_int
id|ds1286_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
suffix:semicolon
r_void
id|get_rtc_time
(paren
r_struct
id|rtc_time
op_star
id|rtc_tm
)paren
suffix:semicolon
r_void
id|get_rtc_alm_time
(paren
r_struct
id|rtc_time
op_star
id|alm_tm
)paren
suffix:semicolon
r_void
id|set_rtc_irq_bit
c_func
(paren
r_int
r_char
id|bit
)paren
suffix:semicolon
r_void
id|clear_rtc_irq_bit
c_func
(paren
r_int
r_char
id|bit
)paren
suffix:semicolon
r_static
r_inline
r_int
r_char
id|ds1286_is_updating
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|ds1286_lock
r_static
id|spinlock_t
id|ds1286_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; *&t;Bits in rtc_status. (7 bits of room for future expansion)&n; */
DECL|macro|RTC_IS_OPEN
mdefine_line|#define RTC_IS_OPEN&t;&t;0x01&t;/* means /dev/rtc is in use&t;*/
DECL|macro|RTC_TIMER_ON
mdefine_line|#define RTC_TIMER_ON&t;&t;0x02&t;/* missed irq timer active&t;*/
DECL|variable|ds1286_status
r_int
r_char
id|ds1286_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* bitmapped status byte.&t;*/
DECL|variable|ds1286_freq
r_int
r_int
id|ds1286_freq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current periodic IRQ rate&t;*/
DECL|variable|ds1286_irq_data
r_int
r_int
id|ds1286_irq_data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* our output to the world&t;*/
DECL|variable|days_in_mo
r_int
r_char
id|days_in_mo
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|31
comma
l_int|28
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|30
comma
l_int|31
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;A very tiny interrupt handler. It runs with SA_INTERRUPT set,&n; *&t;so that there is no possibility of conflicting with the&n; *&t;set_rtc_mmss() call that happens during some timer interrupts.&n; *&t;(See ./arch/XXXX/kernel/time.c for the set_rtc_mmss() function.)&n; */
multiline_comment|/*&n; *&t;Now all the various file operations that we export.&n; */
DECL|function|ds1286_llseek
r_static
r_int
r_int
id|ds1286_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
DECL|function|ds1286_read
r_static
id|ssize_t
id|ds1286_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
id|ssize_t
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
r_sizeof
(paren
r_int
r_int
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|ds1286_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_while
c_loop
(paren
(paren
id|data
op_assign
id|xchg
c_func
(paren
op_amp
id|ds1286_irq_data
comma
l_int|0
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|retval
op_assign
id|put_user
c_func
(paren
id|data
comma
(paren
r_int
r_int
op_star
)paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|retval
op_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
id|out
suffix:colon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|ds1286_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|ds1286_ioctl
r_static
r_int
id|ds1286_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|rtc_time
id|wtime
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RTC_AIE_OFF
suffix:colon
multiline_comment|/* Mask alarm int. enab. bit&t;*/
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
id|val
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
suffix:semicolon
id|val
op_or_assign
id|RTC_TDM
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|val
comma
id|RTC_CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_AIE_ON
suffix:colon
multiline_comment|/* Allow alarm interrupts.&t;*/
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
id|val
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|RTC_TDM
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|val
comma
id|RTC_CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_WIE_OFF
suffix:colon
multiline_comment|/* Mask watchdog int. enab. bit&t;*/
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
id|val
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
suffix:semicolon
id|val
op_or_assign
id|RTC_WAM
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|val
comma
id|RTC_CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_WIE_ON
suffix:colon
multiline_comment|/* Allow watchdog interrupts.&t;*/
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
id|val
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|RTC_WAM
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|val
comma
id|RTC_CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_ALM_READ
suffix:colon
multiline_comment|/* Read the present alarm time */
(brace
multiline_comment|/*&n;&t;&t; * This returns a struct rtc_time. Reading &gt;= 0xc0&n;&t;&t; * means &quot;don&squot;t care&quot; or &quot;match all&quot;. Only the tm_hour,&n;&t;&t; * tm_min, and tm_sec values are filled in.&n;&t;&t; */
id|get_rtc_alm_time
c_func
(paren
op_amp
id|wtime
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|RTC_ALM_SET
suffix:colon
multiline_comment|/* Store a time into the alarm */
(brace
multiline_comment|/*&n;&t;&t; * This expects a struct rtc_time. Writing 0xff means&n;&t;&t; * &quot;don&squot;t care&quot; or &quot;match all&quot;. Only the tm_hour,&n;&t;&t; * tm_min and tm_sec are used.&n;&t;&t; */
r_int
r_char
id|hrs
comma
id|min
comma
id|sec
suffix:semicolon
r_struct
id|rtc_time
id|alm_tm
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|alm_tm
comma
(paren
r_struct
id|rtc_time
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|hrs
op_assign
id|alm_tm.tm_hour
suffix:semicolon
id|min
op_assign
id|alm_tm.tm_min
suffix:semicolon
r_if
c_cond
(paren
id|hrs
op_ge
l_int|24
)paren
id|hrs
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|min
op_ge
l_int|60
)paren
id|min
op_assign
l_int|0xff
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|min
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|hrs
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ds1286_lock
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|hrs
comma
id|RTC_HOURS_ALARM
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|min
comma
id|RTC_MINUTES_ALARM
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ds1286_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_RD_TIME
suffix:colon
multiline_comment|/* Read the time/date from RTC&t;*/
(brace
id|get_rtc_time
c_func
(paren
op_amp
id|wtime
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|RTC_SET_TIME
suffix:colon
multiline_comment|/* Set the RTC */
(brace
r_struct
id|rtc_time
id|rtc_tm
suffix:semicolon
r_int
r_char
id|mon
comma
id|day
comma
id|hrs
comma
id|min
comma
id|sec
comma
id|leap_yr
suffix:semicolon
r_int
r_char
id|save_control
suffix:semicolon
r_int
r_int
id|yrs
comma
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|rtc_tm
comma
(paren
r_struct
id|rtc_time
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|yrs
op_assign
id|rtc_tm.tm_year
op_plus
l_int|1900
suffix:semicolon
id|mon
op_assign
id|rtc_tm.tm_mon
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* tm_mon starts at zero */
id|day
op_assign
id|rtc_tm.tm_mday
suffix:semicolon
id|hrs
op_assign
id|rtc_tm.tm_hour
suffix:semicolon
id|min
op_assign
id|rtc_tm.tm_min
suffix:semicolon
id|sec
op_assign
id|rtc_tm.tm_sec
suffix:semicolon
r_if
c_cond
(paren
id|yrs
OL
l_int|1970
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|leap_yr
op_assign
(paren
(paren
op_logical_neg
(paren
id|yrs
op_mod
l_int|4
)paren
op_logical_and
(paren
id|yrs
op_mod
l_int|100
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|yrs
op_mod
l_int|400
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mon
OG
l_int|12
)paren
op_logical_or
(paren
id|day
op_eq
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|day
OG
(paren
id|days_in_mo
(braket
id|mon
)braket
op_plus
(paren
(paren
id|mon
op_eq
l_int|2
)paren
op_logical_and
id|leap_yr
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hrs
op_ge
l_int|24
)paren
op_logical_or
(paren
id|min
op_ge
l_int|60
)paren
op_logical_or
(paren
id|sec
op_ge
l_int|60
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|yrs
op_sub_assign
l_int|1940
)paren
OG
l_int|255
)paren
multiline_comment|/* They are unsigned */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|yrs
op_ge
l_int|100
)paren
id|yrs
op_sub_assign
l_int|100
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|min
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|hrs
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|day
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|yrs
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
id|save_control
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
(paren
id|save_control
op_or
id|RTC_TE
)paren
comma
id|RTC_CMD
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|yrs
comma
id|RTC_YEAR
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|mon
comma
id|RTC_MONTH
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|day
comma
id|RTC_DATE
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|hrs
comma
id|RTC_HOURS
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|min
comma
id|RTC_MINUTES
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|sec
comma
id|RTC_SECONDS
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
l_int|0
comma
id|RTC_HUNDREDTH_SECOND
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|save_control
comma
id|RTC_CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|wtime
comma
r_sizeof
id|wtime
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;We enforce only one user at a time here with the open/close.&n; *&t;Also clear the previous interrupt data on an open, and clean&n; *&t;up things on a close.&n; */
DECL|function|ds1286_open
r_static
r_int
id|ds1286_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|ds1286_status
op_amp
id|RTC_IS_OPEN
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|ds1286_status
op_or_assign
id|RTC_IS_OPEN
suffix:semicolon
id|ds1286_irq_data
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ds1286_release
r_static
r_int
id|ds1286_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|ds1286_status
op_and_assign
op_complement
id|RTC_IS_OPEN
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ds1286_poll
r_static
r_int
r_int
id|ds1286_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|ds1286_wait
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ds1286_irq_data
op_ne
l_int|0
)paren
r_return
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;The various file operations we support.&n; */
DECL|variable|ds1286_fops
r_static
r_struct
id|file_operations
id|ds1286_fops
op_assign
(brace
id|llseek
suffix:colon
id|ds1286_llseek
comma
id|read
suffix:colon
id|ds1286_read
comma
id|poll
suffix:colon
id|ds1286_poll
comma
id|ioctl
suffix:colon
id|ds1286_ioctl
comma
id|open
suffix:colon
id|ds1286_open
comma
id|release
suffix:colon
id|ds1286_release
comma
)brace
suffix:semicolon
DECL|variable|ds1286_dev
r_static
r_struct
id|miscdevice
id|ds1286_dev
op_assign
(brace
id|RTC_MINOR
comma
l_string|&quot;rtc&quot;
comma
op_amp
id|ds1286_fops
)brace
suffix:semicolon
DECL|function|ds1286_init
r_int
id|__init
id|ds1286_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DS1286 Real Time Clock Driver v%s&bslash;n&quot;
comma
id|DS1286_VERSION
)paren
suffix:semicolon
id|misc_register
c_func
(paren
op_amp
id|ds1286_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|days
r_static
r_char
op_star
id|days
(braket
)braket
op_assign
(brace
l_string|&quot;***&quot;
comma
l_string|&quot;Sun&quot;
comma
l_string|&quot;Mon&quot;
comma
l_string|&quot;Tue&quot;
comma
l_string|&quot;Wed&quot;
comma
l_string|&quot;Thu&quot;
comma
l_string|&quot;Fri&quot;
comma
l_string|&quot;Sat&quot;
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Info exported via &quot;/proc/rtc&quot;.&n; */
DECL|function|get_ds1286_status
r_int
id|get_ds1286_status
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_char
op_star
id|p
comma
op_star
id|s
suffix:semicolon
r_struct
id|rtc_time
id|tm
suffix:semicolon
r_int
r_char
id|hundredth
comma
id|month
comma
id|cmd
comma
id|amode
suffix:semicolon
id|p
op_assign
id|buf
suffix:semicolon
id|get_rtc_time
c_func
(paren
op_amp
id|tm
)paren
suffix:semicolon
id|hundredth
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_HUNDREDTH_SECOND
)paren
suffix:semicolon
id|hundredth
op_assign
id|BCD_TO_BIN
c_func
(paren
id|hundredth
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;rtc_time&bslash;t: %02d:%02d:%02d.%02d&bslash;n&quot;
l_string|&quot;rtc_date&bslash;t: %04d-%02d-%02d&bslash;n&quot;
comma
id|tm.tm_hour
comma
id|tm.tm_min
comma
id|tm.tm_sec
comma
id|hundredth
comma
id|tm.tm_year
op_plus
l_int|1900
comma
id|tm.tm_mon
op_plus
l_int|1
comma
id|tm.tm_mday
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We implicitly assume 24hr mode here. Alarm values &gt;= 0xc0 will&n;&t; * match any value for that particular field. Values that are&n;&t; * greater than a valid time, but less than 0xc0 shouldn&squot;t appear.&n;&t; */
id|get_rtc_alm_time
c_func
(paren
op_amp
id|tm
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;alarm&bslash;t&bslash;t: %s &quot;
comma
id|days
(braket
id|tm.tm_wday
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tm.tm_hour
op_le
l_int|24
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%02d:&quot;
comma
id|tm.tm_hour
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;**:&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tm.tm_min
op_le
l_int|59
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%02d&bslash;n&quot;
comma
id|tm.tm_min
)paren
suffix:semicolon
r_else
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;**&bslash;n&quot;
)paren
suffix:semicolon
id|month
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_MONTH
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;oscillator&bslash;t: %s&bslash;n&quot;
l_string|&quot;square_wave&bslash;t: %s&bslash;n&quot;
comma
(paren
id|month
op_amp
id|RTC_EOSC
)paren
ques
c_cond
l_string|&quot;disabled&quot;
suffix:colon
l_string|&quot;enabled&quot;
comma
(paren
id|month
op_amp
id|RTC_ESQW
)paren
ques
c_cond
l_string|&quot;disabled&quot;
suffix:colon
l_string|&quot;enabled&quot;
)paren
suffix:semicolon
id|amode
op_assign
(paren
(paren
id|CMOS_READ
c_func
(paren
id|RTC_MINUTES_ALARM
)paren
op_amp
l_int|0x80
)paren
op_rshift
l_int|5
)paren
op_or
(paren
(paren
id|CMOS_READ
c_func
(paren
id|RTC_HOURS_ALARM
)paren
op_amp
l_int|0x80
)paren
op_rshift
l_int|6
)paren
op_or
(paren
(paren
id|CMOS_READ
c_func
(paren
id|RTC_DAY_ALARM
)paren
op_amp
l_int|0x80
)paren
op_rshift
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|amode
op_eq
l_int|7
)paren
id|s
op_assign
l_string|&quot;each minute&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|amode
op_eq
l_int|3
)paren
id|s
op_assign
l_string|&quot;minutes match&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|amode
op_eq
l_int|1
)paren
id|s
op_assign
l_string|&quot;hours and minutes match&quot;
suffix:semicolon
r_else
r_if
c_cond
(paren
id|amode
op_eq
l_int|0
)paren
id|s
op_assign
l_string|&quot;days, hours and minutes match&quot;
suffix:semicolon
r_else
id|s
op_assign
l_string|&quot;invalid&quot;
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;alarm_mode&bslash;t: %s&bslash;n&quot;
comma
id|s
)paren
suffix:semicolon
id|cmd
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;alarm_enable&bslash;t: %s&bslash;n&quot;
l_string|&quot;wdog_alarm&bslash;t: %s&bslash;n&quot;
l_string|&quot;alarm_mask&bslash;t: %s&bslash;n&quot;
l_string|&quot;wdog_alarm_mask&bslash;t: %s&bslash;n&quot;
l_string|&quot;interrupt_mode&bslash;t: %s&bslash;n&quot;
l_string|&quot;INTB_mode&bslash;t: %s_active&bslash;n&quot;
l_string|&quot;interrupt_pins&bslash;t: %s&bslash;n&quot;
comma
(paren
id|cmd
op_amp
id|RTC_TDF
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
(paren
id|cmd
op_amp
id|RTC_WAF
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
(paren
id|cmd
op_amp
id|RTC_TDM
)paren
ques
c_cond
l_string|&quot;disabled&quot;
suffix:colon
l_string|&quot;enabled&quot;
comma
(paren
id|cmd
op_amp
id|RTC_WAM
)paren
ques
c_cond
l_string|&quot;disabled&quot;
suffix:colon
l_string|&quot;enabled&quot;
comma
(paren
id|cmd
op_amp
id|RTC_PU_LVL
)paren
ques
c_cond
l_string|&quot;pulse&quot;
suffix:colon
l_string|&quot;level&quot;
comma
(paren
id|cmd
op_amp
id|RTC_IBH_LO
)paren
ques
c_cond
l_string|&quot;low&quot;
suffix:colon
l_string|&quot;high&quot;
comma
(paren
id|cmd
op_amp
id|RTC_IPSW
)paren
ques
c_cond
l_string|&quot;unswapped&quot;
suffix:colon
l_string|&quot;swapped&quot;
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buf
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns true if a clock update is in progress&n; */
DECL|function|ds1286_is_updating
r_static
r_inline
r_int
r_char
id|ds1286_is_updating
c_func
(paren
r_void
)paren
(brace
r_return
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
op_amp
id|RTC_TE
suffix:semicolon
)brace
DECL|function|get_rtc_time
r_void
id|get_rtc_time
c_func
(paren
r_struct
id|rtc_time
op_star
id|rtc_tm
)paren
(brace
r_int
r_int
id|uip_watchdog
op_assign
id|jiffies
suffix:semicolon
r_int
r_char
id|save_control
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;&t; * read RTC once any update in progress is done. The update&n;&t; * can take just over 2ms. We wait 10 to 20ms. There is no need to&n;&t; * to poll-wait (up to 1s - eeccch) for the falling edge of RTC_UIP.&n;&t; * If you need to know *exactly* when a second has started, enable&n;&t; * periodic update complete interrupts, (via ioctl) and then &n;&t; * immediately read /dev/rtc which will block until you get the IRQ.&n;&t; * Once the read clears, read the RTC time (again via ioctl). Easy.&n;&t; */
r_if
c_cond
(paren
id|ds1286_is_updating
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_while
c_loop
(paren
id|jiffies
op_minus
id|uip_watchdog
OL
l_int|2
op_star
id|HZ
op_div
l_int|100
)paren
id|barrier
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Only the values that we read from the RTC are set. We leave&n;&t; * tm_wday, tm_yday and tm_isdst untouched. Even though the&n;&t; * RTC has RTC_DAY_OF_WEEK, we ignore it, as it is only updated&n;&t; * by the RTC when initially set to a non-zero value.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
id|save_control
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
(paren
id|save_control
op_or
id|RTC_TE
)paren
comma
id|RTC_CMD
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_sec
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_SECONDS
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_min
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_MINUTES
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_hour
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_HOURS
)paren
op_amp
l_int|0x1f
suffix:semicolon
id|rtc_tm-&gt;tm_mday
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_DATE
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_mon
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_MONTH
)paren
op_amp
l_int|0x1f
suffix:semicolon
id|rtc_tm-&gt;tm_year
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_YEAR
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|save_control
comma
id|RTC_CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_sec
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_min
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_hour
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_mday
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_mon
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_year
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Account for differences between how the RTC uses the values&n;&t; * and how they are defined in a struct rtc_time;&n;&t; */
r_if
c_cond
(paren
id|rtc_tm-&gt;tm_year
OL
l_int|45
)paren
id|rtc_tm-&gt;tm_year
op_add_assign
l_int|30
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rtc_tm-&gt;tm_year
op_add_assign
l_int|40
)paren
OL
l_int|70
)paren
id|rtc_tm-&gt;tm_year
op_add_assign
l_int|100
suffix:semicolon
id|rtc_tm-&gt;tm_mon
op_decrement
suffix:semicolon
)brace
DECL|function|get_rtc_alm_time
r_void
id|get_rtc_alm_time
c_func
(paren
r_struct
id|rtc_time
op_star
id|alm_tm
)paren
(brace
r_int
r_char
id|cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;&t; * Only the values that we read from the RTC are set. That&n;&t; * means only tm_wday, tm_hour, tm_min.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
id|alm_tm-&gt;tm_min
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_MINUTES_ALARM
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|alm_tm-&gt;tm_hour
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_HOURS_ALARM
)paren
op_amp
l_int|0x1f
suffix:semicolon
id|alm_tm-&gt;tm_wday
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_DAY_ALARM
)paren
op_amp
l_int|0x07
suffix:semicolon
id|cmd
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_CMD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ds1286_lock
comma
id|flags
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|alm_tm-&gt;tm_min
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|alm_tm-&gt;tm_hour
)paren
suffix:semicolon
id|alm_tm-&gt;tm_sec
op_assign
l_int|0
suffix:semicolon
)brace
eof
