multiline_comment|/*&n; * usema.c: software semaphore driver (see IRIX&squot;s usema(7M))&n; * written 1997 Mike Shaver (shaver@neon.ingenia.ca)&n; *         1997 Miguel de Icaza (miguel@kernel.org)&n; *&n; * This file contains the implementation of /dev/usemaclone,&n; * the devices used by IRIX&squot;s us* semaphore routines.&n; *&n; * /dev/usemaclone is used to create a new semaphore device, and then&n; * the semaphore is manipulated via ioctls.&n; *&n; * At least for the zero-contention case, lock set and unset as well&n; * as semaphore P and V are done in userland, which makes things a&n; * little bit better.  I suspect that the ioctls are used to register&n; * the process as blocking, etc.&n; *&n; * Much inspiration and structure stolen from Miguel&squot;s shmiq work.&n; *&n; * For more information:&n; * usema(7m), usinit(3p), usnewsema(3p)&n; * /usr/include/sys/usioctl.h &n; *&n;*/
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/dcache.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &quot;usema.h&quot;
macro_line|#include &lt;asm/usioctl.h&gt;
macro_line|#include &lt;asm/mman.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|struct|irix_usema
r_struct
id|irix_usema
(brace
DECL|member|filp
r_struct
id|file
op_star
id|filp
suffix:semicolon
DECL|member|proc_list
id|wait_queue_head_t
id|proc_list
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|sgi_usema_attach
id|sgi_usema_attach
(paren
id|usattach_t
op_star
id|attach
comma
r_struct
id|irix_usema
op_star
id|usema
)paren
(brace
r_int
id|newfd
suffix:semicolon
id|newfd
op_assign
id|get_unused_fd
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newfd
OL
l_int|0
)paren
r_return
id|newfd
suffix:semicolon
id|get_file
c_func
(paren
id|usema-&gt;filp
)paren
suffix:semicolon
id|fd_install
c_func
(paren
id|newfd
comma
id|usema-&gt;filp
)paren
suffix:semicolon
multiline_comment|/* Is that it? */
id|printk
c_func
(paren
l_string|&quot;UIOCATTACHSEMA: new usema fd is %d&quot;
comma
id|newfd
)paren
suffix:semicolon
r_return
id|newfd
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgi_usemaclone_ioctl
id|sgi_usemaclone_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|irix_usema
op_star
id|usema
op_assign
id|file-&gt;private_data
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;[%s:%d] wants ioctl 0x%xd (arg 0x%lx)&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|UIOCATTACHSEMA
suffix:colon
(brace
multiline_comment|/* They pass us information about the semaphore to&n;&t;&t;   which they wish to be attached, and we create&amp;return&n;&t;&t;   a new fd corresponding to the appropriate semaphore.&n;&t;&t;   */
id|usattach_t
op_star
id|attach
op_assign
(paren
id|usattach_t
op_star
)paren
id|arg
suffix:semicolon
id|retval
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|attach
comma
r_sizeof
(paren
id|usattach_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;[%s:%d] sgi_usema_ioctl(UIOCATTACHSEMA): &quot;
l_string|&quot;verify_area failure&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usema
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;UIOCATTACHSEMA: attaching usema %p to process %d&bslash;n&quot;
comma
id|usema
comma
id|current-&gt;pid
)paren
suffix:semicolon
multiline_comment|/* XXX what is attach-&gt;us_handle for? */
r_return
id|sgi_usema_attach
c_func
(paren
id|attach
comma
id|usema
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|UIOCABLOCK
suffix:colon
multiline_comment|/* XXX make `async&squot; */
r_case
id|UIOCNOIBLOCK
suffix:colon
multiline_comment|/* XXX maybe? */
r_case
id|UIOCBLOCK
suffix:colon
(brace
multiline_comment|/* Block this process on the semaphore */
id|usattach_t
op_star
id|attach
op_assign
(paren
id|usattach_t
op_star
)paren
id|arg
suffix:semicolon
id|retval
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|attach
comma
r_sizeof
(paren
id|usattach_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;[%s:%d] sgi_usema_ioctl(UIOC*BLOCK): &quot;
l_string|&quot;verify_area failure&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;UIOC*BLOCK: putting process %d to sleep on usema %p&quot;
comma
id|current-&gt;pid
comma
id|usema
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|UIOCNOIBLOCK
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|usema-&gt;proc_list
)paren
suffix:semicolon
r_else
id|sleep_on
c_func
(paren
op_amp
id|usema-&gt;proc_list
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|UIOCAUNBLOCK
suffix:colon
multiline_comment|/* XXX make `async&squot; */
r_case
id|UIOCUNBLOCK
suffix:colon
(brace
multiline_comment|/* Wake up all process waiting on this semaphore */
id|usattach_t
op_star
id|attach
op_assign
(paren
id|usattach_t
op_star
)paren
id|arg
suffix:semicolon
id|retval
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|attach
comma
r_sizeof
(paren
id|usattach_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;[%s:%d] sgi_usema_ioctl(UIOC*BLOCK): &quot;
l_string|&quot;verify_area failure&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;[%s:%d] releasing usema %p&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|usema
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|usema-&gt;proc_list
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|sgi_usemaclone_poll
id|sgi_usemaclone_poll
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|irix_usema
op_star
id|usema
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;[%s:%d] wants to poll usema %p&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|usema
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgi_usemaclone_open
id|sgi_usemaclone_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|irix_usema
op_star
id|usema
suffix:semicolon
id|usema
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|irix_usema
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usema
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|usema-&gt;filp
op_assign
id|filp
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|usema-&gt;proc_list
)paren
suffix:semicolon
id|filp-&gt;private_data
op_assign
id|usema
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sgi_usemaclone_fops
r_struct
id|file_operations
id|sgi_usemaclone_fops
op_assign
(brace
id|poll
suffix:colon
id|sgi_usemaclone_poll
comma
id|ioctl
suffix:colon
id|sgi_usemaclone_ioctl
comma
id|open
suffix:colon
id|sgi_usemaclone_open
comma
)brace
suffix:semicolon
DECL|variable|dev_usemaclone
r_static
r_struct
id|miscdevice
id|dev_usemaclone
op_assign
(brace
id|SGI_USEMACLONE
comma
l_string|&quot;usemaclone&quot;
comma
op_amp
id|sgi_usemaclone_fops
)brace
suffix:semicolon
r_void
DECL|function|usema_init
id|usema_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;usemaclone misc device registered (minor: %d)&bslash;n&quot;
comma
id|SGI_USEMACLONE
)paren
suffix:semicolon
id|misc_register
c_func
(paren
op_amp
id|dev_usemaclone
)paren
suffix:semicolon
)brace
eof
