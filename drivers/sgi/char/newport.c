multiline_comment|/*&n; * newport.c: context switching the newport graphics card and&n; *            newport graphics support.&n; *&n; * Author: Miguel de Icaza&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/gfx.h&gt;
macro_line|#include &lt;asm/ng1.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;video/newport.h&gt;
macro_line|#include &lt;linux/module.h&gt;
DECL|variable|npregs
r_struct
id|newport_regs
op_star
id|npregs
suffix:semicolon
multiline_comment|/* Kernel routines for supporting graphics context switching */
DECL|function|newport_save
r_void
id|newport_save
(paren
r_void
op_star
id|y
)paren
(brace
id|newport_ctx
op_star
id|x
op_assign
id|y
suffix:semicolon
id|newport_wait
(paren
)paren
suffix:semicolon
DECL|macro|LOAD
mdefine_line|#define LOAD(val) x-&gt;val = npregs-&gt;set.val;
DECL|macro|LOADI
mdefine_line|#define LOADI(val) x-&gt;val = npregs-&gt;set.val.word;
DECL|macro|LOADC
mdefine_line|#define LOADC(val) x-&gt;val = npregs-&gt;cset.val;
id|LOAD
c_func
(paren
id|drawmode1
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|drawmode0
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|lsmode
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|lspattern
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|lspatsave
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|zpattern
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|colorback
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|colorvram
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|alpharef
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|smask0x
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|smask0y
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|_xstart
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|_ystart
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|_xend
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|_yend
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|xsave
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|xymove
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|bresd
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|bress1
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|bresoctinc1
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|bresrndinc2
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|brese1
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|bress2
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|aweight0
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|aweight1
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|colorred
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|coloralpha
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|colorgrn
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|colorblue
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|slopered
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|slopealpha
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|slopegrn
)paren
suffix:semicolon
id|LOADI
c_func
(paren
id|slopeblue
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|wrmask
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|hostrw0
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|hostrw1
)paren
suffix:semicolon
multiline_comment|/* configregs */
id|LOADC
c_func
(paren
id|smask1x
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|smask1y
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|smask2x
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|smask2y
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|smask3x
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|smask3y
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|smask4x
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|smask4y
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|topscan
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|xywin
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|clipmode
)paren
suffix:semicolon
id|LOADC
c_func
(paren
id|config
)paren
suffix:semicolon
multiline_comment|/* Mhm, maybe I am missing something, but it seems that&n;&t; * saving/restoring the DCB is only a matter of saving these&n;&t; * registers&n;&t; */
id|newport_bfwait
(paren
)paren
suffix:semicolon
id|LOAD
(paren
id|dcbmode
)paren
suffix:semicolon
id|newport_bfwait
(paren
)paren
suffix:semicolon
id|x-&gt;dcbdata0
op_assign
id|npregs-&gt;set.dcbdata0.byword
suffix:semicolon
id|newport_bfwait
(paren
)paren
suffix:semicolon
id|LOAD
c_func
(paren
id|dcbdata1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Importat things to keep in mind when restoring the newport context:&n; *&n; * 1. slopered register is stored as a 2&squot;s complete (s12.11);&n; *    needs to be converted to a signed magnitude (s(8)12.11).&n; *&n; * 2. xsave should be stored after xstart.&n; *&n; * 3. None of the registers should be written with the GO address.&n; *    (read the docs for more details on this).&n; */
DECL|function|newport_restore
r_void
id|newport_restore
(paren
r_void
op_star
id|y
)paren
(brace
id|newport_ctx
op_star
id|x
op_assign
id|y
suffix:semicolon
DECL|macro|STORE
mdefine_line|#define STORE(val) npregs-&gt;set.val = x-&gt;val
DECL|macro|STOREI
mdefine_line|#define STOREI(val) npregs-&gt;set.val.word = x-&gt;val
DECL|macro|STOREC
mdefine_line|#define STOREC(val) npregs-&gt;cset.val = x-&gt;val
id|newport_wait
(paren
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|drawmode1
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|drawmode0
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|lsmode
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|lspattern
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|lspatsave
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|zpattern
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|colorback
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|colorvram
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|alpharef
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|smask0x
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|smask0y
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|_xstart
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|_ystart
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|_xend
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|_yend
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|xsave
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|xymove
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|bresd
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|bress1
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|bresoctinc1
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|bresrndinc2
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|brese1
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|bress2
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|aweight0
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|aweight1
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|colorred
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|coloralpha
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|colorgrn
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|colorblue
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|slopered
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|slopealpha
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|slopegrn
)paren
suffix:semicolon
id|STOREI
c_func
(paren
id|slopeblue
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|wrmask
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|hostrw0
)paren
suffix:semicolon
id|STORE
c_func
(paren
id|hostrw1
)paren
suffix:semicolon
multiline_comment|/* configregs */
id|STOREC
c_func
(paren
id|smask1x
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|smask1y
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|smask2x
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|smask2y
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|smask3x
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|smask3y
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|smask4x
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|smask4y
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|topscan
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|xywin
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|clipmode
)paren
suffix:semicolon
id|STOREC
c_func
(paren
id|config
)paren
suffix:semicolon
multiline_comment|/* FIXME: restore dcb thingies */
)brace
r_int
DECL|function|newport_ioctl
id|newport_ioctl
(paren
r_int
id|card
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|NG1_SETDISPLAYMODE
suffix:colon
(brace
r_struct
id|ng1_setdisplaymode_args
id|request
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|request
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|request
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|newport_wait
(paren
)paren
suffix:semicolon
id|newport_bfwait
(paren
)paren
suffix:semicolon
id|npregs-&gt;set.dcbmode
op_assign
id|DCB_XMAP0
op_or
id|XM9_CRS_FIFO_AVAIL
op_or
id|DCB_DATAWIDTH_1
op_or
id|R_DCB_XMAP9_PROTOCOL
suffix:semicolon
id|xmap9FIFOWait
(paren
id|npregs
)paren
suffix:semicolon
multiline_comment|/* FIXME: timing is wrong, just be extracted from &n;&t;&t; * the per-board timing table.  I still have to figure&n;&t;&t; * out where this comes from&n;&t;&t; *&n;&t;&t; * This is used to select the protocol used to talk to&n;&t;&t; * the xmap9.  For now I am using 60, selecting the&n;&t;&t; * WSLOW_DCB_XMAP9_PROTOCOL.&n;&t;&t; *&n;&t;&t; * Robert Tray comments on this issue:&n;&t;&t; *&n;&t;&t; * cfreq refers to the frequency of the monitor&n;&t;&t; * (ie. the refresh rate).  Our monitors run typically&n;&t;&t; * between 60 Hz and 76 Hz.  But it will be as low as&n;&t;&t; * 50 Hz if you&squot;re displaying NTSC/PAL and as high as&n;&t;&t; * 120 Hz if you are runining in stereo mode.  You&n;&t;&t; * might want to try the WSLOW values.&n;&t;&t; */
id|xmap9SetModeReg
(paren
id|npregs
comma
id|request.wid
comma
id|request.mode
comma
l_int|60
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|NG1_SET_CURSOR_HOTSPOT
suffix:colon
(brace
r_struct
id|ng1_set_cursor_hotspot
id|request
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|request
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|request
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* FIXME: make request.xhot, request.yhot the hot spot */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|NG1_SETGAMMARAMP0
suffix:colon
multiline_comment|/* FIXME: load the gamma ramps :-) */
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
eof
