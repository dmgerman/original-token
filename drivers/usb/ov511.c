multiline_comment|/*&n; * OmniVision OV511 Camera-to-USB Bridge Driver&n; * Copyright 1999 Mark W. McClelland&n; *&n; * Based on the Linux CPiA driver.&n; * &n; * Released under GPL v.2 license.&n; *&n; * Important keywords in comments:&n; *    CAMERA SPECIFIC - Camera specific code; may not work with other cameras.&n; *    DEBUG - Debugging code.&n; *    FIXME - Something that is broken or needs improvement.&n; *&n; * Version History:&n; *    Version 1.00 - Initial version&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
multiline_comment|/* Handle mangled (versioned) external symbols */
macro_line|#include &lt;linux/autoconf.h&gt; /* retrieve the CONFIG_* macros */
macro_line|#if defined(CONFIG_MODVERSIONS) &amp;&amp; !defined(MODVERSIONS)
DECL|macro|MODVERSIONS
macro_line|#&t;define MODVERSIONS  /* force it on */
macro_line|#endif
macro_line|#ifdef MODVERSIONS
macro_line|#include &lt;linux/modversions.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;ov511.h&quot;
multiline_comment|/* Video Size 384 x 288 x 3 bytes for RGB */
DECL|macro|MAX_FRAME_SIZE
mdefine_line|#define MAX_FRAME_SIZE (384 * 288 * 3)
singleline_comment|// FIXME - Force CIF to make some apps happy for the moment. Should find a 
singleline_comment|//         better way to do this.
DECL|macro|DEFAULT_WIDTH
mdefine_line|#define DEFAULT_WIDTH 384
DECL|macro|DEFAULT_HEIGHT
mdefine_line|#define DEFAULT_HEIGHT 288
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
multiline_comment|/*******************************/
multiline_comment|/* Memory management functions */
multiline_comment|/*******************************/
DECL|macro|MDEBUG
mdefine_line|#define MDEBUG(x)&t;do { } while(0)&t;&t;/* Debug memory management */
DECL|variable|ov511_driver
r_static
r_struct
id|usb_driver
id|ov511_driver
suffix:semicolon
multiline_comment|/* Given PGD from the address space&squot;s page table, return the kernel&n; * virtual mapping of the physical memory mapped at ADR.&n; */
DECL|function|uvirt_to_kva
r_static
r_inline
r_int
r_int
id|uvirt_to_kva
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|ret
op_assign
l_int|0UL
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|adr
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
id|ret
op_assign
id|page_address
c_func
(paren
id|pte_page
c_func
(paren
id|pte
)paren
)paren
op_or
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;uv2kva(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|uvirt_to_bus
r_static
r_inline
r_int
r_int
id|uvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|kva
comma
id|ret
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|adr
)paren
comma
id|adr
)paren
suffix:semicolon
id|ret
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|kva
)paren
suffix:semicolon
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;uv2b(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|kvirt_to_bus
r_static
r_inline
r_int
r_int
id|kvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|kva
)paren
suffix:semicolon
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;kv2b(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Here we want the physical address of the memory.&n; * This is used when initializing the contents of the&n; * area and marking the pages as reserved.&n; */
DECL|function|kvirt_to_pa
r_static
r_inline
r_int
r_int
id|kvirt_to_pa
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|__pa
c_func
(paren
id|kva
)paren
suffix:semicolon
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;kv2pa(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
multiline_comment|/* Round it off to PAGE_SIZE */
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|mem
op_assign
id|vmalloc
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|MAP_NR
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|MAP_NR
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
DECL|function|usb_ov511_reg_write
r_int
id|usb_ov511_reg_write
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|2
multiline_comment|/* REG_IO */
comma
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
(paren
id|__u16
)paren
id|reg
comma
op_amp
id|value
comma
l_int|1
comma
id|HZ
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;reg write: 0x%X:0x%X&bslash;n&quot;
comma
id|reg
comma
id|value
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* returns: negative is error, pos or zero is data */
DECL|function|usb_ov511_reg_read
r_int
id|usb_ov511_reg_read
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
r_char
id|buffer
(braket
l_int|1
)braket
suffix:semicolon
id|rc
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|2
multiline_comment|/* REG_IO */
comma
id|USB_DIR_IN
op_or
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
(paren
id|__u16
)paren
id|reg
comma
id|buffer
comma
l_int|1
comma
id|HZ
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;reg read: 0x%X:0x%X&bslash;n&quot;
comma
id|reg
comma
id|buffer
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
r_else
r_return
id|buffer
(braket
l_int|0
)braket
suffix:semicolon
)brace
DECL|function|usb_ov511_cam_reg_write
r_int
id|usb_ov511_cam_reg_write
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
id|rc
suffix:semicolon
singleline_comment|// Three byte write cycle
singleline_comment|//    Set slave ID (This might only need to be done once)
singleline_comment|//    (CAMERA SPECIFIC (OV7610/OV7110))
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SLAVE_ID_WRITE
comma
id|OV7610_I2C_WRITE_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
singleline_comment|//    Select camera register (I2C sub-address)
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SUB_ADDRESS_3_BYTE
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
singleline_comment|//    Write &quot;value&quot; to I2C data port of OV511
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_DATA_PORT
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
singleline_comment|// FIXME - should ensure bus is idle before continuing
singleline_comment|//    Initiate 3-byte write cycle
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x01
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* returns: negative is error, pos or zero is data */
DECL|function|usb_ov511_cam_reg_read
r_int
id|usb_ov511_cam_reg_read
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|rc
suffix:semicolon
singleline_comment|// Two byte write cycle
singleline_comment|//    Set slave ID (This might only need to be done once)
singleline_comment|//    (CAMERA SPECIFIC (OV7610/OV7110))
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SLAVE_ID_WRITE
comma
id|OV7610_I2C_WRITE_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
singleline_comment|//    Select camera register (I2C sub-address)
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SUB_ADDRESS_2_BYTE
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
singleline_comment|//    Initiate 2-byte write cycle
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x03
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
singleline_comment|// Two byte read cycle
singleline_comment|//    Set slave ID (This might only need to be done once)
singleline_comment|//    (CAMERA SPECIFIC (OV7610/OV7110))
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SLAVE_ID_READ
comma
id|OV7610_I2C_READ_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
singleline_comment|//    Initiate 2-byte read cycle
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x05
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
singleline_comment|// FIXME - should check I2C bus status here before reading data!
singleline_comment|//    Write &quot;value&quot; to I2C data port of OV511
r_return
id|usb_ov511_reg_read
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_DATA_PORT
)paren
suffix:semicolon
)brace
DECL|function|usb_ov511_reset
r_int
id|usb_ov511_reset
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reset_type
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;Reset: type=0x%X&bslash;n&quot;
comma
id|reset_type
)paren
suffix:semicolon
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_SYSTEM_RESET
comma
id|reset_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: reset: command failed&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_SYSTEM_RESET
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: reset: command failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|usb_ov511_set_packet_size
r_int
id|usb_ov511_set_packet_size
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
r_int
id|size
)paren
(brace
r_int
id|alt
comma
id|multiplier
comma
id|err
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;set packet size: %d&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
l_int|992
suffix:colon
id|alt
op_assign
l_int|0
suffix:semicolon
id|multiplier
op_assign
l_int|31
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|993
suffix:colon
id|alt
op_assign
l_int|1
suffix:semicolon
id|multiplier
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|768
suffix:colon
id|alt
op_assign
l_int|2
suffix:semicolon
id|multiplier
op_assign
l_int|24
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|769
suffix:colon
id|alt
op_assign
l_int|3
suffix:semicolon
id|multiplier
op_assign
l_int|25
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|512
suffix:colon
id|alt
op_assign
l_int|4
suffix:semicolon
id|multiplier
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|513
suffix:colon
id|alt
op_assign
l_int|5
suffix:semicolon
id|multiplier
op_assign
l_int|17
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|257
suffix:colon
id|alt
op_assign
l_int|6
suffix:semicolon
id|multiplier
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
id|alt
op_assign
l_int|7
suffix:semicolon
id|multiplier
op_assign
l_int|1
suffix:semicolon
singleline_comment|// FIXME - is this correct?
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511_set_packet_size: invalid size (%d)&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|usb_ov511_reg_write
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_REG_FIFO_PACKET_SIZE
comma
id|multiplier
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: Set packet size: Set FIFO size ret %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|ov511-&gt;dev
comma
id|ov511-&gt;iface
comma
id|alt
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: Set packet size: set interface error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
singleline_comment|// FIXME - Should we only reset the FIFO?
r_if
c_cond
(paren
id|usb_ov511_reset
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_RESET_NOREGS
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* How much data is left in the scratch buf? */
DECL|macro|scratch_left
mdefine_line|#define scratch_left(x)&t;(ov511-&gt;scratchlen - (int)((char *)x - (char *)ov511-&gt;scratch))
singleline_comment|// FIXME - Useless stub
DECL|function|ov511_parse_data
r_static
r_void
id|ov511_parse_data
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;ov511_parse_data not implemented&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|// TEMPORARY CODE
)brace
DECL|function|ov511_compress_isochronous
r_static
r_int
id|ov511_compress_isochronous
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
id|urb_t
op_star
id|urb
)paren
(brace
r_int
r_char
op_star
id|cdata
comma
op_star
id|data
suffix:semicolon
r_int
id|i
comma
id|totlen
op_assign
l_int|0
suffix:semicolon
id|data
op_assign
id|ov511-&gt;scratch
op_plus
id|ov511-&gt;scratchlen
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|n
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
suffix:semicolon
r_int
id|st
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
suffix:semicolon
id|cdata
op_assign
id|urb-&gt;transfer_buffer
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
(brace
singleline_comment|// Macro - must be in braces!
id|PDEBUG
c_func
(paren
l_string|&quot;data error: [%d] len=%d, status=%d&bslash;n&quot;
comma
id|i
comma
id|n
comma
id|st
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ov511-&gt;scratchlen
op_plus
id|n
)paren
OG
id|SCRATCH_BUF_SIZE
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;scratch buf overflow!scr_len: %d, n: %d&bslash;n&quot;
comma
id|ov511-&gt;scratchlen
comma
id|n
)paren
suffix:semicolon
r_return
id|totlen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
)paren
(brace
id|memmove
c_func
(paren
id|data
comma
id|cdata
comma
id|n
)paren
suffix:semicolon
id|data
op_add_assign
id|n
suffix:semicolon
id|totlen
op_add_assign
id|n
suffix:semicolon
id|ov511-&gt;scratchlen
op_add_assign
id|n
suffix:semicolon
)brace
)brace
r_return
id|totlen
suffix:semicolon
)brace
DECL|function|ov511_isoc_irq
r_static
r_void
id|ov511_isoc_irq
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|len
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
id|urb-&gt;context
suffix:semicolon
r_struct
id|ov511_sbuf
op_star
id|sbuf
suffix:semicolon
r_int
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;ov511_isoc_irq: %p status %d, errcount = %d, length = %d&bslash;n&quot;
comma
id|urb
comma
id|urb-&gt;status
comma
id|urb-&gt;error_count
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;streaming
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;hmmm... not streaming, but got interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sbuf
op_assign
op_amp
id|ov511-&gt;sbuf
(braket
id|ov511-&gt;cursbuf
)braket
suffix:semicolon
singleline_comment|//&t;usb_kill_isoc(sbuf-&gt;isodesc);
multiline_comment|/* Copy the data received into our scratch buffer */
id|len
op_assign
id|ov511_compress_isochronous
c_func
(paren
id|ov511
comma
id|urb
)paren
suffix:semicolon
multiline_comment|/* If we don&squot;t have a frame we&squot;re current working on, complain */
r_if
c_cond
(paren
id|ov511-&gt;scratchlen
)paren
(brace
r_if
c_cond
(paren
id|ov511-&gt;curframe
OL
l_int|0
)paren
(brace
singleline_comment|// Macro - must be in braces!!
id|PDEBUG
c_func
(paren
l_string|&quot;received data, but no frame available&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|ov511_parse_data
c_func
(paren
id|ov511
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sbuf-&gt;urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|sbuf-&gt;urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Move to the next sbuf */
id|ov511-&gt;cursbuf
op_assign
(paren
id|ov511-&gt;cursbuf
op_plus
l_int|1
)paren
op_mod
id|OV511_NUMSBUF
suffix:semicolon
multiline_comment|/* Reschedule this block of Isochronous desc */
singleline_comment|//&t;usb_run_isoc(sbuf-&gt;isodesc, ov511-&gt;sbuf[ov511-&gt;cursbuf].isodesc);
r_return
suffix:semicolon
)brace
DECL|function|ov511_init_isoc
r_static
r_int
id|ov511_init_isoc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
r_int
id|fx
comma
id|err
suffix:semicolon
id|ov511-&gt;compress
op_assign
l_int|0
suffix:semicolon
id|ov511-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
id|ov511-&gt;cursbuf
op_assign
l_int|0
suffix:semicolon
id|ov511-&gt;scratchlen
op_assign
l_int|0
suffix:semicolon
singleline_comment|// FIXME - is this the proper size?
id|usb_ov511_set_packet_size
c_func
(paren
id|ov511
comma
l_int|512
)paren
suffix:semicolon
multiline_comment|/* We double buffer the Iso lists */
id|urb
op_assign
id|usb_alloc_urb
c_func
(paren
id|FRAMES_PER_DESC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511_init_isoc: usb_alloc_urb ret. NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|urb
op_assign
id|urb
suffix:semicolon
id|urb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|urb-&gt;context
op_assign
id|ov511
suffix:semicolon
id|urb-&gt;pipe
op_assign
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
id|OV511_ENDPOINT_ADDRESS
)paren
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
id|USB_ISO_ASAP
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
suffix:semicolon
id|urb-&gt;complete
op_assign
id|ov511_isoc_irq
suffix:semicolon
id|urb-&gt;number_of_packets
op_assign
id|FRAMES_PER_DESC
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_assign
id|FRAME_SIZE_PER_DESC
op_star
id|FRAMES_PER_DESC
suffix:semicolon
r_for
c_loop
(paren
id|fx
op_assign
l_int|0
suffix:semicolon
id|fx
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|fx
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|fx
)braket
dot
id|offset
op_assign
id|FRAME_SIZE_PER_DESC
op_star
id|fx
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|fx
)braket
dot
id|length
op_assign
id|FRAME_SIZE_PER_DESC
suffix:semicolon
)brace
id|urb
op_assign
id|usb_alloc_urb
c_func
(paren
id|FRAMES_PER_DESC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511_init_isoc: usb_alloc_urb ret. NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|urb
op_assign
id|urb
suffix:semicolon
id|urb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|urb-&gt;context
op_assign
id|ov511
suffix:semicolon
id|urb-&gt;pipe
op_assign
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
id|OV511_ENDPOINT_ADDRESS
)paren
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
id|USB_ISO_ASAP
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
suffix:semicolon
id|urb-&gt;complete
op_assign
id|ov511_isoc_irq
suffix:semicolon
id|urb-&gt;number_of_packets
op_assign
id|FRAMES_PER_DESC
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_assign
id|FRAME_SIZE_PER_DESC
op_star
id|FRAMES_PER_DESC
suffix:semicolon
r_for
c_loop
(paren
id|fx
op_assign
l_int|0
suffix:semicolon
id|fx
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|fx
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|fx
)braket
dot
id|offset
op_assign
id|FRAME_SIZE_PER_DESC
op_star
id|fx
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|fx
)braket
dot
id|length
op_assign
id|FRAME_SIZE_PER_DESC
suffix:semicolon
)brace
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|urb-&gt;next
op_assign
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|urb
suffix:semicolon
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|urb-&gt;next
op_assign
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|urb
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511_init_isoc: usb_run_isoc(0) ret %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511_init_isoc: usb_run_isoc(1) ret %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|ov511-&gt;streaming
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ov511_stop_isoc
r_static
r_void
id|ov511_stop_isoc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;streaming
)paren
r_return
suffix:semicolon
singleline_comment|// FIXME - Figure out how to do this with the ov511 (Does the below do it?)
singleline_comment|//&t;/* Turn off continuous grab */
singleline_comment|//&t;if (usb_cpia_set_grab_mode(cpia-&gt;dev, 0) &lt; 0) {
singleline_comment|//&t;&t;printk(KERN_ERR &quot;cpia_set_grab_mode error&bslash;n&quot;);
singleline_comment|//&t;&t;return /* -EBUSY */;
singleline_comment|//&t;}
id|usb_ov511_set_packet_size
c_func
(paren
id|ov511
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Unschedule all of the iso td&squot;s */
id|usb_unlink_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|urb
)paren
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|urb
)paren
suffix:semicolon
id|ov511-&gt;streaming
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Delete them all */
id|usb_free_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|urb
)paren
suffix:semicolon
)brace
DECL|function|ov511_new_frame
r_static
r_int
id|ov511_new_frame
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
r_int
id|framenum
)paren
(brace
r_struct
id|ov511_frame
op_star
id|frame
suffix:semicolon
r_int
id|width
comma
id|height
suffix:semicolon
multiline_comment|/* If we&squot;re not grabbing a frame right now and the other frame is */
multiline_comment|/*  ready to be grabbed into, then use it instead */
r_if
c_cond
(paren
id|ov511-&gt;curframe
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
(paren
id|framenum
op_minus
l_int|1
op_plus
id|OV511_NUMFRAMES
)paren
op_mod
id|OV511_NUMFRAMES
)braket
dot
id|grabstate
op_eq
id|FRAME_READY
)paren
id|framenum
op_assign
(paren
id|framenum
op_minus
l_int|1
op_plus
id|OV511_NUMFRAMES
)paren
op_mod
id|OV511_NUMFRAMES
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
id|frame
op_assign
op_amp
id|ov511-&gt;frame
(braket
id|framenum
)braket
suffix:semicolon
id|width
op_assign
id|frame-&gt;width
suffix:semicolon
id|height
op_assign
id|frame-&gt;height
suffix:semicolon
id|frame-&gt;grabstate
op_assign
id|FRAME_GRABBING
suffix:semicolon
id|frame-&gt;scanstate
op_assign
id|STATE_SCANNING
suffix:semicolon
id|frame-&gt;scanlength
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* accumulated in ov511_parse_data() */
id|ov511-&gt;curframe
op_assign
id|framenum
suffix:semicolon
multiline_comment|/* Make sure it&squot;s not too big */
r_if
c_cond
(paren
id|width
OG
id|DEFAULT_WIDTH
)paren
id|width
op_assign
id|DEFAULT_WIDTH
suffix:semicolon
id|width
op_assign
(paren
id|width
op_div
l_int|8
)paren
op_star
l_int|8
suffix:semicolon
multiline_comment|/* Multiple of 8 */
r_if
c_cond
(paren
id|height
OG
id|DEFAULT_HEIGHT
)paren
id|height
op_assign
id|DEFAULT_HEIGHT
suffix:semicolon
id|height
op_assign
(paren
id|height
op_div
l_int|4
)paren
op_star
l_int|4
suffix:semicolon
multiline_comment|/* Multiple of 4 */
singleline_comment|// FIXME - Don&squot;t know how to implement the equivalent of this for the ov511
singleline_comment|//&t;/* Set the ROI they want */
singleline_comment|//&t;if (usb_cpia_set_roi(cpia-&gt;dev, 0, width / 8, 0, height / 4) &lt; 0)
singleline_comment|//&t;&t;return -EBUSY;
singleline_comment|//&t;if (usb_cpia_set_compression(cpia-&gt;dev, cpia-&gt;compress ?
singleline_comment|//&t;&t;&t;COMP_AUTO : COMP_DISABLED, DONT_DECIMATE) &lt; 0) {
singleline_comment|//&t;&t;printk(KERN_ERR &quot;cpia_set_compression error&bslash;n&quot;);
singleline_comment|//&t;&t;return -EBUSY;
singleline_comment|//&t;}
multiline_comment|/* We want a fresh frame every 30 we get */
id|ov511-&gt;compress
op_assign
(paren
id|ov511-&gt;compress
op_plus
l_int|1
)paren
op_mod
l_int|30
suffix:semicolon
singleline_comment|//&t;/* Grab the frame */
singleline_comment|//&t;if (usb_cpia_upload_frame(cpia-&gt;dev, WAIT_FOR_NEXT_FRAME) &lt; 0) {
singleline_comment|//&t;&t;printk(KERN_ERR &quot;cpia_upload_frame error&bslash;n&quot;);
singleline_comment|//&t;&t;return -EBUSY;
singleline_comment|//&t;}
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Video 4 Linux API */
DECL|function|ov511_open
r_static
r_int
id|ov511_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_int
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;ov511_open&bslash;n&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;user
)paren
r_goto
id|out_unlock
suffix:semicolon
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Allocate memory for the frame buffers */
id|ov511-&gt;fbuf
op_assign
id|rvmalloc
c_func
(paren
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;fbuf
)paren
r_goto
id|open_err_ret
suffix:semicolon
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|data
op_assign
id|ov511-&gt;fbuf
suffix:semicolon
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|data
op_assign
id|ov511-&gt;fbuf
op_plus
id|MAX_FRAME_SIZE
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;frame [0] @ %p&bslash;n&quot;
comma
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;frame [1] @ %p&bslash;n&quot;
comma
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
op_assign
id|kmalloc
c_func
(paren
id|FRAMES_PER_DESC
op_star
id|FRAME_SIZE_PER_DESC
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
r_goto
id|open_err_on0
suffix:semicolon
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
op_assign
id|kmalloc
c_func
(paren
id|FRAMES_PER_DESC
op_star
id|FRAME_SIZE_PER_DESC
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
r_goto
id|open_err_on1
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;sbuf[0] @ %p&bslash;n&quot;
comma
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;sbuf[1] @ %p&bslash;n&quot;
comma
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
multiline_comment|/* Set default sizes in case IOCTL (VIDIOCMCAPTURE) is not used&n;&t; * (using read() instead). */
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|width
op_assign
id|DEFAULT_WIDTH
suffix:semicolon
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|height
op_assign
id|DEFAULT_HEIGHT
suffix:semicolon
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|bytes_read
op_assign
l_int|0
suffix:semicolon
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|width
op_assign
id|DEFAULT_WIDTH
suffix:semicolon
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|height
op_assign
id|DEFAULT_HEIGHT
suffix:semicolon
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|bytes_read
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|ov511_init_isoc
c_func
(paren
id|ov511
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|open_err_on2
suffix:semicolon
id|ov511-&gt;user
op_increment
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|open_err_on2
suffix:colon
id|kfree
(paren
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
id|open_err_on1
suffix:colon
id|kfree
(paren
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|open_err_on0
suffix:colon
id|rvfree
c_func
(paren
id|ov511-&gt;fbuf
comma
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
suffix:semicolon
id|open_err_ret
suffix:colon
r_return
id|err
suffix:semicolon
id|out_unlock
suffix:colon
id|up
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ov511_close
r_static
r_void
id|ov511_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;ov511_close&bslash;n&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
id|ov511-&gt;user
op_decrement
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|ov511_stop_isoc
c_func
(paren
id|ov511
)paren
suffix:semicolon
id|rvfree
c_func
(paren
id|ov511-&gt;fbuf
comma
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov511-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|ov511_init_done
r_static
r_int
id|ov511_init_done
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ov511_write
r_static
r_int
id|ov511_write
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// FIXME - Needs much work!!!
DECL|function|ov511_ioctl
r_static
r_int
id|ov511_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;IOCtl: 0x%X&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|strcpy
c_func
(paren
id|b.name
comma
l_string|&quot;OV511 USB Camera&quot;
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_SUBCAPTURE
suffix:semicolon
id|b.channels
op_assign
l_int|1
suffix:semicolon
id|b.audios
op_assign
l_int|0
suffix:semicolon
id|b.maxwidth
op_assign
id|DEFAULT_WIDTH
suffix:semicolon
id|b.maxheight
op_assign
id|DEFAULT_HEIGHT
suffix:semicolon
id|b.minwidth
op_assign
l_int|8
suffix:semicolon
id|b.minheight
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v.channel
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Camera&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
id|p.colour
op_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* Damn British people :) */
id|p.hue
op_assign
l_int|0x8000
suffix:semicolon
id|p.brightness
op_assign
l_int|180
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* XXX */
id|p.contrast
op_assign
l_int|192
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* XXX */
id|p.whiteness
op_assign
l_int|105
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* XXX */
id|p.depth
op_assign
l_int|24
suffix:semicolon
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB24
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|vw.flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.clipcount
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.height
op_ne
id|DEFAULT_HEIGHT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.width
op_ne
id|DEFAULT_WIDTH
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ov511-&gt;compress
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
id|vw.x
op_assign
l_int|0
suffix:semicolon
id|vw.y
op_assign
l_int|0
suffix:semicolon
id|vw.width
op_assign
id|DEFAULT_WIDTH
suffix:semicolon
id|vw.height
op_assign
id|DEFAULT_HEIGHT
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|30
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
id|vm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vm
comma
l_int|0
comma
r_sizeof
(paren
id|vm
)paren
)paren
suffix:semicolon
id|vm.size
op_assign
id|MAX_FRAME_SIZE
op_star
l_int|2
suffix:semicolon
id|vm.frames
op_assign
l_int|2
suffix:semicolon
id|vm.offsets
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|vm.offsets
(braket
l_int|1
)braket
op_assign
id|MAX_FRAME_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;MCAPTURE&bslash;n&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;frame: %d, size: %dx%d, format: %d&bslash;n&quot;
comma
id|vm.frame
comma
id|vm.width
comma
id|vm.height
comma
id|vm.format
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vm.format
op_ne
id|VIDEO_PALETTE_RGB24
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vm.frame
op_ne
l_int|0
)paren
op_logical_and
(paren
id|vm.frame
op_ne
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Don&squot;t compress if the size changed */
r_if
c_cond
(paren
(paren
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|width
op_ne
id|vm.width
)paren
op_logical_or
(paren
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|height
op_ne
id|vm.height
)paren
)paren
id|ov511-&gt;compress
op_assign
l_int|0
suffix:semicolon
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|width
op_assign
id|vm.width
suffix:semicolon
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|height
op_assign
id|vm.height
suffix:semicolon
multiline_comment|/* Mark it as ready */
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
op_assign
id|FRAME_READY
suffix:semicolon
r_return
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|vm.frame
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
id|frame
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|frame
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;syncing to frame %d&bslash;n&quot;
comma
id|frame
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
)paren
(brace
r_case
id|FRAME_UNUSED
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|FRAME_READY
suffix:colon
r_case
id|FRAME_GRABBING
suffix:colon
r_case
id|FRAME_ERROR
suffix:colon
id|redo
suffix:colon
r_do
(brace
macro_line|#if 0
id|init_waitqueue_head
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|wq
)paren
suffix:semicolon
macro_line|#endif
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_eq
id|FRAME_ERROR
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frame
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_goto
id|redo
suffix:semicolon
)brace
r_case
id|FRAME_DONE
suffix:colon
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|vb
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vb
comma
l_int|0
comma
r_sizeof
(paren
id|vb
)paren
)paren
suffix:semicolon
id|vb.base
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* frame buffer not supported, not used */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vb
comma
r_sizeof
(paren
id|vb
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCKEY
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|VIDIOCCAPTURE
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCSFBUF
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGTUNER
suffix:colon
r_case
id|VIDIOCSTUNER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGFREQ
suffix:colon
r_case
id|VIDIOCSFREQ
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_case
id|VIDIOCSAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ov511_read
r_static
r_int
id|ov511_read
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
suffix:semicolon
r_int
id|frmx
op_assign
op_minus
l_int|1
suffix:semicolon
r_volatile
r_struct
id|ov511_frame
op_star
id|frame
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;ov511_read: %ld bytes, noblock=%d&bslash;n&quot;
comma
id|count
comma
id|noblock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* See if a frame is completed, then use it. */
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_ge
id|FRAME_DONE
)paren
multiline_comment|/* _DONE or _ERROR */
id|frmx
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_ge
id|FRAME_DONE
)paren
multiline_comment|/* _DONE or _ERROR */
id|frmx
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|noblock
op_logical_and
(paren
id|frmx
op_eq
op_minus
l_int|1
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
multiline_comment|/* If no FRAME_DONE, look for a FRAME_GRABBING state. */
multiline_comment|/* See if a frame is in process (grabbing), then use it. */
r_if
c_cond
(paren
id|frmx
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
id|frmx
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
id|frmx
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If no frame is active, start one. */
r_if
c_cond
(paren
id|frmx
op_eq
op_minus
l_int|1
)paren
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frmx
op_assign
l_int|0
)paren
suffix:semicolon
id|frame
op_assign
op_amp
id|ov511-&gt;frame
(braket
id|frmx
)braket
suffix:semicolon
id|restart
suffix:colon
r_while
c_loop
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_GRABBING
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_ERROR
)paren
(brace
id|frame-&gt;bytes_read
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511_read: errored frame %d&bslash;n&quot;
comma
id|ov511-&gt;curframe
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frmx
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511_read: ov511_new_frame error&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_string|&quot;ov511_read: frmx=%d, bytes_read=%ld, scanlength=%ld&bslash;n&quot;
comma
id|frmx
comma
id|frame-&gt;bytes_read
comma
id|frame-&gt;scanlength
)paren
suffix:semicolon
multiline_comment|/* copy bytes to user space; we allow for partials reads */
r_if
c_cond
(paren
(paren
id|count
op_plus
id|frame-&gt;bytes_read
)paren
OG
id|frame-&gt;scanlength
)paren
id|count
op_assign
id|frame-&gt;scanlength
op_minus
id|frame-&gt;bytes_read
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|frame-&gt;data
op_plus
id|frame-&gt;bytes_read
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|frame-&gt;bytes_read
op_add_assign
id|count
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;ov511_read: {copy} count used=%ld, new bytes_read=%ld&bslash;n&quot;
comma
id|count
comma
id|frame-&gt;bytes_read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;bytes_read
op_ge
id|frame-&gt;scanlength
)paren
(brace
multiline_comment|/* All data has been read */
id|frame-&gt;bytes_read
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Mark it as available to be used again. */
id|ov511-&gt;frame
(braket
id|frmx
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_if
c_cond
(paren
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frmx
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511_read: ov511_new_frame returned error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|ov511_mmap
r_static
r_int
id|ov511_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;mmap: %ld (%lX) bytes&bslash;n&quot;
comma
id|size
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
(paren
(paren
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pos
op_assign
(paren
r_int
r_int
)paren
id|ov511-&gt;fbuf
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// FIXME - needs V4L ID to be assigned
DECL|variable|ov511_template
r_static
r_struct
id|video_device
id|ov511_template
op_assign
(brace
l_string|&quot;OV511 USB Camera&quot;
comma
id|VID_TYPE_CAPTURE
comma
id|VID_HARDWARE_CPIA
comma
multiline_comment|/* FIXME */
id|ov511_open
comma
id|ov511_close
comma
id|ov511_read
comma
id|ov511_write
comma
l_int|NULL
comma
id|ov511_ioctl
comma
id|ov511_mmap
comma
id|ov511_init_done
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|function|usb_ov511_configure
r_static
r_int
id|usb_ov511_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
r_int
id|temprc
suffix:semicolon
singleline_comment|// DEBUG CODE
multiline_comment|/* Set altsetting 0 */
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|dev
comma
id|ov511-&gt;iface
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: usb_set_interface error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|ov511-&gt;vdev
comma
op_amp
id|ov511_template
comma
r_sizeof
(paren
id|ov511_template
)paren
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|wq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|ov511-&gt;vdev
comma
id|VFL_TYPE_GRABBER
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: video_register_device failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
singleline_comment|// Disable compression
r_if
c_cond
(paren
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_OMNICE_ENABLE
comma
l_int|0x00
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: disable compression: command failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
singleline_comment|// Initialize system
singleline_comment|// FIXME - This should be moved to a function
r_if
c_cond
(paren
id|usb_ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_SYSTEM_INIT
comma
l_int|0x01
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: enable system: command failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_ov511_reset
c_func
(paren
id|dev
comma
id|OV511_RESET_NOREGS
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
singleline_comment|// DEBUG - TEST CODE FOR CAMERA REG READ
id|temprc
op_assign
id|usb_ov511_cam_reg_read
c_func
(paren
id|dev
comma
l_int|0x1D
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;Camera reg 0x1D: 0x%X&bslash;n&quot;
comma
id|temprc
)paren
suffix:semicolon
singleline_comment|// END DEBUG CODE
id|ov511-&gt;compress
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|video_unregister_device
c_func
(paren
op_amp
id|ov511-&gt;vdev
)paren
suffix:semicolon
id|usb_driver_release_interface
c_func
(paren
op_amp
id|ov511_driver
comma
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|ov511-&gt;iface
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov511
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|ov511_probe
r_static
r_void
op_star
id|ov511_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|ifnum
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov511
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;probing for device...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t handle multi-config cameras */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
r_return
l_int|NULL
suffix:semicolon
id|interface
op_assign
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|ifnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Is it an OV511? */
r_if
c_cond
(paren
id|dev-&gt;descriptor.idVendor
op_ne
l_int|0x05a9
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;descriptor.idProduct
op_ne
l_int|0x0511
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Checking vendor/product should be enough, but what the hell */
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|0xFF
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|0x00
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* We found one */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ov511: USB OV511-based camera found&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ov511
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ov511
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: couldn&squot;t kmalloc ov511 struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ov511
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ov511
)paren
)paren
suffix:semicolon
id|ov511-&gt;dev
op_assign
id|dev
suffix:semicolon
id|ov511-&gt;iface
op_assign
id|interface-&gt;bInterfaceNumber
suffix:semicolon
id|rc
op_assign
id|usb_ov511_reg_read
c_func
(paren
id|dev
comma
id|OV511_REG_SYSTEM_CUSTOM_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ov511: Unable to read camera bridge registers&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
l_int|3
)paren
(brace
singleline_comment|// D-Link DSB-C300
id|printk
c_func
(paren
l_string|&quot;ov511: Camera is a D-Link DSB-C300&bslash;n&quot;
)paren
suffix:semicolon
id|ov511-&gt;customid
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
l_int|21
)paren
(brace
singleline_comment|// Creative Labs WebCam 3
id|printk
c_func
(paren
l_string|&quot;ov511: Camera is a Creative Labs WebCam 3&bslash;n&quot;
)paren
suffix:semicolon
id|ov511-&gt;customid
op_assign
l_int|21
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;ov511: Specific camera type (%d) not recognized&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ov511: Please contact mmcclelland@delphi.com to request&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ov511: support for your camera.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
singleline_comment|// Reset in case driver was unloaded and reloaded without unplug
r_if
c_cond
(paren
id|usb_ov511_reset
c_func
(paren
id|dev
comma
id|OV511_RESET_ALL
)paren
OL
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_ov511_configure
c_func
(paren
id|ov511
)paren
)paren
(brace
id|ov511-&gt;user
op_assign
l_int|0
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* to 1 == available */
r_return
id|ov511
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ov511: Failed to configure camera&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|ov511
suffix:semicolon
)brace
DECL|function|ov511_disconnect
r_static
r_void
id|ov511_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|ptr
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|ov511-&gt;vdev
)paren
suffix:semicolon
id|usb_driver_release_interface
c_func
(paren
op_amp
id|ov511_driver
comma
op_amp
id|ov511-&gt;dev-&gt;actconfig-&gt;interface
(braket
id|ov511-&gt;iface
)braket
)paren
suffix:semicolon
multiline_comment|/* Free the memory */
id|kfree
c_func
(paren
id|ov511
)paren
suffix:semicolon
id|ov511
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|variable|ov511_driver
r_static
r_struct
id|usb_driver
id|ov511_driver
op_assign
(brace
l_string|&quot;ov511&quot;
comma
id|ov511_probe
comma
id|ov511_disconnect
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|function|usb_ov511_init
r_int
id|usb_ov511_init
c_func
(paren
r_void
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;usb_ov511_init()&bslash;n&quot;
)paren
suffix:semicolon
id|EXPORT_NO_SYMBOLS
suffix:semicolon
r_return
id|usb_register
c_func
(paren
op_amp
id|ov511_driver
)paren
suffix:semicolon
)brace
DECL|function|usb_ov511_cleanup
r_void
id|usb_ov511_cleanup
c_func
(paren
r_void
)paren
(brace
id|usb_deregister
c_func
(paren
op_amp
id|ov511_driver
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_ov511_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|usb_ov511_cleanup
c_func
(paren
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;Module unloaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
