multiline_comment|/*&n; * OmniVision OV511 Camera-to-USB Bridge Driver&n; *&n; * Copyright (c) 1999-2000 Mark W. McClelland&n; * Many improvements by Bret Wallach &lt;bwallac1@san.rr.com&gt;&n; * Color fixes by by Orion Sky Lawlor &lt;olawlor@acm.org&gt; (2/26/2000)&n; * Snapshot code by Kevin Moore&n; * OV7620 fixes by Charl P. Botha &lt;cpbotha@ieee.org&gt;&n; * Changes by Claudio Matsuoka &lt;claudio@conectiva.com&gt;&n; * &n; * Based on the Linux CPiA driver written by Peter Pregler,&n; * Scott J. Bertin and Johannes Erdfelt.&n; * &n; * Please see the file: linux/Documentation/usb/ov511.txt &n; * and the website at:  http://alpha.dyndns.org/ov511&n; * for more info.&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2 of the License, or (at your&n; * option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY&n; * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; * for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
DECL|variable|version
r_static
r_const
r_char
id|version
(braket
)braket
op_assign
l_string|&quot;1.28&quot;
suffix:semicolon
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &quot;ov511.h&quot;
DECL|macro|OV511_I2C_RETRIES
mdefine_line|#define OV511_I2C_RETRIES 3
multiline_comment|/* Video Size 640 x 480 x 3 bytes for RGB */
DECL|macro|MAX_FRAME_SIZE
mdefine_line|#define MAX_FRAME_SIZE (640 * 480 * 3)
DECL|macro|MAX_DATA_SIZE
mdefine_line|#define MAX_DATA_SIZE (MAX_FRAME_SIZE + sizeof(struct timeval))
DECL|macro|GET_SEGSIZE
mdefine_line|#define GET_SEGSIZE(p) ((p) == VIDEO_PALETTE_GREY ? 256 : 384)
multiline_comment|/* PARAMETER VARIABLES: */
DECL|variable|autoadjust
r_static
r_int
id|autoadjust
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* CCD dynamically changes exposure, etc... */
multiline_comment|/* 0=no debug messages&n; * 1=init/detection/unload and other significant messages,&n; * 2=some warning messages&n; * 3=config/control function calls&n; * 4=most function calls and data parsing messages&n; * 5=highly repetitive mesgs&n; * NOTE: This should be changed to 0, 1, or 2 for production kernels&n; */
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Fix vertical misalignment of red and blue at 640x480 */
DECL|variable|fix_rgb_offset
r_static
r_int
id|fix_rgb_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Snapshot mode enabled flag */
DECL|variable|snapshot
r_static
r_int
id|snapshot
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Sensor detection override (global for all attached cameras) */
DECL|variable|sensor
r_static
r_int
id|sensor
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Increase this if you are getting &quot;Failed to read sensor ID...&quot; */
DECL|variable|i2c_detect_tries
r_static
r_int
id|i2c_detect_tries
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* For legal values, see the OV7610/7620 specs under register Common F,&n; * upper nybble  (set to 0-F) */
DECL|variable|aperture
r_static
r_int
id|aperture
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Force image to be read in RGB instead of BGR. This option allow&n; * programs that expect RGB data (e.g. gqcam) to work with this driver. */
DECL|variable|force_rgb
r_static
r_int
id|force_rgb
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Number of seconds before inactive buffers are deallocated */
DECL|variable|buf_timeout
r_static
r_int
id|buf_timeout
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* Number of cameras to stream from simultaneously */
DECL|variable|cams
r_static
r_int
id|cams
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Prevent apps from timing out if frame is not done in time */
DECL|variable|retry_sync
r_static
r_int
id|retry_sync
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Enable compression. This is for experimentation only; compressed images&n; * still cannot be decoded yet. */
DECL|variable|compress
r_static
r_int
id|compress
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Display test pattern - doesn&squot;t work yet either */
DECL|variable|testpat
r_static
r_int
id|testpat
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setting this to 1 will make the sensor output GBR422 instead on YUV420. Only&n; * affects RGB24 mode. */
DECL|variable|sensor_gbr
r_static
r_int
id|sensor_gbr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Dump raw pixel data, in one of 3 formats. See ov511_dumppix() for details. */
DECL|variable|dumppix
r_static
r_int
id|dumppix
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|autoadjust
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|autoadjust
comma
l_string|&quot;CCD dynamically changes exposure&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug level: 0=none, 1=init/detection, 2=warning, 3=config/control, 4=function call, 5=max&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fix_rgb_offset
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|fix_rgb_offset
comma
l_string|&quot;Fix vertical misalignment of red and blue at 640x480&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|snapshot
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|snapshot
comma
l_string|&quot;Enable snapshot mode&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sensor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|sensor
comma
l_string|&quot;Override sensor detection&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|i2c_detect_tries
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|i2c_detect_tries
comma
l_string|&quot;Number of tries to detect sensor&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|aperture
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|aperture
comma
l_string|&quot;Read the OV7610/7620 specs&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|force_rgb
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|force_rgb
comma
l_string|&quot;Read RGB instead of BGR&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|buf_timeout
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|buf_timeout
comma
l_string|&quot;Number of seconds before buffer deallocation&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|cams
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|cams
comma
l_string|&quot;Number of simultaneous cameras&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|retry_sync
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|retry_sync
comma
l_string|&quot;Prevent apps from timing out&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|compress
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|compress
comma
l_string|&quot;Turn on compression (not functional yet)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|testpat
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|testpat
comma
l_string|&quot;Replace image with vertical bar testpattern (only partially working)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|sensor_gbr
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|sensor_gbr
comma
l_string|&quot;Make sensor output GBR422 rather than YUV420&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dumppix
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dumppix
comma
l_string|&quot;Dump raw pixel data, in one of 3 formats. See ov511_dumppix() for details&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Mark McClelland &lt;mwm@i.am&gt; &amp; Bret Wallach &amp; Orion Sky Lawlor &lt;olawlor@acm.org&gt; &amp; Kevin Moore &amp; Charl P. Botha &lt;cpbotha@ieee.org&gt; &amp; Claudio Matsuoka &lt;claudio@conectiva.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;OV511 USB Camera Driver&quot;
)paren
suffix:semicolon
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
DECL|variable|ov511_driver
r_static
r_struct
id|usb_driver
id|ov511_driver
suffix:semicolon
multiline_comment|/* I know, I know, global variables suck. This is only a temporary hack */
DECL|variable|output_offset
r_int
id|output_offset
suffix:semicolon
multiline_comment|/**********************************************************************&n; * List of known OV511-based cameras&n; **********************************************************************/
DECL|variable|clist
r_static
r_struct
id|cam_list
id|clist
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_string|&quot;generic model (no ID)&quot;
)brace
comma
(brace
l_int|3
comma
l_string|&quot;D-Link DSB-C300&quot;
)brace
comma
(brace
l_int|4
comma
l_string|&quot;generic OV511/OV7610&quot;
)brace
comma
(brace
l_int|5
comma
l_string|&quot;Puretek PT-6007&quot;
)brace
comma
(brace
l_int|21
comma
l_string|&quot;Creative Labs WebCam 3&quot;
)brace
comma
(brace
l_int|36
comma
l_string|&quot;Koala-Cam&quot;
)brace
comma
(brace
l_int|38
comma
l_string|&quot;Lifeview USB Life TV&quot;
)brace
comma
multiline_comment|/* No support yet! */
(brace
l_int|100
comma
l_string|&quot;Lifeview RoboCam&quot;
)brace
comma
(brace
l_int|102
comma
l_string|&quot;AverMedia InterCam Elite&quot;
)brace
comma
(brace
l_int|112
comma
l_string|&quot;MediaForte MV300&quot;
)brace
comma
multiline_comment|/* or OV7110 evaluation kit */
(brace
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|device_table
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|device_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x05a9
comma
l_int|0x0511
)paren
)brace
comma
multiline_comment|/* OV511 */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x05a9
comma
l_int|0xA511
)paren
)brace
comma
multiline_comment|/* OV511+ */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x0813
comma
l_int|0x0002
)paren
)brace
comma
multiline_comment|/* Intel Play Me2Cam OV511+ */
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|device_table
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
DECL|variable|plist
r_static
r_struct
id|palette_list
id|plist
(braket
)braket
op_assign
(brace
(brace
id|VIDEO_PALETTE_GREY
comma
l_string|&quot;GREY&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_HI240
comma
l_string|&quot;HI240&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RGB565
comma
l_string|&quot;RGB565&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RGB24
comma
l_string|&quot;RGB24&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RGB32
comma
l_string|&quot;RGB32&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RGB555
comma
l_string|&quot;RGB555&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV422
comma
l_string|&quot;YUV422&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUYV
comma
l_string|&quot;YUYV&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_UYVY
comma
l_string|&quot;UYVY&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV420
comma
l_string|&quot;YUV420&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV411
comma
l_string|&quot;YUV411&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_RAW
comma
l_string|&quot;RAW&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV422P
comma
l_string|&quot;YUV422P&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV411P
comma
l_string|&quot;YUV411P&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV420P
comma
l_string|&quot;YUV420P&quot;
)brace
comma
(brace
id|VIDEO_PALETTE_YUV410P
comma
l_string|&quot;YUV410P&quot;
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|NULL
)brace
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/**********************************************************************&n; *&n; * Memory management&n; *&n; * This is a shameless copy from the USB-cpia driver (linux kernel&n; * version 2.3.29 or so, I have no idea what this code actually does ;).&n; * Actually it seems to be a copy of a shameless copy of the bttv-driver.&n; * Or that is a copy of a shameless copy of ... (To the powers: is there&n; * no generic kernel-function to do this sort of stuff?)&n; *&n; * Yes, it was a shameless copy from the bttv-driver. IIRC, Alan says&n; * there will be one, but apparentely not yet -jerdfelt&n; *&n; * So I copied it again for the OV511 driver -claudio&n; **********************************************************************/
multiline_comment|/* Given PGD from the address space&squot;s page table, return the kernel&n; * virtual mapping of the physical memory mapped at ADR.&n; */
DECL|function|uvirt_to_kva
r_static
r_inline
r_int
r_int
id|uvirt_to_kva
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|ret
op_assign
l_int|0UL
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|adr
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
(brace
id|ret
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|pte_page
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
id|ret
op_or_assign
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Here we want the physical address of the memory.&n; * This is used when initializing the contents of the&n; * area and marking the pages as reserved.&n; */
DECL|function|kvirt_to_pa
r_static
r_inline
r_int
r_int
id|kvirt_to_pa
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|__pa
c_func
(paren
id|kva
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
multiline_comment|/* Round it off to PAGE_SIZE */
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|mem
op_assign
id|vmalloc_32
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; * /proc interface&n; * Based on the CPiA driver version 0.7.4 -claudio&n; **********************************************************************/
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
DECL|variable|ov511_proc_entry
r_static
r_struct
id|proc_dir_entry
op_star
id|ov511_proc_entry
op_assign
l_int|NULL
suffix:semicolon
r_extern
r_struct
id|proc_dir_entry
op_star
id|video_proc_entry
suffix:semicolon
DECL|macro|YES_NO
mdefine_line|#define YES_NO(x) ((x) ? &quot;yes&quot; : &quot;no&quot;)
DECL|function|ov511_read_proc
r_static
r_int
id|ov511_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|out
op_assign
id|page
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|len
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
id|data
suffix:semicolon
multiline_comment|/* IMPORTANT: This output MUST be kept under PAGE_SIZE&n;&t; *            or we need to get more sophisticated. */
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;driver_version  : %s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;custom_id       : %d&bslash;n&quot;
comma
id|ov511-&gt;customid
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;model           : %s&bslash;n&quot;
comma
id|ov511-&gt;desc
ques
c_cond
id|clist
(braket
id|ov511-&gt;desc
)braket
dot
id|description
suffix:colon
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;streaming       : %s&bslash;n&quot;
comma
id|YES_NO
(paren
id|ov511-&gt;streaming
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;grabbing        : %s&bslash;n&quot;
comma
id|YES_NO
(paren
id|ov511-&gt;grabbing
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;compress        : %s&bslash;n&quot;
comma
id|YES_NO
(paren
id|ov511-&gt;compress
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;subcapture      : %s&bslash;n&quot;
comma
id|YES_NO
(paren
id|ov511-&gt;sub_flag
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;sub_size        : %d %d %d %d&bslash;n&quot;
comma
id|ov511-&gt;subx
comma
id|ov511-&gt;suby
comma
id|ov511-&gt;subw
comma
id|ov511-&gt;subh
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;data_format     : %s&bslash;n&quot;
comma
id|force_rgb
ques
c_cond
l_string|&quot;RGB&quot;
suffix:colon
l_string|&quot;BGR&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;brightness      : %d&bslash;n&quot;
comma
id|ov511-&gt;brightness
op_rshift
l_int|8
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;colour          : %d&bslash;n&quot;
comma
id|ov511-&gt;colour
op_rshift
l_int|8
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;contrast        : %d&bslash;n&quot;
comma
id|ov511-&gt;contrast
op_rshift
l_int|8
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;num_frames      : %d&bslash;n&quot;
comma
id|OV511_NUMFRAMES
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;frame           : %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;  depth         : %d&bslash;n&quot;
comma
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|depth
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;  size          : %d %d&bslash;n&quot;
comma
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|width
comma
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|height
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;  format        : &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|plist
(braket
id|j
)braket
dot
id|num
op_ge
l_int|0
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|plist
(braket
id|j
)braket
dot
id|num
op_eq
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|format
)paren
(brace
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|plist
(braket
id|j
)braket
dot
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|plist
(braket
id|j
)braket
dot
id|num
OL
l_int|0
)paren
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;unknown&bslash;n&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;  segsize       : %d&bslash;n&quot;
comma
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|segsize
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;  data_buffer   : 0x%p&bslash;n&quot;
comma
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
)brace
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;snap_enabled    : %s&bslash;n&quot;
comma
id|YES_NO
(paren
id|ov511-&gt;snap_enabled
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;bridge          : %s&bslash;n&quot;
comma
id|ov511-&gt;bridge
op_eq
id|BRG_OV511
ques
c_cond
l_string|&quot;OV511&quot;
suffix:colon
id|ov511-&gt;bridge
op_eq
id|BRG_OV511PLUS
ques
c_cond
l_string|&quot;OV511+&quot;
suffix:colon
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;sensor          : %s&bslash;n&quot;
comma
id|ov511-&gt;sensor
op_eq
id|SEN_OV6620
ques
c_cond
l_string|&quot;OV6620&quot;
suffix:colon
id|ov511-&gt;sensor
op_eq
id|SEN_OV7610
ques
c_cond
l_string|&quot;OV7610&quot;
suffix:colon
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620
ques
c_cond
l_string|&quot;OV7620&quot;
suffix:colon
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620AE
ques
c_cond
l_string|&quot;OV7620AE&quot;
suffix:colon
l_string|&quot;unknown&quot;
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;packet_size     : %d&bslash;n&quot;
comma
id|ov511-&gt;packet_size
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
(paren
id|out
comma
l_string|&quot;framebuffer     : 0x%p&bslash;n&quot;
comma
id|ov511-&gt;fbuf
)paren
suffix:semicolon
id|len
op_assign
id|out
op_minus
id|page
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|len
op_assign
id|count
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|ov511_write_proc
r_static
r_int
id|ov511_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|create_proc_ov511_cam
r_static
r_void
id|create_proc_ov511_cam
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_char
id|name
(braket
l_int|7
)braket
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|ent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511_proc_entry
op_logical_or
op_logical_neg
id|ov511
)paren
r_return
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;video%d&quot;
comma
id|ov511-&gt;vdev.minor
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;creating /proc/video/ov511/%s&quot;
comma
id|name
)paren
suffix:semicolon
id|ent
op_assign
id|create_proc_entry
c_func
(paren
id|name
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|ov511_proc_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ent
)paren
r_return
suffix:semicolon
id|ent-&gt;data
op_assign
id|ov511
suffix:semicolon
id|ent-&gt;read_proc
op_assign
id|ov511_read_proc
suffix:semicolon
id|ent-&gt;write_proc
op_assign
id|ov511_write_proc
suffix:semicolon
id|ov511-&gt;proc_entry
op_assign
id|ent
suffix:semicolon
)brace
DECL|function|destroy_proc_ov511_cam
r_static
r_void
id|destroy_proc_ov511_cam
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_char
id|name
(braket
l_int|7
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511
op_logical_or
op_logical_neg
id|ov511-&gt;proc_entry
)paren
r_return
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;video%d&quot;
comma
id|ov511-&gt;vdev.minor
)paren
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;destroying %s&quot;
comma
id|name
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|name
comma
id|ov511_proc_entry
)paren
suffix:semicolon
id|ov511-&gt;proc_entry
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|proc_ov511_create
r_static
r_void
id|proc_ov511_create
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* No current standard here. Alan prefers /proc/video/ as it keeps&n;&t; * /proc &quot;less cluttered than /proc/randomcardifoundintheshed/&quot;&n;&t; * -claudio&n;&t; */
r_if
c_cond
(paren
id|video_proc_entry
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Unable to initialise /proc/video/ov511&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ov511_proc_entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ov511&quot;
comma
id|S_IFDIR
comma
id|video_proc_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_proc_entry
)paren
id|ov511_proc_entry-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
r_else
id|err
c_func
(paren
l_string|&quot;Unable to initialise /proc/ov511&quot;
)paren
suffix:semicolon
)brace
DECL|function|proc_ov511_destroy
r_static
r_void
id|proc_ov511_destroy
c_func
(paren
r_void
)paren
(brace
id|PDEBUG
(paren
l_int|3
comma
l_string|&quot;removing /proc/video/ov511&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_proc_entry
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;ov511&quot;
comma
id|video_proc_entry
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS &amp;&amp; CONFIG_VIDEO_PROC_FS */
multiline_comment|/**********************************************************************&n; *&n; * Camera interface&n; *&n; **********************************************************************/
DECL|function|ov511_reg_write
r_static
r_int
id|ov511_reg_write
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|2
multiline_comment|/* REG_IO */
comma
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
(paren
id|__u16
)paren
id|reg
comma
op_amp
id|value
comma
l_int|1
comma
id|HZ
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;reg write: 0x%02X:0x%02X, 0x%x&quot;
comma
id|reg
comma
id|value
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;reg write: error %d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* returns: negative is error, pos or zero is data */
DECL|function|ov511_reg_read
r_static
r_int
id|ov511_reg_read
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
r_char
id|buffer
(braket
l_int|1
)braket
suffix:semicolon
id|rc
op_assign
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|2
multiline_comment|/* REG_IO */
comma
id|USB_DIR_IN
op_or
id|USB_TYPE_CLASS
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
(paren
id|__u16
)paren
id|reg
comma
id|buffer
comma
l_int|1
comma
id|HZ
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;reg read: 0x%02X:0x%02X&quot;
comma
id|reg
comma
id|buffer
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;reg read: error %d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
r_return
id|buffer
(braket
l_int|0
)braket
suffix:semicolon
)brace
)brace
DECL|function|ov511_i2c_write
r_static
r_int
id|ov511_i2c_write
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
id|rc
comma
id|retries
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;i2c write: 0x%02X:0x%02X&quot;
comma
id|reg
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* Three byte write cycle */
r_for
c_loop
(paren
id|retries
op_assign
id|OV511_I2C_RETRIES
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Select camera register */
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SUB_ADDRESS_3_BYTE
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* Write &quot;value&quot; to I2C data port of OV511 */
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_DATA_PORT
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* Initiate 3-byte write cycle */
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_do
id|rc
op_assign
id|ov511_reg_read
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rc
OG
l_int|0
op_logical_and
(paren
(paren
id|rc
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Retry until idle */
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|2
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Ack? */
r_break
suffix:semicolon
macro_line|#if 0
multiline_comment|/* I2C abort */
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x10
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_decrement
id|retries
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;i2c write retries exhausted&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|err
c_func
(paren
l_string|&quot;i2c write: error %d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* returns: negative is error, pos or zero is data */
DECL|function|ov511_i2c_read
r_static
r_int
id|ov511_i2c_read
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reg
)paren
(brace
r_int
id|rc
comma
id|value
comma
id|retries
suffix:semicolon
multiline_comment|/* Two byte write cycle */
r_for
c_loop
(paren
id|retries
op_assign
id|OV511_I2C_RETRIES
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Select camera register */
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SUB_ADDRESS_2_BYTE
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* Initiate 2-byte write cycle */
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x03
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_do
id|rc
op_assign
id|ov511_reg_read
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rc
OG
l_int|0
op_logical_and
(paren
(paren
id|rc
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Retry until idle */
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|2
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Ack? */
r_break
suffix:semicolon
multiline_comment|/* I2C abort */
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|retries
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;i2c write retries exhausted&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
multiline_comment|/* Two byte read cycle */
r_for
c_loop
(paren
id|retries
op_assign
id|OV511_I2C_RETRIES
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Initiate 2-byte read cycle */
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x05
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_do
id|rc
op_assign
id|ov511_reg_read
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rc
OG
l_int|0
op_logical_and
(paren
(paren
id|rc
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Retry until idle */
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|2
)paren
op_eq
l_int|0
)paren
multiline_comment|/* Ack? */
r_break
suffix:semicolon
multiline_comment|/* I2C abort */
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|retries
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;i2c read retries exhausted&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
id|value
op_assign
id|ov511_reg_read
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_DATA_PORT
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;i2c read: 0x%02X:0x%02X&quot;
comma
id|reg
comma
id|value
)paren
suffix:semicolon
multiline_comment|/* This is needed to make ov511_i2c_write() work */
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_CONTROL
comma
l_int|0x05
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_return
id|value
suffix:semicolon
id|error
suffix:colon
id|err
c_func
(paren
l_string|&quot;i2c read: error %d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ov511_write_regvals
r_static
r_int
id|ov511_write_regvals
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_struct
id|ov511_regvals
op_star
id|pRegvals
)paren
(brace
r_int
id|rc
suffix:semicolon
r_while
c_loop
(paren
id|pRegvals-&gt;bus
op_ne
id|OV511_DONE_BUS
)paren
(brace
r_if
c_cond
(paren
id|pRegvals-&gt;bus
op_eq
id|OV511_REG_BUS
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|pRegvals-&gt;reg
comma
id|pRegvals-&gt;val
)paren
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pRegvals-&gt;bus
op_eq
id|OV511_I2C_BUS
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ov511_i2c_write
c_func
(paren
id|dev
comma
id|pRegvals-&gt;reg
comma
id|pRegvals-&gt;val
)paren
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Bad regval array&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|pRegvals
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|err
c_func
(paren
l_string|&quot;write regvals: error %d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#ifdef OV511_DEBUG 
DECL|function|ov511_dump_i2c_range
r_static
r_void
id|ov511_dump_i2c_range
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|reg1
comma
r_int
id|regn
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|reg1
suffix:semicolon
id|i
op_le
id|regn
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rc
op_assign
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;OV7610[0x%X] = 0x%X&quot;
comma
id|i
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
DECL|function|ov511_dump_i2c_regs
r_static
r_void
id|ov511_dump_i2c_regs
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;I2C REGS&quot;
)paren
suffix:semicolon
id|ov511_dump_i2c_range
c_func
(paren
id|dev
comma
l_int|0x00
comma
l_int|0x7C
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|ov511_dump_reg_range
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|reg1
comma
r_int
id|regn
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|reg1
suffix:semicolon
id|i
op_le
id|regn
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rc
op_assign
id|ov511_reg_read
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;OV511[0x%X] = 0x%X&quot;
comma
id|i
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
id|ov511_dump_regs
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;CAMERA INTERFACE REGS&quot;
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x10
comma
l_int|0x1f
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;DRAM INTERFACE REGS&quot;
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x20
comma
l_int|0x23
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;ISO FIFO REGS&quot;
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x30
comma
l_int|0x31
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;PIO REGS&quot;
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x38
comma
l_int|0x39
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x3e
comma
l_int|0x3e
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;I2C REGS&quot;
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x40
comma
l_int|0x49
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;SYSTEM CONTROL REGS&quot;
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x50
comma
l_int|0x55
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x5e
comma
l_int|0x5f
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;OmniCE REGS&quot;
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x70
comma
l_int|0x79
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0x80
comma
l_int|0x9f
)paren
suffix:semicolon
id|ov511_dump_reg_range
c_func
(paren
id|dev
comma
l_int|0xa0
comma
l_int|0xbf
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
DECL|function|ov511_reset
r_static
r_int
id|ov511_reset
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|reset_type
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Reset: type=0x%X&quot;
comma
id|reset_type
)paren
suffix:semicolon
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_SYSTEM_RESET
comma
id|reset_type
)paren
suffix:semicolon
id|rc
op_assign
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_SYSTEM_RESET
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;reset: command failed&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Temporarily stops OV511 from functioning. Must do this before changing&n; * registers while the camera is streaming */
DECL|function|ov511_stop
r_static
r_inline
r_int
id|ov511_stop
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;stopping&quot;
)paren
suffix:semicolon
r_return
(paren
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_SYSTEM_RESET
comma
l_int|0x3d
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Restarts OV511 after ov511_stop() is called */
DECL|function|ov511_restart
r_static
r_inline
r_int
id|ov511_restart
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;restarting&quot;
)paren
suffix:semicolon
r_return
(paren
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_SYSTEM_RESET
comma
l_int|0x00
)paren
)paren
suffix:semicolon
)brace
DECL|function|ov511_set_packet_size
r_static
r_int
id|ov511_set_packet_size
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
r_int
id|size
)paren
(brace
r_int
id|alt
comma
id|mult
suffix:semicolon
r_if
c_cond
(paren
id|ov511_stop
c_func
(paren
id|ov511-&gt;dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|mult
op_assign
id|size
op_rshift
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;bridge
op_eq
id|BRG_OV511
)paren
(brace
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|257
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_257
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|513
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_513
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|769
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_769
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|993
)paren
id|alt
op_assign
id|OV511_ALT_SIZE_993
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Set packet size: invalid size (%d)&quot;
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ov511-&gt;bridge
op_eq
id|BRG_OV511PLUS
)paren
(brace
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|33
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_33
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|129
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_129
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|257
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_257
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|385
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_385
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|513
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_513
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|769
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_769
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
op_eq
l_int|961
)paren
id|alt
op_assign
id|OV511PLUS_ALT_SIZE_961
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Set packet size: invalid size (%d)&quot;
comma
id|size
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Set packet size: Invalid bridge type&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;set packet size: %d, mult=%d, alt=%d&quot;
comma
id|size
comma
id|mult
comma
id|alt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_reg_write
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_REG_FIFO_PACKET_SIZE
comma
id|mult
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|ov511-&gt;dev
comma
id|ov511-&gt;iface
comma
id|alt
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Set packet size: set interface error&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
singleline_comment|// FIXME - Should we only reset the FIFO?
r_if
c_cond
(paren
id|ov511_reset
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_RESET_NOREGS
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ov511-&gt;packet_size
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|ov511_restart
c_func
(paren
id|ov511-&gt;dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|ov7610_set_picture
id|ov7610_set_picture
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
r_struct
id|video_picture
op_star
id|p
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ov511_set_picture&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_stop
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|ov511-&gt;contrast
op_assign
id|p-&gt;contrast
suffix:semicolon
id|ov511-&gt;brightness
op_assign
id|p-&gt;brightness
suffix:semicolon
id|ov511-&gt;colour
op_assign
id|p-&gt;colour
suffix:semicolon
id|ov511-&gt;hue
op_assign
id|p-&gt;hue
suffix:semicolon
id|ov511-&gt;whiteness
op_assign
id|p-&gt;whiteness
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_COM_B
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#if 0
multiline_comment|/* disable auto adjust mode */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
id|OV7610_REG_COM_B
comma
id|ret
op_amp
l_int|0xfe
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ov511-&gt;sensor
op_eq
id|SEN_OV7610
op_logical_or
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620AE
op_logical_or
id|ov511-&gt;sensor
op_eq
id|SEN_OV6620
)paren
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
id|OV7610_REG_SAT
comma
id|p-&gt;colour
op_rshift
l_int|8
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;sensor
op_eq
id|SEN_OV7610
op_logical_or
id|ov511-&gt;sensor
op_eq
id|SEN_OV6620
)paren
(brace
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
id|OV7610_REG_CNT
comma
id|p-&gt;contrast
op_rshift
l_int|8
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
id|OV7610_REG_RED
comma
l_int|0xFF
op_minus
(paren
id|p-&gt;hue
op_rshift
l_int|8
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
id|OV7610_REG_BLUE
comma
id|p-&gt;hue
op_rshift
l_int|8
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
id|OV7610_REG_BRT
comma
id|p-&gt;brightness
op_rshift
l_int|8
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620
)paren
op_logical_or
(paren
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620AE
)paren
)paren
(brace
macro_line|#if 0
r_int
id|cur_sat
comma
id|new_sat
comma
id|tmp
suffix:semicolon
id|cur_sat
op_assign
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_BLUE
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|p-&gt;hue
op_rshift
l_int|8
)paren
op_minus
id|cur_sat
suffix:semicolon
id|new_sat
op_assign
(paren
id|tmp
OL
l_int|0
)paren
ques
c_cond
(paren
op_minus
id|tmp
)paren
op_or
l_int|0x80
suffix:colon
id|tmp
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;cur=%d target=%d diff=%d&quot;
comma
id|cur_sat
comma
id|p-&gt;hue
op_rshift
l_int|8
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
id|OV7610_REG_BLUE
comma
id|new_sat
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
singleline_comment|// DEBUG_CODE
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;hue=%d&quot;
comma
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_BLUE
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|ov511_restart
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|ov7610_get_picture
id|ov7610_get_picture
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
r_struct
id|video_picture
op_star
id|p
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ov511_get_picture&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_stop
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_SAT
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|p-&gt;colour
op_assign
id|ret
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_CNT
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|p-&gt;contrast
op_assign
id|ret
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_BRT
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|p-&gt;brightness
op_assign
id|ret
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* This may not be the best way to do it */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_BLUE
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|p-&gt;hue
op_assign
id|ret
op_lshift
l_int|8
suffix:semicolon
id|p-&gt;whiteness
op_assign
l_int|105
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* Can we get these from frame[0]? -claudio? */
id|p-&gt;depth
op_assign
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|depth
suffix:semicolon
id|p-&gt;palette
op_assign
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|format
suffix:semicolon
r_if
c_cond
(paren
id|ov511_restart
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Returns number of bits per pixel (regardless of where they are located; planar or&n; * not), or zero for unsupported format.&n; */
DECL|function|ov511_get_depth
r_static
r_int
id|ov511_get_depth
c_func
(paren
r_int
id|palette
)paren
(brace
r_switch
c_cond
(paren
id|palette
)paren
(brace
r_case
id|VIDEO_PALETTE_GREY
suffix:colon
r_return
l_int|8
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
r_return
l_int|16
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
r_return
l_int|24
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
r_return
l_int|16
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUYV
suffix:colon
r_return
l_int|16
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420
suffix:colon
r_return
l_int|24
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV422P
suffix:colon
r_return
l_int|24
suffix:semicolon
multiline_comment|/* Planar */
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Invalid format */
)brace
)brace
multiline_comment|/* LNCNT values fixed by Lawrence Glaister &lt;lg@jfm.bc.ca&gt; */
DECL|variable|mlist
r_static
r_struct
id|mode_list
id|mlist
(braket
)braket
op_assign
(brace
multiline_comment|/* W    H   C  PXCNT LNCNT PXDIV LNDIV M420  COMA  COML */
(brace
l_int|640
comma
l_int|480
comma
l_int|0
comma
l_int|0x4f
comma
l_int|0x3b
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x24
comma
l_int|0x9e
)brace
comma
(brace
l_int|640
comma
l_int|480
comma
l_int|1
comma
l_int|0x4f
comma
l_int|0x3b
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x24
comma
l_int|0x9e
)brace
comma
(brace
l_int|320
comma
l_int|240
comma
l_int|0
comma
l_int|0x27
comma
l_int|0x1d
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|320
comma
l_int|240
comma
l_int|1
comma
l_int|0x27
comma
l_int|0x1d
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|352
comma
l_int|288
comma
l_int|0
comma
l_int|0x2b
comma
l_int|0x25
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|352
comma
l_int|288
comma
l_int|1
comma
l_int|0x2b
comma
l_int|0x25
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|384
comma
l_int|288
comma
l_int|0
comma
l_int|0x2f
comma
l_int|0x25
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|384
comma
l_int|288
comma
l_int|1
comma
l_int|0x2f
comma
l_int|0x25
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|448
comma
l_int|336
comma
l_int|0
comma
l_int|0x37
comma
l_int|0x29
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|448
comma
l_int|336
comma
l_int|1
comma
l_int|0x37
comma
l_int|0x29
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|176
comma
l_int|144
comma
l_int|0
comma
l_int|0x15
comma
l_int|0x12
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|176
comma
l_int|144
comma
l_int|1
comma
l_int|0x15
comma
l_int|0x12
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|160
comma
l_int|120
comma
l_int|0
comma
l_int|0x13
comma
l_int|0x0e
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|160
comma
l_int|120
comma
l_int|1
comma
l_int|0x13
comma
l_int|0x0e
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x1e
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
r_static
r_int
DECL|function|ov511_mode_init_regs
id|ov511_mode_init_regs
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|mode
comma
r_int
id|sub_flag
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
r_int
id|hwsbase
comma
id|hwebase
comma
id|vwsbase
comma
id|vwebase
comma
id|hwsize
comma
id|vwsize
suffix:semicolon
r_int
id|hwscale
op_assign
l_int|0
comma
id|vwscale
op_assign
l_int|0
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;width:%d, height:%d, mode:%d, sub:%d&quot;
comma
id|width
comma
id|height
comma
id|mode
comma
id|sub_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_stop
c_func
(paren
id|ov511-&gt;dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Dumppix only works with RGB24 */
r_if
c_cond
(paren
id|dumppix
op_logical_and
(paren
id|mode
op_ne
id|VIDEO_PALETTE_RGB24
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;dumppix only supported with RGB 24&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mode
op_eq
id|VIDEO_PALETTE_GREY
)paren
(brace
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x16
comma
l_int|0x00
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;sensor
op_eq
id|SEN_OV7610
op_logical_or
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620AE
)paren
(brace
multiline_comment|/* these aren&squot;t valid on the OV6620/OV7620 */
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x0e
comma
l_int|0x44
)paren
suffix:semicolon
)brace
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x13
comma
id|autoadjust
ques
c_cond
l_int|0x21
suffix:colon
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/* For snapshot */
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x1e
comma
l_int|0x00
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x1f
comma
l_int|0x01
)paren
suffix:semicolon
)brace
r_else
(brace
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x16
comma
l_int|0x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;sensor
op_eq
id|SEN_OV7610
op_logical_or
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620AE
)paren
(brace
multiline_comment|/* not valid on the OV6620/OV7620 */
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x0e
comma
l_int|0x04
)paren
suffix:semicolon
)brace
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x13
comma
id|autoadjust
ques
c_cond
l_int|0x01
suffix:colon
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* For snapshot */
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x1e
comma
l_int|0x01
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x1f
comma
l_int|0x03
)paren
suffix:semicolon
)brace
multiline_comment|/* The different sensor ICs handle setting up of window differently */
r_switch
c_cond
(paren
id|ov511-&gt;sensor
)paren
(brace
r_case
id|SEN_OV7610
suffix:colon
r_case
id|SEN_OV7620AE
suffix:colon
id|hwsbase
op_assign
l_int|0x38
suffix:semicolon
id|hwebase
op_assign
l_int|0x3a
suffix:semicolon
id|vwsbase
op_assign
id|vwebase
op_assign
l_int|0x05
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV6620
suffix:colon
id|hwsbase
op_assign
l_int|0x38
suffix:semicolon
id|hwebase
op_assign
l_int|0x3a
suffix:semicolon
id|vwsbase
op_assign
l_int|0x05
suffix:semicolon
id|vwebase
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_OV7620
suffix:colon
id|hwsbase
op_assign
l_int|0x2c
suffix:semicolon
id|hwebase
op_assign
l_int|0x2d
suffix:semicolon
id|vwsbase
op_assign
id|vwebase
op_assign
l_int|0x05
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Invalid sensor&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Bit 5 of COM C register varies with sensor */
r_if
c_cond
(paren
id|ov511-&gt;sensor
op_eq
id|SEN_OV6620
)paren
(brace
r_if
c_cond
(paren
id|width
OG
l_int|176
op_logical_and
id|height
OG
l_int|144
)paren
(brace
multiline_comment|/* CIF */
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x14
comma
l_int|0x04
)paren
suffix:semicolon
id|hwscale
op_assign
l_int|1
suffix:semicolon
id|vwscale
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* The datasheet says 0; it&squot;s wrong */
id|hwsize
op_assign
l_int|352
suffix:semicolon
id|vwsize
op_assign
l_int|288
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* QCIF */
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x14
comma
l_int|0x24
)paren
suffix:semicolon
id|hwsize
op_assign
l_int|176
suffix:semicolon
id|vwsize
op_assign
l_int|144
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|width
OG
l_int|320
op_logical_and
id|height
OG
l_int|240
)paren
(brace
multiline_comment|/* VGA */
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x14
comma
l_int|0x04
)paren
suffix:semicolon
id|hwscale
op_assign
l_int|2
suffix:semicolon
id|vwscale
op_assign
l_int|1
suffix:semicolon
id|hwsize
op_assign
l_int|640
suffix:semicolon
id|vwsize
op_assign
l_int|480
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* QVGA */
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x14
comma
l_int|0x24
)paren
suffix:semicolon
id|hwscale
op_assign
l_int|1
suffix:semicolon
id|hwsize
op_assign
l_int|320
suffix:semicolon
id|vwsize
op_assign
l_int|240
suffix:semicolon
)brace
)brace
multiline_comment|/* FIXME! - This needs to be changed to support 160x120 and 6620!!! */
r_if
c_cond
(paren
id|sub_flag
)paren
(brace
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x17
comma
id|hwsbase
op_plus
(paren
id|ov511-&gt;subx
op_rshift
id|hwscale
)paren
)paren
suffix:semicolon
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x18
comma
id|hwebase
op_plus
(paren
(paren
id|ov511-&gt;subx
op_plus
id|ov511-&gt;subw
)paren
op_rshift
id|hwscale
)paren
)paren
suffix:semicolon
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x19
comma
id|vwsbase
op_plus
(paren
id|ov511-&gt;suby
op_rshift
id|vwscale
)paren
)paren
suffix:semicolon
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x1a
comma
id|vwebase
op_plus
(paren
(paren
id|ov511-&gt;suby
op_plus
id|ov511-&gt;subh
)paren
op_rshift
id|vwscale
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x17
comma
id|hwsbase
)paren
suffix:semicolon
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x18
comma
id|hwebase
op_plus
(paren
id|hwsize
op_rshift
id|hwscale
)paren
)paren
suffix:semicolon
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x19
comma
id|vwsbase
)paren
suffix:semicolon
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x1a
comma
id|vwebase
op_plus
(paren
id|vwsize
op_rshift
id|vwscale
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|mlist
(braket
id|i
)braket
dot
id|width
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|lncnt
comma
id|pxcnt
comma
id|clock
suffix:semicolon
r_if
c_cond
(paren
id|width
op_ne
id|mlist
(braket
id|i
)braket
dot
id|width
op_logical_or
id|height
op_ne
id|mlist
(braket
id|i
)braket
dot
id|height
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mlist
(braket
id|i
)braket
dot
id|color
op_logical_and
id|mode
op_ne
id|VIDEO_PALETTE_GREY
)paren
r_continue
suffix:semicolon
multiline_comment|/* Here I&squot;m assuming that snapshot size == image size.&n;&t;&t; * I hope that&squot;s always true. --claudio&n;&t;&t; */
id|pxcnt
op_assign
id|sub_flag
ques
c_cond
(paren
id|ov511-&gt;subw
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:colon
id|mlist
(braket
id|i
)braket
dot
id|pxcnt
suffix:semicolon
id|lncnt
op_assign
id|sub_flag
ques
c_cond
(paren
id|ov511-&gt;subh
op_rshift
l_int|3
)paren
op_minus
l_int|1
suffix:colon
id|mlist
(braket
id|i
)braket
dot
id|lncnt
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
id|pxcnt
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x13
comma
id|lncnt
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x14
comma
id|mlist
(braket
id|i
)braket
dot
id|pxdv
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x15
comma
id|mlist
(braket
id|i
)braket
dot
id|lndv
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x18
comma
id|mlist
(braket
id|i
)braket
dot
id|m420
)paren
suffix:semicolon
multiline_comment|/* Snapshot additions */
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x1a
comma
id|pxcnt
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x1b
comma
id|lncnt
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x1c
comma
id|mlist
(braket
id|i
)braket
dot
id|pxdv
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x1d
comma
id|mlist
(braket
id|i
)braket
dot
id|lndv
)paren
suffix:semicolon
multiline_comment|/* Calculate and set the clock divisor */
id|clock
op_assign
(paren
(paren
id|sub_flag
ques
c_cond
id|ov511-&gt;subw
op_star
id|ov511-&gt;subh
suffix:colon
id|width
op_star
id|height
)paren
op_star
(paren
id|mlist
(braket
id|i
)braket
dot
id|color
ques
c_cond
l_int|3
suffix:colon
l_int|2
)paren
op_div
l_int|2
)paren
op_div
l_int|66000
suffix:semicolon
macro_line|#if 0
id|clock
op_mul_assign
id|cams
suffix:semicolon
macro_line|#endif
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x11
comma
id|clock
)paren
suffix:semicolon
multiline_comment|/* We only have code to convert GBR -&gt; RGB24 */
r_if
c_cond
(paren
(paren
id|mode
op_eq
id|VIDEO_PALETTE_RGB24
)paren
op_logical_and
id|sensor_gbr
)paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
id|mlist
(braket
id|i
)braket
dot
id|common_A
op_or
(paren
id|testpat
ques
c_cond
l_int|0x0a
suffix:colon
l_int|0x08
)paren
)paren
suffix:semicolon
r_else
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
id|mlist
(braket
id|i
)braket
dot
id|common_A
op_or
(paren
id|testpat
ques
c_cond
l_int|0x02
suffix:colon
l_int|0x00
)paren
)paren
suffix:semicolon
multiline_comment|/* 7620/6620 don&squot;t have register 0x35, so play it safe */
r_if
c_cond
(paren
id|ov511-&gt;sensor
op_eq
id|SEN_OV7610
op_logical_or
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620AE
)paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x35
comma
id|mlist
(braket
id|i
)braket
dot
id|common_L
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|compress
)paren
(brace
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x78
comma
l_int|0x03
)paren
suffix:semicolon
singleline_comment|// Turn on Y compression
id|ov511_reg_write
c_func
(paren
id|dev
comma
l_int|0x79
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// Disable LUTs
)brace
r_if
c_cond
(paren
id|ov511_restart
c_func
(paren
id|ov511-&gt;dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|mlist
(braket
id|i
)braket
dot
id|width
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Unknown mode (%d, %d): %d&quot;
comma
id|width
comma
id|height
comma
id|mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#ifdef OV511_DEBUG
r_if
c_cond
(paren
id|debug
op_ge
l_int|5
)paren
id|ov511_dump_i2c_regs
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**********************************************************************&n; *&n; * Color correction functions&n; *&n; **********************************************************************/
multiline_comment|/*&n; * Turn a YUV4:2:0 block into an RGB block&n; *&n; * Video4Linux seems to use the blue, green, red channel&n; * order convention-- rgb[0] is blue, rgb[1] is green, rgb[2] is red.&n; *&n; * Color space conversion coefficients taken from the excellent&n; * http://www.inforamp.net/~poynton/ColorFAQ.html&n; * In his terminology, this is a CCIR 601.1 YCbCr -&gt; RGB.&n; * Y values are given for all 4 pixels, but the U (Pb)&n; * and V (Pr) are assumed constant over the 2x2 block.&n; *&n; * To avoid floating point arithmetic, the color conversion&n; * coefficients are scaled into 16.16 fixed-point integers.&n; * They were determined as follows:&n; *&n; *&t;double brightness = 1.0;  (0-&gt;black; 1-&gt;full scale) &n; *&t;double saturation = 1.0;  (0-&gt;greyscale; 1-&gt;full color)&n; *&t;double fixScale = brightness * 256 * 256;&n; *&t;int rvScale = (int)(1.402 * saturation * fixScale);&n; *&t;int guScale = (int)(-0.344136 * saturation * fixScale);&n; *&t;int gvScale = (int)(-0.714136 * saturation * fixScale);&n; *&t;int buScale = (int)(1.772 * saturation * fixScale);&n; *&t;int yScale = (int)(fixScale);&t;&n; */
multiline_comment|/* LIMIT: convert a 16.16 fixed-point value to a byte, with clipping. */
DECL|macro|LIMIT
mdefine_line|#define LIMIT(x) ((x)&gt;0xffffff?0xff: ((x)&lt;=0xffff?0:((x)&gt;&gt;16)))
r_static
r_inline
r_void
DECL|function|ov511_move_420_block
id|ov511_move_420_block
c_func
(paren
r_int
id|yTL
comma
r_int
id|yTR
comma
r_int
id|yBL
comma
r_int
id|yBR
comma
r_int
id|u
comma
r_int
id|v
comma
r_int
id|rowPixels
comma
r_int
r_char
op_star
id|rgb
comma
r_int
id|bits
)paren
(brace
r_const
r_int
id|rvScale
op_assign
l_int|91881
suffix:semicolon
r_const
r_int
id|guScale
op_assign
op_minus
l_int|22553
suffix:semicolon
r_const
r_int
id|gvScale
op_assign
op_minus
l_int|46801
suffix:semicolon
r_const
r_int
id|buScale
op_assign
l_int|116129
suffix:semicolon
r_const
r_int
id|yScale
op_assign
l_int|65536
suffix:semicolon
r_int
id|r
comma
id|g
comma
id|b
suffix:semicolon
id|g
op_assign
id|guScale
op_star
id|u
op_plus
id|gvScale
op_star
id|v
suffix:semicolon
r_if
c_cond
(paren
id|force_rgb
)paren
(brace
id|r
op_assign
id|buScale
op_star
id|u
suffix:semicolon
id|b
op_assign
id|rvScale
op_star
id|v
suffix:semicolon
)brace
r_else
(brace
id|r
op_assign
id|rvScale
op_star
id|v
suffix:semicolon
id|b
op_assign
id|buScale
op_star
id|u
suffix:semicolon
)brace
id|yTL
op_mul_assign
id|yScale
suffix:semicolon
id|yTR
op_mul_assign
id|yScale
suffix:semicolon
id|yBL
op_mul_assign
id|yScale
suffix:semicolon
id|yBR
op_mul_assign
id|yScale
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_eq
l_int|24
)paren
(brace
multiline_comment|/* Write out top two pixels */
id|rgb
(braket
l_int|0
)braket
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|yTL
)paren
suffix:semicolon
id|rgb
(braket
l_int|1
)braket
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTL
)paren
suffix:semicolon
id|rgb
(braket
l_int|2
)braket
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|yTL
)paren
suffix:semicolon
id|rgb
(braket
l_int|3
)braket
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|yTR
)paren
suffix:semicolon
id|rgb
(braket
l_int|4
)braket
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTR
)paren
suffix:semicolon
id|rgb
(braket
l_int|5
)braket
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|yTR
)paren
suffix:semicolon
multiline_comment|/* Skip down to next line to write out bottom two pixels */
id|rgb
op_add_assign
l_int|3
op_star
id|rowPixels
suffix:semicolon
id|rgb
(braket
l_int|0
)braket
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|yBL
)paren
suffix:semicolon
id|rgb
(braket
l_int|1
)braket
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBL
)paren
suffix:semicolon
id|rgb
(braket
l_int|2
)braket
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|yBL
)paren
suffix:semicolon
id|rgb
(braket
l_int|3
)braket
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|yBR
)paren
suffix:semicolon
id|rgb
(braket
l_int|4
)braket
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBR
)paren
suffix:semicolon
id|rgb
(braket
l_int|5
)braket
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|yBR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|bits
op_eq
l_int|16
)paren
(brace
multiline_comment|/* Write out top two pixels */
id|rgb
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|yTL
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x1F
)paren
op_or
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTL
)paren
op_lshift
l_int|3
)paren
op_amp
l_int|0xE0
)paren
suffix:semicolon
id|rgb
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTL
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|yTL
)paren
op_amp
l_int|0xF8
)paren
suffix:semicolon
id|rgb
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|yTR
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x1F
)paren
op_or
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTR
)paren
op_lshift
l_int|3
)paren
op_amp
l_int|0xE0
)paren
suffix:semicolon
id|rgb
(braket
l_int|3
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yTR
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|yTR
)paren
op_amp
l_int|0xF8
)paren
suffix:semicolon
multiline_comment|/* Skip down to next line to write out bottom two pixels */
id|rgb
op_add_assign
l_int|2
op_star
id|rowPixels
suffix:semicolon
id|rgb
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|yBL
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x1F
)paren
op_or
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBL
)paren
op_lshift
l_int|3
)paren
op_amp
l_int|0xE0
)paren
suffix:semicolon
id|rgb
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBL
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|yBL
)paren
op_amp
l_int|0xF8
)paren
suffix:semicolon
id|rgb
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|b
op_plus
id|yBR
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|0x1F
)paren
op_or
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBR
)paren
op_lshift
l_int|3
)paren
op_amp
l_int|0xE0
)paren
suffix:semicolon
id|rgb
(braket
l_int|3
)braket
op_assign
(paren
(paren
id|LIMIT
c_func
(paren
id|g
op_plus
id|yBR
)paren
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
op_or
(paren
id|LIMIT
c_func
(paren
id|r
op_plus
id|yBR
)paren
op_amp
l_int|0xF8
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * For a 640x480 YUV4:2:0 images, data shows up in 1200 384 byte segments.&n; * The first 64 bytes of each segment are U, the next 64 are V.  The U and&n; * V are arranged as follows:&n; *&n; *      0  1 ...  7&n; *      8  9 ... 15&n; *           ...   &n; *     56 57 ... 63&n; *&n; * U and V are shipped at half resolution (1 U,V sample -&gt; one 2x2 block).&n; *&n; * The next 256 bytes are full resolution Y data and represent 4 squares&n; * of 8x8 pixels as follows:&n; *&n; *      0  1 ...  7    64  65 ...  71   ...  192 193 ... 199&n; *      8  9 ... 15    72  73 ...  79        200 201 ... 207&n; *           ...              ...                    ...&n; *     56 57 ... 63   120 121 ... 127   ...  248 249 ... 255&n; *&n; * Note that the U and V data in one segment represents a 16 x 16 pixel&n; * area, but the Y data represents a 32 x 8 pixel area.&n; *&n; * If dumppix module param is set, _parse_data just dumps the incoming segments,&n; * verbatim, in order, into the frame. When used with vidcat -f ppm -s 640x480&n; * this puts the data on the standard output and can be analyzed with the&n; * parseppm.c utility I wrote.  That&squot;s a much faster way for figuring out how&n; * this data is scrambled.&n; */
DECL|macro|HDIV
mdefine_line|#define HDIV 8
DECL|macro|WDIV
mdefine_line|#define WDIV (256/HDIV)
r_static
r_void
DECL|function|ov511_parse_gbr422_to_rgb24
id|ov511_parse_gbr422_to_rgb24
c_func
(paren
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
comma
r_int
id|iOutY
comma
r_int
id|iOutUV
comma
r_int
id|iHalf
comma
r_int
id|iWidth
)paren
(brace
r_int
id|k
comma
id|l
comma
id|m
suffix:semicolon
r_int
r_char
op_star
id|pIn
suffix:semicolon
r_int
r_char
op_star
id|pOut
comma
op_star
id|pOut1
suffix:semicolon
id|pIn
op_assign
id|pIn0
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutUV
op_plus
(paren
id|force_rgb
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
op_star
id|pOut1
op_assign
op_star
(paren
id|pOut1
op_plus
l_int|3
)paren
op_assign
op_star
(paren
id|pOut1
op_plus
id|iWidth
op_star
l_int|3
)paren
op_assign
op_star
(paren
id|pOut1
op_plus
id|iWidth
op_star
l_int|3
op_plus
l_int|3
)paren
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut1
op_add_assign
l_int|6
suffix:semicolon
)brace
id|pOut
op_add_assign
id|iWidth
op_star
l_int|3
op_star
l_int|2
suffix:semicolon
)brace
id|pIn
op_assign
id|pIn0
op_plus
l_int|64
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutUV
op_plus
(paren
id|force_rgb
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
op_star
id|pOut1
op_assign
op_star
(paren
id|pOut1
op_plus
l_int|3
)paren
op_assign
op_star
(paren
id|pOut1
op_plus
id|iWidth
op_star
l_int|3
)paren
op_assign
op_star
(paren
id|pOut1
op_plus
id|iWidth
op_star
l_int|3
op_plus
l_int|3
)paren
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut1
op_add_assign
l_int|6
suffix:semicolon
)brace
id|pOut
op_add_assign
id|iWidth
op_star
l_int|3
op_star
l_int|2
suffix:semicolon
)brace
id|pIn
op_assign
id|pIn0
op_plus
l_int|128
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutY
op_plus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|4
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|8
suffix:semicolon
id|m
op_increment
)paren
(brace
op_star
id|pOut1
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut1
op_add_assign
l_int|3
suffix:semicolon
)brace
id|pOut1
op_add_assign
(paren
id|iWidth
op_minus
l_int|8
)paren
op_star
l_int|3
suffix:semicolon
)brace
id|pOut
op_add_assign
l_int|8
op_star
l_int|3
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ov511_parse_yuv420_to_rgb
id|ov511_parse_yuv420_to_rgb
c_func
(paren
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
comma
r_int
id|iOutY
comma
r_int
id|iOutUV
comma
r_int
id|iHalf
comma
r_int
id|iWidth
comma
r_int
id|bits
)paren
(brace
r_int
id|k
comma
id|l
comma
id|m
suffix:semicolon
r_int
id|bytes
op_assign
id|bits
op_rshift
l_int|3
suffix:semicolon
r_int
r_char
op_star
id|pIn
suffix:semicolon
r_int
r_char
op_star
id|pOut
comma
op_star
id|pOut1
suffix:semicolon
multiline_comment|/* Just copy the Y&squot;s if in the first stripe */
r_if
c_cond
(paren
op_logical_neg
id|iHalf
)paren
(brace
id|pIn
op_assign
id|pIn0
op_plus
l_int|128
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutY
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|4
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|8
suffix:semicolon
id|m
op_increment
)paren
(brace
op_star
id|pOut1
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut1
op_add_assign
id|bytes
suffix:semicolon
)brace
id|pOut1
op_add_assign
(paren
id|iWidth
op_minus
l_int|8
)paren
op_star
id|bytes
suffix:semicolon
)brace
id|pOut
op_add_assign
l_int|8
op_star
id|bytes
suffix:semicolon
)brace
)brace
multiline_comment|/* Use the first half of VUs to calculate value */
id|pIn
op_assign
id|pIn0
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutUV
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|4
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|8
suffix:semicolon
id|m
op_increment
)paren
(brace
r_int
id|y00
op_assign
op_star
(paren
id|pOut
)paren
suffix:semicolon
r_int
id|y01
op_assign
op_star
(paren
id|pOut
op_plus
id|bytes
)paren
suffix:semicolon
r_int
id|y10
op_assign
op_star
(paren
id|pOut
op_plus
id|iWidth
op_star
id|bytes
)paren
suffix:semicolon
r_int
id|y11
op_assign
op_star
(paren
id|pOut
op_plus
id|iWidth
op_star
id|bytes
op_plus
id|bytes
)paren
suffix:semicolon
r_int
id|v
op_assign
op_star
(paren
id|pIn
op_plus
l_int|64
)paren
op_minus
l_int|128
suffix:semicolon
r_int
id|u
op_assign
op_star
id|pIn
op_increment
op_minus
l_int|128
suffix:semicolon
id|ov511_move_420_block
c_func
(paren
id|y00
comma
id|y01
comma
id|y10
comma
id|y11
comma
id|u
comma
id|v
comma
id|iWidth
comma
id|pOut
comma
id|bits
)paren
suffix:semicolon
id|pOut
op_add_assign
l_int|2
op_star
id|bytes
suffix:semicolon
)brace
id|pOut
op_add_assign
(paren
id|iWidth
op_star
l_int|2
op_minus
l_int|16
)paren
op_star
id|bytes
suffix:semicolon
)brace
multiline_comment|/* Just copy the other UV rows */
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|4
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|8
suffix:semicolon
id|m
op_increment
)paren
(brace
op_star
id|pOut
op_increment
op_assign
op_star
(paren
id|pIn
op_plus
l_int|64
)paren
suffix:semicolon
op_star
id|pOut
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut
op_add_assign
l_int|2
op_star
id|bytes
op_minus
l_int|1
suffix:semicolon
)brace
id|pOut
op_add_assign
(paren
id|iWidth
op_star
l_int|2
op_minus
l_int|16
)paren
op_star
id|bytes
suffix:semicolon
)brace
multiline_comment|/* Calculate values if it&squot;s the second half */
r_if
c_cond
(paren
id|iHalf
)paren
(brace
id|pIn
op_assign
id|pIn0
op_plus
l_int|128
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutY
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|4
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|4
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|4
suffix:semicolon
id|m
op_increment
)paren
(brace
r_int
id|y10
op_assign
op_star
(paren
id|pIn
op_plus
l_int|8
)paren
suffix:semicolon
r_int
id|y00
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
r_int
id|y11
op_assign
op_star
(paren
id|pIn
op_plus
l_int|8
)paren
suffix:semicolon
r_int
id|y01
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
r_int
id|v
op_assign
op_star
id|pOut1
op_minus
l_int|128
suffix:semicolon
r_int
id|u
op_assign
op_star
(paren
id|pOut1
op_plus
l_int|1
)paren
op_minus
l_int|128
suffix:semicolon
id|ov511_move_420_block
c_func
(paren
id|y00
comma
id|y01
comma
id|y10
comma
id|y11
comma
id|u
comma
id|v
comma
id|iWidth
comma
id|pOut1
comma
id|bits
)paren
suffix:semicolon
id|pOut1
op_add_assign
l_int|2
op_star
id|bytes
suffix:semicolon
)brace
id|pOut1
op_add_assign
(paren
id|iWidth
op_star
l_int|2
op_minus
l_int|8
)paren
op_star
id|bytes
suffix:semicolon
id|pIn
op_add_assign
l_int|8
suffix:semicolon
)brace
id|pOut
op_add_assign
l_int|8
op_star
id|bytes
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|ov511_dumppix
id|ov511_dumppix
c_func
(paren
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
comma
r_int
id|iOutY
comma
r_int
id|iOutUV
comma
r_int
id|iHalf
comma
r_int
id|iWidth
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
r_int
r_char
op_star
id|pIn
comma
op_star
id|pOut
comma
op_star
id|pOut1
suffix:semicolon
r_switch
c_cond
(paren
id|dumppix
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* Just dump YUV data straight out for debug */
id|pOut0
op_add_assign
id|iOutY
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HDIV
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|WDIV
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
id|pOut0
op_increment
op_assign
op_star
id|pIn0
op_increment
suffix:semicolon
op_star
id|pOut0
op_increment
op_assign
op_star
id|pIn0
op_increment
suffix:semicolon
op_star
id|pOut0
op_increment
op_assign
op_star
id|pIn0
op_increment
suffix:semicolon
)brace
id|pOut0
op_add_assign
(paren
id|iWidth
op_minus
id|WDIV
)paren
op_star
l_int|3
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* This converts the Y data to &quot;black-and-white&quot; RGB data */
multiline_comment|/* Useful for experimenting with compression */
id|pIn
op_assign
id|pIn0
op_plus
l_int|128
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutY
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
op_star
id|pOut1
op_increment
op_assign
op_star
id|pIn
suffix:semicolon
op_star
id|pOut1
op_increment
op_assign
op_star
id|pIn
suffix:semicolon
op_star
id|pOut1
op_increment
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
)brace
id|pOut1
op_add_assign
(paren
id|iWidth
op_minus
l_int|8
)paren
op_star
l_int|3
suffix:semicolon
)brace
id|pOut
op_add_assign
l_int|8
op_star
l_int|3
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* This will dump only the Y channel data stream as-is */
id|pIn
op_assign
id|pIn0
op_plus
l_int|128
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|output_offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|pOut
op_increment
op_assign
op_star
id|pIn
suffix:semicolon
op_star
id|pOut
op_increment
op_assign
op_star
id|pIn
suffix:semicolon
op_star
id|pOut
op_increment
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|output_offset
op_add_assign
l_int|3
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* End switch (dumppix) */
)brace
multiline_comment|/* This converts YUV420 segments to YUYV */
r_static
r_void
DECL|function|ov511_parse_data_yuv422
id|ov511_parse_data_yuv422
c_func
(paren
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
comma
r_int
id|iOutY
comma
r_int
id|iOutUV
comma
r_int
id|iWidth
)paren
(brace
r_int
id|k
comma
id|l
comma
id|m
suffix:semicolon
r_int
r_char
op_star
id|pIn
comma
op_star
id|pOut
comma
op_star
id|pOut1
suffix:semicolon
id|pIn
op_assign
id|pIn0
op_plus
l_int|128
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutY
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|4
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|8
suffix:semicolon
id|m
op_increment
)paren
(brace
op_star
id|pOut1
op_assign
(paren
op_star
id|pIn
op_increment
)paren
suffix:semicolon
id|pOut1
op_add_assign
l_int|2
suffix:semicolon
)brace
id|pOut1
op_add_assign
(paren
id|iWidth
op_minus
l_int|8
)paren
op_star
l_int|2
suffix:semicolon
)brace
id|pOut
op_add_assign
l_int|8
op_star
l_int|2
suffix:semicolon
)brace
id|pIn
op_assign
id|pIn0
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutUV
op_plus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|8
suffix:semicolon
id|m
op_increment
)paren
(brace
r_int
id|v
op_assign
op_star
(paren
id|pIn
op_plus
l_int|64
)paren
suffix:semicolon
r_int
id|u
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
op_star
id|pOut
op_assign
id|u
suffix:semicolon
op_star
(paren
id|pOut
op_plus
l_int|2
)paren
op_assign
id|v
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|iWidth
)paren
op_assign
id|u
suffix:semicolon
op_star
(paren
id|pOut
op_plus
id|iWidth
op_plus
l_int|2
)paren
op_assign
id|v
suffix:semicolon
id|pOut
op_add_assign
l_int|4
suffix:semicolon
)brace
id|pOut
op_add_assign
(paren
id|iWidth
op_star
l_int|4
op_minus
l_int|32
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ov511_parse_data_yuv420
id|ov511_parse_data_yuv420
c_func
(paren
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
comma
r_int
id|iOutY
comma
r_int
id|iOutUV
comma
r_int
id|iWidth
comma
r_int
id|iHeight
)paren
(brace
r_int
id|k
comma
id|l
comma
id|m
suffix:semicolon
r_int
r_char
op_star
id|pIn
suffix:semicolon
r_int
r_char
op_star
id|pOut
comma
op_star
id|pOut1
suffix:semicolon
r_int
id|a
op_assign
id|iWidth
op_star
id|iHeight
suffix:semicolon
r_int
id|w
op_assign
id|iWidth
op_div
l_int|2
suffix:semicolon
id|pIn
op_assign
id|pIn0
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutUV
op_plus
id|a
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
op_star
id|pOut1
op_increment
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut
op_add_assign
id|w
suffix:semicolon
)brace
id|pIn
op_assign
id|pIn0
op_plus
l_int|64
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutUV
op_plus
id|a
op_plus
id|a
op_div
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
op_star
id|pOut1
op_increment
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut
op_add_assign
id|w
suffix:semicolon
)brace
id|pIn
op_assign
id|pIn0
op_plus
l_int|128
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutY
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|4
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|8
suffix:semicolon
id|m
op_increment
)paren
op_star
id|pOut1
op_increment
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut1
op_add_assign
id|iWidth
op_minus
l_int|8
suffix:semicolon
)brace
id|pOut
op_add_assign
l_int|8
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ov511_parse_data_yuv422p
id|ov511_parse_data_yuv422p
c_func
(paren
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
comma
r_int
id|iOutY
comma
r_int
id|iOutUV
comma
r_int
id|iWidth
comma
r_int
id|iHeight
)paren
(brace
r_int
id|k
comma
id|l
comma
id|m
suffix:semicolon
r_int
r_char
op_star
id|pIn
suffix:semicolon
r_int
r_char
op_star
id|pOut
comma
op_star
id|pOut1
suffix:semicolon
r_int
id|a
op_assign
id|iWidth
op_star
id|iHeight
suffix:semicolon
r_int
id|w
op_assign
id|iWidth
op_div
l_int|2
suffix:semicolon
id|pIn
op_assign
id|pIn0
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutUV
op_plus
id|a
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
op_star
id|pOut1
op_assign
op_star
(paren
id|pOut1
op_plus
id|w
)paren
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut1
op_increment
suffix:semicolon
)brace
id|pOut
op_add_assign
id|iWidth
suffix:semicolon
)brace
id|pIn
op_assign
id|pIn0
op_plus
l_int|64
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutUV
op_plus
id|a
op_plus
id|a
op_div
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|8
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
op_star
id|pOut1
op_assign
op_star
(paren
id|pOut1
op_plus
id|w
)paren
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut1
op_increment
suffix:semicolon
)brace
id|pOut
op_add_assign
id|iWidth
suffix:semicolon
)brace
id|pIn
op_assign
id|pIn0
op_plus
l_int|128
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutY
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|4
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|8
suffix:semicolon
id|m
op_increment
)paren
op_star
id|pOut1
op_increment
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
id|pOut1
op_add_assign
id|iWidth
op_minus
l_int|8
suffix:semicolon
)brace
id|pOut
op_add_assign
l_int|8
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * For 640x480 RAW BW images, data shows up in 1200 256 byte segments.&n; * The segments represent 4 squares of 8x8 pixels as follows:&n; *&n; *      0  1 ...  7    64  65 ...  71   ...  192 193 ... 199&n; *      8  9 ... 15    72  73 ...  79        200 201 ... 207&n; *           ...              ...                    ...&n; *     56 57 ... 63   120 121 ... 127        248 249 ... 255&n; *&n; */
r_static
r_void
DECL|function|ov511_parse_data_grey
id|ov511_parse_data_grey
c_func
(paren
r_int
r_char
op_star
id|pIn0
comma
r_int
r_char
op_star
id|pOut0
comma
r_int
id|iOutY
comma
r_int
id|iWidth
)paren
(brace
r_int
id|k
comma
id|l
comma
id|m
suffix:semicolon
r_int
r_char
op_star
id|pIn
suffix:semicolon
r_int
r_char
op_star
id|pOut
comma
op_star
id|pOut1
suffix:semicolon
id|pIn
op_assign
id|pIn0
suffix:semicolon
id|pOut
op_assign
id|pOut0
op_plus
id|iOutY
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|4
suffix:semicolon
id|k
op_increment
)paren
(brace
id|pOut1
op_assign
id|pOut
suffix:semicolon
r_for
c_loop
(paren
id|l
op_assign
l_int|0
suffix:semicolon
id|l
OL
l_int|8
suffix:semicolon
id|l
op_increment
)paren
(brace
r_for
c_loop
(paren
id|m
op_assign
l_int|0
suffix:semicolon
id|m
OL
l_int|8
suffix:semicolon
id|m
op_increment
)paren
(brace
op_star
id|pOut1
op_increment
op_assign
op_star
id|pIn
op_increment
suffix:semicolon
)brace
id|pOut1
op_add_assign
id|iWidth
op_minus
l_int|8
suffix:semicolon
)brace
id|pOut
op_add_assign
l_int|8
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * fixFrameRGBoffset--&n; * My camera seems to return the red channel about 1 pixel&n; * low, and the blue channel about 1 pixel high. After YUV-&gt;RGB&n; * conversion, we can correct this easily. OSL 2/24/2000.&n; */
DECL|function|fixFrameRGBoffset
r_static
r_void
id|fixFrameRGBoffset
c_func
(paren
r_struct
id|ov511_frame
op_star
id|frame
)paren
(brace
r_int
id|x
comma
id|y
suffix:semicolon
r_int
id|rowBytes
op_assign
id|frame-&gt;width
op_star
l_int|3
comma
id|w
op_assign
id|frame-&gt;width
suffix:semicolon
r_int
r_char
op_star
id|rgb
op_assign
id|frame-&gt;data
suffix:semicolon
r_const
r_int
id|shift
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Distance to shift pixels by, vertically */
multiline_comment|/* Don&squot;t bother with little images */
r_if
c_cond
(paren
id|frame-&gt;width
OL
l_int|400
)paren
r_return
suffix:semicolon
multiline_comment|/* Shift red channel up */
r_for
c_loop
(paren
id|y
op_assign
id|shift
suffix:semicolon
id|y
OL
id|frame-&gt;height
suffix:semicolon
id|y
op_increment
)paren
(brace
r_int
id|lp
op_assign
(paren
id|y
op_minus
id|shift
)paren
op_star
id|rowBytes
suffix:semicolon
multiline_comment|/* Previous line offset */
r_int
id|lc
op_assign
id|y
op_star
id|rowBytes
suffix:semicolon
multiline_comment|/* Current line offset */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|w
suffix:semicolon
id|x
op_increment
)paren
id|rgb
(braket
id|lp
op_plus
id|x
op_star
l_int|3
op_plus
l_int|2
)braket
op_assign
id|rgb
(braket
id|lc
op_plus
id|x
op_star
l_int|3
op_plus
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Shift red up */
)brace
multiline_comment|/* Shift blue channel down */
r_for
c_loop
(paren
id|y
op_assign
id|frame-&gt;height
op_minus
id|shift
op_minus
l_int|1
suffix:semicolon
id|y
op_ge
l_int|0
suffix:semicolon
id|y
op_decrement
)paren
(brace
r_int
id|ln
op_assign
(paren
id|y
op_plus
id|shift
)paren
op_star
id|rowBytes
suffix:semicolon
multiline_comment|/* Next line offset */
r_int
id|lc
op_assign
id|y
op_star
id|rowBytes
suffix:semicolon
multiline_comment|/* Current line offset */
r_for
c_loop
(paren
id|x
op_assign
l_int|0
suffix:semicolon
id|x
OL
id|w
suffix:semicolon
id|x
op_increment
)paren
id|rgb
(braket
id|ln
op_plus
id|x
op_star
l_int|3
op_plus
l_int|0
)braket
op_assign
id|rgb
(braket
id|lc
op_plus
id|x
op_star
l_int|3
op_plus
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Shift blue down */
)brace
)brace
multiline_comment|/**********************************************************************&n; *&n; * OV511 data transfer, IRQ handler&n; *&n; **********************************************************************/
DECL|function|ov511_move_data
r_static
r_int
id|ov511_move_data
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
id|urb_t
op_star
id|urb
)paren
(brace
r_int
r_char
op_star
id|cdata
suffix:semicolon
r_int
id|i
comma
id|totlen
op_assign
l_int|0
suffix:semicolon
r_int
id|aPackNum
(braket
l_int|10
)braket
suffix:semicolon
r_struct
id|ov511_frame
op_star
id|frame
suffix:semicolon
r_int
r_char
op_star
id|pData
suffix:semicolon
r_int
id|iPix
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;Moving %d packets&quot;
comma
id|urb-&gt;number_of_packets
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|n
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
suffix:semicolon
r_int
id|st
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0
suffix:semicolon
id|cdata
op_assign
id|urb-&gt;transfer_buffer
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
id|aPackNum
(braket
id|i
)braket
op_assign
id|n
ques
c_cond
id|cdata
(braket
id|ov511-&gt;packet_size
op_minus
l_int|1
)braket
suffix:colon
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
op_logical_or
id|ov511-&gt;curframe
op_eq
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
id|PDEBUG
c_func
(paren
l_int|2
comma
l_string|&quot;data error: [%d] len=%d, status=%d&quot;
comma
id|i
comma
id|n
comma
id|st
)paren
suffix:semicolon
id|frame
op_assign
op_amp
id|ov511-&gt;frame
(braket
id|ov511-&gt;curframe
)braket
suffix:semicolon
multiline_comment|/* SOF/EOF packets have 1st to 8th bytes zeroed and the 9th&n;&t;&t; * byte non-zero. The EOF packet has image width/height in the&n;&t;&t; * 10th and 11th packets. The 9th bit is given as follows:&n;&t;&t; *&n;&t;&t; * bit 7: EOF&n;&t;&t; *     6: compression enabled&n;&t;&t; *     5: 422/420/400 modes&n;&t;&t; *     4: 422/420/400 modes&n;&t;&t; *     3: 1&n;&t;&t; *     2: snapshot bottom on&n;&t;&t; *     1: snapshot frame&n;&t;&t; *     0: even/odd field&n;&t;&t; */
multiline_comment|/* Check for SOF/EOF packet */
r_if
c_cond
(paren
(paren
id|cdata
(braket
l_int|0
)braket
op_or
id|cdata
(braket
l_int|1
)braket
op_or
id|cdata
(braket
l_int|2
)braket
op_or
id|cdata
(braket
l_int|3
)braket
op_or
id|cdata
(braket
l_int|4
)braket
op_or
id|cdata
(braket
l_int|5
)braket
op_or
id|cdata
(braket
l_int|6
)braket
op_or
id|cdata
(braket
l_int|7
)braket
)paren
op_logical_or
(paren
op_complement
id|cdata
(braket
l_int|8
)braket
op_amp
l_int|0x08
)paren
)paren
r_goto
id|check_middle
suffix:semicolon
multiline_comment|/* Frame end */
r_if
c_cond
(paren
id|cdata
(braket
l_int|8
)braket
op_amp
l_int|0x80
)paren
(brace
r_struct
id|timeval
op_star
id|ts
suffix:semicolon
id|ts
op_assign
(paren
r_struct
id|timeval
op_star
)paren
(paren
id|frame-&gt;data
op_plus
id|MAX_FRAME_SIZE
)paren
suffix:semicolon
id|do_gettimeofday
(paren
id|ts
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame end, curframe = %d, packnum=%d, hw=%d, vw=%d&quot;
comma
id|ov511-&gt;curframe
comma
(paren
r_int
)paren
(paren
id|cdata
(braket
id|ov511-&gt;packet_size
op_minus
l_int|1
)braket
)paren
comma
(paren
r_int
)paren
(paren
id|cdata
(braket
l_int|9
)braket
)paren
comma
(paren
r_int
)paren
(paren
id|cdata
(braket
l_int|10
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;scanstate
op_eq
id|STATE_LINES
)paren
(brace
r_int
id|iFrameNext
suffix:semicolon
r_if
c_cond
(paren
id|fix_rgb_offset
)paren
id|fixFrameRGBoffset
c_func
(paren
id|frame
)paren
suffix:semicolon
id|frame-&gt;grabstate
op_assign
id|FRAME_DONE
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
)paren
(brace
id|frame-&gt;grabstate
op_assign
id|FRAME_DONE
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
suffix:semicolon
)brace
multiline_comment|/* If next frame is ready or grabbing,&n;                                 * point to it */
id|iFrameNext
op_assign
(paren
id|ov511-&gt;curframe
op_plus
l_int|1
)paren
op_mod
id|OV511_NUMFRAMES
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
id|iFrameNext
)braket
dot
id|grabstate
op_eq
id|FRAME_READY
op_logical_or
id|ov511-&gt;frame
(braket
id|iFrameNext
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
(brace
id|ov511-&gt;curframe
op_assign
id|iFrameNext
suffix:semicolon
id|ov511-&gt;frame
(braket
id|iFrameNext
)braket
dot
id|scanstate
op_assign
id|STATE_SCANNING
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_DONE
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame done! congratulations&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame not ready? state = %d&quot;
comma
id|ov511-&gt;frame
(braket
id|iFrameNext
)braket
dot
id|grabstate
)paren
suffix:semicolon
)brace
id|ov511-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Image corruption caused by misplaced frame-&gt;segment = 0&n;&t;&t;&t; * fixed by carlosf@conectiva.com.br&n;&t;&t;&t; */
)brace
r_else
(brace
multiline_comment|/* Frame start */
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Frame start, framenum = %d&quot;
comma
id|ov511-&gt;curframe
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Make sure no previous data carries over; necessary&n;&t;&t;&t; * for compression experimentation */
id|memset
c_func
(paren
id|frame-&gt;data
comma
l_int|0
comma
id|MAX_DATA_SIZE
)paren
suffix:semicolon
macro_line|#endif
id|output_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check to see if it&squot;s a snapshot frame */
multiline_comment|/* FIXME?? Should the snapshot reset go here? Performance? */
r_if
c_cond
(paren
id|cdata
(braket
l_int|8
)braket
op_amp
l_int|0x02
)paren
(brace
id|frame-&gt;snapshot
op_assign
l_int|1
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;snapshot detected&quot;
)paren
suffix:semicolon
)brace
id|frame-&gt;scanstate
op_assign
id|STATE_LINES
suffix:semicolon
id|frame-&gt;segment
op_assign
l_int|0
suffix:semicolon
)brace
id|check_middle
suffix:colon
multiline_comment|/* Are we in a frame? */
r_if
c_cond
(paren
id|frame-&gt;scanstate
op_ne
id|STATE_LINES
)paren
r_continue
suffix:semicolon
multiline_comment|/* Deal with leftover from last segment, if any */
r_if
c_cond
(paren
id|frame-&gt;segment
)paren
(brace
id|pData
op_assign
id|ov511-&gt;scratch
suffix:semicolon
id|iPix
op_assign
op_minus
id|ov511-&gt;scratchlen
suffix:semicolon
id|memmove
c_func
(paren
id|pData
op_plus
id|ov511-&gt;scratchlen
comma
id|cdata
comma
id|iPix
op_plus
id|frame-&gt;segsize
)paren
suffix:semicolon
)brace
r_else
(brace
id|pData
op_assign
op_amp
id|cdata
(braket
id|iPix
op_assign
l_int|9
)braket
suffix:semicolon
)brace
multiline_comment|/* Parse the segments */
r_while
c_loop
(paren
id|iPix
op_le
(paren
id|ov511-&gt;packet_size
op_minus
l_int|1
)paren
op_minus
id|frame-&gt;segsize
op_logical_and
id|frame-&gt;segment
OL
id|frame-&gt;width
op_star
id|frame-&gt;height
op_div
l_int|256
)paren
(brace
r_int
id|iSegY
comma
id|iSegUV
suffix:semicolon
r_int
id|iY
comma
id|jY
comma
id|iUV
comma
id|jUV
suffix:semicolon
r_int
id|iOutY
comma
id|iOutYP
comma
id|iOutUV
comma
id|iOutUVP
suffix:semicolon
r_int
r_char
op_star
id|pOut
suffix:semicolon
id|iSegY
op_assign
id|iSegUV
op_assign
id|frame-&gt;segment
suffix:semicolon
id|pOut
op_assign
id|frame-&gt;data
suffix:semicolon
id|frame-&gt;segment
op_increment
suffix:semicolon
id|iPix
op_add_assign
id|frame-&gt;segsize
suffix:semicolon
multiline_comment|/* Handle subwindow */
r_if
c_cond
(paren
id|frame-&gt;sub_flag
)paren
(brace
r_int
id|iSeg1
suffix:semicolon
id|iSeg1
op_assign
id|iSegY
op_div
(paren
id|ov511-&gt;subw
op_div
l_int|32
)paren
suffix:semicolon
id|iSeg1
op_mul_assign
id|frame-&gt;width
op_div
l_int|32
suffix:semicolon
id|iSegY
op_assign
id|iSeg1
op_plus
(paren
id|iSegY
op_mod
(paren
id|ov511-&gt;subw
op_div
l_int|32
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iSegY
op_ge
id|frame-&gt;width
op_star
id|ov511-&gt;subh
op_div
l_int|256
)paren
r_break
suffix:semicolon
id|iSeg1
op_assign
id|iSegUV
op_div
(paren
id|ov511-&gt;subw
op_div
l_int|16
)paren
suffix:semicolon
id|iSeg1
op_mul_assign
id|frame-&gt;width
op_div
l_int|16
suffix:semicolon
id|iSegUV
op_assign
id|iSeg1
op_plus
(paren
id|iSegUV
op_mod
(paren
id|ov511-&gt;subw
op_div
l_int|16
)paren
)paren
suffix:semicolon
id|pOut
op_add_assign
(paren
id|ov511-&gt;subx
op_plus
id|ov511-&gt;suby
op_star
id|frame-&gt;width
)paren
op_star
(paren
id|frame-&gt;depth
op_rshift
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t;&t; * i counts segment lines&n;&t;&t;&t; * j counts segment columns&n;&t;&t;&t; * iOut is the offset (in bytes) of the upper left corner&n;&t;&t;&t; */
id|iY
op_assign
id|iSegY
op_div
(paren
id|frame-&gt;width
op_div
id|WDIV
)paren
suffix:semicolon
id|jY
op_assign
id|iSegY
op_minus
id|iY
op_star
(paren
id|frame-&gt;width
op_div
id|WDIV
)paren
suffix:semicolon
id|iOutYP
op_assign
id|iY
op_star
id|HDIV
op_star
id|frame-&gt;width
op_plus
id|jY
op_star
id|WDIV
suffix:semicolon
id|iOutY
op_assign
id|iOutYP
op_star
(paren
id|frame-&gt;depth
op_rshift
l_int|3
)paren
suffix:semicolon
id|iUV
op_assign
id|iSegUV
op_div
(paren
id|frame-&gt;width
op_div
id|WDIV
op_star
l_int|2
)paren
suffix:semicolon
id|jUV
op_assign
id|iSegUV
op_minus
id|iUV
op_star
(paren
id|frame-&gt;width
op_div
id|WDIV
op_star
l_int|2
)paren
suffix:semicolon
id|iOutUVP
op_assign
id|iUV
op_star
id|HDIV
op_star
l_int|2
op_star
id|frame-&gt;width
op_plus
id|jUV
op_star
id|WDIV
op_div
l_int|2
suffix:semicolon
id|iOutUV
op_assign
id|iOutUVP
op_star
(paren
id|frame-&gt;depth
op_rshift
l_int|3
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|frame-&gt;format
)paren
(brace
r_case
id|VIDEO_PALETTE_GREY
suffix:colon
id|ov511_parse_data_grey
(paren
id|pData
comma
id|pOut
comma
id|iOutY
comma
id|frame-&gt;width
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
r_if
c_cond
(paren
id|dumppix
)paren
id|ov511_dumppix
c_func
(paren
id|pData
comma
id|pOut
comma
id|iOutY
comma
id|iOutUV
comma
id|iY
op_amp
l_int|1
comma
id|frame-&gt;width
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sensor_gbr
)paren
id|ov511_parse_gbr422_to_rgb24
c_func
(paren
id|pData
comma
id|pOut
comma
id|iOutY
comma
id|iOutUV
comma
id|iY
op_amp
l_int|1
comma
id|frame-&gt;width
)paren
suffix:semicolon
r_else
id|ov511_parse_yuv420_to_rgb
c_func
(paren
id|pData
comma
id|pOut
comma
id|iOutY
comma
id|iOutUV
comma
id|iY
op_amp
l_int|1
comma
id|frame-&gt;width
comma
l_int|24
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
id|ov511_parse_yuv420_to_rgb
c_func
(paren
id|pData
comma
id|pOut
comma
id|iOutY
comma
id|iOutUV
comma
id|iY
op_amp
l_int|1
comma
id|frame-&gt;width
comma
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
r_case
id|VIDEO_PALETTE_YUYV
suffix:colon
id|ov511_parse_data_yuv422
c_func
(paren
id|pData
comma
id|pOut
comma
id|iOutY
comma
id|iOutUV
comma
id|frame-&gt;width
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV420
suffix:colon
id|ov511_parse_data_yuv420
(paren
id|pData
comma
id|pOut
comma
id|iOutYP
comma
id|iUV
op_star
id|HDIV
op_star
id|frame-&gt;width
op_div
l_int|2
op_plus
id|jUV
op_star
id|WDIV
op_div
l_int|4
comma
id|frame-&gt;width
comma
id|frame-&gt;height
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_YUV422P
suffix:colon
id|ov511_parse_data_yuv422p
(paren
id|pData
comma
id|pOut
comma
id|iOutYP
comma
id|iOutUVP
op_div
l_int|2
comma
id|frame-&gt;width
comma
id|frame-&gt;height
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Unsupported format: %d&quot;
comma
id|frame-&gt;format
)paren
suffix:semicolon
)brace
id|pData
op_assign
op_amp
id|cdata
(braket
id|iPix
)braket
suffix:semicolon
)brace
multiline_comment|/* Save extra data for next time */
r_if
c_cond
(paren
id|frame-&gt;segment
OL
id|frame-&gt;width
op_star
id|frame-&gt;height
op_div
l_int|256
)paren
(brace
id|ov511-&gt;scratchlen
op_assign
(paren
id|ov511-&gt;packet_size
op_minus
l_int|1
)paren
op_minus
id|iPix
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;scratchlen
OL
id|frame-&gt;segsize
)paren
id|memmove
c_func
(paren
id|ov511-&gt;scratch
comma
id|pData
comma
id|ov511-&gt;scratchlen
)paren
suffix:semicolon
r_else
id|ov511-&gt;scratchlen
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|PDEBUG
c_func
(paren
l_int|5
comma
l_string|&quot;pn: %d %d %d %d %d %d %d %d %d %d&quot;
comma
id|aPackNum
(braket
l_int|0
)braket
comma
id|aPackNum
(braket
l_int|1
)braket
comma
id|aPackNum
(braket
l_int|2
)braket
comma
id|aPackNum
(braket
l_int|3
)braket
comma
id|aPackNum
(braket
l_int|4
)braket
comma
id|aPackNum
(braket
l_int|5
)braket
comma
id|aPackNum
(braket
l_int|6
)braket
comma
id|aPackNum
(braket
l_int|7
)braket
comma
id|aPackNum
(braket
l_int|8
)braket
comma
id|aPackNum
(braket
l_int|9
)braket
)paren
suffix:semicolon
r_return
id|totlen
suffix:semicolon
)brace
DECL|function|ov511_isoc_irq
r_static
r_void
id|ov511_isoc_irq
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|len
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov511
suffix:semicolon
r_struct
id|ov511_sbuf
op_star
id|sbuf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;context
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;no context&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;dev
op_logical_or
op_logical_neg
id|ov511-&gt;user
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;no device, or not open&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;streaming
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;hmmm... not streaming, but got interrupt&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sbuf
op_assign
op_amp
id|ov511-&gt;sbuf
(braket
id|ov511-&gt;cursbuf
)braket
suffix:semicolon
multiline_comment|/* Copy the data received into our scratch buffer */
r_if
c_cond
(paren
id|ov511-&gt;curframe
op_ge
l_int|0
)paren
(brace
id|len
op_assign
id|ov511_move_data
c_func
(paren
id|ov511
comma
id|urb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|ov511-&gt;wq
)paren
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|ov511-&gt;wq
)paren
suffix:semicolon
)brace
multiline_comment|/* Move to the next sbuf */
id|ov511-&gt;cursbuf
op_assign
(paren
id|ov511-&gt;cursbuf
op_plus
l_int|1
)paren
op_mod
id|OV511_NUMSBUF
suffix:semicolon
id|urb-&gt;dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ov511_init_isoc
r_static
r_int
id|ov511_init_isoc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
id|urb_t
op_star
id|urb
suffix:semicolon
r_int
id|fx
comma
id|err
comma
id|n
comma
id|size
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;*** Initializing capture ***&quot;
)paren
suffix:semicolon
id|ov511-&gt;compress
op_assign
l_int|0
suffix:semicolon
id|ov511-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
id|ov511-&gt;cursbuf
op_assign
l_int|0
suffix:semicolon
id|ov511-&gt;scratchlen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;bridge
op_eq
id|BRG_OV511
)paren
r_if
c_cond
(paren
id|cams
op_eq
l_int|1
)paren
id|size
op_assign
l_int|993
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|2
)paren
id|size
op_assign
l_int|513
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|3
op_logical_or
id|cams
op_eq
l_int|4
)paren
id|size
op_assign
l_int|257
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;&bslash;&quot;cams&bslash;&quot; parameter too high!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ov511-&gt;bridge
op_eq
id|BRG_OV511PLUS
)paren
r_if
c_cond
(paren
id|cams
op_eq
l_int|1
)paren
id|size
op_assign
l_int|961
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|2
)paren
id|size
op_assign
l_int|513
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_eq
l_int|3
op_logical_or
id|cams
op_eq
l_int|4
)paren
id|size
op_assign
l_int|257
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_ge
l_int|5
op_logical_and
id|cams
op_le
l_int|8
)paren
id|size
op_assign
l_int|129
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cams
op_ge
l_int|9
op_logical_and
id|cams
op_le
l_int|31
)paren
id|size
op_assign
l_int|33
suffix:semicolon
r_else
(brace
id|err
c_func
(paren
l_string|&quot;&bslash;&quot;cams&bslash;&quot; parameter too high!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;invalid bridge type&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ov511_set_packet_size
c_func
(paren
id|ov511
comma
id|size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMSBUF
suffix:semicolon
id|n
op_increment
)paren
(brace
id|urb
op_assign
id|usb_alloc_urb
c_func
(paren
id|FRAMES_PER_DESC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|err
c_func
(paren
l_string|&quot;init isoc: usb_alloc_urb ret. NULL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
op_assign
id|urb
suffix:semicolon
id|urb-&gt;dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
id|urb-&gt;context
op_assign
id|ov511
suffix:semicolon
id|urb-&gt;pipe
op_assign
id|usb_rcvisocpipe
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_ENDPOINT_ADDRESS
)paren
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
id|USB_ISO_ASAP
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|data
suffix:semicolon
id|urb-&gt;complete
op_assign
id|ov511_isoc_irq
suffix:semicolon
id|urb-&gt;number_of_packets
op_assign
id|FRAMES_PER_DESC
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_assign
id|ov511-&gt;packet_size
op_star
id|FRAMES_PER_DESC
suffix:semicolon
r_for
c_loop
(paren
id|fx
op_assign
l_int|0
suffix:semicolon
id|fx
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|fx
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|fx
)braket
dot
id|offset
op_assign
id|ov511-&gt;packet_size
op_star
id|fx
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|fx
)braket
dot
id|length
op_assign
id|ov511-&gt;packet_size
suffix:semicolon
)brace
)brace
id|ov511-&gt;sbuf
(braket
id|OV511_NUMSBUF
op_minus
l_int|1
)braket
dot
id|urb-&gt;next
op_assign
id|ov511-&gt;sbuf
(braket
l_int|0
)braket
dot
id|urb
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMSBUF
op_minus
l_int|1
suffix:semicolon
id|n
op_increment
)paren
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb-&gt;next
op_assign
id|ov511-&gt;sbuf
(braket
id|n
op_plus
l_int|1
)braket
dot
id|urb
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMSBUF
suffix:semicolon
id|n
op_increment
)paren
(brace
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb-&gt;dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|err
c_func
(paren
l_string|&quot;init isoc: usb_submit_urb(%d) ret %d&quot;
comma
id|n
comma
id|err
)paren
suffix:semicolon
)brace
id|ov511-&gt;streaming
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ov511_stop_isoc
r_static
r_void
id|ov511_stop_isoc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;streaming
op_logical_or
op_logical_neg
id|ov511-&gt;dev
)paren
r_return
suffix:semicolon
id|PDEBUG
(paren
l_int|3
comma
l_string|&quot;*** Stopping capture ***&quot;
)paren
suffix:semicolon
id|ov511_set_packet_size
c_func
(paren
id|ov511
comma
l_int|0
)paren
suffix:semicolon
id|ov511-&gt;streaming
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unschedule all of the iso td&squot;s */
r_for
c_loop
(paren
id|n
op_assign
id|OV511_NUMSBUF
op_minus
l_int|1
suffix:semicolon
id|n
op_ge
l_int|0
suffix:semicolon
id|n
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
(brace
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
suffix:semicolon
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
DECL|function|ov511_new_frame
r_static
r_int
id|ov511_new_frame
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
r_int
id|framenum
)paren
(brace
r_struct
id|ov511_frame
op_star
id|frame
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ov511-&gt;curframe = %d, framenum = %d&quot;
comma
id|ov511-&gt;curframe
comma
id|framenum
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;dev
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* If we&squot;re not grabbing a frame right now and the other frame is */
multiline_comment|/* ready to be grabbed into, then use it instead */
r_if
c_cond
(paren
id|ov511-&gt;curframe
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
(paren
id|framenum
op_minus
l_int|1
op_plus
id|OV511_NUMFRAMES
)paren
op_mod
id|OV511_NUMFRAMES
)braket
dot
id|grabstate
op_eq
id|FRAME_READY
)paren
id|framenum
op_assign
(paren
id|framenum
op_minus
l_int|1
op_plus
id|OV511_NUMFRAMES
)paren
op_mod
id|OV511_NUMFRAMES
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
id|frame
op_assign
op_amp
id|ov511-&gt;frame
(braket
id|framenum
)braket
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;framenum = %d, width = %d, height = %d&quot;
comma
id|framenum
comma
id|frame-&gt;width
comma
id|frame-&gt;height
)paren
suffix:semicolon
id|frame-&gt;grabstate
op_assign
id|FRAME_GRABBING
suffix:semicolon
id|frame-&gt;scanstate
op_assign
id|STATE_SCANNING
suffix:semicolon
id|frame-&gt;scanlength
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* accumulated in ov511_parse_data() */
id|frame-&gt;snapshot
op_assign
l_int|0
suffix:semicolon
id|ov511-&gt;curframe
op_assign
id|framenum
suffix:semicolon
multiline_comment|/* Make sure it&squot;s not too big */
r_if
c_cond
(paren
id|frame-&gt;width
OG
id|ov511-&gt;maxwidth
)paren
id|frame-&gt;width
op_assign
id|ov511-&gt;maxwidth
suffix:semicolon
id|frame-&gt;width
op_and_assign
op_complement
l_int|7L
suffix:semicolon
multiline_comment|/* Multiple of 8 */
r_if
c_cond
(paren
id|frame-&gt;height
OG
id|ov511-&gt;maxheight
)paren
id|frame-&gt;height
op_assign
id|ov511-&gt;maxheight
suffix:semicolon
id|frame-&gt;height
op_and_assign
op_complement
l_int|3L
suffix:semicolon
multiline_comment|/* Multiple of 4 */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Buffer management&n; *&n; ***************************************************************************/
DECL|function|ov511_alloc
r_static
r_int
id|ov511_alloc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_int
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;entered&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov511-&gt;buf_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;buf_state
op_eq
id|BUF_PEND_DEALLOC
)paren
(brace
id|ov511-&gt;buf_state
op_assign
id|BUF_ALLOCATED
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|ov511-&gt;buf_timer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov511-&gt;buf_state
op_eq
id|BUF_ALLOCATED
)paren
r_goto
id|out
suffix:semicolon
id|ov511-&gt;fbuf
op_assign
id|rvmalloc
c_func
(paren
id|OV511_NUMFRAMES
op_star
id|MAX_DATA_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;fbuf
)paren
r_goto
id|error
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|data
op_assign
id|ov511-&gt;fbuf
op_plus
id|i
op_star
id|MAX_DATA_SIZE
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;frame[%d] @ %p&quot;
comma
id|i
comma
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
id|ov511-&gt;sbuf
(braket
id|i
)braket
dot
id|data
op_assign
id|kmalloc
c_func
(paren
id|FRAMES_PER_DESC
op_star
id|MAX_FRAME_SIZE_PER_DESC
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
(brace
r_while
c_loop
(paren
op_decrement
id|i
)paren
(brace
id|kfree
c_func
(paren
id|ov511-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
id|ov511-&gt;sbuf
(braket
id|i
)braket
dot
id|data
op_assign
l_int|NULL
suffix:semicolon
)brace
id|rvfree
c_func
(paren
id|ov511-&gt;fbuf
comma
id|OV511_NUMFRAMES
op_star
id|MAX_DATA_SIZE
)paren
suffix:semicolon
id|ov511-&gt;fbuf
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;sbuf[%d] @ %p&quot;
comma
id|i
comma
id|ov511-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
)brace
id|ov511-&gt;buf_state
op_assign
id|BUF_ALLOCATED
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|ov511-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;leaving&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|ov511-&gt;buf_state
op_assign
id|BUF_NOT_ALLOCATED
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov511-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;errored&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* &n; * - You must acquire buf_lock before entering this function.&n; * - Because this code will free any non-null pointer, you must be sure to null&n; *   them if you explicitly free them somewhere else!&n; */
DECL|function|ov511_do_dealloc
r_static
r_void
id|ov511_do_dealloc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_int
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;entered&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;fbuf
)paren
(brace
id|rvfree
c_func
(paren
id|ov511-&gt;fbuf
comma
id|OV511_NUMFRAMES
op_star
id|MAX_DATA_SIZE
)paren
suffix:semicolon
id|ov511-&gt;fbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ov511-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
(brace
id|kfree
c_func
(paren
id|ov511-&gt;sbuf
(braket
id|i
)braket
dot
id|data
)paren
suffix:semicolon
id|ov511-&gt;sbuf
(braket
id|i
)braket
dot
id|data
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;buffer memory deallocated&quot;
)paren
suffix:semicolon
id|ov511-&gt;buf_state
op_assign
id|BUF_NOT_ALLOCATED
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;leaving&quot;
)paren
suffix:semicolon
)brace
DECL|function|ov511_buf_callback
r_static
r_void
id|ov511_buf_callback
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|data
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;entered&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov511-&gt;buf_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;buf_state
op_eq
id|BUF_PEND_DEALLOC
)paren
id|ov511_do_dealloc
c_func
(paren
id|ov511
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov511-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;leaving&quot;
)paren
suffix:semicolon
)brace
DECL|function|ov511_dealloc
r_static
r_void
id|ov511_dealloc
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
comma
r_int
id|now
)paren
(brace
r_struct
id|timer_list
op_star
id|bt
op_assign
op_amp
(paren
id|ov511-&gt;buf_timer
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;entered&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov511-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;deallocating buffer memory %s&quot;
comma
id|now
ques
c_cond
l_string|&quot;now&quot;
suffix:colon
l_string|&quot;later&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;buf_state
op_eq
id|BUF_PEND_DEALLOC
)paren
(brace
id|ov511-&gt;buf_state
op_assign
id|BUF_ALLOCATED
suffix:semicolon
id|del_timer
c_func
(paren
id|bt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|now
)paren
id|ov511_do_dealloc
c_func
(paren
id|ov511
)paren
suffix:semicolon
r_else
(brace
id|ov511-&gt;buf_state
op_assign
id|BUF_PEND_DEALLOC
suffix:semicolon
id|init_timer
c_func
(paren
id|bt
)paren
suffix:semicolon
id|bt-&gt;function
op_assign
id|ov511_buf_callback
suffix:semicolon
id|bt-&gt;data
op_assign
(paren
r_int
r_int
)paren
id|ov511
suffix:semicolon
id|bt-&gt;expires
op_assign
id|jiffies
op_plus
id|buf_timeout
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
id|bt
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|ov511-&gt;buf_lock
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;leaving&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * V4L API&n; *&n; ***************************************************************************/
DECL|function|ov511_open
r_static
r_int
id|ov511_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
suffix:semicolon
r_int
id|err
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;opening&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;user
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|ov511_alloc
c_func
(paren
id|ov511
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ov511-&gt;sub_flag
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|ov511_init_isoc
c_func
(paren
id|ov511
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ov511_dealloc
c_func
(paren
id|ov511
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ov511-&gt;user
op_increment
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ov511_close
r_static
r_void
id|ov511_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;ov511_close&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
id|ov511-&gt;user
op_decrement
suffix:semicolon
id|ov511_stop_isoc
c_func
(paren
id|ov511
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;dev
)paren
id|ov511_dealloc
c_func
(paren
id|ov511
comma
l_int|0
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;dev
)paren
(brace
id|ov511_dealloc
c_func
(paren
id|ov511
comma
l_int|1
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|ov511-&gt;vdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov511
)paren
suffix:semicolon
id|ov511
op_assign
l_int|NULL
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|ov511_init_done
r_static
r_int
id|ov511_init_done
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|create_proc_ov511_cam
c_func
(paren
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ov511_write
r_static
r_int
id|ov511_write
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ov511_ioctl
r_static
r_int
id|ov511_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|vdev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|vdev
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;IOCtl: 0x%X&quot;
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;dev
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;VIDIOCGCAP&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|b.name
comma
l_string|&quot;OV511 USB Camera&quot;
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_SUBCAPTURE
suffix:semicolon
id|b.channels
op_assign
l_int|1
suffix:semicolon
id|b.audios
op_assign
l_int|0
suffix:semicolon
id|b.maxwidth
op_assign
id|ov511-&gt;maxwidth
suffix:semicolon
id|b.maxheight
op_assign
id|ov511-&gt;maxheight
suffix:semicolon
id|b.minwidth
op_assign
l_int|160
suffix:semicolon
id|b.minheight
op_assign
l_int|120
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v.channel
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Camera&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;VIDIOCGPICT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov7610_get_picture
c_func
(paren
id|ov511
comma
op_amp
id|p
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;VIDIOCSPICT&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511_get_depth
c_func
(paren
id|p.palette
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ov7610_set_picture
c_func
(paren
id|ov511
comma
op_amp
id|p
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Setting depth=%d, palette=%d&quot;
comma
id|p.depth
comma
id|p.palette
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|depth
op_assign
id|p.depth
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|format
op_assign
id|p.palette
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|segsize
op_assign
id|GET_SEGSIZE
c_func
(paren
id|p.palette
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCAPTURE
suffix:colon
(brace
r_int
id|vf
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;VIDIOCGCAPTURE&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vf
comma
id|arg
comma
r_sizeof
(paren
id|vf
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ov511-&gt;sub_flag
op_assign
id|vf
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCAPTURE
suffix:colon
(brace
r_struct
id|video_capture
id|vc
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vc
comma
id|arg
comma
r_sizeof
(paren
id|vc
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|vc.flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vc.decimation
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|vc.x
op_and_assign
op_complement
l_int|3L
suffix:semicolon
id|vc.y
op_and_assign
op_complement
l_int|1L
suffix:semicolon
id|vc.y
op_and_assign
op_complement
l_int|31L
suffix:semicolon
r_if
c_cond
(paren
id|vc.width
op_eq
l_int|0
)paren
id|vc.width
op_assign
l_int|32
suffix:semicolon
id|vc.height
op_div_assign
l_int|16
suffix:semicolon
id|vc.height
op_mul_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|vc.height
op_eq
l_int|0
)paren
id|vc.height
op_assign
l_int|16
suffix:semicolon
id|ov511-&gt;subx
op_assign
id|vc.x
suffix:semicolon
id|ov511-&gt;suby
op_assign
id|vc.y
suffix:semicolon
id|ov511-&gt;subw
op_assign
id|vc.width
suffix:semicolon
id|ov511-&gt;subh
op_assign
id|vc.height
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
r_int
id|i
comma
id|result
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;VIDIOCSWIN: width=%d, height=%d&quot;
comma
id|vw.width
comma
id|vw.height
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|vw.flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.clipcount
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.height
op_ne
id|ov511-&gt;maxheight
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.width
op_ne
id|ov511-&gt;maxwidth
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
multiline_comment|/* If we&squot;re collecting previous frame wait&n;&t;&t;   before changing modes */
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ov511-&gt;wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|result
op_assign
id|ov511_mode_init_regs
c_func
(paren
id|ov511
comma
id|vw.width
comma
id|vw.height
comma
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|format
comma
id|ov511-&gt;sub_flag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|width
op_assign
id|vw.width
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|height
op_assign
id|vw.height
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
id|vw.x
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME */
id|vw.y
op_assign
l_int|0
suffix:semicolon
id|vw.width
op_assign
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|width
suffix:semicolon
id|vw.height
op_assign
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|height
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|30
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;VIDIOCGWIN: %dx%d&quot;
comma
id|vw.width
comma
id|vw.height
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
id|vm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vm
comma
l_int|0
comma
r_sizeof
(paren
id|vm
)paren
)paren
suffix:semicolon
id|vm.size
op_assign
id|OV511_NUMFRAMES
op_star
id|MAX_DATA_SIZE
suffix:semicolon
id|vm.frames
op_assign
id|OV511_NUMFRAMES
suffix:semicolon
id|vm.offsets
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|vm.offsets
(braket
l_int|1
)braket
op_assign
id|MAX_FRAME_SIZE
op_plus
r_sizeof
(paren
r_struct
id|timeval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
r_int
id|ret
comma
id|depth
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;CMCAPTURE&quot;
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;frame: %d, size: %dx%d, format: %d&quot;
comma
id|vm.frame
comma
id|vm.width
comma
id|vm.height
comma
id|vm.format
)paren
suffix:semicolon
id|depth
op_assign
id|ov511_get_depth
c_func
(paren
id|vm.format
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|depth
)paren
(brace
id|err
c_func
(paren
l_string|&quot;VIDIOCMCAPTURE: invalid format (%d)&quot;
comma
id|vm.format
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|vm.frame
op_ne
l_int|0
)paren
op_logical_and
(paren
id|vm.frame
op_ne
l_int|1
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;VIDIOCMCAPTURE: invalid frame (%d)&quot;
comma
id|vm.frame
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vm.width
OG
id|ov511-&gt;maxwidth
op_logical_or
id|vm.height
OG
id|ov511-&gt;maxheight
)paren
(brace
id|err
c_func
(paren
l_string|&quot;VIDIOCMCAPTURE: requested dimensions too big&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Don&squot;t compress if the size changed */
r_if
c_cond
(paren
(paren
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|width
op_ne
id|vm.width
)paren
op_logical_or
(paren
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|height
op_ne
id|vm.height
)paren
op_logical_or
(paren
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|format
op_ne
id|vm.format
)paren
op_logical_or
(paren
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|sub_flag
op_ne
id|ov511-&gt;sub_flag
)paren
)paren
(brace
multiline_comment|/* If we&squot;re collecting previous frame wait&n;&t;&t;&t;   before changing modes */
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ov511-&gt;wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|ret
op_assign
id|ov511_mode_init_regs
c_func
(paren
id|ov511
comma
id|vm.width
comma
id|vm.height
comma
id|vm.format
comma
id|ov511-&gt;sub_flag
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
macro_line|#endif
)brace
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|width
op_assign
id|vm.width
suffix:semicolon
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|height
op_assign
id|vm.height
suffix:semicolon
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|format
op_assign
id|vm.format
suffix:semicolon
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|sub_flag
op_assign
id|ov511-&gt;sub_flag
suffix:semicolon
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|segsize
op_assign
id|GET_SEGSIZE
c_func
(paren
id|vm.format
)paren
suffix:semicolon
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|depth
op_assign
id|depth
suffix:semicolon
multiline_comment|/* Mark it as ready */
id|ov511-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
op_assign
id|FRAME_READY
suffix:semicolon
r_return
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|vm.frame
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
id|frame
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|frame
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;syncing to frame %d, grabstate = %d&quot;
comma
id|frame
comma
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
)paren
(brace
r_case
id|FRAME_UNUSED
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|FRAME_READY
suffix:colon
r_case
id|FRAME_GRABBING
suffix:colon
r_case
id|FRAME_ERROR
suffix:colon
id|redo
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;dev
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_do
(brace
macro_line|#if 0
id|init_waitqueue_head
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|wq
)paren
suffix:semicolon
macro_line|#endif
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
id|retry_sync
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;***retry sync***&quot;
)paren
suffix:semicolon
multiline_comment|/* Polling apps will destroy frames with that! */
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frame
)paren
suffix:semicolon
id|ov511-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* This will request another frame. */
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|wq
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|wq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_eq
id|FRAME_ERROR
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frame
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_goto
id|redo
suffix:semicolon
)brace
r_case
id|FRAME_DONE
suffix:colon
r_if
c_cond
(paren
id|ov511-&gt;snap_enabled
op_logical_and
op_logical_neg
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|snapshot
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frame
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_goto
id|redo
suffix:semicolon
)brace
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
multiline_comment|/* Reset the hardware snapshot button */
multiline_comment|/* FIXME - Is this the best place for this? */
r_if
c_cond
(paren
(paren
id|ov511-&gt;snap_enabled
)paren
op_logical_and
(paren
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|snapshot
)paren
)paren
(brace
id|ov511-&gt;frame
(braket
id|frame
)braket
dot
id|snapshot
op_assign
l_int|0
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_REG_SYSTEM_SNAPSHOT
comma
l_int|0x01
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_REG_SYSTEM_SNAPSHOT
comma
l_int|0x03
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_REG_SYSTEM_SNAPSHOT
comma
l_int|0x01
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|vb
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vb
comma
l_int|0
comma
r_sizeof
(paren
id|vb
)paren
)paren
suffix:semicolon
id|vb.base
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* frame buffer not supported, not used */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vb
comma
r_sizeof
(paren
id|vb
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCKEY
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|VIDIOCCAPTURE
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCSFBUF
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGTUNER
suffix:colon
r_case
id|VIDIOCSTUNER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGFREQ
suffix:colon
r_case
id|VIDIOCSFREQ
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_case
id|VIDIOCSAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
multiline_comment|/* end switch */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ov511_read
r_static
r_int
id|ov511_read
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|frmx
op_assign
op_minus
l_int|1
suffix:semicolon
r_volatile
r_struct
id|ov511_frame
op_star
id|frame
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;%ld bytes, noblock=%d&quot;
comma
id|count
comma
id|noblock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;dev
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* See if a frame is completed, then use it. */
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_ge
id|FRAME_DONE
)paren
multiline_comment|/* _DONE or _ERROR */
id|frmx
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_ge
id|FRAME_DONE
)paren
multiline_comment|/* _DONE or _ERROR */
id|frmx
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* If nonblocking we return immediately */
r_if
c_cond
(paren
id|noblock
op_logical_and
(paren
id|frmx
op_eq
op_minus
l_int|1
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
multiline_comment|/* If no FRAME_DONE, look for a FRAME_GRABBING state. */
multiline_comment|/* See if a frame is in process (grabbing), then use it. */
r_if
c_cond
(paren
id|frmx
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
id|frmx
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov511-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
id|frmx
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If no frame is active, start one. */
r_if
c_cond
(paren
id|frmx
op_eq
op_minus
l_int|1
)paren
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frmx
op_assign
l_int|0
)paren
suffix:semicolon
id|frame
op_assign
op_amp
id|ov511-&gt;frame
(braket
id|frmx
)braket
suffix:semicolon
id|restart
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;dev
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Wait while we&squot;re grabbing the image */
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Waiting image grabbing&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_GRABBING
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|frmx
)braket
dot
id|wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Got image, frame-&gt;grabstate = %d&quot;
comma
id|frame-&gt;grabstate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;grabstate
op_eq
id|FRAME_ERROR
)paren
(brace
id|frame-&gt;bytes_read
op_assign
l_int|0
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;** ick! ** Errored frame %d&quot;
comma
id|ov511-&gt;curframe
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frmx
)paren
)paren
id|err
c_func
(paren
l_string|&quot;read: ov511_new_frame error&quot;
)paren
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
multiline_comment|/* Repeat until we get a snapshot frame */
r_if
c_cond
(paren
id|ov511-&gt;snap_enabled
)paren
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;Waiting snapshot frame&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;snap_enabled
op_logical_and
op_logical_neg
id|frame-&gt;snapshot
)paren
(brace
id|frame-&gt;bytes_read
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ov511_new_frame
c_func
(paren
id|ov511
comma
id|frmx
)paren
)paren
id|err
c_func
(paren
l_string|&quot;ov511_new_frame error&quot;
)paren
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
multiline_comment|/* Clear the snapshot */
r_if
c_cond
(paren
id|ov511-&gt;snap_enabled
op_logical_and
id|frame-&gt;snapshot
)paren
(brace
id|frame-&gt;snapshot
op_assign
l_int|0
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_REG_SYSTEM_SNAPSHOT
comma
l_int|0x01
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_REG_SYSTEM_SNAPSHOT
comma
l_int|0x03
)paren
suffix:semicolon
id|ov511_reg_write
c_func
(paren
id|ov511-&gt;dev
comma
id|OV511_REG_SYSTEM_SNAPSHOT
comma
l_int|0x01
)paren
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;frmx=%d, bytes_read=%ld, scanlength=%ld&quot;
comma
id|frmx
comma
id|frame-&gt;bytes_read
comma
id|frame-&gt;scanlength
)paren
suffix:semicolon
multiline_comment|/* copy bytes to user space; we allow for partials reads */
singleline_comment|//&t;if ((count + frame-&gt;bytes_read) &gt; frame-&gt;scanlength)
singleline_comment|//&t;&t;count = frame-&gt;scanlength - frame-&gt;bytes_read;
multiline_comment|/* FIXME - count hardwired to be one frame... */
id|count
op_assign
id|frame-&gt;width
op_star
id|frame-&gt;height
op_star
(paren
id|frame-&gt;depth
op_rshift
l_int|3
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Copy to user space: %ld bytes&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|copy_to_user
c_func
(paren
id|buf
comma
id|frame-&gt;data
op_plus
id|frame-&gt;bytes_read
comma
id|count
)paren
)paren
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Copy failed! %d bytes not copied&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|frame-&gt;bytes_read
op_add_assign
id|count
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;{copy} count used=%ld, new bytes_read=%ld&quot;
comma
id|count
comma
id|frame-&gt;bytes_read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;bytes_read
op_ge
id|frame-&gt;scanlength
)paren
(brace
multiline_comment|/* All data has been read */
id|frame-&gt;bytes_read
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Mark it as available to be used again. */
id|ov511-&gt;frame
(braket
id|frmx
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_if
c_cond
(paren
id|ov511_new_frame
c_func
(paren
id|ov511
comma
op_logical_neg
id|frmx
)paren
)paren
id|err
c_func
(paren
l_string|&quot;ov511_new_frame returned error&quot;
)paren
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;read finished, returning %ld (sweet)&quot;
comma
id|count
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|ov511_mmap
r_static
r_int
id|ov511_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;dev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;mmap: %ld (%lX) bytes&quot;
comma
id|size
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
(paren
(paren
id|OV511_NUMFRAMES
op_star
id|MAX_DATA_SIZE
)paren
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pos
op_assign
(paren
r_int
r_int
)paren
id|ov511-&gt;fbuf
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ov511_template
r_static
r_struct
id|video_device
id|ov511_template
op_assign
(brace
id|name
suffix:colon
l_string|&quot;OV511 USB Camera&quot;
comma
id|type
suffix:colon
id|VID_TYPE_CAPTURE
comma
id|hardware
suffix:colon
id|VID_HARDWARE_OV511
comma
id|open
suffix:colon
id|ov511_open
comma
id|close
suffix:colon
id|ov511_close
comma
id|read
suffix:colon
id|ov511_read
comma
id|write
suffix:colon
id|ov511_write
comma
id|ioctl
suffix:colon
id|ov511_ioctl
comma
id|mmap
suffix:colon
id|ov511_mmap
comma
id|initialize
suffix:colon
id|ov511_init_done
comma
)brace
suffix:semicolon
multiline_comment|/****************************************************************************&n; *&n; * OV511/OV7610 configuration&n; *&n; ***************************************************************************/
DECL|function|ov76xx_configure
r_static
r_int
id|ov76xx_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
r_int
id|i
comma
id|success
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Lawrence Glaister &lt;lg@jfm.bc.ca&gt; reports:&n;&t; *&n;&t; * Register 0x0f in the 7610 has the following effects:&n;&t; *&n;&t; * 0x85 (AEC method 1): Best overall, good contrast range&n;&t; * 0x45 (AEC method 2): Very overexposed&n;&t; * 0xa5 (spec sheet default): Ok, but the black level is&n;&t; *&t;shifted resulting in loss of contrast&n;&t; * 0x05 (old driver setting): very overexposed, too much&n;&t; *&t;contrast&n;&t; */
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm7610
(braket
)braket
op_assign
(brace
(brace
id|OV511_I2C_BUS
comma
l_int|0x10
comma
l_int|0xff
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x16
comma
l_int|0x06
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x28
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2b
comma
l_int|0xac
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x38
comma
l_int|0x81
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x28
comma
l_int|0x24
)brace
comma
multiline_comment|/* 0c */
(brace
id|OV511_I2C_BUS
comma
l_int|0x0f
comma
l_int|0x85
)brace
comma
multiline_comment|/* lg&squot;s setting */
(brace
id|OV511_I2C_BUS
comma
l_int|0x15
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x20
comma
l_int|0x1c
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x23
comma
l_int|0x2a
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x24
comma
l_int|0x10
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x25
comma
l_int|0x8a
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x27
comma
l_int|0xc2
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2a
comma
l_int|0x04
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2c
comma
l_int|0xfe
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x30
comma
l_int|0x71
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x31
comma
l_int|0x60
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x32
comma
l_int|0x26
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x33
comma
l_int|0x20
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x34
comma
l_int|0x48
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x11
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0c
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0d
comma
l_int|0x24
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm7620
(braket
)braket
op_assign
(brace
(brace
id|OV511_I2C_BUS
comma
l_int|0x10
comma
l_int|0xff
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x16
comma
l_int|0x06
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x28
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2b
comma
l_int|0xac
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x28
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0f
comma
l_int|0x85
)brace
comma
multiline_comment|/* lg&squot;s setting */
(brace
id|OV511_I2C_BUS
comma
l_int|0x15
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x23
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x24
comma
l_int|0x10
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x25
comma
l_int|0x8a
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x27
comma
l_int|0xe2
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2a
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2c
comma
l_int|0xfe
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x30
comma
l_int|0x71
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x31
comma
l_int|0x60
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x32
comma
l_int|0x26
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x33
comma
l_int|0x20
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x34
comma
l_int|0x48
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x11
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0c
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0d
comma
l_int|0x24
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;starting configuration&quot;
)paren
suffix:semicolon
multiline_comment|/* This looks redundant, but is necessary for WebCam 3 */
r_if
c_cond
(paren
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SLAVE_ID_WRITE
comma
id|OV7610_I2C_WRITE_ID
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SLAVE_ID_READ
comma
id|OV7610_I2C_READ_ID
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ov511_reset
c_func
(paren
id|dev
comma
id|OV511_RESET_NOREGS
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Reset the 76xx */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|schedule_timeout
(paren
l_int|1
op_plus
l_int|150
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|success
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|i2c_detect_tries
op_logical_and
op_logical_neg
id|success
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_ID_HIGH
)paren
op_eq
l_int|0x7F
)paren
op_logical_and
(paren
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_ID_LOW
)paren
op_eq
l_int|0xA2
)paren
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Reset the 76xx */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|schedule_timeout
(paren
l_int|1
op_plus
l_int|150
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* Dummy read to sync I2C */
r_if
c_cond
(paren
id|ov511_i2c_read
c_func
(paren
id|dev
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|success
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;I2C synced in %d attempt(s) (method 1)&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Reset the 76xx */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|schedule_timeout
(paren
l_int|1
op_plus
l_int|150
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|success
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
op_le
id|i2c_detect_tries
)paren
(brace
r_if
c_cond
(paren
(paren
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_ID_HIGH
)paren
op_eq
l_int|0x7F
)paren
op_logical_and
(paren
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_ID_LOW
)paren
op_eq
l_int|0xA2
)paren
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|i
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|i
op_eq
id|i2c_detect_tries
)paren
op_logical_and
(paren
id|success
op_eq
l_int|0
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to read sensor ID. You might not have an OV7610/20,&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;or it may be not responding. Report this to&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;mwm@i.am&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;I2C synced in %d attempt(s) (method 2)&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Detect sensor if user didn&squot;t use override param */
r_if
c_cond
(paren
id|sensor
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_COM_I
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error detecting sensor type&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|3
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Sensor is an OV7610&quot;
)paren
suffix:semicolon
id|ov511-&gt;sensor
op_assign
id|SEN_OV7610
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|1
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Sensor is an OV7620AE&quot;
)paren
suffix:semicolon
id|ov511-&gt;sensor
op_assign
id|SEN_OV7620AE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_amp
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Sensor is an OV7620&quot;
)paren
suffix:semicolon
id|ov511-&gt;sensor
op_assign
id|SEN_OV7620
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Unknown image sensor version: %d&quot;
comma
id|rc
op_amp
l_int|3
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* sensor != 0; user overrode detection */
id|ov511-&gt;sensor
op_assign
id|sensor
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;Sensor set to type %d&quot;
comma
id|ov511-&gt;sensor
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Writing 7620 registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_write_regvals
c_func
(paren
id|dev
comma
id|aRegvalsNorm7620
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Writing 7610 registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_write_regvals
c_func
(paren
id|dev
comma
id|aRegvalsNorm7610
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set sensor-specific vars */
id|ov511-&gt;maxwidth
op_assign
l_int|640
suffix:semicolon
id|ov511-&gt;maxheight
op_assign
l_int|480
suffix:semicolon
r_if
c_cond
(paren
id|aperture
OL
l_int|0
)paren
(brace
multiline_comment|/* go with the default */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x26
comma
l_int|0xa2
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|aperture
op_le
l_int|0xf
)paren
(brace
multiline_comment|/* user overrode default */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x26
comma
(paren
id|aperture
op_lshift
l_int|4
)paren
op_plus
l_int|2
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Invalid setting for aperture; legal value: 0 - 15&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|autoadjust
)paren
(brace
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x13
comma
l_int|0x01
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x2d
comma
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620
ques
c_cond
l_int|0x91
suffix:colon
l_int|0x93
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x13
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x2d
comma
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620
ques
c_cond
l_int|0x81
suffix:colon
l_int|0x83
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x28
comma
id|ov511_i2c_read
c_func
(paren
id|dev
comma
l_int|0x28
)paren
op_or
l_int|8
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ov6xx0_configure
r_static
r_int
id|ov6xx0_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
r_int
id|i
comma
id|success
comma
id|rc
suffix:semicolon
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm6x20
(braket
)braket
op_assign
(brace
(brace
id|OV511_I2C_BUS
comma
l_int|0x12
comma
l_int|0x80
)brace
comma
multiline_comment|/* reset */
(brace
id|OV511_I2C_BUS
comma
l_int|0x11
comma
l_int|0x01
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x03
comma
l_int|0xd0
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x05
comma
l_int|0x7f
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x07
comma
l_int|0xa8
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0c
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x0d
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x10
comma
l_int|0xff
)brace
comma
multiline_comment|/* ? */
(brace
id|OV511_I2C_BUS
comma
l_int|0x14
comma
l_int|0x04
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x16
comma
l_int|0x06
)brace
comma
multiline_comment|/* ? */
(brace
id|OV511_I2C_BUS
comma
l_int|0x19
comma
l_int|0x04
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x1a
comma
l_int|0x93
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x20
comma
l_int|0x28
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x27
comma
l_int|0xa2
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x28
comma
l_int|0x24
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x2a
comma
l_int|0x04
)brace
comma
multiline_comment|/* 84? */
(brace
id|OV511_I2C_BUS
comma
l_int|0x2b
comma
l_int|0xac
)brace
comma
multiline_comment|/* a8? */
(brace
id|OV511_I2C_BUS
comma
l_int|0x2d
comma
l_int|0x95
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x33
comma
l_int|0x28
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x34
comma
l_int|0xc7
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x38
comma
l_int|0x8b
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x3c
comma
l_int|0x5c
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x3d
comma
l_int|0x80
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x3f
comma
l_int|0x00
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x4a
comma
l_int|0x80
)brace
comma
multiline_comment|/* undocumented */
(brace
id|OV511_I2C_BUS
comma
l_int|0x4b
comma
l_int|0x80
)brace
comma
multiline_comment|/* undocumented */
(brace
id|OV511_I2C_BUS
comma
l_int|0x4d
comma
l_int|0xd2
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x4e
comma
l_int|0xc1
)brace
comma
(brace
id|OV511_I2C_BUS
comma
l_int|0x4f
comma
l_int|0x04
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;starting sensor configuration&quot;
)paren
suffix:semicolon
multiline_comment|/* Reset the 6xx0 */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|schedule_timeout
(paren
l_int|1
op_plus
l_int|150
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|success
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|i2c_detect_tries
op_logical_and
op_logical_neg
id|success
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_ID_HIGH
)paren
op_eq
l_int|0x7F
)paren
op_logical_and
(paren
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_ID_LOW
)paren
op_eq
l_int|0xA2
)paren
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Reset the 6xx0 */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|schedule_timeout
(paren
l_int|1
op_plus
l_int|150
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* Dummy read to sync I2C */
r_if
c_cond
(paren
id|ov511_i2c_read
c_func
(paren
id|dev
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|success
)paren
(brace
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;I2C synced in %d attempt(s)&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Failed to read sensor ID. You might not have an OV6xx0,&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;or it may be not responding. Report this to&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;mwm@i.am&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Detect sensor if user didn&squot;t use override param */
r_if
c_cond
(paren
id|sensor
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|ov511_i2c_read
c_func
(paren
id|dev
comma
id|OV7610_REG_COM_I
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error detecting sensor type&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|info
c_func
(paren
l_string|&quot;Sensor is an OV6xx0 (version %d)&quot;
comma
id|rc
op_amp
l_int|3
)paren
suffix:semicolon
id|ov511-&gt;sensor
op_assign
id|SEN_OV6620
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* sensor != 0; user overrode detection */
id|ov511-&gt;sensor
op_assign
id|sensor
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;Sensor set to type %d&quot;
comma
id|ov511-&gt;sensor
)paren
suffix:semicolon
)brace
multiline_comment|/* Set sensor-specific vars */
id|ov511-&gt;maxwidth
op_assign
l_int|352
suffix:semicolon
id|ov511-&gt;maxheight
op_assign
l_int|288
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;Writing 6x20 registers&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511_write_regvals
c_func
(paren
id|dev
comma
id|aRegvalsNorm6x20
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|aperture
OL
l_int|0
)paren
(brace
multiline_comment|/* go with the default */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x26
comma
l_int|0xa2
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|aperture
op_le
l_int|0xf
)paren
(brace
multiline_comment|/* user overrode default */
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x26
comma
(paren
id|aperture
op_lshift
l_int|4
)paren
op_plus
l_int|2
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Invalid setting for aperture; legal value: 0 - 15&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|autoadjust
)paren
(brace
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x13
comma
l_int|0x01
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x2d
comma
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620
ques
c_cond
l_int|0x91
suffix:colon
l_int|0x93
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x13
comma
l_int|0x00
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x2d
comma
id|ov511-&gt;sensor
op_eq
id|SEN_OV7620
ques
c_cond
l_int|0x81
suffix:colon
l_int|0x83
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x28
comma
id|ov511_i2c_read
c_func
(paren
id|dev
comma
l_int|0x28
)paren
op_or
l_int|8
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ov511_configure
r_static
r_int
id|ov511_configure
c_func
(paren
r_struct
id|usb_ov511
op_star
id|ov511
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|ov511-&gt;dev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_static
r_struct
id|ov511_regvals
id|aRegvalsInit
(braket
)braket
op_assign
(brace
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_SYSTEM_RESET
comma
l_int|0x7f
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_SYSTEM_INIT
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_SYSTEM_RESET
comma
l_int|0x7f
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_SYSTEM_INIT
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_SYSTEM_RESET
comma
l_int|0x3f
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_SYSTEM_INIT
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_SYSTEM_RESET
comma
l_int|0x3d
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
r_static
r_struct
id|ov511_regvals
id|aRegvalsNorm511
(braket
)braket
op_assign
(brace
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_DRAM_ENABLE_FLOW_CONTROL
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_SYSTEM_SNAPSHOT
comma
l_int|0x02
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_SYSTEM_SNAPSHOT
comma
l_int|0x00
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_REG_FIFO_BITMASK
comma
l_int|0x1f
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_PREDICTION_HORIZ_Y
comma
l_int|0x08
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_PREDICTION_HORIZ_UV
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_PREDICTION_VERT_Y
comma
l_int|0x08
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_PREDICTION_VERT_UV
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_QUANTIZATION_HORIZ_Y
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_QUANTIZATION_HORIZ_UV
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_QUANTIZATION_VERT_Y
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_QUANTIZATION_VERT_UV
comma
l_int|0x01
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_ENABLE
comma
l_int|0x06
)brace
comma
(brace
id|OV511_REG_BUS
comma
id|OV511_OMNICE_LUT_ENABLE
comma
l_int|0x03
)brace
comma
(brace
id|OV511_DONE_BUS
comma
l_int|0x0
comma
l_int|0x00
)brace
comma
)brace
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ov511-&gt;vdev
comma
op_amp
id|ov511_template
comma
r_sizeof
(paren
id|ov511_template
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
id|init_waitqueue_head
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|wq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ov511-&gt;wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|ov511-&gt;vdev
comma
id|VFL_TYPE_GRABBER
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;video_register_device failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov511_write_regvals
c_func
(paren
id|dev
comma
id|aRegvalsInit
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov511_write_regvals
c_func
(paren
id|dev
comma
id|aRegvalsNorm511
)paren
)paren
r_goto
id|error
suffix:semicolon
id|ov511_set_packet_size
c_func
(paren
id|ov511
comma
l_int|0
)paren
suffix:semicolon
id|ov511-&gt;snap_enabled
op_assign
id|snapshot
suffix:semicolon
multiline_comment|/* Test for 76xx */
r_if
c_cond
(paren
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SLAVE_ID_WRITE
comma
id|OV7610_I2C_WRITE_ID
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SLAVE_ID_READ
comma
id|OV7610_I2C_READ_ID
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov511_reset
c_func
(paren
id|dev
comma
id|OV511_RESET_NOREGS
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Test for 6xx0 */
r_if
c_cond
(paren
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SLAVE_ID_WRITE
comma
id|OV6xx0_I2C_WRITE_ID
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov511_reg_write
c_func
(paren
id|dev
comma
id|OV511_REG_I2C_SLAVE_ID_READ
comma
id|OV6xx0_I2C_READ_ID
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov511_reset
c_func
(paren
id|dev
comma
id|OV511_RESET_NOREGS
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|ov511_i2c_write
c_func
(paren
id|dev
comma
l_int|0x12
comma
l_int|0x80
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Can&squot;t determine sensor slave IDs&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov6xx0_configure
c_func
(paren
id|ov511
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;failed to configure OV6xx0&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov76xx_configure
c_func
(paren
id|ov511
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;failed to configure OV76xx&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
multiline_comment|/* Set default sizes in case IOCTL (VIDIOCMCAPTURE) is not used&n;&t; * (using read() instead). */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|width
op_assign
id|ov511-&gt;maxwidth
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|height
op_assign
id|ov511-&gt;maxheight
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|depth
op_assign
l_int|24
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|bytes_read
op_assign
l_int|0
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|segment
op_assign
l_int|0
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|format
op_assign
id|VIDEO_PALETTE_RGB24
suffix:semicolon
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|segsize
op_assign
id|GET_SEGSIZE
c_func
(paren
id|ov511-&gt;frame
(braket
id|i
)braket
dot
id|format
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize to max width/height, RGB24 */
r_if
c_cond
(paren
id|ov511_mode_init_regs
c_func
(paren
id|ov511
comma
id|ov511-&gt;maxwidth
comma
id|ov511-&gt;maxheight
comma
id|VIDEO_PALETTE_RGB24
comma
l_int|0
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|video_unregister_device
c_func
(paren
op_amp
id|ov511-&gt;vdev
)paren
suffix:semicolon
id|usb_driver_release_interface
c_func
(paren
op_amp
id|ov511_driver
comma
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|ov511-&gt;iface
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  USB routines&n; *&n; ***************************************************************************/
r_static
r_void
op_star
DECL|function|ov511_probe
id|ov511_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|ifnum
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_ov511
op_star
id|ov511
suffix:semicolon
r_int
id|i
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;probing for device...&quot;
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t handle multi-config cameras */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
r_return
l_int|NULL
suffix:semicolon
id|interface
op_assign
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|ifnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Checking vendor/product should be enough, but what the hell */
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|0xFF
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|0x00
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* Since code below may sleep, we use this as a lock */
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ov511
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ov511
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;couldn&squot;t kmalloc ov511 struct&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ov511
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ov511
)paren
)paren
suffix:semicolon
id|ov511-&gt;dev
op_assign
id|dev
suffix:semicolon
id|ov511-&gt;iface
op_assign
id|interface-&gt;bInterfaceNumber
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;descriptor.idProduct
)paren
(brace
r_case
l_int|0x0511
suffix:colon
id|info
c_func
(paren
l_string|&quot;USB OV511 camera found&quot;
)paren
suffix:semicolon
id|ov511-&gt;bridge
op_assign
id|BRG_OV511
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xA511
suffix:colon
id|info
c_func
(paren
l_string|&quot;USB OV511+ camera found&quot;
)paren
suffix:semicolon
id|ov511-&gt;bridge
op_assign
id|BRG_OV511PLUS
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0002
suffix:colon
r_if
c_cond
(paren
id|dev-&gt;descriptor.idVendor
op_ne
l_int|0x0813
)paren
r_goto
id|error
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;Intel Play Me2Cam (OV511+) found&quot;
)paren
suffix:semicolon
id|ov511-&gt;bridge
op_assign
id|BRG_OV511PLUS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;Unknown product ID&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|ov511-&gt;customid
op_assign
id|ov511_reg_read
c_func
(paren
id|dev
comma
id|OV511_REG_SYSTEM_CUSTOM_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ov511-&gt;customid
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Unable to read camera bridge registers&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|ov511-&gt;desc
op_assign
op_minus
l_int|1
suffix:semicolon
id|PDEBUG
(paren
l_int|4
comma
l_string|&quot;CustomID = %d&quot;
comma
id|ov511-&gt;customid
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|clist
(braket
id|i
)braket
dot
id|id
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ov511-&gt;customid
op_eq
id|clist
(braket
id|i
)braket
dot
id|id
)paren
(brace
id|info
c_func
(paren
l_string|&quot;camera: %s&quot;
comma
id|clist
(braket
id|i
)braket
dot
id|description
)paren
suffix:semicolon
id|ov511-&gt;desc
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Lifeview USB Life TV not supported */
r_if
c_cond
(paren
id|clist
(braket
id|i
)braket
dot
id|id
op_eq
l_int|38
)paren
(brace
id|err
c_func
(paren
l_string|&quot;This device is not supported yet.&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|clist
(braket
id|i
)braket
dot
id|id
op_eq
op_minus
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Camera type (%d) not recognized&quot;
comma
id|ov511-&gt;customid
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;Please contact mwm@i.am to request&quot;
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;support for your camera.&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Workaround for some applications that want data in RGB&n;&t; * instead of BGR */
r_if
c_cond
(paren
id|force_rgb
)paren
id|info
c_func
(paren
l_string|&quot;data format set to RGB&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov511_configure
c_func
(paren
id|ov511
)paren
)paren
(brace
id|ov511-&gt;user
op_assign
l_int|0
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ov511-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* to 1 == available */
id|init_MUTEX
c_func
(paren
op_amp
id|ov511-&gt;buf_lock
)paren
suffix:semicolon
id|ov511-&gt;buf_state
op_assign
id|BUF_NOT_ALLOCATED
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;Failed to configure camera&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|ov511
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|ov511
)paren
(brace
id|kfree
c_func
(paren
id|ov511
)paren
suffix:semicolon
id|ov511
op_assign
l_int|NULL
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|ov511_disconnect
id|ov511_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|usb_ov511
op_star
id|ov511
op_assign
(paren
r_struct
id|usb_ov511
op_star
)paren
id|ptr
suffix:semicolon
r_int
id|n
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want people trying to open up the device */
r_if
c_cond
(paren
op_logical_neg
id|ov511-&gt;user
)paren
id|video_unregister_device
c_func
(paren
op_amp
id|ov511-&gt;vdev
)paren
suffix:semicolon
r_else
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Device open...deferring video_unregister_device&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|n
op_increment
)paren
id|ov511-&gt;frame
(braket
id|n
)braket
dot
id|grabstate
op_assign
id|FRAME_ERROR
suffix:semicolon
id|ov511-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* This will cause the process to request another frame */
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|OV511_NUMFRAMES
suffix:semicolon
id|n
op_increment
)paren
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|n
)braket
dot
id|wq
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ov511-&gt;frame
(braket
id|n
)braket
dot
id|wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|ov511-&gt;wq
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ov511-&gt;wq
)paren
suffix:semicolon
id|ov511-&gt;streaming
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Unschedule all of the iso td&squot;s */
r_for
c_loop
(paren
id|n
op_assign
id|OV511_NUMSBUF
op_minus
l_int|1
suffix:semicolon
id|n
op_ge
l_int|0
suffix:semicolon
id|n
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
(brace
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
)paren
suffix:semicolon
id|ov511-&gt;sbuf
(braket
id|n
)braket
dot
id|urb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|usb_driver_release_interface
c_func
(paren
op_amp
id|ov511_driver
comma
op_amp
id|ov511-&gt;dev-&gt;actconfig-&gt;interface
(braket
id|ov511-&gt;iface
)braket
)paren
suffix:semicolon
id|ov511-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|destroy_proc_ov511_cam
c_func
(paren
id|ov511
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Free the memory */
r_if
c_cond
(paren
id|ov511
op_logical_and
op_logical_neg
id|ov511-&gt;user
)paren
(brace
id|ov511_dealloc
c_func
(paren
id|ov511
comma
l_int|1
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov511
)paren
suffix:semicolon
id|ov511
op_assign
l_int|NULL
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|variable|ov511_driver
r_static
r_struct
id|usb_driver
id|ov511_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ov511&quot;
comma
id|id_table
suffix:colon
id|device_table
comma
id|probe
suffix:colon
id|ov511_probe
comma
id|disconnect
suffix:colon
id|ov511_disconnect
)brace
suffix:semicolon
multiline_comment|/****************************************************************************&n; *&n; *  Module routines&n; *&n; ***************************************************************************/
DECL|function|usb_ov511_init
r_static
r_int
id|__init
id|usb_ov511_init
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|proc_ov511_create
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|usb_register
c_func
(paren
op_amp
id|ov511_driver
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;ov511 driver version %s registered&quot;
comma
id|version
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_ov511_exit
r_static
r_void
id|__exit
id|usb_ov511_exit
c_func
(paren
r_void
)paren
(brace
id|usb_deregister
c_func
(paren
op_amp
id|ov511_driver
)paren
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;driver deregistered&quot;
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_VIDEO_PROC_FS)
id|proc_ov511_destroy
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif 
)brace
DECL|variable|usb_ov511_init
id|module_init
c_func
(paren
id|usb_ov511_init
)paren
suffix:semicolon
DECL|variable|usb_ov511_exit
id|module_exit
c_func
(paren
id|usb_ov511_exit
)paren
suffix:semicolon
eof
