multiline_comment|/*&n; * HCD (OHCI) Virtual Root Hub for USB.&n; *&n; * (C) Copyright 1999 Roman Weissgaerber (weissg@vienna.at)&n; *&n; * The Root Hub is build into the HC (UHCI or OHCI) hardware. &n; * This piece of code lets it look like it resides on the usb&n; * like the other hubs.&n; * (for anyone who wants to do a control operation on the root hub)&n; *  &n; * v2.1 1999/05/09 &n; * v2.0 1999/05/04&n; * v1.0 1999/04/27&n; * ohci-root-hub.c&n; *  &n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;ohci-hcd.h&quot; 
macro_line|#ifdef VROOTHUB 
macro_line|#include &quot;ohci-root-hub.h&quot;
DECL|variable|root_hub_dev_des
r_static
id|__u8
id|root_hub_dev_des
(braket
)braket
op_assign
(brace
l_int|0x12
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x01
comma
multiline_comment|/*  __u8  bDescriptorType; Device */
l_int|0x00
comma
multiline_comment|/*  __u16 bcdUSB; v1.0 */
l_int|0x01
comma
l_int|0x09
comma
multiline_comment|/*  __u8  bDeviceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceProtocol; */
l_int|0x08
comma
multiline_comment|/*  __u8  bMaxPacketSize0; 8 Bytes */
l_int|0x00
comma
multiline_comment|/*  __u16 idVendor; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 idProduct; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 bcdDevice; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u8  iManufacturer; */
l_int|0x00
comma
multiline_comment|/*  __u8  iProduct; */
l_int|0x00
comma
multiline_comment|/*  __u8  iSerialNumber; */
l_int|0x01
multiline_comment|/*  __u8  bNumConfigurations; */
)brace
suffix:semicolon
multiline_comment|/* Configuration descriptor */
DECL|variable|root_hub_config_des
r_static
id|__u8
id|root_hub_config_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x02
comma
multiline_comment|/*  __u8  bDescriptorType; Configuration */
l_int|0x19
comma
multiline_comment|/*  __u16 wTotalLength; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bNumInterfaces; */
l_int|0x01
comma
multiline_comment|/*  __u8  bConfigurationValue; */
l_int|0x00
comma
multiline_comment|/*  __u8  iConfiguration; */
l_int|0x40
comma
multiline_comment|/*  __u8  bmAttributes; &n;                 Bit 7: Bus-powered, 6: Self-powered, 5 Remote-wakwup, 4..0: resvd */
l_int|0x00
comma
multiline_comment|/*  __u8  MaxPower; */
multiline_comment|/* interface */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bLength; */
l_int|0x04
comma
multiline_comment|/*  __u8  if_bDescriptorType; Interface */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceNumber; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bAlternateSetting; */
l_int|0x01
comma
multiline_comment|/*  __u8  if_bNumEndpoints; */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bInterfaceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceProtocol; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_iInterface; */
multiline_comment|/* endpoint */
l_int|0x07
comma
multiline_comment|/*  __u8  ep_bLength; */
l_int|0x05
comma
multiline_comment|/*  __u8  ep_bDescriptorType; Endpoint */
l_int|0x81
comma
multiline_comment|/*  __u8  ep_bEndpointAddress; IN Endpoint 1 */
l_int|0x03
comma
multiline_comment|/*  __u8  ep_bmAttributes; Interrupt */
l_int|0x40
comma
multiline_comment|/*  __u16 ep_wMaxPacketSize; 64 Bytes */
l_int|0x00
comma
l_int|0xff
multiline_comment|/*  __u8  ep_bInterval; 255 ms */
)brace
suffix:semicolon
multiline_comment|/* &n;For OHCI we need just the  2nd Byte, so we &n;don&squot;t need this constant byte-array &n;&n;static __u8 root_hub_hub_des[] =&n;{ &n;        0x00,       *  __u8  bLength; *&n;&t;&t;0x29,       *  __u8  bDescriptorType; Hub-descriptor *&n;        0x02,       *  __u8  bNbrPorts; *&n;        0x00,       * __u16  wHubCharacteristics; *&n;        0x00,&n;        0x01,       *  __u8  bPwrOn2pwrGood; 2ms * &n;        0x00,       *  __u8  bHubContrCurrent; 0 mA *&n;        0x00,       *  __u8  DeviceRemovable; *** 8 Ports max *** *&n;        0xff        *  __u8  PortPwrCtrlMask; *** 8 ports max *** *&n;};&n;*/
DECL|function|root_hub_control_msg
r_int
id|root_hub_control_msg
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
id|cmd_len
comma
r_void
op_star
id|rh_cmd
comma
r_void
op_star
id|rh_data
comma
r_int
id|leni
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
comma
id|f_handler
id|handler
)paren
(brace
id|__u32
id|stat
suffix:semicolon
id|__u32
id|rep_handler
suffix:semicolon
r_int
id|req_reply
op_assign
l_int|0
suffix:semicolon
r_union
id|ep_addr_
id|ep_addr
suffix:semicolon
r_union
id|ep_addr_
id|ep_addr_ret
suffix:semicolon
id|__u8
op_star
id|cmd
op_assign
id|rh_cmd
suffix:semicolon
id|__u8
op_star
id|data
op_assign
id|rh_data
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
id|leni
suffix:semicolon
id|__u8
id|bmRequestType
op_assign
id|cmd
(braket
l_int|0
)braket
suffix:semicolon
id|__u8
id|bRequest
op_assign
id|cmd
(braket
l_int|1
)braket
suffix:semicolon
id|__u16
id|wValue
op_assign
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|8
op_or
id|cmd
(braket
l_int|2
)braket
suffix:semicolon
id|__u16
id|wIndex
op_assign
id|cmd
(braket
l_int|5
)braket
op_lshift
l_int|8
op_or
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|__u16
id|wLength
op_assign
id|cmd
(braket
l_int|7
)braket
op_lshift
l_int|8
op_or
id|cmd
(braket
l_int|6
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB root hub: adr: %8x cmd(%8x): &quot;
comma
id|ohci-&gt;root_hub_funct_addr
comma
l_int|8
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%2x&quot;
comma
(paren
(paren
r_char
op_star
)paren
id|rh_cmd
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; ; &bslash;n&quot;
)paren
suffix:semicolon
id|ep_addr_ret.iep
op_assign
l_int|0
suffix:semicolon
id|ep_addr_ret.bep.fa
op_assign
id|ohci-&gt;root_hub_funct_addr
suffix:semicolon
id|ep_addr_ret.bep.ep
op_assign
(paren
id|bmRequestType
op_amp
l_int|0x80
)paren
op_or
l_int|0x40
suffix:semicolon
r_switch
c_cond
(paren
id|bmRequestType
op_or
id|bRequest
op_lshift
l_int|8
)paren
(brace
multiline_comment|/* Request Destination:&n;      without flags: Device, &n;      RH_INTERFACE: interface, &n;      RH_ENDPOINT: endpoint,&n;      RH_CLASS means HUB here, &n;      RH_OTHER | RH_CLASS  almost ever means HUB_PORT here &n;   */
r_case
id|RH_GET_STATUS
suffix:colon
id|len
op_assign
l_int|2
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_INTERFACE
suffix:colon
id|len
op_assign
l_int|2
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_ENDPOINT
suffix:colon
id|len
op_assign
l_int|2
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_CLASS
suffix:colon
multiline_comment|/* HUB_STATUS */
id|stat
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
op_amp
l_int|0x7fff7fff
suffix:semicolon
multiline_comment|/* bit 31 u. 15 has other meaning */
id|data
(braket
l_int|0
)braket
op_assign
id|stat
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|stat
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|stat
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
(paren
id|stat
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
id|len
op_assign
l_int|4
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
multiline_comment|/* PORT_STATUS */
id|stat
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|stat
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|stat
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|stat
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
(paren
id|stat
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
id|len
op_assign
l_int|4
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rh: stat %4x wIndex %4x;&bslash;n&quot;
comma
id|stat
comma
id|wIndex
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_DEVICE_REMOTE_WAKEUP
)paren
suffix:colon
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_ENDPOINT
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_ENDPOINT_STALL
)paren
suffix:colon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
multiline_comment|/*     case (RH_C_HUB_LOCAL_POWER):  OHCI says: no switching of this one */
r_case
(paren
id|RH_C_HUB_OVER_CURRENT
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_OCIC
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_CCS
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_POCI
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_LSDA
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_C_PORT_CONNECTION
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_CSC
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_C_PORT_ENABLE
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_PESC
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_C_PORT_SUSPEND
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_PSSC
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_C_PORT_OVER_CURRENT
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_OCIC
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_C_PORT_RESET
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_PRSC
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;       case (RH_PORT_CONNECTION):&n;       case (RH_PORT_OVER_CURRENT):&n;       case (RH_PORT_RESET):&n;       case (RH_PORT_LOW_SPEED):&n;       */
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_DEVICE_REMOTE_WAKEUP
)paren
suffix:colon
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_ENDPOINT
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_ENDPOINT_STALL
)paren
suffix:colon
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
multiline_comment|/* case (RH_C_HUB_LOCAL_POWER): Root Hub has no local Power &n;       case (RH_C_HUB_OVER_CURRENT): */
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_PSS
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_PORT_RESET
)paren
suffix:colon
r_if
c_cond
(paren
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* BUG IN HUP CODE *********/
id|writel
c_func
(paren
id|RH_PS_PRS
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_PPS
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
id|writel
c_func
(paren
id|RH_PS_PES
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|wIndex
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;       case (RH_PORT_CONNECTION):&n;       case (RH_PORT_OVER_CURRENT):&n;       case (RH_PORT_LOW_SPEED):&n;       case (RH_C_PORT_CONNECTION):&n;       case (RH_C_PORT_ENABLE):&n;       case (RH_C_PORT_SUSPEND):&n;       case (RH_C_PORT_OVER_CURRENT):&n;       case (RH_C_PORT_RESET):&n;       */
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_ADDRESS
suffix:colon
id|ohci-&gt;root_hub_funct_addr
op_assign
id|wValue
suffix:semicolon
multiline_comment|/* ohci-&gt;ed_func_ep0[wValue] = &amp;ohci-&gt;ed_rh_ep0;&n;&t; ohci-&gt;ed_func_ep0[wValue]-&gt;ep_addr.bep.fa = wValue; &n;&t; ohci-&gt;ed_func_ep0[wValue]-&gt;ed_list = &amp;ohci-&gt;ed_rh_epi; */
id|ohci-&gt;ed_rh_epi.ed_list
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_rh_epi.ep_addr.bep.fa
op_assign
id|wValue
suffix:semicolon
id|ohci-&gt;ed_rh_epi.ep_addr.bep.ep
op_assign
l_int|0xa1
suffix:semicolon
multiline_comment|/* Int in port 1 */
id|ohci-&gt;ed_func_ep0
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
suffix:colon
r_switch
c_cond
(paren
(paren
id|wValue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
(brace
r_case
(paren
l_int|0x01
)paren
suffix:colon
multiline_comment|/* device descriptor */
id|len
op_assign
id|min
c_func
(paren
r_sizeof
(paren
id|root_hub_dev_des
)paren
comma
id|wLength
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|root_hub_dev_des
comma
id|len
)paren
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x02
)paren
suffix:colon
multiline_comment|/* configuration descriptor */
id|len
op_assign
id|min
c_func
(paren
r_sizeof
(paren
id|root_hub_config_des
)paren
comma
id|wLength
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|root_hub_config_des
comma
id|len
)paren
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x03
)paren
suffix:colon
multiline_comment|/* string descriptors */
r_default
suffix:colon
(brace
)brace
)brace
r_break
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
op_or
id|RH_CLASS
suffix:colon
id|data
(braket
l_int|1
)braket
op_assign
l_int|0x29
suffix:semicolon
id|stat
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|stat
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* number of ports */
id|data
(braket
l_int|0
)braket
op_assign
(paren
id|data
(braket
l_int|2
)braket
op_div
l_int|8
)paren
op_star
l_int|2
op_plus
l_int|9
suffix:semicolon
multiline_comment|/* length of descriptor */
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
OG
id|wLength
)paren
(brace
id|req_reply
op_assign
id|RH_REQ_ERR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|data
(braket
l_int|3
)braket
op_assign
(paren
id|stat
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
(paren
id|stat
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
(paren
id|stat
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Root Hub needs no current from bus */
id|stat
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.b
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
(braket
l_int|2
)braket
op_le
l_int|8
)paren
(brace
multiline_comment|/* less than 8 Ports */
id|data
(braket
l_int|7
)braket
op_assign
id|stat
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|8
)braket
op_assign
(paren
id|stat
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* 0xff for USB Rev. 1.1 ?, stat &gt;&gt; 16 for USB Rev. 1.0 */
)brace
r_else
(brace
id|data
(braket
l_int|7
)braket
op_assign
id|stat
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|8
)braket
op_assign
(paren
id|stat
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|9
)braket
op_assign
(paren
id|stat
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* 0xff for USB Rev. 1.1?, stat &gt;&gt; 16 for USB Rev. 1.0 */
id|data
(braket
l_int|10
)braket
op_assign
(paren
id|stat
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* 0xff for USB Rev. 1.1?, stat &gt;&gt; 24 for USB Rev. 1.0 */
)brace
id|len
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RH_SET_DESCRIPTOR
suffix:colon
r_break
suffix:semicolon
r_case
id|RH_GET_CONFIGURATION
suffix:colon
id|len
op_assign
l_int|1
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RH_SET_CONFIGURATION
suffix:colon
multiline_comment|/* start it up */
id|writel
c_func
(paren
l_int|0x10000
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
suffix:semicolon
multiline_comment|/*writel( OHCI_INTR_RHSC, &amp;ohci-&gt;regs-&gt;intrenable);*/
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*  Optional or meaningless requests &n;     case RH_GET_STATE | RH_OTHER | RH_CLASS:&n;     case RH_GET_INTERFACE | RH_INTERFACE:&n;     case RH_SET_INTERFACE | RH_INTERFACE:&n;     case RH_SYNC_FRAME | RH_ENDPOINT: &n;   */
multiline_comment|/* Vendor Requests, we are the vendor!&n;&t;Will the USB-Consortium give us a Vendor Id&n;&t;for a virtual hub-device :-) ?&n;     We could use these requests for configuration purposes on the HCD Driver, not used in the altenate usb !*/
r_case
id|RH_SET_FEATURE
op_or
id|RH_VENDOR
suffix:colon
multiline_comment|/* remove all endpoints of device wIndex = Dev &lt;&lt; 8  */
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|RH_REMOVE_EP
suffix:colon
id|ep_addr.iep
op_assign
l_int|0
suffix:semicolon
id|ep_addr.bep.ep
op_assign
id|wIndex
op_amp
l_int|0xff
suffix:semicolon
id|ep_addr.bep.fa
op_assign
(paren
id|wIndex
op_lshift
l_int|8
)paren
op_amp
l_int|0xff00
suffix:semicolon
id|usb_ohci_rm_function
c_func
(paren
id|ohci
comma
id|ep_addr.iep
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_ENDPOINT
op_or
id|RH_VENDOR
suffix:colon
multiline_comment|/* remove endpoint wIndex = Dev &lt;&lt; 8 | EP */
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|RH_REMOVE_EP
suffix:colon
id|ep_addr.iep
op_assign
l_int|0
suffix:semicolon
id|ep_addr.bep.ep
op_assign
id|wIndex
op_amp
l_int|0xff
suffix:semicolon
id|ep_addr.bep.fa
op_assign
(paren
id|wIndex
op_lshift
l_int|8
)paren
op_amp
l_int|0xff00
suffix:semicolon
id|usb_ohci_rm_ep
c_func
(paren
id|ohci
comma
id|ohci_find_ep
c_func
(paren
id|ohci
comma
id|ep_addr.iep
)paren
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_EP
op_or
id|RH_ENDPOINT
op_or
id|RH_VENDOR
suffix:colon
id|ep_addr.bep.ep
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|ep_addr.bep.fa
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|ep_addr.bep.hc
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|ep_addr.bep.host
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|rep_handler
op_assign
id|data
(braket
l_int|7
)braket
op_lshift
l_int|24
op_or
id|data
(braket
l_int|6
)braket
op_lshift
l_int|16
op_or
id|data
(braket
l_int|5
)braket
op_lshift
l_int|8
op_or
id|data
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/*  struct usb_ohci_ed *usb_ohci_add_ep(union ep_addr_ ep_addr,&n;&t;struct ohci * ohci, int interval, int load, int (*handler)(int, void*), int ep_size, int speed) */
id|usb_ohci_add_ep
c_func
(paren
id|ohci
comma
id|ep_addr.iep
comma
id|data
(braket
l_int|8
)braket
comma
id|data
(braket
l_int|9
)braket
comma
(paren
id|f_handler
)paren
id|rep_handler
comma
id|data
(braket
l_int|11
)braket
op_lshift
l_int|8
op_or
id|data
(braket
l_int|10
)braket
comma
id|data
(braket
l_int|12
)braket
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|req_reply
op_assign
id|RH_ACK
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstat1: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|0
)braket
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstat2: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|1
)braket
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* if (req_reply == RH_ACK) len; */
id|queue_reply
c_func
(paren
id|ohci
comma
id|ep_addr_ret.iep
comma
l_int|8
comma
id|rh_cmd
comma
id|data
comma
id|len
comma
id|lw0
comma
id|lw1
comma
id|handler
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|root_hub_int_req
r_int
(def_block
id|root_hub_int_req
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
id|cmd_len
comma
r_void
op_star
id|ctrl
comma
r_void
op_star
id|data
comma
r_int
id|data_len
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
comma
id|f_handler
id|handler
)paren
(brace
r_struct
id|ohci_rep_td
op_star
id|td
suffix:semicolon
r_struct
id|ohci_rep_td
op_star
id|tmp
suffix:semicolon
r_union
id|ep_addr_
id|ep_addr
suffix:semicolon
id|td
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|td
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|tmp
op_assign
id|ohci-&gt;td_rh_epi
suffix:semicolon
id|td-&gt;next_td
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* queue td */
id|ohci-&gt;td_rh_epi
op_assign
id|td
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|tmp-&gt;next_td
op_ne
l_int|NULL
)paren
(brace
id|tmp
op_assign
id|tmp-&gt;next_td
suffix:semicolon
)brace
id|tmp-&gt;next_td
op_assign
id|td
suffix:semicolon
)brace
id|ep_addr.iep
op_assign
l_int|0
suffix:semicolon
id|ep_addr.bep.fa
op_assign
id|ohci-&gt;root_hub_funct_addr
suffix:semicolon
id|ep_addr.bep.ep
op_assign
l_int|0xA1
suffix:semicolon
multiline_comment|/* INT IN EP endpoint 1 */
id|td-&gt;cmd_len
op_assign
l_int|0
suffix:semicolon
id|td-&gt;cmd
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;data
op_assign
id|data
suffix:semicolon
id|td-&gt;data_len
op_assign
id|data_len
suffix:semicolon
id|td-&gt;handler
op_assign
id|handler
suffix:semicolon
id|td-&gt;next_td
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;ep_addr
op_assign
id|ep_addr.iep
suffix:semicolon
id|td-&gt;lw0
op_assign
id|lw0
suffix:semicolon
id|td-&gt;lw1
op_assign
id|lw1
suffix:semicolon
id|ohci_init_rh_int_timer
c_func
(paren
id|ohci
comma
l_int|255
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)def_block
multiline_comment|/* prepare Interrupt pipe transaction data; HUP INTERRUPT ENDPOINT */
DECL|function|root_hub_send_irq
r_int
id|root_hub_send_irq
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_void
op_star
id|rh_data
comma
r_int
id|rh_len
)paren
(brace
r_int
id|num_ports
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|len
suffix:semicolon
id|__u8
op_star
id|data
op_assign
id|rh_data
suffix:semicolon
id|num_ports
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_amp
l_int|0xff
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
op_amp
l_int|0x00030000
)paren
OG
l_int|0
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|ret
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
(braket
id|i
op_div
l_int|8
)braket
op_or_assign
(paren
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|i
)braket
)paren
op_amp
l_int|0x001f0000
)paren
OG
l_int|0
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_lshift
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|8
)paren
suffix:semicolon
id|ret
op_add_assign
id|data
(braket
id|i
op_div
l_int|8
)braket
suffix:semicolon
)brace
id|len
op_assign
id|i
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
r_return
id|len
suffix:semicolon
r_return
id|RH_NACK
suffix:semicolon
)brace
DECL|variable|rh_int_timer
r_static
r_struct
id|timer_list
id|rh_int_timer
suffix:semicolon
multiline_comment|/* Virtual Root Hub INTs are polled by this timer every &quot;intervall&quot; ms */
DECL|function|rh_int_timer_do
r_static
r_void
id|rh_int_timer_do
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
id|len
suffix:semicolon
r_int
id|interval
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ohci
op_star
)paren
id|ptr
suffix:semicolon
r_struct
id|ohci_rep_td
op_star
id|td
op_assign
id|ohci-&gt;td_rh_epi
suffix:semicolon
r_if
c_cond
(paren
id|td
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* if ther is a TD handle the INT request */
id|len
op_assign
id|root_hub_send_irq
c_func
(paren
id|ohci
comma
id|td-&gt;data
comma
id|td-&gt;data_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|ohci-&gt;td_rh_epi
op_assign
id|td-&gt;next_td
suffix:semicolon
id|td-&gt;next_td
op_assign
id|ohci-&gt;repl_queue
suffix:semicolon
id|ohci-&gt;repl_queue
op_assign
id|td
suffix:semicolon
id|send_replies
c_func
(paren
id|ohci
)paren
suffix:semicolon
)brace
)brace
id|interval
op_assign
id|ohci-&gt;rh_int_interval
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|rh_int_timer
)paren
suffix:semicolon
id|rh_int_timer.function
op_assign
id|rh_int_timer_do
suffix:semicolon
id|rh_int_timer.data
op_assign
(paren
r_int
r_int
)paren
id|ohci
suffix:semicolon
id|rh_int_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
(paren
id|interval
OL
l_int|30
ques
c_cond
l_int|30
suffix:colon
id|interval
)paren
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|rh_int_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Root Hub INTs are polled by this timer */
DECL|function|ohci_init_rh_int_timer
r_int
id|ohci_init_rh_int_timer
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
id|interval
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ohci-&gt;rh_int_timer
)paren
)paren
(brace
id|ohci-&gt;rh_int_timer
op_assign
l_int|1
suffix:semicolon
id|ohci-&gt;rh_int_interval
op_assign
id|interval
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|rh_int_timer
)paren
suffix:semicolon
id|rh_int_timer.function
op_assign
id|rh_int_timer_do
suffix:semicolon
id|rh_int_timer.data
op_assign
(paren
r_int
r_int
)paren
id|ohci
suffix:semicolon
id|rh_int_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
(paren
id|interval
OL
l_int|30
ques
c_cond
l_int|30
suffix:colon
id|interval
)paren
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|rh_int_timer
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_del_rh_int_timer
r_int
id|ohci_del_rh_int_timer
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|rh_int_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* for root hub replies, queue the reply, (it will be sent immediately now) */
DECL|function|queue_reply
r_int
id|queue_reply
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
r_int
id|ep_addr
comma
r_int
id|cmd_len
comma
r_void
op_star
id|cmd
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
comma
id|f_handler
id|handler
)paren
(brace
r_struct
id|ohci_rep_td
op_star
id|td
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;queue_reply ep: %x len: %x&bslash;n&quot;
comma
id|ep_addr
comma
id|len
)paren
suffix:semicolon
id|td
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|td
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|status
op_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
id|td-&gt;cmd_len
op_assign
id|cmd_len
suffix:semicolon
id|td-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|td-&gt;data
op_assign
id|data
suffix:semicolon
id|td-&gt;data_len
op_assign
id|len
suffix:semicolon
id|td-&gt;handler
op_assign
id|handler
suffix:semicolon
id|td-&gt;next_td
op_assign
id|ohci-&gt;repl_queue
suffix:semicolon
id|ohci-&gt;repl_queue
op_assign
id|td
suffix:semicolon
id|td-&gt;ep_addr
op_assign
id|ep_addr
suffix:semicolon
id|td-&gt;lw0
op_assign
id|lw0
suffix:semicolon
id|td-&gt;lw1
op_assign
id|lw1
suffix:semicolon
id|td-&gt;status
op_assign
id|status
suffix:semicolon
id|send_replies
c_func
(paren
id|ohci
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* for root hub replies; send the reply */
DECL|function|send_replies
r_int
id|send_replies
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
r_struct
id|ohci_rep_td
op_star
id|td
suffix:semicolon
r_struct
id|ohci_rep_td
op_star
id|tmp
suffix:semicolon
id|td
op_assign
id|ohci-&gt;repl_queue
suffix:semicolon
id|ohci-&gt;repl_queue
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|td
op_ne
l_int|NULL
)paren
(brace
id|td
op_member_access_from_pointer
id|handler
c_func
(paren
(paren
r_void
op_star
)paren
id|ohci
comma
id|td-&gt;ep_addr
comma
id|td-&gt;cmd_len
comma
id|td-&gt;cmd
comma
id|td-&gt;data
comma
id|td-&gt;data_len
comma
id|td-&gt;status
comma
id|td-&gt;lw0
comma
id|td-&gt;lw1
)paren
suffix:semicolon
id|tmp
op_assign
id|td
suffix:semicolon
id|td
op_assign
id|td-&gt;next_td
suffix:semicolon
id|kfree
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
eof
