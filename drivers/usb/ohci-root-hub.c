multiline_comment|/*&n; * HCD (OHCI) Virtual Root Hub for USB.&n; *&n; * (C) Copyright 1999 Roman Weissgaerber (weissg@vienna.at)&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * &n; * The Root Hub is build into the HC (UHCI or OHCI) hardware. &n; * This piece of code lets it look like it resides on the usb&n; * like the other hubs.&n; * (for anyone who wants to do a control operation on the root hub)&n; * &n; * v4.0 1999/08/18 &n; * v2.1 1999/05/09 &n; * v2.0 1999/05/04&n; * v1.0 1999/04/27&n; * ohci-root-hub.c&n; *  &n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;ohci-hcd.h&quot; 
macro_line|#ifdef VROOTHUB 
macro_line|#include &quot;ohci-root-hub.h&quot;
DECL|variable|root_hub_dev_des
r_static
id|__u8
id|root_hub_dev_des
(braket
)braket
op_assign
(brace
l_int|0x12
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x01
comma
multiline_comment|/*  __u8  bDescriptorType; Device */
l_int|0x00
comma
multiline_comment|/*  __u16 bcdUSB; v1.0 */
l_int|0x01
comma
l_int|0x09
comma
multiline_comment|/*  __u8  bDeviceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceProtocol; */
l_int|0x08
comma
multiline_comment|/*  __u8  bMaxPacketSize0; 8 Bytes */
l_int|0x00
comma
multiline_comment|/*  __u16 idVendor; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 idProduct; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 bcdDevice; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u8  iManufacturer; */
l_int|0x00
comma
multiline_comment|/*  __u8  iProduct; */
l_int|0x00
comma
multiline_comment|/*  __u8  iSerialNumber; */
l_int|0x01
multiline_comment|/*  __u8  bNumConfigurations; */
)brace
suffix:semicolon
multiline_comment|/* Configuration descriptor */
DECL|variable|root_hub_config_des
r_static
id|__u8
id|root_hub_config_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x02
comma
multiline_comment|/*  __u8  bDescriptorType; Configuration */
l_int|0x19
comma
multiline_comment|/*  __u16 wTotalLength; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bNumInterfaces; */
l_int|0x01
comma
multiline_comment|/*  __u8  bConfigurationValue; */
l_int|0x00
comma
multiline_comment|/*  __u8  iConfiguration; */
l_int|0x40
comma
multiline_comment|/*  __u8  bmAttributes; &n;                 Bit 7: Bus-powered, 6: Self-powered, 5 Remote-wakwup, 4..0: resvd */
l_int|0x00
comma
multiline_comment|/*  __u8  MaxPower; */
multiline_comment|/* interface */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bLength; */
l_int|0x04
comma
multiline_comment|/*  __u8  if_bDescriptorType; Interface */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceNumber; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bAlternateSetting; */
l_int|0x01
comma
multiline_comment|/*  __u8  if_bNumEndpoints; */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bInterfaceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceProtocol; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_iInterface; */
multiline_comment|/* endpoint */
l_int|0x07
comma
multiline_comment|/*  __u8  ep_bLength; */
l_int|0x05
comma
multiline_comment|/*  __u8  ep_bDescriptorType; Endpoint */
l_int|0x81
comma
multiline_comment|/*  __u8  ep_bEndpointAddress; IN Endpoint 1 */
l_int|0x03
comma
multiline_comment|/*  __u8  ep_bmAttributes; Interrupt */
l_int|0x08
comma
multiline_comment|/*  __u16 ep_wMaxPacketSize; 8 Bytes */
l_int|0x00
comma
l_int|0xff
multiline_comment|/*  __u8  ep_bInterval; 255 ms */
)brace
suffix:semicolon
multiline_comment|/* &n;For OHCI we need just the  2nd Byte, so we &n;don&squot;t need this constant byte-array &n;&n;static __u8 root_hub_hub_des[] =&n;{ &n;        0x00,       *  __u8  bLength; *&n;&t;&t;0x29,       *  __u8  bDescriptorType; Hub-descriptor *&n;        0x02,       *  __u8  bNbrPorts; *&n;        0x00,       * __u16  wHubCharacteristics; *&n;        0x00,&n;        0x01,       *  __u8  bPwrOn2pwrGood; 2ms * &n;        0x00,       *  __u8  bHubContrCurrent; 0 mA *&n;        0x00,       *  __u8  DeviceRemovable; *** 8 Ports max *** *&n;        0xff        *  __u8  PortPwrCtrlMask; *** 8 ports max *** *&n;};&n;*/
DECL|macro|OK
mdefine_line|#define OK(x) &t;&t;&t;len = (x); req_reply = 0; break
DECL|macro|WR_RH_STAT
mdefine_line|#define WR_RH_STAT(x) &t;&t;writel((x), &amp;ohci-&gt;regs-&gt;roothub.status)
DECL|macro|WR_RH_PORTSTAT
mdefine_line|#define WR_RH_PORTSTAT(x) &t;writel((x), &amp;ohci-&gt;regs-&gt;roothub.portstatus[wIndex-1])
DECL|macro|RD_RH_STAT
mdefine_line|#define RD_RH_STAT&t;&t;&t;readl(&amp;ohci-&gt;regs-&gt;roothub.status)
DECL|macro|RD_RH_PORTSTAT
mdefine_line|#define RD_RH_PORTSTAT&t;&t;readl(&amp;ohci-&gt;regs-&gt;roothub.portstatus[wIndex-1])
DECL|function|root_hub_control_msg
r_int
id|root_hub_control_msg
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
id|devrequest
op_star
id|cmd
comma
r_void
op_star
id|data
comma
r_int
id|leni
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|__u8
id|data_buf
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|req_reply
op_assign
l_int|4
suffix:semicolon
r_int
id|len
op_assign
id|leni
suffix:semicolon
id|__u16
id|bmRType_bReq
op_assign
id|cmd-&gt;requesttype
op_or
(paren
id|cmd-&gt;request
op_lshift
l_int|8
)paren
suffix:semicolon
id|__u16
id|wValue
op_assign
id|cpu_to_le16
c_func
(paren
id|cmd-&gt;value
)paren
suffix:semicolon
id|__u16
id|wIndex
op_assign
id|cpu_to_le16
c_func
(paren
id|cmd-&gt;index
)paren
suffix:semicolon
id|__u16
id|wLength
op_assign
id|cpu_to_le16
c_func
(paren
id|cmd-&gt;length
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB root hub: adr: %2x cmd(%1x): &quot;
comma
id|ohci-&gt;rh.devnum
comma
l_int|8
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
(brace
r_int
id|i
suffix:semicolon
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|cmd
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; ; &bslash;n&quot;
)paren
suffix:semicolon
)paren
r_switch
c_cond
(paren
id|bmRType_bReq
)paren
(brace
multiline_comment|/* Request Destination:&n;&t;   without flags: Device, &n;&t;   RH_INTERFACE: interface, &n;&t;   RH_ENDPOINT: endpoint,&n;&t;   RH_CLASS means HUB here, &n;&t;   RH_OTHER | RH_CLASS  almost ever means HUB_PORT here &n;&t;*/
r_case
id|RH_GET_STATUS
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_INTERFACE
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_ENDPOINT
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u32
op_star
)paren
id|data
op_assign
id|cpu_to_le32
c_func
(paren
id|RD_RH_STAT
op_amp
l_int|0x7fff7fff
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u32
op_star
)paren
id|data
op_assign
id|cpu_to_le32
c_func
(paren
id|RD_RH_PORTSTAT
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_ENDPOINT
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_ENDPOINT_STALL
)paren
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_C_HUB_OVER_CURRENT
)paren
suffix:colon
id|WR_RH_STAT
c_func
(paren
id|RH_PS_OCIC
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_CCS
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_POCI
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_LSDA
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_CONNECTION
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_CSC
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_ENABLE
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_PESC
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_SUSPEND
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_PSSC
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_OVER_CURRENT
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_OCIC
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_RESET
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_PRSC
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_PSS
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_RESET
)paren
suffix:colon
r_if
c_cond
(paren
(paren
id|RD_RH_PORTSTAT
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_PRS
)paren
suffix:semicolon
)brace
multiline_comment|/* BUG IN HUP CODE *********/
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_PPS
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
id|WR_RH_PORTSTAT
c_func
(paren
id|RH_PS_PES
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_ADDRESS
suffix:colon
id|ohci-&gt;rh.devnum
op_assign
id|wValue
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
suffix:colon
r_switch
c_cond
(paren
(paren
id|wValue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
(brace
r_case
(paren
l_int|0x01
)paren
suffix:colon
multiline_comment|/* device descriptor */
id|len
op_assign
id|min
c_func
(paren
id|leni
comma
id|min
c_func
(paren
r_sizeof
(paren
id|root_hub_dev_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|root_hub_dev_des
comma
id|len
)paren
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x02
)paren
suffix:colon
multiline_comment|/* configuration descriptor */
id|len
op_assign
id|min
c_func
(paren
id|leni
comma
id|min
c_func
(paren
r_sizeof
(paren
id|root_hub_config_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|root_hub_config_des
comma
id|len
)paren
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x03
)paren
suffix:colon
multiline_comment|/* string descriptors */
r_default
suffix:colon
id|OK
c_func
(paren
op_minus
l_int|4
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data_buf
op_plus
l_int|1
)paren
op_assign
l_int|0x29
suffix:semicolon
op_star
(paren
id|__u32
op_star
)paren
(paren
id|data_buf
op_plus
l_int|2
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
)paren
suffix:semicolon
op_star
(paren
id|__u8
op_star
)paren
id|data_buf
op_assign
(paren
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data_buf
op_plus
l_int|2
)paren
op_div
l_int|8
)paren
op_star
l_int|2
op_plus
l_int|9
suffix:semicolon
multiline_comment|/* length of descriptor */
id|len
op_assign
id|min
c_func
(paren
id|leni
comma
id|min
c_func
(paren
op_star
(paren
id|__u8
op_star
)paren
id|data_buf
comma
id|wLength
)paren
)paren
suffix:semicolon
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data_buf
op_plus
l_int|6
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Root Hub needs no current from bus */
r_if
c_cond
(paren
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data_buf
op_plus
l_int|2
)paren
OL
l_int|8
)paren
(brace
multiline_comment|/* less than 8 Ports */
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data_buf
op_plus
l_int|7
)paren
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.b
)paren
op_amp
l_int|0xff
suffix:semicolon
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data_buf
op_plus
l_int|8
)paren
op_assign
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.b
)paren
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
op_star
(paren
id|__u32
op_star
)paren
(paren
id|data_buf
op_plus
l_int|7
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.b
)paren
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|data
comma
id|data_buf
comma
id|len
)paren
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
id|RH_GET_CONFIGURATION
suffix:colon
op_star
(paren
id|__u8
op_star
)paren
id|data
op_assign
l_int|0x01
suffix:semicolon
id|OK
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|RH_SET_CONFIGURATION
suffix:colon
id|WR_RH_STAT
c_func
(paren
l_int|0x10000
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|OK
c_func
(paren
op_minus
l_int|4
)paren
suffix:semicolon
)brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstat1: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|0
)braket
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstat2: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|1
)braket
)paren
)paren
)paren
suffix:semicolon
)paren
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* prepare Interrupt pipe transaction data; HUB INTERRUPT ENDPOINT */
DECL|function|root_hub_send_irq
r_static
r_int
id|root_hub_send_irq
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_void
op_star
id|rh_data
comma
r_int
id|rh_len
)paren
(brace
r_int
id|num_ports
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|len
suffix:semicolon
id|__u8
op_star
id|data
op_assign
id|rh_data
suffix:semicolon
id|num_ports
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_amp
l_int|0xff
suffix:semicolon
op_star
(paren
id|__u8
op_star
)paren
id|data
op_assign
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
op_amp
l_int|0x00030000
)paren
OG
l_int|0
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|ret
op_assign
op_star
(paren
id|__u8
op_star
)paren
id|data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data
op_plus
id|i
op_div
l_int|8
)paren
op_or_assign
(paren
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|i
)braket
)paren
op_amp
l_int|0x001f0000
)paren
OG
l_int|0
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_lshift
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|8
)paren
suffix:semicolon
id|ret
op_add_assign
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data
op_plus
id|i
op_div
l_int|8
)paren
suffix:semicolon
)brace
id|len
op_assign
id|i
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
r_return
id|len
suffix:semicolon
r_return
id|RH_NACK
suffix:semicolon
)brace
r_static
r_int
id|ohci_init_rh_int_timer
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
id|interval
)paren
suffix:semicolon
multiline_comment|/* Virtual Root Hub INTs are polled by this timer every &quot;intervall&quot; ms */
DECL|function|rh_int_timer_do
r_static
r_void
id|rh_int_timer_do
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
id|len
suffix:semicolon
r_int
id|interval
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_struct
id|usb_device
op_star
id|usb_dev
op_assign
(paren
r_struct
id|usb_device
op_star
)paren
id|ptr
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
op_assign
id|usb_to_ohci
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;rh.send
)paren
(brace
id|len
op_assign
id|root_hub_send_irq
c_func
(paren
id|ohci
comma
id|dev-&gt;data
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|ret
op_assign
id|ohci-&gt;rh
dot
id|handler
c_func
(paren
l_int|0
comma
id|dev-&gt;data
comma
id|len
comma
id|ohci-&gt;rh.dev_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_le
l_int|0
)paren
(brace
id|ohci-&gt;rh.send
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* 0 .. do not requeue  */
)brace
)brace
id|interval
op_assign
id|ohci-&gt;rh.interval
suffix:semicolon
id|ohci_init_rh_int_timer
c_func
(paren
id|usb_dev
comma
id|interval
)paren
suffix:semicolon
)brace
multiline_comment|/* Root Hub INTs are polled by this timer */
DECL|function|ohci_init_rh_int_timer
r_static
r_int
id|ohci_init_rh_int_timer
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
id|interval
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|ohci-&gt;rh.interval
op_assign
id|interval
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|ohci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
id|ohci-&gt;rh.rh_int_timer.function
op_assign
id|rh_int_timer_do
suffix:semicolon
id|ohci-&gt;rh.rh_int_timer.data
op_assign
(paren
r_int
r_int
)paren
id|usb_dev
suffix:semicolon
id|ohci-&gt;rh.rh_int_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
(paren
id|interval
OL
l_int|30
ques
c_cond
l_int|30
suffix:colon
id|interval
)paren
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|ohci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_del_rh_int_timer
r_static
r_int
id|ohci_del_rh_int_timer
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|ohci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|root_hub_request_irq
r_int
id|root_hub_request_irq
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
id|usb_device_irq
id|handler
comma
r_int
id|period
comma
r_void
op_star
id|dev_id
comma
r_void
op_star
op_star
id|handle
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC-RH IRQ&gt;&gt;&gt;: RH every %d ms&bslash;n&quot;
comma
id|period
)paren
suffix:semicolon
)paren
id|ohci-&gt;rh.handler
op_assign
id|handler
suffix:semicolon
id|ohci-&gt;rh.dev_id
op_assign
id|dev_id
suffix:semicolon
id|ohci-&gt;rh.send
op_assign
l_int|1
suffix:semicolon
id|ohci-&gt;rh.interval
op_assign
id|period
suffix:semicolon
id|ohci_init_rh_int_timer
c_func
(paren
id|usb_dev
comma
id|period
)paren
suffix:semicolon
op_star
id|handle
op_assign
id|ohci-&gt;rh.int_addr
op_assign
id|usb_to_ohci
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|root_hub_release_irq
r_int
id|root_hub_release_irq
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_void
op_star
id|ed
)paren
(brace
singleline_comment|// struct usb_device *usb_dev = ((struct ohci_device *) ((unsigned int)ed &amp; 0xfffff000))-&gt;usb;
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC-RH RM_IRQ&gt;&gt;&gt;:&bslash;n&quot;
)paren
suffix:semicolon
)paren
id|ohci-&gt;rh.send
op_assign
l_int|0
suffix:semicolon
id|ohci_del_rh_int_timer
c_func
(paren
id|ohci
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
eof
