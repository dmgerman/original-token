multiline_comment|/*&n; * OHCI HCD (Host Controller Driver) for USB.&n; *&n; * (C) Copyright 1999 Roman Weissgaerber &lt;weissg@vienna.at&gt;&n; *&n; * The OHCI HCD layer is a simple but nearly complete implementation of what the&n; * USB people would call a HCD  for the OHCI. &n; * (ISO comming soon, Bulk disabled, INT u. CTRL transfers enabled)&n; * The layer on top of it, is for interfacing to the alternate-usb device-drivers.&n; * &n; * [ This is based on Linus&squot; UHCI code and gregs OHCI fragments (0.03c source tree). ]&n; * [ Open Host Controller Interface driver for USB. ]&n; * [ (C) Copyright 1999 Linus Torvalds (uhci.c) ]&n; * [ (C) Copyright 1999 Gregory P. Smith &lt;greg@electricrain.com&gt; ]&n; * [ $Log: ohci.c,v $ ]&n; * [ Revision 1.1  1999/04/05 08:32:30  greg ]&n; * &n; * &n; * v2.1 1999/05/09 ep_addr correction, code clean up&n; * v2.0 1999/05/04 &n; * virtual root hub is now an option, &n; * memory allocation based on kmalloc and kfree now, Bus error handling, &n; * INT and CTRL transfers enabled, Bulk included but disabled, ISO needs completion&n; * &n; * from Linus Torvalds (uhci.c) (APM not tested; hub, usb_device, bus and related stuff)&n; * from Greg Smith (ohci.c) (reset controller handling, hub)&n; * &n; * v1.0 1999/04/27 initial release&n; * ohci-hcd.c&n; */
multiline_comment|/* #define OHCI_DBG  */
multiline_comment|/* printk some debug information */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;ohci-hcd.h&quot;
macro_line|#include &quot;inits.h&quot; 
macro_line|#ifdef CONFIG_APM
macro_line|#include &lt;linux/apm_bios.h&gt;
r_static
r_int
id|handle_apm_event
c_func
(paren
id|apm_event_t
id|event
)paren
suffix:semicolon
DECL|variable|apm_resume
r_static
r_int
id|apm_resume
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|variable|control_wakeup
r_static
r_struct
id|wait_queue
op_star
id|control_wakeup
suffix:semicolon
DECL|variable|root_hub
r_static
r_struct
id|wait_queue
op_star
id|root_hub
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|cc_to_status
r_static
id|__u8
id|cc_to_status
(braket
l_int|16
)braket
op_assign
(brace
multiline_comment|/* mapping of the OHCI CC to the UHCI status codes; first guess */
multiline_comment|/* Activ, Stalled, Data Buffer Err, Babble Detected : NAK recvd, CRC/Timeout, Bitstuff, reservd */
multiline_comment|/* No  Error  */
l_int|0x00
comma
multiline_comment|/* CRC Error  */
l_int|0x04
comma
multiline_comment|/* Bit Stuff  */
l_int|0x02
comma
multiline_comment|/* Data Togg  */
l_int|0x40
comma
multiline_comment|/* Stall      */
l_int|0x40
comma
multiline_comment|/* DevNotResp */
l_int|0x04
comma
multiline_comment|/* PIDCheck   */
l_int|0x04
comma
multiline_comment|/* UnExpPID   */
l_int|0x40
comma
multiline_comment|/* DataOver   */
l_int|0x20
comma
multiline_comment|/* DataUnder  */
l_int|0x20
comma
multiline_comment|/* reservd    */
l_int|0x40
comma
multiline_comment|/* reservd    */
l_int|0x40
comma
multiline_comment|/* BufferOver */
l_int|0x20
comma
multiline_comment|/* BuffUnder  */
l_int|0x20
comma
multiline_comment|/* Not Access */
l_int|0x80
comma
multiline_comment|/* Not Access */
l_int|0x80
)brace
suffix:semicolon
multiline_comment|/********&n; **** Interface functions&n; ***********************************************/
DECL|function|sohci_int_handler
r_static
r_int
id|sohci_int_handler
c_func
(paren
r_void
op_star
id|ohci_in
comma
r_int
r_int
id|ep_addr
comma
r_int
id|ctrl_len
comma
r_void
op_star
id|ctrl
comma
r_void
op_star
id|data
comma
r_int
id|data_len
comma
r_int
id|status
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|ohci_in
suffix:semicolon
id|usb_device_irq
id|handler
op_assign
(paren
r_void
op_star
)paren
id|lw0
suffix:semicolon
r_void
op_star
id|dev_id
op_assign
(paren
r_void
op_star
)paren
id|lw1
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|OHCI_DEBUG
(paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC IRQ &lt;&lt;&lt;: %x: data(%d):&quot;
comma
id|ep_addr
comma
id|data_len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
(paren
id|printk
c_func
(paren
l_string|&quot; ret_status: %x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
)paren
id|ret
op_assign
id|handler
c_func
(paren
id|cc_to_status
(braket
id|status
op_amp
l_int|0xf
)braket
comma
id|data
comma
id|dev_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* 0 .. do not requeue  */
r_if
c_cond
(paren
id|status
OG
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* error occured do not requeue ? */
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ep_addr
comma
l_int|0
comma
l_int|NULL
comma
id|data
comma
l_int|8
comma
(paren
id|__OHCI_BAG
)paren
id|handler
comma
(paren
id|__OHCI_BAG
)paren
id|dev_id
)paren
suffix:semicolon
multiline_comment|/* requeue int request */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_ctrl_handler
r_static
r_int
id|sohci_ctrl_handler
c_func
(paren
r_void
op_star
id|ohci_in
comma
r_int
r_int
id|ep_addr
comma
r_int
id|ctrl_len
comma
r_void
op_star
id|ctrl
comma
r_void
op_star
id|data
comma
r_int
id|data_len
comma
r_int
id|status
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw
)paren
(brace
op_star
(paren
r_int
op_star
)paren
id|lw0
op_assign
id|status
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|control_wakeup
)paren
suffix:semicolon
id|OHCI_DEBUG
(paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC CTRL&lt;&lt;&lt;: %x: ctrl(%d):&quot;
comma
id|ep_addr
comma
id|ctrl_len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|ctrl
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; data(%d):&quot;
comma
id|data_len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
(paren
id|printk
c_func
(paren
l_string|&quot; ret_status: %x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
)paren
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_request_irq
r_static
r_int
id|sohci_request_irq
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
id|usb_device_irq
id|handler
comma
r_int
id|period
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_union
id|ep_addr_
id|ep_addr
suffix:semicolon
id|ep_addr.iep
op_assign
l_int|0
suffix:semicolon
id|ep_addr.bep.ep
op_assign
(paren
(paren
id|pipe
op_rshift
l_int|15
)paren
op_amp
l_int|0x0f
)paren
multiline_comment|/* endpoint address */
op_or
(paren
id|pipe
op_amp
l_int|0x80
)paren
multiline_comment|/* direction */
op_or
(paren
l_int|1
op_lshift
l_int|5
)paren
suffix:semicolon
multiline_comment|/* type = int*/
id|ep_addr.bep.fa
op_assign
(paren
(paren
id|pipe
op_rshift
l_int|8
)paren
op_amp
l_int|0x7f
)paren
suffix:semicolon
multiline_comment|/* device address */
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC IRQ &gt;&gt;&gt;: %x: every %d ms&bslash;n&quot;
comma
id|ep_addr.iep
comma
id|period
)paren
suffix:semicolon
)paren
id|usb_ohci_add_ep
c_func
(paren
id|ohci
comma
id|ep_addr.iep
comma
id|period
comma
l_int|1
comma
id|sohci_int_handler
comma
l_int|1
op_lshift
(paren
(paren
id|pipe
op_amp
l_int|0x03
)paren
op_plus
l_int|3
)paren
comma
(paren
id|pipe
op_rshift
l_int|26
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ep_addr.iep
comma
l_int|0
comma
l_int|NULL
comma
(paren
(paren
r_struct
id|ohci_device
op_star
)paren
id|usb_dev-&gt;hcpriv
)paren
op_member_access_from_pointer
id|data
comma
l_int|8
comma
(paren
id|__OHCI_BAG
)paren
id|handler
comma
(paren
id|__OHCI_BAG
)paren
id|dev_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_control_msg
r_static
r_int
id|sohci_control_msg
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
r_void
op_star
id|cmd
comma
r_void
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_struct
id|wait_queue
id|wait
op_assign
(brace
id|current
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
id|status
suffix:semicolon
r_union
id|ep_addr_
id|ep_addr
suffix:semicolon
id|ep_addr.iep
op_assign
l_int|0
suffix:semicolon
id|ep_addr.bep.ep
op_assign
(paren
(paren
id|pipe
op_rshift
l_int|15
)paren
op_amp
l_int|0x0f
)paren
multiline_comment|/* endpoint address */
op_or
(paren
id|pipe
op_amp
l_int|0x80
)paren
multiline_comment|/* direction */
op_or
(paren
l_int|1
op_lshift
l_int|6
)paren
suffix:semicolon
multiline_comment|/* type = ctrl*/
id|ep_addr.bep.fa
op_assign
(paren
(paren
id|pipe
op_rshift
l_int|8
)paren
op_amp
l_int|0x7f
)paren
suffix:semicolon
multiline_comment|/* device address */
id|status
op_assign
l_int|0xf
suffix:semicolon
multiline_comment|/* CC not Accessed */
id|OHCI_DEBUG
(paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC CTRL&gt;&gt;&gt;: %x: ctrl(%d):&quot;
comma
id|ep_addr.iep
comma
l_int|8
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|cmd
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; data(%d):&quot;
comma
id|len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
(paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)paren
id|usb_ohci_add_ep
c_func
(paren
id|ohci
comma
id|ep_addr.iep
comma
l_int|0
comma
l_int|1
comma
id|sohci_ctrl_handler
comma
l_int|1
op_lshift
(paren
(paren
id|pipe
op_amp
l_int|0x03
)paren
op_plus
l_int|3
)paren
comma
(paren
id|pipe
op_rshift
l_int|26
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|control_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ep_addr.iep
comma
l_int|8
comma
id|cmd
comma
id|data
comma
id|len
comma
(paren
id|__OHCI_BAG
)paren
op_amp
id|status
comma
l_int|0
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|control_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC status::: %x&bslash;n&quot;
comma
id|cc_to_status
(braket
id|status
op_amp
l_int|0x0f
)braket
)paren
suffix:semicolon
)paren
r_return
id|cc_to_status
(braket
id|status
op_amp
l_int|0x0f
)braket
suffix:semicolon
)brace
DECL|function|sohci_usb_deallocate
r_static
r_int
id|sohci_usb_deallocate
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_struct
id|ohci_device
op_star
id|dev
op_assign
id|usb_to_ohci
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
r_union
id|ep_addr_
id|ep_addr
suffix:semicolon
id|ep_addr.iep
op_assign
l_int|0
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC dealloc %x&bslash;n&quot;
comma
id|usb_dev-&gt;devnum
)paren
suffix:semicolon
)paren
multiline_comment|/* wait_ms(20); */
r_if
c_cond
(paren
id|usb_dev-&gt;devnum
op_ge
l_int|0
)paren
(brace
id|ep_addr.bep.fa
op_assign
id|usb_dev-&gt;devnum
suffix:semicolon
id|usb_ohci_rm_function
c_func
(paren
(paren
(paren
r_struct
id|ohci_device
op_star
)paren
id|usb_dev-&gt;hcpriv
)paren
op_member_access_from_pointer
id|ohci
comma
id|ep_addr.iep
)paren
suffix:semicolon
)brace
id|USB_FREE
c_func
(paren
id|dev
)paren
suffix:semicolon
id|USB_FREE
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_usb_allocate
r_static
r_struct
id|usb_device
op_star
id|sohci_usb_allocate
c_func
(paren
r_struct
id|usb_device
op_star
id|parent
)paren
(brace
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
id|USB_ALLOC
c_func
(paren
id|usb_dev
comma
r_sizeof
(paren
op_star
id|usb_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|usb_dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|usb_dev
)paren
)paren
suffix:semicolon
id|USB_ALLOC
c_func
(paren
id|dev
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|USB_FREE
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Initialize &quot;dev&quot; */
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|usb_dev-&gt;hcpriv
op_assign
id|dev
suffix:semicolon
id|dev-&gt;usb
op_assign
id|usb_dev
suffix:semicolon
id|usb_dev-&gt;parent
op_assign
id|parent
suffix:semicolon
r_if
c_cond
(paren
id|parent
)paren
(brace
id|usb_dev-&gt;bus
op_assign
id|parent-&gt;bus
suffix:semicolon
id|dev-&gt;ohci
op_assign
id|usb_to_ohci
c_func
(paren
id|parent
)paren
op_member_access_from_pointer
id|ohci
suffix:semicolon
)brace
r_return
id|usb_dev
suffix:semicolon
)brace
DECL|variable|sohci_device_operations
r_struct
id|usb_operations
id|sohci_device_operations
op_assign
(brace
id|sohci_usb_allocate
comma
id|sohci_usb_deallocate
comma
id|sohci_control_msg
comma
id|sohci_request_irq
comma
)brace
suffix:semicolon
multiline_comment|/******&n; *** ED handling functions&n; ************************************/
multiline_comment|/* &n; * search for the right place to insert an interrupt ed into the int tree &n; * do some load ballancing&n; * */
DECL|function|usb_ohci_int_ballance
r_static
r_int
id|usb_ohci_int_ballance
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
id|interval
comma
r_int
id|load
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* search for the least loaded interrupt endpoint branch of all 32 branches */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ohci-&gt;ohci_int_load
(braket
id|j
)braket
OG
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
)paren
(brace
id|j
op_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|interval
OL
l_int|1
)paren
(brace
id|interval
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|interval
OG
l_int|32
)paren
(brace
id|interval
op_assign
l_int|32
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|interval
op_rshift
id|i
)paren
OG
l_int|1
)paren
suffix:semicolon
id|interval
op_and_assign
(paren
l_int|0xfffe
op_lshift
id|i
op_increment
)paren
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* interval = 2^int(ld(interval)) */
r_for
c_loop
(paren
id|i
op_assign
id|j
op_mod
id|interval
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|interval
)paren
(brace
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_add_assign
id|load
suffix:semicolon
)brace
id|j
op_assign
id|interval
op_plus
(paren
id|j
op_mod
id|interval
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC new int ed on pos : %x &bslash;n&quot;
comma
id|j
)paren
suffix:semicolon
)paren
r_return
id|j
suffix:semicolon
)brace
multiline_comment|/* get the ed from the endpoint / device adress */
DECL|function|ohci_find_ep
r_struct
id|usb_ohci_ed
op_star
id|ohci_find_ep
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
r_int
id|ep_addr_in
)paren
(brace
r_union
id|ep_addr_
id|ep_addr
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
id|mask
op_assign
l_int|0
suffix:semicolon
id|ep_addr.iep
op_assign
id|ep_addr_in
suffix:semicolon
macro_line|#ifdef VROOTHUB
r_if
c_cond
(paren
id|ep_addr.bep.fa
op_eq
id|ohci-&gt;root_hub_funct_addr
)paren
(brace
r_if
c_cond
(paren
(paren
id|ep_addr.bep.ep
op_amp
l_int|0x0f
)paren
op_eq
l_int|0
)paren
(brace
r_return
op_amp
id|ohci-&gt;ed_rh_ep0
suffix:semicolon
)brace
multiline_comment|/* root hub ep0 */
r_else
r_return
op_amp
id|ohci-&gt;ed_rh_epi
suffix:semicolon
multiline_comment|/* root hub int ep */
)brace
macro_line|#endif
id|tmp
op_assign
id|ohci-&gt;ed_func_ep0
(braket
id|ep_addr.bep.fa
)braket
suffix:semicolon
id|mask
op_assign
(paren
(paren
(paren
(paren
id|ep_addr.bep.ep
op_rshift
l_int|5
)paren
op_amp
l_int|0x03
)paren
op_eq
l_int|2
)paren
ques
c_cond
l_int|0x7f
suffix:colon
l_int|0xff
)paren
suffix:semicolon
id|ep_addr.bep.ep
op_and_assign
id|mask
suffix:semicolon
multiline_comment|/* mask out direction of ctrl ep */
r_while
c_loop
(paren
id|tmp
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;ep_addr.iep
op_eq
id|ep_addr.iep
)paren
r_return
id|tmp
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;ed_list
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|variable|usb_ed_lock
id|spinlock_t
id|usb_ed_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* add a new endpoint ep_addr */
DECL|function|usb_ohci_add_ep
r_struct
id|usb_ohci_ed
op_star
id|usb_ohci_add_ep
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
r_int
id|ep_addr_in
comma
r_int
id|interval
comma
r_int
id|load
comma
id|f_handler
id|handler
comma
r_int
id|ep_size
comma
r_int
id|speed
)paren
(brace
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td
suffix:semicolon
r_union
id|ep_addr_
id|ep_addr
suffix:semicolon
r_int
id|int_junk
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|tmp
suffix:semicolon
id|ep_addr.iep
op_assign
id|ep_addr_in
suffix:semicolon
id|ep_addr.bep.ep
op_and_assign
(paren
(paren
(paren
(paren
id|ep_addr.bep.ep
op_rshift
l_int|5
)paren
op_amp
l_int|0x03
)paren
op_eq
l_int|2
)paren
ques
c_cond
l_int|0x7f
suffix:colon
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* mask out direction of ctrl ep */
id|spin_lock
c_func
(paren
op_amp
id|usb_ed_lock
)paren
suffix:semicolon
id|tmp
op_assign
id|ohci_find_ep
c_func
(paren
id|ohci
comma
id|ep_addr.iep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
l_int|NULL
)paren
(brace
macro_line|#ifdef VROOTHUB
r_if
c_cond
(paren
id|ep_addr.bep.fa
op_eq
id|ohci-&gt;root_hub_funct_addr
)paren
(brace
r_if
c_cond
(paren
(paren
id|ep_addr.bep.ep
op_amp
l_int|0x0f
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* root hub int ep */
id|ohci-&gt;ed_rh_epi.handler
op_assign
id|handler
suffix:semicolon
id|ohci_init_rh_int_timer
c_func
(paren
id|ohci
comma
id|interval
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* root hub ep0 */
id|ohci-&gt;ed_rh_ep0.handler
op_assign
id|handler
suffix:semicolon
)brace
)brace
r_else
macro_line|#endif 
(brace
id|tmp-&gt;hw.info
op_assign
id|ep_addr.bep.fa
op_or
(paren
(paren
id|ep_addr.bep.ep
op_amp
l_int|0xf
)paren
op_lshift
l_int|7
)paren
op_or
(paren
(paren
(paren
id|ep_addr.bep.ep
op_amp
l_int|0x60
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|0x8000
suffix:colon
l_int|0
)paren
op_or
(paren
id|speed
op_lshift
l_int|13
)paren
op_or
id|ep_size
op_lshift
l_int|16
suffix:semicolon
id|tmp-&gt;handler
op_assign
id|handler
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|usb_ed_lock
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
multiline_comment|/* ed  already in use */
)brace
id|OHCI_ALLOC
c_func
(paren
id|td
comma
r_sizeof
(paren
id|td
)paren
)paren
suffix:semicolon
multiline_comment|/* dummy td; end of td list for ed */
id|OHCI_ALLOC
c_func
(paren
id|ed
comma
r_sizeof
(paren
id|ed
)paren
)paren
suffix:semicolon
id|td-&gt;prev_td
op_assign
l_int|NULL
suffix:semicolon
id|ed-&gt;hw.tail_td
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|td-&gt;hw
)paren
suffix:semicolon
id|ed-&gt;hw.head_td
op_assign
id|ed-&gt;hw.tail_td
suffix:semicolon
id|ed-&gt;hw.info
op_assign
id|ep_addr.bep.fa
op_or
(paren
(paren
id|ep_addr.bep.ep
op_amp
l_int|0xf
)paren
op_lshift
l_int|7
)paren
multiline_comment|/*  | ((ep_addr.bep.port &amp; 0x80)? 0x1000 : 0x0800 ) */
op_or
(paren
(paren
(paren
id|ep_addr.bep.ep
op_amp
l_int|0x60
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|0x8000
suffix:colon
l_int|0
)paren
op_or
(paren
id|speed
op_lshift
l_int|13
)paren
op_or
id|ep_size
op_lshift
l_int|16
suffix:semicolon
id|ed-&gt;handler
op_assign
id|handler
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|ep_addr.bep.ep
op_rshift
l_int|5
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
id|CTRL
suffix:colon
id|ed-&gt;hw.next_ed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|ed-&gt;hw
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;ed_controltail-&gt;hw.next_ed
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|ed-&gt;hw
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_controltail
suffix:semicolon
id|ohci-&gt;ed_controltail
op_assign
id|ed
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BULK
suffix:colon
id|ed-&gt;hw.next_ed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|ed-&gt;hw
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;ed_bulktail-&gt;hw.next_ed
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|ed-&gt;hw
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_bulktail
suffix:semicolon
id|ohci-&gt;ed_bulktail
op_assign
id|ed
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT
suffix:colon
id|int_junk
op_assign
id|usb_ohci_int_ballance
c_func
(paren
id|ohci
comma
id|interval
comma
id|load
)paren
suffix:semicolon
id|ed-&gt;hw.next_ed
op_assign
id|ohci-&gt;hc_area-&gt;ed
(braket
id|int_junk
)braket
dot
id|next_ed
suffix:semicolon
id|ohci-&gt;hc_area-&gt;ed
(braket
id|int_junk
)braket
dot
id|next_ed
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|ed-&gt;hw
)paren
suffix:semicolon
id|ed-&gt;ed_prev
op_assign
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
op_amp
id|ohci-&gt;hc_area-&gt;ed
(braket
id|int_junk
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISO
suffix:colon
id|ed-&gt;hw.next_ed
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;ed_isotail-&gt;hw.next_ed
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|ed-&gt;hw
)paren
suffix:semicolon
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_isotail
suffix:semicolon
id|ohci-&gt;ed_isotail
op_assign
id|ed
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ed-&gt;ep_addr
op_assign
id|ep_addr
suffix:semicolon
multiline_comment|/* Add it to the &quot;hash&quot;-table of known endpoint descriptors */
id|ed-&gt;ed_list
op_assign
id|ohci-&gt;ed_func_ep0
(braket
id|ed-&gt;ep_addr.bep.fa
)braket
suffix:semicolon
id|ohci-&gt;ed_func_ep0
(braket
id|ed-&gt;ep_addr.bep.fa
)braket
op_assign
id|ed
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|usb_ed_lock
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC new ed %x: %x :&quot;
comma
id|ep_addr.iep
comma
(paren
r_int
r_int
)paren
id|ed
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
(brace
r_int
id|i
suffix:semicolon
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %4x&quot;
comma
(paren
(paren
r_int
r_int
op_star
)paren
id|ed
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****&n; * Request the removal of an endpoint&n; * &n; * put the ep on the rm_list and request a stop of the bulk or ctrl list &n; * real removal is done at the next start of frame hardware interrupt &n; */
DECL|function|usb_ohci_rm_ep
r_int
id|usb_ohci_rm_ep
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_struct
id|usb_ohci_ed
op_star
id|ed
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|tmp
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC remove ed %x: %x :&bslash;n&quot;
comma
id|ed-&gt;ep_addr.iep
comma
(paren
r_int
r_int
)paren
id|ed
)paren
suffix:semicolon
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
id|ohci-&gt;ed_func_ep0
(braket
id|ed-&gt;ep_addr.bep.fa
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_func_ep0
(braket
id|ed-&gt;ep_addr.bep.fa
)braket
op_assign
id|ed-&gt;ed_list
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|tmp-&gt;ed_list
op_ne
id|ed
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;ed_list
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tmp
op_assign
id|tmp-&gt;ed_list
suffix:semicolon
)brace
id|tmp-&gt;ed_list
op_assign
id|ed-&gt;ed_list
suffix:semicolon
)brace
id|ed-&gt;ed_list
op_assign
id|ohci-&gt;ed_rm_list
suffix:semicolon
id|ohci-&gt;ed_rm_list
op_assign
id|ed
suffix:semicolon
id|ed-&gt;hw.info
op_or_assign
id|OHCI_ED_SKIP
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|ed-&gt;ep_addr.bep.ep
op_rshift
l_int|5
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
id|CTRL
suffix:colon
id|writel_mask
c_func
(paren
op_complement
(paren
l_int|0x01
op_lshift
l_int|4
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* stop CTRL list */
r_break
suffix:semicolon
r_case
id|BULK
suffix:colon
id|writel_mask
c_func
(paren
op_complement
(paren
l_int|0x01
op_lshift
l_int|5
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* stop BULK list */
r_break
suffix:semicolon
)brace
id|writel
c_func
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
multiline_comment|/* enable sof interrupt */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* we have requested to stop the bulk or CTRL list,&n; * now we can remove the eds on the rm_list */
DECL|function|ohci_rm_eds
r_static
r_int
id|ohci_rm_eds
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|ed_tmp
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td
suffix:semicolon
id|__u32
id|td_hw_tmp
suffix:semicolon
id|__u32
id|td_hw
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|ed
op_assign
id|ohci-&gt;ed_rm_list
suffix:semicolon
r_while
c_loop
(paren
id|ed
op_ne
l_int|NULL
)paren
(brace
r_switch
c_cond
(paren
(paren
id|ed-&gt;ep_addr.bep.ep
op_rshift
l_int|5
)paren
op_amp
l_int|0x03
)paren
(brace
r_case
id|CTRL
suffix:colon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|ed-&gt;hw.next_ed
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ed-&gt;ed_prev-&gt;hw.next_ed
op_assign
id|ed-&gt;hw.next_ed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_controltail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BULK
suffix:colon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|ed-&gt;hw.next_ed
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ed-&gt;ed_prev-&gt;hw.next_ed
op_assign
id|ed-&gt;hw.next_ed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_bulktail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|INT
suffix:colon
id|ed-&gt;ed_prev-&gt;hw.next_ed
op_assign
id|ed-&gt;hw.next_ed
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISO
suffix:colon
id|ed-&gt;ed_prev-&gt;hw.next_ed
op_assign
id|ed-&gt;hw.next_ed
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_isotail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_isotail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ed-&gt;hw.next_ed
op_ne
l_int|0
)paren
(brace
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
id|ed-&gt;hw.next_ed
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
multiline_comment|/* tds directly connected to ed */
id|td_hw
op_assign
id|ed-&gt;hw.head_td
op_amp
l_int|0xfffffff0
suffix:semicolon
r_while
c_loop
(paren
id|td_hw
op_ne
l_int|0
)paren
(brace
id|td
op_assign
id|bus_to_virt
c_func
(paren
id|td_hw
)paren
suffix:semicolon
id|td_hw_tmp
op_assign
id|td_hw
suffix:semicolon
id|td_hw
op_assign
id|td-&gt;hw.next_td
suffix:semicolon
id|OHCI_FREE
c_func
(paren
id|td
)paren
suffix:semicolon
multiline_comment|/* free pending tds */
r_if
c_cond
(paren
id|td_hw_tmp
op_eq
id|ed-&gt;hw.tail_td
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* mark TDs on the hc done list (if there are any) */
id|td_hw
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;donehead
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
r_while
c_loop
(paren
id|td_hw
op_ne
l_int|0
)paren
(brace
id|td
op_assign
id|bus_to_virt
c_func
(paren
id|td_hw
)paren
suffix:semicolon
id|td_hw
op_assign
id|td-&gt;hw.next_td
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;ep
op_eq
id|ed
)paren
(brace
id|td-&gt;ep
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* mark TDs on the hcca done list (if there are any) */
id|td_hw
op_assign
id|ohci-&gt;hc_area-&gt;hcca.done_head
op_amp
l_int|0xfffffff0
suffix:semicolon
r_while
c_loop
(paren
id|td_hw
op_ne
l_int|0
)paren
(brace
id|td
op_assign
id|bus_to_virt
c_func
(paren
id|td_hw
)paren
suffix:semicolon
id|td_hw
op_assign
id|td-&gt;hw.next_td
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;ep
op_eq
id|ed
)paren
(brace
id|td-&gt;ep
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|ed_tmp
op_assign
id|ed
suffix:semicolon
id|ed
op_assign
id|ed-&gt;ed_list
suffix:semicolon
id|OHCI_FREE
c_func
(paren
id|ed_tmp
)paren
suffix:semicolon
multiline_comment|/* free ed */
)brace
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlcurrent
)paren
suffix:semicolon
multiline_comment|/* reset CTRL list */
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkcurrent
)paren
suffix:semicolon
multiline_comment|/* reset BULK list */
id|writel_set
c_func
(paren
(paren
l_int|0x01
op_lshift
l_int|4
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* start CTRL u. (BULK list) */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|ohci-&gt;ed_rm_list
op_assign
l_int|NULL
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC after rm ed control: %4x  intrstat: %4x intrenable: %4x&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
comma
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
comma
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
)paren
suffix:semicolon
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* remove all endpoints of a function (device) */
DECL|function|usb_ohci_rm_function
r_int
id|usb_ohci_rm_function
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
r_int
id|ep_addr_in
)paren
(brace
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|tmp
suffix:semicolon
r_union
id|ep_addr_
id|ep_addr
suffix:semicolon
id|ep_addr.iep
op_assign
id|ep_addr_in
suffix:semicolon
r_for
c_loop
(paren
id|ed
op_assign
id|ohci-&gt;ed_func_ep0
(braket
id|ep_addr.bep.fa
)braket
suffix:semicolon
id|ed
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
id|tmp
op_assign
id|ed
suffix:semicolon
id|ed
op_assign
id|ed-&gt;ed_list
suffix:semicolon
id|usb_ohci_rm_ep
c_func
(paren
id|ohci
comma
id|tmp
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/******&n; *** TD handling functions&n; ************************************/
DECL|macro|FILL_TD
mdefine_line|#define FILL_TD(TD_PT, HANDLER, INFO, DATA, LEN, LW0, LW1)  &bslash;&n;    td_pt = (TD_PT); &bslash;&n;    td_pt1 = (struct usb_ohci_td *) bus_to_virt(usb_ep-&gt;hw.tail_td); &bslash;&n;    td_pt1-&gt;ep = usb_ep; &bslash;&n;    td_pt1-&gt;handler = (HANDLER); &bslash;&n;    td_pt1-&gt;buffer_start = (DATA); &bslash;&n;    td_pt1-&gt;lw0 = (LW0); &bslash;&n;    td_pt1-&gt;lw1 = (LW1); &bslash;&n;    td_pt1-&gt;hw.info = (INFO); &bslash;&n;    td_pt1-&gt;hw.cur_buf = virt_to_bus(DATA); &bslash;&n;    td_pt1-&gt;hw.buf_end = td_pt1-&gt;hw.cur_buf + (LEN) - 1; &bslash;&n;    td_pt1-&gt;hw.next_td = virt_to_bus(td_pt); &bslash;&n;    usb_ep-&gt;hw.tail_td = virt_to_bus(td_pt); &bslash;&n;    td_pt-&gt;prev_td = td_pt1; &bslash;&n;    td_pt-&gt;hw.next_td = 0
DECL|variable|usb_req_lock
id|spinlock_t
id|usb_req_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|ohci_trans_req
r_int
id|ohci_trans_req
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
r_int
id|ep_addr
comma
r_int
id|ctrl_len
comma
r_void
op_star
id|ctrl
comma
r_void
op_star
id|data
comma
r_int
id|data_len
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
)paren
(brace
r_int
id|ed_type
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_pt
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_pt1
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_pt_a1
comma
op_star
id|td_pt_a2
comma
op_star
id|td_pt_a3
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|usb_ep
suffix:semicolon
id|f_handler
id|handler
suffix:semicolon
id|td_pt_a1
op_assign
l_int|NULL
suffix:semicolon
id|td_pt_a2
op_assign
l_int|NULL
suffix:semicolon
id|td_pt_a3
op_assign
l_int|NULL
suffix:semicolon
id|usb_ep
op_assign
id|ohci_find_ep
c_func
(paren
id|ohci
comma
id|ep_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_ep
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* not known ep */
id|handler
op_assign
id|usb_ep-&gt;handler
suffix:semicolon
macro_line|#ifdef VROOTHUB 
r_if
c_cond
(paren
id|usb_ep
op_eq
op_amp
id|ohci-&gt;ed_rh_ep0
)paren
(brace
multiline_comment|/* root hub ep 0 control endpoint */
id|root_hub_control_msg
c_func
(paren
id|ohci
comma
l_int|8
comma
id|ctrl
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
comma
id|handler
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_ep
op_eq
op_amp
id|ohci-&gt;ed_rh_epi
)paren
(brace
multiline_comment|/* root hub interrupt endpoint */
id|root_hub_int_req
c_func
(paren
id|ohci
comma
l_int|8
comma
id|ctrl
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
comma
id|handler
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*  struct usb_ohci_ed * usb_ep = usb_ohci_add_ep(pipe, ohci, interval, 1); */
id|ed_type
op_assign
(paren
(paren
(paren
(paren
r_union
id|ep_addr_
)paren
id|ep_addr
)paren
dot
id|bep.ep
op_rshift
l_int|5
)paren
op_amp
l_int|0x07
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ed_type
)paren
(brace
r_case
id|BULK_IN
suffix:colon
r_case
id|BULK_OUT
suffix:colon
r_case
id|INT_IN
suffix:colon
r_case
id|INT_OUT
suffix:colon
id|OHCI_ALLOC
c_func
(paren
id|td_pt_a1
comma
r_sizeof
(paren
id|td_pt_a1
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTRL_IN
suffix:colon
r_case
id|CTRL_OUT
suffix:colon
id|OHCI_ALLOC
c_func
(paren
id|td_pt_a1
comma
r_sizeof
(paren
id|td_pt_a1
)paren
)paren
suffix:semicolon
id|OHCI_ALLOC
c_func
(paren
id|td_pt_a3
comma
r_sizeof
(paren
id|td_pt_a3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_len
OG
l_int|0
)paren
(brace
id|OHCI_ALLOC
c_func
(paren
id|td_pt_a2
comma
r_sizeof
(paren
id|td_pt_a2
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISO_IN
suffix:colon
r_case
id|ISO_OUT
suffix:colon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|usb_req_lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ed_type
)paren
(brace
r_case
id|BULK_IN
suffix:colon
id|FILL_TD
c_func
(paren
id|td_pt_a1
comma
id|handler
comma
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|TD_T_TOGGLE
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_BLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start bulk list */
r_break
suffix:semicolon
r_case
id|BULK_OUT
suffix:colon
id|FILL_TD
c_func
(paren
id|td_pt_a1
comma
id|handler
comma
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|TD_T_TOGGLE
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_BLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start bulk list */
r_break
suffix:semicolon
r_case
id|INT_IN
suffix:colon
id|FILL_TD
c_func
(paren
id|td_pt_a1
comma
id|handler
comma
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|TD_T_TOGGLE
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_OUT
suffix:colon
id|FILL_TD
c_func
(paren
id|td_pt_a1
comma
id|handler
comma
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|TD_T_TOGGLE
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTRL_IN
suffix:colon
id|FILL_TD
c_func
(paren
id|td_pt_a1
comma
l_int|NULL
comma
id|TD_CC
op_or
id|TD_DP_SETUP
op_or
id|TD_T_DATA0
comma
id|ctrl
comma
id|ctrl_len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_len
OG
l_int|0
)paren
(brace
id|FILL_TD
c_func
(paren
id|td_pt_a2
comma
l_int|NULL
comma
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|TD_T_DATA1
comma
id|data
comma
id|data_len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|FILL_TD
c_func
(paren
id|td_pt_a3
comma
id|handler
comma
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|TD_T_DATA1
comma
l_int|NULL
comma
l_int|0
comma
id|lw0
comma
id|lw1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_CLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start Control list */
r_break
suffix:semicolon
r_case
id|CTRL_OUT
suffix:colon
id|FILL_TD
c_func
(paren
id|td_pt_a1
comma
l_int|NULL
comma
id|TD_CC
op_or
id|TD_DP_SETUP
op_or
id|TD_T_DATA0
comma
id|ctrl
comma
id|ctrl_len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_len
OG
l_int|0
)paren
(brace
id|FILL_TD
c_func
(paren
id|td_pt_a2
comma
l_int|NULL
comma
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_OUT
op_or
id|TD_T_DATA1
comma
id|data
comma
id|data_len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|FILL_TD
c_func
(paren
id|td_pt_a3
comma
id|handler
comma
id|TD_CC
op_or
id|TD_DP_IN
op_or
id|TD_T_DATA1
comma
l_int|NULL
comma
l_int|0
comma
id|lw0
comma
id|lw1
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_CLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start Control list */
r_break
suffix:semicolon
r_case
id|ISO_IN
suffix:colon
r_case
id|ISO_OUT
suffix:colon
r_break
suffix:semicolon
)brace
id|td_pt1
op_assign
(paren
r_struct
id|usb_ohci_td
op_star
)paren
id|bus_to_virt
c_func
(paren
id|usb_ep-&gt;hw.tail_td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td_pt_a3
op_ne
l_int|NULL
)paren
(brace
id|td_pt_a3-&gt;prev_td
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|td_pt_a2
op_ne
l_int|NULL
)paren
id|td_pt_a2-&gt;prev_td
op_assign
l_int|NULL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|td_pt_a1
op_ne
l_int|NULL
)paren
id|td_pt_a1-&gt;prev_td
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|usb_req_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******&n; *** Done List handling functions&n; ************************************/
multiline_comment|/* replies to the request have to be on a FIFO basis so&n; * we reverse the reversed done-list */
DECL|function|ohci_reverse_done_list
r_static
r_struct
id|usb_ohci_td
op_star
id|ohci_reverse_done_list
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
id|__u32
id|td_list_hc
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_list
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_rev
op_assign
l_int|NULL
suffix:semicolon
id|td_list_hc
op_assign
id|ohci-&gt;hc_area-&gt;hcca.done_head
op_amp
l_int|0xfffffff0
suffix:semicolon
id|ohci-&gt;hc_area-&gt;hcca.done_head
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|td_list_hc
)paren
(brace
id|td_list
op_assign
(paren
r_struct
id|usb_ohci_td
op_star
)paren
id|bus_to_virt
c_func
(paren
id|td_list_hc
)paren
suffix:semicolon
id|td_list-&gt;next_dl_td
op_assign
id|td_rev
suffix:semicolon
id|td_rev
op_assign
id|td_list
suffix:semicolon
id|td_list_hc
op_assign
id|td_list-&gt;hw.next_td
op_amp
l_int|0xfffffff0
suffix:semicolon
)brace
r_return
id|td_list
suffix:semicolon
)brace
multiline_comment|/* all done requests are replied here */
DECL|function|usb_ohci_done_list
r_static
r_int
id|usb_ohci_done_list
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
r_struct
id|usb_ohci_td
op_star
id|td
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_list
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_list_next
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_err
op_assign
l_int|NULL
suffix:semicolon
id|__u32
id|td_hw
suffix:semicolon
id|td_list
op_assign
id|ohci_reverse_done_list
c_func
(paren
id|ohci
)paren
suffix:semicolon
r_while
c_loop
(paren
id|td_list
)paren
(brace
id|td_list_next
op_assign
id|td_list-&gt;next_dl_td
suffix:semicolon
id|td
op_assign
id|td_list
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;ep
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* removed ep */
id|OHCI_FREE
c_func
(paren
id|td_list
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* the HC halts an ED if an error occurs; put all pendings TDs of an halted ED on the&n;   &t; * done list; they are marked with an 0xf CC_error code &n;   &t; */
r_if
c_cond
(paren
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;hw.info
)paren
op_ne
id|TD_CC_NOERROR
)paren
(brace
multiline_comment|/* on error move all pending tds of an ed into the done list */
id|printk
c_func
(paren
l_string|&quot;******* USB BUS error %x @ep %x&bslash;n&quot;
comma
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;hw.info
)paren
comma
id|td_list-&gt;ep-&gt;ep_addr.iep
)paren
suffix:semicolon
id|td_err
op_assign
id|td_list
suffix:semicolon
id|td_hw
op_assign
id|td_list-&gt;ep-&gt;hw.head_td
op_amp
l_int|0xfffffff0
suffix:semicolon
r_while
c_loop
(paren
id|td_hw
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|td_hw
op_eq
id|td_list-&gt;ep-&gt;hw.tail_td
)paren
(brace
r_break
suffix:semicolon
)brace
id|td
op_assign
id|bus_to_virt
c_func
(paren
id|td_hw
)paren
suffix:semicolon
id|td_err-&gt;next_dl_td
op_assign
id|td
suffix:semicolon
id|td_err
op_assign
id|td
suffix:semicolon
id|td_hw
op_assign
id|td-&gt;hw.next_td
suffix:semicolon
)brace
id|td_list-&gt;ep-&gt;hw.head_td
op_assign
id|td_list-&gt;ep-&gt;hw.tail_td
suffix:semicolon
id|td-&gt;next_dl_td
op_assign
id|td_list_next
suffix:semicolon
id|td_list_next
op_assign
id|td_list-&gt;next_dl_td
suffix:semicolon
)brace
multiline_comment|/*  send the reply  */
r_if
c_cond
(paren
id|td_list-&gt;handler
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|td_list-&gt;prev_td
op_eq
l_int|NULL
)paren
(brace
id|td_list
op_member_access_from_pointer
id|handler
c_func
(paren
(paren
r_void
op_star
)paren
id|ohci
comma
id|td_list-&gt;ep-&gt;ep_addr.iep
comma
l_int|0
comma
l_int|NULL
comma
id|td_list-&gt;buffer_start
comma
id|td_list-&gt;hw.buf_end
op_minus
id|virt_to_bus
c_func
(paren
id|td_list-&gt;buffer_start
)paren
op_plus
l_int|1
comma
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;hw.info
)paren
comma
id|td_list-&gt;lw0
comma
id|td_list-&gt;lw1
)paren
suffix:semicolon
id|OHCI_FREE
c_func
(paren
id|td_list
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|td_list-&gt;prev_td-&gt;prev_td
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* cntrl 2 Transactions dataless */
id|td_list
op_member_access_from_pointer
id|handler
c_func
(paren
(paren
r_void
op_star
)paren
id|ohci
comma
id|td_list-&gt;ep-&gt;ep_addr.iep
comma
id|td_list-&gt;prev_td-&gt;hw.buf_end
op_minus
id|virt_to_bus
c_func
(paren
id|td_list-&gt;prev_td-&gt;buffer_start
)paren
op_plus
l_int|1
comma
id|td_list-&gt;prev_td-&gt;buffer_start
comma
l_int|NULL
comma
l_int|0
comma
(paren
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;prev_td-&gt;hw.info
)paren
OG
l_int|0
)paren
ques
c_cond
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;prev_td-&gt;hw.info
)paren
suffix:colon
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;hw.info
)paren
comma
id|td_list-&gt;lw0
comma
id|td_list-&gt;lw1
)paren
suffix:semicolon
id|OHCI_FREE
c_func
(paren
id|td_list-&gt;prev_td
)paren
suffix:semicolon
id|OHCI_FREE
c_func
(paren
id|td_list
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* cntrl 3 Transactions */
id|td_list
op_member_access_from_pointer
id|handler
c_func
(paren
(paren
r_void
op_star
)paren
id|ohci
comma
id|td_list-&gt;ep-&gt;ep_addr.iep
comma
id|td_list-&gt;prev_td-&gt;prev_td-&gt;hw.buf_end
op_minus
id|virt_to_bus
c_func
(paren
id|td_list-&gt;prev_td-&gt;prev_td-&gt;buffer_start
)paren
op_plus
l_int|1
comma
id|td_list-&gt;prev_td-&gt;prev_td-&gt;buffer_start
comma
id|td_list-&gt;prev_td-&gt;buffer_start
comma
id|td_list-&gt;prev_td-&gt;hw.buf_end
op_minus
id|virt_to_bus
c_func
(paren
id|td_list-&gt;prev_td-&gt;buffer_start
)paren
op_plus
l_int|1
comma
(paren
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;prev_td-&gt;prev_td-&gt;hw.info
)paren
OG
l_int|0
)paren
ques
c_cond
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;prev_td-&gt;prev_td-&gt;hw.info
)paren
suffix:colon
(paren
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;prev_td-&gt;hw.info
)paren
OG
l_int|0
)paren
ques
c_cond
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;prev_td-&gt;hw.info
)paren
suffix:colon
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;hw.info
)paren
comma
id|td_list-&gt;lw0
comma
id|td_list-&gt;lw1
)paren
suffix:semicolon
id|OHCI_FREE
c_func
(paren
id|td_list-&gt;prev_td-&gt;prev_td
)paren
suffix:semicolon
id|OHCI_FREE
c_func
(paren
id|td_list-&gt;prev_td
)paren
suffix:semicolon
id|OHCI_FREE
c_func
(paren
id|td_list
)paren
suffix:semicolon
)brace
)brace
)brace
id|td_list
op_assign
id|td_list_next
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******&n; *** HC functions&n; ************************************/
DECL|function|reset_hc
r_void
id|reset_hc
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
r_int
id|retries
op_assign
l_int|5
suffix:semicolon
r_int
id|timeout
op_assign
l_int|30
suffix:semicolon
r_int
id|fminterval
suffix:semicolon
r_if
c_cond
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
l_int|0x100
)paren
(brace
multiline_comment|/* SMM owns the HC */
id|writel
c_func
(paren
l_int|0x08
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* request ownership */
id|printk
c_func
(paren
l_string|&quot;USB HC TakeOver from SMM&bslash;n&quot;
)paren
suffix:semicolon
r_do
(brace
id|wait_ms
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|retries
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;USB HC TakeOver timed out!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
l_int|0x100
)paren
(brace
suffix:semicolon
)brace
)brace
id|writel
c_func
(paren
(paren
l_int|1
op_lshift
l_int|31
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;intrdisable
)paren
suffix:semicolon
multiline_comment|/* Disable HC interrupts */
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC reset_hc: %x ; retries: %d&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
comma
l_int|5
op_minus
id|retries
)paren
suffix:semicolon
)paren
id|fminterval
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;fminterval
)paren
op_amp
l_int|0x3fff
suffix:semicolon
id|writel
c_func
(paren
l_int|1
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* HC Reset */
r_while
c_loop
(paren
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
op_amp
l_int|0x01
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* 10us Reset */
r_if
c_cond
(paren
op_decrement
id|timeout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;USB HC reset timed out!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* set the timing */
id|fminterval
op_or_assign
(paren
(paren
(paren
id|fminterval
op_minus
l_int|210
)paren
op_star
l_int|6
)paren
op_div
l_int|7
)paren
op_lshift
l_int|16
suffix:semicolon
id|writel
c_func
(paren
id|fminterval
comma
op_amp
id|ohci-&gt;regs-&gt;fminterval
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
(paren
id|fminterval
op_amp
l_int|0x3fff
)paren
op_star
l_int|9
)paren
op_div
l_int|10
comma
op_amp
id|ohci-&gt;regs-&gt;periodicstart
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reset and start an OHCI controller&n; */
DECL|function|start_hc
r_void
id|start_hc
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
multiline_comment|/*  int fminterval; */
r_int
r_int
id|mask
suffix:semicolon
multiline_comment|/*  fminterval = readl(&amp;ohci-&gt;regs-&gt;fminterval) &amp; 0x3fff;&n;&t;reset_hc(ohci); */
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|ohci-&gt;hc_area-&gt;hcca
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;hcca
)paren
suffix:semicolon
multiline_comment|/* a reset clears this */
multiline_comment|/* Choose the interrupts we care about now, others later on demand */
id|mask
op_assign
id|OHCI_INTR_MIE
op_or
id|OHCI_INTR_WDH
suffix:semicolon
multiline_comment|/* | OHCI_INTR_SO | OHCI_INTR_UE |OHCI_INTR_RHSC |OHCI_INTR_SF|  &n;&t;&t;OHCI_INTR_FNO */
id|writel
c_func
(paren
(paren
l_int|0x00
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* USB Reset BUS */
id|wait_ms
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
l_int|0x97
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* USB Operational  */
id|writel
c_func
(paren
l_int|0x10000
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
suffix:semicolon
multiline_comment|/* root hub power on */
id|wait_ms
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC rstart_hc_operational: %x&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstata: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.a
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstatb: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.b
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstatu: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.status
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstat1: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|0
)braket
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstat2: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|1
)braket
)paren
)paren
)paren
suffix:semicolon
)paren
multiline_comment|/* control_wakeup = NULL; */
id|writel
c_func
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
id|writel
c_func
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
macro_line|#ifdef VROOTHUB
(brace
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
id|usb_dev
op_assign
id|sohci_usb_allocate
c_func
(paren
id|ohci-&gt;root_hub-&gt;usb
)paren
suffix:semicolon
id|dev
op_assign
id|usb_dev-&gt;hcpriv
suffix:semicolon
id|dev-&gt;ohci
op_assign
id|ohci
suffix:semicolon
id|usb_connect
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
id|ohci-&gt;root_hub-&gt;usb-&gt;children
(braket
l_int|0
)braket
op_assign
id|usb_dev
suffix:semicolon
id|usb_new_device
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|ohci_interrupt
r_static
r_void
id|ohci_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|__ohci
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|__ohci
suffix:semicolon
r_struct
id|ohci_regs
op_star
id|regs
op_assign
id|ohci-&gt;regs
suffix:semicolon
r_int
id|ints
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ohci-&gt;hc_area-&gt;hcca.done_head
op_ne
l_int|0
)paren
op_logical_and
op_logical_neg
(paren
id|ohci-&gt;hc_area-&gt;hcca.done_head
op_amp
l_int|0x01
)paren
)paren
(brace
id|ints
op_assign
id|OHCI_INTR_WDH
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|ints
op_assign
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;intrstatus
)paren
op_amp
id|readl
c_func
(paren
op_amp
id|regs-&gt;intrenable
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
id|ohci-&gt;intrstatus
op_or_assign
id|ints
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC interrupt: %x (%x) &bslash;n&quot;
comma
id|ints
comma
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
)paren
suffix:semicolon
)paren
multiline_comment|/* ints &amp;= ~(OHCI_INTR_WDH);  WH Bit will be set by done list subroutine */
multiline_comment|/*  if(ints &amp; OHCI_INTR_FNO) {&n;   &t;writel(OHCI_INTR_FNO,  &amp;regs-&gt;intrstatus);&n;   &t;if (waitqueue_active(&amp;ohci_tasks)) wake_up(&amp;ohci_tasks);&n;  } */
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_WDH
)paren
(brace
id|writel
c_func
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
id|ohci-&gt;intrstatus
op_and_assign
(paren
op_complement
id|OHCI_INTR_WDH
)paren
suffix:semicolon
id|usb_ohci_done_list
c_func
(paren
id|ohci
)paren
suffix:semicolon
multiline_comment|/* prepare out channel list */
id|writel
c_func
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_SF
)paren
(brace
id|writel
c_func
(paren
id|OHCI_INTR_SF
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
id|ohci-&gt;intrstatus
op_and_assign
(paren
op_complement
id|OHCI_INTR_SF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_rm_list
op_ne
l_int|NULL
)paren
(brace
id|ohci_rm_eds
c_func
(paren
id|ohci
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifndef VROOTHUB 
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_RHSC
)paren
(brace
id|writel
c_func
(paren
id|OHCI_INTR_RHSC
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_INTR_RHSC
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|root_hub
)paren
suffix:semicolon
)brace
macro_line|#endif
id|writel
c_func
(paren
id|OHCI_INTR_MIE
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
macro_line|#ifndef VROOTHUB
multiline_comment|/*&n; * This gets called if the connect status on the root&n; * hub (and the root hub only) changes.&n; */
DECL|function|ohci_connect_change
r_static
r_void
id|ohci_connect_change
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
r_int
id|port_nr
)paren
(brace
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;uhci_connect_change: called for %d stat %x&bslash;n&quot;
comma
id|port_nr
comma
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|port_nr
)braket
)paren
)paren
suffix:semicolon
)paren
multiline_comment|/*&n;&t; * Even if the status says we&squot;re connected,&n;&t; * the fact that the status bits changed may&n;&t; * that we got disconnected and then reconnected.&n;&t; *&n;&t; * So start off by getting rid of any old devices..&n;&t; */
id|usb_disconnect
c_func
(paren
op_amp
id|ohci-&gt;root_hub-&gt;usb-&gt;children
(braket
id|port_nr
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|port_nr
)braket
)paren
op_amp
id|RH_PS_CCS
)paren
)paren
(brace
id|writel
c_func
(paren
id|RH_PS_CCS
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|port_nr
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* nothing connected */
)brace
multiline_comment|/*&n;&t; * Ok, we got a new connection. Allocate a device to it,&n;&t; * and find out what it wants to do..&n;&t; */
id|usb_dev
op_assign
id|sohci_usb_allocate
c_func
(paren
id|ohci-&gt;root_hub-&gt;usb
)paren
suffix:semicolon
id|dev
op_assign
id|usb_dev-&gt;hcpriv
suffix:semicolon
id|dev-&gt;ohci
op_assign
id|ohci
suffix:semicolon
id|usb_connect
c_func
(paren
id|dev-&gt;usb
)paren
suffix:semicolon
id|ohci-&gt;root_hub-&gt;usb-&gt;children
(braket
id|port_nr
)braket
op_assign
id|usb_dev
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* wait for powerup */
multiline_comment|/* reset port/device */
id|writel
c_func
(paren
id|RH_PS_PRS
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|port_nr
)braket
)paren
suffix:semicolon
multiline_comment|/* reset port */
r_while
c_loop
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|port_nr
)braket
)paren
op_amp
id|RH_PS_PRSC
)paren
)paren
(brace
id|wait_ms
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* reset active ? */
id|writel
c_func
(paren
id|RH_PS_PES
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|port_nr
)braket
)paren
suffix:semicolon
multiline_comment|/* enable port */
id|wait_ms
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Get speed information */
id|usb_dev-&gt;slow
op_assign
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|port_nr
)braket
)paren
op_amp
id|RH_PS_LSDA
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, all the stuff specific to the root hub has been done.&n;&t; * The rest is generic for any new USB attach, regardless of&n;&t; * hub type.&n;&t; */
id|usb_new_device
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Allocate the resources required for running an OHCI controller.&n; * Host controller interrupts must not be running while calling this&n; * function.&n; *&n; * The mem_base parameter must be the usable -virtual- address of the&n; * host controller&squot;s memory mapped I/O registers.&n; *&n; * This is where OHCI triumphs over UHCI, because good is dumb.&n; * Note how much simpler this function is than in uhci.c.&n; *&n; * OHCI hardware takes care of most of the scheduling of different&n; * transfer types with the correct prioritization for us.&n; */
DECL|function|alloc_ohci
r_static
r_struct
id|ohci
op_star
id|alloc_ohci
c_func
(paren
r_void
op_star
id|mem_base
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
suffix:semicolon
r_struct
id|ohci_hc_area
op_star
id|hc_area
suffix:semicolon
r_struct
id|usb_bus
op_star
id|bus
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
r_struct
id|usb_device
op_star
id|usb
suffix:semicolon
multiline_comment|/*&n;&t; * Here we allocate some dummy  EDs as well as the&n;&t; * OHCI host controller communications area.  The HCCA is just&n;&t; * a nice pool of memory with pointers to endpoint descriptors&n;&t; * for the different interrupts.&n;&t; *&n;&t; * The first page of memory  contains the HCCA and ohci structure&n;&t; */
id|hc_area
op_assign
(paren
r_struct
id|ohci_hc_area
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hc_area
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|hc_area
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|hc_area
)paren
)paren
suffix:semicolon
id|ohci
op_assign
op_amp
id|hc_area-&gt;ohci
suffix:semicolon
id|ohci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|ohci-&gt;regs
op_assign
id|mem_base
suffix:semicolon
id|ohci-&gt;hc_area
op_assign
id|hc_area
suffix:semicolon
multiline_comment|/* Tell the controller where the HCCA is */
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|hc_area-&gt;hcca
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;hcca
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the ED polling &quot;tree&quot;,  full tree;&n;         * dummy eds ed[i] (hc should skip them) &n;         * i == 0 is the end of the iso list;&n;&t;&t; * 1 is the   1ms node, &n;         * 2,3        2ms nodes,&n;         * 4,5,6,7    4ms nodes,&n;         * 8  ... 15  8ms nodes,&n;         * 16 ... 31  16ms nodes,&n;         * 32 ... 63  32ms nodes&n;         * Sequenzes:&n;&t;&t; * 32-16- 8-4-2-1-0&n;         * 33-17- 9-5-3-1-0&n;         * 34-18-10-6-2-1-0&n;         * 35-19-11-7-3-1-0&n;         * 36-20-12-4-2-1-0&n;         * 37-21-13-5-3-1-0&n;         * 38-22-14-6-2-1-0&n;         * 39-23-15-7-3-1-0&n;         * 40-24- 8-4-2-1-0&n;         * 41-25- 9-5-3-1-0&n;         * 42-26-10-6-2-1-0&n;         *     :      :&n;         * 63-31-15-7-3-1-0&n;&t; */
id|hc_area-&gt;ed
(braket
id|ED_ISO
)braket
dot
id|info
op_or_assign
id|OHCI_ED_SKIP
suffix:semicolon
multiline_comment|/* place holder, so skip it */
id|hc_area-&gt;ed
(braket
id|ED_ISO
)braket
dot
id|next_ed
op_assign
l_int|0x0000
suffix:semicolon
multiline_comment|/* end of iso list */
id|hc_area-&gt;ed
(braket
l_int|1
)braket
dot
id|next_ed
op_assign
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|hc_area-&gt;ed
(braket
id|ED_ISO
)braket
)paren
)paren
suffix:semicolon
id|hc_area-&gt;ed
(braket
l_int|1
)braket
dot
id|info
op_or_assign
id|OHCI_ED_SKIP
suffix:semicolon
multiline_comment|/* place holder, skip it */
id|j
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
(paren
id|NUM_INTS
op_star
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_ge
id|NUM_INTS
)paren
id|hc_area-&gt;hcca.int_table
(braket
id|i
op_minus
id|NUM_INTS
)braket
op_assign
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|hc_area-&gt;ed
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|j
op_star
l_int|4
)paren
(brace
id|j
op_mul_assign
l_int|2
suffix:semicolon
)brace
id|hc_area-&gt;ed
(braket
id|i
)braket
dot
id|next_ed
op_assign
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|hc_area-&gt;ed
(braket
id|j
op_plus
id|i
op_mod
id|j
)braket
)paren
)paren
suffix:semicolon
id|hc_area-&gt;ed
(braket
id|i
)braket
dot
id|info
op_or_assign
id|OHCI_ED_SKIP
suffix:semicolon
multiline_comment|/* place holder, skip it */
)brace
multiline_comment|/*&n;&t; * for load ballancing of the interrupt branches &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTS
suffix:semicolon
id|i
op_increment
)paren
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Store the end of control and bulk list eds. So, we know where we can add&n;&t; * elements to these lists.&n;&t; */
id|ohci-&gt;ed_isotail
op_assign
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
op_amp
(paren
id|hc_area-&gt;ed
(braket
id|ED_ISO
)braket
)paren
suffix:semicolon
id|ohci-&gt;ed_controltail
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_bulktail
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Tell the controller where the control and bulk lists are&n;&t; * The lists are empty now.&n;&t; */
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
id|USB_ALLOC
c_func
(paren
id|bus
comma
r_sizeof
(paren
op_star
id|bus
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|bus
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|bus
)paren
)paren
suffix:semicolon
id|ohci-&gt;bus
op_assign
id|bus
suffix:semicolon
id|bus-&gt;hcpriv
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
id|bus-&gt;op
op_assign
op_amp
id|sohci_device_operations
suffix:semicolon
id|usb
op_assign
id|sohci_usb_allocate
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb
)paren
r_return
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|ohci-&gt;root_hub
op_assign
id|usb_to_ohci
c_func
(paren
id|usb
)paren
suffix:semicolon
id|usb-&gt;bus
op_assign
id|bus
suffix:semicolon
multiline_comment|/* bus-&gt;root_hub = ohci_to_usb(ohci-&gt;root_hub); */
id|dev-&gt;ohci
op_assign
id|ohci
suffix:semicolon
multiline_comment|/* Initialize the root hub */
id|usb-&gt;maxchild
op_assign
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_amp
l_int|0xff
suffix:semicolon
id|usb_init_root_hub
c_func
(paren
id|usb
)paren
suffix:semicolon
r_return
id|ohci
suffix:semicolon
)brace
multiline_comment|/*&n; * De-allocate all resources..&n; */
DECL|function|release_ohci
r_static
r_void
id|release_ohci
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
r_int
id|i
suffix:semicolon
r_union
id|ep_addr_
id|ep_addr
suffix:semicolon
id|ep_addr.iep
op_assign
l_int|0
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC release ohci &bslash;n&quot;
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|ohci-&gt;irq
op_ge
l_int|0
)paren
(brace
id|free_irq
c_func
(paren
id|ohci-&gt;irq
comma
id|ohci
)paren
suffix:semicolon
id|ohci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* stop hc */
id|writel
c_func
(paren
id|OHCI_USB_SUSPEND
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* deallocate all EDs and TDs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ep_addr.bep.fa
op_assign
id|i
suffix:semicolon
id|usb_ohci_rm_function
c_func
(paren
id|ohci
comma
id|ep_addr.iep
)paren
suffix:semicolon
)brace
id|ohci_rm_eds
c_func
(paren
id|ohci
)paren
suffix:semicolon
multiline_comment|/* remove eds */
multiline_comment|/* disconnect all devices */
r_if
c_cond
(paren
id|ohci-&gt;root_hub
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;root_hub-&gt;usb-&gt;maxchild
suffix:semicolon
id|i
op_increment
)paren
(brace
id|usb_disconnect
c_func
(paren
id|ohci-&gt;root_hub-&gt;usb-&gt;children
op_plus
id|i
)paren
suffix:semicolon
)brace
id|USB_FREE
c_func
(paren
id|ohci-&gt;root_hub-&gt;usb
)paren
suffix:semicolon
id|USB_FREE
c_func
(paren
id|ohci-&gt;root_hub
)paren
suffix:semicolon
id|USB_FREE
c_func
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* unmap the IO address space */
id|iounmap
c_func
(paren
id|ohci-&gt;regs
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ohci-&gt;hc_area
comma
l_int|1
)paren
suffix:semicolon
)brace
r_void
id|cleanup_drivers
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|ohci_roothub_thread
r_static
r_int
id|ohci_roothub_thread
c_func
(paren
r_void
op_star
id|__ohci
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ohci
op_star
)paren
id|__ohci
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;         * This thread doesn&squot;t need any user-level access,&n;         * so get rid of all our resources..&n;         */
id|printk
c_func
(paren
l_string|&quot;ohci_roothub_thread at %p&bslash;n&quot;
comma
op_amp
id|ohci_roothub_thread
)paren
suffix:semicolon
id|exit_mm
c_func
(paren
id|current
)paren
suffix:semicolon
id|exit_files
c_func
(paren
id|current
)paren
suffix:semicolon
id|exit_fs
c_func
(paren
id|current
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;root-hub&quot;
)paren
suffix:semicolon
id|start_hc
c_func
(paren
id|ohci
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x10000
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* root hub power on */
r_do
(brace
macro_line|#ifdef CONFIG_APM
r_if
c_cond
(paren
id|apm_resume
)paren
(brace
id|apm_resume
op_assign
l_int|0
suffix:semicolon
id|start_hc
c_func
(paren
id|ohci
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB RH tasks: int: %x&bslash;n&quot;
comma
id|ohci-&gt;intrstatus
)paren
suffix:semicolon
)paren
macro_line|#ifndef VROOTHUB
multiline_comment|/*&t;if (ohci-&gt;intrstatus &amp; OHCI_INTR_RHSC)  */
(brace
r_int
id|port_nr
suffix:semicolon
r_for
c_loop
(paren
id|port_nr
op_assign
l_int|0
suffix:semicolon
id|port_nr
OL
id|ohci-&gt;root_hub-&gt;usb-&gt;maxchild
suffix:semicolon
id|port_nr
op_increment
)paren
r_if
c_cond
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|port_nr
)braket
)paren
op_amp
(paren
id|RH_PS_CSC
op_or
id|RH_PS_PRSC
)paren
)paren
(brace
id|ohci_connect_change
c_func
(paren
id|ohci
comma
id|port_nr
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0xffff0000
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|port_nr
)braket
)paren
suffix:semicolon
)brace
id|ohci-&gt;intrstatus
op_and_assign
op_complement
(paren
id|OHCI_INTR_RHSC
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_INTR_RHSC
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
)brace
macro_line|#endif
id|interruptible_sleep_on
c_func
(paren
op_amp
id|root_hub
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
)paren
suffix:semicolon
macro_line|#ifdef VROOTHUB
id|ohci_del_rh_int_timer
c_func
(paren
id|ohci
)paren
suffix:semicolon
macro_line|#endif
id|cleanup_drivers
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*  reset_hc(ohci); */
id|release_ohci
c_func
(paren
id|ohci
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ohci_control_thread exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Increment the module usage count, start the control thread and&n; * return success.&n; */
DECL|function|found_ohci
r_static
r_int
id|found_ohci
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|mem_base
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC found  ohci: irq= %d membase= %x &bslash;n&quot;
comma
id|irq
comma
(paren
r_int
)paren
id|mem_base
)paren
suffix:semicolon
)paren
multiline_comment|/* Allocate the running OHCI structures */
id|ohci
op_assign
id|alloc_ohci
c_func
(paren
id|mem_base
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|reset_hc
c_func
(paren
id|ohci
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|ohci_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;ohci-usb&quot;
comma
id|ohci
)paren
op_eq
l_int|0
)paren
(brace
r_int
id|pid
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|ohci-&gt;irq
op_assign
id|irq
suffix:semicolon
id|pid
op_assign
id|kernel_thread
c_func
(paren
id|ohci_roothub_thread
comma
id|ohci
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_SIGHAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pid
op_ge
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|retval
op_assign
id|pid
suffix:semicolon
)brace
id|release_ohci
c_func
(paren
id|ohci
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|start_ohci
r_static
r_int
id|start_ohci
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
r_int
id|mem_base
op_assign
id|dev-&gt;base_address
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* If its OHCI, its memory */
r_if
c_cond
(paren
id|mem_base
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Get the memory address and map it for IO */
id|mem_base
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
multiline_comment|/* &n;&t; * FIXME ioremap_nocache isn&squot;t implemented on all CPUs (such&n;&t; * as the Alpha) [?]  What should I use instead...&n;&t; *&n;&t; * The iounmap() is done on in release_ohci.&n;&t; */
id|mem_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap_nocache
c_func
(paren
id|mem_base
comma
l_int|4096
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Error mapping OHCI memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|found_ohci
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|mem_base
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_APM
DECL|function|handle_apm_event
r_static
r_int
id|handle_apm_event
c_func
(paren
id|apm_event_t
id|event
)paren
(brace
r_static
r_int
id|down
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|APM_SYS_SUSPEND
suffix:colon
r_case
id|APM_USER_SUSPEND
suffix:colon
r_if
c_cond
(paren
id|down
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ohci: received extra suspend event&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|down
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|APM_NORMAL_RESUME
suffix:colon
r_case
id|APM_CRITICAL_RESUME
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|down
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ohci: received bogus resume event&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|down
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|root_hub
)paren
)paren
(brace
id|apm_resume
op_assign
l_int|1
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|root_hub
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_int
id|usb_mouse_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_APM
id|apm_unregister_callback
c_func
(paren
op_amp
id|handle_apm_event
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|macro|ohci_hcd_init
mdefine_line|#define ohci_hcd_init init_module
macro_line|#endif
DECL|macro|PCI_CLASS_SERIAL_USB_OHCI
mdefine_line|#define PCI_CLASS_SERIAL_USB_OHCI 0x0C0310
DECL|macro|PCI_CLASS_SERIAL_USB_OHCI_PG
mdefine_line|#define PCI_CLASS_SERIAL_USB_OHCI_PG 0x10
DECL|function|ohci_hcd_init
r_int
id|ohci_hcd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_class
c_func
(paren
id|PCI_CLASS_SERIAL_USB_OHCI
comma
id|dev
)paren
)paren
)paren
(brace
multiline_comment|/* OHCI */
id|retval
op_assign
id|start_ohci
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_USB_MOUSE
id|usb_mouse_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_KBD&t;&t;
id|usb_kbd_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;
id|hub_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USB_AUDIO&t;&t;
id|usb_audio_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;
macro_line|#ifdef CONFIG_APM
id|apm_register_callback
c_func
(paren
op_amp
id|handle_apm_event
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|cleanup_drivers
r_void
id|cleanup_drivers
c_func
(paren
r_void
)paren
(brace
id|hub_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USB_MOUSE
id|usb_mouse_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
