multiline_comment|/*&n; * OHCI HCD (Host Controller Driver) for USB.&n; *&n; * (C) Copyright 1999 Roman Weissgaerber &lt;weissg@vienna.at&gt;&n; *&n; * The OHCI HCD layer is a simple but nearly complete implementation of what &n; * the USB people would call a HCD  for the OHCI. &n; * (ISO alpha , Bulk, INT u. CTRL transfers enabled)&n; * The layer on top of it, is for interfacing to the alternate-usb &n; * device-drivers.&n; * &n; * [ This is based on Linus&squot; UHCI code and gregs OHCI fragments &n; * (0.03c source tree). ]&n; * [ Open Host Controller Interface driver for USB. ]&n; * [ (C) Copyright 1999 Linus Torvalds (uhci.c) ]&n; * [ (C) Copyright 1999 Gregory P. Smith &lt;greg@electricrain.com&gt; ]&n; * &n; * v4.3 1999/10/27 multiple HCs, bulk_request&n; * v4.2 1999/09/05 ISO API alpha, new dev alloc, neg Error-codes&n; * v4.1 1999/08/27 Randy Dunlap&squot;s - ISO API first impl.&n; * v4.0 1999/08/18 &n; * v3.0 1999/06/25 &n; * v2.1 1999/05/09  code clean up&n; * v2.0 1999/05/04 &n; * virtual root hub is now enabled, &n; * memory allocation based on kmalloc and kfree now, Bus error handling, &n; * INT, CTRL and BULK transfers enabled, ISO needs testing (alpha)&n; * &n; * from Linus Torvalds (uhci.c) (APM not tested; hub, usb_device, bus and related stuff)&n; * from Greg Smith (ohci.c) (reset controller handling, hub)&n; * &n; * v1.0 1999/04/27 initial release&n; * ohci-hcd.c&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;ohci-hcd.h&quot;
macro_line|#ifdef CONFIG_APM
macro_line|#include &lt;linux/apm_bios.h&gt;
r_static
r_int
id|handle_apm_event
c_func
(paren
id|apm_event_t
id|event
)paren
suffix:semicolon
DECL|variable|apm_resume
r_static
r_int
id|apm_resume
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_static
id|LIST_HEAD
c_func
(paren
id|ohci_hcd_list
)paren
suffix:semicolon
r_static
r_int
id|ohci_link_ed
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_struct
id|usb_ohci_ed
op_star
id|ed
)paren
suffix:semicolon
r_static
r_int
id|sohci_kill_isoc
(paren
r_struct
id|usb_isoc_desc
op_star
id|id
)paren
suffix:semicolon
r_static
r_int
id|sohci_get_current_frame_number
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
suffix:semicolon
r_static
r_int
id|sohci_run_isoc
c_func
(paren
r_struct
id|usb_isoc_desc
op_star
id|id
comma
r_struct
id|usb_isoc_desc
op_star
id|pr_id
)paren
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|op_wakeup
)paren
suffix:semicolon
DECL|function|usb_pipe_to_hcd_ed
r_void
id|usb_pipe_to_hcd_ed
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
r_struct
id|usb_hcd_ed
op_star
id|hcd_ed
)paren
(brace
id|hcd_ed-&gt;endpoint
op_assign
id|usb_pipeendpoint
c_func
(paren
id|pipe
)paren
suffix:semicolon
id|hcd_ed-&gt;out
op_assign
id|usb_pipeout
c_func
(paren
id|pipe
)paren
suffix:semicolon
id|hcd_ed-&gt;function
op_assign
id|usb_pipedevice
c_func
(paren
id|pipe
)paren
suffix:semicolon
id|hcd_ed-&gt;type
op_assign
id|usb_pipetype
c_func
(paren
id|pipe
)paren
suffix:semicolon
id|hcd_ed-&gt;slow
op_assign
id|usb_pipeslow
c_func
(paren
id|pipe
)paren
suffix:semicolon
id|hcd_ed-&gt;maxpack
op_assign
id|usb_maxpacket
c_func
(paren
id|usb_dev
comma
id|pipe
comma
id|usb_pipeout
c_func
(paren
id|pipe
)paren
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;******* hcd_ed: pipe: %8x, endpoint: %4x, function: %4x, out: %4x, type: %4x, slow: %4x, maxpack: %4x&bslash;n&quot;
comma
id|pipe
comma
id|hcd_ed-&gt;endpoint
comma
id|hcd_ed-&gt;function
comma
id|hcd_ed-&gt;out
comma
id|hcd_ed-&gt;type
comma
id|hcd_ed-&gt;slow
comma
id|hcd_ed-&gt;maxpack
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;******* dev: devnum: %4x, slow: %4x, maxpacketsize: %4x&bslash;n&quot;
comma
id|usb_dev-&gt;devnum
comma
id|usb_dev-&gt;slow
comma
id|usb_dev-&gt;maxpacketsize
)paren
suffix:semicolon
)paren
)brace
multiline_comment|/********&n; **** Interface functions&n; ***********************************************/
DECL|function|sohci_blocking_handler
r_static
r_int
id|sohci_blocking_handler
c_func
(paren
r_void
op_star
id|ohci_in
comma
r_struct
id|usb_ohci_td
op_star
id|td
comma
r_void
op_star
id|data
comma
r_int
id|data_len
comma
r_int
id|dlen
comma
r_int
id|status
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
)paren
(brace
r_struct
id|usb_ohci_ed
op_star
id|ed
op_assign
id|td-&gt;ed
suffix:semicolon
r_if
c_cond
(paren
id|lw0
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
l_int|0
OL
l_int|0
op_logical_and
(paren
id|status
op_eq
id|USB_ST_DATAUNDERRUN
op_logical_or
id|status
op_eq
id|USB_ST_NOERROR
)paren
)paren
(brace
(paren
(paren
r_struct
id|ohci_state
op_star
)paren
id|lw0
)paren
op_member_access_from_pointer
id|status
op_assign
id|data_len
suffix:semicolon
)brace
r_else
(paren
(paren
r_struct
id|ohci_state
op_star
)paren
id|lw0
)paren
op_member_access_from_pointer
id|status
op_assign
id|status
suffix:semicolon
(paren
(paren
r_struct
id|ohci_state
op_star
)paren
id|lw0
)paren
op_member_access_from_pointer
id|len
op_assign
id|data_len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lw1
op_ne
l_int|NULL
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|op_wakeup
comma
id|lw1
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|op_wakeup
)paren
suffix:semicolon
)brace
id|OHCI_DEBUG
(paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC bh &lt;&lt;&lt;: %x: &quot;
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; data(%d):&quot;
comma
id|data_len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
(paren
id|printk
c_func
(paren
l_string|&quot; ret_status: %x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
)paren
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_int_handler
r_static
r_int
id|sohci_int_handler
c_func
(paren
r_void
op_star
id|ohci_in
comma
r_struct
id|usb_ohci_td
op_star
id|td
comma
r_void
op_star
id|data
comma
r_int
id|data_len
comma
r_int
id|dlen
comma
r_int
id|status
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
)paren
(brace
r_struct
id|usb_ohci_ed
op_star
id|ed
op_assign
id|td-&gt;ed
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
op_assign
id|ohci_in
suffix:semicolon
id|usb_device_irq
id|handler
op_assign
(paren
r_void
op_star
)paren
id|lw0
suffix:semicolon
r_void
op_star
id|dev_id
op_assign
(paren
r_void
op_star
)paren
id|lw1
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|OHCI_DEBUG
(paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC IRQ &lt;&lt;&lt;: %x: data(%d):&quot;
comma
id|ed-&gt;hwINFO
comma
id|data_len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
(paren
id|printk
c_func
(paren
l_string|&quot; ret_status: %x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
)paren
id|ret
op_assign
id|handler
c_func
(paren
id|status
comma
id|data
comma
id|data_len
comma
id|dev_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* 0 .. do not requeue  */
r_if
c_cond
(paren
id|status
OG
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* error occured do not requeue ? */
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ed
comma
l_int|0
comma
l_int|NULL
comma
id|data
comma
(paren
id|ed-&gt;hwINFO
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|__OHCI_BAG
)paren
id|handler
comma
(paren
id|__OHCI_BAG
)paren
id|dev_id
comma
id|INT_IN
comma
id|sohci_int_handler
)paren
suffix:semicolon
multiline_comment|/* requeue int request */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_ret_handler
r_static
r_int
id|sohci_ret_handler
c_func
(paren
r_void
op_star
id|ohci_in
comma
r_struct
id|usb_ohci_td
op_star
id|td
comma
r_void
op_star
id|data
comma
r_int
id|data_len
comma
r_int
id|dlen
comma
r_int
id|status
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
)paren
(brace
r_struct
id|usb_ohci_ed
op_star
id|ed
op_assign
id|td-&gt;ed
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
op_assign
id|ohci_in
suffix:semicolon
id|usb_device_irq
id|handler
op_assign
(paren
r_void
op_star
)paren
id|lw0
suffix:semicolon
r_void
op_star
id|dev_id
op_assign
(paren
r_void
op_star
)paren
id|lw1
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|OHCI_DEBUG
(paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC RET &lt;&lt;&lt;: %x: data(%d):&quot;
comma
id|ed-&gt;hwINFO
comma
id|data_len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
(paren
id|printk
c_func
(paren
l_string|&quot; ret_status: %x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
)paren
id|ret
op_assign
id|handler
c_func
(paren
id|status
comma
id|data
comma
id|data_len
comma
id|dev_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* 0 .. do not requeue  */
r_if
c_cond
(paren
id|status
OG
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* error occured do not requeue ? */
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ed
comma
l_int|0
comma
l_int|NULL
comma
id|data
comma
id|dlen
comma
(paren
id|__OHCI_BAG
)paren
id|handler
comma
(paren
id|__OHCI_BAG
)paren
id|dev_id
comma
id|td-&gt;type
op_amp
l_int|0x7
comma
id|sohci_ret_handler
)paren
suffix:semicolon
multiline_comment|/* requeue int request */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_iso_handler
r_static
r_int
id|sohci_iso_handler
c_func
(paren
r_void
op_star
id|ohci_in
comma
r_struct
id|usb_ohci_td
op_star
id|td
comma
r_void
op_star
id|data
comma
r_int
id|data_len
comma
r_int
id|dlen
comma
r_int
id|status
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
)paren
(brace
singleline_comment|// struct ohci * ohci = ohci_in; 
r_struct
id|usb_ohci_ed
op_star
id|ed
op_assign
id|td-&gt;ed
suffix:semicolon
r_int
r_int
id|ix
op_assign
(paren
r_int
r_int
)paren
id|lw0
suffix:semicolon
r_struct
id|usb_isoc_desc
op_star
id|id
op_assign
(paren
r_struct
id|usb_isoc_desc
op_star
)paren
id|lw1
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
op_star
id|tdp
op_assign
id|id-&gt;td
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|fx
suffix:semicolon
id|OHCI_DEBUG
(paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC ISO |||: %x: data(%d):&quot;
comma
id|ed-&gt;hwINFO
comma
id|data_len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
(paren
id|printk
c_func
(paren
l_string|&quot; ... ret_status: %x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
)paren
id|tdp
(braket
id|ix
)braket
op_assign
l_int|NULL
suffix:semicolon
id|id-&gt;frames
(braket
id|ix
)braket
dot
id|frame_length
op_assign
id|data_len
suffix:semicolon
id|id-&gt;frames
(braket
id|ix
)braket
dot
id|frame_status
op_assign
id|status
suffix:semicolon
id|id-&gt;total_length
op_add_assign
id|data_len
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|id-&gt;error_count
op_increment
suffix:semicolon
)brace
id|id-&gt;cur_completed_frame
op_increment
suffix:semicolon
id|id-&gt;total_completed_frames
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|id-&gt;cur_completed_frame
op_eq
id|id-&gt;callback_frames
)paren
(brace
id|id-&gt;prev_completed_frame
op_assign
id|id-&gt;cur_completed_frame
suffix:semicolon
id|id-&gt;cur_completed_frame
op_assign
l_int|0
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC ISO &lt;&lt;&lt;: %x: &bslash;n&quot;
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
)paren
id|ret
op_assign
id|id
op_member_access_from_pointer
id|callback_fn
c_func
(paren
id|id-&gt;error_count
comma
id|id-&gt;data
comma
id|id-&gt;total_length
comma
id|id
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|CB_CONT_RUN
suffix:colon
r_for
c_loop
(paren
id|fx
op_assign
l_int|0
suffix:semicolon
id|fx
OL
id|id-&gt;frame_count
suffix:semicolon
id|fx
op_increment
)paren
id|id-&gt;frames
(braket
id|fx
)braket
dot
id|frame_length
op_assign
id|id-&gt;frame_size
suffix:semicolon
id|sohci_run_isoc
c_func
(paren
id|id
comma
id|id-&gt;prev_isocdesc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CB_CONTINUE
suffix:colon
r_break
suffix:semicolon
r_case
id|CB_REUSE
suffix:colon
r_break
suffix:semicolon
r_case
id|CB_RESTART
suffix:colon
r_break
suffix:semicolon
r_case
id|CB_ABORT
suffix:colon
id|sohci_kill_isoc
c_func
(paren
id|id
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_request_irq
r_static
r_int
id|sohci_request_irq
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
id|usb_device_irq
id|handler
comma
r_int
id|period
comma
r_void
op_star
id|dev_id
comma
r_void
op_star
op_star
id|handle
comma
r_int
id|bustime
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
op_assign
id|usb_to_ohci
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
r_struct
id|usb_hcd_ed
id|hcd_ed
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
macro_line|#ifdef  VROOTHUB
r_if
c_cond
(paren
id|usb_pipedevice
c_func
(paren
id|pipe
)paren
op_eq
id|ohci-&gt;rh.devnum
)paren
(brace
r_return
id|root_hub_request_irq
c_func
(paren
id|usb_dev
comma
id|pipe
comma
id|handler
comma
id|period
comma
id|dev_id
comma
id|handle
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;
id|usb_pipe_to_hcd_ed
c_func
(paren
id|usb_dev
comma
id|pipe
comma
op_amp
id|hcd_ed
)paren
suffix:semicolon
id|hcd_ed.type
op_assign
id|INT
suffix:semicolon
id|ed
op_assign
id|usb_ohci_add_ep
c_func
(paren
id|usb_dev
comma
op_amp
id|hcd_ed
comma
id|period
comma
l_int|1
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC IRQ&gt;&gt;&gt;: %x: every %d ms&bslash;n&quot;
comma
id|ed-&gt;hwINFO
comma
id|period
)paren
suffix:semicolon
)paren
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ed
comma
l_int|0
comma
l_int|NULL
comma
id|dev-&gt;data
comma
id|hcd_ed.maxpack
comma
(paren
id|__OHCI_BAG
)paren
id|handler
comma
(paren
id|__OHCI_BAG
)paren
id|dev_id
comma
id|INT_IN
comma
id|sohci_int_handler
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ED_STATE
c_func
(paren
id|ed
)paren
op_ne
id|ED_OPER
)paren
id|ohci_link_ed
c_func
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
op_star
id|handle
op_assign
id|ed
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_release_irq
r_static
r_int
id|sohci_release_irq
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_void
op_star
id|ed
)paren
(brace
singleline_comment|// struct usb_device *usb_dev = ((struct ohci_device *) ((unsigned int)ed &amp; 0xfffff000))-&gt;usb;
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC ***** RM_IRQ&gt;&gt;&gt;:%4x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ed
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|ed
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef  VROOTHUB
r_if
c_cond
(paren
id|ed
op_eq
id|ohci-&gt;rh.int_addr
)paren
(brace
r_return
id|root_hub_release_irq
c_func
(paren
id|usb_dev
comma
id|ed
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;
id|ED_setSTATE
c_func
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|ed
comma
id|ED_STOP
)paren
suffix:semicolon
id|usb_ohci_rm_ep
c_func
(paren
id|usb_dev
comma
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|ed
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_control_msg
r_static
r_int
id|sohci_control_msg
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
id|devrequest
op_star
id|cmd
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
r_int
id|timeout
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|ohci_state
id|state
op_assign
(brace
l_int|0
comma
id|TD_NOTACCESSED
)brace
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|usb_hcd_ed
id|hcd_ed
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
macro_line|#ifdef  VROOTHUB
r_if
c_cond
(paren
id|usb_pipedevice
c_func
(paren
id|pipe
)paren
op_eq
id|ohci-&gt;rh.devnum
)paren
(brace
r_return
id|root_hub_control_msg
c_func
(paren
id|usb_dev
comma
id|pipe
comma
id|cmd
comma
id|data
comma
id|len
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;
id|usb_pipe_to_hcd_ed
c_func
(paren
id|usb_dev
comma
id|pipe
comma
op_amp
id|hcd_ed
)paren
suffix:semicolon
id|hcd_ed.type
op_assign
id|CTRL
suffix:semicolon
id|ed
op_assign
id|usb_ohci_add_ep
c_func
(paren
id|usb_dev
comma
op_amp
id|hcd_ed
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|OHCI_DEBUG
(paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC CTRL&gt;&gt;&gt;: ed:%x-%x: ctrl(%d):&quot;
comma
(paren
r_int
r_int
)paren
id|ed
comma
id|ed-&gt;hwINFO
comma
l_int|8
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|cmd
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; data(%d):&quot;
comma
id|len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
(paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)paren
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ed
comma
l_int|8
comma
id|cmd
comma
id|data
comma
id|len
comma
(paren
id|__OHCI_BAG
)paren
op_amp
id|state
comma
(paren
id|__OHCI_BAG
)paren
op_amp
id|wait
comma
(paren
id|usb_pipeout
c_func
(paren
id|pipe
)paren
)paren
ques
c_cond
id|CTRL_OUT
suffix:colon
id|CTRL_IN
comma
id|sohci_blocking_handler
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC trans req ed %x: %x :&quot;
comma
id|ed-&gt;hwINFO
comma
(paren
r_int
r_int
)paren
id|ed
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
(brace
r_int
id|i
suffix:semicolon
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %4x&quot;
comma
(paren
(paren
r_int
r_int
op_star
)paren
id|ed
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
)paren
r_if
c_cond
(paren
id|ED_STATE
c_func
(paren
id|ed
)paren
op_ne
id|ED_OPER
)paren
id|ohci_link_ed
c_func
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state.status
op_eq
id|TD_NOTACCESSED
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|usb_ohci_rm_ep
c_func
(paren
id|usb_dev
comma
id|ed
comma
id|sohci_blocking_handler
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|state.status
op_assign
id|USB_ST_TIMEOUT
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|op_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
id|state.status
suffix:semicolon
)brace
DECL|function|sohci_bulk_msg
r_static
r_int
id|sohci_bulk_msg
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
r_int
r_int
op_star
id|rval
comma
r_int
id|timeout
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|ohci_state
id|state
op_assign
(brace
l_int|0
comma
id|TD_NOTACCESSED
)brace
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|usb_hcd_ed
id|hcd_ed
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
id|usb_pipe_to_hcd_ed
c_func
(paren
id|usb_dev
comma
id|pipe
comma
op_amp
id|hcd_ed
)paren
suffix:semicolon
id|hcd_ed.type
op_assign
id|BULK
suffix:semicolon
id|ed
op_assign
id|usb_ohci_add_ep
c_func
(paren
id|usb_dev
comma
op_amp
id|hcd_ed
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|OHCI_DEBUG
(paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB HC BULK&gt;&gt;&gt;: %x: &quot;
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot; data(%d):&quot;
comma
id|len
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
r_for
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|data
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
(paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)paren
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ed
comma
l_int|0
comma
l_int|NULL
comma
id|data
comma
id|len
comma
(paren
id|__OHCI_BAG
)paren
op_amp
id|state
comma
(paren
id|__OHCI_BAG
)paren
op_amp
id|wait
comma
(paren
id|usb_pipeout
c_func
(paren
id|pipe
)paren
)paren
ques
c_cond
id|BULK_OUT
suffix:colon
id|BULK_IN
comma
id|sohci_blocking_handler
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ED_STATE
c_func
(paren
id|ed
)paren
op_ne
id|ED_OPER
)paren
id|ohci_link_ed
c_func
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state.status
op_eq
id|TD_NOTACCESSED
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|usb_ohci_rm_ep
c_func
(paren
id|usb_dev
comma
id|ed
comma
id|sohci_blocking_handler
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|state.status
op_assign
id|USB_ST_TIMEOUT
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|op_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
op_star
id|rval
op_assign
id|state.len
suffix:semicolon
r_return
id|state.status
suffix:semicolon
)brace
DECL|function|sohci_request_bulk
r_static
r_void
op_star
id|sohci_request_bulk
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
id|usb_device_irq
id|handler
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|usb_hcd_ed
id|hcd_ed
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
id|usb_pipe_to_hcd_ed
c_func
(paren
id|usb_dev
comma
id|pipe
comma
op_amp
id|hcd_ed
)paren
suffix:semicolon
id|hcd_ed.type
op_assign
id|BULK
suffix:semicolon
id|ed
op_assign
id|usb_ohci_add_ep
c_func
(paren
id|usb_dev
comma
op_amp
id|hcd_ed
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC BULK_RQ&gt;&gt;&gt;: %x &bslash;n&quot;
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
)paren
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ed
comma
l_int|0
comma
l_int|NULL
comma
id|data
comma
id|len
comma
(paren
id|__OHCI_BAG
)paren
id|handler
comma
(paren
id|__OHCI_BAG
)paren
id|dev_id
comma
(paren
id|usb_pipeout
c_func
(paren
id|pipe
)paren
)paren
ques
c_cond
id|BULK_OUT
suffix:colon
id|BULK_IN
comma
id|sohci_ret_handler
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ED_STATE
c_func
(paren
id|ed
)paren
op_ne
id|ED_OPER
)paren
id|ohci_link_ed
c_func
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
r_return
id|ed
suffix:semicolon
)brace
DECL|function|sohci_terminate_bulk
r_static
r_int
id|sohci_terminate_bulk
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_void
op_star
id|ed
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC TERM_BULK&gt;&gt;&gt;:%4x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ed
)paren
suffix:semicolon
)paren
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|usb_ohci_rm_ep
c_func
(paren
id|usb_dev
comma
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|ed
comma
id|sohci_blocking_handler
comma
l_int|NULL
comma
op_amp
id|wait
comma
id|SEND
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|op_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sohci_alloc_dev
r_static
r_int
id|sohci_alloc_dev
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* Allocate the OHCI_HCD device private data */
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Initialize &quot;dev&quot; */
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|usb_dev-&gt;hcpriv
op_assign
id|dev
suffix:semicolon
id|dev-&gt;usb
op_assign
id|usb_dev
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_dev-&gt;parent
)paren
id|dev-&gt;ohci
op_assign
id|usb_to_ohci
c_func
(paren
id|usb_dev-&gt;parent
)paren
op_member_access_from_pointer
id|ohci
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_free_dev
r_static
r_int
id|sohci_free_dev
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
op_assign
id|usb_to_ohci
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC ***** free %x&bslash;n&quot;
comma
id|usb_dev-&gt;devnum
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|usb_dev-&gt;devnum
op_ge
l_int|0
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|cnt
op_assign
id|usb_ohci_rm_function
c_func
(paren
id|usb_dev
comma
id|sohci_blocking_handler
comma
l_int|NULL
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
l_int|0
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|op_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|dev-&gt;refcnt
)paren
)paren
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ISO Interface designed by Randy Dunlap&n; */
DECL|function|sohci_get_current_frame_number
r_static
r_int
id|sohci_get_current_frame_number
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_return
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;fmnumber
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
DECL|function|sohci_init_isoc
r_static
r_int
id|sohci_init_isoc
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
r_int
id|frame_count
comma
r_void
op_star
id|context
comma
r_struct
id|usb_isoc_desc
op_star
op_star
id|idp
)paren
(brace
r_struct
id|usb_isoc_desc
op_star
id|id
suffix:semicolon
op_star
id|idp
op_assign
l_int|NULL
suffix:semicolon
id|id
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|usb_isoc_desc
)paren
op_plus
(paren
r_sizeof
(paren
r_struct
id|isoc_frame_desc
)paren
op_star
id|frame_count
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|id
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|id
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|usb_isoc_desc
)paren
op_plus
(paren
r_sizeof
(paren
r_struct
id|isoc_frame_desc
)paren
op_star
id|frame_count
)paren
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ISO alloc id: %p, size: %d&bslash;n&quot;
comma
id|id
comma
r_sizeof
(paren
r_struct
id|usb_isoc_desc
)paren
op_plus
(paren
r_sizeof
(paren
r_struct
id|isoc_frame_desc
)paren
op_star
id|frame_count
)paren
)paren
suffix:semicolon
)paren
id|id-&gt;td
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_void
op_star
)paren
op_star
id|frame_count
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|id-&gt;td
)paren
(brace
id|kfree
(paren
id|id
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|id-&gt;td
comma
l_int|0
comma
r_sizeof
(paren
r_void
op_star
)paren
op_star
id|frame_count
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ISO alloc id-&gt;td: %p, size: %d&bslash;n&quot;
comma
id|id-&gt;td
comma
r_sizeof
(paren
r_void
op_star
)paren
op_star
id|frame_count
)paren
suffix:semicolon
)paren
id|id-&gt;frame_count
op_assign
id|frame_count
suffix:semicolon
id|id-&gt;frame_size
op_assign
id|usb_maxpacket
(paren
id|usb_dev
comma
id|pipe
comma
id|usb_pipeout
c_func
(paren
id|pipe
)paren
)paren
suffix:semicolon
id|id-&gt;start_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|id-&gt;end_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|id-&gt;usb_dev
op_assign
id|usb_dev
suffix:semicolon
id|id-&gt;pipe
op_assign
id|pipe
suffix:semicolon
id|id-&gt;context
op_assign
id|context
suffix:semicolon
op_star
id|idp
op_assign
id|id
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
id|print_int_eds
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
suffix:semicolon
DECL|function|sohci_run_isoc
r_static
r_int
id|sohci_run_isoc
c_func
(paren
r_struct
id|usb_isoc_desc
op_star
id|id
comma
r_struct
id|usb_isoc_desc
op_star
id|pr_id
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|id-&gt;usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
op_star
id|tdp
op_assign
(paren
r_struct
id|usb_ohci_td
op_star
op_star
)paren
id|id-&gt;td
suffix:semicolon
r_struct
id|usb_hcd_ed
id|hcd_ed
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
r_int
id|ix
comma
id|frlen
suffix:semicolon
r_int
r_char
op_star
id|bufptr
suffix:semicolon
r_if
c_cond
(paren
id|pr_id
)paren
(brace
id|id-&gt;start_frame
op_assign
id|pr_id-&gt;end_frame
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|id-&gt;start_type
)paren
(brace
r_case
id|START_ABSOLUTE
suffix:colon
r_break
suffix:semicolon
r_case
id|START_RELATIVE
suffix:colon
r_if
c_cond
(paren
id|id-&gt;start_frame
OL
id|START_FRAME_FUDGE
)paren
(brace
id|id-&gt;start_frame
op_assign
id|START_FRAME_FUDGE
suffix:semicolon
)brace
id|id-&gt;start_frame
op_add_assign
id|sohci_get_current_frame_number
c_func
(paren
id|id-&gt;usb_dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|START_ASAP
suffix:colon
id|id-&gt;start_frame
op_assign
id|START_FRAME_FUDGE
op_plus
id|sohci_get_current_frame_number
c_func
(paren
id|id-&gt;usb_dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|id-&gt;start_frame
op_and_assign
l_int|0xffff
suffix:semicolon
id|id-&gt;end_frame
op_assign
(paren
id|id-&gt;start_frame
op_plus
id|id-&gt;frame_count
op_minus
l_int|1
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|id-&gt;prev_completed_frame
op_assign
l_int|0
suffix:semicolon
id|id-&gt;cur_completed_frame
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|id-&gt;frame_spacing
op_le
l_int|0
)paren
id|id-&gt;frame_spacing
op_assign
l_int|1
suffix:semicolon
id|bufptr
op_assign
id|id-&gt;data
suffix:semicolon
id|usb_pipe_to_hcd_ed
c_func
(paren
id|id-&gt;usb_dev
comma
id|id-&gt;pipe
comma
op_amp
id|hcd_ed
)paren
suffix:semicolon
id|hcd_ed.type
op_assign
id|ISO
suffix:semicolon
id|ed
op_assign
id|usb_ohci_add_ep
c_func
(paren
id|id-&gt;usb_dev
comma
op_amp
id|hcd_ed
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC ISO&gt;&gt;&gt;: ed: %x-%x: (%d tds)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ed
comma
id|ed-&gt;hwINFO
comma
id|id-&gt;frame_count
)paren
suffix:semicolon
)paren
r_for
c_loop
(paren
id|ix
op_assign
l_int|0
suffix:semicolon
id|ix
OL
id|id-&gt;frame_count
suffix:semicolon
id|ix
op_increment
)paren
(brace
id|frlen
op_assign
(paren
id|id-&gt;frames
(braket
id|ix
)braket
dot
id|frame_length
OG
id|id-&gt;frame_size
)paren
ques
c_cond
id|id-&gt;frame_size
suffix:colon
id|id-&gt;frames
(braket
id|ix
)braket
dot
id|frame_length
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ISO run id-&gt;td: %p &bslash;n&quot;
comma
op_amp
id|tdp
(braket
id|ix
)braket
)paren
suffix:semicolon
id|tdp
(braket
id|ix
)braket
op_assign
id|ohci_trans_req
c_func
(paren
id|ohci
comma
id|ed
comma
id|id-&gt;start_frame
op_plus
id|ix
comma
l_int|NULL
comma
id|bufptr
comma
id|frlen
comma
(paren
id|__OHCI_BAG
)paren
id|ix
comma
(paren
id|__OHCI_BAG
)paren
id|id
comma
(paren
id|usb_pipeout
c_func
(paren
id|id-&gt;pipe
)paren
)paren
ques
c_cond
id|ISO_OUT
suffix:colon
id|ISO_IN
comma
id|sohci_iso_handler
)paren
suffix:semicolon
id|bufptr
op_add_assign
id|frlen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ED_STATE
c_func
(paren
id|ed
)paren
op_ne
id|ED_OPER
)paren
id|ohci_link_ed
c_func
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
id|print_int_eds
c_func
(paren
id|ohci
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_kill_isoc
r_static
r_int
id|sohci_kill_isoc
c_func
(paren
r_struct
id|usb_isoc_desc
op_star
id|id
)paren
(brace
r_struct
id|usb_ohci_ed
op_star
id|ed
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
op_star
id|td
op_assign
id|id-&gt;td
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|id-&gt;frame_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|td
(braket
id|i
)braket
)paren
(brace
id|td
(braket
id|i
)braket
op_member_access_from_pointer
id|type
op_or_assign
id|DEL
suffix:semicolon
id|ed
op_assign
id|td
(braket
id|i
)braket
op_member_access_from_pointer
id|ed
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %d&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ed
)paren
(brace
id|usb_ohci_rm_ep
c_func
(paren
id|id-&gt;usb_dev
comma
id|ed
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
id|TD_RM
)paren
suffix:semicolon
)brace
id|id-&gt;start_frame
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sohci_free_isoc
r_static
r_void
id|sohci_free_isoc
c_func
(paren
r_struct
id|usb_isoc_desc
op_star
id|id
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;start_frame
op_ge
l_int|0
)paren
(brace
id|sohci_kill_isoc
c_func
(paren
id|id
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|id-&gt;td
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|id
)paren
suffix:semicolon
)brace
DECL|variable|sohci_device_operations
r_struct
id|usb_operations
id|sohci_device_operations
op_assign
(brace
id|sohci_alloc_dev
comma
id|sohci_free_dev
comma
id|sohci_control_msg
comma
id|sohci_bulk_msg
comma
id|sohci_request_irq
comma
id|sohci_release_irq
comma
id|sohci_request_bulk
comma
id|sohci_terminate_bulk
comma
id|sohci_get_current_frame_number
comma
id|sohci_init_isoc
comma
id|sohci_free_isoc
comma
id|sohci_run_isoc
comma
id|sohci_kill_isoc
)brace
suffix:semicolon
multiline_comment|/******&n; *** ED handling functions&n; ************************************/
multiline_comment|/* just for debugging; prints all 32 branches of the int ed tree inclusive iso eds*/
DECL|function|print_int_eds
r_void
id|print_int_eds
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
r_int
id|i
suffix:semicolon
id|__u32
op_star
id|ed_p
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;branch int %2d(%2x): &quot;
comma
id|i
comma
id|i
)paren
suffix:semicolon
)paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hc_area-&gt;hcca.int_table
(braket
id|i
)braket
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|ed_p
op_ne
l_int|0
)paren
(brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ed: %4x; &quot;
comma
(paren
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|hwINFO
)paren
)paren
suffix:semicolon
)paren
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
suffix:semicolon
)brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)paren
)brace
)brace
multiline_comment|/* &n; * search for the right branch to insert an interrupt ed into the int tree &n; * do some load ballancing &n; * returns the branch and &n; * sets the interval to interval = 2^integer(ld(interval))&n; * */
DECL|function|usb_ohci_int_ballance
r_static
r_int
id|usb_ohci_int_ballance
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_int
op_star
id|interval
comma
r_int
id|load
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* search for the least loaded interrupt endpoint branch of all 32 branches */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ohci-&gt;ohci_int_load
(braket
id|j
)braket
OG
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
)paren
(brace
id|j
op_assign
id|i
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
op_star
id|interval
op_rshift
id|i
)paren
OG
l_int|1
)paren
op_logical_and
(paren
id|i
OL
l_int|5
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* interval = 2^int(ld(interval)) */
op_star
id|interval
op_assign
l_int|1
op_lshift
id|i
suffix:semicolon
id|j
op_assign
id|j
op_mod
(paren
op_star
id|interval
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|j
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
(paren
op_star
id|interval
)paren
)paren
(brace
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_add_assign
id|load
suffix:semicolon
)brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC new int ed on pos %d of interval %d &bslash;n&quot;
comma
id|j
comma
op_star
id|interval
)paren
suffix:semicolon
)paren
r_return
id|j
suffix:semicolon
)brace
multiline_comment|/* the int tree is a binary tree &n; * in order to process it sequentially the indexes of the branches have to be mapped &n; * the mapping reverses the bits of a word of num_bits length&n; * */
DECL|function|rev
r_static
r_int
id|rev
c_func
(paren
r_int
id|num_bits
comma
r_int
id|word
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|wout
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_bits
suffix:semicolon
id|i
op_increment
)paren
(brace
id|wout
op_or_assign
(paren
(paren
(paren
id|word
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
op_lshift
(paren
id|num_bits
op_minus
id|i
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_return
id|wout
suffix:semicolon
)brace
multiline_comment|/* get the ed from the endpoint / usb_device address */
DECL|function|ohci_find_ep
r_struct
id|usb_ohci_ed
op_star
id|ohci_find_ep
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_struct
id|usb_hcd_ed
op_star
id|hcd_ed
)paren
(brace
r_return
op_amp
(paren
id|usb_to_ohci
c_func
(paren
id|usb_dev
)paren
op_member_access_from_pointer
id|ed
(braket
(paren
id|hcd_ed-&gt;endpoint
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|hcd_ed-&gt;type
op_eq
id|CTRL
)paren
ques
c_cond
l_int|0
suffix:colon
id|hcd_ed-&gt;out
)paren
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* link an ed into one of the HC chains */
DECL|function|ohci_link_ed
r_static
r_int
id|ohci_link_ed
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_struct
id|usb_ohci_ed
op_star
id|ed
)paren
(brace
r_int
id|int_branch
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|inter
suffix:semicolon
r_int
id|interval
suffix:semicolon
r_int
id|load
suffix:semicolon
id|__u32
op_star
id|ed_p
suffix:semicolon
id|ED_setSTATE
c_func
(paren
id|ed
comma
id|ED_OPER
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ED_TYPE
c_func
(paren
id|ed
)paren
)paren
(brace
r_case
id|CTRL
suffix:colon
id|ed-&gt;hwNextED
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|ed
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;ed_controltail-&gt;hwNextED
op_assign
id|virt_to_bus
c_func
(paren
id|ed
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_controltail
suffix:semicolon
id|ohci-&gt;ed_controltail
op_assign
id|ed
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BULK
suffix:colon
id|ed-&gt;hwNextED
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
id|ed
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;ed_bulktail-&gt;hwNextED
op_assign
id|virt_to_bus
c_func
(paren
id|ed
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_bulktail
suffix:semicolon
id|ohci-&gt;ed_bulktail
op_assign
id|ed
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT
suffix:colon
id|interval
op_assign
id|ed-&gt;int_period
suffix:semicolon
id|load
op_assign
id|ed-&gt;int_load
suffix:semicolon
id|int_branch
op_assign
id|usb_ohci_int_ballance
c_func
(paren
id|ohci
comma
op_amp
id|interval
comma
id|load
)paren
suffix:semicolon
id|ed-&gt;int_interval
op_assign
id|interval
suffix:semicolon
id|ed-&gt;int_branch
op_assign
id|int_branch
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rev
c_func
(paren
l_int|6
comma
id|interval
)paren
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
id|inter
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hc_area-&gt;hcca.int_table
(braket
id|rev
c_func
(paren
l_int|5
comma
id|i
)paren
op_plus
id|int_branch
)braket
)paren
suffix:semicolon
(paren
op_star
id|ed_p
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|int_interval
op_ge
id|interval
)paren
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
)paren
(brace
id|inter
op_assign
id|rev
c_func
(paren
l_int|6
comma
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
suffix:semicolon
)brace
id|ed-&gt;hwNextED
op_assign
op_star
id|ed_p
suffix:semicolon
op_star
id|ed_p
op_assign
id|virt_to_bus
c_func
(paren
id|ed
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;int_link i: %2x, inter: %2x, ed: %4x&bslash;n&quot;
comma
id|i
comma
id|inter
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
)paren
)brace
r_break
suffix:semicolon
r_case
id|ISO
suffix:colon
r_if
c_cond
(paren
id|ohci-&gt;ed_isotail
op_ne
l_int|NULL
)paren
(brace
id|ohci-&gt;ed_isotail-&gt;hwNextED
op_assign
id|virt_to_bus
c_func
(paren
id|ed
)paren
suffix:semicolon
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_isotail
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
id|inter
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hc_area-&gt;hcca.int_table
(braket
id|rev
c_func
(paren
l_int|5
comma
id|i
)paren
)braket
)paren
suffix:semicolon
op_star
id|ed_p
op_ne
l_int|0
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
)paren
(brace
id|inter
op_assign
id|rev
c_func
(paren
l_int|6
comma
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
suffix:semicolon
)brace
op_star
id|ed_p
op_assign
id|virt_to_bus
c_func
(paren
id|ed
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ed-&gt;hwNextED
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;ed_isotail
op_assign
id|ed
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* unlink an ed from one of the HC chains. &n; * just the link to the ed is unlinked.&n; * the link from the ed still points to another operational ed or 0&n; * so the HC can eventually finish the processing of the unlinked ed&n; * */
DECL|function|ohci_unlink_ed
r_static
r_int
id|ohci_unlink_ed
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_struct
id|usb_ohci_ed
op_star
id|ed
)paren
(brace
r_int
id|int_branch
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|inter
suffix:semicolon
r_int
id|interval
suffix:semicolon
id|__u32
op_star
id|ed_p
suffix:semicolon
r_switch
c_cond
(paren
id|ED_TYPE
c_func
(paren
id|ed
)paren
)paren
(brace
r_case
id|CTRL
suffix:colon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|ed-&gt;hwNextED
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ed-&gt;ed_prev-&gt;hwNextED
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_controltail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
id|ed-&gt;hwNextED
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BULK
suffix:colon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_eq
l_int|NULL
)paren
(brace
id|writel
c_func
(paren
id|ed-&gt;hwNextED
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ed-&gt;ed_prev-&gt;hwNextED
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_bulktail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
id|ed-&gt;hwNextED
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|INT
suffix:colon
id|int_branch
op_assign
id|ed-&gt;int_branch
suffix:semicolon
id|interval
op_assign
id|ed-&gt;int_interval
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rev
c_func
(paren
l_int|6
comma
id|interval
)paren
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hc_area-&gt;hcca.int_table
(braket
id|rev
c_func
(paren
l_int|5
comma
id|i
)paren
op_plus
id|int_branch
)braket
)paren
comma
id|inter
op_assign
l_int|1
suffix:semicolon
(paren
op_star
id|ed_p
op_ne
l_int|0
)paren
op_logical_and
(paren
op_star
id|ed_p
op_ne
id|ed-&gt;hwNextED
)paren
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
comma
id|inter
op_assign
id|rev
c_func
(paren
l_int|6
comma
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_eq
id|ed
)paren
(brace
op_star
id|ed_p
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;int_link i: %2x, inter: %2x, ed: %4x&bslash;n&quot;
comma
id|i
comma
id|inter
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
)paren
)brace
r_for
c_loop
(paren
id|i
op_assign
id|int_branch
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|interval
)paren
(brace
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_sub_assign
id|ed-&gt;int_load
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISO
suffix:colon
r_if
c_cond
(paren
id|ohci-&gt;ed_isotail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_isotail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ed-&gt;hwNextED
op_ne
l_int|0
)paren
(brace
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
id|ed-&gt;hwNextED
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_ne
l_int|NULL
)paren
(brace
id|ed-&gt;ed_prev-&gt;hwNextED
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
id|inter
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hc_area-&gt;hcca.int_table
(braket
id|rev
c_func
(paren
l_int|5
comma
id|i
)paren
)braket
)paren
suffix:semicolon
op_star
id|ed_p
op_ne
l_int|0
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
)paren
(brace
id|inter
op_assign
id|rev
c_func
(paren
l_int|6
comma
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_struct
id|usb_ohci_ed
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|ed_p
)paren
)paren
op_eq
id|ed
)paren
(brace
op_star
id|ed_p
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_break
suffix:semicolon
)brace
id|ED_setSTATE
c_func
(paren
id|ed
comma
id|ED_UNLINK
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|usb_ed_lock
id|spinlock_t
id|usb_ed_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* add/reinit an endpoint; this should be done once at the usb_set_configuration command,&n; * but the USB stack is a little bit stateless  so we do it at every transaction&n; * if the state of the ed is ED_NEW then a dummy td is added and the state is changed to ED_UNLINK&n; * in all other cases the state is left unchanged&n; * the ed info fields are setted anyway even though they should not change&n; * */
DECL|function|usb_ohci_add_ep
r_struct
id|usb_ohci_ed
op_star
id|usb_ohci_add_ep
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_struct
id|usb_hcd_ed
op_star
id|hcd_ed
comma
r_int
id|interval
comma
r_int
id|load
)paren
(brace
singleline_comment|// struct ohci * ohci = usb_dev-&gt;bus-&gt;hcpriv;
r_struct
id|usb_ohci_td
op_star
id|td
suffix:semicolon
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
r_int
id|ed_state
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|usb_ed_lock
)paren
suffix:semicolon
id|ed
op_assign
id|ohci_find_ep
c_func
(paren
id|usb_dev
comma
id|hcd_ed
)paren
suffix:semicolon
id|ed_state
op_assign
id|ED_STATE
c_func
(paren
id|ed
)paren
suffix:semicolon
multiline_comment|/* store state of ed */
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC add ed %x: %x :state: %x&bslash;n&quot;
comma
id|ed-&gt;hwINFO
comma
(paren
r_int
r_int
)paren
id|ed
comma
id|ed_state
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|ed_state
op_eq
id|ED_NEW
)paren
(brace
id|OHCI_ALLOC
c_func
(paren
id|td
comma
r_sizeof
(paren
op_star
id|td
)paren
)paren
suffix:semicolon
multiline_comment|/* dummy td; end of td list for ed */
id|ed-&gt;hwTailP
op_assign
id|virt_to_bus
c_func
(paren
id|td
)paren
suffix:semicolon
id|ed-&gt;hwHeadP
op_assign
id|ed-&gt;hwTailP
suffix:semicolon
id|ed_state
op_assign
id|ED_UNLINK
suffix:semicolon
)brace
id|ed-&gt;hwINFO
op_assign
id|hcd_ed-&gt;function
op_or
id|hcd_ed-&gt;endpoint
op_lshift
l_int|7
op_or
(paren
id|hcd_ed-&gt;type
op_eq
id|ISO
ques
c_cond
l_int|0x8000
suffix:colon
l_int|0
)paren
op_or
(paren
id|hcd_ed-&gt;type
op_eq
id|CTRL
ques
c_cond
l_int|0
suffix:colon
(paren
id|hcd_ed-&gt;out
op_eq
l_int|1
ques
c_cond
l_int|0x800
suffix:colon
l_int|0x1000
)paren
)paren
op_or
id|hcd_ed-&gt;slow
op_lshift
l_int|13
op_or
id|hcd_ed-&gt;maxpack
op_lshift
l_int|16
op_or
id|hcd_ed-&gt;type
op_lshift
l_int|27
singleline_comment|//&t;&t;| 1 &lt;&lt; 14
op_or
id|ed_state
op_lshift
l_int|29
suffix:semicolon
r_if
c_cond
(paren
id|ED_TYPE
c_func
(paren
id|ed
)paren
op_eq
id|INT
op_logical_and
id|ed_state
op_eq
id|ED_UNLINK
)paren
(brace
id|ed-&gt;int_period
op_assign
id|interval
suffix:semicolon
id|ed-&gt;int_load
op_assign
id|load
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|usb_ed_lock
)paren
suffix:semicolon
r_return
id|ed
suffix:semicolon
)brace
multiline_comment|/*****&n; * Request the removal of an endpoint&n; * &n; * put the ep on the rm_list and request a stop of the bulk or ctrl list &n; * real removal is done at the next start of frame (SOF) hardware interrupt &n; * the dummy td carries the essential information (handler, proc queue, ...)&n; * if(send &amp; TD_RM) then just the TD witch have (TD-&gt;type &amp; DEL) set will be removed&n; * otherwise all TDs including the dummy TD of the ED will be removed&n; */
DECL|function|usb_ohci_rm_ep
r_int
id|usb_ohci_rm_ep
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_struct
id|usb_ohci_ed
op_star
id|ed
comma
id|f_handler
id|handler
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
comma
r_int
id|send
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC remove ed %x: %x :&bslash;n&quot;
comma
id|ed-&gt;hwINFO
comma
(paren
r_int
r_int
)paren
id|ed
)paren
suffix:semicolon
)paren
id|spin_lock_irqsave
c_func
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|ed-&gt;hwINFO
op_or_assign
id|OHCI_ED_SKIP
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
multiline_comment|/* enable sof interrupt */
r_if
c_cond
(paren
id|send
op_amp
id|TD_RM
)paren
(brace
multiline_comment|/* delete selected TDs */
id|ED_setSTATE
c_func
(paren
id|ed
comma
id|ED_TD_DEL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* delete all TDS */
r_if
c_cond
(paren
id|ED_STATE
c_func
(paren
id|ed
)paren
op_eq
id|ED_OPER
)paren
(brace
id|ohci_unlink_ed
c_func
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
)brace
id|td
op_assign
(paren
r_struct
id|usb_ohci_td
op_star
)paren
id|bus_to_virt
c_func
(paren
id|ed-&gt;hwTailP
)paren
suffix:semicolon
id|td-&gt;lw0
op_assign
id|lw0
suffix:semicolon
id|td-&gt;lw1
op_assign
id|lw1
suffix:semicolon
id|td-&gt;ed
op_assign
id|ed
suffix:semicolon
id|td-&gt;hwINFO
op_assign
id|TD_CC
suffix:semicolon
id|td-&gt;handler
op_assign
id|handler
suffix:semicolon
id|td-&gt;type
op_assign
id|send
suffix:semicolon
id|ED_setSTATE
c_func
(paren
id|ed
comma
id|ED_DEL
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_rm_list
suffix:semicolon
id|ohci-&gt;ed_rm_list
op_assign
id|ed
suffix:semicolon
r_switch
c_cond
(paren
id|ED_TYPE
c_func
(paren
id|ed
)paren
)paren
(brace
r_case
id|CTRL
suffix:colon
id|writel_mask
c_func
(paren
op_complement
(paren
l_int|0x01
op_lshift
l_int|4
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* stop CTRL list */
r_break
suffix:semicolon
r_case
id|BULK
suffix:colon
id|writel_mask
c_func
(paren
op_complement
(paren
l_int|0x01
op_lshift
l_int|5
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* stop BULK list */
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* remove all endpoints of a function (device) &n; * just the last ed sends a reply&n; * the last ed is ed0 as there always should be an ep0&n; * */
DECL|function|usb_ohci_rm_function
r_int
id|usb_ohci_rm_function
c_func
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
id|f_handler
id|handler
comma
id|__OHCI_BAG
id|tw0
comma
id|__OHCI_BAG
id|tw1
)paren
(brace
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|NUM_EDS
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|ed
op_assign
op_amp
(paren
id|usb_to_ohci
c_func
(paren
id|usb_dev
)paren
op_member_access_from_pointer
id|ed
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ED_STATE
c_func
(paren
id|ed
)paren
op_ne
id|ED_NEW
)paren
(brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB RM FUNCTION ed: %4x;&bslash;n&quot;
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
)paren
id|usb_ohci_rm_ep
c_func
(paren
id|usb_dev
comma
id|ed
comma
id|handler
comma
id|tw0
comma
id|tw1
comma
id|i
op_eq
l_int|0
ques
c_cond
id|SEND
suffix:colon
l_int|0
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
)brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB RM FUNCTION %d eds removed;&bslash;n&quot;
comma
id|cnt
)paren
suffix:semicolon
)paren
r_return
id|cnt
suffix:semicolon
)brace
multiline_comment|/******&n; *** TD handling functions&n; ************************************/
DECL|macro|FILL_TD
mdefine_line|#define FILL_TD(INFO, DATA, LEN, LW0, LW1, TYPE, HANDLER)  &bslash;&n;&t;OHCI_ALLOC(td_pt, sizeof(*td_pt)); &bslash;&n;    td_ret = (struct usb_ohci_td *) bus_to_virt(usb_ed-&gt;hwTailP &amp; 0xfffffff0); &bslash;&n;    td_pt1 = td_ret; &bslash;&n;    td_pt1-&gt;ed = ed; &bslash;&n;    td_pt1-&gt;buffer_start = (DATA); &bslash;&n;    td_pt1-&gt;type = (TYPE); &bslash;&n;    td_pt1-&gt;handler = (HANDLER); &bslash;&n;    td_pt1-&gt;lw0 = (LW0); &bslash;&n;    td_pt1-&gt;lw1 = (LW1); &bslash;&n;    td_pt1-&gt;hwINFO = (INFO); &bslash;&n;    td_pt1-&gt;hwCBP = (((DATA)==NULL)||((LEN)==0))?0:virt_to_bus(DATA); &bslash;&n;    td_pt1-&gt;hwBE = (((DATA)==NULL)||((LEN)==0))?0:virt_to_bus((DATA) + (LEN) - 1); &bslash;&n;    td_pt1-&gt;hwNextTD = virt_to_bus(td_pt); &bslash;&n;    td_pt-&gt;hwNextTD = 0; &bslash;&n;    usb_ed-&gt;hwTailP =  td_pt1-&gt;hwNextTD
DECL|macro|FILL_ISO_TD
mdefine_line|#define FILL_ISO_TD(INFO, DATA, LEN, LW0, LW1, TYPE, HANDLER)  &bslash;&n;&t;OHCI_ALLOC(td_pt, sizeof(*td_pt)); &bslash;&n;    td_ret = (struct usb_ohci_td *) bus_to_virt(usb_ed-&gt;hwTailP &amp; 0xfffffff0); &bslash;&n;    td_pt1 = td_ret; &bslash;&n;    td_pt1-&gt;ed = ed; &bslash;&n;    td_pt1-&gt;buffer_start = (DATA); &bslash;&n;    td_pt1-&gt;type = (TYPE); &bslash;&n;    td_pt1-&gt;handler = (HANDLER); &bslash;&n;    td_pt1-&gt;lw0 = (LW0); &bslash;&n;    td_pt1-&gt;lw1 = (LW1); &bslash;&n;    td_pt1-&gt;hwINFO = (INFO); &bslash;&n;    td_pt1-&gt;hwCBP = (((DATA)==NULL)||((LEN)==0))?0:(virt_to_bus(DATA) &amp; 0xfffff000); &bslash;&n;    td_pt1-&gt;hwBE = (((DATA)==NULL)||((LEN)==0))?0:virt_to_bus((DATA) + (LEN) - 1); &bslash;&n;    td_pt1-&gt;hwNextTD = virt_to_bus(td_pt); &bslash;&n;    td_pt1-&gt;hwPSW[0] = (virt_to_bus(DATA) &amp; 0xfff) | 0xe000; &bslash;&n;    td_pt-&gt;hwNextTD = 0; &bslash;&n;    usb_ed-&gt;hwTailP =  td_pt1-&gt;hwNextTD
DECL|variable|usb_req_lock
id|spinlock_t
id|usb_req_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|ohci_trans_req
r_struct
id|usb_ohci_td
op_star
id|ohci_trans_req
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_struct
id|usb_ohci_ed
op_star
id|ed
comma
r_int
id|ctrl_len
comma
r_void
op_star
id|ctrl
comma
r_void
op_star
id|data
comma
r_int
id|data_len
comma
id|__OHCI_BAG
id|lw0
comma
id|__OHCI_BAG
id|lw1
comma
r_int
r_int
id|ed_type
comma
id|f_handler
id|handler
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_volatile
r_struct
id|usb_ohci_ed
op_star
id|usb_ed
op_assign
id|ed
suffix:semicolon
r_volatile
r_struct
id|usb_ohci_td
op_star
id|td_pt
suffix:semicolon
r_volatile
r_struct
id|usb_ohci_td
op_star
id|td_pt1
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_ret
op_assign
l_int|NULL
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|usb_ed
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* not known ep */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|usb_req_lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ed_type
)paren
(brace
r_case
id|BULK_IN
suffix:colon
r_while
c_loop
(paren
id|data_len
OG
l_int|4096
)paren
(brace
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_DP_IN
op_or
id|TD_T_TOGGLE
comma
id|data
comma
l_int|4096
comma
l_int|NULL
comma
l_int|NULL
comma
id|BULK_IN
op_or
id|ADD_LEN
op_or
(paren
id|cnt
op_increment
ques
c_cond
l_int|0
suffix:colon
id|ST_ADDR
)paren
comma
l_int|NULL
)paren
suffix:semicolon
id|data
op_add_assign
l_int|4096
suffix:semicolon
id|data_len
op_sub_assign
l_int|4096
suffix:semicolon
)brace
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|TD_T_TOGGLE
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
comma
id|BULK_IN
op_or
id|ADD_LEN
op_or
id|SEND
op_or
(paren
id|cnt
op_increment
ques
c_cond
l_int|0
suffix:colon
id|ST_ADDR
)paren
comma
id|handler
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_BLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start bulk list */
r_break
suffix:semicolon
r_case
id|BULK_OUT
suffix:colon
r_while
c_loop
(paren
id|data_len
OG
l_int|4096
)paren
(brace
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|TD_T_TOGGLE
comma
id|data
comma
l_int|4096
comma
l_int|NULL
comma
l_int|NULL
comma
id|BULK_OUT
op_or
id|ADD_LEN
op_or
(paren
id|cnt
op_increment
ques
c_cond
l_int|0
suffix:colon
id|ST_ADDR
)paren
comma
l_int|NULL
)paren
suffix:semicolon
id|data
op_add_assign
l_int|4096
suffix:semicolon
id|data_len
op_sub_assign
l_int|4096
suffix:semicolon
)brace
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|TD_T_TOGGLE
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
comma
id|BULK_OUT
op_or
id|ADD_LEN
op_or
id|SEND
op_or
(paren
id|cnt
op_increment
ques
c_cond
l_int|0
suffix:colon
id|ST_ADDR
)paren
comma
id|handler
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_BLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start bulk list */
r_break
suffix:semicolon
r_case
id|INT_IN
suffix:colon
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|TD_T_TOGGLE
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
comma
id|INT_IN
op_or
id|ST_ADDR
op_or
id|ADD_LEN
op_or
id|SEND
comma
id|handler
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT_OUT
suffix:colon
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|TD_T_TOGGLE
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
comma
id|INT_OUT
op_or
id|ST_ADDR
op_or
id|ADD_LEN
op_or
id|SEND
comma
id|handler
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CTRL_IN
suffix:colon
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_DP_SETUP
op_or
id|TD_T_DATA0
comma
id|ctrl
comma
id|ctrl_len
comma
l_int|0
comma
l_int|0
comma
id|CTRL_SETUP
op_or
id|ST_ADDR
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_len
OG
l_int|0
)paren
(brace
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|TD_T_DATA1
comma
id|data
comma
id|data_len
comma
l_int|0
comma
l_int|0
comma
id|CTRL_DATA_IN
op_or
id|ST_ADDR
op_or
id|ADD_LEN
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|TD_T_DATA1
comma
l_int|NULL
comma
l_int|0
comma
id|lw0
comma
id|lw1
comma
id|CTRL_STATUS_OUT
op_or
id|SEND
comma
id|handler
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_CLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start Control list */
r_break
suffix:semicolon
r_case
id|CTRL_OUT
suffix:colon
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_DP_SETUP
op_or
id|TD_T_DATA0
comma
id|ctrl
comma
id|ctrl_len
comma
l_int|0
comma
l_int|0
comma
id|CTRL_SETUP
op_or
id|ST_ADDR
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_len
OG
l_int|0
)paren
(brace
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_OUT
op_or
id|TD_T_DATA1
comma
id|data
comma
id|data_len
comma
l_int|0
comma
l_int|0
comma
id|CTRL_DATA_OUT
op_or
id|ST_ADDR
op_or
id|ADD_LEN
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|FILL_TD
c_func
(paren
id|TD_CC
op_or
id|TD_DP_IN
op_or
id|TD_T_DATA1
comma
l_int|NULL
comma
l_int|0
comma
id|lw0
comma
id|lw1
comma
id|CTRL_STATUS_IN
op_or
id|SEND
comma
id|handler
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_CLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start Control list */
r_break
suffix:semicolon
r_case
id|ISO_IN
suffix:colon
id|FILL_ISO_TD
c_func
(paren
id|TD_CC
op_or
id|TD_ISO
op_or
(paren
id|ctrl_len
op_amp
l_int|0xffff
)paren
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
comma
id|ISO_IN
op_or
id|ST_ADDR
op_or
id|ADD_LEN
op_or
id|SEND
comma
id|handler
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISO_OUT
suffix:colon
id|FILL_ISO_TD
c_func
(paren
id|TD_CC
op_or
id|TD_ISO
op_or
(paren
id|ctrl_len
op_amp
l_int|0xffff
)paren
comma
id|data
comma
id|data_len
comma
id|lw0
comma
id|lw1
comma
id|ISO_OUT
op_or
id|ST_ADDR
op_or
id|ADD_LEN
op_or
id|SEND
comma
id|handler
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|usb_req_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|td_ret
suffix:semicolon
)brace
multiline_comment|/******&n; *** Done List handling functions&n; ************************************/
multiline_comment|/* the HC halts an ED if an error occurs;  &n; * on error move all pending tds of a transaction (from ed) onto the done list &n; * * */
DECL|function|ohci_append_error_tds
r_static
r_struct
id|usb_ohci_td
op_star
id|ohci_append_error_tds
c_func
(paren
r_struct
id|usb_ohci_td
op_star
id|td_list
comma
r_struct
id|usb_ohci_td
op_star
id|td_rev
)paren
(brace
r_struct
id|usb_ohci_td
op_star
id|tdl
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|tdx
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|tdt
suffix:semicolon
r_int
id|cc
suffix:semicolon
id|tdl
op_assign
(paren
r_struct
id|usb_ohci_td
op_star
)paren
id|bus_to_virt
c_func
(paren
id|td_list-&gt;ed-&gt;hwHeadP
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|tdt
op_assign
(paren
r_struct
id|usb_ohci_td
op_star
)paren
id|bus_to_virt
c_func
(paren
id|td_list-&gt;ed-&gt;hwTailP
)paren
suffix:semicolon
id|cc
op_assign
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;hwINFO
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tdx
op_assign
id|tdl
suffix:semicolon
id|tdx
op_ne
id|tdt
suffix:semicolon
id|tdx
op_assign
id|tdx-&gt;next_dl_td
)paren
(brace
r_if
c_cond
(paren
id|tdx-&gt;type
op_amp
id|SEND
)paren
(brace
r_break
suffix:semicolon
)brace
id|tdx-&gt;next_dl_td
op_assign
id|bus_to_virt
c_func
(paren
id|tdx-&gt;hwNextTD
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
)brace
id|tdx-&gt;next_dl_td
op_assign
id|td_rev
suffix:semicolon
id|td_list-&gt;ed-&gt;hwHeadP
op_assign
(paren
id|tdx-&gt;hwNextTD
op_amp
l_int|0xfffffff0
)paren
op_or
(paren
id|td_list-&gt;ed-&gt;hwHeadP
op_amp
l_int|0x2
)paren
suffix:semicolon
id|TD_CC_SET
c_func
(paren
id|tdx-&gt;hwINFO
comma
id|cc
)paren
suffix:semicolon
r_return
id|tdl
suffix:semicolon
)brace
multiline_comment|/* replies to the request have to be on a FIFO basis so&n; * we reverse the reversed done-list */
DECL|function|ohci_reverse_done_list
r_static
r_struct
id|usb_ohci_td
op_star
id|ohci_reverse_done_list
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
id|__u32
id|td_list_hc
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_rev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_list
op_assign
l_int|NULL
suffix:semicolon
id|td_list_hc
op_assign
id|ohci-&gt;hc_area-&gt;hcca.done_head
op_amp
l_int|0xfffffff0
suffix:semicolon
id|ohci-&gt;hc_area-&gt;hcca.done_head
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|td_list_hc
)paren
(brace
id|td_list
op_assign
(paren
r_struct
id|usb_ohci_td
op_star
)paren
id|bus_to_virt
c_func
(paren
id|td_list_hc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;hwINFO
)paren
op_logical_and
op_logical_neg
(paren
id|td_list-&gt;type
op_amp
id|SEND
)paren
)paren
(brace
id|td_list-&gt;next_dl_td
op_assign
id|ohci_append_error_tds
c_func
(paren
id|td_list
comma
id|td_rev
)paren
suffix:semicolon
)brace
r_else
id|td_list-&gt;next_dl_td
op_assign
id|td_rev
suffix:semicolon
id|td_rev
op_assign
id|td_list
suffix:semicolon
id|td_list_hc
op_assign
id|td_list-&gt;hwNextTD
op_amp
l_int|0xfffffff0
suffix:semicolon
)brace
r_return
id|td_list
suffix:semicolon
)brace
multiline_comment|/* there are some pending requests to remove some of the eds &n; * we either process every td including the dummy td of these eds &n; * or just those marked with TD-&gt;type&amp;DEL&n; * and link them to a list&n; * */
DECL|function|usb_ohci_del_list
r_static
r_struct
id|usb_ohci_td
op_star
id|usb_ohci_del_list
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
r_struct
id|usb_ohci_ed
op_star
id|ed
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_tmp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|usb_ohci_td
op_star
id|td_list
op_assign
l_int|NULL
suffix:semicolon
id|__u32
op_star
id|td_hw
suffix:semicolon
r_for
c_loop
(paren
id|ed
op_assign
id|ohci-&gt;ed_rm_list
suffix:semicolon
id|ed
op_ne
l_int|NULL
suffix:semicolon
id|ed
op_assign
id|ed-&gt;ed_prev
)paren
(brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC ed_rm_list: %4x :&bslash;n&quot;
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
)paren
r_for
c_loop
(paren
id|td_hw
op_assign
op_amp
(paren
id|ed-&gt;hwHeadP
)paren
suffix:semicolon
(paren
op_star
id|td_hw
op_amp
l_int|0xfffffff0
)paren
op_ne
id|ed-&gt;hwTailP
suffix:semicolon
id|td_hw
op_assign
op_amp
(paren
id|td-&gt;hwNextTD
)paren
)paren
(brace
id|td
op_assign
(paren
r_struct
id|usb_ohci_td
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|td_hw
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ED_STATE
c_func
(paren
id|ed
)paren
op_eq
id|ED_DEL
)paren
op_logical_or
(paren
id|td-&gt;type
op_amp
id|DEL
)paren
)paren
(brace
op_star
id|td_hw
op_assign
id|td-&gt;hwNextTD
suffix:semicolon
r_if
c_cond
(paren
id|td_list
op_eq
l_int|NULL
)paren
(brace
id|td_list
op_assign
id|td
suffix:semicolon
)brace
r_else
id|td_tmp-&gt;next_dl_td
op_assign
id|td
suffix:semicolon
id|td_tmp
op_assign
id|td
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC ed_rm_list: td: %4x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|td
)paren
suffix:semicolon
)paren
id|td-&gt;next_dl_td
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ED_STATE
c_func
(paren
id|ed
)paren
op_eq
id|ED_DEL
)paren
(brace
multiline_comment|/* send dummy td */
id|td
op_assign
(paren
r_struct
id|usb_ohci_td
op_star
)paren
id|bus_to_virt
c_func
(paren
op_star
id|td_hw
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|td-&gt;ed
op_assign
id|ed
suffix:semicolon
r_if
c_cond
(paren
id|td_list
op_eq
l_int|NULL
)paren
(brace
id|td_list
op_assign
id|td
suffix:semicolon
)brace
r_else
id|td_tmp-&gt;next_dl_td
op_assign
id|td
suffix:semicolon
id|td_tmp
op_assign
id|td
suffix:semicolon
id|td-&gt;type
op_or_assign
id|DEL_ED
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC ed_rm_list: dummy (ED_DEL) td: %4x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|td
)paren
suffix:semicolon
)paren
id|ED_setSTATE
c_func
(paren
id|td-&gt;ed
comma
id|ED_DEL
op_or
id|ED_NEW
)paren
suffix:semicolon
id|td-&gt;next_dl_td
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ED_TYPE
c_func
(paren
id|ed
)paren
op_eq
id|CTRL
)paren
(brace
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlcurrent
)paren
suffix:semicolon
)brace
multiline_comment|/* reset CTRL list */
r_if
c_cond
(paren
id|ED_TYPE
c_func
(paren
id|ed
)paren
op_eq
id|BULK
)paren
(brace
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkcurrent
)paren
suffix:semicolon
)brace
multiline_comment|/* reset BULK list */
)brace
id|writel_set
c_func
(paren
(paren
l_int|0x03
op_lshift
l_int|4
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* start CTRL u. BULK list */
id|ohci-&gt;ed_rm_list
op_assign
l_int|NULL
suffix:semicolon
r_return
id|td_list
suffix:semicolon
)brace
multiline_comment|/* all tds ever alive go through this loop&n; *  requests are replied here &n; *  the handler is the &n; *  interface handler (blocking/non blocking) the real reply-handler &n; *  is called in the non blocking interface routine&n; * */
DECL|function|usb_ohci_done_list
r_static
r_int
id|usb_ohci_done_list
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
comma
r_struct
id|usb_ohci_td
op_star
id|td_list
)paren
(brace
r_struct
id|usb_ohci_td
op_star
id|td_list_next
op_assign
l_int|NULL
suffix:semicolon
r_int
id|cc
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|dlen
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|td_list
)paren
(brace
id|td_list_next
op_assign
id|td_list-&gt;next_dl_td
suffix:semicolon
r_if
c_cond
(paren
id|td_list-&gt;type
op_amp
id|ST_ADDR
)paren
(brace
multiline_comment|/* remember start address of data buffer */
id|td_list-&gt;ed-&gt;buffer_start
op_assign
id|td_list-&gt;buffer_start
suffix:semicolon
id|td_list-&gt;ed-&gt;len
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|td_list-&gt;type
op_amp
id|ADD_LEN
)paren
(brace
multiline_comment|/* accumulate length of multi td transfers */
r_if
c_cond
(paren
id|td_list-&gt;hwINFO
op_amp
id|TD_ISO
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
(paren
(paren
id|td_list-&gt;hwINFO
op_rshift
l_int|24
)paren
op_amp
l_int|0x7
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|td_list-&gt;hwPSW
(braket
id|i
)braket
op_rshift
l_int|12
)paren
OL
l_int|0xE
)paren
(brace
id|td_list-&gt;ed-&gt;len
op_add_assign
(paren
id|td_list-&gt;hwPSW
(braket
id|i
)braket
op_amp
l_int|0x3ff
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|td_list-&gt;hwBE
op_ne
l_int|0
)paren
(brace
id|dlen
op_assign
(paren
id|bus_to_virt
c_func
(paren
id|td_list-&gt;hwBE
)paren
op_minus
id|td_list-&gt;buffer_start
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td_list-&gt;hwCBP
op_eq
l_int|0
)paren
(brace
id|td_list-&gt;ed-&gt;len
op_add_assign
id|dlen
suffix:semicolon
)brace
r_else
id|td_list-&gt;ed-&gt;len
op_add_assign
(paren
id|bus_to_virt
c_func
(paren
id|td_list-&gt;hwCBP
)paren
op_minus
id|td_list-&gt;buffer_start
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* error code of transfer */
id|cc
op_assign
(paren
id|ED_STATE
c_func
(paren
id|td_list-&gt;ed
)paren
op_eq
id|ED_DEL
op_logical_or
(paren
id|td_list-&gt;type
op_amp
id|DEL
)paren
)paren
ques
c_cond
id|USB_ST_REMOVED
suffix:colon
(paren
id|USB_ST_CRC
op_star
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;hwINFO
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td_list-&gt;type
op_amp
id|DEL_ED
)paren
(brace
id|ED_setSTATE
c_func
(paren
id|td_list-&gt;ed
comma
id|ED_NEW
)paren
suffix:semicolon
)brace
multiline_comment|/* remove ed */
r_if
c_cond
(paren
(paren
id|td_list-&gt;type
op_amp
id|SEND
)paren
op_logical_and
(paren
id|ED_STATE
c_func
(paren
id|td_list-&gt;ed
)paren
op_ne
id|ED_STOP
)paren
op_logical_and
(paren
id|td_list-&gt;handler
)paren
)paren
(brace
multiline_comment|/*  send the reply  */
id|td_list
op_member_access_from_pointer
id|handler
c_func
(paren
(paren
r_void
op_star
)paren
id|ohci
comma
id|td_list
comma
id|td_list-&gt;ed-&gt;buffer_start
comma
id|td_list-&gt;ed-&gt;len
comma
id|dlen
comma
id|cc
comma
id|td_list-&gt;lw0
comma
id|td_list-&gt;lw1
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
r_if
(paren
id|cc
op_ne
id|TD_CC_NOERROR
)paren
id|printk
c_func
(paren
l_string|&quot;******* USB BUS error %x @ep %x&bslash;n&quot;
comma
id|TD_CC_GET
c_func
(paren
id|td_list-&gt;hwINFO
)paren
comma
id|td_list-&gt;ed-&gt;hwINFO
)paren
suffix:semicolon
)paren
)brace
r_if
c_cond
(paren
id|ED_STATE
c_func
(paren
id|td_list-&gt;ed
)paren
op_eq
id|ED_TD_DEL
)paren
(brace
id|td_list-&gt;ed-&gt;hwINFO
op_and_assign
op_complement
id|OHCI_ED_SKIP
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|td_list-&gt;ed-&gt;hwHeadP
op_amp
l_int|0xfffffff0
)paren
op_eq
id|td_list-&gt;ed-&gt;hwTailP
)paren
op_logical_and
(paren
id|ED_STATE
c_func
(paren
id|td_list-&gt;ed
)paren
OG
id|ED_UNLINK
)paren
)paren
(brace
id|ohci_unlink_ed
c_func
(paren
id|ohci
comma
id|td_list-&gt;ed
)paren
suffix:semicolon
)brace
multiline_comment|/* unlink eds if they are not busy */
id|OHCI_FREE
c_func
(paren
id|td_list
)paren
suffix:semicolon
id|td_list
op_assign
id|td_list_next
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******&n; *** HC functions&n; ************************************/
multiline_comment|/* reset the HC not the BUS */
DECL|function|reset_hc
r_void
id|reset_hc
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
r_int
id|timeout
op_assign
l_int|30
suffix:semicolon
r_int
id|smm_timeout
op_assign
l_int|50
suffix:semicolon
multiline_comment|/* 0,5 sec */
r_if
c_cond
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
l_int|0x100
)paren
(brace
multiline_comment|/* SMM owns the HC */
id|writel
c_func
(paren
l_int|0x08
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* request ownership */
id|printk
c_func
(paren
l_string|&quot;USB HC TakeOver from SMM&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
l_int|0x100
)paren
(brace
id|wait_ms
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|smm_timeout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;USB HC TakeOver failed!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|writel
c_func
(paren
(paren
l_int|1
op_lshift
l_int|31
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;intrdisable
)paren
suffix:semicolon
multiline_comment|/* Disable HC interrupts */
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC reset_hc: %x ; &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
)paren
suffix:semicolon
)paren
id|writel
c_func
(paren
l_int|1
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* HC Reset */
r_while
c_loop
(paren
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
op_amp
l_int|0x01
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* 10us Reset */
r_if
c_cond
(paren
op_decrement
id|timeout
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;USB HC reset timed out!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Start an OHCI controller, set the BUS operational&n; * set and enable interrupts &n; * connect the virtual root hub&n; * * */
DECL|function|start_hc
r_int
id|start_hc
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
r_int
r_int
id|mask
suffix:semicolon
r_int
id|fminterval
suffix:semicolon
multiline_comment|/*&n;&t; * Tell the controller where the control and bulk lists are&n;&t; * The lists are empty now.&n;&t; */
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
id|writel
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|ohci-&gt;hc_area-&gt;hcca
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;hcca
)paren
suffix:semicolon
multiline_comment|/* a reset clears this */
id|writel
c_func
(paren
(paren
l_int|0xBF
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* USB Operational */
id|fminterval
op_assign
l_int|0x2edf
suffix:semicolon
id|writel
c_func
(paren
(paren
(paren
id|fminterval
)paren
op_star
l_int|9
)paren
op_div
l_int|10
comma
op_amp
id|ohci-&gt;regs-&gt;periodicstart
)paren
suffix:semicolon
id|fminterval
op_or_assign
(paren
(paren
(paren
(paren
id|fminterval
op_minus
l_int|210
)paren
op_star
l_int|6
)paren
op_div
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|writel
c_func
(paren
id|fminterval
comma
op_amp
id|ohci-&gt;regs-&gt;fminterval
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0x628
comma
op_amp
id|ohci-&gt;regs-&gt;lsthresh
)paren
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC fminterval: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;fminterval
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC periodicstart: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;periodicstart
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC lsthresh: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;lsthresh
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC control: %x&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstata: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.a
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstatb: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.b
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstatu: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.status
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstat1: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|0
)braket
)paren
)paren
)paren
suffix:semicolon
)paren
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC roothubstat2: %x &bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|1
)braket
)paren
)paren
)paren
suffix:semicolon
)paren
multiline_comment|/* Choose the interrupts we care about now, others later on demand */
id|mask
op_assign
id|OHCI_INTR_MIE
op_or
id|OHCI_INTR_WDH
op_or
id|OHCI_INTR_SO
suffix:semicolon
id|writel
c_func
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
id|writel
c_func
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
macro_line|#ifdef VROOTHUB
(brace
multiline_comment|/* connect the virtual root hub */
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
id|usb_dev
op_assign
id|usb_alloc_dev
c_func
(paren
l_int|NULL
comma
id|ohci-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_dev
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|dev
op_assign
id|usb_to_ohci
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
singleline_comment|// usb_dev-&gt;bus = ohci-&gt;bus;
id|ohci-&gt;bus-&gt;root_hub
op_assign
id|usb_dev
suffix:semicolon
id|dev-&gt;ohci
op_assign
id|ohci
suffix:semicolon
id|usb_connect
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_new_device
c_func
(paren
id|usb_dev
)paren
op_ne
l_int|0
)paren
(brace
id|usb_free_dev
c_func
(paren
id|usb_dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#endif&t;
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* an interrupt happens */
DECL|function|ohci_interrupt
r_static
r_void
id|ohci_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|__ohci
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
op_assign
id|__ohci
suffix:semicolon
r_struct
id|ohci_regs
op_star
id|regs
op_assign
id|ohci-&gt;regs
suffix:semicolon
r_int
id|ints
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ohci-&gt;hc_area-&gt;hcca.done_head
op_ne
l_int|0
)paren
op_logical_and
op_logical_neg
(paren
id|ohci-&gt;hc_area-&gt;hcca.done_head
op_amp
l_int|0x01
)paren
)paren
(brace
id|ints
op_assign
id|OHCI_INTR_WDH
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|ints
op_assign
(paren
id|readl
c_func
(paren
op_amp
id|regs-&gt;intrstatus
)paren
op_amp
id|readl
c_func
(paren
op_amp
id|regs-&gt;intrenable
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC interrupt: %x (%x) &bslash;n&quot;
comma
id|ints
comma
id|readl
c_func
(paren
op_amp
id|regs-&gt;intrstatus
)paren
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_WDH
)paren
(brace
id|writel
c_func
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
id|usb_ohci_done_list
c_func
(paren
id|ohci
comma
id|ohci_reverse_done_list
c_func
(paren
id|ohci
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_SO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;****  USB Schedule overrun &quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_INTR_SO
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_SF
)paren
(brace
id|writel
c_func
(paren
id|OHCI_INTR_SF
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_rm_list
op_ne
l_int|NULL
)paren
(brace
id|usb_ohci_done_list
c_func
(paren
id|ohci
comma
id|usb_ohci_del_list
c_func
(paren
id|ohci
)paren
)paren
suffix:semicolon
)brace
)brace
id|writel
c_func
(paren
id|ints
comma
op_amp
id|regs-&gt;intrstatus
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_INTR_MIE
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
multiline_comment|/* allocate OHCI */
DECL|function|alloc_ohci
r_static
r_struct
id|ohci
op_star
id|alloc_ohci
c_func
(paren
r_void
op_star
id|mem_base
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ohci
op_star
id|ohci
suffix:semicolon
r_struct
id|ohci_hc_area
op_star
id|hc_area
suffix:semicolon
r_struct
id|usb_bus
op_star
id|bus
suffix:semicolon
id|hc_area
op_assign
(paren
r_struct
id|ohci_hc_area
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hc_area
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|hc_area
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|hc_area
)paren
)paren
suffix:semicolon
id|ohci
op_assign
op_amp
id|hc_area-&gt;ohci
suffix:semicolon
id|ohci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|ohci-&gt;regs
op_assign
id|mem_base
suffix:semicolon
id|ohci-&gt;hc_area
op_assign
id|hc_area
suffix:semicolon
multiline_comment|/*&n;&t; * for load ballancing of the interrupt branches &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTS
suffix:semicolon
id|i
op_increment
)paren
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTS
suffix:semicolon
id|i
op_increment
)paren
id|hc_area-&gt;hcca.int_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Store the end of control and bulk list eds. So, we know where we can add&n;&t; * elements to these lists.&n;&t; */
id|ohci-&gt;ed_isotail
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_controltail
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_bulktail
op_assign
l_int|NULL
suffix:semicolon
id|bus
op_assign
id|usb_alloc_bus
c_func
(paren
op_amp
id|sohci_device_operations
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ohci-&gt;hc_area
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ohci-&gt;bus
op_assign
id|bus
suffix:semicolon
id|bus-&gt;hcpriv
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
r_return
id|ohci
suffix:semicolon
)brace
multiline_comment|/*&n; * De-allocate all resources..&n; * */
DECL|function|release_ohci
r_static
r_void
id|release_ohci
c_func
(paren
r_struct
id|ohci
op_star
id|ohci
)paren
(brace
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC release ohci &bslash;n&quot;
)paren
suffix:semicolon
)paren
suffix:semicolon
multiline_comment|/* stop hc */
multiline_comment|/* disconnect all devices */
r_if
c_cond
(paren
id|ohci-&gt;bus-&gt;root_hub
)paren
(brace
id|usb_disconnect
c_func
(paren
op_amp
id|ohci-&gt;bus-&gt;root_hub
)paren
suffix:semicolon
)brace
id|reset_hc
c_func
(paren
id|ohci
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_USB_RESET
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;irq
op_ge
l_int|0
)paren
(brace
id|free_irq
c_func
(paren
id|ohci-&gt;irq
comma
id|ohci
)paren
suffix:semicolon
id|ohci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|usb_deregister_bus
c_func
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
id|usb_free_bus
c_func
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* unmap the IO address space */
id|iounmap
c_func
(paren
id|ohci-&gt;regs
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ohci-&gt;hc_area
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Increment the module usage count, start the control thread and&n; * return success.&n; * */
DECL|function|found_ohci
r_static
r_int
id|found_ohci
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|mem_base
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
suffix:semicolon
id|OHCI_DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;USB HC found  ohci: irq= %d membase= %x &bslash;n&quot;
comma
id|irq
comma
(paren
r_int
)paren
id|mem_base
)paren
suffix:semicolon
)paren
id|ohci
op_assign
id|alloc_ohci
c_func
(paren
id|mem_base
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
comma
op_amp
id|ohci_hcd_list
)paren
suffix:semicolon
id|reset_hc
c_func
(paren
id|ohci
)paren
suffix:semicolon
id|writel
c_func
(paren
id|OHCI_USB_RESET
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|usb_register_bus
c_func
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|ohci_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;ohci-usb&quot;
comma
id|ohci
)paren
op_eq
l_int|0
)paren
(brace
id|ohci-&gt;irq
op_assign
id|irq
suffix:semicolon
id|start_hc
c_func
(paren
id|ohci
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;USB HC (ohci-hcd): request interrupt %d failed&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|release_ohci
c_func
(paren
id|ohci
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|start_ohci
r_static
r_int
id|start_ohci
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
r_int
id|mem_base
op_assign
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mem_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap_nocache
c_func
(paren
id|mem_base
comma
l_int|4096
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Error mapping OHCI memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|found_ohci
c_func
(paren
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|mem_base
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_APM
DECL|function|handle_apm_event
r_static
r_int
id|handle_apm_event
c_func
(paren
id|apm_event_t
id|event
)paren
(brace
r_static
r_int
id|down
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|APM_SYS_SUSPEND
suffix:colon
r_case
id|APM_USER_SUSPEND
suffix:colon
r_if
c_cond
(paren
id|down
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ohci: received extra suspend event&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|down
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|APM_NORMAL_RESUME
suffix:colon
r_case
id|APM_CRITICAL_RESUME
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|down
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ohci: received bogus resume event&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|down
op_assign
l_int|0
suffix:semicolon
singleline_comment|//&t;&t;start_hc(ohci);
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|macro|PCI_CLASS_SERIAL_USB_OHCI
mdefine_line|#define PCI_CLASS_SERIAL_USB_OHCI 0x0C0310
DECL|function|ohci_hcd_init
r_int
id|ohci_hcd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_class
c_func
(paren
id|PCI_CLASS_SERIAL_USB_OHCI
comma
id|dev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|start_ohci
c_func
(paren
id|dev
)paren
op_ge
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_APM
id|apm_register_callback
c_func
(paren
op_amp
id|handle_apm_event
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|ohci_hcd_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|ohci
op_star
id|ohci
suffix:semicolon
macro_line|#&t;ifdef CONFIG_APM
id|apm_unregister_callback
c_func
(paren
op_amp
id|handle_apm_event
)paren
suffix:semicolon
macro_line|#&t;endif
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|ohci_hcd_list
)paren
)paren
(brace
id|ohci
op_assign
id|list_entry
c_func
(paren
id|ohci_hcd_list.next
comma
r_struct
id|ohci
comma
id|ohci_hcd_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|ohci-&gt;ohci_hcd_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
id|ohci-&gt;ohci_hcd_list
)paren
suffix:semicolon
id|release_ohci
c_func
(paren
id|ohci
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif 
singleline_comment|//MODULE
eof
