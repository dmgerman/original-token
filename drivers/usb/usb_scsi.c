multiline_comment|/* Driver for USB scsi like devices&n; * &n; * (C) Michael Gee (michael@linuxspecific.com) 1999&n; *&n; * This driver is scitzoid  - it makes a USB device appear as both a SCSI device&n; * and a character device. The latter is only available if the device has an&n; * interrupt endpoint, and is used specifically to receive interrupt events.&n; *&n; * In order to support various &squot;strange&squot; devices, this module supports plug in&n; * device specific filter modules, which can do their own thing when required.&n; *&n; * Further reference.&n; *&t;This driver is based on the &squot;USB Mass Storage Class&squot; document. This&n; *&t;describes in detail the transformation of SCSI command blocks to the&n; *&t;equivalent USB control and data transfer required.&n; *&t;It is important to note that in a number of cases this class exhibits&n; *&t;class-specific exemptions from the USB specification. Notably the&n; *&t;usage of NAK, STALL and ACK differs from the norm, in that they are&n; *&t;used to communicate wait, failed and OK on SCSI commands.&n; *&t;Also, for certain devices, the interrupt endpoint is used to convey&n; *&t;status of a command.&n; *&n; *&t;Basically, this stuff is WIERD!!&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;../scsi/scsi.h&quot;
macro_line|#include &quot;../scsi/hosts.h&quot;
macro_line|#include &quot;../scsi/sd.h&quot;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;usb_scsi.h&quot;
multiline_comment|/* direction table (what a pain) */
DECL|variable|us_direction
r_int
r_char
id|us_direction
(braket
l_int|256
op_div
l_int|8
)braket
op_assign
(brace
macro_line|#include &quot;usb_scsi_dt.c&quot;
)brace
suffix:semicolon
multiline_comment|/*&n; * Per device data&n; */
DECL|variable|my_host_number
r_static
r_int
id|my_host_number
suffix:semicolon
DECL|variable|usbscsi_debug
r_int
id|usbscsi_debug
op_assign
l_int|1
suffix:semicolon
DECL|struct|us_data
r_struct
id|us_data
(brace
DECL|member|next
r_struct
id|us_data
op_star
id|next
suffix:semicolon
multiline_comment|/* next device */
DECL|member|pusb_dev
r_struct
id|usb_device
op_star
id|pusb_dev
suffix:semicolon
DECL|member|filter
r_struct
id|usb_scsi_filter
op_star
id|filter
suffix:semicolon
multiline_comment|/* filter driver */
DECL|member|fdata
r_void
op_star
id|fdata
suffix:semicolon
multiline_comment|/* filter data */
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* from filter initially*/
DECL|member|ep_in
id|__u8
id|ep_in
suffix:semicolon
multiline_comment|/* in endpoint */
DECL|member|ep_out
id|__u8
id|ep_out
suffix:semicolon
multiline_comment|/* out ....... */
DECL|member|ep_int
id|__u8
id|ep_int
suffix:semicolon
multiline_comment|/* interrupt . */
DECL|member|subclass
id|__u8
id|subclass
suffix:semicolon
multiline_comment|/* as in overview */
DECL|member|protocol
id|__u8
id|protocol
suffix:semicolon
multiline_comment|/* .............. */
DECL|member|attention_done
id|__u8
id|attention_done
suffix:semicolon
multiline_comment|/* force attention on first command */
DECL|member|pop
r_int
(paren
op_star
id|pop
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
multiline_comment|/* protocol specific do cmd */
DECL|member|pop_reset
r_int
(paren
op_star
id|pop_reset
)paren
(paren
r_struct
id|us_data
op_star
)paren
suffix:semicolon
multiline_comment|/* ................. device reset */
id|GUID
c_func
(paren
id|guid
)paren
suffix:semicolon
multiline_comment|/* unique dev id */
DECL|member|host
r_struct
id|Scsi_Host
op_star
id|host
suffix:semicolon
multiline_comment|/* our dummy host data */
DECL|member|htmplt
id|Scsi_Host_Template
op_star
id|htmplt
suffix:semicolon
multiline_comment|/* own host template */
DECL|member|host_number
r_int
id|host_number
suffix:semicolon
multiline_comment|/* to find us */
DECL|member|host_no
r_int
id|host_no
suffix:semicolon
multiline_comment|/* allocated by scsi */
DECL|member|fixedlength
r_int
id|fixedlength
suffix:semicolon
multiline_comment|/* expand commands */
DECL|member|srb
id|Scsi_Cmnd
op_star
id|srb
suffix:semicolon
multiline_comment|/* current srb */
DECL|member|action
r_int
id|action
suffix:semicolon
multiline_comment|/* what to do */
DECL|member|waitq
id|wait_queue_head_t
id|waitq
suffix:semicolon
multiline_comment|/* thread waits */
DECL|member|ip_waitq
id|wait_queue_head_t
id|ip_waitq
suffix:semicolon
multiline_comment|/* for CBI interrupts */
DECL|member|ip_data
id|__u16
id|ip_data
suffix:semicolon
multiline_comment|/* interrupt data */
DECL|member|ip_wanted
r_int
id|ip_wanted
suffix:semicolon
multiline_comment|/* needed */
DECL|member|pid
r_int
id|pid
suffix:semicolon
multiline_comment|/* control thread */
DECL|member|notify
r_struct
id|semaphore
op_star
id|notify
suffix:semicolon
multiline_comment|/* wait for thread to begin */
DECL|member|irq_handle
r_void
op_star
id|irq_handle
suffix:semicolon
multiline_comment|/* for USB interrupt requests */
)brace
suffix:semicolon
multiline_comment|/*&n; * kernel thread actions&n; */
DECL|macro|US_ACT_COMMAND
mdefine_line|#define US_ACT_COMMAND&t;&t;1
DECL|macro|US_ACT_ABORT
mdefine_line|#define US_ACT_ABORT&t;&t;2
DECL|macro|US_ACT_DEVICE_RESET
mdefine_line|#define US_ACT_DEVICE_RESET&t;3
DECL|macro|US_ACT_BUS_RESET
mdefine_line|#define US_ACT_BUS_RESET&t;4
DECL|macro|US_ACT_HOST_RESET
mdefine_line|#define US_ACT_HOST_RESET&t;5
DECL|variable|proc_usb_scsi
r_static
r_struct
id|proc_dir_entry
id|proc_usb_scsi
op_assign
(brace
id|PROC_SCSI_USB_SCSI
comma
l_int|0
comma
l_int|NULL
comma
id|S_IFDIR
op_or
id|S_IRUGO
op_or
id|S_IXUGO
comma
l_int|2
)brace
suffix:semicolon
DECL|variable|us_list
r_static
r_struct
id|us_data
op_star
id|us_list
suffix:semicolon
DECL|variable|filters
r_static
r_struct
id|usb_scsi_filter
op_star
id|filters
suffix:semicolon
r_static
r_int
id|scsi_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|scsi_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|scsi_driver
r_static
r_struct
id|usb_driver
id|scsi_driver
op_assign
(brace
l_string|&quot;usb_scsi&quot;
comma
id|scsi_probe
comma
id|scsi_disconnect
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Data handling, using SG if required */
DECL|function|us_one_transfer
r_static
r_int
id|us_one_transfer
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_int
id|pipe
comma
r_char
op_star
id|buf
comma
r_int
id|length
)paren
(brace
r_int
id|max_size
op_assign
id|usb_maxpacket
c_func
(paren
id|us-&gt;pusb_dev
comma
id|pipe
comma
id|usb_pipeout
c_func
(paren
id|pipe
)paren
)paren
op_star
l_int|16
suffix:semicolon
r_int
id|this_xfer
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_int
id|partial
suffix:semicolon
r_int
id|maxtry
op_assign
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|length
)paren
(brace
id|this_xfer
op_assign
id|length
OG
id|max_size
ques
c_cond
id|max_size
suffix:colon
id|length
suffix:semicolon
id|length
op_sub_assign
id|this_xfer
suffix:semicolon
r_do
(brace
multiline_comment|/*US_DEBUGP(&quot;Bulk xfer %x(%d)&bslash;n&quot;, (unsigned int)buf, this_xfer);*/
id|result
op_assign
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|bulk_msg
c_func
(paren
id|us-&gt;pusb_dev
comma
id|pipe
comma
id|buf
comma
id|this_xfer
comma
op_amp
id|partial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
op_logical_or
id|partial
op_ne
id|this_xfer
)paren
id|US_DEBUGP
c_func
(paren
l_string|&quot;bulk_msg returned %d xferred %lu/%d&bslash;n&quot;
comma
id|result
comma
id|partial
comma
id|this_xfer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|USB_ST_STALL
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;clearing endpoing halt for pipe %x&bslash;n&quot;
comma
id|pipe
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_pipeendpoint
c_func
(paren
id|pipe
)paren
op_or
(paren
id|pipe
op_amp
l_int|0x80
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* we want to retry if the device reported NAK */
r_if
c_cond
(paren
id|result
op_eq
id|USB_ST_TIMEOUT
)paren
(brace
r_if
c_cond
(paren
id|partial
op_ne
id|this_xfer
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* I do not like this */
)brace
r_if
c_cond
(paren
op_logical_neg
id|maxtry
op_decrement
)paren
r_break
suffix:semicolon
id|this_xfer
op_sub_assign
id|partial
suffix:semicolon
id|buf
op_add_assign
id|partial
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|result
op_logical_and
id|partial
op_ne
id|this_xfer
)paren
(brace
multiline_comment|/* short data - assume end */
id|result
op_assign
id|USB_ST_DATAUNDERRUN
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_eq
id|USB_ST_STALL
op_logical_and
id|us-&gt;protocol
op_eq
id|US_PR_CB
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|maxtry
op_decrement
)paren
r_break
suffix:semicolon
id|this_xfer
op_sub_assign
id|partial
suffix:semicolon
id|buf
op_add_assign
id|partial
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|this_xfer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|buf
op_add_assign
id|this_xfer
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|us_transfer
r_static
r_int
id|us_transfer
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
comma
r_int
id|dir_in
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|srb-&gt;host_scribble
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|result
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|dir_in
ques
c_cond
id|usb_rcvbulkpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_in
)paren
suffix:colon
id|usb_sndbulkpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|srb-&gt;request_buffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|srb-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|result
op_assign
id|us_one_transfer
c_func
(paren
id|us
comma
id|pipe
comma
id|sg
(braket
id|i
)braket
dot
id|address
comma
id|sg
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
id|result
op_assign
id|us_one_transfer
c_func
(paren
id|us
comma
id|pipe
comma
id|srb-&gt;request_buffer
comma
id|srb-&gt;request_bufflen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|US_DEBUGP
c_func
(paren
l_string|&quot;us_transfer returning error %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|us_transfer_length
r_static
r_int
r_int
id|us_transfer_length
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|total
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* always zero for some commands */
r_switch
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|SEEK_6
suffix:colon
r_case
id|SEEK_10
suffix:colon
r_case
id|REZERO_UNIT
suffix:colon
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_case
id|START_STOP
suffix:colon
r_case
id|TEST_UNIT_READY
suffix:colon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb-&gt;use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|srb-&gt;request_buffer
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|srb-&gt;use_sg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|total
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
r_return
id|total
suffix:semicolon
)brace
r_else
r_return
id|srb-&gt;request_bufflen
suffix:semicolon
)brace
DECL|function|pop_CBI_irq
r_static
r_int
id|pop_CBI_irq
c_func
(paren
r_int
id|state
comma
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
id|USB_ST_REMOVED
)paren
(brace
id|us-&gt;ip_data
op_assign
id|le16_to_cpup
c_func
(paren
(paren
id|__u16
op_star
)paren
id|buffer
)paren
suffix:semicolon
multiline_comment|/* US_DEBUGP(&quot;Interrupt Status %x&bslash;n&quot;, us-&gt;ip_data); */
)brace
r_if
c_cond
(paren
id|us-&gt;ip_wanted
)paren
(brace
id|us-&gt;ip_wanted
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|us-&gt;ip_waitq
)paren
suffix:semicolon
)brace
multiline_comment|/* we dont want another interrupt */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pop_CB_reset
r_static
r_int
id|pop_CB_reset
c_func
(paren
r_struct
id|us_data
op_star
id|us
)paren
(brace
r_int
r_char
id|cmd
(braket
l_int|12
)braket
suffix:semicolon
id|devrequest
id|dr
suffix:semicolon
r_int
id|result
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;pop_CB_reset&bslash;n&quot;
)paren
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_TYPE_CLASS
op_or
id|USB_RT_INTERFACE
suffix:semicolon
id|dr.request
op_assign
id|US_CBI_ADSC
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
id|us-&gt;pusb_dev-&gt;ifnum
suffix:semicolon
id|dr.length
op_assign
l_int|12
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
op_minus
l_int|1
comma
r_sizeof
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|SEND_DIAGNOSTIC
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
l_int|4
suffix:semicolon
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|cmd
comma
l_int|12
)paren
suffix:semicolon
multiline_comment|/* long wait for reset */
id|schedule_timeout
c_func
(paren
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;pop_CB_reset: clearing endpoint halt&bslash;n&quot;
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_in
op_or
l_int|0x80
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_out
)paren
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;pop_CB_reset done&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pop_CB_command
r_static
r_int
id|pop_CB_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|srb-&gt;host_scribble
suffix:semicolon
id|devrequest
id|dr
suffix:semicolon
r_int
r_char
id|cmd
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|retry
op_assign
l_int|5
suffix:semicolon
r_int
id|done_start
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|retry
op_decrement
)paren
(brace
id|dr.requesttype
op_assign
id|USB_TYPE_CLASS
op_or
id|USB_RT_INTERFACE
suffix:semicolon
id|dr.request
op_assign
id|US_CBI_ADSC
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
id|us-&gt;pusb_dev-&gt;ifnum
suffix:semicolon
id|dr.length
op_assign
id|srb-&gt;cmd_len
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;flags
op_amp
id|US_FL_FIXED_COMMAND
)paren
(brace
id|dr.length
op_assign
id|us-&gt;fixedlength
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
id|us-&gt;fixedlength
)paren
suffix:semicolon
multiline_comment|/* fix some commands */
r_switch
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|WRITE_6
suffix:colon
r_case
id|READ_6
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_or
l_int|0x20
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0xE0
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|cmd
(braket
l_int|3
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|1
)braket
op_amp
l_int|0x1F
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|2
)braket
suffix:semicolon
id|cmd
(braket
l_int|5
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|3
)braket
suffix:semicolon
id|cmd
(braket
l_int|8
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
r_case
id|MODE_SELECT
suffix:colon
id|cmd
(braket
l_int|0
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_or
l_int|0x40
suffix:semicolon
id|cmd
(braket
l_int|1
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|1
)braket
suffix:semicolon
id|cmd
(braket
l_int|2
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|2
)braket
suffix:semicolon
id|cmd
(braket
l_int|8
)braket
op_assign
id|srb-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|memcpy
c_func
(paren
id|cmd
comma
id|srb-&gt;cmnd
comma
id|srb-&gt;cmd_len
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|result
op_assign
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|cmd
comma
id|us-&gt;fixedlength
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done_start
op_logical_and
(paren
id|us-&gt;subclass
op_eq
id|US_SC_UFI
multiline_comment|/*|| us-&gt;subclass == US_SC_8070*/
)paren
op_logical_and
id|cmd
(braket
l_int|0
)braket
op_eq
id|TEST_UNIT_READY
op_logical_and
id|result
)paren
(brace
multiline_comment|/* as per spec try a start command, wait and retry */
id|done_start
op_increment
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|cmd
(braket
l_int|0
)braket
op_assign
id|START_STOP
suffix:semicolon
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* start */
id|result
op_assign
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|cmd
comma
id|us-&gt;fixedlength
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|retry
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
id|result
op_assign
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|srb-&gt;cmnd
comma
id|srb-&gt;cmd_len
)paren
suffix:semicolon
r_if
c_cond
(paren
multiline_comment|/*result != USB_ST_STALL &amp;&amp;*/
id|result
op_ne
id|USB_ST_TIMEOUT
)paren
r_return
id|result
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Control/Bulk status handler&n; */
DECL|function|pop_CB_status
r_static
r_int
id|pop_CB_status
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|srb-&gt;host_scribble
suffix:semicolon
r_int
id|result
suffix:semicolon
id|__u8
id|status
(braket
l_int|2
)braket
suffix:semicolon
id|devrequest
id|dr
suffix:semicolon
r_int
id|retry
op_assign
l_int|5
suffix:semicolon
r_void
op_star
id|irq_handle
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;pop_CB_status, proto=%x&bslash;n&quot;
comma
id|us-&gt;protocol
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|us-&gt;protocol
)paren
(brace
r_case
id|US_PR_CB
suffix:colon
multiline_comment|/* get from control */
r_while
c_loop
(paren
id|retry
op_decrement
)paren
(brace
id|dr.requesttype
op_assign
l_int|0x80
op_or
id|USB_TYPE_STANDARD
op_or
id|USB_RT_DEVICE
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_GET_STATUS
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|2
suffix:semicolon
id|result
op_assign
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|status
comma
r_sizeof
(paren
id|status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|USB_ST_TIMEOUT
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bad AP status request %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Got AP status %x %x&bslash;n&quot;
comma
id|status
(braket
l_int|0
)braket
comma
id|status
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|REQUEST_SENSE
op_logical_and
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|INQUIRY
op_logical_and
(paren
(paren
id|status
(braket
l_int|0
)braket
op_amp
op_complement
l_int|3
)paren
op_logical_or
id|status
(braket
l_int|1
)braket
)paren
)paren
r_return
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
l_int|2
suffix:semicolon
r_else
r_return
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_PR_CBI
suffix:colon
multiline_comment|/* get from interrupt pipe */
multiline_comment|/* add interrupt transfer, marked for removal */
id|us-&gt;ip_wanted
op_assign
l_int|1
suffix:semicolon
id|irq_handle
op_assign
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|request_irq
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_int
)paren
comma
id|pop_CBI_irq
comma
l_int|0
comma
(paren
r_void
op_star
)paren
id|us
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_handle
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;No interrupt for CBI&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
id|us-&gt;irq_handle
op_assign
id|irq_handle
suffix:semicolon
id|sleep_on
c_func
(paren
op_amp
id|us-&gt;ip_waitq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;ip_wanted
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Did not get interrupt on CBI&bslash;n&quot;
)paren
suffix:semicolon
id|us-&gt;ip_wanted
op_assign
l_int|0
suffix:semicolon
r_return
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Got interrupt data %x&bslash;n&quot;
comma
id|us-&gt;ip_data
)paren
suffix:semicolon
multiline_comment|/* sort out what it means */
r_if
c_cond
(paren
id|us-&gt;subclass
op_eq
id|US_SC_UFI
)paren
(brace
multiline_comment|/* gives us asc and ascq, as per request sense */
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
op_logical_or
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
r_return
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_else
r_return
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|us-&gt;ip_data
op_amp
l_int|0xff
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|us-&gt;ip_data
op_amp
l_int|0xff
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bad CBI interrupt data %x&bslash;n&quot;
comma
id|us-&gt;ip_data
)paren
suffix:semicolon
r_return
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
r_return
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|us-&gt;ip_data
op_amp
l_int|0x300
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* Protocol command handlers */
DECL|function|pop_CBI
r_static
r_int
id|pop_CBI
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|srb-&gt;host_scribble
suffix:semicolon
r_int
id|result
suffix:semicolon
multiline_comment|/* run the command */
r_if
c_cond
(paren
(paren
id|result
op_assign
id|pop_CB_command
c_func
(paren
id|srb
)paren
)paren
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;CBI command %x&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|USB_ST_STALL
op_logical_or
id|result
op_eq
id|USB_ST_TIMEOUT
)paren
(brace
r_return
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
l_int|2
suffix:semicolon
)brace
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* transfer the data */
r_if
c_cond
(paren
id|us_transfer_length
c_func
(paren
id|srb
)paren
)paren
(brace
id|result
op_assign
id|us_transfer
c_func
(paren
id|srb
comma
id|US_DIRECTION
c_func
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_logical_and
id|result
op_ne
id|USB_ST_DATAUNDERRUN
op_logical_and
id|result
op_ne
id|USB_ST_STALL
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;CBI  transfer %x&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
macro_line|#if 0
r_else
r_if
c_cond
(paren
id|result
op_eq
id|USB_ST_DATAUNDERRUN
)paren
(brace
r_return
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
(brace
r_return
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* get status */
r_return
id|pop_CB_status
c_func
(paren
id|srb
)paren
suffix:semicolon
)brace
DECL|function|pop_Bulk_reset
r_static
r_int
id|pop_Bulk_reset
c_func
(paren
r_struct
id|us_data
op_star
id|us
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_TYPE_CLASS
op_or
id|USB_RT_INTERFACE
suffix:semicolon
id|dr.request
op_assign
id|US_BULK_RESET
suffix:semicolon
id|dr.value
op_assign
id|US_BULK_RESET_HARD
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bulk hard reset failed %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_in
op_or
l_int|0x80
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_out
)paren
suffix:semicolon
multiline_comment|/* long wait for reset */
id|schedule_timeout
c_func
(paren
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * The bulk only protocol handler.&n; * &t;Uses the in and out endpoints to transfer commands and data (nasty)&n; */
DECL|function|pop_Bulk
r_static
r_int
id|pop_Bulk
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|srb-&gt;host_scribble
suffix:semicolon
r_struct
id|bulk_cb_wrap
id|bcb
suffix:semicolon
r_struct
id|bulk_cs_wrap
id|bcs
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_int
id|partial
suffix:semicolon
r_int
id|stall
suffix:semicolon
multiline_comment|/* set up the command wrapper */
id|bcb.Signature
op_assign
id|US_BULK_CB_SIGN
suffix:semicolon
id|bcb.DataTransferLength
op_assign
id|us_transfer_length
c_func
(paren
id|srb
)paren
suffix:semicolon
suffix:semicolon
id|bcb.Flags
op_assign
id|US_DIRECTION
c_func
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
)paren
op_lshift
l_int|7
suffix:semicolon
id|bcb.Tag
op_assign
id|srb-&gt;serial_number
suffix:semicolon
id|bcb.Lun
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|bcb.CDB
comma
l_int|0
comma
r_sizeof
(paren
id|bcb.CDB
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|bcb.CDB
comma
id|srb-&gt;cmnd
comma
id|srb-&gt;cmd_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;flags
op_amp
id|US_FL_FIXED_COMMAND
)paren
(brace
id|bcb.Length
op_assign
id|us-&gt;fixedlength
suffix:semicolon
)brace
r_else
(brace
id|bcb.Length
op_assign
id|srb-&gt;cmd_len
suffix:semicolon
)brace
multiline_comment|/* send it to out endpoint */
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bulk command S %x T %x L %d F %d CL %d&bslash;n&quot;
comma
id|bcb.Signature
comma
id|bcb.Tag
comma
id|bcb.DataTransferLength
comma
id|bcb.Flags
comma
id|bcb.Length
)paren
suffix:semicolon
id|result
op_assign
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|bulk_msg
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_out
)paren
comma
op_amp
id|bcb
comma
id|US_BULK_CB_WRAP_LEN
comma
op_amp
id|partial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bulk command result %x&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
singleline_comment|//return DID_BAD_TARGET &lt;&lt; 16;
multiline_comment|/* send/receive data */
r_if
c_cond
(paren
id|bcb.DataTransferLength
)paren
(brace
id|result
op_assign
id|us_transfer
c_func
(paren
id|srb
comma
id|bcb.Flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_logical_and
id|result
op_ne
id|USB_ST_DATAUNDERRUN
op_logical_and
id|result
op_ne
id|USB_ST_STALL
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bulk transfer result %x&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
)brace
multiline_comment|/* get status */
id|stall
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|result
op_assign
id|us-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|bulk_msg
c_func
(paren
id|us-&gt;pusb_dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_in
)paren
comma
op_amp
id|bcs
comma
id|US_BULK_CS_WRAP_LEN
comma
op_amp
id|partial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|USB_ST_STALL
op_logical_or
id|result
op_eq
id|USB_ST_TIMEOUT
)paren
id|stall
op_increment
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|stall
OL
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_logical_and
id|result
op_ne
id|USB_ST_DATAUNDERRUN
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bulk status result = %x&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* check bulk status */
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bulk status S %x T %x R %d V %x&bslash;n&quot;
comma
id|bcs.Signature
comma
id|bcs.Tag
comma
id|bcs.Residue
comma
id|bcs.Status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcs.Signature
op_ne
id|US_BULK_CS_SIGN
op_logical_or
id|bcs.Tag
op_ne
id|bcb.Tag
op_logical_or
id|bcs.Status
OG
id|US_BULK_STAT_PHASE
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bulk logical error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|bcs.Status
)paren
(brace
r_case
id|US_BULK_STAT_OK
suffix:colon
r_return
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_case
id|US_BULK_STAT_FAIL
suffix:colon
multiline_comment|/* check for underrun - dont report */
r_if
c_cond
(paren
id|bcs.Residue
)paren
r_return
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
singleline_comment|//pop_Bulk_reset(us);
r_break
suffix:semicolon
r_case
id|US_BULK_STAT_PHASE
suffix:colon
r_return
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
r_return
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
l_int|2
suffix:semicolon
multiline_comment|/* check sense required */
)brace
multiline_comment|/* Host functions */
multiline_comment|/* detect adapter (always true ) */
DECL|function|us_detect
r_static
r_int
id|us_detect
c_func
(paren
r_struct
id|SHT
op_star
id|sht
)paren
(brace
multiline_comment|/* FIXME - not nice at all, but how else ? */
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|sht-&gt;proc_dir
suffix:semicolon
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;usbscsi%d&quot;
comma
id|us-&gt;host_number
)paren
suffix:semicolon
id|proc_usb_scsi.namelen
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
id|proc_usb_scsi.name
op_assign
id|kmalloc
c_func
(paren
id|proc_usb_scsi.namelen
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_usb_scsi.name
)paren
r_return
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|proc_usb_scsi.name
comma
id|name
)paren
suffix:semicolon
id|sht-&gt;proc_dir
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|sht-&gt;proc_dir
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sht-&gt;proc_dir
)paren
(brace
id|kfree
c_func
(paren
id|proc_usb_scsi.name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|sht-&gt;proc_dir
op_assign
id|proc_usb_scsi
suffix:semicolon
id|sht-&gt;name
op_assign
id|proc_usb_scsi.name
suffix:semicolon
id|us-&gt;host
op_assign
id|scsi_register
c_func
(paren
id|sht
comma
r_sizeof
(paren
id|us
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;host
)paren
(brace
id|us-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
id|us
suffix:semicolon
id|us-&gt;host_no
op_assign
id|us-&gt;host-&gt;host_no
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|proc_usb_scsi.name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sht-&gt;proc_dir
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* release - must be here to stop scsi&n; *&t;from trying to release IRQ etc.&n; *&t;Kill off our data&n; */
DECL|function|us_release
r_static
r_int
id|us_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|psh
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|psh-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|us_data
op_star
id|prev
op_assign
(paren
r_struct
id|us_data
op_star
)paren
op_amp
id|us_list
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;irq_handle
)paren
(brace
id|usb_release_irq
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;irq_handle
)paren
suffix:semicolon
id|us-&gt;irq_handle
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|us-&gt;filter
)paren
id|us-&gt;filter
op_member_access_from_pointer
id|release
c_func
(paren
id|us-&gt;fdata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;pusb_dev
)paren
id|usb_deregister
c_func
(paren
op_amp
id|scsi_driver
)paren
suffix:semicolon
multiline_comment|/* FIXME - leaves hanging host template copy */
multiline_comment|/* (because scsi layer uses it after removal !!!) */
r_while
c_loop
(paren
id|prev-&gt;next
op_ne
id|us
)paren
(brace
id|prev
op_assign
id|prev-&gt;next
suffix:semicolon
)brace
id|prev-&gt;next
op_assign
id|us-&gt;next
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* run command */
DECL|function|us_command
r_static
r_int
id|us_command
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bad use of us_command&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/* run command */
DECL|function|us_queuecommand
r_static
r_int
id|us_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|srb-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;Command wakeup&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;srb
)paren
(brace
multiline_comment|/* busy */
)brace
id|srb-&gt;host_scribble
op_assign
(paren
r_int
r_char
op_star
)paren
id|us
suffix:semicolon
id|us-&gt;srb
op_assign
id|srb
suffix:semicolon
id|srb-&gt;scsi_done
op_assign
id|done
suffix:semicolon
id|us-&gt;action
op_assign
id|US_ACT_COMMAND
suffix:semicolon
multiline_comment|/* wake up the process task */
id|wake_up_interruptible
c_func
(paren
op_amp
id|us-&gt;waitq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|us_abort
r_static
r_int
id|us_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|us_bus_reset
r_static
r_int
id|us_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|srb-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|us
op_member_access_from_pointer
id|pop_reset
c_func
(paren
id|us
)paren
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
DECL|function|us_host_reset
r_static
r_int
id|us_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|SPRINTF
macro_line|#undef SPRINTF
DECL|macro|SPRINTF
mdefine_line|#define SPRINTF(args...) { if (pos &lt; (buffer + length)) pos += sprintf (pos, ## args); }
DECL|function|usb_scsi_proc_info
r_int
id|usb_scsi_proc_info
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|hostno
comma
r_int
id|inout
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
id|us_list
suffix:semicolon
r_char
op_star
id|pos
op_assign
id|buffer
suffix:semicolon
r_char
op_star
id|vendor
suffix:semicolon
r_char
op_star
id|product
suffix:semicolon
r_char
op_star
id|style
op_assign
l_string|&quot;&quot;
suffix:semicolon
multiline_comment|/* find our data from hostno */
r_while
c_loop
(paren
id|us
)paren
(brace
r_if
c_cond
(paren
id|us-&gt;host_no
op_eq
id|hostno
)paren
r_break
suffix:semicolon
id|us
op_assign
id|us-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|us
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
multiline_comment|/* null on outward */
r_if
c_cond
(paren
id|inout
)paren
r_return
id|length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|us-&gt;pusb_dev
op_logical_or
op_logical_neg
(paren
id|vendor
op_assign
id|usb_string
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;pusb_dev-&gt;descriptor.iManufacturer
)paren
)paren
)paren
id|vendor
op_assign
l_string|&quot;?&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|us-&gt;pusb_dev
op_logical_or
op_logical_neg
(paren
id|product
op_assign
id|usb_string
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;pusb_dev-&gt;descriptor.iProduct
)paren
)paren
)paren
id|product
op_assign
l_string|&quot;?&quot;
suffix:semicolon
r_switch
c_cond
(paren
id|us-&gt;protocol
)paren
(brace
r_case
id|US_PR_CB
suffix:colon
id|style
op_assign
l_string|&quot;Control/Bulk&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_PR_CBI
suffix:colon
id|style
op_assign
l_string|&quot;Control/Bulk/Interrupt&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_PR_ZIP
suffix:colon
id|style
op_assign
l_string|&quot;Bulk only&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|SPRINTF
(paren
l_string|&quot;Host scsi%d: usb-scsi&bslash;n&quot;
comma
id|hostno
)paren
suffix:semicolon
id|SPRINTF
(paren
l_string|&quot;Device: %s %s - GUID &quot;
id|GUID_FORMAT
l_string|&quot;&bslash;n&quot;
comma
id|vendor
comma
id|product
comma
id|GUID_ARGS
c_func
(paren
id|us-&gt;guid
)paren
)paren
suffix:semicolon
id|SPRINTF
(paren
l_string|&quot;Style: %s&bslash;n&quot;
comma
id|style
)paren
suffix:semicolon
multiline_comment|/*&n;     * Calculate start of next buffer, and return value.&n;     */
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pos
op_minus
id|buffer
)paren
OL
id|offset
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|pos
op_minus
id|buffer
op_minus
id|offset
)paren
OL
id|length
)paren
r_return
(paren
id|pos
op_minus
id|buffer
op_minus
id|offset
)paren
suffix:semicolon
r_else
r_return
(paren
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * this defines our &squot;host&squot;&n; */
DECL|variable|my_host_template
r_static
id|Scsi_Host_Template
id|my_host_template
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* next */
l_int|NULL
comma
multiline_comment|/* module */
l_int|NULL
comma
multiline_comment|/* proc_dir */
id|usb_scsi_proc_info
comma
l_int|NULL
comma
multiline_comment|/* name - points to unique */
id|us_detect
comma
id|us_release
comma
l_int|NULL
comma
multiline_comment|/* info */
l_int|NULL
comma
multiline_comment|/* ioctl */
id|us_command
comma
id|us_queuecommand
comma
l_int|NULL
comma
multiline_comment|/* eh_strategy */
id|us_abort
comma
id|us_bus_reset
comma
id|us_bus_reset
comma
id|us_host_reset
comma
l_int|NULL
comma
multiline_comment|/* abort */
l_int|NULL
comma
multiline_comment|/* reset */
l_int|NULL
comma
multiline_comment|/* slave_attach */
l_int|NULL
comma
multiline_comment|/* bios_param */
l_int|1
comma
multiline_comment|/* can_queue */
op_minus
l_int|1
comma
multiline_comment|/* this_id */
id|SG_ALL
comma
multiline_comment|/* sg_tablesize */
l_int|1
comma
multiline_comment|/* cmd_per_lun */
l_int|0
comma
multiline_comment|/* present */
id|FALSE
comma
multiline_comment|/* unchecked_isa_dma */
id|FALSE
comma
multiline_comment|/* use_clustering */
id|TRUE
comma
multiline_comment|/* use_new_eh_code */
id|TRUE
multiline_comment|/* emulated */
)brace
suffix:semicolon
DECL|variable|sense_notready
r_static
r_int
r_char
id|sense_notready
(braket
)braket
op_assign
(brace
l_int|0x70
comma
multiline_comment|/* current error */
l_int|0x00
comma
l_int|0x02
comma
multiline_comment|/* not ready */
l_int|0x00
comma
l_int|0x00
comma
l_int|10
comma
multiline_comment|/* additional length */
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x04
comma
multiline_comment|/* not ready */
l_int|0x03
comma
multiline_comment|/* manual intervention */
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|function|usbscsi_control_thread
r_static
r_int
id|usbscsi_control_thread
c_func
(paren
r_void
op_star
id|__us
)paren
(brace
r_struct
id|us_data
op_star
id|us
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|__us
suffix:semicolon
r_int
id|action
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;     * This thread doesn&squot;t need any user-level access,&n;     * so get rid of all our resources..&n;     */
id|exit_mm
c_func
(paren
id|current
)paren
suffix:semicolon
id|exit_files
c_func
(paren
id|current
)paren
suffix:semicolon
singleline_comment|//exit_fs(current);
id|sprintf
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;usbscsi%d&quot;
comma
id|us-&gt;host_number
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|up
c_func
(paren
id|us-&gt;notify
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|siginfo_t
id|info
suffix:semicolon
r_int
r_int
r_int
id|signr
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|us-&gt;waitq
)paren
suffix:semicolon
id|action
op_assign
id|us-&gt;action
suffix:semicolon
id|us-&gt;action
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|US_ACT_COMMAND
suffix:colon
r_if
c_cond
(paren
id|us-&gt;srb-&gt;target
op_logical_or
id|us-&gt;srb-&gt;lun
)paren
(brace
multiline_comment|/* bad device */
id|US_DEBUGP
c_func
(paren
l_string|&quot;Bad device number (%d/%d) or dev %x&bslash;n&quot;
comma
id|us-&gt;srb-&gt;target
comma
id|us-&gt;srb-&gt;lun
comma
(paren
r_int
r_int
)paren
id|us-&gt;pusb_dev
)paren
suffix:semicolon
id|us-&gt;srb-&gt;result
op_assign
id|DID_BAD_TARGET
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|us-&gt;pusb_dev
)paren
(brace
multiline_comment|/* our device has gone - pretend not ready */
r_if
c_cond
(paren
id|us-&gt;srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
(brace
id|memcpy
c_func
(paren
id|us-&gt;srb-&gt;request_buffer
comma
id|sense_notready
comma
r_sizeof
(paren
id|sense_notready
)paren
)paren
suffix:semicolon
id|us-&gt;srb-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|us-&gt;srb-&gt;result
op_assign
(paren
id|DID_OK
op_lshift
l_int|16
)paren
op_or
l_int|2
suffix:semicolon
)brace
)brace
r_else
(brace
id|US_DEBUG
c_func
(paren
id|us_show_command
c_func
(paren
id|us-&gt;srb
)paren
)paren
suffix:semicolon
multiline_comment|/* check for variable length - do properly if so */
r_if
c_cond
(paren
id|us-&gt;filter
op_logical_and
id|us-&gt;filter-&gt;command
)paren
id|us-&gt;srb-&gt;result
op_assign
id|us-&gt;filter
op_member_access_from_pointer
id|command
c_func
(paren
id|us-&gt;fdata
comma
id|us-&gt;srb
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|us-&gt;srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|START_STOP
op_logical_and
id|us-&gt;pusb_dev-&gt;descriptor.idProduct
op_eq
l_int|0x0001
op_logical_and
id|us-&gt;pusb_dev-&gt;descriptor.idVendor
op_eq
l_int|0x04e6
)paren
id|us-&gt;srb-&gt;result
op_assign
id|DID_OK
op_lshift
l_int|16
suffix:semicolon
r_else
(brace
r_int
r_int
id|savelen
op_assign
id|us-&gt;srb-&gt;request_bufflen
suffix:semicolon
r_int
r_int
id|saveallocation
suffix:semicolon
r_switch
c_cond
(paren
id|us-&gt;srb-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|REQUEST_SENSE
suffix:colon
r_if
c_cond
(paren
id|us-&gt;srb-&gt;request_bufflen
OG
l_int|18
)paren
id|us-&gt;srb-&gt;request_bufflen
op_assign
l_int|18
suffix:semicolon
r_else
r_break
suffix:semicolon
id|saveallocation
op_assign
id|us-&gt;srb-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|4
)braket
op_assign
l_int|18
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
r_if
c_cond
(paren
id|us-&gt;srb-&gt;request_bufflen
OG
l_int|36
)paren
id|us-&gt;srb-&gt;request_bufflen
op_assign
l_int|36
suffix:semicolon
r_else
r_break
suffix:semicolon
id|saveallocation
op_assign
id|us-&gt;srb-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|4
)braket
op_assign
l_int|36
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
r_if
c_cond
(paren
id|us-&gt;srb-&gt;request_bufflen
OG
l_int|4
)paren
id|us-&gt;srb-&gt;request_bufflen
op_assign
l_int|4
suffix:semicolon
r_else
r_break
suffix:semicolon
id|saveallocation
op_assign
id|us-&gt;srb-&gt;cmnd
(braket
l_int|4
)braket
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|4
)braket
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOG_SENSE
suffix:colon
r_case
id|MODE_SENSE_10
suffix:colon
r_if
c_cond
(paren
id|us-&gt;srb-&gt;request_bufflen
OG
l_int|8
)paren
id|us-&gt;srb-&gt;request_bufflen
op_assign
l_int|8
suffix:semicolon
r_else
r_break
suffix:semicolon
id|saveallocation
op_assign
(paren
id|us-&gt;srb-&gt;cmnd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
op_or
id|us-&gt;srb-&gt;cmnd
(braket
l_int|8
)braket
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|8
)braket
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|us-&gt;srb-&gt;result
op_assign
id|us
op_member_access_from_pointer
id|pop
c_func
(paren
id|us-&gt;srb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|savelen
op_ne
id|us-&gt;srb-&gt;request_bufflen
op_logical_and
id|us-&gt;srb-&gt;result
op_eq
(paren
id|DID_OK
op_lshift
l_int|16
)paren
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
id|us-&gt;srb-&gt;request_buffer
suffix:semicolon
r_int
r_int
id|length
suffix:semicolon
multiline_comment|/* set correct length and retry */
r_switch
c_cond
(paren
id|us-&gt;srb-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|REQUEST_SENSE
suffix:colon
multiline_comment|/* simply return 18 bytes */
id|p
(braket
l_int|7
)braket
op_assign
l_int|10
suffix:semicolon
id|length
op_assign
id|us-&gt;srb-&gt;request_bufflen
suffix:semicolon
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INQUIRY
suffix:colon
id|length
op_assign
id|p
(braket
l_int|4
)braket
op_plus
l_int|5
OG
id|savelen
ques
c_cond
id|savelen
suffix:colon
id|p
(braket
l_int|4
)braket
op_plus
l_int|5
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|4
)braket
op_assign
id|length
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
id|length
op_assign
id|p
(braket
l_int|0
)braket
op_plus
l_int|4
OG
id|savelen
ques
c_cond
id|savelen
suffix:colon
id|p
(braket
l_int|0
)braket
op_plus
l_int|4
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|4
)braket
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOG_SENSE
suffix:colon
id|length
op_assign
(paren
(paren
id|p
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|p
(braket
l_int|3
)braket
)paren
op_plus
l_int|4
OG
id|savelen
ques
c_cond
id|savelen
suffix:colon
(paren
(paren
id|p
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|p
(braket
l_int|3
)braket
)paren
op_plus
l_int|4
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|7
)braket
op_assign
id|length
op_rshift
l_int|8
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|8
)braket
op_assign
id|length
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE_10
suffix:colon
id|length
op_assign
(paren
(paren
id|p
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|p
(braket
l_int|1
)braket
)paren
op_plus
l_int|8
OG
id|savelen
ques
c_cond
id|savelen
suffix:colon
(paren
(paren
id|p
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|p
(braket
l_int|1
)braket
)paren
op_plus
l_int|8
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|7
)braket
op_assign
id|length
op_rshift
l_int|8
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|8
)braket
op_assign
id|length
suffix:semicolon
r_break
suffix:semicolon
)brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Old/New length = %d/%d&bslash;n&quot;
comma
id|savelen
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;srb-&gt;request_bufflen
op_ne
id|length
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;redoing cmd with len=%d&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
id|us-&gt;srb-&gt;request_bufflen
op_assign
id|length
suffix:semicolon
id|us-&gt;srb-&gt;result
op_assign
id|us
op_member_access_from_pointer
id|pop
c_func
(paren
id|us-&gt;srb
)paren
suffix:semicolon
)brace
multiline_comment|/* reset back to original values */
id|us-&gt;srb-&gt;request_bufflen
op_assign
id|savelen
suffix:semicolon
r_switch
c_cond
(paren
id|us-&gt;srb-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|REQUEST_SENSE
suffix:colon
r_case
id|INQUIRY
suffix:colon
r_case
id|MODE_SENSE
suffix:colon
r_if
c_cond
(paren
id|us-&gt;srb-&gt;use_sg
op_eq
l_int|0
op_logical_and
id|length
OG
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Data is&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
op_logical_and
id|i
OL
id|length
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot; %.2x&quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|us-&gt;srb-&gt;request_buffer
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|length
)paren
id|printk
c_func
(paren
l_string|&quot; ...&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|us-&gt;srb-&gt;cmnd
(braket
l_int|4
)braket
op_assign
id|saveallocation
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOG_SENSE
suffix:colon
r_case
id|MODE_SENSE_10
suffix:colon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|7
)braket
op_assign
id|saveallocation
op_rshift
l_int|8
suffix:semicolon
id|us-&gt;srb-&gt;cmnd
(braket
l_int|8
)braket
op_assign
id|saveallocation
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* force attention on first command */
r_if
c_cond
(paren
op_logical_neg
id|us-&gt;attention_done
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;forcing unit attention&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
(brace
r_if
c_cond
(paren
id|us-&gt;srb-&gt;result
op_eq
(paren
id|DID_OK
op_lshift
l_int|16
)paren
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
id|us-&gt;srb-&gt;request_buffer
suffix:semicolon
id|us-&gt;attention_done
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
(braket
l_int|2
)braket
op_amp
l_int|0x0f
)paren
op_ne
id|UNIT_ATTENTION
)paren
(brace
id|p
(braket
l_int|2
)braket
op_assign
id|UNIT_ATTENTION
suffix:semicolon
id|p
(braket
l_int|12
)braket
op_assign
l_int|0x29
suffix:semicolon
multiline_comment|/* power on, reset or bus-reset */
id|p
(braket
l_int|13
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|us-&gt;srb-&gt;cmnd
(braket
l_int|0
)braket
op_ne
id|INQUIRY
op_logical_and
id|us-&gt;srb-&gt;result
op_eq
(paren
id|DID_OK
op_lshift
l_int|16
)paren
)paren
(brace
id|us-&gt;srb-&gt;result
op_or_assign
l_int|2
suffix:semicolon
multiline_comment|/* force check condition */
)brace
)brace
)brace
)brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;scsi cmd done, result=%x&bslash;n&quot;
comma
id|us-&gt;srb-&gt;result
)paren
suffix:semicolon
id|us-&gt;srb
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|us-&gt;srb
)paren
suffix:semicolon
id|us-&gt;srb
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_ACT_ABORT
suffix:colon
r_break
suffix:semicolon
r_case
id|US_ACT_DEVICE_RESET
suffix:colon
r_break
suffix:semicolon
r_case
id|US_ACT_BUS_RESET
suffix:colon
r_break
suffix:semicolon
r_case
id|US_ACT_HOST_RESET
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
multiline_comment|/* sending SIGUSR1 makes us print out some info */
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|signr
op_assign
id|dequeue_signal
c_func
(paren
op_amp
id|current-&gt;blocked
comma
op_amp
id|info
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signr
op_eq
id|SIGUSR2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;USBSCSI debug toggle&bslash;n&quot;
)paren
suffix:semicolon
id|usbscsi_debug
op_assign
op_logical_neg
id|usbscsi_debug
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;usbscsi_control_thread exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scsi_probe
r_static
r_int
id|scsi_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|mf
suffix:semicolon
multiline_comment|/* manufacturer */
r_char
op_star
id|prod
suffix:semicolon
multiline_comment|/* product */
r_char
op_star
id|serial
suffix:semicolon
multiline_comment|/* serial number */
r_struct
id|us_data
op_star
id|ss
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|usb_scsi_filter
op_star
id|filter
op_assign
id|filters
suffix:semicolon
r_void
op_star
id|fdata
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|GUID
c_func
(paren
id|guid
)paren
suffix:semicolon
r_struct
id|us_data
op_star
id|prev
suffix:semicolon
id|Scsi_Host_Template
op_star
id|htmplt
suffix:semicolon
r_int
id|protocol
op_assign
l_int|0
suffix:semicolon
r_int
id|subclass
op_assign
l_int|0
suffix:semicolon
id|GUID_CLEAR
c_func
(paren
id|guid
)paren
suffix:semicolon
id|mf
op_assign
id|usb_string
c_func
(paren
id|dev
comma
id|dev-&gt;descriptor.iManufacturer
)paren
suffix:semicolon
id|prod
op_assign
id|usb_string
c_func
(paren
id|dev
comma
id|dev-&gt;descriptor.iProduct
)paren
suffix:semicolon
id|serial
op_assign
id|usb_string
c_func
(paren
id|dev
comma
id|dev-&gt;descriptor.iSerialNumber
)paren
suffix:semicolon
multiline_comment|/* probe with filters first */
r_if
c_cond
(paren
id|mf
op_logical_and
id|prod
)paren
(brace
r_while
c_loop
(paren
id|filter
)paren
(brace
r_if
c_cond
(paren
(paren
id|fdata
op_assign
id|filter
op_member_access_from_pointer
id|probe
c_func
(paren
id|dev
comma
id|mf
comma
id|prod
comma
id|serial
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|flags
op_assign
id|filter-&gt;flags
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB Scsi filter %s&bslash;n&quot;
comma
id|filter-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|filter
op_assign
id|filter-&gt;next
suffix:semicolon
)brace
)brace
multiline_comment|/* generic devices next */
r_if
c_cond
(paren
id|fdata
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* some exceptions */
r_if
c_cond
(paren
id|dev-&gt;descriptor.idVendor
op_eq
l_int|0x04e6
op_logical_and
id|dev-&gt;descriptor.idProduct
op_eq
l_int|0x0001
)paren
(brace
multiline_comment|/* shuttle E-USB */
id|protocol
op_assign
id|US_PR_CB
suffix:semicolon
id|subclass
op_assign
id|US_SC_8070
suffix:semicolon
multiline_comment|/* an assumption */
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;descriptor.bDeviceClass
op_ne
l_int|0
op_logical_or
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|bInterfaceClass
op_ne
l_int|8
op_logical_or
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|bInterfaceSubClass
template_param
id|US_SC_MAX
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* now check if we have seen it before */
r_if
c_cond
(paren
id|dev-&gt;descriptor.iSerialNumber
op_logical_and
id|usb_string
c_func
(paren
id|dev
comma
id|dev-&gt;descriptor.iSerialNumber
)paren
)paren
(brace
id|make_guid
c_func
(paren
id|guid
comma
id|dev-&gt;descriptor.idVendor
comma
id|dev-&gt;descriptor.idProduct
comma
id|usb_string
c_func
(paren
id|dev
comma
id|dev-&gt;descriptor.iSerialNumber
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|make_guid
c_func
(paren
id|guid
comma
id|dev-&gt;descriptor.idVendor
comma
id|dev-&gt;descriptor.idProduct
comma
l_string|&quot;0&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ss
op_assign
id|us_list
suffix:semicolon
id|ss
suffix:semicolon
id|ss
op_assign
id|ss-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ss-&gt;pusb_dev
op_logical_and
id|GUID_EQUAL
c_func
(paren
id|guid
comma
id|ss-&gt;guid
)paren
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Found existing GUID &quot;
id|GUID_FORMAT
l_string|&quot;&bslash;n&quot;
comma
id|GUID_ARGS
c_func
(paren
id|guid
)paren
)paren
suffix:semicolon
id|flags
op_assign
id|ss-&gt;flags
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ss
)paren
(brace
r_if
c_cond
(paren
(paren
id|ss
op_assign
(paren
r_struct
id|us_data
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ss
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|USB_SCSI
l_string|&quot;Out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filter
)paren
id|filter
op_member_access_from_pointer
id|release
c_func
(paren
id|fdata
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ss
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|us_data
)paren
)paren
suffix:semicolon
)brace
id|interface
op_assign
op_amp
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
id|ss-&gt;filter
op_assign
id|filter
suffix:semicolon
id|ss-&gt;fdata
op_assign
id|fdata
suffix:semicolon
id|ss-&gt;flags
op_assign
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|subclass
)paren
(brace
id|ss-&gt;subclass
op_assign
id|subclass
suffix:semicolon
id|ss-&gt;protocol
op_assign
id|protocol
suffix:semicolon
)brace
r_else
(brace
id|ss-&gt;subclass
op_assign
id|interface-&gt;bInterfaceSubClass
suffix:semicolon
id|ss-&gt;protocol
op_assign
id|interface-&gt;bInterfaceProtocol
suffix:semicolon
)brace
id|ss-&gt;attention_done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set the protocol op */
id|US_DEBUGP
c_func
(paren
l_string|&quot;Protocol &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ss-&gt;protocol
)paren
(brace
r_case
id|US_PR_CB
suffix:colon
id|US_DEBUGPX
c_func
(paren
l_string|&quot;Control/Bulk&bslash;n&quot;
)paren
suffix:semicolon
id|ss-&gt;pop
op_assign
id|pop_CBI
suffix:semicolon
id|ss-&gt;pop_reset
op_assign
id|pop_CB_reset
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_PR_CBI
suffix:colon
id|US_DEBUGPX
c_func
(paren
l_string|&quot;Control/Bulk/Interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|ss-&gt;pop
op_assign
id|pop_CBI
suffix:semicolon
id|ss-&gt;pop_reset
op_assign
id|pop_CB_reset
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|US_DEBUGPX
c_func
(paren
l_string|&quot;Bulk&bslash;n&quot;
)paren
suffix:semicolon
id|ss-&gt;pop
op_assign
id|pop_Bulk
suffix:semicolon
id|ss-&gt;pop_reset
op_assign
id|pop_Bulk_reset
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* &n;     * we are expecting a minimum of 2 endpoints - in and out (bulk)&n;     * an optional interrupt is OK (necessary for CBI protocol)&n;     * we will ignore any others&n;     */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|interface-&gt;bNumEndpoints
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|interface-&gt;endpoint
(braket
id|i
)braket
dot
id|bmAttributes
op_eq
l_int|0x02
)paren
(brace
r_if
c_cond
(paren
id|interface-&gt;endpoint
(braket
id|i
)braket
dot
id|bEndpointAddress
op_amp
l_int|0x80
)paren
id|ss-&gt;ep_in
op_assign
id|interface-&gt;endpoint
(braket
id|i
)braket
dot
id|bEndpointAddress
op_amp
l_int|0x0f
suffix:semicolon
r_else
id|ss-&gt;ep_out
op_assign
id|interface-&gt;endpoint
(braket
id|i
)braket
dot
id|bEndpointAddress
op_amp
l_int|0x0f
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|interface-&gt;endpoint
(braket
id|i
)braket
dot
id|bmAttributes
op_eq
l_int|0x03
)paren
(brace
id|ss-&gt;ep_int
op_assign
id|interface-&gt;endpoint
(braket
id|i
)braket
dot
id|bEndpointAddress
op_amp
l_int|0x0f
suffix:semicolon
)brace
)brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Endpoints In %d Out %d Int %d&bslash;n&quot;
comma
id|ss-&gt;ep_in
comma
id|ss-&gt;ep_out
comma
id|ss-&gt;ep_int
)paren
suffix:semicolon
multiline_comment|/* exit if strange looking */
r_if
c_cond
(paren
id|usb_set_configuration
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|bConfigurationValue
)paren
op_logical_or
id|usb_set_interface
c_func
(paren
id|dev
comma
id|interface-&gt;bInterfaceNumber
comma
l_int|0
)paren
op_logical_or
op_logical_neg
id|ss-&gt;ep_in
op_logical_or
op_logical_neg
id|ss-&gt;ep_out
op_logical_or
(paren
id|ss-&gt;protocol
op_eq
id|US_PR_CBI
op_logical_and
id|ss-&gt;ep_int
op_eq
l_int|0
)paren
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Problems with device&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ss-&gt;host
)paren
(brace
id|scsi_unregister_module
c_func
(paren
id|MODULE_SCSI_HA
comma
id|ss-&gt;htmplt
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ss-&gt;htmplt-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ss-&gt;htmplt
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|filter
)paren
id|filter
op_member_access_from_pointer
id|release
c_func
(paren
id|fdata
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ss
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* no endpoints */
)brace
r_if
c_cond
(paren
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|iConfiguration
op_logical_and
id|usb_string
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|iConfiguration
)paren
)paren
id|US_DEBUGP
c_func
(paren
l_string|&quot;Configuration %s&bslash;n&quot;
comma
id|usb_string
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|iConfiguration
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;iInterface
op_logical_and
id|usb_string
c_func
(paren
id|dev
comma
id|interface-&gt;iInterface
)paren
)paren
id|US_DEBUGP
c_func
(paren
l_string|&quot;Interface %s&bslash;n&quot;
comma
id|usb_string
c_func
(paren
id|dev
comma
id|interface-&gt;iInterface
)paren
)paren
suffix:semicolon
id|ss-&gt;pusb_dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Now generate a scsi host definition, and register with scsi above us */
r_if
c_cond
(paren
op_logical_neg
id|ss-&gt;host
)paren
(brace
multiline_comment|/* make unique id if possible */
id|US_DEBUGP
c_func
(paren
l_string|&quot;New GUID &quot;
id|GUID_FORMAT
l_string|&quot;&bslash;n&quot;
comma
id|GUID_ARGS
c_func
(paren
id|guid
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ss-&gt;guid
comma
id|guid
comma
r_sizeof
(paren
id|guid
)paren
)paren
suffix:semicolon
multiline_comment|/* set class specific stuff */
id|US_DEBUGP
c_func
(paren
l_string|&quot;SubClass &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ss-&gt;subclass
)paren
(brace
r_case
id|US_SC_RBC
suffix:colon
id|US_DEBUGPX
c_func
(paren
l_string|&quot;Reduced Block Commands&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_SC_8020
suffix:colon
id|US_DEBUGPX
c_func
(paren
l_string|&quot;8020&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_SC_QIC
suffix:colon
id|US_DEBUGPX
c_func
(paren
l_string|&quot;QIC157&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_SC_8070
suffix:colon
id|US_DEBUGPX
c_func
(paren
l_string|&quot;8070&bslash;n&quot;
)paren
suffix:semicolon
id|ss-&gt;flags
op_or_assign
id|US_FL_FIXED_COMMAND
suffix:semicolon
id|ss-&gt;fixedlength
op_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_SC_SCSI
suffix:colon
id|US_DEBUGPX
c_func
(paren
l_string|&quot;Transparent SCSI&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|US_SC_UFI
suffix:colon
id|US_DEBUGPX
c_func
(paren
l_string|&quot; UFF&bslash;n&quot;
)paren
suffix:semicolon
id|ss-&gt;flags
op_or_assign
id|US_FL_FIXED_COMMAND
suffix:semicolon
id|ss-&gt;fixedlength
op_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/* create unique host template */
r_if
c_cond
(paren
(paren
id|htmplt
op_assign
(paren
id|Scsi_Host_Template
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ss-&gt;htmplt
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|USB_SCSI
l_string|&quot;Out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filter
)paren
id|filter
op_member_access_from_pointer
id|release
c_func
(paren
id|fdata
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ss
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|htmplt
comma
op_amp
id|my_host_template
comma
r_sizeof
(paren
id|my_host_template
)paren
)paren
suffix:semicolon
id|ss-&gt;host_number
op_assign
id|my_host_number
op_increment
suffix:semicolon
(paren
r_struct
id|us_data
op_star
)paren
id|htmplt-&gt;proc_dir
op_assign
id|ss
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;descriptor.idVendor
op_eq
l_int|0x04e6
op_logical_and
id|dev-&gt;descriptor.idProduct
op_eq
l_int|0x0001
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|__u8
id|qstat
(braket
l_int|2
)braket
suffix:semicolon
r_void
op_star
id|irq_handle
suffix:semicolon
multiline_comment|/* shuttle E-USB */
id|dr.requesttype
op_assign
l_int|0xC0
suffix:semicolon
id|dr.request
op_assign
l_int|1
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
id|ss-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|ss-&gt;pusb_dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|qstat
comma
l_int|2
)paren
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;C0 status %x %x&bslash;n&quot;
comma
id|qstat
(braket
l_int|0
)braket
comma
id|qstat
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ss-&gt;ip_waitq
)paren
suffix:semicolon
id|irq_handle
op_assign
id|ss-&gt;pusb_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|request_irq
c_func
(paren
id|ss-&gt;pusb_dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|ss-&gt;pusb_dev
comma
id|ss-&gt;ep_int
)paren
comma
id|pop_CBI_irq
comma
l_int|0
comma
(paren
r_void
op_star
)paren
id|ss
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq_handle
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ss-&gt;irq_handle
op_assign
id|irq_handle
suffix:semicolon
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|ss-&gt;ip_waitq
comma
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ss-&gt;protocol
op_eq
id|US_PR_CBI
)paren
id|init_waitqueue_head
c_func
(paren
op_amp
id|ss-&gt;ip_waitq
)paren
suffix:semicolon
multiline_comment|/* start up our thread */
(brace
id|DECLARE_MUTEX_LOCKED
c_func
(paren
id|sem
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ss-&gt;waitq
)paren
suffix:semicolon
id|ss-&gt;notify
op_assign
op_amp
id|sem
suffix:semicolon
id|ss-&gt;pid
op_assign
id|kernel_thread
c_func
(paren
id|usbscsi_control_thread
comma
id|ss
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_SIGHAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ss-&gt;pid
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|USB_SCSI
l_string|&quot;Unable to start control thread&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|htmplt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filter
)paren
id|filter
op_member_access_from_pointer
id|release
c_func
(paren
id|fdata
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ss
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* wait for it to start */
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
)brace
multiline_comment|/* now register - our detect function will be called */
id|scsi_register_module
c_func
(paren
id|MODULE_SCSI_HA
comma
id|htmplt
)paren
suffix:semicolon
multiline_comment|/* put us in the list */
id|prev
op_assign
(paren
r_struct
id|us_data
op_star
)paren
op_amp
id|us_list
suffix:semicolon
r_while
c_loop
(paren
id|prev-&gt;next
)paren
id|prev
op_assign
id|prev-&gt;next
suffix:semicolon
id|prev-&gt;next
op_assign
id|ss
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB SCSI device found at address %d&bslash;n&quot;
comma
id|dev-&gt;devnum
)paren
suffix:semicolon
id|dev
op_member_access_from_pointer
r_private
op_assign
id|ss
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scsi_disconnect
r_static
r_void
id|scsi_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|us_data
op_star
id|ss
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ss
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ss-&gt;filter
)paren
id|ss-&gt;filter
op_member_access_from_pointer
id|release
c_func
(paren
id|ss-&gt;fdata
)paren
suffix:semicolon
id|ss-&gt;pusb_dev
op_assign
l_int|NULL
suffix:semicolon
id|dev
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* just in case */
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|usb_scsi_init
r_int
id|usb_scsi_init
c_func
(paren
r_void
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#ifdef CONFIG_USB_HP4100
id|hp4100_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_ZIP
id|usb_zip_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|usb_register
c_func
(paren
op_amp
id|scsi_driver
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB SCSI support registered.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_scsi_register
r_int
id|usb_scsi_register
c_func
(paren
r_struct
id|usb_scsi_filter
op_star
id|filter
)paren
(brace
r_struct
id|usb_scsi_filter
op_star
id|prev
op_assign
(paren
r_struct
id|usb_scsi_filter
op_star
)paren
op_amp
id|filters
suffix:semicolon
r_while
c_loop
(paren
id|prev-&gt;next
)paren
id|prev
op_assign
id|prev-&gt;next
suffix:semicolon
id|prev-&gt;next
op_assign
id|filter
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_scsi_deregister
r_void
id|usb_scsi_deregister
c_func
(paren
r_struct
id|usb_scsi_filter
op_star
id|filter
)paren
(brace
r_struct
id|usb_scsi_filter
op_star
id|prev
op_assign
(paren
r_struct
id|usb_scsi_filter
op_star
)paren
op_amp
id|filters
suffix:semicolon
r_while
c_loop
(paren
id|prev-&gt;next
op_logical_and
id|prev-&gt;next
op_ne
id|filter
)paren
id|prev
op_assign
id|prev-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|prev-&gt;next
)paren
id|prev-&gt;next
op_assign
id|filter-&gt;next
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_scsi_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|offset
suffix:semicolon
id|usb_deregister
c_func
(paren
op_amp
id|scsi_driver
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
