multiline_comment|/*&n; * USB hub driver.&n; *&n; * (C) Copyright 1999 Linus Torvalds&n; * (C) Copyright 1999 Johannes Erdfelt&n; * (C) Copyright 1999 Gregory P. Smith&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;hub.h&quot;
multiline_comment|/* Wakes up khubd */
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|usb_hub_wait
)paren
suffix:semicolon
DECL|variable|hub_event_lock
r_static
id|spinlock_t
id|hub_event_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|hub_list_lock
r_static
id|spinlock_t
id|hub_list_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* List of hubs needing servicing */
DECL|variable|hub_event_list
r_static
r_struct
id|list_head
id|hub_event_list
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* List containing all of the hubs (for cleanup) */
DECL|variable|all_hubs_list
r_static
r_struct
id|list_head
id|all_hubs_list
suffix:semicolon
macro_line|#endif
multiline_comment|/* PID of khubd */
DECL|variable|khubd_pid
r_static
r_int
id|khubd_pid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * A irq handler returns non-zero to indicate to&n; * the low-level driver that it wants to be re-activated,&n; * or zero to say &quot;I&squot;m done&quot;.&n; */
DECL|function|hub_irq
r_static
r_int
id|hub_irq
c_func
(paren
r_int
id|status
comma
r_void
op_star
id|__buffer
comma
r_int
id|len
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|usb_hub
op_star
id|hub
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|usb_hub_wait
)paren
)paren
(brace
multiline_comment|/* Add the hub to the event queue */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hub_event_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hub-&gt;event_list.next
op_eq
op_amp
id|hub-&gt;event_list
)paren
(brace
id|list_add
c_func
(paren
op_amp
id|hub-&gt;event_list
comma
op_amp
id|hub_event_list
)paren
suffix:semicolon
multiline_comment|/* Wake up khubd */
id|wake_up
c_func
(paren
op_amp
id|usb_hub_wait
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hub_event_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|usb_hub_configure
r_static
r_void
id|usb_hub_configure
c_func
(paren
r_struct
id|usb_hub
op_star
id|hub
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|hub-&gt;dev
suffix:semicolon
r_int
r_char
id|hubdescriptor
(braket
l_int|8
)braket
comma
id|buf
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|charac
comma
id|i
suffix:semicolon
id|usb_set_configuration
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|bConfigurationValue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_get_hub_descriptor
c_func
(paren
id|dev
comma
id|hubdescriptor
comma
l_int|8
)paren
)paren
r_return
suffix:semicolon
id|hub-&gt;nports
op_assign
id|dev-&gt;maxchild
op_assign
id|hubdescriptor
(braket
l_int|2
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub: %d-port%s detected&bslash;n&quot;
comma
id|hub-&gt;nports
comma
(paren
id|hub-&gt;nports
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|charac
op_assign
(paren
id|hubdescriptor
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
id|hubdescriptor
(braket
l_int|3
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|charac
op_amp
id|HUB_CHAR_LPSM
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|printk
c_func
(paren
l_string|&quot;hub: ganged power switching&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|printk
c_func
(paren
l_string|&quot;hub: individual port power switching&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
r_case
l_int|0x03
suffix:colon
id|printk
c_func
(paren
l_string|&quot;hub: unknown reserved power switching mode&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|charac
op_amp
id|HUB_CHAR_COMPOUND
)paren
id|printk
c_func
(paren
l_string|&quot;hub: part of a compound device&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;hub: standalone hub&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|charac
op_amp
id|HUB_CHAR_OCPM
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|printk
c_func
(paren
l_string|&quot;hub: global over current protection&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|printk
c_func
(paren
l_string|&quot;hub: individual port over current protection&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
r_case
l_int|0x18
suffix:colon
id|printk
c_func
(paren
l_string|&quot;hub: no over current protection&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;hub: power on to power good time: %dms&bslash;n&quot;
comma
id|hubdescriptor
(braket
l_int|5
)braket
op_star
l_int|2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub: hub controller current requirement: %dmA&bslash;n&quot;
comma
id|hubdescriptor
(braket
l_int|6
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;maxchild
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;hub:  port %d is%s removable&bslash;n&quot;
comma
id|i
op_plus
l_int|1
comma
id|hubdescriptor
(braket
l_int|7
op_plus
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
)braket
op_amp
(paren
l_int|1
op_lshift
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|8
)paren
)paren
ques
c_cond
l_string|&quot; not&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_get_hub_status
c_func
(paren
id|dev
comma
id|buf
)paren
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub: local power source is %s&bslash;n&quot;
comma
(paren
id|buf
(braket
l_int|0
)braket
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;lost (inactive)&quot;
suffix:colon
l_string|&quot;good&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub: %sover current condition exists&bslash;n&quot;
comma
(paren
id|buf
(braket
l_int|0
)braket
op_amp
l_int|2
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;no &quot;
)paren
suffix:semicolon
macro_line|#if 0
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hub-&gt;nports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|portstat
comma
id|portchange
suffix:semicolon
r_int
r_char
id|portstatus
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|usb_get_port_status
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
id|portstatus
)paren
)paren
r_return
suffix:semicolon
id|portstat
op_assign
(paren
id|portstatus
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|portstatus
(braket
l_int|0
)braket
suffix:semicolon
id|portchange
op_assign
(paren
id|portstatus
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_plus
id|portstatus
(braket
l_int|2
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub: port %d status&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %sdevice present&bslash;n&quot;
comma
(paren
id|portstat
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;no &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %s&bslash;n&quot;
comma
(paren
id|portstat
op_amp
l_int|2
)paren
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %ssuspended&bslash;n&quot;
comma
(paren
id|portstat
op_amp
l_int|4
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %sover current&bslash;n&quot;
comma
(paren
id|portstat
op_amp
l_int|8
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  has %spower&bslash;n&quot;
comma
(paren
id|portstat
op_amp
l_int|0x100
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;no &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %s speed&bslash;n&quot;
comma
(paren
id|portstat
op_amp
l_int|0x200
)paren
ques
c_cond
l_string|&quot;low&quot;
suffix:colon
l_string|&quot;full&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Enable power to the ports */
id|printk
c_func
(paren
l_string|&quot;enabling power on all ports&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hub-&gt;nports
suffix:semicolon
id|i
op_increment
)paren
id|usb_set_port_feature
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
id|USB_PORT_FEAT_POWER
)paren
suffix:semicolon
)brace
DECL|function|hub_probe
r_static
r_int
id|hub_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
suffix:semicolon
r_struct
id|usb_hub
op_star
id|hub
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* We don&squot;t handle multi-config hubs */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* We don&squot;t handle multi-interface hubs */
r_if
c_cond
(paren
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|bNumInterfaces
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|interface
op_assign
op_amp
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Is it a hub? */
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|9
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|0
)paren
op_logical_and
(paren
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|1
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Multiple endpoints? What kind of mutant ninja-hub is this? */
r_if
c_cond
(paren
id|interface-&gt;bNumEndpoints
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Output endpoint? Curiousier and curiousier.. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
l_int|0x80
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* If it&squot;s not an interrupt endpoint, we&squot;d better punt! */
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bmAttributes
op_amp
l_int|3
)paren
op_ne
l_int|3
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* We found a hub */
id|printk
c_func
(paren
l_string|&quot;USB hub found&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hub
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|hub
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;couldn&squot;t kmalloc hub struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|hub
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|hub
)paren
)paren
suffix:semicolon
id|dev
op_member_access_from_pointer
r_private
op_assign
id|hub
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hub-&gt;event_list
)paren
suffix:semicolon
id|hub-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Record the new hub&squot;s existence */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hub_list_lock
comma
id|flags
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hub-&gt;hub_list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|hub-&gt;hub_list
comma
op_amp
id|all_hubs_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hub_list_lock
comma
id|flags
)paren
suffix:semicolon
id|usb_hub_configure
c_func
(paren
id|hub
)paren
suffix:semicolon
id|hub-&gt;irq_handle
op_assign
id|usb_request_irq
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
id|endpoint-&gt;bEndpointAddress
)paren
comma
id|hub_irq
comma
id|endpoint-&gt;bInterval
comma
id|hub
)paren
suffix:semicolon
multiline_comment|/* Wake up khubd */
id|wake_up
c_func
(paren
op_amp
id|usb_hub_wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hub_disconnect
r_static
r_void
id|hub_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_hub
op_star
id|hub
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hub_event_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Delete it and then reset it */
id|list_del
c_func
(paren
op_amp
id|hub-&gt;event_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hub-&gt;event_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|hub-&gt;hub_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hub-&gt;hub_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hub_event_lock
comma
id|flags
)paren
suffix:semicolon
id|usb_release_irq
c_func
(paren
id|hub-&gt;dev
comma
id|hub-&gt;irq_handle
)paren
suffix:semicolon
id|hub-&gt;irq_handle
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Free the memory */
id|kfree
c_func
(paren
id|hub
)paren
suffix:semicolon
)brace
DECL|function|usb_hub_port_connect_change
r_static
r_void
id|usb_hub_port_connect_change
c_func
(paren
r_struct
id|usb_device
op_star
id|hub
comma
r_int
id|port
)paren
(brace
r_struct
id|usb_device
op_star
id|usb
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_int
id|portstatus
comma
id|portchange
suffix:semicolon
id|usb_disconnect
c_func
(paren
op_amp
id|hub-&gt;children
(braket
id|port
)braket
)paren
suffix:semicolon
id|usb_set_port_feature
c_func
(paren
id|hub
comma
id|port
op_plus
l_int|1
comma
id|USB_PORT_FEAT_RESET
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* FIXME: This is from the *BSD stack, thanks! :) */
r_if
c_cond
(paren
id|usb_get_port_status
c_func
(paren
id|hub
comma
id|port
op_plus
l_int|1
comma
id|buf
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;get_port_status failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|portstatus
op_assign
id|le16_to_cpup
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|buf
op_plus
l_int|0
)paren
suffix:semicolon
id|portchange
op_assign
id|le16_to_cpup
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|buf
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|portstatus
op_amp
id|USB_PORT_STAT_CONNECTION
)paren
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|portstatus
op_amp
id|USB_PORT_STAT_ENABLE
)paren
)paren
)paren
(brace
multiline_comment|/* We&squot;re done now, we already disconnected the device */
multiline_comment|/* printk(&quot;not connected/enabled&bslash;n&quot;); */
r_return
suffix:semicolon
)brace
id|usb
op_assign
id|hub-&gt;bus-&gt;op
op_member_access_from_pointer
id|allocate
c_func
(paren
id|hub
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;couldn&squot;t allocate usb_device&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|usb_connect
c_func
(paren
id|usb
)paren
suffix:semicolon
id|usb-&gt;slow
op_assign
(paren
id|portstatus
op_amp
id|USB_PORT_STAT_LOW_SPEED
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|hub-&gt;children
(braket
id|port
)braket
op_assign
id|usb
suffix:semicolon
id|usb_new_device
c_func
(paren
id|usb
)paren
suffix:semicolon
)brace
DECL|function|usb_hub_events
r_static
r_void
id|usb_hub_events
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_int
id|portstatus
comma
id|portchange
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|list_head
op_star
id|next
comma
op_star
id|tmp
comma
op_star
id|head
op_assign
op_amp
id|hub_event_list
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
r_struct
id|usb_hub
op_star
id|hub
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hub_event_lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
id|hub
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|usb_hub
comma
id|event_list
)paren
suffix:semicolon
id|dev
op_assign
id|hub-&gt;dev
suffix:semicolon
id|next
op_assign
id|tmp-&gt;next
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hub-&gt;nports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|usb_get_port_status
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
id|buf
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;get_port_status failed&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|portstatus
op_assign
id|le16_to_cpup
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|buf
op_plus
l_int|0
)paren
suffix:semicolon
id|portchange
op_assign
id|le16_to_cpup
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|buf
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portchange
op_amp
id|USB_PORT_STAT_C_CONNECTION
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hub: port %d connection change&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|usb_clear_port_feature
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
id|USB_PORT_FEAT_C_CONNECTION
)paren
suffix:semicolon
id|usb_hub_port_connect_change
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|portchange
op_amp
id|USB_PORT_STAT_C_ENABLE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hub: port %d enable change&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|usb_clear_port_feature
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
id|USB_PORT_FEAT_C_ENABLE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|portchange
op_amp
id|USB_PORT_STAT_C_SUSPEND
)paren
id|printk
c_func
(paren
l_string|&quot;hub: port %d suspend change&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portchange
op_amp
id|USB_PORT_STAT_C_OVERCURRENT
)paren
id|printk
c_func
(paren
l_string|&quot;hub: port %d over-current change&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|portchange
op_amp
id|USB_PORT_STAT_C_RESET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hub: port %d reset change&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|usb_clear_port_feature
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
id|USB_PORT_FEAT_C_RESET
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|portchange
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|usb_get_port_status
c_func
(paren
id|dev
comma
id|i
op_plus
l_int|1
comma
id|buf
)paren
)paren
r_return
suffix:semicolon
id|portstatus
op_assign
(paren
id|buf
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|buf
(braket
l_int|0
)braket
suffix:semicolon
id|portchange
op_assign
(paren
id|buf
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_plus
id|buf
(braket
l_int|2
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub: port %d status&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %sdevice present&bslash;n&quot;
comma
(paren
id|portstatus
op_amp
l_int|1
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;no &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %s&bslash;n&quot;
comma
(paren
id|portstatus
op_amp
l_int|2
)paren
ques
c_cond
l_string|&quot;enabled&quot;
suffix:colon
l_string|&quot;disabled&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %ssuspended&bslash;n&quot;
comma
(paren
id|portstatus
op_amp
l_int|4
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %sover current&bslash;n&quot;
comma
(paren
id|portstatus
op_amp
l_int|8
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  has %spower&bslash;n&quot;
comma
(paren
id|portstatus
op_amp
l_int|0x100
)paren
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;no &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;hub:  %s speed&bslash;n&quot;
comma
(paren
id|portstatus
op_amp
l_int|0x200
)paren
ques
c_cond
l_string|&quot;low&quot;
suffix:colon
l_string|&quot;full&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|tmp
op_assign
id|next
suffix:semicolon
macro_line|#if 0
id|wait_ms
c_func
(paren
l_int|1000
)paren
suffix:semicolon
macro_line|#endif
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hub_event_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|usb_hub_thread
r_static
r_int
id|usb_hub_thread
c_func
(paren
r_void
op_star
id|__hub
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB hub driver registered&bslash;n&quot;
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This thread doesn&squot;t need any user-level access,&n;&t; * so get rid of all our resources&n;&t; */
id|exit_mm
c_func
(paren
id|current
)paren
suffix:semicolon
id|exit_files
c_func
(paren
id|current
)paren
suffix:semicolon
id|exit_fs
c_func
(paren
id|current
)paren
suffix:semicolon
multiline_comment|/* Setup a nice name */
id|strcpy
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;khubd&quot;
)paren
suffix:semicolon
multiline_comment|/* Send me a signal to get me die (for debugging) */
r_do
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|usb_hub_wait
)paren
suffix:semicolon
id|usb_hub_events
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;usb_hub_thread exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hub_driver
r_static
r_struct
id|usb_driver
id|hub_driver
op_assign
(brace
l_string|&quot;hub&quot;
comma
id|hub_probe
comma
id|hub_disconnect
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * This should be a separate module.&n; */
DECL|function|usb_hub_init
r_int
id|usb_hub_init
c_func
(paren
r_void
)paren
(brace
r_int
id|pid
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hub_event_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|all_hubs_list
)paren
suffix:semicolon
id|usb_register
c_func
(paren
op_amp
id|hub_driver
)paren
suffix:semicolon
id|pid
op_assign
id|kernel_thread
c_func
(paren
id|usb_hub_thread
comma
l_int|NULL
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_SIGHAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pid
op_ge
l_int|0
)paren
(brace
id|khubd_pid
op_assign
id|pid
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fall through if kernel_thread failed */
id|usb_deregister
c_func
(paren
op_amp
id|hub_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_hub_cleanup
r_void
id|usb_hub_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|next
comma
op_star
id|tmp
comma
op_star
id|head
op_assign
op_amp
id|all_hubs_list
suffix:semicolon
r_struct
id|usb_hub
op_star
id|hub
suffix:semicolon
r_int
r_int
id|flags
comma
id|flags2
suffix:semicolon
multiline_comment|/* Free the resources allocated by each hub */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hub_list_lock
comma
id|flags
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hub_event_lock
comma
id|flags2
)paren
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
id|hub
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|usb_hub
comma
id|hub_list
)paren
suffix:semicolon
id|next
op_assign
id|tmp-&gt;next
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|hub-&gt;event_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hub-&gt;event_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
multiline_comment|/* &amp;hub-&gt;hub_list */
id|INIT_LIST_HEAD
c_func
(paren
id|tmp
)paren
suffix:semicolon
multiline_comment|/* &amp;hub-&gt;hub_list */
multiline_comment|/* XXX we should disconnect each connected port here */
id|usb_release_irq
c_func
(paren
id|hub-&gt;dev
comma
id|hub-&gt;irq_handle
)paren
suffix:semicolon
id|hub-&gt;irq_handle
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|hub
)paren
suffix:semicolon
id|tmp
op_assign
id|next
suffix:semicolon
)brace
id|usb_deregister
c_func
(paren
op_amp
id|hub_driver
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hub_event_lock
comma
id|flags2
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hub_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* usb_hub_cleanup() */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
(def_block
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_hub_init
c_func
(paren
)paren
suffix:semicolon
)brace
)def_block
DECL|function|cleanup_module
r_void
(def_block
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|usb_hub_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
)def_block
macro_line|#endif
eof
