macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kbd_ll.h&gt;
macro_line|#include &quot;usb.h&quot;
DECL|macro|PCKBD_PRESSED
mdefine_line|#define PCKBD_PRESSED  0x00
DECL|macro|PCKBD_RELEASED
mdefine_line|#define PCKBD_RELEASED 0x80
DECL|macro|PCKBD_NEEDS_E0
mdefine_line|#define PCKBD_NEEDS_E0 0x80
DECL|macro|USBKBD_MODIFIER_BASE
mdefine_line|#define USBKBD_MODIFIER_BASE  120
DECL|macro|USBKBD_KEYCODE_OFFSET
mdefine_line|#define USBKBD_KEYCODE_OFFSET 2
DECL|macro|USBKBD_KEYCODE_COUNT
mdefine_line|#define USBKBD_KEYCODE_COUNT  6
DECL|macro|USBKBD_VALID_KEYCODE
mdefine_line|#define USBKBD_VALID_KEYCODE(key) ((unsigned char)(key) &gt; 3)
DECL|macro|USBKBD_FIND_KEYCODE
mdefine_line|#define USBKBD_FIND_KEYCODE(down, key, count) &bslash;&n;    ((unsigned char*) memscan((down), (key), (count)) &lt; ((down) + (count)))
DECL|macro|USBKBD_REPEAT_DELAY
mdefine_line|#define USBKBD_REPEAT_DELAY (HZ / 4)
DECL|macro|USBKBD_REPEAT_RATE
mdefine_line|#define USBKBD_REPEAT_RATE (HZ / 20)
DECL|struct|usb_keyboard
r_struct
id|usb_keyboard
(brace
DECL|member|dev
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
DECL|member|down
r_int
r_int
id|down
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|repeat_key
r_int
r_char
id|repeat_key
suffix:semicolon
DECL|member|repeat_timer
r_struct
id|timer_list
id|repeat_timer
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
)brace
suffix:semicolon
r_extern
r_int
r_char
id|usb_kbd_map
(braket
)braket
suffix:semicolon
r_static
r_int
id|usb_kbd_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|usb_kbd_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|usb_kbd_repeat
c_func
(paren
r_int
r_int
id|dummy
)paren
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|usb_kbd_list
)paren
suffix:semicolon
DECL|variable|usb_kbd_driver
r_static
r_struct
id|usb_driver
id|usb_kbd_driver
op_assign
(brace
l_string|&quot;keyboard&quot;
comma
id|usb_kbd_probe
comma
id|usb_kbd_disconnect
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
r_static
r_void
DECL|function|usb_kbd_handle_key
id|usb_kbd_handle_key
c_func
(paren
r_int
r_char
id|key
comma
r_int
id|down
)paren
(brace
r_int
id|scancode
op_assign
(paren
r_int
)paren
id|usb_kbd_map
(braket
id|key
)braket
suffix:semicolon
r_if
c_cond
(paren
id|scancode
)paren
(brace
r_if
c_cond
(paren
id|scancode
op_amp
id|PCKBD_NEEDS_E0
)paren
(brace
id|handle_scancode
c_func
(paren
l_int|0xe0
comma
l_int|1
)paren
suffix:semicolon
)brace
id|handle_scancode
c_func
(paren
(paren
id|scancode
op_amp
op_complement
id|PCKBD_NEEDS_E0
)paren
comma
id|down
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|usb_kbd_repeat
id|usb_kbd_repeat
c_func
(paren
r_int
r_int
id|dev_id
)paren
(brace
r_struct
id|usb_keyboard
op_star
id|kbd
op_assign
(paren
r_struct
id|usb_keyboard
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd-&gt;repeat_key
)paren
(brace
id|usb_kbd_handle_key
c_func
(paren
id|kbd-&gt;repeat_key
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* reset repeat timer */
id|kbd-&gt;repeat_timer.function
op_assign
id|usb_kbd_repeat
suffix:semicolon
id|kbd-&gt;repeat_timer.expires
op_assign
id|jiffies
op_plus
id|USBKBD_REPEAT_RATE
suffix:semicolon
id|kbd-&gt;repeat_timer.data
op_assign
(paren
r_int
r_int
)paren
id|kbd
suffix:semicolon
id|kbd-&gt;repeat_timer.prev
op_assign
l_int|NULL
suffix:semicolon
id|kbd-&gt;repeat_timer.next
op_assign
l_int|NULL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|kbd-&gt;repeat_timer
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|usb_kbd_irq
id|usb_kbd_irq
c_func
(paren
r_int
id|state
comma
r_void
op_star
id|buffer
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|usb_keyboard
op_star
id|kbd
op_assign
(paren
r_struct
id|usb_keyboard
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
op_star
id|down
op_assign
(paren
r_int
r_int
op_star
)paren
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|kbd-&gt;down
(braket
l_int|0
)braket
op_ne
id|down
(braket
l_int|0
)braket
op_logical_or
id|kbd-&gt;down
(braket
l_int|1
)braket
op_ne
id|down
(braket
l_int|1
)braket
)paren
(brace
r_int
r_char
op_star
id|olddown
comma
op_star
id|newdown
suffix:semicolon
r_int
r_char
id|modsdelta
comma
id|key
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* handle modifier change */
id|modsdelta
op_assign
(paren
op_star
(paren
r_int
r_char
op_star
)paren
id|down
op_xor
op_star
(paren
r_int
r_char
op_star
)paren
id|kbd-&gt;down
)paren
suffix:semicolon
r_if
c_cond
(paren
id|modsdelta
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|modsdelta
op_amp
l_int|0x01
)paren
(brace
r_int
id|pressed
op_assign
(paren
op_star
(paren
r_int
r_char
op_star
)paren
id|down
op_rshift
id|i
)paren
op_amp
l_int|0x01
suffix:semicolon
id|usb_kbd_handle_key
c_func
(paren
id|i
op_plus
id|USBKBD_MODIFIER_BASE
comma
id|pressed
)paren
suffix:semicolon
)brace
id|modsdelta
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
id|olddown
op_assign
(paren
r_int
r_char
op_star
)paren
id|kbd-&gt;down
op_plus
id|USBKBD_KEYCODE_OFFSET
suffix:semicolon
id|newdown
op_assign
(paren
r_int
r_char
op_star
)paren
id|down
op_plus
id|USBKBD_KEYCODE_OFFSET
suffix:semicolon
multiline_comment|/* handle released keys */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USBKBD_KEYCODE_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|key
op_assign
id|olddown
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|USBKBD_VALID_KEYCODE
c_func
(paren
id|key
)paren
op_logical_and
op_logical_neg
id|USBKBD_FIND_KEYCODE
c_func
(paren
id|newdown
comma
id|key
comma
id|USBKBD_KEYCODE_COUNT
)paren
)paren
(brace
id|usb_kbd_handle_key
c_func
(paren
id|key
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* handle pressed keys */
id|kbd-&gt;repeat_key
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USBKBD_KEYCODE_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|key
op_assign
id|newdown
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|USBKBD_VALID_KEYCODE
c_func
(paren
id|key
)paren
op_logical_and
op_logical_neg
id|USBKBD_FIND_KEYCODE
c_func
(paren
id|olddown
comma
id|key
comma
id|USBKBD_KEYCODE_COUNT
)paren
)paren
(brace
id|usb_kbd_handle_key
c_func
(paren
id|key
comma
l_int|1
)paren
suffix:semicolon
id|kbd-&gt;repeat_key
op_assign
id|key
suffix:semicolon
)brace
)brace
multiline_comment|/* set repeat timer if any keys were pressed */
r_if
c_cond
(paren
id|kbd-&gt;repeat_key
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|kbd-&gt;repeat_timer
)paren
suffix:semicolon
id|kbd-&gt;repeat_timer.function
op_assign
id|usb_kbd_repeat
suffix:semicolon
id|kbd-&gt;repeat_timer.expires
op_assign
id|jiffies
op_plus
id|USBKBD_REPEAT_DELAY
suffix:semicolon
id|kbd-&gt;repeat_timer.data
op_assign
(paren
r_int
r_int
)paren
id|kbd
suffix:semicolon
id|kbd-&gt;repeat_timer.prev
op_assign
l_int|NULL
suffix:semicolon
id|kbd-&gt;repeat_timer.next
op_assign
l_int|NULL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|kbd-&gt;repeat_timer
)paren
suffix:semicolon
)brace
id|kbd-&gt;down
(braket
l_int|0
)braket
op_assign
id|down
(braket
l_int|0
)braket
suffix:semicolon
id|kbd-&gt;down
(braket
l_int|1
)braket
op_assign
id|down
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|usb_kbd_probe
id|usb_kbd_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
suffix:semicolon
r_struct
id|usb_keyboard
op_star
id|kbd
suffix:semicolon
id|interface
op_assign
op_amp
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
suffix:semicolon
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|3
op_logical_or
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|1
op_logical_or
id|interface-&gt;bInterfaceProtocol
op_ne
l_int|1
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB HID boot protocol keyboard detected.&bslash;n&quot;
)paren
suffix:semicolon
id|kbd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|usb_keyboard
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd
)paren
(brace
id|memset
c_func
(paren
id|kbd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|kbd
)paren
)paren
suffix:semicolon
id|kbd-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev
op_member_access_from_pointer
r_private
op_assign
id|kbd
suffix:semicolon
id|usb_set_configuration
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|bConfigurationValue
)paren
suffix:semicolon
id|usb_set_protocol
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|usb_set_idle
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|usb_request_irq
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
id|endpoint-&gt;bEndpointAddress
)paren
comma
id|usb_kbd_irq
comma
id|endpoint-&gt;bInterval
comma
id|kbd
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|kbd-&gt;list
comma
op_amp
id|usb_kbd_list
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|usb_kbd_disconnect
id|usb_kbd_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_keyboard
op_star
id|kbd
op_assign
(paren
r_struct
id|usb_keyboard
op_star
)paren
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|kbd
)paren
(brace
id|dev
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|kbd-&gt;list
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|kbd-&gt;repeat_timer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|kbd
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB HID boot protocol keyboard removed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_int
DECL|function|usb_kbd_init
id|usb_kbd_init
c_func
(paren
r_void
)paren
(brace
id|usb_register
c_func
(paren
op_amp
id|usb_kbd_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
