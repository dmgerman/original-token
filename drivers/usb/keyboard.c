multiline_comment|/*&n;&t;Fixes:&n;&t;1999/09/04 - Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n;&t;&t;Handle states in usb_kbd_irq&n;&t;1999/09/06 - Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n;&t;&t;rmmod usb-keyboard doesn&squot;t crash the system anymore: the irq&n;&t;&t;handlers are correctly released with usb_release_irq&n;*/
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kbd_ll.h&gt;
macro_line|#include &quot;usb.h&quot;
DECL|macro|PCKBD_PRESSED
mdefine_line|#define PCKBD_PRESSED  0x00
DECL|macro|PCKBD_RELEASED
mdefine_line|#define PCKBD_RELEASED 0x80
DECL|macro|PCKBD_NEEDS_E0
mdefine_line|#define PCKBD_NEEDS_E0 0x80
DECL|macro|USBKBD_MODIFIER_BASE
mdefine_line|#define USBKBD_MODIFIER_BASE  224
DECL|macro|USBKBD_KEYCODE_OFFSET
mdefine_line|#define USBKBD_KEYCODE_OFFSET 2
DECL|macro|USBKBD_KEYCODE_COUNT
mdefine_line|#define USBKBD_KEYCODE_COUNT  6
DECL|macro|USBKBD_VALID_KEYCODE
mdefine_line|#define USBKBD_VALID_KEYCODE(key) ((unsigned char)(key) &gt; 3)
DECL|macro|USBKBD_FIND_KEYCODE
mdefine_line|#define USBKBD_FIND_KEYCODE(down, key, count) &bslash;&n;    ((unsigned char*) memscan((down), (key), (count)) &lt; ((down) + (count)))
DECL|macro|USBKBD_REPEAT_DELAY
mdefine_line|#define USBKBD_REPEAT_DELAY (HZ / 4)
DECL|macro|USBKBD_REPEAT_RATE
mdefine_line|#define USBKBD_REPEAT_RATE (HZ / 20)
DECL|struct|usb_keyboard
r_struct
id|usb_keyboard
(brace
DECL|member|dev
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
DECL|member|down
r_int
r_int
id|down
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|repeat_key
r_int
r_char
id|repeat_key
suffix:semicolon
DECL|member|repeat_timer
r_struct
id|timer_list
id|repeat_timer
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|irqpipe
r_int
r_int
id|irqpipe
suffix:semicolon
DECL|member|irq_handler
r_void
op_star
id|irq_handler
suffix:semicolon
multiline_comment|/* host controller&squot;s IRQ transfer handle */
)brace
suffix:semicolon
r_extern
r_int
r_char
id|usb_kbd_map
(braket
)braket
suffix:semicolon
r_static
r_void
op_star
id|usb_kbd_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|i
)paren
suffix:semicolon
r_static
r_void
id|usb_kbd_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|usb_kbd_repeat
c_func
(paren
r_int
r_int
id|dummy
)paren
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|usb_kbd_list
)paren
suffix:semicolon
DECL|variable|usb_kbd_driver
r_static
r_struct
id|usb_driver
id|usb_kbd_driver
op_assign
(brace
l_string|&quot;keyboard&quot;
comma
id|usb_kbd_probe
comma
id|usb_kbd_disconnect
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|function|usb_kbd_handle_key
r_static
r_void
id|usb_kbd_handle_key
c_func
(paren
r_int
r_char
id|key
comma
r_int
id|down
)paren
(brace
r_int
id|scancode
op_assign
(paren
r_int
)paren
id|usb_kbd_map
(braket
id|key
)braket
suffix:semicolon
r_if
c_cond
(paren
id|scancode
)paren
(brace
macro_line|#ifndef CONFIG_MAC_KEYBOARD
r_if
c_cond
(paren
id|scancode
op_amp
id|PCKBD_NEEDS_E0
)paren
(brace
id|handle_scancode
c_func
(paren
l_int|0xe0
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_MAC_KEYBOARD */
id|handle_scancode
c_func
(paren
(paren
id|scancode
op_amp
op_complement
id|PCKBD_NEEDS_E0
)paren
comma
id|down
)paren
suffix:semicolon
)brace
)brace
DECL|function|usb_kbd_repeat
r_static
r_void
id|usb_kbd_repeat
c_func
(paren
r_int
r_int
id|dev_id
)paren
(brace
r_struct
id|usb_keyboard
op_star
id|kbd
op_assign
(paren
r_struct
id|usb_keyboard
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd-&gt;repeat_key
)paren
(brace
id|usb_kbd_handle_key
c_func
(paren
id|kbd-&gt;repeat_key
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* reset repeat timer */
id|kbd-&gt;repeat_timer.function
op_assign
id|usb_kbd_repeat
suffix:semicolon
id|kbd-&gt;repeat_timer.expires
op_assign
id|jiffies
op_plus
id|USBKBD_REPEAT_RATE
suffix:semicolon
id|kbd-&gt;repeat_timer.data
op_assign
(paren
r_int
r_int
)paren
id|kbd
suffix:semicolon
id|kbd-&gt;repeat_timer.prev
op_assign
l_int|NULL
suffix:semicolon
id|kbd-&gt;repeat_timer.next
op_assign
l_int|NULL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|kbd-&gt;repeat_timer
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|usb_kbd_irq
r_static
r_int
id|usb_kbd_irq
c_func
(paren
r_int
id|state
comma
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|usb_keyboard
op_star
id|kbd
op_assign
(paren
r_struct
id|usb_keyboard
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
op_star
id|down
op_assign
(paren
r_int
r_int
op_star
)paren
id|buffer
suffix:semicolon
multiline_comment|/*&n;&t; * USB_ST_NOERROR is the normal case.&n;&t; * USB_ST_REMOVED occurs if keyboard disconnected&n;&t; * On other states, ignore&n;&t; */
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|USB_ST_REMOVED
suffix:colon
r_case
id|USB_ST_INTERNALERROR
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s(%d): Suspending&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* disable */
r_case
id|USB_ST_NOERROR
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* ignore */
)brace
r_if
c_cond
(paren
id|kbd-&gt;down
(braket
l_int|0
)braket
op_ne
id|down
(braket
l_int|0
)braket
op_logical_or
id|kbd-&gt;down
(braket
l_int|1
)braket
op_ne
id|down
(braket
l_int|1
)braket
)paren
(brace
r_int
r_char
op_star
id|olddown
comma
op_star
id|newdown
suffix:semicolon
r_int
r_char
id|modsdelta
comma
id|key
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* handle modifier change */
id|modsdelta
op_assign
(paren
op_star
(paren
r_int
r_char
op_star
)paren
id|down
op_xor
op_star
(paren
r_int
r_char
op_star
)paren
id|kbd
op_member_access_from_pointer
id|down
)paren
suffix:semicolon
r_if
c_cond
(paren
id|modsdelta
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|modsdelta
op_amp
l_int|0x01
)paren
(brace
r_int
id|pressed
op_assign
(paren
op_star
(paren
r_int
r_char
op_star
)paren
id|down
op_rshift
id|i
)paren
op_amp
l_int|0x01
suffix:semicolon
id|usb_kbd_handle_key
c_func
(paren
id|i
op_plus
id|USBKBD_MODIFIER_BASE
comma
id|pressed
)paren
suffix:semicolon
)brace
id|modsdelta
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
id|olddown
op_assign
(paren
r_int
r_char
op_star
)paren
id|kbd-&gt;down
op_plus
id|USBKBD_KEYCODE_OFFSET
suffix:semicolon
id|newdown
op_assign
(paren
r_int
r_char
op_star
)paren
id|down
op_plus
id|USBKBD_KEYCODE_OFFSET
suffix:semicolon
multiline_comment|/* handle released keys */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USBKBD_KEYCODE_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|key
op_assign
id|olddown
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|USBKBD_VALID_KEYCODE
c_func
(paren
id|key
)paren
op_logical_and
op_logical_neg
id|USBKBD_FIND_KEYCODE
c_func
(paren
id|newdown
comma
id|key
comma
id|USBKBD_KEYCODE_COUNT
)paren
)paren
(brace
id|usb_kbd_handle_key
c_func
(paren
id|key
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* handle pressed keys */
id|kbd-&gt;repeat_key
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USBKBD_KEYCODE_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|key
op_assign
id|newdown
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|USBKBD_VALID_KEYCODE
c_func
(paren
id|key
)paren
op_logical_and
op_logical_neg
id|USBKBD_FIND_KEYCODE
c_func
(paren
id|olddown
comma
id|key
comma
id|USBKBD_KEYCODE_COUNT
)paren
)paren
(brace
id|usb_kbd_handle_key
c_func
(paren
id|key
comma
l_int|1
)paren
suffix:semicolon
id|kbd-&gt;repeat_key
op_assign
id|key
suffix:semicolon
)brace
)brace
multiline_comment|/* set repeat timer if any keys were pressed */
r_if
c_cond
(paren
id|kbd-&gt;repeat_key
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|kbd-&gt;repeat_timer
)paren
suffix:semicolon
id|kbd-&gt;repeat_timer.function
op_assign
id|usb_kbd_repeat
suffix:semicolon
id|kbd-&gt;repeat_timer.expires
op_assign
id|jiffies
op_plus
id|USBKBD_REPEAT_DELAY
suffix:semicolon
id|kbd-&gt;repeat_timer.data
op_assign
(paren
r_int
r_int
)paren
id|kbd
suffix:semicolon
id|kbd-&gt;repeat_timer.prev
op_assign
l_int|NULL
suffix:semicolon
id|kbd-&gt;repeat_timer.next
op_assign
l_int|NULL
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|kbd-&gt;repeat_timer
)paren
suffix:semicolon
)brace
id|kbd-&gt;down
(braket
l_int|0
)braket
op_assign
id|down
(braket
l_int|0
)braket
suffix:semicolon
id|kbd-&gt;down
(braket
l_int|1
)braket
op_assign
id|down
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|usb_kbd_probe
r_static
r_void
op_star
id|usb_kbd_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|i
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
suffix:semicolon
r_struct
id|usb_keyboard
op_star
id|kbd
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|interface
op_assign
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|i
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|3
op_logical_or
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|1
op_logical_or
id|interface-&gt;bInterfaceProtocol
op_ne
l_int|1
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB HID boot protocol keyboard detected.&bslash;n&quot;
)paren
suffix:semicolon
id|kbd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|usb_keyboard
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd
)paren
(brace
id|memset
c_func
(paren
id|kbd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|kbd
)paren
)paren
suffix:semicolon
id|kbd-&gt;dev
op_assign
id|dev
suffix:semicolon
id|usb_set_protocol
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|usb_set_idle
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|kbd-&gt;irqpipe
op_assign
id|usb_rcvintpipe
c_func
(paren
id|dev
comma
id|endpoint-&gt;bEndpointAddress
)paren
suffix:semicolon
id|ret
op_assign
id|usb_request_irq
c_func
(paren
id|dev
comma
id|kbd-&gt;irqpipe
comma
id|usb_kbd_irq
comma
id|endpoint-&gt;bInterval
comma
id|kbd
comma
op_amp
id|kbd-&gt;irq_handler
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;usb-keyboard failed usb_request_irq (0x%x)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|probe_err
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|kbd-&gt;list
comma
op_amp
id|usb_kbd_list
)paren
suffix:semicolon
r_return
id|kbd
suffix:semicolon
)brace
id|probe_err
suffix:colon
r_if
c_cond
(paren
id|kbd
)paren
id|kfree
c_func
(paren
id|kbd
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|usb_kbd_disconnect
r_static
r_void
id|usb_kbd_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|usb_keyboard
op_star
id|kbd
op_assign
(paren
r_struct
id|usb_keyboard
op_star
)paren
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|kbd
)paren
(brace
id|usb_release_irq
c_func
(paren
id|dev
comma
id|kbd-&gt;irq_handler
comma
id|kbd-&gt;irqpipe
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|kbd-&gt;list
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|kbd-&gt;repeat_timer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|kbd
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB HID boot protocol keyboard removed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|usb_kbd_init
r_int
id|usb_kbd_init
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_register
c_func
(paren
op_amp
id|usb_kbd_driver
)paren
suffix:semicolon
)brace
DECL|function|usb_kbd_cleanup
r_void
id|usb_kbd_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|cur
comma
op_star
id|head
op_assign
op_amp
id|usb_kbd_list
suffix:semicolon
id|cur
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|cur
op_ne
id|head
)paren
(brace
r_struct
id|usb_keyboard
op_star
id|kbd
op_assign
id|list_entry
c_func
(paren
id|cur
comma
r_struct
id|usb_keyboard
comma
id|list
)paren
suffix:semicolon
id|cur
op_assign
id|cur-&gt;next
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|kbd-&gt;list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|kbd-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd-&gt;irq_handler
)paren
(brace
id|usb_release_irq
c_func
(paren
id|kbd-&gt;dev
comma
id|kbd-&gt;irq_handler
comma
id|kbd-&gt;irqpipe
)paren
suffix:semicolon
multiline_comment|/* never keep a reference to a released IRQ! */
id|kbd-&gt;irq_handler
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|usb_deregister
c_func
(paren
op_amp
id|usb_kbd_driver
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_kbd_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|usb_kbd_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
