multiline_comment|/*&n; * drivers/usb/proc_usb.c&n; * (C) Copyright 1999 Randy Dunlap.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; *&n; *************************************************************&n; *&n; * This is a /proc/bus/usb filesystem output module for USB.&n; * It creates /proc/bus/usb/drivers and /proc/bus/usb/devices.&n; *&n; * /proc/bus/usb/devices contains USB topology, device, config, class,&n; * interface, &amp; endpoint data.&n; *&n; * I considered using /proc/bus/usb/devices/device# for each device&n; * as it is attached or detached, but I didn&squot;t like this for some&n; * reason -- maybe it&squot;s just too deep of a directory structure.&n; * I also don&squot;t like looking in multiple places to gather and view&n; * the data.  Having only one file for ./devices also prevents race&n; * conditions that could arise if a program was reading device info&n; * for devices that are being removed (unplugged).  (That is, the&n; * program may find a directory for devnum_12 then try to open it,&n; * but it was just unplugged, so the directory is now deleted.&n; * But programs would just have to be prepared for situations like&n; * this in any plug-and-play environment.)&n; */
DECL|macro|__KERNEL__
mdefine_line|#define __KERNEL__&t;1
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
multiline_comment|/* #include &lt;linux/module.h&gt; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &quot;usb.h&quot;
DECL|macro|DUMP_LIMIT
mdefine_line|#define DUMP_LIMIT&t;&t;(PAGE_SIZE - 100)
multiline_comment|/* limit to only one memory page of output */
DECL|macro|MAX_TOPO_LEVEL
mdefine_line|#define MAX_TOPO_LEVEL&t;&t;6
DECL|variable|format_topo
r_static
r_char
op_star
id|format_topo
op_assign
multiline_comment|/* T:  Lev=dd Prnt=dd Port=dd Cnt=dd Dev#=ddd Spd=ddd If#=ddd MxCh=dd Driver=%s */
l_string|&quot;T:  Lev=%2.2d Prnt=%2.2d Port=%2.2d Cnt=%2.2d Dev#=%3d Spd=%3s If#=%3d MxCh=%2d Driver=%s&bslash;n&quot;
suffix:semicolon
DECL|variable|format_device1
r_static
r_char
op_star
id|format_device1
op_assign
multiline_comment|/* D:  Ver=xx.xx Cls=xx(sssss) Sub=xx Prot=xx MxPS=dd #Cfgs=dd */
l_string|&quot;D:  Ver=%2x.%02x Cls=%02x(%-5s) Sub=%02x Prot=%02x MxPS=%2d #Cfgs=%3d&bslash;n&quot;
suffix:semicolon
DECL|variable|format_device2
r_static
r_char
op_star
id|format_device2
op_assign
multiline_comment|/* P:  Vendor=xxxx ProdID=xxxx Rev=xx.xx */
l_string|&quot;P:  Vendor=%04x ProdID=%04x Rev=%2x.%02x&bslash;n&quot;
suffix:semicolon
DECL|variable|format_config
r_static
r_char
op_star
id|format_config
op_assign
multiline_comment|/* C:  #Ifs=dd Cfg#=dd Atr=xx MPwr=dddmA */
l_string|&quot;C:%c #Ifs=%2d Cfg#=%2d Atr=%02x MxPwr=%3dmA&bslash;n&quot;
suffix:semicolon
DECL|variable|format_iface
r_static
r_char
op_star
id|format_iface
op_assign
multiline_comment|/* I:  If#=dd Alt=dd #EPs=dd Cls=xx(sssss) Sub=xx Prot=xx */
l_string|&quot;I:  If#=%2d Alt=%2d #EPs=%2d Cls=%02x(%-5s) Sub=%02x Prot=%02x&bslash;n&quot;
suffix:semicolon
DECL|variable|format_endpt
r_static
r_char
op_star
id|format_endpt
op_assign
multiline_comment|/* E:  Ad=xx(s) Atr=xx(ssss) MxPS=dddd Ivl=dddms */
l_string|&quot;E:  Ad=%02x(%c) Atr=%02x(%-4s) MxPS=%4d Ivl=%3dms&bslash;n&quot;
suffix:semicolon
multiline_comment|/*&n; * Need access to the driver and USB bus lists.&n; * extern struct list_head usb_driver_list;&n; * extern struct list_head usb_bus_list;&n; * However, these will come from functions that return ptrs to each of them.&n; */
r_extern
r_struct
id|list_head
op_star
id|usb_driver_get_list
(paren
r_void
)paren
suffix:semicolon
r_extern
r_struct
id|list_head
op_star
id|usb_bus_get_list
(paren
r_void
)paren
suffix:semicolon
r_extern
r_struct
id|proc_dir_entry
op_star
id|proc_bus
suffix:semicolon
DECL|variable|usbdir
DECL|variable|driversdir
r_static
r_struct
id|proc_dir_entry
op_star
id|usbdir
op_assign
l_int|NULL
comma
op_star
id|driversdir
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|devicesdir
r_static
r_struct
id|proc_dir_entry
op_star
id|devicesdir
op_assign
l_int|NULL
suffix:semicolon
DECL|struct|class_info
r_struct
id|class_info
(brace
DECL|member|class
r_int
r_class
suffix:semicolon
DECL|member|class_name
r_char
op_star
id|class_name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|clas_info
r_struct
id|class_info
id|clas_info
(braket
)braket
op_assign
(brace
multiline_comment|/* max. 5 chars. per name string */
(brace
id|USB_CLASS_PER_INTERFACE
comma
l_string|&quot;&gt;ifc&quot;
)brace
comma
(brace
id|USB_CLASS_AUDIO
comma
l_string|&quot;audio&quot;
)brace
comma
(brace
id|USB_CLASS_COMM
comma
l_string|&quot;comm.&quot;
)brace
comma
(brace
id|USB_CLASS_HID
comma
l_string|&quot;HID&quot;
)brace
comma
(brace
id|USB_CLASS_HUB
comma
l_string|&quot;hub&quot;
)brace
comma
(brace
id|USB_CLASS_PRINTER
comma
l_string|&quot;print&quot;
)brace
comma
(brace
id|USB_CLASS_MASS_STORAGE
comma
l_string|&quot;stor.&quot;
)brace
comma
(brace
id|USB_CLASS_VENDOR_SPEC
comma
l_string|&quot;vend.&quot;
)brace
comma
(brace
op_minus
l_int|1
comma
l_string|&quot;unk.&quot;
)brace
multiline_comment|/* leave as last */
)brace
suffix:semicolon
multiline_comment|/*****************************************************************/
DECL|function|class_decode
r_static
r_char
op_star
id|class_decode
(paren
r_const
r_int
r_class
)paren
(brace
r_int
id|ix
suffix:semicolon
r_for
c_loop
(paren
id|ix
op_assign
l_int|0
suffix:semicolon
id|clas_info
(braket
id|ix
)braket
dot
r_class
op_ne
op_minus
l_int|1
suffix:semicolon
id|ix
op_increment
)paren
r_if
c_cond
(paren
id|clas_info
(braket
id|ix
)braket
dot
r_class
op_eq
r_class
)paren
r_break
suffix:semicolon
r_return
(paren
id|clas_info
(braket
id|ix
)braket
dot
id|class_name
)paren
suffix:semicolon
)brace
DECL|function|usb_dump_endpoint_descriptor
r_static
r_int
id|usb_dump_endpoint_descriptor
(paren
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|desc
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
r_char
op_star
id|EndpointType
(braket
l_int|4
)braket
op_assign
(brace
l_string|&quot;Ctrl&quot;
comma
l_string|&quot;Isoc&quot;
comma
l_string|&quot;Bulk&quot;
comma
l_string|&quot;Int.&quot;
)brace
suffix:semicolon
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
id|format_endpt
comma
id|desc-&gt;bEndpointAddress
comma
(paren
id|desc-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
ques
c_cond
l_char|&squot;I&squot;
suffix:colon
l_char|&squot;O&squot;
comma
id|desc-&gt;bmAttributes
comma
id|EndpointType
(braket
id|desc-&gt;bmAttributes
op_amp
l_int|3
)braket
comma
id|desc-&gt;wMaxPacketSize
comma
id|desc-&gt;bInterval
)paren
suffix:semicolon
r_return
(paren
op_star
id|len
op_ge
id|DUMP_LIMIT
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|usb_dump_endpoint
r_static
r_int
id|usb_dump_endpoint
(paren
r_const
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
r_if
c_cond
(paren
id|usb_dump_endpoint_descriptor
(paren
id|endpoint
comma
id|buf
comma
id|len
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_dump_interface_descriptor
r_static
r_int
id|usb_dump_interface_descriptor
(paren
r_const
r_struct
id|usb_interface_descriptor
op_star
id|desc
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
id|format_iface
comma
id|desc-&gt;bInterfaceNumber
comma
id|desc-&gt;bAlternateSetting
comma
id|desc-&gt;bNumEndpoints
comma
id|desc-&gt;bInterfaceClass
comma
id|class_decode
(paren
id|desc-&gt;bInterfaceClass
)paren
comma
id|desc-&gt;bInterfaceSubClass
comma
id|desc-&gt;bInterfaceProtocol
)paren
suffix:semicolon
r_return
(paren
op_star
id|len
op_ge
id|DUMP_LIMIT
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|usb_dump_interface
r_static
r_int
id|usb_dump_interface
(paren
r_const
r_struct
id|usb_interface_descriptor
op_star
id|interface
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|usb_dump_interface_descriptor
(paren
id|interface
comma
id|buf
comma
id|len
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|interface-&gt;bNumEndpoints
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|usb_dump_endpoint
(paren
id|interface-&gt;endpoint
op_plus
id|i
comma
id|buf
comma
id|len
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TBD:&n; * 0. TBDs&n; * 1. marking active config and ifaces (code lists all, but should mark&n; *    which ones are active, if any)&n; * 2. Add proc_usb_init() call from usb-core.c.&n; * 3. proc_usb as a MODULE ?&n; * 4. use __initfunc() ?&n; * 5. add &lt;halted&gt; status to each endpoint line&n; */
DECL|function|usb_dump_config_descriptor
r_static
r_int
id|usb_dump_config_descriptor
(paren
r_const
r_struct
id|usb_config_descriptor
op_star
id|desc
comma
r_const
r_int
id|active
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
id|format_config
comma
id|active
ques
c_cond
l_char|&squot;*&squot;
suffix:colon
l_char|&squot; &squot;
comma
multiline_comment|/* mark active/actual/current cfg. */
id|desc-&gt;bNumInterfaces
comma
id|desc-&gt;bConfigurationValue
comma
id|desc-&gt;bmAttributes
comma
id|desc-&gt;MaxPower
op_star
l_int|2
)paren
suffix:semicolon
r_return
(paren
op_star
id|len
op_ge
id|DUMP_LIMIT
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|usb_dump_config
r_static
r_int
id|usb_dump_config
(paren
r_const
r_struct
id|usb_config_descriptor
op_star
id|config
comma
r_const
r_int
id|active
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|usb_interface
op_star
id|intf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|config
)paren
(brace
multiline_comment|/* getting these some in 2.3.7; none in 2.3.6 */
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
l_string|&quot;(null Cfg. desc.)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_dump_config_descriptor
(paren
id|config
comma
id|active
comma
id|buf
comma
id|len
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;bNumInterfaces
suffix:semicolon
id|i
op_increment
)paren
(brace
id|intf
op_assign
id|config-&gt;interface
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|intf
)paren
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|intf-&gt;num_altsetting
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|usb_dump_interface
(paren
id|intf-&gt;altsetting
op_plus
id|j
comma
id|buf
comma
id|len
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Dump the different USB descriptors.&n; */
DECL|function|usb_dump_device_descriptor
r_static
r_int
id|usb_dump_device_descriptor
(paren
r_const
r_struct
id|usb_device_descriptor
op_star
id|desc
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
id|format_device1
comma
id|desc-&gt;bcdUSB
op_rshift
l_int|8
comma
id|desc-&gt;bcdUSB
op_amp
l_int|0xff
comma
id|desc-&gt;bDeviceClass
comma
id|class_decode
(paren
id|desc-&gt;bDeviceClass
)paren
comma
id|desc-&gt;bDeviceSubClass
comma
id|desc-&gt;bDeviceProtocol
comma
id|desc-&gt;bMaxPacketSize0
comma
id|desc-&gt;bNumConfigurations
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
op_ge
id|DUMP_LIMIT
)paren
r_return
op_minus
l_int|1
suffix:semicolon
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
id|format_device2
comma
id|desc-&gt;idVendor
comma
id|desc-&gt;idProduct
comma
id|desc-&gt;bcdDevice
op_rshift
l_int|8
comma
id|desc-&gt;bcdDevice
op_amp
l_int|0xff
)paren
suffix:semicolon
r_return
(paren
op_star
id|len
op_ge
id|DUMP_LIMIT
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|usb_dump_desc
r_static
r_int
id|usb_dump_desc
(paren
r_const
r_struct
id|usb_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|usb_dump_device_descriptor
(paren
op_amp
id|dev-&gt;descriptor
comma
id|buf
comma
id|len
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|usb_dump_config
(paren
id|dev-&gt;config
op_plus
id|i
comma
(paren
id|dev-&gt;config
op_plus
id|i
)paren
op_eq
id|dev-&gt;actconfig
comma
multiline_comment|/* active ? */
id|buf
comma
id|len
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef PROC_EXTRA /* TBD: may want to add this code later */
DECL|function|usb_dump_hub_descriptor
r_static
r_int
id|usb_dump_hub_descriptor
(paren
r_const
r_struct
id|usb_hub_descriptor
op_star
id|desc
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
r_int
id|leng
op_assign
id|USB_DT_HUB_NONVAR_SIZE
suffix:semicolon
r_int
r_char
op_star
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|desc
suffix:semicolon
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
l_string|&quot;Interface:&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|leng
)paren
(brace
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
l_string|&quot; %02x&quot;
comma
op_star
id|ptr
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
id|leng
op_decrement
suffix:semicolon
)brace
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_star
id|len
op_ge
id|DUMP_LIMIT
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|usb_dump_string
r_static
r_int
id|usb_dump_string
(paren
r_const
r_struct
id|usb_device
op_star
id|dev
comma
r_char
op_star
id|id
comma
r_int
id|index
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|len
)paren
(brace
r_if
c_cond
(paren
id|index
op_le
id|dev-&gt;maxstring
op_logical_and
id|dev-&gt;stringindex
op_logical_and
id|dev-&gt;stringindex
(braket
id|index
)braket
)paren
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
l_string|&quot;%s: %s &quot;
comma
id|id
comma
id|dev-&gt;stringindex
(braket
id|index
)braket
)paren
suffix:semicolon
r_return
(paren
op_star
id|len
op_ge
id|DUMP_LIMIT
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* PROC_EXTRA */
multiline_comment|/*****************************************************************/
DECL|function|usb_device_dump
r_static
r_int
id|usb_device_dump
(paren
r_char
op_star
id|buf
comma
r_int
op_star
id|len
comma
r_const
r_struct
id|usb_device
op_star
id|usbdev
comma
r_int
id|level
comma
r_int
id|index
comma
r_int
id|count
)paren
(brace
r_int
id|chix
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
r_int
id|parent_devnum
suffix:semicolon
r_if
c_cond
(paren
id|level
OG
id|MAX_TOPO_LEVEL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|parent_devnum
op_assign
id|usbdev-&gt;parent
ques
c_cond
(paren
id|usbdev-&gt;parent-&gt;devnum
op_eq
op_minus
l_int|1
)paren
ques
c_cond
l_int|0
suffix:colon
id|usbdev-&gt;parent-&gt;devnum
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * So the root hub&squot;s parent is 0 and any device that is&n;&t;&t; * plugged into the root hub has a parent of 0.&n;&t;&t; */
op_star
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
op_star
id|len
comma
id|format_topo
comma
id|level
comma
id|parent_devnum
comma
id|index
comma
id|count
comma
id|usbdev-&gt;devnum
comma
id|usbdev-&gt;slow
ques
c_cond
l_string|&quot;1.5&quot;
suffix:colon
l_string|&quot;12 &quot;
comma
id|usbdev-&gt;ifnum
comma
id|usbdev-&gt;maxchild
comma
id|usbdev-&gt;driver
ques
c_cond
id|usbdev-&gt;driver-&gt;name
suffix:colon
(paren
id|level
op_eq
l_int|0
)paren
ques
c_cond
l_string|&quot;(root hub)&quot;
suffix:colon
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * level = topology-tier level;&n;&t;&t; * parent_devnum = parent device number;&n;&t;&t; * index = parent&squot;s connector number;&n;&t;&t; * count = device count at this level&n;&t;&t; */
r_if
c_cond
(paren
op_star
id|len
op_ge
id|DUMP_LIMIT
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|usbdev-&gt;devnum
OG
l_int|0
)paren
(brace
multiline_comment|/* for any except root hub */
r_if
c_cond
(paren
id|usb_dump_desc
(paren
id|usbdev
comma
id|buf
comma
id|len
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Now look at all of this device&squot;s children. */
r_for
c_loop
(paren
id|chix
op_assign
l_int|0
suffix:semicolon
id|chix
OL
id|usbdev-&gt;maxchild
suffix:semicolon
id|chix
op_increment
)paren
(brace
r_if
c_cond
(paren
id|usbdev-&gt;children
(braket
id|chix
)braket
)paren
(brace
r_if
c_cond
(paren
id|usb_device_dump
(paren
id|buf
comma
id|len
comma
id|usbdev-&gt;children
(braket
id|chix
)braket
comma
id|level
op_plus
l_int|1
comma
id|chix
comma
op_increment
id|cnt
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_bus_list_dump
r_static
r_int
id|usb_bus_list_dump
(paren
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_struct
id|list_head
op_star
id|usb_bus_list
op_assign
id|usb_bus_get_list
(paren
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|list
op_assign
id|usb_bus_list-&gt;next
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Go thru each usb_bus. Within each usb_bus: each usb_device.&n;&t; * Within each usb_device: all of its device &amp; config. descriptors,&n;&t; * marking the currently active ones.&n;&t; */
r_while
c_loop
(paren
id|list
op_ne
id|usb_bus_list
)paren
(brace
r_struct
id|usb_bus
op_star
id|bus
op_assign
id|list_entry
(paren
id|list
comma
r_struct
id|usb_bus
comma
id|bus_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_device_dump
(paren
id|buf
comma
op_amp
id|len
comma
id|bus-&gt;root_hub
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
id|list
op_assign
id|list-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|DUMP_LIMIT
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;(truncated)&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
DECL|function|usb_bus_list_dump_devices
r_static
r_int
id|usb_bus_list_dump_devices
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|usb_bus_list_dump
(paren
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Dump usb_driver_list.&n; *&n; * We now walk the list of registered USB drivers.&n; */
DECL|function|usb_driver_list_dump
r_static
r_int
id|usb_driver_list_dump
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|list_head
op_star
id|usb_driver_list
op_assign
id|usb_driver_get_list
(paren
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
op_assign
id|usb_driver_list-&gt;next
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|usb_driver_list
)paren
(brace
r_struct
id|usb_driver
op_star
id|driver
op_assign
id|list_entry
(paren
id|tmp
comma
r_struct
id|usb_driver
comma
id|driver_list
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|driver-&gt;name
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
id|DUMP_LIMIT
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;(truncated)&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|cnt
)paren
id|len
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;(none)&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
DECL|function|proc_usb_cleanup
r_void
id|proc_usb_cleanup
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|driversdir
)paren
id|remove_proc_entry
(paren
l_string|&quot;drivers&quot;
comma
id|usbdir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devicesdir
)paren
id|remove_proc_entry
(paren
l_string|&quot;devices&quot;
comma
id|usbdir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usbdir
)paren
id|remove_proc_entry
(paren
l_string|&quot;usb&quot;
comma
id|proc_bus
)paren
suffix:semicolon
)brace
DECL|function|proc_usb_init
r_int
id|proc_usb_init
(paren
r_void
)paren
(brace
id|usbdir
op_assign
id|create_proc_entry
(paren
l_string|&quot;usb&quot;
comma
id|S_IFDIR
comma
id|proc_bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usbdir
)paren
(brace
id|printk
(paren
l_string|&quot;proc_usb: cannot create /proc/bus/usb entry&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|driversdir
op_assign
id|create_proc_entry
(paren
l_string|&quot;drivers&quot;
comma
l_int|0
comma
id|usbdir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driversdir
)paren
(brace
id|printk
(paren
l_string|&quot;proc_usb: cannot create /proc/bus/usb/drivers entry&bslash;n&quot;
)paren
suffix:semicolon
id|proc_usb_cleanup
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|driversdir-&gt;read_proc
op_assign
id|usb_driver_list_dump
suffix:semicolon
id|devicesdir
op_assign
id|create_proc_entry
(paren
l_string|&quot;devices&quot;
comma
l_int|0
comma
id|usbdir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|devicesdir
)paren
(brace
id|printk
(paren
l_string|&quot;proc_usb: cannot create /proc/bus/usb/devices entry&bslash;n&quot;
)paren
suffix:semicolon
id|proc_usb_cleanup
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|devicesdir-&gt;read_proc
op_assign
id|usb_bus_list_dump_devices
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef PROCFS_MODULE /* TBD: support proc_fs MODULE ??? */
DECL|function|init_module
r_int
id|init_module
(paren
r_void
)paren
(brace
r_return
id|proc_usb_init
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
(paren
r_void
)paren
(brace
id|proc_usb_cleanup
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* PROCFS_MODULE */
multiline_comment|/* end proc_usb.c */
eof
