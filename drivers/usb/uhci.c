multiline_comment|/*&n; * Universal Host Controller Interface driver for USB.&n; *&n; * (C) Copyright 1999 Linus Torvalds&n; * (C) Copyright 1999-2000 Johannes Erdfelt, johannes@erdfelt.com&n; * (C) Copyright 1999 Randy Dunlap&n; * (C) Copyright 1999 Georg Acher, acher@in.tum.de&n; * (C) Copyright 1999 Deti Fliegl, deti@fliegl.de&n; * (C) Copyright 1999 Thomas Sailer, sailer@ife.ee.ethz.ch&n; * (C) Copyright 1999 Roman Weissgaerber, weissg@vienna.at&n; * (C) Copyright 2000 Yggdrasil Computing, Inc. (port of new PCI interface&n; *               support from usb-ohci.c by Adam Richter, adam@yggdrasil.com).&n; * (C) Copyright 1999 Gregory P. Smith (from usb-ohci.c)&n; *&n; *&n; * Intel documents this fairly well, and as far as I know there&n; * are no royalties or anything like that, but even so there are&n; * people who decided that they want to do the same thing in a&n; * completely different way.&n; *&n; * WARNING! The USB documentation is downright evil. Most of it&n; * is just crap, written by a committee. You&squot;re better off ignoring&n; * most of it, the important stuff is:&n; *  - the low-level protocol (fairly simple but lots of small details)&n; *  - working around the horridness of the rest&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;uhci.h&quot;
macro_line|#include &quot;uhci-debug.h&quot;
macro_line|#include &lt;linux/pm.h&gt;
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug level&quot;
)paren
suffix:semicolon
DECL|variable|uhci_td_cachep
r_static
id|kmem_cache_t
op_star
id|uhci_td_cachep
suffix:semicolon
DECL|variable|uhci_qh_cachep
r_static
id|kmem_cache_t
op_star
id|uhci_qh_cachep
suffix:semicolon
DECL|variable|uhci_up_cachep
r_static
id|kmem_cache_t
op_star
id|uhci_up_cachep
suffix:semicolon
multiline_comment|/* urb_priv */
r_static
r_int
id|rh_submit_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_int
id|rh_unlink_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_int
id|uhci_get_current_frame_number
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|uhci_unlink_generic
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_int
id|uhci_unlink_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
DECL|macro|min
mdefine_line|#define min(a,b) (((a)&lt;(b))?(a):(b))
multiline_comment|/* If a transfer is still active after this much time, turn off FSBR */
DECL|macro|IDLE_TIMEOUT
mdefine_line|#define IDLE_TIMEOUT&t;(HZ / 20)&t;/* 50 ms */
multiline_comment|/*&n; * Only the USB core should call uhci_alloc_dev and uhci_free_dev&n; */
DECL|function|uhci_alloc_dev
r_static
r_int
id|uhci_alloc_dev
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uhci_free_dev
r_static
r_int
id|uhci_free_dev
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
op_assign
op_amp
id|uhci-&gt;urb_list
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Walk through the entire URB list and forcefully remove any */
multiline_comment|/*  URBs that are still active for that device */
id|nested_lock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
r_struct
id|urb
op_star
id|u
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|urb
comma
id|urb_list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;dev
op_eq
id|dev
)paren
id|uhci_unlink_urb
c_func
(paren
id|u
)paren
suffix:semicolon
)brace
id|nested_unlock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uhci_add_urb_list
r_static
r_void
id|uhci_add_urb_list
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|nested_lock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|urb-&gt;urb_list
comma
op_amp
id|uhci-&gt;urb_list
)paren
suffix:semicolon
id|nested_unlock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_remove_urb_list
r_static
r_void
id|uhci_remove_urb_list
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|nested_lock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|urb-&gt;urb_list
)paren
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|urb-&gt;urb_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|urb-&gt;urb_list
)paren
suffix:semicolon
)brace
id|nested_unlock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_set_next_interrupt
r_void
id|uhci_set_next_interrupt
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
id|uhci-&gt;skel_term_td.status
op_or_assign
id|TD_CTRL_IOC
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_clear_next_interrupt
r_void
id|uhci_clear_next_interrupt
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
id|uhci-&gt;skel_term_td.status
op_and_assign
op_complement
id|TD_CTRL_IOC
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_alloc_td
r_static
r_struct
id|uhci_td
op_star
id|uhci_alloc_td
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|uhci_td
op_star
id|td
suffix:semicolon
id|td
op_assign
id|kmem_cache_alloc
c_func
(paren
id|uhci_td_cachep
comma
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|SLAB_ATOMIC
suffix:colon
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
l_int|NULL
suffix:semicolon
id|td-&gt;link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|td-&gt;buffer
op_assign
l_int|0
suffix:semicolon
id|td-&gt;frameptr
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;nexttd
op_assign
id|td-&gt;prevtd
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;dev
op_assign
id|dev
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|td-&gt;list
)paren
suffix:semicolon
id|usb_inc_dev_use
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|td
suffix:semicolon
)brace
DECL|function|uhci_fill_td
r_static
r_void
r_inline
id|uhci_fill_td
c_func
(paren
r_struct
id|uhci_td
op_star
id|td
comma
id|__u32
id|status
comma
id|__u32
id|info
comma
id|__u32
id|buffer
)paren
(brace
id|td-&gt;status
op_assign
id|status
suffix:semicolon
id|td-&gt;info
op_assign
id|info
suffix:semicolon
id|td-&gt;buffer
op_assign
id|buffer
suffix:semicolon
)brace
DECL|function|uhci_insert_td
r_static
r_void
id|uhci_insert_td
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|uhci_td
op_star
id|skeltd
comma
r_struct
id|uhci_td
op_star
id|td
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Fix the linked list pointers */
id|td-&gt;nexttd
op_assign
id|skeltd-&gt;nexttd
suffix:semicolon
id|td-&gt;prevtd
op_assign
id|skeltd
suffix:semicolon
r_if
c_cond
(paren
id|skeltd-&gt;nexttd
)paren
id|skeltd-&gt;nexttd-&gt;prevtd
op_assign
id|td
suffix:semicolon
id|skeltd-&gt;nexttd
op_assign
id|td
suffix:semicolon
id|td-&gt;link
op_assign
id|skeltd-&gt;link
suffix:semicolon
id|skeltd-&gt;link
op_assign
id|virt_to_bus
c_func
(paren
id|td
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * We insert Isochronous transfers directly into the frame list at the&n; * beginning&n; * The layout looks as follows:&n; * frame list pointer -&gt; iso td&squot;s (if any) -&gt;&n; * periodic interrupt td (if frame 0) -&gt; irq td&squot;s -&gt; control qh -&gt; bulk qh&n; */
DECL|function|uhci_insert_td_frame_list
r_static
r_void
id|uhci_insert_td_frame_list
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|uhci_td
op_star
id|td
comma
r_int
id|framenum
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|uhci_td
op_star
id|nexttd
suffix:semicolon
id|framenum
op_mod_assign
id|UHCI_NUMFRAMES
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
id|td-&gt;frameptr
op_assign
op_amp
id|uhci-&gt;fl-&gt;frame
(braket
id|framenum
)braket
suffix:semicolon
id|td-&gt;link
op_assign
id|uhci-&gt;fl-&gt;frame
(braket
id|framenum
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|td-&gt;link
op_amp
(paren
id|UHCI_PTR_TERM
op_or
id|UHCI_PTR_QH
)paren
)paren
)paren
(brace
id|nexttd
op_assign
(paren
r_struct
id|uhci_td
op_star
)paren
id|uhci_ptr_to_virt
c_func
(paren
id|td-&gt;link
)paren
suffix:semicolon
id|td-&gt;nexttd
op_assign
id|nexttd
suffix:semicolon
id|nexttd-&gt;prevtd
op_assign
id|td
suffix:semicolon
id|nexttd-&gt;frameptr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|uhci-&gt;fl-&gt;frame
(braket
id|framenum
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|td
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_remove_td
r_static
r_void
id|uhci_remove_td
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|uhci_td
op_star
id|td
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* If it&squot;s not inserted, don&squot;t remove it */
r_if
c_cond
(paren
op_logical_neg
id|td-&gt;frameptr
op_logical_and
op_logical_neg
id|td-&gt;prevtd
op_logical_and
op_logical_neg
id|td-&gt;nexttd
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;frameptr
)paren
(brace
op_star
(paren
id|td-&gt;frameptr
)paren
op_assign
id|td-&gt;link
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;nexttd
)paren
(brace
id|td-&gt;nexttd-&gt;frameptr
op_assign
id|td-&gt;frameptr
suffix:semicolon
id|td-&gt;nexttd-&gt;prevtd
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;nexttd
op_assign
l_int|NULL
suffix:semicolon
)brace
id|td-&gt;frameptr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|td-&gt;prevtd
)paren
(brace
id|td-&gt;prevtd-&gt;nexttd
op_assign
id|td-&gt;nexttd
suffix:semicolon
id|td-&gt;prevtd-&gt;link
op_assign
id|td-&gt;link
suffix:semicolon
)brace
r_if
c_cond
(paren
id|td-&gt;nexttd
)paren
id|td-&gt;nexttd-&gt;prevtd
op_assign
id|td-&gt;prevtd
suffix:semicolon
id|td-&gt;prevtd
op_assign
id|td-&gt;nexttd
op_assign
l_int|NULL
suffix:semicolon
)brace
id|td-&gt;link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Inserts a td into qh list at the top.&n; */
DECL|function|uhci_insert_tds_in_qh
r_static
r_void
id|uhci_insert_tds_in_qh
c_func
(paren
r_struct
id|uhci_qh
op_star
id|qh
comma
r_struct
id|urb
op_star
id|urb
comma
r_int
id|breadth
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|uhci_td
op_star
id|td
comma
op_star
id|prevtd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_return
suffix:semicolon
id|head
op_assign
op_amp
id|urbp-&gt;list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|head
op_eq
id|tmp
)paren
r_return
suffix:semicolon
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
multiline_comment|/* Add the first TD to the QH element pointer */
id|qh-&gt;element
op_assign
id|virt_to_bus
c_func
(paren
id|td
)paren
op_or
(paren
id|breadth
ques
c_cond
l_int|0
suffix:colon
id|UHCI_PTR_DEPTH
)paren
suffix:semicolon
id|prevtd
op_assign
id|td
suffix:semicolon
multiline_comment|/* Then link the rest of the TD&squot;s */
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
id|prevtd-&gt;link
op_assign
id|virt_to_bus
c_func
(paren
id|td
)paren
op_or
(paren
id|breadth
ques
c_cond
l_int|0
suffix:colon
id|UHCI_PTR_DEPTH
)paren
suffix:semicolon
id|prevtd
op_assign
id|td
suffix:semicolon
)brace
id|prevtd-&gt;link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
)brace
DECL|function|uhci_free_td
r_static
r_void
id|uhci_free_td
c_func
(paren
r_struct
id|uhci_td
op_star
id|td
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|td-&gt;list
)paren
)paren
id|dbg
c_func
(paren
l_string|&quot;td is still in URB list!&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;dev
)paren
id|usb_dec_dev_use
c_func
(paren
id|td-&gt;dev
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|uhci_td_cachep
comma
id|td
)paren
suffix:semicolon
)brace
DECL|function|uhci_alloc_qh
r_static
r_struct
id|uhci_qh
op_star
id|uhci_alloc_qh
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|uhci_qh
op_star
id|qh
suffix:semicolon
id|qh
op_assign
id|kmem_cache_alloc
c_func
(paren
id|uhci_qh_cachep
comma
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|SLAB_ATOMIC
suffix:colon
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qh
)paren
r_return
l_int|NULL
suffix:semicolon
id|qh-&gt;element
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|qh-&gt;link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|qh-&gt;dev
op_assign
id|dev
suffix:semicolon
id|qh-&gt;prevqh
op_assign
id|qh-&gt;nextqh
op_assign
l_int|NULL
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|qh-&gt;remove_list
)paren
suffix:semicolon
id|usb_inc_dev_use
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|qh
suffix:semicolon
)brace
DECL|function|uhci_free_qh
r_static
r_void
id|uhci_free_qh
c_func
(paren
r_struct
id|uhci_qh
op_star
id|qh
)paren
(brace
r_if
c_cond
(paren
id|qh-&gt;dev
)paren
id|usb_dec_dev_use
c_func
(paren
id|qh-&gt;dev
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|uhci_qh_cachep
comma
id|qh
)paren
suffix:semicolon
)brace
DECL|function|uhci_insert_qh
r_static
r_void
id|uhci_insert_qh
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|uhci_qh
op_star
id|skelqh
comma
r_struct
id|uhci_qh
op_star
id|qh
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Fix the linked list pointers */
id|qh-&gt;nextqh
op_assign
id|skelqh-&gt;nextqh
suffix:semicolon
id|qh-&gt;prevqh
op_assign
id|skelqh
suffix:semicolon
r_if
c_cond
(paren
id|skelqh-&gt;nextqh
)paren
id|skelqh-&gt;nextqh-&gt;prevqh
op_assign
id|qh
suffix:semicolon
id|skelqh-&gt;nextqh
op_assign
id|qh
suffix:semicolon
id|qh-&gt;link
op_assign
id|skelqh-&gt;link
suffix:semicolon
id|skelqh-&gt;link
op_assign
id|virt_to_bus
c_func
(paren
id|qh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_remove_qh
r_static
r_void
id|uhci_remove_qh
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|uhci_qh
op_star
id|qh
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|delayed
suffix:semicolon
multiline_comment|/* If the QH isn&squot;t queued, then we don&squot;t need to delay unlink it */
id|delayed
op_assign
(paren
id|qh-&gt;prevqh
op_logical_or
id|qh-&gt;nextqh
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qh-&gt;prevqh
)paren
(brace
id|qh-&gt;prevqh-&gt;nextqh
op_assign
id|qh-&gt;nextqh
suffix:semicolon
id|qh-&gt;prevqh-&gt;link
op_assign
id|qh-&gt;link
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qh-&gt;nextqh
)paren
id|qh-&gt;nextqh-&gt;prevqh
op_assign
id|qh-&gt;prevqh
suffix:semicolon
id|qh-&gt;prevqh
op_assign
id|qh-&gt;nextqh
op_assign
l_int|NULL
suffix:semicolon
id|qh-&gt;element
op_assign
id|qh-&gt;link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|delayed
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;qh_remove_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Check to see if the remove list is empty */
multiline_comment|/* Set the IOC bit to force an interrupt so we can remove the QH */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|uhci-&gt;qh_remove_list
)paren
)paren
id|uhci_set_next_interrupt
c_func
(paren
id|uhci
)paren
suffix:semicolon
multiline_comment|/* Add it */
id|list_add
c_func
(paren
op_amp
id|qh-&gt;remove_list
comma
op_amp
id|uhci-&gt;qh_remove_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;qh_remove_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
id|uhci_free_qh
c_func
(paren
id|qh
)paren
suffix:semicolon
)brace
DECL|variable|uhci_append_urb_lock
r_static
id|spinlock_t
id|uhci_append_urb_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* This function will append one URB&squot;s QH to another URB&squot;s QH. This is for */
multiline_comment|/*  USB_QUEUE_BULK support */
DECL|function|uhci_append_queued_urb
r_static
r_void
id|uhci_append_queued_urb
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|eurb
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|urb_priv
op_star
id|eurbp
comma
op_star
id|urbp
comma
op_star
id|furbp
comma
op_star
id|lurbp
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|uhci_td
op_star
id|td
comma
op_star
id|ltd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|eurbp
op_assign
id|eurb-&gt;hcpriv
suffix:semicolon
id|urbp
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci_append_urb_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Find the beginning URB in the queue */
r_if
c_cond
(paren
id|eurbp-&gt;queued
)paren
(brace
r_struct
id|list_head
op_star
id|head
op_assign
op_amp
id|eurbp-&gt;urb_queue_list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
r_struct
id|urb_priv
op_star
id|turbp
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|urb_priv
comma
id|urb_queue_list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|turbp-&gt;queued
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
id|tmp
op_assign
op_amp
id|eurbp-&gt;urb_queue_list
suffix:semicolon
id|furbp
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|urb_priv
comma
id|urb_queue_list
)paren
suffix:semicolon
id|tmp
op_assign
id|furbp-&gt;urb_queue_list.prev
suffix:semicolon
id|lurbp
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|urb_priv
comma
id|urb_queue_list
)paren
suffix:semicolon
multiline_comment|/* Add this one to the end */
id|list_add_tail
c_func
(paren
op_amp
id|urbp-&gt;urb_queue_list
comma
op_amp
id|furbp-&gt;urb_queue_list
)paren
suffix:semicolon
multiline_comment|/* Grab the last TD from the last URB */
id|ltd
op_assign
id|list_entry
c_func
(paren
id|lurbp-&gt;list.prev
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
multiline_comment|/* Grab the first TD from the first URB */
id|td
op_assign
id|list_entry
c_func
(paren
id|urbp-&gt;list.next
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
multiline_comment|/* No breadth since this will only be called for bulk transfers */
id|ltd-&gt;link
op_assign
id|virt_to_bus
c_func
(paren
id|td
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci_append_urb_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_delete_queued_urb
r_static
r_void
id|uhci_delete_queued_urb
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|urb_priv
op_star
id|urbp
comma
op_star
id|nurbp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|urbp
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci_append_urb_lock
comma
id|flags
)paren
suffix:semicolon
id|nurbp
op_assign
id|list_entry
c_func
(paren
id|urbp-&gt;urb_queue_list.next
comma
r_struct
id|urb_priv
comma
id|urb_queue_list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp-&gt;queued
)paren
(brace
multiline_comment|/* We&squot;re the head, so just insert the QH for the next URB */
id|uhci_insert_qh
c_func
(paren
id|uhci
comma
op_amp
id|uhci-&gt;skel_bulk_qh
comma
id|nurbp-&gt;qh
)paren
suffix:semicolon
id|nurbp-&gt;queued
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_struct
id|urb_priv
op_star
id|purbp
suffix:semicolon
r_struct
id|uhci_td
op_star
id|ptd
suffix:semicolon
multiline_comment|/* We&squot;re somewhere in the middle (or end). A bit trickier */
multiline_comment|/*  than the head scenario */
id|purbp
op_assign
id|list_entry
c_func
(paren
id|urbp-&gt;urb_queue_list.prev
comma
r_struct
id|urb_priv
comma
id|urb_queue_list
)paren
suffix:semicolon
id|ptd
op_assign
id|list_entry
c_func
(paren
id|purbp-&gt;list.prev
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nurbp-&gt;queued
)paren
multiline_comment|/* Close the gap between the two */
id|ptd-&gt;link
op_assign
id|virt_to_bus
c_func
(paren
id|list_entry
c_func
(paren
id|nurbp-&gt;list.next
comma
r_struct
id|uhci_td
comma
id|list
)paren
)paren
suffix:semicolon
r_else
multiline_comment|/* The next URB happens to be the beggining, so */
multiline_comment|/*  we&squot;re the last, end the chain */
id|ptd-&gt;link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|urbp-&gt;urb_queue_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci_append_urb_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_alloc_urb_priv
r_struct
id|urb_priv
op_star
id|uhci_alloc_urb_priv
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|urb_priv
op_star
id|urbp
suffix:semicolon
id|urbp
op_assign
id|kmem_cache_alloc
c_func
(paren
id|uhci_up_cachep
comma
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|SLAB_ATOMIC
suffix:colon
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|urbp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|urbp
)paren
)paren
suffix:semicolon
id|urbp-&gt;inserttime
op_assign
id|jiffies
suffix:semicolon
id|urbp-&gt;urb
op_assign
id|urb
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|urbp-&gt;list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|urbp-&gt;urb_queue_list
)paren
suffix:semicolon
id|urb-&gt;hcpriv
op_assign
id|urbp
suffix:semicolon
r_return
id|urbp
suffix:semicolon
)brace
DECL|function|uhci_add_td_to_urb
r_static
r_void
id|uhci_add_td_to_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|uhci_td
op_star
id|td
)paren
(brace
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
id|td-&gt;urb
op_assign
id|urb
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|td-&gt;list
comma
op_amp
id|urbp-&gt;list
)paren
suffix:semicolon
)brace
DECL|function|uhci_remove_td_from_urb
r_static
r_void
id|uhci_remove_td_from_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|uhci_td
op_star
id|td
)paren
(brace
id|urb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* No warnings */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|td-&gt;list
)paren
)paren
r_return
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|td-&gt;list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|td-&gt;list
)paren
suffix:semicolon
id|td-&gt;urb
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|uhci_destroy_urb_priv
r_static
r_void
id|uhci_destroy_urb_priv
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
suffix:semicolon
r_struct
id|uhci_td
op_star
id|td
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|urb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_goto
id|unlock
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;dev
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
)paren
r_goto
id|unlock
suffix:semicolon
id|uhci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|head
op_assign
op_amp
id|urbp-&gt;list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
id|uhci_remove_td_from_urb
c_func
(paren
id|urb
comma
id|td
)paren
suffix:semicolon
id|uhci_remove_td
c_func
(paren
id|uhci
comma
id|td
)paren
suffix:semicolon
id|uhci_free_td
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
id|urb-&gt;hcpriv
op_assign
l_int|NULL
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|uhci_up_cachep
comma
id|urbp
)paren
suffix:semicolon
id|unlock
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|urb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_inc_fsbr
r_static
r_void
id|uhci_inc_fsbr
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_NO_FSBR
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|urbp-&gt;fsbr
)paren
)paren
(brace
id|urbp-&gt;fsbr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;fsbr
op_increment
)paren
id|uhci-&gt;skel_term_qh.link
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|uhci-&gt;skel_hs_control_qh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_dec_fsbr
r_static
r_void
id|uhci_dec_fsbr
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_NO_FSBR
)paren
)paren
op_logical_and
id|urbp-&gt;fsbr
)paren
(brace
id|urbp-&gt;fsbr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|uhci-&gt;fsbr
)paren
id|uhci-&gt;skel_term_qh.link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Map status to standard result codes&n; *&n; * &lt;status&gt; is (td-&gt;status &amp; 0xFE0000) [a.k.a. uhci_status_bits(td-&gt;status)]&n; * &lt;dir_out&gt; is True for output TDs and False for input TDs.&n; */
DECL|function|uhci_map_status
r_static
r_int
id|uhci_map_status
c_func
(paren
r_int
id|status
comma
r_int
id|dir_out
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_BITSTUFF
)paren
multiline_comment|/* Bitstuff error */
r_return
op_minus
id|EPROTO
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_CRCTIMEO
)paren
(brace
multiline_comment|/* CRC/Timeout */
r_if
c_cond
(paren
id|dir_out
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_else
r_return
op_minus
id|EILSEQ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_NAK
)paren
multiline_comment|/* NAK */
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_BABBLE
)paren
multiline_comment|/* Babble */
r_return
op_minus
id|EPIPE
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_DBUFERR
)paren
multiline_comment|/* Buffer error */
r_return
op_minus
id|ENOSR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_STALLED
)paren
multiline_comment|/* Stalled */
r_return
op_minus
id|EPIPE
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_ACTIVE
)paren
multiline_comment|/* Active */
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * Control transfers&n; */
DECL|function|uhci_submit_control
r_static
r_int
id|uhci_submit_control
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|uhci_td
op_star
id|td
suffix:semicolon
r_struct
id|uhci_qh
op_star
id|qh
suffix:semicolon
r_int
r_int
id|destination
comma
id|status
suffix:semicolon
r_int
id|maxsze
op_assign
id|usb_maxpacket
c_func
(paren
id|urb-&gt;dev
comma
id|urb-&gt;pipe
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
r_int
id|len
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
multiline_comment|/* The &quot;pipe&quot; thing contains the destination in bits 8--18 */
id|destination
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|PIPE_DEVEP_MASK
)paren
op_or
id|USB_PID_SETUP
suffix:semicolon
multiline_comment|/* 3 errors */
id|status
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|TD_CTRL_LS
)paren
op_or
id|TD_CTRL_ACTIVE
op_or
(paren
l_int|3
op_lshift
l_int|27
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Build the TD for the control request&n;&t; */
id|td
op_assign
id|uhci_alloc_td
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|uhci_add_td_to_urb
c_func
(paren
id|urb
comma
id|td
)paren
suffix:semicolon
id|uhci_fill_td
c_func
(paren
id|td
comma
id|status
comma
id|destination
op_or
(paren
l_int|7
op_lshift
l_int|21
)paren
comma
id|virt_to_bus
c_func
(paren
id|urb-&gt;setup_packet
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If direction is &quot;send&quot;, change the frame from SETUP (0x2D)&n;&t; * to OUT (0xE1). Else change it from SETUP to IN (0x69).&n;&t; */
id|destination
op_xor_assign
(paren
id|USB_PID_SETUP
op_xor
id|usb_packetid
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
)paren
id|status
op_or_assign
id|TD_CTRL_SPD
suffix:semicolon
multiline_comment|/*&n;&t; * Build the DATA TD&squot;s&n;&t; */
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|pktsze
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pktsze
OG
id|maxsze
)paren
id|pktsze
op_assign
id|maxsze
suffix:semicolon
id|td
op_assign
id|uhci_alloc_td
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Alternate Data0/1 (start with Data1) */
id|destination
op_xor_assign
l_int|1
op_lshift
id|TD_TOKEN_TOGGLE
suffix:semicolon
id|uhci_add_td_to_urb
c_func
(paren
id|urb
comma
id|td
)paren
suffix:semicolon
id|uhci_fill_td
c_func
(paren
id|td
comma
id|status
comma
id|destination
op_or
(paren
(paren
id|pktsze
op_minus
l_int|1
)paren
op_lshift
l_int|21
)paren
comma
id|virt_to_bus
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
id|data
op_add_assign
id|pktsze
suffix:semicolon
id|len
op_sub_assign
id|pktsze
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Build the final TD for control status &n;&t; */
id|td
op_assign
id|uhci_alloc_td
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * It&squot;s IN if the pipe is an output pipe or we&squot;re not expecting&n;&t; * data back.&n;&t; */
id|destination
op_and_assign
op_complement
id|TD_PID
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
op_logical_or
op_logical_neg
id|urb-&gt;transfer_buffer_length
)paren
id|destination
op_or_assign
id|USB_PID_IN
suffix:semicolon
r_else
id|destination
op_or_assign
id|USB_PID_OUT
suffix:semicolon
id|destination
op_or_assign
l_int|1
op_lshift
id|TD_TOKEN_TOGGLE
suffix:semicolon
multiline_comment|/* End in Data1 */
id|status
op_and_assign
op_complement
id|TD_CTRL_SPD
suffix:semicolon
id|uhci_add_td_to_urb
c_func
(paren
id|urb
comma
id|td
)paren
suffix:semicolon
id|uhci_fill_td
c_func
(paren
id|td
comma
id|status
op_or
id|TD_CTRL_IOC
comma
id|destination
op_or
(paren
id|UHCI_NULL_DATA_SIZE
op_lshift
l_int|21
)paren
comma
l_int|0
)paren
suffix:semicolon
id|qh
op_assign
id|uhci_alloc_qh
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qh
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Low speed or small transfers gets a different queue and treatment */
r_if
c_cond
(paren
id|urb-&gt;pipe
op_amp
id|TD_CTRL_LS
)paren
(brace
id|uhci_insert_tds_in_qh
c_func
(paren
id|qh
comma
id|urb
comma
l_int|0
)paren
suffix:semicolon
id|uhci_insert_qh
c_func
(paren
id|uhci
comma
op_amp
id|uhci-&gt;skel_ls_control_qh
comma
id|qh
)paren
suffix:semicolon
)brace
r_else
(brace
id|uhci_insert_tds_in_qh
c_func
(paren
id|qh
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
id|uhci_insert_qh
c_func
(paren
id|uhci
comma
op_amp
id|uhci-&gt;skel_hs_control_qh
comma
id|qh
)paren
suffix:semicolon
id|uhci_inc_fsbr
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
)brace
id|urbp-&gt;qh
op_assign
id|qh
suffix:semicolon
id|uhci_add_urb_list
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
)brace
r_static
r_int
id|usb_control_retrigger_status
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
DECL|function|uhci_result_control
r_static
r_int
id|uhci_result_control
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|uhci_td
op_star
id|td
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|head
op_assign
op_amp
id|urbp-&gt;list
suffix:semicolon
r_if
c_cond
(paren
id|head-&gt;next
op_eq
id|head
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|urbp-&gt;short_control_packet
)paren
(brace
id|tmp
op_assign
id|head-&gt;prev
suffix:semicolon
r_goto
id|status_phase
suffix:semicolon
)brace
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
multiline_comment|/* The first TD is the SETUP phase, check the status, but skip */
multiline_comment|/*  the count */
id|status
op_assign
id|uhci_status_bits
c_func
(paren
id|td-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_ACTIVE
)paren
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|td_error
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The rest of the TD&squot;s (but the last) are data */
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
op_logical_and
id|tmp-&gt;next
op_ne
id|head
)paren
(brace
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|urbp-&gt;fsbr_timeout
op_logical_and
(paren
id|td-&gt;status
op_amp
id|TD_CTRL_IOC
)paren
op_logical_and
op_logical_neg
(paren
id|td-&gt;status
op_amp
id|TD_CTRL_ACTIVE
)paren
)paren
(brace
id|uhci_inc_fsbr
c_func
(paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
comma
id|urb
)paren
suffix:semicolon
id|urbp-&gt;fsbr_timeout
op_assign
l_int|0
suffix:semicolon
id|td-&gt;status
op_and_assign
op_complement
id|TD_CTRL_IOC
suffix:semicolon
)brace
id|status
op_assign
id|uhci_status_bits
c_func
(paren
id|td-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_ACTIVE
)paren
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
id|urb-&gt;actual_length
op_add_assign
id|uhci_actual_length
c_func
(paren
id|td-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|td_error
suffix:semicolon
multiline_comment|/* Check to see if we received a short packet */
r_if
c_cond
(paren
id|uhci_actual_length
c_func
(paren
id|td-&gt;status
)paren
OL
id|uhci_expected_length
c_func
(paren
id|td-&gt;info
)paren
)paren
(brace
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
(brace
id|ret
op_assign
op_minus
id|EREMOTEIO
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci_packetid
c_func
(paren
id|td-&gt;info
)paren
op_eq
id|USB_PID_IN
)paren
r_return
id|usb_control_retrigger_status
c_func
(paren
id|urb
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|status_phase
suffix:colon
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
multiline_comment|/* Control status phase */
id|status
op_assign
id|uhci_status_bits
c_func
(paren
id|td-&gt;status
)paren
suffix:semicolon
macro_line|#ifdef I_HAVE_BUGGY_APC_BACKUPS
multiline_comment|/* APC BackUPS Pro kludge */
multiline_comment|/* It tries to send all of the descriptor instead of the amount */
multiline_comment|/*  we requested */
r_if
c_cond
(paren
id|td-&gt;status
op_amp
id|TD_CTRL_IOC
op_logical_and
multiline_comment|/* IOC is masked out by uhci_status_bits */
id|status
op_amp
id|TD_CTRL_ACTIVE
op_logical_and
id|status
op_amp
id|TD_CTRL_NAK
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_ACTIVE
)paren
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|td_error
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|td_error
suffix:colon
id|ret
op_assign
id|uhci_map_status
c_func
(paren
id|status
comma
id|uhci_packetout
c_func
(paren
id|td-&gt;info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EPIPE
)paren
multiline_comment|/* endpoint has stalled - mark it halted */
id|usb_endpoint_halt
c_func
(paren
id|urb-&gt;dev
comma
id|uhci_endpoint
c_func
(paren
id|td-&gt;info
)paren
comma
id|uhci_packetout
c_func
(paren
id|td-&gt;info
)paren
)paren
suffix:semicolon
id|err
suffix:colon
r_if
c_cond
(paren
id|debug
op_logical_and
id|ret
op_ne
op_minus
id|EPIPE
)paren
(brace
multiline_comment|/* Some debugging code */
id|dbg
c_func
(paren
l_string|&quot;uhci_result_control() failed with status %x&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Print the chain for debugging purposes */
id|uhci_show_urb_queue
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|usb_control_retrigger_status
r_static
r_int
id|usb_control_retrigger_status
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|urbp-&gt;short_control_packet
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Create a new QH to avoid pointer overwriting problems */
id|uhci_remove_qh
c_func
(paren
id|uhci
comma
id|urbp-&gt;qh
)paren
suffix:semicolon
multiline_comment|/* Delete all of the TD&squot;s except for the status TD at the end */
id|head
op_assign
op_amp
id|urbp-&gt;list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
op_logical_and
id|tmp-&gt;next
op_ne
id|head
)paren
(brace
r_struct
id|uhci_td
op_star
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
id|uhci_remove_td_from_urb
c_func
(paren
id|urb
comma
id|td
)paren
suffix:semicolon
id|uhci_remove_td
c_func
(paren
id|uhci
comma
id|td
)paren
suffix:semicolon
id|uhci_free_td
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
id|urbp-&gt;qh
op_assign
id|uhci_alloc_qh
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp-&gt;qh
)paren
(brace
id|err
c_func
(paren
l_string|&quot;unable to allocate new QH for control retrigger&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* One TD, who cares about Breadth first? */
id|uhci_insert_tds_in_qh
c_func
(paren
id|urbp-&gt;qh
comma
id|urb
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Low speed or small transfers gets a different queue and treatment */
r_if
c_cond
(paren
id|urb-&gt;pipe
op_amp
id|TD_CTRL_LS
)paren
id|uhci_insert_qh
c_func
(paren
id|uhci
comma
op_amp
id|uhci-&gt;skel_ls_control_qh
comma
id|urbp-&gt;qh
)paren
suffix:semicolon
r_else
id|uhci_insert_qh
c_func
(paren
id|uhci
comma
op_amp
id|uhci-&gt;skel_hs_control_qh
comma
id|urbp-&gt;qh
)paren
suffix:semicolon
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupt transfers&n; */
DECL|function|uhci_submit_interrupt
r_static
r_int
id|uhci_submit_interrupt
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|uhci_td
op_star
id|td
suffix:semicolon
r_int
r_int
id|destination
comma
id|status
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer_length
OG
id|usb_maxpacket
c_func
(paren
id|urb-&gt;dev
comma
id|urb-&gt;pipe
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* The &quot;pipe&quot; thing contains the destination in bits 8--18 */
id|destination
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|PIPE_DEVEP_MASK
)paren
op_or
id|usb_packetid
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|status
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|TD_CTRL_LS
)paren
op_or
id|TD_CTRL_ACTIVE
op_or
id|TD_CTRL_IOC
suffix:semicolon
id|td
op_assign
id|uhci_alloc_td
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|destination
op_or_assign
(paren
id|usb_gettoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
op_lshift
id|TD_TOKEN_TOGGLE
)paren
suffix:semicolon
id|destination
op_or_assign
(paren
(paren
id|urb-&gt;transfer_buffer_length
op_minus
l_int|1
)paren
op_lshift
l_int|21
)paren
suffix:semicolon
id|usb_dotoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
id|uhci_add_td_to_urb
c_func
(paren
id|urb
comma
id|td
)paren
suffix:semicolon
id|uhci_fill_td
c_func
(paren
id|td
comma
id|status
comma
id|destination
comma
id|virt_to_bus
c_func
(paren
id|urb-&gt;transfer_buffer
)paren
)paren
suffix:semicolon
id|uhci_insert_td
c_func
(paren
id|uhci
comma
op_amp
id|uhci-&gt;skeltd
(braket
id|__interval_to_skel
c_func
(paren
id|urb-&gt;interval
)paren
)braket
comma
id|td
)paren
suffix:semicolon
id|uhci_add_urb_list
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
)brace
DECL|function|uhci_result_interrupt
r_static
r_int
id|uhci_result_interrupt
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|uhci_td
op_star
id|td
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|head
op_assign
op_amp
id|urbp-&gt;list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|urbp-&gt;fsbr_timeout
op_logical_and
(paren
id|td-&gt;status
op_amp
id|TD_CTRL_IOC
)paren
op_logical_and
op_logical_neg
(paren
id|td-&gt;status
op_amp
id|TD_CTRL_ACTIVE
)paren
)paren
(brace
id|uhci_inc_fsbr
c_func
(paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
comma
id|urb
)paren
suffix:semicolon
id|urbp-&gt;fsbr_timeout
op_assign
l_int|0
suffix:semicolon
id|td-&gt;status
op_and_assign
op_complement
id|TD_CTRL_IOC
suffix:semicolon
)brace
id|status
op_assign
id|uhci_status_bits
c_func
(paren
id|td-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_ACTIVE
)paren
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
id|urb-&gt;actual_length
op_add_assign
id|uhci_actual_length
c_func
(paren
id|td-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|td_error
suffix:semicolon
r_if
c_cond
(paren
id|uhci_actual_length
c_func
(paren
id|td-&gt;status
)paren
OL
id|uhci_expected_length
c_func
(paren
id|td-&gt;info
)paren
)paren
(brace
id|usb_settoggle
c_func
(paren
id|urb-&gt;dev
comma
id|uhci_endpoint
c_func
(paren
id|td-&gt;info
)paren
comma
id|uhci_packetout
c_func
(paren
id|td-&gt;info
)paren
comma
id|uhci_toggle
c_func
(paren
id|td-&gt;info
)paren
op_xor
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
(brace
id|ret
op_assign
op_minus
id|EREMOTEIO
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
id|td_error
suffix:colon
id|ret
op_assign
id|uhci_map_status
c_func
(paren
id|status
comma
id|uhci_packetout
c_func
(paren
id|td-&gt;info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EPIPE
)paren
multiline_comment|/* endpoint has stalled - mark it halted */
id|usb_endpoint_halt
c_func
(paren
id|urb-&gt;dev
comma
id|uhci_endpoint
c_func
(paren
id|td-&gt;info
)paren
comma
id|uhci_packetout
c_func
(paren
id|td-&gt;info
)paren
)paren
suffix:semicolon
id|err
suffix:colon
r_if
c_cond
(paren
id|debug
op_logical_and
id|ret
op_ne
op_minus
id|EPIPE
)paren
(brace
multiline_comment|/* Some debugging code */
id|dbg
c_func
(paren
l_string|&quot;uhci_result_interrupt/bulk() failed with status %x&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* Print the chain for debugging purposes */
r_if
c_cond
(paren
id|urbp-&gt;qh
)paren
id|uhci_show_urb_queue
c_func
(paren
id|urb
)paren
suffix:semicolon
r_else
id|uhci_show_td
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|uhci_reset_interrupt
r_static
r_void
id|uhci_reset_interrupt
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|uhci_td
op_star
id|td
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_return
suffix:semicolon
id|tmp
op_assign
id|urbp-&gt;list.next
suffix:semicolon
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
suffix:semicolon
id|td-&gt;status
op_assign
(paren
id|td-&gt;status
op_amp
l_int|0x2F000000
)paren
op_or
id|TD_CTRL_ACTIVE
op_or
id|TD_CTRL_IOC
suffix:semicolon
id|td-&gt;info
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|TD_TOKEN_TOGGLE
)paren
suffix:semicolon
id|td-&gt;info
op_or_assign
(paren
id|usb_gettoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
op_lshift
id|TD_TOKEN_TOGGLE
)paren
suffix:semicolon
id|usb_dotoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
)brace
multiline_comment|/*&n; * Bulk transfers&n; */
DECL|function|uhci_submit_bulk
r_static
r_int
id|uhci_submit_bulk
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|urb
op_star
id|eurb
)paren
(brace
r_struct
id|uhci_td
op_star
id|td
suffix:semicolon
r_struct
id|uhci_qh
op_star
id|qh
suffix:semicolon
r_int
r_int
id|destination
comma
id|status
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
id|maxsze
op_assign
id|usb_maxpacket
c_func
(paren
id|urb-&gt;dev
comma
id|urb-&gt;pipe
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
r_int
id|len
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Can&squot;t have low speed bulk transfers */
r_if
c_cond
(paren
id|urb-&gt;pipe
op_amp
id|TD_CTRL_LS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* The &quot;pipe&quot; thing contains the destination in bits 8--18 */
id|destination
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|PIPE_DEVEP_MASK
)paren
op_or
id|usb_packetid
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
multiline_comment|/* 3 errors */
id|status
op_assign
id|TD_CTRL_ACTIVE
op_or
(paren
l_int|3
op_lshift
id|TD_CTRL_C_ERR_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
)paren
id|status
op_or_assign
id|TD_CTRL_SPD
suffix:semicolon
multiline_comment|/*&n;&t; * Build the DATA TD&squot;s&n;&t; */
r_do
(brace
multiline_comment|/* Allow zero length packets */
r_int
id|pktsze
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pktsze
OG
id|maxsze
)paren
id|pktsze
op_assign
id|maxsze
suffix:semicolon
id|td
op_assign
id|uhci_alloc_td
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|uhci_add_td_to_urb
c_func
(paren
id|urb
comma
id|td
)paren
suffix:semicolon
id|uhci_fill_td
c_func
(paren
id|td
comma
id|status
comma
id|destination
op_or
(paren
(paren
id|pktsze
op_minus
l_int|1
)paren
op_lshift
l_int|21
)paren
op_or
(paren
id|usb_gettoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
op_lshift
id|TD_TOKEN_TOGGLE
)paren
comma
id|virt_to_bus
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
id|data
op_add_assign
id|pktsze
suffix:semicolon
id|len
op_sub_assign
id|maxsze
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
id|td-&gt;status
op_or_assign
id|TD_CTRL_IOC
suffix:semicolon
id|usb_dotoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
suffix:semicolon
id|qh
op_assign
id|uhci_alloc_qh
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qh
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|urbp-&gt;qh
op_assign
id|qh
suffix:semicolon
multiline_comment|/* Always assume depth first */
id|uhci_insert_tds_in_qh
c_func
(paren
id|qh
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_QUEUE_BULK
op_logical_and
id|eurb
)paren
(brace
id|urbp-&gt;queued
op_assign
l_int|1
suffix:semicolon
id|uhci_append_queued_urb
c_func
(paren
id|uhci
comma
id|eurb
comma
id|urb
)paren
suffix:semicolon
)brace
r_else
id|uhci_insert_qh
c_func
(paren
id|uhci
comma
op_amp
id|uhci-&gt;skel_bulk_qh
comma
id|qh
)paren
suffix:semicolon
id|uhci_add_urb_list
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
id|uhci_inc_fsbr
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
)brace
multiline_comment|/* We can use the result interrupt since they&squot;re identical */
DECL|macro|uhci_result_bulk
mdefine_line|#define uhci_result_bulk uhci_result_interrupt
multiline_comment|/*&n; * Isochronous transfers&n; */
DECL|function|isochronous_find_limits
r_static
r_int
id|isochronous_find_limits
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_int
r_int
op_star
id|start
comma
r_int
r_int
op_star
id|end
)paren
(brace
r_struct
id|urb
op_star
id|last_urb
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
op_assign
op_amp
id|uhci-&gt;urb_list
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|nested_lock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
r_struct
id|urb
op_star
id|u
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|urb
comma
id|urb_list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
multiline_comment|/* look for pending URB&squot;s with identical pipe handle */
r_if
c_cond
(paren
(paren
id|urb-&gt;pipe
op_eq
id|u-&gt;pipe
)paren
op_logical_and
(paren
id|urb-&gt;dev
op_eq
id|u-&gt;dev
)paren
op_logical_and
(paren
id|u-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
op_logical_and
(paren
id|u
op_ne
id|urb
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|last_urb
)paren
op_star
id|start
op_assign
id|u-&gt;start_frame
suffix:semicolon
id|last_urb
op_assign
id|u
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|last_urb
)paren
(brace
op_star
id|end
op_assign
(paren
id|last_urb-&gt;start_frame
op_plus
id|last_urb-&gt;number_of_packets
)paren
op_amp
l_int|1023
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* no previous urb found */
id|nested_unlock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|isochronous_find_start
r_static
r_int
id|isochronous_find_start
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|limits
suffix:semicolon
r_int
r_int
id|start
op_assign
l_int|0
comma
id|end
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;number_of_packets
OG
l_int|900
)paren
multiline_comment|/* 900? Why? */
r_return
op_minus
id|EFBIG
suffix:semicolon
id|limits
op_assign
id|isochronous_find_limits
c_func
(paren
id|urb
comma
op_amp
id|start
comma
op_amp
id|end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ISO_ASAP
)paren
(brace
r_if
c_cond
(paren
id|limits
)paren
(brace
r_int
id|curframe
suffix:semicolon
id|curframe
op_assign
id|uhci_get_current_frame_number
c_func
(paren
id|urb-&gt;dev
)paren
op_mod
id|UHCI_NUMFRAMES
suffix:semicolon
id|urb-&gt;start_frame
op_assign
(paren
id|curframe
op_plus
l_int|10
)paren
op_mod
id|UHCI_NUMFRAMES
suffix:semicolon
)brace
r_else
id|urb-&gt;start_frame
op_assign
id|end
suffix:semicolon
)brace
r_else
(brace
id|urb-&gt;start_frame
op_mod_assign
id|UHCI_NUMFRAMES
suffix:semicolon
multiline_comment|/* FIXME: Sanity check */
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uhci_submit_isochronous
r_static
r_int
id|uhci_submit_isochronous
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|uhci_td
op_star
id|td
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
id|i
comma
id|ret
comma
id|framenum
suffix:semicolon
r_int
id|status
comma
id|destination
suffix:semicolon
id|status
op_assign
id|TD_CTRL_ACTIVE
op_or
id|TD_CTRL_IOS
suffix:semicolon
id|destination
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|PIPE_DEVEP_MASK
)paren
op_or
id|usb_packetid
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|ret
op_assign
id|isochronous_find_start
c_func
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|framenum
op_assign
id|urb-&gt;start_frame
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
comma
id|framenum
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|length
)paren
r_continue
suffix:semicolon
id|td
op_assign
id|uhci_alloc_td
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|uhci_add_td_to_urb
c_func
(paren
id|urb
comma
id|td
)paren
suffix:semicolon
id|uhci_fill_td
c_func
(paren
id|td
comma
id|status
comma
id|destination
op_or
(paren
(paren
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|length
op_minus
l_int|1
)paren
op_lshift
l_int|21
)paren
comma
id|virt_to_bus
c_func
(paren
id|urb-&gt;transfer_buffer
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_plus
l_int|1
op_ge
id|urb-&gt;number_of_packets
)paren
id|td-&gt;status
op_or_assign
id|TD_CTRL_IOC
suffix:semicolon
id|uhci_insert_td_frame_list
c_func
(paren
id|uhci
comma
id|td
comma
id|framenum
)paren
suffix:semicolon
)brace
id|uhci_add_urb_list
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
)brace
DECL|function|uhci_result_isochronous
r_static
r_int
id|uhci_result_isochronous
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|head
op_assign
op_amp
id|urbp-&gt;list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
r_struct
id|uhci_td
op_star
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
r_int
id|actlength
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;status
op_amp
id|TD_CTRL_ACTIVE
)paren
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
id|actlength
op_assign
id|uhci_actual_length
c_func
(paren
id|td-&gt;status
)paren
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
id|actlength
suffix:semicolon
id|urb-&gt;actual_length
op_add_assign
id|actlength
suffix:semicolon
id|status
op_assign
id|uhci_map_status
c_func
(paren
id|uhci_status_bits
c_func
(paren
id|td-&gt;status
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|status
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|urb-&gt;error_count
op_increment
suffix:semicolon
id|ret
op_assign
id|status
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|uhci_find_urb_ep
r_static
r_struct
id|urb
op_star
id|uhci_find_urb_ep
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
op_assign
op_amp
id|uhci-&gt;urb_list
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|urb
op_star
id|u
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipeisoc
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|nested_lock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
id|u
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|urb
comma
id|urb_list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;dev
op_eq
id|urb-&gt;dev
op_logical_and
id|u-&gt;pipe
op_eq
id|urb-&gt;pipe
)paren
r_goto
id|found
suffix:semicolon
)brace
id|u
op_assign
l_int|NULL
suffix:semicolon
id|found
suffix:colon
id|nested_unlock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|u
suffix:semicolon
)brace
DECL|function|uhci_submit_urb
r_static
r_int
id|uhci_submit_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|urb
op_star
id|u
suffix:semicolon
r_int
id|bustime
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;dev
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
multiline_comment|/* Short circuit the virtual root hub */
r_if
c_cond
(paren
id|usb_pipedevice
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|uhci-&gt;rh.devnum
)paren
r_return
id|rh_submit_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|u
op_assign
id|uhci_find_urb_ep
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|u
op_logical_and
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_QUEUE_BULK
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|usb_inc_dev_use
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|urb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci_alloc_urb_priv
c_func
(paren
id|urb
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|urb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|usb_dec_dev_use
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_CONTROL
suffix:colon
id|ret
op_assign
id|uhci_submit_control
c_func
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;bandwidth
op_eq
l_int|0
)paren
(brace
multiline_comment|/* not yet checked/allocated */
id|bustime
op_assign
id|usb_check_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bustime
OL
l_int|0
)paren
id|ret
op_assign
id|bustime
suffix:semicolon
r_else
(brace
id|ret
op_assign
id|uhci_submit_interrupt
c_func
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EINPROGRESS
)paren
id|usb_claim_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
comma
id|bustime
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* bandwidth is already set */
id|ret
op_assign
id|uhci_submit_interrupt
c_func
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
id|ret
op_assign
id|uhci_submit_bulk
c_func
(paren
id|urb
comma
id|u
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;bandwidth
op_eq
l_int|0
)paren
(brace
multiline_comment|/* not yet checked/allocated */
r_if
c_cond
(paren
id|urb-&gt;number_of_packets
op_le
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|bustime
op_assign
id|usb_check_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bustime
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|bustime
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ret
op_assign
id|uhci_submit_isochronous
c_func
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EINPROGRESS
)paren
id|usb_claim_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
comma
id|bustime
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* bandwidth is already set */
id|ret
op_assign
id|uhci_submit_isochronous
c_func
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|urb-&gt;status
op_assign
id|ret
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|urb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EINPROGRESS
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|uhci_unlink_generic
c_func
(paren
id|urb
)paren
suffix:semicolon
id|usb_dec_dev_use
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the result of a transfer&n; *&n; * Must be called with urblist_lock acquired&n; */
DECL|function|uhci_transfer_result
r_static
r_void
id|uhci_transfer_result
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|urb-&gt;dev
suffix:semicolon
r_struct
id|urb
op_star
id|turb
suffix:semicolon
r_int
id|proceed
op_assign
l_int|0
comma
id|is_ring
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|urb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_CONTROL
suffix:colon
id|ret
op_assign
id|uhci_result_control
c_func
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
id|ret
op_assign
id|uhci_result_interrupt
c_func
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
id|ret
op_assign
id|uhci_result_bulk
c_func
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
id|ret
op_assign
id|uhci_result_isochronous
c_func
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|urb-&gt;status
op_assign
id|ret
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|urb-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EINPROGRESS
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_CONTROL
suffix:colon
r_case
id|PIPE_BULK
suffix:colon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
multiline_comment|/* Release bandwidth for Interrupt or Isoc. transfers */
multiline_comment|/* Spinlock needed ? */
r_if
c_cond
(paren
id|urb-&gt;bandwidth
)paren
id|usb_release_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
id|uhci_unlink_generic
c_func
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
multiline_comment|/* Interrupts are an exception */
r_if
c_cond
(paren
id|urb-&gt;interval
)paren
(brace
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
id|uhci_reset_interrupt
c_func
(paren
id|urb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Release bandwidth for Interrupt or Isoc. transfers */
multiline_comment|/* Spinlock needed ? */
r_if
c_cond
(paren
id|urb-&gt;bandwidth
)paren
id|usb_release_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|0
)paren
suffix:semicolon
id|uhci_unlink_generic
c_func
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;next
)paren
(brace
id|turb
op_assign
id|urb-&gt;next
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|turb-&gt;status
op_ne
op_minus
id|EINPROGRESS
)paren
(brace
id|proceed
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|turb
op_assign
id|turb-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|turb
op_logical_and
id|turb
op_ne
id|urb
op_logical_and
id|turb
op_ne
id|urb-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|turb
op_eq
id|urb
op_logical_or
id|turb
op_eq
id|urb-&gt;next
)paren
id|is_ring
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;complete
op_logical_and
op_logical_neg
id|proceed
)paren
(brace
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proceed
op_logical_and
id|is_ring
)paren
id|uhci_submit_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|proceed
op_logical_and
id|urb-&gt;next
)paren
(brace
id|turb
op_assign
id|urb-&gt;next
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|turb-&gt;status
op_ne
op_minus
id|EINPROGRESS
op_logical_and
id|uhci_submit_urb
c_func
(paren
id|turb
)paren
op_ne
l_int|0
)paren
id|turb
op_assign
id|turb-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|turb
op_logical_and
id|turb
op_ne
id|urb-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
multiline_comment|/* We decrement the usage count after we&squot;re done with everything */
id|usb_dec_dev_use
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|uhci_unlink_generic
r_static
r_int
id|uhci_unlink_generic
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|urb_priv
op_star
id|urbp
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urbp
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|uhci_dec_fsbr
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
multiline_comment|/* Safe since it checks */
id|uhci_remove_urb_list
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urbp-&gt;qh
)paren
multiline_comment|/* The interrupt loop will reclaim the QH&squot;s */
id|uhci_remove_qh
c_func
(paren
id|uhci
comma
id|urbp-&gt;qh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|urbp-&gt;urb_queue_list
)paren
)paren
id|uhci_delete_queued_urb
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
id|uhci_destroy_urb_priv
c_func
(paren
id|urb
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uhci_unlink_urb
r_static
r_int
id|uhci_unlink_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|uhci
op_star
id|uhci
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;dev
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
multiline_comment|/* Short circuit the virtual root hub */
r_if
c_cond
(paren
id|usb_pipedevice
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|uhci-&gt;rh.devnum
)paren
r_return
id|rh_unlink_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
multiline_comment|/* Release bandwidth for Interrupt or Isoc. transfers */
multiline_comment|/* Spinlock needed ? */
r_if
c_cond
(paren
id|urb-&gt;bandwidth
)paren
(brace
r_switch
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_INTERRUPT
suffix:colon
id|usb_release_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
id|usb_release_bandwidth
c_func
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|uhci_unlink_generic
c_func
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ASYNC_UNLINK
)paren
(brace
id|urb-&gt;status
op_assign
op_minus
id|ECONNABORTED
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Check to see if the remove list is empty */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_list
)paren
)paren
id|uhci_set_next_interrupt
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|urb-&gt;urb_list
comma
op_amp
id|uhci-&gt;urb_remove_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|urb-&gt;status
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* wait at least 1 frame */
r_static
r_int
id|errorcount
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|errorcount
op_decrement
)paren
id|dbg
c_func
(paren
l_string|&quot;uhci_unlink_urb called from interrupt for urb %p&quot;
comma
id|urb
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
r_else
id|schedule_timeout
c_func
(paren
l_int|1
op_plus
l_int|1
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|uhci_fsbr_timeout
r_static
r_int
id|uhci_fsbr_timeout
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|urb_priv
op_star
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|list_head
op_star
id|head
comma
op_star
id|tmp
suffix:semicolon
id|uhci_dec_fsbr
c_func
(paren
id|uhci
comma
id|urb
)paren
suffix:semicolon
multiline_comment|/* There is a race with updating IOC in here, but it&squot;s not worth */
multiline_comment|/*  trying to fix since this is merely an optimization. The only */
multiline_comment|/*  time we&squot;d lose is if the status of the packet got updated */
multiline_comment|/*  and we&squot;d be turning on FSBR next frame anyway, so it&squot;s a wash */
id|urbp-&gt;fsbr_timeout
op_assign
l_int|1
suffix:semicolon
id|head
op_assign
op_amp
id|urbp-&gt;list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
r_struct
id|uhci_td
op_star
id|td
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_td
comma
id|list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;status
op_amp
id|TD_CTRL_ACTIVE
)paren
(brace
id|td-&gt;status
op_or_assign
id|TD_CTRL_IOC
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * uhci_get_current_frame_number()&n; *&n; * returns the current frame number for a USB bus/controller.&n; */
DECL|function|uhci_get_current_frame_number
r_static
r_int
id|uhci_get_current_frame_number
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_return
id|inw
c_func
(paren
id|uhci-&gt;io_addr
op_plus
id|USBFRNUM
)paren
suffix:semicolon
)brace
DECL|variable|uhci_device_operations
r_struct
id|usb_operations
id|uhci_device_operations
op_assign
(brace
id|uhci_alloc_dev
comma
id|uhci_free_dev
comma
id|uhci_get_current_frame_number
comma
id|uhci_submit_urb
comma
id|uhci_unlink_urb
)brace
suffix:semicolon
multiline_comment|/* -------------------------------------------------------------------&n;   Virtual Root Hub&n;   ------------------------------------------------------------------- */
DECL|variable|root_hub_dev_des
r_static
id|__u8
id|root_hub_dev_des
(braket
)braket
op_assign
(brace
l_int|0x12
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x01
comma
multiline_comment|/*  __u8  bDescriptorType; Device */
l_int|0x00
comma
multiline_comment|/*  __u16 bcdUSB; v1.0 */
l_int|0x01
comma
l_int|0x09
comma
multiline_comment|/*  __u8  bDeviceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceProtocol; */
l_int|0x08
comma
multiline_comment|/*  __u8  bMaxPacketSize0; 8 Bytes */
l_int|0x00
comma
multiline_comment|/*  __u16 idVendor; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 idProduct; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 bcdDevice; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u8  iManufacturer; */
l_int|0x02
comma
multiline_comment|/*  __u8  iProduct; */
l_int|0x01
comma
multiline_comment|/*  __u8  iSerialNumber; */
l_int|0x01
multiline_comment|/*  __u8  bNumConfigurations; */
)brace
suffix:semicolon
multiline_comment|/* Configuration descriptor */
DECL|variable|root_hub_config_des
r_static
id|__u8
id|root_hub_config_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x02
comma
multiline_comment|/*  __u8  bDescriptorType; Configuration */
l_int|0x19
comma
multiline_comment|/*  __u16 wTotalLength; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bNumInterfaces; */
l_int|0x01
comma
multiline_comment|/*  __u8  bConfigurationValue; */
l_int|0x00
comma
multiline_comment|/*  __u8  iConfiguration; */
l_int|0x40
comma
multiline_comment|/*  __u8  bmAttributes;&n;&t;&t;&t;&t;&t;Bit 7: Bus-powered, 6: Self-powered,&n;&t;&t;&t;&t;&t;Bit 5 Remote-wakeup, 4..0: resvd */
l_int|0x00
comma
multiline_comment|/*  __u8  MaxPower; */
multiline_comment|/* interface */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bLength; */
l_int|0x04
comma
multiline_comment|/*  __u8  if_bDescriptorType; Interface */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceNumber; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bAlternateSetting; */
l_int|0x01
comma
multiline_comment|/*  __u8  if_bNumEndpoints; */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bInterfaceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceProtocol; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_iInterface; */
multiline_comment|/* endpoint */
l_int|0x07
comma
multiline_comment|/*  __u8  ep_bLength; */
l_int|0x05
comma
multiline_comment|/*  __u8  ep_bDescriptorType; Endpoint */
l_int|0x81
comma
multiline_comment|/*  __u8  ep_bEndpointAddress; IN Endpoint 1 */
l_int|0x03
comma
multiline_comment|/*  __u8  ep_bmAttributes; Interrupt */
l_int|0x08
comma
multiline_comment|/*  __u16 ep_wMaxPacketSize; 8 Bytes */
l_int|0x00
comma
l_int|0xff
multiline_comment|/*  __u8  ep_bInterval; 255 ms */
)brace
suffix:semicolon
DECL|variable|root_hub_hub_des
r_static
id|__u8
id|root_hub_hub_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x29
comma
multiline_comment|/*  __u8  bDescriptorType; Hub-descriptor */
l_int|0x02
comma
multiline_comment|/*  __u8  bNbrPorts; */
l_int|0x00
comma
multiline_comment|/* __u16  wHubCharacteristics; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bPwrOn2pwrGood; 2ms */
l_int|0x00
comma
multiline_comment|/*  __u8  bHubContrCurrent; 0 mA */
l_int|0x00
comma
multiline_comment|/*  __u8  DeviceRemovable; *** 7 Ports max *** */
l_int|0xff
multiline_comment|/*  __u8  PortPwrCtrlMask; *** 7 ports max *** */
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* prepare Interrupt pipe transaction data; HUB INTERRUPT ENDPOINT */
DECL|function|rh_send_irq
r_static
r_int
id|rh_send_irq
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|i
comma
id|len
op_assign
l_int|1
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
id|__u16
id|data
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uhci-&gt;rh.numports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
op_or_assign
(paren
(paren
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBPORTSC1
op_plus
id|i
op_star
l_int|2
)paren
op_amp
l_int|0xa
)paren
OG
l_int|0
ques
c_cond
(paren
l_int|1
op_lshift
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|len
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
)brace
op_star
(paren
id|__u16
op_star
)paren
id|urb-&gt;transfer_buffer
op_assign
id|cpu_to_le16
c_func
(paren
id|data
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
id|urb-&gt;status
op_assign
id|USB_ST_NOERROR
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
OG
l_int|0
)paren
op_logical_and
(paren
id|uhci-&gt;rh.send
op_ne
l_int|0
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;root-hub INT complete: port1: %x port2: %x data: %x&quot;
comma
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBPORTSC1
)paren
comma
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBPORTSC2
)paren
comma
id|data
)paren
suffix:semicolon
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
r_return
id|USB_ST_NOERROR
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Virtual Root Hub INTs are polled by this timer every &quot;interval&quot; ms */
r_static
r_int
id|rh_init_int_timer
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
DECL|function|rh_int_timer_do
r_static
r_void
id|rh_int_timer_do
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
(paren
r_struct
id|urb
op_star
)paren
id|ptr
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
op_assign
op_amp
id|uhci-&gt;urb_list
suffix:semicolon
r_struct
id|urb_priv
op_star
id|urbp
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;rh.send
)paren
(brace
id|len
op_assign
id|rh_send_irq
c_func
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
id|nested_lock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
r_struct
id|urb
op_star
id|u
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
id|urb_t
comma
id|urb_list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
id|urbp
op_assign
(paren
r_struct
id|urb_priv
op_star
)paren
id|u-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|urbp
)paren
(brace
multiline_comment|/* Check if the FSBR timed out */
r_if
c_cond
(paren
id|urbp-&gt;fsbr
op_logical_and
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|urbp-&gt;inserttime
op_plus
id|IDLE_TIMEOUT
)paren
)paren
id|uhci_fsbr_timeout
c_func
(paren
id|uhci
comma
id|u
)paren
suffix:semicolon
multiline_comment|/* Check if the URB timed out */
r_if
c_cond
(paren
id|u-&gt;timeout
op_logical_and
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|u-&gt;timeout
)paren
)paren
(brace
id|u-&gt;transfer_flags
op_or_assign
id|USB_ASYNC_UNLINK
op_or
id|USB_TIMEOUT_KILLED
suffix:semicolon
id|uhci_unlink_urb
c_func
(paren
id|u
)paren
suffix:semicolon
)brace
)brace
)brace
id|nested_unlock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
id|rh_init_int_timer
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Root Hub INTs are polled by this timer */
DECL|function|rh_init_int_timer
r_static
r_int
id|rh_init_int_timer
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|uhci-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|uhci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
id|uhci-&gt;rh.rh_int_timer.function
op_assign
id|rh_int_timer_do
suffix:semicolon
id|uhci-&gt;rh.rh_int_timer.data
op_assign
(paren
r_int
r_int
)paren
id|urb
suffix:semicolon
id|uhci-&gt;rh.rh_int_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
(paren
id|urb-&gt;interval
OL
l_int|30
ques
c_cond
l_int|30
suffix:colon
id|urb-&gt;interval
)paren
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|uhci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|OK
mdefine_line|#define OK(x)&t;&t;&t;len = (x); break
DECL|macro|CLR_RH_PORTSTAT
mdefine_line|#define CLR_RH_PORTSTAT(x) &bslash;&n;&t;status = inw(io_addr + USBPORTSC1 + 2 * (wIndex-1)); &bslash;&n;&t;status = (status &amp; 0xfff5) &amp; ~(x); &bslash;&n;&t;outw(status, io_addr + USBPORTSC1 + 2 * (wIndex-1))
DECL|macro|SET_RH_PORTSTAT
mdefine_line|#define SET_RH_PORTSTAT(x) &bslash;&n;&t;status = inw(io_addr + USBPORTSC1 + 2 * (wIndex-1)); &bslash;&n;&t;status = (status &amp; 0xfff5) | (x); &bslash;&n;&t;outw(status, io_addr + USBPORTSC1 + 2 * (wIndex-1))
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/*************************&n; ** Root Hub Control Pipe&n; *************************/
DECL|function|rh_submit_urb
r_static
r_int
id|rh_submit_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
id|devrequest
op_star
id|cmd
op_assign
(paren
id|devrequest
op_star
)paren
id|urb-&gt;setup_packet
suffix:semicolon
r_void
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|leni
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|stat
op_assign
id|USB_ST_NOERROR
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
id|__u16
id|cstatus
suffix:semicolon
id|__u16
id|bmRType_bReq
suffix:semicolon
id|__u16
id|wValue
suffix:semicolon
id|__u16
id|wIndex
suffix:semicolon
id|__u16
id|wLength
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
id|uhci-&gt;rh.urb
op_assign
id|urb
suffix:semicolon
id|uhci-&gt;rh.send
op_assign
l_int|1
suffix:semicolon
id|uhci-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|rh_init_int_timer
c_func
(paren
id|urb
)paren
suffix:semicolon
r_return
id|USB_ST_NOERROR
suffix:semicolon
)brace
id|bmRType_bReq
op_assign
id|cmd-&gt;requesttype
op_or
id|cmd-&gt;request
op_lshift
l_int|8
suffix:semicolon
id|wValue
op_assign
id|le16_to_cpu
c_func
(paren
id|cmd-&gt;value
)paren
suffix:semicolon
id|wIndex
op_assign
id|le16_to_cpu
c_func
(paren
id|cmd-&gt;index
)paren
suffix:semicolon
id|wLength
op_assign
id|le16_to_cpu
c_func
(paren
id|cmd-&gt;length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|uhci-&gt;rh.c_p_r
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|bmRType_bReq
)paren
(brace
multiline_comment|/* Request Destination:&n;&t;&t;   without flags: Device,&n;&t;&t;   RH_INTERFACE: interface,&n;&t;&t;   RH_ENDPOINT: endpoint,&n;&t;&t;   RH_CLASS means HUB here,&n;&t;&t;   RH_OTHER | RH_CLASS  almost ever means HUB_PORT here&n;&t;&t;*/
r_case
id|RH_GET_STATUS
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_INTERFACE
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_ENDPOINT
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u32
op_star
)paren
id|data
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* hub power */
r_case
id|RH_GET_STATUS
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
id|status
op_assign
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBPORTSC1
op_plus
l_int|2
op_star
(paren
id|wIndex
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|cstatus
op_assign
(paren
(paren
id|status
op_amp
id|USBPORTSC_CSC
)paren
op_rshift
(paren
l_int|1
op_minus
l_int|0
)paren
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_PEC
)paren
op_rshift
(paren
l_int|3
op_minus
l_int|1
)paren
)paren
op_or
(paren
id|uhci-&gt;rh.c_p_r
(braket
id|wIndex
op_minus
l_int|1
)braket
op_lshift
(paren
l_int|0
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|status
op_assign
(paren
id|status
op_amp
id|USBPORTSC_CCS
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_PE
)paren
op_rshift
(paren
l_int|2
op_minus
l_int|1
)paren
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_SUSP
)paren
op_rshift
(paren
l_int|12
op_minus
l_int|2
)paren
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_PR
)paren
op_rshift
(paren
l_int|9
op_minus
l_int|4
)paren
)paren
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
multiline_comment|/* power on */
(paren
(paren
id|status
op_amp
id|USBPORTSC_LSDA
)paren
op_lshift
(paren
op_minus
l_int|8
op_plus
l_int|9
)paren
)paren
suffix:semicolon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
c_func
(paren
id|status
)paren
suffix:semicolon
op_star
(paren
id|__u16
op_star
)paren
(paren
id|data
op_plus
l_int|2
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|cstatus
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_ENDPOINT
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|RH_ENDPOINT_STALL
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|RH_C_HUB_OVER_CURRENT
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* hub power over current */
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|RH_PORT_ENABLE
suffix:colon
id|CLR_RH_PORTSTAT
c_func
(paren
id|USBPORTSC_PE
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_PORT_SUSPEND
suffix:colon
id|CLR_RH_PORTSTAT
c_func
(paren
id|USBPORTSC_SUSP
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_PORT_POWER
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* port power */
r_case
id|RH_C_PORT_CONNECTION
suffix:colon
id|SET_RH_PORTSTAT
c_func
(paren
id|USBPORTSC_CSC
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_C_PORT_ENABLE
suffix:colon
id|SET_RH_PORTSTAT
c_func
(paren
id|USBPORTSC_PEC
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_C_PORT_SUSPEND
suffix:colon
multiline_comment|/*** WR_RH_PORTSTAT(RH_PS_PSSC); */
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_C_PORT_OVER_CURRENT
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* port power over current */
r_case
id|RH_C_PORT_RESET
suffix:colon
id|uhci-&gt;rh.c_p_r
(braket
id|wIndex
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|RH_PORT_SUSPEND
suffix:colon
id|SET_RH_PORTSTAT
c_func
(paren
id|USBPORTSC_SUSP
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_PORT_RESET
suffix:colon
id|SET_RH_PORTSTAT
c_func
(paren
id|USBPORTSC_PR
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* USB v1.1 7.1.7.3 */
id|uhci-&gt;rh.c_p_r
(braket
id|wIndex
op_minus
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|CLR_RH_PORTSTAT
c_func
(paren
id|USBPORTSC_PR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|SET_RH_PORTSTAT
c_func
(paren
id|USBPORTSC_PE
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|SET_RH_PORTSTAT
c_func
(paren
l_int|0xa
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_PORT_POWER
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* port power ** */
r_case
id|RH_PORT_ENABLE
suffix:colon
id|SET_RH_PORTSTAT
c_func
(paren
id|USBPORTSC_PE
)paren
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_ADDRESS
suffix:colon
id|uhci-&gt;rh.devnum
op_assign
id|wValue
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
suffix:colon
r_switch
c_cond
(paren
(paren
id|wValue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* device descriptor */
id|len
op_assign
id|min
c_func
(paren
id|leni
comma
id|min
c_func
(paren
r_sizeof
(paren
id|root_hub_dev_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|root_hub_dev_des
comma
id|len
)paren
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* configuration descriptor */
id|len
op_assign
id|min
c_func
(paren
id|leni
comma
id|min
c_func
(paren
r_sizeof
(paren
id|root_hub_config_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|data
comma
id|root_hub_config_des
comma
id|len
)paren
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
l_int|0x03
suffix:colon
multiline_comment|/* string descriptors */
id|len
op_assign
id|usb_root_hub_string
(paren
id|wValue
op_amp
l_int|0xff
comma
id|uhci-&gt;io_addr
comma
l_string|&quot;UHCI-alt&quot;
comma
id|data
comma
id|wLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|OK
(paren
id|min
(paren
id|leni
comma
id|len
)paren
)paren
suffix:semicolon
)brace
r_else
id|stat
op_assign
op_minus
id|EPIPE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
op_or
id|RH_CLASS
suffix:colon
id|root_hub_hub_des
(braket
l_int|2
)braket
op_assign
id|uhci-&gt;rh.numports
suffix:semicolon
id|len
op_assign
id|min
c_func
(paren
id|leni
comma
id|min
c_func
(paren
r_sizeof
(paren
id|root_hub_hub_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|root_hub_hub_des
comma
id|len
)paren
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
id|RH_GET_CONFIGURATION
suffix:colon
op_star
(paren
id|__u8
op_star
)paren
id|data
op_assign
l_int|0x01
suffix:semicolon
id|OK
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|RH_SET_CONFIGURATION
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_GET_INTERFACE
op_or
id|RH_INTERFACE
suffix:colon
op_star
(paren
id|__u8
op_star
)paren
id|data
op_assign
l_int|0x00
suffix:semicolon
id|OK
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|RH_SET_INTERFACE
op_or
id|RH_INTERFACE
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|stat
op_assign
op_minus
id|EPIPE
suffix:semicolon
)brace
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
id|urb-&gt;status
op_assign
id|stat
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
r_return
id|USB_ST_NOERROR
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|rh_unlink_urb
r_static
r_int
id|rh_unlink_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|uhci
op_star
id|uhci
op_assign
(paren
r_struct
id|uhci
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;rh.urb
op_eq
id|urb
)paren
(brace
id|uhci-&gt;rh.send
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|uhci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_free_pending_qhs
r_void
id|uhci_free_pending_qhs
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Free any pending QH&squot;s */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uhci-&gt;qh_remove_lock
comma
id|flags
)paren
suffix:semicolon
id|head
op_assign
op_amp
id|uhci-&gt;qh_remove_list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
r_struct
id|uhci_qh
op_star
id|qh
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|uhci_qh
comma
id|remove_list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|qh-&gt;remove_list
)paren
suffix:semicolon
id|uhci_free_qh
c_func
(paren
id|qh
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uhci-&gt;qh_remove_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_interrupt
r_static
r_void
id|uhci_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|__uhci
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uhci
op_star
id|uhci
op_assign
id|__uhci
suffix:semicolon
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|head
suffix:semicolon
multiline_comment|/*&n;&t; * Read the interrupt status, and write it back to clear the&n;&t; * interrupt cause&n;&t; */
id|status
op_assign
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBSTS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
multiline_comment|/* shared interrupt, not mine */
r_return
suffix:semicolon
id|outw
c_func
(paren
id|status
comma
id|io_addr
op_plus
id|USBSTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
op_complement
(paren
id|USBSTS_USBINT
op_or
id|USBSTS_ERROR
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|USBSTS_RD
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;uhci: resume detected, not implemented&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|USBSTS_HSE
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;uhci: host system error, PCI problems?&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|USBSTS_HCPE
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;uhci: host controller process error. something bad happened&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|USBSTS_HCH
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;uhci: host controller halted. very bad&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME: Reset the controller, fix the offending TD */
)brace
)brace
id|uhci_free_pending_qhs
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_lock
)paren
suffix:semicolon
id|head
op_assign
op_amp
id|uhci-&gt;urb_remove_list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|urb
comma
id|urb_list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|urb-&gt;urb_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb
op_member_access_from_pointer
id|complete
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_lock
)paren
suffix:semicolon
id|uhci_clear_next_interrupt
c_func
(paren
id|uhci
)paren
suffix:semicolon
multiline_comment|/* Walk the list of pending TD&squot;s to see which ones completed */
id|nested_lock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
id|head
op_assign
op_amp
id|uhci-&gt;urb_list
suffix:semicolon
id|tmp
op_assign
id|head-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|head
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|urb
comma
id|urb_list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
multiline_comment|/* Checks the status and does all of the magic necessary */
id|uhci_transfer_result
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
id|nested_unlock
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|reset_hc
r_static
r_void
id|reset_hc
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
multiline_comment|/* Global reset for 50ms */
id|outw
c_func
(paren
id|USBCMD_GRESET
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
DECL|function|start_hc
r_static
r_void
id|start_hc
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the HC - this will force us to get a&n;&t; * new notification of any already connected&n;&t; * ports due to the virtual disconnect that it&n;&t; * implies.&n;&t; */
id|outw
c_func
(paren
id|USBCMD_HCRESET
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBCMD
)paren
op_amp
id|USBCMD_HCRESET
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|timeout
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;uhci: USBCMD_HCRESET timed out!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Turn on all interrupts */
id|outw
c_func
(paren
id|USBINTR_TIMEOUT
op_or
id|USBINTR_RESUME
op_or
id|USBINTR_IOC
op_or
id|USBINTR_SP
comma
id|io_addr
op_plus
id|USBINTR
)paren
suffix:semicolon
multiline_comment|/* Start at frame 0 */
id|outw
c_func
(paren
l_int|0
comma
id|io_addr
op_plus
id|USBFRNUM
)paren
suffix:semicolon
id|outl
c_func
(paren
id|virt_to_bus
c_func
(paren
id|uhci-&gt;fl
)paren
comma
id|io_addr
op_plus
id|USBFLBASEADD
)paren
suffix:semicolon
multiline_comment|/* Run and mark it configured with a 64-byte max packet */
id|outw
c_func
(paren
id|USBCMD_RS
op_or
id|USBCMD_CF
op_or
id|USBCMD_MAXP
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a frame list, and then setup the skeleton&n; *&n; * The hardware doesn&squot;t really know any difference&n; * in the queues, but the order does matter for the&n; * protocols higher up. The order is:&n; *&n; *  - any isochronous events handled before any&n; *    of the queues. We don&squot;t do that here, because&n; *    we&squot;ll create the actual TD entries on demand.&n; *  - The first queue is the &quot;interrupt queue&quot;.&n; *  - The second queue is the &quot;control queue&quot;, split into low and high speed&n; *  - The third queue is &quot;bulk data&quot;.&n; */
DECL|function|alloc_uhci
r_static
r_struct
id|uhci
op_star
id|alloc_uhci
c_func
(paren
r_int
r_int
id|io_addr
comma
r_int
r_int
id|io_size
)paren
(brace
r_int
id|i
comma
id|port
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
suffix:semicolon
r_struct
id|usb_bus
op_star
id|bus
suffix:semicolon
id|uhci
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|uhci
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|uhci
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|uhci
)paren
)paren
suffix:semicolon
id|uhci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|uhci-&gt;io_addr
op_assign
id|io_addr
suffix:semicolon
id|uhci-&gt;io_size
op_assign
id|io_size
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|uhci-&gt;qh_remove_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|uhci-&gt;qh_remove_list
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|uhci-&gt;urb_remove_list
)paren
suffix:semicolon
id|nested_init
c_func
(paren
op_amp
id|uhci-&gt;urblist_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|uhci-&gt;urb_list
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|uhci-&gt;framelist_lock
)paren
suffix:semicolon
multiline_comment|/* We need exactly one page (per UHCI specs), how convenient */
multiline_comment|/* We assume that one page is atleast 4k (1024 frames * 4 bytes) */
id|uhci-&gt;fl
op_assign
(paren
r_void
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci-&gt;fl
)paren
r_goto
id|au_free_uhci
suffix:semicolon
id|bus
op_assign
id|usb_alloc_bus
c_func
(paren
op_amp
id|uhci_device_operations
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
r_goto
id|au_free_fl
suffix:semicolon
id|uhci-&gt;bus
op_assign
id|bus
suffix:semicolon
id|bus-&gt;hcpriv
op_assign
id|uhci
suffix:semicolon
multiline_comment|/* Initialize the root hub */
multiline_comment|/* UHCI specs says devices must have 2 ports, but goes on to say */
multiline_comment|/*  they may have more but give no way to determine how many they */
multiline_comment|/*  have. However, according to the UHCI spec, Bit 7 is always set */
multiline_comment|/*  to 1. So we try to use this to our advantage */
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
(paren
id|io_size
op_minus
l_int|0x10
)paren
op_div
l_int|2
suffix:semicolon
id|port
op_increment
)paren
(brace
r_int
r_int
id|portstatus
suffix:semicolon
id|portstatus
op_assign
id|inw
c_func
(paren
id|io_addr
op_plus
l_int|0x10
op_plus
(paren
id|port
op_star
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|portstatus
op_amp
l_int|0x0080
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
)paren
id|info
c_func
(paren
l_string|&quot;detected %d ports&quot;
comma
id|port
)paren
suffix:semicolon
multiline_comment|/* This is experimental so anything less than 2 or greater than 8 is */
multiline_comment|/*  something weird and we&squot;ll ignore it */
r_if
c_cond
(paren
id|port
template_param
l_int|8
)paren
(brace
id|info
c_func
(paren
l_string|&quot;port count misdetected? forcing to 2 ports&quot;
)paren
suffix:semicolon
id|port
op_assign
l_int|2
suffix:semicolon
)brace
id|uhci-&gt;rh.numports
op_assign
id|port
suffix:semicolon
multiline_comment|/*&n;&t; * 9 Interrupt queues; link int2 to int1, int4 to int2, etc&n;&t; * then link int1 to control and control to bulk&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|9
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uhci_td
op_star
id|td
op_assign
op_amp
id|uhci-&gt;skeltd
(braket
id|i
)braket
suffix:semicolon
id|uhci_fill_td
c_func
(paren
id|td
comma
l_int|0
comma
(paren
id|UHCI_NULL_DATA_SIZE
op_lshift
l_int|21
)paren
op_or
(paren
l_int|0x7f
op_lshift
l_int|8
)paren
op_or
id|USB_PID_IN
comma
l_int|0
)paren
suffix:semicolon
id|td-&gt;link
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|uhci-&gt;skeltd
(braket
id|i
op_minus
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|uhci_fill_td
c_func
(paren
op_amp
id|uhci-&gt;skel_int1_td
comma
l_int|0
comma
(paren
id|UHCI_NULL_DATA_SIZE
op_lshift
l_int|21
)paren
op_or
(paren
l_int|0x7f
op_lshift
l_int|8
)paren
op_or
id|USB_PID_IN
comma
l_int|0
)paren
suffix:semicolon
id|uhci-&gt;skel_int1_td.link
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|uhci-&gt;skel_ls_control_qh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|uhci-&gt;skel_ls_control_qh.link
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|uhci-&gt;skel_hs_control_qh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|uhci-&gt;skel_ls_control_qh.element
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|uhci-&gt;skel_hs_control_qh.link
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|uhci-&gt;skel_bulk_qh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|uhci-&gt;skel_hs_control_qh.element
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|uhci-&gt;skel_bulk_qh.link
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|uhci-&gt;skel_term_qh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|uhci-&gt;skel_bulk_qh.element
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
multiline_comment|/* This dummy TD is to work around a bug in Intel PIIX controllers */
id|uhci_fill_td
c_func
(paren
op_amp
id|uhci-&gt;skel_term_td
comma
l_int|0
comma
(paren
id|UHCI_NULL_DATA_SIZE
op_lshift
l_int|21
)paren
op_or
(paren
l_int|0x7f
op_lshift
l_int|8
)paren
op_or
id|USB_PID_IN
comma
l_int|0
)paren
suffix:semicolon
id|uhci-&gt;skel_term_td.link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|uhci-&gt;skel_term_qh.link
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|uhci-&gt;skel_term_qh.element
op_assign
id|virt_to_bus
c_func
(paren
op_amp
id|uhci-&gt;skel_term_td
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Fill the frame list: make all entries point to&n;&t; * the proper interrupt queue.&n;&t; *&n;&t; * This is probably silly, but it&squot;s a simple way to&n;&t; * scatter the interrupt queues in a way that gives&n;&t; * us a reasonable dynamic range for irq latencies.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1024
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uhci_td
op_star
id|irq
op_assign
op_amp
id|uhci-&gt;skel_int1_td
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|1
)paren
(brace
id|irq
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|2
)paren
(brace
id|irq
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|4
)paren
(brace
id|irq
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|8
)paren
(brace
id|irq
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|16
)paren
(brace
id|irq
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|32
)paren
(brace
id|irq
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
l_int|64
)paren
id|irq
op_increment
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
)brace
multiline_comment|/* Only place we don&squot;t use the frame list routines */
id|uhci-&gt;fl-&gt;frame
(braket
id|i
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
r_return
id|uhci
suffix:semicolon
multiline_comment|/*&n; * error exits:&n; */
id|au_free_fl
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|uhci-&gt;fl
)paren
suffix:semicolon
id|au_free_uhci
suffix:colon
id|kfree
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * De-allocate all resources..&n; */
DECL|function|release_uhci
r_static
r_void
id|release_uhci
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
)paren
(brace
r_if
c_cond
(paren
id|uhci-&gt;irq
op_ge
l_int|0
)paren
(brace
id|free_irq
c_func
(paren
id|uhci-&gt;irq
comma
id|uhci
)paren
suffix:semicolon
id|uhci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uhci-&gt;fl
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|uhci-&gt;fl
)paren
suffix:semicolon
id|uhci-&gt;fl
op_assign
l_int|NULL
suffix:semicolon
)brace
id|usb_free_bus
c_func
(paren
id|uhci-&gt;bus
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|uhci
)paren
suffix:semicolon
)brace
DECL|function|uhci_start_root_hub
r_int
id|uhci_start_root_hub
c_func
(paren
r_struct
id|uhci
op_star
id|uhci
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
id|dev
op_assign
id|usb_alloc_dev
c_func
(paren
l_int|NULL
comma
id|uhci-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|uhci-&gt;bus-&gt;root_hub
op_assign
id|dev
suffix:semicolon
id|usb_connect
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_new_device
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|usb_free_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * If we&squot;ve successfully found a UHCI, now is the time to increment the&n; * module usage count, and return success..&n; */
DECL|function|setup_uhci
r_static
r_int
id|setup_uhci
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|irq
comma
r_int
r_int
id|io_addr
comma
r_int
r_int
id|io_size
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|uhci
op_star
id|uhci
suffix:semicolon
r_char
id|buf
(braket
l_int|8
)braket
comma
op_star
id|bufp
op_assign
id|buf
suffix:semicolon
macro_line|#ifndef __sparc__
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&quot;
comma
id|irq
)paren
suffix:semicolon
macro_line|#else
id|bufp
op_assign
id|__irq_itoa
c_func
(paren
id|irq
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
id|__FILE__
l_string|&quot;: USB UHCI at I/O 0x%x, IRQ %s&bslash;n&quot;
comma
id|io_addr
comma
id|bufp
)paren
suffix:semicolon
id|uhci
op_assign
id|alloc_uhci
c_func
(paren
id|io_addr
comma
id|io_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;driver_data
op_assign
id|uhci
suffix:semicolon
id|request_region
c_func
(paren
id|uhci-&gt;io_addr
comma
id|io_size
comma
l_string|&quot;usb-uhci&quot;
)paren
suffix:semicolon
id|reset_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|usb_register_bus
c_func
(paren
id|uhci-&gt;bus
)paren
suffix:semicolon
id|start_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|uhci_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;usb-uhci&quot;
comma
id|uhci
)paren
op_eq
l_int|0
)paren
(brace
id|uhci-&gt;irq
op_assign
id|irq
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|USBLEGSUP
comma
id|USBLEGSUP_DEFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci_start_root_hub
c_func
(paren
id|uhci
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Couldn&squot;t allocate IRQ if we got here */
id|reset_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|uhci-&gt;io_addr
comma
id|uhci-&gt;io_size
)paren
suffix:semicolon
id|release_uhci
c_func
(paren
id|uhci
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|uhci_pci_probe
r_static
r_int
id|__devinit
id|uhci_pci_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* disable legacy emulation */
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|USBLEGSUP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
(brace
id|err
c_func
(paren
l_string|&quot;found UHCI device with no IRQ assigned. check BIOS settings!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Search for the IO base address.. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
r_int
r_int
id|io_size
op_assign
id|pci_resource_len
c_func
(paren
id|dev
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* IO address? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|dev
comma
id|i
)paren
op_amp
id|IORESOURCE_IO
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Is it already in use? */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|io_addr
comma
id|io_size
)paren
)paren
r_break
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|setup_uhci
c_func
(paren
id|dev
comma
id|dev-&gt;irq
comma
id|io_addr
comma
id|io_size
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|uhci_pci_remove
r_static
r_void
id|__devexit
id|uhci_pci_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|uhci
op_star
id|uhci
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;bus-&gt;root_hub
)paren
id|usb_disconnect
c_func
(paren
op_amp
id|uhci-&gt;bus-&gt;root_hub
)paren
suffix:semicolon
id|usb_deregister_bus
c_func
(paren
id|uhci-&gt;bus
)paren
suffix:semicolon
id|reset_hc
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|uhci-&gt;io_addr
comma
id|uhci-&gt;io_size
)paren
suffix:semicolon
id|uhci_free_pending_qhs
c_func
(paren
id|uhci
)paren
suffix:semicolon
id|release_uhci
c_func
(paren
id|uhci
)paren
suffix:semicolon
)brace
DECL|function|uhci_pci_suspend
r_static
r_void
id|uhci_pci_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|reset_hc
c_func
(paren
(paren
r_struct
id|uhci
op_star
)paren
id|dev-&gt;driver_data
)paren
suffix:semicolon
)brace
DECL|function|uhci_pci_resume
r_static
r_void
id|uhci_pci_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|reset_hc
c_func
(paren
(paren
r_struct
id|uhci
op_star
)paren
id|dev-&gt;driver_data
)paren
suffix:semicolon
id|start_hc
c_func
(paren
(paren
r_struct
id|uhci
op_star
)paren
id|dev-&gt;driver_data
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|uhci_pci_ids
r_static
r_const
r_struct
id|pci_device_id
id|__devinitdata
id|uhci_pci_ids
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* handle any USB UHCI controller */
r_class
suffix:colon
(paren
(paren
id|PCI_CLASS_SERIAL_USB
op_lshift
l_int|8
)paren
op_or
l_int|0x00
)paren
comma
id|class_mask
suffix:colon
op_complement
l_int|0
comma
multiline_comment|/* no matter who makes it */
id|vendor
suffix:colon
id|PCI_ANY_ID
comma
id|device
suffix:colon
id|PCI_ANY_ID
comma
id|subvendor
suffix:colon
id|PCI_ANY_ID
comma
id|subdevice
suffix:colon
id|PCI_ANY_ID
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|uhci_pci_ids
)paren
suffix:semicolon
DECL|variable|uhci_pci_driver
r_static
r_struct
id|pci_driver
id|uhci_pci_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;usb-uhci&quot;
comma
id|id_table
suffix:colon
op_amp
id|uhci_pci_ids
(braket
l_int|0
)braket
comma
id|probe
suffix:colon
id|uhci_pci_probe
comma
id|remove
suffix:colon
id|uhci_pci_remove
comma
macro_line|#ifdef&t;CONFIG_PM
id|suspend
suffix:colon
id|uhci_pci_suspend
comma
id|resume
suffix:colon
id|uhci_pci_resume
comma
macro_line|#endif&t;/* PM */
)brace
suffix:semicolon
DECL|function|uhci_hcd_init
r_static
r_int
id|__init
id|uhci_hcd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* We throw all of the TD&squot;s and QH&squot;s into a kmem cache */
multiline_comment|/* TD&squot;s and QH&squot;s need to be 16 byte aligned and SLAB_HWCACHE_ALIGN */
multiline_comment|/*  does this for us */
id|uhci_td_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;uhci_td&quot;
comma
r_sizeof
(paren
r_struct
id|uhci_td
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci_td_cachep
)paren
r_goto
id|td_failed
suffix:semicolon
id|uhci_qh_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;uhci_qh&quot;
comma
r_sizeof
(paren
r_struct
id|uhci_qh
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci_qh_cachep
)paren
r_goto
id|qh_failed
suffix:semicolon
id|uhci_up_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;uhci_urb_priv&quot;
comma
r_sizeof
(paren
r_struct
id|urb_priv
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci_up_cachep
)paren
r_goto
id|up_failed
suffix:semicolon
id|retval
op_assign
id|pci_module_init
(paren
op_amp
id|uhci_pci_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|init_failed
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|init_failed
suffix:colon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_up_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;uhci: not all urb_priv&squot;s were freed&bslash;n&quot;
)paren
suffix:semicolon
id|up_failed
suffix:colon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_qh_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;uhci: not all QH&squot;s were freed&bslash;n&quot;
)paren
suffix:semicolon
id|qh_failed
suffix:colon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_td_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;uhci: not all TD&squot;s were freed&bslash;n&quot;
)paren
suffix:semicolon
id|td_failed
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|uhci_hcd_cleanup
r_static
r_void
id|__exit
id|uhci_hcd_cleanup
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|uhci_pci_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_up_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;uhci: not all urb_priv&squot;s were freed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_qh_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;uhci: not all QH&squot;s were freed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_td_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;uhci: not all TD&squot;s were freed&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|uhci_hcd_init
id|module_init
c_func
(paren
id|uhci_hcd_init
)paren
suffix:semicolon
DECL|variable|uhci_hcd_cleanup
id|module_exit
c_func
(paren
id|uhci_hcd_cleanup
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Linus Torvalds, Johannes Erdfelt, Randy Dunlap, Georg Acher, Deti Fliegl, Thomas Sailer, Roman Weissgaerber&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;USB Universal Host Controller Interface driver&quot;
)paren
suffix:semicolon
eof
