multiline_comment|/*&n; * copyright (C) 1999/2000 by Henning Zabel &lt;henning@uni-paderborn.de&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2 of the License, or (at your&n; * option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY&n; * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License&n; * for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/*&n; *&t;USB-Kernel Driver for the Mustek MDC800 Digital Camera&n; *&t;(c) 1999/2000 Henning Zabel &lt;henning@uni-paderborn.de&gt;&n; *&n; *&n; * The driver brings the USB functions of the MDC800 to Linux.&n; * To use the Camera you must support the USB Protocoll of the camera&n; * to the Kernel Node.&n; * The Driver uses a misc device Node. Create it with :&n; * mknod /dev/mustek c 180 32&n; *&n; * The driver supports only one camera.&n; *&n; * version 0.7.5&n; * Fixed potential SMP races with Spinlocks.&n; * Thanks to Oliver Neukum &lt;oliver.neukum@lrz.uni-muenchen.de&gt; who &n; * noticed the race conditions.&n; * (30/10/2000)&n; *&n; * Fixed: Setting urb-&gt;dev before submitting urb.&n; * by Greg KH &lt;greg@kroah.com&gt;&n; * (13/10/2000)&n; *&n; * version 0.7.3&n; * bugfix : The mdc800-&gt;state field gets set to READY after the&n; * the diconnect function sets it to NOT_CONNECTED. This makes the&n; * driver running like the camera is connected and causes some&n; * hang ups.&n; *&n; * version 0.7.1&n; * MOD_INC and MOD_DEC are changed in usb_probe to prevent load/unload&n; * problems when compiled as Module.&n; * (04/04/2000)&n; *&n; * The mdc800 driver gets assigned the USB Minor 32-47. The Registration&n; * was updated to use these values.&n; * (26/03/2000)&n; *&n; * The Init und Exit Module Function are updated.&n; * (01/03/2000)&n; *&n; * version 0.7.0&n; * Rewrite of the driver : The driver now uses URB&squot;s. The old stuff&n; * has been removed.&n; *&n; * version 0.6.0&n; * Rewrite of this driver: The Emulation of the rs232 protocoll&n; * has been removed from the driver. A special executeCommand function&n; * for this driver is included to gphoto.&n; * The driver supports two kind of communication to bulk endpoints.&n; * Either with the dev-&gt;bus-&gt;ops-&gt;bulk... or with callback function.&n; * (09/11/1999)&n; *&n; * version 0.5.0:&n; * first Version that gets a version number. Most of the needed&n; * functions work.&n; * (20/10/1999)&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
DECL|macro|VERSION
mdefine_line|#define VERSION &t;&quot;0.7.5&quot;
DECL|macro|RELEASE_DATE
mdefine_line|#define RELEASE_DATE &t;&quot;(30/10/2000)&quot;
multiline_comment|/* Vendor and Product Information */
DECL|macro|MDC800_VENDOR_ID
mdefine_line|#define MDC800_VENDOR_ID &t;0x055f
DECL|macro|MDC800_PRODUCT_ID
mdefine_line|#define MDC800_PRODUCT_ID&t;0xa800
multiline_comment|/* Timeouts (msec) */
DECL|macro|TO_DOWNLOAD_GET_READY
mdefine_line|#define TO_DOWNLOAD_GET_READY&t;&t;1500
DECL|macro|TO_DOWNLOAD_GET_BUSY
mdefine_line|#define TO_DOWNLOAD_GET_BUSY&t;&t;1500
DECL|macro|TO_WRITE_GET_READY
mdefine_line|#define TO_WRITE_GET_READY&t;&t;1000
DECL|macro|TO_DEFAULT_COMMAND
mdefine_line|#define TO_DEFAULT_COMMAND&t;&t;5000
DECL|macro|TO_READ_FROM_IRQ
mdefine_line|#define TO_READ_FROM_IRQ &t;&t;TO_DEFAULT_COMMAND
DECL|macro|TO_GET_READY
mdefine_line|#define TO_GET_READY&t;&t;&t;TO_DEFAULT_COMMAND
multiline_comment|/* Minor Number of the device (create with mknod /dev/mustek c 180 32) */
DECL|macro|MDC800_DEVICE_MINOR_BASE
mdefine_line|#define MDC800_DEVICE_MINOR_BASE 32
multiline_comment|/**************************************************************************&n;&t;Data and structs&n;***************************************************************************/
r_typedef
r_enum
(brace
DECL|enumerator|NOT_CONNECTED
DECL|enumerator|READY
DECL|enumerator|WORKING
DECL|enumerator|DOWNLOAD
id|NOT_CONNECTED
comma
id|READY
comma
id|WORKING
comma
id|DOWNLOAD
DECL|typedef|mdc800_state
)brace
id|mdc800_state
suffix:semicolon
multiline_comment|/* Data for the driver */
DECL|struct|mdc800_data
r_struct
id|mdc800_data
(brace
DECL|member|dev
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
singleline_comment|// Device Data
DECL|member|state
id|mdc800_state
id|state
suffix:semicolon
DECL|member|endpoint
r_int
r_int
id|endpoint
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|irq_urb
id|purb_t
id|irq_urb
suffix:semicolon
DECL|member|irq_wait
id|wait_queue_head_t
id|irq_wait
suffix:semicolon
DECL|member|irq_urb_buffer
r_char
op_star
id|irq_urb_buffer
suffix:semicolon
DECL|member|camera_busy
r_int
id|camera_busy
suffix:semicolon
singleline_comment|// is camera busy ?
DECL|member|camera_request_ready
r_int
id|camera_request_ready
suffix:semicolon
singleline_comment|// Status to synchronize with irq
DECL|member|camera_response
r_char
id|camera_response
(braket
l_int|8
)braket
suffix:semicolon
singleline_comment|// last Bytes send after busy
DECL|member|write_urb
id|purb_t
id|write_urb
suffix:semicolon
DECL|member|write_urb_buffer
r_char
op_star
id|write_urb_buffer
suffix:semicolon
DECL|member|write_wait
id|wait_queue_head_t
id|write_wait
suffix:semicolon
DECL|member|download_urb
id|purb_t
id|download_urb
suffix:semicolon
DECL|member|download_urb_buffer
r_char
op_star
id|download_urb_buffer
suffix:semicolon
DECL|member|download_wait
id|wait_queue_head_t
id|download_wait
suffix:semicolon
DECL|member|download_left
r_int
id|download_left
suffix:semicolon
singleline_comment|// Bytes left to download ?
multiline_comment|/* Device Data */
DECL|member|out
r_char
id|out
(braket
l_int|64
)braket
suffix:semicolon
singleline_comment|// Answer Buffer
DECL|member|out_ptr
r_int
id|out_ptr
suffix:semicolon
singleline_comment|// Index to the first not readen byte
DECL|member|out_count
r_int
id|out_count
suffix:semicolon
singleline_comment|// Bytes in the buffer
DECL|member|open
r_int
id|open
suffix:semicolon
singleline_comment|// Camera device open ?
DECL|member|io_lock
id|spinlock_t
id|io_lock
suffix:semicolon
singleline_comment|// IO -lock&t;
DECL|member|in
r_char
id|in
(braket
l_int|8
)braket
suffix:semicolon
singleline_comment|// Command Input Buffer
DECL|member|in_count
r_int
id|in_count
suffix:semicolon
DECL|member|pic_index
r_int
id|pic_index
suffix:semicolon
singleline_comment|// Cache for the Imagesize (-1 for nothing cached )
DECL|member|pic_len
r_int
id|pic_len
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Specification of the Endpoints */
DECL|variable|mdc800_ed
r_static
r_struct
id|usb_endpoint_descriptor
id|mdc800_ed
(braket
l_int|4
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
comma
l_int|0x01
comma
l_int|0x02
comma
l_int|8
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0x82
comma
l_int|0x03
comma
l_int|8
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0x03
comma
l_int|0x02
comma
l_int|64
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0x84
comma
l_int|0x02
comma
l_int|64
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* The Variable used by the driver */
DECL|variable|mdc800
r_static
r_struct
id|mdc800_data
op_star
id|mdc800
op_assign
l_int|0
suffix:semicolon
multiline_comment|/***************************************************************************&n;&t;The USB Part of the driver&n;****************************************************************************/
DECL|function|mdc800_endpoint_equals
r_static
r_int
id|mdc800_endpoint_equals
(paren
r_struct
id|usb_endpoint_descriptor
op_star
id|a
comma
r_struct
id|usb_endpoint_descriptor
op_star
id|b
)paren
(brace
r_return
(paren
(paren
id|a-&gt;bEndpointAddress
op_eq
id|b-&gt;bEndpointAddress
)paren
op_logical_and
(paren
id|a-&gt;bmAttributes
op_eq
id|b-&gt;bmAttributes
)paren
op_logical_and
(paren
id|a-&gt;wMaxPacketSize
op_eq
id|b-&gt;wMaxPacketSize
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Checks wether the camera responds busy&n; */
DECL|function|mdc800_isBusy
r_static
r_int
id|mdc800_isBusy
(paren
r_char
op_star
id|ch
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|ch
(braket
id|i
)braket
op_ne
(paren
r_char
)paren
l_int|0x99
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Checks wether the Camera is ready&n; */
DECL|function|mdc800_isReady
r_static
r_int
id|mdc800_isReady
(paren
r_char
op_star
id|ch
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|ch
(braket
id|i
)braket
op_ne
(paren
r_char
)paren
l_int|0xbb
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * USB IRQ Handler for InputLine&n; */
DECL|function|mdc800_usb_irq
r_static
r_void
id|mdc800_usb_irq
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|data_received
op_assign
l_int|0
comma
id|wake_up
suffix:semicolon
r_int
r_char
op_star
id|b
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_struct
id|mdc800_data
op_star
id|mdc800
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_ge
l_int|0
)paren
(brace
singleline_comment|//dbg (&quot;%i %i %i %i %i %i %i %i &bslash;n&quot;,b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7]);
r_if
c_cond
(paren
id|mdc800_isBusy
(paren
id|b
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mdc800-&gt;camera_busy
)paren
(brace
id|mdc800-&gt;camera_busy
op_assign
l_int|1
suffix:semicolon
id|dbg
(paren
l_string|&quot;gets busy&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|mdc800-&gt;camera_busy
op_logical_and
id|mdc800_isReady
(paren
id|b
)paren
)paren
(brace
id|mdc800-&gt;camera_busy
op_assign
l_int|0
suffix:semicolon
id|dbg
(paren
l_string|&quot;gets ready&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mdc800_isBusy
(paren
id|b
)paren
op_logical_or
id|mdc800_isReady
(paren
id|b
)paren
)paren
)paren
(brace
multiline_comment|/* Store Data in camera_answer field */
id|dbg
(paren
l_string|&quot;%i %i %i %i %i %i %i %i &quot;
comma
id|b
(braket
l_int|0
)braket
comma
id|b
(braket
l_int|1
)braket
comma
id|b
(braket
l_int|2
)braket
comma
id|b
(braket
l_int|3
)braket
comma
id|b
(braket
l_int|4
)braket
comma
id|b
(braket
l_int|5
)braket
comma
id|b
(braket
l_int|6
)braket
comma
id|b
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|memcpy
(paren
id|mdc800-&gt;camera_response
comma
id|b
comma
l_int|8
)paren
suffix:semicolon
id|data_received
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|wake_up
op_assign
(paren
id|mdc800-&gt;camera_request_ready
OG
l_int|0
)paren
op_logical_and
(paren
(paren
(paren
id|mdc800-&gt;camera_request_ready
op_eq
l_int|1
)paren
op_logical_and
(paren
op_logical_neg
id|mdc800-&gt;camera_busy
)paren
)paren
op_logical_or
(paren
(paren
id|mdc800-&gt;camera_request_ready
op_eq
l_int|2
)paren
op_logical_and
id|data_received
)paren
op_logical_or
(paren
(paren
id|mdc800-&gt;camera_request_ready
op_eq
l_int|3
)paren
op_logical_and
(paren
id|mdc800-&gt;camera_busy
)paren
)paren
op_logical_or
(paren
id|urb-&gt;status
OL
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wake_up
)paren
(brace
id|mdc800-&gt;camera_request_ready
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|mdc800-&gt;irq_wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Waits a while until the irq responds that camera is ready&n; *&n; *  mode : 0: Wait for camera gets ready&n; *         1: Wait for receiving data&n; *         2: Wait for camera gets busy&n; *&n; * msec: Time to wait&n; */
DECL|function|mdc800_usb_waitForIRQ
r_static
r_int
id|mdc800_usb_waitForIRQ
(paren
r_int
id|mode
comma
r_int
id|msec
)paren
(brace
id|mdc800-&gt;camera_request_ready
op_assign
l_int|1
op_plus
id|mode
suffix:semicolon
id|interruptible_sleep_on_timeout
(paren
op_amp
id|mdc800-&gt;irq_wait
comma
id|msec
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;camera_request_ready
OG
l_int|0
)paren
(brace
id|mdc800-&gt;camera_request_ready
op_assign
l_int|0
suffix:semicolon
id|err
(paren
l_string|&quot;timeout waiting for camera.&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mdc800-&gt;state
op_eq
id|NOT_CONNECTED
)paren
(brace
id|warn
(paren
l_string|&quot;Camera gets disconnected during waiting for irq.&quot;
)paren
suffix:semicolon
id|mdc800-&gt;camera_request_ready
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
l_int|2
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The write_urb callback function&n; */
DECL|function|mdc800_usb_write_notify
r_static
r_void
id|mdc800_usb_write_notify
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|mdc800_data
op_star
id|mdc800
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_ne
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;writing command fails (status=%i)&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdc800-&gt;state
op_assign
id|READY
suffix:semicolon
)brace
id|wake_up_interruptible
(paren
op_amp
id|mdc800-&gt;write_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The download_urb callback function&n; */
DECL|function|mdc800_usb_download_notify
r_static
r_void
id|mdc800_usb_download_notify
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|mdc800_data
op_star
id|mdc800
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Fill output buffer with these data */
id|memcpy
(paren
id|mdc800-&gt;out
comma
id|urb-&gt;transfer_buffer
comma
l_int|64
)paren
suffix:semicolon
id|mdc800-&gt;out_count
op_assign
l_int|64
suffix:semicolon
id|mdc800-&gt;out_ptr
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;download_left
op_sub_assign
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;download_left
op_eq
l_int|0
)paren
(brace
id|mdc800-&gt;state
op_assign
id|READY
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
(paren
l_string|&quot;request bytes fails (status:%i)&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
(paren
op_amp
id|mdc800-&gt;download_wait
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n;&t;Probing for the Camera&n; ***************************************************************************/
DECL|variable|mdc800_usb_driver
r_static
r_struct
id|usb_driver
id|mdc800_usb_driver
suffix:semicolon
multiline_comment|/*&n; * Callback to search the Mustek MDC800 on the USB Bus&n; */
DECL|function|mdc800_usb_probe
r_static
r_void
op_star
id|mdc800_usb_probe
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|ifnum
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|intf_desc
suffix:semicolon
r_int
id|irq_interval
op_assign
l_int|0
suffix:semicolon
id|dbg
(paren
l_string|&quot;(mdc800_usb_probe) called.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;dev
op_ne
l_int|0
)paren
(brace
id|warn
(paren
l_string|&quot;only one Mustek MDC800 is supported.&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
(brace
id|err
(paren
l_string|&quot;probe fails -&gt; wrong Number of Configuration&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|intf_desc
op_assign
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|ifnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|intf_desc-&gt;bInterfaceClass
op_ne
l_int|0xff
)paren
op_logical_or
(paren
id|intf_desc-&gt;bInterfaceSubClass
op_ne
l_int|0
)paren
op_logical_or
(paren
id|intf_desc-&gt;bInterfaceProtocol
op_ne
l_int|0
)paren
op_logical_or
(paren
id|intf_desc-&gt;bNumEndpoints
op_ne
l_int|4
)paren
)paren
(brace
id|err
(paren
l_string|&quot;probe fails -&gt; wrong Interface&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check the Endpoints */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mdc800-&gt;endpoint
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mdc800_endpoint_equals
(paren
op_amp
id|intf_desc-&gt;endpoint
(braket
id|j
)braket
comma
op_amp
id|mdc800_ed
(braket
id|i
)braket
)paren
)paren
(brace
id|mdc800-&gt;endpoint
(braket
id|i
)braket
op_assign
id|intf_desc-&gt;endpoint
(braket
id|j
)braket
dot
id|bEndpointAddress
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|1
)paren
(brace
id|irq_interval
op_assign
id|intf_desc-&gt;endpoint
(braket
id|j
)braket
dot
id|bInterval
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mdc800-&gt;endpoint
(braket
id|i
)braket
op_eq
op_minus
l_int|1
)paren
(brace
id|err
(paren
l_string|&quot;probe fails -&gt; Wrong Endpoints.&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|usb_driver_claim_interface
(paren
op_amp
id|mdc800_usb_driver
comma
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|ifnum
)braket
comma
id|mdc800
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_set_interface
(paren
id|dev
comma
id|ifnum
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;MDC800 Configuration fails.&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|info
(paren
l_string|&quot;Found Mustek MDC800 on USB.&quot;
)paren
suffix:semicolon
id|spin_lock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
id|mdc800-&gt;dev
op_assign
id|dev
suffix:semicolon
id|mdc800-&gt;open
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setup URB Structs */
id|FILL_INT_URB
(paren
id|mdc800-&gt;irq_urb
comma
id|mdc800-&gt;dev
comma
id|usb_rcvintpipe
(paren
id|mdc800-&gt;dev
comma
id|mdc800-&gt;endpoint
(braket
l_int|1
)braket
)paren
comma
id|mdc800-&gt;irq_urb_buffer
comma
l_int|8
comma
id|mdc800_usb_irq
comma
id|mdc800
comma
id|irq_interval
)paren
suffix:semicolon
id|FILL_BULK_URB
(paren
id|mdc800-&gt;write_urb
comma
id|mdc800-&gt;dev
comma
id|usb_sndbulkpipe
(paren
id|mdc800-&gt;dev
comma
id|mdc800-&gt;endpoint
(braket
l_int|0
)braket
)paren
comma
id|mdc800-&gt;write_urb_buffer
comma
l_int|8
comma
id|mdc800_usb_write_notify
comma
id|mdc800
)paren
suffix:semicolon
id|FILL_BULK_URB
(paren
id|mdc800-&gt;download_urb
comma
id|mdc800-&gt;dev
comma
id|usb_rcvbulkpipe
(paren
id|mdc800-&gt;dev
comma
id|mdc800-&gt;endpoint
(braket
l_int|3
)braket
)paren
comma
id|mdc800-&gt;download_urb_buffer
comma
l_int|64
comma
id|mdc800_usb_download_notify
comma
id|mdc800
)paren
suffix:semicolon
id|mdc800-&gt;state
op_assign
id|READY
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
id|mdc800
suffix:semicolon
)brace
multiline_comment|/*&n; * Disconnect USB device (maybe the MDC800)&n; */
DECL|function|mdc800_usb_disconnect
r_static
r_void
id|mdc800_usb_disconnect
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|mdc800_data
op_star
id|mdc800
op_assign
(paren
r_struct
id|mdc800_data
op_star
)paren
id|ptr
suffix:semicolon
id|dbg
(paren
l_string|&quot;(mdc800_usb_disconnect) called&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;state
op_eq
id|NOT_CONNECTED
)paren
r_return
suffix:semicolon
id|mdc800-&gt;state
op_assign
id|NOT_CONNECTED
suffix:semicolon
id|usb_unlink_urb
(paren
id|mdc800-&gt;irq_urb
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|mdc800-&gt;write_urb
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|mdc800-&gt;download_urb
)paren
suffix:semicolon
id|usb_driver_release_interface
(paren
op_amp
id|mdc800_usb_driver
comma
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|mdc800-&gt;dev
op_assign
l_int|0
suffix:semicolon
id|info
(paren
l_string|&quot;Mustek MDC800 disconnected from USB.&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n;&t;The Misc device Part (file_operations)&n;****************************************************************************/
multiline_comment|/*&n; * This Function calc the Answersize for a command.&n; */
DECL|function|mdc800_getAnswerSize
r_static
r_int
id|mdc800_getAnswerSize
(paren
r_char
id|command
)paren
(brace
r_switch
c_cond
(paren
(paren
r_int
r_char
)paren
id|command
)paren
(brace
r_case
l_int|0x2a
suffix:colon
r_case
l_int|0x49
suffix:colon
r_case
l_int|0x51
suffix:colon
r_case
l_int|0x0d
suffix:colon
r_case
l_int|0x20
suffix:colon
r_case
l_int|0x07
suffix:colon
r_case
l_int|0x01
suffix:colon
r_case
l_int|0x25
suffix:colon
r_case
l_int|0x00
suffix:colon
r_return
l_int|8
suffix:semicolon
r_case
l_int|0x05
suffix:colon
r_case
l_int|0x3e
suffix:colon
r_return
id|mdc800-&gt;pic_len
suffix:semicolon
r_case
l_int|0x09
suffix:colon
r_return
l_int|4096
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Init the device: (1) alloc mem (2) Increase MOD Count ..&n; */
DECL|function|mdc800_device_open
r_static
r_int
id|mdc800_device_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|errn
op_assign
l_int|0
suffix:semicolon
id|spin_lock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;state
op_eq
id|NOT_CONNECTED
)paren
(brace
id|errn
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mdc800-&gt;open
)paren
(brace
id|errn
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
id|mdc800-&gt;in_count
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;out_count
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;out_ptr
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;pic_index
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;pic_len
op_assign
op_minus
l_int|1
suffix:semicolon
id|mdc800-&gt;download_left
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;camera_busy
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;camera_request_ready
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;irq_urb-&gt;dev
op_assign
id|mdc800-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
(paren
id|mdc800-&gt;irq_urb
)paren
)paren
(brace
id|err
(paren
l_string|&quot;request USB irq fails (submit_retval=%i urb_status=%i).&quot;
comma
id|retval
comma
id|mdc800-&gt;irq_urb-&gt;status
)paren
suffix:semicolon
id|errn
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error_out
suffix:semicolon
)brace
id|mdc800-&gt;open
op_assign
l_int|1
suffix:semicolon
id|dbg
(paren
l_string|&quot;Mustek MDC800 device opened.&quot;
)paren
suffix:semicolon
id|error_out
suffix:colon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
id|errn
suffix:semicolon
)brace
multiline_comment|/*&n; * Close the Camera and release Memory&n; */
DECL|function|mdc800_device_release
r_static
r_int
id|mdc800_device_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|dbg
(paren
l_string|&quot;Mustek MDC800 device closed.&quot;
)paren
suffix:semicolon
id|spin_lock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;open
op_logical_and
(paren
id|mdc800-&gt;state
op_ne
id|NOT_CONNECTED
)paren
)paren
(brace
id|mdc800-&gt;open
op_assign
l_int|0
suffix:semicolon
id|usb_unlink_urb
(paren
id|mdc800-&gt;irq_urb
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|mdc800-&gt;write_urb
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|mdc800-&gt;download_urb
)paren
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * The Device read callback Function&n; */
DECL|function|mdc800_device_read
r_static
id|ssize_t
id|mdc800_device_read
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_int
id|left
op_assign
id|len
comma
id|sts
op_assign
id|len
suffix:semicolon
multiline_comment|/* single transfer size */
r_char
op_star
id|ptr
op_assign
id|buf
suffix:semicolon
id|spin_lock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;state
op_eq
id|NOT_CONNECTED
)paren
(brace
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mdc800-&gt;state
op_eq
id|WORKING
)paren
(brace
id|warn
(paren
l_string|&quot;Illegal State &bslash;&quot;working&bslash;&quot; reached during read ?!&quot;
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mdc800-&gt;open
)paren
(brace
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_while
c_loop
(paren
id|left
)paren
(brace
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|sts
op_assign
id|left
OG
(paren
id|mdc800-&gt;out_count
op_minus
id|mdc800-&gt;out_ptr
)paren
ques
c_cond
id|mdc800-&gt;out_count
op_minus
id|mdc800-&gt;out_ptr
suffix:colon
id|left
suffix:semicolon
r_if
c_cond
(paren
id|sts
op_le
l_int|0
)paren
(brace
multiline_comment|/* Too less Data in buffer */
r_if
c_cond
(paren
id|mdc800-&gt;state
op_eq
id|DOWNLOAD
)paren
(brace
id|mdc800-&gt;out_count
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;out_ptr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Download -&gt; Request new bytes */
id|mdc800-&gt;download_urb-&gt;dev
op_assign
id|mdc800-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
(paren
id|mdc800-&gt;download_urb
)paren
)paren
(brace
id|err
(paren
l_string|&quot;Can&squot;t submit download urb (status=%i)&quot;
comma
id|mdc800-&gt;download_urb-&gt;status
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
id|len
op_minus
id|left
suffix:semicolon
)brace
id|interruptible_sleep_on_timeout
(paren
op_amp
id|mdc800-&gt;download_wait
comma
id|TO_DOWNLOAD_GET_READY
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;download_urb-&gt;status
op_ne
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;request download-bytes fails (status=%i)&quot;
comma
id|mdc800-&gt;download_urb-&gt;status
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
id|len
op_minus
id|left
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* No more bytes -&gt; that&squot;s an error*/
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* memcpy Bytes */
id|memcpy
(paren
id|ptr
comma
op_amp
id|mdc800-&gt;out
(braket
id|mdc800-&gt;out_ptr
)braket
comma
id|sts
)paren
suffix:semicolon
id|ptr
op_add_assign
id|sts
suffix:semicolon
id|left
op_sub_assign
id|sts
suffix:semicolon
id|mdc800-&gt;out_ptr
op_add_assign
id|sts
suffix:semicolon
)brace
)brace
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
id|len
op_minus
id|left
suffix:semicolon
)brace
multiline_comment|/*&n; * The Device write callback Function&n; * If a 8Byte Command is received, it will be send to the camera.&n; * After this the driver initiates the request for the answer or&n; * just waits until the camera becomes ready.&n; */
DECL|function|mdc800_device_write
r_static
id|ssize_t
id|mdc800_device_write
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|len
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|spin_lock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;state
op_ne
id|READY
)paren
(brace
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mdc800-&gt;open
)paren
(brace
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|len
)paren
(brace
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
multiline_comment|/* check for command start */
r_if
c_cond
(paren
id|buf
(braket
id|i
)braket
op_eq
(paren
r_char
)paren
l_int|0x55
)paren
(brace
id|mdc800-&gt;in_count
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;out_count
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;out_ptr
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;download_left
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* save command byte */
r_if
c_cond
(paren
id|mdc800-&gt;in_count
OL
l_int|8
)paren
(brace
id|mdc800-&gt;in
(braket
id|mdc800-&gt;in_count
)braket
op_assign
id|buf
(braket
id|i
)braket
suffix:semicolon
id|mdc800-&gt;in_count
op_increment
suffix:semicolon
)brace
r_else
(brace
id|err
(paren
l_string|&quot;Command is to long !&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Command Buffer full ? -&gt; send it to camera */
r_if
c_cond
(paren
id|mdc800-&gt;in_count
op_eq
l_int|8
)paren
(brace
r_int
id|answersize
suffix:semicolon
r_if
c_cond
(paren
id|mdc800_usb_waitForIRQ
(paren
l_int|0
comma
id|TO_GET_READY
)paren
)paren
(brace
id|err
(paren
l_string|&quot;Camera didn&squot;t get ready.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|answersize
op_assign
id|mdc800_getAnswerSize
(paren
id|mdc800-&gt;in
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|mdc800-&gt;state
op_assign
id|WORKING
suffix:semicolon
id|memcpy
(paren
id|mdc800-&gt;write_urb-&gt;transfer_buffer
comma
id|mdc800-&gt;in
comma
l_int|8
)paren
suffix:semicolon
id|mdc800-&gt;write_urb-&gt;dev
op_assign
id|mdc800-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
(paren
id|mdc800-&gt;write_urb
)paren
)paren
(brace
id|err
(paren
l_string|&quot;submitting write urb fails (status=%i)&quot;
comma
id|mdc800-&gt;write_urb-&gt;status
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|interruptible_sleep_on_timeout
(paren
op_amp
id|mdc800-&gt;write_wait
comma
id|TO_WRITE_GET_READY
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mdc800-&gt;state
op_eq
id|WORKING
)paren
(brace
id|usb_unlink_urb
(paren
id|mdc800-&gt;write_urb
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_switch
c_cond
(paren
(paren
r_int
r_char
)paren
id|mdc800-&gt;in
(braket
l_int|1
)braket
)paren
(brace
r_case
l_int|0x05
suffix:colon
multiline_comment|/* Download Image */
r_case
l_int|0x3e
suffix:colon
multiline_comment|/* Take shot in Fine Mode (WCam Mode) */
r_if
c_cond
(paren
id|mdc800-&gt;pic_len
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;call 0x07 before 0x05,0x3e&quot;
)paren
suffix:semicolon
id|mdc800-&gt;state
op_assign
id|READY
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|mdc800-&gt;pic_len
op_assign
op_minus
l_int|1
suffix:semicolon
r_case
l_int|0x09
suffix:colon
multiline_comment|/* Download Thumbnail */
id|mdc800-&gt;download_left
op_assign
id|answersize
op_plus
l_int|64
suffix:semicolon
id|mdc800-&gt;state
op_assign
id|DOWNLOAD
suffix:semicolon
id|mdc800_usb_waitForIRQ
(paren
l_int|0
comma
id|TO_DOWNLOAD_GET_BUSY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|answersize
)paren
(brace
r_if
c_cond
(paren
id|mdc800_usb_waitForIRQ
(paren
l_int|1
comma
id|TO_READ_FROM_IRQ
)paren
)paren
(brace
id|err
(paren
l_string|&quot;requesting answer from irq fails&quot;
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Write dummy data, (this is ugly but part of the USB Protokoll */
multiline_comment|/* if you use endpoint 1 as bulk and not as irq */
id|memcpy
(paren
id|mdc800-&gt;out
comma
id|mdc800-&gt;camera_response
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* This is the interpreted answer */
id|memcpy
(paren
op_amp
id|mdc800-&gt;out
(braket
l_int|8
)braket
comma
id|mdc800-&gt;camera_response
comma
l_int|8
)paren
suffix:semicolon
id|mdc800-&gt;out_ptr
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;out_count
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* Cache the Imagesize, if command was getImageSize */
r_if
c_cond
(paren
id|mdc800-&gt;in
(braket
l_int|1
)braket
op_eq
(paren
r_char
)paren
l_int|0x07
)paren
(brace
id|mdc800-&gt;pic_len
op_assign
(paren
r_int
)paren
l_int|65536
op_star
(paren
r_int
r_char
)paren
id|mdc800-&gt;camera_response
(braket
l_int|0
)braket
op_plus
l_int|256
op_star
(paren
r_int
r_char
)paren
id|mdc800-&gt;camera_response
(braket
l_int|1
)braket
op_plus
(paren
r_int
r_char
)paren
id|mdc800-&gt;camera_response
(braket
l_int|2
)braket
suffix:semicolon
id|dbg
(paren
l_string|&quot;cached imagesize = %i&quot;
comma
id|mdc800-&gt;pic_len
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|mdc800_usb_waitForIRQ
(paren
l_int|0
comma
id|TO_DEFAULT_COMMAND
)paren
)paren
(brace
id|err
(paren
l_string|&quot;Command Timeout.&quot;
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|mdc800-&gt;state
op_assign
id|READY
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|i
op_increment
suffix:semicolon
)brace
id|spin_unlock
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/***************************************************************************&n;&t;Init and Cleanup this driver (Structs and types)&n;****************************************************************************/
multiline_comment|/* File Operations of this drivers */
DECL|variable|mdc800_device_ops
r_static
r_struct
id|file_operations
id|mdc800_device_ops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|read
suffix:colon
id|mdc800_device_read
comma
id|write
suffix:colon
id|mdc800_device_write
comma
id|open
suffix:colon
id|mdc800_device_open
comma
id|release
suffix:colon
id|mdc800_device_release
comma
)brace
suffix:semicolon
DECL|variable|mdc800_table
r_static
r_struct
id|usb_device_id
id|mdc800_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|MDC800_VENDOR_ID
comma
id|MDC800_PRODUCT_ID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|mdc800_table
)paren
suffix:semicolon
multiline_comment|/*&n; * USB Driver Struct for this device&n; */
DECL|variable|mdc800_usb_driver
r_static
r_struct
id|usb_driver
id|mdc800_usb_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;mdc800&quot;
comma
id|probe
suffix:colon
id|mdc800_usb_probe
comma
id|disconnect
suffix:colon
id|mdc800_usb_disconnect
comma
id|fops
suffix:colon
op_amp
id|mdc800_device_ops
comma
id|minor
suffix:colon
id|MDC800_DEVICE_MINOR_BASE
comma
id|id_table
suffix:colon
id|mdc800_table
)brace
suffix:semicolon
multiline_comment|/************************************************************************&n;&t;Init and Cleanup this driver (Main Functions)&n;*************************************************************************/
DECL|macro|try
mdefine_line|#define try(A)           if ((A) == 0) goto cleanup_on_fail;
DECL|macro|try_free_mem
mdefine_line|#define try_free_mem(A)  if (A != 0) { kfree (A); A=0; }
DECL|macro|try_free_urb
mdefine_line|#define try_free_urb(A)  if (A != 0) { usb_free_urb (A); A=0; }
DECL|function|usb_mdc800_init
r_int
id|__init
id|usb_mdc800_init
(paren
r_void
)paren
(brace
multiline_comment|/* Allocate Memory */
r_try
(paren
id|mdc800
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|mdc800_data
)paren
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|mdc800
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mdc800_data
)paren
)paren
suffix:semicolon
id|mdc800-&gt;dev
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;open
op_assign
l_int|0
suffix:semicolon
id|mdc800-&gt;state
op_assign
id|NOT_CONNECTED
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|mdc800-&gt;io_lock
)paren
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|mdc800-&gt;irq_wait
)paren
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|mdc800-&gt;write_wait
)paren
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|mdc800-&gt;download_wait
)paren
suffix:semicolon
r_try
(paren
id|mdc800-&gt;irq_urb_buffer
op_assign
id|kmalloc
(paren
l_int|8
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
r_try
(paren
id|mdc800-&gt;write_urb_buffer
op_assign
id|kmalloc
(paren
l_int|8
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
r_try
(paren
id|mdc800-&gt;download_urb_buffer
op_assign
id|kmalloc
(paren
l_int|64
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
r_try
(paren
id|mdc800-&gt;irq_urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_try
(paren
id|mdc800-&gt;download_urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_try
(paren
id|mdc800-&gt;write_urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Register the driver */
r_if
c_cond
(paren
id|usb_register
(paren
op_amp
id|mdc800_usb_driver
)paren
OL
l_int|0
)paren
r_goto
id|cleanup_on_fail
suffix:semicolon
id|info
(paren
l_string|&quot;Mustek Digital Camera Driver &quot;
id|VERSION
l_string|&quot; (MDC800)&quot;
)paren
suffix:semicolon
id|info
(paren
id|RELEASE_DATE
l_string|&quot; Henning Zabel &lt;henning@uni-paderborn.de&gt;&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Clean driver up, when something fails */
id|cleanup_on_fail
suffix:colon
r_if
c_cond
(paren
id|mdc800
op_ne
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;can&squot;t alloc memory!&quot;
)paren
suffix:semicolon
id|try_free_mem
(paren
id|mdc800-&gt;download_urb_buffer
)paren
suffix:semicolon
id|try_free_mem
(paren
id|mdc800-&gt;write_urb_buffer
)paren
suffix:semicolon
id|try_free_mem
(paren
id|mdc800-&gt;irq_urb_buffer
)paren
suffix:semicolon
id|try_free_urb
(paren
id|mdc800-&gt;write_urb
)paren
suffix:semicolon
id|try_free_urb
(paren
id|mdc800-&gt;download_urb
)paren
suffix:semicolon
id|try_free_urb
(paren
id|mdc800-&gt;irq_urb
)paren
suffix:semicolon
id|kfree
(paren
id|mdc800
)paren
suffix:semicolon
)brace
id|mdc800
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|usb_mdc800_cleanup
r_void
id|__exit
id|usb_mdc800_cleanup
(paren
r_void
)paren
(brace
id|usb_deregister
(paren
op_amp
id|mdc800_usb_driver
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|mdc800-&gt;irq_urb
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|mdc800-&gt;download_urb
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|mdc800-&gt;write_urb
)paren
suffix:semicolon
id|kfree
(paren
id|mdc800-&gt;irq_urb_buffer
)paren
suffix:semicolon
id|kfree
(paren
id|mdc800-&gt;write_urb_buffer
)paren
suffix:semicolon
id|kfree
(paren
id|mdc800-&gt;download_urb_buffer
)paren
suffix:semicolon
id|kfree
(paren
id|mdc800
)paren
suffix:semicolon
id|mdc800
op_assign
l_int|0
suffix:semicolon
)brace
id|MODULE_AUTHOR
(paren
l_string|&quot;Henning Zabel &lt;henning@uni-paderborn.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;USB Driver for Mustek MDC800 Digital Camera&quot;
)paren
suffix:semicolon
DECL|variable|usb_mdc800_init
id|module_init
(paren
id|usb_mdc800_init
)paren
suffix:semicolon
DECL|variable|usb_mdc800_cleanup
id|module_exit
(paren
id|usb_mdc800_cleanup
)paren
suffix:semicolon
eof
