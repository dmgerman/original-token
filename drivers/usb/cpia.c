multiline_comment|/*&n; * USB CPiA Video Camera driver&n; *&n; * Supports CPiA based Video Camera&squot;s. Many manufacturers use this chipset.&n; * There&squot;s a good chance, if you have a USB video camera, it&squot;s a CPiA based&n; * one&n; *&n; * (C) Copyright 1999 Johannes Erdfelt&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;uhci.h&quot;
macro_line|#include &quot;cpia.h&quot;
DECL|macro|MAX_FRAME_SIZE
mdefine_line|#define MAX_FRAME_SIZE (384 * 288 * 3)
multiline_comment|/*******************************/
multiline_comment|/* Memory management functions */
multiline_comment|/*******************************/
multiline_comment|/* convert virtual user memory address to physical address */
multiline_comment|/* (virt_to_phys only works for kmalloced kernel memory) */
DECL|function|uvirt_to_phys
r_static
r_inline
r_int
r_int
id|uvirt_to_phys
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
id|pgd_t
op_star
id|pgd
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
id|pgd
op_assign
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|adr
multiline_comment|/*&amp;(~PGDIR_MASK)*/
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
(brace
r_return
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|pte_page
c_func
(paren
id|pte
)paren
op_or
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uvirt_to_bus
r_static
r_inline
r_int
r_int
id|uvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_return
id|virt_to_bus
c_func
(paren
id|phys_to_virt
c_func
(paren
id|uvirt_to_phys
c_func
(paren
id|adr
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* convert virtual kernel memory address to physical address */
multiline_comment|/* (virt_to_phys only works for kmalloced kernel memory) */
DECL|function|kvirt_to_phys
r_static
r_inline
r_int
r_int
id|kvirt_to_phys
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_return
id|uvirt_to_phys
c_func
(paren
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
)paren
suffix:semicolon
)brace
DECL|function|kvirt_to_bus
r_static
r_inline
r_int
r_int
id|kvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_return
id|uvirt_to_bus
c_func
(paren
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
)paren
suffix:semicolon
)brace
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|mem
op_assign
id|vmalloc
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_phys
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|MAP_NR
c_func
(paren
id|phys_to_virt
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_phys
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|MAP_NR
c_func
(paren
id|phys_to_virt
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
)brace
DECL|function|usb_cpia_get_version
r_int
id|usb_cpia_get_version
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|buf
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
op_or
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_GET_VERSION
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|4
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|buf
comma
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_get_pnp_id
r_int
id|usb_cpia_get_pnp_id
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|buf
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
op_or
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_GET_PNP_ID
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|6
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|buf
comma
l_int|6
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_get_camera_status
r_int
id|usb_cpia_get_camera_status
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|buf
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
op_or
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_GET_CAMERA_STATUS
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|8
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|buf
comma
l_int|8
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_goto_hi_power
r_int
id|usb_cpia_goto_hi_power
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_GOTO_HI_POWER
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_get_vp_version
r_int
id|usb_cpia_get_vp_version
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|buf
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_GET_VP_VERSION
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|4
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|buf
comma
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_set_sensor_fps
r_int
id|usb_cpia_set_sensor_fps
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|sensorbaserate
comma
r_int
id|sensorclkdivisor
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_SET_SENSOR_FPS
suffix:semicolon
id|dr.value
op_assign
(paren
id|sensorclkdivisor
op_lshift
l_int|8
)paren
op_plus
id|sensorbaserate
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_grab_frame
r_int
id|usb_cpia_grab_frame
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|streamstartline
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_GRAB_FRAME
suffix:semicolon
id|dr.value
op_assign
id|streamstartline
op_lshift
l_int|8
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_upload_frame
r_int
id|usb_cpia_upload_frame
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|forceupload
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_UPLOAD_FRAME
suffix:semicolon
id|dr.value
op_assign
id|forceupload
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_set_grab_mode
r_int
id|usb_cpia_set_grab_mode
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|continuousgrab
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_SET_GRAB_MODE
suffix:semicolon
id|dr.value
op_assign
id|continuousgrab
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_set_format
r_int
id|usb_cpia_set_format
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|size
comma
r_int
id|subsample
comma
r_int
id|order
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_SET_FORMAT
suffix:semicolon
id|dr.value
op_assign
(paren
id|subsample
op_lshift
l_int|8
)paren
op_plus
id|size
suffix:semicolon
id|dr.index
op_assign
id|order
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_set_compression
r_int
id|usb_cpia_set_compression
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|compmode
comma
r_int
id|decimation
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_SET_COMPRESSION
suffix:semicolon
id|dr.value
op_assign
(paren
id|decimation
op_lshift
l_int|8
)paren
op_plus
id|compmode
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_initstreamcap
r_int
id|usb_cpia_initstreamcap
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|skipframes
comma
r_int
id|streamstartline
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_INIT_STREAM_CAP
suffix:semicolon
id|dr.value
op_assign
(paren
id|streamstartline
op_lshift
l_int|8
)paren
op_plus
id|skipframes
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_finistreamcap
r_int
id|usb_cpia_finistreamcap
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_FINI_STREAM_CAP
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_startstreamcap
r_int
id|usb_cpia_startstreamcap
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_START_STREAM_CAP
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_endstreamcap
r_int
id|usb_cpia_endstreamcap
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
)paren
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CPIA_END_STREAM_CAP
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|macro|scratch_left
mdefine_line|#define scratch_left(x)&t;(cpia-&gt;scratchlen - (int)((char *)x - (char *)cpia-&gt;scratch))
DECL|function|cpia_parse_data
r_static
r_void
id|cpia_parse_data
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
)paren
(brace
r_int
r_char
op_star
id|data
op_assign
id|cpia-&gt;scratch
suffix:semicolon
r_int
id|done
suffix:semicolon
id|done
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
op_logical_and
id|scratch_left
c_func
(paren
id|data
)paren
)paren
(brace
r_switch
c_cond
(paren
id|cpia-&gt;state
)paren
(brace
r_case
id|STATE_SCANNING
suffix:colon
(brace
r_int
r_char
op_star
id|begin
op_assign
id|data
suffix:semicolon
multiline_comment|/* We need atleast 2 bytes for the magic value */
r_if
c_cond
(paren
id|scratch_left
c_func
(paren
id|data
)paren
OL
l_int|2
)paren
(brace
id|done
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;header: %X&bslash;n&quot;
comma
(paren
op_star
id|data
op_lshift
l_int|8
)paren
op_plus
op_star
(paren
id|data
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|data
op_eq
l_int|0x19
)paren
op_logical_and
(paren
op_star
(paren
id|data
op_plus
l_int|1
)paren
op_eq
l_int|0x68
)paren
)paren
(brace
id|cpia-&gt;state
op_assign
id|STATE_HEADER
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;moving to header&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scratch_left
c_func
(paren
id|data
)paren
OL
l_int|4
)paren
(brace
id|done
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Scanning for end of frame&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|scratch_left
c_func
(paren
id|data
)paren
op_ge
l_int|4
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|data
op_eq
l_int|0xFF
)paren
op_logical_and
(paren
op_star
(paren
id|data
op_plus
l_int|1
)paren
op_eq
l_int|0xFF
)paren
op_logical_and
(paren
op_star
(paren
id|data
op_plus
l_int|2
)paren
op_eq
l_int|0xFF
)paren
op_logical_and
(paren
op_star
(paren
id|data
op_plus
l_int|3
)paren
op_eq
l_int|0xFF
)paren
)paren
(brace
id|data
op_add_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
id|data
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;scan: scanned %d bytes&bslash;n&quot;
comma
id|data
op_minus
id|begin
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|STATE_HEADER
suffix:colon
multiline_comment|/* We need atleast 64 bytes for the header */
r_if
c_cond
(paren
id|scratch_left
c_func
(paren
id|data
)paren
OL
l_int|64
)paren
(brace
id|done
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;header: framerate %d&bslash;n&quot;
comma
id|data
(braket
l_int|41
)braket
)paren
suffix:semicolon
id|data
op_add_assign
l_int|64
suffix:semicolon
id|cpia-&gt;state
op_assign
id|STATE_LINES
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_LINES
suffix:colon
(brace
r_int
r_char
op_star
id|begin
op_assign
id|data
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|scratch_left
c_func
(paren
id|data
)paren
)paren
(brace
r_if
c_cond
(paren
op_star
id|data
op_eq
l_int|0xFD
)paren
(brace
id|data
op_increment
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_star
id|data
op_eq
l_int|0xFF
)paren
op_logical_and
(paren
id|scratch_left
c_func
(paren
id|data
)paren
op_ge
l_int|3
)paren
op_logical_and
(paren
op_star
(paren
id|data
op_plus
l_int|1
)paren
op_eq
l_int|0xFF
)paren
op_logical_and
(paren
op_star
(paren
id|data
op_plus
l_int|2
)paren
op_eq
l_int|0xFF
)paren
op_logical_and
(paren
op_star
(paren
id|data
op_plus
l_int|3
)paren
op_eq
l_int|0xFF
)paren
)paren
(brace
id|data
op_add_assign
l_int|4
suffix:semicolon
id|cpia-&gt;curline
op_assign
l_int|144
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|data
op_increment
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;line %d: scanned %d bytes&bslash;n&quot;
comma
id|cpia-&gt;curline
comma
id|data
op_minus
id|begin
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|data
op_minus
id|begin
op_eq
l_int|355
op_logical_and
id|cpia-&gt;frame
(braket
id|cpia-&gt;curframe
)braket
dot
id|width
op_ne
l_int|64
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|f
op_assign
id|cpia-&gt;frame
(braket
id|cpia-&gt;curframe
)braket
dot
id|data
comma
op_star
id|b
op_assign
id|begin
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;copying&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|b
op_add_assign
l_int|2
suffix:semicolon
id|f
op_add_assign
(paren
id|cpia-&gt;frame
(braket
id|cpia-&gt;curframe
)braket
dot
id|width
op_star
l_int|3
)paren
op_star
id|cpia-&gt;curline
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|176
suffix:semicolon
id|i
op_increment
)paren
id|f
(braket
(paren
id|i
op_star
l_int|3
)paren
op_plus
l_int|0
)braket
op_assign
id|f
(braket
(paren
id|i
op_star
l_int|3
)paren
op_plus
l_int|1
)braket
op_assign
id|f
(braket
(paren
id|i
op_star
l_int|3
)paren
op_plus
l_int|2
)braket
op_assign
id|b
(braket
(paren
id|i
op_star
l_int|2
)paren
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
)paren
(brace
id|cpia-&gt;curline
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cpia-&gt;curline
op_ge
l_int|144
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|cpia-&gt;wq
)paren
suffix:semicolon
id|cpia-&gt;state
op_assign
id|STATE_SCANNING
suffix:semicolon
id|cpia-&gt;curline
op_assign
l_int|0
suffix:semicolon
id|cpia-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|data
op_assign
id|begin
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
(brace
r_int
id|l
suffix:semicolon
id|l
op_assign
id|scratch_left
c_func
(paren
id|data
)paren
suffix:semicolon
id|memmove
c_func
(paren
id|cpia-&gt;scratch
comma
id|data
comma
id|l
)paren
suffix:semicolon
id|cpia-&gt;scratchlen
op_assign
id|l
suffix:semicolon
)brace
)brace
DECL|function|cpia_isoc_irq
r_static
r_int
id|cpia_isoc_irq
c_func
(paren
r_int
id|status
comma
r_void
op_star
id|__buffer
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
id|dev_id
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
op_assign
id|cpia-&gt;dev
suffix:semicolon
r_struct
id|cpia_sbuf
op_star
id|sbuf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;streaming
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;oops, not streaming, but interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpia-&gt;curframe
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cpia-&gt;frame
(braket
l_int|0
)braket
dot
id|state
op_eq
id|FRAME_READY
)paren
(brace
id|cpia-&gt;curframe
op_assign
l_int|0
suffix:semicolon
id|cpia-&gt;frame
(braket
l_int|0
)braket
dot
id|state
op_assign
id|FRAME_GRABBING
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;capturing to frame 0&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cpia-&gt;frame
(braket
l_int|1
)braket
dot
id|state
op_eq
id|FRAME_READY
)paren
(brace
id|cpia-&gt;curframe
op_assign
l_int|1
suffix:semicolon
id|cpia-&gt;frame
(braket
l_int|1
)braket
dot
id|state
op_assign
id|FRAME_GRABBING
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;capturing to frame 1&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;no frame available&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|sbuf
op_assign
op_amp
id|cpia-&gt;sbuf
(braket
id|cpia-&gt;receivesbuf
)braket
suffix:semicolon
id|uhci_unsched_isochronous
c_func
(paren
id|dev
comma
id|sbuf-&gt;isodesc
)paren
suffix:semicolon
multiline_comment|/* Do something to it now */
id|sbuf-&gt;len
op_assign
id|uhci_compress_isochronous
c_func
(paren
id|dev
comma
id|sbuf-&gt;isodesc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbuf-&gt;len
)paren
id|printk
c_func
(paren
l_string|&quot;%d bytes received&bslash;n&quot;
comma
id|sbuf-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbuf-&gt;len
op_logical_and
id|cpia-&gt;curframe
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|sbuf-&gt;len
OG
(paren
id|SCRATCH_BUF_SIZE
op_minus
id|cpia-&gt;scratchlen
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;overflow!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|cpia-&gt;scratch
op_plus
id|cpia-&gt;scratchlen
comma
id|sbuf-&gt;data
comma
id|sbuf-&gt;len
)paren
suffix:semicolon
id|cpia-&gt;scratchlen
op_add_assign
id|sbuf-&gt;len
suffix:semicolon
id|cpia_parse_data
c_func
(paren
id|cpia
)paren
suffix:semicolon
)brace
multiline_comment|/* Reschedule this block of Isochronous desc */
id|uhci_sched_isochronous
c_func
(paren
id|dev
comma
id|sbuf-&gt;isodesc
comma
id|cpia-&gt;sbuf
(braket
(paren
id|cpia-&gt;receivesbuf
op_plus
l_int|2
)paren
op_mod
l_int|3
)braket
dot
id|isodesc
)paren
suffix:semicolon
multiline_comment|/* Move to the next one */
id|cpia-&gt;receivesbuf
op_assign
(paren
id|cpia-&gt;receivesbuf
op_plus
l_int|1
)paren
op_mod
l_int|3
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|cpia_init_isoc
r_int
id|cpia_init_isoc
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|cpia-&gt;dev
suffix:semicolon
id|cpia-&gt;receivesbuf
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|cpia-&gt;parsesbuf
op_assign
l_int|0
suffix:semicolon
id|cpia-&gt;parsepos
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|cpia-&gt;scratchlen
op_assign
l_int|0
suffix:semicolon
id|cpia-&gt;curline
op_assign
l_int|0
suffix:semicolon
id|cpia-&gt;state
op_assign
id|STATE_SCANNING
suffix:semicolon
multiline_comment|/* Allocate all of the memory necessary */
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
op_assign
id|uhci_alloc_isochronous
c_func
(paren
id|dev
comma
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
l_int|1
)paren
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
comma
id|STREAM_BUF_SIZE
comma
l_int|960
comma
id|cpia_isoc_irq
comma
id|cpia
)paren
suffix:semicolon
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
op_assign
id|uhci_alloc_isochronous
c_func
(paren
id|dev
comma
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
l_int|1
)paren
comma
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
comma
id|STREAM_BUF_SIZE
comma
l_int|960
comma
id|cpia_isoc_irq
comma
id|cpia
)paren
suffix:semicolon
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|isodesc
op_assign
id|uhci_alloc_isochronous
c_func
(paren
id|dev
comma
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
l_int|1
)paren
comma
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|data
comma
id|STREAM_BUF_SIZE
comma
l_int|960
comma
id|cpia_isoc_irq
comma
id|cpia
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;isodesc[0] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;isodesc[1] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;isodesc[2] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|isodesc
)paren
suffix:semicolon
multiline_comment|/* Schedule the queues */
id|uhci_sched_isochronous
c_func
(paren
id|dev
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
comma
l_int|NULL
)paren
suffix:semicolon
id|uhci_sched_isochronous
c_func
(paren
id|dev
comma
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|uhci_sched_isochronous
c_func
(paren
id|dev
comma
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|isodesc
comma
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|cpia-&gt;dev
comma
l_int|1
comma
l_int|3
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_set_interface error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|usb_cpia_startstreamcap
c_func
(paren
id|cpia-&gt;dev
)paren
suffix:semicolon
id|cpia-&gt;streaming
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_stop_isoc
r_void
id|cpia_stop_isoc
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|cpia-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;streaming
)paren
r_return
suffix:semicolon
id|cpia-&gt;streaming
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Stop the streaming */
id|usb_cpia_endstreamcap
c_func
(paren
id|cpia-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* Set packet size to 0 */
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|cpia-&gt;dev
comma
l_int|1
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_set_interface error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Unschedule all of the iso td&squot;s */
id|uhci_unsched_isochronous
c_func
(paren
id|dev
comma
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|uhci_unsched_isochronous
c_func
(paren
id|dev
comma
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|uhci_unsched_isochronous
c_func
(paren
id|dev
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
multiline_comment|/* Delete them all */
id|uhci_delete_isochronous
c_func
(paren
id|dev
comma
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|uhci_delete_isochronous
c_func
(paren
id|dev
comma
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|uhci_delete_isochronous
c_func
(paren
id|dev
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
)brace
multiline_comment|/* Video 4 Linux API */
DECL|function|cpia_open
r_static
r_int
id|cpia_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cpia_open&bslash;n&quot;
)paren
suffix:semicolon
id|cpia-&gt;fbuf
op_assign
id|rvmalloc
c_func
(paren
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;fbuf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|cpia-&gt;frame
(braket
l_int|0
)braket
dot
id|state
op_assign
id|FRAME_DONE
suffix:semicolon
id|cpia-&gt;frame
(braket
l_int|1
)braket
dot
id|state
op_assign
id|FRAME_DONE
suffix:semicolon
id|cpia-&gt;frame
(braket
l_int|0
)braket
dot
id|data
op_assign
id|cpia-&gt;fbuf
suffix:semicolon
id|cpia-&gt;frame
(braket
l_int|1
)braket
dot
id|data
op_assign
id|cpia-&gt;fbuf
op_plus
id|MAX_FRAME_SIZE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;frame [0] @ %p&bslash;n&quot;
comma
id|cpia-&gt;frame
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;frame [1] @ %p&bslash;n&quot;
comma
id|cpia-&gt;frame
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
op_assign
id|kmalloc
c_func
(paren
id|STREAM_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
op_assign
id|kmalloc
c_func
(paren
id|STREAM_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|data
op_assign
id|kmalloc
c_func
(paren
id|STREAM_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sbuf[0] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sbuf[1] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sbuf[2] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|data
)paren
suffix:semicolon
id|cpia-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
id|cpia-&gt;receivesbuf
op_assign
l_int|0
suffix:semicolon
id|usb_cpia_initstreamcap
c_func
(paren
id|cpia-&gt;dev
comma
l_int|0
comma
l_int|60
)paren
suffix:semicolon
id|cpia_init_isoc
c_func
(paren
id|cpia
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_close
r_static
r_void
id|cpia_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cpia_close&bslash;n&quot;
)paren
suffix:semicolon
id|cpia_stop_isoc
c_func
(paren
id|cpia
)paren
suffix:semicolon
id|usb_cpia_finistreamcap
c_func
(paren
id|cpia-&gt;dev
)paren
suffix:semicolon
id|rvfree
c_func
(paren
id|cpia-&gt;fbuf
comma
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|2
)braket
dot
id|data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
)brace
DECL|function|cpia_init_done
r_static
r_int
id|cpia_init_done
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_write
r_static
r_int
id|cpia_write
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|3
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_set_interface error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_cpia_grab_frame
c_func
(paren
id|dev
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_grab_frame error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_cpia_upload_frame
c_func
(paren
id|dev
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_upload_frame error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf
op_assign
id|cpia-&gt;ibuf
suffix:semicolon
id|uhci_receive_isochronous
c_func
(paren
id|dev
comma
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
l_int|1
)paren
comma
id|buf
comma
l_int|176
op_star
l_int|144
op_star
l_int|4
)paren
suffix:semicolon
(brace
id|printk
c_func
(paren
l_string|&quot;header magic: %X&bslash;n&quot;
comma
(paren
id|buf
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|buf
(braket
l_int|0
)braket
op_ne
l_int|0x19
)paren
op_logical_or
(paren
id|buf
(braket
l_int|1
)braket
op_ne
l_int|0x68
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;resync&squot;ing&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
l_int|176
op_star
l_int|144
op_star
l_int|4
)paren
op_minus
l_int|4
suffix:semicolon
id|i
op_increment
comma
id|buf
op_increment
)paren
r_if
c_cond
(paren
(paren
id|buf
(braket
l_int|0
)braket
op_eq
l_int|0xFF
)paren
op_logical_and
(paren
id|buf
(braket
l_int|1
)braket
op_eq
l_int|0xFF
)paren
op_logical_and
(paren
id|buf
(braket
l_int|2
)braket
op_eq
l_int|0xFF
)paren
op_logical_and
(paren
id|buf
(braket
l_int|3
)braket
op_eq
l_int|0xFF
)paren
)paren
(brace
id|buf
op_add_assign
l_int|4
suffix:semicolon
id|i
op_add_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memmove
c_func
(paren
id|cpia-&gt;ibuf
comma
id|buf
comma
(paren
l_int|176
op_star
l_int|144
op_star
l_int|4
)paren
op_minus
id|i
)paren
suffix:semicolon
id|uhci_receive_isochronous
c_func
(paren
id|dev
comma
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
l_int|1
)paren
comma
id|cpia-&gt;ibuf
op_plus
(paren
l_int|176
op_star
l_int|144
op_star
l_int|4
)paren
op_minus
id|i
comma
id|i
)paren
suffix:semicolon
id|buf
op_assign
id|cpia-&gt;ibuf
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;header magic: %X&bslash;n&quot;
comma
(paren
id|buf
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_plus
id|buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
id|printk
c_func
(paren
l_string|&quot;size: %d, sample: %d, order: %d&bslash;n&quot;
comma
id|buf
(braket
l_int|16
)braket
comma
id|buf
(braket
l_int|17
)braket
comma
id|buf
(braket
l_int|18
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;comp: %d, decimation: %d&bslash;n&quot;
comma
id|buf
(braket
l_int|28
)braket
comma
id|buf
(braket
l_int|29
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;roi: top left: %d, %d bottom right: %d, %d&bslash;n&quot;
comma
id|buf
(braket
l_int|26
)braket
op_star
l_int|4
comma
id|buf
(braket
l_int|24
)braket
op_star
l_int|8
comma
id|buf
(braket
l_int|27
)braket
op_star
l_int|4
comma
id|buf
(braket
l_int|25
)braket
op_star
l_int|8
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;vm-&gt;frame: %d&bslash;n&quot;
comma
id|vm-&gt;frame
)paren
suffix:semicolon
(brace
r_int
id|i
comma
id|i1
suffix:semicolon
r_char
op_star
id|b
op_assign
id|buf
op_plus
l_int|64
comma
op_star
id|fbuf
op_assign
op_amp
id|cpia-&gt;fbuffer
(braket
id|MAX_FRAME_SIZE
op_star
(paren
id|vm-&gt;frame
op_amp
l_int|1
)paren
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|144
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;line len: %d&bslash;n&quot;
comma
(paren
id|b
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|b
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
id|b
op_add_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|i1
op_assign
l_int|0
suffix:semicolon
id|i1
OL
l_int|176
suffix:semicolon
id|i1
op_increment
)paren
(brace
id|fbuf
(braket
(paren
id|i
op_star
id|vm-&gt;width
op_star
l_int|3
)paren
op_plus
(paren
id|i1
op_star
l_int|3
)paren
)braket
op_assign
id|fbuf
(braket
(paren
id|i
op_star
id|vm-&gt;width
op_star
l_int|3
)paren
op_plus
(paren
id|i1
op_star
l_int|3
)paren
op_plus
l_int|1
)braket
op_assign
id|fbuf
(braket
(paren
id|i
op_star
id|vm-&gt;width
op_star
l_int|3
)paren
op_plus
(paren
id|i1
op_star
l_int|3
)paren
op_plus
l_int|2
)braket
op_assign
id|b
(braket
id|i1
op_star
l_int|2
)braket
suffix:semicolon
macro_line|#if 0
op_star
(paren
(paren
r_int
op_star
)paren
op_amp
id|fbuf
(braket
(paren
id|i
op_star
id|vm-&gt;width
op_star
l_int|2
)paren
op_plus
(paren
id|i1
op_star
l_int|2
)paren
)braket
)paren
op_assign
(paren
(paren
id|b
(braket
id|i1
op_star
l_int|2
)braket
op_rshift
l_int|3
)paren
op_lshift
l_int|11
)paren
op_plus
(paren
(paren
id|b
(braket
id|i1
op_star
l_int|2
)braket
op_rshift
l_int|2
)paren
op_lshift
l_int|6
)paren
op_plus
(paren
id|b
(braket
id|i1
op_star
l_int|2
)braket
op_rshift
l_int|3
)paren
suffix:semicolon
macro_line|#endif
)brace
id|b
op_add_assign
(paren
l_int|176
op_star
l_int|2
)paren
op_plus
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_set_interface error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
DECL|function|cpia_ioctl
r_static
r_int
id|cpia_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|strcpy
c_func
(paren
id|b.name
comma
l_string|&quot;CPiA USB Camera&quot;
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
multiline_comment|/* | VID_TYPE_SUBCAPTURE */
suffix:semicolon
id|b.channels
op_assign
l_int|1
suffix:semicolon
id|b.audios
op_assign
l_int|0
suffix:semicolon
id|b.maxwidth
op_assign
l_int|176
multiline_comment|/* 352 */
suffix:semicolon
id|b.maxheight
op_assign
l_int|144
multiline_comment|/* 240 */
suffix:semicolon
id|b.minwidth
op_assign
l_int|176
multiline_comment|/* (Something small?) */
suffix:semicolon
id|b.minheight
op_assign
l_int|144
multiline_comment|/* &quot;         &quot; */
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v.channel
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Camera&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v.tuner
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Format&quot;
)paren
suffix:semicolon
id|v.rangelow
op_assign
l_int|0
suffix:semicolon
id|v.rangehigh
op_assign
l_int|0
suffix:semicolon
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.mode
op_assign
id|VIDEO_MODE_AUTO
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v.tuner
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|v.mode
op_ne
id|VIDEO_MODE_AUTO
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
id|p.colour
op_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* Damn British people :) */
id|p.hue
op_assign
l_int|0x8000
suffix:semicolon
id|p.brightness
op_assign
l_int|180
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* XXX */
id|p.contrast
op_assign
l_int|192
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* XXX */
id|p.whiteness
op_assign
l_int|105
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* XXX */
macro_line|#if 0
id|p.depth
op_assign
l_int|24
suffix:semicolon
macro_line|#endif
id|p.depth
op_assign
l_int|16
suffix:semicolon
id|p.palette
op_assign
id|VIDEO_PALETTE_YUYV
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Attempting to set palette %d, depth %d&bslash;n&quot;
comma
id|p.palette
comma
id|p.depth
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|p.palette
op_ne
id|VIDEO_PALETTE_YUYV
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|p.depth
op_ne
l_int|16
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VIDIOCSWIN&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|vw.flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.clipcount
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.height
op_ne
l_int|176
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.width
op_ne
l_int|144
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;VIDIOCGWIN&bslash;n&quot;
)paren
suffix:semicolon
id|vw.x
op_assign
l_int|0
suffix:semicolon
id|vw.y
op_assign
l_int|0
suffix:semicolon
id|vw.width
op_assign
l_int|176
suffix:semicolon
id|vw.height
op_assign
l_int|144
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
id|vm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vm
comma
l_int|0
comma
r_sizeof
(paren
id|vm
)paren
)paren
suffix:semicolon
id|vm.size
op_assign
id|MAX_FRAME_SIZE
op_star
l_int|2
suffix:semicolon
id|vm.frames
op_assign
l_int|2
suffix:semicolon
id|vm.offsets
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|vm.offsets
(braket
l_int|1
)braket
op_assign
id|MAX_FRAME_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MCAPTURE&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;frame: %d, size: %dx%d, format: %d&bslash;n&quot;
comma
id|vm.frame
comma
id|vm.width
comma
id|vm.height
comma
id|vm.format
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vm.format
op_ne
id|VIDEO_PALETTE_RGB24
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vm.frame
op_ne
l_int|0
)paren
op_logical_and
(paren
id|vm.frame
op_ne
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|cpia-&gt;frame
(braket
id|vm.frame
)braket
dot
id|width
op_assign
id|vm.width
suffix:semicolon
id|cpia-&gt;frame
(braket
id|vm.frame
)braket
dot
id|height
op_assign
id|vm.height
suffix:semicolon
multiline_comment|/* Mark it as free */
id|cpia-&gt;frame
(braket
id|vm.frame
)braket
dot
id|state
op_assign
id|FRAME_READY
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
id|frame
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|frame
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;syncing to frame %d&bslash;n&quot;
comma
id|frame
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cpia-&gt;frame
(braket
id|frame
)braket
dot
id|state
)paren
(brace
r_case
id|FRAME_UNUSED
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|FRAME_READY
suffix:colon
r_case
id|FRAME_GRABBING
suffix:colon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|cpia-&gt;wq
)paren
suffix:semicolon
r_case
id|FRAME_DONE
suffix:colon
id|cpia-&gt;frame
(braket
id|frame
)braket
dot
id|state
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;synced to frame %d&bslash;n&quot;
comma
id|frame
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCCAPTURE
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGFBUF
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCSFBUF
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCKEY
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|VIDIOCGFREQ
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCSFREQ
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCSAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_read
r_static
r_int
id|cpia_read
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
r_int
id|len
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cpia_read: %d bytes&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
macro_line|#if 0
id|len
op_assign
id|cpia_capture
c_func
(paren
id|cpia
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_mmap
r_static
r_int
id|cpia_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mmap: %d (%X) bytes&bslash;n&quot;
comma
id|size
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
(paren
(paren
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;fbuffer
)paren
(brace
r_if
c_cond
(paren
(paren
id|cpia-&gt;fbuffer
op_assign
id|rvmalloc
c_func
(paren
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
id|pos
op_assign
(paren
r_int
r_int
)paren
id|cpia-&gt;fbuf
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_phys
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|cpia_template
r_static
r_struct
id|video_device
id|cpia_template
op_assign
(brace
l_string|&quot;CPiA USB Camera&quot;
comma
id|VID_TYPE_CAPTURE
comma
id|VID_HARDWARE_CPIA
comma
id|cpia_open
comma
id|cpia_close
comma
id|cpia_read
comma
id|cpia_write
comma
l_int|NULL
comma
id|cpia_ioctl
comma
id|cpia_mmap
comma
id|cpia_init_done
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|function|usb_cpia_configure
r_static
r_void
id|usb_cpia_configure
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|cpia-&gt;dev
suffix:semicolon
r_int
r_char
id|version
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_char
id|pnpid
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_char
id|camerastat
(braket
l_int|8
)braket
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
id|usb_set_configuration
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|bConfigurationValue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_cpia_get_version
c_func
(paren
id|dev
comma
id|version
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_get_version error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;cpia: Firmware v%d.%d, VC Hardware v%d.%d&bslash;n&quot;
comma
id|version
(braket
l_int|0
)braket
comma
id|version
(braket
l_int|1
)braket
comma
id|version
(braket
l_int|2
)braket
comma
id|version
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_cpia_get_pnp_id
c_func
(paren
id|dev
comma
id|pnpid
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_get_pnp_id error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;cpia: PnP Id: Vendor: %X, Product: %X, Revision: %X&bslash;n&quot;
comma
(paren
id|pnpid
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_plus
id|pnpid
(braket
l_int|0
)braket
comma
(paren
id|pnpid
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_plus
id|pnpid
(braket
l_int|2
)braket
comma
(paren
id|pnpid
(braket
l_int|5
)braket
op_lshift
l_int|8
)paren
op_plus
id|pnpid
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|cpia-&gt;vdev
comma
op_amp
id|cpia_template
comma
r_sizeof
(paren
id|cpia_template
)paren
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cpia-&gt;wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|cpia-&gt;vdev
comma
id|VFL_TYPE_GRABBER
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;video_register_device failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_cpia_goto_hi_power
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_goto_hi_power error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_cpia_get_vp_version
c_func
(paren
id|dev
comma
id|version
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_get_vp_version error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;cpia: VP v%d rev %d&bslash;n&quot;
comma
id|version
(braket
l_int|0
)braket
comma
id|version
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cpia: Camera Head ID %04X&bslash;n&quot;
comma
(paren
id|version
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_plus
id|version
(braket
l_int|2
)braket
)paren
suffix:semicolon
multiline_comment|/* Turn off continuous grab */
r_if
c_cond
(paren
id|usb_cpia_set_grab_mode
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_set_grab_mode error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Set up the sensor to be 30fps */
r_if
c_cond
(paren
id|usb_cpia_set_sensor_fps
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_set_sensor_fps error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Set video into QCIF mode, and order into YUYV mode */
r_if
c_cond
(paren
id|usb_cpia_set_format
c_func
(paren
id|dev
comma
id|CPIA_QCIF
comma
l_int|1
comma
id|CPIA_YUYV
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_set_format error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Turn off compression */
r_if
c_cond
(paren
id|usb_cpia_set_compression
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_set_compression error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|usb_cpia_grab_frame
c_func
(paren
id|dev
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_grab_frame error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_cpia_upload_frame
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cpia_upload_frame error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|buf
op_assign
(paren
r_void
op_star
)paren
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|448
suffix:semicolon
id|i
op_increment
)paren
id|buf
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|uhci_receive_isochronous
c_func
(paren
id|dev
comma
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
l_int|1
)paren
comma
id|buf
comma
l_int|448
)paren
suffix:semicolon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|448
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|16
)paren
op_eq
l_int|15
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|buf
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|cpia_probe
r_static
r_int
id|cpia_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
suffix:semicolon
r_struct
id|usb_cpia
op_star
id|cpia
suffix:semicolon
multiline_comment|/* We don&squot;t handle multi-config cameras */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#if 0
multiline_comment|/* We don&squot;t handle multi-interface hubs */
r_if
c_cond
(paren
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|bNumInterfaces
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
id|interface
op_assign
op_amp
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Is it a CPiA? */
multiline_comment|/*&n;Apr 24 17:49:04 bjorn kernel:   Vendor:  0545 &n;Apr 24 17:49:04 bjorn kernel:   Product: 8080 &n;*/
multiline_comment|/*&n;&t;if (dev-&gt;descriptor.idVendor != 0x0545)&n;&t;&t;return -1;&n;&t;if (dev-&gt;descriptor.idProduct != 0x8080)&n;&t;&t;return -1;&n;&t;if (interface-&gt;bInterfaceClass != 0xFF)&n;&t;&t;return -1;&n;&t;if (interface-&gt;bInterfaceSubClass != 0xFF)&n;&t;&t;return -1;&n;*/
r_if
c_cond
(paren
id|dev-&gt;descriptor.idVendor
op_ne
l_int|0x0553
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;descriptor.idProduct
op_ne
l_int|0x0002
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|0xFF
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|0x00
)paren
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Multiple endpoints? What kind of mutant ninja-hub is this? */
r_if
c_cond
(paren
id|interface-&gt;bNumEndpoints
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Output endpoint? Curiousier and curiousier.. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
l_int|0x80
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* If it&squot;s not an interrupt endpoint, we&squot;d better punt! */
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bmAttributes
op_amp
l_int|3
)paren
op_ne
l_int|3
)paren
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* We found a CPiA */
id|printk
c_func
(paren
l_string|&quot;USB CPiA camera found&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpia
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|cpia
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;couldn&squot;t kmalloc cpia struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cpia
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cpia
)paren
)paren
suffix:semicolon
id|dev
op_member_access_from_pointer
r_private
op_assign
id|cpia
suffix:semicolon
id|cpia-&gt;dev
op_assign
id|dev
suffix:semicolon
id|usb_cpia_configure
c_func
(paren
id|cpia
)paren
suffix:semicolon
macro_line|#if 0
id|usb_request_irq
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
id|endpoint-&gt;bEndpointAddress
)paren
comma
id|pport_irq
comma
id|endpoint-&gt;bInterval
comma
id|pport
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_disconnect
r_static
r_void
id|cpia_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|cpia-&gt;vdev
)paren
suffix:semicolon
multiline_comment|/* Free the memory */
id|kfree
c_func
(paren
id|cpia
)paren
suffix:semicolon
)brace
DECL|variable|cpia_driver
r_static
r_struct
id|usb_driver
id|cpia_driver
op_assign
(brace
l_string|&quot;cpia&quot;
comma
id|cpia_probe
comma
id|cpia_disconnect
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * This should be a separate module.&n; */
DECL|function|usb_cpia_init
r_int
id|usb_cpia_init
c_func
(paren
r_void
)paren
(brace
id|usb_register
c_func
(paren
op_amp
id|cpia_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_cpia_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|module_cleanup
r_void
id|module_cleanup
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
eof
