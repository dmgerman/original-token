multiline_comment|/*&n; * USB CPiA Video Camera driver&n; *&n; * Supports CPiA based Video Cameras. Many manufacturers use this chipset.&n; * There&squot;s a good chance, if you have a USB video camera, it&squot;s a CPiA based&n; * one.&n; *&n; * (C) Copyright 1999 Johannes Erdfelt&n; * (C) Copyright 1999 Randy Dunlap&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;cpia.h&quot;
DECL|macro|CPIA_DEBUG
mdefine_line|#define CPIA_DEBUG&t;/* Gobs of debugging info */
multiline_comment|/* Video Size 384 x 288 x 3 bytes for RGB */
DECL|macro|MAX_FRAME_SIZE
mdefine_line|#define MAX_FRAME_SIZE (384 * 288 * 3)
multiline_comment|/*******************************/
multiline_comment|/* Memory management functions */
multiline_comment|/*******************************/
DECL|macro|MDEBUG
mdefine_line|#define MDEBUG(x)&t;do { } while(0)&t;&t;/* Debug memory management */
multiline_comment|/* Given PGD from the address space&squot;s page table, return the kernel&n; * virtual mapping of the physical memory mapped at ADR.&n; */
DECL|function|uvirt_to_kva
r_static
r_inline
r_int
r_int
id|uvirt_to_kva
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|ret
op_assign
l_int|0UL
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|adr
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
id|ret
op_assign
(paren
id|pte_page
c_func
(paren
id|pte
)paren
op_or
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;uv2kva(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|uvirt_to_bus
r_static
r_inline
r_int
r_int
id|uvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|kva
comma
id|ret
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|adr
)paren
comma
id|adr
)paren
suffix:semicolon
id|ret
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|kva
)paren
suffix:semicolon
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;uv2b(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|kvirt_to_bus
r_static
r_inline
r_int
r_int
id|kvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|kva
)paren
suffix:semicolon
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;kv2b(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Here we want the physical address of the memory.&n; * This is used when initializing the contents of the&n; * area and marking the pages as reserved.&n; */
DECL|function|kvirt_to_pa
r_static
r_inline
r_int
r_int
id|kvirt_to_pa
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|__pa
c_func
(paren
id|kva
)paren
suffix:semicolon
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;kv2pa(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
multiline_comment|/* Round it off to PAGE_SIZE */
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|mem
op_assign
id|vmalloc
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|MAP_NR
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
suffix:semicolon
id|size
op_add_assign
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|size
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|MAP_NR
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_get_version
r_static
r_int
id|usb_cpia_get_version
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|buf
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_GET_VERSION
comma
id|USB_DIR_IN
op_or
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|4
comma
id|HZ
)paren
suffix:semicolon
)brace
macro_line|#ifdef NOTUSED
DECL|function|usb_cpia_get_pnp_id
r_static
r_int
id|usb_cpia_get_pnp_id
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|buf
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_GET_PNP_ID
comma
id|USB_DIR_IN
op_or
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|6
comma
id|HZ
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef NOTUSED
DECL|function|usb_cpia_get_camera_status
r_static
r_int
id|usb_cpia_get_camera_status
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|buf
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_GET_CAMERA_STATUS
comma
id|USB_DIR_IN
op_or
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|8
comma
id|HZ
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|usb_cpia_goto_hi_power
r_static
r_int
id|usb_cpia_goto_hi_power
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_GOTO_HI_POWER
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_get_vp_version
r_static
r_int
id|usb_cpia_get_vp_version
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|buf
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_GET_VP_VERSION
comma
id|USB_DIR_IN
op_or
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|4
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_set_sensor_fps
r_static
r_int
id|usb_cpia_set_sensor_fps
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|sensorbaserate
comma
r_int
id|sensorclkdivisor
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_SET_SENSOR_FPS
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
(paren
id|sensorbaserate
op_lshift
l_int|8
)paren
op_plus
id|sensorclkdivisor
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_grab_frame
r_static
r_int
id|usb_cpia_grab_frame
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|streamstartline
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_GRAB_FRAME
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
id|streamstartline
op_lshift
l_int|8
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_upload_frame
r_static
r_int
id|usb_cpia_upload_frame
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|forceupload
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_UPLOAD_FRAME
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
id|forceupload
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_set_grab_mode
r_static
r_int
id|usb_cpia_set_grab_mode
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|continuousgrab
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_SET_GRAB_MODE
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
id|continuousgrab
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_set_format
r_static
r_int
id|usb_cpia_set_format
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|size
comma
r_int
id|subsample
comma
r_int
id|order
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_SET_FORMAT
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
(paren
id|subsample
op_lshift
l_int|8
)paren
op_plus
id|size
comma
id|order
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_set_roi
r_static
r_int
id|usb_cpia_set_roi
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|colstart
comma
r_int
id|colend
comma
r_int
id|rowstart
comma
r_int
id|rowend
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_SET_ROI
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
(paren
id|colend
op_lshift
l_int|8
)paren
op_plus
id|colstart
comma
(paren
id|rowend
op_lshift
l_int|8
)paren
op_plus
id|rowstart
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_set_compression
r_static
r_int
id|usb_cpia_set_compression
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|compmode
comma
r_int
id|decimation
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_SET_COMPRESSION
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
(paren
id|decimation
op_lshift
l_int|8
)paren
op_plus
id|compmode
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
macro_line|#ifdef NOTUSED
DECL|function|usb_cpia_initstreamcap
r_static
r_int
id|usb_cpia_initstreamcap
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|skipframes
comma
r_int
id|streamstartline
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_INIT_STREAM_CAP
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
(paren
id|streamstartline
op_lshift
l_int|8
)paren
op_plus
id|skipframes
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_finistreamcap
r_static
r_int
id|usb_cpia_finistreamcap
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_FINI_STREAM_CAP
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_startstreamcap
r_static
r_int
id|usb_cpia_startstreamcap
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_START_STREAM_CAP
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|usb_cpia_endstreamcap
r_static
r_int
id|usb_cpia_endstreamcap
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|USB_REQ_CPIA_END_STREAM_CAP
comma
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
id|HZ
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* How much data is left in the scratch buf? */
DECL|macro|scratch_left
mdefine_line|#define scratch_left(x)&t;(cpia-&gt;scratchlen - (int)((char *)x - (char *)cpia-&gt;scratch))
DECL|function|cpia_parse_data
r_static
r_void
id|cpia_parse_data
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
)paren
(brace
r_struct
id|cpia_frame
op_star
id|frame
comma
op_star
id|pframe
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|cpia-&gt;scratch
suffix:semicolon
r_int
r_int
id|l
suffix:semicolon
id|frame
op_assign
op_amp
id|cpia-&gt;frame
(braket
id|cpia-&gt;curframe
)braket
suffix:semicolon
id|pframe
op_assign
op_amp
id|cpia-&gt;frame
(braket
(paren
id|cpia-&gt;curframe
op_minus
l_int|1
op_plus
id|CPIA_NUMFRAMES
)paren
op_mod
id|CPIA_NUMFRAMES
)braket
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|scratch_left
c_func
(paren
id|data
)paren
)paren
r_goto
id|out
suffix:semicolon
r_switch
c_cond
(paren
id|frame-&gt;scanstate
)paren
(brace
r_case
id|STATE_SCANNING
suffix:colon
(brace
r_struct
id|cpia_frame_header
op_star
id|header
suffix:semicolon
multiline_comment|/* We need atleast 2 bytes for the magic value */
r_if
c_cond
(paren
id|scratch_left
c_func
(paren
id|data
)paren
OL
l_int|2
)paren
r_goto
id|out
suffix:semicolon
id|header
op_assign
(paren
r_struct
id|cpia_frame_header
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|be16_to_cpup
c_func
(paren
op_amp
id|header-&gt;magic
)paren
op_eq
id|CPIA_MAGIC
)paren
(brace
id|frame-&gt;scanstate
op_assign
id|STATE_HEADER
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Woops, lost the header, find the end of the frame */
r_if
c_cond
(paren
id|scratch_left
c_func
(paren
id|data
)paren
OL
l_int|4
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* See if we found the end of the frame */
r_while
c_loop
(paren
id|scratch_left
c_func
(paren
id|data
)paren
op_ge
l_int|4
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
(paren
id|__u32
op_star
)paren
id|data
)paren
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;found end of frame&bslash;n&quot;
)paren
suffix:semicolon
id|data
op_add_assign
l_int|4
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|data
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|STATE_HEADER
suffix:colon
multiline_comment|/* We need atleast 64 bytes for the header */
r_if
c_cond
(paren
id|scratch_left
c_func
(paren
id|data
)paren
OL
r_sizeof
(paren
r_struct
id|cpia_frame_header
)paren
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|frame-&gt;header
comma
id|data
comma
r_sizeof
(paren
r_struct
id|cpia_frame_header
)paren
)paren
suffix:semicolon
multiline_comment|/* Skip over the header */
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|cpia_frame_header
)paren
suffix:semicolon
id|frame-&gt;hdrwidth
op_assign
(paren
id|frame-&gt;header.col_end
op_minus
id|frame-&gt;header.col_start
)paren
op_star
l_int|8
suffix:semicolon
id|frame-&gt;hdrheight
op_assign
(paren
id|frame-&gt;header.row_end
op_minus
id|frame-&gt;header.row_start
)paren
op_star
l_int|4
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;cpia: frame size %dx%d&bslash;n&quot;
comma
id|frame-&gt;hdrwidth
comma
id|frame-&gt;hdrheight
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cpia: frame %scompressed&bslash;n&quot;
comma
id|frame-&gt;header.comp_enable
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;not &quot;
)paren
suffix:semicolon
macro_line|#endif
id|frame-&gt;scanstate
op_assign
id|STATE_LINES
suffix:semicolon
id|frame-&gt;curline
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_LINES
suffix:colon
(brace
r_int
r_char
op_star
id|f
comma
op_star
id|end
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|y
comma
id|u
comma
id|y1
comma
id|v
comma
id|r
comma
id|g
comma
id|b
suffix:semicolon
multiline_comment|/* We want atleast 2 bytes for the length */
r_if
c_cond
(paren
id|scratch_left
c_func
(paren
id|data
)paren
OL
l_int|2
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Grab the length */
id|len
op_assign
id|data
(braket
l_int|0
)braket
op_plus
(paren
id|data
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;line %d, %d bytes long&bslash;n&quot;
comma
id|frame-&gt;curline
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Check to make sure it&squot;s nothing outrageous */
r_if
c_cond
(paren
id|len
OG
(paren
id|frame-&gt;hdrwidth
op_star
l_int|2
)paren
op_plus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia: bad length, resynching&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Make sure there&squot;s enough data for the entire line */
r_if
c_cond
(paren
id|scratch_left
c_func
(paren
id|data
op_plus
l_int|2
)paren
OL
id|len
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Skip over the length */
id|data
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* Is the end of the line there */
r_if
c_cond
(paren
id|data
(braket
id|len
op_minus
l_int|1
)braket
op_ne
l_int|0xFD
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia: lost synch&bslash;n&quot;
)paren
suffix:semicolon
id|end
op_assign
id|data
op_plus
id|len
op_minus
l_int|1
op_minus
l_int|4
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02X %02X %02X %02X %02X %02X %02X %02X&bslash;n&quot;
comma
id|end
(braket
l_int|0
)braket
comma
id|end
(braket
l_int|1
)braket
comma
id|end
(braket
l_int|2
)braket
comma
id|end
(braket
l_int|3
)braket
comma
id|end
(braket
l_int|4
)braket
comma
id|end
(braket
l_int|5
)braket
comma
id|end
(braket
l_int|6
)braket
comma
id|end
(braket
l_int|7
)braket
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Start at the beginning */
id|end
op_assign
id|data
op_plus
id|len
op_minus
l_int|1
suffix:semicolon
id|f
op_assign
id|frame-&gt;data
op_plus
(paren
id|frame-&gt;width
op_star
l_int|3
op_star
id|frame-&gt;curline
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frame-&gt;header.comp_enable
)paren
(brace
r_int
r_char
op_star
id|fp
suffix:semicolon
multiline_comment|/* We use the previous frame as a reference */
id|fp
op_assign
id|pframe-&gt;data
op_plus
(paren
id|frame-&gt;width
op_star
l_int|3
op_star
id|frame-&gt;curline
)paren
suffix:semicolon
r_while
c_loop
(paren
id|data
OL
id|end
)paren
(brace
r_if
c_cond
(paren
op_star
id|data
op_amp
l_int|1
)paren
(brace
multiline_comment|/* Compress RLE data */
id|i
op_assign
op_star
id|data
op_rshift
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|f
comma
id|fp
comma
id|i
op_star
l_int|3
)paren
suffix:semicolon
id|f
op_add_assign
(paren
id|i
op_star
l_int|3
)paren
suffix:semicolon
id|fp
op_add_assign
(paren
id|i
op_star
l_int|3
)paren
suffix:semicolon
id|data
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Raw data */
DECL|macro|LIMIT
mdefine_line|#define LIMIT(x) ((((x)&gt;0xffffff)?0xff0000:(((x)&lt;=0xffff)?0:(x)&amp;0xff0000))&gt;&gt;16)
id|y
op_assign
op_star
id|data
op_increment
op_minus
l_int|16
suffix:semicolon
id|u
op_assign
op_star
id|data
op_increment
op_minus
l_int|128
suffix:semicolon
id|y1
op_assign
op_star
id|data
op_increment
op_minus
l_int|16
suffix:semicolon
id|v
op_assign
op_star
id|data
op_increment
op_minus
l_int|128
suffix:semicolon
id|r
op_assign
l_int|104635
op_star
id|v
suffix:semicolon
id|g
op_assign
op_minus
l_int|25690
op_star
id|u
op_plus
op_minus
l_int|53294
op_star
id|v
suffix:semicolon
id|b
op_assign
l_int|132278
op_star
id|u
suffix:semicolon
id|y
op_mul_assign
l_int|76310
suffix:semicolon
id|y1
op_mul_assign
l_int|76310
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y1
)paren
suffix:semicolon
id|fp
op_add_assign
l_int|6
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;f[0] = f[1] = f[2] = *data;&n;&t;&t;&t;&t;&t;&t;f += 3;&n;&t;&t;&t;&t;&t;&t;data += 2;&n;&t;&t;&t;&t;&t;&t;fp += 3;&n;*/
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Raw data */
r_while
c_loop
(paren
id|data
OL
id|end
)paren
(brace
id|y
op_assign
op_star
id|data
op_increment
op_minus
l_int|16
suffix:semicolon
id|u
op_assign
op_star
id|data
op_increment
op_minus
l_int|128
suffix:semicolon
id|y1
op_assign
op_star
id|data
op_increment
op_minus
l_int|16
suffix:semicolon
id|v
op_assign
op_star
id|data
op_increment
op_minus
l_int|128
suffix:semicolon
id|r
op_assign
l_int|104635
op_star
id|v
suffix:semicolon
id|g
op_assign
op_minus
l_int|25690
op_star
id|u
op_plus
op_minus
l_int|53294
op_star
id|v
suffix:semicolon
id|b
op_assign
l_int|132278
op_star
id|u
suffix:semicolon
id|y
op_mul_assign
l_int|76310
suffix:semicolon
id|y1
op_mul_assign
l_int|76310
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|b
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|g
op_plus
id|y1
)paren
suffix:semicolon
op_star
id|f
op_increment
op_assign
id|LIMIT
c_func
(paren
id|r
op_plus
id|y1
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CPIA_DEBUG
multiline_comment|/* Make sure we found the end correctly */
r_if
c_cond
(paren
op_star
id|data
op_ne
l_int|0xFD
)paren
id|printk
c_func
(paren
l_string|&quot;cpia: missed end!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Skip the last byte */
id|data
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|frame-&gt;curline
op_ge
id|frame-&gt;hdrheight
)paren
r_goto
id|nextframe
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|nextframe
suffix:colon
r_if
c_cond
(paren
id|scratch_left
c_func
(paren
id|data
)paren
op_ge
l_int|4
op_logical_and
op_star
(paren
(paren
id|__u32
op_star
)paren
id|data
)paren
op_eq
l_int|0xFFFFFFFF
)paren
(brace
id|data
op_add_assign
l_int|4
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;end of frame found normally&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|frame-&gt;grabstate
op_assign
id|FRAME_DONE
suffix:semicolon
id|cpia-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* This will cause the process to request another frame */
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|error
suffix:colon
id|frame-&gt;grabstate
op_assign
id|FRAME_ERROR
suffix:semicolon
id|cpia-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
id|cpia-&gt;compress
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This will cause the process to request another frame */
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|frame-&gt;wq
)paren
suffix:semicolon
id|out
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scanned %d bytes, %d left&bslash;n&quot;
comma
id|data
op_minus
id|cpia-&gt;scratch
comma
id|scratch_left
c_func
(paren
id|data
)paren
)paren
suffix:semicolon
multiline_comment|/* Grab the remaining */
id|l
op_assign
id|scratch_left
c_func
(paren
id|data
)paren
suffix:semicolon
id|memmove
c_func
(paren
id|cpia-&gt;scratch
comma
id|data
comma
id|l
)paren
suffix:semicolon
id|cpia-&gt;scratchlen
op_assign
id|l
suffix:semicolon
)brace
multiline_comment|/*&n; * Make all of the blocks of data contiguous&n; */
DECL|function|cpia_compress_isochronous
r_static
r_int
id|cpia_compress_isochronous
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
comma
r_struct
id|usb_isoc_desc
op_star
id|isodesc
)paren
(brace
r_int
r_char
op_star
id|cdata
comma
op_star
id|data
suffix:semicolon
r_int
id|i
comma
id|totlen
op_assign
l_int|0
suffix:semicolon
id|cdata
op_assign
id|isodesc-&gt;data
suffix:semicolon
id|data
op_assign
id|cpia-&gt;scratch
op_plus
id|cpia-&gt;scratchlen
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|isodesc-&gt;frame_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|n
op_assign
id|isodesc-&gt;frames
(braket
id|i
)braket
dot
id|frame_length
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
r_int
id|st
op_assign
id|isodesc-&gt;frames
(braket
id|i
)braket
dot
id|frame_status
suffix:semicolon
r_if
c_cond
(paren
id|st
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cpia data error: [%d] len=%d, status=%X&bslash;n&quot;
comma
id|i
comma
id|n
comma
id|st
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|cpia-&gt;scratchlen
op_plus
id|n
)paren
OG
id|SCRATCH_BUF_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cpia: scratch buf overflow!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
)paren
id|memmove
c_func
(paren
id|data
comma
id|cdata
comma
id|n
)paren
suffix:semicolon
id|data
op_add_assign
id|n
suffix:semicolon
id|totlen
op_add_assign
id|n
suffix:semicolon
id|cpia-&gt;scratchlen
op_add_assign
id|n
suffix:semicolon
id|cdata
op_add_assign
id|isodesc-&gt;frame_size
suffix:semicolon
)brace
r_return
id|totlen
suffix:semicolon
)brace
DECL|function|cpia_isoc_irq
r_static
r_int
id|cpia_isoc_irq
c_func
(paren
r_int
id|status
comma
r_void
op_star
id|__buffer
comma
r_int
id|len
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|cpia_sbuf
op_star
id|sbuf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;streaming
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;oops, not streaming, but interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sbuf
op_assign
op_amp
id|cpia-&gt;sbuf
(braket
id|cpia-&gt;cursbuf
)braket
suffix:semicolon
id|usb_kill_isoc
c_func
(paren
id|sbuf-&gt;isodesc
)paren
suffix:semicolon
multiline_comment|/* Copy the data received into our scratch buffer */
id|len
op_assign
id|cpia_compress_isochronous
c_func
(paren
id|cpia
comma
id|sbuf-&gt;isodesc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d bytes received&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* If we don&squot;t have a frame we&squot;re current working on, complain */
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
id|cpia-&gt;curframe
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;cpia: received data, but no frame available&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|cpia_parse_data
c_func
(paren
id|cpia
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|i
op_increment
)paren
id|sbuf-&gt;isodesc-&gt;frames
(braket
id|i
)braket
dot
id|frame_length
op_assign
id|FRAME_SIZE_PER_DESC
suffix:semicolon
multiline_comment|/* Move to the next sbuf */
id|cpia-&gt;cursbuf
op_assign
(paren
id|cpia-&gt;cursbuf
op_plus
l_int|1
)paren
op_mod
id|CPIA_NUMSBUF
suffix:semicolon
multiline_comment|/* Reschedule this block of Isochronous desc */
id|usb_run_isoc
c_func
(paren
id|sbuf-&gt;isodesc
comma
id|cpia-&gt;sbuf
(braket
id|cpia-&gt;cursbuf
)braket
dot
id|isodesc
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|cpia_init_isoc
r_static
r_int
id|cpia_init_isoc
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|cpia-&gt;dev
suffix:semicolon
r_struct
id|usb_isoc_desc
op_star
id|id
suffix:semicolon
r_int
id|fx
comma
id|err
suffix:semicolon
id|cpia-&gt;curframe
op_assign
op_minus
l_int|1
suffix:semicolon
id|cpia-&gt;cursbuf
op_assign
l_int|0
suffix:semicolon
id|cpia-&gt;scratchlen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We double buffer the Iso lists */
id|err
op_assign
id|usb_init_isoc
c_func
(paren
id|dev
comma
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
l_int|1
)paren
comma
id|FRAMES_PER_DESC
comma
id|cpia
comma
op_amp
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cpia_init_isoc: usb_init_isoc() ret %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|err
op_assign
id|usb_init_isoc
c_func
(paren
id|dev
comma
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
l_int|1
)paren
comma
id|FRAMES_PER_DESC
comma
id|cpia
comma
op_amp
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cpia_init_isoc: usb_init_isoc() ret %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|usb_free_isoc
(paren
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;isodesc[0] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;isodesc[1] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Set the Isoc. desc. parameters. */
multiline_comment|/* First for desc. [0] */
id|id
op_assign
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
suffix:semicolon
id|id-&gt;start_type
op_assign
id|START_ASAP
suffix:semicolon
id|id-&gt;callback_frames
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* on every 10th frame */
id|id-&gt;callback_fn
op_assign
id|cpia_isoc_irq
suffix:semicolon
id|id-&gt;data
op_assign
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
suffix:semicolon
id|id-&gt;buf_size
op_assign
id|FRAME_SIZE_PER_DESC
op_star
id|FRAMES_PER_DESC
suffix:semicolon
r_for
c_loop
(paren
id|fx
op_assign
l_int|0
suffix:semicolon
id|fx
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|fx
op_increment
)paren
id|id-&gt;frames
(braket
id|fx
)braket
dot
id|frame_length
op_assign
id|FRAME_SIZE_PER_DESC
suffix:semicolon
multiline_comment|/* and the desc. [1] */
id|id
op_assign
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
suffix:semicolon
id|id-&gt;start_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* will follow the first desc. */
id|id-&gt;callback_frames
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* on every 10th frame */
id|id-&gt;callback_fn
op_assign
id|cpia_isoc_irq
suffix:semicolon
id|id-&gt;data
op_assign
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
suffix:semicolon
id|id-&gt;buf_size
op_assign
id|FRAME_SIZE_PER_DESC
op_star
id|FRAMES_PER_DESC
suffix:semicolon
r_for
c_loop
(paren
id|fx
op_assign
l_int|0
suffix:semicolon
id|fx
OL
id|FRAMES_PER_DESC
suffix:semicolon
id|fx
op_increment
)paren
id|id-&gt;frames
(braket
id|fx
)braket
dot
id|frame_length
op_assign
id|FRAME_SIZE_PER_DESC
suffix:semicolon
id|usb_run_isoc
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
comma
l_int|NULL
)paren
suffix:semicolon
id|usb_run_isoc
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;done scheduling&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Alternate interface 3 is is the biggest frame size */
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|cpia-&gt;dev
comma
l_int|1
comma
l_int|3
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;usb_set_interface error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|usb_cpia_grab_frame
c_func
(paren
id|dev
comma
l_int|120
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_grab_frame error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#endif
id|cpia-&gt;streaming
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;now streaming&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_stop_isoc
r_static
r_void
id|cpia_stop_isoc
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;streaming
)paren
r_return
suffix:semicolon
id|cpia-&gt;streaming
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Turn off continuous grab */
r_if
c_cond
(paren
id|usb_cpia_set_grab_mode
c_func
(paren
id|cpia-&gt;dev
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_set_grab_mode error&bslash;n&quot;
)paren
suffix:semicolon
r_return
multiline_comment|/* -EBUSY */
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|usb_cpia_grab_frame
c_func
(paren
id|cpia-&gt;dev
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_grab_frame error&bslash;n&quot;
)paren
suffix:semicolon
r_return
multiline_comment|/* -EBUSY */
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Set packet size to 0 */
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|cpia-&gt;dev
comma
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;usb_set_interface error&bslash;n&quot;
)paren
suffix:semicolon
r_return
multiline_comment|/* -EINVAL */
suffix:semicolon
)brace
multiline_comment|/* Unschedule all of the iso td&squot;s */
id|usb_kill_isoc
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|usb_kill_isoc
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
multiline_comment|/* Delete them all */
id|usb_free_isoc
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|isodesc
)paren
suffix:semicolon
id|usb_free_isoc
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|isodesc
)paren
suffix:semicolon
)brace
DECL|function|cpia_new_frame
r_static
r_int
id|cpia_new_frame
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
comma
r_int
id|framenum
)paren
(brace
r_struct
id|cpia_frame
op_star
id|frame
suffix:semicolon
r_int
id|width
comma
id|height
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;new frame %d&bslash;n&quot;
comma
id|framenum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|framenum
op_eq
op_minus
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CPIA_NUMFRAMES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|cpia-&gt;frame
(braket
id|i
)braket
dot
id|grabstate
op_eq
id|FRAME_READY
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|CPIA_NUMFRAMES
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;no frame ready&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|framenum
op_assign
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;using frame %d&bslash;n&quot;
comma
id|framenum
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpia-&gt;curframe
op_ne
op_minus
l_int|1
op_logical_and
id|cpia-&gt;curframe
op_ne
id|framenum
)paren
r_return
l_int|0
suffix:semicolon
id|frame
op_assign
op_amp
id|cpia-&gt;frame
(braket
id|framenum
)braket
suffix:semicolon
id|width
op_assign
id|frame-&gt;width
suffix:semicolon
id|height
op_assign
id|frame-&gt;height
suffix:semicolon
multiline_comment|/* Make sure it&squot;s not too big */
r_if
c_cond
(paren
id|width
OG
l_int|352
)paren
id|width
op_assign
l_int|352
suffix:semicolon
id|width
op_assign
(paren
id|width
op_div
l_int|8
)paren
op_star
l_int|8
suffix:semicolon
multiline_comment|/* Multiple of 8 */
r_if
c_cond
(paren
id|height
OG
l_int|288
)paren
id|height
op_assign
l_int|288
suffix:semicolon
id|height
op_assign
(paren
id|height
op_div
l_int|4
)paren
op_star
l_int|4
suffix:semicolon
multiline_comment|/* Multiple of 4 */
multiline_comment|/* Set the ROI they want */
r_if
c_cond
(paren
id|usb_cpia_set_roi
c_func
(paren
id|cpia-&gt;dev
comma
l_int|0
comma
id|width
op_div
l_int|8
comma
l_int|0
comma
id|height
op_div
l_int|4
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|usb_cpia_set_compression
c_func
(paren
id|cpia-&gt;dev
comma
id|cpia-&gt;compress
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_set_compression error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* We want a fresh frame every 30 we get */
id|cpia-&gt;compress
op_assign
(paren
id|cpia-&gt;compress
op_plus
l_int|1
)paren
op_mod
l_int|30
suffix:semicolon
multiline_comment|/* Grab the frame */
r_if
c_cond
(paren
id|usb_cpia_upload_frame
c_func
(paren
id|cpia-&gt;dev
comma
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_upload_frame error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|frame-&gt;grabstate
op_assign
id|FRAME_GRABBING
suffix:semicolon
id|frame-&gt;scanstate
op_assign
id|STATE_SCANNING
suffix:semicolon
id|cpia-&gt;curframe
op_assign
id|framenum
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Video 4 Linux API */
DECL|function|cpia_open
r_static
r_int
id|cpia_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_int
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;cpia_open&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|cpia-&gt;frame
(braket
l_int|0
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
id|cpia-&gt;frame
(braket
l_int|1
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
multiline_comment|/* Allocate memory for the frame buffers */
id|cpia-&gt;fbuf
op_assign
id|rvmalloc
c_func
(paren
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;fbuf
)paren
r_goto
id|open_err_ret
suffix:semicolon
id|cpia-&gt;frame
(braket
l_int|0
)braket
dot
id|data
op_assign
id|cpia-&gt;fbuf
suffix:semicolon
id|cpia-&gt;frame
(braket
l_int|1
)braket
dot
id|data
op_assign
id|cpia-&gt;fbuf
op_plus
id|MAX_FRAME_SIZE
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;frame [0] @ %p&bslash;n&quot;
comma
id|cpia-&gt;frame
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;frame [1] @ %p&bslash;n&quot;
comma
id|cpia-&gt;frame
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
macro_line|#endif
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
op_assign
id|kmalloc
(paren
id|FRAMES_PER_DESC
op_star
id|FRAME_SIZE_PER_DESC
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
r_goto
id|open_err_on0
suffix:semicolon
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
op_assign
id|kmalloc
(paren
id|FRAMES_PER_DESC
op_star
id|FRAME_SIZE_PER_DESC
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
r_goto
id|open_err_on1
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;sbuf[0] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sbuf[1] @ %p&bslash;n&quot;
comma
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
macro_line|#endif
id|err
op_assign
id|cpia_init_isoc
c_func
(paren
id|cpia
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|open_err_on2
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|open_err_on2
suffix:colon
id|kfree
(paren
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
id|open_err_on1
suffix:colon
id|kfree
(paren
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
id|open_err_on0
suffix:colon
id|rvfree
c_func
(paren
id|cpia-&gt;fbuf
comma
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
suffix:semicolon
id|open_err_ret
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|cpia_close
r_static
r_void
id|cpia_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;cpia_close&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|cpia_stop_isoc
c_func
(paren
id|cpia
)paren
suffix:semicolon
id|rvfree
c_func
(paren
id|cpia-&gt;fbuf
comma
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|1
)braket
dot
id|data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cpia-&gt;sbuf
(braket
l_int|0
)braket
dot
id|data
)paren
suffix:semicolon
)brace
DECL|function|cpia_init_done
r_static
r_int
id|cpia_init_done
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_write
r_static
r_int
id|cpia_write
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|cpia_ioctl
r_static
r_int
id|cpia_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;GCAP&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|strcpy
c_func
(paren
id|b.name
comma
l_string|&quot;CPiA USB Camera&quot;
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_SUBCAPTURE
suffix:semicolon
id|b.channels
op_assign
l_int|1
suffix:semicolon
id|b.audios
op_assign
l_int|0
suffix:semicolon
id|b.maxwidth
op_assign
l_int|352
suffix:semicolon
multiline_comment|/* CIF */
id|b.maxheight
op_assign
l_int|288
suffix:semicolon
multiline_comment|/*  &quot;  */
id|b.minwidth
op_assign
l_int|176
suffix:semicolon
multiline_comment|/* QCIF */
id|b.minheight
op_assign
l_int|144
suffix:semicolon
multiline_comment|/*  &quot;   */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;GCHAN&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v.channel
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|v.flags
op_assign
l_int|0
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Camera&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_int
id|v
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;SCHAN&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|v
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;GPICT&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|p.colour
op_assign
l_int|0x8000
suffix:semicolon
multiline_comment|/* Damn British people :) */
id|p.hue
op_assign
l_int|0x8000
suffix:semicolon
id|p.brightness
op_assign
l_int|180
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* XXX */
id|p.contrast
op_assign
l_int|192
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* XXX */
id|p.whiteness
op_assign
l_int|105
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* XXX */
macro_line|#if 0
id|p.depth
op_assign
l_int|24
suffix:semicolon
macro_line|#endif
id|p.depth
op_assign
l_int|16
suffix:semicolon
id|p.palette
op_assign
id|VIDEO_PALETTE_YUYV
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;SPICT&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;Attempting to set palette %d, depth %d&bslash;n&quot;
comma
id|p.palette
comma
id|p.depth
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;SWIN&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|vw.flags
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.clipcount
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.height
op_ne
l_int|176
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vw.width
op_ne
l_int|144
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|cpia-&gt;compress
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;GWIN&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|vw.x
op_assign
l_int|0
suffix:semicolon
id|vw.y
op_assign
l_int|0
suffix:semicolon
id|vw.width
op_assign
l_int|176
suffix:semicolon
id|vw.height
op_assign
l_int|144
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
id|vm
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;MBUF&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
c_func
(paren
op_amp
id|vm
comma
l_int|0
comma
r_sizeof
(paren
id|vm
)paren
)paren
suffix:semicolon
id|vm.size
op_assign
id|MAX_FRAME_SIZE
op_star
l_int|2
suffix:semicolon
id|vm.frames
op_assign
l_int|2
suffix:semicolon
id|vm.offsets
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|vm.offsets
(braket
l_int|1
)braket
op_assign
id|MAX_FRAME_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;MCAPTURE&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;frame: %d, size: %dx%d, format: %d&bslash;n&quot;
comma
id|vm.frame
comma
id|vm.width
comma
id|vm.height
comma
id|vm.format
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|vm.format
op_ne
id|VIDEO_PALETTE_RGB24
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vm.frame
op_ne
l_int|0
)paren
op_logical_and
(paren
id|vm.frame
op_ne
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cpia-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Don&squot;t compress if the size changed */
r_if
c_cond
(paren
(paren
id|cpia-&gt;frame
(braket
id|vm.frame
)braket
dot
id|width
op_ne
id|vm.width
)paren
op_logical_or
(paren
id|cpia-&gt;frame
(braket
id|vm.frame
)braket
dot
id|height
op_ne
id|vm.height
)paren
)paren
id|cpia-&gt;compress
op_assign
l_int|0
suffix:semicolon
id|cpia-&gt;frame
(braket
id|vm.frame
)braket
dot
id|width
op_assign
id|vm.width
suffix:semicolon
id|cpia-&gt;frame
(braket
id|vm.frame
)braket
dot
id|height
op_assign
id|vm.height
suffix:semicolon
multiline_comment|/* Mark it as ready */
id|cpia-&gt;frame
(braket
id|vm.frame
)braket
dot
id|grabstate
op_assign
id|FRAME_READY
suffix:semicolon
r_return
id|cpia_new_frame
c_func
(paren
id|cpia
comma
id|vm.frame
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
id|frame
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;SYNC&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|frame
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;cpia: syncing to frame %d&bslash;n&quot;
comma
id|frame
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cpia-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
)paren
(brace
r_case
id|FRAME_UNUSED
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|FRAME_READY
suffix:colon
r_case
id|FRAME_GRABBING
suffix:colon
id|redo
suffix:colon
r_do
(brace
id|printk
c_func
(paren
l_string|&quot;enter sleeping&bslash;n&quot;
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|cpia-&gt;frame
(braket
id|frame
)braket
dot
id|wq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;back from sleeping&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_while
c_loop
(paren
id|cpia-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_eq
id|FRAME_GRABBING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpia-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_eq
id|FRAME_ERROR
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|cpia_new_frame
c_func
(paren
id|cpia
comma
id|frame
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_goto
id|redo
suffix:semicolon
)brace
r_case
id|FRAME_DONE
suffix:colon
id|cpia-&gt;frame
(braket
id|frame
)braket
dot
id|grabstate
op_assign
id|FRAME_UNUSED
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;cpia: finished, synced to frame %d&bslash;n&quot;
comma
id|frame
)paren
suffix:semicolon
macro_line|#endif
r_return
id|cpia_new_frame
c_func
(paren
id|cpia
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCKEY
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|VIDIOCCAPTURE
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGFBUF
suffix:colon
r_case
id|VIDIOCSFBUF
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGTUNER
suffix:colon
r_case
id|VIDIOCSTUNER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGFREQ
suffix:colon
r_case
id|VIDIOCSFREQ
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_case
id|VIDIOCSAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_read
r_static
r_int
id|cpia_read
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|noblock
)paren
(brace
macro_line|#if 0
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
r_int
id|len
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;cpia_read: %ld bytes&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_mmap
r_static
r_int
id|cpia_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
(paren
r_struct
id|usb_cpia
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
macro_line|#ifdef CPIA_DEBUG
id|printk
c_func
(paren
l_string|&quot;mmap: %ld (%lX) bytes&bslash;n&quot;
comma
id|size
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|size
OG
(paren
(paren
(paren
l_int|2
op_star
id|MAX_FRAME_SIZE
)paren
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pos
op_assign
(paren
r_int
r_int
)paren
id|cpia-&gt;fbuf
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|PAGE_SIZE
)paren
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
r_else
id|size
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|cpia_template
r_static
r_struct
id|video_device
id|cpia_template
op_assign
(brace
l_string|&quot;CPiA USB Camera&quot;
comma
id|VID_TYPE_CAPTURE
comma
id|VID_HARDWARE_CPIA
comma
id|cpia_open
comma
id|cpia_close
comma
id|cpia_read
comma
id|cpia_write
comma
l_int|NULL
comma
id|cpia_ioctl
comma
id|cpia_mmap
comma
id|cpia_init_done
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|function|usb_cpia_configure
r_static
r_int
id|usb_cpia_configure
c_func
(paren
r_struct
id|usb_cpia
op_star
id|cpia
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|cpia-&gt;dev
suffix:semicolon
r_int
r_char
id|version
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|usb_set_configuration
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|bConfigurationValue
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia: usb_set_configuration failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Set packet size to 0 */
r_if
c_cond
(paren
id|usb_set_interface
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;usb_set_interface error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_cpia_get_version
c_func
(paren
id|dev
comma
id|version
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_get_version error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;cpia: Firmware v%d.%d, VC Hardware v%d.%d&bslash;n&quot;
comma
id|version
(braket
l_int|0
)braket
comma
id|version
(braket
l_int|1
)braket
comma
id|version
(braket
l_int|2
)braket
comma
id|version
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|cpia-&gt;vdev
comma
op_amp
id|cpia_template
comma
r_sizeof
(paren
id|cpia_template
)paren
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cpia-&gt;frame
(braket
l_int|0
)braket
dot
id|wq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cpia-&gt;frame
(braket
l_int|1
)braket
dot
id|wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|cpia-&gt;vdev
comma
id|VFL_TYPE_GRABBER
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;video_register_device failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_cpia_goto_hi_power
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_goto_hi_power error&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_cpia_get_vp_version
c_func
(paren
id|dev
comma
id|version
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_get_vp_version error&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;cpia: VP v%d rev %d&bslash;n&quot;
comma
id|version
(braket
l_int|0
)braket
comma
id|version
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cpia: Camera Head ID %04X&bslash;n&quot;
comma
(paren
id|version
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_plus
id|version
(braket
l_int|2
)braket
)paren
suffix:semicolon
multiline_comment|/* Turn on continuous grab */
r_if
c_cond
(paren
id|usb_cpia_set_grab_mode
c_func
(paren
id|dev
comma
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_set_grab_mode error&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Set up the sensor to be 30fps */
r_if
c_cond
(paren
id|usb_cpia_set_sensor_fps
c_func
(paren
id|dev
comma
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_set_sensor_fps error&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Set video into CIF mode, and order into YUYV mode */
r_if
c_cond
(paren
id|usb_cpia_set_format
c_func
(paren
id|dev
comma
id|CPIA_CIF
comma
l_int|1
comma
id|CPIA_YUYV
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_set_format error&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Turn off compression */
r_if
c_cond
(paren
id|usb_cpia_set_compression
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cpia_set_compression error&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|cpia-&gt;compress
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|video_unregister_device
c_func
(paren
op_amp
id|cpia-&gt;vdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cpia
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|cpia_probe
r_static
r_int
id|cpia_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_cpia
op_star
id|cpia
suffix:semicolon
multiline_comment|/* We don&squot;t handle multi-config cameras */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|interface
op_assign
op_amp
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Is it a CPiA? */
r_if
c_cond
(paren
id|dev-&gt;descriptor.idVendor
op_ne
l_int|0x0553
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;descriptor.idProduct
op_ne
l_int|0x0002
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Checking vendor/product should be enough, but what the hell */
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|0xFF
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|0x00
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* We found a CPiA */
id|printk
c_func
(paren
l_string|&quot;USB CPiA camera found&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpia
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|cpia
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;couldn&squot;t kmalloc cpia struct&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cpia
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cpia
)paren
)paren
suffix:semicolon
id|dev
op_member_access_from_pointer
r_private
op_assign
id|cpia
suffix:semicolon
id|cpia-&gt;dev
op_assign
id|dev
suffix:semicolon
r_return
id|usb_cpia_configure
c_func
(paren
id|cpia
)paren
suffix:semicolon
)brace
DECL|function|cpia_disconnect
r_static
r_void
id|cpia_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_cpia
op_star
id|cpia
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|cpia-&gt;vdev
)paren
suffix:semicolon
multiline_comment|/* Free the memory */
id|kfree
c_func
(paren
id|cpia
)paren
suffix:semicolon
)brace
DECL|variable|cpia_driver
r_static
r_struct
id|usb_driver
id|cpia_driver
op_assign
(brace
l_string|&quot;cpia&quot;
comma
id|cpia_probe
comma
id|cpia_disconnect
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|function|usb_cpia_init
r_int
id|usb_cpia_init
c_func
(paren
r_void
)paren
(brace
id|usb_register
c_func
(paren
op_amp
id|cpia_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_cpia_cleanup
r_void
id|usb_cpia_cleanup
c_func
(paren
r_void
)paren
(brace
id|usb_deregister
c_func
(paren
op_amp
id|cpia_driver
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_cpia_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|usb_cpia_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
