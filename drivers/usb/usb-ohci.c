multiline_comment|/*&n; * URB OHCI HCD (Host Controller Driver) for USB.&n; *&n; * (C) Copyright 1999 Roman Weissgaerber &lt;weissg@vienna.at&gt;&n; * &n; * [ Initialisation is based on Linus&squot;  ]&n; * [ uhci code and gregs ohci fragments ]&n; * [ (C) Copyright 1999 Linus Torvalds  ]&n; * [ (C) Copyright 1999 Gregory P. Smith]&n; * &n; * &n; * History:&n; * &n; * v5.2 1999/12/07 URB 3rd preview, &n; * v5.1 1999/11/30 URB 2nd preview, cpia, (usb-scsi)&n; * v5.0 1999/11/22 URB Technical preview, Paul Mackerras powerbook susp/resume &n; * &t;i386: HUB, Keyboard, Mouse, Printer &n; *&n; * v4.3 1999/10/27 multiple HCs, bulk_request&n; * v4.2 1999/09/05 ISO API alpha, new dev alloc, neg Error-codes&n; * v4.1 1999/08/27 Randy Dunlap&squot;s - ISO API first impl.&n; * v4.0 1999/08/18 &n; * v3.0 1999/06/25 &n; * v2.1 1999/05/09  code clean up&n; * v2.0 1999/05/04 &n; * v1.0 1999/04/27 initial release&n; * &n; &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;  /* for in_interrupt() */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
DECL|macro|OHCI_USE_NPS
mdefine_line|#define OHCI_USE_NPS
macro_line|#include &quot;usb-ohci.h&quot;
macro_line|#include &lt;linux/pm.h&gt;
r_static
r_int
id|handle_pm_event
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#endif
r_static
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|op_wakeup
)paren
suffix:semicolon
r_static
id|LIST_HEAD
(paren
id|ohci_hcd_list
)paren
suffix:semicolon
DECL|variable|usb_ed_lock
r_static
id|spinlock_t
id|usb_ed_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*&n; * URB support functions &n; *-------------------------------------------------------------------------*/
multiline_comment|/* free the private part of an URB */
DECL|function|urb_rm_priv
r_static
r_void
id|urb_rm_priv
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_void
op_star
id|wait
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv
)paren
r_return
suffix:semicolon
id|wait
op_assign
id|urb_priv-&gt;wait
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb_priv-&gt;length
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|urb_priv-&gt;td
(braket
id|i
)braket
)paren
(brace
id|OHCI_FREE
(paren
id|urb_priv-&gt;td
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|kfree
(paren
id|urb-&gt;hcpriv
)paren
suffix:semicolon
id|urb-&gt;hcpriv
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|wait
)paren
(brace
id|add_wait_queue
(paren
op_amp
id|op_wakeup
comma
id|wait
)paren
suffix:semicolon
id|wake_up
(paren
op_amp
id|op_wakeup
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef DEBUG
r_static
r_int
id|sohci_get_current_frame_number
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* debug| print the main components of an URB     &n; * small: 0) header + data packets 1) just header */
DECL|function|urb_print
r_static
r_void
id|urb_print
(paren
id|urb_t
op_star
id|urb
comma
r_char
op_star
id|str
comma
r_int
id|small
)paren
(brace
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
r_int
id|i
comma
id|len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;dev
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s URB: no dev&quot;
comma
id|str
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s URB:[%4x] dev:%2d,ep:%2d-%c,type:%s,flags:%4x,len:%d/%d,stat:%d(%x)&quot;
comma
id|str
comma
id|sohci_get_current_frame_number
(paren
id|urb-&gt;dev
)paren
comma
id|usb_pipedevice
(paren
id|pipe
)paren
comma
id|usb_pipeendpoint
(paren
id|pipe
)paren
comma
id|usb_pipeout
(paren
id|pipe
)paren
ques
c_cond
l_char|&squot;O&squot;
suffix:colon
l_char|&squot;I&squot;
comma
id|usb_pipetype
(paren
id|pipe
)paren
OL
l_int|2
ques
c_cond
(paren
id|usb_pipeint
(paren
id|pipe
)paren
ques
c_cond
l_string|&quot;INTR&quot;
suffix:colon
l_string|&quot;ISOC&quot;
)paren
suffix:colon
(paren
id|usb_pipecontrol
(paren
id|pipe
)paren
ques
c_cond
l_string|&quot;CTRL&quot;
suffix:colon
l_string|&quot;BULK&quot;
)paren
comma
id|urb-&gt;transfer_flags
comma
id|urb-&gt;actual_length
comma
id|urb-&gt;transfer_buffer_length
comma
id|urb-&gt;status
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|small
)paren
(brace
r_if
c_cond
(paren
id|usb_pipecontrol
(paren
id|pipe
)paren
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: cmd(8):&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|urb-&gt;setup_packet
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer_length
OG
l_int|0
op_logical_and
id|urb-&gt;transfer_buffer
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: data(%d/%d):&quot;
comma
id|urb-&gt;actual_length
comma
id|urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
id|len
op_assign
id|usb_pipeout
(paren
id|pipe
)paren
ques
c_cond
id|urb-&gt;transfer_buffer_length
suffix:colon
id|urb-&gt;actual_length
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
op_logical_and
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|urb-&gt;transfer_buffer
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%s stat:%d&bslash;n&quot;
comma
id|i
OL
id|len
ques
c_cond
l_string|&quot;...&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* just for debugging; prints all 32 branches of the int ed tree inclusive iso eds*/
DECL|function|ep_print_int_eds
r_void
id|ep_print_int_eds
(paren
id|ohci_t
op_star
id|ohci
comma
r_char
op_star
id|str
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|__u32
op_star
id|ed_p
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
l_int|5
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot; %s branch int %2d(%2x):&quot;
comma
id|str
comma
id|i
comma
id|i
)paren
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|i
)braket
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|ed_p
op_ne
l_int|0
op_logical_and
id|j
op_decrement
)paren
(brace
id|ed_t
op_star
id|ed
op_assign
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
c_func
(paren
id|le32_to_cpup
c_func
(paren
id|ed_p
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot; ed: %4x;&quot;
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
id|ed_p
op_assign
op_amp
id|ed-&gt;hwNextED
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*&n; * Interface functions (URB)&n; *-------------------------------------------------------------------------*/
multiline_comment|/* return a request to the completion handler */
DECL|function|sohci_return_urb
r_static
r_int
id|sohci_return_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|urb_t
op_star
id|urbt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* just to be sure */
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;complete
)paren
(brace
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|urb_priv
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* urb already unlinked */
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;RET&quot;
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_INTERRUPT
suffix:colon
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
multiline_comment|/* call complete and requeue URB */
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;status
op_assign
id|USB_ST_URB_PENDING
suffix:semicolon
r_if
c_cond
(paren
id|urb_priv-&gt;state
op_ne
id|URB_DEL
)paren
id|td_submit_urb
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_for
c_loop
(paren
id|urbt
op_assign
id|urb-&gt;next
suffix:semicolon
id|urbt
op_logical_and
(paren
id|urbt
op_ne
id|urb
)paren
suffix:semicolon
id|urbt
op_assign
id|urbt-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urbt
)paren
(brace
multiline_comment|/* send the reply and requeue URB */
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;status
op_assign
id|USB_ST_URB_PENDING
suffix:semicolon
id|urb-&gt;start_frame
op_assign
id|urb_priv-&gt;ed-&gt;last_iso
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|urb_priv-&gt;state
op_ne
id|URB_DEL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
op_minus
id|EXDEV
suffix:semicolon
)brace
id|td_submit_urb
(paren
id|urb
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* unlink URB, call complete */
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
r_case
id|PIPE_CONTROL
suffix:colon
multiline_comment|/* unlink URB, call complete */
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* get a transfer request */
DECL|function|sohci_submit_urb
r_static
r_int
id|sohci_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|ohci_t
op_star
id|ohci
suffix:semicolon
id|ed_t
op_star
id|ed
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
r_int
id|i
comma
id|size
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;dev
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;hcpriv
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* urb already in use */
singleline_comment|//&t;if(usb_endpoint_halted (urb-&gt;dev, usb_pipeendpoint (pipe), usb_pipeout (pipe))) 
singleline_comment|//&t;&t;return -EPIPE;
id|usb_inc_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;SUB&quot;
comma
id|usb_pipein
(paren
id|pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* a request to the virtual root hub */
r_if
c_cond
(paren
id|usb_pipedevice
(paren
id|pipe
)paren
op_eq
id|ohci-&gt;rh.devnum
)paren
r_return
id|rh_submit_urb
(paren
id|urb
)paren
suffix:semicolon
multiline_comment|/* when controller&squot;s hung, permit only hub cleanup attempts&n;&t; * such as powering down ports */
r_if
c_cond
(paren
id|ohci-&gt;disabled
)paren
r_return
op_minus
id|ESHUTDOWN
suffix:semicolon
multiline_comment|/* every endpoint has a ed, locate and fill it */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ed
op_assign
id|ep_add_ed
(paren
id|urb-&gt;dev
comma
id|pipe
comma
id|urb-&gt;interval
comma
l_int|1
)paren
)paren
)paren
(brace
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* for the private part of the URB we need the number of TDs (size) */
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|pipe
)paren
)paren
(brace
r_case
id|PIPE_BULK
suffix:colon
multiline_comment|/* one TD for every 4096 Byte */
id|size
op_assign
(paren
id|urb-&gt;transfer_buffer_length
op_minus
l_int|1
)paren
op_div
l_int|4096
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
multiline_comment|/* number of packets from URB */
id|size
op_assign
id|urb-&gt;number_of_packets
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
op_minus
id|EXDEV
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PIPE_CONTROL
suffix:colon
multiline_comment|/* 1 TD for setup, 1 for ACK and 1 for every 4096 B */
id|size
op_assign
(paren
id|urb-&gt;transfer_buffer_length
op_eq
l_int|0
)paren
ques
c_cond
l_int|2
suffix:colon
(paren
id|urb-&gt;transfer_buffer_length
op_minus
l_int|1
)paren
op_div
l_int|4096
op_plus
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
multiline_comment|/* one TD */
id|size
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* allocate the private part or the URB */
id|urb_priv
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|urb_priv_t
)paren
op_plus
id|size
op_star
r_sizeof
(paren
id|td_t
op_star
)paren
comma
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv
)paren
(brace
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|urb_priv
comma
l_int|0
comma
r_sizeof
(paren
id|urb_priv_t
)paren
op_plus
id|size
op_star
r_sizeof
(paren
id|td_t
op_star
)paren
)paren
suffix:semicolon
multiline_comment|/* fill the private part of the URB */
id|urb-&gt;hcpriv
op_assign
id|urb_priv
suffix:semicolon
id|urb_priv-&gt;length
op_assign
id|size
suffix:semicolon
id|urb_priv-&gt;td_cnt
op_assign
l_int|0
suffix:semicolon
id|urb_priv-&gt;state
op_assign
l_int|0
suffix:semicolon
id|urb_priv-&gt;ed
op_assign
id|ed
suffix:semicolon
id|urb_priv-&gt;wait
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* allocate the TDs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|OHCI_ALLOC
(paren
id|urb_priv-&gt;td
(braket
id|i
)braket
comma
r_sizeof
(paren
id|td_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv-&gt;td
(braket
id|i
)braket
)paren
(brace
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;state
op_eq
id|ED_NEW
op_logical_or
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
)paren
(brace
id|urb_rm_priv
c_func
(paren
id|urb
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* for ISOC transfers calculate start frame index */
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ISO_ASAP
)paren
(brace
id|urb-&gt;start_frame
op_assign
(paren
(paren
id|ed-&gt;state
op_eq
id|ED_OPER
)paren
ques
c_cond
(paren
id|ed-&gt;last_iso
op_plus
l_int|1
)paren
suffix:colon
(paren
id|le16_to_cpu
(paren
id|ohci-&gt;hcca.frame_no
)paren
op_plus
l_int|10
)paren
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ed-&gt;state
op_ne
id|ED_OPER
)paren
multiline_comment|/* link the ed into a chain if is not already */
id|ep_link
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
id|td_submit_urb
(paren
id|urb
)paren
suffix:semicolon
multiline_comment|/* fill the TDs and link it to the ed */
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
id|USB_ST_URB_PENDING
suffix:semicolon
singleline_comment|// queue_urb(s, &amp;urb-&gt;urb_list);
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* deactivate all TDs and remove the private part of the URB */
DECL|function|sohci_unlink_urb
r_static
r_int
id|sohci_unlink_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ohci_t
op_star
id|ohci
suffix:semicolon
id|DECLARE_WAITQUEUE
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
multiline_comment|/* just to be sure */
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;UNLINK&quot;
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif&t;&t;  
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipedevice
(paren
id|urb-&gt;pipe
)paren
op_eq
id|ohci-&gt;rh.devnum
)paren
r_return
id|rh_unlink_urb
(paren
id|urb
)paren
suffix:semicolon
multiline_comment|/* a request to the virtual root hub */
r_if
c_cond
(paren
id|urb-&gt;hcpriv
)paren
(brace
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
id|USB_ST_URB_PENDING
)paren
(brace
multiline_comment|/* URB active? */
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|urb_priv-&gt;state
op_assign
id|URB_DEL
suffix:semicolon
multiline_comment|/* we want to delete the TDs of an URB from an ed &n;&t;&t;&t; * request the deletion, it will be handled at the next USB-frame */
id|urb_priv-&gt;wait
op_assign
op_amp
id|wait
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|ep_rm_ed
(paren
id|urb-&gt;dev
comma
id|urb_priv-&gt;ed
)paren
suffix:semicolon
id|urb_priv-&gt;ed-&gt;state
op_or_assign
id|ED_URB_DEL
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
id|schedule_timeout
(paren
id|HZ
op_div
l_int|10
)paren
)paren
(brace
multiline_comment|/* wait until all TDs are deleted */
id|remove_wait_queue
(paren
op_amp
id|op_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
r_else
id|err
c_func
(paren
l_string|&quot;unlink URB timeout!&quot;
)paren
suffix:semicolon
)brace
r_else
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* allocate private data space for a usb device */
DECL|function|sohci_alloc_dev
r_static
r_int
id|sohci_alloc_dev
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
id|dev
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|usb_dev-&gt;hcpriv
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* free private data space of usb device */
DECL|function|sohci_free_dev
r_static
r_int
id|sohci_free_dev
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|cnt
op_assign
l_int|0
suffix:semicolon
id|ed_t
op_star
id|ed
suffix:semicolon
id|DECLARE_WAITQUEUE
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
op_assign
id|usb_to_ohci
(paren
id|usb_dev
)paren
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|usb_dev-&gt;devnum
op_ge
l_int|0
)paren
(brace
multiline_comment|/* delete all TDs of all EDs */
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_EDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ed
op_assign
op_amp
(paren
id|dev-&gt;ed
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;state
op_ne
id|ED_NEW
)paren
(brace
r_if
c_cond
(paren
id|ed-&gt;state
op_eq
id|ED_OPER
)paren
id|ep_unlink
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
id|ep_rm_ed
(paren
id|usb_dev
comma
id|ed
)paren
suffix:semicolon
id|ed-&gt;state
op_assign
id|ED_DEL
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
l_int|0
)paren
(brace
id|dev-&gt;wait
op_assign
op_amp
id|wait
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|remove_wait_queue
(paren
op_amp
id|op_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
)brace
id|kfree
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* tell us the current USB frame number */
DECL|function|sohci_get_current_frame_number
r_static
r_int
id|sohci_get_current_frame_number
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_return
id|le16_to_cpu
(paren
id|ohci-&gt;hcca.frame_no
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|sohci_device_operations
r_struct
id|usb_operations
id|sohci_device_operations
op_assign
(brace
id|sohci_alloc_dev
comma
id|sohci_free_dev
comma
id|sohci_get_current_frame_number
comma
id|sohci_submit_urb
comma
id|sohci_unlink_urb
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*&n; * ED handling functions&n; *-------------------------------------------------------------------------*/
multiline_comment|/* search for the right branch to insert an interrupt ed into the int tree &n; * do some load ballancing;&n; * returns the branch and &n; * sets the interval to interval = 2^integer (ld (interval)) */
DECL|function|ep_int_ballance
r_static
r_int
id|ep_int_ballance
(paren
id|ohci_t
op_star
id|ohci
comma
r_int
id|interval
comma
r_int
id|load
)paren
(brace
r_int
id|i
comma
id|branch
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* search for the least loaded interrupt endpoint branch of all 32 branches */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ohci-&gt;ohci_int_load
(braket
id|branch
)braket
OG
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
)paren
id|branch
op_assign
id|i
suffix:semicolon
id|branch
op_assign
id|branch
op_mod
id|interval
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|branch
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|interval
)paren
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_add_assign
id|load
suffix:semicolon
r_return
id|branch
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/*  2^int( ld (inter)) */
DECL|function|ep_2_n_interval
r_static
r_int
id|ep_2_n_interval
(paren
r_int
id|inter
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|inter
op_rshift
id|i
)paren
OG
l_int|1
)paren
op_logical_and
(paren
id|i
OL
l_int|5
)paren
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_return
l_int|1
op_lshift
id|i
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* the int tree is a binary tree &n; * in order to process it sequentially the indexes of the branches have to be mapped &n; * the mapping reverses the bits of a word of num_bits length */
DECL|function|ep_rev
r_static
r_int
id|ep_rev
(paren
r_int
id|num_bits
comma
r_int
id|word
)paren
(brace
r_int
id|i
comma
id|wout
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_bits
suffix:semicolon
id|i
op_increment
)paren
id|wout
op_or_assign
(paren
(paren
(paren
id|word
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
op_lshift
(paren
id|num_bits
op_minus
id|i
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_return
id|wout
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* link an ed into one of the HC chains */
DECL|function|ep_link
r_static
r_int
id|ep_link
(paren
id|ohci_t
op_star
id|ohci
comma
id|ed_t
op_star
id|edi
)paren
(brace
r_int
id|int_branch
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|inter
suffix:semicolon
r_int
id|interval
suffix:semicolon
r_int
id|load
suffix:semicolon
id|__u32
op_star
id|ed_p
suffix:semicolon
r_volatile
id|ed_t
op_star
id|ed
op_assign
id|edi
suffix:semicolon
id|ed-&gt;state
op_assign
id|ED_OPER
suffix:semicolon
r_switch
c_cond
(paren
id|ed-&gt;type
)paren
(brace
r_case
id|CTRL
suffix:colon
id|ed-&gt;hwNextED
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
op_eq
l_int|NULL
)paren
(brace
id|writel
(paren
id|virt_to_bus
(paren
id|ed
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;ed_controltail-&gt;hwNextED
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_controltail
suffix:semicolon
id|ohci-&gt;ed_controltail
op_assign
id|edi
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BULK
suffix:colon
id|ed-&gt;hwNextED
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
op_eq
l_int|NULL
)paren
(brace
id|writel
(paren
id|virt_to_bus
(paren
id|ed
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;ed_bulktail-&gt;hwNextED
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_bulktail
suffix:semicolon
id|ohci-&gt;ed_bulktail
op_assign
id|edi
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INT
suffix:colon
id|load
op_assign
id|ed-&gt;int_load
suffix:semicolon
id|interval
op_assign
id|ep_2_n_interval
(paren
id|ed-&gt;int_period
)paren
suffix:semicolon
id|ed-&gt;int_interval
op_assign
id|interval
suffix:semicolon
id|int_branch
op_assign
id|ep_int_ballance
(paren
id|ohci
comma
id|interval
comma
id|load
)paren
suffix:semicolon
id|ed-&gt;int_branch
op_assign
id|int_branch
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ep_rev
(paren
l_int|6
comma
id|interval
)paren
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
id|inter
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|ep_rev
(paren
l_int|5
comma
id|i
)paren
op_plus
id|int_branch
)braket
)paren
suffix:semicolon
(paren
op_star
id|ed_p
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|int_interval
op_ge
id|interval
)paren
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
)paren
id|inter
op_assign
id|ep_rev
(paren
l_int|6
comma
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
suffix:semicolon
id|ed-&gt;hwNextED
op_assign
op_star
id|ed_p
suffix:semicolon
op_star
id|ed_p
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|ep_print_int_eds
(paren
id|ohci
comma
l_string|&quot;LINK_INT&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|ISO
suffix:colon
id|ed-&gt;hwNextED
op_assign
l_int|0
suffix:semicolon
id|ed-&gt;int_interval
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_isotail
op_ne
l_int|NULL
)paren
(brace
id|ohci-&gt;ed_isotail-&gt;hwNextED
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_isotail
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
id|inter
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|ep_rev
(paren
l_int|5
comma
id|i
)paren
)braket
)paren
suffix:semicolon
op_star
id|ed_p
op_ne
l_int|0
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
)paren
id|inter
op_assign
id|ep_rev
(paren
l_int|6
comma
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
suffix:semicolon
op_star
id|ed_p
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ohci-&gt;ed_isotail
op_assign
id|edi
suffix:semicolon
macro_line|#ifdef DEBUG
id|ep_print_int_eds
(paren
id|ohci
comma
l_string|&quot;LINK_ISO&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* unlink an ed from one of the HC chains. &n; * just the link to the ed is unlinked.&n; * the link from the ed still points to another operational ed or 0&n; * so the HC can eventually finish the processing of the unlinked ed */
DECL|function|ep_unlink
r_static
r_int
id|ep_unlink
(paren
id|ohci_t
op_star
id|ohci
comma
id|ed_t
op_star
id|ed
)paren
(brace
r_int
id|int_branch
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|inter
suffix:semicolon
r_int
id|interval
suffix:semicolon
id|__u32
op_star
id|ed_p
suffix:semicolon
r_switch
c_cond
(paren
id|ed-&gt;type
)paren
(brace
r_case
id|CTRL
suffix:colon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_eq
l_int|NULL
)paren
(brace
id|writel
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ed-&gt;ed_prev-&gt;hwNextED
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_controltail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BULK
suffix:colon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_eq
l_int|NULL
)paren
(brace
id|writel
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ed-&gt;ed_prev-&gt;hwNextED
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_bulktail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|INT
suffix:colon
id|int_branch
op_assign
id|ed-&gt;int_branch
suffix:semicolon
id|interval
op_assign
id|ed-&gt;int_interval
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ep_rev
(paren
l_int|6
comma
id|interval
)paren
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|ep_rev
(paren
l_int|5
comma
id|i
)paren
op_plus
id|int_branch
)braket
)paren
comma
id|inter
op_assign
l_int|1
suffix:semicolon
(paren
op_star
id|ed_p
op_ne
l_int|0
)paren
op_logical_and
(paren
op_star
id|ed_p
op_ne
id|ed-&gt;hwNextED
)paren
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
comma
id|inter
op_assign
id|ep_rev
(paren
l_int|6
comma
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_eq
id|ed
)paren
(brace
op_star
id|ed_p
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
id|int_branch
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|interval
)paren
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_sub_assign
id|ed-&gt;int_load
suffix:semicolon
macro_line|#ifdef DEBUG
id|ep_print_int_eds
(paren
id|ohci
comma
l_string|&quot;UNLINK_INT&quot;
)paren
suffix:semicolon
macro_line|#endif&t;&t;break;
r_case
id|ISO
suffix:colon
r_if
c_cond
(paren
id|ohci-&gt;ed_isotail
op_eq
id|ed
)paren
id|ohci-&gt;ed_isotail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;hwNextED
op_ne
l_int|0
)paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_ne
l_int|NULL
)paren
(brace
id|ed-&gt;ed_prev-&gt;hwNextED
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
id|inter
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|ep_rev
(paren
l_int|5
comma
id|i
)paren
)braket
)paren
suffix:semicolon
op_star
id|ed_p
op_ne
l_int|0
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
)paren
(brace
id|inter
op_assign
id|ep_rev
(paren
l_int|6
comma
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_eq
id|ed
)paren
(brace
op_star
id|ed_p
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#ifdef DEBUG
id|ep_print_int_eds
(paren
id|ohci
comma
l_string|&quot;UNLINK_ISO&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
id|ed-&gt;state
op_assign
id|ED_UNLINK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* add/reinit an endpoint; this should be done once at the usb_set_configuration command,&n; * but the USB stack is a little bit stateless  so we do it at every transaction&n; * if the state of the ed is ED_NEW then a dummy td is added and the state is changed to ED_UNLINK&n; * in all other cases the state is left unchanged&n; * the ed info fields are setted anyway even though most of them should not change */
DECL|function|ep_add_ed
r_static
id|ed_t
op_star
id|ep_add_ed
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
r_int
id|interval
comma
r_int
id|load
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|td_t
op_star
id|td
suffix:semicolon
id|ed_t
op_star
id|ed_ret
suffix:semicolon
r_volatile
id|ed_t
op_star
id|ed
suffix:semicolon
id|spin_lock
(paren
op_amp
id|usb_ed_lock
)paren
suffix:semicolon
id|ed
op_assign
id|ed_ret
op_assign
op_amp
(paren
id|usb_to_ohci
(paren
id|usb_dev
)paren
op_member_access_from_pointer
id|ed
(braket
(paren
id|usb_pipeendpoint
(paren
id|pipe
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|usb_pipecontrol
(paren
id|pipe
)paren
ques
c_cond
l_int|0
suffix:colon
id|usb_pipeout
(paren
id|pipe
)paren
)paren
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
op_logical_or
(paren
id|ed-&gt;state
op_amp
id|ED_URB_DEL
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* pending delete request */
r_if
c_cond
(paren
id|ed-&gt;state
op_eq
id|ED_NEW
)paren
(brace
id|ed-&gt;hwINFO
op_assign
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
multiline_comment|/* skip ed */
id|OHCI_ALLOC
(paren
id|td
comma
r_sizeof
(paren
op_star
id|td
)paren
)paren
suffix:semicolon
multiline_comment|/* dummy td; end of td list for ed */
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* out of memory */
id|ed-&gt;hwTailP
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|td
)paren
)paren
suffix:semicolon
id|ed-&gt;hwHeadP
op_assign
id|ed-&gt;hwTailP
suffix:semicolon
id|ed-&gt;state
op_assign
id|ED_UNLINK
suffix:semicolon
id|ed-&gt;type
op_assign
id|usb_pipetype
(paren
id|pipe
)paren
suffix:semicolon
id|usb_to_ohci
(paren
id|usb_dev
)paren
op_member_access_from_pointer
id|ed_cnt
op_increment
suffix:semicolon
)brace
id|ohci-&gt;dev
(braket
id|usb_pipedevice
(paren
id|pipe
)paren
)braket
op_assign
id|usb_dev
suffix:semicolon
id|ed-&gt;hwINFO
op_assign
id|cpu_to_le32
(paren
id|usb_pipedevice
(paren
id|pipe
)paren
op_or
id|usb_pipeendpoint
(paren
id|pipe
)paren
op_lshift
l_int|7
op_or
(paren
id|usb_pipeisoc
(paren
id|pipe
)paren
ques
c_cond
l_int|0x8000
suffix:colon
l_int|0
)paren
op_or
(paren
id|usb_pipecontrol
(paren
id|pipe
)paren
ques
c_cond
l_int|0
suffix:colon
(paren
id|usb_pipeout
(paren
id|pipe
)paren
ques
c_cond
l_int|0x800
suffix:colon
l_int|0x1000
)paren
)paren
op_or
id|usb_pipeslow
(paren
id|pipe
)paren
op_lshift
l_int|13
op_or
id|usb_maxpacket
(paren
id|usb_dev
comma
id|pipe
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;type
op_eq
id|INT
op_logical_and
id|ed-&gt;state
op_eq
id|ED_UNLINK
)paren
(brace
id|ed-&gt;int_period
op_assign
id|interval
suffix:semicolon
id|ed-&gt;int_load
op_assign
id|load
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|usb_ed_lock
)paren
suffix:semicolon
r_return
id|ed_ret
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* request the removal of an endpoint&n; * put the ep on the rm_list and request a stop of the bulk or ctrl list &n; * real removal is done at the next start of frame (SOF) hardware interrupt */
DECL|function|ep_rm_ed
r_static
r_void
id|ep_rm_ed
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
id|ed_t
op_star
id|ed
)paren
(brace
r_int
r_int
id|frame
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
op_logical_or
(paren
id|ed-&gt;state
op_amp
id|ED_URB_DEL
)paren
)paren
r_return
suffix:semicolon
id|ed-&gt;hwINFO
op_or_assign
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
multiline_comment|/* enable sof interrupt */
id|frame
op_assign
id|le16_to_cpu
(paren
id|ohci-&gt;hcca.frame_no
)paren
op_amp
l_int|0x1
suffix:semicolon
id|ed-&gt;ed_rm_list
op_assign
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
suffix:semicolon
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
op_assign
id|ed
suffix:semicolon
r_switch
c_cond
(paren
id|ed-&gt;type
)paren
(brace
r_case
id|CTRL
suffix:colon
multiline_comment|/* stop CTRL list */
id|writel
(paren
id|ohci-&gt;hc_control
op_and_assign
op_complement
(paren
l_int|0x01
op_lshift
l_int|4
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BULK
suffix:colon
multiline_comment|/* stop BULK list */
id|writel
(paren
id|ohci-&gt;hc_control
op_and_assign
op_complement
(paren
l_int|0x01
op_lshift
l_int|5
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------------*&n; * TD handling functions&n; *-------------------------------------------------------------------------*/
multiline_comment|/* prepare a TD */
DECL|function|td_fill
r_static
r_void
id|td_fill
(paren
r_int
r_int
id|info
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
id|urb_t
op_star
id|urb
comma
r_int
id|type
comma
r_int
id|index
)paren
(brace
r_volatile
id|td_t
op_star
id|td
comma
op_star
id|td_pt
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|index
op_ge
id|urb_priv-&gt;length
)paren
(brace
id|err
c_func
(paren
l_string|&quot;internal OHCI error: TD index &gt; length&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|td_pt
op_assign
id|urb_priv-&gt;td
(braket
id|index
)braket
suffix:semicolon
multiline_comment|/* fill the old dummy TD */
id|td
op_assign
id|urb_priv-&gt;td
(braket
id|index
)braket
op_assign
(paren
id|td_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|urb_priv-&gt;ed-&gt;hwTailP
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|td-&gt;ed
op_assign
id|urb_priv-&gt;ed
suffix:semicolon
id|td-&gt;index
op_assign
id|index
suffix:semicolon
id|td-&gt;urb
op_assign
id|urb
suffix:semicolon
id|td-&gt;hwINFO
op_assign
id|cpu_to_le32
(paren
id|info
)paren
suffix:semicolon
id|td-&gt;type
op_assign
id|type
suffix:semicolon
r_if
c_cond
(paren
(paren
id|td-&gt;ed-&gt;type
op_amp
l_int|3
)paren
op_eq
id|PIPE_ISOCHRONOUS
)paren
(brace
id|td-&gt;hwCBP
op_assign
id|cpu_to_le32
(paren
(paren
(paren
op_logical_neg
id|data
op_logical_or
op_logical_neg
id|len
)paren
ques
c_cond
l_int|0
suffix:colon
id|virt_to_bus
(paren
id|data
)paren
)paren
op_amp
l_int|0xFFFFF000
)paren
suffix:semicolon
id|td-&gt;ed-&gt;last_iso
op_assign
id|info
op_amp
l_int|0xffff
suffix:semicolon
)brace
r_else
(brace
id|td-&gt;hwCBP
op_assign
id|cpu_to_le32
(paren
(paren
(paren
op_logical_neg
id|data
op_logical_or
op_logical_neg
id|len
)paren
ques
c_cond
l_int|0
suffix:colon
id|virt_to_bus
(paren
id|data
)paren
)paren
)paren
suffix:semicolon
)brace
id|td-&gt;hwBE
op_assign
id|cpu_to_le32
(paren
(paren
op_logical_neg
id|data
op_logical_or
op_logical_neg
id|len
)paren
ques
c_cond
l_int|0
suffix:colon
id|virt_to_bus
(paren
id|data
op_plus
id|len
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|td-&gt;hwNextTD
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|td_pt
)paren
)paren
suffix:semicolon
id|td-&gt;hwPSW
(braket
l_int|0
)braket
op_assign
id|cpu_to_le16
(paren
(paren
id|virt_to_bus
(paren
id|data
)paren
op_amp
l_int|0x0FFF
)paren
op_or
l_int|0xE000
)paren
suffix:semicolon
id|td_pt-&gt;hwNextTD
op_assign
l_int|0
suffix:semicolon
id|td-&gt;ed-&gt;hwTailP
op_assign
id|td-&gt;hwNextTD
suffix:semicolon
id|td-&gt;next_dl_td
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//td_pt;
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* prepare all TDs of a transfer */
DECL|function|td_submit_urb
r_static
r_void
id|td_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_void
op_star
id|ctrl
op_assign
id|urb-&gt;setup_packet
suffix:semicolon
r_void
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|data_len
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|__u32
id|info
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|toggle
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* OHCI handles the DATA-toggles itself, we just use the USB-toggle bits for reseting */
r_if
c_cond
(paren
id|usb_gettoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
)paren
(brace
id|toggle
op_assign
id|TD_T_TOGGLE
suffix:semicolon
)brace
r_else
(brace
id|toggle
op_assign
id|TD_T_DATA0
suffix:semicolon
id|usb_settoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
comma
l_int|1
)paren
suffix:semicolon
)brace
id|urb_priv-&gt;td_cnt
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_BULK
suffix:colon
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_DP_OUT
suffix:colon
id|TD_CC
op_or
id|TD_DP_IN
suffix:semicolon
r_while
c_loop
(paren
id|data_len
OG
l_int|4096
)paren
(brace
id|td_fill
(paren
id|info
op_or
(paren
id|cnt
ques
c_cond
id|TD_T_TOGGLE
suffix:colon
id|toggle
)paren
comma
id|data
comma
l_int|4096
comma
id|urb
comma
(paren
id|cnt
ques
c_cond
l_int|0
suffix:colon
id|ST_ADDR
)paren
op_or
id|ADD_LEN
comma
id|cnt
)paren
suffix:semicolon
id|data
op_add_assign
l_int|4096
suffix:semicolon
id|data_len
op_sub_assign
l_int|4096
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_DP_OUT
suffix:colon
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
suffix:semicolon
id|td_fill
(paren
id|info
op_or
(paren
id|cnt
ques
c_cond
id|TD_T_TOGGLE
suffix:colon
id|toggle
)paren
comma
id|data
comma
id|data_len
comma
id|urb
comma
(paren
id|cnt
ques
c_cond
l_int|0
suffix:colon
id|ST_ADDR
)paren
op_or
id|ADD_LEN
comma
id|cnt
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
id|writel
(paren
id|OHCI_BLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start bulk list */
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|toggle
suffix:colon
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|toggle
suffix:semicolon
id|td_fill
(paren
id|info
comma
id|data
comma
id|data_len
comma
id|urb
comma
id|ST_ADDR
op_or
id|ADD_LEN
comma
id|cnt
op_increment
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_CONTROL
suffix:colon
id|info
op_assign
id|TD_CC
op_or
id|TD_DP_SETUP
op_or
id|TD_T_DATA0
suffix:semicolon
id|td_fill
(paren
id|info
comma
id|ctrl
comma
l_int|8
comma
id|urb
comma
id|ST_ADDR
comma
id|cnt
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_len
OG
l_int|0
)paren
(brace
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_OUT
op_or
id|TD_T_DATA1
suffix:colon
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|TD_T_DATA1
suffix:semicolon
id|td_fill
(paren
id|info
comma
id|data
comma
id|data_len
comma
id|urb
comma
id|ADD_LEN
comma
id|cnt
op_increment
)paren
suffix:semicolon
)brace
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_DP_IN
op_or
id|TD_T_DATA1
suffix:colon
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|TD_T_DATA1
suffix:semicolon
id|td_fill
(paren
id|info
comma
l_int|NULL
comma
l_int|0
comma
id|urb
comma
l_int|0
comma
id|cnt
op_increment
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_CLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start Control list */
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|td_fill
(paren
id|TD_CC
op_or
id|TD_ISO
op_or
(paren
(paren
id|urb-&gt;start_frame
op_plus
id|cnt
)paren
op_amp
l_int|0xffff
)paren
comma
(paren
id|__u8
op_star
)paren
id|data
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|cnt
)braket
dot
id|offset
comma
id|urb-&gt;iso_frame_desc
(braket
id|cnt
)braket
dot
id|length
comma
id|urb
comma
(paren
id|cnt
ques
c_cond
l_int|0
suffix:colon
id|ST_ADDR
)paren
op_or
id|ADD_LEN
comma
id|cnt
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb_priv-&gt;length
op_ne
id|cnt
)paren
id|dbg
c_func
(paren
l_string|&quot;TD LENGTH %d != CNT %d&quot;
comma
id|urb_priv-&gt;length
comma
id|cnt
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*&n; * Done List handling functions&n; *-------------------------------------------------------------------------*/
multiline_comment|/* replies to the request have to be on a FIFO basis so&n; * we reverse the reversed done-list */
DECL|function|dl_reverse_done_list
r_static
id|td_t
op_star
id|dl_reverse_done_list
(paren
id|ohci_t
op_star
id|ohci
)paren
(brace
id|__u32
id|td_list_hc
suffix:semicolon
id|td_t
op_star
id|td_rev
op_assign
l_int|NULL
suffix:semicolon
id|td_t
op_star
id|td_list
op_assign
l_int|NULL
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|td_list_hc
op_assign
id|le32_to_cpup
(paren
op_amp
id|ohci-&gt;hcca.done_head
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
id|ohci-&gt;hcca.done_head
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|td_list_hc
)paren
(brace
id|td_list
op_assign
(paren
id|td_t
op_star
)paren
id|bus_to_virt
(paren
id|td_list_hc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TD_CC_GET
(paren
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwINFO
)paren
)paren
)paren
(brace
id|urb_priv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|td_list-&gt;urb-&gt;hcpriv
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot; USB-error/status: %x : %p&quot;
comma
id|TD_CC_GET
(paren
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwINFO
)paren
)paren
comma
id|td_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td_list-&gt;ed-&gt;hwHeadP
op_amp
id|cpu_to_le32
(paren
l_int|0x1
)paren
)paren
(brace
r_if
c_cond
(paren
id|urb_priv
op_logical_and
(paren
(paren
id|td_list-&gt;index
op_plus
l_int|1
)paren
OL
id|urb_priv-&gt;length
)paren
)paren
(brace
id|td_list-&gt;ed-&gt;hwHeadP
op_assign
(paren
id|urb_priv-&gt;td
(braket
id|urb_priv-&gt;length
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|hwNextTD
op_amp
id|cpu_to_le32
(paren
l_int|0xfffffff0
)paren
)paren
op_or
(paren
id|td_list-&gt;ed-&gt;hwHeadP
op_amp
id|cpu_to_le32
(paren
l_int|0x2
)paren
)paren
suffix:semicolon
id|urb_priv-&gt;td_cnt
op_add_assign
id|urb_priv-&gt;length
op_minus
id|td_list-&gt;index
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|td_list-&gt;ed-&gt;hwHeadP
op_and_assign
id|cpu_to_le32
(paren
l_int|0xfffffff2
)paren
suffix:semicolon
)brace
)brace
id|td_list-&gt;next_dl_td
op_assign
id|td_rev
suffix:semicolon
id|td_rev
op_assign
id|td_list
suffix:semicolon
id|td_list_hc
op_assign
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwNextTD
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|td_list
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* there are some pending requests to remove &n; * - some of the eds (if ed-&gt;state &amp; ED_DEL (set by sohci_free_dev)&n; * - some URBs/TDs if urb_priv-&gt;state == URB_DEL */
DECL|function|dl_del_list
r_static
r_void
id|dl_del_list
(paren
id|ohci_t
op_star
id|ohci
comma
r_int
r_int
id|frame
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ed_t
op_star
id|ed
suffix:semicolon
id|__u32
id|edINFO
suffix:semicolon
id|td_t
op_star
id|td
op_assign
l_int|NULL
comma
op_star
id|td_next
op_assign
l_int|NULL
comma
op_star
id|tdHeadP
op_assign
l_int|NULL
comma
op_star
id|tdTailP
suffix:semicolon
id|__u32
op_star
id|td_p
suffix:semicolon
r_int
id|ctrl
op_assign
l_int|0
comma
id|bulk
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ed
op_assign
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
suffix:semicolon
id|ed
op_ne
l_int|NULL
suffix:semicolon
id|ed
op_assign
id|ed-&gt;ed_rm_list
)paren
(brace
id|tdTailP
op_assign
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwTailP
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|tdHeadP
op_assign
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwHeadP
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|edINFO
op_assign
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwINFO
)paren
suffix:semicolon
id|td_p
op_assign
op_amp
id|ed-&gt;hwHeadP
suffix:semicolon
r_for
c_loop
(paren
id|td
op_assign
id|tdHeadP
suffix:semicolon
id|td
op_ne
id|tdTailP
suffix:semicolon
id|td
op_assign
id|td_next
)paren
(brace
id|urb_t
op_star
id|urb
op_assign
id|td-&gt;urb
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|td-&gt;urb-&gt;hcpriv
suffix:semicolon
id|td_next
op_assign
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|td-&gt;hwNextTD
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|urb_priv-&gt;state
op_eq
id|URB_DEL
)paren
op_logical_or
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
)paren
(brace
op_star
id|td_p
op_assign
id|td-&gt;hwNextTD
op_or
(paren
op_star
id|td_p
op_amp
id|cpu_to_le32
(paren
l_int|0x3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
(paren
id|urb_priv-&gt;td_cnt
)paren
op_eq
id|urb_priv-&gt;length
)paren
(brace
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|td_p
op_assign
op_amp
id|td-&gt;hwNextTD
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
(brace
multiline_comment|/* set by sohci_free_dev */
r_struct
id|ohci_device
op_star
id|dev
op_assign
id|usb_to_ohci
(paren
id|ohci-&gt;dev
(braket
id|edINFO
op_amp
l_int|0x7F
)braket
)paren
suffix:semicolon
id|OHCI_FREE
(paren
id|tdTailP
)paren
suffix:semicolon
multiline_comment|/* free dummy td */
id|ed-&gt;hwINFO
op_assign
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
id|ed-&gt;state
op_assign
id|ED_NEW
suffix:semicolon
multiline_comment|/* if all eds are removed wake up sohci_free_dev */
r_if
c_cond
(paren
(paren
op_logical_neg
op_decrement
id|dev-&gt;ed_cnt
)paren
op_logical_and
id|dev-&gt;wait
)paren
(brace
id|add_wait_queue
(paren
op_amp
id|op_wakeup
comma
id|dev-&gt;wait
)paren
suffix:semicolon
id|wake_up
(paren
op_amp
id|op_wakeup
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|ed-&gt;state
op_and_assign
op_complement
id|ED_URB_DEL
suffix:semicolon
id|ed-&gt;hwINFO
op_and_assign
op_complement
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ed-&gt;type
op_amp
l_int|3
)paren
op_eq
id|CTRL
)paren
id|ctrl
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ed-&gt;type
op_amp
l_int|3
)paren
op_eq
id|BULK
)paren
id|bulk
op_or_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl
)paren
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlcurrent
)paren
suffix:semicolon
multiline_comment|/* reset CTRL list */
r_if
c_cond
(paren
id|bulk
)paren
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkcurrent
)paren
suffix:semicolon
multiline_comment|/* reset BULK list */
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
op_logical_neg
id|frame
)braket
)paren
multiline_comment|/* start CTRL u. BULK list */
id|writel
(paren
id|ohci-&gt;hc_control
op_or_assign
(paren
l_int|0x03
op_lshift
l_int|4
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* td done list */
DECL|function|dl_done_list
r_static
r_void
id|dl_done_list
(paren
id|ohci_t
op_star
id|ohci
comma
id|td_t
op_star
id|td_list
)paren
(brace
id|td_t
op_star
id|td_list_next
op_assign
l_int|NULL
suffix:semicolon
id|ed_t
op_star
id|ed
suffix:semicolon
r_int
id|dlen
op_assign
l_int|0
suffix:semicolon
r_int
id|cc
op_assign
l_int|0
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
id|__u32
id|tdINFO
comma
id|tdBE
comma
id|tdCBP
comma
id|edHeadP
comma
id|edTailP
suffix:semicolon
id|__u16
id|tdPSW
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_while
c_loop
(paren
id|td_list
)paren
(brace
id|td_list_next
op_assign
id|td_list-&gt;next_dl_td
suffix:semicolon
id|urb
op_assign
id|td_list-&gt;urb
suffix:semicolon
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|tdINFO
op_assign
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwINFO
)paren
suffix:semicolon
id|tdBE
op_assign
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwBE
)paren
suffix:semicolon
id|tdCBP
op_assign
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwCBP
)paren
suffix:semicolon
id|ed
op_assign
id|td_list-&gt;ed
suffix:semicolon
r_if
c_cond
(paren
id|td_list-&gt;type
op_amp
id|ST_ADDR
)paren
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|td_list-&gt;type
op_amp
id|ADD_LEN
)paren
(brace
multiline_comment|/* accumulate length of multi td transfers */
r_if
c_cond
(paren
id|tdINFO
op_amp
id|TD_ISO
)paren
(brace
id|tdPSW
op_assign
id|le16_to_cpu
(paren
id|td_list-&gt;hwPSW
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cc
op_assign
(paren
id|tdPSW
op_rshift
l_int|12
)paren
op_amp
l_int|0xF
suffix:semicolon
r_if
c_cond
(paren
id|cc
OL
l_int|0xE
)paren
(brace
r_if
c_cond
(paren
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|dlen
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|td_list-&gt;index
)braket
dot
id|length
suffix:semicolon
)brace
r_else
(brace
id|dlen
op_assign
id|tdPSW
op_amp
l_int|0x3ff
suffix:semicolon
)brace
id|urb-&gt;actual_length
op_add_assign
id|dlen
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|td_list-&gt;index
)braket
dot
id|actual_length
op_assign
id|dlen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
op_logical_and
(paren
id|cc
op_eq
id|TD_DATAUNDERRUN
)paren
)paren
id|cc
op_assign
id|TD_CC_NOERROR
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|td_list-&gt;index
)braket
dot
id|status
op_assign
id|cc_to_error
(braket
id|cc
)braket
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|tdBE
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|td_list-&gt;hwCBP
op_eq
l_int|0
)paren
id|urb-&gt;actual_length
op_assign
id|bus_to_virt
(paren
id|tdBE
)paren
op_minus
id|urb-&gt;transfer_buffer
op_plus
l_int|1
suffix:semicolon
r_else
id|urb-&gt;actual_length
op_assign
id|bus_to_virt
(paren
id|tdCBP
)paren
op_minus
id|urb-&gt;transfer_buffer
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* error code of transfer */
id|cc
op_assign
id|TD_CC_GET
(paren
id|tdINFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cc
op_eq
id|TD_CC_STALL
)paren
(brace
id|usb_endpoint_halt
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
op_logical_and
(paren
id|cc
op_eq
id|TD_DATAUNDERRUN
)paren
)paren
id|cc
op_assign
id|TD_CC_NOERROR
suffix:semicolon
r_if
c_cond
(paren
op_increment
(paren
id|urb_priv-&gt;td_cnt
)paren
op_eq
id|urb_priv-&gt;length
)paren
(brace
r_if
c_cond
(paren
id|urb_priv-&gt;state
op_ne
id|URB_DEL
op_logical_and
op_logical_neg
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
op_logical_and
id|ed-&gt;state
op_ne
id|ED_NEW
)paren
(brace
id|urb-&gt;status
op_assign
id|cc_to_error
(braket
id|cc
)braket
suffix:semicolon
id|sohci_return_urb
(paren
id|urb
)paren
suffix:semicolon
)brace
r_else
(brace
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;state
op_ne
id|ED_NEW
)paren
(brace
id|edHeadP
op_assign
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwHeadP
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
id|edTailP
op_assign
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwTailP
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|edHeadP
op_eq
id|edTailP
)paren
op_logical_and
(paren
id|ed-&gt;state
op_eq
id|ED_OPER
)paren
)paren
(brace
id|ep_unlink
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
)brace
multiline_comment|/* unlink eds if they are not busy */
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|td_list
op_assign
id|td_list_next
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------------*&n; * Virtual Root Hub &n; *-------------------------------------------------------------------------*/
DECL|variable|root_hub_dev_des
r_static
id|__u8
id|root_hub_dev_des
(braket
)braket
op_assign
(brace
l_int|0x12
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x01
comma
multiline_comment|/*  __u8  bDescriptorType; Device */
l_int|0x00
comma
multiline_comment|/*  __u16 bcdUSB; v1.0 */
l_int|0x01
comma
l_int|0x09
comma
multiline_comment|/*  __u8  bDeviceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceProtocol; */
l_int|0x08
comma
multiline_comment|/*  __u8  bMaxPacketSize0; 8 Bytes */
l_int|0x00
comma
multiline_comment|/*  __u16 idVendor; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 idProduct; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 bcdDevice; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u8  iManufacturer; */
l_int|0x02
comma
multiline_comment|/*  __u8  iProduct; */
l_int|0x01
comma
multiline_comment|/*  __u8  iSerialNumber; */
l_int|0x01
multiline_comment|/*  __u8  bNumConfigurations; */
)brace
suffix:semicolon
multiline_comment|/* Configuration descriptor */
DECL|variable|root_hub_config_des
r_static
id|__u8
id|root_hub_config_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x02
comma
multiline_comment|/*  __u8  bDescriptorType; Configuration */
l_int|0x19
comma
multiline_comment|/*  __u16 wTotalLength; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bNumInterfaces; */
l_int|0x01
comma
multiline_comment|/*  __u8  bConfigurationValue; */
l_int|0x00
comma
multiline_comment|/*  __u8  iConfiguration; */
l_int|0x40
comma
multiline_comment|/*  __u8  bmAttributes; &n;                 Bit 7: Bus-powered, 6: Self-powered, 5 Remote-wakwup, 4..0: resvd */
l_int|0x00
comma
multiline_comment|/*  __u8  MaxPower; */
multiline_comment|/* interface */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bLength; */
l_int|0x04
comma
multiline_comment|/*  __u8  if_bDescriptorType; Interface */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceNumber; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bAlternateSetting; */
l_int|0x01
comma
multiline_comment|/*  __u8  if_bNumEndpoints; */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bInterfaceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceProtocol; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_iInterface; */
multiline_comment|/* endpoint */
l_int|0x07
comma
multiline_comment|/*  __u8  ep_bLength; */
l_int|0x05
comma
multiline_comment|/*  __u8  ep_bDescriptorType; Endpoint */
l_int|0x81
comma
multiline_comment|/*  __u8  ep_bEndpointAddress; IN Endpoint 1 */
l_int|0x03
comma
multiline_comment|/*  __u8  ep_bmAttributes; Interrupt */
l_int|0x08
comma
multiline_comment|/*  __u16 ep_wMaxPacketSize; 8 Bytes */
l_int|0x00
comma
l_int|0xff
multiline_comment|/*  __u8  ep_bInterval; 255 ms */
)brace
suffix:semicolon
multiline_comment|/* &n;For OHCI we need just the  2nd Byte, so we &n;don&squot;t need this constant byte-array &n;&n;static __u8 root_hub_hub_des[] =&n;{ &n;&t;0x00,       *  __u8  bLength; *&n;&t;0x29,       *  __u8  bDescriptorType; Hub-descriptor *&n;&t;0x02,       *  __u8  bNbrPorts; *&n;&t;0x00,       * __u16  wHubCharacteristics; *&n;&t;0x00,&n;&t;0x01,       *  __u8  bPwrOn2pwrGood; 2ms * &n; &t;0x00,       *  __u8  bHubContrCurrent; 0 mA *&n;&t;0x00,       *  __u8  DeviceRemovable; *** 8 Ports max *** *&n;&t;0xff        *  __u8  PortPwrCtrlMask; *** 8 ports max *** *&n;};&n;*/
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* prepare Interrupt pipe data; HUB INTERRUPT ENDPOINT */
DECL|function|rh_send_irq
r_static
r_int
id|rh_send_irq
(paren
id|ohci_t
op_star
id|ohci
comma
r_void
op_star
id|rh_data
comma
r_int
id|rh_len
)paren
(brace
r_int
id|num_ports
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|len
suffix:semicolon
id|__u8
id|data
(braket
l_int|8
)braket
suffix:semicolon
id|num_ports
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_amp
l_int|0xff
suffix:semicolon
op_star
(paren
id|__u8
op_star
)paren
id|data
op_assign
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
op_amp
l_int|0x00030000
)paren
OG
l_int|0
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|ret
op_assign
op_star
(paren
id|__u8
op_star
)paren
id|data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
op_or_assign
(paren
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|i
)braket
)paren
op_amp
l_int|0x001f0000
)paren
OG
l_int|0
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_lshift
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|8
)paren
suffix:semicolon
id|ret
op_add_assign
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
suffix:semicolon
)brace
id|len
op_assign
id|i
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
(brace
id|memcpy
(paren
id|rh_data
comma
id|data
comma
id|min
(paren
id|len
comma
id|min
(paren
id|rh_len
comma
r_sizeof
(paren
id|data
)paren
)paren
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Virtual Root Hub INTs are polled by this timer every &quot;intervall&quot; ms */
DECL|function|rh_int_timer_do
r_static
r_void
id|rh_int_timer_do
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
id|len
suffix:semicolon
id|urb_t
op_star
id|urb
op_assign
(paren
id|urb_t
op_star
)paren
id|ptr
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;disabled
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;rh.send
)paren
(brace
id|len
op_assign
id|rh_send_irq
(paren
id|ohci
comma
id|urb-&gt;transfer_buffer
comma
id|urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;RET-t(rh)&quot;
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
id|rh_init_int_timer
(paren
id|urb
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Root Hub INTs are polled by this timer */
DECL|function|rh_init_int_timer
r_static
r_int
id|rh_init_int_timer
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|ohci-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|init_timer
(paren
op_amp
id|ohci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
id|ohci-&gt;rh.rh_int_timer.function
op_assign
id|rh_int_timer_do
suffix:semicolon
id|ohci-&gt;rh.rh_int_timer.data
op_assign
(paren
r_int
r_int
)paren
id|urb
suffix:semicolon
id|ohci-&gt;rh.rh_int_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
(paren
id|urb-&gt;interval
OL
l_int|30
ques
c_cond
l_int|30
suffix:colon
id|urb-&gt;interval
)paren
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
(paren
op_amp
id|ohci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|OK
mdefine_line|#define OK(x) &t;&t;&t;&t;len = (x); break
DECL|macro|WR_RH_STAT
mdefine_line|#define WR_RH_STAT(x) &t;&t;writel((x), &amp;ohci-&gt;regs-&gt;roothub.status)
DECL|macro|WR_RH_PORTSTAT
mdefine_line|#define WR_RH_PORTSTAT(x) &t;writel((x), &amp;ohci-&gt;regs-&gt;roothub.portstatus[wIndex-1])
DECL|macro|RD_RH_STAT
mdefine_line|#define RD_RH_STAT&t;&t;&t;readl(&amp;ohci-&gt;regs-&gt;roothub.status)
DECL|macro|RD_RH_PORTSTAT
mdefine_line|#define RD_RH_PORTSTAT&t;&t;readl(&amp;ohci-&gt;regs-&gt;roothub.portstatus[wIndex-1])
multiline_comment|/* request to virtual root hub */
DECL|function|rh_submit_urb
r_static
r_int
id|rh_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_struct
id|usb_device
op_star
id|usb_dev
op_assign
id|urb-&gt;dev
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
id|devrequest
op_star
id|cmd
op_assign
(paren
id|devrequest
op_star
)paren
id|urb-&gt;setup_packet
suffix:semicolon
r_void
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|leni
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|status
op_assign
id|TD_CC_NOERROR
suffix:semicolon
id|__u32
id|datab
(braket
l_int|4
)braket
suffix:semicolon
id|__u8
op_star
id|data_buf
op_assign
(paren
id|__u8
op_star
)paren
id|datab
suffix:semicolon
id|__u16
id|bmRType_bReq
suffix:semicolon
id|__u16
id|wValue
suffix:semicolon
id|__u16
id|wIndex
suffix:semicolon
id|__u16
id|wLength
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipeint
c_func
(paren
id|pipe
)paren
)paren
(brace
id|ohci-&gt;rh.urb
op_assign
id|urb
suffix:semicolon
id|ohci-&gt;rh.send
op_assign
l_int|1
suffix:semicolon
id|ohci-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|rh_init_int_timer
c_func
(paren
id|urb
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
id|cc_to_error
(braket
id|TD_CC_NOERROR
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bmRType_bReq
op_assign
id|cmd-&gt;requesttype
op_or
(paren
id|cmd-&gt;request
op_lshift
l_int|8
)paren
suffix:semicolon
id|wValue
op_assign
id|le16_to_cpu
(paren
id|cmd-&gt;value
)paren
suffix:semicolon
id|wIndex
op_assign
id|le16_to_cpu
(paren
id|cmd-&gt;index
)paren
suffix:semicolon
id|wLength
op_assign
id|le16_to_cpu
(paren
id|cmd-&gt;length
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|bmRType_bReq
)paren
(brace
multiline_comment|/* Request Destination:&n;&t;   without flags: Device, &n;&t;   RH_INTERFACE: interface, &n;&t;   RH_ENDPOINT: endpoint,&n;&t;   RH_CLASS means HUB here, &n;&t;   RH_OTHER | RH_CLASS  almost ever means HUB_PORT here &n;&t;*/
r_case
id|RH_GET_STATUS
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_INTERFACE
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_ENDPOINT
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u32
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le32
(paren
id|RD_RH_STAT
op_amp
l_int|0x7fff7fff
)paren
suffix:semicolon
id|OK
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u32
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le32
(paren
id|RD_RH_PORTSTAT
)paren
suffix:semicolon
id|OK
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_ENDPOINT
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_ENDPOINT_STALL
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|RH_C_HUB_LOCAL_POWER
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_HUB_OVER_CURRENT
)paren
suffix:colon
id|WR_RH_STAT
c_func
(paren
id|RH_HS_OCIC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_CCS
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_POCI
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_LSDA
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_CONNECTION
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_CSC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_ENABLE
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PESC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_SUSPEND
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PSSC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_OVER_CURRENT
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_OCIC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_RESET
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PRSC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PSS
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_RESET
)paren
suffix:colon
multiline_comment|/* BUG IN HUP CODE *********/
r_if
c_cond
(paren
(paren
id|RD_RH_PORTSTAT
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PRS
)paren
suffix:semicolon
)brace
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PPS
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
multiline_comment|/* BUG IN HUP CODE *********/
r_if
c_cond
(paren
(paren
id|RD_RH_PORTSTAT
op_amp
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PES
)paren
suffix:semicolon
)brace
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_ADDRESS
suffix:colon
id|ohci-&gt;rh.devnum
op_assign
id|wValue
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
suffix:colon
r_switch
c_cond
(paren
(paren
id|wValue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
(brace
r_case
(paren
l_int|0x01
)paren
suffix:colon
multiline_comment|/* device descriptor */
id|len
op_assign
id|min
(paren
id|leni
comma
id|min
(paren
r_sizeof
(paren
id|root_hub_dev_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|data_buf
op_assign
id|root_hub_dev_des
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x02
)paren
suffix:colon
multiline_comment|/* configuration descriptor */
id|len
op_assign
id|min
(paren
id|leni
comma
id|min
(paren
r_sizeof
(paren
id|root_hub_config_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|data_buf
op_assign
id|root_hub_config_des
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x03
)paren
suffix:colon
multiline_comment|/* string descriptors */
id|len
op_assign
id|usb_root_hub_string
(paren
id|wValue
op_amp
l_int|0xff
comma
(paren
r_int
)paren
id|ohci-&gt;regs
comma
l_string|&quot;OHCI&quot;
comma
id|data
comma
id|wLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|data_buf
op_assign
id|data
suffix:semicolon
id|OK
(paren
id|min
(paren
id|leni
comma
id|len
)paren
)paren
suffix:semicolon
)brace
singleline_comment|// else fallthrough
r_default
suffix:colon
id|status
op_assign
id|TD_CC_STALL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
op_or
id|RH_CLASS
suffix:colon
(brace
id|__u32
id|temp
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
suffix:semicolon
id|data_buf
(braket
l_int|0
)braket
op_assign
l_int|9
suffix:semicolon
singleline_comment|// min length;
id|data_buf
(braket
l_int|1
)braket
op_assign
l_int|0x29
suffix:semicolon
id|data_buf
(braket
l_int|2
)braket
op_assign
id|temp
op_amp
id|RH_A_NDP
suffix:semicolon
id|data_buf
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|RH_A_PSM
)paren
multiline_comment|/* per-port power switching? */
id|data_buf
(braket
l_int|3
)braket
op_or_assign
l_int|0x1
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|RH_A_NOCP
)paren
multiline_comment|/* no overcurrent reporting? */
id|data_buf
(braket
l_int|3
)braket
op_or_assign
l_int|0x10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|temp
op_amp
id|RH_A_OCPM
)paren
multiline_comment|/* per-port overcurrent reporting? */
id|data_buf
(braket
l_int|3
)braket
op_or_assign
l_int|0x8
suffix:semicolon
id|datab
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|data_buf
(braket
l_int|5
)braket
op_assign
(paren
id|temp
op_amp
id|RH_A_POTPGT
)paren
op_rshift
l_int|24
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.b
)paren
suffix:semicolon
id|data_buf
(braket
l_int|7
)braket
op_assign
id|temp
op_amp
id|RH_B_DR
suffix:semicolon
r_if
c_cond
(paren
id|data_buf
(braket
l_int|2
)braket
OL
l_int|7
)paren
(brace
id|data_buf
(braket
l_int|8
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
id|data_buf
(braket
l_int|0
)braket
op_add_assign
l_int|2
suffix:semicolon
id|data_buf
(braket
l_int|8
)braket
op_assign
(paren
id|temp
op_amp
id|RH_B_DR
)paren
op_rshift
l_int|8
suffix:semicolon
id|data_buf
(braket
l_int|10
)braket
op_assign
id|data_buf
(braket
l_int|9
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
id|len
op_assign
id|min
(paren
id|leni
comma
id|min
(paren
id|data_buf
(braket
l_int|0
)braket
comma
id|wLength
)paren
)paren
suffix:semicolon
id|OK
(paren
id|len
)paren
suffix:semicolon
)brace
r_case
id|RH_GET_CONFIGURATION
suffix:colon
op_star
(paren
id|__u8
op_star
)paren
id|data_buf
op_assign
l_int|0x01
suffix:semicolon
id|OK
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|RH_SET_CONFIGURATION
suffix:colon
id|WR_RH_STAT
(paren
l_int|0x10000
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
id|TD_CC_STALL
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;USB HC roothubstat1: %x&quot;
comma
id|readl
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|0
)braket
)paren
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;USB HC roothubstat2: %x&quot;
comma
id|readl
(paren
op_amp
(paren
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
l_int|1
)braket
)paren
)paren
)paren
suffix:semicolon
id|len
op_assign
id|min
c_func
(paren
id|len
comma
id|leni
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ne
id|data_buf
)paren
id|memcpy
(paren
id|data
comma
id|data_buf
comma
id|len
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
id|urb-&gt;status
op_assign
id|cc_to_error
(braket
id|status
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;RET(rh)&quot;
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|rh_unlink_urb
r_static
r_int
id|rh_unlink_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|ohci-&gt;rh.send
op_assign
l_int|0
suffix:semicolon
id|del_timer
(paren
op_amp
id|ohci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*&n; * HC functions&n; *-------------------------------------------------------------------------*/
multiline_comment|/* reset the HC not the BUS */
DECL|function|hc_reset
r_static
r_void
id|hc_reset
(paren
id|ohci_t
op_star
id|ohci
)paren
(brace
r_int
id|timeout
op_assign
l_int|30
suffix:semicolon
r_int
id|smm_timeout
op_assign
l_int|50
suffix:semicolon
multiline_comment|/* 0,5 sec */
r_if
c_cond
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
l_int|0x100
)paren
(brace
multiline_comment|/* SMM owns the HC */
id|writel
(paren
l_int|0x08
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* request ownership */
id|dbg
c_func
(paren
l_string|&quot;USB HC TakeOver from SMM&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
l_int|0x100
)paren
(brace
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|smm_timeout
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;USB HC TakeOver failed!&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|writel
(paren
(paren
l_int|1
op_lshift
l_int|31
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;intrdisable
)paren
suffix:semicolon
multiline_comment|/* Disable HC interrupts */
id|dbg
c_func
(paren
l_string|&quot;USB HC reset_hc: %x ;&quot;
comma
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
)paren
suffix:semicolon
multiline_comment|/* this seems to be needed for the lucent controller on powerbooks.. */
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* Move USB to reset state */
id|writel
(paren
l_int|1
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* HC Reset */
r_while
c_loop
(paren
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
op_amp
l_int|0x01
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* 10us Reset */
r_if
c_cond
(paren
op_decrement
id|timeout
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;USB HC reset timed out!&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|udelay
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|ohci-&gt;disabled
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Start an OHCI controller, set the BUS operational&n; * enable interrupts &n; * connect the virtual root hub */
DECL|function|hc_start
r_static
r_int
id|hc_start
(paren
id|ohci_t
op_star
id|ohci
)paren
(brace
r_int
r_int
id|mask
suffix:semicolon
r_int
r_int
id|fminterval
suffix:semicolon
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* Tell the controller where the control and bulk lists are&n;&t; * The lists are empty now. */
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
id|writel
(paren
id|virt_to_bus
(paren
op_amp
id|ohci-&gt;hcca
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;hcca
)paren
suffix:semicolon
multiline_comment|/* a reset clears this */
id|fminterval
op_assign
l_int|0x2edf
suffix:semicolon
id|writel
(paren
(paren
id|fminterval
op_star
l_int|9
)paren
op_div
l_int|10
comma
op_amp
id|ohci-&gt;regs-&gt;periodicstart
)paren
suffix:semicolon
id|fminterval
op_or_assign
(paren
(paren
(paren
(paren
id|fminterval
op_minus
l_int|210
)paren
op_star
l_int|6
)paren
op_div
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|writel
(paren
id|fminterval
comma
op_amp
id|ohci-&gt;regs-&gt;fminterval
)paren
suffix:semicolon
id|writel
(paren
l_int|0x628
comma
op_amp
id|ohci-&gt;regs-&gt;lsthresh
)paren
suffix:semicolon
multiline_comment|/* Choose the interrupts we care about now, others later on demand */
id|mask
op_assign
id|OHCI_INTR_MIE
op_or
id|OHCI_INTR_UE
op_or
id|OHCI_INTR_WDH
op_or
id|OHCI_INTR_SO
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
l_int|0xBF
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* USB Operational */
id|writel
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
id|writel
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
macro_line|#ifdef OHCI_USE_NPS
id|writel
(paren
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_or
l_int|0x200
)paren
op_amp
op_complement
l_int|0x100
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
suffix:semicolon
id|writel
(paren
l_int|0x10000
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
suffix:semicolon
id|mdelay
(paren
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_rshift
l_int|23
)paren
op_amp
l_int|0x1fe
)paren
suffix:semicolon
macro_line|#endif /* OHCI_USE_NPS */
multiline_comment|/* connect the virtual root hub */
id|usb_dev
op_assign
id|usb_alloc_dev
(paren
l_int|NULL
comma
id|ohci-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_dev
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|dev
op_assign
id|usb_to_ohci
(paren
id|usb_dev
)paren
suffix:semicolon
id|ohci-&gt;bus-&gt;root_hub
op_assign
id|usb_dev
suffix:semicolon
id|usb_connect
(paren
id|usb_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_new_device
(paren
id|usb_dev
)paren
op_ne
l_int|0
)paren
(brace
id|usb_free_dev
(paren
id|usb_dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* an interrupt happens */
DECL|function|hc_interrupt
r_static
r_void
id|hc_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|__ohci
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|__ohci
suffix:semicolon
r_struct
id|ohci_regs
op_star
id|regs
op_assign
id|ohci-&gt;regs
suffix:semicolon
r_int
id|ints
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ohci-&gt;hcca.done_head
op_ne
l_int|0
)paren
op_logical_and
op_logical_neg
(paren
id|le32_to_cpup
(paren
op_amp
id|ohci-&gt;hcca.done_head
)paren
op_amp
l_int|0x01
)paren
)paren
(brace
id|ints
op_assign
id|OHCI_INTR_WDH
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|ints
op_assign
(paren
id|readl
(paren
op_amp
id|regs-&gt;intrstatus
)paren
op_amp
id|readl
(paren
op_amp
id|regs-&gt;intrenable
)paren
)paren
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Interrupt: %x frame: %x&quot;
comma
id|ints
comma
id|le16_to_cpu
(paren
id|ohci-&gt;hcca.frame_no
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_UE
)paren
(brace
id|ohci-&gt;disabled
op_increment
suffix:semicolon
id|err
(paren
l_string|&quot;OHCI Unrecoverable Error, controller disabled&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_WDH
)paren
(brace
id|writel
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
id|dl_done_list
(paren
id|ohci
comma
id|dl_reverse_done_list
(paren
id|ohci
)paren
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_SO
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;USB Schedule overrun&quot;
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SO
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_SF
)paren
(brace
r_int
r_int
id|frame
op_assign
id|le16_to_cpu
(paren
id|ohci-&gt;hcca.frame_no
)paren
op_amp
l_int|1
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_rm_list
(braket
op_logical_neg
id|frame
)braket
op_ne
l_int|NULL
)paren
(brace
id|dl_del_list
(paren
id|ohci
comma
op_logical_neg
id|frame
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
op_ne
l_int|NULL
)paren
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
id|writel
(paren
id|ints
comma
op_amp
id|regs-&gt;intrstatus
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_MIE
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* allocate OHCI */
DECL|function|hc_alloc_ohci
r_static
id|ohci_t
op_star
id|hc_alloc_ohci
(paren
r_void
op_star
id|mem_base
)paren
(brace
r_int
id|i
suffix:semicolon
id|ohci_t
op_star
id|ohci
suffix:semicolon
r_struct
id|usb_bus
op_star
id|bus
suffix:semicolon
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|__get_free_pages
(paren
id|GFP_KERNEL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
(paren
id|ohci
comma
l_int|0
comma
r_sizeof
(paren
id|ohci_t
)paren
)paren
suffix:semicolon
id|ohci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|ohci-&gt;regs
op_assign
id|mem_base
suffix:semicolon
multiline_comment|/* for load ballancing of the interrupt branches */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTS
suffix:semicolon
id|i
op_increment
)paren
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTS
suffix:semicolon
id|i
op_increment
)paren
id|ohci-&gt;hcca.int_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* end of control and bulk lists */
id|ohci-&gt;ed_isotail
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_controltail
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_bulktail
op_assign
l_int|NULL
suffix:semicolon
id|bus
op_assign
id|usb_alloc_bus
(paren
op_amp
id|sohci_device_operations
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|free_pages
(paren
(paren
r_int
r_int
)paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ohci-&gt;bus
op_assign
id|bus
suffix:semicolon
id|bus-&gt;hcpriv
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
r_return
id|ohci
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* De-allocate all resources.. */
DECL|function|hc_release_ohci
r_static
r_void
id|hc_release_ohci
(paren
id|ohci_t
op_star
id|ohci
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;USB HC release ohci&quot;
)paren
suffix:semicolon
multiline_comment|/* disconnect all devices */
r_if
c_cond
(paren
id|ohci-&gt;bus-&gt;root_hub
)paren
id|usb_disconnect
(paren
op_amp
id|ohci-&gt;bus-&gt;root_hub
)paren
suffix:semicolon
id|hc_reset
(paren
id|ohci
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_USB_RESET
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;irq
op_ge
l_int|0
)paren
(brace
id|free_irq
(paren
id|ohci-&gt;irq
comma
id|ohci
)paren
suffix:semicolon
id|ohci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|usb_deregister_bus
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
id|usb_free_bus
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* unmap the IO address space */
id|iounmap
(paren
id|ohci-&gt;regs
)paren
suffix:semicolon
id|free_pages
(paren
(paren
r_int
r_int
)paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Increment the module usage count, start the control thread and&n; * return success. */
DECL|function|hc_found_ohci
r_static
r_int
id|hc_found_ohci
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|irq
comma
r_void
op_star
id|mem_base
)paren
(brace
id|ohci_t
op_star
id|ohci
suffix:semicolon
r_char
id|buf
(braket
l_int|8
)braket
comma
op_star
id|bufp
op_assign
id|buf
suffix:semicolon
macro_line|#ifndef __sparc__
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&quot;
comma
id|irq
)paren
suffix:semicolon
macro_line|#else
id|bufp
op_assign
id|__irq_itoa
c_func
(paren
id|irq
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
id|__FILE__
l_string|&quot;: USB OHCI at membase 0x%lx, IRQ %s&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|mem_base
comma
id|bufp
)paren
suffix:semicolon
id|ohci
op_assign
id|hc_alloc_ohci
(paren
id|mem_base
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|INIT_LIST_HEAD
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
comma
op_amp
id|ohci_hcd_list
)paren
suffix:semicolon
id|hc_reset
(paren
id|ohci
)paren
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
id|OHCI_USB_RESET
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
id|usb_register_bus
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|irq
comma
id|hc_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;ohci-usb&quot;
comma
id|ohci
)paren
op_eq
l_int|0
)paren
(brace
r_struct
id|pm_dev
op_star
id|pmdev
suffix:semicolon
id|ohci-&gt;irq
op_assign
id|irq
suffix:semicolon
id|hc_start
(paren
id|ohci
)paren
suffix:semicolon
id|pmdev
op_assign
id|pm_register
(paren
id|PM_PCI_DEV
comma
id|PM_PCI_ID
c_func
(paren
id|dev
)paren
comma
id|handle_pm_event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmdev
)paren
id|pmdev-&gt;data
op_assign
id|ohci
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|err
c_func
(paren
l_string|&quot;request interrupt %d failed&quot;
comma
id|irq
)paren
suffix:semicolon
id|hc_release_ohci
(paren
id|ohci
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|hc_start_ohci
r_static
r_int
id|hc_start_ohci
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
r_int
id|mem_base
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
id|mem_base
op_assign
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#else
id|u16
id|cmd
suffix:semicolon
id|mem_base
op_assign
id|dev-&gt;base_address
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|mem_base
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|mem_base
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
multiline_comment|/* Some Mac firmware will switch memory response off */
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cmd
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|cmd
op_or
id|PCI_COMMAND_MEMORY
)paren
suffix:semicolon
macro_line|#endif
id|pci_set_master
(paren
id|dev
)paren
suffix:semicolon
id|mem_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap_nocache
(paren
id|mem_base
comma
l_int|4096
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_base
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error mapping OHCI memory&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|hc_found_ohci
(paren
id|dev
comma
id|dev-&gt;irq
comma
(paren
r_void
op_star
)paren
id|mem_base
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef CONFIG_PMAC_PBOOK
multiline_comment|/* On Powerbooks, put the controller into suspend mode when going&n; * to sleep, and do a resume when waking up. */
DECL|function|ohci_sleep_notify
r_static
r_int
id|ohci_sleep_notify
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
(brace
r_struct
id|list_head
op_star
id|ohci_l
suffix:semicolon
id|ohci_t
op_star
id|ohci
suffix:semicolon
r_for
c_loop
(paren
id|ohci_l
op_assign
id|ohci_hcd_list.next
suffix:semicolon
id|ohci_l
op_ne
op_amp
id|ohci_hcd_list
suffix:semicolon
id|ohci_l
op_assign
id|ohci_l-&gt;next
)paren
(brace
id|ohci
op_assign
id|list_entry
(paren
id|ohci_l
comma
id|ohci_t
comma
id|ohci_hcd_list
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|when
)paren
(brace
r_case
id|PBOOK_SLEEP_NOW
suffix:colon
id|disable_irq
(paren
id|ohci-&gt;irq
)paren
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
id|OHCI_USB_SUSPEND
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_WAKE
suffix:colon
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
id|OHCI_USB_RESUME
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|20
)paren
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
l_int|0xBF
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|enable_irq
(paren
id|ohci-&gt;irq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
)brace
DECL|variable|ohci_sleep_notifier
r_static
r_struct
id|pmu_sleep_notifier
id|ohci_sleep_notifier
op_assign
(brace
id|ohci_sleep_notify
comma
id|SLEEP_LEVEL_MISC
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|handle_pm_event
r_static
r_int
id|handle_pm_event
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|dev-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|ohci
)paren
(brace
r_switch
c_cond
(paren
id|rqst
)paren
(brace
r_case
id|PM_SUSPEND
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;USB-Bus suspend: %p&quot;
comma
id|ohci
)paren
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
l_int|0xFF
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PM_RESUME
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;USB-Bus resume: %p&quot;
comma
id|ohci
)paren
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
l_int|0x7F
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|20
)paren
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
l_int|0xBF
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|PCI_CLASS_SERIAL_USB_OHCI
mdefine_line|#define PCI_CLASS_SERIAL_USB_OHCI 0x0C0310
DECL|function|ohci_hcd_init
r_int
id|ohci_hcd_init
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_class
(paren
id|PCI_CLASS_SERIAL_USB_OHCI
comma
id|dev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|hc_start_ohci
c_func
(paren
id|dev
)paren
op_ge
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_register_sleep_notifier
(paren
op_amp
id|ohci_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif  
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
(paren
r_void
)paren
(brace
r_return
id|ohci_hcd_init
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|cleanup_module
r_void
id|cleanup_module
(paren
r_void
)paren
(brace
id|ohci_t
op_star
id|ohci
suffix:semicolon
id|pm_unregister_all
(paren
id|handle_pm_event
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_unregister_sleep_notifier
(paren
op_amp
id|ohci_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif  
r_while
c_loop
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|ohci_hcd_list
)paren
)paren
(brace
id|ohci
op_assign
id|list_entry
(paren
id|ohci_hcd_list.next
comma
id|ohci_t
comma
id|ohci_hcd_list
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
)paren
suffix:semicolon
id|hc_release_ohci
(paren
id|ohci
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif 
singleline_comment|//MODULE
eof
