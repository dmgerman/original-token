multiline_comment|/*&n; * URB OHCI HCD (Host Controller Driver) for USB.&n; *&n; * (C) Copyright 1999 Roman Weissgaerber &lt;weissg@vienna.at&gt;&n; * (C) Copyright 2000 David Brownell &lt;david-b@pacbell.net&gt;&n; * &n; * [ Initialisation is based on Linus&squot;  ]&n; * [ uhci code and gregs ohci fragments ]&n; * [ (C) Copyright 1999 Linus Torvalds  ]&n; * [ (C) Copyright 1999 Gregory P. Smith]&n; * &n; * &n; * History:&n; * &n; * 2000/09/26 fixed races in removing the private portion of the urb&n; * 2000/09/07 disable bulk and control lists when unlinking the last&n; *&t;endpoint descriptor in order to avoid unrecoverable errors on&n; *&t;the Lucent chips.&n; * 2000/08/29 use bandwidth claiming hooks (thanks Randy!), fix some&n; *&t;urb unlink probs, indentation fixes&n; * 2000/08/11 various oops fixes mostly affecting iso and cleanup from&n; *&t;device unplugs.&n; * 2000/06/28 use PCI hotplug framework, for better power management&n; *&t;and for Cardbus support (David Brownell)&n; * 2000/earlier:  fixes for NEC/Lucent chips; suspend/resume handling&n; *&t;when the controller loses power; handle UE; cleanup; ...&n; *&n; * v5.2 1999/12/07 URB 3rd preview, &n; * v5.1 1999/11/30 URB 2nd preview, cpia, (usb-scsi)&n; * v5.0 1999/11/22 URB Technical preview, Paul Mackerras powerbook susp/resume &n; * &t;i386: HUB, Keyboard, Mouse, Printer &n; *&n; * v4.3 1999/10/27 multiple HCs, bulk_request&n; * v4.2 1999/09/05 ISO API alpha, new dev alloc, neg Error-codes&n; * v4.1 1999/08/27 Randy Dunlap&squot;s - ISO API first impl.&n; * v4.0 1999/08/18 &n; * v3.0 1999/06/25 &n; * v2.1 1999/05/09  code clean up&n; * v2.0 1999/05/04 &n; * v1.0 1999/04/27 initial release&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;  /* for in_interrupt() */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
DECL|macro|OHCI_USE_NPS
mdefine_line|#define OHCI_USE_NPS&t;&t;
singleline_comment|// force NoPowerSwitching mode
singleline_comment|// #define OHCI_VERBOSE_DEBUG&t;/* not always helpful */
singleline_comment|// #define OHCI_MEM_SLAB
singleline_comment|// #define OHCI_MEM_FLAGS&t;SLAB_POISON&t;/* no redzones; see mm/slab.c */
macro_line|#include &quot;usb-ohci.h&quot;
macro_line|#ifdef CONFIG_PMAC_PBOOK
multiline_comment|/* All this PMAC_PBOOK stuff should disappear when those&n; * platforms fully support the 2.4 kernel PCI APIs.&n; */
macro_line|#include &lt;linux/adb.h&gt;
macro_line|#include &lt;linux/pmu.h&gt;
macro_line|#ifndef CONFIG_PM
DECL|macro|CONFIG_PM
mdefine_line|#define CONFIG_PM
macro_line|#endif
macro_line|#endif
multiline_comment|/* For initializing controller (mask in an HCFS mode too) */
DECL|macro|OHCI_CONTROL_INIT
mdefine_line|#define&t;OHCI_CONTROL_INIT &bslash;&n;&t;(OHCI_CTRL_CBSR &amp; 0x3) | OHCI_CTRL_IE | OHCI_CTRL_PLE
DECL|macro|OHCI_UNLINK_TIMEOUT
mdefine_line|#define OHCI_UNLINK_TIMEOUT&t;(HZ / 10)
r_static
id|LIST_HEAD
(paren
id|ohci_hcd_list
)paren
suffix:semicolon
DECL|variable|usb_ed_lock
r_static
id|spinlock_t
id|usb_ed_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*&n; * URB support functions &n; *-------------------------------------------------------------------------*/
multiline_comment|/* free HCD-private data associated with this URB */
DECL|function|urb_free_priv
r_static
r_void
id|urb_free_priv
(paren
r_struct
id|ohci
op_star
id|hc
comma
id|urb_priv_t
op_star
id|urb_priv
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb_priv-&gt;length
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|urb_priv-&gt;td
(braket
id|i
)braket
)paren
(brace
id|td_free
(paren
id|hc
comma
id|urb_priv-&gt;td
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|kfree
(paren
id|urb_priv
)paren
suffix:semicolon
)brace
DECL|function|urb_rm_priv_locked
r_static
r_void
id|urb_rm_priv_locked
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|urb_priv
)paren
(brace
id|urb-&gt;hcpriv
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Release int/iso bandwidth */
r_if
c_cond
(paren
id|urb-&gt;bandwidth
)paren
(brace
r_switch
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_INTERRUPT
suffix:colon
id|usb_release_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
id|usb_release_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
id|urb_free_priv
(paren
(paren
r_struct
id|ohci
op_star
)paren
id|urb-&gt;dev-&gt;bus
comma
id|urb_priv
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|urb_rm_priv
r_static
r_void
id|urb_rm_priv
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|urb_rm_priv_locked
(paren
id|urb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef DEBUG
r_static
r_int
id|sohci_get_current_frame_number
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* debug| print the main components of an URB     &n; * small: 0) header + data packets 1) just header */
DECL|function|urb_print
r_static
r_void
id|urb_print
(paren
id|urb_t
op_star
id|urb
comma
r_char
op_star
id|str
comma
r_int
id|small
)paren
(brace
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;dev
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s URB: no dev&quot;
comma
id|str
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifndef&t;OHCI_VERBOSE_DEBUG
r_if
c_cond
(paren
id|urb-&gt;status
op_ne
l_int|0
)paren
macro_line|#endif
id|dbg
c_func
(paren
l_string|&quot;%s URB:[%4x] dev:%2d,ep:%2d-%c,type:%s,flags:%4x,len:%d/%d,stat:%d(%x)&quot;
comma
id|str
comma
id|sohci_get_current_frame_number
(paren
id|urb-&gt;dev
)paren
comma
id|usb_pipedevice
(paren
id|pipe
)paren
comma
id|usb_pipeendpoint
(paren
id|pipe
)paren
comma
id|usb_pipeout
(paren
id|pipe
)paren
ques
c_cond
l_char|&squot;O&squot;
suffix:colon
l_char|&squot;I&squot;
comma
id|usb_pipetype
(paren
id|pipe
)paren
OL
l_int|2
ques
c_cond
(paren
id|usb_pipeint
(paren
id|pipe
)paren
ques
c_cond
l_string|&quot;INTR&quot;
suffix:colon
l_string|&quot;ISOC&quot;
)paren
suffix:colon
(paren
id|usb_pipecontrol
(paren
id|pipe
)paren
ques
c_cond
l_string|&quot;CTRL&quot;
suffix:colon
l_string|&quot;BULK&quot;
)paren
comma
id|urb-&gt;transfer_flags
comma
id|urb-&gt;actual_length
comma
id|urb-&gt;transfer_buffer_length
comma
id|urb-&gt;status
comma
id|urb-&gt;status
)paren
suffix:semicolon
macro_line|#ifdef&t;OHCI_VERBOSE_DEBUG
r_if
c_cond
(paren
op_logical_neg
id|small
)paren
(brace
r_int
id|i
comma
id|len
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipecontrol
(paren
id|pipe
)paren
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: cmd(8):&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|urb-&gt;setup_packet
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer_length
OG
l_int|0
op_logical_and
id|urb-&gt;transfer_buffer
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: data(%d/%d):&quot;
comma
id|urb-&gt;actual_length
comma
id|urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
id|len
op_assign
id|usb_pipeout
(paren
id|pipe
)paren
ques
c_cond
id|urb-&gt;transfer_buffer_length
suffix:colon
id|urb-&gt;actual_length
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
op_logical_and
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
l_string|&quot; %02x&quot;
comma
(paren
(paren
id|__u8
op_star
)paren
id|urb-&gt;transfer_buffer
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%s stat:%d&bslash;n&quot;
comma
id|i
OL
id|len
ques
c_cond
l_string|&quot;...&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
multiline_comment|/* just for debugging; prints non-empty branches of the int ed tree inclusive iso eds*/
DECL|function|ep_print_int_eds
r_void
id|ep_print_int_eds
(paren
id|ohci_t
op_star
id|ohci
comma
r_char
op_star
id|str
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|__u32
op_star
id|ed_p
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
l_int|5
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ed_p
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: %s branch int %2d(%2x):&quot;
comma
id|str
comma
id|i
comma
id|i
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|ed_p
op_ne
l_int|0
op_logical_and
id|j
op_decrement
)paren
(brace
id|ed_t
op_star
id|ed
op_assign
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
c_func
(paren
id|le32_to_cpup
c_func
(paren
id|ed_p
)paren
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot; ed: %4x;&quot;
comma
id|ed-&gt;hwINFO
)paren
suffix:semicolon
id|ed_p
op_assign
op_amp
id|ed-&gt;hwNextED
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|ohci_dump_intr_mask
r_static
r_void
id|ohci_dump_intr_mask
(paren
r_char
op_star
id|label
comma
id|__u32
id|mask
)paren
(brace
id|dbg
(paren
l_string|&quot;%s: 0x%08x%s%s%s%s%s%s%s%s%s&quot;
comma
id|label
comma
id|mask
comma
(paren
id|mask
op_amp
id|OHCI_INTR_MIE
)paren
ques
c_cond
l_string|&quot; MIE&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|OHCI_INTR_OC
)paren
ques
c_cond
l_string|&quot; OC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|OHCI_INTR_RHSC
)paren
ques
c_cond
l_string|&quot; RHSC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|OHCI_INTR_FNO
)paren
ques
c_cond
l_string|&quot; FNO&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|OHCI_INTR_UE
)paren
ques
c_cond
l_string|&quot; UE&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|OHCI_INTR_RD
)paren
ques
c_cond
l_string|&quot; RD&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|OHCI_INTR_SF
)paren
ques
c_cond
l_string|&quot; SF&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|OHCI_INTR_WDH
)paren
ques
c_cond
l_string|&quot; WDH&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|mask
op_amp
id|OHCI_INTR_SO
)paren
ques
c_cond
l_string|&quot; SO&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
DECL|function|maybe_print_eds
r_static
r_void
id|maybe_print_eds
(paren
r_char
op_star
id|label
comma
id|__u32
id|value
)paren
(brace
r_if
c_cond
(paren
id|value
)paren
id|dbg
(paren
l_string|&quot;%s %08x&quot;
comma
id|label
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|hcfs2string
r_static
r_char
op_star
id|hcfs2string
(paren
r_int
id|state
)paren
(brace
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|OHCI_USB_RESET
suffix:colon
r_return
l_string|&quot;reset&quot;
suffix:semicolon
r_case
id|OHCI_USB_RESUME
suffix:colon
r_return
l_string|&quot;resume&quot;
suffix:semicolon
r_case
id|OHCI_USB_OPER
suffix:colon
r_return
l_string|&quot;operational&quot;
suffix:semicolon
r_case
id|OHCI_USB_SUSPEND
suffix:colon
r_return
l_string|&quot;suspend&quot;
suffix:semicolon
)brace
r_return
l_string|&quot;?&quot;
suffix:semicolon
)brace
singleline_comment|// dump control and status registers
DECL|function|ohci_dump_status
r_static
r_void
id|ohci_dump_status
(paren
id|ohci_t
op_star
id|controller
)paren
(brace
r_struct
id|ohci_regs
op_star
id|regs
op_assign
id|controller-&gt;regs
suffix:semicolon
id|__u32
id|temp
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|regs-&gt;revision
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_ne
l_int|0x10
)paren
id|dbg
(paren
l_string|&quot;spec %d.%d&quot;
comma
(paren
id|temp
op_rshift
l_int|4
)paren
comma
(paren
id|temp
op_amp
l_int|0x0f
)paren
)paren
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|regs-&gt;control
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;control: 0x%08x%s%s%s HCFS=%s%s%s%s%s CBSR=%d&quot;
comma
id|temp
comma
(paren
id|temp
op_amp
id|OHCI_CTRL_RWE
)paren
ques
c_cond
l_string|&quot; RWE&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|OHCI_CTRL_RWC
)paren
ques
c_cond
l_string|&quot; RWC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|OHCI_CTRL_IR
)paren
ques
c_cond
l_string|&quot; IR&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|hcfs2string
(paren
id|temp
op_amp
id|OHCI_CTRL_HCFS
)paren
comma
(paren
id|temp
op_amp
id|OHCI_CTRL_BLE
)paren
ques
c_cond
l_string|&quot; BLE&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|OHCI_CTRL_CLE
)paren
ques
c_cond
l_string|&quot; CLE&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|OHCI_CTRL_IE
)paren
ques
c_cond
l_string|&quot; IE&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|OHCI_CTRL_PLE
)paren
ques
c_cond
l_string|&quot; PLE&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|temp
op_amp
id|OHCI_CTRL_CBSR
)paren
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|regs-&gt;cmdstatus
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;cmdstatus: 0x%08x SOC=%d%s%s%s%s&quot;
comma
id|temp
comma
(paren
id|temp
op_amp
id|OHCI_SOC
)paren
op_rshift
l_int|16
comma
(paren
id|temp
op_amp
id|OHCI_OCR
)paren
ques
c_cond
l_string|&quot; OCR&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|OHCI_BLF
)paren
ques
c_cond
l_string|&quot; BLF&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|OHCI_CLF
)paren
ques
c_cond
l_string|&quot; CLF&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|OHCI_HCR
)paren
ques
c_cond
l_string|&quot; HCR&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|ohci_dump_intr_mask
(paren
l_string|&quot;intrstatus&quot;
comma
id|readl
(paren
op_amp
id|regs-&gt;intrstatus
)paren
)paren
suffix:semicolon
id|ohci_dump_intr_mask
(paren
l_string|&quot;intrenable&quot;
comma
id|readl
(paren
op_amp
id|regs-&gt;intrenable
)paren
)paren
suffix:semicolon
singleline_comment|// intrdisable always same as intrenable
singleline_comment|// ohci_dump_intr_mask (&quot;intrdisable&quot;, readl (&amp;regs-&gt;intrdisable));
id|maybe_print_eds
(paren
l_string|&quot;ed_periodcurrent&quot;
comma
id|readl
(paren
op_amp
id|regs-&gt;ed_periodcurrent
)paren
)paren
suffix:semicolon
id|maybe_print_eds
(paren
l_string|&quot;ed_controlhead&quot;
comma
id|readl
(paren
op_amp
id|regs-&gt;ed_controlhead
)paren
)paren
suffix:semicolon
id|maybe_print_eds
(paren
l_string|&quot;ed_controlcurrent&quot;
comma
id|readl
(paren
op_amp
id|regs-&gt;ed_controlcurrent
)paren
)paren
suffix:semicolon
id|maybe_print_eds
(paren
l_string|&quot;ed_bulkhead&quot;
comma
id|readl
(paren
op_amp
id|regs-&gt;ed_bulkhead
)paren
)paren
suffix:semicolon
id|maybe_print_eds
(paren
l_string|&quot;ed_bulkcurrent&quot;
comma
id|readl
(paren
op_amp
id|regs-&gt;ed_bulkcurrent
)paren
)paren
suffix:semicolon
id|maybe_print_eds
(paren
l_string|&quot;donehead&quot;
comma
id|readl
(paren
op_amp
id|regs-&gt;donehead
)paren
)paren
suffix:semicolon
)brace
DECL|function|ohci_dump_roothub
r_static
r_void
id|ohci_dump_roothub
(paren
id|ohci_t
op_star
id|controller
comma
r_int
id|verbose
)paren
(brace
r_struct
id|ohci_regs
op_star
id|regs
op_assign
id|controller-&gt;regs
suffix:semicolon
id|__u32
id|temp
comma
id|ndp
comma
id|i
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|regs-&gt;roothub.a
)paren
suffix:semicolon
id|ndp
op_assign
(paren
id|temp
op_amp
id|RH_A_NDP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
(brace
id|dbg
(paren
l_string|&quot;roothub.a: %08x POTPGT=%d%s%s%s%s%s NDP=%d&quot;
comma
id|temp
comma
(paren
(paren
id|temp
op_amp
id|RH_A_POTPGT
)paren
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
comma
(paren
id|temp
op_amp
id|RH_A_NOCP
)paren
ques
c_cond
l_string|&quot; NOCP&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_A_OCPM
)paren
ques
c_cond
l_string|&quot; OCPM&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_A_DT
)paren
ques
c_cond
l_string|&quot; DT&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_A_NPS
)paren
ques
c_cond
l_string|&quot; NPS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_A_PSM
)paren
ques
c_cond
l_string|&quot; PSM&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|ndp
)paren
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|regs-&gt;roothub.b
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;roothub.b: %08x PPCM=%04x DR=%04x&quot;
comma
id|temp
comma
(paren
id|temp
op_amp
id|RH_B_PPCM
)paren
op_rshift
l_int|16
comma
(paren
id|temp
op_amp
id|RH_B_DR
)paren
)paren
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|regs-&gt;roothub.status
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;roothub.status: %08x%s%s%s%s%s%s&quot;
comma
id|temp
comma
(paren
id|temp
op_amp
id|RH_HS_CRWE
)paren
ques
c_cond
l_string|&quot; CRWE&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_HS_OCIC
)paren
ques
c_cond
l_string|&quot; OCIC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_HS_LPSC
)paren
ques
c_cond
l_string|&quot; LPSC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_HS_DRWE
)paren
ques
c_cond
l_string|&quot; DRWE&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_HS_OCI
)paren
ques
c_cond
l_string|&quot; OCI&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_HS_LPS
)paren
ques
c_cond
l_string|&quot; LPS&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ndp
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp
op_assign
id|readl
(paren
op_amp
id|regs-&gt;roothub.portstatus
(braket
id|i
)braket
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;roothub.portstatus [%d] = 0x%08x%s%s%s%s%s%s%s%s%s%s%s%s&quot;
comma
id|i
comma
id|temp
comma
(paren
id|temp
op_amp
id|RH_PS_PRSC
)paren
ques
c_cond
l_string|&quot; PRSC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_OCIC
)paren
ques
c_cond
l_string|&quot; OCIC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_PSSC
)paren
ques
c_cond
l_string|&quot; PSSC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_PESC
)paren
ques
c_cond
l_string|&quot; PESC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_CSC
)paren
ques
c_cond
l_string|&quot; CSC&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_LSDA
)paren
ques
c_cond
l_string|&quot; LSDA&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_PPS
)paren
ques
c_cond
l_string|&quot; PPS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_PRS
)paren
ques
c_cond
l_string|&quot; PRS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_POCI
)paren
ques
c_cond
l_string|&quot; POCI&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_PSS
)paren
ques
c_cond
l_string|&quot; PSS&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_PES
)paren
ques
c_cond
l_string|&quot; PES&quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|temp
op_amp
id|RH_PS_CCS
)paren
ques
c_cond
l_string|&quot; CCS&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|ohci_dump
r_static
r_void
id|ohci_dump
(paren
id|ohci_t
op_star
id|controller
comma
r_int
id|verbose
)paren
(brace
id|dbg
(paren
l_string|&quot;OHCI controller usb-%s state&quot;
comma
id|controller-&gt;ohci_dev-&gt;slot_name
)paren
suffix:semicolon
singleline_comment|// dumps some of the state we know about
id|ohci_dump_status
(paren
id|controller
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
id|ep_print_int_eds
(paren
id|controller
comma
l_string|&quot;hcca&quot;
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;hcca frame #%04x&quot;
comma
id|controller-&gt;hcca.frame_no
)paren
suffix:semicolon
id|ohci_dump_roothub
(paren
id|controller
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------*&n; * Interface functions (URB)&n; *-------------------------------------------------------------------------*/
multiline_comment|/* return a request to the completion handler */
DECL|function|sohci_return_urb
r_static
r_int
id|sohci_return_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|urb_t
op_star
id|urbt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* urb already unlinked */
multiline_comment|/* just to be sure */
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;complete
)paren
(brace
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;RET&quot;
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_INTERRUPT
suffix:colon
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
multiline_comment|/* call complete and requeue URB */
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;status
op_assign
id|USB_ST_URB_PENDING
suffix:semicolon
r_if
c_cond
(paren
id|urb_priv-&gt;state
op_ne
id|URB_DEL
)paren
id|td_submit_urb
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_for
c_loop
(paren
id|urbt
op_assign
id|urb-&gt;next
suffix:semicolon
id|urbt
op_logical_and
(paren
id|urbt
op_ne
id|urb
)paren
suffix:semicolon
id|urbt
op_assign
id|urbt-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urbt
)paren
(brace
multiline_comment|/* send the reply and requeue URB */
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;status
op_assign
id|USB_ST_URB_PENDING
suffix:semicolon
id|urb-&gt;start_frame
op_assign
id|urb_priv-&gt;ed-&gt;last_iso
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|urb_priv-&gt;state
op_ne
id|URB_DEL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
op_minus
id|EXDEV
suffix:semicolon
)brace
id|td_submit_urb
(paren
id|urb
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* unlink URB, call complete */
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
r_case
id|PIPE_CONTROL
suffix:colon
multiline_comment|/* unlink URB, call complete */
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* get a transfer request */
DECL|function|sohci_submit_urb
r_static
r_int
id|sohci_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|ohci_t
op_star
id|ohci
suffix:semicolon
id|ed_t
op_star
id|ed
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
r_int
id|i
comma
id|size
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|bustime
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;dev
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;hcpriv
)paren
multiline_comment|/* urb already in use */
r_return
op_minus
id|EINVAL
suffix:semicolon
singleline_comment|//&t;if(usb_endpoint_halted (urb-&gt;dev, usb_pipeendpoint (pipe), usb_pipeout (pipe))) 
singleline_comment|//&t;&t;return -EPIPE;
id|usb_inc_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;SUB&quot;
comma
id|usb_pipein
(paren
id|pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* handle a request to the virtual root hub */
r_if
c_cond
(paren
id|usb_pipedevice
(paren
id|pipe
)paren
op_eq
id|ohci-&gt;rh.devnum
)paren
r_return
id|rh_submit_urb
(paren
id|urb
)paren
suffix:semicolon
multiline_comment|/* when controller&squot;s hung, permit only roothub cleanup attempts&n;&t; * such as powering down ports */
r_if
c_cond
(paren
id|ohci-&gt;disabled
)paren
(brace
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ESHUTDOWN
suffix:semicolon
)brace
multiline_comment|/* every endpoint has a ed, locate and fill it */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ed
op_assign
id|ep_add_ed
(paren
id|urb-&gt;dev
comma
id|pipe
comma
id|urb-&gt;interval
comma
l_int|1
)paren
)paren
)paren
(brace
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* for the private part of the URB we need the number of TDs (size) */
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|pipe
)paren
)paren
(brace
r_case
id|PIPE_BULK
suffix:colon
multiline_comment|/* one TD for every 4096 Byte */
id|size
op_assign
(paren
id|urb-&gt;transfer_buffer_length
op_minus
l_int|1
)paren
op_div
l_int|4096
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
multiline_comment|/* number of packets from URB */
id|size
op_assign
id|urb-&gt;number_of_packets
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
)paren
(brace
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
op_minus
id|EXDEV
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PIPE_CONTROL
suffix:colon
multiline_comment|/* 1 TD for setup, 1 for ACK and 1 for every 4096 B */
id|size
op_assign
(paren
id|urb-&gt;transfer_buffer_length
op_eq
l_int|0
)paren
ques
c_cond
l_int|2
suffix:colon
(paren
id|urb-&gt;transfer_buffer_length
op_minus
l_int|1
)paren
op_div
l_int|4096
op_plus
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
multiline_comment|/* one TD */
id|size
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* allocate the private part of the URB */
id|urb_priv
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|urb_priv_t
)paren
op_plus
id|size
op_star
r_sizeof
(paren
id|td_t
op_star
)paren
comma
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv
)paren
(brace
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|urb_priv
comma
l_int|0
comma
r_sizeof
(paren
id|urb_priv_t
)paren
op_plus
id|size
op_star
r_sizeof
(paren
id|td_t
op_star
)paren
)paren
suffix:semicolon
multiline_comment|/* fill the private part of the URB */
id|urb_priv-&gt;length
op_assign
id|size
suffix:semicolon
id|urb_priv-&gt;ed
op_assign
id|ed
suffix:semicolon
multiline_comment|/* allocate the TDs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|urb_priv-&gt;td
(braket
id|i
)braket
op_assign
id|td_alloc
(paren
id|ohci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv-&gt;td
(braket
id|i
)braket
)paren
(brace
id|urb_free_priv
(paren
id|ohci
comma
id|urb_priv
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ed-&gt;state
op_eq
id|ED_NEW
op_logical_or
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
)paren
(brace
id|urb_free_priv
(paren
id|ohci
comma
id|urb_priv
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* allocate and claim bandwidth if needed; ISO&n;&t; * needs start frame index if it was&squot;t provided.&n;&t; */
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|pipe
)paren
)paren
(brace
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ISO_ASAP
)paren
(brace
id|urb-&gt;start_frame
op_assign
(paren
(paren
id|ed-&gt;state
op_eq
id|ED_OPER
)paren
ques
c_cond
(paren
id|ed-&gt;last_iso
op_plus
l_int|1
)paren
suffix:colon
(paren
id|le16_to_cpu
(paren
id|ohci-&gt;hcca.frame_no
)paren
op_plus
l_int|10
)paren
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
multiline_comment|/* FALLTHROUGH */
r_case
id|PIPE_INTERRUPT
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;bandwidth
op_eq
l_int|0
)paren
(brace
id|bustime
op_assign
id|usb_check_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bustime
OL
l_int|0
)paren
(brace
id|urb_free_priv
(paren
id|ohci
comma
id|urb_priv
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
r_return
id|bustime
suffix:semicolon
)brace
id|usb_claim_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
id|bustime
comma
id|usb_pipeisoc
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;hcpriv
op_assign
id|urb_priv
suffix:semicolon
id|urb-&gt;status
op_assign
id|USB_ST_URB_PENDING
suffix:semicolon
multiline_comment|/* link the ed into a chain if is not already */
r_if
c_cond
(paren
id|ed-&gt;state
op_ne
id|ED_OPER
)paren
id|ep_link
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
multiline_comment|/* fill the TDs and link it to the ed */
id|td_submit_urb
(paren
id|urb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* deactivate all TDs and remove the private part of the URB */
multiline_comment|/* interrupt callers must use async unlink mode */
DECL|function|sohci_unlink_urb
r_static
r_int
id|sohci_unlink_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ohci_t
op_star
id|ohci
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
multiline_comment|/* just to be sure */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;dev
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;UNLINK&quot;
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif&t;&t;  
multiline_comment|/* handle a request to the virtual root hub */
r_if
c_cond
(paren
id|usb_pipedevice
(paren
id|urb-&gt;pipe
)paren
op_eq
id|ohci-&gt;rh.devnum
)paren
r_return
id|rh_unlink_urb
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;hcpriv
op_logical_and
(paren
id|urb-&gt;status
op_eq
id|USB_ST_URB_PENDING
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;disabled
)paren
(brace
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
multiline_comment|/* interrupt code may not sleep; it must use&n;&t;&t;&t; * async status return to unlink pending urbs.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ASYNC_UNLINK
)paren
op_logical_and
id|in_interrupt
(paren
)paren
)paren
(brace
id|err
(paren
l_string|&quot;bug in call from %p; use async!&quot;
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
multiline_comment|/* flag the urb and its TDs for deletion in some&n;&t;&t;&t; * upcoming SF interrupt delete list processing&n;&t;&t;&t; */
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv
op_logical_or
(paren
id|urb_priv-&gt;state
op_eq
id|URB_DEL
)paren
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|urb_priv-&gt;state
op_assign
id|URB_DEL
suffix:semicolon
id|ep_rm_ed
(paren
id|urb-&gt;dev
comma
id|urb_priv-&gt;ed
)paren
suffix:semicolon
id|urb_priv-&gt;ed-&gt;state
op_or_assign
id|ED_URB_DEL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ASYNC_UNLINK
)paren
)paren
(brace
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|unlink_wakeup
)paren
suffix:semicolon
id|DECLARE_WAITQUEUE
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|timeout
op_assign
id|OHCI_UNLINK_TIMEOUT
suffix:semicolon
id|add_wait_queue
(paren
op_amp
id|unlink_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
id|urb_priv-&gt;wait
op_assign
op_amp
id|unlink_wakeup
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* wait until all TDs are deleted */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_logical_and
(paren
id|urb-&gt;status
op_eq
id|USB_ST_URB_PENDING
)paren
)paren
id|timeout
op_assign
id|schedule_timeout
(paren
id|timeout
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
(paren
op_amp
id|unlink_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
id|USB_ST_URB_PENDING
)paren
(brace
id|err
(paren
l_string|&quot;unlink URB timeout&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* usb_dec_dev_use done in dl_del_list() */
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|urb_rm_priv
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ASYNC_UNLINK
)paren
(brace
id|urb-&gt;status
op_assign
op_minus
id|ECONNRESET
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
r_else
id|urb-&gt;status
op_assign
op_minus
id|ENOENT
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* allocate private data space for a usb device */
DECL|function|sohci_alloc_dev
r_static
r_int
id|sohci_alloc_dev
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* FIXME:  ED allocation with pci_consistent memory&n;&t; * must know the controller ... either pass it in here,&n;&t; * or decouple ED allocation from dev allocation.&n;&t; */
id|dev
op_assign
id|dev_alloc
(paren
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|usb_dev-&gt;hcpriv
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* may be called from interrupt context */
multiline_comment|/* frees private data space of usb device */
DECL|function|sohci_free_dev
r_static
r_int
id|sohci_free_dev
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|cnt
op_assign
l_int|0
suffix:semicolon
id|ed_t
op_star
id|ed
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
op_assign
id|usb_to_ohci
(paren
id|usb_dev
)paren
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|usb_dev-&gt;devnum
op_ge
l_int|0
)paren
(brace
multiline_comment|/* driver disconnects should have unlinked all urbs&n;&t;&t; * (freeing all the TDs, unlinking EDs) but we need&n;&t;&t; * to defend against bugs that prevent that.&n;&t;&t; */
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_EDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ed
op_assign
op_amp
(paren
id|dev-&gt;ed
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;state
op_ne
id|ED_NEW
)paren
(brace
r_if
c_cond
(paren
id|ed-&gt;state
op_eq
id|ED_OPER
)paren
(brace
multiline_comment|/* driver on that interface didn&squot;t unlink an urb */
id|dbg
(paren
l_string|&quot;driver usb-%s dev %d ed 0x%x unfreed URB&quot;
comma
id|ohci-&gt;ohci_dev-&gt;slot_name
comma
id|usb_dev-&gt;devnum
comma
id|i
)paren
suffix:semicolon
id|ep_unlink
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
)brace
id|ep_rm_ed
(paren
id|usb_dev
comma
id|ed
)paren
suffix:semicolon
id|ed-&gt;state
op_assign
id|ED_DEL
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* if the controller is running, tds for those unlinked&n;&t;&t; * urbs get freed by dl_del_list at the next SF interrupt&n;&t;&t; */
r_if
c_cond
(paren
id|cnt
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;disabled
)paren
(brace
multiline_comment|/* FIXME: Something like this should kick in,&n;&t;&t;&t;&t; * though it&squot;s currently an exotic case ...&n;&t;&t;&t;&t; * the controller won&squot;t ever be touching&n;&t;&t;&t;&t; * these lists again!!&n;&t;&t;&t;&t;dl_del_list (ohci,&n;&t;&t;&t;&t;&t;le16_to_cpu (ohci-&gt;hcca.frame_no) &amp; 1);&n;&t;&t;&t;&t; */
id|warn
(paren
l_string|&quot;TD leak, %d&quot;
comma
id|cnt
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
(paren
)paren
)paren
(brace
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|freedev_wakeup
)paren
suffix:semicolon
id|DECLARE_WAITQUEUE
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|timeout
op_assign
id|OHCI_UNLINK_TIMEOUT
suffix:semicolon
multiline_comment|/* SF interrupt handler calls dl_del_list */
id|add_wait_queue
(paren
op_amp
id|freedev_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
id|dev-&gt;wait
op_assign
op_amp
id|freedev_wakeup
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_logical_and
id|dev-&gt;ed_cnt
)paren
id|timeout
op_assign
id|schedule_timeout
(paren
id|timeout
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
(paren
op_amp
id|freedev_wakeup
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ed_cnt
)paren
(brace
id|err
(paren
l_string|&quot;free device %d timeout&quot;
comma
id|usb_dev-&gt;devnum
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* likely some interface&squot;s driver has a refcount bug */
id|err
(paren
l_string|&quot;bus %s devnum %d deletion in interrupt&quot;
comma
id|ohci-&gt;ohci_dev-&gt;slot_name
comma
id|usb_dev-&gt;devnum
)paren
suffix:semicolon
id|BUG
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* free device, and associated EDs */
id|dev_free
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* tell us the current USB frame number */
DECL|function|sohci_get_current_frame_number
r_static
r_int
id|sohci_get_current_frame_number
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_return
id|le16_to_cpu
(paren
id|ohci-&gt;hcca.frame_no
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|sohci_device_operations
r_struct
id|usb_operations
id|sohci_device_operations
op_assign
(brace
id|sohci_alloc_dev
comma
id|sohci_free_dev
comma
id|sohci_get_current_frame_number
comma
id|sohci_submit_urb
comma
id|sohci_unlink_urb
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*&n; * ED handling functions&n; *-------------------------------------------------------------------------*/
multiline_comment|/* search for the right branch to insert an interrupt ed into the int tree &n; * do some load ballancing;&n; * returns the branch and &n; * sets the interval to interval = 2^integer (ld (interval)) */
DECL|function|ep_int_ballance
r_static
r_int
id|ep_int_ballance
(paren
id|ohci_t
op_star
id|ohci
comma
r_int
id|interval
comma
r_int
id|load
)paren
(brace
r_int
id|i
comma
id|branch
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* search for the least loaded interrupt endpoint branch of all 32 branches */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ohci-&gt;ohci_int_load
(braket
id|branch
)braket
OG
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
)paren
id|branch
op_assign
id|i
suffix:semicolon
id|branch
op_assign
id|branch
op_mod
id|interval
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|branch
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|interval
)paren
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_add_assign
id|load
suffix:semicolon
r_return
id|branch
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/*  2^int( ld (inter)) */
DECL|function|ep_2_n_interval
r_static
r_int
id|ep_2_n_interval
(paren
r_int
id|inter
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|inter
op_rshift
id|i
)paren
OG
l_int|1
)paren
op_logical_and
(paren
id|i
OL
l_int|5
)paren
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_return
l_int|1
op_lshift
id|i
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* the int tree is a binary tree &n; * in order to process it sequentially the indexes of the branches have to be mapped &n; * the mapping reverses the bits of a word of num_bits length */
DECL|function|ep_rev
r_static
r_int
id|ep_rev
(paren
r_int
id|num_bits
comma
r_int
id|word
)paren
(brace
r_int
id|i
comma
id|wout
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_bits
suffix:semicolon
id|i
op_increment
)paren
id|wout
op_or_assign
(paren
(paren
(paren
id|word
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
op_lshift
(paren
id|num_bits
op_minus
id|i
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_return
id|wout
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* link an ed into one of the HC chains */
DECL|function|ep_link
r_static
r_int
id|ep_link
(paren
id|ohci_t
op_star
id|ohci
comma
id|ed_t
op_star
id|edi
)paren
(brace
r_int
id|int_branch
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|inter
suffix:semicolon
r_int
id|interval
suffix:semicolon
r_int
id|load
suffix:semicolon
id|__u32
op_star
id|ed_p
suffix:semicolon
r_volatile
id|ed_t
op_star
id|ed
op_assign
id|edi
suffix:semicolon
id|ed-&gt;state
op_assign
id|ED_OPER
suffix:semicolon
r_switch
c_cond
(paren
id|ed-&gt;type
)paren
(brace
r_case
id|PIPE_CONTROL
suffix:colon
id|ed-&gt;hwNextED
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
op_eq
l_int|NULL
)paren
(brace
id|writel
(paren
id|virt_to_bus
(paren
id|ed
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;ed_controltail-&gt;hwNextED
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_controltail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;ed_controltail
op_logical_and
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
l_int|0
)braket
op_logical_and
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
l_int|1
)braket
)paren
(brace
id|ohci-&gt;hc_control
op_or_assign
id|OHCI_CTRL_CLE
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
)brace
id|ohci-&gt;ed_controltail
op_assign
id|edi
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
id|ed-&gt;hwNextED
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
op_eq
l_int|NULL
)paren
(brace
id|writel
(paren
id|virt_to_bus
(paren
id|ed
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;ed_bulktail-&gt;hwNextED
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_bulktail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;ed_bulktail
op_logical_and
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
l_int|0
)braket
op_logical_and
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
l_int|1
)braket
)paren
(brace
id|ohci-&gt;hc_control
op_or_assign
id|OHCI_CTRL_BLE
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
)brace
id|ohci-&gt;ed_bulktail
op_assign
id|edi
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
id|load
op_assign
id|ed-&gt;int_load
suffix:semicolon
id|interval
op_assign
id|ep_2_n_interval
(paren
id|ed-&gt;int_period
)paren
suffix:semicolon
id|ed-&gt;int_interval
op_assign
id|interval
suffix:semicolon
id|int_branch
op_assign
id|ep_int_ballance
(paren
id|ohci
comma
id|interval
comma
id|load
)paren
suffix:semicolon
id|ed-&gt;int_branch
op_assign
id|int_branch
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ep_rev
(paren
l_int|6
comma
id|interval
)paren
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
id|inter
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|ep_rev
(paren
l_int|5
comma
id|i
)paren
op_plus
id|int_branch
)braket
)paren
suffix:semicolon
(paren
op_star
id|ed_p
op_ne
l_int|0
)paren
op_logical_and
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|int_interval
op_ge
id|interval
)paren
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
)paren
id|inter
op_assign
id|ep_rev
(paren
l_int|6
comma
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
suffix:semicolon
id|ed-&gt;hwNextED
op_assign
op_star
id|ed_p
suffix:semicolon
op_star
id|ed_p
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|ep_print_int_eds
(paren
id|ohci
comma
l_string|&quot;LINK_INT&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
id|ed-&gt;hwNextED
op_assign
l_int|0
suffix:semicolon
id|ed-&gt;int_interval
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_isotail
op_ne
l_int|NULL
)paren
(brace
id|ohci-&gt;ed_isotail-&gt;hwNextED
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
id|ed-&gt;ed_prev
op_assign
id|ohci-&gt;ed_isotail
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
id|inter
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|ep_rev
(paren
l_int|5
comma
id|i
)paren
)braket
)paren
suffix:semicolon
op_star
id|ed_p
op_ne
l_int|0
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
)paren
id|inter
op_assign
id|ep_rev
(paren
l_int|6
comma
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
suffix:semicolon
op_star
id|ed_p
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|ed
)paren
)paren
suffix:semicolon
)brace
id|ed-&gt;ed_prev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ohci-&gt;ed_isotail
op_assign
id|edi
suffix:semicolon
macro_line|#ifdef DEBUG
id|ep_print_int_eds
(paren
id|ohci
comma
l_string|&quot;LINK_ISO&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* unlink an ed from one of the HC chains. &n; * just the link to the ed is unlinked.&n; * the link from the ed still points to another operational ed or 0&n; * so the HC can eventually finish the processing of the unlinked ed */
DECL|function|ep_unlink
r_static
r_int
id|ep_unlink
(paren
id|ohci_t
op_star
id|ohci
comma
id|ed_t
op_star
id|ed
)paren
(brace
r_int
id|int_branch
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|inter
suffix:semicolon
r_int
id|interval
suffix:semicolon
id|__u32
op_star
id|ed_p
suffix:semicolon
id|ed-&gt;hwINFO
op_or_assign
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ed-&gt;type
)paren
(brace
r_case
id|PIPE_CONTROL
suffix:colon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ed-&gt;hwNextED
)paren
(brace
id|ohci-&gt;hc_control
op_and_assign
op_complement
id|OHCI_CTRL_CLE
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
)brace
id|writel
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ed-&gt;ed_prev-&gt;hwNextED
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_controltail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ed-&gt;hwNextED
)paren
(brace
id|ohci-&gt;hc_control
op_and_assign
op_complement
id|OHCI_CTRL_BLE
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
)brace
id|writel
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
)brace
r_else
(brace
id|ed-&gt;ed_prev-&gt;hwNextED
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
op_eq
id|ed
)paren
(brace
id|ohci-&gt;ed_bulktail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
id|int_branch
op_assign
id|ed-&gt;int_branch
suffix:semicolon
id|interval
op_assign
id|ed-&gt;int_interval
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ep_rev
(paren
l_int|6
comma
id|interval
)paren
suffix:semicolon
id|i
op_add_assign
id|inter
)paren
(brace
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|ep_rev
(paren
l_int|5
comma
id|i
)paren
op_plus
id|int_branch
)braket
)paren
comma
id|inter
op_assign
l_int|1
suffix:semicolon
(paren
op_star
id|ed_p
op_ne
l_int|0
)paren
op_logical_and
(paren
op_star
id|ed_p
op_ne
id|ed-&gt;hwNextED
)paren
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
comma
id|inter
op_assign
id|ep_rev
(paren
l_int|6
comma
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|int_interval
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_eq
id|ed
)paren
(brace
op_star
id|ed_p
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
id|int_branch
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_add_assign
id|interval
)paren
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_sub_assign
id|ed-&gt;int_load
suffix:semicolon
macro_line|#ifdef DEBUG
id|ep_print_int_eds
(paren
id|ohci
comma
l_string|&quot;UNLINK_INT&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_if
c_cond
(paren
id|ohci-&gt;ed_isotail
op_eq
id|ed
)paren
id|ohci-&gt;ed_isotail
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;hwNextED
op_ne
l_int|0
)paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwNextED
)paren
)paren
)paren
op_member_access_from_pointer
id|ed_prev
op_assign
id|ed-&gt;ed_prev
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;ed_prev
op_ne
l_int|NULL
)paren
(brace
id|ed-&gt;ed_prev-&gt;hwNextED
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|ed_p
op_assign
op_amp
(paren
id|ohci-&gt;hcca.int_table
(braket
id|ep_rev
(paren
l_int|5
comma
id|i
)paren
)braket
)paren
suffix:semicolon
op_star
id|ed_p
op_ne
l_int|0
suffix:semicolon
id|ed_p
op_assign
op_amp
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_member_access_from_pointer
id|hwNextED
)paren
)paren
(brace
singleline_comment|// inter = ep_rev (6, ((ed_t *) bus_to_virt (le32_to_cpup (ed_p)))-&gt;int_interval);
r_if
c_cond
(paren
(paren
(paren
id|ed_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
id|ed_p
)paren
)paren
)paren
op_eq
id|ed
)paren
(brace
op_star
id|ed_p
op_assign
id|ed-&gt;hwNextED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#ifdef DEBUG
id|ep_print_int_eds
(paren
id|ohci
comma
l_string|&quot;UNLINK_ISO&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
id|ed-&gt;state
op_assign
id|ED_UNLINK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* add/reinit an endpoint; this should be done once at the usb_set_configuration command,&n; * but the USB stack is a little bit stateless  so we do it at every transaction&n; * if the state of the ed is ED_NEW then a dummy td is added and the state is changed to ED_UNLINK&n; * in all other cases the state is left unchanged&n; * the ed info fields are setted anyway even though most of them should not change */
DECL|function|ep_add_ed
r_static
id|ed_t
op_star
id|ep_add_ed
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
r_int
id|pipe
comma
r_int
id|interval
comma
r_int
id|load
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|td_t
op_star
id|td
suffix:semicolon
id|ed_t
op_star
id|ed_ret
suffix:semicolon
r_volatile
id|ed_t
op_star
id|ed
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|ed
op_assign
id|ed_ret
op_assign
op_amp
(paren
id|usb_to_ohci
(paren
id|usb_dev
)paren
op_member_access_from_pointer
id|ed
(braket
(paren
id|usb_pipeendpoint
(paren
id|pipe
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|usb_pipecontrol
(paren
id|pipe
)paren
ques
c_cond
l_int|0
suffix:colon
id|usb_pipeout
(paren
id|pipe
)paren
)paren
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
op_logical_or
(paren
id|ed-&gt;state
op_amp
id|ED_URB_DEL
)paren
)paren
(brace
multiline_comment|/* pending delete request */
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ed-&gt;state
op_eq
id|ED_NEW
)paren
(brace
id|ed-&gt;hwINFO
op_assign
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
multiline_comment|/* skip ed */
multiline_comment|/* dummy td; end of td list for ed */
id|td
op_assign
id|td_alloc
(paren
id|ohci
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
(brace
multiline_comment|/* out of memory */
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ed-&gt;hwTailP
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|td
)paren
)paren
suffix:semicolon
id|ed-&gt;hwHeadP
op_assign
id|ed-&gt;hwTailP
suffix:semicolon
id|ed-&gt;state
op_assign
id|ED_UNLINK
suffix:semicolon
id|ed-&gt;type
op_assign
id|usb_pipetype
(paren
id|pipe
)paren
suffix:semicolon
id|usb_to_ohci
(paren
id|usb_dev
)paren
op_member_access_from_pointer
id|ed_cnt
op_increment
suffix:semicolon
)brace
id|ohci-&gt;dev
(braket
id|usb_pipedevice
(paren
id|pipe
)paren
)braket
op_assign
id|usb_dev
suffix:semicolon
id|ed-&gt;hwINFO
op_assign
id|cpu_to_le32
(paren
id|usb_pipedevice
(paren
id|pipe
)paren
op_or
id|usb_pipeendpoint
(paren
id|pipe
)paren
op_lshift
l_int|7
op_or
(paren
id|usb_pipeisoc
(paren
id|pipe
)paren
ques
c_cond
l_int|0x8000
suffix:colon
l_int|0
)paren
op_or
(paren
id|usb_pipecontrol
(paren
id|pipe
)paren
ques
c_cond
l_int|0
suffix:colon
(paren
id|usb_pipeout
(paren
id|pipe
)paren
ques
c_cond
l_int|0x800
suffix:colon
l_int|0x1000
)paren
)paren
op_or
id|usb_pipeslow
(paren
id|pipe
)paren
op_lshift
l_int|13
op_or
id|usb_maxpacket
(paren
id|usb_dev
comma
id|pipe
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;type
op_eq
id|PIPE_INTERRUPT
op_logical_and
id|ed-&gt;state
op_eq
id|ED_UNLINK
)paren
(brace
id|ed-&gt;int_period
op_assign
id|interval
suffix:semicolon
id|ed-&gt;int_load
op_assign
id|load
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ed_ret
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* request the removal of an endpoint&n; * put the ep on the rm_list and request a stop of the bulk or ctrl list &n; * real removal is done at the next start frame (SF) hardware interrupt */
DECL|function|ep_rm_ed
r_static
r_void
id|ep_rm_ed
(paren
r_struct
id|usb_device
op_star
id|usb_dev
comma
id|ed_t
op_star
id|ed
)paren
(brace
r_int
r_int
id|frame
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
op_logical_or
(paren
id|ed-&gt;state
op_amp
id|ED_URB_DEL
)paren
)paren
r_return
suffix:semicolon
id|ed-&gt;hwINFO
op_or_assign
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;disabled
)paren
(brace
r_switch
c_cond
(paren
id|ed-&gt;type
)paren
(brace
r_case
id|PIPE_CONTROL
suffix:colon
multiline_comment|/* stop control list */
id|ohci-&gt;hc_control
op_and_assign
op_complement
id|OHCI_CTRL_CLE
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
multiline_comment|/* stop bulk list */
id|ohci-&gt;hc_control
op_and_assign
op_complement
id|OHCI_CTRL_BLE
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|frame
op_assign
id|le16_to_cpu
(paren
id|ohci-&gt;hcca.frame_no
)paren
op_amp
l_int|0x1
suffix:semicolon
id|ed-&gt;ed_rm_list
op_assign
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
suffix:semicolon
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
op_assign
id|ed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;disabled
)paren
(brace
multiline_comment|/* enable SOF interrupt */
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------------*&n; * TD handling functions&n; *-------------------------------------------------------------------------*/
multiline_comment|/* prepare a TD */
DECL|function|td_fill
r_static
r_void
id|td_fill
(paren
r_int
r_int
id|info
comma
r_void
op_star
id|data
comma
r_int
id|len
comma
id|urb_t
op_star
id|urb
comma
r_int
id|index
)paren
(brace
r_volatile
id|td_t
op_star
id|td
comma
op_star
id|td_pt
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|index
op_ge
id|urb_priv-&gt;length
)paren
(brace
id|err
c_func
(paren
l_string|&quot;internal OHCI error: TD index &gt; length&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|td_pt
op_assign
id|urb_priv-&gt;td
(braket
id|index
)braket
suffix:semicolon
multiline_comment|/* fill the old dummy TD */
id|td
op_assign
id|urb_priv-&gt;td
(braket
id|index
)braket
op_assign
(paren
id|td_t
op_star
)paren
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|urb_priv-&gt;ed-&gt;hwTailP
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|td-&gt;ed
op_assign
id|urb_priv-&gt;ed
suffix:semicolon
id|td-&gt;next_dl_td
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;index
op_assign
id|index
suffix:semicolon
id|td-&gt;urb
op_assign
id|urb
suffix:semicolon
id|td-&gt;hwINFO
op_assign
id|cpu_to_le32
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|td-&gt;ed-&gt;type
)paren
op_eq
id|PIPE_ISOCHRONOUS
)paren
(brace
id|td-&gt;hwCBP
op_assign
id|cpu_to_le32
(paren
(paren
(paren
op_logical_neg
id|data
op_logical_or
op_logical_neg
id|len
)paren
ques
c_cond
l_int|0
suffix:colon
id|virt_to_bus
(paren
id|data
)paren
)paren
op_amp
l_int|0xFFFFF000
)paren
suffix:semicolon
id|td-&gt;ed-&gt;last_iso
op_assign
id|info
op_amp
l_int|0xffff
suffix:semicolon
)brace
r_else
(brace
id|td-&gt;hwCBP
op_assign
id|cpu_to_le32
(paren
(paren
(paren
op_logical_neg
id|data
op_logical_or
op_logical_neg
id|len
)paren
ques
c_cond
l_int|0
suffix:colon
id|virt_to_bus
(paren
id|data
)paren
)paren
)paren
suffix:semicolon
)brace
id|td-&gt;hwBE
op_assign
id|cpu_to_le32
(paren
(paren
op_logical_neg
id|data
op_logical_or
op_logical_neg
id|len
)paren
ques
c_cond
l_int|0
suffix:colon
id|virt_to_bus
(paren
id|data
op_plus
id|len
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|td-&gt;hwNextTD
op_assign
id|cpu_to_le32
(paren
id|virt_to_bus
(paren
id|td_pt
)paren
)paren
suffix:semicolon
id|td-&gt;hwPSW
(braket
l_int|0
)braket
op_assign
id|cpu_to_le16
(paren
(paren
id|virt_to_bus
(paren
id|data
)paren
op_amp
l_int|0x0FFF
)paren
op_or
l_int|0xE000
)paren
suffix:semicolon
id|td_pt-&gt;hwNextTD
op_assign
l_int|0
suffix:semicolon
id|td-&gt;ed-&gt;hwTailP
op_assign
id|td-&gt;hwNextTD
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* prepare all TDs of a transfer */
DECL|function|td_submit_urb
r_static
r_void
id|td_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_void
op_star
id|ctrl
op_assign
id|urb-&gt;setup_packet
suffix:semicolon
r_void
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|data_len
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
id|__u32
id|info
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|toggle
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* OHCI handles the DATA-toggles itself, we just use the USB-toggle bits for reseting */
r_if
c_cond
(paren
id|usb_gettoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
)paren
(brace
id|toggle
op_assign
id|TD_T_TOGGLE
suffix:semicolon
)brace
r_else
(brace
id|toggle
op_assign
id|TD_T_DATA0
suffix:semicolon
id|usb_settoggle
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
comma
l_int|1
)paren
suffix:semicolon
)brace
id|urb_priv-&gt;td_cnt
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_BULK
suffix:colon
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_DP_OUT
suffix:colon
id|TD_CC
op_or
id|TD_DP_IN
suffix:semicolon
r_while
c_loop
(paren
id|data_len
OG
l_int|4096
)paren
(brace
id|td_fill
(paren
id|info
op_or
(paren
id|cnt
ques
c_cond
id|TD_T_TOGGLE
suffix:colon
id|toggle
)paren
comma
id|data
comma
l_int|4096
comma
id|urb
comma
id|cnt
)paren
suffix:semicolon
id|data
op_add_assign
l_int|4096
suffix:semicolon
id|data_len
op_sub_assign
l_int|4096
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_DP_OUT
suffix:colon
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
suffix:semicolon
id|td_fill
(paren
id|info
op_or
(paren
id|cnt
ques
c_cond
id|TD_T_TOGGLE
suffix:colon
id|toggle
)paren
comma
id|data
comma
id|data_len
comma
id|urb
comma
id|cnt
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
id|writel
(paren
id|OHCI_BLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start bulk list */
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|toggle
suffix:colon
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|toggle
suffix:semicolon
id|td_fill
(paren
id|info
comma
id|data
comma
id|data_len
comma
id|urb
comma
id|cnt
op_increment
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_CONTROL
suffix:colon
id|info
op_assign
id|TD_CC
op_or
id|TD_DP_SETUP
op_or
id|TD_T_DATA0
suffix:semicolon
id|td_fill
(paren
id|info
comma
id|ctrl
comma
l_int|8
comma
id|urb
comma
id|cnt
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_len
OG
l_int|0
)paren
(brace
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_OUT
op_or
id|TD_T_DATA1
suffix:colon
id|TD_CC
op_or
id|TD_R
op_or
id|TD_DP_IN
op_or
id|TD_T_DATA1
suffix:semicolon
id|td_fill
(paren
id|info
comma
id|data
comma
id|data_len
comma
id|urb
comma
id|cnt
op_increment
)paren
suffix:semicolon
)brace
id|info
op_assign
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|TD_CC
op_or
id|TD_DP_IN
op_or
id|TD_T_DATA1
suffix:colon
id|TD_CC
op_or
id|TD_DP_OUT
op_or
id|TD_T_DATA1
suffix:semicolon
id|td_fill
(paren
id|info
comma
l_int|NULL
comma
l_int|0
comma
id|urb
comma
id|cnt
op_increment
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_CLF
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* start Control list */
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|td_fill
(paren
id|TD_CC
op_or
id|TD_ISO
op_or
(paren
(paren
id|urb-&gt;start_frame
op_plus
id|cnt
)paren
op_amp
l_int|0xffff
)paren
comma
(paren
id|__u8
op_star
)paren
id|data
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|cnt
)braket
dot
id|offset
comma
id|urb-&gt;iso_frame_desc
(braket
id|cnt
)braket
dot
id|length
comma
id|urb
comma
id|cnt
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb_priv-&gt;length
op_ne
id|cnt
)paren
id|dbg
c_func
(paren
l_string|&quot;TD LENGTH %d != CNT %d&quot;
comma
id|urb_priv-&gt;length
comma
id|cnt
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*&n; * Done List handling functions&n; *-------------------------------------------------------------------------*/
multiline_comment|/* calculate the transfer length and update the urb */
DECL|function|dl_transfer_length
r_static
r_void
id|dl_transfer_length
c_func
(paren
id|td_t
op_star
id|td
)paren
(brace
id|__u32
id|tdINFO
comma
id|tdBE
comma
id|tdCBP
suffix:semicolon
id|__u16
id|tdPSW
suffix:semicolon
id|urb_t
op_star
id|urb
op_assign
id|td-&gt;urb
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_int
id|dlen
op_assign
l_int|0
suffix:semicolon
r_int
id|cc
op_assign
l_int|0
suffix:semicolon
id|tdINFO
op_assign
id|le32_to_cpup
(paren
op_amp
id|td-&gt;hwINFO
)paren
suffix:semicolon
id|tdBE
op_assign
id|le32_to_cpup
(paren
op_amp
id|td-&gt;hwBE
)paren
suffix:semicolon
id|tdCBP
op_assign
id|le32_to_cpup
(paren
op_amp
id|td-&gt;hwCBP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tdINFO
op_amp
id|TD_ISO
)paren
(brace
id|tdPSW
op_assign
id|le16_to_cpu
(paren
id|td-&gt;hwPSW
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cc
op_assign
(paren
id|tdPSW
op_rshift
l_int|12
)paren
op_amp
l_int|0xF
suffix:semicolon
r_if
c_cond
(paren
id|cc
OL
l_int|0xE
)paren
(brace
r_if
c_cond
(paren
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|dlen
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|td-&gt;index
)braket
dot
id|length
suffix:semicolon
)brace
r_else
(brace
id|dlen
op_assign
id|tdPSW
op_amp
l_int|0x3ff
suffix:semicolon
)brace
id|urb-&gt;actual_length
op_add_assign
id|dlen
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|td-&gt;index
)braket
dot
id|actual_length
op_assign
id|dlen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
op_logical_and
(paren
id|cc
op_eq
id|TD_DATAUNDERRUN
)paren
)paren
id|cc
op_assign
id|TD_CC_NOERROR
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|td-&gt;index
)braket
dot
id|status
op_assign
id|cc_to_error
(braket
id|cc
)braket
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* BULK, INT, CONTROL DATA */
r_if
c_cond
(paren
op_logical_neg
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_CONTROL
op_logical_and
(paren
(paren
id|td-&gt;index
op_eq
l_int|0
)paren
op_logical_or
(paren
id|td-&gt;index
op_eq
id|urb_priv-&gt;length
op_minus
l_int|1
)paren
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|tdBE
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|td-&gt;hwCBP
op_eq
l_int|0
)paren
id|urb-&gt;actual_length
op_assign
id|bus_to_virt
(paren
id|tdBE
)paren
op_minus
id|urb-&gt;transfer_buffer
op_plus
l_int|1
suffix:semicolon
r_else
id|urb-&gt;actual_length
op_assign
id|bus_to_virt
(paren
id|tdCBP
)paren
op_minus
id|urb-&gt;transfer_buffer
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* handle an urb that is being unlinked */
DECL|function|dl_del_urb
r_static
r_void
id|dl_del_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|wait_queue_head_t
op_star
id|wait_head
op_assign
(paren
(paren
id|urb_priv_t
op_star
)paren
(paren
id|urb-&gt;hcpriv
)paren
)paren
op_member_access_from_pointer
id|wait
suffix:semicolon
id|urb_rm_priv_locked
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ASYNC_UNLINK
)paren
(brace
id|urb-&gt;status
op_assign
op_minus
id|ECONNRESET
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
r_else
(brace
id|urb-&gt;status
op_assign
op_minus
id|ENOENT
suffix:semicolon
multiline_comment|/* unblock sohci_unlink_urb */
r_if
c_cond
(paren
id|wait_head
)paren
id|wake_up
(paren
id|wait_head
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* replies to the request have to be on a FIFO basis so&n; * we reverse the reversed done-list */
DECL|function|dl_reverse_done_list
r_static
id|td_t
op_star
id|dl_reverse_done_list
(paren
id|ohci_t
op_star
id|ohci
)paren
(brace
id|__u32
id|td_list_hc
suffix:semicolon
id|td_t
op_star
id|td_rev
op_assign
l_int|NULL
suffix:semicolon
id|td_t
op_star
id|td_list
op_assign
l_int|NULL
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|td_list_hc
op_assign
id|le32_to_cpup
(paren
op_amp
id|ohci-&gt;hcca.done_head
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
id|ohci-&gt;hcca.done_head
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|td_list_hc
)paren
(brace
id|td_list
op_assign
(paren
id|td_t
op_star
)paren
id|bus_to_virt
(paren
id|td_list_hc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TD_CC_GET
(paren
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwINFO
)paren
)paren
)paren
(brace
id|urb_priv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|td_list-&gt;urb-&gt;hcpriv
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot; USB-error/status: %x : %p&quot;
comma
id|TD_CC_GET
(paren
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwINFO
)paren
)paren
comma
id|td_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td_list-&gt;ed-&gt;hwHeadP
op_amp
id|cpu_to_le32
(paren
l_int|0x1
)paren
)paren
(brace
r_if
c_cond
(paren
id|urb_priv
op_logical_and
(paren
(paren
id|td_list-&gt;index
op_plus
l_int|1
)paren
OL
id|urb_priv-&gt;length
)paren
)paren
(brace
id|td_list-&gt;ed-&gt;hwHeadP
op_assign
(paren
id|urb_priv-&gt;td
(braket
id|urb_priv-&gt;length
op_minus
l_int|1
)braket
op_member_access_from_pointer
id|hwNextTD
op_amp
id|cpu_to_le32
(paren
l_int|0xfffffff0
)paren
)paren
op_or
(paren
id|td_list-&gt;ed-&gt;hwHeadP
op_amp
id|cpu_to_le32
(paren
l_int|0x2
)paren
)paren
suffix:semicolon
id|urb_priv-&gt;td_cnt
op_add_assign
id|urb_priv-&gt;length
op_minus
id|td_list-&gt;index
op_minus
l_int|1
suffix:semicolon
)brace
r_else
id|td_list-&gt;ed-&gt;hwHeadP
op_and_assign
id|cpu_to_le32
(paren
l_int|0xfffffff2
)paren
suffix:semicolon
)brace
)brace
id|td_list-&gt;next_dl_td
op_assign
id|td_rev
suffix:semicolon
id|td_rev
op_assign
id|td_list
suffix:semicolon
id|td_list_hc
op_assign
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwNextTD
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|td_list
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* there are some pending requests to remove &n; * - some of the eds (if ed-&gt;state &amp; ED_DEL (set by sohci_free_dev)&n; * - some URBs/TDs if urb_priv-&gt;state == URB_DEL */
DECL|function|dl_del_list
r_static
r_void
id|dl_del_list
(paren
id|ohci_t
op_star
id|ohci
comma
r_int
r_int
id|frame
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ed_t
op_star
id|ed
suffix:semicolon
id|__u32
id|edINFO
suffix:semicolon
id|__u32
id|tdINFO
suffix:semicolon
id|td_t
op_star
id|td
op_assign
l_int|NULL
comma
op_star
id|td_next
op_assign
l_int|NULL
comma
op_star
id|tdHeadP
op_assign
l_int|NULL
comma
op_star
id|tdTailP
suffix:semicolon
id|__u32
op_star
id|td_p
suffix:semicolon
r_int
id|ctrl
op_assign
l_int|0
comma
id|bulk
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ed
op_assign
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
suffix:semicolon
id|ed
op_ne
l_int|NULL
suffix:semicolon
id|ed
op_assign
id|ed-&gt;ed_rm_list
)paren
(brace
id|tdTailP
op_assign
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwTailP
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|tdHeadP
op_assign
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwHeadP
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
id|edINFO
op_assign
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwINFO
)paren
suffix:semicolon
id|td_p
op_assign
op_amp
id|ed-&gt;hwHeadP
suffix:semicolon
r_for
c_loop
(paren
id|td
op_assign
id|tdHeadP
suffix:semicolon
id|td
op_ne
id|tdTailP
suffix:semicolon
id|td
op_assign
id|td_next
)paren
(brace
id|urb_t
op_star
id|urb
op_assign
id|td-&gt;urb
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|td-&gt;urb-&gt;hcpriv
suffix:semicolon
id|td_next
op_assign
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|td-&gt;hwNextTD
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|urb_priv-&gt;state
op_eq
id|URB_DEL
)paren
op_logical_or
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
)paren
(brace
id|tdINFO
op_assign
id|le32_to_cpup
(paren
op_amp
id|td-&gt;hwINFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TD_CC_GET
(paren
id|tdINFO
)paren
OL
l_int|0xE
)paren
id|dl_transfer_length
(paren
id|td
)paren
suffix:semicolon
op_star
id|td_p
op_assign
id|td-&gt;hwNextTD
op_or
(paren
op_star
id|td_p
op_amp
id|cpu_to_le32
(paren
l_int|0x3
)paren
)paren
suffix:semicolon
multiline_comment|/* URB is done; clean up */
r_if
c_cond
(paren
op_increment
(paren
id|urb_priv-&gt;td_cnt
)paren
op_eq
id|urb_priv-&gt;length
)paren
id|dl_del_urb
(paren
id|urb
)paren
suffix:semicolon
)brace
r_else
(brace
id|td_p
op_assign
op_amp
id|td-&gt;hwNextTD
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ed-&gt;state
op_amp
id|ED_DEL
)paren
(brace
multiline_comment|/* set by sohci_free_dev */
r_struct
id|ohci_device
op_star
id|dev
op_assign
id|usb_to_ohci
(paren
id|ohci-&gt;dev
(braket
id|edINFO
op_amp
l_int|0x7F
)braket
)paren
suffix:semicolon
id|td_free
(paren
id|ohci
comma
id|tdTailP
)paren
suffix:semicolon
multiline_comment|/* free dummy td */
id|ed-&gt;hwINFO
op_assign
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
id|ed-&gt;state
op_assign
id|ED_NEW
suffix:semicolon
multiline_comment|/* if all eds are removed wake up sohci_free_dev */
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|dev-&gt;ed_cnt
)paren
(brace
id|wait_queue_head_t
op_star
id|wait_head
op_assign
id|dev-&gt;wait
suffix:semicolon
id|dev-&gt;wait
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|wait_head
)paren
id|wake_up
(paren
id|wait_head
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|ed-&gt;state
op_and_assign
op_complement
id|ED_URB_DEL
suffix:semicolon
id|tdHeadP
op_assign
id|bus_to_virt
(paren
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwHeadP
)paren
op_amp
l_int|0xfffffff0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tdHeadP
op_eq
id|tdTailP
)paren
(brace
r_if
c_cond
(paren
id|ed-&gt;state
op_eq
id|ED_OPER
)paren
id|ep_unlink
c_func
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
id|td_free
(paren
id|ohci
comma
id|tdTailP
)paren
suffix:semicolon
id|ed-&gt;hwINFO
op_assign
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
id|ed-&gt;state
op_assign
id|ED_NEW
suffix:semicolon
op_decrement
(paren
id|usb_to_ohci
(paren
id|ohci-&gt;dev
(braket
id|edINFO
op_amp
l_int|0x7F
)braket
)paren
)paren
op_member_access_from_pointer
id|ed_cnt
suffix:semicolon
)brace
r_else
id|ed-&gt;hwINFO
op_and_assign
op_complement
id|cpu_to_le32
(paren
id|OHCI_ED_SKIP
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ed-&gt;type
)paren
(brace
r_case
id|PIPE_CONTROL
suffix:colon
id|ctrl
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
id|bulk
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* maybe reenable control and bulk lists */
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;disabled
)paren
(brace
r_if
c_cond
(paren
id|ctrl
)paren
multiline_comment|/* reset control list */
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlcurrent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bulk
)paren
multiline_comment|/* reset bulk list */
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkcurrent
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
op_logical_neg
id|frame
)braket
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
)paren
id|ohci-&gt;hc_control
op_or_assign
id|OHCI_CTRL_CLE
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
)paren
id|ohci-&gt;hc_control
op_or_assign
id|OHCI_CTRL_BLE
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
)brace
)brace
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* td done list */
DECL|function|dl_done_list
r_static
r_void
id|dl_done_list
(paren
id|ohci_t
op_star
id|ohci
comma
id|td_t
op_star
id|td_list
)paren
(brace
id|td_t
op_star
id|td_list_next
op_assign
l_int|NULL
suffix:semicolon
id|ed_t
op_star
id|ed
suffix:semicolon
r_int
id|cc
op_assign
l_int|0
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
id|__u32
id|tdINFO
comma
id|edHeadP
comma
id|edTailP
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_while
c_loop
(paren
id|td_list
)paren
(brace
id|td_list_next
op_assign
id|td_list-&gt;next_dl_td
suffix:semicolon
id|urb
op_assign
id|td_list-&gt;urb
suffix:semicolon
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|tdINFO
op_assign
id|le32_to_cpup
(paren
op_amp
id|td_list-&gt;hwINFO
)paren
suffix:semicolon
id|ed
op_assign
id|td_list-&gt;ed
suffix:semicolon
id|dl_transfer_length
c_func
(paren
id|td_list
)paren
suffix:semicolon
multiline_comment|/* error code of transfer */
id|cc
op_assign
id|TD_CC_GET
(paren
id|tdINFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cc
op_eq
id|TD_CC_STALL
)paren
id|usb_endpoint_halt
c_func
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
op_logical_and
(paren
id|cc
op_eq
id|TD_DATAUNDERRUN
)paren
)paren
id|cc
op_assign
id|TD_CC_NOERROR
suffix:semicolon
r_if
c_cond
(paren
op_increment
(paren
id|urb_priv-&gt;td_cnt
)paren
op_eq
id|urb_priv-&gt;length
)paren
(brace
r_if
c_cond
(paren
(paren
id|ed-&gt;state
op_amp
(paren
id|ED_OPER
op_or
id|ED_UNLINK
)paren
)paren
op_logical_and
(paren
id|urb_priv-&gt;state
op_ne
id|URB_DEL
)paren
)paren
(brace
id|urb-&gt;status
op_assign
id|cc_to_error
(braket
id|cc
)braket
suffix:semicolon
id|sohci_return_urb
(paren
id|urb
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|dl_del_urb
(paren
id|urb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ed-&gt;state
op_ne
id|ED_NEW
)paren
(brace
id|edHeadP
op_assign
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwHeadP
)paren
op_amp
l_int|0xfffffff0
suffix:semicolon
id|edTailP
op_assign
id|le32_to_cpup
(paren
op_amp
id|ed-&gt;hwTailP
)paren
suffix:semicolon
multiline_comment|/* unlink eds if they are not busy */
r_if
c_cond
(paren
(paren
id|edHeadP
op_eq
id|edTailP
)paren
op_logical_and
(paren
id|ed-&gt;state
op_eq
id|ED_OPER
)paren
)paren
id|ep_unlink
(paren
id|ohci
comma
id|ed
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|usb_ed_lock
comma
id|flags
)paren
suffix:semicolon
id|td_list
op_assign
id|td_list_next
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------------*&n; * Virtual Root Hub &n; *-------------------------------------------------------------------------*/
multiline_comment|/* Device descriptor */
DECL|variable|root_hub_dev_des
r_static
id|__u8
id|root_hub_dev_des
(braket
)braket
op_assign
(brace
l_int|0x12
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x01
comma
multiline_comment|/*  __u8  bDescriptorType; Device */
l_int|0x10
comma
multiline_comment|/*  __u16 bcdUSB; v1.1 */
l_int|0x01
comma
l_int|0x09
comma
multiline_comment|/*  __u8  bDeviceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceProtocol; */
l_int|0x08
comma
multiline_comment|/*  __u8  bMaxPacketSize0; 8 Bytes */
l_int|0x00
comma
multiline_comment|/*  __u16 idVendor; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 idProduct; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 bcdDevice; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u8  iManufacturer; */
l_int|0x02
comma
multiline_comment|/*  __u8  iProduct; */
l_int|0x01
comma
multiline_comment|/*  __u8  iSerialNumber; */
l_int|0x01
multiline_comment|/*  __u8  bNumConfigurations; */
)brace
suffix:semicolon
multiline_comment|/* Configuration descriptor */
DECL|variable|root_hub_config_des
r_static
id|__u8
id|root_hub_config_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x02
comma
multiline_comment|/*  __u8  bDescriptorType; Configuration */
l_int|0x19
comma
multiline_comment|/*  __u16 wTotalLength; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bNumInterfaces; */
l_int|0x01
comma
multiline_comment|/*  __u8  bConfigurationValue; */
l_int|0x00
comma
multiline_comment|/*  __u8  iConfiguration; */
l_int|0x40
comma
multiline_comment|/*  __u8  bmAttributes; &n;                 Bit 7: Bus-powered, 6: Self-powered, 5 Remote-wakwup, 4..0: resvd */
l_int|0x00
comma
multiline_comment|/*  __u8  MaxPower; */
multiline_comment|/* interface */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bLength; */
l_int|0x04
comma
multiline_comment|/*  __u8  if_bDescriptorType; Interface */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceNumber; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bAlternateSetting; */
l_int|0x01
comma
multiline_comment|/*  __u8  if_bNumEndpoints; */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bInterfaceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceProtocol; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_iInterface; */
multiline_comment|/* endpoint */
l_int|0x07
comma
multiline_comment|/*  __u8  ep_bLength; */
l_int|0x05
comma
multiline_comment|/*  __u8  ep_bDescriptorType; Endpoint */
l_int|0x81
comma
multiline_comment|/*  __u8  ep_bEndpointAddress; IN Endpoint 1 */
l_int|0x03
comma
multiline_comment|/*  __u8  ep_bmAttributes; Interrupt */
l_int|0x02
comma
multiline_comment|/*  __u16 ep_wMaxPacketSize; ((MAX_ROOT_PORTS + 1) / 8 */
l_int|0x00
comma
l_int|0xff
multiline_comment|/*  __u8  ep_bInterval; 255 ms */
)brace
suffix:semicolon
multiline_comment|/* Hub class-specific descriptor is constructed dynamically */
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* prepare Interrupt pipe data; HUB INTERRUPT ENDPOINT */
DECL|function|rh_send_irq
r_static
r_int
id|rh_send_irq
(paren
id|ohci_t
op_star
id|ohci
comma
r_void
op_star
id|rh_data
comma
r_int
id|rh_len
)paren
(brace
r_int
id|num_ports
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|len
suffix:semicolon
id|__u8
id|data
(braket
l_int|8
)braket
suffix:semicolon
id|num_ports
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_amp
id|RH_A_NDP
suffix:semicolon
r_if
c_cond
(paren
id|num_ports
OG
id|MAX_ROOT_PORTS
)paren
(brace
id|err
(paren
l_string|&quot;bogus NDP=%d for OHCI usb-%s&quot;
comma
id|num_ports
comma
id|ohci-&gt;ohci_dev-&gt;slot_name
)paren
suffix:semicolon
id|err
(paren
l_string|&quot;rereads as NDP=%d&quot;
comma
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_amp
id|RH_A_NDP
)paren
suffix:semicolon
multiline_comment|/* retry later; &quot;should not happen&quot; */
r_return
l_int|0
suffix:semicolon
)brace
op_star
(paren
id|__u8
op_star
)paren
id|data
op_assign
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
op_amp
(paren
id|RH_HS_LPSC
op_or
id|RH_HS_OCIC
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|ret
op_assign
op_star
(paren
id|__u8
op_star
)paren
id|data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
op_or_assign
(paren
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.portstatus
(braket
id|i
)braket
)paren
op_amp
(paren
id|RH_PS_CSC
op_or
id|RH_PS_PESC
op_or
id|RH_PS_PSSC
op_or
id|RH_PS_OCIC
op_or
id|RH_PS_PRSC
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_lshift
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|8
)paren
suffix:semicolon
id|ret
op_add_assign
op_star
(paren
id|__u8
op_star
)paren
(paren
id|data
op_plus
(paren
id|i
op_plus
l_int|1
)paren
op_div
l_int|8
)paren
suffix:semicolon
)brace
id|len
op_assign
id|i
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
(brace
id|memcpy
(paren
id|rh_data
comma
id|data
comma
id|min
(paren
id|len
comma
id|min
(paren
id|rh_len
comma
r_sizeof
(paren
id|data
)paren
)paren
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Virtual Root Hub INTs are polled by this timer every &quot;interval&quot; ms */
DECL|function|rh_int_timer_do
r_static
r_void
id|rh_int_timer_do
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
id|len
suffix:semicolon
id|urb_t
op_star
id|urb
op_assign
(paren
id|urb_t
op_star
)paren
id|ptr
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;disabled
)paren
r_return
suffix:semicolon
multiline_comment|/* ignore timers firing during PM suspend, etc */
r_if
c_cond
(paren
(paren
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
)paren
op_ne
id|OHCI_USB_OPER
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;rh.send
)paren
(brace
id|len
op_assign
id|rh_send_irq
(paren
id|ohci
comma
id|urb-&gt;transfer_buffer
comma
id|urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;RET-t(rh)&quot;
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|rh_init_int_timer
(paren
id|urb
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Root Hub INTs are polled by this timer */
DECL|function|rh_init_int_timer
r_static
r_int
id|rh_init_int_timer
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|ohci-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|init_timer
(paren
op_amp
id|ohci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
id|ohci-&gt;rh.rh_int_timer.function
op_assign
id|rh_int_timer_do
suffix:semicolon
id|ohci-&gt;rh.rh_int_timer.data
op_assign
(paren
r_int
r_int
)paren
id|urb
suffix:semicolon
id|ohci-&gt;rh.rh_int_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
(paren
id|urb-&gt;interval
OL
l_int|30
ques
c_cond
l_int|30
suffix:colon
id|urb-&gt;interval
)paren
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
(paren
op_amp
id|ohci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|OK
mdefine_line|#define OK(x) &t;&t;&t;len = (x); break
DECL|macro|WR_RH_STAT
mdefine_line|#define WR_RH_STAT(x) &t;&t;writel((x), &amp;ohci-&gt;regs-&gt;roothub.status)
DECL|macro|WR_RH_PORTSTAT
mdefine_line|#define WR_RH_PORTSTAT(x) &t;writel((x), &amp;ohci-&gt;regs-&gt;roothub.portstatus[wIndex-1])
DECL|macro|RD_RH_STAT
mdefine_line|#define RD_RH_STAT&t;&t;readl(&amp;ohci-&gt;regs-&gt;roothub.status)
DECL|macro|RD_RH_PORTSTAT
mdefine_line|#define RD_RH_PORTSTAT&t;&t;readl(&amp;ohci-&gt;regs-&gt;roothub.portstatus[wIndex-1])
multiline_comment|/* request to virtual root hub */
DECL|function|rh_submit_urb
r_static
r_int
id|rh_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_struct
id|usb_device
op_star
id|usb_dev
op_assign
id|urb-&gt;dev
suffix:semicolon
id|ohci_t
op_star
id|ohci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
id|devrequest
op_star
id|cmd
op_assign
(paren
id|devrequest
op_star
)paren
id|urb-&gt;setup_packet
suffix:semicolon
r_void
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|leni
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|status
op_assign
id|TD_CC_NOERROR
suffix:semicolon
id|__u32
id|datab
(braket
l_int|4
)braket
suffix:semicolon
id|__u8
op_star
id|data_buf
op_assign
(paren
id|__u8
op_star
)paren
id|datab
suffix:semicolon
id|__u16
id|bmRType_bReq
suffix:semicolon
id|__u16
id|wValue
suffix:semicolon
id|__u16
id|wIndex
suffix:semicolon
id|__u16
id|wLength
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipeint
c_func
(paren
id|pipe
)paren
)paren
(brace
id|ohci-&gt;rh.urb
op_assign
id|urb
suffix:semicolon
id|ohci-&gt;rh.send
op_assign
l_int|1
suffix:semicolon
id|ohci-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|rh_init_int_timer
c_func
(paren
id|urb
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
id|cc_to_error
(braket
id|TD_CC_NOERROR
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bmRType_bReq
op_assign
id|cmd-&gt;requesttype
op_or
(paren
id|cmd-&gt;request
op_lshift
l_int|8
)paren
suffix:semicolon
id|wValue
op_assign
id|le16_to_cpu
(paren
id|cmd-&gt;value
)paren
suffix:semicolon
id|wIndex
op_assign
id|le16_to_cpu
(paren
id|cmd-&gt;index
)paren
suffix:semicolon
id|wLength
op_assign
id|le16_to_cpu
(paren
id|cmd-&gt;length
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;rh_submit_urb, req = %d(%x) len=%d&quot;
comma
id|bmRType_bReq
comma
id|bmRType_bReq
comma
id|wLength
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|bmRType_bReq
)paren
(brace
multiline_comment|/* Request Destination:&n;&t;   without flags: Device, &n;&t;   RH_INTERFACE: interface, &n;&t;   RH_ENDPOINT: endpoint,&n;&t;   RH_CLASS means HUB here, &n;&t;   RH_OTHER | RH_CLASS  almost ever means HUB_PORT here &n;&t;*/
r_case
id|RH_GET_STATUS
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_INTERFACE
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_ENDPOINT
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u32
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le32
(paren
id|RD_RH_STAT
op_amp
op_complement
(paren
id|RH_HS_CRWE
op_or
id|RH_HS_DRWE
)paren
)paren
suffix:semicolon
id|OK
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u32
op_star
)paren
id|data_buf
op_assign
id|cpu_to_le32
(paren
id|RD_RH_PORTSTAT
)paren
suffix:semicolon
id|OK
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_ENDPOINT
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_ENDPOINT_STALL
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
id|RH_C_HUB_LOCAL_POWER
suffix:colon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_HUB_OVER_CURRENT
)paren
suffix:colon
id|WR_RH_STAT
c_func
(paren
id|RH_HS_OCIC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_CCS
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_POCI
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_LSDA
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_CONNECTION
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_CSC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_ENABLE
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PESC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_SUSPEND
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PSSC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_OVER_CURRENT
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_OCIC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_RESET
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PRSC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PSS
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_RESET
)paren
suffix:colon
multiline_comment|/* BUG IN HUP CODE *********/
r_if
c_cond
(paren
id|RD_RH_PORTSTAT
op_amp
id|RH_PS_CCS
)paren
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PRS
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PPS
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
multiline_comment|/* BUG IN HUP CODE *********/
r_if
c_cond
(paren
id|RD_RH_PORTSTAT
op_amp
id|RH_PS_CCS
)paren
id|WR_RH_PORTSTAT
(paren
id|RH_PS_PES
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_ADDRESS
suffix:colon
id|ohci-&gt;rh.devnum
op_assign
id|wValue
suffix:semicolon
id|OK
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
suffix:colon
r_switch
c_cond
(paren
(paren
id|wValue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
(brace
r_case
(paren
l_int|0x01
)paren
suffix:colon
multiline_comment|/* device descriptor */
id|len
op_assign
id|min
(paren
id|leni
comma
id|min
(paren
r_sizeof
(paren
id|root_hub_dev_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|data_buf
op_assign
id|root_hub_dev_des
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x02
)paren
suffix:colon
multiline_comment|/* configuration descriptor */
id|len
op_assign
id|min
(paren
id|leni
comma
id|min
(paren
r_sizeof
(paren
id|root_hub_config_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|data_buf
op_assign
id|root_hub_config_des
suffix:semicolon
id|OK
c_func
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x03
)paren
suffix:colon
multiline_comment|/* string descriptors */
id|len
op_assign
id|usb_root_hub_string
(paren
id|wValue
op_amp
l_int|0xff
comma
(paren
r_int
)paren
(paren
r_int
)paren
id|ohci-&gt;regs
comma
l_string|&quot;OHCI&quot;
comma
id|data
comma
id|wLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|data_buf
op_assign
id|data
suffix:semicolon
id|OK
(paren
id|min
(paren
id|leni
comma
id|len
)paren
)paren
suffix:semicolon
)brace
singleline_comment|// else fallthrough
r_default
suffix:colon
id|status
op_assign
id|TD_CC_STALL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
op_or
id|RH_CLASS
suffix:colon
(brace
id|__u32
id|temp
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
suffix:semicolon
id|data_buf
(braket
l_int|0
)braket
op_assign
l_int|9
suffix:semicolon
singleline_comment|// min length;
id|data_buf
(braket
l_int|1
)braket
op_assign
l_int|0x29
suffix:semicolon
id|data_buf
(braket
l_int|2
)braket
op_assign
id|temp
op_amp
id|RH_A_NDP
suffix:semicolon
id|data_buf
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|RH_A_PSM
)paren
multiline_comment|/* per-port power switching? */
id|data_buf
(braket
l_int|3
)braket
op_or_assign
l_int|0x1
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|RH_A_NOCP
)paren
multiline_comment|/* no overcurrent reporting? */
id|data_buf
(braket
l_int|3
)braket
op_or_assign
l_int|0x10
suffix:semicolon
r_else
r_if
c_cond
(paren
id|temp
op_amp
id|RH_A_OCPM
)paren
multiline_comment|/* per-port overcurrent reporting? */
id|data_buf
(braket
l_int|3
)braket
op_or_assign
l_int|0x8
suffix:semicolon
id|datab
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|data_buf
(braket
l_int|5
)braket
op_assign
(paren
id|temp
op_amp
id|RH_A_POTPGT
)paren
op_rshift
l_int|24
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.b
)paren
suffix:semicolon
id|data_buf
(braket
l_int|7
)braket
op_assign
id|temp
op_amp
id|RH_B_DR
suffix:semicolon
r_if
c_cond
(paren
id|data_buf
(braket
l_int|2
)braket
OL
l_int|7
)paren
(brace
id|data_buf
(braket
l_int|8
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
id|data_buf
(braket
l_int|0
)braket
op_add_assign
l_int|2
suffix:semicolon
id|data_buf
(braket
l_int|8
)braket
op_assign
(paren
id|temp
op_amp
id|RH_B_DR
)paren
op_rshift
l_int|8
suffix:semicolon
id|data_buf
(braket
l_int|10
)braket
op_assign
id|data_buf
(braket
l_int|9
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
id|len
op_assign
id|min
(paren
id|leni
comma
id|min
(paren
id|data_buf
(braket
l_int|0
)braket
comma
id|wLength
)paren
)paren
suffix:semicolon
id|OK
(paren
id|len
)paren
suffix:semicolon
)brace
r_case
id|RH_GET_CONFIGURATION
suffix:colon
op_star
(paren
id|__u8
op_star
)paren
id|data_buf
op_assign
l_int|0x01
suffix:semicolon
id|OK
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|RH_SET_CONFIGURATION
suffix:colon
id|WR_RH_STAT
(paren
l_int|0x10000
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|dbg
(paren
l_string|&quot;unsupported root hub command&quot;
)paren
suffix:semicolon
id|status
op_assign
id|TD_CC_STALL
suffix:semicolon
)brace
macro_line|#ifdef&t;DEBUG
singleline_comment|// ohci_dump_roothub (ohci, 0);
macro_line|#endif
id|len
op_assign
id|min
c_func
(paren
id|len
comma
id|leni
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ne
id|data_buf
)paren
id|memcpy
(paren
id|data
comma
id|data_buf
comma
id|len
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
id|urb-&gt;status
op_assign
id|cc_to_error
(braket
id|status
)braket
suffix:semicolon
macro_line|#ifdef DEBUG
id|urb_print
(paren
id|urb
comma
l_string|&quot;RET(rh)&quot;
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
id|urb-&gt;hcpriv
op_assign
l_int|NULL
suffix:semicolon
id|usb_dec_dev_use
(paren
id|usb_dev
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|rh_unlink_urb
r_static
r_int
id|rh_unlink_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;rh.urb
op_eq
id|urb
)paren
(brace
id|ohci-&gt;rh.send
op_assign
l_int|0
suffix:semicolon
id|del_timer
(paren
op_amp
id|ohci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
id|ohci-&gt;rh.urb
op_assign
l_int|NULL
suffix:semicolon
id|urb-&gt;hcpriv
op_assign
l_int|NULL
suffix:semicolon
id|usb_dec_dev_use
c_func
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ASYNC_UNLINK
)paren
(brace
id|urb-&gt;status
op_assign
op_minus
id|ECONNRESET
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
r_else
id|urb-&gt;status
op_assign
op_minus
id|ENOENT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*&n; * HC functions&n; *-------------------------------------------------------------------------*/
multiline_comment|/* reset the HC and BUS */
DECL|function|hc_reset
r_static
r_int
id|hc_reset
(paren
id|ohci_t
op_star
id|ohci
)paren
(brace
r_int
id|timeout
op_assign
l_int|30
suffix:semicolon
r_int
id|smm_timeout
op_assign
l_int|50
suffix:semicolon
multiline_comment|/* 0,5 sec */
r_if
c_cond
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
id|OHCI_CTRL_IR
)paren
(brace
multiline_comment|/* SMM owns the HC */
id|writel
(paren
id|OHCI_OCR
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
multiline_comment|/* request ownership */
id|dbg
c_func
(paren
l_string|&quot;USB HC TakeOver from SMM&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
op_amp
id|OHCI_CTRL_IR
)paren
(brace
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|smm_timeout
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;USB HC TakeOver failed!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Disable HC interrupts */
id|writel
(paren
id|OHCI_INTR_MIE
comma
op_amp
id|ohci-&gt;regs-&gt;intrdisable
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;USB HC reset_hc usb-%s: ctrl = 0x%x ;&quot;
comma
id|ohci-&gt;ohci_dev-&gt;slot_name
comma
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
)paren
suffix:semicolon
multiline_comment|/* Reset USB (needed by some controllers) */
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* HC Reset requires max 10 ms delay */
id|writel
(paren
id|OHCI_HCR
comma
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;cmdstatus
)paren
op_amp
id|OHCI_HCR
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|timeout
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;USB HC reset timed out!&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|udelay
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Start an OHCI controller, set the BUS operational&n; * enable interrupts &n; * connect the virtual root hub */
DECL|function|hc_start
r_static
r_int
id|hc_start
(paren
id|ohci_t
op_star
id|ohci
)paren
(brace
id|__u32
id|mask
suffix:semicolon
r_int
r_int
id|fminterval
suffix:semicolon
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
r_struct
id|ohci_device
op_star
id|dev
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Tell the controller where the control and bulk lists are&n;&t; * The lists are empty now. */
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_controlhead
)paren
suffix:semicolon
id|writel
(paren
l_int|0
comma
op_amp
id|ohci-&gt;regs-&gt;ed_bulkhead
)paren
suffix:semicolon
id|writel
(paren
id|virt_to_bus
(paren
op_amp
id|ohci-&gt;hcca
)paren
comma
op_amp
id|ohci-&gt;regs-&gt;hcca
)paren
suffix:semicolon
multiline_comment|/* a reset clears this */
id|fminterval
op_assign
l_int|0x2edf
suffix:semicolon
id|writel
(paren
(paren
id|fminterval
op_star
l_int|9
)paren
op_div
l_int|10
comma
op_amp
id|ohci-&gt;regs-&gt;periodicstart
)paren
suffix:semicolon
id|fminterval
op_or_assign
(paren
(paren
(paren
(paren
id|fminterval
op_minus
l_int|210
)paren
op_star
l_int|6
)paren
op_div
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|writel
(paren
id|fminterval
comma
op_amp
id|ohci-&gt;regs-&gt;fminterval
)paren
suffix:semicolon
id|writel
(paren
l_int|0x628
comma
op_amp
id|ohci-&gt;regs-&gt;lsthresh
)paren
suffix:semicolon
multiline_comment|/* start controller operations */
id|ohci-&gt;hc_control
op_assign
id|OHCI_CONTROL_INIT
op_or
id|OHCI_USB_OPER
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|0
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
multiline_comment|/* Choose the interrupts we care about now, others later on demand */
id|mask
op_assign
id|OHCI_INTR_MIE
op_or
id|OHCI_INTR_UE
op_or
id|OHCI_INTR_WDH
op_or
id|OHCI_INTR_SO
suffix:semicolon
id|writel
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrenable
)paren
suffix:semicolon
id|writel
(paren
id|mask
comma
op_amp
id|ohci-&gt;regs-&gt;intrstatus
)paren
suffix:semicolon
macro_line|#ifdef&t;OHCI_USE_NPS
id|writel
(paren
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_or
id|RH_A_NPS
)paren
op_amp
op_complement
id|RH_A_PSM
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
suffix:semicolon
id|writel
(paren
id|RH_HS_LPSC
comma
op_amp
id|ohci-&gt;regs-&gt;roothub.status
)paren
suffix:semicolon
macro_line|#endif&t;/* OHCI_USE_NPS */
singleline_comment|// POTPGT delay is bits 24-31, in 2 ms units.
id|mdelay
(paren
(paren
id|readl
c_func
(paren
op_amp
id|ohci-&gt;regs-&gt;roothub.a
)paren
op_rshift
l_int|23
)paren
op_amp
l_int|0x1fe
)paren
suffix:semicolon
multiline_comment|/* connect the virtual root hub */
id|ohci-&gt;rh.devnum
op_assign
l_int|0
suffix:semicolon
id|usb_dev
op_assign
id|usb_alloc_dev
(paren
l_int|NULL
comma
id|ohci-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_dev
)paren
(brace
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev
op_assign
id|usb_to_ohci
(paren
id|usb_dev
)paren
suffix:semicolon
id|ohci-&gt;bus-&gt;root_hub
op_assign
id|usb_dev
suffix:semicolon
id|usb_connect
(paren
id|usb_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_new_device
(paren
id|usb_dev
)paren
op_ne
l_int|0
)paren
(brace
id|usb_free_dev
(paren
id|usb_dev
)paren
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* an interrupt happens */
DECL|function|hc_interrupt
r_static
r_void
id|hc_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|__ohci
comma
r_struct
id|pt_regs
op_star
id|r
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
id|__ohci
suffix:semicolon
r_struct
id|ohci_regs
op_star
id|regs
op_assign
id|ohci-&gt;regs
suffix:semicolon
r_int
id|ints
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ohci-&gt;hcca.done_head
op_ne
l_int|0
)paren
op_logical_and
op_logical_neg
(paren
id|le32_to_cpup
(paren
op_amp
id|ohci-&gt;hcca.done_head
)paren
op_amp
l_int|0x01
)paren
)paren
(brace
id|ints
op_assign
id|OHCI_INTR_WDH
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ints
op_assign
(paren
id|readl
(paren
op_amp
id|regs-&gt;intrstatus
)paren
op_amp
id|readl
(paren
op_amp
id|regs-&gt;intrenable
)paren
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
singleline_comment|// dbg(&quot;Interrupt: %x frame: %x&quot;, ints, le16_to_cpu (ohci-&gt;hcca.frame_no));
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_UE
)paren
(brace
id|ohci-&gt;disabled
op_increment
suffix:semicolon
id|err
(paren
l_string|&quot;OHCI Unrecoverable Error, controller usb-%s disabled&quot;
comma
id|ohci-&gt;ohci_dev-&gt;slot_name
)paren
suffix:semicolon
singleline_comment|// e.g. due to PCI Master/Target Abort
macro_line|#ifdef&t;DEBUG
id|ohci_dump
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
macro_line|#else
singleline_comment|// FIXME: be optimistic, hope that bug won&squot;t repeat often.
singleline_comment|// Make some non-interrupt context restart the controller.
singleline_comment|// Count and limit the retries though; either hardware or
singleline_comment|// software errors can go forever...
macro_line|#endif
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_WDH
)paren
(brace
id|writel
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
id|dl_done_list
(paren
id|ohci
comma
id|dl_reverse_done_list
(paren
id|ohci
)paren
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_WDH
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_SO
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;USB Schedule overrun&quot;
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SO
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
op_amp
id|OHCI_INTR_SF
)paren
(brace
r_int
r_int
id|frame
op_assign
id|le16_to_cpu
(paren
id|ohci-&gt;hcca.frame_no
)paren
op_amp
l_int|1
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|regs-&gt;intrdisable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_rm_list
(braket
op_logical_neg
id|frame
)braket
op_ne
l_int|NULL
)paren
(brace
id|dl_del_list
(paren
id|ohci
comma
op_logical_neg
id|frame
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;ed_rm_list
(braket
id|frame
)braket
op_ne
l_int|NULL
)paren
id|writel
(paren
id|OHCI_INTR_SF
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
)brace
id|writel
(paren
id|ints
comma
op_amp
id|regs-&gt;intrstatus
)paren
suffix:semicolon
id|writel
(paren
id|OHCI_INTR_MIE
comma
op_amp
id|regs-&gt;intrenable
)paren
suffix:semicolon
multiline_comment|/* FIXME:  check URB timeouts */
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* allocate OHCI */
DECL|function|hc_alloc_ohci
r_static
id|ohci_t
op_star
id|__devinit
id|hc_alloc_ohci
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_void
op_star
id|mem_base
)paren
(brace
id|ohci_t
op_star
id|ohci
suffix:semicolon
r_struct
id|usb_bus
op_star
id|bus
suffix:semicolon
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|kmalloc
(paren
r_sizeof
op_star
id|ohci
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
(paren
id|ohci
comma
l_int|0
comma
r_sizeof
(paren
id|ohci_t
)paren
)paren
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
id|ohci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|ohci-&gt;regs
op_assign
id|mem_base
suffix:semicolon
id|ohci-&gt;ohci_dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;driver_data
op_assign
id|ohci
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
comma
op_amp
id|ohci_hcd_list
)paren
suffix:semicolon
id|bus
op_assign
id|usb_alloc_bus
(paren
op_amp
id|sohci_device_operations
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|kfree
(paren
id|ohci
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ohci-&gt;bus
op_assign
id|bus
suffix:semicolon
id|bus-&gt;hcpriv
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
r_return
id|ohci
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* De-allocate all resources.. */
DECL|function|hc_release_ohci
r_static
r_void
id|hc_release_ohci
(paren
id|ohci_t
op_star
id|ohci
)paren
(brace
id|dbg
(paren
l_string|&quot;USB HC release ohci usb-%s&quot;
comma
id|ohci-&gt;ohci_dev-&gt;slot_name
)paren
suffix:semicolon
multiline_comment|/* disconnect all devices */
r_if
c_cond
(paren
id|ohci-&gt;bus-&gt;root_hub
)paren
id|usb_disconnect
(paren
op_amp
id|ohci-&gt;bus-&gt;root_hub
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;disabled
)paren
id|hc_reset
(paren
id|ohci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;irq
op_ge
l_int|0
)paren
(brace
id|free_irq
(paren
id|ohci-&gt;irq
comma
id|ohci
)paren
suffix:semicolon
id|ohci-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|ohci-&gt;ohci_dev-&gt;driver_data
op_assign
l_int|0
suffix:semicolon
id|usb_deregister_bus
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
id|usb_free_bus
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|ohci-&gt;ohci_hcd_list
)paren
suffix:semicolon
multiline_comment|/* unmap the IO address space */
id|iounmap
(paren
id|ohci-&gt;regs
)paren
suffix:semicolon
id|kfree
(paren
id|ohci
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Increment the module usage count, start the control thread and&n; * return success. */
DECL|variable|ohci_pci_driver
r_static
r_struct
id|pci_driver
id|ohci_pci_driver
suffix:semicolon
r_static
r_int
id|__devinit
DECL|function|hc_found_ohci
id|hc_found_ohci
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|irq
comma
r_void
op_star
id|mem_base
)paren
(brace
id|ohci_t
op_star
id|ohci
suffix:semicolon
id|u8
id|latency
comma
id|limit
suffix:semicolon
r_char
id|buf
(braket
l_int|8
)braket
comma
op_star
id|bufp
op_assign
id|buf
suffix:semicolon
macro_line|#ifndef __sparc__
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&quot;
comma
id|irq
)paren
suffix:semicolon
macro_line|#else
id|bufp
op_assign
id|__irq_itoa
c_func
(paren
id|irq
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
id|__FILE__
l_string|&quot;: USB OHCI at membase 0x%lx, IRQ %s&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|mem_base
comma
id|bufp
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|__FILE__
l_string|&quot;: usb-%s, %s&bslash;n&quot;
comma
id|dev-&gt;slot_name
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|ohci
op_assign
id|hc_alloc_ohci
(paren
id|dev
comma
id|mem_base
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* bad pci latencies can contribute to overruns */
id|pci_read_config_byte
(paren
id|dev
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|latency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|latency
)paren
(brace
id|pci_read_config_byte
(paren
id|dev
comma
id|PCI_MAX_LAT
comma
op_amp
id|limit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_logical_and
id|limit
OL
id|latency
)paren
(brace
id|dbg
(paren
l_string|&quot;PCI latency reduced to max %d&quot;
comma
id|limit
)paren
suffix:semicolon
id|pci_write_config_byte
(paren
id|dev
comma
id|PCI_LATENCY_TIMER
comma
id|limit
)paren
suffix:semicolon
id|ohci-&gt;pci_latency
op_assign
id|limit
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* it might already have been reduced */
id|ohci-&gt;pci_latency
op_assign
id|latency
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hc_reset
(paren
id|ohci
)paren
OL
l_int|0
)paren
(brace
id|hc_release_ohci
(paren
id|ohci
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* FIXME this is a second HC reset; why?? */
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
id|OHCI_USB_RESET
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
id|usb_register_bus
(paren
id|ohci-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|irq
comma
id|hc_interrupt
comma
id|SA_SHIRQ
comma
id|ohci_pci_driver.name
comma
id|ohci
)paren
op_ne
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;request interrupt %s failed&quot;
comma
id|bufp
)paren
suffix:semicolon
id|hc_release_ohci
(paren
id|ohci
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|ohci-&gt;irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|hc_start
(paren
id|ohci
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;can&squot;t start usb-%s&quot;
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
id|hc_release_ohci
(paren
id|ohci
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#ifdef&t;DEBUG
id|ohci_dump
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
macro_line|#ifdef&t;CONFIG_PM
multiline_comment|/* controller died; cleanup debris, then restart */
multiline_comment|/* must not be called from interrupt context */
DECL|function|hc_restart
r_static
r_void
id|hc_restart
(paren
id|ohci_t
op_star
id|ohci
)paren
(brace
r_int
id|temp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;pci_latency
)paren
id|pci_write_config_byte
(paren
id|ohci-&gt;ohci_dev
comma
id|PCI_LATENCY_TIMER
comma
id|ohci-&gt;pci_latency
)paren
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;bus-&gt;root_hub
)paren
id|usb_disconnect
(paren
op_amp
id|ohci-&gt;bus-&gt;root_hub
)paren
suffix:semicolon
multiline_comment|/* empty the interrupt branches */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTS
suffix:semicolon
id|i
op_increment
)paren
id|ohci-&gt;ohci_int_load
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_INTS
suffix:semicolon
id|i
op_increment
)paren
id|ohci-&gt;hcca.int_table
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EDs to remove */
id|ohci-&gt;ed_rm_list
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_rm_list
(braket
l_int|1
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* empty control and bulk lists */
id|ohci-&gt;ed_isotail
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_controltail
op_assign
l_int|NULL
suffix:semicolon
id|ohci-&gt;ed_bulktail
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_assign
id|hc_reset
(paren
id|ohci
)paren
)paren
OL
l_int|0
op_logical_or
(paren
id|temp
op_assign
id|hc_start
(paren
id|ohci
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
(paren
l_string|&quot;can&squot;t restart usb-%s, %d&quot;
comma
id|ohci-&gt;ohci_dev-&gt;slot_name
comma
id|temp
)paren
suffix:semicolon
)brace
r_else
id|dbg
(paren
l_string|&quot;restart usb-%s completed&quot;
comma
id|ohci-&gt;ohci_dev-&gt;slot_name
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_PM */
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* configured so that an OHCI device is always provided */
multiline_comment|/* always called with process context; sleeping is OK */
r_static
r_int
id|__devinit
DECL|function|ohci_pci_probe
id|ohci_pci_probe
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
r_int
id|mem_resource
comma
id|mem_len
suffix:semicolon
r_void
op_star
id|mem_base
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* we read its hardware registers as memory */
id|mem_resource
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|mem_len
op_assign
id|pci_resource_len
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
(paren
id|mem_resource
comma
id|mem_len
comma
id|ohci_pci_driver.name
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;controller already in use&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|mem_base
op_assign
id|ioremap_nocache
(paren
id|mem_resource
comma
id|mem_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_base
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error mapping OHCI memory&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* controller writes into our memory */
id|pci_set_master
(paren
id|dev
)paren
suffix:semicolon
r_return
id|hc_found_ohci
(paren
id|dev
comma
id|dev-&gt;irq
comma
id|mem_base
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* may be called from interrupt context [interface spec] */
multiline_comment|/* may be called without controller present */
multiline_comment|/* may be called with controller, bus, and devices active */
r_static
r_void
id|__devexit
DECL|function|ohci_pci_remove
id|ohci_pci_remove
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|dev-&gt;driver_data
suffix:semicolon
id|dbg
(paren
l_string|&quot;remove %s controller usb-%s%s%s&quot;
comma
id|hcfs2string
(paren
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
)paren
comma
id|dev-&gt;slot_name
comma
id|ohci-&gt;disabled
ques
c_cond
l_string|&quot; (disabled)&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|in_interrupt
(paren
)paren
ques
c_cond
l_string|&quot; in interrupt&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|ohci_dump
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* don&squot;t wake up sleeping controllers, or block in interrupt context */
r_if
c_cond
(paren
(paren
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
)paren
op_ne
id|OHCI_USB_OPER
op_logical_or
id|in_interrupt
(paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;controller being disabled&quot;
)paren
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* on return, USB will always be reset (if present) */
r_if
c_cond
(paren
id|ohci-&gt;disabled
)paren
id|writel
(paren
id|ohci-&gt;hc_control
op_assign
id|OHCI_USB_RESET
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|hc_release_ohci
(paren
id|ohci
)paren
suffix:semicolon
id|release_mem_region
(paren
id|pci_resource_start
(paren
id|dev
comma
l_int|0
)paren
comma
id|pci_resource_len
(paren
id|dev
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef&t;CONFIG_PM
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
DECL|function|ohci_pci_suspend
id|ohci_pci_suspend
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
)paren
op_ne
id|OHCI_USB_OPER
)paren
(brace
id|dbg
(paren
l_string|&quot;can&squot;t suspend usb-%s (state is %s)&quot;
comma
id|dev-&gt;slot_name
comma
id|hcfs2string
(paren
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* act as if usb suspend can always be used */
id|info
(paren
l_string|&quot;USB suspend: usb-%s&quot;
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|disable_irq
(paren
id|ohci-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* else, 2.4 assumes shared irqs -- don&squot;t disable */
macro_line|#endif
id|ohci-&gt;hc_control
op_assign
id|OHCI_USB_SUSPEND
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
r_static
r_void
DECL|function|ohci_pci_resume
id|ohci_pci_resume
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|ohci_t
op_star
id|ohci
op_assign
(paren
id|ohci_t
op_star
)paren
id|dev-&gt;driver_data
suffix:semicolon
r_int
id|temp
suffix:semicolon
multiline_comment|/* guard against multiple resumes */
id|atomic_inc
(paren
op_amp
id|ohci-&gt;resume_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
(paren
op_amp
id|ohci-&gt;resume_count
)paren
op_ne
l_int|1
)paren
(brace
id|err
(paren
l_string|&quot;concurrent PCI resumes for usb-%s&quot;
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
id|atomic_dec
(paren
op_amp
id|ohci-&gt;resume_count
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* did we suspend, or were we powered off? */
id|ohci-&gt;hc_control
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|temp
op_assign
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
suffix:semicolon
macro_line|#ifdef DEBUG
multiline_comment|/* the registers may look crazy here */
id|ohci_dump_status
(paren
id|ohci
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|temp
)paren
(brace
r_case
id|OHCI_USB_RESET
suffix:colon
singleline_comment|// lost power
id|info
(paren
l_string|&quot;USB restart: usb-%s&quot;
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
id|hc_restart
(paren
id|ohci
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OHCI_USB_SUSPEND
suffix:colon
singleline_comment|// host wakeup
r_case
id|OHCI_USB_RESUME
suffix:colon
singleline_comment|// remote wakeup
id|info
(paren
l_string|&quot;USB continue: usb-%s from %s wakeup&quot;
comma
id|dev-&gt;slot_name
comma
(paren
id|temp
op_eq
id|OHCI_USB_SUSPEND
)paren
ques
c_cond
l_string|&quot;host&quot;
suffix:colon
l_string|&quot;remote&quot;
)paren
suffix:semicolon
id|ohci-&gt;hc_control
op_assign
id|OHCI_USB_RESUME
suffix:semicolon
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|20
)paren
suffix:semicolon
id|temp
op_assign
id|readl
(paren
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
id|temp
op_assign
id|ohci-&gt;hc_control
op_amp
id|OHCI_CTRL_HCFS
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_ne
id|OHCI_USB_RESUME
)paren
(brace
id|err
(paren
l_string|&quot;controller usb-%s won&squot;t resume&quot;
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
id|ohci-&gt;disabled
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ohci-&gt;disabled
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;hc_control
op_assign
id|OHCI_CONTROL_INIT
op_or
id|OHCI_USB_OPER
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
l_int|0
)braket
op_amp
op_logical_neg
id|ohci-&gt;ed_rm_list
(braket
l_int|1
)braket
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;ed_controltail
)paren
id|ohci-&gt;hc_control
op_or_assign
id|OHCI_CTRL_CLE
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ed_bulktail
)paren
id|ohci-&gt;hc_control
op_or_assign
id|OHCI_CTRL_BLE
suffix:semicolon
)brace
id|writel
(paren
id|ohci-&gt;hc_control
comma
op_amp
id|ohci-&gt;regs-&gt;control
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|enable_irq
(paren
id|ohci-&gt;irq
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|warn
(paren
l_string|&quot;odd PCI resume for usb-%s&quot;
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
)brace
multiline_comment|/* controller is operational, extra resumes are harmless */
id|atomic_dec
(paren
op_amp
id|ohci-&gt;resume_count
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_PM */
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|ohci_pci_ids
r_static
r_const
r_struct
id|pci_device_id
id|__devinitdata
id|ohci_pci_ids
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* handle any USB OHCI controller */
r_class
suffix:colon
(paren
(paren
id|PCI_CLASS_SERIAL_USB
op_lshift
l_int|8
)paren
op_or
l_int|0x10
)paren
comma
id|class_mask
suffix:colon
op_complement
l_int|0
comma
multiline_comment|/* no matter who makes it */
id|vendor
suffix:colon
id|PCI_ANY_ID
comma
id|device
suffix:colon
id|PCI_ANY_ID
comma
id|subvendor
suffix:colon
id|PCI_ANY_ID
comma
id|subdevice
suffix:colon
id|PCI_ANY_ID
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|ohci_pci_ids
)paren
suffix:semicolon
DECL|variable|ohci_pci_driver
r_static
r_struct
id|pci_driver
id|ohci_pci_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;usb-ohci&quot;
comma
id|id_table
suffix:colon
op_amp
id|ohci_pci_ids
(braket
l_int|0
)braket
comma
id|probe
suffix:colon
id|ohci_pci_probe
comma
id|remove
suffix:colon
id|ohci_pci_remove
comma
macro_line|#ifdef&t;CONFIG_PMAC_PBOOK
multiline_comment|/* pbook PCI thinks different ... for now :-) */
macro_line|#else
macro_line|#ifdef&t;CONFIG_PM
id|suspend
suffix:colon
id|ohci_pci_suspend
comma
id|resume
suffix:colon
id|ohci_pci_resume
comma
macro_line|#endif&t;/* PM */
macro_line|#endif&t;/* PBOOK */
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|ohci_sleep_notify
r_static
r_int
id|ohci_sleep_notify
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
(brace
r_struct
id|list_head
op_star
id|ohci_l
suffix:semicolon
id|ohci_t
op_star
id|ohci
suffix:semicolon
r_for
c_loop
(paren
id|ohci_l
op_assign
id|ohci_hcd_list.next
suffix:semicolon
id|ohci_l
op_ne
op_amp
id|ohci_hcd_list
suffix:semicolon
id|ohci_l
op_assign
id|ohci_l-&gt;next
)paren
(brace
id|ohci
op_assign
id|list_entry
(paren
id|ohci_l
comma
id|ohci_t
comma
id|ohci_hcd_list
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|when
)paren
(brace
r_case
id|PBOOK_SLEEP_NOW
suffix:colon
id|ohci_pci_suspend
(paren
id|ohci-&gt;ohci_dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_WAKE
suffix:colon
id|ohci_pci_resume
(paren
id|ohci-&gt;ohci_dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
)brace
DECL|variable|ohci_sleep_notifier
r_static
r_struct
id|pmu_sleep_notifier
id|ohci_sleep_notifier
op_assign
(brace
id|ohci_sleep_notify
comma
id|SLEEP_LEVEL_MISC
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PMAC_PBOOK */
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|ohci_hcd_init
r_static
r_int
id|__init
id|ohci_hcd_init
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ohci_mem_init
(paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|pci_module_init
(paren
op_amp
id|ohci_pci_driver
)paren
)paren
OL
l_int|0
)paren
(brace
id|ohci_mem_cleanup
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_register_sleep_notifier
(paren
op_amp
id|ohci_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif  
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|ohci_hcd_cleanup
r_static
r_void
id|__exit
id|ohci_hcd_cleanup
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|pmu_unregister_sleep_notifier
(paren
op_amp
id|ohci_sleep_notifier
)paren
suffix:semicolon
macro_line|#endif  
id|pci_unregister_driver
(paren
op_amp
id|ohci_pci_driver
)paren
suffix:semicolon
id|ohci_mem_cleanup
(paren
)paren
suffix:semicolon
)brace
DECL|variable|ohci_hcd_init
id|module_init
(paren
id|ohci_hcd_init
)paren
suffix:semicolon
DECL|variable|ohci_hcd_cleanup
id|module_exit
(paren
id|ohci_hcd_cleanup
)paren
suffix:semicolon
id|MODULE_AUTHOR
(paren
l_string|&quot;Roman Weissgaerber &lt;weissg@vienna.at&gt;, David Brownell&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;USB OHCI Host Controller Driver&quot;
)paren
suffix:semicolon
eof
