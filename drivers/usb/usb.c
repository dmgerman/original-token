multiline_comment|/*&n; * driver/usb/usb.c&n; *&n; * (C) Copyright Linus Torvalds 1999&n; *&n; * NOTE! This is not actually a driver at all, rather this is&n; * just a collection of helper routines that implement the&n; * generic USB things that the real drivers can use..&n; *&n; * Think of this as a &quot;USB library&quot; rather than anything else.&n; * It should be considered a slave, with no callbacks. Callbacks&n; * are evil.&n; */
multiline_comment|/*&n; * Table 9-2&n; *&n; * Offset&t;Field&t;&t;Size&t;Value&t;&t;Desc&n; * 0&t;&t;bmRequestType&t;1&t;Bitmap&t;&t;D7:&t;Direction&n; *&t;&t;&t;&t;&t;&t;&t;0 = Host-to-device&n; *&t;&t;&t;&t;&t;&t;&t;1 = Device-to-host&n; *&t;&t;&t;&t;&t;&t;&t;D6..5:&t;Type&n; *&t;&t;&t;&t;&t;&t;&t;0 = Standard&n; *&t;&t;&t;&t;&t;&t;&t;1 = Class&n; *&t;&t;&t;&t;&t;&t;&t;2 = Vendor&n; *&t;&t;&t;&t;&t;&t;&t;3 = Reserved&n; *&t;&t;&t;&t;&t;&t;&t;D4..0:&t;Recipient&n; *&t;&t;&t;&t;&t;&t;&t;0 = Device&n; *&t;&t;&t;&t;&t;&t;&t;1 = Interface&n; *&t;&t;&t;&t;&t;&t;&t;2 = Endpoint&n; *&t;&t;&t;&t;&t;&t;&t;3 = Other&n; *&t;&t;&t;&t;&t;&t;&t;4..31 = Reserved&n; * 1&t;&t;bRequest&t;1&t;Value&t;&t;Specific request (9-3)&n; * 2&t;&t;wValue&t;&t;2&t;Value&t;&t;Varies&n; * 4&t;&t;wIndex&t;&t;2&t;Index/Offset&t;Varies&n; * 6&t;&t;wLength&t;&t;2&t;Count&t;&t;Bytes for data&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &quot;usb.h&quot;
macro_line|#ifdef CONFIG_USB_UHCI
r_int
id|uhci_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_OHCI
r_int
id|ohci_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_OHCI_HCD
r_int
id|ohci_hcd_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|function|usb_init
r_int
id|usb_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_USB_UHCI
id|uhci_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_OHCI
id|ohci_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_OHCI_HCD
id|ohci_hcd_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_MOUSE
id|usb_mouse_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_KBD
id|usb_kbd_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_AUDIO
id|usb_audio_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_ACM
id|usb_acm_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_CPIA
id|usb_cpia_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_USB_PRINTER
id|usb_printer_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|usb_hub_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_drivers
r_void
id|cleanup_drivers
c_func
(paren
r_void
)paren
(brace
id|hub_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USB_MOUSE
id|usb_mouse_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * We have a per-interface &quot;registered driver&quot; list.&n; */
r_static
id|LIST_HEAD
c_func
(paren
id|usb_driver_list
)paren
suffix:semicolon
DECL|function|usb_register
r_int
id|usb_register
c_func
(paren
r_struct
id|usb_driver
op_star
id|new_driver
)paren
(brace
multiline_comment|/* Add it to the list of known drivers */
id|list_add
c_func
(paren
op_amp
id|new_driver-&gt;driver_list
comma
op_amp
id|usb_driver_list
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We should go through all existing devices, and see if any of&n;&t; * them would be acceptable to the new driver.. Let&squot;s do that&n;&t; * in version 2.0.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_deregister
r_void
id|usb_deregister
c_func
(paren
r_struct
id|usb_driver
op_star
id|driver
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|driver-&gt;driver_list
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This entrypoint gets called for each new device.&n; *&n; * We now walk the list of registered USB drivers,&n; * looking for one that will accept this device as&n; * his..&n; */
DECL|function|usb_device_descriptor
r_void
id|usb_device_descriptor
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
op_assign
id|usb_driver_list.next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
op_amp
id|usb_driver_list
)paren
(brace
r_struct
id|usb_driver
op_star
id|driver
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|usb_driver
comma
id|driver_list
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|driver
op_member_access_from_pointer
id|probe
c_func
(paren
id|dev
)paren
)paren
r_continue
suffix:semicolon
id|dev-&gt;driver
op_assign
id|driver
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Ok, no driver accepted the device, so show the info&n;&t; * for debugging..&n;&t; */
id|printk
c_func
(paren
l_string|&quot;Unknown new USB device:&bslash;n&quot;
)paren
suffix:semicolon
id|usb_show_device
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Parse the fairly incomprehensible output of&n; * the USB configuration data, and build up the&n; * USB device database.&n; */
DECL|function|usb_expect_descriptor
r_static
r_int
id|usb_expect_descriptor
c_func
(paren
r_int
r_char
op_star
id|ptr
comma
r_int
id|len
comma
r_int
r_char
id|desctype
comma
r_int
r_char
id|descindex
)paren
(brace
r_int
id|parsed
op_assign
l_int|0
suffix:semicolon
r_int
id|n_len
suffix:semicolon
r_int
r_int
id|n_desc
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|descindex
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|n_desc
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
id|ptr
suffix:semicolon
id|n_len
op_assign
id|n_desc
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|n_desc
op_eq
(paren
(paren
id|desctype
op_lshift
l_int|8
)paren
op_plus
id|descindex
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|n_desc
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
op_eq
id|desctype
op_logical_and
id|n_len
OG
id|descindex
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bug: oversized descriptor.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n_len
template_param
id|len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Short descriptor&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Expected descriptor %02X/%02X, got %02X/%02X - skipping&bslash;n&quot;
comma
id|desctype
comma
id|descindex
comma
(paren
id|n_desc
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
comma
id|n_desc
op_amp
l_int|0xFF
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n_len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;   %d %02x&bslash;n&quot;
comma
id|i
comma
id|ptr
(braket
id|i
)braket
)paren
suffix:semicolon
id|len
op_sub_assign
id|n_len
suffix:semicolon
id|ptr
op_add_assign
id|n_len
suffix:semicolon
id|parsed
op_add_assign
id|n_len
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Found %02X:%02X&bslash;n&quot;
comma
id|desctype
comma
id|descindex
)paren
suffix:semicolon
r_return
id|parsed
suffix:semicolon
)brace
multiline_comment|/*&n; * Parse the even more incomprehensible mess made of the USB spec&n; * by USB audio having private magic to go with it.&n; */
DECL|function|usb_check_descriptor
r_static
r_int
id|usb_check_descriptor
c_func
(paren
r_int
r_char
op_star
id|ptr
comma
r_int
id|len
comma
r_int
r_char
id|desctype
)paren
(brace
r_int
id|n_len
op_assign
id|ptr
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|n_len
template_param
id|len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Short descriptor. (%d, %d)&bslash;n&quot;
comma
id|len
comma
id|n_len
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr
(braket
l_int|1
)braket
op_eq
id|desctype
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|usb_parse_endpoint
r_static
r_int
id|usb_parse_endpoint
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
comma
r_int
r_char
op_star
id|ptr
comma
r_int
id|len
)paren
(brace
r_int
id|parsed
op_assign
id|usb_expect_descriptor
c_func
(paren
id|ptr
comma
id|len
comma
id|USB_DT_ENDPOINT
comma
l_int|7
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|parsed
OL
l_int|0
)paren
r_return
id|parsed
suffix:semicolon
id|memcpy
c_func
(paren
id|endpoint
comma
id|ptr
op_plus
id|parsed
comma
id|ptr
(braket
id|parsed
)braket
)paren
suffix:semicolon
id|parsed
op_add_assign
id|ptr
(braket
id|parsed
)braket
suffix:semicolon
id|len
op_sub_assign
id|ptr
(braket
id|parsed
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
id|i
op_assign
id|usb_check_descriptor
c_func
(paren
id|ptr
op_plus
id|parsed
comma
id|len
comma
l_int|0x25
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|usb_audio_endpoint
c_func
(paren
id|endpoint
comma
id|ptr
op_plus
id|parsed
op_plus
id|i
)paren
suffix:semicolon
id|len
op_sub_assign
id|ptr
(braket
id|parsed
op_plus
id|i
)braket
suffix:semicolon
id|parsed
op_add_assign
id|ptr
(braket
id|parsed
op_plus
id|i
)braket
suffix:semicolon
)brace
r_return
id|parsed
suffix:semicolon
singleline_comment|// + ptr[parsed];
)brace
DECL|function|usb_parse_interface
r_static
r_int
id|usb_parse_interface
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_struct
id|usb_interface_descriptor
op_star
id|interface
comma
r_int
r_char
op_star
id|ptr
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|parsed
op_assign
id|usb_expect_descriptor
c_func
(paren
id|ptr
comma
id|len
comma
id|USB_DT_INTERFACE
comma
l_int|9
)paren
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|parsed
OL
l_int|0
)paren
r_return
id|parsed
suffix:semicolon
id|memcpy
c_func
(paren
id|interface
comma
id|ptr
op_plus
id|parsed
comma
op_star
id|ptr
)paren
suffix:semicolon
id|len
op_sub_assign
id|ptr
(braket
id|parsed
)braket
suffix:semicolon
id|parsed
op_add_assign
id|ptr
(braket
id|parsed
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
id|i
op_assign
id|usb_check_descriptor
c_func
(paren
id|ptr
op_plus
id|parsed
comma
id|len
comma
l_int|0x24
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|usb_audio_interface
c_func
(paren
id|interface
comma
id|ptr
op_plus
id|parsed
op_plus
id|i
)paren
suffix:semicolon
id|len
op_sub_assign
id|ptr
(braket
id|parsed
op_plus
id|i
)braket
suffix:semicolon
id|parsed
op_add_assign
id|ptr
(braket
id|parsed
op_plus
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|interface-&gt;bNumEndpoints
OG
id|USB_MAXENDPOINTS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;usb: too many endpoints.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|interface-&gt;endpoint
op_assign
(paren
r_struct
id|usb_endpoint_descriptor
op_star
)paren
id|kmalloc
c_func
(paren
id|interface-&gt;bNumEndpoints
op_star
r_sizeof
(paren
r_struct
id|usb_endpoint_descriptor
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;endpoint
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;usb: out of memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|interface-&gt;endpoint
comma
l_int|0
comma
id|interface-&gt;bNumEndpoints
op_star
r_sizeof
(paren
r_struct
id|usb_endpoint_descriptor
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|interface-&gt;bNumEndpoints
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|//&t;&t;if(((USB_DT_HID &lt;&lt; 8) | 9) == *(unsigned short*)(ptr + parsed)) {
singleline_comment|//&t;&t;&t;parsed += 9;&t;/* skip over the HID descriptor for now */
singleline_comment|//&t;&t;&t;len -= 9;
singleline_comment|//&t;&t;}
id|retval
op_assign
id|usb_parse_endpoint
c_func
(paren
id|dev
comma
id|interface-&gt;endpoint
op_plus
id|i
comma
id|ptr
op_plus
id|parsed
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
id|parsed
op_add_assign
id|retval
suffix:semicolon
id|len
op_sub_assign
id|retval
suffix:semicolon
)brace
r_return
id|parsed
suffix:semicolon
)brace
DECL|function|usb_parse_config
r_static
r_int
id|usb_parse_config
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_struct
id|usb_config_descriptor
op_star
id|config
comma
r_int
r_char
op_star
id|ptr
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|parsed
op_assign
id|usb_expect_descriptor
c_func
(paren
id|ptr
comma
id|len
comma
id|USB_DT_CONFIG
comma
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parsed
OL
l_int|0
)paren
r_return
id|parsed
suffix:semicolon
id|memcpy
c_func
(paren
id|config
comma
id|ptr
op_plus
id|parsed
comma
op_star
id|ptr
)paren
suffix:semicolon
id|len
op_sub_assign
op_star
id|ptr
suffix:semicolon
id|parsed
op_add_assign
op_star
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|config-&gt;MaxPower
op_eq
l_int|200
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bNumInterfaces kludge&bslash;n&quot;
)paren
suffix:semicolon
id|config-&gt;bNumInterfaces
op_add_assign
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|config-&gt;bNumInterfaces
OG
id|USB_MAXINTERFACES
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;usb: too many interfaces.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|config-&gt;interface
op_assign
(paren
r_struct
id|usb_interface_descriptor
op_star
)paren
id|kmalloc
c_func
(paren
id|config-&gt;bNumInterfaces
op_star
r_sizeof
(paren
r_struct
id|usb_interface_descriptor
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|config-&gt;interface
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;usb: out of memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|config-&gt;interface
comma
l_int|0
comma
id|config-&gt;bNumInterfaces
op_star
r_sizeof
(paren
r_struct
id|usb_interface_descriptor
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|config-&gt;bNumInterfaces
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|retval
op_assign
id|usb_parse_interface
c_func
(paren
id|dev
comma
id|config-&gt;interface
op_plus
id|i
comma
id|ptr
op_plus
id|parsed
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|parsed
suffix:semicolon
singleline_comment|// HACK
singleline_comment|//&t;&t;&t;return retval;
id|parsed
op_add_assign
id|retval
suffix:semicolon
id|len
op_sub_assign
id|retval
suffix:semicolon
)brace
r_return
id|parsed
suffix:semicolon
)brace
DECL|function|usb_parse_configuration
r_int
id|usb_parse_configuration
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|__buf
comma
r_int
id|bytes
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|ptr
op_assign
id|__buf
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;descriptor.bNumConfigurations
OG
id|USB_MAXCONFIG
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;usb: too many configurations.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dev-&gt;config
op_assign
(paren
r_struct
id|usb_config_descriptor
op_star
)paren
id|kmalloc
c_func
(paren
id|dev-&gt;descriptor.bNumConfigurations
op_star
r_sizeof
(paren
r_struct
id|usb_config_descriptor
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;config
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;usb: out of memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev-&gt;config
comma
l_int|0
comma
id|dev-&gt;descriptor.bNumConfigurations
op_star
r_sizeof
(paren
r_struct
id|usb_config_descriptor
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|retval
op_assign
id|usb_parse_config
c_func
(paren
id|dev
comma
id|dev-&gt;config
op_plus
id|i
comma
id|ptr
comma
id|bytes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
id|ptr
op_add_assign
id|retval
suffix:semicolon
id|bytes
op_sub_assign
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bytes
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;usb: %d bytes of extra configuration data left&bslash;n&quot;
comma
id|bytes
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_destroy_configuration
r_void
id|usb_destroy_configuration
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_int
id|c
comma
id|i
suffix:semicolon
r_struct
id|usb_config_descriptor
op_star
id|cf
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|ifp
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;config
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
id|c
op_increment
)paren
(brace
id|cf
op_assign
op_amp
id|dev-&gt;config
(braket
id|c
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cf-&gt;interface
op_eq
l_int|NULL
)paren
(brace
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cf-&gt;bNumInterfaces
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ifp
op_assign
op_amp
id|cf-&gt;interface
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ifp-&gt;endpoint
op_eq
l_int|NULL
)paren
(brace
r_break
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ifp-&gt;endpoint
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|cf-&gt;interface
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|dev-&gt;config
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;stringindex
)paren
id|kfree
c_func
(paren
id|dev-&gt;stringindex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;stringtable
)paren
id|kfree
c_func
(paren
id|dev-&gt;stringtable
)paren
suffix:semicolon
)brace
DECL|function|usb_init_root_hub
r_void
id|usb_init_root_hub
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|dev-&gt;devnum
op_assign
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;slow
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Something got disconnected. Get rid of it, and all of its children.&n; */
DECL|function|usb_disconnect
r_void
id|usb_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
op_star
id|pdev
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
op_star
id|pdev
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB disconnect on device %d&bslash;n&quot;
comma
id|dev-&gt;devnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
)paren
(brace
id|dev-&gt;driver
op_member_access_from_pointer
id|disconnect
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Free up all the children.. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|USB_MAXCHILDREN
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|usb_device
op_star
op_star
id|child
op_assign
id|dev-&gt;children
op_plus
id|i
suffix:semicolon
id|usb_disconnect
c_func
(paren
id|child
)paren
suffix:semicolon
)brace
multiline_comment|/* Free up the device itself, including its device number */
r_if
c_cond
(paren
id|dev-&gt;devnum
OG
l_int|0
)paren
id|clear_bit
c_func
(paren
id|dev-&gt;devnum
comma
op_amp
id|dev-&gt;bus-&gt;devmap.devicemap
)paren
suffix:semicolon
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|deallocate
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Connect a new USB device. This basically just initializes&n; * the USB device information and sets up the topology - it&squot;s&n; * up to the low-level driver to reset the port and actually&n; * do the setup (the upper levels don&squot;t know how to do that).&n; */
DECL|function|usb_connect
r_void
id|usb_connect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_int
id|devnum
suffix:semicolon
id|dev-&gt;descriptor.bMaxPacketSize0
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* XXX fixed 8 bytes for now */
id|devnum
op_assign
id|find_next_zero_bit
c_func
(paren
id|dev-&gt;bus-&gt;devmap.devicemap
comma
l_int|128
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devnum
OL
l_int|128
)paren
(brace
id|set_bit
c_func
(paren
id|devnum
comma
id|dev-&gt;bus-&gt;devmap.devicemap
)paren
suffix:semicolon
id|dev-&gt;devnum
op_assign
id|devnum
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * These are the actual routines to send&n; * and receive control messages.&n; */
DECL|function|usb_set_address
r_int
id|usb_set_address
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
l_int|0
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_SET_ADDRESS
suffix:semicolon
id|dr.value
op_assign
id|dev-&gt;devnum
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_snddefctrl
c_func
(paren
id|dev
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_get_descriptor
r_int
id|usb_get_descriptor
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_char
id|type
comma
r_int
r_char
id|index
comma
r_void
op_star
id|buf
comma
r_int
id|size
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
r_int
id|i
op_assign
l_int|5
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dr.requesttype
op_assign
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_GET_DESCRIPTOR
suffix:semicolon
id|dr.value
op_assign
(paren
id|type
op_lshift
l_int|8
)paren
op_plus
id|index
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
id|size
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|result
op_assign
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|buf
comma
id|size
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|usb_get_string
r_int
id|usb_get_string
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|langid
comma
r_int
r_char
id|index
comma
r_void
op_star
id|buf
comma
r_int
id|size
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
r_int
id|i
op_assign
l_int|5
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dr.requesttype
op_assign
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_GET_DESCRIPTOR
suffix:semicolon
id|dr.value
op_assign
(paren
id|USB_DT_STRING
op_lshift
l_int|8
)paren
op_plus
id|index
suffix:semicolon
id|dr.index
op_assign
id|langid
suffix:semicolon
id|dr.length
op_assign
id|size
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|result
op_assign
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|buf
comma
id|size
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|usb_get_device_descriptor
r_int
id|usb_get_device_descriptor
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_return
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_DEVICE
comma
l_int|0
comma
op_amp
id|dev-&gt;descriptor
comma
r_sizeof
(paren
id|dev-&gt;descriptor
)paren
)paren
suffix:semicolon
)brace
DECL|function|usb_get_hub_descriptor
r_int
id|usb_get_hub_descriptor
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|data
comma
r_int
id|size
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_RT_HUB
op_or
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_GET_DESCRIPTOR
suffix:semicolon
id|dr.value
op_assign
(paren
id|USB_DT_HUB
op_lshift
l_int|8
)paren
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
id|size
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|data
comma
id|size
)paren
suffix:semicolon
)brace
DECL|function|usb_clear_port_feature
r_int
id|usb_clear_port_feature
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|port
comma
r_int
id|feature
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_RT_PORT
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_CLEAR_FEATURE
suffix:semicolon
id|dr.value
op_assign
id|feature
suffix:semicolon
id|dr.index
op_assign
id|port
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_set_port_feature
r_int
id|usb_set_port_feature
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|port
comma
r_int
id|feature
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_RT_PORT
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_SET_FEATURE
suffix:semicolon
id|dr.value
op_assign
id|feature
suffix:semicolon
id|dr.index
op_assign
id|port
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|usb_get_hub_status
r_int
id|usb_get_hub_status
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|data
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_RT_HUB
op_or
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_GET_STATUS
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|4
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|data
comma
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|usb_get_port_status
r_int
id|usb_get_port_status
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|port
comma
r_void
op_star
id|data
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_RT_PORT
op_or
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_GET_STATUS
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
id|port
suffix:semicolon
id|dr.length
op_assign
l_int|4
suffix:semicolon
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|data
comma
l_int|4
)paren
suffix:semicolon
)brace
DECL|function|usb_get_protocol
r_int
id|usb_get_protocol
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_int
r_char
id|buf
(braket
l_int|8
)braket
suffix:semicolon
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_RT_HIDD
op_or
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_GET_PROTOCOL
suffix:semicolon
id|dr.value
op_assign
l_int|0
suffix:semicolon
id|dr.index
op_assign
l_int|1
suffix:semicolon
id|dr.length
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|buf
comma
l_int|1
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|buf
(braket
l_int|0
)braket
suffix:semicolon
)brace
DECL|function|usb_set_protocol
r_int
id|usb_set_protocol
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|protocol
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_RT_HIDD
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_SET_PROTOCOL
suffix:semicolon
id|dr.value
op_assign
id|protocol
suffix:semicolon
id|dr.index
op_assign
l_int|1
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* keyboards want a nonzero duration according to HID spec, but&n;   mice should use infinity (0) -keryan */
DECL|function|usb_set_idle
r_int
id|usb_set_idle
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|duration
comma
r_int
id|report_id
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_RT_HIDD
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_SET_IDLE
suffix:semicolon
id|dr.value
op_assign
(paren
id|duration
op_lshift
l_int|8
)paren
op_or
id|report_id
suffix:semicolon
id|dr.index
op_assign
l_int|1
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_set_maxpacket
r_static
r_void
id|usb_set_maxpacket
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_endpoint_descriptor
op_star
id|ep
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|ip
op_assign
id|dev-&gt;actconfig-&gt;interface
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;actconfig-&gt;bNumInterfaces
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;actconfig-&gt;interface
(braket
id|i
)braket
dot
id|bInterfaceNumber
op_eq
id|dev-&gt;ifnum
)paren
(brace
id|ip
op_assign
op_amp
id|dev-&gt;actconfig-&gt;interface
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|ep
op_assign
id|ip-&gt;endpoint
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ip-&gt;bNumEndpoints
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;epmaxpacket
(braket
id|ep
(braket
id|i
)braket
dot
id|bEndpointAddress
op_amp
l_int|0x0f
)braket
op_assign
id|ep
(braket
id|i
)braket
dot
id|wMaxPacketSize
suffix:semicolon
)brace
)brace
DECL|function|usb_set_interface
r_int
id|usb_set_interface
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|interface
comma
r_int
id|alternate
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
l_int|1
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_SET_INTERFACE
suffix:semicolon
id|dr.value
op_assign
id|alternate
suffix:semicolon
id|dr.index
op_assign
id|interface
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;ifnum
op_assign
id|interface
suffix:semicolon
id|usb_set_maxpacket
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_set_configuration
r_int
id|usb_set_configuration
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|configuration
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|usb_config_descriptor
op_star
id|cp
op_assign
l_int|NULL
suffix:semicolon
id|dr.requesttype
op_assign
l_int|0
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_SET_CONFIGURATION
suffix:semicolon
id|dr.value
op_assign
id|configuration
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;config
(braket
id|i
)braket
dot
id|bConfigurationValue
op_eq
id|configuration
)paren
(brace
id|cp
op_assign
op_amp
id|dev-&gt;config
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|cp
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;usb: selecting invalid configuration %d&bslash;n&quot;
comma
id|configuration
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;actconfig
op_assign
id|cp
suffix:semicolon
id|dev-&gt;toggle
op_assign
l_int|0
suffix:semicolon
id|usb_set_maxpacket
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_get_report
r_int
id|usb_get_report
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_int
r_char
id|buf
(braket
l_int|8
)braket
suffix:semicolon
id|devrequest
id|dr
suffix:semicolon
id|dr.requesttype
op_assign
id|USB_RT_HIDD
op_or
l_int|0x80
suffix:semicolon
id|dr.request
op_assign
id|USB_REQ_GET_REPORT
suffix:semicolon
id|dr.value
op_assign
l_int|0x100
suffix:semicolon
id|dr.index
op_assign
l_int|1
suffix:semicolon
id|dr.length
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
id|buf
comma
l_int|3
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|buf
(braket
l_int|0
)braket
suffix:semicolon
)brace
DECL|function|usb_get_configuration
r_int
id|usb_get_configuration
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_int
r_int
id|cfgno
suffix:semicolon
r_int
r_char
id|buffer
(braket
l_int|400
)braket
suffix:semicolon
r_int
r_char
op_star
id|bufptr
suffix:semicolon
id|bufptr
op_assign
id|buffer
suffix:semicolon
r_for
c_loop
(paren
id|cfgno
op_assign
l_int|0
suffix:semicolon
id|cfgno
OL
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
id|cfgno
op_increment
)paren
(brace
r_int
r_int
id|size
suffix:semicolon
multiline_comment|/* Get the first 8 bytes - guaranteed */
r_if
c_cond
(paren
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_CONFIG
comma
id|cfgno
comma
id|bufptr
comma
l_int|8
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Get the full buffer */
id|size
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|bufptr
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bufptr
op_plus
id|size
OG
id|buffer
op_plus
r_sizeof
(paren
id|buffer
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;usb: truncated DT_CONFIG (want %d).&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
id|size
op_assign
id|buffer
op_plus
r_sizeof
(paren
id|buffer
)paren
op_minus
id|bufptr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_CONFIG
comma
id|cfgno
comma
id|bufptr
comma
id|size
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Prepare for next configuration */
id|bufptr
op_add_assign
id|size
suffix:semicolon
)brace
r_return
id|usb_parse_configuration
c_func
(paren
id|dev
comma
id|buffer
comma
id|bufptr
op_minus
id|buffer
)paren
suffix:semicolon
)brace
DECL|function|usb_get_stringtable
r_int
id|usb_get_stringtable
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|maxindex
suffix:semicolon
r_int
id|langid
suffix:semicolon
r_int
r_char
id|buffer
(braket
l_int|256
)braket
suffix:semicolon
r_int
id|totalchars
suffix:semicolon
r_struct
id|usb_string_descriptor
op_star
id|sd
op_assign
(paren
r_struct
id|usb_string_descriptor
op_star
)paren
id|buffer
suffix:semicolon
r_char
op_star
id|string
suffix:semicolon
id|__u8
id|bLengths
(braket
id|USB_MAXSTRINGS
op_plus
l_int|1
)braket
suffix:semicolon
r_int
id|j
suffix:semicolon
id|dev-&gt;maxstring
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|usb_get_string
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
comma
id|buffer
comma
l_int|2
)paren
op_logical_or
id|usb_get_string
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
comma
id|buffer
comma
id|sd-&gt;bLength
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* we are going to assume that the first ID is good */
id|langid
op_assign
id|sd-&gt;wData
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* whip through and find total length and max index */
r_for
c_loop
(paren
id|maxindex
op_assign
l_int|1
comma
id|totalchars
op_assign
l_int|0
suffix:semicolon
id|maxindex
op_le
id|USB_MAXSTRINGS
suffix:semicolon
id|maxindex
op_increment
)paren
(brace
r_if
c_cond
(paren
id|usb_get_string
c_func
(paren
id|dev
comma
id|langid
comma
id|maxindex
comma
id|buffer
comma
l_int|2
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|totalchars
op_add_assign
(paren
id|sd-&gt;bLength
op_minus
l_int|2
)paren
op_div
l_int|2
op_plus
l_int|1
suffix:semicolon
id|bLengths
(braket
id|maxindex
)braket
op_assign
id|sd-&gt;bLength
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|maxindex
op_le
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* get space for strings and index */
id|dev-&gt;stringindex
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_char
op_star
)paren
op_star
id|maxindex
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;stringindex
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;stringtable
op_assign
id|kmalloc
c_func
(paren
id|totalchars
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;stringtable
)paren
(brace
id|kfree
c_func
(paren
id|dev-&gt;stringindex
)paren
suffix:semicolon
id|dev-&gt;stringindex
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* fill them in */
id|memset
c_func
(paren
id|dev-&gt;stringindex
comma
l_int|0
comma
r_sizeof
(paren
r_char
op_star
)paren
op_star
id|maxindex
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
comma
id|string
op_assign
id|dev-&gt;stringtable
suffix:semicolon
id|i
op_le
id|maxindex
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|usb_get_string
c_func
(paren
id|dev
comma
id|langid
comma
id|i
comma
id|buffer
comma
id|bLengths
(braket
id|i
)braket
)paren
)paren
r_continue
suffix:semicolon
id|dev-&gt;stringindex
(braket
id|i
)braket
op_assign
id|string
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
id|bLengths
(braket
id|i
)braket
op_minus
l_int|2
)paren
op_div
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
id|string
op_increment
op_assign
id|sd-&gt;wData
(braket
id|j
)braket
suffix:semicolon
)brace
op_star
id|string
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|dev-&gt;maxstring
op_assign
id|maxindex
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * By the time we get here, the device has gotten a new device ID&n; * and is in the default state. We need to identify the thing and&n; * get the ball rolling..&n; */
DECL|function|usb_new_device
r_void
id|usb_new_device
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_int
id|addr
comma
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB new device connect, assigned device number %d&bslash;n&quot;
comma
id|dev-&gt;devnum
)paren
suffix:semicolon
id|dev-&gt;maxpacketsize
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Default to 8 byte max packet size */
id|dev-&gt;epmaxpacket
(braket
l_int|0
)braket
op_assign
l_int|8
suffix:semicolon
id|addr
op_assign
id|dev-&gt;devnum
suffix:semicolon
id|dev-&gt;devnum
op_assign
l_int|0
suffix:semicolon
macro_line|#if 1
multiline_comment|/* Slow devices */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|usb_get_descriptor
c_func
(paren
id|dev
comma
id|USB_DT_DEVICE
comma
l_int|0
comma
op_amp
id|dev-&gt;descriptor
comma
l_int|8
)paren
)paren
r_break
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;get_descriptor failed, waiting&bslash;n&quot;
)paren
suffix:semicolon
id|wait_ms
c_func
(paren
l_int|200
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;giving up&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;maxpacketsize: %d&bslash;n&quot;
comma
id|dev-&gt;descriptor.bMaxPacketSize0
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;epmaxpacket
(braket
l_int|0
)braket
op_assign
id|dev-&gt;descriptor.bMaxPacketSize0
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;descriptor.bMaxPacketSize0
)paren
(brace
r_case
l_int|8
suffix:colon
id|dev-&gt;maxpacketsize
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|dev-&gt;maxpacketsize
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|dev-&gt;maxpacketsize
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|64
suffix:colon
id|dev-&gt;maxpacketsize
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;dev-&gt;mps: %d&bslash;n&quot;
comma
id|dev-&gt;maxpacketsize
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;devnum
op_assign
id|addr
suffix:semicolon
macro_line|#if 1
r_if
c_cond
(paren
id|usb_set_address
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to set address&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME: We should disable the port */
r_return
suffix:semicolon
)brace
macro_line|#else
id|usb_set_address
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
id|wait_ms
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Let the SET_ADDRESS settle */
r_if
c_cond
(paren
id|usb_get_device_descriptor
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to get device descriptor&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_get_configuration
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to get configuration&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|usb_get_stringtable
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;actconfig
op_assign
id|dev-&gt;config
suffix:semicolon
id|dev-&gt;ifnum
op_assign
l_int|0
suffix:semicolon
id|usb_set_maxpacket
c_func
(paren
id|dev
)paren
suffix:semicolon
id|usb_show_string
c_func
(paren
id|dev
comma
l_string|&quot;Manufacturer&quot;
comma
id|dev-&gt;descriptor.iManufacturer
)paren
suffix:semicolon
id|usb_show_string
c_func
(paren
id|dev
comma
l_string|&quot;Product&quot;
comma
id|dev-&gt;descriptor.iProduct
)paren
suffix:semicolon
id|usb_show_string
c_func
(paren
id|dev
comma
l_string|&quot;SerialNumber&quot;
comma
id|dev-&gt;descriptor.iSerialNumber
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;Vendor: %X&bslash;n&quot;
comma
id|dev-&gt;descriptor.idVendor
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Product: %X&bslash;n&quot;
comma
id|dev-&gt;descriptor.idProduct
)paren
suffix:semicolon
macro_line|#endif
id|usb_device_descriptor
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|usb_request_irq
r_int
id|usb_request_irq
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|pipe
comma
id|usb_device_irq
id|handler
comma
r_int
id|period
comma
r_void
op_star
id|dev_id
)paren
(brace
r_return
id|dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|request_irq
c_func
(paren
id|dev
comma
id|pipe
comma
id|handler
comma
id|period
comma
id|dev_id
)paren
suffix:semicolon
)brace
eof
