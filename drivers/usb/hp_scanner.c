multiline_comment|/* -*- linux-c -*- */
multiline_comment|/* &n; * Driver for USB HP Scanners&n; *&n; * David E. Nelson (dnelson@jump.net)&n; * &n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License as&n; * published by the Free Software Foundation; either version 2 of the&n; * License, or (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Based upon mouse.c (Brad Keryan) and printer.c (Michael Gee).&n; *&n; * History&n; *  0.1  8/31/1999&n; *&n; *    Developed/tested using linux-2.3.15 with minor ohci.c changes to&n; *    support short packes during bulk xfer mode.  Some testing was&n; *    done with ohci-hcd but the performace was low.  Very limited&n; *    testing was performed with uhci but I was unable to get it to&n; *    work.  Initial relase to the linux-usb development effort.&n; *&n; * */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &quot;usb.h&quot;
multiline_comment|/* stall/wait timeout for scanner */
DECL|macro|NAK_TIMEOUT
mdefine_line|#define NAK_TIMEOUT (HZ)
multiline_comment|/* For some reason, an IBUF_SIZE of 8192 causes REALLY big problems&n; * with linux-2.3.15.  Anything more than 4k seems to not have an&n; * effect on increasing performance. Anything smaller than 4k hurts&n; * it.  */
DECL|macro|IBUF_SIZE
mdefine_line|#define IBUF_SIZE 4096
multiline_comment|/* This is a scanner, so not much data is sent to it.  The largest&n; * stuff may be some kind of maps and stuff but that&squot;s kinda rare.  */
DECL|macro|OBUF_SIZE
mdefine_line|#define OBUF_SIZE 128
DECL|macro|USB_SCANNER_MAJOR
mdefine_line|#define USB_SCANNER_MAJOR 16
DECL|struct|hpscan_usb_data
r_struct
id|hpscan_usb_data
(brace
DECL|member|hpscan_dev
r_struct
id|usb_device
op_star
id|hpscan_dev
suffix:semicolon
multiline_comment|/* init: probe_scanner */
DECL|member|isopen
id|__u8
id|isopen
suffix:semicolon
multiline_comment|/* nz if open */
DECL|member|present
id|__u8
id|present
suffix:semicolon
multiline_comment|/* Device is present on the bus */
DECL|member|obuf
r_char
op_star
id|obuf
suffix:semicolon
multiline_comment|/* transfer buffers */
DECL|member|ibuf
r_char
op_star
id|ibuf
suffix:semicolon
DECL|member|wait_q
id|wait_queue_head_t
id|wait_q
suffix:semicolon
multiline_comment|/* for timeouts */
)brace
suffix:semicolon
DECL|variable|hpscan
r_static
r_struct
id|hpscan_usb_data
id|hpscan
suffix:semicolon
r_static
r_int
DECL|function|open_scanner
id|open_scanner
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|hpscan_usb_data
op_star
id|hps
op_assign
op_amp
id|hpscan
suffix:semicolon
r_if
c_cond
(paren
id|hps-&gt;isopen
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|hps-&gt;isopen
op_assign
l_int|1
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|hps-&gt;wait_q
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|close_scanner
id|close_scanner
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|hpscan_usb_data
op_star
id|hps
op_assign
op_amp
id|hpscan
suffix:semicolon
id|hps-&gt;isopen
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|write_scanner
id|write_scanner
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|hpscan_usb_data
op_star
id|hps
op_assign
op_amp
id|hpscan
suffix:semicolon
r_int
r_int
id|copy_size
suffix:semicolon
r_int
r_int
id|bytes_written
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|partial
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|maxretry
suffix:semicolon
r_do
(brace
r_int
r_int
id|thistime
suffix:semicolon
r_char
op_star
id|obuf
op_assign
id|hps-&gt;obuf
suffix:semicolon
id|thistime
op_assign
id|copy_size
op_assign
(paren
id|count
OG
id|OBUF_SIZE
)paren
ques
c_cond
id|OBUF_SIZE
suffix:colon
id|count
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|hps-&gt;obuf
comma
id|buffer
comma
id|copy_size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|maxretry
op_assign
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|thistime
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hps-&gt;hpscan_dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
id|bytes_written
ques
c_cond
id|bytes_written
suffix:colon
op_minus
id|EINTR
suffix:semicolon
)brace
id|result
op_assign
id|hps-&gt;hpscan_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|bulk_msg
c_func
(paren
id|hps-&gt;hpscan_dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|hps-&gt;hpscan_dev
comma
l_int|2
)paren
comma
id|obuf
comma
id|thistime
comma
op_amp
id|partial
)paren
suffix:semicolon
singleline_comment|//printk(KERN_DEBUG &quot;write stats: result:%d thistime:%lu partial:%lu&bslash;n&quot;, result, thistime, partial);
r_if
c_cond
(paren
id|result
op_eq
id|USB_ST_TIMEOUT
)paren
(brace
multiline_comment|/* NAK - so hold for a while */
r_if
c_cond
(paren
op_logical_neg
id|maxretry
op_decrement
)paren
(brace
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|hps-&gt;wait_q
comma
id|NAK_TIMEOUT
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|result
op_amp
id|partial
)paren
(brace
id|obuf
op_add_assign
id|partial
suffix:semicolon
id|thistime
op_sub_assign
id|partial
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write Whoops - %x&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|bytes_written
op_add_assign
id|copy_size
suffix:semicolon
id|count
op_sub_assign
id|copy_size
suffix:semicolon
id|buffer
op_add_assign
id|copy_size
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
suffix:semicolon
r_return
id|bytes_written
ques
c_cond
id|bytes_written
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|read_scanner
id|read_scanner
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|hpscan_usb_data
op_star
id|hps
op_assign
op_amp
id|hpscan
suffix:semicolon
id|ssize_t
id|read_count
suffix:semicolon
r_int
r_int
id|partial
suffix:semicolon
r_int
id|this_read
suffix:semicolon
r_int
id|result
suffix:semicolon
multiline_comment|/* Wait for the scanner to get it&squot;s act together.  This may involve&n; * resetting the head, warming up the lamp, etc.  maxretry is number&n; * of seconds.  */
r_int
id|maxretry
op_assign
l_int|30
suffix:semicolon
r_char
op_star
id|ibuf
op_assign
id|hps-&gt;ibuf
suffix:semicolon
id|read_count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
id|read_count
ques
c_cond
id|read_count
suffix:colon
op_minus
id|EINTR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hps-&gt;hpscan_dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|this_read
op_assign
(paren
id|count
OG
id|IBUF_SIZE
)paren
ques
c_cond
id|IBUF_SIZE
suffix:colon
id|count
suffix:semicolon
id|result
op_assign
id|hps-&gt;hpscan_dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|bulk_msg
c_func
(paren
id|hps-&gt;hpscan_dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|hps-&gt;hpscan_dev
comma
l_int|1
)paren
comma
id|ibuf
comma
id|this_read
comma
op_amp
id|partial
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;read stats: result:%d this_read:%u partial:%lu&bslash;n&quot;
comma
id|result
comma
id|this_read
comma
id|partial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|partial
)paren
(brace
id|count
op_assign
id|this_read
op_assign
id|partial
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_eq
id|USB_ST_TIMEOUT
op_logical_or
id|result
op_eq
l_int|15
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|maxretry
op_decrement
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;read_scanner: maxretry timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|hps-&gt;wait_q
comma
id|NAK_TIMEOUT
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_ne
id|USB_ST_DATAUNDERRUN
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Read Whoops - result:%u partial:%lu this_read:%u&bslash;n&quot;
comma
id|result
comma
id|partial
comma
id|this_read
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_else
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|this_read
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|ibuf
comma
id|this_read
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|count
op_sub_assign
id|this_read
suffix:semicolon
id|read_count
op_add_assign
id|this_read
suffix:semicolon
id|buffer
op_add_assign
id|this_read
suffix:semicolon
)brace
)brace
r_return
id|read_count
suffix:semicolon
)brace
r_static
r_int
DECL|function|probe_scanner
id|probe_scanner
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|hpscan_usb_data
op_star
id|hps
op_assign
op_amp
id|hpscan
suffix:semicolon
multiline_comment|/*&n;&t; * Don&squot;t bother using an HP 4200C since it does NOT understand&n;&t; * SCL and HP isn&squot;t going to be releasing the specs any time&n;&t; * soon.  */
r_if
c_cond
(paren
id|dev-&gt;descriptor.idVendor
op_ne
l_int|0x3f0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Scanner is not an HP Scanner.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;descriptor.idProduct
op_ne
l_int|0x101
op_logical_and
multiline_comment|/* HP 4100C */
id|dev-&gt;descriptor.idProduct
op_ne
l_int|0x202
op_logical_and
multiline_comment|/* HP 5100C */
id|dev-&gt;descriptor.idProduct
op_ne
l_int|0x601
)paren
(brace
multiline_comment|/* HP 6300C */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Scanner model not supported/tested.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;USB Scanner found at address %d&bslash;n&quot;
comma
id|dev-&gt;devnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_set_configuration
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|bConfigurationValue
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Failed to set configuration&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|hps-&gt;present
op_assign
l_int|1
suffix:semicolon
id|hps-&gt;hpscan_dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hps-&gt;obuf
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|OBUF_SIZE
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hps-&gt;ibuf
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|IBUF_SIZE
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|disconnect_scanner
id|disconnect_scanner
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|hpscan_usb_data
op_star
id|hps
op_assign
op_amp
id|hpscan
suffix:semicolon
r_if
c_cond
(paren
id|hps-&gt;isopen
)paren
(brace
multiline_comment|/* better let it finish - the release will do whats needed */
id|hps-&gt;hpscan_dev
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|hps-&gt;ibuf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hps-&gt;obuf
)paren
suffix:semicolon
id|dev
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* just in case */
id|hps-&gt;present
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_struct
DECL|variable|scanner_driver
id|usb_driver
id|scanner_driver
op_assign
(brace
l_string|&quot;usbscanner&quot;
comma
id|probe_scanner
comma
id|disconnect_scanner
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
r_static
r_struct
DECL|variable|usb_scanner_fops
id|file_operations
id|usb_scanner_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* seek */
id|read_scanner
comma
id|write_scanner
comma
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* poll */
l_int|NULL
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
id|open_scanner
comma
l_int|NULL
comma
multiline_comment|/* flush */
id|close_scanner
comma
l_int|NULL
comma
l_int|NULL
comma
multiline_comment|/* fasync */
)brace
suffix:semicolon
r_int
DECL|function|usb_hp_scanner_init
id|usb_hp_scanner_init
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|register_chrdev
c_func
(paren
id|USB_SCANNER_MAJOR
comma
l_string|&quot;usbscanner&quot;
comma
op_amp
id|usb_scanner_fops
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;hp_scanner: Cannot register device&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|usb_register
c_func
(paren
op_amp
id|scanner_driver
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;USB Scanner support registered.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|usb_hp_scanner_cleanup
id|usb_hp_scanner_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|hpscan_usb_data
op_star
id|hps
op_assign
op_amp
id|hpscan
suffix:semicolon
id|hps-&gt;present
op_assign
l_int|0
suffix:semicolon
id|usb_deregister
c_func
(paren
op_amp
id|scanner_driver
)paren
suffix:semicolon
id|unregister_chrdev
c_func
(paren
id|USB_SCANNER_MAJOR
comma
l_string|&quot;usbscanner&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_hp_scanner_init
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|usb_hp_scanner_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
