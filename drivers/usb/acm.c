multiline_comment|/*&n; * USB Abstract Control Model based on Brad Keryan&squot;s USB busmouse driver &n; *&n; * Armin Fuerst 5/8/1999&n; *&n; * version 0.2: Improved Bulk transfer. TX led now flashes every time data is&n; * sent. Send Encapsulated Data is not needed, nor does it do anything.&n; * Why&squot;s that ?!? Thanks to Thomas Sailer for his close look at the bulk code.&n; * He told me about some importand bugs. (5/21/99)&n; *&n; * version 0.1: Bulk transfer for uhci seems to work now, no dangling tds any&n; * more. TX led of the ISDN TA flashed the first time. Does this mean it works?&n; * The interrupt of the ctrl endpoint crashes the kernel =&gt; no read possible&n; * (5/19/99)&n; *&n; * version 0.0: Driver sets up configuration, sets up data pipes, opens misc&n; * device. No actual data transfer is done, since we don&squot;t have bulk transfer,&n; * yet. Purely skeleton for now. (5/8/99)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &quot;usb.h&quot;
DECL|macro|USB_ACM_MINOR
mdefine_line|#define USB_ACM_MINOR 32
DECL|struct|acm_state
r_struct
id|acm_state
(brace
DECL|member|present
r_int
id|present
suffix:semicolon
multiline_comment|/* this acm is plugged in */
DECL|member|active
r_int
id|active
suffix:semicolon
multiline_comment|/* someone is has this acm&squot;s device open */
DECL|member|serstate
r_int
id|serstate
suffix:semicolon
multiline_comment|/* Status of the serial port (rate, handshakelines,...) */
DECL|member|dev
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
DECL|member|ctrlbuffer
r_int
id|ctrlbuffer
suffix:semicolon
multiline_comment|/*buffer for control messages*/
DECL|member|readendp
DECL|member|writeendp
DECL|member|ctrlendp
r_int
r_int
id|readendp
comma
id|writeendp
comma
id|ctrlendp
suffix:semicolon
DECL|member|readpipe
DECL|member|writepipe
DECL|member|ctrlpipe
r_int
r_int
id|readpipe
comma
id|writepipe
comma
id|ctrlpipe
suffix:semicolon
DECL|member|buffer
r_char
id|buffer
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|static_acm_state
r_static
r_struct
id|acm_state
id|static_acm_state
suffix:semicolon
DECL|variable|usb_acm_lock
id|spinlock_t
id|usb_acm_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|acm_irq
r_static
r_int
id|acm_irq
c_func
(paren
r_int
id|state
comma
r_void
op_star
id|__buffer
comma
r_int
id|len
comma
r_void
op_star
id|dev_id
)paren
(brace
singleline_comment|//&t;unsigned char *data = __buffer;
r_struct
id|acm_state
op_star
id|acm
op_assign
op_amp
id|static_acm_state
suffix:semicolon
id|devrequest
op_star
id|dr
suffix:semicolon
id|dr
op_assign
id|__buffer
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ACM_USB_IRQ&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;reqtype: %02X&bslash;n&quot;
comma
id|dr-&gt;requesttype
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;request: %02X&bslash;n&quot;
comma
id|dr-&gt;request
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wValue: %02X&bslash;n&quot;
comma
id|dr-&gt;value
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wIndex: %02X&bslash;n&quot;
comma
id|dr-&gt;index
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wLength: %02X&bslash;n&quot;
comma
id|dr-&gt;length
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dr-&gt;request
)paren
(brace
singleline_comment|//Network connection 
r_case
l_int|0x00
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Network connection: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dr-&gt;request
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;disconnected&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dr-&gt;request
op_eq
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;connected&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|//Response available
r_case
l_int|0x01
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Response available&bslash;n&quot;
)paren
suffix:semicolon
id|acm-&gt;buffer
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|//Set serial line state
r_case
l_int|0x20
suffix:colon
r_if
c_cond
(paren
(paren
id|dr-&gt;index
op_eq
l_int|1
)paren
op_logical_and
(paren
id|dr-&gt;length
op_eq
l_int|2
)paren
)paren
(brace
id|acm-&gt;serstate
op_assign
id|acm-&gt;ctrlbuffer
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Serstate: %02X&bslash;n&quot;
comma
id|acm-&gt;ctrlbuffer
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;if(!acm-&gt;active)&n;&t;&t;return 1;&n;*/
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|release_acm
r_static
r_int
id|release_acm
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
op_amp
id|static_acm_state
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ACM_FILE_RELEASE&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//&t;fasync_acm(-1, file, 0);
r_if
c_cond
(paren
op_decrement
id|acm-&gt;active
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|open_acm
r_static
r_int
id|open_acm
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
op_amp
id|static_acm_state
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB_FILE_OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|acm-&gt;active
op_increment
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|write_acm
r_static
id|ssize_t
id|write_acm
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
r_struct
id|acm_state
op_star
id|acm
op_assign
op_amp
id|static_acm_state
suffix:semicolon
r_int
r_int
id|retval
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB_FILE_WRITE&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//Huh, i seem to got that wrong, we don&squot;t need this ?!?
multiline_comment|/*&n;&t;dr.requesttype = USB_TYPE_CLASS | USB_RT_ENDPOINT;&n;&t;dr.request = 0;&n;&t;dr.value = 0;&n;&t;dr.index = acm-&gt;writeendp;&n;&t;dr.length = count;&n;&t;acm-&gt;dev-&gt;bus-&gt;op-&gt;control_msg(acm-&gt;dev, usb_sndctrlpipe(acm-&gt;dev, 0), &amp;dr, NULL, 0);&n;*/
id|acm-&gt;dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|bulk_msg
c_func
(paren
id|acm-&gt;dev
comma
op_amp
id|acm-&gt;writepipe
comma
id|buffer
comma
id|count
comma
op_amp
id|retval
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|read_acm
r_static
id|ssize_t
id|read_acm
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
r_struct
id|acm_state
op_star
id|acm
op_assign
op_amp
id|static_acm_state
suffix:semicolon
r_int
r_int
id|retval
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB_FILE_READ&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//        if (!acm-&gt;buffer) return -1;
id|acm-&gt;buffer
op_assign
l_int|0
suffix:semicolon
singleline_comment|//We don&squot;t need this
multiline_comment|/*&n;&t;printk(&quot;writing control msg&bslash;n&quot;);&n;&t;dr.requesttype = USB_TYPE_CLASS | USB_RT_ENDPOINT | 0x80;&n;&t;dr.request = 1;&n;&t;dr.value = 0;&n;&t;dr.index = acm-&gt;readendp;&n;&t;dr.length = 0;&n;&t;acm-&gt;dev-&gt;bus-&gt;op-&gt;control_msg(acm-&gt;dev, usb_sndctrlpipe(acm-&gt;dev, 0), &amp;dr, NULL, 0);&n;*/
id|printk
c_func
(paren
l_string|&quot;reading:&gt;%s&lt;&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
id|acm-&gt;dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|bulk_msg
c_func
(paren
id|acm-&gt;dev
comma
op_amp
id|acm-&gt;readpipe
comma
id|buffer
comma
l_int|1
comma
op_amp
id|retval
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;done:&gt;%s&lt;&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|usb_acm_fops
r_struct
id|file_operations
id|usb_acm_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* acm_seek */
id|read_acm
comma
id|write_acm
comma
l_int|NULL
comma
multiline_comment|/* acm_readdir */
l_int|NULL
comma
multiline_comment|/* acm_poll */
l_int|NULL
comma
multiline_comment|/* acm_ioctl */
l_int|NULL
comma
multiline_comment|/* acm_mmap */
id|open_acm
comma
l_int|NULL
comma
multiline_comment|/* flush */
id|release_acm
comma
l_int|NULL
comma
l_int|NULL
comma
multiline_comment|/*fasync*/
)brace
suffix:semicolon
DECL|variable|usb_acm
r_static
r_struct
id|miscdevice
id|usb_acm
op_assign
(brace
id|USB_ACM_MINOR
comma
l_string|&quot;USB ACM&quot;
comma
op_amp
id|usb_acm_fops
)brace
suffix:semicolon
DECL|function|acm_probe
r_static
r_int
id|acm_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
suffix:semicolon
r_struct
id|acm_state
op_star
id|acm
op_assign
op_amp
id|static_acm_state
suffix:semicolon
r_int
id|cfgnum
suffix:semicolon
multiline_comment|/* Only use CDC */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bDeviceClass
op_ne
l_int|2
op_logical_or
id|dev-&gt;descriptor.bDeviceSubClass
op_ne
l_int|0
op_logical_or
id|dev-&gt;descriptor.bDeviceProtocol
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*Now scan all configs for a ACM configuration*/
r_for
c_loop
(paren
id|cfgnum
op_assign
l_int|0
suffix:semicolon
id|cfgnum
OL
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
id|cfgnum
op_increment
)paren
(brace
multiline_comment|/* The first one should be Communications interface? */
id|interface
op_assign
op_amp
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|2
op_logical_or
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|2
op_logical_or
id|interface-&gt;bInterfaceProtocol
op_ne
l_int|1
op_logical_or
id|interface-&gt;bNumEndpoints
op_ne
l_int|1
)paren
r_continue
suffix:semicolon
multiline_comment|/*Which uses an interrupt input */
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
l_int|0x80
)paren
op_ne
l_int|0x80
op_logical_or
(paren
id|endpoint-&gt;bmAttributes
op_amp
l_int|3
)paren
op_ne
l_int|3
)paren
r_continue
suffix:semicolon
multiline_comment|/* The second one should be a Data interface? */
id|interface
op_assign
op_amp
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|10
op_logical_or
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|0
op_logical_or
id|interface-&gt;bInterfaceProtocol
op_ne
l_int|0
op_logical_or
id|interface-&gt;bNumEndpoints
op_ne
l_int|2
)paren
r_continue
suffix:semicolon
multiline_comment|/*With a bulk input */
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
l_int|0x80
)paren
op_ne
l_int|0x80
op_logical_or
(paren
id|endpoint-&gt;bmAttributes
op_amp
l_int|3
)paren
op_ne
l_int|2
)paren
r_continue
suffix:semicolon
multiline_comment|/*And a bulk output */
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
l_int|0x80
)paren
op_eq
l_int|0x80
op_logical_or
(paren
id|endpoint-&gt;bmAttributes
op_amp
l_int|3
)paren
op_ne
l_int|2
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB ACM found&bslash;n&quot;
)paren
suffix:semicolon
id|usb_set_configuration
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|bConfigurationValue
)paren
suffix:semicolon
id|acm-&gt;dev
op_assign
id|dev
suffix:semicolon
id|acm-&gt;readendp
op_assign
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|1
)braket
dot
id|endpoint
(braket
l_int|0
)braket
dot
id|bEndpointAddress
suffix:semicolon
id|acm-&gt;writeendp
op_assign
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|1
)braket
dot
id|endpoint
(braket
l_int|1
)braket
dot
id|bEndpointAddress
suffix:semicolon
id|acm-&gt;ctrlendp
op_assign
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
dot
id|endpoint
(braket
l_int|0
)braket
dot
id|bEndpointAddress
suffix:semicolon
id|acm-&gt;readpipe
op_assign
id|usb_rcvbulkpipe
c_func
(paren
id|dev
comma
id|acm-&gt;readendp
)paren
suffix:semicolon
id|acm-&gt;writepipe
op_assign
id|usb_sndbulkpipe
c_func
(paren
id|dev
comma
id|acm-&gt;writeendp
)paren
suffix:semicolon
id|usb_request_irq
c_func
(paren
id|dev
comma
id|acm-&gt;ctrlpipe
op_assign
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
id|acm-&gt;ctrlendp
)paren
comma
id|acm_irq
comma
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
dot
id|endpoint
(braket
l_int|0
)braket
dot
id|bInterval
comma
op_amp
id|acm-&gt;ctrlbuffer
)paren
suffix:semicolon
id|acm-&gt;present
op_assign
l_int|1
suffix:semicolon
id|acm-&gt;buffer
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|acm_disconnect
r_static
r_void
id|acm_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
op_amp
id|static_acm_state
suffix:semicolon
multiline_comment|/* this might need work */
id|acm-&gt;present
op_assign
l_int|0
suffix:semicolon
)brace
DECL|variable|acm_driver
r_static
r_struct
id|usb_driver
id|acm_driver
op_assign
(brace
l_string|&quot;acm&quot;
comma
id|acm_probe
comma
id|acm_disconnect
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|function|usb_acm_init
r_int
id|usb_acm_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
op_amp
id|static_acm_state
suffix:semicolon
id|misc_register
c_func
(paren
op_amp
id|usb_acm
)paren
suffix:semicolon
id|acm-&gt;present
op_assign
id|acm-&gt;active
op_assign
l_int|0
suffix:semicolon
id|usb_register
c_func
(paren
op_amp
id|acm_driver
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB ACM registered.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_acm_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* this, too, probably needs work */
id|usb_deregister
c_func
(paren
op_amp
id|acm_driver
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|usb_acm
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
