multiline_comment|/*&n; * USB Abstract Control Model based on Brad Keryan&squot;s USB busmouse driver &n; *&n; * Armin Fuerst 5/8/1999&n; *&n; * version 0.7: Added usb flow control. Fixed bug in uhci.c (what idiot&n; * wrote this code? ...Oops that was me). Fixed module cleanup. Did some&n; * testing at 3Com =&gt; zmodem uload+download works, pppd had trouble but&n; * seems to work now. Changed Menuconfig texts &quot;Communications Device&n; * Class (ACM)&quot; might be a bit more intuitive. Ported to 2.3.13-1 prepatch. &n; * (2/8/99)&n; *&n; * version 0.6: Modularized driver, added disconnect code, improved&n; * assignment of device to tty minor number.&n; * (21/7/99)&n; *&n; * version 0.5: Driver now generates a tty instead of a simple character&n; * device. Moved async bulk transfer to 2.3.10 kernel version. fixed a bug&n; * in uhci_td_allocate. Commenetd out getstringtable which causes crash.&n; * (13/7/99)&n; *&n; * version 0.4: Small fixes in the FIFO, cleanup. Updated Bulk transfer in &n; * uhci.c. Should have the correct interface now. &n; * (6/6/99)&n; *&n; * version 0.5 driver now generates a tty instead of a simple character&n; * device&n; *&n; * version 0.3: Mayor changes. Changed Bulk transfer to interrupt based&n; * transfer. Using FIFO Buffers now. Consistent handling of open/close&n; * file state and detected/nondetected device. File operations behave&n; * according to this. Driver is able to send+receive now! Heureka!&n; * (27/5/99)&n; *&n; * version 0.2: Improved Bulk transfer. TX led now flashes every time data is&n; * sent. Send Encapsulated Data is not needed, nor does it do anything.&n; * Why&squot;s that ?!? Thanks to Thomas Sailer for his close look at the bulk code.&n; * He told me about some importand bugs. (5/21/99)&n; *&n; * version 0.1: Bulk transfer for uhci seems to work now, no dangling tds any&n; * more. TX led of the ISDN TA flashed the first time. Does this mean it works?&n; * The interrupt of the ctrl endpoint crashes the kernel =&gt; no read possible&n; * (5/19/99)&n; *&n; * version 0.0: Driver sets up configuration, sets up data pipes, opens misc&n; * device. No actual data transfer is done, since we don&squot;t have bulk transfer,&n; * yet. Purely skeleton for now. (5/8/99)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/module.h&gt;
singleline_comment|//#include &lt;sys/ioctl.h&gt;
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &quot;usb.h&quot;
DECL|macro|NR_PORTS
mdefine_line|#define NR_PORTS 3
DECL|macro|ACM_MAJOR
mdefine_line|#define ACM_MAJOR 166
DECL|macro|info
mdefine_line|#define info(message); printk(message);
singleline_comment|//#define info(message);
DECL|macro|CTRL_STAT_DTR
mdefine_line|#define CTRL_STAT_DTR&t;1
DECL|macro|CTRL_STAT_RTS
mdefine_line|#define CTRL_STAT_RTS&t;2
DECL|variable|acm_refcount
r_static
r_int
id|acm_refcount
suffix:semicolon
DECL|variable|acm_tty_driver
r_static
r_struct
id|tty_driver
id|acm_tty_driver
suffix:semicolon
DECL|variable|acm_tty
r_static
r_struct
id|tty_struct
op_star
id|acm_tty
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|acm_termios
r_static
r_struct
id|termios
op_star
id|acm_termios
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|acm_termios_locked
r_static
r_struct
id|termios
op_star
id|acm_termios_locked
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|acm_state_table
r_static
r_struct
id|acm_state
id|acm_state_table
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|struct|acm_state
r_struct
id|acm_state
(brace
DECL|member|dev
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
singleline_comment|//the coresponding usb device
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
singleline_comment|//the coresponding tty
DECL|member|present
r_char
id|present
suffix:semicolon
singleline_comment|//a device for this struct was detected =&gt; this tty is used
DECL|member|active
r_char
id|active
suffix:semicolon
singleline_comment|//someone has this acm&squot;s device open 
DECL|member|ctrlstate
r_int
r_int
id|ctrlstate
suffix:semicolon
singleline_comment|//Status of the serial control lines  (handshake,...)
DECL|member|linecoding
r_int
r_int
id|linecoding
suffix:semicolon
singleline_comment|//Status of the line coding (Bits, Stop, Parity)
DECL|member|writesize
DECL|member|readsize
r_int
id|writesize
comma
id|readsize
suffix:semicolon
singleline_comment|//size of the usb buffers
DECL|member|writebuffer
DECL|member|readbuffer
r_char
op_star
id|writebuffer
comma
op_star
id|readbuffer
suffix:semicolon
singleline_comment|//the usb buffers
DECL|member|readtransfer
DECL|member|writetransfer
r_void
op_star
id|readtransfer
comma
op_star
id|writetransfer
suffix:semicolon
DECL|member|ctrltransfer
r_void
op_star
id|ctrltransfer
suffix:semicolon
singleline_comment|//ptr to HC internal transfer struct
DECL|member|writing
DECL|member|reading
r_char
id|writing
comma
id|reading
suffix:semicolon
singleline_comment|//flag if transfer is running
DECL|member|readendp
DECL|member|writeendp
DECL|member|ctrlendp
r_int
r_int
id|readendp
comma
id|writeendp
comma
id|ctrlendp
suffix:semicolon
singleline_comment|//endpoints and
DECL|member|readpipe
DECL|member|writepipe
DECL|member|ctrlpipe
r_int
r_int
id|readpipe
comma
id|writepipe
comma
id|ctrlpipe
suffix:semicolon
singleline_comment|//pipes (are one of these obsolete?)
DECL|member|ctrlinterval
r_int
id|ctrlinterval
suffix:semicolon
singleline_comment|//interval to poll from device
)brace
suffix:semicolon
singleline_comment|//functions for various ACM requests
DECL|function|Set_Control_Line_Status
r_void
id|Set_Control_Line_Status
(paren
r_int
r_int
id|status
comma
r_struct
id|acm_state
op_star
id|acm
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;Set_control_Line_Status&bslash;n&quot;
)paren
suffix:semicolon
id|dr.requesttype
op_assign
l_int|0x22
suffix:semicolon
id|dr.request
op_assign
l_int|0x22
suffix:semicolon
id|dr.value
op_assign
id|status
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
id|acm-&gt;dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|acm-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|acm-&gt;dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|acm-&gt;ctrlstate
op_assign
id|status
suffix:semicolon
)brace
DECL|function|Set_Line_Coding
r_void
id|Set_Line_Coding
(paren
r_int
r_int
id|coding
comma
r_struct
id|acm_state
op_star
id|acm
)paren
(brace
id|devrequest
id|dr
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;Set_Line_Coding&bslash;n&quot;
)paren
suffix:semicolon
id|dr.requesttype
op_assign
l_int|0x22
suffix:semicolon
id|dr.request
op_assign
l_int|0x30
suffix:semicolon
id|dr.value
op_assign
id|coding
suffix:semicolon
id|dr.index
op_assign
l_int|0
suffix:semicolon
id|dr.length
op_assign
l_int|0
suffix:semicolon
id|acm-&gt;dev-&gt;bus-&gt;op
op_member_access_from_pointer
id|control_msg
c_func
(paren
id|acm-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|acm-&gt;dev
comma
l_int|0
)paren
comma
op_amp
id|dr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|acm-&gt;linecoding
op_assign
id|coding
suffix:semicolon
)brace
singleline_comment|//Interrupt handler for various usb events
DECL|function|acm_irq
r_static
r_int
id|acm_irq
c_func
(paren
r_int
id|state
comma
r_void
op_star
id|__buffer
comma
r_int
id|count
comma
r_void
op_star
id|dev_id
)paren
(brace
r_int
r_char
op_star
id|data
suffix:semicolon
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|dev_id
suffix:semicolon
id|devrequest
op_star
id|dr
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;ACM_USB_IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dr
op_assign
id|__buffer
suffix:semicolon
id|data
op_assign
id|__buffer
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
id|dr
)paren
suffix:semicolon
macro_line|#if 1
id|printk
c_func
(paren
l_string|&quot;reqtype: %02X&bslash;n&quot;
comma
id|dr-&gt;requesttype
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;request: %02X&bslash;n&quot;
comma
id|dr-&gt;request
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wValue: %02X&bslash;n&quot;
comma
id|dr-&gt;value
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wIndex: %02X&bslash;n&quot;
comma
id|dr-&gt;index
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;wLength: %02X&bslash;n&quot;
comma
id|dr-&gt;length
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|dr-&gt;request
)paren
(brace
singleline_comment|//Network connection 
r_case
l_int|0x00
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Network connection: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dr-&gt;request
op_eq
l_int|0
)paren
id|info
c_func
(paren
l_string|&quot;disconnected&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dr-&gt;request
op_eq
l_int|1
)paren
id|info
c_func
(paren
l_string|&quot;connected&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|//Response available
r_case
l_int|0x01
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Response available&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|//Set serial line state
r_case
l_int|0x20
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Set serial control line state&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dr-&gt;index
op_eq
l_int|1
)paren
op_logical_and
(paren
id|dr-&gt;length
op_eq
l_int|2
)paren
)paren
(brace
id|acm-&gt;ctrlstate
op_assign
op_star
(paren
(paren
r_int
r_int
r_int
op_star
)paren
id|data
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Serstate: %02X&bslash;n&quot;
comma
id|acm-&gt;ctrlstate
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
singleline_comment|//info(&quot;Done&bslash;n&quot;);
singleline_comment|//Continue transfer
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|acm_read_irq
r_static
r_int
id|acm_read_irq
c_func
(paren
r_int
id|state
comma
r_void
op_star
id|__buffer
comma
r_int
id|count
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|acm-&gt;tty
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|__buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;ACM_READ_IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//Stop transfer
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//Stop transfer
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//&t;printk(&quot;%d %s&bslash;n&quot;,count,data);
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
singleline_comment|//info(&quot;Done&bslash;n&quot;);
singleline_comment|//Continue transfer
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|acm_write_irq
r_static
r_int
id|acm_write_irq
c_func
(paren
r_int
id|state
comma
r_void
op_star
id|__buffer
comma
r_int
id|count
comma
r_void
op_star
id|dev_id
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|acm-&gt;tty
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;ACM_WRITE_IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//Stop transfer
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//Stop transfer
r_return
l_int|0
suffix:semicolon
)brace
id|usb_terminate_bulk
c_func
(paren
id|acm-&gt;dev
comma
id|acm-&gt;writetransfer
)paren
suffix:semicolon
id|acm-&gt;writing
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
singleline_comment|//info(&quot;Done&bslash;n&quot;);
singleline_comment|//Stop transfer
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*TTY STUFF*/
DECL|function|rs_open
r_static
r_int
id|rs_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;USB_FILE_OPEN&bslash;n&quot;
)paren
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|acm
op_assign
op_amp
id|acm_state_table
(braket
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
)braket
suffix:semicolon
id|acm-&gt;tty
op_assign
id|tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE ALREADY OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|acm-&gt;active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*Start reading from the device*/
id|acm-&gt;ctrltransfer
op_assign
id|usb_request_irq
c_func
(paren
id|acm-&gt;dev
comma
id|acm-&gt;ctrlpipe
comma
id|acm_irq
comma
id|acm-&gt;ctrlinterval
comma
id|acm
)paren
suffix:semicolon
id|acm-&gt;reading
op_assign
l_int|1
suffix:semicolon
id|acm-&gt;readtransfer
op_assign
id|usb_request_bulk
c_func
(paren
id|acm-&gt;dev
comma
id|acm-&gt;readpipe
comma
id|acm_read_irq
comma
id|acm-&gt;readbuffer
comma
id|acm-&gt;readsize
comma
id|acm
)paren
suffix:semicolon
id|Set_Control_Line_Status
(paren
id|CTRL_STAT_DTR
op_or
id|CTRL_STAT_RTS
comma
id|acm
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rs_close
r_static
r_void
id|rs_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;rs_close&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|Set_Control_Line_Status
(paren
l_int|0
comma
id|acm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acm-&gt;writing
)paren
(brace
id|usb_terminate_bulk
c_func
(paren
id|acm-&gt;dev
comma
id|acm-&gt;writetransfer
)paren
suffix:semicolon
id|acm-&gt;writing
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acm-&gt;reading
)paren
(brace
id|usb_terminate_bulk
c_func
(paren
id|acm-&gt;dev
comma
id|acm-&gt;readtransfer
)paren
suffix:semicolon
id|acm-&gt;reading
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|//  usb_release_irq(acm-&gt;dev,acm-&gt;ctrltransfer);
id|acm-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|rs_write
r_static
r_int
id|rs_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|written
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;rs_write&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acm-&gt;writing
)paren
(brace
id|info
(paren
l_string|&quot;already writing&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|written
op_assign
(paren
id|count
OG
id|acm-&gt;writesize
)paren
ques
c_cond
id|acm-&gt;writesize
suffix:colon
id|count
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
singleline_comment|//info(&quot;fromuser&bslash;n&quot;);
id|copy_from_user
c_func
(paren
id|acm-&gt;writebuffer
comma
id|buf
comma
id|written
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//info(&quot;notfromuser&bslash;n&quot;);
id|memcpy
c_func
(paren
id|acm-&gt;writebuffer
comma
id|buf
comma
id|written
)paren
suffix:semicolon
)brace
singleline_comment|//start the transfer
id|acm-&gt;writing
op_assign
l_int|1
suffix:semicolon
id|acm-&gt;writetransfer
op_assign
id|usb_request_bulk
c_func
(paren
id|acm-&gt;dev
comma
id|acm-&gt;writepipe
comma
id|acm_write_irq
comma
id|acm-&gt;writebuffer
comma
id|written
comma
id|acm
)paren
suffix:semicolon
r_return
id|written
suffix:semicolon
)brace
DECL|function|rs_put_char
r_static
r_void
id|rs_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;rs_put_char&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|//  printk(&quot;%c&bslash;n&quot;,ch);
)brace
DECL|function|rs_write_room
r_static
r_int
id|rs_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;rs_write_room&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acm-&gt;writing
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|acm-&gt;writesize
suffix:semicolon
)brace
DECL|function|rs_chars_in_buffer
r_static
r_int
id|rs_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;rs_chars_in_buffer&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acm-&gt;writing
)paren
(brace
r_return
id|acm-&gt;writesize
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rs_throttle
r_static
r_void
id|rs_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;rs_throttle&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&t;&n;&t;if (I_IXOFF(tty))&n;&t;&t;rs_send_xchar(tty, STOP_CHAR(tty));&n;*/
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
id|Set_Control_Line_Status
(paren
id|acm-&gt;ctrlstate
op_amp
op_complement
id|CTRL_STAT_RTS
comma
id|acm
)paren
suffix:semicolon
)brace
DECL|function|rs_unthrottle
r_static
r_void
id|rs_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;rs_unthrottle&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|info
c_func
(paren
l_string|&quot;NO ACM DEVICE REGISTERED&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;active
)paren
(brace
id|info
(paren
l_string|&quot;ACM DEVICE NOT OPEN&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&t;&n;&t;if (I_IXOFF(tty))&n;&t;&t;rs_send_xchar(tty, STOP_CHAR(tty));&n;*/
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
id|Set_Control_Line_Status
(paren
id|acm-&gt;ctrlstate
op_or
id|CTRL_STAT_RTS
comma
id|acm
)paren
suffix:semicolon
)brace
DECL|function|get_free_acm
r_static
r_int
id|get_free_acm
c_func
(paren
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|acm_state_table
(braket
id|i
)braket
dot
id|present
)paren
r_return
id|i
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|acm_probe
r_static
r_int
id|acm_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
suffix:semicolon
r_int
id|cfgnum
comma
id|acmno
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;acm_probe&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
(paren
id|acmno
op_assign
id|get_free_acm
c_func
(paren
)paren
)paren
)paren
(brace
id|info
c_func
(paren
l_string|&quot;Too many acm devices connected&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|acm
op_assign
op_amp
id|acm_state_table
(braket
id|acmno
)braket
suffix:semicolon
multiline_comment|/* Only use CDC */
r_if
c_cond
(paren
id|dev-&gt;descriptor.bDeviceClass
op_ne
l_int|2
op_logical_or
id|dev-&gt;descriptor.bDeviceSubClass
op_ne
l_int|0
op_logical_or
id|dev-&gt;descriptor.bDeviceProtocol
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*Now scan all configs for a ACM configuration*/
r_for
c_loop
(paren
id|cfgnum
op_assign
l_int|0
suffix:semicolon
id|cfgnum
OL
id|dev-&gt;descriptor.bNumConfigurations
suffix:semicolon
id|cfgnum
op_increment
)paren
(brace
multiline_comment|/* The first one should be Communications interface? */
id|interface
op_assign
op_amp
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|2
op_logical_or
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|2
op_logical_or
id|interface-&gt;bInterfaceProtocol
op_ne
l_int|1
op_logical_or
id|interface-&gt;bNumEndpoints
op_ne
l_int|1
)paren
r_continue
suffix:semicolon
multiline_comment|/*Which uses an interrupt input */
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
l_int|0x80
)paren
op_ne
l_int|0x80
op_logical_or
(paren
id|endpoint-&gt;bmAttributes
op_amp
l_int|3
)paren
op_ne
l_int|3
)paren
r_continue
suffix:semicolon
multiline_comment|/* The second one should be a Data interface? */
id|interface
op_assign
op_amp
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|interface-&gt;bInterfaceClass
op_ne
l_int|10
op_logical_or
id|interface-&gt;bInterfaceSubClass
op_ne
l_int|0
op_logical_or
id|interface-&gt;bInterfaceProtocol
op_ne
l_int|0
op_logical_or
id|interface-&gt;bNumEndpoints
op_ne
l_int|2
)paren
r_continue
suffix:semicolon
multiline_comment|/*With a bulk input */
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
l_int|0x80
)paren
op_ne
l_int|0x80
op_logical_or
(paren
id|endpoint-&gt;bmAttributes
op_amp
l_int|3
)paren
op_ne
l_int|2
)paren
r_continue
suffix:semicolon
multiline_comment|/*And a bulk output */
id|endpoint
op_assign
op_amp
id|interface-&gt;endpoint
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
l_int|0x80
)paren
op_eq
l_int|0x80
op_logical_or
(paren
id|endpoint-&gt;bmAttributes
op_amp
l_int|3
)paren
op_ne
l_int|2
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;USB ACM %d found&bslash;n&quot;
comma
id|acmno
)paren
suffix:semicolon
id|usb_set_configuration
c_func
(paren
id|dev
comma
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|bConfigurationValue
)paren
suffix:semicolon
id|acm-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev
op_member_access_from_pointer
r_private
op_assign
id|acm
suffix:semicolon
id|acm-&gt;readendp
op_assign
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|1
)braket
dot
id|endpoint
(braket
l_int|0
)braket
dot
id|bEndpointAddress
suffix:semicolon
id|acm-&gt;readpipe
op_assign
id|usb_rcvbulkpipe
c_func
(paren
id|dev
comma
id|acm-&gt;readendp
)paren
suffix:semicolon
id|acm-&gt;readbuffer
op_assign
id|kmalloc
c_func
(paren
id|acm-&gt;readsize
op_assign
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|1
)braket
dot
id|endpoint
(braket
l_int|0
)braket
dot
id|wMaxPacketSize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|acm-&gt;reading
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;readbuffer
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ACM: Couldn&squot;t allocate readbuffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|acm-&gt;writeendp
op_assign
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|1
)braket
dot
id|endpoint
(braket
l_int|1
)braket
dot
id|bEndpointAddress
suffix:semicolon
id|acm-&gt;writepipe
op_assign
id|usb_sndbulkpipe
c_func
(paren
id|dev
comma
id|acm-&gt;writeendp
)paren
suffix:semicolon
id|acm-&gt;writebuffer
op_assign
id|kmalloc
c_func
(paren
id|acm-&gt;writesize
op_assign
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|1
)braket
dot
id|endpoint
(braket
l_int|1
)braket
dot
id|wMaxPacketSize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|acm-&gt;writing
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;writebuffer
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ACM: Couldn&squot;t allocate writebuffer&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|acm-&gt;readbuffer
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|acm-&gt;ctrlendp
op_assign
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
dot
id|endpoint
(braket
l_int|0
)braket
dot
id|bEndpointAddress
suffix:semicolon
id|acm-&gt;ctrlpipe
op_assign
id|usb_rcvctrlpipe
c_func
(paren
id|acm-&gt;dev
comma
id|acm-&gt;ctrlendp
)paren
suffix:semicolon
id|acm-&gt;ctrlinterval
op_assign
id|dev-&gt;config
(braket
id|cfgnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|interface
(braket
l_int|0
)braket
dot
id|endpoint
(braket
l_int|0
)braket
dot
id|bInterval
suffix:semicolon
id|acm-&gt;present
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|acm_disconnect
r_static
r_void
id|acm_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_struct
id|acm_state
op_star
id|acm
op_assign
(paren
r_struct
id|acm_state
op_star
)paren
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;acm_disconnect&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acm-&gt;present
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;device not present&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;disconnecting&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acm-&gt;writing
)paren
(brace
id|usb_terminate_bulk
c_func
(paren
id|acm-&gt;dev
comma
id|acm-&gt;writetransfer
)paren
suffix:semicolon
id|acm-&gt;writing
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acm-&gt;reading
)paren
(brace
id|usb_terminate_bulk
c_func
(paren
id|acm-&gt;dev
comma
id|acm-&gt;readtransfer
)paren
suffix:semicolon
id|acm-&gt;reading
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|//  usb_release_irq(acm-&gt;dev,acm-&gt;ctrltransfer);
singleline_comment|//BUG: What to do if a device is open?? Notify process or not allow cleanup?
id|acm-&gt;active
op_assign
l_int|0
suffix:semicolon
id|acm-&gt;present
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|acm-&gt;writebuffer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|acm-&gt;readbuffer
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/*USB DRIVER STUFF*/
DECL|variable|acm_driver
r_static
r_struct
id|usb_driver
id|acm_driver
op_assign
(brace
l_string|&quot;acm&quot;
comma
id|acm_probe
comma
id|acm_disconnect
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|function|usb_acm_init
r_int
id|usb_acm_init
c_func
(paren
r_void
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;usb_acm_init&bslash;n&quot;
)paren
suffix:semicolon
singleline_comment|//INITIALIZE GLOBAL DATA STRUCTURES
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|NR_PORTS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|acm_state_table
(braket
id|cnt
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acm_state
)paren
)paren
suffix:semicolon
)brace
singleline_comment|//REGISTER TTY DRIVER
id|memset
c_func
(paren
op_amp
id|acm_tty_driver
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|acm_tty_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|acm_tty_driver.driver_name
op_assign
l_string|&quot;usb&quot;
suffix:semicolon
id|acm_tty_driver.name
op_assign
l_string|&quot;ttyACM&quot;
suffix:semicolon
id|acm_tty_driver.major
op_assign
id|ACM_MAJOR
suffix:semicolon
id|acm_tty_driver.minor_start
op_assign
l_int|0
suffix:semicolon
id|acm_tty_driver.num
op_assign
id|NR_PORTS
suffix:semicolon
id|acm_tty_driver.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|acm_tty_driver.subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|acm_tty_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|acm_tty_driver.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|acm_tty_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|acm_tty_driver.refcount
op_assign
op_amp
id|acm_refcount
suffix:semicolon
id|acm_tty_driver.table
op_assign
id|acm_tty
suffix:semicolon
id|acm_tty_driver.termios
op_assign
id|acm_termios
suffix:semicolon
id|acm_tty_driver.termios_locked
op_assign
id|acm_termios_locked
suffix:semicolon
id|acm_tty_driver.open
op_assign
id|rs_open
suffix:semicolon
id|acm_tty_driver.close
op_assign
id|rs_close
suffix:semicolon
id|acm_tty_driver.write
op_assign
id|rs_write
suffix:semicolon
id|acm_tty_driver.put_char
op_assign
id|rs_put_char
suffix:semicolon
singleline_comment|//FUCKIN BUG IN DOKU!!!
id|acm_tty_driver.flush_chars
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_flush_chars;
id|acm_tty_driver.write_room
op_assign
id|rs_write_room
suffix:semicolon
singleline_comment|//ANBOTHER FUCKIN BUG!!
id|acm_tty_driver.ioctl
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_ioctl;
id|acm_tty_driver.set_termios
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_set_termios;
id|acm_tty_driver.set_ldisc
op_assign
l_int|NULL
suffix:semicolon
id|acm_tty_driver.throttle
op_assign
id|rs_throttle
suffix:semicolon
id|acm_tty_driver.unthrottle
op_assign
id|rs_unthrottle
suffix:semicolon
id|acm_tty_driver.stop
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_stop;
id|acm_tty_driver.start
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_start;
id|acm_tty_driver.hangup
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_hangup;
id|acm_tty_driver.break_ctl
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_break;
id|acm_tty_driver.wait_until_sent
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_wait_until_sent;
id|acm_tty_driver.send_xchar
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_send_xchar;
id|acm_tty_driver.read_proc
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_read_proc;
id|acm_tty_driver.chars_in_buffer
op_assign
id|rs_chars_in_buffer
suffix:semicolon
id|acm_tty_driver.flush_buffer
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|//rs_flush_buffer;
id|tty_register_driver
c_func
(paren
op_amp
id|acm_tty_driver
)paren
suffix:semicolon
singleline_comment|//REGISTER USB DRIVER
id|usb_register
c_func
(paren
op_amp
id|acm_driver
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;USB ACM registered.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_acm_cleanup
r_void
id|usb_acm_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|acm_state
op_star
id|acm
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;usb_acm_cleanup&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|acm
op_assign
op_amp
id|acm_state_table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|acm-&gt;present
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;disconnecting %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|acm_disconnect
c_func
(paren
id|acm-&gt;dev
)paren
suffix:semicolon
)brace
)brace
id|tty_unregister_driver
c_func
(paren
op_amp
id|acm_tty_driver
)paren
suffix:semicolon
id|usb_deregister
c_func
(paren
op_amp
id|acm_driver
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|usb_acm_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|usb_acm_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
