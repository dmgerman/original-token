multiline_comment|/*&n;  Keyspan USB to Serial Converter driver&n; &n;  (C) Copyright (C) 2000&n;      Hugh Blemings &lt;hugh@linuxcare.com&gt;&n;   &n;  This program is free software; you can redistribute it and/or modify&n;  it under the terms of the GNU General Public License as published by&n;  the Free Software Foundation; either version 2 of the License, or&n;  (at your option) any later version.&n;&n;  See http://www.linuxcare.com.au/hugh/keyspan.html for more&n;  information on this driver.&n;  &n;  Code in this driver inspired by and in a number of places taken&n;  from Brian Warner&squot;s original Keyspan-PDA driver.&n;&n;  This driver has been put together with the support of Innosys, Inc.&n;  and Keyspan, Inc the manufacturers of the Keyspan USB-serial products.&n;  Thanks Guys :)&n;  &n;  Thanks to Paulus for miscellaneous tidy ups, some largish chunks&n;  of much nicer and/or completely new code and (perhaps most uniquely)&n;  having the patience to sit down and explain why and where he&squot;d changed&n;  stuff. &n;  &n;  Tip &squot;o the hat to Linuxcare for supporting staff in their work on&n;  open source projects.&n;&n;  Change History&n;   (11/01/2000) Adam J. Richter&n;&t;usb_device_id table support.&n;   &n;    Tue Oct 10 23:15:33 EST 2000 Hugh&n;      Merged Paul&squot;s changes with my USA-49W mods.  Work in progress&n;      still...&n;  &n;    Wed Jul 19 14:00:42 EST 2000 gkh&n;      Added module_init and module_exit functions to handle the fact that&n;      this driver is a loadable module now.&n; &n;    Tue Jul 18 16:14:52 EST 2000 Hugh&n;      Basic character input/output for USA-19 now mostly works,&n;      fixed at 9600 baud for the moment.&n;&n;    Sat Jul  8 11:11:48 EST 2000 Hugh&n;      First public release - nothing works except the firmware upload.&n;      Tested on PPC and x86 architectures, seems to behave...&n;*/
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
DECL|macro|DEBUG
mdefine_line|#define DEBUG
multiline_comment|/*  #ifdef CONFIG_USB_SERIAL_DEBUG */
DECL|macro|DEBUG
mdefine_line|#define DEBUG
multiline_comment|/*  #endif */
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;usb-serial.h&quot;
macro_line|#include &quot;keyspan.h&quot;
DECL|macro|INSTAT_BUFLEN
mdefine_line|#define INSTAT_BUFLEN&t;32
DECL|macro|GLOCONT_BUFLEN
mdefine_line|#define GLOCONT_BUFLEN&t;64
multiline_comment|/* Per device and per port private data */
DECL|struct|keyspan_serial_private
r_struct
id|keyspan_serial_private
(brace
multiline_comment|/* number of active ports */
DECL|member|active_count
id|atomic_t
id|active_count
suffix:semicolon
DECL|member|device_details
r_const
id|keyspan_device_details
op_star
id|device_details
suffix:semicolon
DECL|member|instat_urb
id|urb_t
op_star
id|instat_urb
suffix:semicolon
DECL|member|instat_buf
r_char
id|instat_buf
(braket
id|INSTAT_BUFLEN
)braket
suffix:semicolon
multiline_comment|/* XXX this one probably will need a lock */
DECL|member|glocont_urb
id|urb_t
op_star
id|glocont_urb
suffix:semicolon
DECL|member|glocont_buf
r_char
id|glocont_buf
(braket
id|GLOCONT_BUFLEN
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|keyspan_port_private
r_struct
id|keyspan_port_private
(brace
multiline_comment|/* Keep track of which input &amp; output endpoints to use */
DECL|member|in_flip
r_int
id|in_flip
suffix:semicolon
DECL|member|out_flip
r_int
id|out_flip
suffix:semicolon
multiline_comment|/* Keep duplicate of device details in each port&n;&t;   structure as well - simplifies some of the&n;&t;   callback functions etc. */
DECL|member|device_details
r_const
id|keyspan_device_details
op_star
id|device_details
suffix:semicolon
multiline_comment|/* Input endpoints and buffer for this port */
DECL|member|in_urbs
id|urb_t
op_star
id|in_urbs
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|in_buffer
r_char
id|in_buffer
(braket
l_int|2
)braket
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* Output endpoints and buffer for this port */
DECL|member|out_urbs
id|urb_t
op_star
id|out_urbs
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|out_buffer
r_char
id|out_buffer
(braket
l_int|2
)braket
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* Input ack endpoint */
DECL|member|inack_urb
id|urb_t
op_star
id|inack_urb
suffix:semicolon
DECL|member|inack_buffer
r_char
id|inack_buffer
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Output control endpoint */
DECL|member|outcont_urb
id|urb_t
op_star
id|outcont_urb
suffix:semicolon
DECL|member|outcont_buffer
r_char
id|outcont_buffer
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/* Settings for the port */
DECL|member|baud
r_int
id|baud
suffix:semicolon
DECL|member|old_baud
r_int
id|old_baud
suffix:semicolon
DECL|member|cflag
r_int
r_int
id|cflag
suffix:semicolon
DECL|enumerator|flow_none
DECL|enumerator|flow_cts
DECL|enumerator|flow_xon
DECL|member|flow_control
r_enum
(brace
id|flow_none
comma
id|flow_cts
comma
id|flow_xon
)brace
id|flow_control
suffix:semicolon
DECL|member|rts_state
r_int
id|rts_state
suffix:semicolon
multiline_comment|/* Handshaking pins (outputs) */
DECL|member|dtr_state
r_int
id|dtr_state
suffix:semicolon
DECL|member|cts_state
r_int
id|cts_state
suffix:semicolon
multiline_comment|/* Handshaking pins (inputs) */
DECL|member|dsr_state
r_int
id|dsr_state
suffix:semicolon
DECL|member|dcd_state
r_int
id|dcd_state
suffix:semicolon
DECL|member|ri_state
r_int
id|ri_state
suffix:semicolon
DECL|member|tx_start_time
r_int
r_int
id|tx_start_time
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|resend_cont
r_int
id|resend_cont
suffix:semicolon
multiline_comment|/* need to resend control packet */
)brace
suffix:semicolon
multiline_comment|/* Include Keyspan message headers.  All current Keyspan Adapters&n;   make use of one of three message formats which are referred&n;   to as USA-26, USA-28 and USA-49 by Keyspan and within this driver. */
macro_line|#include &quot;keyspan_usa26msg.h&quot;
macro_line|#include &quot;keyspan_usa28msg.h&quot;
macro_line|#include &quot;keyspan_usa49msg.h&quot;
multiline_comment|/* If you don&squot;t get debugging output, uncomment the following&n;   two lines to enable cheat. */
macro_line|#if 0
macro_line|#undef &t;dbg 
mdefine_line|#define&t;dbg&t;printk 
macro_line|#endif
r_static
r_void
id|keyspan_send_setup
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
multiline_comment|/* Functions used by new usb-serial code. */
DECL|function|keyspan_init
r_int
id|keyspan_init
(paren
r_void
)paren
(brace
id|usb_serial_register
(paren
op_amp
id|keyspan_usa18x_pre_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa19_pre_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa19w_pre_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa28_pre_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa28x_pre_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa49w_pre_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa18x_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa19_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa19w_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa28_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa28x_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|keyspan_usa49w_device
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|keyspan_exit
r_void
id|keyspan_exit
(paren
r_void
)paren
(brace
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa18x_pre_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa19_pre_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa19w_pre_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa28_pre_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa28x_pre_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa49w_pre_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa18x_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa19_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa19w_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa28_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa28x_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|keyspan_usa49w_device
)paren
suffix:semicolon
)brace
DECL|variable|keyspan_init
id|module_init
c_func
(paren
id|keyspan_init
)paren
suffix:semicolon
DECL|variable|keyspan_exit
id|module_exit
c_func
(paren
id|keyspan_exit
)paren
suffix:semicolon
DECL|function|keyspan_rx_throttle
r_static
r_void
id|keyspan_rx_throttle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;keyspan_rx_throttle port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
)brace
DECL|function|keyspan_rx_unthrottle
r_static
r_void
id|keyspan_rx_unthrottle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;keyspan_rx_unthrottle port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
)brace
DECL|function|keyspan_break_ctl
r_static
r_void
id|keyspan_break_ctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;keyspan_break_ctl&quot;
)paren
suffix:semicolon
)brace
DECL|function|keyspan_set_termios
r_static
r_void
id|keyspan_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_int
id|baud_rate
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_const
id|keyspan_device_details
op_star
id|d_details
suffix:semicolon
r_int
r_int
id|cflag
suffix:semicolon
multiline_comment|/*  dbg(__FUNCTION__ &quot;.&quot;); */
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|d_details
op_assign
id|p_priv-&gt;device_details
suffix:semicolon
id|cflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
multiline_comment|/* Baud rate calculation takes baud rate as an integer&n;&t;   so other rates can be generated if desired. */
id|baud_rate
op_assign
id|tty_get_baud_rate
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
multiline_comment|/* If no match or invalid, don&squot;t change */
r_if
c_cond
(paren
id|baud_rate
op_ge
l_int|0
op_logical_and
id|d_details
op_member_access_from_pointer
id|calculate_baud_rate
c_func
(paren
id|baud_rate
comma
id|d_details-&gt;baudclk
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
op_eq
id|KEYSPAN_BAUD_RATE_OK
)paren
(brace
multiline_comment|/* FIXME - more to do here to ensure rate changes cleanly */
id|p_priv-&gt;baud
op_assign
id|baud_rate
suffix:semicolon
)brace
multiline_comment|/* set CTS/RTS handshake etc. */
id|p_priv-&gt;cflag
op_assign
id|cflag
suffix:semicolon
id|p_priv-&gt;flow_control
op_assign
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
ques
c_cond
id|flow_cts
suffix:colon
id|flow_none
suffix:semicolon
id|keyspan_send_setup
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
DECL|function|keyspan_ioctl
r_static
r_int
id|keyspan_ioctl
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_int
id|value
comma
id|set
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMGET
suffix:colon
id|value
op_assign
(paren
(paren
id|p_priv-&gt;rts_state
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|p_priv-&gt;dtr_state
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|p_priv-&gt;cts_state
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|p_priv-&gt;dsr_state
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|p_priv-&gt;dcd_state
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|p_priv-&gt;ri_state
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|value
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|value
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|p_priv-&gt;rts_state
op_assign
(paren
(paren
id|value
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;dtr_state
op_assign
(paren
(paren
id|value
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|keyspan_send_setup
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|value
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|set
op_assign
(paren
id|cmd
op_eq
id|TIOCMBIS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
id|TIOCM_RTS
)paren
id|p_priv-&gt;rts_state
op_assign
id|set
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
id|TIOCM_DTR
)paren
id|p_priv-&gt;dtr_state
op_assign
id|set
suffix:semicolon
id|keyspan_send_setup
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
multiline_comment|/* Write function is generic for the three protocols used&n;&t;   with only a minor change for usa49 required */
DECL|function|keyspan_write
r_static
r_int
id|keyspan_write
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_const
id|keyspan_device_details
op_star
id|d_details
suffix:semicolon
r_int
id|flip
suffix:semicolon
r_int
id|left
comma
id|todo
suffix:semicolon
id|urb_t
op_star
id|this_urb
suffix:semicolon
r_int
id|err
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|d_details
op_assign
id|p_priv-&gt;device_details
suffix:semicolon
macro_line|#if 0
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; for port %d (%d chars [%x]), flip=%d&quot;
comma
id|port-&gt;number
comma
id|count
comma
id|buf
(braket
l_int|0
)braket
comma
id|p_priv-&gt;out_flip
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|left
op_assign
id|count
suffix:semicolon
id|left
OG
l_int|0
suffix:semicolon
id|left
op_sub_assign
id|todo
)paren
(brace
id|todo
op_assign
id|left
suffix:semicolon
r_if
c_cond
(paren
id|todo
OG
l_int|63
)paren
id|todo
op_assign
l_int|63
suffix:semicolon
id|flip
op_assign
id|p_priv-&gt;out_flip
suffix:semicolon
multiline_comment|/* Check we have a valid urb/endpoint before we use it... */
r_if
c_cond
(paren
(paren
id|this_urb
op_assign
id|p_priv-&gt;out_urbs
(braket
id|flip
)braket
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* no bulk out, so return 0 bytes written */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; no output urb :(&quot;
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|this_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
r_if
c_cond
(paren
id|this_urb-&gt;transfer_flags
op_amp
id|USB_ASYNC_UNLINK
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|p_priv-&gt;tx_start_time
(braket
id|flip
)braket
OL
l_int|10
op_star
id|HZ
)paren
r_break
suffix:semicolon
id|this_urb-&gt;transfer_flags
op_or_assign
id|USB_ASYNC_UNLINK
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|this_urb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* First byte in buffer is &quot;last flag&quot; - unused so&n;&t;&t;   for now so set to zero */
(paren
(paren
r_char
op_star
)paren
id|this_urb-&gt;transfer_buffer
)paren
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|copy_from_user
c_func
(paren
id|this_urb-&gt;transfer_buffer
op_plus
l_int|1
comma
id|buf
comma
id|todo
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|this_urb-&gt;transfer_buffer
op_plus
l_int|1
comma
id|buf
comma
id|todo
)paren
suffix:semicolon
)brace
id|buf
op_add_assign
id|todo
suffix:semicolon
multiline_comment|/* send the data out the bulk port */
id|this_urb-&gt;transfer_buffer_length
op_assign
id|todo
op_plus
l_int|1
suffix:semicolon
id|this_urb-&gt;transfer_flags
op_and_assign
op_complement
id|USB_ASYNC_UNLINK
suffix:semicolon
id|this_urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|this_urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;usb_submit_urb(write bulk) failed (%d)&quot;
comma
id|err
)paren
suffix:semicolon
)brace
id|p_priv-&gt;tx_start_time
(braket
id|flip
)braket
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Flip for next time if usa26 or usa28 interface&n;&t;&t;   (not used on usa49) */
id|p_priv-&gt;out_flip
op_assign
(paren
id|flip
op_plus
l_int|1
)paren
op_amp
id|d_details-&gt;outdat_endp_flip
suffix:semicolon
)brace
r_return
id|count
op_minus
id|left
suffix:semicolon
)brace
DECL|function|usa26_indat_callback
r_static
r_void
id|usa26_indat_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
r_int
id|endpoint
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__); */
id|endpoint
op_assign
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;nonzero status: %x on endpoint %d.&quot;
comma
id|urb-&gt;status
comma
id|endpoint
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;actual_length
)paren
(brace
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
multiline_comment|/* no error on any byte */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|i
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* some bytes had errors, every byte has status */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_plus
l_int|1
OL
id|urb-&gt;actual_length
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
r_int
id|stat
op_assign
id|data
(braket
id|i
)braket
comma
id|flag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|RXERROR_OVERRUN
)paren
id|flag
op_or_assign
id|TTY_OVERRUN
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|RXERROR_FRAMING
)paren
id|flag
op_or_assign
id|TTY_FRAME
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|RXERROR_PARITY
)paren
id|flag
op_or_assign
id|TTY_PARITY
suffix:semicolon
multiline_comment|/* XXX should handle break (0x10) */
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
op_plus
l_int|1
)braket
comma
id|flag
)paren
suffix:semicolon
)brace
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* Resubmit urb so we continue receiving */
id|urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;resubmit read urb failed. (%d)&quot;
comma
id|err
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Outdat handling is common for usa26, usa28 and usa49 messages */
DECL|function|usa2x_outdat_callback
r_static
r_void
id|usa2x_outdat_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__ &quot; urb %d&quot;, urb == p_priv-&gt;out_urbs[1]); */
r_if
c_cond
(paren
id|port-&gt;active
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|port-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
)brace
DECL|function|usa26_inack_callback
r_static
r_void
id|usa26_inack_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|usa26_outcont_callback
r_static
r_void
id|usa26_outcont_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_priv-&gt;resend_cont
)paren
(brace
multiline_comment|/*  dbg (__FUNCTION__ &quot; sending setup&quot;); */
id|keyspan_usa26_send_setup
c_func
(paren
id|port-&gt;serial
comma
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|usa26_instat_callback
r_static
r_void
id|usa26_instat_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
id|keyspan_usa26_portStatusMessage
op_star
id|msg
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_int
id|old_dcd_state
comma
id|err
suffix:semicolon
id|serial
op_assign
(paren
r_struct
id|usb_serial
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; nonzero status: %x&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;actual_length
op_ne
l_int|9
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; %d byte report??&quot;
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|msg
op_assign
(paren
id|keyspan_usa26_portStatusMessage
op_star
)paren
id|data
suffix:semicolon
macro_line|#if 0
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; port status: port %d cts %d dcd %d dsr %d ri %d toff %d txoff %d rxen %d cr %d&quot;
comma
id|msg-&gt;port
comma
id|msg-&gt;hskia_cts
comma
id|msg-&gt;gpia_dcd
comma
id|msg-&gt;dsr
comma
id|msg-&gt;ri
comma
id|msg-&gt;_txOff
comma
id|msg-&gt;_txXoff
comma
id|msg-&gt;rxEnabled
comma
id|msg-&gt;controlResponse
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Now do something useful with the data */
multiline_comment|/* Check port number from message and retrieve private data */
r_if
c_cond
(paren
id|msg-&gt;port
op_ge
id|serial-&gt;num_ports
)paren
(brace
id|dbg
(paren
l_string|&quot;Unexpected port number %d&quot;
comma
id|msg-&gt;port
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|port
op_assign
op_amp
id|serial-&gt;port
(braket
id|msg-&gt;port
)braket
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
multiline_comment|/* Update handshaking pin state information */
id|old_dcd_state
op_assign
id|p_priv-&gt;dcd_state
suffix:semicolon
id|p_priv-&gt;cts_state
op_assign
(paren
(paren
id|msg-&gt;hskia_cts
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;dsr_state
op_assign
(paren
(paren
id|msg-&gt;dsr
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;dcd_state
op_assign
(paren
(paren
id|msg-&gt;gpia_dcd
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;ri_state
op_assign
(paren
(paren
id|msg-&gt;ri
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;tty
op_logical_and
op_logical_neg
id|C_CLOCAL
c_func
(paren
id|port-&gt;tty
)paren
op_logical_and
id|old_dcd_state
op_ne
id|p_priv-&gt;dcd_state
)paren
(brace
r_if
c_cond
(paren
id|old_dcd_state
)paren
id|tty_hangup
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
multiline_comment|/*  else */
multiline_comment|/*&t;wake_up_interruptible(&amp;p_priv-&gt;open_wait); */
)brace
m_exit
suffix:colon
multiline_comment|/* Resubmit urb so we continue receiving */
id|urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;resubmit read urb failed. (%d)&quot;
comma
id|err
)paren
suffix:semicolon
)brace
)brace
DECL|function|usa26_glocont_callback
r_static
r_void
id|usa26_glocont_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|usa28_indat_callback
r_static
r_void
id|usa28_indat_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__); */
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_if
c_cond
(paren
id|urb
op_ne
id|p_priv-&gt;in_urbs
(braket
id|p_priv-&gt;in_flip
)braket
)paren
r_return
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
"&quot;"
id|nonzero
id|status
suffix:colon
op_mod
id|x
id|on
id|endpoint
op_mod
id|d
dot
"&quot;"
comma
id|urb-&gt;status
comma
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;actual_length
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|i
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* Resubmit urb so we continue receiving */
id|urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;resubmit read urb failed. (%d)&quot;
comma
id|err
)paren
suffix:semicolon
)brace
id|p_priv-&gt;in_flip
op_xor_assign
l_int|1
suffix:semicolon
id|urb
op_assign
id|p_priv-&gt;in_urbs
(braket
id|p_priv-&gt;in_flip
)braket
suffix:semicolon
)brace
r_while
c_loop
(paren
id|urb-&gt;status
op_ne
op_minus
id|EINPROGRESS
)paren
suffix:semicolon
)brace
DECL|function|usa28_inack_callback
r_static
r_void
id|usa28_inack_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|usa28_outcont_callback
r_static
r_void
id|usa28_outcont_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_priv-&gt;resend_cont
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; sending setup&quot;
)paren
suffix:semicolon
id|keyspan_usa28_send_setup
c_func
(paren
id|port-&gt;serial
comma
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|function|usa28_instat_callback
r_static
r_void
id|usa28_instat_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
id|keyspan_usa28_portStatusMessage
op_star
id|msg
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_int
id|old_dcd_state
suffix:semicolon
id|serial
op_assign
(paren
r_struct
id|usb_serial
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; nonzero status: %x&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;actual_length
op_ne
r_sizeof
(paren
r_struct
id|keyspan_usa28_portStatusMessage
)paren
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; bad length %d&quot;
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/*dbg(__FUNCTION__ &quot; %x %x %x %x %x %x %x %x %x %x %x %x&quot;,&n;&t;    data[0], data[1], data[2], data[3], data[4], data[5],&n;&t;    data[6], data[7], data[8], data[9], data[10], data[11]);*/
multiline_comment|/* Now do something useful with the data */
id|msg
op_assign
(paren
id|keyspan_usa28_portStatusMessage
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* Check port number from message and retrieve private data */
r_if
c_cond
(paren
id|msg-&gt;port
op_ge
id|serial-&gt;num_ports
)paren
(brace
id|dbg
(paren
l_string|&quot;Unexpected port number %d&quot;
comma
id|msg-&gt;port
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|port
op_assign
op_amp
id|serial-&gt;port
(braket
id|msg-&gt;port
)braket
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
multiline_comment|/* Update handshaking pin state information */
id|old_dcd_state
op_assign
id|p_priv-&gt;dcd_state
suffix:semicolon
id|p_priv-&gt;cts_state
op_assign
(paren
(paren
id|msg-&gt;cts
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;dsr_state
op_assign
(paren
(paren
id|msg-&gt;dsr
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;dcd_state
op_assign
(paren
(paren
id|msg-&gt;dcd
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;ri_state
op_assign
(paren
(paren
id|msg-&gt;ri
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;tty
op_logical_and
op_logical_neg
id|C_CLOCAL
c_func
(paren
id|port-&gt;tty
)paren
op_logical_and
id|old_dcd_state
op_ne
id|p_priv-&gt;dcd_state
)paren
(brace
r_if
c_cond
(paren
id|old_dcd_state
)paren
id|tty_hangup
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
multiline_comment|/*  else */
multiline_comment|/*&t;wake_up_interruptible(&amp;p_priv-&gt;open_wait); */
)brace
m_exit
suffix:colon
multiline_comment|/* Resubmit urb so we continue receiving */
id|urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;resubmit read urb failed. (%d)&quot;
comma
id|err
)paren
suffix:semicolon
)brace
)brace
DECL|function|usa28_glocont_callback
r_static
r_void
id|usa28_glocont_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|usa49_glocont_callback
r_static
r_void
id|usa49_glocont_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__); */
id|serial
op_assign
(paren
r_struct
id|usb_serial
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
id|port
op_assign
op_amp
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_priv-&gt;resend_cont
)paren
(brace
multiline_comment|/*  dbg (__FUNCTION__ &quot; sending setup&quot;); */
id|keyspan_usa49_send_setup
c_func
(paren
id|serial
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* This is actually called glostat in the Keyspan&n;&t;   doco */
DECL|function|usa49_instat_callback
r_static
r_void
id|usa49_instat_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
id|keyspan_usa49_portStatusMessage
op_star
id|msg
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_int
id|old_dcd_state
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__); */
id|serial
op_assign
(paren
r_struct
id|usb_serial
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; nonzero status: %x&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;actual_length
op_ne
r_sizeof
(paren
r_struct
id|keyspan_usa49_portStatusMessage
)paren
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; bad length %d&quot;
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/*dbg(__FUNCTION__ &quot; %x %x %x %x %x %x %x %x %x %x %x&quot;,&n;&t;    data[0], data[1], data[2], data[3], data[4], data[5],&n;&t;    data[6], data[7], data[8], data[9], data[10]);*/
multiline_comment|/* Now do something useful with the data */
id|msg
op_assign
(paren
id|keyspan_usa49_portStatusMessage
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* Check port number from message and retrieve private data */
r_if
c_cond
(paren
id|msg-&gt;portNumber
op_ge
id|serial-&gt;num_ports
)paren
(brace
id|dbg
(paren
l_string|&quot;Unexpected port number %d&quot;
comma
id|msg-&gt;portNumber
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|port
op_assign
op_amp
id|serial-&gt;port
(braket
id|msg-&gt;portNumber
)braket
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
multiline_comment|/* Update handshaking pin state information */
id|old_dcd_state
op_assign
id|p_priv-&gt;dcd_state
suffix:semicolon
id|p_priv-&gt;cts_state
op_assign
(paren
(paren
id|msg-&gt;cts
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;dsr_state
op_assign
(paren
(paren
id|msg-&gt;dsr
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;dcd_state
op_assign
(paren
(paren
id|msg-&gt;dcd
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p_priv-&gt;ri_state
op_assign
(paren
(paren
id|msg-&gt;ri
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;tty
op_logical_and
op_logical_neg
id|C_CLOCAL
c_func
(paren
id|port-&gt;tty
)paren
op_logical_and
id|old_dcd_state
op_ne
id|p_priv-&gt;dcd_state
)paren
(brace
r_if
c_cond
(paren
id|old_dcd_state
)paren
id|tty_hangup
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
multiline_comment|/*  else */
multiline_comment|/*&t;wake_up_interruptible(&amp;p_priv-&gt;open_wait); */
)brace
m_exit
suffix:colon
multiline_comment|/* Resubmit urb so we continue receiving */
id|urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;resubmit read urb failed. (%d)&quot;
comma
id|err
)paren
suffix:semicolon
)brace
)brace
DECL|function|usa49_inack_callback
r_static
r_void
id|usa49_inack_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|usa49_indat_callback
r_static
r_void
id|usa49_indat_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
r_int
id|endpoint
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__); */
id|endpoint
op_assign
id|usb_pipeendpoint
c_func
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;nonzero status: %x on endpoint %d.&quot;
comma
id|urb-&gt;status
comma
id|endpoint
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;actual_length
)paren
(brace
r_if
c_cond
(paren
id|data
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
multiline_comment|/* no error on any byte */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|i
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* some bytes had errors, every byte has status */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_plus
l_int|1
OL
id|urb-&gt;actual_length
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
r_int
id|stat
op_assign
id|data
(braket
id|i
)braket
comma
id|flag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|RXERROR_OVERRUN
)paren
id|flag
op_or_assign
id|TTY_OVERRUN
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|RXERROR_FRAMING
)paren
id|flag
op_or_assign
id|TTY_FRAME
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|RXERROR_PARITY
)paren
id|flag
op_or_assign
id|TTY_PARITY
suffix:semicolon
multiline_comment|/* XXX should handle break (0x10) */
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
op_plus
l_int|1
)braket
comma
id|flag
)paren
suffix:semicolon
)brace
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* Resubmit urb so we continue receiving */
id|urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;resubmit read urb failed. (%d)&quot;
comma
id|err
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* not used, usa-49 doesn&squot;t have per-port control endpoints */
DECL|function|usa49_outcont_callback
r_static
r_void
id|usa49_outcont_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|keyspan_write_room
r_static
r_int
id|keyspan_write_room
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
singleline_comment|//&t;dbg(&quot;keyspan_write_room called&quot;);
r_return
(paren
l_int|32
)paren
suffix:semicolon
)brace
DECL|function|keyspan_chars_in_buffer
r_static
r_int
id|keyspan_chars_in_buffer
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|keyspan_open
r_static
r_int
id|keyspan_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_struct
id|keyspan_serial_private
op_star
id|s_priv
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_const
id|keyspan_device_details
op_star
id|d_details
suffix:semicolon
r_int
id|i
comma
id|already_active
comma
id|err
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
id|s_priv
op_assign
(paren
r_struct
id|keyspan_serial_private
op_star
)paren
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|d_details
op_assign
id|s_priv-&gt;device_details
suffix:semicolon
multiline_comment|/*  dbg(&quot;keyspan_open called.&quot;); */
id|MOD_INC_USE_COUNT
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
op_increment
id|port-&gt;open_count
suffix:semicolon
id|already_active
op_assign
id|port-&gt;active
suffix:semicolon
id|port-&gt;active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|already_active
)paren
r_return
l_int|0
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
multiline_comment|/* Set some sane defaults */
id|p_priv-&gt;baud
op_assign
l_int|9600
suffix:semicolon
id|p_priv-&gt;cflag
op_assign
id|CREAD
op_or
id|CLOCAL
suffix:semicolon
id|p_priv-&gt;flow_control
op_assign
id|flow_none
suffix:semicolon
id|p_priv-&gt;rts_state
op_assign
l_int|1
suffix:semicolon
id|p_priv-&gt;dtr_state
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Start reading from endpoints */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|urb
op_assign
id|p_priv-&gt;in_urbs
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; submit urb %d failed (%d)&quot;
comma
id|i
comma
id|err
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*    Now done in startup routine&n;&t;if (atomic_inc_return(&amp;s_priv-&gt;active_count) == 1) {&n;&t;&t;s_priv-&gt;instat_urb-&gt;dev = serial-&gt;dev;&n;&t;&t;if ((err = usb_submit_urb(s_priv-&gt;instat_urb)) != 0) {&n;&t;&t;&t;dbg(__FUNCTION__ &quot; submit instat urb failed %d&quot;, err);&n;&t;&t;}&n;&t;}&n;*/
id|keyspan_send_setup
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|stop_urb
r_static
r_inline
r_void
id|stop_urb
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_if
c_cond
(paren
id|urb
op_logical_and
id|urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|urb-&gt;transfer_flags
op_and_assign
op_complement
id|USB_ASYNC_UNLINK
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
DECL|function|keyspan_close
r_static
r_void
id|keyspan_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
multiline_comment|/* FIXME should so sanity check */
r_struct
id|keyspan_serial_private
op_star
id|s_priv
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*  dbg(&quot;keyspan_close called&quot;); */
id|s_priv
op_assign
(paren
r_struct
id|keyspan_serial_private
op_star
)paren
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|port-&gt;open_count
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;active
)paren
(brace
multiline_comment|/* Stop reading/writing urbs */
id|stop_urb
c_func
(paren
id|p_priv-&gt;inack_urb
)paren
suffix:semicolon
id|stop_urb
c_func
(paren
id|p_priv-&gt;outcont_urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|stop_urb
c_func
(paren
id|p_priv-&gt;in_urbs
(braket
id|i
)braket
)paren
suffix:semicolon
id|stop_urb
c_func
(paren
id|p_priv-&gt;out_urbs
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Now done in shutdown &n;&t;&t;&t;if (atomic_dec_return(&amp;s_priv-&gt;active_count) &lt;= 0) {&n;&t;&t;&t;&t;stop_urb(s_priv-&gt;instat_urb);&n;&t;&t;&t;&t;stop_urb(s_priv-&gt;glocont_urb);&n;&t;&t;&t;} */
)brace
id|port-&gt;active
op_assign
l_int|0
suffix:semicolon
id|port-&gt;open_count
op_assign
l_int|0
suffix:semicolon
id|port-&gt;tty
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/* download the firmware to a pre-renumeration device */
DECL|function|keyspan_fake_startup
r_static
r_int
id|keyspan_fake_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|response
suffix:semicolon
r_const
r_struct
id|ezusb_hex_record
op_star
id|record
suffix:semicolon
r_char
op_star
id|fw_name
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Keyspan startup version %04x product %04x&quot;
comma
id|serial-&gt;dev-&gt;descriptor.bcdDevice
comma
id|serial-&gt;dev-&gt;descriptor.idProduct
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|serial-&gt;dev-&gt;descriptor.bcdDevice
op_amp
l_int|0x8000
)paren
op_ne
l_int|0x8000
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Firmware already loaded.  Quitting.&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Select firmware image on the basis of idProduct */
r_switch
c_cond
(paren
id|serial-&gt;dev-&gt;descriptor.idProduct
)paren
(brace
r_case
l_int|0x0101
suffix:colon
id|record
op_assign
op_amp
id|keyspan_usa28_firmware
(braket
l_int|0
)braket
suffix:semicolon
id|fw_name
op_assign
l_string|&quot;USA28&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0102
suffix:colon
id|record
op_assign
op_amp
id|keyspan_usa28x_firmware
(braket
l_int|0
)braket
suffix:semicolon
id|fw_name
op_assign
l_string|&quot;USA28X&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0103
suffix:colon
id|record
op_assign
op_amp
id|keyspan_usa19_firmware
(braket
l_int|0
)braket
suffix:semicolon
id|fw_name
op_assign
l_string|&quot;USA19&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0105
suffix:colon
id|record
op_assign
op_amp
id|keyspan_usa18x_firmware
(braket
l_int|0
)braket
suffix:semicolon
id|fw_name
op_assign
l_string|&quot;USA18X&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0106
suffix:colon
id|record
op_assign
op_amp
id|keyspan_usa19w_firmware
(braket
l_int|0
)braket
suffix:semicolon
id|fw_name
op_assign
l_string|&quot;USA19W&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0109
suffix:colon
id|record
op_assign
op_amp
id|keyspan_usa49w_firmware
(braket
l_int|0
)braket
suffix:semicolon
id|fw_name
op_assign
l_string|&quot;USA49W&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|record
op_assign
l_int|NULL
suffix:semicolon
id|fw_name
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|record
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Required keyspan firmware image (%s) unavailable.&quot;
comma
id|fw_name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Uploading Keyspan %s firmware.&quot;
comma
id|fw_name
)paren
suffix:semicolon
multiline_comment|/* download the firmware image */
id|response
op_assign
id|ezusb_set_reset
c_func
(paren
id|serial
comma
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|record-&gt;address
op_ne
l_int|0xffff
)paren
(brace
id|response
op_assign
id|ezusb_writememory
c_func
(paren
id|serial
comma
id|record-&gt;address
comma
(paren
r_int
r_char
op_star
)paren
id|record-&gt;data
comma
id|record-&gt;data_size
comma
l_int|0xa0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|response
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;ezusb_writememory failed for Keyspan&quot;
l_string|&quot;firmware (%d %04X %p %d)&quot;
comma
id|response
comma
id|record-&gt;address
comma
id|record-&gt;data
comma
id|record-&gt;data_size
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|record
op_increment
suffix:semicolon
)brace
multiline_comment|/* bring device out of reset. Renumeration will occur in a&n;&t;&t;   moment and the new device will bind to the real driver */
id|response
op_assign
id|ezusb_set_reset
c_func
(paren
id|serial
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* we don&squot;t want this device to have a driver assigned to it. */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Helper functions used by keyspan_setup_urbs */
DECL|function|keyspan_setup_urb
r_static
id|urb_t
op_star
id|keyspan_setup_urb
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_int
id|endpoint
comma
r_int
id|dir
comma
r_void
op_star
id|ctx
comma
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_void
(paren
op_star
id|callback
)paren
(paren
id|urb_t
op_star
)paren
)paren
(brace
id|urb_t
op_star
id|urb
suffix:semicolon
r_if
c_cond
(paren
id|endpoint
op_eq
op_minus
l_int|1
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* endpoint not needed */
multiline_comment|/*  dbg (__FUNCTION__ &quot; alloc for endpoint %d.&quot;, endpoint); */
id|urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* No ISO */
r_if
c_cond
(paren
id|urb
op_eq
l_int|NULL
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; alloc for endpoint %d failed.&quot;
comma
id|endpoint
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Fill URB using supplied data. */
id|FILL_BULK_URB
c_func
(paren
id|urb
comma
id|serial-&gt;dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|serial-&gt;dev
comma
id|endpoint
)paren
op_or
id|dir
comma
id|buf
comma
id|len
comma
id|callback
comma
id|ctx
)paren
suffix:semicolon
r_return
id|urb
suffix:semicolon
)brace
DECL|struct|callbacks
r_struct
id|callbacks
(brace
DECL|member|instat_callback
r_void
(paren
op_star
id|instat_callback
)paren
(paren
id|urb_t
op_star
)paren
suffix:semicolon
DECL|member|glocont_callback
r_void
(paren
op_star
id|glocont_callback
)paren
(paren
id|urb_t
op_star
)paren
suffix:semicolon
DECL|member|indat_callback
r_void
(paren
op_star
id|indat_callback
)paren
(paren
id|urb_t
op_star
)paren
suffix:semicolon
DECL|member|outdat_callback
r_void
(paren
op_star
id|outdat_callback
)paren
(paren
id|urb_t
op_star
)paren
suffix:semicolon
DECL|member|inack_callback
r_void
(paren
op_star
id|inack_callback
)paren
(paren
id|urb_t
op_star
)paren
suffix:semicolon
DECL|member|outcont_callback
r_void
(paren
op_star
id|outcont_callback
)paren
(paren
id|urb_t
op_star
)paren
suffix:semicolon
DECL|variable|keyspan_callbacks
)brace
id|keyspan_callbacks
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* msg_usa26 callbacks */
id|instat_callback
suffix:colon
id|usa26_instat_callback
comma
id|glocont_callback
suffix:colon
id|usa26_glocont_callback
comma
id|indat_callback
suffix:colon
id|usa26_indat_callback
comma
id|outdat_callback
suffix:colon
id|usa2x_outdat_callback
comma
id|inack_callback
suffix:colon
id|usa26_inack_callback
comma
id|outcont_callback
suffix:colon
id|usa26_outcont_callback
comma
)brace
comma
(brace
multiline_comment|/* msg_usa28 callbacks */
id|instat_callback
suffix:colon
id|usa28_instat_callback
comma
id|glocont_callback
suffix:colon
id|usa28_glocont_callback
comma
id|indat_callback
suffix:colon
id|usa28_indat_callback
comma
id|outdat_callback
suffix:colon
id|usa2x_outdat_callback
comma
id|inack_callback
suffix:colon
id|usa28_inack_callback
comma
id|outcont_callback
suffix:colon
id|usa28_outcont_callback
comma
)brace
comma
(brace
multiline_comment|/* msg_usa49 callbacks */
id|instat_callback
suffix:colon
id|usa49_instat_callback
comma
id|glocont_callback
suffix:colon
id|usa49_glocont_callback
comma
id|indat_callback
suffix:colon
id|usa49_indat_callback
comma
id|outdat_callback
suffix:colon
id|usa2x_outdat_callback
comma
id|inack_callback
suffix:colon
id|usa49_inack_callback
comma
id|outcont_callback
suffix:colon
id|usa49_outcont_callback
comma
)brace
)brace
suffix:semicolon
multiline_comment|/* Generic setup urbs function that uses&n;&t;   data in device_details */
DECL|function|keyspan_setup_urbs
r_static
r_void
id|keyspan_setup_urbs
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|keyspan_serial_private
op_star
id|s_priv
suffix:semicolon
r_const
id|keyspan_device_details
op_star
id|d_details
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_struct
id|callbacks
op_star
id|cback
suffix:semicolon
r_int
id|endp
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__); */
id|s_priv
op_assign
(paren
r_struct
id|keyspan_serial_private
op_star
)paren
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|d_details
op_assign
id|s_priv-&gt;device_details
suffix:semicolon
multiline_comment|/* Setup values for the various callback routines */
id|cback
op_assign
op_amp
id|keyspan_callbacks
(braket
id|d_details-&gt;msg_format
)braket
suffix:semicolon
multiline_comment|/* Allocate and set up urbs for each one that is in use, &n;&t;&t;   starting with instat endpoints */
id|s_priv-&gt;instat_urb
op_assign
id|keyspan_setup_urb
(paren
id|serial
comma
id|d_details-&gt;instat_endpoint
comma
id|USB_DIR_IN
comma
id|serial
comma
id|s_priv-&gt;instat_buf
comma
id|INSTAT_BUFLEN
comma
id|cback-&gt;instat_callback
)paren
suffix:semicolon
id|s_priv-&gt;glocont_urb
op_assign
id|keyspan_setup_urb
(paren
id|serial
comma
id|d_details-&gt;glocont_endpoint
comma
id|USB_DIR_OUT
comma
id|serial
comma
id|s_priv-&gt;glocont_buf
comma
id|GLOCONT_BUFLEN
comma
id|cback-&gt;glocont_callback
)paren
suffix:semicolon
multiline_comment|/* Setup endpoints for each port specific thing */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d_details-&gt;num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port
op_assign
op_amp
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
multiline_comment|/* Do indat endpoints first, once for each flip */
id|endp
op_assign
id|d_details-&gt;indat_endpoints
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|d_details-&gt;indat_endp_flip
suffix:semicolon
op_increment
id|j
comma
op_increment
id|endp
)paren
(brace
id|p_priv-&gt;in_urbs
(braket
id|j
)braket
op_assign
id|keyspan_setup_urb
(paren
id|serial
comma
id|endp
comma
id|USB_DIR_IN
comma
id|port
comma
id|p_priv-&gt;in_buffer
(braket
id|j
)braket
comma
l_int|64
comma
id|cback-&gt;indat_callback
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
op_increment
id|j
)paren
id|p_priv-&gt;in_urbs
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* outdat endpoints also have flip */
id|endp
op_assign
id|d_details-&gt;outdat_endpoints
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|d_details-&gt;outdat_endp_flip
suffix:semicolon
op_increment
id|j
comma
op_increment
id|endp
)paren
(brace
id|p_priv-&gt;out_urbs
(braket
id|j
)braket
op_assign
id|keyspan_setup_urb
(paren
id|serial
comma
id|endp
comma
id|USB_DIR_OUT
comma
id|port
comma
id|p_priv-&gt;out_buffer
(braket
id|j
)braket
comma
l_int|64
comma
id|cback-&gt;outdat_callback
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
op_increment
id|j
)paren
id|p_priv-&gt;out_urbs
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* inack endpoint */
id|p_priv-&gt;inack_urb
op_assign
id|keyspan_setup_urb
(paren
id|serial
comma
id|d_details-&gt;inack_endpoints
(braket
id|i
)braket
comma
id|USB_DIR_IN
comma
id|port
comma
id|p_priv-&gt;inack_buffer
comma
l_int|1
comma
id|cback-&gt;inack_callback
)paren
suffix:semicolon
multiline_comment|/* outcont endpoint */
id|p_priv-&gt;outcont_urb
op_assign
id|keyspan_setup_urb
(paren
id|serial
comma
id|d_details-&gt;outcont_endpoints
(braket
id|i
)braket
comma
id|USB_DIR_OUT
comma
id|port
comma
id|p_priv-&gt;outcont_buffer
comma
l_int|64
comma
id|cback-&gt;outcont_callback
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* usa19 function doesn&squot;t require prescaler */
DECL|function|keyspan_usa19_calc_baud
r_static
r_int
id|keyspan_usa19_calc_baud
c_func
(paren
id|u32
id|baud_rate
comma
id|u32
id|baudclk
comma
id|u8
op_star
id|rate_hi
comma
id|u8
op_star
id|rate_low
comma
id|u8
op_star
id|prescaler
)paren
(brace
id|u32
id|b16
comma
multiline_comment|/* baud rate times 16 (actual rate used internally) */
id|div
comma
multiline_comment|/* divisor */
id|cnt
suffix:semicolon
multiline_comment|/* inverse of divisor (programmed into 8051) */
multiline_comment|/* prevent divide by zero...  */
r_if
c_cond
(paren
(paren
id|b16
op_assign
(paren
id|baud_rate
op_star
l_int|16L
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
(paren
id|KEYSPAN_INVALID_BAUD_RATE
)paren
suffix:semicolon
)brace
multiline_comment|/* Any &quot;standard&quot; rate over 57k6 is marginal on the USA-19&n;&t;&t;   as we run out of divisor resolution. */
r_if
c_cond
(paren
id|baud_rate
OG
l_int|57600
)paren
(brace
r_return
(paren
id|KEYSPAN_INVALID_BAUD_RATE
)paren
suffix:semicolon
)brace
multiline_comment|/* calculate the divisor and the counter (its inverse) */
r_if
c_cond
(paren
(paren
id|div
op_assign
(paren
id|baudclk
op_div
id|b16
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
(paren
id|KEYSPAN_INVALID_BAUD_RATE
)paren
suffix:semicolon
)brace
r_else
(brace
id|cnt
op_assign
l_int|0
op_minus
id|div
suffix:semicolon
)brace
r_if
c_cond
(paren
id|div
OG
l_int|0xffff
)paren
(brace
r_return
(paren
id|KEYSPAN_INVALID_BAUD_RATE
)paren
suffix:semicolon
)brace
multiline_comment|/* return the counter values if non-null */
r_if
c_cond
(paren
id|rate_low
)paren
(brace
op_star
id|rate_low
op_assign
(paren
id|u8
)paren
(paren
id|cnt
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rate_hi
)paren
(brace
op_star
id|rate_hi
op_assign
(paren
id|u8
)paren
(paren
(paren
id|cnt
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rate_low
op_logical_and
id|rate_hi
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; %d %02x %02x.&quot;
comma
id|baud_rate
comma
op_star
id|rate_hi
comma
op_star
id|rate_low
)paren
suffix:semicolon
)brace
r_return
(paren
id|KEYSPAN_BAUD_RATE_OK
)paren
suffix:semicolon
)brace
DECL|function|keyspan_usa19w_calc_baud
r_static
r_int
id|keyspan_usa19w_calc_baud
c_func
(paren
id|u32
id|baud_rate
comma
id|u32
id|baudclk
comma
id|u8
op_star
id|rate_hi
comma
id|u8
op_star
id|rate_low
comma
id|u8
op_star
id|prescaler
)paren
(brace
id|u32
id|b16
comma
multiline_comment|/* baud rate times 16 (actual rate used internally) */
id|clk
comma
multiline_comment|/* clock with 13/8 prescaler */
id|div
comma
multiline_comment|/* divisor using 13/8 prescaler */
id|res
comma
multiline_comment|/* resulting baud rate using 13/8 prescaler */
id|diff
comma
multiline_comment|/* error using 13/8 prescaler */
id|smallest_diff
suffix:semicolon
id|u8
id|best_prescaler
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__ &quot; %d.&quot;, baud_rate); */
multiline_comment|/* prevent divide by zero */
r_if
c_cond
(paren
(paren
id|b16
op_assign
id|baud_rate
op_star
l_int|16L
)paren
op_eq
l_int|0
)paren
(brace
r_return
(paren
id|KEYSPAN_INVALID_BAUD_RATE
)paren
suffix:semicolon
)brace
multiline_comment|/* Calculate prescaler by trying them all and looking&n;&t;&t;   for best fit */
multiline_comment|/* start with largest possible difference */
id|smallest_diff
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* 0 is an invalid prescaler, used as a flag */
id|best_prescaler
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|8
suffix:semicolon
id|i
op_le
l_int|0xff
suffix:semicolon
op_increment
id|i
)paren
(brace
id|clk
op_assign
(paren
id|baudclk
op_star
l_int|8
)paren
op_div
(paren
id|u32
)paren
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|div
op_assign
id|clk
op_div
id|b16
)paren
op_eq
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|res
op_assign
id|clk
op_div
id|div
suffix:semicolon
id|diff
op_assign
(paren
id|res
OG
id|b16
)paren
ques
c_cond
(paren
id|res
op_minus
id|b16
)paren
suffix:colon
(paren
id|b16
op_minus
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diff
OL
id|smallest_diff
)paren
(brace
id|best_prescaler
op_assign
id|i
suffix:semicolon
id|smallest_diff
op_assign
id|diff
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|best_prescaler
op_eq
l_int|0
)paren
(brace
r_return
(paren
id|KEYSPAN_INVALID_BAUD_RATE
)paren
suffix:semicolon
)brace
id|clk
op_assign
(paren
id|baudclk
op_star
l_int|8
)paren
op_div
(paren
id|u32
)paren
id|best_prescaler
suffix:semicolon
id|div
op_assign
id|clk
op_div
id|b16
suffix:semicolon
multiline_comment|/* return the divisor and prescaler if non-null */
r_if
c_cond
(paren
id|rate_low
)paren
(brace
op_star
id|rate_low
op_assign
(paren
id|u8
)paren
(paren
id|div
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rate_hi
)paren
(brace
op_star
id|rate_hi
op_assign
(paren
id|u8
)paren
(paren
(paren
id|div
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|prescaler
)paren
(brace
op_star
id|prescaler
op_assign
id|best_prescaler
suffix:semicolon
multiline_comment|/*  dbg(__FUNCTION__ &quot; %d %d&quot;, *prescaler, div); */
)brace
r_return
(paren
id|KEYSPAN_BAUD_RATE_OK
)paren
suffix:semicolon
)brace
DECL|function|keyspan_usa26_send_setup
r_static
r_int
id|keyspan_usa26_send_setup
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|keyspan_usa26_portControlMessage
id|msg
suffix:semicolon
r_struct
id|keyspan_serial_private
op_star
id|s_priv
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_const
id|keyspan_device_details
op_star
id|d_details
suffix:semicolon
r_int
id|outcont_urb
suffix:semicolon
id|urb_t
op_star
id|this_urb
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__); */
id|s_priv
op_assign
(paren
r_struct
id|keyspan_serial_private
op_star
)paren
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|d_details
op_assign
id|s_priv-&gt;device_details
suffix:semicolon
id|outcont_urb
op_assign
id|d_details-&gt;outcont_endpoints
(braket
id|port-&gt;number
)braket
suffix:semicolon
id|this_urb
op_assign
id|p_priv-&gt;outcont_urb
suffix:semicolon
multiline_comment|/* Make sure we have an urb then send the message */
r_if
c_cond
(paren
id|this_urb
op_eq
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; oops no urb.&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|p_priv-&gt;resend_cont
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|this_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
multiline_comment|/*  dbg (__FUNCTION__ &quot; already writing&quot;); */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|msg
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|keyspan_usa26_portControlMessage
)paren
)paren
suffix:semicolon
multiline_comment|/* Only set baud rate if it&squot;s changed */
r_if
c_cond
(paren
id|p_priv-&gt;old_baud
op_ne
id|p_priv-&gt;baud
)paren
(brace
id|p_priv-&gt;old_baud
op_assign
id|p_priv-&gt;baud
suffix:semicolon
id|msg.setClocking
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|d_details-&gt;calculate_baud_rate
(paren
id|p_priv-&gt;baud
comma
id|d_details-&gt;baudclk
comma
op_amp
id|msg.baudHi
comma
op_amp
id|msg.baudLo
comma
op_amp
id|msg.prescaler
)paren
op_eq
id|KEYSPAN_INVALID_BAUD_RATE
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;Invalid baud rate %d requested, using 9600.&quot;
comma
id|p_priv-&gt;baud
)paren
suffix:semicolon
id|msg.baudLo
op_assign
l_int|0
suffix:semicolon
id|msg.baudHi
op_assign
l_int|125
suffix:semicolon
multiline_comment|/* Values for 9600 baud */
id|msg.prescaler
op_assign
l_int|10
suffix:semicolon
)brace
id|msg.setPrescaler
op_assign
l_int|0xff
suffix:semicolon
)brace
id|msg.lcr
op_assign
id|USA_DATABITS_8
op_or
id|STOPBITS_5678_1
suffix:semicolon
r_if
c_cond
(paren
id|p_priv-&gt;cflag
op_amp
id|PARENB
)paren
(brace
multiline_comment|/* note USA_PARITY_NONE == 0 */
id|msg.lcr
op_or_assign
(paren
id|p_priv-&gt;cflag
op_amp
id|PARODD
)paren
ques
c_cond
id|USA_PARITY_ODD
suffix:colon
id|USA_PARITY_EVEN
suffix:semicolon
)brace
id|msg.setLcr
op_assign
l_int|0xff
suffix:semicolon
id|msg.ctsFlowControl
op_assign
(paren
id|p_priv-&gt;flow_control
op_eq
id|flow_cts
)paren
suffix:semicolon
id|msg.xonFlowControl
op_assign
l_int|0
suffix:semicolon
id|msg.setFlowControl
op_assign
l_int|0xff
suffix:semicolon
id|msg.forwardingLength
op_assign
l_int|1
suffix:semicolon
id|msg.xonChar
op_assign
l_int|17
suffix:semicolon
id|msg.xoffChar
op_assign
l_int|19
suffix:semicolon
id|msg._txOn
op_assign
l_int|1
suffix:semicolon
id|msg._txOff
op_assign
l_int|0
suffix:semicolon
id|msg.txFlush
op_assign
l_int|0
suffix:semicolon
id|msg.txBreak
op_assign
l_int|0
suffix:semicolon
id|msg.rxOn
op_assign
l_int|1
suffix:semicolon
id|msg.rxOff
op_assign
l_int|0
suffix:semicolon
id|msg.rxFlush
op_assign
l_int|0
suffix:semicolon
id|msg.rxForward
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*msg.returnStatus = 1;&n;&t;msg.resetDataToggle = 0xff;*/
multiline_comment|/* Do handshaking outputs */
id|msg.setTxTriState_setRts
op_assign
l_int|0xff
suffix:semicolon
id|msg.txTriState_rts
op_assign
id|p_priv-&gt;rts_state
suffix:semicolon
id|msg.setHskoa_setDtr
op_assign
l_int|0xff
suffix:semicolon
id|msg.hskoa_dtr
op_assign
id|p_priv-&gt;dtr_state
suffix:semicolon
id|p_priv-&gt;resend_cont
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
id|this_urb-&gt;transfer_buffer
comma
op_amp
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
multiline_comment|/* send the data out the device on control endpoint */
id|this_urb-&gt;transfer_buffer_length
op_assign
r_sizeof
(paren
id|msg
)paren
suffix:semicolon
id|this_urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|this_urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; usb_submit_urb(setup) failed (%d)&quot;
comma
id|err
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_else
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; usb_submit_urb(%d) OK %d bytes (end %d)&quot;
comma
id|outcont_urb
comma
id|this_urb-&gt;transfer_buffer_length
comma
id|usb_pipeendpoint
c_func
(paren
id|this_urb-&gt;pipe
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|keyspan_usa28_send_setup
r_static
r_int
id|keyspan_usa28_send_setup
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|keyspan_usa28_portControlMessage
id|msg
suffix:semicolon
r_struct
id|keyspan_serial_private
op_star
id|s_priv
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_const
id|keyspan_device_details
op_star
id|d_details
suffix:semicolon
id|urb_t
op_star
id|this_urb
suffix:semicolon
r_int
id|err
suffix:semicolon
id|s_priv
op_assign
(paren
r_struct
id|keyspan_serial_private
op_star
)paren
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|d_details
op_assign
id|s_priv-&gt;device_details
suffix:semicolon
multiline_comment|/* only do something if we have a bulk out endpoint */
r_if
c_cond
(paren
(paren
id|this_urb
op_assign
id|p_priv-&gt;outcont_urb
)paren
op_eq
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; oops no urb.&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|p_priv-&gt;resend_cont
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|this_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
l_string|&quot; already writing&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|msg
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|keyspan_usa28_portControlMessage
)paren
)paren
suffix:semicolon
id|msg.setBaudRate
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|keyspan_usa19_calc_baud
c_func
(paren
id|p_priv-&gt;baud
comma
id|d_details-&gt;baudclk
comma
op_amp
id|msg.baudHi
comma
op_amp
id|msg.baudLo
comma
l_int|NULL
)paren
op_eq
id|KEYSPAN_INVALID_BAUD_RATE
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;Invalid baud rate requested %d.&quot;
comma
l_int|9600
)paren
suffix:semicolon
id|msg.baudLo
op_assign
l_int|0xff
suffix:semicolon
id|msg.baudHi
op_assign
l_int|0xb2
suffix:semicolon
multiline_comment|/* Values for 9600 baud */
)brace
multiline_comment|/* If parity is enabled, we must calculate it ourselves. */
id|msg.parity
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX for now */
id|msg.ctsFlowControl
op_assign
(paren
id|p_priv-&gt;flow_control
op_eq
id|flow_cts
)paren
suffix:semicolon
id|msg.xonFlowControl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Do handshaking outputs, DTR is inverted relative to RTS */
id|msg.rts
op_assign
id|p_priv-&gt;rts_state
suffix:semicolon
id|msg.dtr
op_assign
id|p_priv-&gt;dtr_state
suffix:semicolon
id|msg.forwardingLength
op_assign
l_int|1
suffix:semicolon
id|msg.forwardMs
op_assign
l_int|10
suffix:semicolon
id|msg.breakThreshold
op_assign
l_int|45
suffix:semicolon
id|msg.xonChar
op_assign
l_int|17
suffix:semicolon
id|msg.xoffChar
op_assign
l_int|19
suffix:semicolon
id|msg._txOn
op_assign
l_int|1
suffix:semicolon
id|msg._txOff
op_assign
l_int|0
suffix:semicolon
id|msg.txFlush
op_assign
l_int|0
suffix:semicolon
id|msg.txForceXoff
op_assign
l_int|0
suffix:semicolon
id|msg.txBreak
op_assign
l_int|0
suffix:semicolon
id|msg.rxOn
op_assign
l_int|1
suffix:semicolon
id|msg.rxOff
op_assign
l_int|0
suffix:semicolon
id|msg.rxFlush
op_assign
l_int|0
suffix:semicolon
id|msg.rxForward
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*msg.returnStatus = 1;&n;&t;msg.resetDataToggle = 0xff;*/
id|p_priv-&gt;resend_cont
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
id|this_urb-&gt;transfer_buffer
comma
op_amp
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
multiline_comment|/* send the data out the device on control endpoint */
id|this_urb-&gt;transfer_buffer_length
op_assign
r_sizeof
(paren
id|msg
)paren
suffix:semicolon
id|this_urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|this_urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; usb_submit_urb(setup) failed&quot;
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_else
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; usb_submit_urb(setup) OK %d bytes&quot;
comma
id|this_urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|keyspan_usa49_send_setup
r_static
r_int
id|keyspan_usa49_send_setup
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|keyspan_usa49_portControlMessage
id|msg
suffix:semicolon
r_struct
id|keyspan_serial_private
op_star
id|s_priv
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_const
id|keyspan_device_details
op_star
id|d_details
suffix:semicolon
r_int
id|glocont_urb
suffix:semicolon
id|urb_t
op_star
id|this_urb
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/*  dbg (__FUNCTION__); */
id|s_priv
op_assign
(paren
r_struct
id|keyspan_serial_private
op_star
)paren
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|d_details
op_assign
id|s_priv-&gt;device_details
suffix:semicolon
id|glocont_urb
op_assign
id|d_details-&gt;glocont_endpoint
suffix:semicolon
id|this_urb
op_assign
id|s_priv-&gt;glocont_urb
suffix:semicolon
multiline_comment|/*  dbg(__FUNCTION__ &quot; port %d&bslash;n&quot;, port-&gt;number); */
multiline_comment|/* Make sure we have an urb then send the message */
r_if
c_cond
(paren
id|this_urb
op_eq
l_int|NULL
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; oops no urb for port %d.&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|p_priv-&gt;resend_cont
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|this_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
multiline_comment|/*  dbg (__FUNCTION__ &quot; already writing&quot;); */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|msg
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|keyspan_usa49_portControlMessage
)paren
)paren
suffix:semicolon
id|msg.portNumber
op_assign
id|port-&gt;number
suffix:semicolon
multiline_comment|/* Only set baud rate if it&squot;s changed */
r_if
c_cond
(paren
id|p_priv-&gt;old_baud
op_ne
id|p_priv-&gt;baud
)paren
(brace
id|p_priv-&gt;old_baud
op_assign
id|p_priv-&gt;baud
suffix:semicolon
id|msg.setClocking
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|d_details-&gt;calculate_baud_rate
(paren
id|p_priv-&gt;baud
comma
id|d_details-&gt;baudclk
comma
op_amp
id|msg.baudHi
comma
op_amp
id|msg.baudLo
comma
op_amp
id|msg.prescaler
)paren
op_eq
id|KEYSPAN_INVALID_BAUD_RATE
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;Invalid baud rate %d requested, using 9600.&quot;
comma
id|p_priv-&gt;baud
)paren
suffix:semicolon
id|msg.baudLo
op_assign
l_int|0
suffix:semicolon
id|msg.baudHi
op_assign
l_int|125
suffix:semicolon
multiline_comment|/* Values for 9600 baud */
id|msg.prescaler
op_assign
l_int|10
suffix:semicolon
)brace
singleline_comment|//msg.setPrescaler = 0xff;
)brace
id|msg.lcr
op_assign
id|USA_DATABITS_8
op_or
id|STOPBITS_5678_1
suffix:semicolon
r_if
c_cond
(paren
id|p_priv-&gt;cflag
op_amp
id|PARENB
)paren
(brace
multiline_comment|/* note USA_PARITY_NONE == 0 */
id|msg.lcr
op_or_assign
(paren
id|p_priv-&gt;cflag
op_amp
id|PARODD
)paren
ques
c_cond
id|USA_PARITY_ODD
suffix:colon
id|USA_PARITY_EVEN
suffix:semicolon
)brace
id|msg.setLcr
op_assign
l_int|0xff
suffix:semicolon
id|msg.ctsFlowControl
op_assign
(paren
id|p_priv-&gt;flow_control
op_eq
id|flow_cts
)paren
suffix:semicolon
id|msg.xonFlowControl
op_assign
l_int|0
suffix:semicolon
id|msg.setFlowControl
op_assign
l_int|0xff
suffix:semicolon
id|msg.forwardingLength
op_assign
l_int|1
suffix:semicolon
id|msg.xonChar
op_assign
l_int|17
suffix:semicolon
id|msg.xoffChar
op_assign
l_int|19
suffix:semicolon
id|msg._txOn
op_assign
l_int|1
suffix:semicolon
id|msg._txOff
op_assign
l_int|0
suffix:semicolon
id|msg.txFlush
op_assign
l_int|0
suffix:semicolon
id|msg.txBreak
op_assign
l_int|0
suffix:semicolon
id|msg.rxOn
op_assign
l_int|1
suffix:semicolon
id|msg.rxOff
op_assign
l_int|0
suffix:semicolon
id|msg.rxFlush
op_assign
l_int|0
suffix:semicolon
id|msg.rxForward
op_assign
l_int|0
suffix:semicolon
id|msg.enablePort
op_assign
l_int|0xff
suffix:semicolon
id|msg.disablePort
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Do handshaking outputs */
id|msg.setRts
op_assign
l_int|0xff
suffix:semicolon
id|msg.rts
op_assign
id|p_priv-&gt;rts_state
suffix:semicolon
id|msg.setDtr
op_assign
l_int|0xff
suffix:semicolon
id|msg.dtr
op_assign
id|p_priv-&gt;dtr_state
suffix:semicolon
id|p_priv-&gt;resend_cont
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
id|this_urb-&gt;transfer_buffer
comma
op_amp
id|msg
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
multiline_comment|/* send the data out the device on control endpoint */
id|this_urb-&gt;transfer_buffer_length
op_assign
r_sizeof
(paren
id|msg
)paren
suffix:semicolon
id|this_urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|this_urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; usb_submit_urb(setup) failed (%d)&quot;
comma
id|err
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_else
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; usb_submit_urb(%d) OK %d bytes (end %d)&quot;
comma
id|outcont_urb
comma
id|this_urb-&gt;transfer_buffer_length
comma
id|usb_pipeendpoint
c_func
(paren
id|this_urb-&gt;pipe
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|keyspan_send_setup
r_static
r_void
id|keyspan_send_setup
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_struct
id|keyspan_serial_private
op_star
id|s_priv
suffix:semicolon
r_const
id|keyspan_device_details
op_star
id|d_details
suffix:semicolon
id|s_priv
op_assign
(paren
r_struct
id|keyspan_serial_private
op_star
)paren
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|d_details
op_assign
id|s_priv-&gt;device_details
suffix:semicolon
r_switch
c_cond
(paren
id|d_details-&gt;msg_format
)paren
(brace
r_case
id|msg_usa26
suffix:colon
id|keyspan_usa26_send_setup
c_func
(paren
id|serial
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|msg_usa28
suffix:colon
id|keyspan_usa28_send_setup
c_func
(paren
id|serial
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|msg_usa49
suffix:colon
id|keyspan_usa49_send_setup
c_func
(paren
id|serial
comma
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Gets called by the &quot;real&quot; driver (ie once firmware is loaded&n;   and renumeration has taken place. */
DECL|function|keyspan_startup
r_static
r_int
id|keyspan_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_serial_private
op_star
id|s_priv
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
r_const
id|keyspan_device_details
op_star
id|d_details
suffix:semicolon
multiline_comment|/*  dbg(&quot;keyspan_startup called.&quot;); */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|d_details
op_assign
id|keyspan_devices
(braket
id|i
)braket
)paren
op_ne
l_int|NULL
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|d_details-&gt;product_id
op_eq
id|serial-&gt;dev-&gt;descriptor.idProduct
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|d_details
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|__FUNCTION__
l_string|&quot;: unknown product id %x&bslash;n&quot;
comma
id|serial-&gt;dev-&gt;descriptor.idProduct
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Setup private data for serial driver */
id|serial
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|keyspan_serial_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial
op_member_access_from_pointer
r_private
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;kmalloc for keyspan_serial_private failed.&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|serial
op_member_access_from_pointer
r_private
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|keyspan_serial_private
)paren
)paren
suffix:semicolon
id|s_priv
op_assign
(paren
r_struct
id|keyspan_serial_private
op_star
)paren
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|s_priv-&gt;device_details
op_assign
id|d_details
suffix:semicolon
multiline_comment|/* Now setup per port private data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port
op_assign
op_amp
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|port
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|keyspan_port_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
op_member_access_from_pointer
r_private
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot;kmalloc for keyspan_port_private (%d) failed!.&quot;
comma
id|i
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|port
op_member_access_from_pointer
r_private
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|keyspan_port_private
)paren
)paren
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|p_priv-&gt;device_details
op_assign
id|d_details
suffix:semicolon
)brace
id|keyspan_setup_urbs
c_func
(paren
id|serial
)paren
suffix:semicolon
id|s_priv-&gt;instat_urb-&gt;dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|s_priv-&gt;instat_urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; submit instat urb failed %d&quot;
comma
id|err
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|keyspan_shutdown
r_static
r_void
id|keyspan_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|keyspan_serial_private
op_star
id|s_priv
suffix:semicolon
r_struct
id|keyspan_port_private
op_star
id|p_priv
suffix:semicolon
multiline_comment|/*  dbg(&quot;keyspan_shutdown called&quot;); */
id|s_priv
op_assign
(paren
r_struct
id|keyspan_serial_private
op_star
)paren
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
multiline_comment|/* Stop reading/writing urbs */
id|stop_urb
c_func
(paren
id|s_priv-&gt;instat_urb
)paren
suffix:semicolon
id|stop_urb
c_func
(paren
id|s_priv-&gt;glocont_urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
id|port
op_assign
op_amp
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|stop_urb
c_func
(paren
id|p_priv-&gt;inack_urb
)paren
suffix:semicolon
id|stop_urb
c_func
(paren
id|p_priv-&gt;outcont_urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
id|stop_urb
c_func
(paren
id|p_priv-&gt;in_urbs
(braket
id|j
)braket
)paren
suffix:semicolon
id|stop_urb
c_func
(paren
id|p_priv-&gt;out_urbs
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Now free them */
r_if
c_cond
(paren
id|s_priv-&gt;instat_urb
)paren
id|usb_free_urb
c_func
(paren
id|s_priv-&gt;instat_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s_priv-&gt;glocont_urb
)paren
id|usb_free_urb
c_func
(paren
id|s_priv-&gt;glocont_urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
id|port
op_assign
op_amp
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|p_priv
op_assign
(paren
r_struct
id|keyspan_port_private
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_priv-&gt;inack_urb
)paren
id|usb_free_urb
c_func
(paren
id|p_priv-&gt;inack_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_priv-&gt;outcont_urb
)paren
id|usb_free_urb
c_func
(paren
id|p_priv-&gt;outcont_urb
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p_priv-&gt;in_urbs
(braket
id|j
)braket
)paren
id|usb_free_urb
c_func
(paren
id|p_priv-&gt;in_urbs
(braket
id|j
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_priv-&gt;out_urbs
(braket
id|j
)braket
)paren
id|usb_free_urb
c_func
(paren
id|p_priv-&gt;out_urbs
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  dbg(&quot;Freeing serial-&gt;private.&quot;); */
id|kfree
c_func
(paren
id|serial
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
multiline_comment|/*  dbg(&quot;Freeing port-&gt;private.&quot;); */
multiline_comment|/* Now free per port private data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port
op_assign
op_amp
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
id|port-&gt;open_count
OG
l_int|0
)paren
(brace
op_decrement
id|port-&gt;open_count
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
)brace
)brace
eof
