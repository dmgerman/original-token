multiline_comment|/*&n;*  Digi AccelePort USB-4 Serial Converter&n;*&n;*  Copyright 2000 by Digi International&n;*&n;*  This program is free software; you can redistribute it and/or modify&n;*  it under the terms of the GNU General Public License as published by&n;*  the Free Software Foundation; either version 2 of the License, or&n;*  (at your option) any later version.&n;*&n;*  Shamelessly based on Brian Warner&squot;s keyspan_pda.c and Greg Kroah-Hartman&squot;s&n;*  usb-serial driver.&n;*&n;*  Peter Berger (pberger@brimson.com)&n;*  Al Borchers (borchers@steinerpoint.com)&n;*&n;*  (5/3/2000) pberger and borchers&n;*  First alpha version of the driver--many known limitations and bugs.&n;*&n;*  $Id: digi_acceleport.c,v 1.28 2000/05/04 01:47:08 root Exp root $&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_DIGI_ACCELEPORT
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#else
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#endif
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;usb-serial.h&quot;
multiline_comment|/* Defines */
multiline_comment|/* port buffer length -- must be &lt;= transfer buffer length - 2 */
multiline_comment|/* so we can be sure to send the full buffer in one urb */
DECL|macro|DIGI_PORT_BUF_LEN
mdefine_line|#define DIGI_PORT_BUF_LEN&t;&t;&t;16
multiline_comment|/* AccelePort USB Defines */
multiline_comment|/* ids */
DECL|macro|DIGI_VENDOR_ID
mdefine_line|#define DIGI_VENDOR_ID&t;&t;&t;&t;0x05c5
DECL|macro|DIGI_ID
mdefine_line|#define DIGI_ID&t;&t;&t;&t;&t;0x0004
multiline_comment|/* commands */
DECL|macro|DIGI_CMD_SET_BAUD_RATE
mdefine_line|#define DIGI_CMD_SET_BAUD_RATE&t;&t;&t;0
DECL|macro|DIGI_CMD_SET_WORD_SIZE
mdefine_line|#define DIGI_CMD_SET_WORD_SIZE&t;&t;&t;1
DECL|macro|DIGI_CMD_SET_PARITY
mdefine_line|#define DIGI_CMD_SET_PARITY&t;&t;&t;2
DECL|macro|DIGI_CMD_SET_STOP_BITS
mdefine_line|#define DIGI_CMD_SET_STOP_BITS&t;&t;&t;3
DECL|macro|DIGI_CMD_SET_INPUT_FLOW_CONTROL
mdefine_line|#define DIGI_CMD_SET_INPUT_FLOW_CONTROL&t;&t;4
DECL|macro|DIGI_CMD_SET_OUTPUT_FLOW_CONTROL
mdefine_line|#define DIGI_CMD_SET_OUTPUT_FLOW_CONTROL&t;5
DECL|macro|DIGI_CMD_SET_DTR_SIGNAL
mdefine_line|#define DIGI_CMD_SET_DTR_SIGNAL&t;&t;&t;6
DECL|macro|DIGI_CMD_SET_RTS_SIGNAL
mdefine_line|#define DIGI_CMD_SET_RTS_SIGNAL&t;&t;&t;7
DECL|macro|DIGI_CMD_RECEIVE_ENABLE
mdefine_line|#define DIGI_CMD_RECEIVE_ENABLE&t;&t;&t;10
DECL|macro|DIGI_CMD_BREAK_CONTROL
mdefine_line|#define DIGI_CMD_BREAK_CONTROL&t;&t;&t;11
DECL|macro|DIGI_CMD_LOCAL_LOOPBACK
mdefine_line|#define DIGI_CMD_LOCAL_LOOPBACK&t;&t;&t;12
DECL|macro|DIGI_CMD_TRANSMIT_IDLE
mdefine_line|#define DIGI_CMD_TRANSMIT_IDLE&t;&t;&t;13
DECL|macro|DIGI_CMD_WRITE_UART_REGISTER
mdefine_line|#define DIGI_CMD_WRITE_UART_REGISTER&t;&t;15
DECL|macro|DIGI_CMD_AND_UART_REGISTER
mdefine_line|#define DIGI_CMD_AND_UART_REGISTER&t;&t;16
DECL|macro|DIGI_CMD_OR_UART_REGISTER
mdefine_line|#define DIGI_CMD_OR_UART_REGISTER&t;&t;17
DECL|macro|DIGI_CMD_SEND_DATA
mdefine_line|#define DIGI_CMD_SEND_DATA&t;&t;&t;18
multiline_comment|/* baud rates */
DECL|macro|DIGI_BAUD_50
mdefine_line|#define DIGI_BAUD_50&t;&t;&t;&t;0
DECL|macro|DIGI_BAUD_75
mdefine_line|#define DIGI_BAUD_75&t;&t;&t;&t;1
DECL|macro|DIGI_BAUD_110
mdefine_line|#define DIGI_BAUD_110&t;&t;&t;&t;2
DECL|macro|DIGI_BAUD_150
mdefine_line|#define DIGI_BAUD_150&t;&t;&t;&t;3
DECL|macro|DIGI_BAUD_200
mdefine_line|#define DIGI_BAUD_200&t;&t;&t;&t;4
DECL|macro|DIGI_BAUD_300
mdefine_line|#define DIGI_BAUD_300&t;&t;&t;&t;5
DECL|macro|DIGI_BAUD_600
mdefine_line|#define DIGI_BAUD_600&t;&t;&t;&t;6
DECL|macro|DIGI_BAUD_1200
mdefine_line|#define DIGI_BAUD_1200&t;&t;&t;&t;7
DECL|macro|DIGI_BAUD_1800
mdefine_line|#define DIGI_BAUD_1800&t;&t;&t;&t;8
DECL|macro|DIGI_BAUD_2400
mdefine_line|#define DIGI_BAUD_2400&t;&t;&t;&t;9
DECL|macro|DIGI_BAUD_4800
mdefine_line|#define DIGI_BAUD_4800&t;&t;&t;&t;10
DECL|macro|DIGI_BAUD_7200
mdefine_line|#define DIGI_BAUD_7200&t;&t;&t;&t;11
DECL|macro|DIGI_BAUD_9600
mdefine_line|#define DIGI_BAUD_9600&t;&t;&t;&t;12
DECL|macro|DIGI_BAUD_14400
mdefine_line|#define DIGI_BAUD_14400&t;&t;&t;&t;13
DECL|macro|DIGI_BAUD_19200
mdefine_line|#define DIGI_BAUD_19200&t;&t;&t;&t;14
DECL|macro|DIGI_BAUD_28800
mdefine_line|#define DIGI_BAUD_28800&t;&t;&t;&t;15
DECL|macro|DIGI_BAUD_38400
mdefine_line|#define DIGI_BAUD_38400&t;&t;&t;&t;16
DECL|macro|DIGI_BAUD_57600
mdefine_line|#define DIGI_BAUD_57600&t;&t;&t;&t;17
DECL|macro|DIGI_BAUD_76800
mdefine_line|#define DIGI_BAUD_76800&t;&t;&t;&t;18
DECL|macro|DIGI_BAUD_115200
mdefine_line|#define DIGI_BAUD_115200&t;&t;&t;19
DECL|macro|DIGI_BAUD_153600
mdefine_line|#define DIGI_BAUD_153600&t;&t;&t;20
DECL|macro|DIGI_BAUD_230400
mdefine_line|#define DIGI_BAUD_230400&t;&t;&t;21
DECL|macro|DIGI_BAUD_460800
mdefine_line|#define DIGI_BAUD_460800&t;&t;&t;22
multiline_comment|/* flow control arguments */
DECL|macro|DIGI_ENABLE_IXON_IXOFF_FLOW_CONTROL
mdefine_line|#define DIGI_ENABLE_IXON_IXOFF_FLOW_CONTROL&t;1
DECL|macro|DIGI_ENABLE_RTS_CTS_FLOW_CONTROL
mdefine_line|#define DIGI_ENABLE_RTS_CTS_FLOW_CONTROL&t;2
DECL|macro|DIGI_ENABLE_DTR_DSR_FLOW_CONTROL
mdefine_line|#define DIGI_ENABLE_DTR_DSR_FLOW_CONTROL&t;4
multiline_comment|/* macros */
DECL|macro|MAX
mdefine_line|#define MAX(a,b)&t;(((a)&gt;(b))?(a):(b))
DECL|macro|MIN
mdefine_line|#define MIN(a,b)&t;(((a)&lt;(b))?(a):(b))
multiline_comment|/* Structures */
DECL|struct|digi_private
r_typedef
r_struct
id|digi_private
(brace
DECL|member|dp_port_lock
id|spinlock_t
id|dp_port_lock
suffix:semicolon
DECL|member|dp_buf_len
r_int
id|dp_buf_len
suffix:semicolon
DECL|member|dp_buf
r_char
id|dp_buf
(braket
l_int|32
)braket
suffix:semicolon
DECL|typedef|digi_private_t
)brace
id|digi_private_t
suffix:semicolon
DECL|struct|s_digiusb
r_struct
id|s_digiusb
(brace
DECL|member|opcode
id|u8
id|opcode
suffix:semicolon
DECL|member|length
id|u8
id|length
suffix:semicolon
DECL|member|val
id|u8
id|val
suffix:semicolon
DECL|member|pad
id|u8
id|pad
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Local Function Declarations */
r_static
r_void
id|digi_send_cmd
c_func
(paren
r_char
op_star
id|mes
comma
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|opcode
comma
r_int
id|length
comma
r_int
id|val
)paren
suffix:semicolon
r_static
r_void
id|digi_send_oob
c_func
(paren
r_char
op_star
id|mes
comma
r_int
id|opcode
comma
r_int
id|linenum
comma
r_int
id|data1
comma
r_int
id|data2
)paren
suffix:semicolon
r_static
r_void
id|digi_rx_throttle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|digi_rx_unthrottle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|digi_setbaud
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|baud
)paren
suffix:semicolon
r_static
r_void
id|digi_set_termios
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
suffix:semicolon
r_static
r_void
id|digi_break_ctl
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
suffix:semicolon
r_static
r_int
id|digi_get_modem_info
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_int
r_char
op_star
id|value
)paren
suffix:semicolon
r_static
r_int
id|digi_set_modem_info
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_int
r_char
id|value
)paren
suffix:semicolon
r_static
r_int
id|digi_ioctl
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|digi_write
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|digi_write_bulk_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_int
id|digi_write_room
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|digi_chars_in_buffer
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|digi_open
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|digi_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|digi_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|digi_shutdown
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|digi_read_bulk_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
multiline_comment|/* Statics */
multiline_comment|/* device info needed for the Digi serial converter */
DECL|variable|digi_vendor_id
r_static
id|__u16
id|digi_vendor_id
op_assign
id|DIGI_VENDOR_ID
suffix:semicolon
DECL|variable|digi_product_id
r_static
id|__u16
id|digi_product_id
op_assign
id|DIGI_ID
suffix:semicolon
multiline_comment|/* out of band port */
DECL|variable|oob_port_num
r_static
r_int
id|oob_port_num
suffix:semicolon
multiline_comment|/* index of out-of-band port */
DECL|variable|oob_port
r_static
r_struct
id|usb_serial_port
op_star
id|oob_port
suffix:semicolon
multiline_comment|/* out-of-band control port */
DECL|variable|oob_read_started
r_static
r_int
id|oob_read_started
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* config lock -- used to protect digi statics and globals, like oob vars */
DECL|variable|config_lock
id|spinlock_t
id|config_lock
suffix:semicolon
multiline_comment|/* Globals */
DECL|variable|digi_acceleport_device
r_struct
id|usb_serial_device_type
id|digi_acceleport_device
op_assign
(brace
id|name
suffix:colon
l_string|&quot;Digi USB&quot;
comma
id|idVendor
suffix:colon
op_amp
id|digi_vendor_id
comma
id|idProduct
suffix:colon
op_amp
id|digi_product_id
comma
id|needs_interrupt_in
suffix:colon
id|DONT_CARE
comma
id|needs_bulk_in
suffix:colon
id|MUST_HAVE
comma
id|needs_bulk_out
suffix:colon
id|MUST_HAVE
comma
id|num_interrupt_in
suffix:colon
l_int|0
comma
id|num_bulk_in
suffix:colon
l_int|5
comma
id|num_bulk_out
suffix:colon
l_int|5
comma
id|num_ports
suffix:colon
l_int|4
comma
id|open
suffix:colon
id|digi_open
comma
id|close
suffix:colon
id|digi_close
comma
id|write
suffix:colon
id|digi_write
comma
id|write_room
suffix:colon
id|digi_write_room
comma
id|write_bulk_callback
suffix:colon
id|digi_write_bulk_callback
comma
id|read_bulk_callback
suffix:colon
id|digi_read_bulk_callback
comma
id|chars_in_buffer
suffix:colon
id|digi_chars_in_buffer
comma
id|throttle
suffix:colon
id|digi_rx_throttle
comma
id|unthrottle
suffix:colon
id|digi_rx_unthrottle
comma
id|ioctl
suffix:colon
id|digi_ioctl
comma
id|set_termios
suffix:colon
id|digi_set_termios
comma
id|break_ctl
suffix:colon
id|digi_break_ctl
comma
id|startup
suffix:colon
id|digi_startup
comma
id|shutdown
suffix:colon
id|digi_shutdown
comma
)brace
suffix:semicolon
multiline_comment|/* Functions */
multiline_comment|/* Send message on the out-of-Band endpoint */
DECL|function|digi_send_oob
r_static
r_void
id|digi_send_oob
c_func
(paren
r_char
op_star
id|mes
comma
r_int
id|opcode
comma
r_int
id|linenum
comma
r_int
id|data1
comma
r_int
id|data2
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|s_digiusb
id|digiusb
suffix:semicolon
id|digi_private_t
op_star
id|priv
op_assign
(paren
id|digi_private_t
op_star
)paren
(paren
id|oob_port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_send_oob: TOP: from &squot;%s&squot;, opcode: %d, linenum:%d, data1: %d, data2: %d&quot;
comma
id|mes
comma
id|opcode
comma
id|linenum
comma
id|data1
comma
id|data2
)paren
suffix:semicolon
id|digiusb.opcode
op_assign
(paren
id|u8
)paren
id|opcode
suffix:semicolon
id|digiusb.length
op_assign
(paren
id|u8
)paren
id|linenum
suffix:semicolon
id|digiusb.val
op_assign
(paren
id|u8
)paren
id|data1
suffix:semicolon
id|digiusb.pad
op_assign
(paren
id|u8
)paren
id|data2
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|oob_port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_send_oob: opcode:%d already writing...&quot;
comma
id|opcode
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|oob_port-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|oob_port-&gt;write_urb-&gt;transfer_buffer
comma
op_amp
id|digiusb
comma
r_sizeof
(paren
id|digiusb
)paren
)paren
suffix:semicolon
id|oob_port-&gt;write_urb-&gt;transfer_buffer_length
op_assign
r_sizeof
(paren
id|digiusb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|oob_port-&gt;write_urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_send_oob: usb_submit_urb(write bulk) failed, opcode=%d, ret=%d&quot;
comma
id|opcode
comma
id|ret
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_send_oob: opcode %d done&quot;
comma
id|opcode
)paren
suffix:semicolon
)brace
DECL|function|digi_send_cmd
r_static
r_void
id|digi_send_cmd
c_func
(paren
r_char
op_star
id|mes
comma
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|opcode
comma
r_int
id|length
comma
r_int
id|val
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|s_digiusb
id|digiusb
suffix:semicolon
id|digi_private_t
op_star
id|priv
op_assign
(paren
id|digi_private_t
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_send_cmd: TOP: from &squot;%s&squot;, opcode: %d, val: %d&quot;
comma
id|mes
comma
id|opcode
comma
id|val
)paren
suffix:semicolon
id|digiusb.opcode
op_assign
(paren
id|u8
)paren
id|opcode
suffix:semicolon
id|digiusb.length
op_assign
(paren
id|u8
)paren
id|length
suffix:semicolon
id|digiusb.val
op_assign
(paren
id|u8
)paren
id|val
suffix:semicolon
id|digiusb.pad
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_send_cmd: opcode=%d already writing...&quot;
comma
id|opcode
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|port-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
comma
op_amp
id|digiusb
comma
r_sizeof
(paren
id|digiusb
)paren
)paren
suffix:semicolon
id|port-&gt;write_urb-&gt;transfer_buffer_length
op_assign
r_sizeof
(paren
id|digiusb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;write_urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_send_cmd: usb_submit_urb(write bulk) failed, opcode=%d, ret=%d&quot;
comma
id|opcode
comma
id|ret
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;digi_send_cmd: opcode %d done&quot;
comma
id|opcode
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
)brace
DECL|function|digi_rx_throttle
r_static
r_void
id|digi_rx_throttle
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_rx_throttle: TOP: port=%d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* stop receiving characters. We just turn off the URB request, and&n;&t;   let chars pile up in the device. If we&squot;re doing hardware&n;&t;   flowcontrol, the device will signal the other end when its buffer&n;&t;   fills up. If we&squot;re doing XON/XOFF, this would be a good time to&n;&t;   send an XOFF, although it might make sense to foist that off&n;&t;   upon the device too. */
singleline_comment|// usb_unlink_urb(port-&gt;interrupt_in_urb);
)brace
DECL|function|digi_rx_unthrottle
r_static
r_void
id|digi_rx_unthrottle
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_rx_unthrottle: TOP: port=%d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* just restart the receive interrupt URB */
singleline_comment|//if (usb_submit_urb(port-&gt;interrupt_in_urb))
singleline_comment|//&t;dbg( &quot;digi_rx_unthrottle: usb_submit_urb(read urb) failed&quot; );
)brace
DECL|function|digi_setbaud
r_static
r_int
id|digi_setbaud
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|baud
)paren
(brace
r_int
id|bindex
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_setbaud: TOP: port=%d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|baud
)paren
(brace
r_case
l_int|50
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_50
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|75
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_75
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|110
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_110
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|150
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_150
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|200
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|300
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_300
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|600
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1200
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_1200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1800
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_1800
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2400
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_2400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_4800
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7200
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_7200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_9600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|14400
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_14400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_19200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|28800
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_28800
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_38400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_57600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|76800
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_76800
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_115200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|153600
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_153600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|230400
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_230400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|460800
suffix:colon
id|bindex
op_assign
id|DIGI_BAUD_460800
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;digi_setbaud: can&squot;t handle requested baud rate %d&quot;
comma
id|baud
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_setbaud:&quot;
comma
id|port
comma
id|DIGI_CMD_SET_BAUD_RATE
comma
l_int|2
comma
id|bindex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* FIX -- send_cmd should return a value??, return it */
)brace
DECL|function|digi_set_termios
r_static
r_void
id|digi_set_termios
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_int
r_int
id|iflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_iflag
suffix:semicolon
r_int
r_int
id|old_iflag
op_assign
id|old_termios-&gt;c_iflag
suffix:semicolon
r_int
r_int
id|cflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
r_int
r_int
id|old_cflag
op_assign
id|old_termios-&gt;c_cflag
suffix:semicolon
r_int
id|arg
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_set_termios: TOP: port=%d, iflag=0x%x, old_iflag=0x%x, cflag=0x%x, old_cflag=0x%x&quot;
comma
id|port-&gt;number
comma
id|iflag
comma
id|old_iflag
comma
id|cflag
comma
id|old_cflag
)paren
suffix:semicolon
multiline_comment|/* set baud rate */
multiline_comment|/* if( (cflag&amp;CBAUD) != (old_cflag&amp;CBAUD) ) */
(brace
r_switch
c_cond
(paren
(paren
id|cflag
op_amp
id|CBAUD
)paren
)paren
(brace
r_case
id|B50
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|50
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B75
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|75
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B110
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|110
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B150
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|150
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B200
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|200
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B300
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|300
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|600
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|1200
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1800
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|1800
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|2400
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|4800
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B9600
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|9600
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|19200
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|38400
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|57600
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|115200
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;digi_set_termios: can&squot;t handle baud rate 0x%x&quot;
comma
(paren
id|cflag
op_amp
id|CBAUD
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* set input flow control */
multiline_comment|/* if( (iflag&amp;IXOFF) != (old_iflag&amp;IXOFF)&n;&t;|| (cflag&amp;CRTSCTS) != (old_cflag&amp;CRTSCTS) ) */
(brace
id|arg
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iflag
op_amp
id|IXOFF
)paren
)paren
(brace
id|arg
op_or_assign
id|DIGI_ENABLE_IXON_IXOFF_FLOW_CONTROL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|arg
op_or_assign
id|DIGI_ENABLE_RTS_CTS_FLOW_CONTROL
suffix:semicolon
)brace
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_termios: set input flow control:&quot;
comma
id|port
comma
id|DIGI_CMD_SET_INPUT_FLOW_CONTROL
comma
l_int|2
comma
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/* set output flow control */
multiline_comment|/* if( (iflag&amp;IXON) != (old_iflag&amp;IXON)&n;&t;|| (cflag&amp;CRTSCTS) != (old_cflag&amp;CRTSCTS) ) */
(brace
id|arg
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iflag
op_amp
id|IXON
)paren
)paren
(brace
id|arg
op_or_assign
id|DIGI_ENABLE_IXON_IXOFF_FLOW_CONTROL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|arg
op_or_assign
id|DIGI_ENABLE_RTS_CTS_FLOW_CONTROL
suffix:semicolon
)brace
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_set_termios: set output flow control:&quot;
comma
id|port
comma
id|DIGI_CMD_SET_OUTPUT_FLOW_CONTROL
comma
l_int|2
comma
id|arg
)paren
suffix:semicolon
)brace
)brace
DECL|function|digi_break_ctl
r_static
r_void
id|digi_break_ctl
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_break_ctl: TOP: port=%d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
)brace
multiline_comment|/* modem control pins: DTR and RTS are outputs and can be controlled;&n;   DCD, RI, DSR, CTS are inputs and can be read */
DECL|function|digi_get_modem_info
r_static
r_int
id|digi_get_modem_info
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_int
r_char
op_star
id|value
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_get_modem_info: TOP&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|digi_set_modem_info
r_static
r_int
id|digi_set_modem_info
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_int
r_char
id|value
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_set_modem_info: TOP&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|digi_ioctl
r_static
r_int
id|digi_ioctl
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
r_int
r_char
id|status
comma
id|mask
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_ioctl: TOP: port=%d, cmd=0x%x&quot;
comma
id|port-&gt;number
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMGET
suffix:colon
multiline_comment|/* get modem pins state */
id|rc
op_assign
id|digi_get_modem_info
c_func
(paren
id|serial
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|value
op_assign
(paren
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
l_int|7
)paren
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
l_int|6
)paren
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
l_int|4
)paren
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
l_int|3
)paren
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
l_int|2
)paren
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|value
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
multiline_comment|/* set a state as returned by MGET */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|value
comma
(paren
r_int
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|status
op_assign
(paren
(paren
id|value
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|7
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|value
op_amp
id|TIOCM_CAR
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|6
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|value
op_amp
id|TIOCM_RNG
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|5
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|value
op_amp
id|TIOCM_DSR
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|4
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|value
op_amp
id|TIOCM_CTS
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|3
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|value
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|2
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|rc
op_assign
id|digi_set_modem_info
c_func
(paren
id|serial
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
multiline_comment|/* set bits in bitmask &lt;arg&gt; */
r_case
id|TIOCMBIC
suffix:colon
multiline_comment|/* clear bits from bitmask &lt;arg&gt; */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|value
comma
(paren
r_int
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|rc
op_assign
id|digi_get_modem_info
c_func
(paren
id|serial
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|mask
op_assign
(paren
(paren
id|value
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|2
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|value
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
(paren
l_int|1
op_lshift
l_int|7
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|TIOCMBIS
)paren
id|status
op_or_assign
id|mask
suffix:semicolon
r_else
id|status
op_and_assign
op_complement
id|mask
suffix:semicolon
id|rc
op_assign
id|digi_set_modem_info
c_func
(paren
id|serial
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMIWAIT
suffix:colon
multiline_comment|/* wait for any of the 4 modem inputs (DCD,RI,DSR,CTS)*/
multiline_comment|/* TODO */
r_case
id|TIOCGICOUNT
suffix:colon
multiline_comment|/* return count of modemline transitions */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* TODO */
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|function|digi_write
r_static
r_int
id|digi_write
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|i
comma
id|ret
comma
id|data_len
comma
id|new_len
suffix:semicolon
id|digi_private_t
op_star
id|priv
op_assign
(paren
id|digi_private_t
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_write: TOP: port=%d, count=%d, from_user=%d, in_interrupt=%d&quot;
comma
id|port-&gt;number
comma
id|count
comma
id|from_user
comma
id|in_interrupt
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* be sure only one write proceeds at a time */
multiline_comment|/* there are races on the port private buffer */
multiline_comment|/* and races to check write_urb-&gt;status */
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
multiline_comment|/* wait for urb status clear to submit another urb */
r_if
c_cond
(paren
id|port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_write: -EINPROGRESS set&quot;
)paren
suffix:semicolon
multiline_comment|/* buffer the data if possible */
id|new_len
op_assign
id|MIN
c_func
(paren
id|count
comma
id|DIGI_PORT_BUF_LEN
op_minus
id|priv-&gt;dp_buf_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|priv-&gt;dp_buf
op_plus
id|priv-&gt;dp_buf_len
comma
id|buf
comma
id|new_len
)paren
suffix:semicolon
id|priv-&gt;dp_buf_len
op_add_assign
id|new_len
suffix:semicolon
multiline_comment|/* unlock and return number of bytes buffered */
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_write: buffering, return %d&quot;
comma
id|new_len
)paren
suffix:semicolon
r_return
id|new_len
suffix:semicolon
)brace
multiline_comment|/* allow space for any buffered data and for new data, up to */
multiline_comment|/* transfer buffer size - 2 (for command and length bytes) */
id|new_len
op_assign
id|MIN
c_func
(paren
id|count
comma
id|port-&gt;bulk_out_size
op_minus
l_int|2
op_minus
id|priv-&gt;dp_buf_len
)paren
suffix:semicolon
id|data_len
op_assign
id|new_len
op_plus
id|priv-&gt;dp_buf_len
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_write: counts: new data %d, buf data %d, total data %d (max %d)&quot;
comma
id|new_len
comma
id|priv-&gt;dp_buf_len
comma
id|data_len
comma
id|port-&gt;bulk_out_size
op_minus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* nothing to send */
r_if
c_cond
(paren
id|data_len
op_eq
l_int|0
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set command and length bytes */
op_star
(paren
(paren
id|u8
op_star
)paren
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
)paren
)paren
op_assign
(paren
id|u8
)paren
id|DIGI_CMD_SEND_DATA
suffix:semicolon
op_star
(paren
(paren
id|u8
op_star
)paren
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
)paren
op_plus
l_int|1
)paren
op_assign
(paren
id|u8
)paren
id|data_len
suffix:semicolon
multiline_comment|/* set total transfer buffer length */
id|port-&gt;write_urb-&gt;transfer_buffer_length
op_assign
id|data_len
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* copy in buffered data first */
id|memcpy
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
op_plus
l_int|2
comma
id|priv-&gt;dp_buf
comma
id|priv-&gt;dp_buf_len
)paren
suffix:semicolon
multiline_comment|/* copy in new data */
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|copy_from_user
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
op_plus
l_int|2
op_plus
id|priv-&gt;dp_buf_len
comma
id|buf
comma
id|new_len
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
op_plus
l_int|2
op_plus
id|priv-&gt;dp_buf_len
comma
id|buf
comma
id|new_len
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: digi_write: length=%d, data=&quot;
comma
id|port-&gt;write_urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|port-&gt;write_urb-&gt;transfer_buffer_length
suffix:semicolon
op_increment
id|i
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%.2x &quot;
comma
(paren
(paren
r_int
r_char
op_star
)paren
id|port-&gt;write_urb-&gt;transfer_buffer
)paren
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* submit urb */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;write_urb
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* submit successful, return length of new data written */
id|ret
op_assign
id|new_len
suffix:semicolon
multiline_comment|/* clear buffer */
id|priv-&gt;dp_buf_len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_write: usb_submit_urb(write bulk) failed, ret=%d&quot;
comma
id|ret
)paren
suffix:semicolon
multiline_comment|/* no bytes written - should we return the error code or 0? */
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* return length of new data written, or error */
id|dbg
c_func
(paren
l_string|&quot;digi_write: returning %d&quot;
comma
id|ret
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|digi_write_bulk_callback
r_static
r_void
id|digi_write_bulk_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
id|digi_private_t
op_star
id|priv
op_assign
(paren
id|digi_private_t
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_write_bulk_callback: TOP: port=%d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* handle callback on out-of-band port */
r_if
c_cond
(paren
id|port-&gt;number
op_eq
id|oob_port_num
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_write_bulk_callback: oob callback&quot;
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;write_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
id|port_paranoia_check
c_func
(paren
id|port
comma
l_string|&quot;digi_write_bulk_callback&quot;
)paren
op_logical_or
id|serial_paranoia_check
c_func
(paren
id|serial
comma
l_string|&quot;digi_write_bulk_callback&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* try to send any buffered data on this port */
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;write_urb-&gt;status
op_ne
op_minus
id|EINPROGRESS
op_logical_and
id|priv-&gt;dp_buf_len
OG
l_int|0
)paren
(brace
multiline_comment|/* set command and length bytes */
op_star
(paren
(paren
id|u8
op_star
)paren
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
)paren
)paren
op_assign
(paren
id|u8
)paren
id|DIGI_CMD_SEND_DATA
suffix:semicolon
op_star
(paren
(paren
id|u8
op_star
)paren
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
)paren
op_plus
l_int|1
)paren
op_assign
(paren
id|u8
)paren
id|priv-&gt;dp_buf_len
suffix:semicolon
multiline_comment|/* set total transfer buffer length */
id|port-&gt;write_urb-&gt;transfer_buffer_length
op_assign
id|priv-&gt;dp_buf_len
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* copy in buffered data */
id|memcpy
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
op_plus
l_int|2
comma
id|priv-&gt;dp_buf
comma
id|priv-&gt;dp_buf_len
)paren
suffix:semicolon
multiline_comment|/* submit urb */
id|dbg
c_func
(paren
l_string|&quot;digi_write_bulk_callback: submit urb to write buffer, data len=%d&quot;
comma
id|priv-&gt;dp_buf_len
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;write_urb
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* successful, clear buffer */
id|priv-&gt;dp_buf_len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_write_bulk_callback: usb_submit_urb(write bulk) failed, ret=%d&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
multiline_comment|/* wake up port processes */
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;write_wait
)paren
suffix:semicolon
multiline_comment|/* wake up line discipline */
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(brace
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* wake up other tty processes */
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
DECL|function|digi_write_room
r_static
r_int
id|digi_write_room
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_int
id|room
suffix:semicolon
id|digi_private_t
op_star
id|priv
op_assign
(paren
id|digi_private_t
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_write_room: TOP: port=%d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|room
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|room
op_assign
id|port-&gt;bulk_out_size
op_minus
l_int|2
op_minus
id|priv-&gt;dp_buf_len
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_write_room: return room=%d&quot;
comma
id|room
)paren
suffix:semicolon
r_return
id|room
suffix:semicolon
)brace
DECL|function|digi_chars_in_buffer
r_static
r_int
id|digi_chars_in_buffer
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
id|digi_private_t
op_star
id|priv
op_assign
(paren
id|digi_private_t
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_chars_in_buffer: TOP: port=%d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_chars_in_buffer: return=%d&quot;
comma
id|port-&gt;bulk_out_size
)paren
suffix:semicolon
r_return
id|port-&gt;bulk_out_size
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_chars_in_buffer: return=%d&quot;
comma
id|priv-&gt;dp_buf_len
)paren
suffix:semicolon
r_return
id|priv-&gt;dp_buf_len
suffix:semicolon
)brace
)brace
DECL|function|digi_open
r_static
r_int
id|digi_open
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|ret
suffix:semicolon
id|digi_private_t
op_star
id|priv
op_assign
(paren
id|digi_private_t
op_star
)paren
(paren
id|port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_open: TOP: port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* if port is already open, just return */
multiline_comment|/* be sure exactly one open succeeds */
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;active
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|port-&gt;active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
multiline_comment|/* start reading from the out-of-band port for the device */
multiline_comment|/* be sure this happens exactly once */
id|spin_lock
c_func
(paren
op_amp
id|config_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oob_read_started
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|oob_port-&gt;read_urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_open: usb_submit_urb(read bulk) for oob failed, ret=%d&quot;
comma
id|ret
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|config_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_open: usb_submit_urb(read bulk) for oob succeeded&quot;
)paren
suffix:semicolon
id|oob_read_started
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|config_lock
)paren
suffix:semicolon
multiline_comment|/* initialize port */
id|dbg
c_func
(paren
l_string|&quot;digi_open: init...&quot;
)paren
suffix:semicolon
multiline_comment|/* set 9600, 8N1, DTR, RTS, RX enable, no input or output flow control */
id|digi_setbaud
c_func
(paren
id|port
comma
l_int|9600
)paren
suffix:semicolon
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_open: wordsize&quot;
comma
id|port
comma
id|DIGI_CMD_SET_WORD_SIZE
comma
l_int|2
comma
l_int|3
)paren
suffix:semicolon
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_open: parity&quot;
comma
id|port
comma
id|DIGI_CMD_SET_PARITY
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_open: stopbits&quot;
comma
id|port
comma
id|DIGI_CMD_SET_STOP_BITS
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_open: DTR on&quot;
comma
id|port
comma
id|DIGI_CMD_SET_DTR_SIGNAL
comma
l_int|2
comma
l_int|1
)paren
suffix:semicolon
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_open: RTS on&quot;
comma
id|port
comma
id|DIGI_CMD_SET_RTS_SIGNAL
comma
l_int|2
comma
l_int|1
)paren
suffix:semicolon
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_open: RX enable on&quot;
comma
id|port
comma
id|DIGI_CMD_RECEIVE_ENABLE
comma
l_int|2
comma
l_int|1
)paren
suffix:semicolon
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_open: input flow control off&quot;
comma
id|port
comma
id|DIGI_CMD_SET_INPUT_FLOW_CONTROL
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|digi_send_cmd
c_func
(paren
l_string|&quot;digi_open: output flow control off&quot;
comma
id|port
comma
id|DIGI_CMD_SET_OUTPUT_FLOW_CONTROL
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* start reading from the device */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;read_urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_open: usb_submit_urb(read bulk) failed, ret=%d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;digi_open: done&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|digi_close
r_static
r_void
id|digi_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_close: TOP: port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* Need to change the control lines here */
multiline_comment|/* TODO */
id|dbg
c_func
(paren
l_string|&quot;digi_close: wanna clear DTR and RTS...&quot;
)paren
suffix:semicolon
singleline_comment|//digi_send_cmd( &quot;digi_close DTR off&quot;, port, 6, 2, 0);&t;// clear DTR
singleline_comment|//digi_send_cmd( &quot;digi_close RTS off&quot;, port, 7, 2, 0);&t;// clear RTS
singleline_comment|//digi_send_cmd( &quot;digi_close RX disable&quot;, port, 10, 2, 0);&t;// Rx Disable
id|digi_send_oob
c_func
(paren
l_string|&quot;digi_close RTS off&quot;
comma
id|DIGI_CMD_SET_RTS_SIGNAL
comma
id|port-&gt;number
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// clear RTS
id|digi_send_oob
c_func
(paren
l_string|&quot;digi_close DTR off&quot;
comma
id|DIGI_CMD_SET_DTR_SIGNAL
comma
id|port-&gt;number
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// clear DTR
r_while
c_loop
(paren
id|oob_port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|dbg
(paren
l_string|&quot;digi_close: waiting for final writes to complete on oob port %d...&quot;
comma
id|oob_port-&gt;number
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|oob_port-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* shutdown our bulk reads and writes */
id|usb_unlink_urb
(paren
id|port-&gt;write_urb
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|port-&gt;read_urb
)paren
suffix:semicolon
id|port-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|digi_startup
r_static
r_int
id|digi_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|i
suffix:semicolon
id|digi_private_t
op_star
id|priv
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_startup: TOP&quot;
)paren
suffix:semicolon
multiline_comment|/* initialize config lock */
id|spin_lock_init
c_func
(paren
op_amp
id|config_lock
)paren
suffix:semicolon
multiline_comment|/* allocate the private data structures for all ports */
multiline_comment|/* number of regular ports + 1 for the out-of-band port */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|digi_acceleport_device.num_ports
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* allocate private structure */
id|priv
op_assign
id|serial-&gt;port
(braket
id|i
)braket
dot
r_private
op_assign
(paren
id|digi_private_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|digi_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv
op_eq
(paren
id|digi_private_t
op_star
)paren
l_int|0
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* error */
multiline_comment|/* initialize private structure */
id|priv-&gt;dp_buf_len
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|priv-&gt;dp_port_lock
)paren
suffix:semicolon
multiline_comment|/* initialize write wait queue for this port */
id|init_waitqueue_head
c_func
(paren
op_amp
id|serial-&gt;port
(braket
id|i
)braket
dot
id|write_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* initialize out of band port info */
id|oob_port_num
op_assign
id|digi_acceleport_device.num_ports
suffix:semicolon
id|oob_port
op_assign
op_amp
id|serial-&gt;port
(braket
id|oob_port_num
)braket
suffix:semicolon
id|oob_read_started
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|digi_shutdown
r_static
r_void
id|digi_shutdown
c_func
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|i
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_shutdown: TOP&quot;
)paren
suffix:semicolon
multiline_comment|/* stop writing and reading from the out-of-band port */
id|usb_unlink_urb
c_func
(paren
id|oob_port-&gt;write_urb
)paren
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|oob_port-&gt;read_urb
)paren
suffix:semicolon
id|oob_read_started
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* free the private data structures for all ports */
multiline_comment|/* number of regular ports + 1 for the out-of-band port */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|digi_acceleport_device.num_ports
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kfree
c_func
(paren
id|serial-&gt;port
(braket
id|i
)braket
dot
r_private
)paren
suffix:semicolon
)brace
)brace
DECL|function|digi_read_bulk_callback
r_static
r_void
id|digi_read_bulk_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|ret
comma
id|i
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;digi_read_bulk_callback: TOP: port=%d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* handle oob callback */
r_if
c_cond
(paren
id|port-&gt;number
op_eq
id|oob_port_num
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_read_bulk_callback: oob_port callback, opcode=%d, line=%d, status=%d, ret=%d&quot;
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
comma
id|data
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_read_bulk_callback: nonzero read bulk status on oob: %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_read_bulk_callback: failed resubmitting oob urb, ret=%d&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
id|port_paranoia_check
c_func
(paren
id|port
comma
l_string|&quot;digi_read_bulk_callback&quot;
)paren
op_logical_or
id|serial_paranoia_check
c_func
(paren
id|serial
comma
l_string|&quot;digi_read_bulk_callback&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* check status */
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_read_bulk_callback: nonzero read bulk status: %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|urb-&gt;actual_length
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: digi_read_bulk_callback: length=%d, data=&quot;
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|i
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%.2x &quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Digi read packets are:&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t; */
multiline_comment|/* 0         1      2         3       4    ...     3+length-1 == 2+length*/
multiline_comment|/* opcode, length, status, data[0], data[1]...data[length-2]&t;&t;&t; */
r_if
c_cond
(paren
id|urb-&gt;actual_length
OG
l_int|3
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|3
suffix:semicolon
id|i
OL
l_int|2
op_plus
id|data
(braket
l_int|1
)braket
suffix:semicolon
op_increment
id|i
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* Continue trying to read */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;digi_read_bulk_callback: failed resubmitting read urb, ret=%d&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;/* CONFIG_USB_SERIAL_DIGI_ACCELEPORT */
eof
