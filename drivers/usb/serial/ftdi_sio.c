multiline_comment|/*&n; * USB FTDI SIO driver&n; *&n; *&t;(C) Copyright (C) 1999, 2000&n; *&t;    Greg Kroah-Hartman (greg@kroah.com)&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; * See Documentation/usb/usb-serial.txt for more information on using this driver&n; * &n; * (03/26/2000) gkh&n; *&t;Split driver up into device specific pieces.&n; * &n; */
multiline_comment|/* Bill Ryder - bryder@sgi.com - wrote the FTDI_SIO implementation */
multiline_comment|/* Thanx to FTDI for so kindly providing details of the protocol required */
multiline_comment|/*   to talk to the device */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_FTDI_SIO
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#else
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#endif
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;usb-serial.h&quot;
macro_line|#include &quot;ftdi_sio.h&quot;
DECL|macro|FTDI_VENDOR_ID
mdefine_line|#define FTDI_VENDOR_ID&t;&t;&t;0x0403
DECL|macro|FTDI_SIO_SERIAL_CONVERTER_ID
mdefine_line|#define FTDI_SIO_SERIAL_CONVERTER_ID&t;0x8372
multiline_comment|/* function prototypes for a FTDI serial converter */
r_static
r_int
id|ftdi_sio_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|ftdi_sio_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|ftdi_sio_write
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|ftdi_sio_read_bulk_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|ftdi_sio_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old
)paren
suffix:semicolon
r_static
r_int
id|ftdi_sio_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
multiline_comment|/* All of the device info needed for the FTDI SIO serial converter */
DECL|variable|ftdi_vendor_id
r_static
id|__u16
id|ftdi_vendor_id
op_assign
id|FTDI_VENDOR_ID
suffix:semicolon
DECL|variable|ftdi_sio_product_id
r_static
id|__u16
id|ftdi_sio_product_id
op_assign
id|FTDI_SIO_SERIAL_CONVERTER_ID
suffix:semicolon
DECL|variable|ftdi_sio_device
r_struct
id|usb_serial_device_type
id|ftdi_sio_device
op_assign
(brace
id|name
suffix:colon
l_string|&quot;FTDI SIO&quot;
comma
id|idVendor
suffix:colon
op_amp
id|ftdi_vendor_id
comma
multiline_comment|/* the FTDI vendor ID */
id|idProduct
suffix:colon
op_amp
id|ftdi_sio_product_id
comma
multiline_comment|/* the FTDI SIO product id */
id|needs_interrupt_in
suffix:colon
id|MUST_HAVE_NOT
comma
multiline_comment|/* this device must not have an interrupt in endpoint */
id|needs_bulk_in
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have a bulk in endpoint */
id|needs_bulk_out
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have a bulk out endpoint */
id|num_interrupt_in
suffix:colon
l_int|0
comma
id|num_bulk_in
suffix:colon
l_int|1
comma
id|num_bulk_out
suffix:colon
l_int|1
comma
id|num_ports
suffix:colon
l_int|1
comma
id|open
suffix:colon
id|ftdi_sio_open
comma
id|close
suffix:colon
id|ftdi_sio_close
comma
id|write
suffix:colon
id|ftdi_sio_write
comma
id|ioctl
suffix:colon
id|ftdi_sio_ioctl
comma
id|read_bulk_callback
suffix:colon
id|ftdi_sio_read_bulk_callback
comma
id|set_termios
suffix:colon
id|ftdi_sio_set_termios
)brace
suffix:semicolon
multiline_comment|/******************************************************************************&n; * FTDI SIO Serial Converter specific driver functions&n; ******************************************************************************/
DECL|function|ftdi_sio_open
r_static
r_int
id|ftdi_sio_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Needed for the usb_control_msg I think */
id|dbg
c_func
(paren
l_string|&quot;ftdi_sio_open port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;active
)paren
(brace
id|dbg
(paren
l_string|&quot;port already open&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|port-&gt;active
op_assign
l_int|1
suffix:semicolon
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_RESET_REQUEST
comma
id|FTDI_SIO_RESET_REQUEST_TYPE
comma
id|FTDI_SIO_RESET_SIO
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
multiline_comment|/* FIXME - Should I really purge the buffers? */
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_RESET_REQUEST
comma
id|FTDI_SIO_RESET_REQUEST_TYPE
comma
id|FTDI_SIO_RESET_PURGE_RX
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_RESET_REQUEST
comma
id|FTDI_SIO_RESET_REQUEST_TYPE
comma
id|FTDI_SIO_RESET_PURGE_TX
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
multiline_comment|/* As per usb_serial_init s/be CS8, B9600, 1 STOP BIT */
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_BAUDRATE_REQUEST
comma
id|FTDI_SIO_SET_BAUDRATE_REQUEST_TYPE
comma
id|ftdi_sio_b9600
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Error from baudrate urb&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_DATA_REQUEST
comma
id|FTDI_SIO_SET_DATA_REQUEST_TYPE
comma
l_int|8
op_or
id|FTDI_SIO_SET_DATA_PARITY_NONE
op_or
id|FTDI_SIO_SET_DATA_STOP_BITS_1
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Error from cs8/noparity/1 stopbit urb&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Disable flow control */
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST_TYPE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;error from flowcontrol urb&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Turn on RTS and DTR since we are not flow controlling*/
multiline_comment|/* FIXME - check for correct behaviour clocal vs non clocal */
multiline_comment|/* FIXME - might be able to do both simultaneously */
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST_TYPE
comma
(paren
r_int
)paren
id|FTDI_SIO_SET_DTR_HIGH
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Error from DTR HIGH urb&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST_TYPE
comma
(paren
r_int
)paren
id|FTDI_SIO_SET_RTS_HIGH
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Error from RTS HIGH urb&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*Start reading from the device*/
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
id|port-&gt;read_urb
)paren
)paren
id|dbg
c_func
(paren
l_string|&quot;usb_submit_urb(read bulk) failed&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|ftdi_sio_close
r_static
r_void
id|ftdi_sio_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;ftdi_sio_close port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* FIXME - might be able to do both simultaneously */
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST_TYPE
comma
(paren
r_int
)paren
id|FTDI_SIO_SET_DTR_LOW
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Error from DTR LOW urb&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST_TYPE
comma
(paren
r_int
)paren
id|FTDI_SIO_SET_RTS_LOW
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Error from RTS LOW urb&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME Should I flush the device here? - not doing it for now */
multiline_comment|/* shutdown our bulk reads and writes */
id|usb_unlink_urb
(paren
id|port-&gt;write_urb
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|port-&gt;read_urb
)paren
suffix:semicolon
id|port-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The ftdi_sio requires the first byte to have:&n;   B0 1&n;   B1 0&n;   B2..7 length of message excluding byte 0&n;*/
DECL|function|ftdi_sio_write
r_static
r_int
id|ftdi_sio_write
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_const
r_int
id|data_offset
op_assign
l_int|1
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;ftdi_sio_serial_write port %d, %d bytes&quot;
comma
id|port-&gt;number
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;write request of 0 bytes&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* only do something if we have a bulk out endpoint */
r_if
c_cond
(paren
id|serial-&gt;num_bulk_out
)paren
(brace
r_int
r_char
op_star
id|first_byte
op_assign
id|port-&gt;write_urb-&gt;transfer_buffer
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|dbg
(paren
l_string|&quot;already writing&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|count
op_add_assign
id|data_offset
suffix:semicolon
id|count
op_assign
(paren
id|count
OG
id|port-&gt;bulk_out_size
)paren
ques
c_cond
id|port-&gt;bulk_out_size
suffix:colon
id|count
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Copy in the data to send */
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|copy_from_user
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
op_plus
id|data_offset
comma
id|buf
comma
id|count
op_minus
id|data_offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
op_plus
id|data_offset
comma
id|buf
comma
id|count
op_minus
id|data_offset
)paren
suffix:semicolon
)brace
multiline_comment|/* Write the control byte at the front of the packet*/
id|first_byte
op_assign
id|port-&gt;write_urb-&gt;transfer_buffer
suffix:semicolon
op_star
id|first_byte
op_assign
l_int|1
op_or
(paren
(paren
id|count
op_minus
id|data_offset
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|dbg
c_func
(paren
l_string|&quot;Bytes: %d, Control Byte: 0o%03o&quot;
comma
id|count
comma
id|first_byte
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: data written - length = %d, data = &quot;
comma
id|count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
op_increment
id|i
)paren
(brace
id|printk
(paren
l_string|&quot;0x%02x &quot;
comma
id|first_byte
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_byte
(braket
id|i
)braket
OG
l_char|&squot; &squot;
op_logical_and
id|first_byte
(braket
id|i
)braket
OL
l_char|&squot;~&squot;
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%c &quot;
comma
id|first_byte
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;  &quot;
)paren
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* send the data out the bulk port */
id|port-&gt;write_urb-&gt;transfer_buffer_length
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
id|port-&gt;write_urb
)paren
)paren
id|dbg
c_func
(paren
l_string|&quot;usb_submit_urb(write bulk) failed&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;write returning: %d&quot;
comma
id|count
op_minus
id|data_offset
)paren
suffix:semicolon
r_return
(paren
id|count
op_minus
id|data_offset
)paren
suffix:semicolon
)brace
multiline_comment|/* no bulk out, so return 0 bytes written */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ftdi_sio_read_bulk_callback
r_static
r_void
id|ftdi_sio_read_bulk_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
multiline_comment|/* ftdi_sio_serial_buld_callback */
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_const
r_int
id|data_offset
op_assign
l_int|2
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;ftdi_sio_read_bulk_callback&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
l_string|&quot;ftdi_sio_read_bulk_callback&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
(paren
id|serial
comma
l_string|&quot;ftdi_sio_read_bulk_callback&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;nonzero read bulk status received: %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|urb-&gt;actual_length
OG
l_int|2
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
id|__FILE__
l_string|&quot;: data read - length = %d, data = &quot;
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|i
)paren
(brace
id|printk
(paren
l_string|&quot;0x%.2x &quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
(braket
id|i
)braket
OG
l_char|&squot; &squot;
op_logical_and
id|data
(braket
id|i
)braket
OL
l_char|&squot;~&squot;
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%c &quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;  &quot;
)paren
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|urb-&gt;actual_length
OG
id|data_offset
)paren
(brace
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|data_offset
suffix:semicolon
id|i
OL
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|i
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* Continue trying to always read  */
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
id|dbg
c_func
(paren
l_string|&quot;failed resubmitting read urb&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* ftdi_sio_serial_read_bulk_callback */
DECL|function|ftdi_sio_set_termios
r_static
r_void
id|ftdi_sio_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_int
r_int
id|cflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|__u16
id|urb_value
suffix:semicolon
multiline_comment|/* Will hold the new flags */
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Perhaps I should dynamically alloc this? */
id|dbg
c_func
(paren
l_string|&quot;ftdi_sio_set_termios port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* FIXME - we should keep the old termios really */
multiline_comment|/* FIXME -For this cut I don&squot;t care if the line is really changing or &n;&t;   not  - so just do the change regardless */
multiline_comment|/* Set number of data bits, parity, stop bits */
id|urb_value
op_assign
l_int|0
suffix:semicolon
id|urb_value
op_or_assign
(paren
id|cflag
op_amp
id|CSTOPB
ques
c_cond
id|FTDI_SIO_SET_DATA_STOP_BITS_2
suffix:colon
id|FTDI_SIO_SET_DATA_STOP_BITS_1
)paren
suffix:semicolon
id|urb_value
op_or_assign
(paren
id|cflag
op_amp
id|PARENB
ques
c_cond
(paren
id|cflag
op_amp
id|PARODD
ques
c_cond
id|FTDI_SIO_SET_DATA_PARITY_ODD
suffix:colon
id|FTDI_SIO_SET_DATA_PARITY_EVEN
)paren
suffix:colon
id|FTDI_SIO_SET_DATA_PARITY_NONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|urb_value
op_or_assign
l_int|5
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Setting CS5&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|urb_value
op_or_assign
l_int|6
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Setting CS6&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|urb_value
op_or_assign
l_int|7
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Setting CS7&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|urb_value
op_or_assign
l_int|8
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Setting CS8&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;CSIZE was set but not CS5-CS8&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_DATA_REQUEST
comma
id|FTDI_SIO_SET_DATA_REQUEST_TYPE
comma
id|urb_value
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
l_int|100
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;FAILED to set databits/stopbits/parity&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Now do the baudrate */
multiline_comment|/* FIXME - should drop lines on B0 */
multiline_comment|/* FIXME Should also handle CLOCAL here  */
r_switch
c_cond
(paren
id|cflag
op_amp
id|CBAUD
)paren
(brace
r_case
id|B300
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b300
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 300&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b1200
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 1200&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b2400
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 2400&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b4800
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 4800&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B9600
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b9600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 9600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b19200
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 19200&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b38400
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 38400&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b57600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 57600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b115200
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 115200&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;FTDI_SIO does not support the baudrate requested&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME - how to return an error for this? */
r_break
suffix:semicolon
)brace
multiline_comment|/* Send the URB */
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_BAUDRATE_REQUEST
comma
id|FTDI_SIO_SET_BAUDRATE_REQUEST_TYPE
comma
id|urb_value
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
l_int|100
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;urb failed to set baurdrate&quot;
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*FIXME - the beginnings of this implementation - not even hooked into the driver yet */
DECL|function|ftdi_sio_ioctl
r_static
r_int
id|ftdi_sio_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
id|__u16
id|urb_value
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Will hold the new flags */
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|ret
comma
id|mask
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;ftdi_sio_ioctl port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/* Based on code from acm.c */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMGET
suffix:colon
multiline_comment|/* Request the status from the device */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_GET_MODEM_STATUS_REQUEST
comma
id|FTDI_SIO_GET_MODEM_STATUS_REQUEST_TYPE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|1
comma
id|HZ
op_star
l_int|5
)paren
)paren
OL
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Get not get modem status of device&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
(paren
id|buf
(braket
l_int|0
)braket
op_amp
id|FTDI_SIO_DSR_MASK
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
id|buf
(braket
l_int|0
)braket
op_amp
id|FTDI_SIO_CTS_MASK
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
op_or
(paren
id|buf
(braket
l_int|0
)braket
op_amp
id|FTDI_SIO_RI_MASK
ques
c_cond
id|TIOCM_RI
suffix:colon
l_int|0
)paren
op_or
(paren
id|buf
(braket
l_int|0
)braket
op_amp
id|FTDI_SIO_RLSD_MASK
ques
c_cond
id|TIOCM_CD
suffix:colon
l_int|0
)paren
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
r_case
id|TIOCMBIS
suffix:colon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|get_user
c_func
(paren
id|mask
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* FIXME Need to remember if we have set DTR or RTS since we&n;&t;&t;&t;   can&squot;t ask the device  */
multiline_comment|/* FIXME - also need to find the meaning of TIOCMBIS/BIC/SET */
r_if
c_cond
(paren
id|mask
op_amp
id|TIOCM_DTR
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMSET
suffix:colon
id|urb_value
op_assign
id|FTDI_SIO_SET_DTR_HIGH
op_or
id|FTDI_SIO_SET_RTS_LOW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
multiline_comment|/* Will leave RTS alone and set DTR */
id|urb_value
op_assign
id|FTDI_SIO_SET_DTR_HIGH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
id|urb_value
op_assign
id|FTDI_SIO_SET_DTR_LOW
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mask
op_amp
id|TIOCM_RTS
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMSET
suffix:colon
id|urb_value
op_assign
id|FTDI_SIO_SET_DTR_LOW
op_or
id|FTDI_SIO_SET_RTS_HIGH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
multiline_comment|/* Will leave DTR and set RTS */
id|urb_value
op_assign
id|FTDI_SIO_SET_RTS_HIGH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
multiline_comment|/* Will unset RTS */
id|urb_value
op_assign
id|FTDI_SIO_SET_RTS_LOW
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST_TYPE
comma
id|urb_value
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_USB_SERIAL_FTDI_SIO */
eof
