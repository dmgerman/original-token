multiline_comment|/*&n; * USB FTDI SIO driver&n; *&n; * &t;Copyright (C) 1999, 2000&n; * &t;    Greg Kroah-Hartman (greg@kroah.com)&n; *          Bill Ryder (bryder@sgi.com)&n; *&n; * &t;This program is free software; you can redistribute it and/or modify&n; * &t;it under the terms of the GNU General Public License as published by&n; * &t;the Free Software Foundation; either version 2 of the License, or&n; * &t;(at your option) any later version.&n; *&n; * See Documentation/usb/usb-serial.txt for more information on using this driver&n; *&n; * See http://reality.sgi.com/bryder_wellington/ftdi_sio for upto date testing info&n; *     and extra documentation&n; *       &n; * (12/3/2000) Bill Ryder&n; *     Added support for 8U232AM device.&n; *     Moved PID and VIDs into header file only.&n; *     Turned on low-latency for the tty (device will do high baudrates)&n; *     Added shutdown routine to close files when device removed.&n; *     More debug and error message cleanups.&n; *     &n; *&n; * (11/13/2000) Bill Ryder&n; *     Added spinlock protected open code and close code.&n; *     Multiple opens work (sort of - see webpage mentioned above).&n; *     Cleaned up comments. Removed multiple PID/VID definitions.&n; *     Factorised cts/dtr code&n; *     Made use of __FUNCTION__ in dbg&squot;s&n; *      &n; * (11/01/2000) Adam J. Richter&n; *&t;usb_device_id table support&n; * &n; * (10/05/2000) gkh&n; *&t;Fixed bug with urb-&gt;dev not being set properly, now that the usb&n; *&t;core needs it.&n; * &n; * (09/11/2000) gkh&n; *&t;Removed DEBUG #ifdefs with call to usb_serial_debug_data&n; *&n; * (07/19/2000) gkh&n; *&t;Added module_init and module_exit functions to handle the fact that this&n; *&t;driver is a loadable module now.&n; *&n; * (04/04/2000) Bill Ryder &n; *      Fixed bugs in TCGET/TCSET ioctls (by removing them - they are &n; *        handled elsewhere in the tty io driver chain).&n; *&n; * (03/30/2000) Bill Ryder &n; *      Implemented lots of ioctls&n; * &t;Fixed a race condition in write&n; * &t;Changed some dbg&squot;s to errs&n; *&n; * (03/26/2000) gkh&n; * &t;Split driver up into device specific pieces.&n; *&n; */
multiline_comment|/* Bill Ryder - bryder@sgi.com - wrote the FTDI_SIO implementation */
multiline_comment|/* Thanx to FTDI for so kindly providing details of the protocol required */
multiline_comment|/*   to talk to the device */
multiline_comment|/* Thanx to gkh and the rest of the usb dev group for all code I have assimilated :-) */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#else
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#endif
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;usb-serial.h&quot;
macro_line|#include &quot;ftdi_sio.h&quot;
DECL|variable|id_table_sio
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|id_table_sio
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|FTDI_VID
comma
id|FTDI_SIO_PID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
multiline_comment|/* THe 8U232AM has the same API as the sio - but it can support MUCH &n;   higher baudrates (921600 at 48MHz/230400 at 12MHz &n;   so .. it&squot;s baudrate setting codes are different */
DECL|variable|id_table_8U232AM
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|id_table_8U232AM
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|FTDI_VID
comma
id|FTDI_8U232AM_PID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
DECL|variable|id_table_combined
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|id_table_combined
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|FTDI_VID
comma
id|FTDI_SIO_PID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|FTDI_VID
comma
id|FTDI_8U232AM_PID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|id_table_combined
)paren
suffix:semicolon
DECL|struct|ftdi_private
r_struct
id|ftdi_private
(brace
DECL|member|ftdi_type
id|ftdi_type_t
id|ftdi_type
suffix:semicolon
DECL|member|last_status_byte
r_char
id|last_status_byte
suffix:semicolon
multiline_comment|/* device sends this every 40ms when open */
)brace
suffix:semicolon
multiline_comment|/* function prototypes for a FTDI serial converter */
r_static
r_int
id|ftdi_sio_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_int
id|ftdi_8U232AM_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|ftdi_sio_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_int
id|ftdi_sio_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|ftdi_sio_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|ftdi_sio_write
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|ftdi_sio_write_bulk_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|ftdi_sio_read_bulk_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|ftdi_sio_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old
)paren
suffix:semicolon
r_static
r_int
id|ftdi_sio_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
multiline_comment|/* Should rename most ftdi_sio&squot;s to ftdi_ now since there are two devices &n;   which share common code */
DECL|variable|ftdi_sio_device
r_struct
id|usb_serial_device_type
id|ftdi_sio_device
op_assign
(brace
id|name
suffix:colon
l_string|&quot;FTDI SIO&quot;
comma
id|id_table
suffix:colon
id|id_table_sio
comma
id|needs_interrupt_in
suffix:colon
id|MUST_HAVE_NOT
comma
id|needs_bulk_in
suffix:colon
id|MUST_HAVE
comma
id|needs_bulk_out
suffix:colon
id|MUST_HAVE
comma
id|num_interrupt_in
suffix:colon
l_int|0
comma
id|num_bulk_in
suffix:colon
l_int|1
comma
id|num_bulk_out
suffix:colon
l_int|1
comma
id|num_ports
suffix:colon
l_int|1
comma
id|open
suffix:colon
id|ftdi_sio_open
comma
id|close
suffix:colon
id|ftdi_sio_close
comma
id|write
suffix:colon
id|ftdi_sio_write
comma
id|read_bulk_callback
suffix:colon
id|ftdi_sio_read_bulk_callback
comma
id|write_bulk_callback
suffix:colon
id|ftdi_sio_write_bulk_callback
comma
id|ioctl
suffix:colon
id|ftdi_sio_ioctl
comma
id|set_termios
suffix:colon
id|ftdi_sio_set_termios
comma
id|startup
suffix:colon
id|ftdi_sio_startup
comma
id|shutdown
suffix:colon
id|ftdi_sio_shutdown
comma
)brace
suffix:semicolon
DECL|variable|ftdi_8U232AM_device
r_struct
id|usb_serial_device_type
id|ftdi_8U232AM_device
op_assign
(brace
id|name
suffix:colon
l_string|&quot;FTDI 8U232AM&quot;
comma
id|id_table
suffix:colon
id|id_table_8U232AM
comma
id|needs_interrupt_in
suffix:colon
id|DONT_CARE
comma
id|needs_bulk_in
suffix:colon
id|MUST_HAVE
comma
id|needs_bulk_out
suffix:colon
id|MUST_HAVE
comma
id|num_interrupt_in
suffix:colon
l_int|0
comma
id|num_bulk_in
suffix:colon
l_int|1
comma
id|num_bulk_out
suffix:colon
l_int|1
comma
id|num_ports
suffix:colon
l_int|1
comma
id|open
suffix:colon
id|ftdi_sio_open
comma
id|close
suffix:colon
id|ftdi_sio_close
comma
id|write
suffix:colon
id|ftdi_sio_write
comma
id|read_bulk_callback
suffix:colon
id|ftdi_sio_read_bulk_callback
comma
id|write_bulk_callback
suffix:colon
id|ftdi_sio_write_bulk_callback
comma
id|ioctl
suffix:colon
id|ftdi_sio_ioctl
comma
id|set_termios
suffix:colon
id|ftdi_sio_set_termios
comma
id|startup
suffix:colon
id|ftdi_8U232AM_startup
comma
id|shutdown
suffix:colon
id|ftdi_sio_shutdown
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * ***************************************************************************&n; * FTDI SIO Serial Converter specific driver functions&n; * ***************************************************************************&n; */
DECL|macro|WDR_TIMEOUT
mdefine_line|#define WDR_TIMEOUT (HZ * 5 ) /* default urb timeout */
multiline_comment|/* utility functions to set and unset dtr and rts */
DECL|macro|HIGH
mdefine_line|#define HIGH 1
DECL|macro|LOW
mdefine_line|#define LOW 0
DECL|function|set_rts
r_static
r_int
id|set_rts
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|pipe
comma
r_int
id|high_or_low
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|ftdi_high_or_low
op_assign
(paren
id|high_or_low
ques
c_cond
id|FTDI_SIO_SET_RTS_HIGH
suffix:colon
id|FTDI_SIO_SET_RTS_LOW
)paren
suffix:semicolon
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|pipe
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST_TYPE
comma
id|ftdi_high_or_low
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|WDR_TIMEOUT
)paren
suffix:semicolon
)brace
DECL|function|set_dtr
r_static
r_int
id|set_dtr
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|pipe
comma
r_int
id|high_or_low
)paren
(brace
r_static
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|ftdi_high_or_low
op_assign
(paren
id|high_or_low
ques
c_cond
id|FTDI_SIO_SET_DTR_HIGH
suffix:colon
id|FTDI_SIO_SET_DTR_LOW
)paren
suffix:semicolon
r_return
id|usb_control_msg
c_func
(paren
id|dev
comma
id|pipe
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST
comma
id|FTDI_SIO_SET_MODEM_CTRL_REQUEST_TYPE
comma
id|ftdi_high_or_low
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|WDR_TIMEOUT
)paren
suffix:semicolon
)brace
DECL|function|ftdi_sio_startup
r_static
r_int
id|ftdi_sio_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|ftdi_private
op_star
id|priv
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|serial-&gt;port
(braket
l_int|0
)braket
dot
id|write_wait
)paren
suffix:semicolon
id|priv
op_assign
id|serial-&gt;port
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ftdi_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot;- kmalloc(%d) failed.&quot;
comma
r_sizeof
(paren
r_struct
id|ftdi_private
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|priv-&gt;ftdi_type
op_assign
id|sio
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|ftdi_8U232AM_startup
r_static
r_int
id|ftdi_8U232AM_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|ftdi_private
op_star
id|priv
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|serial-&gt;port
(braket
l_int|0
)braket
dot
id|write_wait
)paren
suffix:semicolon
id|priv
op_assign
id|serial-&gt;port
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ftdi_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot;- kmalloc(%d) failed.&quot;
comma
r_sizeof
(paren
r_struct
id|ftdi_private
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|priv-&gt;ftdi_type
op_assign
id|F8U232AM
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|ftdi_sio_shutdown
r_static
r_void
id|ftdi_sio_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
id|dbg
(paren
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Close ports if they are open */
r_while
c_loop
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
dot
id|open_count
OG
l_int|0
)paren
(brace
id|ftdi_sio_close
(paren
op_amp
id|serial-&gt;port
(braket
l_int|0
)braket
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|serial-&gt;port
op_member_access_from_pointer
r_private
)paren
(brace
id|kfree
c_func
(paren
id|serial-&gt;port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|serial-&gt;port
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|ftdi_sio_open
r_static
r_int
id|ftdi_sio_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
multiline_comment|/* ftdi_sio_open */
r_struct
id|termios
id|tmp_termios
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Used for spinlock */
r_int
id|result
suffix:semicolon
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Needed for the usb_control_msg I think */
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
op_increment
id|port-&gt;open_count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;active
)paren
(brace
id|port-&gt;active
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* do not allow a task to be queued to deliver received data */
id|port-&gt;tty-&gt;low_latency
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* No error checking for this (will get errors later anyway) */
multiline_comment|/* See ftdi_sio.h for description of what is reset */
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_RESET_REQUEST
comma
id|FTDI_SIO_RESET_REQUEST_TYPE
comma
id|FTDI_SIO_RESET_SIO
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|WDR_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* Setup termios defaults. According to tty_io.c the &n;&t;&t;   settings are driver specific */
id|port-&gt;tty-&gt;termios-&gt;c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
multiline_comment|/* ftdi_sio_set_termios  will send usb control messages */
id|ftdi_sio_set_termios
c_func
(paren
id|port
comma
op_amp
id|tmp_termios
)paren
suffix:semicolon
multiline_comment|/* Turn on RTS and DTR since we are not flow controlling by default */
r_if
c_cond
(paren
id|set_dtr
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|HIGH
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; Error from DTR HIGH urb&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_rts
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|HIGH
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; Error from RTS HIGH urb&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Start reading from the device */
id|FILL_BULK_URB
c_func
(paren
id|port-&gt;read_urb
comma
id|serial-&gt;dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|serial-&gt;dev
comma
id|port-&gt;bulk_in_endpointAddress
)paren
comma
id|port-&gt;read_urb-&gt;transfer_buffer
comma
id|port-&gt;read_urb-&gt;transfer_buffer_length
comma
id|ftdi_sio_read_bulk_callback
comma
id|port
)paren
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;read_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - failed submitting read urb, error %d&quot;
comma
id|result
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* the port was already active - so no initialisation is done */
id|spin_unlock_irqrestore
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* ftdi_sio_open */
DECL|function|ftdi_sio_close
r_static
r_void
id|ftdi_sio_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
multiline_comment|/* ftdi_sio_close */
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_int
r_int
id|c_cflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
op_decrement
id|port-&gt;open_count
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;open_count
op_le
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c_cflag
op_amp
id|HUPCL
)paren
(brace
multiline_comment|/* Disable flow control */
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST_TYPE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|WDR_TIMEOUT
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;error from flowcontrol urb&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* drop DTR */
r_if
c_cond
(paren
id|set_dtr
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|LOW
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error from DTR LOW urb&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* drop RTS */
r_if
c_cond
(paren
id|set_rts
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|LOW
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error from RTS LOW urb&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Note change no line is hupcl is off */
multiline_comment|/* shutdown our bulk reads and writes */
id|usb_unlink_urb
(paren
id|port-&gt;write_urb
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|port-&gt;read_urb
)paren
suffix:semicolon
id|port-&gt;active
op_assign
l_int|0
suffix:semicolon
id|port-&gt;open_count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Send a HUP if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
)paren
(brace
id|tty_hangup
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
)brace
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/* ftdi_sio_close */
multiline_comment|/* The ftdi_sio requires the first byte to have:&n; *  B0 1&n; *  B1 0&n; *  B2..7 length of message excluding byte 0&n; */
DECL|function|ftdi_sio_write
r_static
r_int
id|ftdi_sio_write
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
multiline_comment|/* ftdi_sio_write */
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_struct
id|ftdi_private
op_star
id|priv
op_assign
(paren
r_struct
id|ftdi_private
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|data_offset
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|result
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; port %d, %d bytes&quot;
comma
id|port-&gt;number
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;write request of 0 bytes&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;ftdi_type
op_eq
id|sio
)paren
(brace
id|data_offset
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|data_offset
op_assign
l_int|0
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;data_offset set to %d&quot;
comma
id|data_offset
)paren
suffix:semicolon
multiline_comment|/* only do something if we have a bulk out endpoint */
r_if
c_cond
(paren
id|serial-&gt;num_bulk_out
)paren
(brace
r_int
r_char
op_star
id|first_byte
op_assign
id|port-&gt;write_urb-&gt;transfer_buffer
suffix:semicolon
multiline_comment|/* Was seeing a race here, got a read callback, then write callback before&n;&t;&t;   hitting interuptible_sleep_on  - so wrapping in a wait_queue */
id|add_wait_queue
c_func
(paren
op_amp
id|port-&gt;write_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; write in progress - retrying&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|port-&gt;write_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|port-&gt;write_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|count
op_add_assign
id|data_offset
suffix:semicolon
id|count
op_assign
(paren
id|count
OG
id|port-&gt;bulk_out_size
)paren
ques
c_cond
id|port-&gt;bulk_out_size
suffix:colon
id|count
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Copy in the data to send */
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|copy_from_user
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
op_plus
id|data_offset
comma
id|buf
comma
id|count
op_minus
id|data_offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
op_plus
id|data_offset
comma
id|buf
comma
id|count
op_minus
id|data_offset
)paren
suffix:semicolon
)brace
id|first_byte
op_assign
id|port-&gt;write_urb-&gt;transfer_buffer
suffix:semicolon
r_if
c_cond
(paren
id|data_offset
OG
l_int|0
)paren
(brace
multiline_comment|/* Write the control byte at the front of the packet*/
op_star
id|first_byte
op_assign
l_int|1
op_or
(paren
(paren
id|count
op_minus
id|data_offset
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; Bytes: %d, First Byte: 0o%03o&quot;
comma
id|count
comma
id|first_byte
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|count
comma
id|first_byte
)paren
suffix:semicolon
multiline_comment|/* send the data out the bulk port */
id|FILL_BULK_URB
c_func
(paren
id|port-&gt;write_urb
comma
id|serial-&gt;dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|serial-&gt;dev
comma
id|port-&gt;bulk_out_endpointAddress
)paren
comma
id|port-&gt;write_urb-&gt;transfer_buffer
comma
id|count
comma
id|ftdi_sio_write_bulk_callback
comma
id|port
)paren
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;write_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - failed submitting write urb, error %d&quot;
comma
id|result
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; write returning: %d&quot;
comma
id|count
op_minus
id|data_offset
)paren
suffix:semicolon
r_return
(paren
id|count
op_minus
id|data_offset
)paren
suffix:semicolon
)brace
multiline_comment|/* no bulk out, so return 0 bytes written */
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
multiline_comment|/* error exit */
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* ftdi_sio_write */
DECL|function|ftdi_sio_write_bulk_callback
r_static
r_void
id|ftdi_sio_write_bulk_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;ftdi_sio_write_bulk_callback&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
l_string|&quot;ftdi_sio_write_bulk_callback&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
(paren
id|serial
comma
l_string|&quot;ftdi_sio_write_bulk_callback&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;nonzero write bulk status received: %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* ftdi_sio_write_bulk_callback */
DECL|function|ftdi_sio_read_bulk_callback
r_static
r_void
id|ftdi_sio_read_bulk_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
multiline_comment|/* ftdi_sio_serial_buld_callback */
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|ftdi_private
op_star
id|priv
op_assign
(paren
r_struct
id|ftdi_private
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_const
r_int
id|data_offset
op_assign
l_int|2
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
l_string|&quot;ftdi_sio_read_bulk_callback&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
(paren
id|serial
comma
l_string|&quot;ftdi_sio_read_bulk_callback&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
multiline_comment|/* This will happen at close every time so it is a dbg not an err */
id|dbg
c_func
(paren
l_string|&quot;nonzero read bulk status received: %d&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;actual_length
OG
l_int|2
)paren
(brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
comma
id|data
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;Just status&quot;
)paren
suffix:semicolon
)brace
id|priv-&gt;last_status_byte
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* this has modem control lines */
multiline_comment|/* TO DO -- check for hung up line and handle appropriately: */
multiline_comment|/*   send hangup  */
multiline_comment|/* See acm.c - you do a tty_hangup  - eg tty_hangup(tty) */
multiline_comment|/* if CD is dropped and the line is not CLOCAL then we should hangup */
r_if
c_cond
(paren
id|urb-&gt;actual_length
OG
id|data_offset
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
id|data_offset
suffix:semicolon
id|i
OL
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|i
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* Continue trying to always read  */
id|FILL_BULK_URB
c_func
(paren
id|urb
comma
id|serial-&gt;dev
comma
id|usb_rcvbulkpipe
c_func
(paren
id|serial-&gt;dev
comma
id|port-&gt;bulk_in_endpointAddress
)paren
comma
id|urb-&gt;transfer_buffer
comma
id|urb-&gt;transfer_buffer_length
comma
id|ftdi_sio_read_bulk_callback
comma
id|port
)paren
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; - failed resubmitting read urb, error %d&quot;
comma
id|result
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* ftdi_sio_serial_read_bulk_callback */
DECL|function|translate_baudrate_to_ftdi
id|__u16
id|translate_baudrate_to_ftdi
c_func
(paren
r_int
r_int
id|cflag
comma
id|ftdi_type_t
id|ftdi_type
)paren
(brace
multiline_comment|/* translate_baudrate_to_ftdi */
id|__u16
id|urb_value
op_assign
id|ftdi_sio_b9600
suffix:semicolon
r_if
c_cond
(paren
id|ftdi_type
op_eq
id|sio
)paren
(brace
r_switch
c_cond
(paren
id|cflag
op_amp
id|CBAUD
)paren
(brace
r_case
id|B0
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* ignored by this */
r_case
id|B300
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b300
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 300&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b1200
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 1200&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b2400
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 2400&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b4800
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 4800&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B9600
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b9600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 9600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b19200
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 19200&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b38400
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 38400&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b57600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 57600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|urb_value
op_assign
id|ftdi_sio_b115200
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 115200&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; FTDI_SIO does not support the baudrate (%d) requested&quot;
comma
(paren
id|cflag
op_amp
id|CBAUD
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* it is 8U232AM */
r_switch
c_cond
(paren
id|cflag
op_amp
id|CBAUD
)paren
(brace
r_case
id|B0
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* ignored by this */
r_case
id|B300
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b300
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 300&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b1200
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 1200&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b2400
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 2400&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b4800
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 4800&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B9600
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b9600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 9600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b19200
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 19200&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b38400
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 38400&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b57600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 57600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b115200
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 115200&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B230400
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b230400
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 230400&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B460800
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b460800
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 460800&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B921600
suffix:colon
id|urb_value
op_assign
id|ftdi_8U232AM_48MHz_b921600
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Set to 921600&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; The baudrate (%d) requested is not implemented&quot;
comma
(paren
id|cflag
op_amp
id|CBAUD
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|urb_value
suffix:semicolon
)brace
multiline_comment|/* As I understand this - old_termios contains the original termios settings */
multiline_comment|/*  and tty-&gt;termios contains the new setting to be used */
multiline_comment|/* */
multiline_comment|/*   WARNING: set_termios calls this with old_termios in kernel space */
DECL|function|ftdi_sio_set_termios
r_static
r_void
id|ftdi_sio_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
multiline_comment|/* ftdi_sio_set_termios */
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_int
r_int
id|cflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
r_struct
id|ftdi_private
op_star
id|priv
op_assign
(paren
r_struct
id|ftdi_private
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
id|__u16
id|urb_value
suffix:semicolon
multiline_comment|/* will hold the new flags */
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Perhaps I should dynamically alloc this? */
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* FIXME -For this cut I don&squot;t care if the line is really changing or &n;&t;   not  - so just do the change regardless  - should be able to &n;&t;   compare old_termios and tty-&gt;termios */
multiline_comment|/* NOTE These routines can get interrupted by &n;&t;   ftdi_sio_read_bulk_callback  - need to examine what this &n;           means - don&squot;t see any problems yet */
multiline_comment|/* Set number of data bits, parity, stop bits */
id|urb_value
op_assign
l_int|0
suffix:semicolon
id|urb_value
op_or_assign
(paren
id|cflag
op_amp
id|CSTOPB
ques
c_cond
id|FTDI_SIO_SET_DATA_STOP_BITS_2
suffix:colon
id|FTDI_SIO_SET_DATA_STOP_BITS_1
)paren
suffix:semicolon
id|urb_value
op_or_assign
(paren
id|cflag
op_amp
id|PARENB
ques
c_cond
(paren
id|cflag
op_amp
id|PARODD
ques
c_cond
id|FTDI_SIO_SET_DATA_PARITY_ODD
suffix:colon
id|FTDI_SIO_SET_DATA_PARITY_EVEN
)paren
suffix:colon
id|FTDI_SIO_SET_DATA_PARITY_NONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|urb_value
op_or_assign
l_int|5
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Setting CS5&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|urb_value
op_or_assign
l_int|6
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Setting CS6&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|urb_value
op_or_assign
l_int|7
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Setting CS7&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|urb_value
op_or_assign
l_int|8
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Setting CS8&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;CSIZE was set but not CS5-CS8&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_DATA_REQUEST
comma
id|FTDI_SIO_SET_DATA_REQUEST_TYPE
comma
id|urb_value
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
l_int|100
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; FAILED to set databits/stopbits/parity&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Now do the baudrate */
id|urb_value
op_assign
id|translate_baudrate_to_ftdi
c_func
(paren
(paren
id|cflag
op_amp
id|CBAUD
)paren
comma
id|priv-&gt;ftdi_type
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CBAUD
)paren
op_eq
id|B0
)paren
(brace
multiline_comment|/* Disable flow control */
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST_TYPE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|WDR_TIMEOUT
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; error from disable flowcontrol urb&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Drop RTS and DTR */
r_if
c_cond
(paren
id|set_dtr
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|LOW
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; Error from DTR LOW urb&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_rts
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|LOW
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; Error from RTS LOW urb&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* set the baudrate determined before */
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_BAUDRATE_REQUEST
comma
id|FTDI_SIO_SET_BAUDRATE_REQUEST_TYPE
comma
id|urb_value
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
l_int|100
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; urb failed to set baurdrate&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Set flow control */
multiline_comment|/* Note device also supports DTR/CD (ugh) and Xon/Xoff in hardware */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; Setting to CRTSCTS flow control&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST_TYPE
comma
l_int|0
comma
id|FTDI_SIO_RTS_CTS_HS
comma
id|buf
comma
l_int|0
comma
id|WDR_TIMEOUT
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;urb failed to set to rts/cts flow control&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* CHECKME Assuming XON/XOFF handled by tty stack - not by device */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; Turning off hardware flow control&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST
comma
id|FTDI_SIO_SET_FLOW_CTRL_REQUEST_TYPE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|0
comma
id|WDR_TIMEOUT
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;urb failed to clear flow control&quot;
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* ftdi_sio_set_termios */
DECL|function|ftdi_sio_ioctl
r_static
r_int
id|ftdi_sio_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_struct
id|ftdi_private
op_star
id|priv
op_assign
(paren
r_struct
id|ftdi_private
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
id|__u16
id|urb_value
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Will hold the new flags */
r_char
id|buf
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|ret
comma
id|mask
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; cmd 0x%04x&quot;
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Based on code from acm.c and others */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMGET
suffix:colon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; TIOCMGET&quot;
)paren
suffix:semicolon
multiline_comment|/* The MODEM_STATUS_REQUEST works for the sio but not the 232 */
r_if
c_cond
(paren
id|priv-&gt;ftdi_type
op_eq
id|sio
)paren
(brace
multiline_comment|/* TO DECIDE - use the 40ms status packets or not? */
multiline_comment|/*   PRO: No need to send urb */
multiline_comment|/*   CON: Could be 40ms out of date */
multiline_comment|/* Request the status from the device */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_control_msg
c_func
(paren
id|serial-&gt;dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|FTDI_SIO_GET_MODEM_STATUS_REQUEST
comma
id|FTDI_SIO_GET_MODEM_STATUS_REQUEST_TYPE
comma
l_int|0
comma
l_int|0
comma
id|buf
comma
l_int|1
comma
id|WDR_TIMEOUT
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
id|__FUNCTION__
l_string|&quot; Could not get modem status of device - err: %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* This gets updated every 40ms - so just copy it in */
id|buf
(braket
l_int|0
)braket
op_assign
id|priv-&gt;last_status_byte
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
(paren
id|buf
(braket
l_int|0
)braket
op_amp
id|FTDI_SIO_DSR_MASK
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
id|buf
(braket
l_int|0
)braket
op_amp
id|FTDI_SIO_CTS_MASK
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
op_or
(paren
id|buf
(braket
l_int|0
)braket
op_amp
id|FTDI_SIO_RI_MASK
ques
c_cond
id|TIOCM_RI
suffix:colon
l_int|0
)paren
op_or
(paren
id|buf
(braket
l_int|0
)braket
op_amp
id|FTDI_SIO_RLSD_MASK
ques
c_cond
id|TIOCM_CD
suffix:colon
l_int|0
)paren
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
multiline_comment|/* Turns on and off the lines as specified by the mask */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; TIOCMSET&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|get_user
c_func
(paren
id|mask
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|urb_value
op_assign
(paren
(paren
id|mask
op_amp
id|TIOCM_DTR
)paren
ques
c_cond
id|HIGH
suffix:colon
id|LOW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set_dtr
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|urb_value
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error from DTR set urb (TIOCMSET)&quot;
)paren
suffix:semicolon
)brace
id|urb_value
op_assign
(paren
(paren
id|mask
op_amp
id|TIOCM_RTS
)paren
ques
c_cond
id|HIGH
suffix:colon
id|LOW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set_rts
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|urb_value
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Error from RTS set urb (TIOCMSET)&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
multiline_comment|/* turns on (Sets) the lines as specified by the mask */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; TIOCMBIS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|get_user
c_func
(paren
id|mask
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
id|TIOCM_DTR
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|set_dtr
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|HIGH
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Urb to set DTR failed&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mask
op_amp
id|TIOCM_RTS
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|set_rts
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|HIGH
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Urb to set RTS failed&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
multiline_comment|/* turns off (Clears) the lines as specified by the mask */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; TIOCMBIC&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|get_user
c_func
(paren
id|mask
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
id|TIOCM_DTR
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|set_dtr
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|LOW
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Urb to unset DTR failed&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mask
op_amp
id|TIOCM_RTS
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|set_rts
c_func
(paren
id|serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|serial-&gt;dev
comma
l_int|0
)paren
comma
id|LOW
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Urb to unset RTS failed&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * I had originally implemented TCSET{A,S}{,F,W} and&n;&t;&t; * TCGET{A,S} here separately, however when testing I&n;&t;&t; * found that the higher layers actually do the termios&n;&t;&t; * conversions themselves and pass the call onto&n;&t;&t; * ftdi_sio_set_termios. &n;&t;&t; *&n;&t;&t; */
r_default
suffix:colon
multiline_comment|/* This is not an error - turns out the higher layers will do &n;&t;   *  some ioctls itself (see comment above)&n; &t;   */
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; arg not supported - it was 0x%04x&quot;
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ftdi_sio_ioctl */
DECL|function|ftdi_sio_init
r_static
r_int
id|__init
id|ftdi_sio_init
(paren
r_void
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|ftdi_sio_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|ftdi_8U232AM_device
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ftdi_sio_exit
r_static
r_void
id|__exit
id|ftdi_sio_exit
(paren
r_void
)paren
(brace
id|dbg
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|ftdi_sio_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|ftdi_8U232AM_device
)paren
suffix:semicolon
)brace
DECL|variable|ftdi_sio_init
id|module_init
c_func
(paren
id|ftdi_sio_init
)paren
suffix:semicolon
DECL|variable|ftdi_sio_exit
id|module_exit
c_func
(paren
id|ftdi_sio_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Greg Kroah-Hartman &lt;greg@kroah.com&gt;, Bill Ryder &lt;bryder@sgi.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;USB FTDI RS232 converters driver&quot;
)paren
suffix:semicolon
eof
