multiline_comment|/*&n; * Belkin USB Serial Adapter Driver&n; *&n; *  Copyright (C) 2000&n; *      William Greathouse (wgreathouse@smva.com)&n; *&n; *  This program is largely derived from work by the linux-usb group&n; *  and associated source files.  Please see the usb/serial files for&n; *  individual credits and copyrights.&n; *  &n; * &t;This program is free software; you can redistribute it and/or modify&n; * &t;it under the terms of the GNU General Public License as published by&n; * &t;the Free Software Foundation; either version 2 of the License, or&n; * &t;(at your option) any later version.&n; *&n; * See Documentation/usb/usb-serial.txt for more information on using this driver&n; *&n; * TODO:&n; * -- Add true modem contol line query capability.  Currently we track the&n; *    states reported by the interrupt and the states we request.&n; * -- Add error reporting back to application for UART error conditions.&n; *    Just point me at how to implement this and I&squot;ll do it. I&squot;ve put the&n; *    framework in, but haven&squot;t analyzed the &quot;tty_flip&quot; interface yet.&n; * -- Add support for flush commands&n; * -- Add everything that is missing :)&n; *&n; * (11/06/2000) gkh&n; *&t;- Added support for the old Belkin and Peracom devices.&n; *&t;- Made the port able to be opened multiple times.&n; *&t;- Added some defaults incase the line settings are things these devices&n; *&t;  can&squot;t support. &n; *&n; * 18-Oct-2000 William Greathouse&n; *    Released into the wild (linux-usb-devel)&n; *&n; * 17-Oct-2000 William Greathouse&n; *    Add code to recognize firmware version and set hardware flow control&n; *    appropriately.  Belkin states that firmware prior to 3.05 does not&n; *    operate correctly in hardware handshake mode.  I have verified this&n; *    on firmware 2.05 -- for both RTS and DTR input flow control, the control&n; *    line is not reset.  The test performed by the Belkin Win* driver is&n; *    to enable hardware flow control for firmware 2.06 or greater and&n; *    for 1.00 or prior.  I am only enabling for 2.06 or greater.&n; *&n; * 12-Oct-2000 William Greathouse&n; *    First cut at supporting Belkin USB Serial Adapter F5U103&n; *    I did not have a copy of the original work to support this&n; *    adapter, so pardon any stupid mistakes.  All of the information&n; *    I am using to write this driver was acquired by using a modified&n; *    UsbSnoop on Windows2000 and from examining the other USB drivers.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_DEBUG
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#else
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#endif
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;usb-serial.h&quot;
macro_line|#include &quot;belkin_sa.h&quot;
multiline_comment|/* function prototypes for a Belkin USB Serial Adapter F5U103 */
r_static
r_int
id|belkin_sa_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|belkin_sa_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_int
id|belkin_sa_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|belkin_sa_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|belkin_sa_read_int_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
suffix:semicolon
r_static
r_void
id|belkin_sa_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old
)paren
suffix:semicolon
r_static
r_int
id|belkin_sa_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|belkin_sa_break_ctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
suffix:semicolon
DECL|variable|id_table_combined
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|id_table_combined
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|BELKIN_SA_VID
comma
id|BELKIN_SA_PID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|BELKIN_OLD_VID
comma
id|BELKIN_OLD_PID
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|PERACOM_VID
comma
id|PERACOM_PID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
DECL|variable|belkin_sa_table
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|belkin_sa_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|BELKIN_SA_VID
comma
id|BELKIN_SA_PID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
DECL|variable|belkin_old_table
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|belkin_old_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|BELKIN_OLD_VID
comma
id|BELKIN_OLD_PID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
DECL|variable|peracom_table
r_static
id|__devinitdata
r_struct
id|usb_device_id
id|peracom_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|PERACOM_VID
comma
id|PERACOM_PID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|id_table_combined
)paren
suffix:semicolon
multiline_comment|/* All of the device info needed for the Belkin serial converter */
DECL|variable|belkin_sa_device
r_struct
id|usb_serial_device_type
id|belkin_sa_device
op_assign
(brace
id|name
suffix:colon
l_string|&quot;Belkin F5U103 USB Serial Adapter&quot;
comma
id|id_table
suffix:colon
id|belkin_sa_table
comma
multiline_comment|/* the Belkin F5U103 device */
id|needs_interrupt_in
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have an interrupt in endpoint */
id|needs_bulk_in
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have a bulk in endpoint */
id|needs_bulk_out
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have a bulk out endpoint */
id|num_interrupt_in
suffix:colon
l_int|1
comma
id|num_bulk_in
suffix:colon
l_int|1
comma
id|num_bulk_out
suffix:colon
l_int|1
comma
id|num_ports
suffix:colon
l_int|1
comma
id|open
suffix:colon
id|belkin_sa_open
comma
id|close
suffix:colon
id|belkin_sa_close
comma
id|read_int_callback
suffix:colon
id|belkin_sa_read_int_callback
comma
multiline_comment|/* How we get the status info */
id|ioctl
suffix:colon
id|belkin_sa_ioctl
comma
id|set_termios
suffix:colon
id|belkin_sa_set_termios
comma
id|break_ctl
suffix:colon
id|belkin_sa_break_ctl
comma
id|startup
suffix:colon
id|belkin_sa_startup
comma
id|shutdown
suffix:colon
id|belkin_sa_shutdown
comma
)brace
suffix:semicolon
multiline_comment|/* This driver also supports the &quot;old&quot; school Belkin single port adaptor */
DECL|variable|belkin_old_device
r_struct
id|usb_serial_device_type
id|belkin_old_device
op_assign
(brace
id|name
suffix:colon
l_string|&quot;Belkin USB Serial Adapter&quot;
comma
id|id_table
suffix:colon
id|belkin_old_table
comma
multiline_comment|/* the old Belkin device */
id|needs_interrupt_in
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have an interrupt in endpoint */
id|needs_bulk_in
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have a bulk in endpoint */
id|needs_bulk_out
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have a bulk out endpoint */
id|num_interrupt_in
suffix:colon
l_int|1
comma
id|num_bulk_in
suffix:colon
l_int|1
comma
id|num_bulk_out
suffix:colon
l_int|1
comma
id|num_ports
suffix:colon
l_int|1
comma
id|open
suffix:colon
id|belkin_sa_open
comma
id|close
suffix:colon
id|belkin_sa_close
comma
id|read_int_callback
suffix:colon
id|belkin_sa_read_int_callback
comma
multiline_comment|/* How we get the status info */
id|ioctl
suffix:colon
id|belkin_sa_ioctl
comma
id|set_termios
suffix:colon
id|belkin_sa_set_termios
comma
id|break_ctl
suffix:colon
id|belkin_sa_break_ctl
comma
id|startup
suffix:colon
id|belkin_sa_startup
comma
id|shutdown
suffix:colon
id|belkin_sa_shutdown
comma
)brace
suffix:semicolon
multiline_comment|/* this driver also works for the Peracom single port adapter */
DECL|variable|peracom_device
r_struct
id|usb_serial_device_type
id|peracom_device
op_assign
(brace
id|name
suffix:colon
l_string|&quot;Peracom single port USB Serial Adapter&quot;
comma
id|id_table
suffix:colon
id|peracom_table
comma
multiline_comment|/* the Peracom device */
id|needs_interrupt_in
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have an interrupt in endpoint */
id|needs_bulk_in
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have a bulk in endpoint */
id|needs_bulk_out
suffix:colon
id|MUST_HAVE
comma
multiline_comment|/* this device must have a bulk out endpoint */
id|num_interrupt_in
suffix:colon
l_int|1
comma
id|num_bulk_in
suffix:colon
l_int|1
comma
id|num_bulk_out
suffix:colon
l_int|1
comma
id|num_ports
suffix:colon
l_int|1
comma
id|open
suffix:colon
id|belkin_sa_open
comma
id|close
suffix:colon
id|belkin_sa_close
comma
id|read_int_callback
suffix:colon
id|belkin_sa_read_int_callback
comma
multiline_comment|/* How we get the status info */
id|ioctl
suffix:colon
id|belkin_sa_ioctl
comma
id|set_termios
suffix:colon
id|belkin_sa_set_termios
comma
id|break_ctl
suffix:colon
id|belkin_sa_break_ctl
comma
id|startup
suffix:colon
id|belkin_sa_startup
comma
id|shutdown
suffix:colon
id|belkin_sa_shutdown
comma
)brace
suffix:semicolon
DECL|struct|belkin_sa_private
r_struct
id|belkin_sa_private
(brace
DECL|member|control_state
r_int
r_int
id|control_state
suffix:semicolon
DECL|member|last_lsr
r_int
r_char
id|last_lsr
suffix:semicolon
DECL|member|last_msr
r_int
r_char
id|last_msr
suffix:semicolon
DECL|member|bad_flow_control
r_int
id|bad_flow_control
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * ***************************************************************************&n; * Belkin USB Serial Adapter F5U103 specific driver functions&n; * ***************************************************************************&n; */
DECL|macro|WDR_TIMEOUT
mdefine_line|#define WDR_TIMEOUT (HZ * 5 ) /* default urb timeout */
multiline_comment|/* assumes that struct usb_serial *serial is available */
DECL|macro|BSA_USB_CMD
mdefine_line|#define BSA_USB_CMD(c,v) usb_control_msg(serial-&gt;dev, usb_sndctrlpipe(serial-&gt;dev, 0), &bslash;&n;&t;&t;&t;&t;&t;    (c), BELKIN_SA_SET_REQUEST_TYPE, &bslash;&n;&t;&t;&t;&t;&t;    (v), 0, NULL, 0, WDR_TIMEOUT)
multiline_comment|/* do some startup allocations not currently performed by usb_serial_probe() */
DECL|function|belkin_sa_startup
r_static
r_int
id|belkin_sa_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|usb_device
op_star
id|dev
op_assign
id|serial-&gt;dev
suffix:semicolon
r_struct
id|belkin_sa_private
op_star
id|priv
suffix:semicolon
multiline_comment|/* allocate the private data structure */
id|serial-&gt;port
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|belkin_sa_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial-&gt;port
op_member_access_from_pointer
r_private
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* error */
id|priv
op_assign
(paren
r_struct
id|belkin_sa_private
op_star
)paren
id|serial-&gt;port
op_member_access_from_pointer
r_private
suffix:semicolon
multiline_comment|/* set initial values for control structures */
id|priv-&gt;control_state
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;last_lsr
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;last_msr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* see comments at top of file */
id|priv-&gt;bad_flow_control
op_assign
(paren
id|dev-&gt;descriptor.bcdDevice
op_le
l_int|0x0206
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|info
c_func
(paren
l_string|&quot;bcdDevice: %04x, bfc: %d&quot;
comma
id|dev-&gt;descriptor.bcdDevice
comma
id|priv-&gt;bad_flow_control
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|serial-&gt;port-&gt;write_wait
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|belkin_sa_shutdown
r_static
r_void
id|belkin_sa_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|i
suffix:semicolon
id|dbg
(paren
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* stop reads and writes on all ports */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
r_while
c_loop
(paren
id|serial-&gt;port
(braket
id|i
)braket
dot
id|open_count
OG
l_int|0
)paren
(brace
id|belkin_sa_close
(paren
op_amp
id|serial-&gt;port
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* My special items, the standard routines free my urbs */
r_if
c_cond
(paren
id|serial-&gt;port
op_member_access_from_pointer
r_private
)paren
id|kfree
c_func
(paren
id|serial-&gt;port
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
)brace
)brace
DECL|function|belkin_sa_open
r_static
r_int
id|belkin_sa_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
op_increment
id|port-&gt;open_count
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;active
)paren
(brace
id|port-&gt;active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*Start reading from the device*/
multiline_comment|/* TODO: Look at possibility of submitting mulitple URBs to device to&n;&t;&t; *       enhance buffering.  Win trace shows 16 initial read URBs.&n;&t;&t; */
id|port-&gt;read_urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
id|port-&gt;read_urb
)paren
)paren
id|err
c_func
(paren
l_string|&quot;usb_submit_urb(read bulk) failed&quot;
)paren
suffix:semicolon
id|port-&gt;interrupt_in_urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
id|port-&gt;interrupt_in_urb
)paren
)paren
id|err
c_func
(paren
l_string|&quot; usb_submit_urb(read int) failed&quot;
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* belkin_sa_open */
DECL|function|belkin_sa_close
r_static
r_void
id|belkin_sa_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
id|__FUNCTION__
l_string|&quot; port %d&quot;
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
op_decrement
id|port-&gt;open_count
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;open_count
op_le
l_int|0
)paren
(brace
multiline_comment|/* shutdown our bulk reads and writes */
id|usb_unlink_urb
(paren
id|port-&gt;write_urb
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|port-&gt;read_urb
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|port-&gt;interrupt_in_urb
)paren
suffix:semicolon
multiline_comment|/* wgg - do I need this? I think so. */
id|port-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|port-&gt;port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* belkin_sa_close */
DECL|function|belkin_sa_read_int_callback
r_static
r_void
id|belkin_sa_read_int_callback
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|belkin_sa_private
op_star
id|priv
op_assign
(paren
r_struct
id|belkin_sa_private
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
multiline_comment|/* the urb might have been killed. */
r_if
c_cond
(paren
id|urb-&gt;status
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
l_string|&quot;belkin_sa_read_interrupt&quot;
)paren
)paren
r_return
suffix:semicolon
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
(paren
id|serial
comma
l_string|&quot;belkin_sa_read_interrupt&quot;
)paren
)paren
r_return
suffix:semicolon
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Handle known interrupt data */
multiline_comment|/* ignore data[0] and data[1] */
id|priv-&gt;last_msr
op_assign
id|data
(braket
id|BELKIN_SA_MSR_INDEX
)braket
suffix:semicolon
multiline_comment|/* Record Control Line states */
r_if
c_cond
(paren
id|priv-&gt;last_msr
op_amp
id|BELKIN_SA_MSR_DSR
)paren
id|priv-&gt;control_state
op_or_assign
id|TIOCM_DSR
suffix:semicolon
r_else
id|priv-&gt;control_state
op_and_assign
op_complement
id|TIOCM_DSR
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;last_msr
op_amp
id|BELKIN_SA_MSR_CTS
)paren
id|priv-&gt;control_state
op_or_assign
id|TIOCM_CTS
suffix:semicolon
r_else
id|priv-&gt;control_state
op_and_assign
op_complement
id|TIOCM_CTS
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;last_msr
op_amp
id|BELKIN_SA_MSR_RI
)paren
id|priv-&gt;control_state
op_or_assign
id|TIOCM_RI
suffix:semicolon
r_else
id|priv-&gt;control_state
op_and_assign
op_complement
id|TIOCM_RI
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;last_msr
op_amp
id|BELKIN_SA_MSR_CD
)paren
id|priv-&gt;control_state
op_or_assign
id|TIOCM_CD
suffix:semicolon
r_else
id|priv-&gt;control_state
op_and_assign
op_complement
id|TIOCM_CD
suffix:semicolon
multiline_comment|/* Now to report any errors */
id|priv-&gt;last_lsr
op_assign
id|data
(braket
id|BELKIN_SA_LSR_INDEX
)braket
suffix:semicolon
macro_line|#if 0
multiline_comment|/*&n;&t; * fill in the flip buffer here, but I do not know the relation&n;&t; * to the current/next receive buffer or characters.  I need&n;&t; * to look in to this before committing any code.&n;&t; */
r_if
c_cond
(paren
id|priv-&gt;last_lsr
op_amp
id|BELKIN_SA_LSR_ERR
)paren
(brace
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
multiline_comment|/* Overrun Error */
r_if
c_cond
(paren
id|priv-&gt;last_lsr
op_amp
id|BELKIN_SA_LSR_OE
)paren
(brace
)brace
multiline_comment|/* Parity Error */
r_if
c_cond
(paren
id|priv-&gt;last_lsr
op_amp
id|BELKIN_SA_LSR_PE
)paren
(brace
)brace
multiline_comment|/* Framing Error */
r_if
c_cond
(paren
id|priv-&gt;last_lsr
op_amp
id|BELKIN_SA_LSR_FE
)paren
(brace
)brace
multiline_comment|/* Break Indicator */
r_if
c_cond
(paren
id|priv-&gt;last_lsr
op_amp
id|BELKIN_SA_LSR_BI
)paren
(brace
)brace
)brace
macro_line|#endif
multiline_comment|/* INT urbs are automatically re-submitted */
)brace
DECL|function|belkin_sa_set_termios
r_static
r_void
id|belkin_sa_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_struct
id|belkin_sa_private
op_star
id|priv
op_assign
(paren
r_struct
id|belkin_sa_private
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|iflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_iflag
suffix:semicolon
r_int
r_int
id|cflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
r_int
r_int
id|old_iflag
op_assign
id|old_termios-&gt;c_iflag
suffix:semicolon
r_int
r_int
id|old_cflag
op_assign
id|old_termios-&gt;c_cflag
suffix:semicolon
id|__u16
id|urb_value
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Will hold the new flags */
multiline_comment|/* Set the baud rate */
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CBAUD
)paren
op_ne
(paren
id|old_cflag
op_amp
id|CBAUD
)paren
)paren
(brace
multiline_comment|/* reassert DTR and (maybe) RTS on transition from B0 */
r_if
c_cond
(paren
(paren
id|old_cflag
op_amp
id|CBAUD
)paren
op_eq
id|B0
)paren
(brace
id|priv-&gt;control_state
op_or_assign
(paren
id|TIOCM_DTR
op_or
id|TIOCM_RTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_DTR_REQUEST
comma
l_int|1
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;Set DTR error&quot;
)paren
suffix:semicolon
multiline_comment|/* don&squot;t set RTS if using hardware flow control */
r_if
c_cond
(paren
op_logical_neg
(paren
id|old_cflag
op_amp
id|CRTSCTS
)paren
)paren
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_RTS_REQUEST
comma
l_int|1
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;Set RTS error&quot;
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cflag
op_amp
id|CBAUD
)paren
(brace
r_case
id|B0
suffix:colon
multiline_comment|/* handled below */
r_break
suffix:semicolon
r_case
id|B300
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|300
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|600
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|1200
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|2400
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|4800
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B9600
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|9600
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|19200
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|38400
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|57600
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|115200
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B230400
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|230400
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;BELKIN USB Serial Adapter: unsupported baudrate request, using default of 9600&quot;
)paren
suffix:semicolon
id|urb_value
op_assign
id|BELKIN_SA_BAUD
c_func
(paren
l_int|9600
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CBAUD
)paren
op_ne
id|B0
)paren
(brace
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_BAUDRATE_REQUEST
comma
id|urb_value
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;Set baudrate error&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Disable flow control */
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_FLOW_CTRL_REQUEST
comma
id|BELKIN_SA_FLOW_NONE
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;Disable flowcontrol error&quot;
)paren
suffix:semicolon
multiline_comment|/* Drop RTS and DTR */
id|priv-&gt;control_state
op_and_assign
op_complement
(paren
id|TIOCM_DTR
op_or
id|TIOCM_RTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_DTR_REQUEST
comma
l_int|0
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;DTR LOW error&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_RTS_REQUEST
comma
l_int|0
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;RTS LOW error&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* set the parity */
r_if
c_cond
(paren
(paren
id|cflag
op_amp
(paren
id|PARENB
op_or
id|PARODD
)paren
)paren
op_ne
(paren
id|old_cflag
op_amp
(paren
id|PARENB
op_or
id|PARODD
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
id|urb_value
op_assign
(paren
id|cflag
op_amp
id|PARODD
)paren
ques
c_cond
id|BELKIN_SA_PARITY_ODD
suffix:colon
id|BELKIN_SA_PARITY_EVEN
suffix:semicolon
r_else
id|urb_value
op_assign
id|BELKIN_SA_PARITY_NONE
suffix:semicolon
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_PARITY_REQUEST
comma
id|urb_value
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;Set parity error&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* set the number of data bits */
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CSIZE
)paren
op_ne
(paren
id|old_cflag
op_amp
id|CSIZE
)paren
)paren
(brace
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_DATA_BITS
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_DATA_BITS
c_func
(paren
l_int|6
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_DATA_BITS
c_func
(paren
l_int|7
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|urb_value
op_assign
id|BELKIN_SA_DATA_BITS
c_func
(paren
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;CSIZE was not CS5-CS8, using default of 8&quot;
)paren
suffix:semicolon
id|urb_value
op_assign
id|BELKIN_SA_DATA_BITS
c_func
(paren
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_DATA_BITS_REQUEST
comma
id|urb_value
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;Set data bits error&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* set the number of stop bits */
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CSTOPB
)paren
op_ne
(paren
id|old_cflag
op_amp
id|CSTOPB
)paren
)paren
(brace
id|urb_value
op_assign
(paren
id|cflag
op_amp
id|CSTOPB
)paren
ques
c_cond
id|BELKIN_SA_STOP_BITS
c_func
(paren
l_int|2
)paren
suffix:colon
id|BELKIN_SA_STOP_BITS
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_STOP_BITS_REQUEST
comma
id|urb_value
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;Set stop bits error&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Set flow control */
r_if
c_cond
(paren
(paren
id|iflag
op_amp
id|IXOFF
)paren
op_ne
(paren
id|old_iflag
op_amp
id|IXOFF
)paren
op_logical_or
(paren
id|iflag
op_amp
id|IXON
)paren
op_ne
(paren
id|old_iflag
op_amp
id|IXON
)paren
op_logical_or
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
op_ne
(paren
id|old_cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|urb_value
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iflag
op_amp
id|IXOFF
)paren
op_logical_or
(paren
id|iflag
op_amp
id|IXON
)paren
)paren
id|urb_value
op_or_assign
(paren
id|BELKIN_SA_FLOW_OXON
op_or
id|BELKIN_SA_FLOW_IXON
)paren
suffix:semicolon
r_else
id|urb_value
op_and_assign
op_complement
(paren
id|BELKIN_SA_FLOW_OXON
op_or
id|BELKIN_SA_FLOW_IXON
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|urb_value
op_or_assign
(paren
id|BELKIN_SA_FLOW_OCTS
op_or
id|BELKIN_SA_FLOW_IRTS
)paren
suffix:semicolon
r_else
id|urb_value
op_and_assign
op_complement
(paren
id|BELKIN_SA_FLOW_OCTS
op_or
id|BELKIN_SA_FLOW_IRTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;bad_flow_control
)paren
id|urb_value
op_and_assign
op_complement
(paren
id|BELKIN_SA_FLOW_IRTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_FLOW_CTRL_REQUEST
comma
id|urb_value
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;Set flow control error&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* belkin_sa_set_termios */
DECL|function|belkin_sa_break_ctl
r_static
r_void
id|belkin_sa_break_ctl
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_if
c_cond
(paren
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_BREAK_REQUEST
comma
id|break_state
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
OL
l_int|0
)paren
id|err
c_func
(paren
l_string|&quot;Set break_ctl %d&quot;
comma
id|break_state
)paren
suffix:semicolon
)brace
DECL|function|belkin_sa_ioctl
r_static
r_int
id|belkin_sa_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
id|__u16
id|urb_value
suffix:semicolon
multiline_comment|/* Will hold the new flags */
r_struct
id|belkin_sa_private
op_star
id|priv
op_assign
(paren
r_struct
id|belkin_sa_private
op_star
)paren
id|port
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|ret
comma
id|mask
suffix:semicolon
multiline_comment|/* Based on code from acm.c and others */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMGET
suffix:colon
r_return
id|put_user
c_func
(paren
id|priv-&gt;control_state
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
multiline_comment|/* Turns on and off the lines as specified by the mask */
r_case
id|TIOCMBIS
suffix:colon
multiline_comment|/* turns on (Sets) the lines as specified by the mask */
r_case
id|TIOCMBIC
suffix:colon
multiline_comment|/* turns off (Clears) the lines as specified by the mask */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|get_user
c_func
(paren
id|mask
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|TIOCMSET
)paren
op_logical_or
(paren
id|mask
op_amp
id|TIOCM_RTS
)paren
)paren
(brace
multiline_comment|/* RTS needs set */
id|urb_value
op_assign
(paren
(paren
id|cmd
op_eq
id|TIOCMSET
)paren
op_logical_and
(paren
id|mask
op_amp
id|TIOCM_RTS
)paren
)paren
op_logical_or
(paren
id|cmd
op_eq
id|TIOCMBIS
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|urb_value
)paren
id|priv-&gt;control_state
op_or_assign
id|TIOCM_RTS
suffix:semicolon
r_else
id|priv-&gt;control_state
op_and_assign
op_complement
id|TIOCM_RTS
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_RTS_REQUEST
comma
id|urb_value
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Set RTS error %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|cmd
op_eq
id|TIOCMSET
)paren
op_logical_or
(paren
id|mask
op_amp
id|TIOCM_DTR
)paren
)paren
(brace
multiline_comment|/* DTR needs set */
id|urb_value
op_assign
(paren
(paren
id|cmd
op_eq
id|TIOCMSET
)paren
op_logical_and
(paren
id|mask
op_amp
id|TIOCM_DTR
)paren
)paren
op_logical_or
(paren
id|cmd
op_eq
id|TIOCMBIS
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|urb_value
)paren
id|priv-&gt;control_state
op_or_assign
id|TIOCM_DTR
suffix:semicolon
r_else
id|priv-&gt;control_state
op_and_assign
op_complement
id|TIOCM_DTR
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|BSA_USB_CMD
c_func
(paren
id|BELKIN_SA_SET_DTR_REQUEST
comma
id|urb_value
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Set DTR error %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|TIOCMIWAIT
suffix:colon
multiline_comment|/* wait for any of the 4 modem inputs (DCD,RI,DSR,CTS)*/
multiline_comment|/* TODO */
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCGICOUNT
suffix:colon
multiline_comment|/* return count of modemline transitions */
multiline_comment|/* TODO */
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;belkin_sa_ioctl arg not supported - 0x%04x&quot;
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* belkin_sa_ioctl */
DECL|function|belkin_sa_init
r_static
r_int
id|__init
id|belkin_sa_init
(paren
r_void
)paren
(brace
id|usb_serial_register
(paren
op_amp
id|belkin_sa_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|belkin_old_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|peracom_device
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|belkin_sa_exit
r_static
r_void
id|__exit
id|belkin_sa_exit
(paren
r_void
)paren
(brace
id|usb_serial_deregister
(paren
op_amp
id|belkin_sa_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|belkin_old_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|peracom_device
)paren
suffix:semicolon
)brace
DECL|variable|belkin_sa_init
id|module_init
(paren
id|belkin_sa_init
)paren
suffix:semicolon
DECL|variable|belkin_sa_exit
id|module_exit
(paren
id|belkin_sa_exit
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;USB Belkin Serial converter driver&quot;
)paren
suffix:semicolon
eof
