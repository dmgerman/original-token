multiline_comment|/* &n; * Universal Host Controller Interface driver for USB (take II).&n; *&n; * (c) 1999-2000 Georg Acher, acher@in.tum.de (executive slave) (base guitar)&n; *               Deti Fliegl, deti@fliegl.de (executive slave) (lead voice)&n; *               Thomas Sailer, sailer@ife.ee.ethz.ch (chief consultant) (cheer leader)&n; *               Roman Weissgaerber, weissg@vienna.at (virt root hub) (studio porter)&n; * (c) 2000      Yggdrasil Computing, Inc. (port of new PCI interface support&n; *               from usb-ohci.c by Adam Richter, adam@yggdrasil.com).&n; * (C) 2000      David Brownell, david-b@pacbell.net (usb-ohci.c)&n; *          &n; * HW-initalization based on material of&n; *&n; * (C) Copyright 1999 Linus Torvalds&n; * (C) Copyright 1999 Johannes Erdfelt&n; * (C) Copyright 1999 Randy Dunlap&n; * (C) Copyright 1999 Gregory P. Smith&n; *&n; * $Id: usb-uhci.c,v 1.251 2000/11/30 09:47:54 acher Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;&t;/* for in_interrupt() */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
multiline_comment|/* This enables more detailed sanity checks in submit_iso */
singleline_comment|//#define ISO_SANITY_CHECK
multiline_comment|/* This enables debug printks */
DECL|macro|DEBUG
mdefine_line|#define DEBUG
multiline_comment|/* This enables all symbols to be exported, to ease debugging oopses */
singleline_comment|//#define DEBUG_SYMBOLS
multiline_comment|/* This enables an extra UHCI slab for memory debugging */
DECL|macro|DEBUG_SLAB
mdefine_line|#define DEBUG_SLAB
DECL|macro|VERSTR
mdefine_line|#define VERSTR &quot;$Revision: 1.251 $ time &quot; __TIME__ &quot; &quot; __DATE__
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &quot;usb-uhci.h&quot;
macro_line|#include &quot;usb-uhci-debug.h&quot;
DECL|macro|DEBUG
macro_line|#undef DEBUG
DECL|macro|dbg
macro_line|#undef dbg
DECL|macro|dbg
mdefine_line|#define dbg(format, arg...) do {} while (0)
DECL|macro|DEBUG_SYMBOLS
mdefine_line|#define DEBUG_SYMBOLS
macro_line|#ifdef DEBUG_SYMBOLS
DECL|macro|_static
mdefine_line|#define _static
macro_line|#ifndef EXPORT_SYMTAB
DECL|macro|EXPORT_SYMTAB
mdefine_line|#define EXPORT_SYMTAB
macro_line|#endif
macro_line|#else
DECL|macro|_static
mdefine_line|#define _static static
macro_line|#endif
DECL|macro|queue_dbg
mdefine_line|#define queue_dbg dbg 
singleline_comment|//err
DECL|macro|async_dbg
mdefine_line|#define async_dbg dbg 
singleline_comment|//err
macro_line|#ifdef DEBUG_SLAB
DECL|variable|uhci_desc_kmem
r_static
id|kmem_cache_t
op_star
id|uhci_desc_kmem
suffix:semicolon
DECL|variable|urb_priv_kmem
r_static
id|kmem_cache_t
op_star
id|urb_priv_kmem
suffix:semicolon
macro_line|#endif
DECL|macro|SLAB_FLAG
mdefine_line|#define SLAB_FLAG     (in_interrupt ()? SLAB_ATOMIC : SLAB_KERNEL)
DECL|macro|KMALLOC_FLAG
mdefine_line|#define KMALLOC_FLAG  (in_interrupt ()? GFP_ATOMIC : GFP_KERNEL)
DECL|macro|CONFIG_USB_UHCI_HIGH_BANDWIDTH
mdefine_line|#define CONFIG_USB_UHCI_HIGH_BANDWIDTH 
DECL|macro|USE_CTRL_DEPTH_FIRST
mdefine_line|#define USE_CTRL_DEPTH_FIRST 0  
singleline_comment|// 0: Breadth first, 1: Depth first
DECL|macro|USE_BULK_DEPTH_FIRST
mdefine_line|#define USE_BULK_DEPTH_FIRST 0  
singleline_comment|// 0: Breadth first, 1: Depth first
singleline_comment|// stop bandwidth reclamation after (roughly) 50ms
DECL|macro|IDLE_TIMEOUT
mdefine_line|#define IDLE_TIMEOUT  (HZ/20)
id|_static
r_int
id|rh_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
id|_static
r_int
id|rh_unlink_urb
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
id|_static
r_int
id|delete_qh
(paren
id|uhci_t
op_star
id|s
comma
id|uhci_desc_t
op_star
id|qh
)paren
suffix:semicolon
id|_static
r_int
id|process_transfer
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
comma
r_int
id|mode
)paren
suffix:semicolon
id|_static
r_int
id|process_interrupt
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
id|_static
r_int
id|process_iso
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
comma
r_int
id|force
)paren
suffix:semicolon
singleline_comment|// How much URBs with -&gt;next are walked
DECL|macro|MAX_NEXT_COUNT
mdefine_line|#define MAX_NEXT_COUNT 2048
DECL|variable|devs
r_static
id|uhci_t
op_star
id|devs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* used by userspace UHCI data structure dumper */
DECL|variable|uhci_devices
id|uhci_t
op_star
op_star
id|uhci_devices
op_assign
op_amp
id|devs
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// Cleans up collected QHs, but not more than 100 in one go
DECL|function|clean_descs
r_void
id|clean_descs
c_func
(paren
id|uhci_t
op_star
id|s
comma
r_int
id|force
)paren
(brace
r_struct
id|list_head
op_star
id|q
suffix:semicolon
id|uhci_desc_t
op_star
id|qh
suffix:semicolon
r_int
id|now
op_assign
id|UHCI_GET_CURRENT_FRAME
c_func
(paren
id|s
)paren
comma
id|n
op_assign
l_int|0
suffix:semicolon
id|q
op_assign
id|s-&gt;free_desc.prev
suffix:semicolon
r_while
c_loop
(paren
id|q
op_ne
op_amp
id|s-&gt;free_desc
op_logical_and
(paren
id|force
op_logical_or
id|n
OL
l_int|100
)paren
)paren
(brace
id|qh
op_assign
id|list_entry
(paren
id|q
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|q
op_assign
id|qh-&gt;horizontal.prev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|qh-&gt;last_used
op_ne
id|now
)paren
op_logical_or
id|force
)paren
id|delete_qh
c_func
(paren
id|s
comma
id|qh
)paren
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_switch_timer_int
id|_static
r_void
id|uhci_switch_timer_int
c_func
(paren
id|uhci_t
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|s-&gt;urb_unlinked
)paren
)paren
(brace
id|s-&gt;td1ms-&gt;hw.td.status
op_or_assign
id|TD_CTRL_IOC
suffix:semicolon
)brace
r_else
(brace
id|s-&gt;td1ms-&gt;hw.td.status
op_and_assign
op_complement
id|TD_CTRL_IOC
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;timeout_urbs
)paren
(brace
id|s-&gt;td32ms-&gt;hw.td.status
op_or_assign
id|TD_CTRL_IOC
suffix:semicolon
)brace
r_else
(brace
id|s-&gt;td32ms-&gt;hw.td.status
op_and_assign
op_complement
id|TD_CTRL_IOC
suffix:semicolon
)brace
id|wmb
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
macro_line|#ifdef CONFIG_USB_UHCI_HIGH_BANDWIDTH
DECL|function|enable_desc_loop
id|_static
r_void
id|enable_desc_loop
c_func
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
(brace
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_NO_FSBR
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
id|s-&gt;chain_end-&gt;hw.qh.head
op_and_assign
op_complement
id|UHCI_PTR_TERM
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|s-&gt;loop_usage
op_increment
suffix:semicolon
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|use_loop
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|disable_desc_loop
id|_static
r_void
id|disable_desc_loop
c_func
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
(brace
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_NO_FSBR
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|use_loop
)paren
(brace
id|s-&gt;loop_usage
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;loop_usage
)paren
(brace
id|s-&gt;chain_end-&gt;hw.qh.head
op_or_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|use_loop
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|queue_urb_unlocked
id|_static
r_void
id|queue_urb_unlocked
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
(brace
r_struct
id|list_head
op_star
id|p
op_assign
op_amp
id|urb-&gt;urb_list
suffix:semicolon
macro_line|#ifdef CONFIG_USB_UHCI_HIGH_BANDWIDTH
(brace
r_int
id|type
suffix:semicolon
id|type
op_assign
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|type
op_eq
id|PIPE_BULK
)paren
op_logical_or
(paren
id|type
op_eq
id|PIPE_CONTROL
)paren
)paren
id|enable_desc_loop
c_func
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
)brace
macro_line|#endif
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|started
op_assign
id|jiffies
suffix:semicolon
id|list_add
(paren
id|p
comma
op_amp
id|s-&gt;urb_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;timeout
)paren
id|s-&gt;timeout_urbs
op_increment
suffix:semicolon
id|uhci_switch_timer_int
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|queue_urb
id|_static
r_void
id|queue_urb
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
(brace
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|queue_urb_unlocked
c_func
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|dequeue_urb
id|_static
r_void
id|dequeue_urb
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
(brace
macro_line|#ifdef CONFIG_USB_UHCI_HIGH_BANDWIDTH
r_int
id|type
suffix:semicolon
id|type
op_assign
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|type
op_eq
id|PIPE_BULK
)paren
op_logical_or
(paren
id|type
op_eq
id|PIPE_CONTROL
)paren
)paren
id|disable_desc_loop
c_func
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
macro_line|#endif
id|list_del
(paren
op_amp
id|urb-&gt;urb_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;timeout
op_logical_and
id|s-&gt;timeout_urbs
)paren
id|s-&gt;timeout_urbs
op_decrement
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|alloc_td
id|_static
r_int
id|alloc_td
(paren
id|uhci_desc_t
op_star
op_star
r_new
comma
r_int
id|flags
)paren
(brace
macro_line|#ifdef DEBUG_SLAB
op_star
r_new
op_assign
id|kmem_cache_alloc
c_func
(paren
id|uhci_desc_kmem
comma
id|SLAB_FLAG
)paren
suffix:semicolon
macro_line|#else
op_star
r_new
op_assign
(paren
id|uhci_desc_t
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
id|uhci_desc_t
)paren
comma
id|KMALLOC_FLAG
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
op_star
r_new
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
op_star
r_new
comma
l_int|0
comma
r_sizeof
(paren
id|uhci_desc_t
)paren
)paren
suffix:semicolon
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|hw.td.link
op_assign
id|UHCI_PTR_TERM
op_or
(paren
id|flags
op_amp
id|UHCI_PTR_BITS
)paren
suffix:semicolon
singleline_comment|// last by default
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|type
op_assign
id|TD_TYPE
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|vertical
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|horizontal
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// append a qh to td.link physically, the SW linkage is not affected
DECL|function|append_qh
id|_static
r_void
id|append_qh
c_func
(paren
id|uhci_t
op_star
id|s
comma
id|uhci_desc_t
op_star
id|td
comma
id|uhci_desc_t
op_star
id|qh
comma
r_int
id|flags
)paren
(brace
r_int
r_int
id|xxx
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;td_lock
comma
id|xxx
)paren
suffix:semicolon
id|td-&gt;hw.td.link
op_assign
id|virt_to_bus
(paren
id|qh
)paren
op_or
(paren
id|flags
op_amp
id|UHCI_PTR_DEPTH
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;td_lock
comma
id|xxx
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
multiline_comment|/* insert td at last position in td-list of qh (vertical) */
DECL|function|insert_td
id|_static
r_int
id|insert_td
(paren
id|uhci_t
op_star
id|s
comma
id|uhci_desc_t
op_star
id|qh
comma
id|uhci_desc_t
op_star
r_new
comma
r_int
id|flags
)paren
(brace
id|uhci_desc_t
op_star
id|prev
suffix:semicolon
r_int
r_int
id|xxx
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;td_lock
comma
id|xxx
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
r_new
op_member_access_from_pointer
id|vertical
comma
op_amp
id|qh-&gt;vertical
)paren
suffix:semicolon
id|prev
op_assign
id|list_entry
(paren
r_new
op_member_access_from_pointer
id|vertical.prev
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qh
op_eq
id|prev
)paren
(brace
singleline_comment|// virgin qh without any tds
id|qh-&gt;hw.qh.element
op_assign
id|virt_to_bus
(paren
r_new
)paren
op_or
id|UHCI_PTR_TERM
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// already tds inserted, implicitely remove TERM bit of prev
id|prev-&gt;hw.td.link
op_assign
id|virt_to_bus
(paren
r_new
)paren
op_or
(paren
id|flags
op_amp
id|UHCI_PTR_DEPTH
)paren
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;td_lock
comma
id|xxx
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
multiline_comment|/* insert new_td after td (horizontal) */
DECL|function|insert_td_horizontal
id|_static
r_int
id|insert_td_horizontal
(paren
id|uhci_t
op_star
id|s
comma
id|uhci_desc_t
op_star
id|td
comma
id|uhci_desc_t
op_star
r_new
)paren
(brace
id|uhci_desc_t
op_star
id|next
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;td_lock
comma
id|flags
)paren
suffix:semicolon
id|next
op_assign
id|list_entry
(paren
id|td-&gt;horizontal.next
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|list_add
(paren
op_amp
r_new
op_member_access_from_pointer
id|horizontal
comma
op_amp
id|td-&gt;horizontal
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|hw.td.link
op_assign
id|td-&gt;hw.td.link
suffix:semicolon
id|td-&gt;hw.td.link
op_assign
id|virt_to_bus
(paren
r_new
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;td_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|unlink_td
id|_static
r_int
id|unlink_td
(paren
id|uhci_t
op_star
id|s
comma
id|uhci_desc_t
op_star
id|element
comma
r_int
id|phys_unlink
)paren
(brace
id|uhci_desc_t
op_star
id|next
comma
op_star
id|prev
suffix:semicolon
r_int
id|dir
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;td_lock
comma
id|flags
)paren
suffix:semicolon
id|next
op_assign
id|list_entry
(paren
id|element-&gt;vertical.next
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next
op_eq
id|element
)paren
(brace
id|dir
op_assign
l_int|1
suffix:semicolon
id|prev
op_assign
id|list_entry
(paren
id|element-&gt;horizontal.prev
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
)brace
r_else
id|prev
op_assign
id|list_entry
(paren
id|element-&gt;vertical.prev
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phys_unlink
)paren
(brace
singleline_comment|// really remove HW linking
r_if
c_cond
(paren
id|prev-&gt;type
op_eq
id|TD_TYPE
)paren
id|prev-&gt;hw.td.link
op_assign
id|element-&gt;hw.td.link
suffix:semicolon
r_else
id|prev-&gt;hw.qh.element
op_assign
id|element-&gt;hw.td.link
suffix:semicolon
)brace
id|mb
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir
op_eq
l_int|0
)paren
id|list_del
(paren
op_amp
id|element-&gt;vertical
)paren
suffix:semicolon
r_else
id|list_del
(paren
op_amp
id|element-&gt;horizontal
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;td_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|delete_desc
id|_static
r_int
id|delete_desc
(paren
id|uhci_desc_t
op_star
id|element
)paren
(brace
macro_line|#ifdef DEBUG_SLAB
id|kmem_cache_free
c_func
(paren
id|uhci_desc_kmem
comma
id|element
)paren
suffix:semicolon
macro_line|#else
id|kfree
(paren
id|element
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// Allocates qh element
DECL|function|alloc_qh
id|_static
r_int
id|alloc_qh
(paren
id|uhci_desc_t
op_star
op_star
r_new
)paren
(brace
macro_line|#ifdef DEBUG_SLAB
op_star
r_new
op_assign
id|kmem_cache_alloc
c_func
(paren
id|uhci_desc_kmem
comma
id|SLAB_FLAG
)paren
suffix:semicolon
macro_line|#else
op_star
r_new
op_assign
(paren
id|uhci_desc_t
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
id|uhci_desc_t
)paren
comma
id|KMALLOC_FLAG
)paren
suffix:semicolon
macro_line|#endif&t;
r_if
c_cond
(paren
op_logical_neg
op_star
r_new
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
op_star
r_new
comma
l_int|0
comma
r_sizeof
(paren
id|uhci_desc_t
)paren
)paren
suffix:semicolon
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|hw.qh.head
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|hw.qh.element
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|type
op_assign
id|QH_TYPE
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|horizontal
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
(paren
op_star
r_new
)paren
op_member_access_from_pointer
id|vertical
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Allocated qh @ %p&quot;
comma
op_star
r_new
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// inserts new qh before/after the qh at pos
singleline_comment|// flags: 0: insert before pos, 1: insert after pos (for low speed transfers)
DECL|function|insert_qh
id|_static
r_int
id|insert_qh
(paren
id|uhci_t
op_star
id|s
comma
id|uhci_desc_t
op_star
id|pos
comma
id|uhci_desc_t
op_star
r_new
comma
r_int
id|order
)paren
(brace
id|uhci_desc_t
op_star
id|old
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|order
)paren
(brace
singleline_comment|// (OLD) (POS) -&gt; (OLD) (NEW) (POS)
id|old
op_assign
id|list_entry
(paren
id|pos-&gt;horizontal.prev
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
r_new
op_member_access_from_pointer
id|horizontal
comma
op_amp
id|pos-&gt;horizontal
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|hw.qh.head
op_assign
id|MAKE_QH_ADDR
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|old-&gt;hw.qh.head
op_amp
id|UHCI_PTR_TERM
)paren
)paren
id|old-&gt;hw.qh.head
op_assign
id|MAKE_QH_ADDR
(paren
r_new
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// (POS) (OLD) -&gt; (POS) (NEW) (OLD)
id|old
op_assign
id|list_entry
(paren
id|pos-&gt;horizontal.next
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|list_add
(paren
op_amp
r_new
op_member_access_from_pointer
id|horizontal
comma
op_amp
id|pos-&gt;horizontal
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|hw.qh.head
op_assign
id|MAKE_QH_ADDR
(paren
id|old
)paren
suffix:semicolon
id|pos-&gt;hw.qh.head
op_assign
id|MAKE_QH_ADDR
(paren
r_new
)paren
suffix:semicolon
)brace
id|mb
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|unlink_qh
id|_static
r_int
id|unlink_qh
(paren
id|uhci_t
op_star
id|s
comma
id|uhci_desc_t
op_star
id|element
)paren
(brace
id|uhci_desc_t
op_star
id|prev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
id|prev
op_assign
id|list_entry
(paren
id|element-&gt;horizontal.prev
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|prev-&gt;hw.qh.head
op_assign
id|element-&gt;hw.qh.head
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;unlink qh %p, pqh %p, nxqh %p, to %08x&quot;
comma
id|element
comma
id|prev
comma
id|list_entry
(paren
id|element-&gt;horizontal.next
comma
id|uhci_desc_t
comma
id|horizontal
)paren
comma
id|element-&gt;hw.qh.head
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|element-&gt;horizontal
)paren
suffix:semicolon
id|mb
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|delete_qh
id|_static
r_int
id|delete_qh
(paren
id|uhci_t
op_star
id|s
comma
id|uhci_desc_t
op_star
id|qh
)paren
(brace
id|uhci_desc_t
op_star
id|td
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|list_del
(paren
op_amp
id|qh-&gt;horizontal
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|qh-&gt;vertical.next
)paren
op_ne
op_amp
id|qh-&gt;vertical
)paren
(brace
id|td
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;unlink td @ %p&quot;
comma
id|td
)paren
suffix:semicolon
id|unlink_td
(paren
id|s
comma
id|td
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// no physical unlink
id|delete_desc
(paren
id|td
)paren
suffix:semicolon
)brace
id|delete_desc
(paren
id|qh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|clean_td_chain
id|_static
r_void
id|clean_td_chain
(paren
id|uhci_desc_t
op_star
id|td
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|uhci_desc_t
op_star
id|td1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|td-&gt;horizontal.next
)paren
op_ne
op_amp
id|td-&gt;horizontal
)paren
(brace
id|td1
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|delete_desc
(paren
id|td1
)paren
suffix:semicolon
)brace
id|delete_desc
(paren
id|td
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|fill_td
id|_static
r_void
id|fill_td
(paren
id|uhci_desc_t
op_star
id|td
comma
r_int
id|status
comma
r_int
id|info
comma
id|__u32
id|buffer
)paren
(brace
id|td-&gt;hw.td.status
op_assign
id|status
suffix:semicolon
id|td-&gt;hw.td.info
op_assign
id|info
suffix:semicolon
id|td-&gt;hw.td.buffer
op_assign
id|buffer
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// Removes ALL qhs in chain (paranoia!)
DECL|function|cleanup_skel
id|_static
r_void
id|cleanup_skel
(paren
id|uhci_t
op_star
id|s
)paren
(brace
r_int
r_int
id|n
suffix:semicolon
id|uhci_desc_t
op_star
id|td
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;cleanup_skel&quot;
)paren
suffix:semicolon
id|clean_descs
c_func
(paren
id|s
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;td32ms
)paren
(brace
id|unlink_td
c_func
(paren
id|s
comma
id|s-&gt;td32ms
comma
l_int|1
)paren
suffix:semicolon
id|delete_desc
c_func
(paren
id|s-&gt;td32ms
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|8
suffix:semicolon
id|n
op_increment
)paren
(brace
id|td
op_assign
id|s-&gt;int_chain
(braket
id|n
)braket
suffix:semicolon
id|clean_td_chain
(paren
id|td
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;iso_td
)paren
(brace
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|1024
suffix:semicolon
id|n
op_increment
)paren
(brace
id|td
op_assign
id|s-&gt;iso_td
(braket
id|n
)braket
suffix:semicolon
id|clean_td_chain
(paren
id|td
)paren
suffix:semicolon
)brace
id|kfree
(paren
id|s-&gt;iso_td
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;framelist
)paren
id|free_page
(paren
(paren
r_int
r_int
)paren
id|s-&gt;framelist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;control_chain
)paren
(brace
singleline_comment|// completed init_skel?
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|uhci_desc_t
op_star
id|qh
comma
op_star
id|qh1
suffix:semicolon
id|qh
op_assign
id|s-&gt;control_chain
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|qh-&gt;horizontal.next
)paren
op_ne
op_amp
id|qh-&gt;horizontal
)paren
(brace
id|qh1
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|delete_qh
(paren
id|s
comma
id|qh1
)paren
suffix:semicolon
)brace
id|delete_qh
(paren
id|s
comma
id|qh
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|s-&gt;ls_control_chain
)paren
id|delete_desc
(paren
id|s-&gt;ls_control_chain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;control_chain
)paren
id|delete_desc
c_func
(paren
id|s-&gt;control_chain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;bulk_chain
)paren
id|delete_desc
(paren
id|s-&gt;bulk_chain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;chain_end
)paren
id|delete_desc
(paren
id|s-&gt;chain_end
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;cleanup_skel finished&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// allocates framelist and qh-skeletons
singleline_comment|// only HW-links provide continous linking, SW-links stay in their domain (ISO/INT)
DECL|function|init_skel
id|_static
r_int
id|init_skel
(paren
id|uhci_t
op_star
id|s
)paren
(brace
r_int
id|n
comma
id|ret
suffix:semicolon
id|uhci_desc_t
op_star
id|qh
comma
op_star
id|td
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;init_skel&quot;
)paren
suffix:semicolon
id|s-&gt;framelist
op_assign
(paren
id|__u32
op_star
)paren
id|get_free_page
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;framelist
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
(paren
id|s-&gt;framelist
comma
l_int|0
comma
l_int|4096
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;allocating iso desc pointer list&quot;
)paren
suffix:semicolon
id|s-&gt;iso_td
op_assign
(paren
id|uhci_desc_t
op_star
op_star
)paren
id|kmalloc
(paren
l_int|1024
op_star
r_sizeof
(paren
id|uhci_desc_t
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;iso_td
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|s-&gt;ls_control_chain
op_assign
l_int|NULL
suffix:semicolon
id|s-&gt;control_chain
op_assign
l_int|NULL
suffix:semicolon
id|s-&gt;bulk_chain
op_assign
l_int|NULL
suffix:semicolon
id|s-&gt;chain_end
op_assign
l_int|NULL
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;allocating iso descs&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|1024
suffix:semicolon
id|n
op_increment
)paren
(brace
singleline_comment|// allocate skeleton iso/irq-tds
id|ret
op_assign
id|alloc_td
(paren
op_amp
id|td
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|s-&gt;iso_td
(braket
id|n
)braket
op_assign
id|td
suffix:semicolon
id|s-&gt;framelist
(braket
id|n
)braket
op_assign
(paren
(paren
id|__u32
)paren
id|virt_to_bus
(paren
id|td
)paren
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;allocating qh: chain_end&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|alloc_qh
(paren
op_amp
id|qh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|s-&gt;chain_end
op_assign
id|qh
suffix:semicolon
id|ret
op_assign
id|alloc_td
(paren
op_amp
id|td
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|fill_td
(paren
id|td
comma
l_int|0
op_star
id|TD_CTRL_IOC
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// generate 1ms interrupt (enabled on demand)
id|insert_td
(paren
id|s
comma
id|qh
comma
id|td
comma
l_int|0
)paren
suffix:semicolon
id|qh-&gt;hw.qh.element
op_and_assign
op_complement
id|UHCI_PTR_TERM
suffix:semicolon
singleline_comment|// remove TERM bit
id|s-&gt;td1ms
op_assign
id|td
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;allocating qh: bulk_chain&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|alloc_qh
(paren
op_amp
id|qh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|insert_qh
(paren
id|s
comma
id|s-&gt;chain_end
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
id|s-&gt;bulk_chain
op_assign
id|qh
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;allocating qh: control_chain&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|alloc_qh
(paren
op_amp
id|qh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|insert_qh
(paren
id|s
comma
id|s-&gt;bulk_chain
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
id|s-&gt;control_chain
op_assign
id|qh
suffix:semicolon
macro_line|#ifdef&t;CONFIG_USB_UHCI_HIGH_BANDWIDTH
singleline_comment|// disabled reclamation loop
id|s-&gt;chain_end-&gt;hw.qh.head
op_assign
id|virt_to_bus
c_func
(paren
id|s-&gt;control_chain
)paren
op_or
id|UHCI_PTR_QH
op_or
id|UHCI_PTR_TERM
suffix:semicolon
macro_line|#endif
id|dbg
c_func
(paren
l_string|&quot;allocating qh: ls_control_chain&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|alloc_qh
(paren
op_amp
id|qh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|insert_qh
(paren
id|s
comma
id|s-&gt;control_chain
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
id|s-&gt;ls_control_chain
op_assign
id|qh
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|8
suffix:semicolon
id|n
op_increment
)paren
id|s-&gt;int_chain
(braket
id|n
)braket
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;allocating skeleton INT-TDs&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|8
suffix:semicolon
id|n
op_increment
)paren
(brace
id|uhci_desc_t
op_star
id|td
suffix:semicolon
id|alloc_td
(paren
op_amp
id|td
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|s-&gt;int_chain
(braket
id|n
)braket
op_assign
id|td
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
(brace
id|s-&gt;int_chain
(braket
l_int|0
)braket
op_member_access_from_pointer
id|hw.td.link
op_assign
id|virt_to_bus
(paren
id|s-&gt;ls_control_chain
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
)brace
r_else
(brace
id|s-&gt;int_chain
(braket
id|n
)braket
op_member_access_from_pointer
id|hw.td.link
op_assign
id|virt_to_bus
(paren
id|s-&gt;int_chain
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;Linking skeleton INT-TDs&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
l_int|1024
suffix:semicolon
id|n
op_increment
)paren
(brace
singleline_comment|// link all iso-tds to the interrupt chains
r_int
id|m
comma
id|o
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;framelist[%i]=%x&quot;
comma
id|n
comma
id|s-&gt;framelist
(braket
id|n
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|n
op_amp
l_int|127
)paren
op_eq
l_int|127
)paren
(paren
(paren
id|uhci_desc_t
op_star
)paren
id|s-&gt;iso_td
(braket
id|n
)braket
)paren
op_member_access_from_pointer
id|hw.td.link
op_assign
id|virt_to_bus
c_func
(paren
id|s-&gt;int_chain
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
r_for
c_loop
(paren
id|o
op_assign
l_int|1
comma
id|m
op_assign
l_int|2
suffix:semicolon
id|m
op_le
l_int|128
suffix:semicolon
id|o
op_increment
comma
id|m
op_add_assign
id|m
)paren
r_if
c_cond
(paren
(paren
id|n
op_amp
(paren
id|m
op_minus
l_int|1
)paren
)paren
op_eq
(paren
(paren
id|m
op_minus
l_int|1
)paren
op_div
l_int|2
)paren
)paren
(paren
(paren
id|uhci_desc_t
op_star
)paren
id|s-&gt;iso_td
(braket
id|n
)braket
)paren
op_member_access_from_pointer
id|hw.td.link
op_assign
id|virt_to_bus
(paren
id|s-&gt;int_chain
(braket
id|o
)braket
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|alloc_td
(paren
op_amp
id|td
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|init_skel_cleanup
suffix:semicolon
id|fill_td
(paren
id|td
comma
l_int|0
op_star
id|TD_CTRL_IOC
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// generate 32ms interrupt
id|s-&gt;td32ms
op_assign
id|td
suffix:semicolon
id|insert_td_horizontal
(paren
id|s
comma
id|s-&gt;int_chain
(braket
l_int|5
)braket
comma
id|td
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
singleline_comment|//uhci_show_queue(s-&gt;control_chain);   
id|dbg
c_func
(paren
l_string|&quot;init_skel exit&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|init_skel_cleanup
suffix:colon
id|cleanup_skel
(paren
id|s
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|//                         LOW LEVEL STUFF
singleline_comment|//          assembles QHs und TDs for control, bulk and iso
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_submit_control_urb
id|_static
r_int
id|uhci_submit_control_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_desc_t
op_star
id|qh
comma
op_star
id|td
suffix:semicolon
id|uhci_t
op_star
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_int
r_int
id|destination
comma
id|status
suffix:semicolon
r_int
id|maxsze
op_assign
id|usb_maxpacket
(paren
id|urb-&gt;dev
comma
id|urb-&gt;pipe
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_int
id|depth_first
op_assign
id|USE_CTRL_DEPTH_FIRST
suffix:semicolon
singleline_comment|// UHCI descriptor chasing method
r_if
c_cond
(paren
op_logical_neg
id|maxsze
)paren
(brace
id|err
c_func
(paren
l_string|&quot;uhci_submit_control_urb: pipesize for pipe %x is zero&quot;
comma
id|urb-&gt;pipe
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;uhci_submit_control start&quot;
)paren
suffix:semicolon
id|alloc_qh
(paren
op_amp
id|qh
)paren
suffix:semicolon
singleline_comment|// alloc qh for this request
r_if
c_cond
(paren
op_logical_neg
id|qh
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|alloc_td
(paren
op_amp
id|td
comma
id|UHCI_PTR_DEPTH
op_star
id|depth_first
)paren
suffix:semicolon
singleline_comment|// get td for setup stage
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
(brace
id|delete_qh
(paren
id|s
comma
id|qh
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* The &quot;pipe&quot; thing contains the destination in bits 8--18 */
id|destination
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|PIPE_DEVEP_MASK
)paren
op_or
id|USB_PID_SETUP
suffix:semicolon
multiline_comment|/* 3 errors */
id|status
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|TD_CTRL_LS
)paren
op_or
id|TD_CTRL_ACTIVE
op_or
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
ques
c_cond
l_int|0
suffix:colon
id|TD_CTRL_SPD
)paren
op_or
(paren
l_int|3
op_lshift
l_int|27
)paren
suffix:semicolon
multiline_comment|/*  Build the TD for the control request, try forever, 8 bytes of data */
id|fill_td
(paren
id|td
comma
id|status
comma
id|destination
op_or
(paren
l_int|7
op_lshift
l_int|21
)paren
comma
id|virt_to_bus
(paren
id|urb-&gt;setup_packet
)paren
)paren
suffix:semicolon
id|insert_td
(paren
id|s
comma
id|qh
comma
id|td
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// queue &squot;setup stage&squot;-td in qh
macro_line|#if 0
(brace
r_char
op_star
id|sp
op_assign
id|urb-&gt;setup_packet
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;SETUP to pipe %x: %x %x %x %x %x %x %x %x&quot;
comma
id|urb-&gt;pipe
comma
id|sp
(braket
l_int|0
)braket
comma
id|sp
(braket
l_int|1
)braket
comma
id|sp
(braket
l_int|2
)braket
comma
id|sp
(braket
l_int|3
)braket
comma
id|sp
(braket
l_int|4
)braket
comma
id|sp
(braket
l_int|5
)braket
comma
id|sp
(braket
l_int|6
)braket
comma
id|sp
(braket
l_int|7
)braket
)paren
suffix:semicolon
)brace
singleline_comment|//uhci_show_td(td);
macro_line|#endif
id|len
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
multiline_comment|/* If direction is &quot;send&quot;, change the frame from SETUP (0x2D)&n;&t;   to OUT (0xE1). Else change it from SETUP to IN (0x69). */
id|destination
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|PIPE_DEVEP_MASK
)paren
op_or
(paren
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
id|USB_PID_OUT
suffix:colon
id|USB_PID_IN
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|pktsze
op_assign
id|len
suffix:semicolon
id|alloc_td
(paren
op_amp
id|td
comma
id|UHCI_PTR_DEPTH
op_star
id|depth_first
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
(brace
id|delete_qh
(paren
id|s
comma
id|qh
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pktsze
OG
id|maxsze
)paren
id|pktsze
op_assign
id|maxsze
suffix:semicolon
id|destination
op_xor_assign
l_int|1
op_lshift
id|TD_TOKEN_TOGGLE
suffix:semicolon
singleline_comment|// toggle DATA0/1
id|fill_td
(paren
id|td
comma
id|status
comma
id|destination
op_or
(paren
(paren
id|pktsze
op_minus
l_int|1
)paren
op_lshift
l_int|21
)paren
comma
id|virt_to_bus
(paren
id|data
)paren
)paren
suffix:semicolon
singleline_comment|// Status, pktsze bytes of data
id|insert_td
(paren
id|s
comma
id|qh
comma
id|td
comma
id|UHCI_PTR_DEPTH
op_star
id|depth_first
)paren
suffix:semicolon
singleline_comment|// queue &squot;data stage&squot;-td in qh
id|data
op_add_assign
id|pktsze
suffix:semicolon
id|len
op_sub_assign
id|pktsze
suffix:semicolon
)brace
multiline_comment|/*  Build the final TD for control status */
multiline_comment|/* It&squot;s only IN if the pipe is out AND we aren&squot;t expecting data */
id|destination
op_and_assign
op_complement
id|UHCI_PID
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
op_logical_or
(paren
id|urb-&gt;transfer_buffer_length
op_eq
l_int|0
)paren
)paren
id|destination
op_or_assign
id|USB_PID_IN
suffix:semicolon
r_else
id|destination
op_or_assign
id|USB_PID_OUT
suffix:semicolon
id|destination
op_or_assign
l_int|1
op_lshift
id|TD_TOKEN_TOGGLE
suffix:semicolon
multiline_comment|/* End in Data1 */
id|alloc_td
(paren
op_amp
id|td
comma
id|UHCI_PTR_DEPTH
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
(brace
id|delete_qh
(paren
id|s
comma
id|qh
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|status
op_and_assign
op_complement
id|TD_CTRL_SPD
suffix:semicolon
multiline_comment|/* no limit on errors on final packet , 0 bytes of data */
id|fill_td
(paren
id|td
comma
id|status
op_or
id|TD_CTRL_IOC
comma
id|destination
op_or
(paren
id|UHCI_NULL_DATA_SIZE
op_lshift
l_int|21
)paren
comma
l_int|0
)paren
suffix:semicolon
id|insert_td
(paren
id|s
comma
id|qh
comma
id|td
comma
id|UHCI_PTR_DEPTH
op_star
id|depth_first
)paren
suffix:semicolon
singleline_comment|// queue status td
id|list_add
(paren
op_amp
id|qh-&gt;desc_list
comma
op_amp
id|urb_priv-&gt;desc_list
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|queue_urb
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
singleline_comment|// queue before inserting in desc chain
id|qh-&gt;hw.qh.element
op_and_assign
op_complement
id|UHCI_PTR_TERM
suffix:semicolon
singleline_comment|//uhci_show_queue(qh);
multiline_comment|/* Start it up... put low speed first */
r_if
c_cond
(paren
id|urb-&gt;pipe
op_amp
id|TD_CTRL_LS
)paren
id|insert_qh
(paren
id|s
comma
id|s-&gt;control_chain
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
r_else
id|insert_qh
(paren
id|s
comma
id|s-&gt;bulk_chain
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;uhci_submit_control end&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// For queued bulk transfers, two additional QH helpers are allocated (nqh, bqh)
singleline_comment|// Due to the linking with other bulk urbs, it has to be locked with urb_list_lock!
DECL|function|uhci_submit_bulk_urb
id|_static
r_int
id|uhci_submit_bulk_urb
(paren
id|urb_t
op_star
id|urb
comma
id|urb_t
op_star
id|bulk_urb
)paren
(brace
id|uhci_t
op_star
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
id|uhci_desc_t
op_star
id|qh
comma
op_star
id|td
comma
op_star
id|nqh
comma
op_star
id|bqh
comma
op_star
id|first_td
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|destination
comma
id|status
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
r_int
id|maxsze
op_assign
id|usb_maxpacket
(paren
id|urb-&gt;dev
comma
id|pipe
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
suffix:semicolon
r_int
id|info
comma
id|len
comma
id|last
suffix:semicolon
r_int
id|depth_first
op_assign
id|USE_BULK_DEPTH_FIRST
suffix:semicolon
singleline_comment|// UHCI descriptor chasing method
id|urb_priv_t
op_star
id|upriv
comma
op_star
id|bpriv
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|usb_endpoint_halted
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|pipe
)paren
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
)paren
r_return
op_minus
id|EPIPE
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer_length
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Negative transfer length in submit_bulk&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|maxsze
)paren
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
id|queue_dbg
c_func
(paren
l_string|&quot;uhci_submit_bulk_urb: urb %p, old %p, pipe %08x, len %i&quot;
comma
id|urb
comma
id|bulk_urb
comma
id|urb-&gt;pipe
comma
id|urb-&gt;transfer_buffer_length
)paren
suffix:semicolon
id|upriv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bulk_urb
)paren
(brace
id|alloc_qh
(paren
op_amp
id|qh
)paren
suffix:semicolon
singleline_comment|// get qh for this request
r_if
c_cond
(paren
op_logical_neg
id|qh
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_QUEUE_BULK
)paren
(brace
id|alloc_qh
c_func
(paren
op_amp
id|nqh
)paren
suffix:semicolon
singleline_comment|// placeholder for clean unlink
r_if
c_cond
(paren
op_logical_neg
id|nqh
)paren
(brace
id|delete_desc
(paren
id|qh
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|upriv-&gt;next_qh
op_assign
id|nqh
suffix:semicolon
id|queue_dbg
c_func
(paren
l_string|&quot;new next qh %p&quot;
comma
id|nqh
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|bpriv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|bulk_urb-&gt;hcpriv
suffix:semicolon
id|qh
op_assign
id|bpriv-&gt;bottom_qh
suffix:semicolon
singleline_comment|// re-use bottom qh and next qh
id|nqh
op_assign
id|bpriv-&gt;next_qh
suffix:semicolon
id|upriv-&gt;next_qh
op_assign
id|nqh
suffix:semicolon
id|upriv-&gt;prev_queued_urb
op_assign
id|bulk_urb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_QUEUE_BULK
)paren
(brace
id|alloc_qh
(paren
op_amp
id|bqh
)paren
suffix:semicolon
singleline_comment|// &quot;bottom&quot; QH,
r_if
c_cond
(paren
op_logical_neg
id|bqh
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bulk_urb
)paren
(brace
id|delete_desc
c_func
(paren
id|qh
)paren
suffix:semicolon
id|delete_desc
c_func
(paren
id|nqh
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|bqh-&gt;hw.qh.element
op_assign
id|UHCI_PTR_TERM
suffix:semicolon
id|bqh-&gt;hw.qh.head
op_assign
id|virt_to_bus
c_func
(paren
id|nqh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
singleline_comment|// element
id|upriv-&gt;bottom_qh
op_assign
id|bqh
suffix:semicolon
)brace
id|queue_dbg
c_func
(paren
l_string|&quot;uhci_submit_bulk: qh %p bqh %p nqh %p&quot;
comma
id|qh
comma
id|bqh
comma
id|nqh
)paren
suffix:semicolon
multiline_comment|/* The &quot;pipe&quot; thing contains the destination in bits 8--18. */
id|destination
op_assign
(paren
id|pipe
op_amp
id|PIPE_DEVEP_MASK
)paren
op_or
id|usb_packetid
(paren
id|pipe
)paren
suffix:semicolon
multiline_comment|/* 3 errors */
id|status
op_assign
(paren
id|pipe
op_amp
id|TD_CTRL_LS
)paren
op_or
id|TD_CTRL_ACTIVE
op_or
(paren
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
ques
c_cond
l_int|0
suffix:colon
id|TD_CTRL_SPD
)paren
op_or
(paren
l_int|3
op_lshift
l_int|27
)paren
suffix:semicolon
multiline_comment|/* Build the TDs for the bulk request */
id|len
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_do
(brace
singleline_comment|// TBD: Really allow zero-length packets?
r_int
id|pktsze
op_assign
id|len
suffix:semicolon
id|alloc_td
(paren
op_amp
id|td
comma
id|UHCI_PTR_DEPTH
op_star
id|depth_first
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
(brace
id|delete_qh
(paren
id|s
comma
id|qh
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pktsze
OG
id|maxsze
)paren
id|pktsze
op_assign
id|maxsze
suffix:semicolon
singleline_comment|// pktsze bytes of data 
id|info
op_assign
id|destination
op_or
(paren
(paren
(paren
id|pktsze
op_minus
l_int|1
)paren
op_amp
id|UHCI_NULL_DATA_SIZE
)paren
op_lshift
l_int|21
)paren
op_or
(paren
id|usb_gettoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|pipe
)paren
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
op_lshift
id|TD_TOKEN_TOGGLE
)paren
suffix:semicolon
id|fill_td
(paren
id|td
comma
id|status
comma
id|info
comma
id|virt_to_bus
(paren
id|data
)paren
)paren
suffix:semicolon
id|data
op_add_assign
id|pktsze
suffix:semicolon
id|len
op_sub_assign
id|pktsze
suffix:semicolon
id|last
op_assign
(paren
id|len
op_eq
l_int|0
op_logical_and
(paren
id|usb_pipein
c_func
(paren
id|pipe
)paren
op_logical_or
id|pktsze
OL
id|maxsze
op_logical_or
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last
)paren
id|td-&gt;hw.td.status
op_or_assign
id|TD_CTRL_IOC
suffix:semicolon
singleline_comment|// last one generates INT
id|insert_td
(paren
id|s
comma
id|qh
comma
id|td
comma
id|UHCI_PTR_DEPTH
op_star
id|depth_first
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|first_td
)paren
id|first_td
op_assign
id|td
suffix:semicolon
id|usb_dotoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|pipe
)paren
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|last
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bulk_urb
op_logical_and
id|bpriv
)paren
singleline_comment|// everything went OK, link with old bulk URB
id|bpriv-&gt;next_queued_urb
op_assign
id|urb
suffix:semicolon
id|list_add
(paren
op_amp
id|qh-&gt;desc_list
comma
op_amp
id|urb_priv-&gt;desc_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_QUEUE_BULK
)paren
id|append_qh
c_func
(paren
id|s
comma
id|td
comma
id|bqh
comma
id|UHCI_PTR_DEPTH
op_star
id|depth_first
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|queue_urb_unlocked
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_QUEUE_BULK
)paren
id|qh-&gt;hw.qh.element
op_assign
id|virt_to_bus
(paren
id|first_td
)paren
suffix:semicolon
r_else
id|qh-&gt;hw.qh.element
op_and_assign
op_complement
id|UHCI_PTR_TERM
suffix:semicolon
singleline_comment|// arm QH
r_if
c_cond
(paren
op_logical_neg
id|bulk_urb
)paren
(brace
singleline_comment|// new bulk queue&t;
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_QUEUE_BULK
)paren
(brace
id|spin_lock
(paren
op_amp
id|s-&gt;td_lock
)paren
suffix:semicolon
singleline_comment|// both QHs in one go
id|insert_qh
(paren
id|s
comma
id|s-&gt;chain_end
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// Main QH
id|insert_qh
(paren
id|s
comma
id|s-&gt;chain_end
comma
id|nqh
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// Helper QH
id|spin_unlock
(paren
op_amp
id|s-&gt;td_lock
)paren
suffix:semicolon
)brace
r_else
id|insert_qh
(paren
id|s
comma
id|s-&gt;chain_end
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|//uhci_show_queue(s-&gt;bulk_chain);
singleline_comment|//dbg(&quot;uhci_submit_bulk_urb: exit&bslash;n&quot;);
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_clean_iso_step1
id|_static
r_void
id|uhci_clean_iso_step1
c_func
(paren
id|uhci_t
op_star
id|s
comma
id|urb_priv_t
op_star
id|urb_priv
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|uhci_desc_t
op_star
id|td
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|urb_priv-&gt;desc_list.next
suffix:semicolon
id|p
op_ne
op_amp
id|urb_priv-&gt;desc_list
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
id|td
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
id|unlink_td
(paren
id|s
comma
id|td
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_clean_iso_step2
id|_static
r_void
id|uhci_clean_iso_step2
c_func
(paren
id|uhci_t
op_star
id|s
comma
id|urb_priv_t
op_star
id|urb_priv
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|uhci_desc_t
op_star
id|td
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|urb_priv-&gt;desc_list.next
)paren
op_ne
op_amp
id|urb_priv-&gt;desc_list
)paren
(brace
id|td
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
id|list_del
(paren
id|p
)paren
suffix:semicolon
id|delete_desc
(paren
id|td
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// mode: 0: unlink but no deletion mark (step 1 of async_unlink)
singleline_comment|//       1: regular (unlink/delete-mark)
singleline_comment|//       2: deletion mark for QH (step 2 of async_unlink)
singleline_comment|// looks a bit complicated because of all the bulk queueing goodies
DECL|function|uhci_clean_transfer
id|_static
r_void
id|uhci_clean_transfer
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
comma
id|uhci_desc_t
op_star
id|qh
comma
r_int
id|mode
)paren
(brace
id|uhci_desc_t
op_star
id|bqh
comma
op_star
id|nqh
comma
op_star
id|prevqh
comma
op_star
id|prevtd
suffix:semicolon
r_int
id|now
suffix:semicolon
id|urb_priv_t
op_star
id|priv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
id|now
op_assign
id|UHCI_GET_CURRENT_FRAME
c_func
(paren
id|s
)paren
suffix:semicolon
id|bqh
op_assign
id|priv-&gt;bottom_qh
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;next_queued_urb
)paren
(brace
singleline_comment|// no more appended bulk queues
id|queue_dbg
c_func
(paren
l_string|&quot;uhci_clean_transfer: No more bulks for urb %p, qh %p, bqh %p, nqh %p&quot;
comma
id|urb
comma
id|qh
comma
id|bqh
comma
id|priv-&gt;next_qh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;prev_queued_urb
)paren
(brace
singleline_comment|// qh not top of the queue
id|urb_priv_t
op_star
id|ppriv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|priv-&gt;prev_queued_urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
l_int|2
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
id|prevqh
op_assign
id|list_entry
(paren
id|ppriv-&gt;desc_list.next
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
id|prevtd
op_assign
id|list_entry
(paren
id|prevqh-&gt;vertical.prev
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
id|prevtd-&gt;hw.td.link
op_assign
id|virt_to_bus
c_func
(paren
id|priv-&gt;bottom_qh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
singleline_comment|// skip current qh
id|mb
c_func
(paren
)paren
suffix:semicolon
id|queue_dbg
c_func
(paren
l_string|&quot;uhci_clean_transfer: relink pqh %p, ptd %p&quot;
comma
id|prevqh
comma
id|prevtd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
id|ppriv-&gt;bottom_qh
op_assign
id|priv-&gt;bottom_qh
suffix:semicolon
id|ppriv-&gt;next_queued_urb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// queue is dead, qh is top of the queue
r_if
c_cond
(paren
id|mode
op_ne
l_int|2
)paren
id|unlink_qh
c_func
(paren
id|s
comma
id|qh
)paren
suffix:semicolon
singleline_comment|// remove qh from horizontal chain
r_if
c_cond
(paren
id|bqh
)paren
(brace
singleline_comment|// remove remainings of bulk queue
id|nqh
op_assign
id|priv-&gt;next_qh
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
l_int|2
)paren
id|unlink_qh
c_func
(paren
id|s
comma
id|nqh
)paren
suffix:semicolon
singleline_comment|// remove nqh from horizontal chain
r_if
c_cond
(paren
id|mode
)paren
(brace
id|nqh-&gt;last_used
op_assign
id|bqh-&gt;last_used
op_assign
id|now
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|nqh-&gt;horizontal
comma
op_amp
id|s-&gt;free_desc
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|bqh-&gt;horizontal
comma
op_amp
id|s-&gt;free_desc
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
singleline_comment|// there are queued urbs following
id|queue_dbg
c_func
(paren
l_string|&quot;uhci_clean_transfer: urb %p, prevurb %p, nexturb %p, qh %p, bqh %p, nqh %p&quot;
comma
id|urb
comma
id|priv-&gt;prev_queued_urb
comma
id|priv-&gt;next_queued_urb
comma
id|qh
comma
id|bqh
comma
id|priv-&gt;next_qh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
l_int|2
)paren
(brace
singleline_comment|// no work for cleanup at unlink-completion
id|urb_t
op_star
id|nurb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|nurb
op_assign
id|priv-&gt;next_queued_urb
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;prev_queued_urb
)paren
(brace
singleline_comment|// top QH
id|prevqh
op_assign
id|list_entry
(paren
id|qh-&gt;horizontal.prev
comma
id|uhci_desc_t
comma
id|horizontal
)paren
suffix:semicolon
id|prevqh-&gt;hw.qh.head
op_assign
id|virt_to_bus
c_func
(paren
id|bqh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
id|list_del
(paren
op_amp
id|qh-&gt;horizontal
)paren
suffix:semicolon
singleline_comment|// remove this qh form horizontal chain
id|list_add
(paren
op_amp
id|bqh-&gt;horizontal
comma
op_amp
id|prevqh-&gt;horizontal
)paren
suffix:semicolon
singleline_comment|// insert next bqh in horizontal chain
)brace
r_else
(brace
singleline_comment|// intermediate QH
id|urb_priv_t
op_star
id|ppriv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|priv-&gt;prev_queued_urb-&gt;hcpriv
suffix:semicolon
id|urb_priv_t
op_star
id|npriv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|nurb-&gt;hcpriv
suffix:semicolon
id|uhci_desc_t
op_star
id|bnqh
suffix:semicolon
id|bnqh
op_assign
id|list_entry
(paren
id|npriv-&gt;desc_list.next
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
id|ppriv-&gt;bottom_qh
op_assign
id|bnqh
suffix:semicolon
id|ppriv-&gt;next_queued_urb
op_assign
id|nurb
suffix:semicolon
id|prevqh
op_assign
id|list_entry
(paren
id|ppriv-&gt;desc_list.next
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
id|prevqh-&gt;hw.qh.head
op_assign
id|virt_to_bus
c_func
(paren
id|bqh
)paren
op_or
id|UHCI_PTR_QH
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;qh_lock
comma
id|flags
)paren
suffix:semicolon
(paren
(paren
id|urb_priv_t
op_star
)paren
id|nurb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|prev_queued_urb
op_assign
id|priv-&gt;prev_queued_urb
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mode
)paren
(brace
id|qh-&gt;last_used
op_assign
id|now
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|qh-&gt;horizontal
comma
op_amp
id|s-&gt;free_desc
)paren
suffix:semicolon
singleline_comment|// mark for later deletion/kfree
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// Release bandwidth for Interrupt or Isoc. transfers 
DECL|function|uhci_release_bandwidth
id|_static
r_void
id|uhci_release_bandwidth
c_func
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_if
c_cond
(paren
id|urb-&gt;bandwidth
)paren
(brace
r_switch
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_INTERRUPT
suffix:colon
id|usb_release_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
id|usb_release_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// unlinks an urb by dequeuing its qh, waits some frames and forgets it
DECL|function|uhci_unlink_urb_sync
id|_static
r_int
id|uhci_unlink_urb_sync
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_desc_t
op_star
id|qh
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
)paren
singleline_comment|// shouldn&squot;t be called from interrupt at all...
id|spin_lock
c_func
(paren
op_amp
id|urb-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
singleline_comment|// URB probably still in work
id|dequeue_urb
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
id|uhci_switch_timer_int
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;unlink_urb_done
op_assign
l_int|1
suffix:semicolon
id|uhci_release_bandwidth
c_func
(paren
id|urb
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
op_minus
id|ENOENT
suffix:semicolon
singleline_comment|// mark urb as killed&t;&t;
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
)paren
id|spin_unlock
c_func
(paren
op_amp
id|urb-&gt;lock
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_INTERRUPT
suffix:colon
id|usb_dotoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
id|uhci_clean_iso_step1
c_func
(paren
id|s
comma
id|urb_priv
)paren
suffix:semicolon
id|uhci_wait_ms
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|uhci_clean_iso_step2
c_func
(paren
id|s
comma
id|urb_priv
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
r_case
id|PIPE_CONTROL
suffix:colon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|qh
op_assign
id|list_entry
(paren
id|urb_priv-&gt;desc_list.next
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
id|uhci_clean_transfer
c_func
(paren
id|s
comma
id|urb
comma
id|qh
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|uhci_wait_ms
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_SLAB
id|kmem_cache_free
(paren
id|urb_priv_kmem
comma
id|urb-&gt;hcpriv
)paren
suffix:semicolon
macro_line|#else
id|kfree
(paren
id|urb-&gt;hcpriv
)paren
suffix:semicolon
macro_line|#endif
id|usb_dev
op_assign
id|urb-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;unlink_urb: calling completion&quot;
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
id|urb-&gt;complete
(paren
(paren
r_struct
id|urb
op_star
)paren
id|urb
)paren
suffix:semicolon
)brace
id|usb_dec_dev_use
(paren
id|usb_dev
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
)paren
id|spin_unlock
c_func
(paren
op_amp
id|urb-&gt;lock
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// async unlink_urb completion/cleanup work
singleline_comment|// has to be protected by urb_list_lock!
singleline_comment|// features: if set in transfer_flags, the resulting status of the killed
singleline_comment|// transaction is not overwritten
DECL|function|uhci_cleanup_unlink
id|_static
r_void
id|uhci_cleanup_unlink
c_func
(paren
id|uhci_t
op_star
id|s
comma
r_int
id|force
)paren
(brace
r_struct
id|list_head
op_star
id|q
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
r_int
id|pipe
comma
id|now
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
id|q
op_assign
id|s-&gt;urb_unlinked.next
suffix:semicolon
id|now
op_assign
id|UHCI_GET_CURRENT_FRAME
c_func
(paren
id|s
)paren
suffix:semicolon
r_while
c_loop
(paren
id|q
op_ne
op_amp
id|s-&gt;urb_unlinked
)paren
(brace
id|urb
op_assign
id|list_entry
(paren
id|q
comma
id|urb_t
comma
id|urb_list
)paren
suffix:semicolon
id|urb_priv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
id|q
op_assign
id|urb-&gt;urb_list.next
suffix:semicolon
r_if
c_cond
(paren
id|force
op_logical_or
(paren
(paren
id|urb_priv-&gt;started
op_ne
l_int|0xffffffff
)paren
op_logical_and
(paren
id|urb_priv-&gt;started
op_ne
id|now
)paren
)paren
)paren
(brace
id|async_dbg
c_func
(paren
l_string|&quot;async cleanup %p&quot;
comma
id|urb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
singleline_comment|// process descriptors
r_case
id|PIPE_CONTROL
suffix:colon
id|process_transfer
(paren
id|s
comma
id|urb
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// 2: don&squot;t unlink (already done)
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;avoid_bulk.counter
)paren
id|process_transfer
(paren
id|s
comma
id|urb
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// don&squot;t unlink (already done)
r_else
r_continue
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
id|process_iso
(paren
id|s
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// force, don&squot;t unlink
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
id|process_interrupt
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_TIMEOUT_KILLED
)paren
)paren
id|urb-&gt;status
op_assign
op_minus
id|ECONNRESET
suffix:semicolon
singleline_comment|// mark as asynchronously killed
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
singleline_comment|// completion may destroy all...
id|dev
op_assign
id|urb-&gt;dev
suffix:semicolon
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
id|urb-&gt;complete
(paren
(paren
r_struct
id|urb
op_star
)paren
id|urb
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_TIMEOUT_KILLED
)paren
)paren
id|urb-&gt;status
op_assign
op_minus
id|ENOENT
suffix:semicolon
singleline_comment|// now the urb is really dead
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|pipe
)paren
)paren
(brace
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_case
id|PIPE_INTERRUPT
suffix:colon
id|uhci_clean_iso_step2
c_func
(paren
id|s
comma
id|urb_priv
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|usb_dec_dev_use
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SLAB
id|kmem_cache_free
(paren
id|urb_priv_kmem
comma
id|urb_priv
)paren
suffix:semicolon
macro_line|#else
id|kfree
(paren
id|urb_priv
)paren
suffix:semicolon
macro_line|#endif
id|list_del
(paren
op_amp
id|urb-&gt;urb_list
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// needs urb_list_lock!
DECL|function|uhci_unlink_urb_async
id|_static
r_int
id|uhci_unlink_urb_async
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_desc_t
op_star
id|qh
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
id|async_dbg
c_func
(paren
l_string|&quot;unlink_urb_async called %p&quot;
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
op_logical_or
(paren
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
op_logical_and
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|flags
)paren
)paren
(brace
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|started
op_assign
op_complement
l_int|0
suffix:semicolon
id|dequeue_urb
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|urb-&gt;urb_list
comma
op_amp
id|s-&gt;urb_unlinked
)paren
suffix:semicolon
singleline_comment|// store urb
id|uhci_switch_timer_int
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;unlink_urb_done
op_assign
l_int|1
suffix:semicolon
id|urb-&gt;status
op_assign
op_minus
id|ECONNABORTED
suffix:semicolon
singleline_comment|// mark urb as &quot;waiting to be killed&quot;&t;
id|urb_priv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_INTERRUPT
suffix:colon
id|usb_dotoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
id|uhci_clean_iso_step1
(paren
id|s
comma
id|urb_priv
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
r_case
id|PIPE_CONTROL
suffix:colon
id|qh
op_assign
id|list_entry
(paren
id|urb_priv-&gt;desc_list.next
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
id|uhci_clean_transfer
(paren
id|s
comma
id|urb
comma
id|qh
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|started
op_assign
id|UHCI_GET_CURRENT_FRAME
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
op_minus
id|EINPROGRESS
suffix:semicolon
singleline_comment|// completion will follow
)brace
r_return
l_int|0
suffix:semicolon
singleline_comment|// URB already dead
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_unlink_urb
id|_static
r_int
id|uhci_unlink_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_t
op_star
id|s
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;uhci_unlink_urb called for %p&quot;
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
op_logical_or
op_logical_neg
id|urb-&gt;dev
)paren
singleline_comment|// you never know...
r_return
op_minus
id|EINVAL
suffix:semicolon
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipedevice
(paren
id|urb-&gt;pipe
)paren
op_eq
id|s-&gt;rh.devnum
)paren
r_return
id|rh_unlink_urb
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;hcpriv
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ASYNC_UNLINK
)paren
(brace
r_int
id|ret
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
singleline_comment|// The URB needs to be locked if called outside completion context
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
)paren
id|spin_lock
c_func
(paren
op_amp
id|urb-&gt;lock
)paren
suffix:semicolon
id|uhci_release_bandwidth
c_func
(paren
id|urb
)paren
suffix:semicolon
id|ret
op_assign
id|uhci_unlink_urb_async
c_func
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
)paren
id|spin_unlock
c_func
(paren
op_amp
id|urb-&gt;lock
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_else
r_return
id|uhci_unlink_urb_sync
c_func
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// In case of ASAP iso transfer, search the URB-list for already queued URBs
singleline_comment|// for this EP and calculate the earliest start frame for the new
singleline_comment|// URB (easy seamless URB continuation!)
DECL|function|find_iso_limits
id|_static
r_int
id|find_iso_limits
(paren
id|urb_t
op_star
id|urb
comma
r_int
r_int
op_star
id|start
comma
r_int
r_int
op_star
id|end
)paren
(brace
id|urb_t
op_star
id|u
comma
op_star
id|last_urb
op_assign
l_int|NULL
suffix:semicolon
id|uhci_t
op_star
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|p
op_assign
id|s-&gt;urb_list.prev
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|p
op_ne
op_amp
id|s-&gt;urb_list
suffix:semicolon
id|p
op_assign
id|p-&gt;prev
)paren
(brace
id|u
op_assign
id|list_entry
(paren
id|p
comma
id|urb_t
comma
id|urb_list
)paren
suffix:semicolon
singleline_comment|// look for pending URBs with identical pipe handle
singleline_comment|// works only because iso doesn&squot;t toggle the data bit!
r_if
c_cond
(paren
(paren
id|urb-&gt;pipe
op_eq
id|u-&gt;pipe
)paren
op_logical_and
(paren
id|urb-&gt;dev
op_eq
id|u-&gt;dev
)paren
op_logical_and
(paren
id|u-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|last_urb
)paren
op_star
id|start
op_assign
id|u-&gt;start_frame
suffix:semicolon
id|last_urb
op_assign
id|u
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|last_urb
)paren
(brace
op_star
id|end
op_assign
(paren
id|last_urb-&gt;start_frame
op_plus
id|last_urb-&gt;number_of_packets
)paren
op_amp
l_int|1023
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// adjust start_frame according to scheduling constraints (ASAP etc)
DECL|function|iso_find_start
id|_static
r_int
id|iso_find_start
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_t
op_star
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
r_int
id|now
suffix:semicolon
r_int
r_int
id|start_limit
op_assign
l_int|0
comma
id|stop_limit
op_assign
l_int|0
comma
id|queued_size
suffix:semicolon
r_int
id|limits
suffix:semicolon
id|now
op_assign
id|UHCI_GET_CURRENT_FRAME
(paren
id|s
)paren
op_amp
l_int|1023
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|urb-&gt;number_of_packets
OG
l_int|900
)paren
r_return
op_minus
id|EFBIG
suffix:semicolon
id|limits
op_assign
id|find_iso_limits
(paren
id|urb
comma
op_amp
id|start_limit
comma
op_amp
id|stop_limit
)paren
suffix:semicolon
id|queued_size
op_assign
(paren
id|stop_limit
op_minus
id|start_limit
)paren
op_amp
l_int|1023
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_ISO_ASAP
)paren
(brace
singleline_comment|// first iso
r_if
c_cond
(paren
id|limits
)paren
(brace
singleline_comment|// 10ms setup should be enough //FIXME!
id|urb-&gt;start_frame
op_assign
(paren
id|now
op_plus
l_int|10
)paren
op_amp
l_int|1023
suffix:semicolon
)brace
r_else
(brace
id|urb-&gt;start_frame
op_assign
id|stop_limit
suffix:semicolon
singleline_comment|//seamless linkage
r_if
c_cond
(paren
(paren
(paren
id|now
op_minus
id|urb-&gt;start_frame
)paren
op_amp
l_int|1023
)paren
op_le
(paren
r_int
)paren
id|urb-&gt;number_of_packets
)paren
(brace
id|info
c_func
(paren
l_string|&quot;iso_find_start: gap in seamless isochronous scheduling&quot;
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;iso_find_start: now %u start_frame %u number_of_packets %u pipe 0x%08x&quot;
comma
id|now
comma
id|urb-&gt;start_frame
comma
id|urb-&gt;number_of_packets
comma
id|urb-&gt;pipe
)paren
suffix:semicolon
id|urb-&gt;start_frame
op_assign
(paren
id|now
op_plus
l_int|5
)paren
op_amp
l_int|1023
suffix:semicolon
singleline_comment|// 5ms setup should be enough //FIXME!
)brace
)brace
)brace
r_else
(brace
id|urb-&gt;start_frame
op_and_assign
l_int|1023
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|now
op_minus
id|urb-&gt;start_frame
)paren
op_amp
l_int|1023
)paren
OL
(paren
r_int
)paren
id|urb-&gt;number_of_packets
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;iso_find_start: now between start_frame and end&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
multiline_comment|/* check if either start_frame or start_frame+number_of_packets-1 lies between start_limit and stop_limit */
r_if
c_cond
(paren
id|limits
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|urb-&gt;start_frame
op_minus
id|start_limit
)paren
op_amp
l_int|1023
)paren
OL
id|queued_size
op_logical_or
(paren
(paren
id|urb-&gt;start_frame
op_plus
id|urb-&gt;number_of_packets
op_minus
l_int|1
op_minus
id|start_limit
)paren
op_amp
l_int|1023
)paren
OL
id|queued_size
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;iso_find_start: start_frame %u number_of_packets %u start_limit %u stop_limit %u&quot;
comma
id|urb-&gt;start_frame
comma
id|urb-&gt;number_of_packets
comma
id|start_limit
comma
id|stop_limit
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// submits USB interrupt (ie. polling ;-) 
singleline_comment|// ASAP-flag set implicitely
singleline_comment|// if period==0, the the transfer is only done once
DECL|function|uhci_submit_int_urb
id|_static
r_int
id|uhci_submit_int_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_t
op_star
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_int
id|nint
comma
id|n
comma
id|ret
suffix:semicolon
id|uhci_desc_t
op_star
id|td
suffix:semicolon
r_int
id|status
comma
id|destination
suffix:semicolon
r_int
id|info
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;interval
OL
l_int|0
op_logical_or
id|urb-&gt;interval
op_ge
l_int|256
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;interval
op_eq
l_int|0
)paren
id|nint
op_assign
l_int|0
suffix:semicolon
r_else
(brace
r_for
c_loop
(paren
id|nint
op_assign
l_int|0
comma
id|n
op_assign
l_int|1
suffix:semicolon
id|nint
op_le
l_int|8
suffix:semicolon
id|nint
op_increment
comma
id|n
op_add_assign
id|n
)paren
singleline_comment|// round interval down to 2^n
(brace
r_if
c_cond
(paren
id|urb-&gt;interval
OL
id|n
)paren
(brace
id|urb-&gt;interval
op_assign
id|n
op_div
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|nint
op_decrement
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Rounded interval to %i, chain  %i&quot;
comma
id|urb-&gt;interval
comma
id|nint
)paren
suffix:semicolon
id|urb-&gt;start_frame
op_assign
id|UHCI_GET_CURRENT_FRAME
(paren
id|s
)paren
op_amp
l_int|1023
suffix:semicolon
singleline_comment|// remember start frame, just in case...
id|urb-&gt;number_of_packets
op_assign
l_int|1
suffix:semicolon
singleline_comment|// INT allows only one packet
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer_length
OG
id|usb_maxpacket
(paren
id|urb-&gt;dev
comma
id|pipe
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ret
op_assign
id|alloc_td
(paren
op_amp
id|td
comma
id|UHCI_PTR_DEPTH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|status
op_assign
(paren
id|pipe
op_amp
id|TD_CTRL_LS
)paren
op_or
id|TD_CTRL_ACTIVE
op_or
id|TD_CTRL_IOC
op_or
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
ques
c_cond
l_int|0
suffix:colon
id|TD_CTRL_SPD
)paren
op_or
(paren
l_int|3
op_lshift
l_int|27
)paren
suffix:semicolon
id|destination
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|PIPE_DEVEP_MASK
)paren
op_or
id|usb_packetid
(paren
id|urb-&gt;pipe
)paren
op_or
(paren
(paren
(paren
id|urb-&gt;transfer_buffer_length
op_minus
l_int|1
)paren
op_amp
l_int|0x7ff
)paren
op_lshift
l_int|21
)paren
suffix:semicolon
id|info
op_assign
id|destination
op_or
(paren
id|usb_gettoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|pipe
)paren
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
op_lshift
id|TD_TOKEN_TOGGLE
)paren
suffix:semicolon
id|fill_td
(paren
id|td
comma
id|status
comma
id|info
comma
id|virt_to_bus
(paren
id|urb-&gt;transfer_buffer
)paren
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|td-&gt;desc_list
comma
op_amp
id|urb_priv-&gt;desc_list
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|queue_urb
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
id|insert_td_horizontal
(paren
id|s
comma
id|s-&gt;int_chain
(braket
id|nint
)braket
comma
id|td
)paren
suffix:semicolon
singleline_comment|// store in INT-TDs
id|usb_dotoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|pipe
)paren
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_submit_iso_urb
id|_static
r_int
id|uhci_submit_iso_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_t
op_star
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
macro_line|#ifdef ISO_SANITY_CHECK
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
r_int
id|maxsze
op_assign
id|usb_maxpacket
(paren
id|urb-&gt;dev
comma
id|pipe
comma
id|usb_pipeout
(paren
id|pipe
)paren
)paren
suffix:semicolon
macro_line|#endif
r_int
id|n
comma
id|ret
comma
id|last
op_assign
l_int|0
suffix:semicolon
id|uhci_desc_t
op_star
id|td
comma
op_star
op_star
id|tdm
suffix:semicolon
r_int
id|status
comma
id|destination
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// Disable IRQs to schedule all ISO-TDs in time
id|ret
op_assign
id|iso_find_start
(paren
id|urb
)paren
suffix:semicolon
singleline_comment|// adjusts urb-&gt;start_frame for later use
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|err
suffix:semicolon
id|tdm
op_assign
(paren
id|uhci_desc_t
op_star
op_star
)paren
id|kmalloc
(paren
id|urb-&gt;number_of_packets
op_star
r_sizeof
(paren
id|uhci_desc_t
op_star
)paren
comma
id|KMALLOC_FLAG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tdm
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
singleline_comment|// First try to get all TDs
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|n
op_increment
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;n:%d urb-&gt;iso_frame_desc[n].length:%d&quot;
comma
id|n
comma
id|urb-&gt;iso_frame_desc
(braket
id|n
)braket
dot
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;iso_frame_desc
(braket
id|n
)braket
dot
id|length
)paren
(brace
singleline_comment|// allows ISO striping by setting length to zero in iso_descriptor
id|tdm
(braket
id|n
)braket
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#ifdef ISO_SANITY_CHECK
r_if
c_cond
(paren
id|urb-&gt;iso_frame_desc
(braket
id|n
)braket
dot
id|length
OG
id|maxsze
)paren
(brace
id|err
c_func
(paren
l_string|&quot;submit_iso: urb-&gt;iso_frame_desc[%d].length(%d)&gt;%d&quot;
comma
id|n
comma
id|urb-&gt;iso_frame_desc
(braket
id|n
)braket
dot
id|length
comma
id|maxsze
)paren
suffix:semicolon
id|tdm
(braket
id|n
)braket
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
macro_line|#endif
id|ret
op_assign
id|alloc_td
(paren
op_amp
id|td
comma
id|UHCI_PTR_DEPTH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_int
id|i
suffix:semicolon
singleline_comment|// Cleanup allocated TDs
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|n
op_increment
)paren
r_if
c_cond
(paren
id|tdm
(braket
id|i
)braket
)paren
id|delete_desc
c_func
(paren
id|tdm
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|tdm
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|last
op_assign
id|n
suffix:semicolon
id|tdm
(braket
id|n
)braket
op_assign
id|td
suffix:semicolon
)brace
id|status
op_assign
id|TD_CTRL_ACTIVE
op_or
id|TD_CTRL_IOS
suffix:semicolon
singleline_comment|//| (urb-&gt;transfer_flags&amp;USB_DISABLE_SPD?0:TD_CTRL_SPD);
id|destination
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|PIPE_DEVEP_MASK
)paren
op_or
id|usb_packetid
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
singleline_comment|// Queue all allocated TDs
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|urb-&gt;number_of_packets
suffix:semicolon
id|n
op_increment
)paren
(brace
id|td
op_assign
id|tdm
(braket
id|n
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|td
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
id|last
)paren
id|status
op_or_assign
id|TD_CTRL_IOC
suffix:semicolon
id|fill_td
(paren
id|td
comma
id|status
comma
id|destination
op_or
(paren
(paren
(paren
id|urb-&gt;iso_frame_desc
(braket
id|n
)braket
dot
id|length
op_minus
l_int|1
)paren
op_amp
l_int|0x7ff
)paren
op_lshift
l_int|21
)paren
comma
id|virt_to_bus
(paren
id|urb-&gt;transfer_buffer
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|n
)braket
dot
id|offset
)paren
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|td-&gt;desc_list
comma
op_amp
id|urb_priv-&gt;desc_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
id|last
)paren
(brace
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|queue_urb
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
)brace
id|insert_td_horizontal
(paren
id|s
comma
id|s-&gt;iso_td
(braket
(paren
id|urb-&gt;start_frame
op_plus
id|n
)paren
op_amp
l_int|1023
)braket
comma
id|td
)paren
suffix:semicolon
singleline_comment|// store in iso-tds
singleline_comment|//uhci_show_td(td);
)brace
id|kfree
(paren
id|tdm
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;ISO-INT# %i, start %i, now %i&quot;
comma
id|urb-&gt;number_of_packets
comma
id|urb-&gt;start_frame
comma
id|UHCI_GET_CURRENT_FRAME
(paren
id|s
)paren
op_amp
l_int|1023
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|err
suffix:colon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
singleline_comment|// returns: 0 (no transfer queued), urb* (this urb already queued)
DECL|function|search_dev_ep
id|_static
id|urb_t
op_star
id|search_dev_ep
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|urb_t
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|mask
op_assign
id|usb_pipecontrol
c_func
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
(paren
op_complement
id|USB_DIR_IN
)paren
suffix:colon
(paren
op_complement
l_int|0
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;search_dev_ep:&quot;
)paren
suffix:semicolon
id|p
op_assign
id|s-&gt;urb_list.next
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|p
op_ne
op_amp
id|s-&gt;urb_list
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
id|tmp
op_assign
id|list_entry
(paren
id|p
comma
id|urb_t
comma
id|urb_list
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;urb: %p&quot;
comma
id|tmp
)paren
suffix:semicolon
singleline_comment|// we can accept this urb if it is not queued at this time 
singleline_comment|// or if non-iso transfer requests should be scheduled for the same device and pipe
r_if
c_cond
(paren
(paren
op_logical_neg
id|usb_pipeisoc
c_func
(paren
id|urb-&gt;pipe
)paren
op_logical_and
(paren
id|tmp-&gt;dev
op_eq
id|urb-&gt;dev
)paren
op_logical_and
op_logical_neg
(paren
(paren
id|tmp-&gt;pipe
op_xor
id|urb-&gt;pipe
)paren
op_amp
id|mask
)paren
)paren
op_logical_or
(paren
id|urb
op_eq
id|tmp
)paren
)paren
(brace
r_return
id|tmp
suffix:semicolon
singleline_comment|// found another urb already queued for processing
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|uhci_submit_urb
id|_static
r_int
id|uhci_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_t
op_star
id|s
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|urb_t
op_star
id|queued_urb
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bustime
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb-&gt;dev
op_logical_or
op_logical_neg
id|urb-&gt;dev-&gt;bus
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
singleline_comment|//dbg(&quot;submit_urb: %p type %d&quot;,urb,usb_pipetype(urb-&gt;pipe));
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;running
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipedevice
(paren
id|urb-&gt;pipe
)paren
op_eq
id|s-&gt;rh.devnum
)paren
r_return
id|rh_submit_urb
(paren
id|urb
)paren
suffix:semicolon
multiline_comment|/* virtual root hub */
id|usb_inc_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|queued_urb
op_assign
id|search_dev_ep
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
singleline_comment|// returns already queued urb for that pipe
r_if
c_cond
(paren
id|queued_urb
)paren
(brace
id|queue_dbg
c_func
(paren
l_string|&quot;found bulk urb %p&bslash;n&quot;
comma
id|queued_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
op_ne
id|PIPE_BULK
)paren
op_logical_or
(paren
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_BULK
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_QUEUE_BULK
)paren
op_logical_or
op_logical_neg
(paren
id|queued_urb-&gt;transfer_flags
op_amp
id|USB_QUEUE_BULK
)paren
)paren
)paren
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|err
c_func
(paren
l_string|&quot;ENXIO %08x, flags %x, urb %p, burb %p&quot;
comma
id|urb-&gt;pipe
comma
id|urb-&gt;transfer_flags
comma
id|urb
comma
id|queued_urb
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
singleline_comment|// urb already queued
)brace
)brace
macro_line|#ifdef DEBUG_SLAB
id|urb_priv
op_assign
id|kmem_cache_alloc
c_func
(paren
id|urb_priv_kmem
comma
id|SLAB_FLAG
)paren
suffix:semicolon
macro_line|#else
id|urb_priv
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|urb_priv_t
)paren
comma
id|KMALLOC_FLAG
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|urb_priv
)paren
(brace
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|urb-&gt;hcpriv
op_assign
id|urb_priv
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|urb_priv-&gt;desc_list
)paren
suffix:semicolon
id|urb_priv-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;submit_urb: scheduling %p&quot;
comma
id|urb
)paren
suffix:semicolon
id|urb_priv-&gt;next_queued_urb
op_assign
l_int|NULL
suffix:semicolon
id|urb_priv-&gt;prev_queued_urb
op_assign
l_int|NULL
suffix:semicolon
id|urb_priv-&gt;bottom_qh
op_assign
l_int|NULL
suffix:semicolon
id|urb_priv-&gt;next_qh
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_BULK
)paren
(brace
r_if
c_cond
(paren
id|queued_urb
)paren
(brace
r_while
c_loop
(paren
(paren
(paren
id|urb_priv_t
op_star
)paren
id|queued_urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|next_queued_urb
)paren
singleline_comment|// find last queued bulk
id|queued_urb
op_assign
(paren
(paren
id|urb_priv_t
op_star
)paren
id|queued_urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|next_queued_urb
suffix:semicolon
(paren
(paren
id|urb_priv_t
op_star
)paren
id|queued_urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|next_queued_urb
op_assign
id|urb
suffix:semicolon
)brace
id|atomic_inc
(paren
op_amp
id|s-&gt;avoid_bulk
)paren
suffix:semicolon
id|ret
op_assign
id|uhci_submit_bulk_urb
(paren
id|urb
comma
id|queued_urb
)paren
suffix:semicolon
id|atomic_dec
(paren
op_amp
id|s-&gt;avoid_bulk
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;bandwidth
op_eq
l_int|0
)paren
(brace
multiline_comment|/* not yet checked/allocated */
r_if
c_cond
(paren
id|urb-&gt;number_of_packets
op_le
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|bustime
op_assign
id|usb_check_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bustime
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|bustime
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ret
op_assign
id|uhci_submit_iso_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|usb_claim_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
id|bustime
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* bandwidth is already set */
id|ret
op_assign
id|uhci_submit_iso_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;bandwidth
op_eq
l_int|0
)paren
(brace
multiline_comment|/* not yet checked/allocated */
id|bustime
op_assign
id|usb_check_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bustime
OL
l_int|0
)paren
id|ret
op_assign
id|bustime
suffix:semicolon
r_else
(brace
id|ret
op_assign
id|uhci_submit_int_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|usb_claim_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
id|bustime
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* bandwidth is already set */
id|ret
op_assign
id|uhci_submit_int_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PIPE_CONTROL
suffix:colon
id|ret
op_assign
id|uhci_submit_control_urb
(paren
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;submit_urb: scheduled with ret: %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|usb_dec_dev_use
(paren
id|urb-&gt;dev
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SLAB
id|kmem_cache_free
c_func
(paren
id|urb_priv_kmem
comma
id|urb_priv
)paren
suffix:semicolon
macro_line|#else
id|kfree
(paren
id|urb_priv
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// Checks for URB timeout and removes bandwidth reclamation 
singleline_comment|// if URB idles too long
DECL|function|uhci_check_timeouts
id|_static
r_void
id|uhci_check_timeouts
c_func
(paren
id|uhci_t
op_star
id|s
)paren
(brace
r_struct
id|list_head
op_star
id|p
comma
op_star
id|p2
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
r_int
id|type
suffix:semicolon
id|p
op_assign
id|s-&gt;urb_list.prev
suffix:semicolon
r_while
c_loop
(paren
id|p
op_ne
op_amp
id|s-&gt;urb_list
)paren
(brace
id|urb_priv_t
op_star
id|hcpriv
suffix:semicolon
id|p2
op_assign
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;prev
suffix:semicolon
id|urb
op_assign
id|list_entry
(paren
id|p2
comma
id|urb_t
comma
id|urb_list
)paren
suffix:semicolon
id|type
op_assign
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
suffix:semicolon
id|hcpriv
op_assign
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;timeout
op_logical_and
(paren
(paren
id|hcpriv-&gt;started
op_plus
id|urb-&gt;timeout
)paren
OL
id|jiffies
)paren
)paren
(brace
id|urb-&gt;transfer_flags
op_or_assign
id|USB_TIMEOUT_KILLED
op_or
id|USB_ASYNC_UNLINK
suffix:semicolon
id|async_dbg
c_func
(paren
l_string|&quot;uhci_check_timeout: timeout for %p&quot;
comma
id|urb
)paren
suffix:semicolon
id|uhci_unlink_urb_async
c_func
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_USB_UHCI_HIGH_BANDWIDTH
r_else
r_if
c_cond
(paren
(paren
(paren
id|type
op_eq
id|PIPE_BULK
)paren
op_logical_or
(paren
id|type
op_eq
id|PIPE_CONTROL
)paren
)paren
op_logical_and
(paren
id|hcpriv-&gt;use_loop
)paren
op_logical_and
(paren
(paren
id|hcpriv-&gt;started
op_plus
id|IDLE_TIMEOUT
)paren
OL
id|jiffies
)paren
)paren
id|disable_desc_loop
c_func
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
macro_line|#endif
)brace
id|s-&gt;timeout_check
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------&n; Virtual Root Hub&n; -------------------------------------------------------------------*/
DECL|variable|root_hub_dev_des
id|_static
id|__u8
id|root_hub_dev_des
(braket
)braket
op_assign
(brace
l_int|0x12
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x01
comma
multiline_comment|/*  __u8  bDescriptorType; Device */
l_int|0x00
comma
multiline_comment|/*  __u16 bcdUSB; v1.0 */
l_int|0x01
comma
l_int|0x09
comma
multiline_comment|/*  __u8  bDeviceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  bDeviceProtocol; */
l_int|0x08
comma
multiline_comment|/*  __u8  bMaxPacketSize0; 8 Bytes */
l_int|0x00
comma
multiline_comment|/*  __u16 idVendor; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 idProduct; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u16 bcdDevice; */
l_int|0x00
comma
l_int|0x00
comma
multiline_comment|/*  __u8  iManufacturer; */
l_int|0x02
comma
multiline_comment|/*  __u8  iProduct; */
l_int|0x01
comma
multiline_comment|/*  __u8  iSerialNumber; */
l_int|0x01
multiline_comment|/*  __u8  bNumConfigurations; */
)brace
suffix:semicolon
multiline_comment|/* Configuration descriptor */
DECL|variable|root_hub_config_des
id|_static
id|__u8
id|root_hub_config_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x02
comma
multiline_comment|/*  __u8  bDescriptorType; Configuration */
l_int|0x19
comma
multiline_comment|/*  __u16 wTotalLength; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bNumInterfaces; */
l_int|0x01
comma
multiline_comment|/*  __u8  bConfigurationValue; */
l_int|0x00
comma
multiline_comment|/*  __u8  iConfiguration; */
l_int|0x40
comma
multiline_comment|/*  __u8  bmAttributes; &n;&t;&t;&t;&t;   Bit 7: Bus-powered, 6: Self-powered, 5 Remote-wakwup, 4..0: resvd */
l_int|0x00
comma
multiline_comment|/*  __u8  MaxPower; */
multiline_comment|/* interface */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bLength; */
l_int|0x04
comma
multiline_comment|/*  __u8  if_bDescriptorType; Interface */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceNumber; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bAlternateSetting; */
l_int|0x01
comma
multiline_comment|/*  __u8  if_bNumEndpoints; */
l_int|0x09
comma
multiline_comment|/*  __u8  if_bInterfaceClass; HUB_CLASSCODE */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceSubClass; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_bInterfaceProtocol; */
l_int|0x00
comma
multiline_comment|/*  __u8  if_iInterface; */
multiline_comment|/* endpoint */
l_int|0x07
comma
multiline_comment|/*  __u8  ep_bLength; */
l_int|0x05
comma
multiline_comment|/*  __u8  ep_bDescriptorType; Endpoint */
l_int|0x81
comma
multiline_comment|/*  __u8  ep_bEndpointAddress; IN Endpoint 1 */
l_int|0x03
comma
multiline_comment|/*  __u8  ep_bmAttributes; Interrupt */
l_int|0x08
comma
multiline_comment|/*  __u16 ep_wMaxPacketSize; 8 Bytes */
l_int|0x00
comma
l_int|0xff
multiline_comment|/*  __u8  ep_bInterval; 255 ms */
)brace
suffix:semicolon
DECL|variable|root_hub_hub_des
id|_static
id|__u8
id|root_hub_hub_des
(braket
)braket
op_assign
(brace
l_int|0x09
comma
multiline_comment|/*  __u8  bLength; */
l_int|0x29
comma
multiline_comment|/*  __u8  bDescriptorType; Hub-descriptor */
l_int|0x02
comma
multiline_comment|/*  __u8  bNbrPorts; */
l_int|0x00
comma
multiline_comment|/* __u16  wHubCharacteristics; */
l_int|0x00
comma
l_int|0x01
comma
multiline_comment|/*  __u8  bPwrOn2pwrGood; 2ms */
l_int|0x00
comma
multiline_comment|/*  __u8  bHubContrCurrent; 0 mA */
l_int|0x00
comma
multiline_comment|/*  __u8  DeviceRemovable; *** 7 Ports max *** */
l_int|0xff
multiline_comment|/*  __u8  PortPwrCtrlMask; *** 7 ports max *** */
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* prepare Interrupt pipe transaction data; HUB INTERRUPT ENDPOINT */
DECL|function|rh_send_irq
id|_static
r_int
id|rh_send_irq
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_int
id|len
op_assign
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|uhci_t
op_star
id|uhci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
id|__u16
id|data
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uhci-&gt;rh.numports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data
op_or_assign
(paren
(paren
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC1
op_plus
id|i
op_star
l_int|2
)paren
op_amp
l_int|0xa
)paren
OG
l_int|0
ques
c_cond
(paren
l_int|1
op_lshift
(paren
id|i
op_plus
l_int|1
)paren
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|len
op_assign
(paren
id|i
op_plus
l_int|1
)paren
op_div
l_int|8
op_plus
l_int|1
suffix:semicolon
)brace
op_star
(paren
id|__u16
op_star
)paren
id|urb-&gt;transfer_buffer
op_assign
id|cpu_to_le16
(paren
id|data
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
id|urb-&gt;status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
OG
l_int|0
)paren
op_logical_and
(paren
id|uhci-&gt;rh.send
op_ne
l_int|0
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Root-Hub INT complete: port1: %x port2: %x data: %x&quot;
comma
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC1
)paren
comma
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC2
)paren
comma
id|data
)paren
suffix:semicolon
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Virtual Root Hub INTs are polled by this timer every &quot;intervall&quot; ms */
id|_static
r_int
id|rh_init_int_timer
(paren
id|urb_t
op_star
id|urb
)paren
suffix:semicolon
DECL|function|rh_int_timer_do
id|_static
r_void
id|rh_int_timer_do
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
id|len
suffix:semicolon
id|urb_t
op_star
id|urb
op_assign
(paren
id|urb_t
op_star
)paren
id|ptr
suffix:semicolon
id|uhci_t
op_star
id|uhci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;rh.send
)paren
(brace
id|len
op_assign
id|rh_send_irq
(paren
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
)brace
)brace
id|rh_init_int_timer
(paren
id|urb
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/* Root Hub INTs are polled by this timer, polling interval 20ms */
multiline_comment|/* This time is also used for URB-timeout checking */
DECL|function|rh_init_int_timer
id|_static
r_int
id|rh_init_int_timer
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_t
op_star
id|uhci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|uhci-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|init_timer
(paren
op_amp
id|uhci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
id|uhci-&gt;rh.rh_int_timer.function
op_assign
id|rh_int_timer_do
suffix:semicolon
id|uhci-&gt;rh.rh_int_timer.data
op_assign
(paren
r_int
r_int
)paren
id|urb
suffix:semicolon
id|uhci-&gt;rh.rh_int_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|20
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
(paren
op_amp
id|uhci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|macro|OK
mdefine_line|#define OK(x) &t;&t;&t;len = (x); break
DECL|macro|CLR_RH_PORTSTAT
mdefine_line|#define CLR_RH_PORTSTAT(x) &bslash;&n;&t;&t;status = inw(io_addr+USBPORTSC1+2*(wIndex-1)); &bslash;&n;&t;&t;status = (status &amp; 0xfff5) &amp; ~(x); &bslash;&n;&t;&t;outw(status, io_addr+USBPORTSC1+2*(wIndex-1))
DECL|macro|SET_RH_PORTSTAT
mdefine_line|#define SET_RH_PORTSTAT(x) &bslash;&n;&t;&t;status = inw(io_addr+USBPORTSC1+2*(wIndex-1)); &bslash;&n;&t;&t;status = (status &amp; 0xfff5) | (x); &bslash;&n;&t;&t;outw(status, io_addr+USBPORTSC1+2*(wIndex-1))
multiline_comment|/*-------------------------------------------------------------------------*/
multiline_comment|/****&n; ** Root Hub Control Pipe&n; *************************/
DECL|function|rh_submit_urb
id|_static
r_int
id|rh_submit_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
r_struct
id|usb_device
op_star
id|usb_dev
op_assign
id|urb-&gt;dev
suffix:semicolon
id|uhci_t
op_star
id|uhci
op_assign
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_int
r_int
id|pipe
op_assign
id|urb-&gt;pipe
suffix:semicolon
id|devrequest
op_star
id|cmd
op_assign
(paren
id|devrequest
op_star
)paren
id|urb-&gt;setup_packet
suffix:semicolon
r_void
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|leni
op_assign
id|urb-&gt;transfer_buffer_length
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|stat
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|io_addr
op_assign
id|uhci-&gt;io_addr
suffix:semicolon
id|__u16
id|cstatus
suffix:semicolon
id|__u16
id|bmRType_bReq
suffix:semicolon
id|__u16
id|wValue
suffix:semicolon
id|__u16
id|wIndex
suffix:semicolon
id|__u16
id|wLength
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipetype
(paren
id|pipe
)paren
op_eq
id|PIPE_INTERRUPT
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Root-Hub submit IRQ: every %d ms&quot;
comma
id|urb-&gt;interval
)paren
suffix:semicolon
id|uhci-&gt;rh.urb
op_assign
id|urb
suffix:semicolon
id|uhci-&gt;rh.send
op_assign
l_int|1
suffix:semicolon
id|uhci-&gt;rh.interval
op_assign
id|urb-&gt;interval
suffix:semicolon
id|rh_init_int_timer
(paren
id|urb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bmRType_bReq
op_assign
id|cmd-&gt;requesttype
op_or
id|cmd-&gt;request
op_lshift
l_int|8
suffix:semicolon
id|wValue
op_assign
id|le16_to_cpu
(paren
id|cmd-&gt;value
)paren
suffix:semicolon
id|wIndex
op_assign
id|le16_to_cpu
(paren
id|cmd-&gt;index
)paren
suffix:semicolon
id|wLength
op_assign
id|le16_to_cpu
(paren
id|cmd-&gt;length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|uhci-&gt;rh.c_p_r
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;Root-Hub: adr: %2x cmd(%1x): %04x %04x %04x %04x&quot;
comma
id|uhci-&gt;rh.devnum
comma
l_int|8
comma
id|bmRType_bReq
comma
id|wValue
comma
id|wIndex
comma
id|wLength
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|bmRType_bReq
)paren
(brace
multiline_comment|/* Request Destination:&n;&t;&t;   without flags: Device, &n;&t;&t;   RH_INTERFACE: interface, &n;&t;&t;   RH_ENDPOINT: endpoint,&n;&t;&t;   RH_CLASS means HUB here, &n;&t;&t;   RH_OTHER | RH_CLASS  almost ever means HUB_PORT here &n;&t;&t; */
r_case
id|RH_GET_STATUS
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
(paren
l_int|1
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_INTERFACE
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_ENDPOINT
suffix:colon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|2
)paren
suffix:semicolon
r_case
id|RH_GET_STATUS
op_or
id|RH_CLASS
suffix:colon
op_star
(paren
id|__u32
op_star
)paren
id|data
op_assign
id|cpu_to_le32
(paren
l_int|0
)paren
suffix:semicolon
id|OK
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* hub power ** */
r_case
id|RH_GET_STATUS
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
id|status
op_assign
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC1
op_plus
l_int|2
op_star
(paren
id|wIndex
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|cstatus
op_assign
(paren
(paren
id|status
op_amp
id|USBPORTSC_CSC
)paren
op_rshift
(paren
l_int|1
op_minus
l_int|0
)paren
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_PEC
)paren
op_rshift
(paren
l_int|3
op_minus
l_int|1
)paren
)paren
op_or
(paren
id|uhci-&gt;rh.c_p_r
(braket
id|wIndex
op_minus
l_int|1
)braket
op_lshift
(paren
l_int|0
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|status
op_assign
(paren
id|status
op_amp
id|USBPORTSC_CCS
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_PE
)paren
op_rshift
(paren
l_int|2
op_minus
l_int|1
)paren
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_SUSP
)paren
op_rshift
(paren
l_int|12
op_minus
l_int|2
)paren
)paren
op_or
(paren
(paren
id|status
op_amp
id|USBPORTSC_PR
)paren
op_rshift
(paren
l_int|9
op_minus
l_int|4
)paren
)paren
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
multiline_comment|/* power on ** */
(paren
(paren
id|status
op_amp
id|USBPORTSC_LSDA
)paren
op_lshift
(paren
op_minus
l_int|8
op_plus
l_int|9
)paren
)paren
suffix:semicolon
op_star
(paren
id|__u16
op_star
)paren
id|data
op_assign
id|cpu_to_le16
(paren
id|status
)paren
suffix:semicolon
op_star
(paren
id|__u16
op_star
)paren
(paren
id|data
op_plus
l_int|2
)paren
op_assign
id|cpu_to_le16
(paren
id|cstatus
)paren
suffix:semicolon
id|OK
(paren
l_int|4
)paren
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_ENDPOINT
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_ENDPOINT_STALL
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_C_HUB_OVER_CURRENT
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* hub power over current ** */
)brace
r_break
suffix:semicolon
r_case
id|RH_CLEAR_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
id|CLR_RH_PORTSTAT
(paren
id|USBPORTSC_PE
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|CLR_RH_PORTSTAT
(paren
id|USBPORTSC_SUSP
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* port power ** */
r_case
(paren
id|RH_C_PORT_CONNECTION
)paren
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_CSC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_ENABLE
)paren
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_PEC
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_SUSPEND
)paren
suffix:colon
multiline_comment|/*** WR_RH_PORTSTAT(RH_PS_PSSC); */
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_C_PORT_OVER_CURRENT
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* port power over current ** */
r_case
(paren
id|RH_C_PORT_RESET
)paren
suffix:colon
id|uhci-&gt;rh.c_p_r
(braket
id|wIndex
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_FEATURE
op_or
id|RH_OTHER
op_or
id|RH_CLASS
suffix:colon
r_switch
c_cond
(paren
id|wValue
)paren
(brace
r_case
(paren
id|RH_PORT_SUSPEND
)paren
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_SUSP
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_RESET
)paren
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_PR
)paren
suffix:semicolon
id|uhci_wait_ms
(paren
l_int|10
)paren
suffix:semicolon
id|uhci-&gt;rh.c_p_r
(braket
id|wIndex
op_minus
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|CLR_RH_PORTSTAT
(paren
id|USBPORTSC_PR
)paren
suffix:semicolon
id|udelay
(paren
l_int|10
)paren
suffix:semicolon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_PE
)paren
suffix:semicolon
id|uhci_wait_ms
(paren
l_int|10
)paren
suffix:semicolon
id|SET_RH_PORTSTAT
(paren
l_int|0xa
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
(paren
id|RH_PORT_POWER
)paren
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* port power ** */
r_case
(paren
id|RH_PORT_ENABLE
)paren
suffix:colon
id|SET_RH_PORTSTAT
(paren
id|USBPORTSC_PE
)paren
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_SET_ADDRESS
suffix:colon
id|uhci-&gt;rh.devnum
op_assign
id|wValue
suffix:semicolon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
suffix:colon
r_switch
c_cond
(paren
(paren
id|wValue
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
)paren
(brace
r_case
(paren
l_int|0x01
)paren
suffix:colon
multiline_comment|/* device descriptor */
id|len
op_assign
id|min
(paren
id|leni
comma
id|min
(paren
r_sizeof
(paren
id|root_hub_dev_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|data
comma
id|root_hub_dev_des
comma
id|len
)paren
suffix:semicolon
id|OK
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x02
)paren
suffix:colon
multiline_comment|/* configuration descriptor */
id|len
op_assign
id|min
(paren
id|leni
comma
id|min
(paren
r_sizeof
(paren
id|root_hub_config_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|data
comma
id|root_hub_config_des
comma
id|len
)paren
suffix:semicolon
id|OK
(paren
id|len
)paren
suffix:semicolon
r_case
(paren
l_int|0x03
)paren
suffix:colon
multiline_comment|/* string descriptors */
id|len
op_assign
id|usb_root_hub_string
(paren
id|wValue
op_amp
l_int|0xff
comma
id|uhci-&gt;io_addr
comma
l_string|&quot;UHCI&quot;
comma
id|data
comma
id|wLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|OK
(paren
id|min
(paren
id|leni
comma
id|len
)paren
)paren
suffix:semicolon
)brace
r_else
id|stat
op_assign
op_minus
id|EPIPE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RH_GET_DESCRIPTOR
op_or
id|RH_CLASS
suffix:colon
id|root_hub_hub_des
(braket
l_int|2
)braket
op_assign
id|uhci-&gt;rh.numports
suffix:semicolon
id|len
op_assign
id|min
(paren
id|leni
comma
id|min
(paren
r_sizeof
(paren
id|root_hub_hub_des
)paren
comma
id|wLength
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|data
comma
id|root_hub_hub_des
comma
id|len
)paren
suffix:semicolon
id|OK
(paren
id|len
)paren
suffix:semicolon
r_case
id|RH_GET_CONFIGURATION
suffix:colon
op_star
(paren
id|__u8
op_star
)paren
id|data
op_assign
l_int|0x01
suffix:semicolon
id|OK
(paren
l_int|1
)paren
suffix:semicolon
r_case
id|RH_SET_CONFIGURATION
suffix:colon
id|OK
(paren
l_int|0
)paren
suffix:semicolon
r_default
suffix:colon
id|stat
op_assign
op_minus
id|EPIPE
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;Root-Hub stat port1: %x port2: %x&quot;
comma
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC1
)paren
comma
id|inw
(paren
id|io_addr
op_plus
id|USBPORTSC2
)paren
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_assign
id|len
suffix:semicolon
id|urb-&gt;status
op_assign
id|stat
suffix:semicolon
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
id|urb-&gt;complete
(paren
id|urb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|rh_unlink_urb
id|_static
r_int
id|rh_unlink_urb
(paren
id|urb_t
op_star
id|urb
)paren
(brace
id|uhci_t
op_star
id|uhci
op_assign
id|urb-&gt;dev-&gt;bus-&gt;hcpriv
suffix:semicolon
r_if
c_cond
(paren
id|uhci-&gt;rh.urb
op_eq
id|urb
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Root-Hub unlink IRQ&quot;
)paren
suffix:semicolon
id|uhci-&gt;rh.send
op_assign
l_int|0
suffix:semicolon
id|del_timer
(paren
op_amp
id|uhci-&gt;rh.rh_int_timer
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
multiline_comment|/*&n; * Map status to standard result codes&n; *&n; * &lt;status&gt; is (td-&gt;status &amp; 0xFE0000) [a.k.a. uhci_status_bits(td-&gt;status)&n; * &lt;dir_out&gt; is True for output TDs and False for input TDs.&n; */
DECL|function|uhci_map_status
id|_static
r_int
id|uhci_map_status
(paren
r_int
id|status
comma
r_int
id|dir_out
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_BITSTUFF
)paren
multiline_comment|/* Bitstuff error */
r_return
op_minus
id|EPROTO
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_CRCTIMEO
)paren
(brace
multiline_comment|/* CRC/Timeout */
r_if
c_cond
(paren
id|dir_out
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_else
r_return
op_minus
id|EILSEQ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_NAK
)paren
multiline_comment|/* NAK */
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_BABBLE
)paren
multiline_comment|/* Babble */
r_return
op_minus
id|EPIPE
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_DBUFERR
)paren
multiline_comment|/* Buffer error */
r_return
op_minus
id|ENOSR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_STALLED
)paren
multiline_comment|/* Stalled */
r_return
op_minus
id|EPIPE
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|TD_CTRL_ACTIVE
)paren
multiline_comment|/* Active */
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|EPROTO
suffix:semicolon
)brace
multiline_comment|/*&n; * Only the USB core should call uhci_alloc_dev and uhci_free_dev&n; */
DECL|function|uhci_alloc_dev
id|_static
r_int
id|uhci_alloc_dev
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uhci_unlink_urbs
id|_static
r_void
id|uhci_unlink_urbs
c_func
(paren
id|uhci_t
op_star
id|s
comma
r_struct
id|usb_device
op_star
id|usb_dev
comma
r_int
id|remove_all
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|list_head
op_star
id|p2
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|p
op_assign
id|s-&gt;urb_list.prev
suffix:semicolon
r_while
c_loop
(paren
id|p
op_ne
op_amp
id|s-&gt;urb_list
)paren
(brace
id|p2
op_assign
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;prev
suffix:semicolon
id|urb
op_assign
id|list_entry
(paren
id|p2
comma
id|urb_t
comma
id|urb_list
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;urb: %p, dev %p, %p&quot;
comma
id|urb
comma
id|usb_dev
comma
id|urb-&gt;dev
)paren
suffix:semicolon
singleline_comment|//urb-&gt;transfer_flags |=USB_ASYNC_UNLINK; 
r_if
c_cond
(paren
id|remove_all
op_logical_or
(paren
id|usb_dev
op_eq
id|urb-&gt;dev
)paren
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|warn
c_func
(paren
l_string|&quot;forced removing of queued URB %p due to disconnect&quot;
comma
id|urb
)paren
suffix:semicolon
id|uhci_unlink_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// avoid further processing of this UR
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
id|p
op_assign
id|s-&gt;urb_list.prev
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;urb_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|uhci_free_dev
id|_static
r_int
id|uhci_free_dev
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
id|uhci_t
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_dev
op_logical_or
op_logical_neg
id|usb_dev-&gt;bus
op_logical_or
op_logical_neg
id|usb_dev-&gt;bus-&gt;hcpriv
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|usb_dev-&gt;bus-&gt;hcpriv
suffix:semicolon
id|uhci_unlink_urbs
c_func
(paren
id|s
comma
id|usb_dev
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * uhci_get_current_frame_number()&n; *&n; * returns the current frame number for a USB bus/controller.&n; */
DECL|function|uhci_get_current_frame_number
id|_static
r_int
id|uhci_get_current_frame_number
(paren
r_struct
id|usb_device
op_star
id|usb_dev
)paren
(brace
r_return
id|UHCI_GET_CURRENT_FRAME
(paren
(paren
id|uhci_t
op_star
)paren
id|usb_dev-&gt;bus-&gt;hcpriv
)paren
suffix:semicolon
)brace
DECL|variable|uhci_device_operations
r_struct
id|usb_operations
id|uhci_device_operations
op_assign
(brace
id|uhci_alloc_dev
comma
id|uhci_free_dev
comma
id|uhci_get_current_frame_number
comma
id|uhci_submit_urb
comma
id|uhci_unlink_urb
)brace
suffix:semicolon
multiline_comment|/* &n; * For IN-control transfers, process_transfer gets a bit more complicated,&n; * since there are devices that return less data (eg. strings) than they&n; * have announced. This leads to a queue abort due to the short packet,&n; * the status stage is not executed. If this happens, the status stage&n; * is manually re-executed.&n; * mode: 1: regular (unlink QH), 2: QHs already unlinked (for async unlink_urb)&n; */
DECL|function|process_transfer
id|_static
r_int
id|process_transfer
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
comma
r_int
id|mode
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|list_head
op_star
id|qhl
op_assign
id|urb_priv-&gt;desc_list.next
suffix:semicolon
id|uhci_desc_t
op_star
id|qh
op_assign
id|list_entry
(paren
id|qhl
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|p
op_assign
id|qh-&gt;vertical.next
suffix:semicolon
id|uhci_desc_t
op_star
id|desc
op_assign
id|list_entry
(paren
id|urb_priv-&gt;desc_list.prev
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
id|uhci_desc_t
op_star
id|last_desc
op_assign
id|list_entry
(paren
id|desc-&gt;vertical.prev
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
r_int
id|data_toggle
op_assign
id|usb_gettoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
singleline_comment|// save initial data_toggle
r_int
id|maxlength
suffix:semicolon
singleline_comment|// extracted and remapped info from TD
r_int
id|actual_length
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
singleline_comment|//dbg(&quot;process_transfer: urb %p, urb_priv %p, qh %p last_desc %p&bslash;n&quot;,urb,urb_priv, qh, last_desc);
multiline_comment|/* if the status phase has been retriggered and the&n;&t;   queue is empty or the last status-TD is inactive, the retriggered&n;&t;   status stage is completed&n;&t; */
r_if
c_cond
(paren
id|urb_priv-&gt;flags
op_logical_and
(paren
(paren
id|qh-&gt;hw.qh.element
op_eq
id|UHCI_PTR_TERM
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|last_desc-&gt;hw.td.status
op_amp
id|TD_CTRL_ACTIVE
)paren
)paren
)paren
)paren
r_goto
id|transfer_finished
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|p
op_ne
op_amp
id|qh-&gt;vertical
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
id|desc
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|vertical
)paren
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;hw.td.status
op_amp
id|TD_CTRL_ACTIVE
)paren
singleline_comment|// do not process active TDs
r_return
id|ret
suffix:semicolon
id|actual_length
op_assign
(paren
id|desc-&gt;hw.td.status
op_plus
l_int|1
)paren
op_amp
l_int|0x7ff
suffix:semicolon
singleline_comment|// extract transfer parameters from TD
id|maxlength
op_assign
(paren
(paren
(paren
id|desc-&gt;hw.td.info
op_rshift
l_int|21
)paren
op_amp
l_int|0x7ff
)paren
op_plus
l_int|1
)paren
op_amp
l_int|0x7ff
suffix:semicolon
id|status
op_assign
id|uhci_map_status
(paren
id|uhci_status_bits
(paren
id|desc-&gt;hw.td.status
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|EPIPE
)paren
(brace
singleline_comment|// see if EP is stalled
singleline_comment|// set up stalled condition
id|usb_endpoint_halt
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_logical_and
(paren
id|status
op_ne
op_minus
id|EPIPE
)paren
)paren
(brace
singleline_comment|// if any error occurred stop processing of further TDs
singleline_comment|// only set ret if status returned an error
id|is_error
suffix:colon
id|ret
op_assign
id|status
suffix:semicolon
id|urb-&gt;error_count
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|desc-&gt;hw.td.info
op_amp
l_int|0xff
)paren
op_ne
id|USB_PID_SETUP
)paren
id|urb-&gt;actual_length
op_add_assign
id|actual_length
suffix:semicolon
singleline_comment|// got less data than requested
r_if
c_cond
(paren
(paren
id|actual_length
OL
id|maxlength
)paren
)paren
(brace
r_if
c_cond
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
)paren
(brace
id|status
op_assign
op_minus
id|EREMOTEIO
suffix:semicolon
singleline_comment|// treat as real error
id|dbg
c_func
(paren
l_string|&quot;process_transfer: SPD!!&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// exit after this TD because SP was detected
)brace
singleline_comment|// short read during control-IN: re-start status stage
r_if
c_cond
(paren
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_CONTROL
)paren
)paren
(brace
r_if
c_cond
(paren
id|uhci_packetid
c_func
(paren
id|last_desc-&gt;hw.td.info
)paren
op_eq
id|USB_PID_OUT
)paren
(brace
id|qh-&gt;hw.qh.element
op_assign
id|virt_to_bus
(paren
id|last_desc
)paren
suffix:semicolon
singleline_comment|// re-trigger status stage
id|dbg
c_func
(paren
l_string|&quot;short packet during control transfer, retrigger status stage @ %p&quot;
comma
id|last_desc
)paren
suffix:semicolon
singleline_comment|//uhci_show_td (desc);
singleline_comment|//uhci_show_td (last_desc);
id|urb_priv-&gt;flags
op_assign
l_int|1
suffix:semicolon
singleline_comment|// mark as short control packet
r_return
l_int|0
suffix:semicolon
)brace
)brace
singleline_comment|// all other cases: short read is OK
id|data_toggle
op_assign
id|uhci_toggle
(paren
id|desc-&gt;hw.td.info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
)paren
r_goto
id|is_error
suffix:semicolon
id|data_toggle
op_assign
id|uhci_toggle
(paren
id|desc-&gt;hw.td.info
)paren
suffix:semicolon
id|queue_dbg
c_func
(paren
l_string|&quot;process_transfer: len:%d status:%x mapped:%x toggle:%d&quot;
comma
id|actual_length
comma
id|desc-&gt;hw.td.status
comma
id|status
comma
id|data_toggle
)paren
suffix:semicolon
)brace
id|usb_settoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
comma
op_logical_neg
id|data_toggle
)paren
suffix:semicolon
id|transfer_finished
suffix:colon
id|uhci_clean_transfer
c_func
(paren
id|s
comma
id|urb
comma
id|qh
comma
id|mode
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
id|status
suffix:semicolon
macro_line|#ifdef CONFIG_USB_UHCI_HIGH_BANDWIDTH&t;
id|disable_desc_loop
c_func
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
macro_line|#endif&t;
id|queue_dbg
c_func
(paren
l_string|&quot;process_transfer: (end) urb %p, wanted len %d, len %d status %x err %d&quot;
comma
id|urb
comma
id|urb-&gt;transfer_buffer_length
comma
id|urb-&gt;actual_length
comma
id|urb-&gt;status
comma
id|urb-&gt;error_count
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|process_interrupt
id|_static
r_int
id|process_interrupt
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|list_head
op_star
id|p
op_assign
id|urb_priv-&gt;desc_list.next
suffix:semicolon
id|uhci_desc_t
op_star
id|desc
op_assign
id|list_entry
(paren
id|urb_priv-&gt;desc_list.prev
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
r_int
id|actual_length
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
singleline_comment|//dbg(&quot;urb contains interrupt request&quot;);
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|p
op_ne
op_amp
id|urb_priv-&gt;desc_list
suffix:semicolon
id|p
op_assign
id|p-&gt;next
comma
id|i
op_increment
)paren
singleline_comment|// Maybe we allow more than one TD later ;-)
(brace
id|desc
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;hw.td.status
op_amp
id|TD_CTRL_ACTIVE
)paren
(brace
singleline_comment|// do not process active TDs
singleline_comment|//dbg(&quot;TD ACT Status @%p %08x&quot;,desc,desc-&gt;hw.td.status);
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|desc-&gt;hw.td.status
op_amp
id|TD_CTRL_IOC
)paren
(brace
singleline_comment|// do not process one-shot TDs, no recycling
r_break
suffix:semicolon
)brace
singleline_comment|// extract transfer parameters from TD
id|actual_length
op_assign
(paren
id|desc-&gt;hw.td.status
op_plus
l_int|1
)paren
op_amp
l_int|0x7ff
suffix:semicolon
id|status
op_assign
id|uhci_map_status
(paren
id|uhci_status_bits
(paren
id|desc-&gt;hw.td.status
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
singleline_comment|// see if EP is stalled
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|EPIPE
)paren
(brace
singleline_comment|// set up stalled condition
id|usb_endpoint_halt
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
)brace
singleline_comment|// if any error occured: ignore this td, and continue
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
singleline_comment|//uhci_show_td (desc);
id|urb-&gt;error_count
op_increment
suffix:semicolon
r_goto
id|recycle
suffix:semicolon
)brace
r_else
id|urb-&gt;actual_length
op_assign
id|actual_length
suffix:semicolon
id|recycle
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
(brace
singleline_comment|//dbg(&quot;process_interrupt: calling completion, status %i&quot;,status);
id|urb-&gt;status
op_assign
id|status
suffix:semicolon
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|flags
op_assign
l_int|1
suffix:semicolon
singleline_comment|// if unlink_urb is called during completion
id|spin_unlock
c_func
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
id|urb-&gt;complete
(paren
(paren
r_struct
id|urb
op_star
)paren
id|urb
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|flags
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|urb-&gt;status
op_ne
op_minus
id|ECONNABORTED
)paren
op_logical_and
(paren
id|urb-&gt;status
op_ne
id|ECONNRESET
)paren
op_logical_and
(paren
id|urb-&gt;status
op_ne
op_minus
id|ENOENT
)paren
)paren
(brace
id|urb-&gt;status
op_assign
op_minus
id|EINPROGRESS
suffix:semicolon
singleline_comment|// Recycle INT-TD if interval!=0, else mark TD as one-shot
r_if
c_cond
(paren
id|urb-&gt;interval
)paren
(brace
id|desc-&gt;hw.td.info
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|TD_TOKEN_TOGGLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
(paren
(paren
id|urb_priv_t
op_star
)paren
id|urb-&gt;hcpriv
)paren
op_member_access_from_pointer
id|started
op_assign
id|jiffies
suffix:semicolon
id|desc-&gt;hw.td.info
op_or_assign
(paren
id|usb_gettoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
op_lshift
id|TD_TOKEN_TOGGLE
)paren
suffix:semicolon
id|usb_dotoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|desc-&gt;hw.td.info
op_or_assign
(paren
op_logical_neg
id|usb_gettoggle
(paren
id|urb-&gt;dev
comma
id|usb_pipeendpoint
(paren
id|urb-&gt;pipe
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
op_lshift
id|TD_TOKEN_TOGGLE
)paren
suffix:semicolon
)brace
id|desc-&gt;hw.td.status
op_assign
(paren
id|urb-&gt;pipe
op_amp
id|TD_CTRL_LS
)paren
op_or
id|TD_CTRL_ACTIVE
op_or
id|TD_CTRL_IOC
op_or
(paren
id|urb-&gt;transfer_flags
op_amp
id|USB_DISABLE_SPD
ques
c_cond
l_int|0
suffix:colon
id|TD_CTRL_SPD
)paren
op_or
(paren
l_int|3
op_lshift
l_int|27
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|uhci_unlink_urb_async
c_func
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
id|desc-&gt;hw.td.status
op_and_assign
op_complement
id|TD_CTRL_IOC
suffix:semicolon
singleline_comment|// inactivate TD
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
singleline_comment|// mode: 1: force processing, don&squot;t unlink tds (already unlinked)
DECL|function|process_iso
id|_static
r_int
id|process_iso
(paren
id|uhci_t
op_star
id|s
comma
id|urb_t
op_star
id|urb
comma
r_int
id|mode
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|urb_priv_t
op_star
id|urb_priv
op_assign
id|urb-&gt;hcpriv
suffix:semicolon
r_struct
id|list_head
op_star
id|p
op_assign
id|urb_priv-&gt;desc_list.next
suffix:semicolon
id|uhci_desc_t
op_star
id|desc
op_assign
id|list_entry
(paren
id|urb_priv-&gt;desc_list.prev
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;urb contains iso request&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|desc-&gt;hw.td.status
op_amp
id|TD_CTRL_ACTIVE
)paren
op_logical_and
op_logical_neg
id|mode
)paren
r_return
op_minus
id|EXDEV
suffix:semicolon
singleline_comment|// last TD not finished
id|urb-&gt;error_count
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;actual_length
op_assign
l_int|0
suffix:semicolon
id|urb-&gt;status
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;process iso urb %p, %li, %i, %i, %i %08x&quot;
comma
id|urb
comma
id|jiffies
comma
id|UHCI_GET_CURRENT_FRAME
c_func
(paren
id|s
)paren
comma
id|urb-&gt;number_of_packets
comma
id|mode
comma
id|desc-&gt;hw.td.status
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|p
op_ne
op_amp
id|urb_priv-&gt;desc_list
suffix:semicolon
id|i
op_increment
)paren
(brace
id|desc
op_assign
id|list_entry
(paren
id|p
comma
id|uhci_desc_t
comma
id|desc_list
)paren
suffix:semicolon
singleline_comment|//uhci_show_td(desc);
r_if
c_cond
(paren
id|desc-&gt;hw.td.status
op_amp
id|TD_CTRL_ACTIVE
)paren
(brace
singleline_comment|// means we have completed the last TD, but not the TDs before
id|desc-&gt;hw.td.status
op_and_assign
op_complement
id|TD_CTRL_ACTIVE
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;TD still active (%x)- grrr. paranoia!&quot;
comma
id|desc-&gt;hw.td.status
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EXDEV
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|ret
suffix:semicolon
id|unlink_td
(paren
id|s
comma
id|desc
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// FIXME: immediate deletion may be dangerous
r_goto
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mode
)paren
id|unlink_td
(paren
id|s
comma
id|desc
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;number_of_packets
op_le
id|i
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;urb-&gt;number_of_packets (%d)&lt;=(%d)&quot;
comma
id|urb-&gt;number_of_packets
comma
id|i
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
op_plus
id|urb-&gt;transfer_buffer
op_ne
id|bus_to_virt
(paren
id|desc-&gt;hw.td.buffer
)paren
)paren
(brace
singleline_comment|// Hm, something really weird is going on
id|dbg
c_func
(paren
l_string|&quot;Pointer Paranoia: %p!=%p&quot;
comma
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
op_plus
id|urb-&gt;transfer_buffer
comma
id|bus_to_virt
(paren
id|desc-&gt;hw.td.buffer
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|ret
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_assign
(paren
id|desc-&gt;hw.td.status
op_plus
l_int|1
)paren
op_amp
l_int|0x7ff
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_assign
id|uhci_map_status
(paren
id|uhci_status_bits
(paren
id|desc-&gt;hw.td.status
)paren
comma
id|usb_pipeout
(paren
id|urb-&gt;pipe
)paren
)paren
suffix:semicolon
id|urb-&gt;actual_length
op_add_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
suffix:semicolon
id|err
suffix:colon
r_if
c_cond
(paren
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
op_ne
l_int|0
)paren
(brace
id|urb-&gt;error_count
op_increment
suffix:semicolon
id|urb-&gt;status
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;process_iso: %i: len:%d %08x status:%x&quot;
comma
id|i
comma
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
comma
id|desc-&gt;hw.td.status
comma
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
id|list_del
(paren
id|p
)paren
suffix:semicolon
id|p
op_assign
id|p-&gt;next
suffix:semicolon
id|delete_desc
(paren
id|desc
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;process_iso: exit %i (%d), actual_len %i&quot;
comma
id|i
comma
id|ret
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|process_urb
id|_static
r_int
id|process_urb
(paren
id|uhci_t
op_star
id|s
comma
r_struct
id|list_head
op_star
id|p
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|urb_t
op_star
id|urb
suffix:semicolon
id|urb
op_assign
id|list_entry
(paren
id|p
comma
id|urb_t
comma
id|urb_list
)paren
suffix:semicolon
singleline_comment|//dbg(&quot;process_urb: found queued urb: %p&quot;, urb);
r_switch
c_cond
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_case
id|PIPE_CONTROL
suffix:colon
id|ret
op_assign
id|process_transfer
(paren
id|s
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_BULK
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;avoid_bulk.counter
)paren
id|ret
op_assign
id|process_transfer
(paren
id|s
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_ISOCHRONOUS
suffix:colon
id|ret
op_assign
id|process_iso
(paren
id|s
comma
id|urb
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PIPE_INTERRUPT
suffix:colon
id|ret
op_assign
id|process_interrupt
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
op_ne
op_minus
id|EINPROGRESS
)paren
(brace
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
id|usb_dev
op_assign
id|urb-&gt;dev
suffix:semicolon
multiline_comment|/* Release bandwidth for Interrupt or Iso transfers */
r_if
c_cond
(paren
id|urb-&gt;bandwidth
)paren
(brace
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_ISOCHRONOUS
)paren
id|usb_release_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|usb_pipetype
c_func
(paren
id|urb-&gt;pipe
)paren
op_eq
id|PIPE_INTERRUPT
op_logical_and
id|urb-&gt;interval
)paren
id|usb_release_bandwidth
(paren
id|urb-&gt;dev
comma
id|urb
comma
l_int|0
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;dequeued urb: %p&quot;
comma
id|urb
)paren
suffix:semicolon
id|dequeue_urb
(paren
id|s
comma
id|urb
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SLAB
id|kmem_cache_free
c_func
(paren
id|urb_priv_kmem
comma
id|urb-&gt;hcpriv
)paren
suffix:semicolon
macro_line|#else
id|kfree
(paren
id|urb-&gt;hcpriv
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|usb_pipetype
(paren
id|urb-&gt;pipe
)paren
op_ne
id|PIPE_INTERRUPT
)paren
)paren
(brace
singleline_comment|// process_interrupt does completion on its own&t;&t;
id|urb_t
op_star
id|next_urb
op_assign
id|urb-&gt;next
suffix:semicolon
r_int
id|is_ring
op_assign
l_int|0
suffix:semicolon
r_int
id|contains_killed
op_assign
l_int|0
suffix:semicolon
r_int
id|loop_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|next_urb
)paren
(brace
singleline_comment|// Find out if the URBs are linked to a ring
r_while
c_loop
(paren
id|next_urb
op_ne
l_int|NULL
op_logical_and
id|next_urb
op_ne
id|urb
op_logical_and
id|loop_count
OL
id|MAX_NEXT_COUNT
)paren
(brace
r_if
c_cond
(paren
id|next_urb-&gt;status
op_eq
op_minus
id|ENOENT
)paren
(brace
singleline_comment|// killed URBs break ring structure &amp; resubmission
id|contains_killed
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|next_urb
op_assign
id|next_urb-&gt;next
suffix:semicolon
id|loop_count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|loop_count
op_eq
id|MAX_NEXT_COUNT
)paren
id|err
c_func
(paren
l_string|&quot;process_urb: Too much linked URBs in ring detection!&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next_urb
op_eq
id|urb
)paren
id|is_ring
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|urb-&gt;lock
)paren
suffix:semicolon
singleline_comment|// Submit idle/non-killed URBs linked with urb-&gt;next
singleline_comment|// Stop before the current URB&t;&t;&t;&t;
id|next_urb
op_assign
id|urb-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|next_urb
op_logical_and
op_logical_neg
id|contains_killed
)paren
(brace
r_int
id|ret_submit
suffix:semicolon
id|next_urb
op_assign
id|urb-&gt;next
suffix:semicolon
id|loop_count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|next_urb
op_ne
l_int|NULL
op_logical_and
id|next_urb
op_ne
id|urb
op_logical_and
id|loop_count
OL
id|MAX_NEXT_COUNT
)paren
(brace
r_if
c_cond
(paren
id|next_urb-&gt;status
op_ne
op_minus
id|EINPROGRESS
)paren
(brace
r_if
c_cond
(paren
id|next_urb-&gt;status
op_eq
op_minus
id|ENOENT
)paren
r_break
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
id|ret_submit
op_assign
id|uhci_submit_urb
c_func
(paren
id|next_urb
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_submit
)paren
r_break
suffix:semicolon
)brace
id|loop_count
op_increment
suffix:semicolon
id|next_urb
op_assign
id|next_urb-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|loop_count
op_eq
id|MAX_NEXT_COUNT
)paren
id|err
c_func
(paren
l_string|&quot;process_urb: Too much linked URBs in resubmission!&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// Completion
r_if
c_cond
(paren
id|urb-&gt;complete
)paren
(brace
id|urb-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
id|urb-&gt;complete
(paren
(paren
r_struct
id|urb
op_star
)paren
id|urb
)paren
suffix:semicolon
singleline_comment|// Re-submit the URB if ring-linked
r_if
c_cond
(paren
id|is_ring
op_logical_and
(paren
id|urb-&gt;status
op_ne
op_minus
id|ENOENT
)paren
op_logical_and
op_logical_neg
id|contains_killed
)paren
(brace
id|urb-&gt;dev
op_assign
id|usb_dev
suffix:semicolon
id|uhci_submit_urb
(paren
id|urb
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
)brace
id|usb_dec_dev_use
(paren
id|usb_dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|urb-&gt;lock
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|uhci_interrupt
id|_static
r_void
id|uhci_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|__uhci
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|uhci_t
op_star
id|s
op_assign
id|__uhci
suffix:semicolon
r_int
r_int
id|io_addr
op_assign
id|s-&gt;io_addr
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_struct
id|list_head
op_star
id|p
comma
op_star
id|p2
suffix:semicolon
r_int
id|restarts
comma
id|work_done
suffix:semicolon
multiline_comment|/*&n;&t; * Read the interrupt status, and write it back to clear the&n;&t; * interrupt cause&n;&t; */
id|status
op_assign
id|inw
(paren
id|io_addr
op_plus
id|USBSTS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
multiline_comment|/* shared interrupt, not mine */
r_return
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;interrupt&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|1
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;interrupt, status %x, frame# %i&quot;
comma
id|status
comma
id|UHCI_GET_CURRENT_FRAME
c_func
(paren
id|s
)paren
)paren
suffix:semicolon
singleline_comment|// remove host controller halted state
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0x20
)paren
op_logical_and
(paren
id|s-&gt;running
)paren
)paren
(brace
id|outw
(paren
id|USBCMD_RS
op_or
id|inw
c_func
(paren
id|io_addr
op_plus
id|USBCMD
)paren
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
)brace
singleline_comment|//uhci_show_status (s);
)brace
multiline_comment|/*&n;&t; * traverse the list in *reverse* direction, because new entries&n;&t; * may be added at the end.&n;&t; * also, because process_urb may unlink the current urb,&n;&t; * we need to advance the list before&n;&t; * New: check for max. workload and restart count&n;&t; */
id|spin_lock
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
id|restarts
op_assign
l_int|0
suffix:semicolon
id|work_done
op_assign
l_int|0
suffix:semicolon
id|restart
suffix:colon
id|s-&gt;unlink_urb_done
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|s-&gt;urb_list.prev
suffix:semicolon
r_while
c_loop
(paren
id|p
op_ne
op_amp
id|s-&gt;urb_list
op_logical_and
(paren
id|work_done
OL
l_int|1024
)paren
)paren
(brace
id|p2
op_assign
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;prev
suffix:semicolon
id|process_urb
(paren
id|s
comma
id|p2
)paren
suffix:semicolon
id|work_done
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;unlink_urb_done
)paren
(brace
id|s-&gt;unlink_urb_done
op_assign
l_int|0
suffix:semicolon
id|restarts
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|restarts
OL
l_int|16
)paren
singleline_comment|// avoid endless restarts
r_goto
id|restart
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|s-&gt;timeout_check
)paren
OG
(paren
id|HZ
op_div
l_int|30
)paren
)paren
id|uhci_check_timeouts
c_func
(paren
id|s
)paren
suffix:semicolon
id|clean_descs
c_func
(paren
id|s
comma
l_int|0
)paren
suffix:semicolon
id|uhci_cleanup_unlink
c_func
(paren
id|s
comma
l_int|0
)paren
suffix:semicolon
id|uhci_switch_timer_int
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
id|outw
(paren
id|status
comma
id|io_addr
op_plus
id|USBSTS
)paren
suffix:semicolon
singleline_comment|//dbg(&quot;uhci_interrupt: done&quot;);
)brace
DECL|function|reset_hc
id|_static
r_void
id|reset_hc
(paren
id|uhci_t
op_star
id|s
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|s-&gt;io_addr
suffix:semicolon
id|s-&gt;apm_state
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Global reset for 50ms */
id|outw
(paren
id|USBCMD_GRESET
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
id|uhci_wait_ms
(paren
l_int|50
)paren
suffix:semicolon
id|outw
(paren
l_int|0
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
id|uhci_wait_ms
(paren
l_int|10
)paren
suffix:semicolon
)brace
DECL|function|start_hc
id|_static
r_void
id|start_hc
(paren
id|uhci_t
op_star
id|s
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|s-&gt;io_addr
suffix:semicolon
r_int
id|timeout
op_assign
l_int|1000
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the HC - this will force us to get a&n;&t; * new notification of any already connected&n;&t; * ports due to the virtual disconnect that it&n;&t; * implies.&n;&t; */
id|outw
(paren
id|USBCMD_HCRESET
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inw
(paren
id|io_addr
op_plus
id|USBCMD
)paren
op_amp
id|USBCMD_HCRESET
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|timeout
)paren
(brace
id|err
c_func
(paren
l_string|&quot;USBCMD_HCRESET timed out!&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Turn on all interrupts */
id|outw
(paren
id|USBINTR_TIMEOUT
op_or
id|USBINTR_RESUME
op_or
id|USBINTR_IOC
op_or
id|USBINTR_SP
comma
id|io_addr
op_plus
id|USBINTR
)paren
suffix:semicolon
multiline_comment|/* Start at frame 0 */
id|outw
(paren
l_int|0
comma
id|io_addr
op_plus
id|USBFRNUM
)paren
suffix:semicolon
id|outl
(paren
id|virt_to_bus
(paren
id|s-&gt;framelist
)paren
comma
id|io_addr
op_plus
id|USBFLBASEADD
)paren
suffix:semicolon
multiline_comment|/* Run and mark it configured with a 64-byte max packet */
id|outw
(paren
id|USBCMD_RS
op_or
id|USBCMD_CF
op_or
id|USBCMD_MAXP
comma
id|io_addr
op_plus
id|USBCMD
)paren
suffix:semicolon
id|s-&gt;apm_state
op_assign
l_int|1
suffix:semicolon
id|s-&gt;running
op_assign
l_int|1
suffix:semicolon
)brace
id|_static
r_void
id|__devexit
DECL|function|uhci_pci_remove
id|uhci_pci_remove
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|uhci_t
op_star
id|s
op_assign
(paren
id|uhci_t
op_star
)paren
id|dev-&gt;driver_data
suffix:semicolon
r_struct
id|usb_device
op_star
id|root_hub
op_assign
id|s-&gt;bus-&gt;root_hub
suffix:semicolon
id|s-&gt;running
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Don&squot;t allow submit_urb
r_if
c_cond
(paren
id|root_hub
)paren
id|usb_disconnect
(paren
op_amp
id|root_hub
)paren
suffix:semicolon
id|reset_hc
(paren
id|s
)paren
suffix:semicolon
id|wait_ms
(paren
l_int|1
)paren
suffix:semicolon
id|uhci_unlink_urbs
(paren
id|s
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// Forced unlink of remaining URBs
id|uhci_cleanup_unlink
(paren
id|s
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// force cleanup of async killed URBs
id|usb_deregister_bus
(paren
id|s-&gt;bus
)paren
suffix:semicolon
id|release_region
(paren
id|s-&gt;io_addr
comma
id|s-&gt;io_size
)paren
suffix:semicolon
id|free_irq
(paren
id|s-&gt;irq
comma
id|s
)paren
suffix:semicolon
id|usb_free_bus
(paren
id|s-&gt;bus
)paren
suffix:semicolon
id|cleanup_skel
(paren
id|s
)paren
suffix:semicolon
id|kfree
(paren
id|s
)paren
suffix:semicolon
)brace
DECL|function|uhci_start_usb
id|_static
r_int
id|__init
id|uhci_start_usb
(paren
id|uhci_t
op_star
id|s
)paren
(brace
multiline_comment|/* start it up */
multiline_comment|/* connect the virtual root hub */
r_struct
id|usb_device
op_star
id|usb_dev
suffix:semicolon
id|usb_dev
op_assign
id|usb_alloc_dev
(paren
l_int|NULL
comma
id|s-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_dev
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|s-&gt;bus-&gt;root_hub
op_assign
id|usb_dev
suffix:semicolon
id|usb_connect
(paren
id|usb_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_new_device
(paren
id|usb_dev
)paren
op_ne
l_int|0
)paren
(brace
id|usb_free_dev
(paren
id|usb_dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|_static
r_void
DECL|function|uhci_pci_suspend
id|uhci_pci_suspend
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|reset_hc
c_func
(paren
(paren
id|uhci_t
op_star
)paren
id|dev-&gt;driver_data
)paren
suffix:semicolon
)brace
id|_static
r_void
DECL|function|uhci_pci_resume
id|uhci_pci_resume
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|start_hc
c_func
(paren
(paren
id|uhci_t
op_star
)paren
id|dev-&gt;driver_data
)paren
suffix:semicolon
)brace
DECL|function|alloc_uhci
id|_static
r_int
id|__devinit
id|alloc_uhci
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|irq
comma
r_int
r_int
id|io_addr
comma
r_int
r_int
id|io_size
)paren
(brace
id|uhci_t
op_star
id|s
suffix:semicolon
r_struct
id|usb_bus
op_star
id|bus
suffix:semicolon
r_char
id|buf
(braket
l_int|8
)braket
comma
op_star
id|bufp
op_assign
id|buf
suffix:semicolon
macro_line|#ifndef __sparc__
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&quot;
comma
id|irq
)paren
suffix:semicolon
macro_line|#else
id|bufp
op_assign
id|__irq_itoa
c_func
(paren
id|irq
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
id|__FILE__
l_string|&quot;: USB UHCI at I/O 0x%x, IRQ %s&bslash;n&quot;
comma
id|io_addr
comma
id|bufp
)paren
suffix:semicolon
id|s
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|uhci_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memset
(paren
id|s
comma
l_int|0
comma
r_sizeof
(paren
id|uhci_t
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|s-&gt;free_desc
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|s-&gt;urb_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|s-&gt;urb_unlinked
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|s-&gt;urb_list_lock
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|s-&gt;qh_lock
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|s-&gt;td_lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|s-&gt;avoid_bulk
comma
l_int|0
)paren
suffix:semicolon
id|s-&gt;timeout_urbs
op_assign
l_int|0
suffix:semicolon
id|s-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|s-&gt;io_addr
op_assign
id|io_addr
suffix:semicolon
id|s-&gt;io_size
op_assign
id|io_size
suffix:semicolon
id|s-&gt;timeout_check
op_assign
l_int|0
suffix:semicolon
id|s-&gt;uhci_pci
op_assign
id|dev
suffix:semicolon
id|bus
op_assign
id|usb_alloc_bus
(paren
op_amp
id|uhci_device_operations
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bus
)paren
(brace
id|kfree
(paren
id|s
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|s-&gt;bus
op_assign
id|bus
suffix:semicolon
id|bus-&gt;hcpriv
op_assign
id|s
suffix:semicolon
multiline_comment|/* UHCI specs says devices must have 2 ports, but goes on to say */
multiline_comment|/* they may have more but give no way to determine how many they */
multiline_comment|/* have, so default to 2 */
multiline_comment|/* According to the UHCI spec, Bit 7 is always set to 1. So we try */
multiline_comment|/* to use this to our advantage */
r_for
c_loop
(paren
id|s-&gt;maxports
op_assign
l_int|0
suffix:semicolon
id|s-&gt;maxports
OL
(paren
id|io_size
op_minus
l_int|0x10
)paren
op_div
l_int|2
suffix:semicolon
id|s-&gt;maxports
op_increment
)paren
(brace
r_int
r_int
id|portstatus
suffix:semicolon
id|portstatus
op_assign
id|inw
(paren
id|io_addr
op_plus
l_int|0x10
op_plus
(paren
id|s-&gt;maxports
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;port %i, adr %x status %x&quot;
comma
id|s-&gt;maxports
comma
id|io_addr
op_plus
l_int|0x10
op_plus
(paren
id|s-&gt;maxports
op_star
l_int|2
)paren
comma
id|portstatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|portstatus
op_amp
l_int|0x0080
)paren
)paren
r_break
suffix:semicolon
)brace
id|warn
c_func
(paren
l_string|&quot;Detected %d ports&quot;
comma
id|s-&gt;maxports
)paren
suffix:semicolon
multiline_comment|/* This is experimental so anything less than 2 or greater than 8 is */
multiline_comment|/*  something weird and we&squot;ll ignore it */
r_if
c_cond
(paren
id|s-&gt;maxports
template_param
l_int|8
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Port count misdetected, forcing to 2 ports&quot;
)paren
suffix:semicolon
id|s-&gt;maxports
op_assign
l_int|2
suffix:semicolon
)brace
id|s-&gt;rh.numports
op_assign
id|s-&gt;maxports
suffix:semicolon
id|s-&gt;loop_usage
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|init_skel
(paren
id|s
)paren
)paren
(brace
id|usb_free_bus
(paren
id|bus
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|request_region
(paren
id|s-&gt;io_addr
comma
id|io_size
comma
id|MODNAME
)paren
suffix:semicolon
id|reset_hc
(paren
id|s
)paren
suffix:semicolon
id|usb_register_bus
(paren
id|s-&gt;bus
)paren
suffix:semicolon
id|start_hc
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|irq
comma
id|uhci_interrupt
comma
id|SA_SHIRQ
comma
id|MODNAME
comma
id|s
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;request_irq %d failed!&quot;
comma
id|irq
)paren
suffix:semicolon
id|usb_free_bus
(paren
id|bus
)paren
suffix:semicolon
id|reset_hc
(paren
id|s
)paren
suffix:semicolon
id|release_region
(paren
id|s-&gt;io_addr
comma
id|s-&gt;io_size
)paren
suffix:semicolon
id|cleanup_skel
c_func
(paren
id|s
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Enable PIRQ */
id|pci_write_config_word
(paren
id|dev
comma
id|USBLEGSUP
comma
id|USBLEGSUP_DEFAULT
)paren
suffix:semicolon
id|s-&gt;irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|uhci_start_usb
(paren
id|s
)paren
OL
l_int|0
)paren
(brace
id|uhci_pci_remove
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
singleline_comment|//chain new uhci device into global list
id|dev-&gt;driver_data
op_assign
id|s
suffix:semicolon
id|devs
op_assign
id|s
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|_static
r_int
id|__devinit
DECL|function|uhci_pci_probe
id|uhci_pci_probe
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Search for the IO base address.. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|io_addr
op_assign
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
suffix:semicolon
r_int
r_int
id|io_size
op_assign
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|end
op_minus
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|start
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;resource
(braket
id|i
)braket
dot
id|flags
op_amp
id|IORESOURCE_IO
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Is it already in use? */
r_if
c_cond
(paren
id|check_region
(paren
id|io_addr
comma
id|io_size
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* disable legacy emulation */
id|pci_write_config_word
(paren
id|dev
comma
id|USBLEGSUP
comma
l_int|0
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|alloc_uhci
c_func
(paren
id|dev
comma
id|dev-&gt;irq
comma
id|io_addr
comma
id|io_size
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|variable|uhci_pci_ids
r_static
r_const
r_struct
id|pci_device_id
id|__devinitdata
id|uhci_pci_ids
(braket
)braket
op_assign
(brace
(brace
multiline_comment|/* handle any USB UHCI controller */
r_class
suffix:colon
(paren
(paren
id|PCI_CLASS_SERIAL_USB
op_lshift
l_int|8
)paren
op_or
l_int|0x00
)paren
comma
id|class_mask
suffix:colon
op_complement
l_int|0
comma
multiline_comment|/* no matter who makes it */
id|vendor
suffix:colon
id|PCI_ANY_ID
comma
id|device
suffix:colon
id|PCI_ANY_ID
comma
id|subvendor
suffix:colon
id|PCI_ANY_ID
comma
id|subdevice
suffix:colon
id|PCI_ANY_ID
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|uhci_pci_ids
)paren
suffix:semicolon
DECL|variable|uhci_pci_driver
r_static
r_struct
id|pci_driver
id|uhci_pci_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;usb-uhci&quot;
comma
id|id_table
suffix:colon
op_amp
id|uhci_pci_ids
(braket
l_int|0
)braket
comma
id|probe
suffix:colon
id|uhci_pci_probe
comma
id|remove
suffix:colon
id|uhci_pci_remove
comma
macro_line|#ifdef&t;CONFIG_PM
id|suspend
suffix:colon
id|uhci_pci_suspend
comma
id|resume
suffix:colon
id|uhci_pci_resume
comma
macro_line|#endif&t;/* PM */
)brace
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------*/
DECL|function|uhci_hcd_init
r_static
r_int
id|__init
id|uhci_hcd_init
(paren
r_void
)paren
(brace
r_int
id|retval
suffix:semicolon
macro_line|#ifdef DEBUG_SLAB
id|uhci_desc_kmem
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;uhci_desc&quot;
comma
r_sizeof
(paren
id|uhci_desc_t
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uhci_desc_kmem
)paren
(brace
id|err
c_func
(paren
l_string|&quot;kmem_cache_create for uhci_desc failed (out of memory)&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|urb_priv_kmem
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;urb_priv&quot;
comma
r_sizeof
(paren
id|urb_priv_t
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb_priv_kmem
)paren
(brace
id|err
c_func
(paren
l_string|&quot;kmem_cache_create for urb_priv_t failed (out of memory)&quot;
)paren
suffix:semicolon
id|kmem_cache_destroy
c_func
(paren
id|uhci_desc_kmem
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#endif&t;
id|info
c_func
(paren
id|VERSTR
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_USB_UHCI_HIGH_BANDWIDTH
id|info
c_func
(paren
l_string|&quot;High bandwidth mode enabled&quot;
)paren
suffix:semicolon
macro_line|#endif
id|retval
op_assign
id|pci_module_init
(paren
op_amp
id|uhci_pci_driver
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SLAB
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|urb_priv_kmem
)paren
)paren
id|err
c_func
(paren
l_string|&quot;urb_priv_kmem remained&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_desc_kmem
)paren
)paren
id|err
c_func
(paren
l_string|&quot;uhci_desc_kmem remained&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
DECL|function|uhci_hcd_cleanup
r_static
r_void
id|__exit
id|uhci_hcd_cleanup
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|uhci_pci_driver
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SLAB
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|uhci_desc_kmem
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;uhci_desc_kmem remained&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|urb_priv_kmem
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;urb_priv_kmem remained&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|variable|uhci_hcd_init
id|module_init
(paren
id|uhci_hcd_init
)paren
suffix:semicolon
DECL|variable|uhci_hcd_cleanup
id|module_exit
(paren
id|uhci_hcd_cleanup
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Georg Acher, Deti Fliegl, Thomas Sailer, Roman Weissgaerber&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;USB Universal Host Controller Interface driver&quot;
)paren
suffix:semicolon
eof
