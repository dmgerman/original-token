multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *      plusb.c  --  prolific pl-2302 driver.&n; *&n; *      Copyright (C) 2000  Deti Fliegl (deti@fliegl.de)&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *      This program is distributed in the hope that it will be useful,&n; *      but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *      GNU General Public License for more details.&n; *&n; *      You should have received a copy of the GNU General Public License&n; *      along with this program; if not, write to the Free Software&n; *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *&n; *&n; *  $Id: plusb.c,v 1.18 2000/02/14 10:38:58 fliegl Exp $&n; *&n; */
multiline_comment|/*****************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
singleline_comment|//#define DEBUG
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;plusb.h&quot;
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|NRPLUSB
mdefine_line|#define NRPLUSB 4
multiline_comment|/*-------------------------------------------------------------------*/
DECL|variable|plusb
r_static
id|plusb_t
id|plusb
(braket
id|NRPLUSB
)braket
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_add_buf_tail
r_static
r_int
id|plusb_add_buf_tail
(paren
id|plusb_t
op_star
id|s
comma
r_struct
id|list_head
op_star
id|dst
comma
r_struct
id|list_head
op_star
id|src
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
(paren
id|src
)paren
)paren
(brace
singleline_comment|// no elements in source buffer
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|tmp
op_assign
id|src-&gt;next
suffix:semicolon
id|list_del
(paren
id|tmp
)paren
suffix:semicolon
id|list_add_tail
(paren
id|tmp
comma
id|dst
)paren
suffix:semicolon
id|err
suffix:colon
id|spin_unlock_irqrestore
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|plusb_my_bulk
r_static
r_int
id|plusb_my_bulk
c_func
(paren
id|plusb_t
op_star
id|s
comma
r_int
id|pipe
comma
r_void
op_star
id|data
comma
r_int
id|size
comma
r_int
op_star
id|actual_length
)paren
(brace
r_int
id|ret
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_my_bulk: len:%d&quot;
comma
id|size
)paren
suffix:semicolon
id|ret
op_assign
id|usb_bulk_msg
c_func
(paren
id|s-&gt;usbdev
comma
id|pipe
comma
id|data
comma
id|size
comma
id|actual_length
comma
l_int|500
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;plusb: usb_bulk_msg failed(%d)&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EPIPE
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;CLEAR_FEATURE request to remove STALL condition.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_clear_halt
c_func
(paren
id|s-&gt;usbdev
comma
id|usb_pipeendpoint
c_func
(paren
id|pipe
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;request failed&quot;
)paren
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;plusb_my_bulk: finished act: %d&quot;
comma
op_star
id|actual_length
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_bh
r_static
r_void
id|plusb_bh
c_func
(paren
r_void
op_star
id|context
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
id|context
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|s-&gt;net_stats
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|actual_length
suffix:semicolon
id|skb_list_t
op_star
id|skb_list
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_bh: i:%d&quot;
comma
id|in_interrupt
c_func
(paren
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|s-&gt;tx_skb_list
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;status
op_amp
id|_PLUSB_TXOK
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|skb_list
op_assign
id|list_entry
(paren
id|s-&gt;tx_skb_list.next
comma
id|skb_list_t
comma
id|skb_list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_list-&gt;state
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;plusb_bh: not yet ready&quot;
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb
op_assign
id|skb_list-&gt;skb
suffix:semicolon
id|ret
op_assign
id|plusb_my_bulk
c_func
(paren
id|s
comma
id|usb_sndbulkpipe
(paren
id|s-&gt;usbdev
comma
id|_PLUSB_BULKOUTPIPE
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
op_amp
id|actual_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_or
id|skb-&gt;len
op_ne
id|actual_length
op_logical_or
op_logical_neg
(paren
id|skb-&gt;len
op_mod
l_int|64
)paren
)paren
(brace
id|plusb_my_bulk
c_func
(paren
id|s
comma
id|usb_sndbulkpipe
(paren
id|s-&gt;usbdev
comma
id|_PLUSB_BULKOUTPIPE
)paren
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|actual_length
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
id|stats-&gt;tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
)brace
r_else
(brace
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_increment
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;plusb_bh: dev_kfree_skb&quot;
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb_list-&gt;state
op_assign
l_int|0
suffix:semicolon
id|plusb_add_buf_tail
(paren
id|s
comma
op_amp
id|s-&gt;free_skb_list
comma
op_amp
id|s-&gt;tx_skb_list
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;plusb_bh: finished&quot;
)paren
suffix:semicolon
id|s-&gt;in_bh
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_net_xmit
r_static
r_int
id|plusb_net_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
id|dev-&gt;priv
suffix:semicolon
id|skb_list_t
op_star
id|skb_list
suffix:semicolon
r_int
id|ret
op_assign
id|NET_XMIT_SUCCESS
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_net_xmit: len:%d i:%d&quot;
comma
id|skb-&gt;len
comma
id|in_interrupt
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;connected
op_logical_or
id|list_empty
c_func
(paren
op_amp
id|s-&gt;free_skb_list
)paren
)paren
(brace
id|ret
op_assign
id|NET_XMIT_CN
suffix:semicolon
r_goto
id|lab
suffix:semicolon
)brace
id|plusb_add_buf_tail
(paren
id|s
comma
op_amp
id|s-&gt;tx_skb_list
comma
op_amp
id|s-&gt;free_skb_list
)paren
suffix:semicolon
id|skb_list
op_assign
id|list_entry
(paren
id|s-&gt;tx_skb_list.prev
comma
id|skb_list_t
comma
id|skb_list
)paren
suffix:semicolon
id|skb_list-&gt;skb
op_assign
id|skb
suffix:semicolon
id|skb_list-&gt;state
op_assign
l_int|1
suffix:semicolon
id|lab
suffix:colon
r_if
c_cond
(paren
id|s-&gt;in_bh
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;plusb_net_xmit: queue_task&quot;
)paren
suffix:semicolon
id|s-&gt;in_bh
op_assign
l_int|1
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|s-&gt;bh
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_net_xmit: finished&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_bulk_complete
r_static
r_void
id|plusb_bulk_complete
c_func
(paren
id|urb_t
op_star
id|purb
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
id|purb-&gt;context
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_bulk_complete: status:%d length:%d&quot;
comma
id|purb-&gt;status
comma
id|purb-&gt;actual_length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;connected
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|purb-&gt;status
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_char
op_star
id|dst
suffix:semicolon
r_int
id|len
op_assign
id|purb-&gt;transfer_buffer_length
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
op_amp
id|s-&gt;net_stats
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|err
c_func
(paren
l_string|&quot;plusb_bulk_complete: dev_alloc_skb(%d)=NULL, dropping frame&quot;
comma
id|len
)paren
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dst
op_assign
(paren
r_char
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dst
comma
id|purb-&gt;transfer_buffer
comma
id|len
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
op_amp
id|s-&gt;net_dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|skb-&gt;dev
)paren
suffix:semicolon
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|len
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
id|purb-&gt;status
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_int_complete
r_static
r_void
id|plusb_int_complete
c_func
(paren
id|urb_t
op_star
id|purb
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
id|purb-&gt;context
suffix:semicolon
id|s-&gt;status
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|purb-&gt;transfer_buffer
)paren
(braket
l_int|0
)braket
op_amp
l_int|255
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|s-&gt;status
op_amp
l_int|0x3f
)paren
op_ne
l_int|0x20
)paren
(brace
id|warn
c_func
(paren
l_string|&quot;invalid device status %02X&quot;
comma
id|s-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif&t;
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;connected
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;status
op_amp
id|_PLUSB_RXD
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;bulkurb-&gt;status
)paren
(brace
id|err
c_func
(paren
l_string|&quot;plusb_int_complete: URB still in use&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|s-&gt;bulkurb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_and
id|ret
op_ne
op_minus
id|EBUSY
)paren
(brace
id|err
c_func
(paren
l_string|&quot;plusb_int_complete: usb_submit_urb failed&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|purb-&gt;status
op_logical_or
id|s-&gt;status
op_ne
l_int|160
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;status: %p %d buf: %02X&quot;
comma
id|purb-&gt;dev
comma
id|purb-&gt;status
comma
id|s-&gt;status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_free_all
r_static
r_void
id|plusb_free_all
c_func
(paren
id|plusb_t
op_star
id|s
)paren
(brace
r_struct
id|list_head
op_star
id|skb
suffix:semicolon
id|skb_list_t
op_star
id|skb_list
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_free_all&quot;
)paren
suffix:semicolon
id|run_task_queue
c_func
(paren
op_amp
id|tq_immediate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;inturb
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;unlink inturb&quot;
)paren
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|s-&gt;inturb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;inturb
op_logical_and
id|s-&gt;inturb-&gt;transfer_buffer
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;kfree inturb-&gt;transfer_buffer&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s-&gt;inturb-&gt;transfer_buffer
)paren
suffix:semicolon
id|s-&gt;inturb-&gt;transfer_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;inturb
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;free_urb inturb&quot;
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|s-&gt;inturb
)paren
suffix:semicolon
id|s-&gt;inturb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;bulkurb
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;unlink bulkurb&quot;
)paren
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|s-&gt;bulkurb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;bulkurb
op_logical_and
id|s-&gt;bulkurb-&gt;transfer_buffer
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;kfree bulkurb-&gt;transfer_buffer&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s-&gt;bulkurb-&gt;transfer_buffer
)paren
suffix:semicolon
id|s-&gt;bulkurb-&gt;transfer_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;bulkurb
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;free_urb bulkurb&quot;
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|s-&gt;bulkurb
)paren
suffix:semicolon
id|s-&gt;bulkurb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|s-&gt;free_skb_list
)paren
)paren
(brace
id|skb
op_assign
id|s-&gt;free_skb_list.next
suffix:semicolon
id|list_del
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb_list
op_assign
id|list_entry
(paren
id|skb
comma
id|skb_list_t
comma
id|skb_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|skb_list
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|s-&gt;tx_skb_list
)paren
)paren
(brace
id|skb
op_assign
id|s-&gt;tx_skb_list.next
suffix:semicolon
id|list_del
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb_list
op_assign
id|list_entry
(paren
id|skb
comma
id|skb_list_t
comma
id|skb_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|skb_list
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;plusb_free_all: finished&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|plusb_alloc
r_static
r_int
id|plusb_alloc
c_func
(paren
id|plusb_t
op_star
id|s
)paren
(brace
r_int
id|i
suffix:semicolon
id|skb_list_t
op_star
id|skb
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_alloc&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|_SKB_NUM
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|skb_list_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|err
c_func
(paren
l_string|&quot;kmalloc for skb_list failed&quot;
)paren
suffix:semicolon
r_goto
id|reject
suffix:semicolon
)brace
id|memset
c_func
(paren
id|skb
comma
l_int|0
comma
r_sizeof
(paren
id|skb_list_t
)paren
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|skb-&gt;skb_list
comma
op_amp
id|s-&gt;free_skb_list
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;inturb allocation:&quot;
)paren
suffix:semicolon
id|s-&gt;inturb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;inturb
)paren
(brace
id|err
c_func
(paren
l_string|&quot;alloc_urb failed&quot;
)paren
suffix:semicolon
r_goto
id|reject
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;bulkurb allocation:&quot;
)paren
suffix:semicolon
id|s-&gt;bulkurb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;bulkurb
)paren
(brace
id|err
c_func
(paren
l_string|&quot;alloc_urb failed&quot;
)paren
suffix:semicolon
r_goto
id|reject
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;bulkurb/inturb init:&quot;
)paren
suffix:semicolon
id|s-&gt;inturb-&gt;dev
op_assign
id|s-&gt;usbdev
suffix:semicolon
id|s-&gt;inturb-&gt;pipe
op_assign
id|usb_rcvintpipe
(paren
id|s-&gt;usbdev
comma
id|_PLUSB_INTPIPE
)paren
suffix:semicolon
id|s-&gt;inturb-&gt;transfer_buffer
op_assign
id|kmalloc
c_func
(paren
l_int|64
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;inturb-&gt;transfer_buffer
)paren
(brace
id|err
c_func
(paren
l_string|&quot;kmalloc failed&quot;
)paren
suffix:semicolon
r_goto
id|reject
suffix:semicolon
)brace
id|s-&gt;inturb-&gt;transfer_buffer_length
op_assign
l_int|1
suffix:semicolon
id|s-&gt;inturb-&gt;complete
op_assign
id|plusb_int_complete
suffix:semicolon
id|s-&gt;inturb-&gt;context
op_assign
id|s
suffix:semicolon
id|s-&gt;inturb-&gt;interval
op_assign
l_int|10
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;inturb submission:&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
id|s-&gt;inturb
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;usb_submit_urb failed&quot;
)paren
suffix:semicolon
r_goto
id|reject
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;bulkurb init:&quot;
)paren
suffix:semicolon
id|s-&gt;bulkurb-&gt;dev
op_assign
id|s-&gt;usbdev
suffix:semicolon
id|s-&gt;bulkurb-&gt;pipe
op_assign
id|usb_rcvbulkpipe
(paren
id|s-&gt;usbdev
comma
id|_PLUSB_BULKINPIPE
)paren
suffix:semicolon
id|s-&gt;bulkurb-&gt;transfer_buffer
op_assign
id|kmalloc
c_func
(paren
id|_BULK_DATA_LEN
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;bulkurb-&gt;transfer_buffer
)paren
(brace
id|err
c_func
(paren
l_string|&quot;kmalloc failed&quot;
)paren
suffix:semicolon
r_goto
id|reject
suffix:semicolon
)brace
id|s-&gt;bulkurb-&gt;transfer_buffer_length
op_assign
id|_BULK_DATA_LEN
suffix:semicolon
id|s-&gt;bulkurb-&gt;complete
op_assign
id|plusb_bulk_complete
suffix:semicolon
id|s-&gt;bulkurb-&gt;context
op_assign
id|s
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_alloc: finished&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|reject
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;plusb_alloc: failed&quot;
)paren
suffix:semicolon
id|plusb_free_all
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*/
DECL|function|plusb_net_open
r_static
r_int
id|plusb_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_net_open&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|plusb_alloc
c_func
(paren
id|s
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|s-&gt;opened
op_assign
l_int|1
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_net_open: success&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_net_stop
r_static
r_int
id|plusb_net_stop
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_net_stop&quot;
)paren
suffix:semicolon
id|plusb_free_all
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_net_stop:finished&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_net_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|plusb_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
id|dev-&gt;priv
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;net_device_stats&quot;
)paren
suffix:semicolon
r_return
op_amp
id|s-&gt;net_stats
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_find_struct
r_static
id|plusb_t
op_star
id|plusb_find_struct
(paren
r_void
)paren
(brace
r_int
id|u
suffix:semicolon
r_for
c_loop
(paren
id|u
op_assign
l_int|0
suffix:semicolon
id|u
OL
id|NRPLUSB
suffix:semicolon
id|u
op_increment
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
op_amp
id|plusb
(braket
id|u
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;connected
)paren
r_return
id|s
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_disconnect
r_static
r_void
id|plusb_disconnect
(paren
r_struct
id|usb_device
op_star
id|usbdev
comma
r_void
op_star
id|ptr
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
id|ptr
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_disconnect&quot;
)paren
suffix:semicolon
id|s-&gt;connected
op_assign
l_int|0
suffix:semicolon
id|plusb_free_all
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;opened
op_logical_and
id|s-&gt;net_dev.name
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;unregistering netdev: %s&quot;
comma
id|s-&gt;net_dev.name
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|s-&gt;net_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s-&gt;net_dev.name
)paren
suffix:semicolon
id|s-&gt;net_dev.name
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;plusb_disconnect: finished&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_net_init
r_int
id|plusb_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;plusb_net_init&quot;
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|plusb_net_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|plusb_net_stop
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|plusb_net_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|plusb_net_get_stats
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_POINTOPOINT
op_or
id|IFF_NOARP
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_net_init: finished&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_probe
r_static
r_void
op_star
id|plusb_probe
(paren
r_struct
id|usb_device
op_star
id|usbdev
comma
r_int
r_int
id|ifnum
)paren
(brace
id|plusb_t
op_star
id|s
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb: probe: vendor id 0x%x, device id 0x%x ifnum:%d&quot;
comma
id|usbdev-&gt;descriptor.idVendor
comma
id|usbdev-&gt;descriptor.idProduct
comma
id|ifnum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usbdev-&gt;descriptor.idVendor
op_ne
l_int|0x067b
op_logical_or
id|usbdev-&gt;descriptor.idProduct
op_ne
l_int|0x1
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* We don&squot;t handle multiple configurations */
r_if
c_cond
(paren
id|usbdev-&gt;descriptor.bNumConfigurations
op_ne
l_int|1
)paren
r_return
l_int|NULL
suffix:semicolon
id|s
op_assign
id|plusb_find_struct
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_return
l_int|NULL
suffix:semicolon
id|s-&gt;usbdev
op_assign
id|usbdev
suffix:semicolon
r_if
c_cond
(paren
id|usb_set_configuration
(paren
id|s-&gt;usbdev
comma
id|usbdev-&gt;config
(braket
l_int|0
)braket
dot
id|bConfigurationValue
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;set_configuration failed&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_set_interface
(paren
id|s-&gt;usbdev
comma
l_int|0
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;set_interface failed&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;net_dev.name
)paren
(brace
id|s-&gt;net_dev.name
op_assign
id|kmalloc
c_func
(paren
l_int|16
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;net_dev.name
op_logical_or
id|dev_alloc_name
c_func
(paren
op_amp
id|s-&gt;net_dev
comma
l_string|&quot;plusb%d&quot;
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;alloc name failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|s-&gt;net_dev.init
op_assign
id|plusb_net_init
suffix:semicolon
id|s-&gt;net_dev.priv
op_assign
id|s
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|register_netdev
c_func
(paren
op_amp
id|s-&gt;net_dev
)paren
)paren
(brace
id|info
c_func
(paren
l_string|&quot;registered: %s&quot;
comma
id|s-&gt;net_dev.name
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
c_func
(paren
l_string|&quot;register_netdev failed&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s-&gt;net_dev.name
)paren
suffix:semicolon
id|s-&gt;net_dev.name
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|s-&gt;connected
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;opened
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;net device already allocated, restarting USB transfers&quot;
)paren
suffix:semicolon
id|plusb_alloc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|info
c_func
(paren
l_string|&quot;bound to interface: %d dev: %p&quot;
comma
id|ifnum
comma
id|usbdev
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|plusb_driver
r_static
r_struct
id|usb_driver
id|plusb_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;plusb&quot;
comma
id|probe
suffix:colon
id|plusb_probe
comma
id|disconnect
suffix:colon
id|plusb_disconnect
comma
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_init
r_int
id|__init
id|plusb_init
(paren
r_void
)paren
(brace
r_int
id|u
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_init&quot;
)paren
suffix:semicolon
multiline_comment|/* initialize struct */
r_for
c_loop
(paren
id|u
op_assign
l_int|0
suffix:semicolon
id|u
OL
id|NRPLUSB
suffix:semicolon
id|u
op_increment
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
op_amp
id|plusb
(braket
id|u
)braket
suffix:semicolon
id|memset
(paren
id|s
comma
l_int|0
comma
r_sizeof
(paren
id|plusb_t
)paren
)paren
suffix:semicolon
id|s-&gt;bh.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|plusb_bh
suffix:semicolon
id|s-&gt;bh.data
op_assign
id|s
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|s-&gt;tx_skb_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|s-&gt;free_skb_list
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|s-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* register misc device */
id|usb_register
(paren
op_amp
id|plusb_driver
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_init: driver registered&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|plusb_cleanup
r_void
id|__exit
id|plusb_cleanup
(paren
r_void
)paren
(brace
r_int
id|u
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_cleanup&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|u
op_assign
l_int|0
suffix:semicolon
id|u
OL
id|NRPLUSB
suffix:semicolon
id|u
op_increment
)paren
(brace
id|plusb_t
op_star
id|s
op_assign
op_amp
id|plusb
(braket
id|u
)braket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;net_dev.name
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;unregistering netdev: %s&quot;
comma
id|s-&gt;net_dev.name
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
op_amp
id|s-&gt;net_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s-&gt;net_dev.name
)paren
suffix:semicolon
id|s-&gt;net_dev.name
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|usb_deregister
(paren
op_amp
id|plusb_driver
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;plusb_cleanup: finished&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
(paren
l_string|&quot;Deti Fliegl, deti@fliegl.de&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;PL-2302 USB Interface Driver for Linux (c)2000&quot;
)paren
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|init_module
r_int
id|__init
id|init_module
(paren
r_void
)paren
(brace
r_return
id|plusb_init
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|cleanup_module
r_void
id|__exit
id|cleanup_module
(paren
r_void
)paren
(brace
id|plusb_cleanup
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
eof
