multiline_comment|/* Driver for SanDisk SDDR-09 SmartMedia reader&n; *&n; * SDDR09 driver v0.1:&n; *&n; * First release&n; *&n; * Current development and maintainance by:&n; *   (c) 2000 Robert Baruch (autophile@dol.net)&n; *&n; * The SanDisk SDDR-09 SmartMedia reader uses the Shuttle EUSB-01 chip.&n; * This chip is a programmable USB controller. In the SDDR-09, it has&n; * been programmed to obey a certain limited set of SCSI commands. This&n; * driver translates the &quot;real&quot; SCSI commands to the SDDR-09 SCSI&n; * commands.&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License along&n; * with this program; if not, write to the Free Software Foundation, Inc.,&n; * 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &quot;transport.h&quot;
macro_line|#include &quot;protocol.h&quot;
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;debug.h&quot;
macro_line|#include &quot;sddr09.h&quot;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
r_extern
r_int
id|usb_stor_control_msg
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_int
r_int
id|pipe
comma
id|u8
id|request
comma
id|u8
id|requesttype
comma
id|u16
id|value
comma
id|u16
id|index
comma
r_void
op_star
id|data
comma
id|u16
id|size
)paren
suffix:semicolon
r_extern
r_int
id|usb_stor_bulk_msg
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_void
op_star
id|data
comma
r_int
id|pipe
comma
r_int
r_int
id|len
comma
r_int
r_int
op_star
id|act_len
)paren
suffix:semicolon
DECL|macro|short_pack
mdefine_line|#define short_pack(b1,b2) ( ((u16)(b1)) | ( ((u16)(b2))&lt;&lt;8 ) )
DECL|macro|LSB_of
mdefine_line|#define LSB_of(s) ((s)&amp;0xFF)
DECL|macro|MSB_of
mdefine_line|#define MSB_of(s) ((s)&gt;&gt;8)
multiline_comment|/*&n; * Send a control message and wait for the response.&n; *&n; * us - the pointer to the us_data structure for the device to use&n; *&n; * request - the URB Setup Packet&squot;s first 6 bytes. The first byte always&n; *  corresponds to the request type, and the second byte always corresponds&n; *  to the request.  The other 4 bytes do not correspond to value and index,&n; *  since they are used in a custom way by the SCM protocol.&n; *&n; * xfer_data - a buffer from which to get, or to which to store, any data&n; *  that gets send or received, respectively, with the URB. Even though&n; *  it looks like we allocate a buffer in this code for the data, xfer_data&n; *  must contain enough allocated space.&n; *&n; * xfer_len - the number of bytes to send or receive with the URB.&n; *&n; */
DECL|function|sddr09_send_control
r_static
r_int
id|sddr09_send_control
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_int
id|pipe
comma
r_int
r_char
id|request
comma
r_int
r_char
id|requesttype
comma
r_int
r_int
id|value
comma
r_int
r_int
id|index
comma
r_int
r_char
op_star
id|xfer_data
comma
r_int
r_int
id|xfer_len
)paren
(brace
r_int
id|result
suffix:semicolon
singleline_comment|// If data is going to be sent or received with the URB,
singleline_comment|// then allocate a buffer for it. If data is to be sent,
singleline_comment|// copy the data into the buffer.
multiline_comment|/*&n;&t;if (xfer_len &gt; 0) {&n;&t;&t;buffer = kmalloc(xfer_len, GFP_KERNEL);&n;&t;&t;if (!(command[0] &amp; USB_DIR_IN))&n;&t;&t;&t;memcpy(buffer, xfer_data, xfer_len);&n;&t;}&n;*/
singleline_comment|// Send the URB to the device and wait for a response.
multiline_comment|/* Why are request and request type reversed in this call? */
id|result
op_assign
id|usb_stor_control_msg
c_func
(paren
id|us
comma
id|pipe
comma
id|request
comma
id|requesttype
comma
id|value
comma
id|index
comma
id|xfer_data
comma
id|xfer_len
)paren
suffix:semicolon
singleline_comment|// If data was sent or received with the URB, free the buffer we
singleline_comment|// allocated earlier, but not before reading the data out of the
singleline_comment|// buffer if we wanted to receive data.
multiline_comment|/*&n;&t;if (xfer_len &gt; 0) {&n;&t;&t;if (command[0] &amp; USB_DIR_IN)&n;&t;&t;&t;memcpy(xfer_data, buffer, xfer_len);&n;&t;&t;kfree(buffer);&n;&t;}&n;*/
singleline_comment|// Check the return code for the command.
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
multiline_comment|/* if the command was aborted, indicate that */
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ENOENT
)paren
r_return
id|USB_STOR_TRANSPORT_ABORTED
suffix:semicolon
multiline_comment|/* a stall is a fatal condition from the device */
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EPIPE
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;-- Stall on control pipe. Clearing&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
id|usb_clear_halt
c_func
(paren
id|us-&gt;pusb_dev
comma
id|pipe
)paren
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;-- usb_clear_halt() returns %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|USB_STOR_TRANSPORT_FAILED
suffix:semicolon
)brace
multiline_comment|/* Uh oh... serious problem here */
r_return
id|USB_STOR_TRANSPORT_ERROR
suffix:semicolon
)brace
r_return
id|USB_STOR_TRANSPORT_GOOD
suffix:semicolon
)brace
DECL|function|sddr09_raw_bulk
r_static
r_int
id|sddr09_raw_bulk
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_int
id|direction
comma
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|act_len
suffix:semicolon
r_int
id|pipe
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|SCSI_DATA_READ
)paren
id|pipe
op_assign
id|usb_rcvbulkpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_in
)paren
suffix:semicolon
r_else
id|pipe
op_assign
id|usb_sndbulkpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
id|us-&gt;ep_out
)paren
suffix:semicolon
id|result
op_assign
id|usb_stor_bulk_msg
c_func
(paren
id|us
comma
id|data
comma
id|pipe
comma
id|len
comma
op_amp
id|act_len
)paren
suffix:semicolon
multiline_comment|/* if we stall, we need to clear it before we go on */
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EPIPE
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;EPIPE: clearing endpoint halt for&quot;
l_string|&quot; pipe 0x%x, stalled at %d bytes&bslash;n&quot;
comma
id|pipe
comma
id|act_len
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|us-&gt;pusb_dev
comma
id|pipe
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
)paren
(brace
multiline_comment|/* NAK - that means we&squot;ve retried a few times already */
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ETIMEDOUT
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;usbat_raw_bulk():&quot;
l_string|&quot; device NAKed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|US_BULK_TRANSFER_FAILED
suffix:semicolon
)brace
multiline_comment|/* -ENOENT -- we canceled this transfer */
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ENOENT
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;usbat_raw_bulk():&quot;
l_string|&quot; transfer aborted&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|US_BULK_TRANSFER_ABORTED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EPIPE
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;usbat_raw_bulk():&quot;
l_string|&quot; output pipe stalled&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|USB_STOR_TRANSPORT_FAILED
suffix:semicolon
)brace
multiline_comment|/* the catch-all case */
id|US_DEBUGP
c_func
(paren
l_string|&quot;us_transfer_partial(): unknown error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|US_BULK_TRANSFER_FAILED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|act_len
op_ne
id|len
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Warning: Transferred only %d bytes&bslash;n&quot;
comma
id|act_len
)paren
suffix:semicolon
r_return
id|US_BULK_TRANSFER_SHORT
suffix:semicolon
)brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Transfered %d of %d bytes&bslash;n&quot;
comma
id|act_len
comma
id|len
)paren
suffix:semicolon
r_return
id|US_BULK_TRANSFER_GOOD
suffix:semicolon
)brace
multiline_comment|/*&n; * Note: direction must be set if command_len == 0.&n; */
DECL|function|sddr09_bulk_transport
r_static
r_int
id|sddr09_bulk_transport
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_int
r_char
op_star
id|command
comma
r_int
r_int
id|command_len
comma
r_int
id|direction
comma
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|len
comma
r_int
id|use_sg
)paren
(brace
r_int
id|result
op_assign
id|USB_STOR_TRANSPORT_GOOD
suffix:semicolon
r_int
id|transferred
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|execute
(braket
l_int|8
)braket
op_assign
(brace
l_int|0x40
comma
l_int|0x80
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_char
id|string
(braket
l_int|64
)braket
suffix:semicolon
multiline_comment|/*&n;&t;if (command_len != 0) {&n;&n;&t;&t;// Fix up the command&squot;s data length&n;&n;&t;&t;command[6] = len&amp;0xFF;&n;&t;&t;command[7] = (len&gt;&gt;8)&amp;0xFF;&n;&n;&t;&t;result = sddr09_send_control(us, &n;&t;&t;&t;&t;&t;  execute,&n;&t;&t;&t;&t;&t;  command,&n;&t;&t;&t;&t;&t;  command_len);&n;&n;&t;&t;if (result != USB_STOR_TRANSPORT_GOOD)&n;&t;&t;&t;return result;&n;&t;}&n;*/
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
r_return
id|USB_STOR_TRANSPORT_GOOD
suffix:semicolon
multiline_comment|/* transfer the data payload for the command, if there is any */
r_if
c_cond
(paren
id|command_len
op_ne
l_int|0
)paren
id|direction
op_assign
(paren
id|command
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
ques
c_cond
id|SCSI_DATA_READ
suffix:colon
id|SCSI_DATA_WRITE
suffix:semicolon
r_if
c_cond
(paren
id|direction
op_eq
id|SCSI_DATA_WRITE
)paren
(brace
multiline_comment|/* Debug-print the first 48 bytes of the write transfer */
r_if
c_cond
(paren
op_logical_neg
id|use_sg
)paren
(brace
id|string
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
op_logical_and
id|i
OL
l_int|48
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|string
op_plus
id|strlen
c_func
(paren
id|string
)paren
comma
l_string|&quot;%02X &quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|16
)paren
op_eq
l_int|15
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|string
)paren
suffix:semicolon
id|string
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|string
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
id|US_DEBUGP
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|string
)paren
suffix:semicolon
)brace
)brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;SCM data %s transfer %d sg buffers %d&bslash;n&quot;
comma
(paren
id|direction
op_eq
id|SCSI_DATA_READ
ques
c_cond
l_string|&quot;in&quot;
suffix:colon
l_string|&quot;out&quot;
)paren
comma
id|len
comma
id|use_sg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_sg
)paren
id|result
op_assign
id|sddr09_raw_bulk
c_func
(paren
id|us
comma
id|direction
comma
id|data
comma
id|len
)paren
suffix:semicolon
r_else
(brace
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|use_sg
op_logical_and
id|transferred
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|result
op_assign
id|sddr09_raw_bulk
c_func
(paren
id|us
comma
id|direction
comma
id|sg
(braket
id|i
)braket
dot
id|address
comma
id|len
op_minus
id|transferred
OG
id|sg
(braket
id|i
)braket
dot
id|length
ques
c_cond
id|sg
(braket
id|i
)braket
dot
id|length
suffix:colon
id|len
op_minus
id|transferred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|US_BULK_TRANSFER_GOOD
)paren
r_break
suffix:semicolon
id|transferred
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
)brace
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|sddr09_read_data
r_int
id|sddr09_read_data
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_int
r_int
id|address
comma
r_int
r_int
id|sectors
comma
r_int
r_char
op_star
id|content
comma
r_int
id|use_sg
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_char
id|command
(braket
l_int|12
)braket
op_assign
(brace
l_int|0xe8
comma
l_int|0x20
comma
id|MSB_of
c_func
(paren
id|address
op_rshift
l_int|16
)paren
comma
id|LSB_of
c_func
(paren
id|address
op_rshift
l_int|16
)paren
comma
id|MSB_of
c_func
(paren
id|address
op_amp
l_int|0xFFFF
)paren
comma
id|LSB_of
c_func
(paren
id|address
op_amp
l_int|0xFFFF
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|MSB_of
c_func
(paren
id|sectors
)paren
comma
id|LSB_of
c_func
(paren
id|sectors
)paren
)brace
suffix:semicolon
id|result
op_assign
id|sddr09_send_control
c_func
(paren
id|us
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
l_int|0
comma
l_int|0x41
comma
l_int|0
comma
l_int|0
comma
id|command
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|USB_STOR_TRANSPORT_GOOD
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
id|sddr09_bulk_transport
c_func
(paren
id|us
comma
l_int|NULL
comma
l_int|0
comma
id|SCSI_DATA_READ
comma
id|content
comma
id|sectors
op_star
l_int|512
comma
id|use_sg
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|sddr09_read_control
r_int
id|sddr09_read_control
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_int
r_int
id|address
comma
r_int
r_int
id|sectors
comma
r_int
r_char
op_star
id|content
comma
r_int
id|use_sg
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_char
id|command
(braket
l_int|12
)braket
op_assign
(brace
l_int|0xe8
comma
l_int|0x21
comma
id|MSB_of
c_func
(paren
id|address
op_rshift
l_int|16
)paren
comma
id|LSB_of
c_func
(paren
id|address
op_rshift
l_int|16
)paren
comma
id|MSB_of
c_func
(paren
id|address
op_amp
l_int|0xFFFF
)paren
comma
id|LSB_of
c_func
(paren
id|address
op_amp
l_int|0xFFFF
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|MSB_of
c_func
(paren
id|sectors
)paren
comma
id|LSB_of
c_func
(paren
id|sectors
)paren
)brace
suffix:semicolon
id|result
op_assign
id|sddr09_send_control
c_func
(paren
id|us
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
l_int|0
comma
l_int|0x41
comma
l_int|0
comma
l_int|0
comma
id|command
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|USB_STOR_TRANSPORT_GOOD
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
id|sddr09_bulk_transport
c_func
(paren
id|us
comma
l_int|NULL
comma
l_int|0
comma
id|SCSI_DATA_READ
comma
id|content
comma
id|sectors
op_star
l_int|64
comma
id|use_sg
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|sddr09_read_deviceID
r_int
id|sddr09_read_deviceID
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_int
r_char
op_star
id|manufacturerID
comma
r_int
r_char
op_star
id|deviceID
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_char
id|command
(braket
l_int|12
)braket
op_assign
(brace
l_int|0xed
comma
l_int|0x20
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
r_char
id|content
(braket
l_int|64
)braket
suffix:semicolon
id|result
op_assign
id|sddr09_send_control
c_func
(paren
id|us
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
l_int|0
comma
l_int|0x41
comma
l_int|0
comma
l_int|0
comma
id|command
comma
l_int|12
)paren
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;Result of send_control for device ID is %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|USB_STOR_TRANSPORT_GOOD
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
id|sddr09_bulk_transport
c_func
(paren
id|us
comma
l_int|NULL
comma
l_int|0
comma
id|SCSI_DATA_READ
comma
id|content
comma
l_int|64
comma
l_int|0
)paren
suffix:semicolon
op_star
id|manufacturerID
op_assign
id|content
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|deviceID
op_assign
id|content
(braket
l_int|1
)braket
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|sddr09_read_status
r_int
id|sddr09_read_status
c_func
(paren
r_struct
id|us_data
op_star
id|us
comma
r_int
r_char
op_star
id|status
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_char
id|command
(braket
l_int|12
)braket
op_assign
(brace
l_int|0xec
comma
l_int|0x20
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
r_char
id|content
(braket
l_int|2
)braket
suffix:semicolon
id|result
op_assign
id|sddr09_send_control
c_func
(paren
id|us
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
l_int|0
comma
l_int|0x41
comma
l_int|0
comma
l_int|0
comma
id|command
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|USB_STOR_TRANSPORT_GOOD
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
id|sddr09_bulk_transport
c_func
(paren
id|us
comma
l_int|NULL
comma
l_int|0
comma
id|SCSI_DATA_READ
comma
id|status
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|sddr09_reset
r_int
id|sddr09_reset
c_func
(paren
r_struct
id|us_data
op_star
id|us
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_char
id|command
(braket
l_int|12
)braket
op_assign
(brace
l_int|0xeb
comma
l_int|0x20
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|result
op_assign
id|sddr09_send_control
c_func
(paren
id|us
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
l_int|0
comma
l_int|0x41
comma
l_int|0
comma
l_int|0
comma
id|command
comma
l_int|12
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n;static int init_sddr09(struct us_data *us) {&n;&n;&t;int result;&n;&t;unsigned char data[14];&n;&t;unsigned char command[8] = {&n;&t;&t;0xc1, 0x01, 0, 0, 0, 0, 0, 0&n;&t;};&n;&t;unsigned char command2[8] = {&n;&t;&t;0x41, 0, 0, 0, 0, 0, 0, 0&n;&t;};&n;&t;unsigned char tur[12] = {&n;&t;&t;0x03, 0x20, 0, 0, 0x0e, 0, 0, 0, 0, 0, 0, 0&n;&t;};&n;&n;&t;if ( (result = sddr09_send_control(us, command, data, 2)) !=&n;&t;&t;&t;USB_STOR_TRANSPORT_GOOD)&n;&t;&t;return result;&n;&n;&t;US_DEBUGP(&quot;SDDR09: %02X %02X&bslash;n&quot;, data[0], data[1]);&n;&n;&t;command[1] = 0x08;&n;&n;&t;if ( (result = sddr09_send_control(us, command, data, 2)) !=&n;&t;&t;&t;USB_STOR_TRANSPORT_GOOD)&n;&t;&t;return result;&n;&n;&t;US_DEBUGP(&quot;SDDR09: %02X %02X&bslash;n&quot;, data[0], data[1]);&n;&n;&t;if ( (result = sddr09_send_control(us, command2, tur, 12)) !=&n;&t;&t;&t;USB_STOR_TRANSPORT_GOOD) {&n;&t;&t;US_DEBUGP(&quot;SDDR09: request sense failed&bslash;n&quot;);&n;&t;&t;return result;&n;&t;}&n;&n;&t;if ( (result = sddr09_raw_bulk(&n;&t;&t;us, SCSI_DATA_READ, data, 14)) !=&n;&t;&t;&t;USB_STOR_TRANSPORT_GOOD) {&n;&t;&t;US_DEBUGP(&quot;SDDR09: request sense bulk in failed&bslash;n&quot;);&n;&t;&t;return result;&n;&t;}&n;&n;&t;US_DEBUGP(&quot;SDDR09: request sense worked&bslash;n&quot;);&n;&n;&t;return result;&n;}&n;*/
multiline_comment|/*&n; * Transport for the Sandisk SDDR-09&n; */
DECL|function|sddr09_transport
r_int
id|sddr09_transport
c_func
(paren
id|Scsi_Cmnd
op_star
id|srb
comma
r_struct
id|us_data
op_star
id|us
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_char
id|send_scsi_command
(braket
l_int|8
)braket
op_assign
(brace
l_int|0x41
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
id|string
(braket
l_int|64
)braket
suffix:semicolon
r_int
r_char
id|inquiry_response
(braket
l_int|36
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x80
comma
l_int|0x00
comma
l_int|0x02
comma
l_int|0x1F
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_char|&squot;S&squot;
comma
l_char|&squot;a&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;D&squot;
comma
l_char|&squot;i&squot;
comma
l_char|&squot;s&squot;
comma
l_char|&squot;k&squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot;I&squot;
comma
l_char|&squot;m&squot;
comma
l_char|&squot;a&squot;
comma
l_char|&squot;g&squot;
comma
l_char|&squot;e&squot;
comma
l_char|&squot;M&squot;
comma
l_char|&squot;a&squot;
comma
l_char|&squot;t&squot;
comma
l_char|&squot;e&squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot;S&squot;
comma
l_char|&squot;D&squot;
comma
l_char|&squot;D&squot;
comma
l_char|&squot;R&squot;
comma
l_char|&squot;0&squot;
comma
l_char|&squot;9&squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot; &squot;
)brace
suffix:semicolon
r_int
r_char
id|deviceID
suffix:semicolon
r_int
r_char
id|manufacturerID
suffix:semicolon
r_int
r_char
op_star
id|ptr
suffix:semicolon
multiline_comment|/*&n;&t;if (us-&gt;flags &amp; US_FL_NEED_INIT) {&n;&t;&t;US_DEBUGP(&quot;SDDR-09: initializing&bslash;n&quot;);&n;&t;&t;init_sddr09(us);&n;&t;&t;us-&gt;flags &amp;= ~US_FL_NEED_INIT;&n;&t;}&n;*/
id|ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|srb-&gt;request_buffer
suffix:semicolon
multiline_comment|/* Dummy up a response for INQUIRY since SDDR09 doesn&squot;t&n;&t;   respond to INQUIRY commands */
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|INQUIRY
)paren
(brace
id|memcpy
c_func
(paren
id|srb-&gt;request_buffer
comma
id|inquiry_response
comma
l_int|36
)paren
suffix:semicolon
r_return
id|USB_STOR_TRANSPORT_GOOD
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srb-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|READ_CAPACITY
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;Reading capacity...&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
id|sddr09_read_deviceID
c_func
(paren
id|us
comma
op_amp
id|manufacturerID
comma
op_amp
id|deviceID
)paren
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;Result of read_deviceID is %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|USB_STOR_TRANSPORT_GOOD
)paren
r_return
id|result
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;Device ID = %02X&bslash;n&quot;
comma
id|deviceID
)paren
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;Manuf  ID = %02X&bslash;n&quot;
comma
id|manufacturerID
)paren
suffix:semicolon
id|ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|deviceID
)paren
(brace
r_case
l_int|0x6e
suffix:colon
singleline_comment|// 1MB
r_case
l_int|0xe8
suffix:colon
r_case
l_int|0xec
suffix:colon
id|ptr
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr
(braket
l_int|5
)braket
op_assign
l_int|0x10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xea
suffix:colon
singleline_comment|// 2MB
r_case
l_int|0x64
suffix:colon
r_case
l_int|0x5d
suffix:colon
id|ptr
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr
(braket
l_int|5
)braket
op_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe3
suffix:colon
singleline_comment|// 4MB
r_case
l_int|0xe5
suffix:colon
r_case
l_int|0x6b
suffix:colon
r_case
l_int|0xd5
suffix:colon
id|ptr
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr
(braket
l_int|5
)braket
op_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe6
suffix:colon
singleline_comment|// 8MB
r_case
l_int|0xd6
suffix:colon
id|ptr
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr
(braket
l_int|5
)braket
op_assign
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x75
suffix:colon
singleline_comment|// 32MB
id|ptr
(braket
l_int|4
)braket
op_assign
l_int|0x02
suffix:semicolon
id|ptr
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|// unknown
id|ptr
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|ptr
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|USB_STOR_TRANSPORT_GOOD
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|srb-&gt;cmd_len
OL
l_int|12
suffix:semicolon
id|srb-&gt;cmd_len
op_increment
)paren
id|srb-&gt;cmnd
(braket
id|srb-&gt;cmd_len
)braket
op_assign
l_int|0
suffix:semicolon
id|srb-&gt;cmnd
(braket
l_int|1
)braket
op_assign
l_int|0x20
suffix:semicolon
id|string
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|12
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
id|string
op_plus
id|strlen
c_func
(paren
id|string
)paren
comma
l_string|&quot;%02X &quot;
comma
id|srb-&gt;cmnd
(braket
id|i
)braket
)paren
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;SDDR09: Send control for command %s&bslash;n&quot;
comma
id|string
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|sddr09_send_control
c_func
(paren
id|us
comma
id|usb_sndctrlpipe
c_func
(paren
id|us-&gt;pusb_dev
comma
l_int|0
)paren
comma
l_int|0
comma
l_int|0x41
comma
l_int|0
comma
l_int|0
comma
id|srb-&gt;cmnd
comma
l_int|12
)paren
)paren
op_ne
id|USB_STOR_TRANSPORT_GOOD
)paren
r_return
id|result
suffix:semicolon
id|US_DEBUGP
c_func
(paren
l_string|&quot;SDDR09: Control for command OK&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;request_bufflen
op_eq
l_int|0
)paren
r_return
id|USB_STOR_TRANSPORT_GOOD
suffix:semicolon
r_if
c_cond
(paren
id|srb-&gt;sc_data_direction
op_eq
id|SCSI_DATA_WRITE
op_logical_or
id|srb-&gt;sc_data_direction
op_eq
id|SCSI_DATA_READ
)paren
(brace
id|US_DEBUGP
c_func
(paren
l_string|&quot;SDDR09: %s %d bytes&bslash;n&quot;
comma
id|srb-&gt;sc_data_direction
op_eq
id|SCSI_DATA_WRITE
ques
c_cond
l_string|&quot;sending&quot;
suffix:colon
l_string|&quot;receiving&quot;
comma
id|srb-&gt;request_bufflen
)paren
suffix:semicolon
id|result
op_assign
id|sddr09_bulk_transport
c_func
(paren
id|us
comma
l_int|NULL
comma
l_int|0
comma
id|srb-&gt;sc_data_direction
comma
id|srb-&gt;request_buffer
comma
id|srb-&gt;request_bufflen
comma
id|srb-&gt;use_sg
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_return
id|USB_STOR_TRANSPORT_GOOD
suffix:semicolon
)brace
eof
