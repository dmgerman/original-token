multiline_comment|/*&n; * IEEE 1394 for Linux&n; *&n; * GUID collection and management&n; *&n; * Copyright (C) 2000 Andreas E. Bombe&n; *&n; * This code is licensed under the GPL.  See the file COPYING in the root&n; * directory of the kernel sources for details.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_transactions.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;csr.h&quot;
DECL|variable|outstanding_requests
r_static
id|atomic_t
id|outstanding_requests
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|guid_list
)paren
suffix:semicolon
DECL|variable|guid_lock
id|rwlock_t
id|guid_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|struct|guid_entry
r_struct
id|guid_entry
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|refcount
id|atomic_t
id|refcount
suffix:semicolon
DECL|member|guid
id|u64
id|guid
suffix:semicolon
DECL|member|host
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
DECL|member|node_id
id|nodeid_t
id|node_id
suffix:semicolon
DECL|member|generation
id|atomic_t
id|generation
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|guid_req
r_struct
id|guid_req
(brace
DECL|member|pkt
r_struct
id|hpsb_packet
op_star
id|pkt
suffix:semicolon
DECL|member|tq
r_struct
id|tq_struct
id|tq
suffix:semicolon
)brace
suffix:semicolon
DECL|function|create_guid_entry
r_static
r_struct
id|guid_entry
op_star
id|create_guid_entry
c_func
(paren
r_void
)paren
(brace
r_struct
id|guid_entry
op_star
id|ge
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ge
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|guid_entry
)paren
comma
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ge
)paren
r_return
l_int|NULL
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ge-&gt;list
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ge-&gt;refcount
comma
l_int|0
)paren
suffix:semicolon
id|ge-&gt;guid
op_assign
(paren
id|u64
)paren
op_minus
l_int|1
suffix:semicolon
id|ge-&gt;host
op_assign
l_int|NULL
suffix:semicolon
id|ge-&gt;node_id
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ge-&gt;generation
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|guid_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ge-&gt;list
comma
op_amp
id|guid_list
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|guid_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ge
suffix:semicolon
)brace
DECL|function|find_entry
r_static
r_struct
id|guid_entry
op_star
id|find_entry
c_func
(paren
id|u64
id|guid
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|guid_entry
op_star
id|ge
suffix:semicolon
id|lh
op_assign
id|guid_list.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|guid_list
)paren
(brace
id|ge
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|guid_entry
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ge-&gt;guid
op_eq
id|guid
)paren
r_return
id|ge
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|associate_guid
r_static
r_void
id|associate_guid
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
id|nodeid_t
id|nodeid
comma
id|u64
id|guid
)paren
(brace
r_struct
id|guid_entry
op_star
id|ge
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|HPSB_DEBUG
c_func
(paren
l_string|&quot;node %d on host 0x%p has GUID 0x%08x%08x&quot;
comma
id|nodeid
op_amp
id|NODE_MASK
comma
id|host
comma
(paren
r_int
r_int
)paren
(paren
id|guid
op_rshift
l_int|32
)paren
comma
(paren
r_int
r_int
)paren
(paren
id|guid
op_amp
l_int|0xffffffff
)paren
)paren
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|guid_lock
comma
id|flags
)paren
suffix:semicolon
id|ge
op_assign
id|find_entry
c_func
(paren
id|guid
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|guid_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ge
)paren
id|ge
op_assign
id|create_guid_entry
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ge
)paren
r_return
suffix:semicolon
id|ge-&gt;host
op_assign
id|host
suffix:semicolon
id|ge-&gt;node_id
op_assign
id|nodeid
suffix:semicolon
id|ge-&gt;guid
op_assign
id|guid
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ge-&gt;generation
comma
id|get_hpsb_generation
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|pkt_complete
r_static
r_void
id|pkt_complete
c_func
(paren
r_struct
id|guid_req
op_star
id|req
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|pkt
op_assign
id|req-&gt;pkt
suffix:semicolon
r_int
id|rcode
op_assign
(paren
id|pkt-&gt;header
(braket
l_int|1
)braket
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;ack_code
op_eq
id|ACK_PENDING
op_logical_and
id|rcode
op_eq
id|RCODE_COMPLETE
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
r_char
op_star
)paren
id|pkt-&gt;data
OG
l_int|1
)paren
(brace
id|associate_guid
c_func
(paren
id|pkt-&gt;host
comma
id|pkt-&gt;node_id
comma
(paren
(paren
id|u64
)paren
id|be32_to_cpu
c_func
(paren
id|pkt-&gt;data
(braket
l_int|3
)braket
)paren
op_lshift
l_int|32
)paren
op_or
id|be32_to_cpu
c_func
(paren
id|pkt-&gt;data
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|HPSB_DEBUG
c_func
(paren
l_string|&quot;minimal ROM on node %d&quot;
comma
id|pkt-&gt;node_id
op_amp
id|NODE_MASK
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|HPSB_DEBUG
c_func
(paren
l_string|&quot;guid transaction error: ack %d, rcode %d&quot;
comma
id|pkt-&gt;ack_code
comma
id|rcode
)paren
suffix:semicolon
)brace
id|free_tlabel
c_func
(paren
id|pkt-&gt;host
comma
id|pkt-&gt;node_id
comma
id|pkt-&gt;tlabel
)paren
suffix:semicolon
id|free_hpsb_packet
c_func
(paren
id|pkt
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|outstanding_requests
)paren
)paren
(brace
multiline_comment|/* FIXME: free unreferenced and inactive GUID entries. */
)brace
)brace
DECL|function|host_reset
r_static
r_void
id|host_reset
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|guid_req
op_star
id|greq
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|pkt
suffix:semicolon
r_struct
id|selfid
op_star
id|sid
op_assign
(paren
r_struct
id|selfid
op_star
)paren
id|host-&gt;topology_map
suffix:semicolon
r_int
id|nodecount
op_assign
id|host-&gt;node_count
suffix:semicolon
id|nodeid_t
id|nodeid
op_assign
id|LOCAL_BUS
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|nodecount
suffix:semicolon
id|nodecount
op_decrement
comma
id|nodeid
op_increment
comma
id|sid
op_increment
)paren
(brace
r_while
c_loop
(paren
id|sid-&gt;extended
)paren
id|sid
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sid-&gt;link_active
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|nodeid
op_eq
id|host-&gt;node_id
)paren
r_continue
suffix:semicolon
id|greq
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|guid_req
)paren
comma
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|greq
)paren
(brace
id|HPSB_ERR
c_func
(paren
l_string|&quot;out of memory in GUID processing&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pkt
op_assign
id|hpsb_make_readbpacket
c_func
(paren
id|host
comma
id|nodeid
comma
id|CSR_REGISTER_BASE
op_plus
id|CSR_CONFIG_ROM
comma
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
(brace
id|kfree
c_func
(paren
id|greq
)paren
suffix:semicolon
id|HPSB_ERR
c_func
(paren
l_string|&quot;out of memory in GUID processing&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|greq-&gt;tq.list
)paren
suffix:semicolon
id|greq-&gt;tq.sync
op_assign
l_int|0
suffix:semicolon
id|greq-&gt;tq.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|pkt_complete
suffix:semicolon
id|greq-&gt;tq.data
op_assign
id|greq
suffix:semicolon
id|greq-&gt;pkt
op_assign
id|pkt
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|greq-&gt;tq
comma
op_amp
id|pkt-&gt;complete_tq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpsb_send_packet
c_func
(paren
id|pkt
)paren
)paren
(brace
id|free_tlabel
c_func
(paren
id|pkt-&gt;host
comma
id|pkt-&gt;node_id
comma
id|pkt-&gt;tlabel
)paren
suffix:semicolon
id|free_hpsb_packet
c_func
(paren
id|pkt
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|greq
)paren
suffix:semicolon
id|HPSB_NOTICE
c_func
(paren
l_string|&quot;failed to send packet in GUID processing&quot;
)paren
suffix:semicolon
)brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;GUID request sent to node %d&quot;
comma
id|nodeid
op_amp
id|NODE_MASK
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|outstanding_requests
)paren
suffix:semicolon
)brace
)brace
DECL|function|hpsb_guid_get_handle
r_struct
id|guid_entry
op_star
id|hpsb_guid_get_handle
c_func
(paren
id|u64
id|guid
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|guid_entry
op_star
id|ge
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|guid_lock
comma
id|flags
)paren
suffix:semicolon
id|ge
op_assign
id|find_entry
c_func
(paren
id|guid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ge
)paren
id|atomic_inc
c_func
(paren
op_amp
id|ge-&gt;refcount
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|guid_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ge
suffix:semicolon
)brace
DECL|function|hpsb_guid_localhost
r_struct
id|hpsb_host
op_star
id|hpsb_guid_localhost
c_func
(paren
r_struct
id|guid_entry
op_star
id|ge
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ge-&gt;generation
)paren
op_ne
id|get_hpsb_generation
c_func
(paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ge-&gt;node_id
op_eq
id|ge-&gt;host-&gt;node_id
)paren
r_return
id|ge-&gt;host
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|hpsb_guid_fill_packet
r_int
id|hpsb_guid_fill_packet
c_func
(paren
r_struct
id|guid_entry
op_star
id|ge
comma
r_struct
id|hpsb_packet
op_star
id|pkt
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ge-&gt;generation
)paren
op_ne
id|get_hpsb_generation
c_func
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|pkt-&gt;host
op_assign
id|ge-&gt;host
suffix:semicolon
id|pkt-&gt;node_id
op_assign
id|ge-&gt;node_id
suffix:semicolon
id|pkt-&gt;generation
op_assign
id|atomic_read
c_func
(paren
op_amp
id|ge-&gt;generation
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|guid_ops
r_static
r_struct
id|hpsb_highlevel_ops
id|guid_ops
op_assign
(brace
id|host_reset
suffix:colon
id|host_reset
comma
)brace
suffix:semicolon
DECL|function|init_ieee1394_guid
r_void
id|init_ieee1394_guid
c_func
(paren
r_void
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|outstanding_requests
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpsb_register_highlevel
c_func
(paren
l_string|&quot;GUID manager&quot;
comma
op_amp
id|guid_ops
)paren
)paren
(brace
id|HPSB_ERR
c_func
(paren
l_string|&quot;out of memory during ieee1394 initialization&quot;
)paren
suffix:semicolon
)brace
)brace
eof
