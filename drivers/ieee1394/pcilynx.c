multiline_comment|/*&n; * ti_pcilynx.c - Texas Instruments PCILynx driver&n; * Copyright (C) 1999,2000 Andreas Bombe &lt;andreas.bombe@munich.netsurf.de&gt;,&n; *                         Stephan Linz &lt;linz@mazet.de&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
multiline_comment|/*&n; * Lynx DMA usage:&n; *&n; * 0 is used for Lynx local bus transfers&n; * 1 is async/selfid receive&n; * 2 is iso receive&n; * 3 is async transmit&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;pcilynx.h&quot;
macro_line|#if MAX_PCILYNX_CARDS &gt; PCILYNX_MINOR_ROM_START
macro_line|#error Max number of cards is bigger than PCILYNX_MINOR_ROM_START - this does not work.
macro_line|#endif
multiline_comment|/* print general (card independent) information */
DECL|macro|PRINT_G
mdefine_line|#define PRINT_G(level, fmt, args...) printk(level &quot;pcilynx: &quot; fmt &quot;&bslash;n&quot; , ## args)
multiline_comment|/* print card specific information */
DECL|macro|PRINT
mdefine_line|#define PRINT(level, card, fmt, args...) printk(level &quot;pcilynx%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
DECL|variable|cards
r_static
r_struct
id|ti_lynx
id|cards
(braket
id|MAX_PCILYNX_CARDS
)braket
suffix:semicolon
DECL|variable|num_of_cards
r_static
r_int
id|num_of_cards
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * PCL handling functions.&n; */
DECL|function|alloc_pcl
r_static
id|pcl_t
id|alloc_pcl
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
id|u8
id|m
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* FIXME - use ffz() to make this readable */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LOCALRAM_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m
op_assign
id|lynx-&gt;pcl_bmap
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|m
op_amp
l_int|1
op_lshift
id|j
)paren
(brace
r_continue
suffix:semicolon
)brace
id|m
op_or_assign
l_int|1
op_lshift
id|j
suffix:semicolon
id|lynx-&gt;pcl_bmap
(braket
id|i
)braket
op_assign
id|m
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
r_return
l_int|8
op_star
id|i
op_plus
id|j
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|free_pcl
r_static
r_void
id|free_pcl
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
id|pcl_t
id|pclid
)paren
(brace
r_int
id|off
comma
id|bit
suffix:semicolon
id|off
op_assign
id|pclid
op_div
l_int|8
suffix:semicolon
id|bit
op_assign
id|pclid
op_mod
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|pclid
OL
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;pcl_bmap
(braket
id|off
)braket
op_amp
l_int|1
op_lshift
id|bit
)paren
(brace
id|lynx-&gt;pcl_bmap
(braket
id|off
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|bit
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;attempted to free unallocated PCL %d&quot;
comma
id|pclid
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* functions useful for debugging */
DECL|function|pretty_print_pcl
r_static
r_void
id|pretty_print_pcl
c_func
(paren
r_const
r_struct
id|ti_pcl
op_star
id|pcl
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCL next %08x, userdata %08x, status %08x, remtrans %08x, nextbuf %08x&bslash;n&quot;
comma
id|pcl-&gt;next
comma
id|pcl-&gt;user_data
comma
id|pcl-&gt;pcl_status
comma
id|pcl-&gt;remaining_transfer_count
comma
id|pcl-&gt;next_data_buffer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCL&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; c%x:%08x d%x:%08x&quot;
comma
id|i
comma
id|pcl-&gt;buffer
(braket
id|i
)braket
dot
id|control
comma
id|i
comma
id|pcl-&gt;buffer
(braket
id|i
)braket
dot
id|pointer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
l_int|0x3
)paren
op_logical_and
(paren
id|i
op_ne
l_int|12
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;nPCL&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|print_pcl
r_static
r_void
id|print_pcl
c_func
(paren
r_const
r_struct
id|ti_lynx
op_star
id|lynx
comma
id|pcl_t
id|pclid
)paren
(brace
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
id|get_pcl
c_func
(paren
id|lynx
comma
id|pclid
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|pretty_print_pcl
c_func
(paren
op_amp
id|pcl
)paren
suffix:semicolon
)brace
r_static
r_int
id|add_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
suffix:semicolon
r_static
r_int
id|init_driver
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/***********************************&n; * IEEE-1394 functionality section *&n; ***********************************/
DECL|function|get_phy_reg
r_static
r_int
id|get_phy_reg
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_int
id|addr
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|addr
OG
l_int|15
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY register address %d out of range&quot;
comma
id|addr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_do
(brace
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_PHY
comma
id|LINK_PHY_READ
op_or
id|LINK_PHY_ADDR
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|LINK_PHY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|10000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: runaway loop, aborting&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|retval
op_amp
l_int|0xf00
)paren
op_ne
id|LINK_PHY_RADDR
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_INT_STATUS
comma
id|LINK_INT_PHY_REG_RCVD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
op_minus
l_int|1
)paren
(brace
r_return
id|retval
op_amp
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|set_phy_reg
r_static
r_int
id|set_phy_reg
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_int
id|addr
comma
r_int
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|addr
OG
l_int|15
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY register address %d out of range&quot;
comma
id|addr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
OG
l_int|0xff
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY register value %d out of range&quot;
comma
id|val
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_PHY
comma
id|LINK_PHY_WRITE
op_or
id|LINK_PHY_ADDR
c_func
(paren
id|addr
)paren
op_or
id|LINK_PHY_WDATA
c_func
(paren
id|val
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sel_phy_reg_page
r_static
r_int
id|sel_phy_reg_page
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_int
id|page
)paren
(brace
r_int
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|page
OG
l_int|7
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY page %d out of range&quot;
comma
id|page
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_ne
op_minus
l_int|1
)paren
(brace
id|reg
op_and_assign
l_int|0x1f
suffix:semicolon
id|reg
op_or_assign
(paren
id|page
op_lshift
l_int|5
)paren
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|7
comma
id|reg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#if 0 /* not needed at this time */
r_static
r_int
id|sel_phy_reg_port
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_int
id|port
)paren
(brace
r_int
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|port
OG
l_int|15
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY port %d out of range&quot;
comma
id|port
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_ne
op_minus
l_int|1
)paren
(brace
id|reg
op_and_assign
l_int|0xf0
suffix:semicolon
id|reg
op_or_assign
id|port
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|7
comma
id|reg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|get_phy_vendorid
r_static
id|u32
id|get_phy_vendorid
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
id|u32
id|pvid
op_assign
l_int|0
suffix:semicolon
id|sel_phy_reg_page
c_func
(paren
id|lynx
comma
l_int|1
)paren
suffix:semicolon
id|pvid
op_or_assign
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|10
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|pvid
op_or_assign
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|11
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|pvid
op_or_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|12
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;PHY vendor id 0x%06x&quot;
comma
id|pvid
)paren
suffix:semicolon
r_return
id|pvid
suffix:semicolon
)brace
DECL|function|get_phy_productid
r_static
id|u32
id|get_phy_productid
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
id|u32
id|id
op_assign
l_int|0
suffix:semicolon
id|sel_phy_reg_page
c_func
(paren
id|lynx
comma
l_int|1
)paren
suffix:semicolon
id|id
op_or_assign
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|13
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|id
op_or_assign
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|14
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|id
op_or_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|15
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;PHY product id 0x%06x&quot;
comma
id|id
)paren
suffix:semicolon
r_return
id|id
suffix:semicolon
)brace
DECL|function|generate_own_selfid
r_static
id|quadlet_t
id|generate_own_selfid
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
id|quadlet_t
id|lsid
suffix:semicolon
r_char
id|phyreg
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
id|phyreg
(braket
id|i
)braket
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME? We assume a TSB21LV03A phy here.  This code doesn&squot;t support&n;           more than 3 ports on the PHY anyway. */
id|lsid
op_assign
l_int|0x80400000
op_or
(paren
(paren
id|phyreg
(braket
l_int|0
)braket
op_amp
l_int|0xfc
)paren
op_lshift
l_int|22
)paren
suffix:semicolon
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|1
)braket
op_amp
l_int|0x3f
)paren
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* gap count */
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|2
)braket
op_amp
l_int|0xc0
)paren
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* max speed */
multiline_comment|/* lsid |= (phyreg[6] &amp; 0x01) &lt;&lt; 11; */
multiline_comment|/* contender (phy dependent) */
id|lsid
op_or_assign
l_int|1
op_lshift
l_int|11
suffix:semicolon
multiline_comment|/* set contender (hack) */
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|6
)braket
op_amp
l_int|0x10
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* initiated reset */
singleline_comment|//for (i = 0; i &lt; (phyreg[2] &amp; 0xf); i++) { /* ports */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|phyreg
(braket
l_int|2
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* ports */
r_if
c_cond
(paren
id|phyreg
(braket
l_int|3
op_plus
id|i
)braket
op_amp
l_int|0x4
)paren
(brace
id|lsid
op_or_assign
(paren
(paren
(paren
id|phyreg
(braket
l_int|3
op_plus
id|i
)braket
op_amp
l_int|0x8
)paren
op_or
l_int|0x10
)paren
op_rshift
l_int|3
)paren
op_lshift
(paren
l_int|6
op_minus
id|i
op_star
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|lsid
op_or_assign
l_int|1
op_lshift
(paren
l_int|6
op_minus
id|i
op_star
l_int|2
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;-%d- generated own selfid 0x%x&bslash;n&quot;
comma
id|lynx-&gt;id
comma
id|lsid
)paren
suffix:semicolon
r_return
id|lsid
suffix:semicolon
)brace
DECL|function|handle_selfid
r_static
r_void
id|handle_selfid
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|size
)paren
(brace
id|quadlet_t
op_star
id|q
op_assign
id|lynx-&gt;rcv_page
suffix:semicolon
r_int
id|phyid
comma
id|isroot
suffix:semicolon
id|quadlet_t
id|lsid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
)paren
(brace
id|lsid
op_assign
id|generate_own_selfid
c_func
(paren
id|lynx
comma
id|host
)paren
suffix:semicolon
)brace
id|phyid
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|0
)paren
suffix:semicolon
id|isroot
op_assign
(paren
id|phyid
op_amp
l_int|2
)paren
op_ne
l_int|0
suffix:semicolon
id|phyid
op_rshift_assign
l_int|2
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;SelfID process finished (phyid %d, %s)&quot;
comma
id|phyid
comma
(paren
id|isroot
ques
c_cond
l_string|&quot;root&quot;
suffix:colon
l_string|&quot;not root&quot;
)paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_ID
comma
(paren
l_int|0xffc0
op_or
id|phyid
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
op_logical_and
op_logical_neg
id|size
)paren
(brace
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|lsid
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
op_logical_and
(paren
id|q
(braket
l_int|0
)braket
op_amp
l_int|0x3f800000
)paren
op_eq
(paren
(paren
id|phyid
op_plus
l_int|1
)paren
op_lshift
l_int|24
)paren
)paren
(brace
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|lsid
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|q
(braket
l_int|0
)braket
op_eq
op_complement
id|q
(braket
l_int|1
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;-%d- selfid packet 0x%x rcvd&bslash;n&quot;
comma
id|lynx-&gt;id
comma
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;-%d- inconsistent selfid 0x%x/0x%x&bslash;n&quot;
comma
id|lynx-&gt;id
comma
id|q
(braket
l_int|0
)braket
comma
id|q
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|q
op_add_assign
l_int|2
suffix:semicolon
id|size
op_sub_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
op_logical_and
id|isroot
op_logical_and
id|phyid
op_ne
l_int|0
)paren
(brace
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|lsid
)paren
suffix:semicolon
)brace
id|hpsb_selfid_complete
c_func
(paren
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
)brace
multiline_comment|/* This must be called with the async_queue_lock held. */
DECL|function|send_next_async
r_static
r_void
id|send_next_async
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
op_assign
id|lynx-&gt;async_queue
suffix:semicolon
id|pcl.next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.async_error_next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
macro_line|#ifdef __BIG_ENDIAN
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_XMT
op_or
id|packet-&gt;speed_code
op_lshift
l_int|14
op_or
id|packet-&gt;header_size
suffix:semicolon
macro_line|#else
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_XMT
op_or
id|packet-&gt;speed_code
op_lshift
l_int|14
op_or
id|packet-&gt;header_size
op_or
id|PCL_BIGENDIAN
suffix:semicolon
macro_line|#endif
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|pointer
op_assign
id|virt_to_bus
c_func
(paren
id|packet-&gt;header
)paren
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|control
op_assign
id|PCL_LAST_BUFF
op_or
id|packet-&gt;data_size
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|pointer
op_assign
id|virt_to_bus
c_func
(paren
id|packet-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet-&gt;data_be
)paren
(brace
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|control
op_or_assign
id|PCL_BIGENDIAN
suffix:semicolon
)brace
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;async_pcl
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|run_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;async_pcl_start
comma
l_int|3
)paren
suffix:semicolon
)brace
DECL|function|lynx_detect
r_static
r_int
id|lynx_detect
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
r_int
id|i
suffix:semicolon
id|init_driver
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_of_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|host
op_assign
id|hpsb_get_host
c_func
(paren
id|tmpl
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* simply don&squot;t init more after out of mem */
r_return
id|i
suffix:semicolon
)brace
id|host-&gt;hostdata
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
id|cards
(braket
id|i
)braket
dot
id|host
op_assign
id|host
suffix:semicolon
)brace
r_return
id|num_of_cards
suffix:semicolon
)brace
DECL|function|lynx_initialize
r_static
r_int
id|lynx_initialize
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_lynx
op_star
id|lynx
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
op_star
id|pcli
suffix:semicolon
id|lynx-&gt;async_queue
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lynx-&gt;async_queue_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
)paren
suffix:semicolon
id|pcl.next
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl
)paren
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl_start
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|pcl.next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.async_error_next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
macro_line|#ifdef __BIG_ENDIAN
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_RCV
op_or
l_int|2048
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|control
op_assign
id|PCL_LAST_BUFF
op_or
l_int|2048
suffix:semicolon
macro_line|#else
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_RCV
op_or
id|PCL_BIGENDIAN
op_or
l_int|2048
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|control
op_assign
id|PCL_LAST_BUFF
op_or
id|PCL_BIGENDIAN
op_or
l_int|2048
suffix:semicolon
macro_line|#endif
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|pointer
op_assign
id|virt_to_bus
c_func
(paren
id|lynx-&gt;rcv_page
)paren
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|pointer
op_assign
id|virt_to_bus
c_func
(paren
id|lynx-&gt;rcv_page
)paren
op_plus
l_int|2048
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|pcl.next
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;async_pcl
)paren
suffix:semicolon
id|pcl.async_error_next
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;async_pcl
)paren
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;async_pcl_start
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|pcl.next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.async_error_next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_RCV
op_or
id|PCL_LAST_BUFF
op_or
l_int|2048
suffix:semicolon
macro_line|#ifndef __BIG_ENDIAN
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_or_assign
id|PCL_BIGENDIAN
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ISORCV_PCL
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|page
op_assign
id|i
op_div
id|ISORCV_PER_PAGE
suffix:semicolon
r_int
id|sec
op_assign
id|i
op_mod
id|ISORCV_PER_PAGE
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|pointer
op_assign
id|virt_to_bus
c_func
(paren
id|lynx-&gt;iso_rcv.page
(braket
id|page
)braket
)paren
op_plus
id|sec
op_star
id|MAX_ISORCV_SIZE
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl
(braket
id|i
)braket
comma
op_amp
id|pcl
)paren
suffix:semicolon
)brace
id|pcli
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|pcl
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ISORCV_PCL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pcli
(braket
id|i
)braket
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl_start
comma
op_amp
id|pcl
)paren
suffix:semicolon
multiline_comment|/* 85 bytes for each FIFO - FIXME - optimize or make configurable */
id|reg_write
c_func
(paren
id|lynx
comma
id|FIFO_SIZES
comma
l_int|0x00555555
)paren
suffix:semicolon
multiline_comment|/* 20 byte threshold before triggering PCI transfer */
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_GLOBAL_REGISTER
comma
l_int|0x2
op_lshift
l_int|24
)paren
suffix:semicolon
multiline_comment|/* 69 byte threshold on both send FIFOs before transmitting */
id|reg_write
c_func
(paren
id|lynx
comma
id|FIFO_XMIT_THRESHOLD
comma
l_int|0x4545
)paren
suffix:semicolon
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|PCI_INT_ENABLE
comma
id|PCI_INT_1394
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_INT_ENABLE
comma
id|LINK_INT_PHY_TIMEOUT
op_or
id|LINK_INT_PHY_REG_RCVD
op_or
id|LINK_INT_PHY_BUSRESET
op_or
id|LINK_INT_ISO_STUCK
op_or
id|LINK_INT_ASYNC_STUCK
op_or
id|LINK_INT_SENT_REJECT
op_or
id|LINK_INT_TX_INVALID_TC
op_or
id|LINK_INT_GRF_OVERFLOW
op_or
id|LINK_INT_ITF_UNDERFLOW
op_or
id|LINK_INT_ATF_UNDERFLOW
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA1_WORD0_CMP_VALUE
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA1_WORD0_CMP_ENABLE
comma
l_int|0xa
op_lshift
l_int|4
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA1_WORD1_CMP_VALUE
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA1_WORD1_CMP_ENABLE
comma
id|DMA_WORD1_CMP_MATCH_NODE_BCAST
op_or
id|DMA_WORD1_CMP_MATCH_BROADCAST
op_or
id|DMA_WORD1_CMP_MATCH_LOCAL
op_or
id|DMA_WORD1_CMP_MATCH_BUS_BCAST
op_or
id|DMA_WORD1_CMP_ENABLE_SELF_ID
op_or
id|DMA_WORD1_CMP_ENABLE_MASTER
)paren
suffix:semicolon
id|run_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl_start
comma
l_int|1
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD0_CMP_VALUE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD0_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0x9
op_lshift
l_int|4
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_VALUE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
id|run_sub_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl_start
comma
l_int|0
comma
id|CHANNEL_ISO_RCV
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_CONTROL
comma
id|LINK_CONTROL_RCV_CMP_VALID
op_or
id|LINK_CONTROL_TX_ISO_EN
op_or
id|LINK_CONTROL_RX_ISO_EN
op_or
id|LINK_CONTROL_TX_ASYNC_EN
op_or
id|LINK_CONTROL_RX_ASYNC_EN
op_or
id|LINK_CONTROL_RESET_TX
op_or
id|LINK_CONTROL_RESET_RX
op_or
id|LINK_CONTROL_CYCSOURCE
op_or
id|LINK_CONTROL_CYCTIMEREN
)paren
suffix:semicolon
multiline_comment|/* attempt to enable contender bit -FIXME- would this work elsewhere? */
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|GPIO_CTRL_A
comma
l_int|0x1
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|GPIO_DATA_BASE
op_plus
l_int|0x3c
comma
l_int|0x1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|lynx_release
r_static
r_void
id|lynx_release
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_lynx
op_star
id|lynx
suffix:semicolon
r_if
c_cond
(paren
id|host
op_ne
l_int|NULL
)paren
(brace
id|lynx
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|remove_card
c_func
(paren
id|lynx
)paren
suffix:semicolon
)brace
r_else
(brace
id|unregister_chrdev
c_func
(paren
id|PCILYNX_MAJOR
comma
id|PCILYNX_DRIVER_NAME
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * FIXME - does not support iso/raw transmits yet and will choke on them.&n; */
DECL|function|lynx_transmit
r_static
r_int
id|lynx_transmit
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_struct
id|ti_lynx
op_star
id|lynx
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|p
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
op_ge
l_int|4096
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;transmit packet data too big (%d)&quot;
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|packet-&gt;xnext
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;async_queue
op_eq
l_int|NULL
)paren
(brace
id|lynx-&gt;async_queue
op_assign
id|packet
suffix:semicolon
id|send_next_async
c_func
(paren
id|lynx
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|lynx-&gt;async_queue
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;xnext
op_ne
l_int|NULL
)paren
(brace
id|p
op_assign
id|p-&gt;xnext
suffix:semicolon
)brace
id|p-&gt;xnext
op_assign
id|packet
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|lynx_devctl
r_static
r_int
id|lynx_devctl
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_enum
id|devctl_cmd
id|cmd
comma
r_int
id|arg
)paren
(brace
r_struct
id|ti_lynx
op_star
id|lynx
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
comma
op_star
id|lastpacket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RESET_BUS
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|arg
op_assign
l_int|3
op_lshift
l_int|6
suffix:semicolon
)brace
r_else
(brace
id|arg
op_assign
l_int|1
op_lshift
l_int|6
suffix:semicolon
)brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;resetting bus on request%s&quot;
comma
(paren
id|host-&gt;attempt_root
ques
c_cond
l_string|&quot; and attempting to become root&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_PHY
comma
id|LINK_PHY_WRITE
op_or
id|LINK_PHY_ADDR
c_func
(paren
l_int|1
)paren
op_or
id|LINK_PHY_WDATA
c_func
(paren
id|arg
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GET_CYCLE_COUNTER
suffix:colon
id|retval
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|CYCLE_TIMER
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_CYCLE_COUNTER
suffix:colon
id|reg_write
c_func
(paren
id|lynx
comma
id|CYCLE_TIMER
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_BUS_ID
suffix:colon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_ID
comma
(paren
id|arg
op_lshift
l_int|22
)paren
op_or
(paren
id|reg_read
c_func
(paren
id|lynx
comma
id|LINK_ID
)paren
op_amp
l_int|0x003f0000
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT_CYCLE_MASTER
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|LINK_CONTROL
comma
id|LINK_CONTROL_CYCMASTER
)paren
suffix:semicolon
)brace
r_else
(brace
id|reg_clear_bits
c_func
(paren
id|lynx
comma
id|LINK_CONTROL
comma
id|LINK_CONTROL_CYCMASTER
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CANCEL_REQUESTS
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA3_CHAN_CTRL
comma
l_int|0
)paren
suffix:semicolon
id|packet
op_assign
id|lynx-&gt;async_queue
suffix:semicolon
id|lynx-&gt;async_queue
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|packet
op_ne
l_int|NULL
)paren
(brace
id|lastpacket
op_assign
id|packet
suffix:semicolon
id|packet
op_assign
id|packet-&gt;xnext
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|lastpacket
comma
id|ACKX_ABORTED
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MODIFY_USAGE
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISO_LISTEN_CHANNEL
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;iso_rcv.chan_count
op_increment
op_eq
l_int|0
)paren
(brace
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
id|DMA_WORD1_CMP_ENABLE_MASTER
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISO_UNLISTEN_CHANNEL
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|lynx-&gt;iso_rcv.chan_count
op_eq
l_int|0
)paren
(brace
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;unknown devctl command %d&quot;
comma
id|cmd
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/***************************************&n; * IEEE-1394 functionality section END *&n; ***************************************/
multiline_comment|/* VFS functions for local bus / aux device access.  Access to those&n; * is implemented as a character device instead of block devices&n; * because buffers are not wanted for this.  Therefore llseek (from&n; * VFS) can be used for these char devices with obvious effects.&n; */
r_static
r_int
id|mem_open
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|mem_release
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
r_int
id|aux_poll
c_func
(paren
r_struct
id|file
op_star
comma
r_struct
id|poll_table_struct
op_star
)paren
suffix:semicolon
r_static
id|ssize_t
id|mem_read
(paren
r_struct
id|file
op_star
comma
r_char
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
r_static
id|ssize_t
id|mem_write
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
DECL|variable|aux_ops
r_static
r_struct
id|file_operations
id|aux_ops
op_assign
(brace
multiline_comment|/* FIXME: should have custom llseek with bounds checking */
id|read
suffix:colon
id|mem_read
comma
id|write
suffix:colon
id|mem_write
comma
id|poll
suffix:colon
id|aux_poll
comma
id|open
suffix:colon
id|mem_open
comma
id|release
suffix:colon
id|mem_release
comma
)brace
suffix:semicolon
DECL|function|aux_setup_pcls
r_static
r_void
id|aux_setup_pcls
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
r_int
r_int
id|membufbus
op_assign
id|virt_to_bus
c_func
(paren
id|lynx-&gt;mem_dma_buffer
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* This pcl is used to start any aux transfers, the pointer to next&n;           points to itself to avoid a dummy pcl (the PCL engine only executes&n;           the next pcl on startup.  The real chain is done by branch */
id|pcl.next
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.start
)paren
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_BRANCH
op_or
id|PCL_COND_DMARDY_SET
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|pointer
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.max
)paren
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|control
op_assign
id|PCL_CMD_BRANCH
op_or
id|PCL_COND_DMARDY_CLEAR
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|pointer
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.cmd
)paren
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.start
comma
op_amp
id|pcl
)paren
suffix:semicolon
multiline_comment|/* let maxpcl transfer exactly 32kB */
id|pcl.next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pcl.buffer
(braket
id|i
)braket
dot
id|control
op_assign
l_int|4000
suffix:semicolon
id|pcl.buffer
(braket
id|i
)braket
dot
id|pointer
op_assign
id|membufbus
op_plus
id|i
op_star
l_int|4000
suffix:semicolon
)brace
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_or_assign
id|PCL_CMD_LBUS_TO_PCI
multiline_comment|/*| PCL_GEN_INTR*/
suffix:semicolon
id|pcl.buffer
(braket
l_int|8
)braket
dot
id|control
op_assign
l_int|768
op_or
id|PCL_LAST_BUFF
suffix:semicolon
id|pcl.buffer
(braket
l_int|8
)braket
dot
id|pointer
op_assign
id|membufbus
op_plus
l_int|8
op_star
l_int|4000
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.max
comma
op_amp
id|pcl
)paren
suffix:semicolon
multiline_comment|/* magic stuff - self and modpcl modifying pcl */
id|pcl.next
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.mod
)paren
suffix:semicolon
id|pcl.user_data
op_assign
l_int|4000
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_LOAD
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|pointer
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.cmd
)paren
op_plus
id|pcloffs
c_func
(paren
id|user_data
)paren
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|control
op_assign
id|PCL_CMD_STOREQ
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|pointer
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.mod
)paren
op_plus
id|pcloffs
c_func
(paren
id|buffer
(braket
l_int|1
)braket
dot
id|control
)paren
suffix:semicolon
id|pcl.buffer
(braket
l_int|2
)braket
dot
id|control
op_assign
id|PCL_CMD_LOAD
suffix:semicolon
id|pcl.buffer
(braket
l_int|2
)braket
dot
id|pointer
op_assign
id|membufbus
suffix:semicolon
id|pcl.buffer
(braket
l_int|3
)braket
dot
id|control
op_assign
id|PCL_CMD_STOREQ
suffix:semicolon
id|pcl.buffer
(braket
l_int|3
)braket
dot
id|pointer
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.cmd
)paren
op_plus
id|pcloffs
c_func
(paren
id|buffer
(braket
l_int|1
)braket
dot
id|pointer
)paren
suffix:semicolon
id|pcl.buffer
(braket
l_int|4
)braket
dot
id|control
op_assign
id|PCL_CMD_STOREQ
suffix:semicolon
id|pcl.buffer
(braket
l_int|4
)braket
dot
id|pointer
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.cmd
)paren
op_plus
id|pcloffs
c_func
(paren
id|buffer
(braket
l_int|6
)braket
dot
id|pointer
)paren
suffix:semicolon
id|pcl.buffer
(braket
l_int|5
)braket
dot
id|control
op_assign
id|PCL_CMD_LOAD
suffix:semicolon
id|pcl.buffer
(braket
l_int|5
)braket
dot
id|pointer
op_assign
id|membufbus
op_plus
l_int|4
suffix:semicolon
id|pcl.buffer
(braket
l_int|6
)braket
dot
id|control
op_assign
id|PCL_CMD_STOREQ
op_or
id|PCL_LAST_CMD
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.cmd
comma
op_amp
id|pcl
)paren
suffix:semicolon
multiline_comment|/* modified by cmdpcl when actual transfer occurs */
id|pcl.next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_LBUS_TO_PCI
suffix:semicolon
multiline_comment|/* null transfer */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pcl.buffer
(braket
id|i
)braket
dot
id|control
op_assign
l_int|4000
suffix:semicolon
id|pcl.buffer
(braket
id|i
)braket
dot
id|pointer
op_assign
id|membufbus
op_plus
(paren
id|i
op_minus
l_int|1
)paren
op_star
l_int|4000
suffix:semicolon
)brace
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;mem_pcl.mod
comma
op_amp
id|pcl
)paren
suffix:semicolon
)brace
DECL|function|mem_open
r_static
r_int
id|mem_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|cid
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_enum
(brace
id|rom
comma
id|aux
comma
id|ram
)brace
id|type
suffix:semicolon
r_struct
id|memdata
op_star
id|md
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|cid
OL
id|PCILYNX_MINOR_AUX_START
)paren
(brace
multiline_comment|/* just for completeness */
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cid
OL
id|PCILYNX_MINOR_ROM_START
)paren
(brace
id|cid
op_sub_assign
id|PCILYNX_MINOR_AUX_START
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_ge
id|num_of_cards
op_logical_or
op_logical_neg
id|cards
(braket
id|cid
)braket
dot
id|aux_port
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|type
op_assign
id|aux
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cid
OL
id|PCILYNX_MINOR_RAM_START
)paren
(brace
id|cid
op_sub_assign
id|PCILYNX_MINOR_ROM_START
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_ge
id|num_of_cards
op_logical_or
op_logical_neg
id|cards
(braket
id|cid
)braket
dot
id|local_rom
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|type
op_assign
id|rom
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* WARNING: Know what you are doing when opening RAM.&n;                 * It is currently used inside the driver! */
id|cid
op_sub_assign
id|PCILYNX_MINOR_RAM_START
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_ge
id|num_of_cards
op_logical_or
op_logical_neg
id|cards
(braket
id|cid
)braket
dot
id|local_ram
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|type
op_assign
id|ram
suffix:semicolon
)brace
id|md
op_assign
(paren
r_struct
id|memdata
op_star
)paren
id|vmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|memdata
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|md
op_eq
l_int|NULL
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|md-&gt;lynx
op_assign
op_amp
id|cards
(braket
id|cid
)braket
suffix:semicolon
id|md-&gt;cid
op_assign
id|cid
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|rom
suffix:colon
id|md-&gt;type
op_assign
id|rom
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ram
suffix:colon
id|md-&gt;type
op_assign
id|ram
suffix:semicolon
r_break
suffix:semicolon
r_case
id|aux
suffix:colon
id|md-&gt;aux_intr_last_seen
op_assign
id|atomic_read
c_func
(paren
op_amp
id|cards
(braket
id|cid
)braket
dot
id|aux_intr_seen
)paren
suffix:semicolon
id|md-&gt;type
op_assign
id|aux
suffix:semicolon
r_break
suffix:semicolon
)brace
id|file-&gt;private_data
op_assign
id|md
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mem_release
r_static
r_int
id|mem_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|memdata
op_star
id|md
op_assign
(paren
r_struct
id|memdata
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|vfree
c_func
(paren
id|md
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aux_poll
r_static
r_int
r_int
id|aux_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|pt
)paren
(brace
r_struct
id|memdata
op_star
id|md
op_assign
(paren
r_struct
id|memdata
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
id|cid
op_assign
id|md-&gt;cid
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_int
id|intr_seen
suffix:semicolon
multiline_comment|/* reading and writing is always allowed */
id|mask
op_assign
id|POLLIN
op_or
id|POLLRDNORM
op_or
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;type
op_eq
id|aux
)paren
(brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|cards
(braket
id|cid
)braket
dot
id|aux_intr_wait
comma
id|pt
)paren
suffix:semicolon
id|intr_seen
op_assign
id|atomic_read
c_func
(paren
op_amp
id|cards
(braket
id|cid
)braket
dot
id|aux_intr_seen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;aux_intr_last_seen
op_ne
id|intr_seen
)paren
(brace
id|mask
op_or_assign
id|POLLPRI
suffix:semicolon
multiline_comment|/* md-&gt;aux_intr_last_seen = intr_seen; */
id|md-&gt;aux_intr_last_seen
op_increment
suffix:semicolon
multiline_comment|/* don&squot;t miss interrupts */
multiline_comment|/* FIXME - make ioctl for configuring this */
)brace
)brace
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/* &n; * do not DMA if count is too small because this will have a serious impact &n; * on performance - the value 2400 was found by experiment and may not work&n; * everywhere as good as here - use mem_mindma option for modules to change &n; */
DECL|variable|mem_mindma
r_int
id|mem_mindma
op_assign
l_int|2400
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mem_mindma
comma
l_string|&quot;h&quot;
)paren
suffix:semicolon
DECL|function|mem_read
r_static
id|ssize_t
id|mem_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|offset
)paren
(brace
r_struct
id|memdata
op_star
id|md
op_assign
(paren
r_struct
id|memdata
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
id|bcount
suffix:semicolon
r_int
id|alignfix
suffix:semicolon
r_int
id|off
op_assign
(paren
r_int
)paren
op_star
id|offset
suffix:semicolon
multiline_comment|/* avoid useless 64bit-arithmetic */
r_void
op_star
id|membase
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|off
op_plus
id|count
)paren
OG
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
)paren
(brace
id|count
op_assign
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
op_minus
id|off
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|md-&gt;lynx-&gt;mem_dma_mutex
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|md-&gt;type
)paren
(brace
r_case
id|rom
suffix:colon
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|LBUS_ADDR
comma
id|LBUS_ADDR_SEL_ROM
op_or
id|off
)paren
suffix:semicolon
id|membase
op_assign
id|md-&gt;lynx-&gt;local_rom
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ram
suffix:colon
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|LBUS_ADDR
comma
id|LBUS_ADDR_SEL_RAM
op_or
id|off
)paren
suffix:semicolon
id|membase
op_assign
id|md-&gt;lynx-&gt;local_ram
suffix:semicolon
r_break
suffix:semicolon
r_case
id|aux
suffix:colon
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|LBUS_ADDR
comma
id|LBUS_ADDR_SEL_AUX
op_or
id|off
)paren
suffix:semicolon
id|membase
op_assign
id|md-&gt;lynx-&gt;aux_port
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|panic
c_func
(paren
l_string|&quot;pcilynx%d: unsupported md-&gt;type %d in &quot;
id|__FUNCTION__
comma
id|md-&gt;lynx-&gt;id
comma
id|md-&gt;type
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
id|mem_mindma
)paren
(brace
id|memcpy_fromio
c_func
(paren
id|md-&gt;lynx-&gt;mem_dma_buffer
comma
id|membase
op_plus
id|off
comma
id|count
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buffer
comma
id|md-&gt;lynx-&gt;mem_dma_buffer
comma
id|count
)paren
suffix:semicolon
id|bcount
op_assign
l_int|0
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|bcount
op_assign
id|count
suffix:semicolon
id|alignfix
op_assign
l_int|4
op_minus
(paren
id|off
op_mod
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alignfix
op_ne
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|bcount
OL
id|alignfix
)paren
(brace
id|alignfix
op_assign
id|bcount
suffix:semicolon
)brace
id|memcpy_fromio
c_func
(paren
id|md-&gt;lynx-&gt;mem_dma_buffer
comma
id|membase
op_plus
id|off
comma
id|alignfix
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
id|buffer
comma
id|md-&gt;lynx-&gt;mem_dma_buffer
comma
id|alignfix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcount
op_eq
id|alignfix
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
id|bcount
op_sub_assign
id|alignfix
suffix:semicolon
id|buffer
op_add_assign
id|alignfix
suffix:semicolon
id|off
op_add_assign
id|alignfix
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|md-&gt;lynx
comma
id|DMA0_CHAN_CTRL
)paren
op_amp
id|DMA_CHAN_CTRL_BUSY
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_WARNING
comma
id|md-&gt;lynx-&gt;id
comma
l_string|&quot;DMA ALREADY ACTIVE!&quot;
)paren
suffix:semicolon
)brace
id|add_wait_queue
c_func
(paren
op_amp
id|md-&gt;lynx-&gt;mem_dma_intr_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcount
OG
l_int|32768
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|DMA0_READY
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* select maxpcl */
id|run_pcl
c_func
(paren
id|md-&gt;lynx
comma
id|md-&gt;lynx-&gt;mem_pcl.start
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|md-&gt;lynx
comma
id|DMA0_CHAN_CTRL
)paren
op_amp
id|DMA_CHAN_CTRL_BUSY
)paren
(brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|DMA0_CHAN_CTRL
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|rmwait_done
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|copy_to_user
c_func
(paren
id|buffer
comma
id|md-&gt;lynx-&gt;mem_dma_buffer
comma
l_int|32768
)paren
suffix:semicolon
id|buffer
op_add_assign
l_int|32768
suffix:semicolon
id|bcount
op_sub_assign
l_int|32768
suffix:semicolon
)brace
op_star
(paren
id|u32
op_star
)paren
(paren
id|md-&gt;lynx-&gt;mem_dma_buffer
)paren
op_assign
id|pcl_bus
c_func
(paren
id|md-&gt;lynx
comma
id|md-&gt;lynx-&gt;mem_pcl.mod
)paren
op_plus
id|pcloffs
c_func
(paren
id|buffer
(braket
id|bcount
op_div
l_int|4000
op_plus
l_int|1
)braket
dot
id|control
)paren
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
(paren
id|md-&gt;lynx-&gt;mem_dma_buffer
op_plus
l_int|4
)paren
op_assign
id|PCL_LAST_BUFF
op_or
(paren
id|bcount
op_mod
l_int|4000
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|DMA0_READY
comma
l_int|0
)paren
suffix:semicolon
id|run_pcl
c_func
(paren
id|md-&gt;lynx
comma
id|md-&gt;lynx-&gt;mem_pcl.start
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|md-&gt;lynx
comma
id|DMA0_CHAN_CTRL
)paren
op_amp
id|DMA_CHAN_CTRL_BUSY
)paren
(brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|DMA0_CHAN_CTRL
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|rmwait_done
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|copy_to_user
c_func
(paren
id|buffer
comma
id|md-&gt;lynx-&gt;mem_dma_buffer
comma
id|bcount
)paren
suffix:semicolon
id|bcount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|md-&gt;lynx
comma
id|DMA0_CHAN_CTRL
)paren
op_amp
id|DMA_CHAN_CTRL_BUSY
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|md-&gt;lynx-&gt;id
comma
l_string|&quot;DMA STILL ACTIVE!&quot;
)paren
suffix:semicolon
)brace
id|rmwait_done
suffix:colon
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|DMA0_CHAN_CTRL
comma
l_int|0
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|md-&gt;lynx-&gt;mem_dma_intr_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|done
suffix:colon
id|up
c_func
(paren
op_amp
id|md-&gt;lynx-&gt;mem_dma_mutex
)paren
suffix:semicolon
id|count
op_sub_assign
id|bcount
suffix:semicolon
op_star
id|offset
op_add_assign
id|count
suffix:semicolon
r_return
(paren
id|count
ques
c_cond
id|count
suffix:colon
op_minus
id|EINTR
)paren
suffix:semicolon
)brace
DECL|function|mem_write
r_static
id|ssize_t
id|mem_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|offset
)paren
(brace
r_struct
id|memdata
op_star
id|md
op_assign
(paren
r_struct
id|memdata
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
op_star
id|offset
)paren
op_plus
id|count
)paren
OG
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
)paren
(brace
id|count
op_assign
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
op_minus
op_star
id|offset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
op_logical_or
op_star
id|offset
OG
id|PCILYNX_MAX_MEMORY
)paren
(brace
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
multiline_comment|/* FIXME: dereferencing pointers to PCI mem doesn&squot;t work everywhere */
r_switch
c_cond
(paren
id|md-&gt;type
)paren
(brace
r_case
id|aux
suffix:colon
id|copy_from_user
c_func
(paren
id|md-&gt;lynx-&gt;aux_port
op_plus
(paren
op_star
id|offset
)paren
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ram
suffix:colon
id|copy_from_user
c_func
(paren
id|md-&gt;lynx-&gt;local_ram
op_plus
(paren
op_star
id|offset
)paren
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|rom
suffix:colon
multiline_comment|/* the ROM may be writeable */
id|copy_from_user
c_func
(paren
id|md-&gt;lynx-&gt;local_rom
op_plus
(paren
op_star
id|offset
)paren
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|file-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/********************************************************&n; * Global stuff (interrupt handler, init/shutdown code) *&n; ********************************************************/
DECL|function|lynx_irq_handler
r_static
r_void
id|lynx_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs_are_unused
)paren
(brace
r_struct
id|ti_lynx
op_star
id|lynx
op_assign
(paren
r_struct
id|ti_lynx
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|lynx-&gt;host
suffix:semicolon
id|u32
id|intmask
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|PCI_INT_STATUS
)paren
suffix:semicolon
id|u32
id|linkint
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|LINK_INT_STATUS
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|PCI_INT_STATUS
comma
id|intmask
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_INT_STATUS
comma
id|linkint
)paren
suffix:semicolon
singleline_comment|//printk(&quot;-%d- one interrupt: 0x%08x / 0x%08x&bslash;n&quot;, lynx-&gt;id, intmask, linkint);
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_AUX_INT
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|lynx-&gt;aux_intr_seen
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|lynx-&gt;aux_intr_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_DMA0_HLT
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|lynx-&gt;mem_dma_intr_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_1394
)paren
(brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_PHY_TIMEOUT
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;PHY timeout occured&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_PHY_BUSRESET
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;bus reset interrupt&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;in_bus_reset
)paren
(brace
id|hpsb_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_PHY_REG_RCVD
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;in_bus_reset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;-%d- phy reg received without reset&bslash;n&quot;
comma
id|lynx-&gt;id
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_ISO_STUCK
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;isochronous transmitter stuck&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_ASYNC_STUCK
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;asynchronous transmitter stuck&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_SENT_REJECT
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;sent reject&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_TX_INVALID_TC
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;invalid transaction code&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_GRF_OVERFLOW
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;GRF overflow&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_ITF_UNDERFLOW
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;ITF underflow&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_ATF_UNDERFLOW
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;ATF underflow&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_DMA_HLT
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;iso receive&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
)paren
suffix:semicolon
id|lynx-&gt;iso_rcv.stat
(braket
id|lynx-&gt;iso_rcv.next
)braket
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|DMA_CHAN_STAT
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
)paren
suffix:semicolon
id|lynx-&gt;iso_rcv.used
op_increment
suffix:semicolon
id|lynx-&gt;iso_rcv.next
op_assign
(paren
id|lynx-&gt;iso_rcv.next
op_plus
l_int|1
)paren
op_mod
id|NUM_ISORCV_PCL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lynx-&gt;iso_rcv.next
op_eq
id|lynx-&gt;iso_rcv.last
)paren
op_logical_or
op_logical_neg
id|lynx-&gt;iso_rcv.chan_count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;stopped&bslash;n&quot;
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
id|run_sub_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl_start
comma
id|lynx-&gt;iso_rcv.next
comma
id|CHANNEL_ISO_RCV
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.tq
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_DMA3_HLT
)paren
(brace
multiline_comment|/* async send DMA completed */
id|u32
id|ack
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;async_queue_lock
)paren
suffix:semicolon
id|ack
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|DMA3_CHAN_STAT
)paren
suffix:semicolon
id|packet
op_assign
id|lynx-&gt;async_queue
suffix:semicolon
id|lynx-&gt;async_queue
op_assign
id|packet-&gt;xnext
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;async_queue
op_ne
l_int|NULL
)paren
(brace
id|send_next_async
c_func
(paren
id|lynx
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;async_queue_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ack
op_amp
id|DMA_CHAN_STAT_SPECIALACK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;-%d- special ack %d&bslash;n&quot;
comma
id|lynx-&gt;id
comma
(paren
id|ack
op_rshift
l_int|15
)paren
op_amp
l_int|0xf
)paren
suffix:semicolon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
)brace
r_else
(brace
id|ack
op_assign
(paren
id|ack
op_rshift
l_int|15
)paren
op_amp
l_int|0xf
suffix:semicolon
)brace
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|packet
comma
id|ack
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intmask
op_amp
(paren
id|PCI_INT_DMA1_HLT
op_or
id|PCI_INT_DMA1_PCL
)paren
)paren
(brace
multiline_comment|/* general receive DMA completed */
r_int
id|stat
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|DMA1_CHAN_STAT
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;-%d- received packet size %d&bslash;n&quot;
comma
id|lynx-&gt;id
comma
id|stat
op_amp
l_int|0x1fff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|DMA_CHAN_STAT_SELFID
)paren
(brace
id|handle_selfid
c_func
(paren
id|lynx
comma
id|host
comma
id|stat
op_amp
l_int|0x1fff
)paren
suffix:semicolon
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|LINK_CONTROL
comma
id|LINK_CONTROL_RCV_CMP_VALID
op_or
id|LINK_CONTROL_TX_ASYNC_EN
op_or
id|LINK_CONTROL_RX_ASYNC_EN
)paren
suffix:semicolon
)brace
r_else
(brace
id|hpsb_packet_received
c_func
(paren
id|host
comma
id|lynx-&gt;rcv_page
comma
id|stat
op_amp
l_int|0x1fff
)paren
suffix:semicolon
)brace
id|run_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl_start
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|function|iso_rcv_bh
r_static
r_void
id|iso_rcv_bh
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
r_int
r_int
id|idx
suffix:semicolon
id|quadlet_t
op_star
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lynx-&gt;iso_rcv.used
)paren
(brace
id|idx
op_assign
id|lynx-&gt;iso_rcv.last
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
id|data
op_assign
id|lynx-&gt;iso_rcv.page
(braket
id|idx
op_div
id|ISORCV_PER_PAGE
)braket
op_plus
(paren
id|idx
op_mod
id|ISORCV_PER_PAGE
)paren
op_star
id|MAX_ISORCV_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;iso_rcv.stat
(braket
id|idx
)braket
op_amp
(paren
id|DMA_CHAN_STAT_PCIERR
op_or
id|DMA_CHAN_STAT_PKTERR
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;iso receive error on %d to 0x%p&quot;
comma
id|idx
comma
id|data
)paren
suffix:semicolon
)brace
r_else
(brace
id|hpsb_packet_received
c_func
(paren
id|lynx-&gt;host
comma
id|data
comma
id|lynx-&gt;iso_rcv.stat
(braket
id|idx
)braket
op_amp
l_int|0x1fff
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
id|lynx-&gt;iso_rcv.last
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|NUM_ISORCV_PCL
suffix:semicolon
id|lynx-&gt;iso_rcv.used
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lynx-&gt;iso_rcv.chan_count
)paren
(brace
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
id|DMA_WORD1_CMP_ENABLE_MASTER
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|add_card
r_static
r_int
id|add_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
DECL|macro|FAIL
mdefine_line|#define FAIL(fmt, args...) &bslash;&n;        PRINT_G(KERN_ERR, fmt , ## args); &bslash;&n;        num_of_cards--; &bslash;&n;        remove_card(lynx); &bslash;&n;        return 1
r_struct
id|ti_lynx
op_star
id|lynx
suffix:semicolon
multiline_comment|/* shortcut to currently handled device */
r_int
r_int
id|page
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|num_of_cards
op_eq
id|MAX_PCILYNX_CARDS
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;cannot handle more than %d cards.  &quot;
l_string|&quot;Adjust MAX_PCILYNX_CARDS in ti_pcilynx.h.&quot;
comma
id|MAX_PCILYNX_CARDS
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|lynx
op_assign
op_amp
id|cards
(braket
id|num_of_cards
op_increment
)braket
suffix:semicolon
id|lynx-&gt;id
op_assign
id|num_of_cards
op_minus
l_int|1
suffix:semicolon
id|lynx-&gt;dev
op_assign
id|dev
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|lynx_irq_handler
comma
id|SA_SHIRQ
comma
id|PCILYNX_DRIVER_NAME
comma
id|lynx
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;allocated interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|lynx-&gt;state
op_assign
id|have_intr
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate shared interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_IEEE1394_PCILYNX_LOCALRAM
id|lynx-&gt;pcl_mem
op_assign
id|kmalloc
c_func
(paren
l_int|8
op_star
r_sizeof
(paren
id|lynx-&gt;pcl_bmap
)paren
op_star
r_sizeof
(paren
r_struct
id|ti_pcl
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;pcl_mem
op_ne
l_int|NULL
)paren
(brace
id|lynx-&gt;state
op_assign
id|have_pcl_mem
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;allocated PCL memory %d Bytes @ 0x%p&quot;
comma
l_int|8
op_star
r_sizeof
(paren
id|lynx-&gt;pcl_bmap
)paren
op_star
r_sizeof
(paren
r_struct
id|ti_pcl
)paren
comma
id|lynx-&gt;pcl_mem
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate PCL memory area&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|lynx-&gt;mem_dma_buffer
op_assign
id|kmalloc
c_func
(paren
l_int|32768
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;mem_dma_buffer
op_ne
l_int|NULL
)paren
(brace
id|lynx-&gt;state
op_assign
id|have_aux_buf
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate DMA buffer for aux&quot;
)paren
suffix:semicolon
)brace
id|page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_ne
l_int|0
)paren
(brace
id|lynx-&gt;rcv_page
op_assign
(paren
r_void
op_star
)paren
id|page
suffix:semicolon
id|lynx-&gt;state
op_assign
id|have_1394_buffers
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate receive buffer&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISORCV_PAGES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_ne
l_int|0
)paren
(brace
id|lynx-&gt;iso_rcv.page
(braket
id|i
)braket
op_assign
(paren
r_void
op_star
)paren
id|page
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate iso receive buffers&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,13)
id|lynx-&gt;registers
op_assign
id|ioremap_nocache
c_func
(paren
id|dev-&gt;base_address
(braket
l_int|0
)braket
comma
id|PCILYNX_MAX_REGISTER
)paren
suffix:semicolon
id|lynx-&gt;local_ram
op_assign
id|ioremap
c_func
(paren
id|dev-&gt;base_address
(braket
l_int|1
)braket
comma
id|PCILYNX_MAX_MEMORY
)paren
suffix:semicolon
id|lynx-&gt;aux_port
op_assign
id|ioremap
c_func
(paren
id|dev-&gt;base_address
(braket
l_int|2
)braket
comma
id|PCILYNX_MAX_MEMORY
)paren
suffix:semicolon
macro_line|#else
id|lynx-&gt;registers
op_assign
id|ioremap_nocache
c_func
(paren
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|PCILYNX_MAX_REGISTER
)paren
suffix:semicolon
id|lynx-&gt;local_ram
op_assign
id|ioremap
c_func
(paren
id|dev-&gt;resource
(braket
l_int|1
)braket
dot
id|start
comma
id|PCILYNX_MAX_MEMORY
)paren
suffix:semicolon
id|lynx-&gt;aux_port
op_assign
id|ioremap
c_func
(paren
id|dev-&gt;resource
(braket
l_int|2
)braket
dot
id|start
comma
id|PCILYNX_MAX_MEMORY
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,15)
id|lynx-&gt;local_rom
op_assign
id|ioremap
c_func
(paren
id|dev-&gt;rom_address
comma
id|PCILYNX_MAX_MEMORY
)paren
suffix:semicolon
macro_line|#else
id|lynx-&gt;local_rom
op_assign
id|ioremap
c_func
(paren
id|dev-&gt;resource
(braket
id|PCI_ROM_RESOURCE
)braket
dot
id|start
comma
id|PCILYNX_MAX_MEMORY
)paren
suffix:semicolon
macro_line|#endif
id|lynx-&gt;state
op_assign
id|have_iomappings
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;registers
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to remap registers - card not accessible&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_LOCALRAM
r_if
c_cond
(paren
id|lynx-&gt;local_ram
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to remap local RAM which is required for &quot;
l_string|&quot;operation&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* alloc_pcl return values are not checked, it is expected that the&n;         * provided PCL space is sufficient for the initial allocations */
r_if
c_cond
(paren
id|lynx-&gt;aux_port
op_ne
l_int|NULL
)paren
(brace
id|lynx-&gt;mem_pcl.start
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;mem_pcl.cmd
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;mem_pcl.mod
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;mem_pcl.max
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|aux_setup_pcls
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|lynx-&gt;mem_dma_mutex
comma
l_int|1
)paren
suffix:semicolon
)brace
id|lynx-&gt;rcv_pcl
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;rcv_pcl_start
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;async_pcl
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;async_pcl_start
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ISORCV_PCL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lynx-&gt;iso_rcv.pcl
(braket
id|i
)braket
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
)brace
id|lynx-&gt;iso_rcv.pcl_start
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
multiline_comment|/* all allocations successful - simple init stuff follows */
id|lynx-&gt;lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|PCI_INT_ENABLE
comma
id|PCI_INT_AUX_INT
op_or
id|PCI_INT_DMA_ALL
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|lynx-&gt;mem_dma_intr_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|lynx-&gt;aux_intr_wait
)paren
suffix:semicolon
id|lynx-&gt;iso_rcv.tq.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|iso_rcv_bh
suffix:semicolon
id|lynx-&gt;iso_rcv.tq.data
op_assign
id|lynx
suffix:semicolon
id|lynx-&gt;iso_rcv.lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;remapped memory spaces reg 0x%p, rom 0x%p, &quot;
l_string|&quot;ram 0x%p, aux 0x%p&quot;
comma
id|lynx-&gt;registers
comma
id|lynx-&gt;local_rom
comma
id|lynx-&gt;local_ram
comma
id|lynx-&gt;aux_port
)paren
suffix:semicolon
multiline_comment|/* now, looking for PHY register set */
r_if
c_cond
(paren
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|2
)paren
op_amp
l_int|0xe0
)paren
op_eq
l_int|0xe0
)paren
(brace
id|lynx-&gt;phyic.reg_1394a
op_assign
l_int|1
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;found 1394a conform PHY (using extended register set)&quot;
)paren
suffix:semicolon
id|lynx-&gt;phyic.vendor
op_assign
id|get_phy_vendorid
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;phyic.product
op_assign
id|get_phy_productid
c_func
(paren
id|lynx
)paren
suffix:semicolon
)brace
r_else
(brace
id|lynx-&gt;phyic.reg_1394a
op_assign
l_int|0
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;found old 1394 PHY&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
DECL|macro|FAIL
macro_line|#undef FAIL
)brace
DECL|function|remove_card
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|lynx-&gt;state
)paren
(brace
r_case
id|have_iomappings
suffix:colon
id|reg_write
c_func
(paren
id|lynx
comma
id|PCI_INT_ENABLE
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|MISC_CONTROL
comma
id|MISC_CONTROL_SWRESET
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|lynx-&gt;registers
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|lynx-&gt;local_rom
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|lynx-&gt;local_ram
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|lynx-&gt;aux_port
)paren
suffix:semicolon
r_case
id|have_1394_buffers
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISORCV_PAGES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|lynx-&gt;iso_rcv.page
(braket
id|i
)braket
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|lynx-&gt;iso_rcv.page
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|lynx-&gt;rcv_page
)paren
suffix:semicolon
r_case
id|have_aux_buf
suffix:colon
id|kfree
c_func
(paren
id|lynx-&gt;mem_dma_buffer
)paren
suffix:semicolon
r_case
id|have_pcl_mem
suffix:colon
macro_line|#ifndef CONFIG_IEEE1394_PCILYNX_LOCALRAM
id|kfree
c_func
(paren
id|lynx-&gt;pcl_mem
)paren
suffix:semicolon
macro_line|#endif
r_case
id|have_intr
suffix:colon
id|free_irq
c_func
(paren
id|lynx-&gt;dev-&gt;irq
comma
id|lynx
)paren
suffix:semicolon
r_case
id|clear
suffix:colon
multiline_comment|/* do nothing - already freed */
)brace
id|lynx-&gt;state
op_assign
id|clear
suffix:semicolon
)brace
DECL|function|init_driver
r_static
r_int
id|init_driver
c_func
(paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|success
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|num_of_cards
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_DEBUG
comma
id|__PRETTY_FUNCTION__
l_string|&quot; called again&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;looking for PCILynx cards&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_PCILYNX
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|add_card
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|success
op_eq
l_int|0
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;no operable PCILynx cards found&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|PCILYNX_MAJOR
comma
id|PCILYNX_DRIVER_NAME
comma
op_amp
id|aux_ops
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;allocation of char major number %d failed&bslash;n&quot;
comma
id|PCILYNX_MAJOR
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_lynx_rom
r_static
r_int
id|get_lynx_rom
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_const
id|quadlet_t
op_star
op_star
id|ptr
)paren
(brace
op_star
id|ptr
op_assign
id|lynx_csr_rom
suffix:semicolon
r_return
r_sizeof
(paren
id|lynx_csr_rom
)paren
suffix:semicolon
)brace
DECL|function|get_lynx_template
r_struct
id|hpsb_host_template
op_star
id|get_lynx_template
c_func
(paren
r_void
)paren
(brace
r_static
r_struct
id|hpsb_host_template
id|tmpl
op_assign
(brace
id|name
suffix:colon
l_string|&quot;pcilynx&quot;
comma
id|detect_hosts
suffix:colon
id|lynx_detect
comma
id|initialize_host
suffix:colon
id|lynx_initialize
comma
id|release_host
suffix:colon
id|lynx_release
comma
id|get_rom
suffix:colon
id|get_lynx_rom
comma
id|transmit_packet
suffix:colon
id|lynx_transmit
comma
id|devctl
suffix:colon
id|lynx_devctl
)brace
suffix:semicolon
r_return
op_amp
id|tmpl
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* EXPORT_NO_SYMBOLS; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Andreas E. Bombe &lt;andreas.bombe@munich.netsurf.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;driver for Texas Instruments PCI Lynx IEEE-1394 controller&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;pcilynx&quot;
)paren
suffix:semicolon
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|hpsb_unregister_lowlevel
c_func
(paren
id|get_lynx_template
c_func
(paren
)paren
)paren
suffix:semicolon
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;removed &quot;
id|PCILYNX_DRIVER_NAME
l_string|&quot; module&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|hpsb_register_lowlevel
c_func
(paren
id|get_lynx_template
c_func
(paren
)paren
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;registering failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
eof
