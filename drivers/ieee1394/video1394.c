multiline_comment|/*&n; * video1394.c - video driver for OHCI 1394 boards&n; * Copyright (C)1999,2000 Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;video1394.h&quot;
macro_line|#include &quot;ohci1394.h&quot;
DECL|macro|VIDEO1394_MAJOR
mdefine_line|#define VIDEO1394_MAJOR 172
DECL|macro|ISO_CHANNELS
mdefine_line|#define ISO_CHANNELS 64
DECL|macro|ISO_RECEIVE
mdefine_line|#define ISO_RECEIVE 0
DECL|macro|ISO_TRANSMIT
mdefine_line|#define ISO_TRANSMIT 1
macro_line|#ifndef virt_to_page
DECL|macro|virt_to_page
mdefine_line|#define virt_to_page(x) MAP_NR(x)
macro_line|#endif
macro_line|#ifndef vmalloc_32
DECL|macro|vmalloc_32
mdefine_line|#define vmalloc_32(x) vmalloc(x)
macro_line|#endif
DECL|struct|it_dma_prg
r_struct
id|it_dma_prg
(brace
DECL|member|begin
r_struct
id|dma_cmd
id|begin
suffix:semicolon
DECL|member|data
id|quadlet_t
id|data
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|end
r_struct
id|dma_cmd
id|end
suffix:semicolon
DECL|member|pad
id|quadlet_t
id|pad
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* FIXME: quick hack for memory alignment */
)brace
suffix:semicolon
DECL|struct|dma_iso_ctx
r_struct
id|dma_iso_ctx
(brace
DECL|member|ohci
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
DECL|member|ctx
r_int
id|ctx
suffix:semicolon
DECL|member|channel
r_int
id|channel
suffix:semicolon
DECL|member|last_buffer
r_int
id|last_buffer
suffix:semicolon
DECL|member|num_desc
r_int
r_int
id|num_desc
suffix:semicolon
DECL|member|buf_size
r_int
r_int
id|buf_size
suffix:semicolon
DECL|member|frame_size
r_int
r_int
id|frame_size
suffix:semicolon
DECL|member|packet_size
r_int
r_int
id|packet_size
suffix:semicolon
DECL|member|left_size
r_int
r_int
id|left_size
suffix:semicolon
DECL|member|nb_cmd
r_int
r_int
id|nb_cmd
suffix:semicolon
DECL|member|buf
r_int
r_char
op_star
id|buf
suffix:semicolon
DECL|member|ir_prg
r_struct
id|dma_cmd
op_star
op_star
id|ir_prg
suffix:semicolon
DECL|member|it_prg
r_struct
id|it_dma_prg
op_star
op_star
id|it_prg
suffix:semicolon
DECL|member|buffer_status
r_int
r_int
op_star
id|buffer_status
suffix:semicolon
DECL|member|ctrlClear
r_int
id|ctrlClear
suffix:semicolon
DECL|member|ctrlSet
r_int
id|ctrlSet
suffix:semicolon
DECL|member|cmdPtr
r_int
id|cmdPtr
suffix:semicolon
DECL|member|ctxMatch
r_int
id|ctxMatch
suffix:semicolon
DECL|member|waitq
id|wait_queue_head_t
id|waitq
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|video_card
r_struct
id|video_card
(brace
DECL|member|ohci
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
DECL|member|ir_context
r_struct
id|dma_iso_ctx
op_star
op_star
id|ir_context
suffix:semicolon
DECL|member|it_context
r_struct
id|dma_iso_ctx
op_star
op_star
id|it_context
suffix:semicolon
DECL|member|current_ctx
r_struct
id|dma_iso_ctx
op_star
id|current_ctx
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
DECL|macro|VIDEO1394_DEBUG
mdefine_line|#define VIDEO1394_DEBUG
macro_line|#endif
macro_line|#ifdef DBGMSG
DECL|macro|DBGMSG
macro_line|#undef DBGMSG
macro_line|#endif
macro_line|#ifdef VIDEO1394_DEBUG
DECL|macro|DBGMSG
mdefine_line|#define DBGMSG(card, fmt, args...) &bslash;&n;printk(KERN_INFO &quot;video1394_%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
macro_line|#else
DECL|macro|DBGMSG
mdefine_line|#define DBGMSG(card, fmt, args...)
macro_line|#endif
multiline_comment|/* print general (card independent) information */
DECL|macro|PRINT_G
mdefine_line|#define PRINT_G(level, fmt, args...) &bslash;&n;printk(level &quot;video1394: &quot; fmt &quot;&bslash;n&quot; , ## args)
multiline_comment|/* print card specific information */
DECL|macro|PRINT
mdefine_line|#define PRINT(level, card, fmt, args...) &bslash;&n;printk(level &quot;video1394_%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
r_void
id|irq_handler
c_func
(paren
r_int
id|card
comma
id|quadlet_t
id|isoRecvIntEvent
comma
id|quadlet_t
id|isoXmitIntEvent
)paren
suffix:semicolon
DECL|variable|video_cards
r_static
r_struct
id|video_card
id|video_cards
(braket
id|MAX_OHCI1394_CARDS
)braket
suffix:semicolon
DECL|variable|num_of_video_cards
r_static
r_int
id|num_of_video_cards
op_assign
l_int|0
suffix:semicolon
DECL|variable|video_tmpl
r_static
r_struct
id|video_template
id|video_tmpl
op_assign
(brace
id|irq_handler
)brace
suffix:semicolon
multiline_comment|/* Taken from bttv.c */
multiline_comment|/*******************************/
multiline_comment|/* Memory management functions */
multiline_comment|/*******************************/
DECL|macro|MDEBUG
mdefine_line|#define MDEBUG(x)&t;do { } while(0)&t;&t;/* Debug memory management */
multiline_comment|/* [DaveM] I&squot;ve recoded most of this so that:&n; * 1) It&squot;s easier to tell what is happening&n; * 2) It&squot;s more portable, especially for translating things&n; *    out of vmalloc mapped areas in the kernel.&n; * 3) Less unnecessary translations happen.&n; *&n; * The code used to assume that the kernel vmalloc mappings&n; * existed in the page tables of every process, this is simply&n; * not guarenteed.  We now use pgd_offset_k which is the&n; * defined way to get at the kernel page tables.&n; */
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0)
DECL|macro|page_address
mdefine_line|#define page_address(x)&t;(x)
macro_line|#endif
multiline_comment|/* Given PGD from the address space&squot;s page table, return the kernel&n; * virtual mapping of the physical memory mapped at ADR.&n; */
DECL|function|uvirt_to_kva
r_static
r_inline
r_int
r_int
id|uvirt_to_kva
c_func
(paren
id|pgd_t
op_star
id|pgd
comma
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|ret
op_assign
l_int|0UL
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
(brace
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
(brace
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|adr
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
(brace
id|ret
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|pte_page
c_func
(paren
id|pte
)paren
)paren
suffix:semicolon
id|ret
op_or_assign
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;uv2kva(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|uvirt_to_bus
r_static
r_inline
r_int
r_int
id|uvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|kva
comma
id|ret
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|adr
)paren
comma
id|adr
)paren
suffix:semicolon
id|ret
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|kva
)paren
suffix:semicolon
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;uv2b(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|kvirt_to_bus
r_static
r_inline
r_int
r_int
id|kvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|kva
)paren
suffix:semicolon
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;kv2b(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Here we want the physical address of the memory.&n; * This is used when initializing the contents of the&n; * area and marking the pages as reserved.&n; */
DECL|function|kvirt_to_pa
r_static
r_inline
r_int
r_int
id|kvirt_to_pa
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|va
comma
id|kva
comma
id|ret
suffix:semicolon
id|va
op_assign
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
suffix:semicolon
id|kva
op_assign
id|uvirt_to_kva
c_func
(paren
id|pgd_offset_k
c_func
(paren
id|va
)paren
comma
id|va
)paren
suffix:semicolon
id|ret
op_assign
id|__pa
c_func
(paren
id|kva
)paren
suffix:semicolon
id|MDEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;kv2pa(%lx--&gt;%lx)&quot;
comma
id|adr
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
id|mem
op_assign
id|vmalloc_32
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, &n;&t;&t;&t;&t;&t; no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
)brace
DECL|function|free_dma_iso_ctx
r_static
r_int
id|free_dma_iso_ctx
c_func
(paren
r_struct
id|dma_iso_ctx
op_star
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ohci
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Freeing dma_iso_ctx %d&quot;
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctx
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf
)paren
id|rvfree
c_func
(paren
(paren
r_void
op_star
)paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|num_desc
op_star
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_size
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ir_prg
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ir_prg
(braket
id|i
)braket
)paren
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ir_prg
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ir_prg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|it_prg
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|it_prg
(braket
id|i
)braket
)paren
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|it_prg
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|it_prg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buffer_status
)paren
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buffer_status
)paren
suffix:semicolon
id|kfree
c_func
(paren
op_star
id|d
)paren
suffix:semicolon
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|dma_iso_ctx
op_star
DECL|function|alloc_dma_iso_ctx
id|alloc_dma_iso_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|type
comma
r_int
id|ctx
comma
r_int
id|num_desc
comma
r_int
id|buf_size
comma
r_int
id|channel
comma
r_int
r_int
id|packet_size
)paren
(brace
r_struct
id|dma_iso_ctx
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|d
op_assign
(paren
r_struct
id|dma_iso_ctx
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dma_iso_ctx
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dma_iso_ctx
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma_iso_ctx&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|d-&gt;ohci
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
id|d-&gt;ctx
op_assign
id|ctx
suffix:semicolon
id|d-&gt;channel
op_assign
id|channel
suffix:semicolon
id|d-&gt;num_desc
op_assign
id|num_desc
suffix:semicolon
id|d-&gt;frame_size
op_assign
id|buf_size
suffix:semicolon
r_if
c_cond
(paren
id|buf_size
op_mod
id|PAGE_SIZE
)paren
id|d-&gt;buf_size
op_assign
id|buf_size
op_plus
id|PAGE_SIZE
op_minus
(paren
id|buf_size
op_mod
id|PAGE_SIZE
)paren
suffix:semicolon
r_else
id|d-&gt;buf_size
op_assign
id|buf_size
suffix:semicolon
id|d-&gt;last_buffer
op_assign
op_minus
l_int|1
suffix:semicolon
id|d-&gt;buf
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;ir_prg
op_assign
l_int|NULL
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|d-&gt;waitq
)paren
suffix:semicolon
id|d-&gt;buf
op_assign
id|rvmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
id|d-&gt;buf_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buf
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma buffer&quot;
)paren
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;buf
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
id|d-&gt;buf_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|ISO_RECEIVE
)paren
(brace
id|d-&gt;ctrlSet
op_assign
id|OHCI1394_IsoRcvContextControlSet
op_plus
l_int|32
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|OHCI1394_IsoRcvContextControlClear
op_plus
l_int|32
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|OHCI1394_IsoRcvCommandPtr
op_plus
l_int|32
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;ctxMatch
op_assign
id|OHCI1394_IsoRcvContextMatch
op_plus
l_int|32
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;ir_prg
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;ir_prg
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma ir prg&quot;
)paren
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;ir_prg
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
)paren
suffix:semicolon
id|d-&gt;nb_cmd
op_assign
id|d-&gt;buf_size
op_div
id|PAGE_SIZE
op_plus
l_int|1
suffix:semicolon
id|d-&gt;left_size
op_assign
(paren
id|d-&gt;frame_size
op_mod
id|PAGE_SIZE
)paren
ques
c_cond
id|d-&gt;frame_size
op_mod
id|PAGE_SIZE
suffix:colon
id|PAGE_SIZE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;ir_prg
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;nb_cmd
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;ir_prg
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma ir prg&quot;
)paren
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* ISO_TRANSMIT */
id|d-&gt;ctrlSet
op_assign
id|OHCI1394_IsoXmitContextControlSet
op_plus
l_int|16
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|OHCI1394_IsoXmitContextControlClear
op_plus
l_int|16
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|OHCI1394_IsoXmitCommandPtr
op_plus
l_int|16
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;it_prg
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|it_dma_prg
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;it_prg
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma it prg&quot;
)paren
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;it_prg
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|it_dma_prg
op_star
)paren
)paren
suffix:semicolon
id|d-&gt;packet_size
op_assign
id|packet_size
suffix:semicolon
r_if
c_cond
(paren
id|PAGE_SIZE
op_mod
id|packet_size
op_logical_or
id|packet_size
OG
l_int|4096
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Packet size %d not yet supported&bslash;n&quot;
comma
id|packet_size
)paren
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|d-&gt;nb_cmd
op_assign
id|d-&gt;frame_size
op_div
id|d-&gt;packet_size
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;frame_size
op_mod
id|d-&gt;packet_size
)paren
(brace
id|d-&gt;nb_cmd
op_increment
suffix:semicolon
id|d-&gt;left_size
op_assign
id|d-&gt;frame_size
op_mod
id|d-&gt;packet_size
suffix:semicolon
)brace
r_else
id|d-&gt;left_size
op_assign
id|d-&gt;packet_size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;it_prg
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;nb_cmd
op_star
r_sizeof
(paren
r_struct
id|it_dma_prg
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;it_prg
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma it prg&quot;
)paren
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
id|d-&gt;buffer_status
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_int
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buffer_status
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma ir prg&quot;
)paren
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;buffer_status
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Iso %s DMA: %d buffers &quot;
l_string|&quot;of size %d allocated for a frame size %d, each with %d prgs&quot;
comma
(paren
id|type
op_eq
id|ISO_RECEIVE
)paren
ques
c_cond
l_string|&quot;receive&quot;
suffix:colon
l_string|&quot;transmit&quot;
comma
id|d-&gt;num_desc
comma
id|d-&gt;buf_size
comma
id|d-&gt;frame_size
comma
id|d-&gt;nb_cmd
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|reset_ir_status
r_static
r_void
id|reset_ir_status
c_func
(paren
r_struct
id|dma_iso_ctx
op_star
id|d
comma
r_int
id|n
)paren
(brace
r_int
id|i
suffix:semicolon
id|d-&gt;ir_prg
(braket
id|n
)braket
(braket
l_int|0
)braket
dot
id|status
op_assign
l_int|4
suffix:semicolon
id|d-&gt;ir_prg
(braket
id|n
)braket
(braket
l_int|1
)braket
dot
id|status
op_assign
id|PAGE_SIZE
op_minus
l_int|4
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
id|d-&gt;nb_cmd
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|d-&gt;ir_prg
(braket
id|n
)braket
(braket
id|i
)braket
dot
id|status
op_assign
id|PAGE_SIZE
suffix:semicolon
id|d-&gt;ir_prg
(braket
id|n
)braket
(braket
id|i
)braket
dot
id|status
op_assign
id|d-&gt;left_size
suffix:semicolon
)brace
DECL|function|initialize_dma_ir_prg
r_static
r_void
id|initialize_dma_ir_prg
c_func
(paren
r_struct
id|dma_iso_ctx
op_star
id|d
comma
r_int
id|n
comma
r_int
id|flags
)paren
(brace
r_struct
id|dma_cmd
op_star
id|ir_prg
op_assign
id|d-&gt;ir_prg
(braket
id|n
)braket
suffix:semicolon
r_int
r_int
id|buf
op_assign
(paren
r_int
r_int
)paren
id|d-&gt;buf
op_plus
id|n
op_star
id|d-&gt;buf_size
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* the first descriptor will read only 4 bytes */
id|ir_prg
(braket
l_int|0
)braket
dot
id|control
op_assign
(paren
l_int|0x280C
op_lshift
l_int|16
)paren
op_or
l_int|4
suffix:semicolon
multiline_comment|/* set the sync flag */
r_if
c_cond
(paren
id|flags
op_amp
id|VIDEO1394_SYNC_FRAMES
)paren
id|ir_prg
(braket
l_int|0
)braket
dot
id|control
op_or_assign
l_int|0x00030000
suffix:semicolon
id|ir_prg
(braket
l_int|0
)braket
dot
id|address
op_assign
id|kvirt_to_bus
c_func
(paren
id|buf
)paren
suffix:semicolon
id|ir_prg
(braket
l_int|0
)braket
dot
id|branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|ir_prg
(braket
l_int|1
)braket
dot
id|control
)paren
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
suffix:semicolon
multiline_comment|/* the second descriptor will read PAGE_SIZE-4 bytes */
id|ir_prg
(braket
l_int|1
)braket
dot
id|control
op_assign
(paren
l_int|0x280C
op_lshift
l_int|16
)paren
op_or
(paren
id|PAGE_SIZE
op_minus
l_int|4
)paren
suffix:semicolon
id|ir_prg
(braket
l_int|1
)braket
dot
id|address
op_assign
id|kvirt_to_bus
c_func
(paren
id|buf
op_plus
l_int|4
)paren
suffix:semicolon
id|ir_prg
(braket
l_int|1
)braket
dot
id|branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|ir_prg
(braket
l_int|2
)braket
dot
id|control
)paren
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
id|d-&gt;nb_cmd
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ir_prg
(braket
id|i
)braket
dot
id|control
op_assign
(paren
l_int|0x280C
op_lshift
l_int|16
)paren
op_or
id|PAGE_SIZE
suffix:semicolon
id|ir_prg
(braket
id|i
)braket
dot
id|address
op_assign
id|kvirt_to_bus
c_func
(paren
id|buf
op_plus
(paren
id|i
op_minus
l_int|1
)paren
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
id|ir_prg
(braket
id|i
)braket
dot
id|branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|ir_prg
(braket
id|i
op_plus
l_int|1
)braket
dot
id|control
)paren
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
suffix:semicolon
)brace
multiline_comment|/* the last descriptor will generate an interrupt */
id|ir_prg
(braket
id|i
)braket
dot
id|control
op_assign
(paren
l_int|0x283C
op_lshift
l_int|16
)paren
op_or
id|d-&gt;left_size
suffix:semicolon
id|ir_prg
(braket
id|i
)braket
dot
id|address
op_assign
id|kvirt_to_bus
c_func
(paren
id|buf
op_plus
(paren
id|i
op_minus
l_int|1
)paren
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
DECL|function|initialize_dma_ir_ctx
r_static
r_void
id|initialize_dma_ir_ctx
c_func
(paren
r_struct
id|dma_iso_ctx
op_star
id|d
comma
r_int
id|tag
comma
r_int
id|flags
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|d-&gt;ohci
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|initialize_dma_ir_prg
c_func
(paren
id|d
comma
id|i
comma
id|flags
)paren
suffix:semicolon
id|reset_ir_status
c_func
(paren
id|d
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* reset the ctrl register */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|0xf0000000
)paren
suffix:semicolon
multiline_comment|/* Set bufferFill */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x80000000
)paren
suffix:semicolon
multiline_comment|/* Set isoch header */
r_if
c_cond
(paren
id|flags
op_amp
id|VIDEO1394_INCLUDE_ISO_HEADERS
)paren
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x40000000
)paren
suffix:semicolon
multiline_comment|/* Set the context match register to match on all tags, &n;&t;   sync for sync tag, and listen to d-&gt;channel */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctxMatch
comma
l_int|0xf0000000
op_or
(paren
(paren
id|tag
op_amp
l_int|0xf
)paren
op_lshift
l_int|8
)paren
op_or
id|d-&gt;channel
)paren
suffix:semicolon
multiline_comment|/* Set up isoRecvIntMask to generate interrupts */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
comma
l_int|1
op_lshift
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* find which context is listening to this channel */
DECL|function|ir_ctx_listening
r_int
id|ir_ctx_listening
c_func
(paren
r_struct
id|video_card
op_star
id|video
comma
r_int
id|channel
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|video-&gt;ohci
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_rcv_ctx
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|video-&gt;ir_context
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|video-&gt;ir_context
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
op_eq
id|channel
)paren
r_return
id|i
suffix:semicolon
)brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;no iso context is listening to channel %d&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|it_ctx_talking
r_int
id|it_ctx_talking
c_func
(paren
r_struct
id|video_card
op_star
id|video
comma
r_int
id|channel
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|video-&gt;ohci
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|video-&gt;it_context
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|video-&gt;it_context
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
op_eq
id|channel
)paren
r_return
id|i
suffix:semicolon
)brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;no iso context is talking to channel %d&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|wakeup_dma_ir_ctx
r_int
id|wakeup_dma_ir_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_iso_ctx
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Iso receive event received but &quot;
l_string|&quot;context not allocated&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|d-&gt;ir_prg
(braket
id|i
)braket
(braket
id|d-&gt;nb_cmd
op_minus
l_int|1
)braket
dot
id|status
op_amp
l_int|0xFFFF0000
)paren
(brace
id|reset_ir_status
c_func
(paren
id|d
comma
id|i
)paren
suffix:semicolon
id|d-&gt;buffer_status
(braket
id|i
)braket
op_assign
id|VIDEO1394_BUFFER_READY
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|d-&gt;waitq
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|d-&gt;waitq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wakeup_dma_it_ctx
r_int
id|wakeup_dma_it_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_iso_ctx
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Iso transmit event received but &quot;
l_string|&quot;context not allocated&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|d-&gt;it_prg
(braket
id|i
)braket
(braket
id|d-&gt;nb_cmd
op_minus
l_int|1
)braket
dot
id|end.status
op_amp
l_int|0xFFFF0000
)paren
(brace
id|d-&gt;it_prg
(braket
id|i
)braket
(braket
id|d-&gt;nb_cmd
op_minus
l_int|1
)braket
dot
id|end.status
op_assign
l_int|0
suffix:semicolon
id|d-&gt;buffer_status
(braket
id|i
)braket
op_assign
id|VIDEO1394_BUFFER_READY
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|d-&gt;waitq
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|d-&gt;waitq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|initialize_dma_it_prg
r_static
r_void
id|initialize_dma_it_prg
c_func
(paren
r_struct
id|dma_iso_ctx
op_star
id|d
comma
r_int
id|n
comma
r_int
id|sync_tag
)paren
(brace
r_struct
id|it_dma_prg
op_star
id|it_prg
op_assign
id|d-&gt;it_prg
(braket
id|n
)braket
suffix:semicolon
r_int
r_int
id|buf
op_assign
(paren
r_int
r_int
)paren
id|d-&gt;buf
op_plus
id|n
op_star
id|d-&gt;buf_size
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;nb_cmd
suffix:semicolon
id|i
op_increment
)paren
(brace
id|it_prg
(braket
id|i
)braket
dot
id|begin.control
op_assign
id|OUTPUT_MORE_IMMEDIATE
op_or
l_int|8
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|begin.address
op_assign
l_int|0
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|begin.status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: what is the tag value + speed selection */
id|it_prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|0
)braket
op_assign
(paren
id|DMA_SPEED_400
op_lshift
l_int|16
)paren
op_or
(paren
id|d-&gt;channel
op_lshift
l_int|8
)paren
op_or
l_int|0xa0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
id|it_prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|0
)braket
op_or_assign
id|sync_tag
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|1
)braket
op_assign
id|d-&gt;packet_size
op_lshift
l_int|16
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|end.control
op_assign
l_int|0x100c0000
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|end.address
op_assign
id|kvirt_to_bus
c_func
(paren
id|buf
op_plus
id|i
op_star
id|d-&gt;packet_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|d-&gt;nb_cmd
op_minus
l_int|1
)paren
(brace
id|it_prg
(braket
id|i
)braket
dot
id|end.control
op_or_assign
id|d-&gt;packet_size
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|begin.branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|it_prg
(braket
id|i
op_plus
l_int|1
)braket
dot
id|begin.control
)paren
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x3
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|end.branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|it_prg
(braket
id|i
op_plus
l_int|1
)braket
dot
id|begin.control
)paren
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x3
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* the last prg generates an interrupt */
id|it_prg
(braket
id|i
)braket
dot
id|end.control
op_or_assign
l_int|0x08300000
op_or
id|d-&gt;left_size
suffix:semicolon
multiline_comment|/* the last prg doesn&squot;t branch */
id|it_prg
(braket
id|i
)braket
dot
id|begin.branchAddress
op_assign
l_int|0
suffix:semicolon
id|it_prg
(braket
id|i
)braket
dot
id|end.branchAddress
op_assign
l_int|0
suffix:semicolon
)brace
id|it_prg
(braket
id|i
)braket
dot
id|end.status
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;%d:%d: %08x-%08x ctrl %08x brch %08x d0 %08x d1 %08x&bslash;n&quot;
comma
id|n
comma
id|i
comma
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|it_prg
(braket
id|i
)braket
dot
id|begin.control
)paren
)paren
comma
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|it_prg
(braket
id|i
)braket
dot
id|end.control
)paren
)paren
comma
id|it_prg
(braket
id|i
)braket
dot
id|end.control
comma
id|it_prg
(braket
id|i
)braket
dot
id|end.branchAddress
comma
id|it_prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|0
)braket
comma
id|it_prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
DECL|function|initialize_dma_it_ctx
r_static
r_void
id|initialize_dma_it_ctx
c_func
(paren
r_struct
id|dma_iso_ctx
op_star
id|d
comma
r_int
id|sync_tag
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|d-&gt;ohci
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
id|initialize_dma_it_prg
c_func
(paren
id|d
comma
id|i
comma
id|sync_tag
)paren
suffix:semicolon
multiline_comment|/* Set up isoRecvIntMask to generate interrupts */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskSet
comma
l_int|1
op_lshift
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
DECL|function|do_iso_mmap
r_static
r_int
id|do_iso_mmap
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_iso_ctx
op_star
id|d
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|d-&gt;num_desc
op_star
id|d-&gt;buf_size
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;iso context %d buf size is different from mmap size&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|d-&gt;buf
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;iso context %d is not allocated&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pos
op_assign
(paren
r_int
r_int
)paren
id|d-&gt;buf
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|video1394_ioctl
r_static
r_int
id|video1394_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
op_amp
id|video_cards
(braket
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|video-&gt;ohci
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDEO1394_LISTEN_CHANNEL
suffix:colon
r_case
id|VIDEO1394_TALK_CHANNEL
suffix:colon
(brace
r_struct
id|video1394_mmap
id|v
suffix:semicolon
id|u64
id|mask
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.channel
c_func
(paren
id|ISO_CHANNELS
op_minus
l_int|1
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;iso channel %d out of bound&quot;
comma
id|v.channel
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|v.channel
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;mask: %08X%08X usage: %08X%08X&bslash;n&quot;
comma
(paren
id|u32
)paren
(paren
id|mask
op_rshift
l_int|32
)paren
comma
(paren
id|u32
)paren
(paren
id|mask
op_amp
l_int|0xffffffff
)paren
comma
(paren
id|u32
)paren
(paren
id|ohci-&gt;ISO_channel_usage
op_rshift
l_int|32
)paren
comma
(paren
id|u32
)paren
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
l_int|0xffffffff
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;channel %d is already taken&quot;
comma
id|v.channel
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ohci-&gt;ISO_channel_usage
op_or_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|v.buf_size
op_le
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Invalid %d length buffer requested&quot;
comma
id|v.buf_size
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.nb_buffers
op_le
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Invalid %d buffers requested&quot;
comma
id|v.nb_buffers
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.nb_buffers
op_star
id|v.buf_size
OG
id|VIDEO1394_MAX_SIZE
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;%d buffers of size %d bytes is too big&quot;
comma
id|v.nb_buffers
comma
id|v.buf_size
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|VIDEO1394_LISTEN_CHANNEL
)paren
(brace
multiline_comment|/* find a free iso receive context */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_rcv_ctx
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|video-&gt;ir_context
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
(paren
id|ohci-&gt;nb_iso_rcv_ctx
op_minus
l_int|1
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;no iso context available&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|video-&gt;ir_context
(braket
id|i
)braket
op_assign
id|alloc_dma_iso_ctx
c_func
(paren
id|ohci
comma
id|ISO_RECEIVE
comma
id|i
op_plus
l_int|1
comma
id|v.nb_buffers
comma
id|v.buf_size
comma
id|v.channel
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;ir_context
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Couldn&squot;t allocate ir context&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|initialize_dma_ir_ctx
c_func
(paren
id|video-&gt;ir_context
(braket
id|i
)braket
comma
id|v.sync_tag
comma
id|v.flags
)paren
suffix:semicolon
id|video-&gt;current_ctx
op_assign
id|video-&gt;ir_context
(braket
id|i
)braket
suffix:semicolon
id|v.buf_size
op_assign
id|video-&gt;ir_context
(braket
id|i
)braket
op_member_access_from_pointer
id|buf_size
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;iso context %d listen on channel %d&quot;
comma
id|i
op_plus
l_int|1
comma
id|v.channel
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* find a free iso transmit context */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|video-&gt;it_context
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|ohci-&gt;nb_iso_xmit_ctx
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;no iso context available&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|video-&gt;it_context
(braket
id|i
)braket
op_assign
id|alloc_dma_iso_ctx
c_func
(paren
id|ohci
comma
id|ISO_TRANSMIT
comma
id|i
comma
id|v.nb_buffers
comma
id|v.buf_size
comma
id|v.channel
comma
id|v.packet_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;it_context
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Couldn&squot;t allocate it context&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|initialize_dma_it_ctx
c_func
(paren
id|video-&gt;it_context
(braket
id|i
)braket
comma
id|v.sync_tag
)paren
suffix:semicolon
id|video-&gt;current_ctx
op_assign
id|video-&gt;it_context
(braket
id|i
)braket
suffix:semicolon
id|v.buf_size
op_assign
id|video-&gt;it_context
(braket
id|i
)braket
op_member_access_from_pointer
id|buf_size
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;iso context %d talk on channel %d&quot;
comma
id|i
comma
id|v.channel
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDEO1394_UNLISTEN_CHANNEL
suffix:colon
r_case
id|VIDEO1394_UNTALK_CHANNEL
suffix:colon
(brace
r_int
id|channel
suffix:semicolon
id|u64
id|mask
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|channel
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|channel
c_func
(paren
id|ISO_CHANNELS
op_minus
l_int|1
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;iso channel %d out of bound&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|channel
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;channel %d is not being used&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ohci-&gt;ISO_channel_usage
op_and_assign
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|VIDEO1394_UNLISTEN_CHANNEL
)paren
(brace
id|i
op_assign
id|ir_ctx_listening
c_func
(paren
id|video
comma
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|video-&gt;ir_context
(braket
id|i
)braket
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;iso context %d stop listening on channel %d&quot;
comma
id|i
op_plus
l_int|1
comma
id|channel
)paren
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|it_ctx_talking
c_func
(paren
id|video
comma
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|video-&gt;it_context
(braket
id|i
)braket
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;iso context %d stop talking on channel %d&quot;
comma
id|i
comma
id|channel
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDEO1394_LISTEN_QUEUE_BUFFER
suffix:colon
(brace
r_struct
id|video1394_wait
id|v
suffix:semicolon
r_struct
id|dma_iso_ctx
op_star
id|d
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|i
op_assign
id|ir_ctx_listening
c_func
(paren
id|video
comma
id|v.channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|d
op_assign
id|video-&gt;ir_context
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v.buffer
OL
l_int|0
)paren
op_logical_or
(paren
id|v.buffer
OG
id|d-&gt;num_desc
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;buffer %d out of range&quot;
comma
id|v.buffer
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_eq
id|VIDEO1394_BUFFER_QUEUED
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;buffer %d is already used&quot;
comma
id|v.buffer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_assign
id|VIDEO1394_BUFFER_QUEUED
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;last_buffer
op_ge
l_int|0
)paren
id|d-&gt;ir_prg
(braket
id|d-&gt;last_buffer
)braket
(braket
id|d-&gt;nb_cmd
op_minus
l_int|1
)braket
dot
id|branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|d-&gt;ir_prg
(braket
id|v.buffer
)braket
(braket
l_int|0
)braket
dot
id|control
)paren
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
suffix:semicolon
id|d-&gt;last_buffer
op_assign
id|v.buffer
suffix:semicolon
id|d-&gt;ir_prg
(braket
id|d-&gt;last_buffer
)braket
(braket
id|d-&gt;nb_cmd
op_minus
l_int|1
)braket
dot
id|branchAddress
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x8000
)paren
)paren
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Starting iso DMA ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
multiline_comment|/* Tell the controller where the first program is */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;cmdPtr
comma
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|d-&gt;ir_prg
(braket
id|v.buffer
)braket
(braket
l_int|0
)braket
)paren
)paren
op_or
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* Run IR context */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x8000
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Wake up dma context if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x400
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Waking up iso dma ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDEO1394_LISTEN_WAIT_BUFFER
suffix:colon
(brace
r_struct
id|video1394_wait
id|v
suffix:semicolon
r_struct
id|dma_iso_ctx
op_star
id|d
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|i
op_assign
id|ir_ctx_listening
c_func
(paren
id|video
comma
id|v.channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|d
op_assign
id|video-&gt;ir_context
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v.buffer
OL
l_int|0
)paren
op_logical_or
(paren
id|v.buffer
OG
id|d-&gt;num_desc
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;buffer %d out of range&quot;
comma
id|v.buffer
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * I change the way it works so that it returns &n;&t;&t; * the last received frame.&n;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
)paren
(brace
r_case
id|VIDEO1394_BUFFER_READY
suffix:colon
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_assign
id|VIDEO1394_BUFFER_FREE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO1394_BUFFER_QUEUED
suffix:colon
macro_line|#if 1
r_while
c_loop
(paren
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_ne
id|VIDEO1394_BUFFER_READY
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|d-&gt;waitq
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
)brace
macro_line|#else
r_if
c_cond
(paren
id|wait_event_interruptible
c_func
(paren
id|d-&gt;waitq
comma
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_eq
id|VIDEO1394_BUFFER_READY
)paren
op_eq
op_minus
id|ERESTARTSYS
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
macro_line|#endif
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_assign
id|VIDEO1394_BUFFER_FREE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;buffer %d is not queued&quot;
comma
id|v.buffer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Look ahead to see how many more buffers have been received&n;&t;&t; */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|d-&gt;buffer_status
(braket
(paren
id|v.buffer
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
)braket
op_eq
id|VIDEO1394_BUFFER_READY
)paren
(brace
id|v.buffer
op_assign
(paren
id|v.buffer
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|v.buffer
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDEO1394_TALK_QUEUE_BUFFER
suffix:colon
(brace
r_struct
id|video1394_wait
id|v
suffix:semicolon
r_struct
id|dma_iso_ctx
op_star
id|d
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|i
op_assign
id|it_ctx_talking
c_func
(paren
id|video
comma
id|v.channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|d
op_assign
id|video-&gt;it_context
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v.buffer
OL
l_int|0
)paren
op_logical_or
(paren
id|v.buffer
OG
id|d-&gt;num_desc
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;buffer %d out of range&quot;
comma
id|v.buffer
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_ne
id|VIDEO1394_BUFFER_FREE
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;buffer %d is already used&quot;
comma
id|v.buffer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_assign
id|VIDEO1394_BUFFER_QUEUED
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;last_buffer
op_ge
l_int|0
)paren
(brace
id|d-&gt;it_prg
(braket
id|d-&gt;last_buffer
)braket
(braket
id|d-&gt;nb_cmd
op_minus
l_int|1
)braket
dot
id|end.branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|d-&gt;it_prg
(braket
id|v.buffer
)braket
(braket
l_int|0
)braket
dot
id|begin.control
)paren
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x3
suffix:semicolon
id|d-&gt;it_prg
(braket
id|d-&gt;last_buffer
)braket
(braket
id|d-&gt;nb_cmd
op_minus
l_int|1
)braket
dot
id|begin.branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|d-&gt;it_prg
(braket
id|v.buffer
)braket
(braket
l_int|0
)braket
dot
id|begin.control
)paren
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x3
suffix:semicolon
)brace
id|d-&gt;last_buffer
op_assign
id|v.buffer
suffix:semicolon
id|d-&gt;it_prg
(braket
id|d-&gt;last_buffer
)braket
(braket
id|d-&gt;nb_cmd
op_minus
l_int|1
)braket
dot
id|end.branchAddress
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x8000
)paren
)paren
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Starting iso transmit DMA ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
multiline_comment|/* Tell the controller where the first program is */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;cmdPtr
comma
id|virt_to_bus
c_func
(paren
op_amp
(paren
id|d-&gt;it_prg
(braket
id|v.buffer
)braket
(braket
l_int|0
)braket
)paren
)paren
op_or
l_int|0x3
)paren
suffix:semicolon
multiline_comment|/* Run IT context */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x8000
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Wake up dma context if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x400
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Waking up iso transmit dma ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDEO1394_TALK_WAIT_BUFFER
suffix:colon
(brace
r_struct
id|video1394_wait
id|v
suffix:semicolon
r_struct
id|dma_iso_ctx
op_star
id|d
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|i
op_assign
id|it_ctx_talking
c_func
(paren
id|video
comma
id|v.channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|d
op_assign
id|video-&gt;it_context
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v.buffer
OL
l_int|0
)paren
op_logical_or
(paren
id|v.buffer
OG
id|d-&gt;num_desc
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;buffer %d out of range&quot;
comma
id|v.buffer
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
)paren
(brace
r_case
id|VIDEO1394_BUFFER_READY
suffix:colon
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_assign
id|VIDEO1394_BUFFER_FREE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|VIDEO1394_BUFFER_QUEUED
suffix:colon
macro_line|#if 1
r_while
c_loop
(paren
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_ne
id|VIDEO1394_BUFFER_READY
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|d-&gt;waitq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
)brace
macro_line|#else
r_if
c_cond
(paren
id|wait_event_interruptible
c_func
(paren
id|d-&gt;waitq
comma
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_eq
id|VIDEO1394_BUFFER_READY
)paren
op_eq
op_minus
id|ERESTARTSYS
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
macro_line|#endif
id|d-&gt;buffer_status
(braket
id|v.buffer
)braket
op_assign
id|VIDEO1394_BUFFER_FREE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;buffer %d is not queued&quot;
comma
id|v.buffer
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;This maps the vmalloced and reserved buffer to user space.&n; *&n; *  FIXME: &n; *  - PAGE_READONLY should suffice!?&n; *  - remap_page_range is kind of inefficient for page by page remapping.&n; *    But e.g. pte_alloc() does not work in modules ... :-(&n; */
DECL|function|video1394_mmap
r_int
id|video1394_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
op_amp
id|video_cards
(braket
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
)braket
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_int
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|ohci
op_assign
id|video-&gt;ohci
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;mmap&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;current_ctx
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;current iso context not set&quot;
)paren
suffix:semicolon
)brace
r_else
id|res
op_assign
id|do_iso_mmap
c_func
(paren
id|ohci
comma
id|video-&gt;current_ctx
comma
(paren
r_char
op_star
)paren
id|vma-&gt;vm_start
comma
(paren
r_int
r_int
)paren
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
)paren
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|video1394_open
r_static
r_int
id|video1394_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
op_logical_or
id|i
op_ge
id|num_of_video_cards
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|i
comma
l_string|&quot;ohci card %d not found&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|V22_COMPAT_MOD_INC_USE_COUNT
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|i
comma
l_string|&quot;open&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|video1394_release
r_static
r_int
id|video1394_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
op_amp
id|video_cards
(braket
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)braket
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|video-&gt;ohci
suffix:semicolon
id|u64
id|mask
suffix:semicolon
r_int
id|i
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_rcv_ctx
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|video-&gt;ir_context
(braket
id|i
)braket
)paren
(brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|video-&gt;ir_context
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;channel %d is not being used&quot;
comma
id|video-&gt;ir_context
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
)paren
suffix:semicolon
r_else
id|ohci-&gt;ISO_channel_usage
op_and_assign
op_complement
id|mask
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;iso receive context %d stop listening &quot;
l_string|&quot;on channel %d&quot;
comma
id|i
op_plus
l_int|1
comma
id|video-&gt;ir_context
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
)paren
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|video-&gt;ir_context
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|video-&gt;it_context
(braket
id|i
)braket
)paren
(brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|video-&gt;it_context
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;channel %d is not being used&quot;
comma
id|video-&gt;it_context
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
)paren
suffix:semicolon
r_else
id|ohci-&gt;ISO_channel_usage
op_and_assign
op_complement
id|mask
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;iso transmit context %d stop talking &quot;
l_string|&quot;on channel %d&quot;
comma
id|i
op_plus
l_int|1
comma
id|video-&gt;it_context
(braket
id|i
)braket
op_member_access_from_pointer
id|channel
)paren
suffix:semicolon
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|video-&gt;it_context
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|V22_COMPAT_MOD_DEC_USE_COUNT
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;release&quot;
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|irq_handler
r_void
id|irq_handler
c_func
(paren
r_int
id|card
comma
id|quadlet_t
id|isoRecvIntEvent
comma
id|quadlet_t
id|isoXmitIntEvent
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|video_card
op_star
id|video
op_assign
op_amp
id|video_cards
(braket
id|card
)braket
suffix:semicolon
id|DBGMSG
c_func
(paren
id|card
comma
l_string|&quot;Iso event Recv: %08x Xmit: %08x&quot;
comma
id|isoRecvIntEvent
comma
id|isoXmitIntEvent
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|video-&gt;ohci-&gt;nb_iso_rcv_ctx
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|isoRecvIntEvent
op_amp
(paren
l_int|1
op_lshift
(paren
id|i
op_plus
l_int|1
)paren
)paren
)paren
id|wakeup_dma_ir_ctx
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ir_context
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|video-&gt;ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|isoXmitIntEvent
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|wakeup_dma_it_ctx
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;it_context
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
DECL|variable|video1394_fops
r_static
r_struct
id|file_operations
id|video1394_fops
op_assign
(brace
id|OWNER_THIS_MODULE
id|ioctl
suffix:colon
id|video1394_ioctl
comma
id|mmap
suffix:colon
id|video1394_mmap
comma
id|open
suffix:colon
id|video1394_open
comma
id|release
suffix:colon
id|video1394_release
)brace
suffix:semicolon
DECL|function|video1394_init
r_static
r_int
id|video1394_init
c_func
(paren
r_int
id|i
comma
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
op_amp
id|video_cards
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ohci1394_register_video
c_func
(paren
id|ohci
comma
op_amp
id|video_tmpl
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|i
comma
l_string|&quot;register_video failed&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|video-&gt;ohci
op_assign
id|ohci
suffix:semicolon
multiline_comment|/* Iso receive dma contexts */
id|video-&gt;ir_context
op_assign
(paren
r_struct
id|dma_iso_ctx
op_star
op_star
)paren
id|kmalloc
c_func
(paren
(paren
id|ohci-&gt;nb_iso_rcv_ctx
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|dma_iso_ctx
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;ir_context
)paren
id|memset
c_func
(paren
id|video-&gt;ir_context
comma
l_int|0
comma
(paren
id|ohci-&gt;nb_iso_rcv_ctx
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|dma_iso_ctx
op_star
)paren
)paren
suffix:semicolon
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Cannot allocate ir_context&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Iso transmit dma contexts */
id|video-&gt;it_context
op_assign
(paren
r_struct
id|dma_iso_ctx
op_star
op_star
)paren
id|kmalloc
c_func
(paren
id|ohci-&gt;nb_iso_xmit_ctx
op_star
r_sizeof
(paren
r_struct
id|dma_iso_ctx
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;it_context
)paren
id|memset
c_func
(paren
id|video-&gt;it_context
comma
l_int|0
comma
id|ohci-&gt;nb_iso_xmit_ctx
op_star
r_sizeof
(paren
r_struct
id|dma_iso_ctx
op_star
)paren
)paren
suffix:semicolon
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Cannot allocate it_context&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|remove_card
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|video_card
op_star
id|video
)paren
(brace
r_int
id|i
suffix:semicolon
id|ohci1394_unregister_video
c_func
(paren
id|video-&gt;ohci
comma
op_amp
id|video_tmpl
)paren
suffix:semicolon
multiline_comment|/* Free the iso receive contexts */
r_if
c_cond
(paren
id|video-&gt;ir_context
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|video-&gt;ohci-&gt;nb_iso_rcv_ctx
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|video-&gt;ir_context
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|video-&gt;ir_context
)paren
suffix:semicolon
)brace
multiline_comment|/* Free the iso transmit contexts */
r_if
c_cond
(paren
id|video-&gt;it_context
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|video-&gt;ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|free_dma_iso_ctx
c_func
(paren
op_amp
id|video-&gt;it_context
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|video-&gt;it_context
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE
multiline_comment|/* EXPORT_NO_SYMBOLS; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;driver for digital video on OHCI board&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;video1394&quot;
)paren
suffix:semicolon
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|unregister_chrdev
c_func
(paren
id|VIDEO1394_MAJOR
comma
id|VIDEO1394_DRIVER_NAME
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_of_video_cards
suffix:semicolon
id|i
op_increment
)paren
id|remove_card
c_func
(paren
op_amp
id|video_cards
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;removed &quot;
id|VIDEO1394_DRIVER_NAME
l_string|&quot; module&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
id|video_cards
comma
l_int|0
comma
id|MAX_OHCI1394_CARDS
op_star
r_sizeof
(paren
r_struct
id|video_card
)paren
)paren
suffix:semicolon
id|num_of_video_cards
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_OHCI1394_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ohci
op_assign
id|ohci1394_get_struct
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci
)paren
(brace
id|num_of_video_cards
op_increment
suffix:semicolon
id|video1394_init
c_func
(paren
id|i
comma
id|ohci
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|num_of_video_cards
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;no ohci card found... init failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|VIDEO1394_MAJOR
comma
id|VIDEO1394_DRIVER_NAME
comma
op_amp
id|video1394_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;video1394: unable to get major %d&bslash;n&quot;
comma
id|VIDEO1394_MAJOR
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;initialized with %d ohci cards&quot;
comma
id|num_of_video_cards
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
