multiline_comment|/*&n; * IEEE 1394 for Linux&n; *&n; * Core support: hpsb_packet management, packet handling and forwarding to&n; *               highlevel or lowlevel code&n; *&n; * Copyright (C) 1999, 2000 Andreas E. Bombe&n; *&n; * This code is licensed under the GPL.  See the file COPYING in the root&n; * directory of the kernel sources for details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;ieee1394_transactions.h&quot;
macro_line|#include &quot;csr.h&quot;
macro_line|#include &quot;guid.h&quot;
DECL|variable|hpsb_generation
id|atomic_t
id|hpsb_generation
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
DECL|function|dump_packet
r_static
r_void
id|dump_packet
c_func
(paren
r_const
r_char
op_star
id|text
comma
id|quadlet_t
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_int
id|i
suffix:semicolon
id|size
op_div_assign
l_int|4
suffix:semicolon
id|size
op_assign
(paren
id|size
OG
l_int|4
ques
c_cond
l_int|4
suffix:colon
id|size
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ieee1394: %s&quot;
comma
id|text
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %8.8x&quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * alloc_hpsb_packet - allocate new packet structure&n; * @data_size: size of the data block to be allocated&n; *&n; * This function allocates, initializes and returns a new &amp;struct hpsb_packet.&n; * It can be used in interrupt context.  A header block is always included, its&n; * size is big enough to contain all possible 1394 headers.  The data block is&n; * only allocated when @data_size is not zero.&n; *&n; * For packets for which responses will be received the @data_size has to be big&n; * enough to contain the response&squot;s data block since no further allocation&n; * occurs at response matching time.&n; *&n; * The packet&squot;s generation value will be set to the current generation number&n; * for ease of use.  Remember to overwrite it with your own recorded generation&n; * number if you can not be sure that your code will not race with a bus reset.&n; *&n; * Return value: A pointer to a &amp;struct hpsb_packet or NULL on allocation&n; * failure.&n; */
DECL|function|alloc_hpsb_packet
r_struct
id|hpsb_packet
op_star
id|alloc_hpsb_packet
c_func
(paren
r_int
id|data_size
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|packet
op_assign
l_int|NULL
suffix:semicolon
r_void
op_star
id|header
op_assign
l_int|NULL
comma
op_star
id|data
op_assign
l_int|NULL
suffix:semicolon
r_int
id|kmflags
op_assign
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
suffix:semicolon
id|packet
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hpsb_packet
)paren
comma
id|kmflags
)paren
suffix:semicolon
id|header
op_assign
id|kmalloc
c_func
(paren
l_int|5
op_star
l_int|4
comma
id|kmflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|header
op_eq
l_int|NULL
op_logical_or
id|packet
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|header
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|packet
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hpsb_packet
)paren
)paren
suffix:semicolon
id|packet-&gt;header
op_assign
id|header
suffix:semicolon
r_if
c_cond
(paren
id|data_size
)paren
(brace
id|data
op_assign
id|kmalloc
c_func
(paren
id|data_size
op_plus
l_int|8
comma
id|kmflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|header
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|packet-&gt;data
op_assign
id|data
suffix:semicolon
id|packet-&gt;data_size
op_assign
id|data_size
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|packet-&gt;list
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|packet-&gt;state_change
comma
l_int|0
)paren
suffix:semicolon
id|packet-&gt;state
op_assign
id|unused
suffix:semicolon
id|packet-&gt;generation
op_assign
id|get_hpsb_generation
c_func
(paren
)paren
suffix:semicolon
id|packet-&gt;data_be
op_assign
l_int|1
suffix:semicolon
r_return
id|packet
suffix:semicolon
)brace
multiline_comment|/**&n; * free_hpsb_packet - free packet and data associated with it&n; * @packet: packet to free (is NULL safe)&n; *&n; * This function will free packet-&gt;data, packet-&gt;header and finally the packet&n; * itself.&n; */
DECL|function|free_hpsb_packet
r_void
id|free_hpsb_packet
c_func
(paren
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_if
c_cond
(paren
id|packet
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|packet-&gt;data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|packet-&gt;header
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|packet
)paren
suffix:semicolon
)brace
DECL|function|hpsb_reset_bus
r_int
id|hpsb_reset_bus
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;initialized
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hpsb_bus_reset
c_func
(paren
id|host
)paren
)paren
(brace
id|host
op_member_access_from_pointer
r_template
op_member_access_from_pointer
id|devctl
c_func
(paren
id|host
comma
id|RESET_BUS
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|hpsb_bus_reset
r_int
id|hpsb_bus_reset
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
id|HPSB_NOTICE
c_func
(paren
id|__FUNCTION__
l_string|&quot; called while bus reset already in progress&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|abort_requests
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;in_bus_reset
op_assign
l_int|1
suffix:semicolon
id|host-&gt;irm_id
op_assign
op_minus
l_int|1
suffix:semicolon
id|host-&gt;busmgr_id
op_assign
op_minus
l_int|1
suffix:semicolon
id|host-&gt;node_count
op_assign
l_int|0
suffix:semicolon
id|host-&gt;selfid_count
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Verify num_of_selfids SelfIDs and return number of nodes.  Return zero in&n; * case verification failed.&n; */
DECL|function|check_selfids
r_static
r_int
id|check_selfids
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
r_int
id|num_of_selfids
)paren
(brace
r_int
id|nodeid
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|rest_of_selfids
op_assign
id|num_of_selfids
suffix:semicolon
r_struct
id|selfid
op_star
id|sid
op_assign
(paren
r_struct
id|selfid
op_star
)paren
id|host-&gt;topology_map
suffix:semicolon
r_struct
id|ext_selfid
op_star
id|esid
suffix:semicolon
r_int
id|esid_seq
op_assign
l_int|23
suffix:semicolon
r_while
c_loop
(paren
id|rest_of_selfids
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sid-&gt;extended
)paren
(brace
id|nodeid
op_increment
suffix:semicolon
id|esid_seq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sid-&gt;phy_id
op_ne
id|nodeid
)paren
(brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;SelfIDs failed monotony check with &quot;
l_string|&quot;%d&quot;
comma
id|sid-&gt;phy_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sid-&gt;contender
op_logical_and
id|sid-&gt;link_active
)paren
(brace
id|host-&gt;irm_id
op_assign
id|LOCAL_BUS
op_or
id|sid-&gt;phy_id
suffix:semicolon
)brace
)brace
r_else
(brace
id|esid
op_assign
(paren
r_struct
id|ext_selfid
op_star
)paren
id|sid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|esid-&gt;phy_id
op_ne
id|nodeid
)paren
op_logical_or
(paren
id|esid-&gt;seq_nr
op_ne
id|esid_seq
)paren
)paren
(brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;SelfIDs failed monotony check with &quot;
l_string|&quot;%d/%d&quot;
comma
id|esid-&gt;phy_id
comma
id|esid-&gt;seq_nr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|esid_seq
op_increment
suffix:semicolon
)brace
id|sid
op_increment
suffix:semicolon
)brace
id|esid
op_assign
(paren
r_struct
id|ext_selfid
op_star
)paren
(paren
id|sid
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|esid-&gt;extended
)paren
(brace
r_if
c_cond
(paren
(paren
id|esid-&gt;porta
op_eq
l_int|0x2
)paren
op_logical_or
(paren
id|esid-&gt;portb
op_eq
l_int|0x2
)paren
op_logical_or
(paren
id|esid-&gt;portc
op_eq
l_int|0x2
)paren
op_logical_or
(paren
id|esid-&gt;portd
op_eq
l_int|0x2
)paren
op_logical_or
(paren
id|esid-&gt;porte
op_eq
l_int|0x2
)paren
op_logical_or
(paren
id|esid-&gt;portf
op_eq
l_int|0x2
)paren
op_logical_or
(paren
id|esid-&gt;portg
op_eq
l_int|0x2
)paren
op_logical_or
(paren
id|esid-&gt;porth
op_eq
l_int|0x2
)paren
)paren
(brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;SelfIDs failed root check on &quot;
l_string|&quot;extended SelfID&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|esid
op_decrement
suffix:semicolon
)brace
id|sid
op_assign
(paren
r_struct
id|selfid
op_star
)paren
id|esid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sid-&gt;port0
op_eq
l_int|0x2
)paren
op_logical_or
(paren
id|sid-&gt;port1
op_eq
l_int|0x2
)paren
op_logical_or
(paren
id|sid-&gt;port2
op_eq
l_int|0x2
)paren
)paren
(brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;SelfIDs failed root check&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|nodeid
op_plus
l_int|1
suffix:semicolon
)brace
DECL|function|build_speed_map
r_static
r_void
id|build_speed_map
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|nodecount
)paren
(brace
r_char
id|speedcap
(braket
id|nodecount
)braket
suffix:semicolon
r_char
id|cldcnt
(braket
id|nodecount
)braket
suffix:semicolon
id|u8
op_star
id|map
op_assign
id|host-&gt;speed_map
suffix:semicolon
r_struct
id|selfid
op_star
id|sid
suffix:semicolon
r_struct
id|ext_selfid
op_star
id|esid
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|n
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|nodecount
op_star
l_int|64
)paren
suffix:semicolon
id|i
op_add_assign
l_int|64
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|nodecount
suffix:semicolon
id|j
op_increment
)paren
(brace
id|map
(braket
id|i
op_plus
id|j
)braket
op_assign
id|SPEED_400
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nodecount
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cldcnt
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* find direct children count and speed */
r_for
c_loop
(paren
id|sid
op_assign
(paren
r_struct
id|selfid
op_star
)paren
op_amp
id|host-&gt;topology_map
(braket
id|host-&gt;selfid_count
op_minus
l_int|1
)braket
comma
id|n
op_assign
id|nodecount
op_minus
l_int|1
suffix:semicolon
(paren
r_void
op_star
)paren
id|sid
op_ge
(paren
r_void
op_star
)paren
id|host-&gt;topology_map
suffix:semicolon
id|sid
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|sid-&gt;extended
)paren
(brace
id|esid
op_assign
(paren
r_struct
id|ext_selfid
op_star
)paren
id|sid
suffix:semicolon
r_if
c_cond
(paren
id|esid-&gt;porta
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|esid-&gt;portb
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|esid-&gt;portc
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|esid-&gt;portd
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|esid-&gt;porte
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|esid-&gt;portf
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|esid-&gt;portg
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|esid-&gt;porth
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sid-&gt;port0
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sid-&gt;port1
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sid-&gt;port2
op_eq
l_int|0x3
)paren
id|cldcnt
(braket
id|n
)braket
op_increment
suffix:semicolon
id|speedcap
(braket
id|n
)braket
op_assign
id|sid-&gt;speed
suffix:semicolon
id|n
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/* set self mapping */
r_for
c_loop
(paren
id|i
op_assign
id|nodecount
op_minus
l_int|1
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|map
(braket
l_int|64
op_star
id|i
op_plus
id|i
)braket
op_assign
id|speedcap
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* fix up direct children count to total children count;&n;         * also fix up speedcaps for sibling and parent communication */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|nodecount
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
id|cldcnt
(braket
id|i
)braket
comma
id|n
op_assign
id|i
op_minus
l_int|1
suffix:semicolon
id|j
OG
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|cldcnt
(braket
id|i
)braket
op_add_assign
id|cldcnt
(braket
id|n
)braket
suffix:semicolon
id|speedcap
(braket
id|n
)braket
op_assign
id|MIN
c_func
(paren
id|speedcap
(braket
id|n
)braket
comma
id|speedcap
(braket
id|i
)braket
)paren
suffix:semicolon
id|n
op_sub_assign
id|cldcnt
(braket
id|n
)braket
op_plus
l_int|1
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|nodecount
suffix:semicolon
id|n
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
id|n
op_minus
id|cldcnt
(braket
id|n
)braket
suffix:semicolon
id|i
op_le
id|n
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
id|n
op_minus
id|cldcnt
(braket
id|n
)braket
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
id|map
(braket
id|j
op_star
l_int|64
op_plus
id|i
)braket
op_assign
id|map
(braket
id|i
op_star
l_int|64
op_plus
id|j
)braket
op_assign
id|MIN
c_func
(paren
id|map
(braket
id|i
op_star
l_int|64
op_plus
id|j
)braket
comma
id|speedcap
(braket
id|n
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
id|n
op_plus
l_int|1
suffix:semicolon
id|j
OL
id|nodecount
suffix:semicolon
id|j
op_increment
)paren
(brace
id|map
(braket
id|j
op_star
l_int|64
op_plus
id|i
)braket
op_assign
id|map
(braket
id|i
op_star
l_int|64
op_plus
id|j
)braket
op_assign
id|MIN
c_func
(paren
id|map
(braket
id|i
op_star
l_int|64
op_plus
id|j
)braket
comma
id|speedcap
(braket
id|n
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|hpsb_selfid_received
r_void
id|hpsb_selfid_received
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
id|quadlet_t
id|sid
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
id|HPSB_DEBUG
c_func
(paren
l_string|&quot;including selfid 0x%x&quot;
comma
id|sid
)paren
suffix:semicolon
id|host-&gt;topology_map
(braket
id|host-&gt;selfid_count
op_increment
)braket
op_assign
id|sid
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* FIXME - info on which host */
id|HPSB_NOTICE
c_func
(paren
l_string|&quot;spurious selfid packet (0x%8.8x) received&quot;
comma
id|sid
)paren
suffix:semicolon
)brace
)brace
DECL|function|hpsb_selfid_complete
r_void
id|hpsb_selfid_complete
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|phyid
comma
r_int
id|isroot
)paren
(brace
id|host-&gt;node_id
op_assign
l_int|0xffc0
op_or
id|phyid
suffix:semicolon
id|host-&gt;in_bus_reset
op_assign
l_int|0
suffix:semicolon
id|host-&gt;is_root
op_assign
id|isroot
suffix:semicolon
id|host-&gt;node_count
op_assign
id|check_selfids
c_func
(paren
id|host
comma
id|host-&gt;selfid_count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;node_count
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;reset_retries
op_increment
OL
l_int|20
)paren
(brace
multiline_comment|/* selfid stage did not complete without error */
id|HPSB_NOTICE
c_func
(paren
l_string|&quot;error in SelfID stage - resetting&quot;
)paren
suffix:semicolon
id|hpsb_reset_bus
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|HPSB_NOTICE
c_func
(paren
l_string|&quot;stopping out-of-control reset loop&quot;
)paren
suffix:semicolon
id|HPSB_NOTICE
c_func
(paren
l_string|&quot;warning - topology map and speed map will &quot;
l_string|&quot;therefore not be valid&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|build_speed_map
c_func
(paren
id|host
comma
id|host-&gt;node_count
)paren
suffix:semicolon
)brace
multiline_comment|/* irm_id is kept up to date by check_selfids() */
r_if
c_cond
(paren
id|host-&gt;irm_id
op_eq
id|host-&gt;node_id
)paren
(brace
id|host-&gt;is_irm
op_assign
l_int|1
suffix:semicolon
id|host-&gt;is_busmgr
op_assign
l_int|1
suffix:semicolon
id|host-&gt;busmgr_id
op_assign
id|host-&gt;node_id
suffix:semicolon
id|host-&gt;csr.bus_manager_id
op_assign
id|host-&gt;node_id
suffix:semicolon
)brace
id|host-&gt;reset_retries
op_assign
l_int|0
suffix:semicolon
id|inc_hpsb_generation
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isroot
)paren
id|host
op_member_access_from_pointer
r_template
op_member_access_from_pointer
id|devctl
c_func
(paren
id|host
comma
id|ACT_CYCLE_MASTER
comma
l_int|1
)paren
suffix:semicolon
id|highlevel_host_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
DECL|function|hpsb_packet_sent
r_void
id|hpsb_packet_sent
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_struct
id|hpsb_packet
op_star
id|packet
comma
r_int
id|ackcode
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|packet-&gt;ack_code
op_assign
id|ackcode
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;no_waiter
)paren
(brace
multiline_comment|/* must not have a tlabel allocated */
id|free_hpsb_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ackcode
op_ne
id|ACK_PENDING
op_logical_or
op_logical_neg
id|packet-&gt;expect_response
)paren
(brace
id|packet-&gt;state
op_assign
id|complete
suffix:semicolon
id|up
c_func
(paren
op_amp
id|packet-&gt;state_change
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|packet-&gt;state_change
)paren
suffix:semicolon
id|run_task_queue
c_func
(paren
op_amp
id|packet-&gt;complete_tq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|packet-&gt;state
op_assign
id|pending
suffix:semicolon
id|packet-&gt;sendtime
op_assign
id|jiffies
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|packet-&gt;list
comma
op_amp
id|host-&gt;pending_packets
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|packet-&gt;state_change
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|host-&gt;timeout_tq
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * hpsb_send_packet - transmit a packet on the bus&n; * @packet: packet to send&n; *&n; * The packet is sent through the host specified in the packet-&gt;host field.&n; * Before sending, the packet&squot;s transmit speed is automatically determined using&n; * the local speed map when it is an async, non-broadcast packet.&n; *&n; * Possibilities for failure are that host is either not initialized, in bus&n; * reset, the packet&squot;s generation number doesn&squot;t match the current generation&n; * number or the host reports a transmit error.&n; *&n; * Return value: False (0) on failure, true (1) otherwise.&n; */
DECL|function|hpsb_send_packet
r_int
id|hpsb_send_packet
c_func
(paren
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|packet-&gt;host
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;initialized
op_logical_or
id|host-&gt;in_bus_reset
op_logical_or
(paren
id|packet-&gt;generation
op_ne
id|get_hpsb_generation
c_func
(paren
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|packet-&gt;state
op_assign
id|queued
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|async
op_logical_and
id|packet-&gt;node_id
op_ne
id|ALL_NODES
)paren
(brace
id|packet-&gt;speed_code
op_assign
id|host-&gt;speed_map
(braket
(paren
id|host-&gt;node_id
op_amp
id|NODE_MASK
)paren
op_star
l_int|64
op_plus
(paren
id|packet-&gt;node_id
op_amp
id|NODE_MASK
)paren
)braket
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
r_switch
c_cond
(paren
id|packet-&gt;speed_code
)paren
(brace
r_case
l_int|2
suffix:colon
id|dump_packet
c_func
(paren
l_string|&quot;send packet 400:&quot;
comma
id|packet-&gt;header
comma
id|packet-&gt;header_size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|dump_packet
c_func
(paren
l_string|&quot;send packet 200:&quot;
comma
id|packet-&gt;header
comma
id|packet-&gt;header_size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dump_packet
c_func
(paren
l_string|&quot;send packet 100:&quot;
comma
id|packet-&gt;header
comma
id|packet-&gt;header_size
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|host
op_member_access_from_pointer
r_template
op_member_access_from_pointer
id|transmit_packet
c_func
(paren
id|host
comma
id|packet
)paren
suffix:semicolon
)brace
DECL|function|send_packet_nocare
r_static
r_void
id|send_packet_nocare
c_func
(paren
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hpsb_send_packet
c_func
(paren
id|packet
)paren
)paren
(brace
id|free_hpsb_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
)brace
)brace
DECL|function|handle_packet_response
r_void
id|handle_packet_response
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|tcode
comma
id|quadlet_t
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|packet
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_int
id|tcode_match
op_assign
l_int|0
suffix:semicolon
r_int
id|tlabel
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|tlabel
op_assign
(paren
id|data
(braket
l_int|0
)braket
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
id|lh
op_assign
id|host-&gt;pending_packets.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|host-&gt;pending_packets
)paren
(brace
id|packet
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|hpsb_packet
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|packet-&gt;tlabel
op_eq
id|tlabel
)paren
op_logical_and
(paren
id|packet-&gt;node_id
op_eq
(paren
id|data
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lh
op_eq
op_amp
id|host-&gt;pending_packets
)paren
(brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;unsolicited response packet received - np&quot;
)paren
suffix:semicolon
id|dump_packet
c_func
(paren
l_string|&quot;contents:&quot;
comma
id|data
comma
l_int|16
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|packet-&gt;tcode
)paren
(brace
r_case
id|TCODE_WRITEQ
suffix:colon
r_case
id|TCODE_WRITEB
suffix:colon
r_if
c_cond
(paren
id|tcode
op_eq
id|TCODE_WRITE_RESPONSE
)paren
id|tcode_match
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_READQ
suffix:colon
r_if
c_cond
(paren
id|tcode
op_eq
id|TCODE_READQ_RESPONSE
)paren
id|tcode_match
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_READB
suffix:colon
r_if
c_cond
(paren
id|tcode
op_eq
id|TCODE_READB_RESPONSE
)paren
id|tcode_match
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_LOCK_REQUEST
suffix:colon
r_if
c_cond
(paren
id|tcode
op_eq
id|TCODE_LOCK_RESPONSE
)paren
id|tcode_match
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tcode_match
op_logical_or
(paren
id|packet-&gt;tlabel
op_ne
id|tlabel
)paren
op_logical_or
(paren
id|packet-&gt;node_id
op_ne
(paren
id|data
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
)paren
)paren
(brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;unsolicited response packet received&quot;
)paren
suffix:semicolon
id|dump_packet
c_func
(paren
l_string|&quot;contents:&quot;
comma
id|data
comma
l_int|16
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|packet-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* FIXME - update size fields? */
r_switch
c_cond
(paren
id|tcode
)paren
(brace
r_case
id|TCODE_WRITE_RESPONSE
suffix:colon
id|memcpy
c_func
(paren
id|packet-&gt;header
comma
id|data
comma
l_int|12
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_READQ_RESPONSE
suffix:colon
id|memcpy
c_func
(paren
id|packet-&gt;header
comma
id|data
comma
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_READB_RESPONSE
suffix:colon
id|memcpy
c_func
(paren
id|packet-&gt;header
comma
id|data
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|packet-&gt;data
comma
id|data
op_plus
l_int|4
comma
id|size
op_minus
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_LOCK_RESPONSE
suffix:colon
id|memcpy
c_func
(paren
id|packet-&gt;header
comma
id|data
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|packet-&gt;data
comma
id|data
op_plus
l_int|4
comma
(paren
id|size
op_minus
l_int|16
)paren
OG
l_int|8
ques
c_cond
l_int|8
suffix:colon
id|size
op_minus
l_int|16
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|packet-&gt;state
op_assign
id|complete
suffix:semicolon
id|up
c_func
(paren
op_amp
id|packet-&gt;state_change
)paren
suffix:semicolon
id|run_task_queue
c_func
(paren
op_amp
id|packet-&gt;complete_tq
)paren
suffix:semicolon
)brace
DECL|function|create_reply_packet
r_struct
id|hpsb_packet
op_star
id|create_reply_packet
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
id|quadlet_t
op_star
id|data
comma
r_int
id|dsize
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|p
suffix:semicolon
id|dsize
op_add_assign
(paren
id|dsize
op_mod
l_int|4
ques
c_cond
l_int|4
op_minus
(paren
id|dsize
op_mod
l_int|4
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|p
op_assign
id|alloc_hpsb_packet
c_func
(paren
id|dsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* FIXME - send data_error response */
r_return
l_int|NULL
suffix:semicolon
)brace
id|p-&gt;type
op_assign
id|async
suffix:semicolon
id|p-&gt;state
op_assign
id|unused
suffix:semicolon
id|p-&gt;host
op_assign
id|host
suffix:semicolon
id|p-&gt;node_id
op_assign
id|data
(braket
l_int|1
)braket
op_rshift
l_int|16
suffix:semicolon
id|p-&gt;tlabel
op_assign
(paren
id|data
(braket
l_int|0
)braket
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|p-&gt;no_waiter
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dsize
op_mod
l_int|4
)paren
(brace
id|p-&gt;data
(braket
id|dsize
op_div
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|p
suffix:semicolon
)brace
DECL|macro|PREP_REPLY_PACKET
mdefine_line|#define PREP_REPLY_PACKET(length) &bslash;&n;                packet = create_reply_packet(host, data, length); &bslash;&n;                if (packet == NULL) break
DECL|function|handle_incoming_packet
r_void
id|handle_incoming_packet
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|tcode
comma
id|quadlet_t
op_star
id|data
comma
r_int
id|size
comma
r_int
id|write_acked
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
r_int
id|length
comma
id|rcode
comma
id|extcode
suffix:semicolon
r_int
id|source
op_assign
id|data
(braket
l_int|1
)braket
op_rshift
l_int|16
suffix:semicolon
id|u64
id|addr
suffix:semicolon
multiline_comment|/* big FIXME - no error checking is done for an out of bounds length */
r_switch
c_cond
(paren
id|tcode
)paren
(brace
r_case
id|TCODE_WRITEQ
suffix:colon
id|addr
op_assign
(paren
(paren
(paren
id|u64
)paren
(paren
id|data
(braket
l_int|1
)braket
op_amp
l_int|0xffff
)paren
)paren
op_lshift
l_int|32
)paren
op_or
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|rcode
op_assign
id|highlevel_write
c_func
(paren
id|host
comma
id|source
comma
id|data
op_plus
l_int|3
comma
id|addr
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|write_acked
op_logical_and
(paren
(paren
id|data
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
op_amp
id|NODE_MASK
)paren
op_ne
id|NODE_MASK
)paren
(brace
multiline_comment|/* not a broadcast write, reply */
id|PREP_REPLY_PACKET
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fill_async_write_resp
c_func
(paren
id|packet
comma
id|rcode
)paren
suffix:semicolon
id|send_packet_nocare
c_func
(paren
id|packet
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TCODE_WRITEB
suffix:colon
id|addr
op_assign
(paren
(paren
(paren
id|u64
)paren
(paren
id|data
(braket
l_int|1
)braket
op_amp
l_int|0xffff
)paren
)paren
op_lshift
l_int|32
)paren
op_or
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|rcode
op_assign
id|highlevel_write
c_func
(paren
id|host
comma
id|source
comma
id|data
op_plus
l_int|4
comma
id|addr
comma
id|data
(braket
l_int|3
)braket
op_rshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|write_acked
op_logical_and
(paren
(paren
id|data
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
op_amp
id|NODE_MASK
)paren
op_ne
id|NODE_MASK
)paren
(brace
multiline_comment|/* not a broadcast write, reply */
id|PREP_REPLY_PACKET
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fill_async_write_resp
c_func
(paren
id|packet
comma
id|rcode
)paren
suffix:semicolon
id|send_packet_nocare
c_func
(paren
id|packet
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TCODE_READQ
suffix:colon
id|PREP_REPLY_PACKET
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|addr
op_assign
(paren
(paren
(paren
id|u64
)paren
(paren
id|data
(braket
l_int|1
)braket
op_amp
l_int|0xffff
)paren
)paren
op_lshift
l_int|32
)paren
op_or
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|rcode
op_assign
id|highlevel_read
c_func
(paren
id|host
comma
id|source
comma
id|data
comma
id|addr
comma
l_int|4
)paren
suffix:semicolon
id|fill_async_readquad_resp
c_func
(paren
id|packet
comma
id|rcode
comma
op_star
id|data
)paren
suffix:semicolon
id|send_packet_nocare
c_func
(paren
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_READB
suffix:colon
id|length
op_assign
id|data
(braket
l_int|3
)braket
op_rshift
l_int|16
suffix:semicolon
id|PREP_REPLY_PACKET
c_func
(paren
id|length
)paren
suffix:semicolon
id|addr
op_assign
(paren
(paren
(paren
id|u64
)paren
(paren
id|data
(braket
l_int|1
)braket
op_amp
l_int|0xffff
)paren
)paren
op_lshift
l_int|32
)paren
op_or
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|rcode
op_assign
id|highlevel_read
c_func
(paren
id|host
comma
id|source
comma
id|packet-&gt;data
comma
id|addr
comma
id|length
)paren
suffix:semicolon
id|fill_async_readblock_resp
c_func
(paren
id|packet
comma
id|rcode
comma
id|length
)paren
suffix:semicolon
id|send_packet_nocare
c_func
(paren
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_LOCK_REQUEST
suffix:colon
id|length
op_assign
id|data
(braket
l_int|3
)braket
op_rshift
l_int|16
suffix:semicolon
id|extcode
op_assign
id|data
(braket
l_int|3
)braket
op_amp
l_int|0xffff
suffix:semicolon
id|addr
op_assign
(paren
(paren
(paren
id|u64
)paren
(paren
id|data
(braket
l_int|1
)braket
op_amp
l_int|0xffff
)paren
)paren
op_lshift
l_int|32
)paren
op_or
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|PREP_REPLY_PACKET
c_func
(paren
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|extcode
op_eq
l_int|0
)paren
op_logical_or
(paren
id|extcode
op_ge
l_int|7
)paren
)paren
(brace
multiline_comment|/* let switch default handle error */
id|length
op_assign
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|length
)paren
(brace
r_case
l_int|4
suffix:colon
id|rcode
op_assign
id|highlevel_lock
c_func
(paren
id|host
comma
id|source
comma
id|packet-&gt;data
comma
id|addr
comma
id|data
(braket
l_int|4
)braket
comma
l_int|0
comma
id|extcode
)paren
suffix:semicolon
id|fill_async_lock_resp
c_func
(paren
id|packet
comma
id|rcode
comma
id|extcode
comma
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
r_if
c_cond
(paren
(paren
id|extcode
op_ne
id|EXTCODE_FETCH_ADD
)paren
op_logical_and
(paren
id|extcode
op_ne
id|EXTCODE_LITTLE_ADD
)paren
)paren
(brace
id|rcode
op_assign
id|highlevel_lock
c_func
(paren
id|host
comma
id|source
comma
id|packet-&gt;data
comma
id|addr
comma
id|data
(braket
l_int|5
)braket
comma
id|data
(braket
l_int|4
)braket
comma
id|extcode
)paren
suffix:semicolon
id|fill_async_lock_resp
c_func
(paren
id|packet
comma
id|rcode
comma
id|extcode
comma
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|rcode
op_assign
id|highlevel_lock64
c_func
(paren
id|host
comma
id|source
comma
(paren
id|octlet_t
op_star
)paren
id|packet-&gt;data
comma
id|addr
comma
op_star
(paren
id|octlet_t
op_star
)paren
(paren
id|data
op_plus
l_int|4
)paren
comma
l_int|0ULL
comma
id|extcode
)paren
suffix:semicolon
id|fill_async_lock_resp
c_func
(paren
id|packet
comma
id|rcode
comma
id|extcode
comma
l_int|8
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|rcode
op_assign
id|highlevel_lock64
c_func
(paren
id|host
comma
id|source
comma
(paren
id|octlet_t
op_star
)paren
id|packet-&gt;data
comma
id|addr
comma
op_star
(paren
id|octlet_t
op_star
)paren
(paren
id|data
op_plus
l_int|6
)paren
comma
op_star
(paren
id|octlet_t
op_star
)paren
(paren
id|data
op_plus
l_int|4
)paren
comma
id|extcode
)paren
suffix:semicolon
id|fill_async_lock_resp
c_func
(paren
id|packet
comma
id|rcode
comma
id|extcode
comma
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|fill_async_lock_resp
c_func
(paren
id|packet
comma
id|RCODE_TYPE_ERROR
comma
id|extcode
comma
l_int|0
)paren
suffix:semicolon
)brace
id|send_packet_nocare
c_func
(paren
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|macro|PREP_REPLY_PACKET
macro_line|#undef PREP_REPLY_PACKET
DECL|function|hpsb_packet_received
r_void
id|hpsb_packet_received
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
id|quadlet_t
op_star
id|data
comma
r_int
id|size
comma
r_int
id|write_acked
)paren
(brace
r_int
id|tcode
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;received packet during reset; ignoring&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
id|dump_packet
c_func
(paren
l_string|&quot;received packet:&quot;
comma
id|data
comma
id|size
)paren
suffix:semicolon
macro_line|#endif
id|tcode
op_assign
(paren
id|data
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
r_switch
c_cond
(paren
id|tcode
)paren
(brace
r_case
id|TCODE_WRITE_RESPONSE
suffix:colon
r_case
id|TCODE_READQ_RESPONSE
suffix:colon
r_case
id|TCODE_READB_RESPONSE
suffix:colon
r_case
id|TCODE_LOCK_RESPONSE
suffix:colon
id|handle_packet_response
c_func
(paren
id|host
comma
id|tcode
comma
id|data
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_WRITEQ
suffix:colon
r_case
id|TCODE_WRITEB
suffix:colon
r_case
id|TCODE_READQ
suffix:colon
r_case
id|TCODE_READB
suffix:colon
r_case
id|TCODE_LOCK_REQUEST
suffix:colon
id|handle_incoming_packet
c_func
(paren
id|host
comma
id|tcode
comma
id|data
comma
id|size
comma
id|write_acked
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_ISO_DATA
suffix:colon
id|highlevel_iso_receive
c_func
(paren
id|host
comma
id|data
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCODE_CYCLE_START
suffix:colon
multiline_comment|/* simply ignore this packet if it is passed on */
r_break
suffix:semicolon
r_default
suffix:colon
id|HPSB_NOTICE
c_func
(paren
l_string|&quot;received packet with bogus transaction code %d&quot;
comma
id|tcode
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|abort_requests
r_void
id|abort_requests
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|llist
)paren
suffix:semicolon
id|host
op_member_access_from_pointer
r_template
op_member_access_from_pointer
id|devctl
c_func
(paren
id|host
comma
id|CANCEL_REQUESTS
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
id|list_splice
c_func
(paren
op_amp
id|host-&gt;pending_packets
comma
op_amp
id|llist
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|host-&gt;pending_packets
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
id|lh
op_assign
id|llist.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|llist
)paren
(brace
id|packet
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|hpsb_packet
comma
id|list
)paren
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
id|packet-&gt;state
op_assign
id|complete
suffix:semicolon
id|packet-&gt;ack_code
op_assign
id|ACKX_ABORTED
suffix:semicolon
id|up
c_func
(paren
op_amp
id|packet-&gt;state_change
)paren
suffix:semicolon
id|run_task_queue
c_func
(paren
op_amp
id|packet-&gt;complete_tq
)paren
suffix:semicolon
)brace
)brace
DECL|function|abort_timedouts
r_void
id|abort_timedouts
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
r_int
r_int
id|expire
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|expiredlist
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;csr.lock
comma
id|flags
)paren
suffix:semicolon
id|expire
op_assign
(paren
id|host-&gt;csr.split_timeout_hi
op_star
l_int|8000
op_plus
(paren
id|host-&gt;csr.split_timeout_lo
op_rshift
l_int|19
)paren
)paren
op_star
id|HZ
op_div
l_int|8000
suffix:semicolon
multiline_comment|/* Avoid shortening of timeout due to rounding errors: */
id|expire
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;csr.lock
comma
id|flags
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
id|lh
op_assign
id|host-&gt;pending_packets.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|host-&gt;pending_packets
)paren
(brace
id|packet
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|hpsb_packet
comma
id|list
)paren
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|packet-&gt;sendtime
op_plus
id|expire
comma
id|jiffies
)paren
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|packet-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|packet-&gt;list
comma
op_amp
id|expiredlist
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|host-&gt;pending_packets
)paren
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|host-&gt;timeout_tq
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;pending_pkt_lock
comma
id|flags
)paren
suffix:semicolon
id|lh
op_assign
id|expiredlist.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|expiredlist
)paren
(brace
id|packet
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|hpsb_packet
comma
id|list
)paren
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
id|packet-&gt;state
op_assign
id|complete
suffix:semicolon
id|packet-&gt;ack_code
op_assign
id|ACKX_TIMEOUT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|packet-&gt;state_change
)paren
suffix:semicolon
id|run_task_queue
c_func
(paren
op_amp
id|packet-&gt;complete_tq
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifndef MODULE
DECL|function|ieee1394_init
r_void
id|__init
id|ieee1394_init
c_func
(paren
r_void
)paren
(brace
id|register_builtin_lowlevels
c_func
(paren
)paren
suffix:semicolon
id|init_hpsb_highlevel
c_func
(paren
)paren
suffix:semicolon
id|init_csr
c_func
(paren
)paren
suffix:semicolon
id|init_ieee1394_guid
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|init_hpsb_highlevel
c_func
(paren
)paren
suffix:semicolon
id|init_csr
c_func
(paren
)paren
suffix:semicolon
id|init_ieee1394_guid
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
eof
