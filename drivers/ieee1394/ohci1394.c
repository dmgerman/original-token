multiline_comment|/*&n; * ohci1394.c - driver for OHCI 1394 boards&n; * Copyright (C)1999,2000 Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&n; *                        Gord Peters &lt;GordPeters@smarttech.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
multiline_comment|/*&n; * Things known to be working:&n; * . Async Request Transmit&n; * . Async Response Receive&n; * . Async Request Receive&n; * . Async Response Transmit&n; * . Iso Receive&n; * . DMA mmap for iso receive&n; * &n; * Things not implemented:&n; * . Iso Transmit&n; * . DMA error recovery&n; *&n; * Things to be fixed:&n; * . Config ROM&n; *&n; * Known bugs:&n; * . Self-id are sometimes not received properly &n; *   if card is initialized with no other nodes &n; *   on the bus&n; * . Apple PowerBook detected but not working yet&n; */
multiline_comment|/* &n; * Acknowledgments:&n; *&n; * Adam J Richter &lt;adam@yggdrasil.com&gt;&n; *  . Use of pci_class to find device&n; * Andreas Tobler &lt;toa@pop.agri.ch&gt;&n; *  . Updated proc_fs calls&n; * Emilie Chung&t;&lt;emilie.chung@axis.com&gt;&n; *  . Tip on Async Request Filter&n; * Pascal Drolet &lt;pascal.drolet@informission.ca&gt;&n; *  . Various tips for optimization and functionnalities&n; * Robert Ficklin &lt;rficklin@westengineering.com&gt;&n; *  . Loop in irq_handler&n; * James Goodwin &lt;jamesg@Filanet.com&gt;&n; *  . Various tips on initialization, self-id reception, etc.&n; * Albrecht Dress &lt;ad@mpifr-bonn.mpg.de&gt;&n; *  . Apple PowerBook detection&n; * Daniel Kobras &lt;daniel.kobras@student.uni-tuebingen.de&gt;&n; *  . Reset the board properly before leaving + misc cleanups&n; * Leon van Stuivenberg &lt;leonvs@iae.nl&gt;&n; *  . Bug fixes&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;ohci1394.h&quot;
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
DECL|macro|OHCI1394_DEBUG
mdefine_line|#define OHCI1394_DEBUG
macro_line|#endif
macro_line|#ifdef DBGMSG
DECL|macro|DBGMSG
macro_line|#undef DBGMSG
macro_line|#endif
macro_line|#ifdef OHCI1394_DEBUG
DECL|macro|DBGMSG
mdefine_line|#define DBGMSG(card, fmt, args...) &bslash;&n;printk(KERN_INFO &quot;ohci1394_%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
macro_line|#else
DECL|macro|DBGMSG
mdefine_line|#define DBGMSG(card, fmt, args...)
macro_line|#endif
multiline_comment|/* print general (card independent) information */
DECL|macro|PRINT_G
mdefine_line|#define PRINT_G(level, fmt, args...) &bslash;&n;printk(level &quot;ohci1394: &quot; fmt &quot;&bslash;n&quot; , ## args)
multiline_comment|/* print card specific information */
DECL|macro|PRINT
mdefine_line|#define PRINT(level, card, fmt, args...) &bslash;&n;printk(level &quot;ohci1394_%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
DECL|macro|FAIL
mdefine_line|#define FAIL(fmt, args...) &bslash;&n;&t;PRINT_G(KERN_ERR, fmt , ## args); &bslash;&n;&t;  num_of_cards--; &bslash;&n;&t;    remove_card(ohci); &bslash;&n;&t;      return 1;
macro_line|#if USE_DEVICE
DECL|variable|supported_chips
r_int
id|supported_chips
(braket
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_OHCI1394_LV22
)brace
comma
(brace
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_OHCI1394_LV23
)brace
comma
(brace
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_OHCI1394_LV26
)brace
comma
(brace
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_OHCI1394_PCI4450
)brace
comma
(brace
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_OHCI1394
)brace
comma
(brace
id|PCI_VENDOR_ID_SONY
comma
id|PCI_DEVICE_ID_SONY_CXD3222
)brace
comma
(brace
id|PCI_VENDOR_ID_NEC
comma
id|PCI_DEVICE_ID_NEC_UPD72862
)brace
comma
(brace
id|PCI_VENDOR_ID_NEC
comma
id|PCI_DEVICE_ID_NEC_UPD72870
)brace
comma
(brace
id|PCI_VENDOR_ID_NEC
comma
id|PCI_DEVICE_ID_NEC_UPD72871
)brace
comma
(brace
id|PCI_VENDOR_ID_APPLE
comma
id|PCI_DEVICE_ID_APPLE_UNI_N_FW
)brace
comma
(brace
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_ALI_OHCI1394_M5251
)brace
comma
(brace
id|PCI_VENDOR_ID_LUCENT
comma
id|PCI_DEVICE_ID_LUCENT_FW323
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
macro_line|#else
DECL|macro|PCI_CLASS_FIREWIRE_OHCI
mdefine_line|#define PCI_CLASS_FIREWIRE_OHCI     ((PCI_CLASS_SERIAL_FIREWIRE &lt;&lt; 8) | 0x10)
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
DECL|variable|__initdata
r_static
r_struct
id|pci_device_id
id|ohci1394_pci_tbl
(braket
)braket
id|__initdata
op_assign
(brace
(brace
r_class
suffix:colon
id|PCI_CLASS_FIREWIRE_OHCI
comma
id|class_mask
suffix:colon
l_int|0x00ffffff
comma
id|vendor
suffix:colon
id|PCI_ANY_ID
comma
id|device
suffix:colon
id|PCI_ANY_ID
comma
id|subvendor
suffix:colon
id|PCI_ANY_ID
comma
id|subdevice
suffix:colon
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|ohci1394_pci_tbl
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif /* USE_DEVICE */
id|MODULE_PARM
c_func
(paren
id|attempt_root
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|attempt_root
r_static
r_int
id|attempt_root
op_assign
l_int|0
suffix:semicolon
DECL|variable|cards
r_static
r_struct
id|ti_ohci
id|cards
(braket
id|MAX_OHCI1394_CARDS
)braket
suffix:semicolon
DECL|variable|num_of_cards
r_static
r_int
id|num_of_cards
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|add_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
suffix:semicolon
r_static
r_int
id|init_driver
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|dma_trm_bh
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|dma_rcv_bh
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|dma_trm_reset
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
suffix:semicolon
multiline_comment|/***********************************&n; * IEEE-1394 functionality section *&n; ***********************************/
macro_line|#if 0 /* not needed at this time */
r_static
r_int
id|get_phy_reg
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|addr
)paren
(brace
r_int
id|timeout
op_assign
l_int|10000
suffix:semicolon
r_static
id|quadlet_t
id|r
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
OL
l_int|1
)paren
op_logical_or
(paren
id|addr
OG
l_int|15
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY register address %d out of range&quot;
comma
id|addr
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
multiline_comment|/* initiate read request */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
(paren
(paren
id|addr
op_lshift
l_int|8
)paren
op_amp
l_int|0x00000f00
)paren
op_or
l_int|0x00008000
)paren
suffix:semicolon
multiline_comment|/* wait */
r_while
c_loop
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
op_amp
l_int|0x80000000
)paren
op_logical_and
id|timeout
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;get_phy_reg timeout !!!&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|r
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
r_return
(paren
id|r
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
)brace
r_static
r_int
id|set_phy_reg
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|addr
comma
r_int
r_char
id|data
)paren
(brace
r_int
id|timeout
op_assign
l_int|10000
suffix:semicolon
id|u32
id|r
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
OL
l_int|1
)paren
op_logical_or
(paren
id|addr
OG
l_int|15
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY register address %d out of range&quot;
comma
id|addr
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|r
op_assign
(paren
(paren
id|addr
op_lshift
l_int|8
)paren
op_amp
l_int|0x00000f00
)paren
op_or
l_int|0x00004000
op_or
(paren
(paren
id|u32
)paren
id|data
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
id|r
)paren
suffix:semicolon
multiline_comment|/* wait */
r_while
c_loop
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
op_amp
l_int|0x80000000
)paren
op_logical_and
id|timeout
)paren
id|timeout
op_decrement
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;set_phy_reg timeout !!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* unneeded functions */
DECL|function|handle_selfid
r_inline
r_static
r_int
id|handle_selfid
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|phyid
comma
r_int
id|isroot
)paren
(brace
id|quadlet_t
op_star
id|q
op_assign
id|ohci-&gt;selfid_buf_cpu
suffix:semicolon
id|quadlet_t
id|self_id_count
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_SelfIDCount
)paren
suffix:semicolon
r_int
id|size
suffix:semicolon
id|quadlet_t
id|lsid
suffix:semicolon
multiline_comment|/* Self-id handling seems much easier than for the aic5800 chip.&n;&t;   All the self-id packets, including this device own self-id,&n;&t;   should be correctly arranged in the selfid buffer at this&n;&t;   stage */
multiline_comment|/* Check status of self-id reception */
r_if
c_cond
(paren
(paren
id|self_id_count
op_amp
l_int|0x80000000
)paren
op_logical_or
(paren
(paren
id|self_id_count
op_amp
l_int|0x00FF0000
)paren
op_ne
(paren
id|q
(braket
l_int|0
)braket
op_amp
l_int|0x00FF0000
)paren
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Error in reception of self-id packets&quot;
l_string|&quot;Self-id count: %08x q[0]: %08x&quot;
comma
id|self_id_count
comma
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Tip by James Goodwin &lt;jamesg@Filanet.com&gt;:&n;&t;&t; * We had an error, generate another bus reset in response. &n;&t;&t; * TODO. Actually read the current value in the phy before &n;&t;&t; * generating a bus reset (read modify write). This way&n;&t;&t; * we don&squot;t stomp any current gap count settings, etc.&n;&t;&t; */
r_if
c_cond
(paren
id|ohci-&gt;self_id_errors
OL
id|OHCI1394_MAX_SELF_ID_ERRORS
)paren
(brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
l_int|0x000041ff
)paren
suffix:semicolon
id|ohci-&gt;self_id_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Timeout on self-id error reception&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|size
op_assign
(paren
(paren
id|self_id_count
op_amp
l_int|0x00001FFC
)paren
op_rshift
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|q
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|q
(braket
l_int|0
)braket
op_eq
op_complement
id|q
(braket
l_int|1
)braket
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;selfid packet 0x%x rcvd&quot;
comma
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|cpu_to_be32
c_func
(paren
id|q
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|q
(braket
l_int|0
)braket
op_amp
l_int|0x3f000000
)paren
op_rshift
l_int|24
)paren
op_eq
id|phyid
)paren
(brace
id|lsid
op_assign
id|q
(braket
l_int|0
)braket
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;This node self-id is 0x%08x&quot;
comma
id|lsid
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;inconsistent selfid 0x%x/0x%x&quot;
comma
id|q
(braket
l_int|0
)braket
comma
id|q
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|q
op_add_assign
l_int|2
suffix:semicolon
id|size
op_sub_assign
l_int|2
suffix:semicolon
)brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;calling self-id complete&quot;
)paren
suffix:semicolon
id|hpsb_selfid_complete
c_func
(paren
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_detect
r_static
r_int
id|ohci_detect
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
r_int
id|i
suffix:semicolon
id|init_driver
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_of_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|host
op_assign
id|hpsb_get_host
c_func
(paren
id|tmpl
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* simply don&squot;t init more after out of mem */
r_return
id|i
suffix:semicolon
)brace
id|host-&gt;hostdata
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
id|cards
(braket
id|i
)braket
dot
id|host
op_assign
id|host
suffix:semicolon
)brace
r_return
id|num_of_cards
suffix:semicolon
)brace
DECL|function|ohci_soft_reset
r_static
r_int
id|ohci_soft_reset
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_int
id|timeout
op_assign
l_int|10000
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00010000
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
)paren
op_amp
l_int|0x00010000
)paren
op_logical_and
id|timeout
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;soft reset timeout !!!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;soft reset finished&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|run_context
r_static
r_int
id|run_context
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|reg
comma
r_char
op_star
id|msg
)paren
(brace
id|u32
id|nodeId
suffix:semicolon
multiline_comment|/* check that the node id is valid */
id|nodeId
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|nodeId
op_amp
l_int|0x80000000
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Running dma failed because Node ID not valid&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* check that the node number != 63 */
r_if
c_cond
(paren
(paren
id|nodeId
op_amp
l_int|0x3f
)paren
op_eq
l_int|63
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Running dma failed because Node ID == 63&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Run the dma context */
id|reg_write
c_func
(paren
id|ohci
comma
id|reg
comma
l_int|0x8000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
)paren
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;%s&quot;
comma
id|msg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Generate the dma receive prgs and start the context */
DECL|function|initialize_dma_rcv_ctx
r_static
r_void
id|initialize_dma_rcv_ctx
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* end of descriptor list? */
r_if
c_cond
(paren
(paren
id|i
op_plus
l_int|1
)paren
OL
id|d-&gt;num_desc
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|control
op_assign
(paren
l_int|0x283C
op_lshift
l_int|16
)paren
op_or
id|d-&gt;buf_size
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
(paren
id|d-&gt;prg_bus
(braket
id|i
op_plus
l_int|1
)braket
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|control
op_assign
(paren
l_int|0x283C
op_lshift
l_int|16
)paren
op_or
id|d-&gt;buf_size
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
id|d-&gt;prg_bus
(braket
l_int|0
)braket
op_amp
l_int|0xfffffff0
suffix:semicolon
)brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|address
op_assign
id|d-&gt;buf_bus
(braket
id|i
)braket
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|status
op_assign
id|d-&gt;buf_size
suffix:semicolon
)brace
id|d-&gt;buf_ind
op_assign
l_int|0
suffix:semicolon
id|d-&gt;buf_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Tell the controller where the first AR program is */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;cmdPtr
comma
id|d-&gt;prg_bus
(braket
l_int|0
)braket
op_or
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* Run AR context */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x00008000
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Receive DMA ctx=%d initialized&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the dma transmit context */
DECL|function|initialize_dma_trm_ctx
r_static
r_void
id|initialize_dma_trm_ctx
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
multiline_comment|/* Stop the context */
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
id|d-&gt;prg_ind
op_assign
l_int|0
suffix:semicolon
id|d-&gt;sent_ind
op_assign
l_int|0
suffix:semicolon
id|d-&gt;free_prgs
op_assign
id|d-&gt;num_desc
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;fifo_first
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;fifo_last
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;pending_first
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;pending_last
op_assign
l_int|NULL
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;AT dma ctx=%d initialized&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* Count the number of available iso contexts */
DECL|function|get_nb_iso_ctx
r_static
r_int
id|get_nb_iso_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|reg
)paren
(brace
r_int
id|i
comma
id|ctx
op_assign
l_int|0
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|reg
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|tmp
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|reg
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Iso contexts reg: %08x implemented: %08x&quot;
comma
id|reg
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Count the number of contexts */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tmp
op_amp
l_int|1
)paren
(brace
id|ctx
op_increment
suffix:semicolon
)brace
id|tmp
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ctx
suffix:semicolon
)brace
multiline_comment|/* Global initialization */
DECL|function|ohci_initialize
r_static
r_int
id|ohci_initialize
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
comma
id|i
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Tip by James Goodwin &lt;jamesg@Filanet.com&gt;:&n;&t; * We need to add delays after the soft reset, setting LPS, and&n;&t; * enabling our link. This might fixes the self-id reception &n;&t; * problem at initialization.&n;&t; */
multiline_comment|/* Soft reset */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|ohci_soft_reset
c_func
(paren
id|ohci
)paren
)paren
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
multiline_comment|/* &n;&t; * Delay after soft reset to make sure everything has settled&n;&t; * down (sanity)&n;&t; */
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* Set Link Power Status (LPS) */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00080000
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Delay after setting LPS in order to make sure link/phy&n;&t; * communication is established&n;&t; */
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* Set the bus number */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
comma
l_int|0x0000ffc0
)paren
suffix:semicolon
multiline_comment|/* Enable posted writes */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00040000
)paren
suffix:semicolon
multiline_comment|/* Clear link control register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Enable cycle timer and cycle master */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00300000
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt registers */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Set up self-id dma buffer */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_SelfIDBuffer
comma
id|ohci-&gt;selfid_buf_bus
)paren
suffix:semicolon
multiline_comment|/* enable self-id dma */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00000200
)paren
suffix:semicolon
multiline_comment|/* Set the configuration ROM mapping register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ConfigROMmap
comma
id|ohci-&gt;csr_config_rom_bus
)paren
suffix:semicolon
multiline_comment|/* Set bus options */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
comma
id|cpu_to_be32
c_func
(paren
id|ohci-&gt;csr_config_rom_cpu
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
macro_line|#if 0&t;
multiline_comment|/* Write the GUID into the csr config rom */
id|ohci-&gt;csr_config_rom_cpu
(braket
l_int|3
)braket
op_assign
id|be32_to_cpu
c_func
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDHi
)paren
)paren
suffix:semicolon
id|ohci-&gt;csr_config_rom_cpu
(braket
l_int|4
)braket
op_assign
id|be32_to_cpu
c_func
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDLo
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Write the config ROM header */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ConfigROMhdr
comma
id|cpu_to_be32
c_func
(paren
id|ohci-&gt;csr_config_rom_cpu
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|ohci-&gt;max_packet_size
op_assign
l_int|1
op_lshift
(paren
(paren
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;max packet size = %d bytes&quot;
comma
id|ohci-&gt;max_packet_size
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t accept phy packets into AR request context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0x00000400
)paren
suffix:semicolon
multiline_comment|/* Initialize IR dma */
id|ohci-&gt;nb_iso_rcv_ctx
op_assign
id|get_nb_iso_ctx
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;%d iso receive contexts available&quot;
comma
id|ohci-&gt;nb_iso_rcv_ctx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_rcv_ctx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextControlClear
op_plus
l_int|32
op_star
id|i
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextMatch
op_plus
l_int|32
op_star
id|i
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvCommandPtr
op_plus
l_int|32
op_star
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Set bufferFill, isochHeader, multichannel for IR context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextControlSet
comma
l_int|0xd0000000
)paren
suffix:semicolon
multiline_comment|/* Set the context match register to match on all tags */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextMatch
comma
l_int|0xf0000000
)paren
suffix:semicolon
multiline_comment|/* Clear the interrupt mask */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Initialize IT dma */
id|ohci-&gt;nb_iso_xmit_ctx
op_assign
id|get_nb_iso_ctx
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskSet
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;%d iso transmit contexts available&quot;
comma
id|ohci-&gt;nb_iso_xmit_ctx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitContextControlClear
op_plus
l_int|32
op_star
id|i
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitCommandPtr
op_plus
l_int|32
op_star
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear the interrupt mask */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Clear the multi channel mask high and low registers */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Initialize AR dma */
id|initialize_dma_rcv_ctx
c_func
(paren
id|ohci-&gt;ar_req_context
)paren
suffix:semicolon
id|initialize_dma_rcv_ctx
c_func
(paren
id|ohci-&gt;ar_resp_context
)paren
suffix:semicolon
multiline_comment|/* Initialize AT dma */
id|initialize_dma_trm_ctx
c_func
(paren
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|initialize_dma_trm_ctx
c_func
(paren
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
multiline_comment|/* Initialize IR dma */
id|initialize_dma_rcv_ctx
c_func
(paren
id|ohci-&gt;ir_context
)paren
suffix:semicolon
multiline_comment|/* Set up isoRecvIntMask to generate interrupts for context 0&n;&t;   (thanks to Michael Greger for seeing that I forgot this) */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
comma
l_int|0x00000001
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Accept AT requests from all nodes. This probably &n;&t; * will have to be controlled from the subsystem&n;&t; * on a per node basis.&n;&t; */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqFilterHiSet
comma
l_int|0x80000000
)paren
suffix:semicolon
multiline_comment|/* Specify AT retries */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ATRetries
comma
id|OHCI1394_MAX_AT_REQ_RETRIES
op_or
(paren
id|OHCI1394_MAX_AT_RESP_RETRIES
op_lshift
l_int|4
)paren
op_or
(paren
id|OHCI1394_MAX_PHYS_RESP_RETRIES
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
macro_line|#ifndef __BIG_ENDIAN
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlClear
comma
l_int|0x40000000
)paren
suffix:semicolon
macro_line|#else
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x40000000
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Enable interrupts */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskSet
comma
id|OHCI1394_masterIntEnable
op_or
id|OHCI1394_phyRegRcvd
op_or
id|OHCI1394_busReset
op_or
id|OHCI1394_selfIDComplete
op_or
id|OHCI1394_RSPkt
op_or
id|OHCI1394_RQPkt
op_or
id|OHCI1394_ARRS
op_or
id|OHCI1394_ARRQ
op_or
id|OHCI1394_respTxComplete
op_or
id|OHCI1394_reqTxComplete
op_or
id|OHCI1394_isochRx
op_or
id|OHCI1394_isochTx
)paren
suffix:semicolon
multiline_comment|/* Enable link */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00020000
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ohci_remove
r_static
r_void
id|ohci_remove
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_if
c_cond
(paren
id|host
op_ne
l_int|NULL
)paren
(brace
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|remove_card
c_func
(paren
id|ohci
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * Insert a packet in the AT DMA fifo and generate the DMA prg&n; * FIXME: rewrite the program in order to accept packets crossing&n; *        page boundaries.&n; *        check also that a single dma descriptor doesn&squot;t cross a &n; *        page boundary.&n; */
DECL|function|insert_packet
r_static
r_void
id|insert_packet
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_trm_ctx
op_star
id|d
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
id|u32
id|cycleTimer
suffix:semicolon
r_int
id|idx
op_assign
id|d-&gt;prg_ind
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.address
op_assign
l_int|0
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.branchAddress
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;ctx
op_eq
l_int|1
)paren
(brace
multiline_comment|/* &n;&t;&t; * For response packets, we need to put a timeout value in&n;&t;&t; * the 16 lower bits of the status... let&squot;s try 1 sec timeout &n;&t;&t; */
id|cycleTimer
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
op_assign
(paren
(paren
(paren
(paren
(paren
id|cycleTimer
op_rshift
l_int|25
)paren
op_amp
l_int|0x7
)paren
op_plus
l_int|1
)paren
op_amp
l_int|0x7
)paren
op_lshift
l_int|13
)paren
op_or
(paren
(paren
id|cycleTimer
op_amp
l_int|0x01fff000
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;cycleTimer: %08x timeStamp: %08x&quot;
comma
id|cycleTimer
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
)paren
suffix:semicolon
)brace
r_else
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|raw
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_assign
id|OHCI1394_TCODE_PHY
op_lshift
l_int|4
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_assign
id|packet-&gt;header
(braket
l_int|0
)braket
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|2
)braket
op_assign
id|packet-&gt;header
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_assign
id|packet-&gt;speed_code
op_lshift
l_int|16
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|packet-&gt;header
(braket
l_int|1
)braket
op_amp
l_int|0xFFFF
)paren
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF0000
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|2
)braket
op_assign
id|packet-&gt;header
(braket
l_int|2
)braket
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
op_assign
id|packet-&gt;header
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|packet-&gt;data_size
)paren
(brace
multiline_comment|/* block transmit */
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|OUTPUT_MORE_IMMEDIATE
op_or
l_int|0x10
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.control
op_assign
id|OUTPUT_LAST
op_or
id|packet-&gt;data_size
suffix:semicolon
multiline_comment|/* &n;&t;&t; * FIXME: check that the packet data buffer&n;&t;&t; * do not cross a page boundary &n;&t;&t; */
r_if
c_cond
(paren
id|cross_bound
c_func
(paren
(paren
r_int
r_int
)paren
id|packet-&gt;data
comma
id|packet-&gt;data_size
)paren
OG
l_int|0
)paren
(brace
multiline_comment|/* FIXME: do something about it */
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: packet data addr: %p size %d bytes &quot;
l_string|&quot;cross page boundary&quot;
comma
id|packet-&gt;data
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
)brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.address
op_assign
id|pci_map_single
c_func
(paren
id|ohci-&gt;dev
comma
id|packet-&gt;data
comma
id|packet-&gt;data_size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
op_assign
l_int|0
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;branchAddrPtr
)paren
op_star
(paren
id|d-&gt;branchAddrPtr
)paren
op_assign
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
l_int|0x3
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* quadlet transmit */
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|raw
)paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|OUTPUT_LAST_IMMEDIATE
op_or
(paren
id|packet-&gt;header_size
op_plus
l_int|4
)paren
suffix:semicolon
r_else
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|OUTPUT_LAST_IMMEDIATE
op_or
id|packet-&gt;header_size
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;branchAddrPtr
)paren
op_star
(paren
id|d-&gt;branchAddrPtr
)paren
op_assign
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
l_int|0x2
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.branchAddress
)paren
suffix:semicolon
)brace
id|d-&gt;free_prgs
op_decrement
suffix:semicolon
multiline_comment|/* queue the packet in the appropriate context queue */
r_if
c_cond
(paren
id|d-&gt;fifo_last
)paren
(brace
id|d-&gt;fifo_last-&gt;xnext
op_assign
id|packet
suffix:semicolon
id|d-&gt;fifo_last
op_assign
id|packet
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;fifo_first
op_assign
id|packet
suffix:semicolon
id|d-&gt;fifo_last
op_assign
id|packet
suffix:semicolon
)brace
id|d-&gt;prg_ind
op_assign
(paren
id|d-&gt;prg_ind
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
)brace
multiline_comment|/*&n; * This function fills the AT FIFO with the (eventual) pending packets&n; * and runs or wake up the AT DMA prg if necessary.&n; * The function MUST be called with the d-&gt;lock held.&n; */
DECL|function|dma_trm_flush
r_static
r_int
id|dma_trm_flush
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_int
id|idx
comma
id|z
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;pending_first
op_eq
l_int|NULL
op_logical_or
id|d-&gt;free_prgs
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|idx
op_assign
id|d-&gt;prg_ind
suffix:semicolon
id|z
op_assign
(paren
id|d-&gt;pending_first-&gt;data_size
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* insert the packets into the at dma fifo */
r_while
c_loop
(paren
id|d-&gt;free_prgs
OG
l_int|0
op_logical_and
id|d-&gt;pending_first
)paren
(brace
id|insert_packet
c_func
(paren
id|ohci
comma
id|d
comma
id|d-&gt;pending_first
)paren
suffix:semicolon
id|d-&gt;pending_first
op_assign
id|d-&gt;pending_first-&gt;xnext
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;pending_first
op_eq
l_int|NULL
)paren
id|d-&gt;pending_last
op_assign
l_int|NULL
suffix:semicolon
r_else
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;AT DMA FIFO ctx=%d full... waiting&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
multiline_comment|/* Is the context running ? (should be unless it is &n;&t;   the first packet to be sent in this context) */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x8000
)paren
)paren
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Starting AT DMA ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;cmdPtr
comma
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
id|z
)paren
suffix:semicolon
id|run_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Waking AT DMA ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
multiline_comment|/* wake up the dma context if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x400
)paren
)paren
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmission of an async packet&n; */
DECL|function|ohci_transmit
r_static
r_int
id|ohci_transmit
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|dma_trm_ctx
op_star
id|d
suffix:semicolon
r_int
r_char
id|tcode
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
OG
id|ohci-&gt;max_packet_size
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;transmit packet size = %d too big&quot;
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|packet-&gt;xnext
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Decide wether we have a request or a response packet */
id|tcode
op_assign
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|tcode
op_amp
l_int|0x02
)paren
id|d
op_assign
id|ohci-&gt;at_resp_context
suffix:semicolon
r_else
id|d
op_assign
id|ohci-&gt;at_req_context
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* queue the packet for later insertion into to dma fifo */
r_if
c_cond
(paren
id|d-&gt;pending_last
)paren
(brace
id|d-&gt;pending_last-&gt;xnext
op_assign
id|packet
suffix:semicolon
id|d-&gt;pending_last
op_assign
id|packet
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;pending_first
op_assign
id|packet
suffix:semicolon
id|d-&gt;pending_last
op_assign
id|packet
suffix:semicolon
)brace
id|dma_trm_flush
c_func
(paren
id|ohci
comma
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ohci_devctl
r_static
r_int
id|ohci_devctl
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_enum
id|devctl_cmd
id|cmd
comma
r_int
id|arg
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RESET_BUS
suffix:colon
multiline_comment|/*&n;&t;&t; * FIXME: this flag might be necessary in some case&n;&t;&t; */
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;resetting bus on request%s&quot;
comma
(paren
(paren
id|host-&gt;attempt_root
op_logical_or
id|attempt_root
)paren
ques
c_cond
l_string|&quot; and attempting to become root&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
(paren
id|host-&gt;attempt_root
op_logical_or
id|attempt_root
)paren
ques
c_cond
l_int|0x000041ff
suffix:colon
l_int|0x0000417f
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GET_CYCLE_COUNTER
suffix:colon
id|retval
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_CYCLE_COUNTER
suffix:colon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_BUS_ID
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;devctl command SET_BUS_ID err&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT_CYCLE_MASTER
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
multiline_comment|/* check if we are root and other nodes are present */
id|u32
id|nodeId
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nodeId
op_amp
(paren
l_int|1
op_lshift
l_int|30
)paren
)paren
op_logical_and
(paren
id|nodeId
op_amp
l_int|0x3f
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * enable cycleTimer, cycleMaster&n;&t;&t;&t;&t; */
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Cycle master enabled&quot;
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00300000
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* disable cycleTimer, cycleMaster, cycleSource */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0x00700000
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CANCEL_REQUESTS
suffix:colon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Cancel request received&quot;
)paren
suffix:semicolon
id|dma_trm_reset
c_func
(paren
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|dma_trm_reset
c_func
(paren
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODIFY_USAGE
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISO_LISTEN_CHANNEL
suffix:colon
(brace
id|u64
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
l_int|63
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;IS0_LISTEN_CHANNEL channel %d out of range&quot;
comma
id|arg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|arg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;IS0_LISTEN_CHANNEL channel %d already used&quot;
comma
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ohci-&gt;ISO_channel_usage
op_or_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|31
)paren
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiSet
comma
l_int|1
op_lshift
(paren
id|arg
op_minus
l_int|32
)paren
)paren
suffix:semicolon
r_else
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoSet
comma
l_int|1
op_lshift
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;listening enabled on channel %d&quot;
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|ISO_UNLISTEN_CHANNEL
suffix:colon
(brace
id|u64
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
l_int|63
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;IS0_UNLISTEN_CHANNEL channel %d out of range&quot;
comma
id|arg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|arg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;IS0_UNLISTEN_CHANNEL channel %d not used&quot;
comma
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ohci-&gt;ISO_channel_usage
op_and_assign
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|31
)paren
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
l_int|1
op_lshift
(paren
id|arg
op_minus
l_int|32
)paren
)paren
suffix:semicolon
r_else
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
l_int|1
op_lshift
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;listening disabled on channel %d&quot;
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;ohci_devctl cmd %d not implemented yet&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/***************************************&n; * IEEE-1394 functionality section END *&n; ***************************************/
multiline_comment|/********************************************************&n; * Global stuff (interrupt handler, init/shutdown code) *&n; ********************************************************/
DECL|function|dma_trm_reset
r_static
r_void
id|dma_trm_reset
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|nextpacket
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;dma_trm_reset called with NULL arg&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* is there still any packet pending in the fifo ? */
r_while
c_loop
(paren
id|d-&gt;fifo_first
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;AT dma reset ctx=%d, aborting transmission&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|nextpacket
op_assign
id|d-&gt;fifo_first-&gt;xnext
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|ohci-&gt;host
comma
id|d-&gt;fifo_first
comma
id|ACKX_ABORTED
)paren
suffix:semicolon
id|d-&gt;fifo_first
op_assign
id|nextpacket
suffix:semicolon
)brace
id|d-&gt;fifo_first
op_assign
id|d-&gt;fifo_last
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* is there still any packet pending ? */
r_while
c_loop
(paren
id|d-&gt;pending_first
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;AT dma reset ctx=%d, aborting transmission&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|nextpacket
op_assign
id|d-&gt;pending_first-&gt;xnext
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|ohci-&gt;host
comma
id|d-&gt;pending_first
comma
id|ACKX_ABORTED
)paren
suffix:semicolon
id|d-&gt;pending_first
op_assign
id|nextpacket
suffix:semicolon
)brace
id|d-&gt;pending_first
op_assign
id|d-&gt;pending_last
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;sent_ind
op_assign
id|d-&gt;prg_ind
suffix:semicolon
id|d-&gt;free_prgs
op_assign
id|d-&gt;num_desc
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ohci_irq_handler
r_static
r_void
id|ohci_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs_are_unused
)paren
(brace
id|quadlet_t
id|event
comma
id|node_id
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|ohci-&gt;host
suffix:semicolon
r_int
id|phyid
op_assign
op_minus
l_int|1
comma
id|isroot
op_assign
l_int|0
suffix:semicolon
r_int
id|timeout
op_assign
l_int|255
suffix:semicolon
r_do
(brace
multiline_comment|/* read the interrupt event register */
id|event
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|event
)paren
r_return
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;IntEvent: %08x&quot;
comma
id|event
)paren
suffix:semicolon
multiline_comment|/* clear the interrupt event register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
id|event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_busReset
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;in_bus_reset
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Bus reset&quot;
)paren
suffix:semicolon
multiline_comment|/* Wait for the AT fifo to be flushed */
id|dma_trm_reset
c_func
(paren
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|dma_trm_reset
c_func
(paren
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
multiline_comment|/* Subsystem call */
id|hpsb_bus_reset
c_func
(paren
id|ohci-&gt;host
)paren
suffix:semicolon
id|ohci-&gt;NumBusResets
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * Problem: How can I ensure that the AT bottom half will be&n;&t;&t; * executed before the AR bottom half (both events may have&n;&t;&t; * occured within a single irq event)&n;&t;&t; * Quick hack: just launch it within the IRQ handler&n;&t;&t; */
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_reqTxComplete
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
id|ohci-&gt;at_req_context
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got reqTxComplete interrupt &quot;
l_string|&quot;status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;reqTxComplete&quot;
)paren
suffix:semicolon
r_else
id|dma_trm_bh
c_func
(paren
(paren
r_void
op_star
)paren
id|d
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_respTxComplete
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
id|ohci-&gt;at_resp_context
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got respTxComplete interrupt &quot;
l_string|&quot;status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;respTxComplete&quot;
)paren
suffix:semicolon
r_else
id|dma_trm_bh
c_func
(paren
(paren
r_void
op_star
)paren
id|d
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_RQPkt
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
id|ohci-&gt;ar_req_context
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got RQPkt interrupt status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;RQPkt&quot;
)paren
suffix:semicolon
r_else
(brace
macro_line|#if IEEE1394_USE_BOTTOM_HALVES
id|queue_task
c_func
(paren
op_amp
id|d-&gt;task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
macro_line|#else
id|dma_rcv_bh
c_func
(paren
(paren
r_void
op_star
)paren
id|d
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_RSPkt
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
id|ohci-&gt;ar_resp_context
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got RSPkt interrupt status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;RSPkt&quot;
)paren
suffix:semicolon
r_else
(brace
macro_line|#if IEEE1394_USE_BOTTOM_HALVES
id|queue_task
c_func
(paren
op_amp
id|d-&gt;task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
macro_line|#else
id|dma_rcv_bh
c_func
(paren
(paren
r_void
op_star
)paren
id|d
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_isochRx
)paren
(brace
id|quadlet_t
id|isoRecvIntEvent
suffix:semicolon
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
id|ohci-&gt;ir_context
suffix:semicolon
id|isoRecvIntEvent
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventSet
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventClear
comma
id|isoRecvIntEvent
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got isochRx interrupt &quot;
l_string|&quot;status=0x%08X isoRecvIntEvent=%08x&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
comma
id|isoRecvIntEvent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isoRecvIntEvent
op_amp
l_int|0x1
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;isochRx&quot;
)paren
suffix:semicolon
r_else
(brace
macro_line|#if IEEE1394_USE_BOTTOM_HALVES
id|queue_task
c_func
(paren
op_amp
id|d-&gt;task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
macro_line|#else
id|dma_rcv_bh
c_func
(paren
(paren
r_void
op_star
)paren
id|d
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|ohci-&gt;video_tmpl
)paren
id|ohci-&gt;video_tmpl
op_member_access_from_pointer
id|irq_handler
c_func
(paren
id|ohci-&gt;id
comma
id|isoRecvIntEvent
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_isochTx
)paren
(brace
id|quadlet_t
id|isoXmitIntEvent
suffix:semicolon
id|isoXmitIntEvent
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventSet
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventClear
comma
id|isoXmitIntEvent
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got isochTx interrupt&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;video_tmpl
)paren
id|ohci-&gt;video_tmpl
op_member_access_from_pointer
id|irq_handler
c_func
(paren
id|ohci-&gt;id
comma
l_int|0
comma
id|isoXmitIntEvent
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_selfIDComplete
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
multiline_comment|/* &n;&t;&t;&t;&t; * Begin Fix (JSG): Check to make sure our &n;&t;&t;&t;&t; * node id is valid &n;&t;&t;&t;&t; */
id|node_id
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|node_id
op_amp
l_int|0x80000000
)paren
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* phy is upset - &n;&t;&t;&t;&t;&t;&t;    * this happens once in &n;&t;&t;&t;&t;&t;&t;    * a while on hot-plugs...&n;&t;&t;&t;&t;&t;&t;    * give it a ms to recover &n;&t;&t;&t;&t;&t;&t;    */
)brace
multiline_comment|/* End Fix (JSG) */
id|node_id
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node_id
op_amp
l_int|0x80000000
)paren
(brace
multiline_comment|/* NodeID valid */
id|phyid
op_assign
id|node_id
op_amp
l_int|0x0000003f
suffix:semicolon
id|isroot
op_assign
(paren
id|node_id
op_amp
l_int|0x40000000
)paren
op_ne
l_int|0
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID process finished &quot;
l_string|&quot;(phyid %d, %s)&quot;
comma
id|phyid
comma
(paren
id|isroot
ques
c_cond
l_string|&quot;root&quot;
suffix:colon
l_string|&quot;not root&quot;
)paren
)paren
suffix:semicolon
id|handle_selfid
c_func
(paren
id|ohci
comma
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID process finished but &quot;
l_string|&quot;NodeID not valid: %08X&quot;
comma
id|node_id
)paren
suffix:semicolon
multiline_comment|/* Accept Physical requests from all nodes. */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqFilterHiSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqFilterLoSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Tip by James Goodwin &lt;jamesg@Filanet.com&gt;&n;&t;&t;&t;&t; * Turn on phys dma reception. We should&n;&t;&t;&t;&t; * probably manage the filtering somehow, &n;&t;&t;&t;&t; * instead of blindly turning it on.&n;&t;&t;&t;&t; */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterHiSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterLoSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyUpperBound
comma
l_int|0xffff0000
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;self-id received outside of bus reset&quot;
l_string|&quot;sequence&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_phyRegRcvd
)paren
(brace
macro_line|#if 1
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;PhyControl: %08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;phy reg received outside of bus reset&quot;
l_string|&quot;sequence&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_while
c_loop
(paren
op_decrement
id|timeout
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;irq_handler timeout event=0x%08x&quot;
comma
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* Put the buffer back into the dma context */
DECL|function|insert_dma_buffer
r_static
r_void
id|insert_dma_buffer
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_int
id|idx
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Inserting dma buf ctx=%d idx=%d&quot;
comma
id|d-&gt;ctx
comma
id|idx
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_assign
id|d-&gt;buf_size
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|branchAddress
op_and_assign
l_int|0xfffffff0
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
id|d-&gt;num_desc
op_minus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|branchAddress
op_or_assign
l_int|0x1
suffix:semicolon
multiline_comment|/* wake up the dma context if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x400
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Waking dma cxt=%d ... processing is probably too slow&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
)brace
DECL|function|block_length
r_static
r_int
id|block_length
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_int
id|idx
comma
id|quadlet_t
op_star
id|buf_ptr
comma
r_int
id|offset
)paren
(brace
r_int
id|length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Where is the data length ? */
r_if
c_cond
(paren
id|offset
op_plus
l_int|12
op_ge
id|d-&gt;buf_size
)paren
id|length
op_assign
(paren
id|d-&gt;buf_cpu
(braket
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
)braket
(braket
l_int|3
op_minus
(paren
id|d-&gt;buf_size
op_minus
id|offset
)paren
op_div
l_int|4
)braket
op_rshift
l_int|16
)paren
suffix:semicolon
r_else
id|length
op_assign
(paren
id|buf_ptr
(braket
l_int|3
)braket
op_rshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
op_mod
l_int|4
)paren
id|length
op_add_assign
l_int|4
op_minus
(paren
id|length
op_mod
l_int|4
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
DECL|variable|TCODE_SIZE
r_const
r_int
id|TCODE_SIZE
(braket
l_int|16
)braket
op_assign
(brace
l_int|20
comma
l_int|0
comma
l_int|16
comma
op_minus
l_int|1
comma
l_int|16
comma
l_int|20
comma
l_int|20
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|16
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* &n; * Determine the length of a packet in the buffer&n; * Optimization suggested by Pascal Drolet &lt;pascal.drolet@informission.ca&gt;&n; */
DECL|function|packet_length
r_static
r_int
id|packet_length
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_int
id|idx
comma
id|quadlet_t
op_star
id|buf_ptr
comma
r_int
id|offset
)paren
(brace
r_int
r_char
id|tcode
suffix:semicolon
r_int
id|length
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Let&squot;s see what kind of packet is in there */
id|tcode
op_assign
(paren
id|buf_ptr
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;ctx
OL
l_int|2
)paren
(brace
multiline_comment|/* Async Receive Response/Request */
id|length
op_assign
id|TCODE_SIZE
(braket
id|tcode
)braket
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
id|length
op_assign
id|block_length
c_func
(paren
id|d
comma
id|idx
comma
id|buf_ptr
comma
id|offset
)paren
op_plus
l_int|20
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|d-&gt;ctx
op_eq
l_int|2
)paren
(brace
multiline_comment|/* Iso receive */
multiline_comment|/* Assumption: buffer fill mode with header/trailer */
id|length
op_assign
(paren
id|buf_ptr
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
op_mod
l_int|4
)paren
id|length
op_add_assign
l_int|4
op_minus
(paren
id|length
op_mod
l_int|4
)paren
suffix:semicolon
id|length
op_add_assign
l_int|8
suffix:semicolon
)brace
r_return
id|length
suffix:semicolon
)brace
multiline_comment|/* Bottom half that processes dma receive buffers */
DECL|function|dma_rcv_bh
r_static
r_void
id|dma_rcv_bh
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
(paren
r_struct
id|dma_rcv_ctx
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
r_int
r_int
id|split_left
comma
id|idx
comma
id|offset
comma
id|rescount
suffix:semicolon
r_int
r_char
id|tcode
suffix:semicolon
r_int
id|length
comma
id|bytes_left
comma
id|ack
suffix:semicolon
id|quadlet_t
op_star
id|buf_ptr
suffix:semicolon
r_char
op_star
id|split_ptr
suffix:semicolon
r_char
id|msg
(braket
l_int|256
)braket
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
id|idx
op_assign
id|d-&gt;buf_ind
suffix:semicolon
id|offset
op_assign
id|d-&gt;buf_offset
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
op_plus
id|offset
op_div
l_int|4
suffix:semicolon
id|rescount
op_assign
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_amp
l_int|0xffff
suffix:semicolon
id|bytes_left
op_assign
id|d-&gt;buf_size
op_minus
id|rescount
op_minus
id|offset
suffix:semicolon
r_while
c_loop
(paren
id|bytes_left
OG
l_int|0
)paren
(brace
id|tcode
op_assign
(paren
id|buf_ptr
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
id|length
op_assign
id|packet_length
c_func
(paren
id|d
comma
id|idx
comma
id|buf_ptr
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|4
)paren
(brace
multiline_comment|/* something is wrong */
id|sprintf
c_func
(paren
id|msg
comma
l_string|&quot;unexpected tcode 0x%X in AR ctx=%d&quot;
comma
id|tcode
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
id|msg
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|offset
op_plus
id|length
)paren
OG
id|d-&gt;buf_size
)paren
(brace
multiline_comment|/* Split packet */
r_if
c_cond
(paren
id|length
OG
id|d-&gt;split_buf_size
)paren
(brace
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;split packet size exceeded&quot;
)paren
suffix:semicolon
id|d-&gt;buf_ind
op_assign
id|idx
suffix:semicolon
id|d-&gt;buf_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;prg_cpu
(braket
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
)braket
op_member_access_from_pointer
id|status
op_eq
id|d-&gt;buf_size
)paren
(brace
multiline_comment|/* other part of packet not written yet */
multiline_comment|/* this should never happen I think */
multiline_comment|/* anyway we&squot;ll get it on the next call */
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Got only half a packet !!!&quot;
)paren
suffix:semicolon
id|d-&gt;buf_ind
op_assign
id|idx
suffix:semicolon
id|d-&gt;buf_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|split_left
op_assign
id|length
suffix:semicolon
id|split_ptr
op_assign
(paren
r_char
op_star
)paren
id|d-&gt;spb
suffix:semicolon
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|d-&gt;buf_size
op_minus
id|offset
)paren
suffix:semicolon
id|split_left
op_sub_assign
id|d-&gt;buf_size
op_minus
id|offset
suffix:semicolon
id|split_ptr
op_add_assign
id|d-&gt;buf_size
op_minus
id|offset
suffix:semicolon
id|insert_dma_buffer
c_func
(paren
id|d
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|split_left
op_ge
id|d-&gt;buf_size
)paren
(brace
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|d-&gt;buf_size
)paren
suffix:semicolon
id|split_ptr
op_add_assign
id|d-&gt;buf_size
suffix:semicolon
id|split_left
op_sub_assign
id|d-&gt;buf_size
suffix:semicolon
id|insert_dma_buffer
c_func
(paren
id|d
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|split_left
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|split_left
)paren
suffix:semicolon
id|offset
op_assign
id|split_left
suffix:semicolon
id|buf_ptr
op_add_assign
id|offset
op_div
l_int|4
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t;&t; * We get one phy packet for each bus reset. &n;&t;&t;&t; * we know that from now on the bus topology may&n;&t;&t;&t; * have changed. Just ignore it for the moment&n;&t;&t;&t; */
r_if
c_cond
(paren
id|tcode
op_ne
l_int|0xE
)paren
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Split packet received from&quot;
l_string|&quot; node %d ack=0x%02X spd=%d tcode=0x%X&quot;
l_string|&quot; length=%d data=0x%08x ctx=%d&quot;
comma
(paren
id|d-&gt;spb
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
comma
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
op_rshift
l_int|21
)paren
op_amp
l_int|0x3
comma
id|tcode
comma
id|length
comma
id|d-&gt;spb
(braket
l_int|3
)braket
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|ack
op_assign
(paren
(paren
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
)paren
op_eq
l_int|0x11
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|hpsb_packet_received
c_func
(paren
id|ohci-&gt;host
comma
id|d-&gt;spb
comma
id|length
comma
id|ack
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Got phy packet ctx=%d ... discarded&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* &n;&t;&t;&t; * We get one phy packet for each bus reset. &n;&t;&t;&t; * we know that from now on the bus topology may&n;&t;&t;&t; * have changed. Just ignore it for the moment&n;&t;&t;&t; */
r_if
c_cond
(paren
id|tcode
op_ne
l_int|0xE
)paren
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Packet received from node&quot;
l_string|&quot; %d ack=0x%02X spd=%d tcode=0x%X&quot;
l_string|&quot; length=%d data=0x%08x ctx=%d&quot;
comma
(paren
id|buf_ptr
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|buf_ptr
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
comma
(paren
id|buf_ptr
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
op_rshift
l_int|21
)paren
op_amp
l_int|0x3
comma
id|tcode
comma
id|length
comma
id|buf_ptr
(braket
l_int|3
)braket
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|ack
op_assign
(paren
(paren
(paren
id|buf_ptr
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
)paren
op_eq
l_int|0x11
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|hpsb_packet_received
c_func
(paren
id|ohci-&gt;host
comma
id|buf_ptr
comma
id|length
comma
id|ack
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Got phy packet ctx=%d ... discarded&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|offset
op_add_assign
id|length
suffix:semicolon
id|buf_ptr
op_add_assign
id|length
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
id|d-&gt;buf_size
)paren
(brace
id|insert_dma_buffer
c_func
(paren
id|d
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|rescount
op_assign
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_amp
l_int|0xffff
suffix:semicolon
id|bytes_left
op_assign
id|d-&gt;buf_size
op_minus
id|rescount
op_minus
id|offset
suffix:semicolon
)brace
id|d-&gt;buf_ind
op_assign
id|idx
suffix:semicolon
id|d-&gt;buf_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Bottom half that processes sent packets */
DECL|function|dma_trm_bh
r_static
r_void
id|dma_trm_bh
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
(paren
r_struct
id|dma_trm_ctx
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
comma
op_star
id|nextpacket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|ack
suffix:semicolon
r_int
id|datasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;fifo_first
op_eq
l_int|NULL
)paren
(brace
macro_line|#if 0
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;Packet sent ack received but queue is empty&quot;
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|d-&gt;fifo_first
)paren
(brace
id|packet
op_assign
id|d-&gt;fifo_first
suffix:semicolon
id|datasize
op_assign
id|d-&gt;fifo_first-&gt;data_size
suffix:semicolon
r_if
c_cond
(paren
id|datasize
)paren
id|ack
op_assign
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|end.status
op_rshift
l_int|16
suffix:semicolon
r_else
id|ack
op_assign
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|begin.status
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|ack
op_eq
l_int|0
)paren
multiline_comment|/* this packet hasn&squot;t been sent yet*/
r_break
suffix:semicolon
macro_line|#ifdef OHCI1394_DEBUG
r_if
c_cond
(paren
id|datasize
)paren
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Packet sent to node %d tcode=0x%X tLabel=&quot;
l_string|&quot;0x%02X ack=0x%X spd=%d dataLength=%d ctx=%d&quot;
comma
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
comma
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
comma
id|ack
op_amp
l_int|0x1f
comma
(paren
id|ack
op_rshift
l_int|5
)paren
op_amp
l_int|0x3
comma
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
op_rshift
l_int|16
comma
id|d-&gt;ctx
)paren
suffix:semicolon
r_else
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Packet sent to node %d tcode=0x%X tLabel=&quot;
l_string|&quot;0x%02X ack=0x%X spd=%d data=0x%08X ctx=%d&quot;
comma
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
comma
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
comma
id|ack
op_amp
l_int|0x1f
comma
(paren
id|ack
op_rshift
l_int|5
)paren
op_amp
l_int|0x3
comma
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
comma
id|d-&gt;ctx
)paren
suffix:semicolon
macro_line|#endif&t;&t;
id|nextpacket
op_assign
id|packet-&gt;xnext
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|ohci-&gt;host
comma
id|packet
comma
id|ack
op_amp
l_int|0xf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datasize
)paren
id|pci_unmap_single
c_func
(paren
id|ohci-&gt;dev
comma
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|end.address
comma
id|datasize
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|d-&gt;sent_ind
op_assign
(paren
id|d-&gt;sent_ind
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|d-&gt;free_prgs
op_increment
suffix:semicolon
id|d-&gt;fifo_first
op_assign
id|nextpacket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;fifo_first
op_eq
l_int|NULL
)paren
id|d-&gt;fifo_last
op_assign
l_int|NULL
suffix:semicolon
id|dma_trm_flush
c_func
(paren
id|ohci
comma
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|free_dma_rcv_ctx
r_static
r_int
id|free_dma_rcv_ctx
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_if
c_cond
(paren
op_star
id|d
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ohci
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Freeing dma_rcv_ctx %d&quot;
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctx
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_cpu
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_cpu
(braket
id|i
)braket
op_logical_and
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_bus
(braket
id|i
)braket
)paren
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_size
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_cpu
(braket
id|i
)braket
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_cpu
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_bus
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
(braket
id|i
)braket
op_logical_and
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
(braket
id|i
)braket
)paren
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
(braket
id|i
)braket
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|spb
)paren
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|spb
)paren
suffix:semicolon
id|kfree
c_func
(paren
op_star
id|d
)paren
suffix:semicolon
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|dma_rcv_ctx
op_star
DECL|function|alloc_dma_rcv_ctx
id|alloc_dma_rcv_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|ctx
comma
r_int
id|num_desc
comma
r_int
id|buf_size
comma
r_int
id|split_buf_size
comma
r_int
id|ctrlSet
comma
r_int
id|ctrlClear
comma
r_int
id|cmdPtr
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|d
op_assign
(paren
r_struct
id|dma_rcv_ctx
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dma_rcv_ctx
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma_rcv_ctx&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|d-&gt;ohci
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
id|d-&gt;ctx
op_assign
id|ctx
suffix:semicolon
id|d-&gt;num_desc
op_assign
id|num_desc
suffix:semicolon
id|d-&gt;buf_size
op_assign
id|buf_size
suffix:semicolon
id|d-&gt;split_buf_size
op_assign
id|split_buf_size
suffix:semicolon
id|d-&gt;ctrlSet
op_assign
id|ctrlSet
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|ctrlClear
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|cmdPtr
suffix:semicolon
id|d-&gt;buf_cpu
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;buf_bus
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;prg_bus
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;spb
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;buf_cpu
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|quadlet_t
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|d-&gt;buf_bus
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buf_cpu
op_eq
l_int|NULL
op_logical_or
id|d-&gt;buf_bus
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma buffer&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;buf_cpu
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|quadlet_t
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d-&gt;buf_bus
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|d-&gt;prg_bus
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
op_eq
l_int|NULL
op_logical_or
id|d-&gt;prg_bus
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma prg&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d-&gt;prg_bus
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|d-&gt;spb
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;split_buf_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;spb
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate split buffer&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;buf_cpu
(braket
id|i
)braket
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|d-&gt;buf_size
comma
id|d-&gt;buf_bus
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buf_cpu
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|d-&gt;buf_cpu
(braket
id|i
)braket
comma
l_int|0
comma
id|d-&gt;buf_size
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma buffer&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
comma
id|d-&gt;prg_bus
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma prg&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* initialize bottom handler */
id|d-&gt;task.sync
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|d-&gt;task.list
)paren
suffix:semicolon
id|d-&gt;task.routine
op_assign
id|dma_rcv_bh
suffix:semicolon
id|d-&gt;task.data
op_assign
(paren
r_void
op_star
)paren
id|d
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|free_dma_trm_ctx
r_static
r_int
id|free_dma_trm_ctx
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
op_star
id|d
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_star
id|d
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ohci
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Freeing dma_trm_ctx %d&quot;
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctx
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
(braket
id|i
)braket
op_logical_and
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
(braket
id|i
)braket
)paren
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|at_dma_prg
)paren
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
(braket
id|i
)braket
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
op_star
id|d
)paren
suffix:semicolon
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|dma_trm_ctx
op_star
DECL|function|alloc_dma_trm_ctx
id|alloc_dma_trm_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|ctx
comma
r_int
id|num_desc
comma
r_int
id|ctrlSet
comma
r_int
id|ctrlClear
comma
r_int
id|cmdPtr
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|d
op_assign
(paren
r_struct
id|dma_trm_ctx
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dma_trm_ctx
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate dma_trm_ctx&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|d-&gt;ohci
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
id|d-&gt;ctx
op_assign
id|ctx
suffix:semicolon
id|d-&gt;num_desc
op_assign
id|num_desc
suffix:semicolon
id|d-&gt;ctrlSet
op_assign
id|ctrlSet
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|ctrlClear
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|cmdPtr
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;prg_bus
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|at_dma_prg
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|d-&gt;prg_bus
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
op_eq
l_int|NULL
op_logical_or
id|d-&gt;prg_bus
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate at dma prg&quot;
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|at_dma_prg
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d-&gt;prg_bus
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|at_dma_prg
)paren
comma
id|d-&gt;prg_bus
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|at_dma_prg
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;failed to allocate at dma prg&quot;
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* initialize bottom handler */
id|d-&gt;task.routine
op_assign
id|dma_trm_bh
suffix:semicolon
id|d-&gt;task.data
op_assign
(paren
r_void
op_star
)paren
id|d
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|ohci_crc16
r_static
id|u32
id|ohci_crc16
c_func
(paren
r_int
op_star
id|data
comma
r_int
id|length
)paren
(brace
r_int
id|check
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_int
id|shift
comma
id|sum
comma
id|next
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|length
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_for
c_loop
(paren
id|next
op_assign
id|check
comma
id|shift
op_assign
l_int|28
suffix:semicolon
id|shift
op_ge
l_int|0
suffix:semicolon
id|shift
op_sub_assign
l_int|4
)paren
(brace
id|sum
op_assign
(paren
(paren
id|next
op_rshift
l_int|12
)paren
op_xor
(paren
op_star
id|data
op_rshift
id|shift
)paren
)paren
op_amp
l_int|0xf
suffix:semicolon
id|next
op_assign
(paren
id|next
op_lshift
l_int|4
)paren
op_xor
(paren
id|sum
op_lshift
l_int|12
)paren
op_xor
(paren
id|sum
op_lshift
l_int|5
)paren
op_xor
(paren
id|sum
)paren
suffix:semicolon
)brace
id|check
op_assign
id|next
op_amp
l_int|0xffff
suffix:semicolon
id|data
op_increment
suffix:semicolon
)brace
r_return
id|check
suffix:semicolon
)brace
DECL|function|ohci_init_config_rom
r_static
r_void
id|ohci_init_config_rom
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_int
id|i
suffix:semicolon
id|ohci_csr_rom
(braket
l_int|3
)braket
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDHi
)paren
suffix:semicolon
id|ohci_csr_rom
(braket
l_int|4
)braket
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDLo
)paren
suffix:semicolon
id|ohci_csr_rom
(braket
l_int|0
)braket
op_assign
l_int|0x04040000
op_or
id|ohci_crc16
c_func
(paren
id|ohci_csr_rom
op_plus
l_int|1
comma
l_int|4
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|ohci_csr_rom
)paren
op_div
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|ohci-&gt;csr_config_rom_cpu
(braket
id|i
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|ohci_csr_rom
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
DECL|function|add_card
r_static
r_int
id|add_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
multiline_comment|/* shortcut to currently handled device */
r_if
c_cond
(paren
id|num_of_cards
op_eq
id|MAX_OHCI1394_CARDS
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;cannot handle more than %d cards.  &quot;
l_string|&quot;Adjust MAX_OHCI1394_CARDS in ti_ohci1394.h.&quot;
comma
id|MAX_OHCI1394_CARDS
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_NOTICE
comma
l_string|&quot;failed to enable OHCI hardware %d&quot;
comma
id|num_of_cards
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ohci
op_assign
op_amp
id|cards
(braket
id|num_of_cards
op_increment
)braket
suffix:semicolon
id|ohci-&gt;id
op_assign
id|num_of_cards
op_minus
l_int|1
suffix:semicolon
id|ohci-&gt;dev
op_assign
id|dev
suffix:semicolon
id|ohci-&gt;state
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* csr_config rom allocation */
id|ohci-&gt;csr_config_rom_cpu
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
id|ohci_csr_rom
)paren
comma
op_amp
id|ohci-&gt;csr_config_rom_bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;csr_config_rom_cpu
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate buffer config rom&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * self-id dma buffer allocation&n;&t; * FIXME: some early chips may need 8KB alignment for the &n;&t; * selfid buffer... if you have problems a temporary fic&n;&t; * is to allocate 8192 bytes instead of 2048&n;&t; */
id|ohci-&gt;selfid_buf_cpu
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
l_int|8192
comma
op_amp
id|ohci-&gt;selfid_buf_bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;selfid_buf_cpu
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate DMA buffer for self-id packets&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|ohci-&gt;selfid_buf_cpu
op_amp
l_int|0x1fff
)paren
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Selfid buffer %p not aligned on &quot;
l_string|&quot;8Kb boundary... may cause pb on some CXD3222 chip&quot;
comma
id|ohci-&gt;selfid_buf_cpu
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,13)
id|ohci-&gt;registers
op_assign
id|ioremap_nocache
c_func
(paren
id|dev-&gt;base_address
(braket
l_int|0
)braket
comma
id|OHCI1394_REGISTER_SIZE
)paren
suffix:semicolon
macro_line|#else
id|ohci-&gt;registers
op_assign
id|ioremap_nocache
c_func
(paren
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|OHCI1394_REGISTER_SIZE
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ohci-&gt;registers
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to remap registers - card not accessible&quot;
)paren
suffix:semicolon
)brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;remapped memory spaces reg 0x%p&quot;
comma
id|ohci-&gt;registers
)paren
suffix:semicolon
id|ohci-&gt;ar_req_context
op_assign
id|alloc_dma_rcv_ctx
c_func
(paren
id|ohci
comma
l_int|0
comma
id|AR_REQ_NUM_DESC
comma
id|AR_REQ_BUF_SIZE
comma
id|AR_REQ_SPLIT_BUF_SIZE
comma
id|OHCI1394_AsReqRcvContextControlSet
comma
id|OHCI1394_AsReqRcvContextControlClear
comma
id|OHCI1394_AsReqRcvCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ar_req_context
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AR Req context&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;ar_resp_context
op_assign
id|alloc_dma_rcv_ctx
c_func
(paren
id|ohci
comma
l_int|1
comma
id|AR_RESP_NUM_DESC
comma
id|AR_RESP_BUF_SIZE
comma
id|AR_RESP_SPLIT_BUF_SIZE
comma
id|OHCI1394_AsRspRcvContextControlSet
comma
id|OHCI1394_AsRspRcvContextControlClear
comma
id|OHCI1394_AsRspRcvCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ar_resp_context
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AR Resp context&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;at_req_context
op_assign
id|alloc_dma_trm_ctx
c_func
(paren
id|ohci
comma
l_int|0
comma
id|AT_REQ_NUM_DESC
comma
id|OHCI1394_AsReqTrContextControlSet
comma
id|OHCI1394_AsReqTrContextControlClear
comma
id|OHCI1394_AsReqTrCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;at_req_context
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AT Req context&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;at_resp_context
op_assign
id|alloc_dma_trm_ctx
c_func
(paren
id|ohci
comma
l_int|1
comma
id|AT_RESP_NUM_DESC
comma
id|OHCI1394_AsRspTrContextControlSet
comma
id|OHCI1394_AsRspTrContextControlClear
comma
id|OHCI1394_AsRspTrCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;at_resp_context
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AT Resp context&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;ir_context
op_assign
id|alloc_dma_rcv_ctx
c_func
(paren
id|ohci
comma
l_int|2
comma
id|IR_NUM_DESC
comma
id|IR_BUF_SIZE
comma
id|IR_SPLIT_BUF_SIZE
comma
id|OHCI1394_IsoRcvContextControlSet
comma
id|OHCI1394_IsoRcvContextControlClear
comma
id|OHCI1394_IsoRcvCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ir_context
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate IR context&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;ISO_channel_usage
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ohci_irq_handler
comma
id|SA_SHIRQ
comma
id|OHCI1394_DRIVER_NAME
comma
id|ohci
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;allocated interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate shared interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
id|ohci_init_config_rom
c_func
(paren
id|ohci
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;The 1st byte at offset 0x404 is: 0x%02x&quot;
comma
op_star
(paren
(paren
r_char
op_star
)paren
id|ohci-&gt;csr_config_rom_cpu
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
DECL|macro|FAIL
macro_line|#undef FAIL
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|macro|SR
mdefine_line|#define SR(fmt, reg0, reg1, reg2)&bslash;&n;p += sprintf(p,fmt,reg_read(ohci, reg0),&bslash;&n;&t;       reg_read(ohci, reg1),reg_read(ohci, reg2));
DECL|function|ohci_get_status
r_static
r_int
id|ohci_get_status
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
op_amp
id|cards
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|ohci-&gt;host
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
singleline_comment|//unsigned char phyreg;
singleline_comment|//int i, nports;
r_int
id|i
suffix:semicolon
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dma_trm_ctx
op_star
id|dt
op_assign
l_int|NULL
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;IEEE-1394 OHCI Driver status report:&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;  bus number: 0x%x Node ID: 0x%x&bslash;n&quot;
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
op_amp
l_int|0xFFC0
)paren
op_rshift
l_int|6
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
op_amp
l_int|0x3f
)paren
suffix:semicolon
macro_line|#if 0
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;  hardware version %d.%d GUID_ROM is %s&bslash;n&bslash;n&quot;
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_Version
)paren
op_amp
l_int|0xFF0000
)paren
op_rshift
l_int|16
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_Version
)paren
op_amp
l_int|0xFF
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_Version
)paren
op_amp
l_int|0x01000000
)paren
ques
c_cond
l_string|&quot;set&quot;
suffix:colon
l_string|&quot;clear&quot;
)paren
suffix:semicolon
macro_line|#endif
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n### Host data ###&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;node_count: %8d  &quot;
comma
id|host-&gt;node_count
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;node_id   : %08X&bslash;n&quot;
comma
id|host-&gt;node_id
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;irm_id    : %08X  &quot;
comma
id|host-&gt;irm_id
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;busmgr_id : %08X&bslash;n&quot;
comma
id|host-&gt;busmgr_id
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%s %s %s&bslash;n&quot;
comma
id|host-&gt;initialized
ques
c_cond
l_string|&quot;initialized&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;in_bus_reset
ques
c_cond
l_string|&quot;in_bus_reset&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;attempt_root
ques
c_cond
l_string|&quot;attempt_root&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%s %s %s %s&bslash;n&quot;
comma
id|host-&gt;is_root
ques
c_cond
l_string|&quot;root&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;is_cycmst
ques
c_cond
l_string|&quot;cycle_master&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;is_irm
ques
c_cond
l_string|&quot;iso_res_mgr&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;is_busmgr
ques
c_cond
l_string|&quot;bus_mgr&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n---Iso Receive DMA---&bslash;n&quot;
)paren
suffix:semicolon
id|d
op_assign
id|ohci-&gt;ir_context
suffix:semicolon
macro_line|#if 0
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;IR buf[%d] : %p prg[%d]: %p&bslash;n&quot;
comma
id|i
comma
id|d-&gt;buf
(braket
id|i
)braket
comma
id|i
comma
id|d-&gt;prg
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Current buf: %d offset: %d&bslash;n&quot;
comma
id|d-&gt;buf_ind
comma
id|d-&gt;buf_offset
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n---Async Receive DMA---&bslash;n&quot;
)paren
suffix:semicolon
id|d
op_assign
id|ohci-&gt;ar_req_context
suffix:semicolon
macro_line|#if 0
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AR req buf[%d] : %p prg[%d]: %p&bslash;n&quot;
comma
id|i
comma
id|d-&gt;buf
(braket
id|i
)braket
comma
id|i
comma
id|d-&gt;prg
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Ar req current buf: %d offset: %d&bslash;n&quot;
comma
id|d-&gt;buf_ind
comma
id|d-&gt;buf_offset
)paren
suffix:semicolon
id|d
op_assign
id|ohci-&gt;ar_resp_context
suffix:semicolon
macro_line|#if 0
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AR resp buf[%d] : %p prg[%d]: %p&bslash;n&quot;
comma
id|i
comma
id|d-&gt;buf
(braket
id|i
)braket
comma
id|i
comma
id|d-&gt;prg
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AR resp current buf: %d offset: %d&bslash;n&quot;
comma
id|d-&gt;buf_ind
comma
id|d-&gt;buf_offset
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n---Async Transmit DMA---&bslash;n&quot;
)paren
suffix:semicolon
id|dt
op_assign
id|ohci-&gt;at_req_context
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AT req prg: %d sent: %d free: %d branchAddrPtr: %p&bslash;n&quot;
comma
id|dt-&gt;prg_ind
comma
id|dt-&gt;sent_ind
comma
id|dt-&gt;free_prgs
comma
id|dt-&gt;branchAddrPtr
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AT req queue: first: %p last: %p&bslash;n&quot;
comma
id|dt-&gt;fifo_first
comma
id|dt-&gt;fifo_last
)paren
suffix:semicolon
id|dt
op_assign
id|ohci-&gt;at_resp_context
suffix:semicolon
macro_line|#if 0
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dt-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;------- AT resp prg[%02d] ------&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: control  : %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|begin.control
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|begin.control
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: address  : %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|begin.address
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|begin.address
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: brancAddr: %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|begin.branchAddress
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|begin.branchAddress
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: status   : %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|begin.status
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|begin.status
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: header[0]: %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|0
)braket
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: header[1]: %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|1
)braket
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: header[2]: %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|2
)braket
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: header[3]: %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|3
)braket
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|data
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: control  : %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|end.control
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|end.control
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: address  : %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|end.address
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|end.address
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: brancAddr: %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|end.branchAddress
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|end.branchAddress
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%p: status   : %08x&bslash;n&quot;
comma
op_amp
(paren
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|end.status
)paren
comma
id|dt-&gt;prg
(braket
id|i
)braket
dot
id|end.status
)paren
suffix:semicolon
)brace
macro_line|#endif
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AR resp prg: %d sent: %d free: %d&quot;
l_string|&quot; branchAddrPtr: %p&bslash;n&quot;
comma
id|dt-&gt;prg_ind
comma
id|dt-&gt;sent_ind
comma
id|dt-&gt;free_prgs
comma
id|dt-&gt;branchAddrPtr
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AT resp queue: first: %p last: %p&bslash;n&quot;
comma
id|dt-&gt;fifo_first
comma
id|dt-&gt;fifo_last
)paren
suffix:semicolon
multiline_comment|/* ----- Register Dump ----- */
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n### HC Register dump ###&bslash;n&quot;
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;Version     : %08x  GUID_ROM    : %08x  ATRetries   : %08x&bslash;n&quot;
comma
id|OHCI1394_Version
comma
id|OHCI1394_GUID_ROM
comma
id|OHCI1394_ATRetries
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;CSRData     : %08x  CSRCompData : %08x  CSRControl  : %08x&bslash;n&quot;
comma
id|OHCI1394_CSRData
comma
id|OHCI1394_CSRCompareData
comma
id|OHCI1394_CSRControl
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;ConfigROMhdr: %08x  BusID       : %08x  BusOptions  : %08x&bslash;n&quot;
comma
id|OHCI1394_ConfigROMhdr
comma
id|OHCI1394_BusID
comma
id|OHCI1394_BusOptions
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;GUIDHi      : %08x  GUIDLo      : %08x  ConfigROMmap: %08x&bslash;n&quot;
comma
id|OHCI1394_GUIDHi
comma
id|OHCI1394_GUIDLo
comma
id|OHCI1394_ConfigROMmap
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;PtdWrAddrLo : %08x  PtdWrAddrHi : %08x  VendorID    : %08x&bslash;n&quot;
comma
id|OHCI1394_PostedWriteAddressLo
comma
id|OHCI1394_PostedWriteAddressHi
comma
id|OHCI1394_VendorID
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;HCControl   : %08x  SelfIDBuffer: %08x  SelfIDCount : %08x&bslash;n&quot;
comma
id|OHCI1394_HCControlSet
comma
id|OHCI1394_SelfIDBuffer
comma
id|OHCI1394_SelfIDCount
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;IRMuChMaskHi: %08x  IRMuChMaskLo: %08x  IntEvent    : %08x&bslash;n&quot;
comma
id|OHCI1394_IRMultiChanMaskHiSet
comma
id|OHCI1394_IRMultiChanMaskLoSet
comma
id|OHCI1394_IntEventSet
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;IntMask     : %08x  IsoXmIntEvnt: %08x  IsoXmIntMask: %08x&bslash;n&quot;
comma
id|OHCI1394_IntMaskSet
comma
id|OHCI1394_IsoXmitIntEventSet
comma
id|OHCI1394_IsoXmitIntMaskSet
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;IsoRcvIntEvt: %08x  IsoRcvIntMsk: %08x  FairnessCtrl: %08x&bslash;n&quot;
comma
id|OHCI1394_IsoRecvIntEventSet
comma
id|OHCI1394_IsoRecvIntMaskSet
comma
id|OHCI1394_FairnessControl
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;LinkControl : %08x  NodeID      : %08x  PhyControl  : %08x&bslash;n&quot;
comma
id|OHCI1394_LinkControlSet
comma
id|OHCI1394_NodeID
comma
id|OHCI1394_PhyControl
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;IsoCyclTimer: %08x  AsRqFilterHi: %08x  AsRqFilterLo: %08x&bslash;n&quot;
comma
id|OHCI1394_IsochronousCycleTimer
comma
id|OHCI1394_AsReqFilterHiSet
comma
id|OHCI1394_AsReqFilterLoSet
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;PhyReqFiltHi: %08x  PhyReqFiltLo: %08x  PhyUpperBnd : %08x&bslash;n&quot;
comma
id|OHCI1394_PhyReqFilterHiSet
comma
id|OHCI1394_PhyReqFilterLoSet
comma
id|OHCI1394_PhyUpperBound
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;AsRqTrCxtCtl: %08x  AsRqTrCmdPtr: %08x  AsRsTrCtxCtl: %08x&bslash;n&quot;
comma
id|OHCI1394_AsReqTrContextControlSet
comma
id|OHCI1394_AsReqTrCommandPtr
comma
id|OHCI1394_AsRspTrContextControlSet
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;AsRsTrCmdPtr: %08x  AsRqRvCtxCtl: %08x  AsRqRvCmdPtr: %08x&bslash;n&quot;
comma
id|OHCI1394_AsRspTrCommandPtr
comma
id|OHCI1394_AsReqRcvContextControlSet
comma
id|OHCI1394_AsReqRcvCommandPtr
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;AsRsRvCtxCtl: %08x  AsRsRvCmdPtr: %08x  IntEvent    : %08x&bslash;n&quot;
comma
id|OHCI1394_AsRspRcvContextControlSet
comma
id|OHCI1394_AsRspRcvCommandPtr
comma
id|OHCI1394_IntEventSet
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_rcv_ctx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;IsoRCtxCtl%02d: %08x  IsoRCmdPtr%02d: %08x&quot;
l_string|&quot;  IsoRCxtMch%02d: %08x&bslash;n&quot;
comma
id|i
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextControlSet
op_plus
l_int|32
op_star
id|i
)paren
comma
id|i
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvCommandPtr
op_plus
l_int|32
op_star
id|i
)paren
comma
id|i
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextMatch
op_plus
l_int|32
op_star
id|i
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;IsoTCtxCtl%02d: %08x  IsoTCmdPtr%02d: %08x&bslash;n&quot;
comma
id|i
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitContextControlSet
op_plus
l_int|32
op_star
id|i
)paren
comma
id|i
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitCommandPtr
op_plus
l_int|32
op_star
id|i
)paren
)paren
suffix:semicolon
)brace
macro_line|#if 0
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n### Phy Register dump ###&bslash;n&quot;
)paren
suffix:semicolon
id|phyreg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;offset: %d val: 0x%02x -&gt; RHB: %d&quot;
l_string|&quot;IBR: %d Gap_count: %d&bslash;n&quot;
comma
l_int|1
comma
id|phyreg
comma
(paren
id|phyreg
op_amp
l_int|0x80
)paren
op_ne
l_int|0
comma
(paren
id|phyreg
op_amp
l_int|0x40
)paren
op_ne
l_int|0
comma
id|phyreg
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|phyreg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|2
)paren
suffix:semicolon
id|nports
op_assign
id|phyreg
op_amp
l_int|0x1f
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;offset: %d val: 0x%02x -&gt; SPD: %d&quot;
l_string|&quot; E  : %d Ports    : %2d&bslash;n&quot;
comma
l_int|2
comma
id|phyreg
comma
(paren
id|phyreg
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
comma
(paren
id|phyreg
op_amp
l_int|0x20
)paren
op_ne
l_int|0
comma
id|nports
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|phyreg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|3
op_plus
id|i
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;offset: %d val: 0x%02x -&gt; [port %d]&quot;
l_string|&quot; TPA: %d TPB: %d | %s %s&bslash;n&quot;
comma
l_int|3
op_plus
id|i
comma
id|phyreg
comma
id|i
comma
(paren
id|phyreg
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
comma
(paren
id|phyreg
op_amp
l_int|0x30
)paren
op_rshift
l_int|4
comma
(paren
id|phyreg
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot;child&quot;
suffix:colon
l_string|&quot;parent&quot;
comma
(paren
id|phyreg
op_amp
l_int|0x04
)paren
ques
c_cond
l_string|&quot;connected&quot;
suffix:colon
l_string|&quot;disconnected&quot;
)paren
suffix:semicolon
)brace
id|phyreg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|3
op_plus
id|i
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;offset: %d val: 0x%02x -&gt; ENV: %s Reg_count: %d&bslash;n&quot;
comma
l_int|3
op_plus
id|i
comma
id|phyreg
comma
(paren
(paren
(paren
id|phyreg
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_string|&quot;backplane&quot;
suffix:colon
(paren
(paren
(paren
id|phyreg
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
)paren
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;cable&quot;
suffix:colon
l_string|&quot;reserved&quot;
comma
id|phyreg
op_amp
l_int|0x3f
)paren
suffix:semicolon
macro_line|#endif
r_return
id|p
op_minus
id|buf
suffix:semicolon
)brace
DECL|function|ohci1394_read_proc
r_static
r_int
id|ohci1394_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
id|ohci_get_status
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0)
DECL|variable|ohci_proc_entry
r_struct
id|proc_dir_entry
op_star
id|ohci_proc_entry
suffix:semicolon
macro_line|#endif /* LINUX_VERSION_CODE */
macro_line|#endif /* CONFIG_PROC_FS */
DECL|function|remove_card
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
multiline_comment|/*&n;&t; * Reset the board properly before leaving&n;&t; * Daniel Kobras &lt;daniel.kobras@student.uni-tuebingen.de&gt;&n;&t; */
id|ohci_soft_reset
c_func
(paren
id|ohci
)paren
suffix:semicolon
multiline_comment|/* Free AR dma */
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ar_req_context
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ar_resp_context
)paren
suffix:semicolon
multiline_comment|/* Free AT dma */
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
multiline_comment|/* Free IR dma */
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ir_context
)paren
suffix:semicolon
multiline_comment|/* Free self-id buffer */
r_if
c_cond
(paren
id|ohci-&gt;selfid_buf_cpu
)paren
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
l_int|2048
comma
id|ohci-&gt;selfid_buf_cpu
comma
id|ohci-&gt;selfid_buf_bus
)paren
suffix:semicolon
multiline_comment|/* Free config rom */
r_if
c_cond
(paren
id|ohci-&gt;csr_config_rom_cpu
)paren
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
id|ohci_csr_rom
)paren
comma
id|ohci-&gt;csr_config_rom_cpu
comma
id|ohci-&gt;csr_config_rom_bus
)paren
suffix:semicolon
multiline_comment|/* Free the IRQ */
id|free_irq
c_func
(paren
id|ohci-&gt;dev-&gt;irq
comma
id|ohci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;registers
)paren
id|iounmap
c_func
(paren
id|ohci-&gt;registers
)paren
suffix:semicolon
id|ohci-&gt;state
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|init_driver
r_static
r_int
id|init_driver
c_func
(paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|success
op_assign
l_int|0
suffix:semicolon
macro_line|#if USE_DEVICE
r_int
id|i
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|num_of_cards
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_DEBUG
comma
id|__PRETTY_FUNCTION__
l_string|&quot; called again&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;looking for Ohci1394 cards&quot;
)paren
suffix:semicolon
macro_line|#if USE_DEVICE
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|supported_chips
(braket
id|i
)braket
(braket
l_int|0
)braket
op_ne
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|supported_chips
(braket
id|i
)braket
(braket
l_int|0
)braket
comma
id|supported_chips
(braket
id|i
)braket
(braket
l_int|1
)braket
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|add_card
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
macro_line|#else
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_class
c_func
(paren
id|PCI_CLASS_FIREWIRE_OHCI
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|add_card
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
id|success
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* USE_DEVICE */
r_if
c_cond
(paren
id|success
op_eq
l_int|0
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;no operable Ohci1394 cards found&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
id|create_proc_read_entry
(paren
l_string|&quot;ohci1394&quot;
comma
l_int|0
comma
l_int|NULL
comma
id|ohci1394_read_proc
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
(paren
id|ohci_proc_entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ohci1394&quot;
comma
l_int|0
comma
l_int|NULL
)paren
)paren
)paren
id|ohci_proc_entry-&gt;read_proc
op_assign
id|ohci1394_read_proc
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_ohci_rom
r_static
r_int
id|get_ohci_rom
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_const
id|quadlet_t
op_star
op_star
id|ptr
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;request csr_rom address: %08X&quot;
comma
(paren
id|u32
)paren
id|ohci-&gt;csr_config_rom_cpu
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|ohci-&gt;csr_config_rom_cpu
suffix:semicolon
r_return
r_sizeof
(paren
id|ohci_csr_rom
)paren
suffix:semicolon
)brace
DECL|function|ohci_hw_csr_reg
r_static
id|quadlet_t
id|ohci_hw_csr_reg
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|reg
comma
id|quadlet_t
id|data
comma
id|quadlet_t
id|compare
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|timeout
op_assign
l_int|255
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRData
comma
id|data
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRCompareData
comma
id|compare
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRControl
comma
id|reg
op_amp
l_int|0x3
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_decrement
op_logical_and
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRControl
)paren
op_amp
l_int|0x80000000
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;timeout!&quot;
)paren
suffix:semicolon
r_return
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRData
)paren
suffix:semicolon
)brace
DECL|function|get_ohci_template
r_struct
id|hpsb_host_template
op_star
id|get_ohci_template
c_func
(paren
r_void
)paren
(brace
r_static
r_struct
id|hpsb_host_template
id|tmpl
suffix:semicolon
r_static
r_int
id|initialized
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|initialized
)paren
(brace
multiline_comment|/* Initialize by field names so that a template structure&n;&t;&t; * reorganization does not influence this code. */
id|tmpl.name
op_assign
l_string|&quot;ohci1394&quot;
suffix:semicolon
id|tmpl.detect_hosts
op_assign
id|ohci_detect
suffix:semicolon
id|tmpl.initialize_host
op_assign
id|ohci_initialize
suffix:semicolon
id|tmpl.release_host
op_assign
id|ohci_remove
suffix:semicolon
id|tmpl.get_rom
op_assign
id|get_ohci_rom
suffix:semicolon
id|tmpl.transmit_packet
op_assign
id|ohci_transmit
suffix:semicolon
id|tmpl.devctl
op_assign
id|ohci_devctl
suffix:semicolon
id|tmpl.hw_csr_reg
op_assign
id|ohci_hw_csr_reg
suffix:semicolon
id|initialized
op_assign
l_int|1
suffix:semicolon
)brace
r_return
op_amp
id|tmpl
suffix:semicolon
)brace
DECL|function|ohci1394_stop_context
r_void
id|ohci1394_stop_context
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|reg
comma
r_char
op_star
id|msg
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* stop the channel program if it&squot;s still running */
id|reg_write
c_func
(paren
id|ohci
comma
id|reg
comma
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* Wait until it effectively stops */
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|reg
)paren
op_amp
l_int|0x400
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|5000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;runaway loop while stopping context...&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|msg
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;%s&bslash;n dma prg stopped&bslash;n&quot;
comma
id|msg
)paren
suffix:semicolon
)brace
DECL|function|ohci1394_get_struct
r_struct
id|ti_ohci
op_star
id|ohci1394_get_struct
c_func
(paren
r_int
id|card_num
)paren
(brace
r_if
c_cond
(paren
id|card_num
op_ge
l_int|0
op_logical_and
id|card_num
OL
id|num_of_cards
)paren
r_return
op_amp
id|cards
(braket
id|card_num
)braket
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ohci1394_register_video
r_int
id|ohci1394_register_video
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|video_template
op_star
id|tmpl
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;video_tmpl
)paren
r_return
op_minus
id|ENFILE
suffix:semicolon
id|ohci-&gt;video_tmpl
op_assign
id|tmpl
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci1394_unregister_video
r_void
id|ohci1394_unregister_video
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|video_template
op_star
id|tmpl
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;video_tmpl
op_ne
id|tmpl
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Trying to unregister wrong video device&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;video_tmpl
op_assign
l_int|NULL
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
macro_line|#if 0
r_int
id|ohci_compare_swap
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
id|quadlet_t
op_star
id|data
comma
id|quadlet_t
id|compare
comma
r_int
id|sel
)paren
(brace
r_int
id|timeout
op_assign
l_int|255
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRData
comma
op_star
id|data
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRCompareData
comma
id|compare
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRControl
comma
id|sel
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRControl
)paren
op_amp
l_int|0x80000000
)paren
)paren
(brace
r_if
c_cond
(paren
id|timeout
op_decrement
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request_channel timeout&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
op_star
id|data
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRData
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
id|ohci1394_request_channel
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|channel
)paren
(brace
r_int
id|csrSel
suffix:semicolon
id|quadlet_t
id|chan
comma
id|data1
op_assign
l_int|0
comma
id|data2
op_assign
l_int|0
suffix:semicolon
r_int
id|timeout
op_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|channel
OL
l_int|32
)paren
(brace
id|chan
op_assign
l_int|1
op_lshift
id|channel
suffix:semicolon
id|csrSel
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|chan
op_assign
l_int|1
op_lshift
(paren
id|channel
op_minus
l_int|32
)paren
suffix:semicolon
id|csrSel
op_assign
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci_compare_swap
c_func
(paren
id|ohci
comma
op_amp
id|data1
comma
l_int|0
comma
id|csrSel
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request_channel timeout&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|timeout
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|data1
op_amp
id|chan
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request channel %d failed&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|data2
op_assign
id|data1
suffix:semicolon
id|data1
op_or_assign
id|chan
suffix:semicolon
r_if
c_cond
(paren
id|ohci_compare_swap
c_func
(paren
id|ohci
comma
op_amp
id|data1
comma
id|data2
comma
id|csrSel
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request_channel timeout&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data1
op_eq
id|data2
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request channel %d succeded&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request channel %d failed&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|ohci1394_stop_context
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_stop_context
)paren
suffix:semicolon
DECL|variable|ohci1394_get_struct
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_get_struct
)paren
suffix:semicolon
DECL|variable|ohci1394_register_video
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_register_video
)paren
suffix:semicolon
DECL|variable|ohci1394_unregister_video
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_unregister_video
)paren
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* EXPORT_NO_SYMBOLS; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;driver for PCI Ohci IEEE-1394 controller&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;ohci1394&quot;
)paren
suffix:semicolon
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|hpsb_unregister_lowlevel
c_func
(paren
id|get_ohci_template
c_func
(paren
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|remove_proc_entry
(paren
l_string|&quot;ohci1394&quot;
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;removed &quot;
id|OHCI1394_DRIVER_NAME
l_string|&quot; module&quot;
)paren
suffix:semicolon
)brace
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
id|memset
c_func
(paren
id|cards
comma
l_int|0
comma
id|MAX_OHCI1394_CARDS
op_star
r_sizeof
(paren
r_struct
id|ti_ohci
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpsb_register_lowlevel
c_func
(paren
id|get_ohci_template
c_func
(paren
)paren
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;registering failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
eof
