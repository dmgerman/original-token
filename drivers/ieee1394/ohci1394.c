multiline_comment|/*&n; * ohci1394.c - driver for OHCI 1394 boards&n; * Copyright (C)1999,2000 Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&n; *                        Gord Peters &lt;GordPeters@smarttech.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;ohci1394.h&quot;
multiline_comment|/* print general (card independent) information */
DECL|macro|PRINT_G
mdefine_line|#define PRINT_G(level, fmt, args...) &bslash;&n;printk(level &quot;ohci1394: &quot; fmt &quot;&bslash;n&quot; , ## args)
multiline_comment|/* print card specific information */
DECL|macro|PRINT
mdefine_line|#define PRINT(level, card, fmt, args...) &bslash;&n;printk(level &quot;ohci1394_%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
DECL|variable|supported_chips
r_int
id|supported_chips
(braket
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_OHCI1394
)brace
comma
(brace
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_OHCI1394_2
)brace
comma
(brace
id|PCI_VENDOR_ID_VIA
comma
id|PCI_DEVICE_ID_VIA_OHCI1394
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
DECL|variable|cards
r_static
r_struct
id|ti_ohci
id|cards
(braket
id|MAX_OHCI1394_CARDS
)braket
suffix:semicolon
DECL|variable|num_of_cards
r_static
r_int
id|num_of_cards
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|add_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
suffix:semicolon
r_static
r_int
id|init_driver
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/***********************************&n; * IEEE-1394 functionality section *&n; ***********************************/
macro_line|#if 0 /* not needed at this time */
r_static
r_int
id|get_phy_reg
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|addr
)paren
(brace
r_int
id|timeout
op_assign
l_int|10000
suffix:semicolon
r_static
id|quadlet_t
id|r
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
OL
l_int|1
)paren
op_logical_or
(paren
id|addr
OG
l_int|15
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY register address %d out of range&quot;
comma
id|addr
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
multiline_comment|/* initiate read request */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
(paren
(paren
id|addr
op_lshift
l_int|8
)paren
op_amp
l_int|0x00000f00
)paren
op_or
l_int|0x00008000
)paren
suffix:semicolon
multiline_comment|/* wait */
r_while
c_loop
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
op_amp
l_int|0x80000000
)paren
op_logical_and
id|timeout
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;get_phy_reg timeout !!!&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|r
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
r_return
(paren
id|r
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
)brace
r_static
r_int
id|set_phy_reg
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|addr
comma
r_int
r_char
id|data
)paren
(brace
r_int
id|timeout
op_assign
l_int|10000
suffix:semicolon
id|u32
id|r
suffix:semicolon
r_if
c_cond
(paren
(paren
id|addr
OL
l_int|1
)paren
op_logical_or
(paren
id|addr
OG
l_int|15
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY register address %d out of range&quot;
comma
id|addr
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|r
op_assign
(paren
(paren
id|addr
op_lshift
l_int|8
)paren
op_amp
l_int|0x00000f00
)paren
op_or
l_int|0x00004000
op_or
(paren
(paren
id|u32
)paren
id|data
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
id|r
)paren
suffix:semicolon
multiline_comment|/* wait */
r_while
c_loop
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
op_amp
l_int|0x80000000
)paren
op_logical_and
id|timeout
)paren
id|timeout
op_decrement
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;set_phy_reg timeout !!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* unneeded functions */
DECL|function|handle_selfid
r_inline
r_static
r_int
id|handle_selfid
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|phyid
comma
r_int
id|isroot
)paren
(brace
id|quadlet_t
op_star
id|q
op_assign
id|ohci-&gt;self_id_buffer
suffix:semicolon
id|quadlet_t
id|self_id_count
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_SelfIDCount
)paren
suffix:semicolon
r_int
id|size
suffix:semicolon
id|quadlet_t
id|lsid
suffix:semicolon
multiline_comment|/* Self-id handling seems much easier than for the aic5800 chip.&n;&t;   All the self-id packets, including this device own self-id,&n;&t;   should be correctly arranged in the self_id_buffer at this&n;&t;   stage */
multiline_comment|/* Check status of self-id reception */
r_if
c_cond
(paren
(paren
id|self_id_count
op_amp
l_int|0x80000000
)paren
op_logical_or
(paren
(paren
id|self_id_count
op_amp
l_int|0x00FF0000
)paren
op_ne
(paren
id|q
(braket
l_int|0
)braket
op_amp
l_int|0x00FF0000
)paren
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Error in reception of self-id packets&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|size
op_assign
(paren
(paren
id|self_id_count
op_amp
l_int|0x0000EFFC
)paren
op_rshift
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|q
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|q
(braket
l_int|0
)braket
op_eq
op_complement
id|q
(braket
l_int|1
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;-%d- selfid packet 0x%x rcvd&bslash;n&quot;
comma
id|ohci-&gt;id
comma
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|q
(braket
l_int|0
)braket
op_amp
l_int|0x3f000000
)paren
op_rshift
l_int|24
)paren
op_eq
id|phyid
)paren
(brace
id|lsid
op_assign
id|q
(braket
l_int|0
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;This node self-id is 0x%08x&bslash;n&quot;
comma
id|lsid
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;-%d- inconsistent selfid 0x%x/0x%x&bslash;n&quot;
comma
id|ohci-&gt;id
comma
id|q
(braket
l_int|0
)braket
comma
id|q
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|q
op_add_assign
l_int|2
suffix:semicolon
id|size
op_sub_assign
l_int|2
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; calling self-id complete&bslash;n&quot;
)paren
suffix:semicolon
id|hpsb_selfid_complete
c_func
(paren
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_detect
r_static
r_int
id|ohci_detect
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
r_int
id|i
suffix:semicolon
id|init_driver
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_of_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|host
op_assign
id|hpsb_get_host
c_func
(paren
id|tmpl
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* simply don&squot;t init more after out of mem */
r_return
id|i
suffix:semicolon
)brace
id|host-&gt;hostdata
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
id|cards
(braket
id|i
)braket
dot
id|host
op_assign
id|host
suffix:semicolon
)brace
r_return
id|num_of_cards
suffix:semicolon
)brace
DECL|function|ohci_soft_reset
r_static
r_int
id|ohci_soft_reset
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_int
id|timeout
op_assign
l_int|10000
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00010000
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
)paren
op_amp
l_int|0x00010000
)paren
op_logical_and
id|timeout
)paren
id|timeout
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;soft reset timeout !!!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;soft reset finished&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_initialize
r_static
r_int
id|ohci_initialize
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
comma
id|i
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
multiline_comment|/* Soft reset */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|ohci_soft_reset
c_func
(paren
id|ohci
)paren
)paren
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
multiline_comment|/* Set the bus number */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
comma
l_int|0x0000ffc0
)paren
suffix:semicolon
multiline_comment|/* Set Link Power Status (LPS) */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00080000
)paren
suffix:semicolon
multiline_comment|/* Enable posted writes */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00040000
)paren
suffix:semicolon
multiline_comment|/* Clear link control register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Enable cycle timer and cycle master */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00300000
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt registers */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Set up self-id dma buffer */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_SelfIDBuffer
comma
id|virt_to_bus
c_func
(paren
id|ohci-&gt;self_id_buffer
)paren
)paren
suffix:semicolon
multiline_comment|/* enable self-id dma */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00000200
)paren
suffix:semicolon
multiline_comment|/* Set the configuration ROM mapping register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ConfigROMmap
comma
id|virt_to_bus
c_func
(paren
id|ohci-&gt;csr_config_rom
)paren
)paren
suffix:semicolon
macro_line|#if 1&t;&t;&t;&t;/* Why is this step necessary ? */
multiline_comment|/* Write the config ROM header */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ConfigROMhdr
comma
l_int|0x04040000
)paren
suffix:semicolon
multiline_comment|/* Set bus options */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
comma
l_int|0xf064A002
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 1
multiline_comment|/* Accept phy packets into AR request context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00000400
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Enable link */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00020000
)paren
suffix:semicolon
multiline_comment|/* Initialize IR dma */
multiline_comment|/* make sure the context isn&squot;t running, dead, or active */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IrRcvContextControlSet
)paren
op_amp
l_int|0x00008F00
)paren
)paren
(brace
multiline_comment|/* initialize IR program */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IR_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* end of descriptor list? */
r_if
c_cond
(paren
(paren
id|i
op_plus
l_int|1
)paren
OL
id|IR_NUM_DESC
)paren
(brace
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|control
op_assign
(paren
l_int|0x283C
op_lshift
l_int|16
)paren
op_or
id|IR_RECV_BUF_SIZE
suffix:semicolon
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
id|ohci-&gt;IR_recv_prg
(braket
id|i
op_plus
l_int|1
)braket
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|control
op_assign
(paren
l_int|0x283C
op_lshift
l_int|16
)paren
op_or
id|IR_RECV_BUF_SIZE
suffix:semicolon
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
id|ohci-&gt;IR_recv_prg
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
suffix:semicolon
)brace
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|ohci-&gt;IR_recv_buf
(braket
id|i
)braket
)paren
suffix:semicolon
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|status
op_assign
id|IR_RECV_BUF_SIZE
suffix:semicolon
)brace
multiline_comment|/* Tell the controller where the first IR program is */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IrRcvCommandPtr
comma
id|virt_to_bus
c_func
(paren
id|ohci-&gt;IR_recv_prg
(braket
l_int|0
)braket
)paren
op_or
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* Set bufferFill, isochHeader, multichannel for IR context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IrRcvContextControlSet
comma
l_int|0xd0000000
)paren
suffix:semicolon
multiline_comment|/* Set the context match register to match on all tags */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IrRcvContextMatch
comma
l_int|0xf0000000
)paren
suffix:semicolon
multiline_comment|/* Clear the multi channel mask high and low registers */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Set up isoRecvIntMask to generate interrupts for context 0&n;                   (thanks to Michael Greger for seeing that I forgot this) */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
comma
l_int|0x00000001
)paren
suffix:semicolon
multiline_comment|/* Run IR context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IrRcvContextControlSet
comma
l_int|0x00008000
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize AR dma */
multiline_comment|/* make sure the context isn&squot;t running, dead, or active */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspRcvContextControlSet
)paren
op_amp
l_int|0x00008F00
)paren
)paren
(brace
multiline_comment|/* initialize AR program */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AR_RESP_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* end of descriptor list? */
r_if
c_cond
(paren
(paren
id|i
op_plus
l_int|1
)paren
OL
id|AR_RESP_NUM_DESC
)paren
(brace
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|control
op_assign
(paren
l_int|0x283C
op_lshift
l_int|16
)paren
op_or
id|AR_RESP_BUF_SIZE
suffix:semicolon
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
id|ohci-&gt;AR_resp_prg
(braket
id|i
op_plus
l_int|1
)braket
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|control
op_assign
(paren
l_int|0x283C
op_lshift
l_int|16
)paren
op_or
id|AR_RESP_BUF_SIZE
suffix:semicolon
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
(paren
id|virt_to_bus
c_func
(paren
id|ohci-&gt;AR_resp_prg
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
suffix:semicolon
)brace
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|ohci-&gt;AR_resp_buf
(braket
id|i
)braket
)paren
suffix:semicolon
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
op_member_access_from_pointer
id|status
op_assign
id|AR_RESP_BUF_SIZE
suffix:semicolon
)brace
multiline_comment|/* Tell the controller where the first AR program is */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspRcvCommandPtr
comma
id|virt_to_bus
c_func
(paren
id|ohci-&gt;AR_resp_prg
(braket
l_int|0
)braket
)paren
op_or
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* Accept phy packets into AR request context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00000400
)paren
suffix:semicolon
multiline_comment|/* Run AR context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspRcvContextControlSet
comma
l_int|0x00008000
)paren
suffix:semicolon
)brace
multiline_comment|/* Specify AT retries */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ATRetries
comma
id|OHCI1394_MAX_AT_REQ_RETRIES
op_or
(paren
id|OHCI1394_MAX_AT_RESP_RETRIES
op_lshift
l_int|4
)paren
op_or
(paren
id|OHCI1394_MAX_PHYS_RESP_RETRIES
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
macro_line|#ifndef __BIG_ENDIAN
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlClear
comma
l_int|0x40000000
)paren
suffix:semicolon
macro_line|#else
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x40000000
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Enable interrupts */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskSet
comma
id|OHCI1394_masterIntEnable
op_or
id|OHCI1394_phyRegRcvd
op_or
id|OHCI1394_busReset
op_or
id|OHCI1394_selfIDComplete
op_or
id|OHCI1394_RSPkt
op_or
id|OHCI1394_RQPkt
op_or
id|OHCI1394_ARRS
op_or
id|OHCI1394_ARRQ
op_or
id|OHCI1394_respTxComplete
op_or
id|OHCI1394_reqTxComplete
op_or
id|OHCI1394_isochRx
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ohci_remove
r_static
r_void
id|ohci_remove
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_if
c_cond
(paren
id|host
op_ne
l_int|NULL
)paren
(brace
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|remove_card
c_func
(paren
id|ohci
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* This must be called with the async_queue_lock held. */
DECL|function|send_next_async
r_static
r_void
id|send_next_async
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
op_assign
id|ohci-&gt;async_queue
suffix:semicolon
r_struct
id|dma_cmd
id|prg
suffix:semicolon
macro_line|#if 0
id|quadlet_t
op_star
id|ptr
op_assign
(paren
id|quadlet_t
op_star
)paren
id|ohci-&gt;AT_req_prg
suffix:semicolon
macro_line|#endif
singleline_comment|//HPSB_TRACE();
multiline_comment|/* stop the channel program if it&squot;s still running */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrContextControlClear
comma
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* Wait until it effectively stops */
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrContextControlSet
)paren
op_amp
l_int|0x400
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|5000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;runaway loop in DmaAT. bailing out...&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|async
)paren
(brace
multiline_comment|/* re-format packet header according to ohci specification */
id|packet-&gt;header
(braket
l_int|1
)braket
op_assign
(paren
id|packet-&gt;header
(braket
l_int|1
)braket
op_amp
l_int|0xFFFF
)paren
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF0000
)paren
suffix:semicolon
id|packet-&gt;header
(braket
l_int|0
)braket
op_assign
id|DMA_SPEED_200
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
)paren
(brace
multiline_comment|/* block transmit */
id|prg.control
op_assign
id|OUTPUT_MORE_IMMEDIATE
op_or
l_int|0x10
suffix:semicolon
id|prg.address
op_assign
l_int|0
suffix:semicolon
id|prg.branchAddress
op_assign
l_int|0
suffix:semicolon
id|prg.status
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|ohci-&gt;AT_req_prg
comma
op_amp
id|prg
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ohci-&gt;AT_req_prg
op_plus
l_int|1
comma
id|packet-&gt;header
comma
l_int|16
)paren
suffix:semicolon
id|prg.control
op_assign
id|OUTPUT_LAST
op_or
id|packet-&gt;data_size
suffix:semicolon
id|prg.address
op_assign
id|virt_to_bus
c_func
(paren
id|packet-&gt;data
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ohci-&gt;AT_req_prg
op_plus
l_int|2
comma
op_amp
id|prg
comma
l_int|16
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrCommandPtr
comma
id|virt_to_bus
c_func
(paren
id|ohci-&gt;AT_req_prg
)paren
op_or
l_int|0x3
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* quadlet transmit */
id|prg.control
op_assign
id|OUTPUT_LAST_IMMEDIATE
op_or
id|packet-&gt;header_size
suffix:semicolon
id|prg.address
op_assign
l_int|0
suffix:semicolon
id|prg.branchAddress
op_assign
l_int|0
suffix:semicolon
id|prg.status
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|ohci-&gt;AT_req_prg
comma
op_amp
id|prg
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ohci-&gt;AT_req_prg
op_plus
l_int|1
comma
id|packet-&gt;header
comma
l_int|16
)paren
suffix:semicolon
macro_line|#if 0
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;dma_cmd: %08x %08x %08x %08x&quot;
comma
op_star
id|ptr
comma
op_star
(paren
id|ptr
op_plus
l_int|1
)paren
comma
op_star
(paren
id|ptr
op_plus
l_int|2
)paren
comma
op_star
(paren
id|ptr
op_plus
l_int|3
)paren
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;header: %08x %08x %08x %08x&quot;
comma
op_star
(paren
id|ptr
op_plus
l_int|4
)paren
comma
op_star
(paren
id|ptr
op_plus
l_int|5
)paren
comma
op_star
(paren
id|ptr
op_plus
l_int|6
)paren
comma
op_star
(paren
id|ptr
op_plus
l_int|7
)paren
)paren
suffix:semicolon
macro_line|#endif
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrCommandPtr
comma
id|virt_to_bus
c_func
(paren
id|ohci-&gt;AT_req_prg
)paren
op_or
l_int|0x2
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|raw
)paren
(brace
id|prg.control
op_assign
id|OUTPUT_LAST
op_or
id|packet-&gt;data_size
suffix:semicolon
id|prg.address
op_assign
id|virt_to_bus
c_func
(paren
id|packet-&gt;data
)paren
suffix:semicolon
id|prg.branchAddress
op_assign
l_int|0
suffix:semicolon
id|prg.status
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|ohci-&gt;AT_req_prg
comma
op_amp
id|prg
comma
l_int|16
)paren
suffix:semicolon
macro_line|#if 0
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;dma_cmd: %08x %08x %08x %08x&quot;
comma
op_star
id|ptr
comma
op_star
(paren
id|ptr
op_plus
l_int|1
)paren
comma
op_star
(paren
id|ptr
op_plus
l_int|2
)paren
comma
op_star
(paren
id|ptr
op_plus
l_int|3
)paren
)paren
suffix:semicolon
macro_line|#endif
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrCommandPtr
comma
id|virt_to_bus
c_func
(paren
id|ohci-&gt;AT_req_prg
)paren
op_or
l_int|0x2
)paren
suffix:semicolon
)brace
multiline_comment|/* run program */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrContextControlSet
comma
l_int|0x00008000
)paren
suffix:semicolon
)brace
DECL|function|ohci_transmit
r_static
r_int
id|ohci_transmit
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|p
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
op_ge
l_int|4096
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;transmit packet data too big (%d)&quot;
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|//HPSB_TRACE();
id|packet-&gt;xnext
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;async_queue
op_eq
l_int|NULL
)paren
(brace
id|ohci-&gt;async_queue
op_assign
id|packet
suffix:semicolon
id|send_next_async
c_func
(paren
id|ohci
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|ohci-&gt;async_queue
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;xnext
op_ne
l_int|NULL
)paren
(brace
id|p
op_assign
id|p-&gt;xnext
suffix:semicolon
)brace
id|p-&gt;xnext
op_assign
id|packet
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ohci_devctl
r_static
r_int
id|ohci_devctl
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_enum
id|devctl_cmd
id|cmd
comma
r_int
id|arg
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
comma
op_star
id|lastpacket
suffix:semicolon
id|u32
id|r
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RESET_BUS
suffix:colon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;resetting bus on request%s&quot;
comma
(paren
id|host-&gt;attempt_root
ques
c_cond
l_string|&quot; and attempting to become root&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|r
op_assign
(paren
id|host-&gt;attempt_root
)paren
ques
c_cond
l_int|0x000041ff
suffix:colon
l_int|0x0000417f
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
id|r
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GET_CYCLE_COUNTER
suffix:colon
id|retval
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_CYCLE_COUNTER
suffix:colon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_BUS_ID
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;devctl command SET_BUS_ID err&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT_CYCLE_MASTER
suffix:colon
macro_line|#if 0
r_if
c_cond
(paren
id|arg
)paren
(brace
multiline_comment|/* enable cycleTimer, cycleMaster, cycleSource */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00700000
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* disable cycleTimer, cycleMaster, cycleSource */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0x00700000
)paren
suffix:semicolon
)brace
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|CANCEL_REQUESTS
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* stop any chip activity */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlClear
comma
l_int|0x00020000
)paren
suffix:semicolon
id|packet
op_assign
id|ohci-&gt;async_queue
suffix:semicolon
id|ohci-&gt;async_queue
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|packet
op_ne
l_int|NULL
)paren
(brace
id|lastpacket
op_assign
id|packet
suffix:semicolon
id|packet
op_assign
id|packet-&gt;xnext
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|lastpacket
comma
id|ACKX_ABORTED
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MODIFY_USAGE
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISO_LISTEN_CHANNEL
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|arg
comma
op_amp
id|ohci-&gt;IR_channel_usage
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;listening enabled on channel %d&quot;
comma
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|31
)paren
(brace
id|u32
id|setMask
op_assign
l_int|0x00000001
suffix:semicolon
id|arg
op_sub_assign
l_int|32
suffix:semicolon
r_while
c_loop
(paren
id|arg
op_decrement
)paren
(brace
id|setMask
op_assign
id|setMask
op_lshift
l_int|1
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiSet
comma
id|setMask
)paren
suffix:semicolon
)brace
r_else
(brace
id|u32
id|setMask
op_assign
l_int|0x00000001
suffix:semicolon
r_while
c_loop
(paren
id|arg
op_decrement
)paren
(brace
id|setMask
op_assign
id|setMask
op_lshift
l_int|1
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoSet
comma
id|setMask
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISO_UNLISTEN_CHANNEL
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|arg
comma
op_amp
id|ohci-&gt;IR_channel_usage
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;listening disabled on iso channel %d&quot;
comma
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|31
)paren
(brace
id|u32
id|clearMask
op_assign
l_int|0x00000001
suffix:semicolon
id|arg
op_sub_assign
l_int|32
suffix:semicolon
r_while
c_loop
(paren
id|arg
op_decrement
)paren
(brace
id|clearMask
op_assign
id|clearMask
op_lshift
l_int|1
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
id|clearMask
)paren
suffix:semicolon
)brace
r_else
(brace
id|u32
id|clearMask
op_assign
l_int|0x00000001
suffix:semicolon
r_while
c_loop
(paren
id|arg
op_decrement
)paren
(brace
id|clearMask
op_assign
id|clearMask
op_lshift
l_int|1
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
id|clearMask
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;ohci_devctl cmd %d not implemented yet&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/***************************************&n; * IEEE-1394 functionality section END *&n; ***************************************/
multiline_comment|/********************************************************&n; * Global stuff (interrupt handler, init/shutdown code) *&n; ********************************************************/
DECL|function|stop_ar_resp_context
r_static
r_void
id|stop_ar_resp_context
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_char
op_star
id|msg
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* stop the channel program if it&squot;s still running */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspRcvContextControlClear
comma
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* Wait until it effectively stops */
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspRcvContextControlSet
)paren
op_amp
l_int|0x400
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|5000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;runaway loop in Dma Ar Resp. bailing out...&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;%s&bslash;n async response receive dma stopped&bslash;n&quot;
comma
id|msg
)paren
suffix:semicolon
)brace
DECL|function|ohci_irq_handler
r_static
r_void
id|ohci_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs_are_unused
)paren
(brace
singleline_comment|//int i;
r_static
id|quadlet_t
id|event
comma
id|node_id
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|ohci-&gt;host
suffix:semicolon
r_int
id|phyid
op_assign
op_minus
l_int|1
comma
id|isroot
op_assign
l_int|0
suffix:semicolon
id|event
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventSet
)paren
suffix:semicolon
multiline_comment|/* Clear the interrupt register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
id|event
)paren
suffix:semicolon
multiline_comment|/* PRINT(KERN_INFO, ohci-&gt;id, &quot;int event %08X mask %08X&quot;,&n;&t;   event,reg_read(ohci, OHCI1394_IntMaskSet)); */
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_busReset
)paren
(brace
macro_line|#if 0
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;bus reset interrupt&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;in_bus_reset
)paren
(brace
id|hpsb_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
id|ohci-&gt;NumBusResets
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_RQPkt
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;RQPkt int received&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_RQPkt
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;ControlContext: %08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqRcvContextControlSet
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_RSPkt
)paren
(brace
r_int
r_int
id|idx
comma
id|offset
comma
id|rescount
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ohci-&gt;AR_resp_lock
)paren
suffix:semicolon
id|idx
op_assign
id|ohci-&gt;AR_resp_buf_th_ind
suffix:semicolon
id|offset
op_assign
id|ohci-&gt;AR_resp_buf_th_offset
suffix:semicolon
id|rescount
op_assign
id|ohci-&gt;AR_resp_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_amp
l_int|0xffff
suffix:semicolon
id|ohci-&gt;AR_resp_bytes_left
op_add_assign
id|AR_RESP_BUF_SIZE
op_minus
id|rescount
op_minus
id|offset
suffix:semicolon
id|offset
op_assign
id|AR_RESP_BUF_SIZE
op_minus
id|rescount
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rescount
)paren
(brace
multiline_comment|/* We cross a buffer boundary */
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|AR_RESP_NUM_DESC
suffix:semicolon
macro_line|#if 0 
multiline_comment|/* This bit of code does not work */
multiline_comment|/* Let&squot;s see how many bytes were written in the async response &n;&t;&t;&t;   receive buf since last interrupt. This is done by finding &n;&t;&t;&t;   the next active context (See OHCI Spec p91) */
r_while
c_loop
(paren
id|ohci-&gt;AR_resp_bytes_left
op_le
id|AR_RESP_TOTAL_BUF_SIZE
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_amp
l_int|0x04000000
)paren
r_break
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|AR_RESP_NUM_DESC
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;crossing more than one buffer boundary !!!&quot;
)paren
suffix:semicolon
id|ohci-&gt;AR_resp_bytes_left
op_add_assign
id|AR_RESP_BUF_SIZE
suffix:semicolon
)brace
macro_line|#endif 
multiline_comment|/* ASSUMPTION: only one buffer boundary is crossed */
id|rescount
op_assign
id|ohci-&gt;AR_resp_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_amp
l_int|0xffff
suffix:semicolon
id|offset
op_assign
id|AR_RESP_BUF_SIZE
op_minus
id|rescount
suffix:semicolon
id|ohci-&gt;AR_resp_bytes_left
op_add_assign
id|offset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
op_eq
id|AR_RESP_BUF_SIZE
)paren
(brace
id|offset
op_assign
l_int|0
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|AR_RESP_NUM_DESC
suffix:semicolon
)brace
id|ohci-&gt;AR_resp_buf_th_ind
op_assign
id|idx
suffix:semicolon
id|ohci-&gt;AR_resp_buf_th_offset
op_assign
id|offset
suffix:semicolon
multiline_comment|/* is buffer processing too slow? (all buffers used) */
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_bytes_left
OG
id|AR_RESP_TOTAL_BUF_SIZE
)paren
(brace
id|stop_ar_resp_context
c_func
(paren
id|ohci
comma
l_string|&quot;async response receive processing too slow&quot;
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;AR_resp_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;AR_resp_lock
)paren
suffix:semicolon
multiline_comment|/* queue bottom half in immediate queue */
id|queue_task
c_func
(paren
op_amp
id|ohci-&gt;AR_resp_pdl_task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_isochRx
)paren
(brace
id|quadlet_t
id|isoRecvIntEvent
suffix:semicolon
multiline_comment|/* ASSUMPTION: We assume there is only one context for now. */
id|spin_lock
c_func
(paren
op_amp
id|ohci-&gt;IR_recv_lock
)paren
suffix:semicolon
multiline_comment|/* Clear the isoRecvIntEvent register (very important!) */
id|isoRecvIntEvent
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventSet
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventClear
comma
id|isoRecvIntEvent
)paren
suffix:semicolon
id|ohci-&gt;IR_buf_used
op_increment
suffix:semicolon
id|ohci-&gt;IR_buf_next_ind
op_assign
(paren
id|ohci-&gt;IR_buf_next_ind
op_plus
l_int|1
)paren
op_mod
id|IR_NUM_DESC
suffix:semicolon
multiline_comment|/* is buffer processing too slow? (all buffers used) */
r_if
c_cond
(paren
id|ohci-&gt;IR_buf_next_ind
op_eq
id|ohci-&gt;IR_buf_last_ind
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* stop the context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IrRcvContextControlClear
comma
l_int|0x8000
)paren
suffix:semicolon
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IrRcvContextControlSet
)paren
op_amp
l_int|0x400
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|5000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;runaway loop in DmaIR. bailing out...&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;IR_recv_lock
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;iso receive processing too slow... stopped&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* reset status field of next descriptor */
id|ohci-&gt;IR_recv_prg
(braket
id|ohci-&gt;IR_buf_next_ind
)braket
op_member_access_from_pointer
id|status
op_assign
id|IR_RECV_BUF_SIZE
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;IR_recv_lock
)paren
suffix:semicolon
multiline_comment|/* queue bottom half in immediate queue */
id|queue_task
c_func
(paren
op_amp
id|ohci-&gt;IR_pdl_task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_selfIDComplete
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
id|node_id
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node_id
op_amp
l_int|0x8000000
)paren
(brace
multiline_comment|/* NodeID valid */
id|phyid
op_assign
id|node_id
op_amp
l_int|0x0000003f
suffix:semicolon
id|isroot
op_assign
(paren
id|node_id
op_amp
l_int|0x40000000
)paren
op_ne
l_int|0
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID process finished (phyid %d, %s)&quot;
comma
id|phyid
comma
(paren
id|isroot
ques
c_cond
l_string|&quot;root&quot;
suffix:colon
l_string|&quot;not root&quot;
)paren
)paren
suffix:semicolon
id|handle_selfid
c_func
(paren
id|ohci
comma
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID process finished but NodeID&quot;
l_string|&quot; not valid: %08X&quot;
comma
id|node_id
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;phy reg received without reset&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_phyRegRcvd
)paren
(brace
macro_line|#if 0
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;PhyControl: %08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;-%d- phy reg received without reset&bslash;n&quot;
comma
id|ohci-&gt;id
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_reqTxComplete
)paren
(brace
multiline_comment|/* async packet sent - transmitter ready */
id|u32
id|ack
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;async_queue
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|ohci-&gt;async_queue_lock
)paren
suffix:semicolon
id|ack
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrContextControlSet
)paren
op_amp
l_int|0xF
suffix:semicolon
id|packet
op_assign
id|ohci-&gt;async_queue
suffix:semicolon
id|ohci-&gt;async_queue
op_assign
id|packet-&gt;xnext
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;async_queue
op_ne
l_int|NULL
)paren
(brace
id|send_next_async
c_func
(paren
id|ohci
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;async_queue_lock
)paren
suffix:semicolon
macro_line|#if 0
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;packet sent with ack code %d&quot;
comma
id|ack
)paren
suffix:semicolon
macro_line|#endif
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|packet
comma
id|ack
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;packet sent without async_queue (self-id?)&quot;
)paren
suffix:semicolon
id|ohci-&gt;TxRdy
op_increment
suffix:semicolon
)brace
id|ohci-&gt;NumInterrupts
op_increment
suffix:semicolon
)brace
multiline_comment|/* This is the bottom half that processes async response receive descriptor buffers. */
DECL|function|ohci_ar_resp_proc_desc
r_static
r_void
id|ohci_ar_resp_proc_desc
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|quadlet_t
op_star
id|buf_ptr
suffix:semicolon
r_char
op_star
id|split_ptr
suffix:semicolon
r_int
r_int
id|split_left
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|packet_length
suffix:semicolon
r_int
r_int
id|idx
comma
id|offset
comma
id|tcode
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
id|msg
(braket
l_int|256
)braket
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;AR_resp_lock
comma
id|flags
)paren
suffix:semicolon
id|idx
op_assign
id|ohci-&gt;AR_resp_buf_bh_ind
suffix:semicolon
id|offset
op_assign
id|ohci-&gt;AR_resp_buf_bh_offset
suffix:semicolon
id|buf_ptr
op_assign
id|ohci-&gt;AR_resp_buf
(braket
id|idx
)braket
suffix:semicolon
id|buf_ptr
op_add_assign
id|offset
op_div
l_int|4
suffix:semicolon
r_while
c_loop
(paren
id|ohci-&gt;AR_resp_bytes_left
OG
l_int|0
)paren
(brace
multiline_comment|/* check to see if a fatal error occurred */
r_if
c_cond
(paren
(paren
id|ohci-&gt;AR_resp_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_rshift
l_int|16
)paren
op_amp
l_int|0x800
)paren
(brace
id|sprintf
c_func
(paren
id|msg
comma
l_string|&quot;fatal async response receive error -- status is %d&quot;
comma
id|ohci-&gt;AR_resp_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_amp
l_int|0x1F
)paren
suffix:semicolon
id|stop_ar_resp_context
c_func
(paren
id|ohci
comma
id|msg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;AR_resp_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;AR_resp_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Let&squot;s see what kind of packet is in there */
id|tcode
op_assign
(paren
id|buf_ptr
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|tcode
op_eq
l_int|2
)paren
multiline_comment|/* no-data receive */
id|packet_length
op_assign
l_int|16
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tcode
op_eq
l_int|6
)paren
multiline_comment|/* quadlet receive */
id|packet_length
op_assign
l_int|20
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tcode
op_eq
l_int|7
)paren
(brace
multiline_comment|/* block receive */
multiline_comment|/* Where is the data length ? */
r_if
c_cond
(paren
id|offset
op_plus
l_int|12
op_ge
id|AR_RESP_BUF_SIZE
)paren
id|packet_length
op_assign
(paren
id|ohci-&gt;AR_resp_buf
(braket
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|AR_RESP_NUM_DESC
)braket
(braket
l_int|3
op_minus
(paren
id|AR_RESP_BUF_SIZE
op_minus
id|offset
)paren
op_div
l_int|4
)braket
op_rshift
l_int|16
)paren
op_plus
l_int|20
suffix:semicolon
r_else
id|packet_length
op_assign
(paren
id|buf_ptr
(braket
l_int|3
)braket
op_rshift
l_int|16
)paren
op_plus
l_int|20
suffix:semicolon
r_if
c_cond
(paren
id|packet_length
op_mod
l_int|4
)paren
id|packet_length
op_add_assign
l_int|4
op_minus
(paren
id|packet_length
op_mod
l_int|4
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* something is wrong */
(brace
id|sprintf
c_func
(paren
id|msg
comma
l_string|&quot;unexpected packet tcode %d in async response receive buffer&quot;
comma
id|tcode
)paren
suffix:semicolon
id|stop_ar_resp_context
c_func
(paren
id|ohci
comma
id|msg
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|offset
op_plus
id|packet_length
)paren
OG
id|AR_RESP_BUF_SIZE
)paren
(brace
multiline_comment|/* we have a split packet */
r_if
c_cond
(paren
id|packet_length
OG
id|AR_RESP_SPLIT_PACKET_BUF_SIZE
)paren
(brace
id|sprintf
c_func
(paren
id|msg
comma
l_string|&quot;packet size %d bytes exceed split packet buffer size %d bytes&quot;
comma
id|packet_length
comma
id|AR_RESP_SPLIT_PACKET_BUF_SIZE
)paren
suffix:semicolon
id|stop_ar_resp_context
c_func
(paren
id|ohci
comma
id|msg
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|split_left
op_assign
id|packet_length
suffix:semicolon
id|split_ptr
op_assign
(paren
r_char
op_star
)paren
id|ohci-&gt;AR_resp_spb
suffix:semicolon
r_while
c_loop
(paren
id|split_left
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|AR_RESP_BUF_SIZE
op_minus
id|offset
)paren
suffix:semicolon
id|split_left
op_sub_assign
id|AR_RESP_BUF_SIZE
op_minus
id|offset
suffix:semicolon
id|split_ptr
op_add_assign
id|AR_RESP_BUF_SIZE
op_minus
id|offset
suffix:semicolon
id|ohci-&gt;AR_resp_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_assign
id|AR_RESP_BUF_SIZE
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|AR_RESP_NUM_DESC
suffix:semicolon
id|buf_ptr
op_assign
id|ohci-&gt;AR_resp_buf
(braket
id|idx
)braket
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|split_left
op_ge
id|AR_RESP_BUF_SIZE
)paren
(brace
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|AR_RESP_BUF_SIZE
)paren
suffix:semicolon
id|split_ptr
op_add_assign
id|AR_RESP_BUF_SIZE
suffix:semicolon
id|split_left
op_sub_assign
id|AR_RESP_BUF_SIZE
suffix:semicolon
id|ohci-&gt;AR_resp_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_assign
id|AR_RESP_BUF_SIZE
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|AR_RESP_NUM_DESC
suffix:semicolon
id|buf_ptr
op_assign
id|ohci-&gt;AR_resp_buf
(braket
id|idx
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|split_left
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|split_left
)paren
suffix:semicolon
id|offset
op_assign
id|split_left
suffix:semicolon
id|split_left
op_assign
l_int|0
suffix:semicolon
id|buf_ptr
op_add_assign
id|split_left
op_div
l_int|4
suffix:semicolon
)brace
)brace
macro_line|#if 0
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;AR resp: received split packet tcode=%d length=%d&quot;
comma
id|tcode
comma
id|packet_length
)paren
suffix:semicolon
macro_line|#endif
id|hpsb_packet_received
c_func
(paren
id|ohci-&gt;host
comma
id|ohci-&gt;AR_resp_spb
comma
id|packet_length
)paren
suffix:semicolon
id|ohci-&gt;AR_resp_bytes_left
op_sub_assign
id|packet_length
suffix:semicolon
)brace
r_else
(brace
macro_line|#if 0
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;AR resp: received packet tcode=%d length=%d&quot;
comma
id|tcode
comma
id|packet_length
)paren
suffix:semicolon
macro_line|#endif
id|hpsb_packet_received
c_func
(paren
id|ohci-&gt;host
comma
id|buf_ptr
comma
id|packet_length
)paren
suffix:semicolon
id|offset
op_add_assign
id|packet_length
suffix:semicolon
id|buf_ptr
op_add_assign
id|packet_length
op_div
l_int|4
suffix:semicolon
id|ohci-&gt;AR_resp_bytes_left
op_sub_assign
id|packet_length
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
id|AR_RESP_BUF_SIZE
)paren
(brace
id|ohci-&gt;AR_resp_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_assign
id|AR_RESP_BUF_SIZE
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|AR_RESP_NUM_DESC
suffix:semicolon
id|buf_ptr
op_assign
id|ohci-&gt;AR_resp_buf
(braket
id|idx
)braket
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_bytes_left
OL
l_int|0
)paren
id|stop_ar_resp_context
c_func
(paren
id|ohci
comma
l_string|&quot;Sync problem in AR resp dma buffer&quot;
)paren
suffix:semicolon
id|ohci-&gt;AR_resp_buf_bh_ind
op_assign
id|idx
suffix:semicolon
id|ohci-&gt;AR_resp_buf_bh_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;AR_resp_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* This is the bottom half that processes iso receive descriptor buffers. */
DECL|function|ohci_ir_proc_desc
r_static
r_void
id|ohci_ir_proc_desc
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|quadlet_t
op_star
id|buf_ptr
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|data
suffix:semicolon
r_int
id|bytes_left
comma
id|data_length
suffix:semicolon
r_int
r_int
id|idx
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_recv_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ohci-&gt;IR_buf_used
OG
l_int|0
)paren
(brace
id|idx
op_assign
id|ohci-&gt;IR_buf_last_ind
suffix:semicolon
multiline_comment|/* check to see if a fatal error occurred */
r_if
c_cond
(paren
(paren
id|ohci-&gt;IR_recv_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_rshift
l_int|16
)paren
op_amp
l_int|0x800
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* stop the context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IrRcvContextControlClear
comma
l_int|0x8000
)paren
suffix:semicolon
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IrRcvContextControlSet
)paren
op_amp
l_int|0x400
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|5000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;runaway loop in DmaIR. bailing out...&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_recv_lock
comma
id|flags
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;fatal iso receive error -- status is %d&quot;
comma
id|ohci-&gt;IR_recv_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_amp
l_int|0x1F
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_recv_lock
comma
id|flags
)paren
suffix:semicolon
id|buf_ptr
op_assign
id|bus_to_virt
c_func
(paren
id|ohci-&gt;IR_recv_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|address
)paren
suffix:semicolon
id|bytes_left
op_assign
id|IR_RECV_BUF_SIZE
suffix:semicolon
multiline_comment|/* are we processing a split packet from last buffer */
r_if
c_cond
(paren
id|ohci-&gt;IR_sp_bytes_left
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;IR_spb_bytes_used
)paren
(brace
multiline_comment|/* packet is in process of being dropped */
r_if
c_cond
(paren
id|ohci-&gt;IR_sp_bytes_left
OG
id|bytes_left
)paren
(brace
id|ohci-&gt;IR_sp_bytes_left
op_sub_assign
id|bytes_left
suffix:semicolon
id|bytes_left
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|buf_ptr
op_assign
id|bus_to_virt
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
(paren
(paren
id|quadlet_t
op_star
)paren
id|ohci-&gt;IR_recv_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|address
)paren
(braket
id|ohci-&gt;IR_sp_bytes_left
op_div
l_int|4
)braket
)paren
suffix:semicolon
id|bytes_left
op_sub_assign
id|ohci-&gt;IR_sp_bytes_left
suffix:semicolon
id|ohci-&gt;IR_sp_bytes_left
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* packet is being assembled */
r_if
c_cond
(paren
id|ohci-&gt;IR_sp_bytes_left
OG
id|bytes_left
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|ohci-&gt;IR_spb
(braket
id|ohci-&gt;IR_spb_bytes_used
op_div
l_int|4
)braket
comma
id|buf_ptr
comma
id|bytes_left
)paren
suffix:semicolon
id|ohci-&gt;IR_spb_bytes_used
op_add_assign
id|bytes_left
suffix:semicolon
id|ohci-&gt;IR_sp_bytes_left
op_sub_assign
id|bytes_left
suffix:semicolon
id|bytes_left
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|ohci-&gt;IR_spb
(braket
id|ohci-&gt;IR_spb_bytes_used
op_div
l_int|4
)braket
comma
id|buf_ptr
comma
id|ohci-&gt;IR_sp_bytes_left
)paren
suffix:semicolon
id|ohci-&gt;IR_spb_bytes_used
op_add_assign
id|ohci-&gt;IR_sp_bytes_left
suffix:semicolon
id|hpsb_packet_received
c_func
(paren
id|ohci-&gt;host
comma
id|ohci-&gt;IR_spb
comma
id|ohci-&gt;IR_spb_bytes_used
)paren
suffix:semicolon
id|buf_ptr
op_assign
id|bus_to_virt
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
(paren
(paren
id|quadlet_t
op_star
)paren
id|ohci-&gt;IR_recv_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|address
)paren
(braket
id|ohci-&gt;IR_sp_bytes_left
op_div
l_int|4
)braket
)paren
suffix:semicolon
id|bytes_left
op_sub_assign
id|ohci-&gt;IR_sp_bytes_left
suffix:semicolon
id|ohci-&gt;IR_sp_bytes_left
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;IR_spb_bytes_used
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|bytes_left
OG
l_int|0
)paren
(brace
id|data_length
op_assign
(paren
r_int
)paren
(paren
(paren
id|buf_ptr
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_length
op_mod
l_int|4
)paren
id|data_length
op_add_assign
l_int|4
op_minus
(paren
id|data_length
op_mod
l_int|4
)paren
suffix:semicolon
multiline_comment|/* is this a split packet? */
r_if
c_cond
(paren
(paren
id|bytes_left
op_minus
(paren
id|data_length
op_plus
l_int|8
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|data_length
op_plus
l_int|8
)paren
op_le
id|IR_SPLIT_PACKET_BUF_SIZE
)paren
(brace
id|memcpy
c_func
(paren
id|ohci-&gt;IR_spb
comma
id|buf_ptr
comma
id|bytes_left
)paren
suffix:semicolon
id|ohci-&gt;IR_spb_bytes_used
op_assign
id|bytes_left
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Packet too large for split packet buffer... dropping it&quot;
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;Header: %8.8x&bslash;n&quot;
comma
id|buf_ptr
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ohci-&gt;IR_spb_bytes_used
op_assign
l_int|0
suffix:semicolon
)brace
id|ohci-&gt;IR_sp_bytes_left
op_assign
(paren
id|data_length
op_plus
l_int|8
)paren
op_minus
id|bytes_left
suffix:semicolon
)brace
r_else
(brace
id|hpsb_packet_received
c_func
(paren
id|ohci-&gt;host
comma
id|buf_ptr
comma
(paren
id|data_length
op_plus
l_int|8
)paren
)paren
suffix:semicolon
id|buf_ptr
op_assign
id|bus_to_virt
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
(paren
(paren
id|quadlet_t
op_star
)paren
id|ohci-&gt;IR_recv_prg
(braket
id|idx
)braket
op_member_access_from_pointer
id|address
)paren
(braket
(paren
id|IR_RECV_BUF_SIZE
op_minus
id|bytes_left
op_plus
id|data_length
op_plus
l_int|8
)paren
op_div
l_int|4
)braket
)paren
suffix:semicolon
)brace
id|bytes_left
op_sub_assign
(paren
id|data_length
op_plus
l_int|8
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_recv_lock
comma
id|flags
)paren
suffix:semicolon
id|ohci-&gt;IR_buf_last_ind
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|IR_NUM_DESC
suffix:semicolon
id|ohci-&gt;IR_buf_used
op_decrement
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_recv_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|add_card
r_static
r_int
id|add_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
DECL|macro|FAIL
mdefine_line|#define FAIL(fmt, args...) &bslash;&n;&t;PRINT_G(KERN_ERR, fmt , ## args); &bslash;&n;&t;  num_of_cards--; &bslash;&n;&t;    remove_card(ohci); &bslash;&n;&t;      return 1;
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
multiline_comment|/* shortcut to currently handled device */
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|num_of_cards
op_eq
id|MAX_OHCI1394_CARDS
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;cannot handle more than %d cards.  &quot;
l_string|&quot;Adjust MAX_OHCI1394_CARDS in ti_ohci1394.h.&quot;
comma
id|MAX_OHCI1394_CARDS
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|ohci
op_assign
op_amp
id|cards
(braket
id|num_of_cards
op_increment
)braket
suffix:semicolon
id|ohci-&gt;id
op_assign
id|num_of_cards
op_minus
l_int|1
suffix:semicolon
id|ohci-&gt;dev
op_assign
id|dev
suffix:semicolon
id|ohci-&gt;state
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ohci_irq_handler
comma
id|SA_SHIRQ
comma
id|OHCI1394_DRIVER_NAME
comma
id|ohci
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;allocated interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate shared interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
multiline_comment|/* csr_config rom allocation */
id|ohci-&gt;csr_config_rom
op_assign
id|kmalloc
c_func
(paren
l_int|1024
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;csr_config_rom
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate buffer config rom&quot;
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|ohci-&gt;csr_config_rom
comma
id|ohci_csr_rom
comma
r_sizeof
(paren
id|ohci_csr_rom
)paren
)paren
suffix:semicolon
multiline_comment|/* self-id dma buffer allocation */
id|ohci-&gt;self_id_buffer
op_assign
id|kmalloc
c_func
(paren
l_int|2048
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;self_id_buffer
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate DMA buffer for self-id packets&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* AR dma buffer and program allocation */
id|ohci-&gt;AR_resp_buf
op_assign
id|kmalloc
c_func
(paren
id|AR_RESP_NUM_DESC
op_star
r_sizeof
(paren
id|quadlet_t
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_buf
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AR response receive DMA buffer&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;AR_resp_prg
op_assign
id|kmalloc
c_func
(paren
id|AR_RESP_NUM_DESC
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_prg
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AR response receive DMA program&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;AR_resp_spb
op_assign
id|kmalloc
c_func
(paren
id|AR_RESP_SPLIT_PACKET_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_spb
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AR response split packet buffer&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AR_RESP_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ohci-&gt;AR_resp_buf
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
id|AR_RESP_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_buf
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|ohci-&gt;AR_resp_buf
(braket
id|i
)braket
comma
l_int|0
comma
id|AR_RESP_BUF_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AR response DMA buffer&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AR response DMA buffer&quot;
)paren
suffix:semicolon
)brace
)brace
id|ohci-&gt;AR_resp_buf_th_ind
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;AR_resp_buf_th_offset
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;AR_resp_buf_bh_ind
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;AR_resp_buf_bh_offset
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;AR_resp_bytes_left
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;AR_resp_lock
)paren
suffix:semicolon
multiline_comment|/* initialize AR response receive task */
id|ohci-&gt;AR_resp_pdl_task.routine
op_assign
id|ohci_ar_resp_proc_desc
suffix:semicolon
id|ohci-&gt;AR_resp_pdl_task.data
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
multiline_comment|/* AT dma program allocation */
id|ohci-&gt;AT_req_prg
op_assign
(paren
r_struct
id|dma_cmd
op_star
)paren
id|kmalloc
c_func
(paren
id|AT_REQ_PRG_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;AT_req_prg
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|ohci-&gt;AT_req_prg
comma
l_int|0
comma
id|AT_REQ_PRG_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate AT request DMA program&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* IR dma buffer and program allocation */
id|ohci-&gt;IR_recv_buf
op_assign
id|kmalloc
c_func
(paren
id|IR_NUM_DESC
op_star
r_sizeof
(paren
id|quadlet_t
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;IR_recv_buf
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate IR receive DMA buffer&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;IR_recv_prg
op_assign
id|kmalloc
c_func
(paren
id|IR_NUM_DESC
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;IR_recv_prg
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate IR receive DMA program&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;IR_spb
op_assign
id|kmalloc
c_func
(paren
id|IR_SPLIT_PACKET_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;IR_spb
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate IR split packet buffer&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IR_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ohci-&gt;IR_recv_buf
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
id|IR_RECV_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;IR_recv_buf
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|ohci-&gt;IR_recv_buf
(braket
id|i
)braket
comma
l_int|0
comma
id|IR_RECV_BUF_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate IR DMA buffer&quot;
)paren
suffix:semicolon
)brace
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate IR DMA buffer&quot;
)paren
suffix:semicolon
)brace
)brace
id|ohci-&gt;IR_buf_used
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;IR_buf_last_ind
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;IR_buf_next_ind
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;IR_recv_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
)paren
suffix:semicolon
id|ohci-&gt;IR_channel_usage
op_assign
l_int|0x0000000000000000
suffix:semicolon
multiline_comment|/* initialize iso receive task */
id|ohci-&gt;IR_pdl_task.routine
op_assign
id|ohci_ir_proc_desc
suffix:semicolon
id|ohci-&gt;IR_pdl_task.data
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,13)
id|ohci-&gt;registers
op_assign
id|ioremap_nocache
c_func
(paren
id|dev-&gt;base_address
(braket
l_int|0
)braket
comma
id|OHCI1394_REGISTER_SIZE
)paren
suffix:semicolon
macro_line|#else
id|ohci-&gt;registers
op_assign
id|ioremap_nocache
c_func
(paren
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|OHCI1394_REGISTER_SIZE
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ohci-&gt;registers
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to remap registers - card not accessible&quot;
)paren
suffix:semicolon
)brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;remapped memory spaces reg 0x%p&quot;
comma
id|ohci-&gt;registers
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
DECL|macro|FAIL
macro_line|#undef FAIL
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|macro|SR
mdefine_line|#define SR(fmt, reg0, reg1, reg2)&bslash;&n;p += sprintf(p,fmt,reg_read(ohci, reg0),&bslash;&n;&t;       reg_read(ohci, reg1),reg_read(ohci, reg2));
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
DECL|function|ohci_get_status
r_static
r_int
id|ohci_get_status
c_func
(paren
r_char
op_star
id|buf
)paren
macro_line|#else
r_int
id|ohci_get_info
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|fpos
comma
r_int
id|length
comma
r_int
id|dummy
)paren
macro_line|#endif
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
op_amp
id|cards
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|ohci-&gt;host
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
singleline_comment|//unsigned char phyreg;
singleline_comment|//int i, nports;
r_int
id|i
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;IEEE-1394 OHCI Driver status report:&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;  bus number: 0x%x Node ID: 0x%x&bslash;n&quot;
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
op_amp
l_int|0xFFC0
)paren
op_rshift
l_int|6
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
op_amp
l_int|0x3f
)paren
suffix:semicolon
macro_line|#if 0
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;  hardware version %d.%d GUID_ROM is %s&bslash;n&bslash;n&quot;
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_Version
)paren
op_amp
l_int|0xFF0000
)paren
op_rshift
l_int|16
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_Version
)paren
op_amp
l_int|0xFF
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_Version
)paren
op_amp
l_int|0x01000000
)paren
ques
c_cond
l_string|&quot;set&quot;
suffix:colon
l_string|&quot;clear&quot;
)paren
suffix:semicolon
macro_line|#endif
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n### Host data ###&bslash;n&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;node_count: %8d  &quot;
comma
id|host-&gt;node_count
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;node_id   : %08X&bslash;n&quot;
comma
id|host-&gt;node_id
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;irm_id    : %08X  &quot;
comma
id|host-&gt;irm_id
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;busmgr_id : %08X&bslash;n&quot;
comma
id|host-&gt;busmgr_id
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%s %s %s&bslash;n&quot;
comma
id|host-&gt;initialized
ques
c_cond
l_string|&quot;initialized&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;in_bus_reset
ques
c_cond
l_string|&quot;in_bus_reset&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;attempt_root
ques
c_cond
l_string|&quot;attempt_root&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%s %s %s %s&bslash;n&quot;
comma
id|host-&gt;is_root
ques
c_cond
l_string|&quot;root&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;is_cycmst
ques
c_cond
l_string|&quot;cycle_master&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;is_irm
ques
c_cond
l_string|&quot;iso_res_mgr&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|host-&gt;is_busmgr
ques
c_cond
l_string|&quot;bus_mgr&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n---Iso Receive DMA---&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IR_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;IR_recv_buf[%d] : %p  IR_recv_prg[%d]: %p&bslash;n&quot;
comma
id|i
comma
id|ohci-&gt;IR_recv_buf
(braket
id|i
)braket
comma
id|i
comma
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n---Async Reponse Receive DMA---&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AR_RESP_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AR_resp_buf[%d] : %p  AR_resp_prg[%d]: %p&bslash;n&quot;
comma
id|i
comma
id|ohci-&gt;AR_resp_buf
(braket
id|i
)braket
comma
id|i
comma
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Current AR resp buf in irq handler: %d offset: %d&bslash;n&quot;
comma
id|ohci-&gt;AR_resp_buf_th_ind
comma
id|ohci-&gt;AR_resp_buf_th_offset
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Current AR resp buf in bottom half: %d offset: %d&bslash;n&quot;
comma
id|ohci-&gt;AR_resp_buf_bh_ind
comma
id|ohci-&gt;AR_resp_buf_bh_offset
)paren
suffix:semicolon
multiline_comment|/* ----- Register Dump ----- */
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n### HC Register dump ###&bslash;n&quot;
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;Version     : %08x  GUID_ROM    : %08x  ATRetries   : %08x&bslash;n&quot;
comma
id|OHCI1394_Version
comma
id|OHCI1394_GUID_ROM
comma
id|OHCI1394_ATRetries
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;CSRReadData : %08x  CSRCompData : %08x  CSRControl  : %08x&bslash;n&quot;
comma
id|OHCI1394_CSRReadData
comma
id|OHCI1394_CSRCompareData
comma
id|OHCI1394_CSRControl
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;ConfigROMhdr: %08x  BusID       : %08x  BusOptions  : %08x&bslash;n&quot;
comma
id|OHCI1394_ConfigROMhdr
comma
id|OHCI1394_BusID
comma
id|OHCI1394_BusOptions
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;GUIDHi      : %08x  GUIDLo      : %08x  ConfigROMmap: %08x&bslash;n&quot;
comma
id|OHCI1394_GUIDHi
comma
id|OHCI1394_GUIDLo
comma
id|OHCI1394_ConfigROMmap
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;PtdWrAddrLo : %08x  PtdWrAddrHi : %08x  VendorID    : %08x&bslash;n&quot;
comma
id|OHCI1394_PostedWriteAddressLo
comma
id|OHCI1394_PostedWriteAddressHi
comma
id|OHCI1394_VendorID
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;HCControl   : %08x  SelfIDBuffer: %08x  SelfIDCount : %08x&bslash;n&quot;
comma
id|OHCI1394_HCControlSet
comma
id|OHCI1394_SelfIDBuffer
comma
id|OHCI1394_SelfIDCount
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;IRMuChMaskHi: %08x  IRMuChMaskLo: %08x  IntEvent    : %08x&bslash;n&quot;
comma
id|OHCI1394_IRMultiChanMaskHiSet
comma
id|OHCI1394_IRMultiChanMaskLoSet
comma
id|OHCI1394_IntEventSet
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;IntMask     : %08x  IsoXmIntEvnt: %08x  IsoXmIntMask: %08x&bslash;n&quot;
comma
id|OHCI1394_IntMaskSet
comma
id|OHCI1394_IsoXmitIntEventSet
comma
id|OHCI1394_IsoXmitIntMaskSet
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;IsoRcvIntEvt: %08x  IsoRcvIntMsk: %08x  FairnessCtrl: %08x&bslash;n&quot;
comma
id|OHCI1394_IsoRecvIntEventSet
comma
id|OHCI1394_IsoRecvIntMaskSet
comma
id|OHCI1394_FairnessControl
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;LinkControl : %08x  NodeID      : %08x  PhyControl  : %08x&bslash;n&quot;
comma
id|OHCI1394_LinkControlSet
comma
id|OHCI1394_NodeID
comma
id|OHCI1394_PhyControl
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;IsoCyclTimer: %08x  AsRqFilterHi: %08x  AsRqFilterLo: %08x&bslash;n&quot;
comma
id|OHCI1394_IsochronousCycleTimer
comma
id|OHCI1394_AsReqFilterHiSet
comma
id|OHCI1394_AsReqFilterLoSet
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;PhyReqFiltHi: %08x  PhyReqFiltLo: %08x  PhyUpperBnd : %08x&bslash;n&quot;
comma
id|OHCI1394_PhyReqFilterHiSet
comma
id|OHCI1394_PhyReqFilterLoSet
comma
id|OHCI1394_PhyUpperBound
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;AsRqTrCxtCtl: %08x  AsRqTrCmdPtr: %08x  AsRsTrCtxCtl: %08x&bslash;n&quot;
comma
id|OHCI1394_AsReqTrContextControlSet
comma
id|OHCI1394_AsReqTrCommandPtr
comma
id|OHCI1394_AsRspTrContextControlSet
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;AsRsTrCmdPtr: %08x  AsRqRvCtxCtl: %08x  AsRqRvCmdPtr: %08x&bslash;n&quot;
comma
id|OHCI1394_AsRspTrCommandPtr
comma
id|OHCI1394_AsReqRcvContextControlSet
comma
id|OHCI1394_AsReqRcvCommandPtr
)paren
suffix:semicolon
id|SR
c_func
(paren
l_string|&quot;AsRsRvCtxCtl: %08x  AsRsRvCmdPtr: %08x  IntEvent    : %08x&bslash;n&quot;
comma
id|OHCI1394_AsRspRcvContextControlSet
comma
id|OHCI1394_AsRspRcvCommandPtr
comma
id|OHCI1394_IntEventSet
)paren
suffix:semicolon
macro_line|#if 0
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n### Phy Register dump ###&bslash;n&quot;
)paren
suffix:semicolon
id|phyreg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;offset: %d val: 0x%02x -&gt; RHB: %d IBR: %d Gap_count: %d&bslash;n&quot;
comma
l_int|1
comma
id|phyreg
comma
(paren
id|phyreg
op_amp
l_int|0x80
)paren
op_ne
l_int|0
comma
(paren
id|phyreg
op_amp
l_int|0x40
)paren
op_ne
l_int|0
comma
id|phyreg
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|phyreg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|2
)paren
suffix:semicolon
id|nports
op_assign
id|phyreg
op_amp
l_int|0x1f
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;offset: %d val: 0x%02x -&gt; SPD: %d E  : %d Ports    : %2d&bslash;n&quot;
comma
l_int|2
comma
id|phyreg
comma
(paren
id|phyreg
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
comma
(paren
id|phyreg
op_amp
l_int|0x20
)paren
op_ne
l_int|0
comma
id|nports
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nports
suffix:semicolon
id|i
op_increment
)paren
(brace
id|phyreg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|3
op_plus
id|i
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;offset: %d val: 0x%02x -&gt; [port %d] TPA: %d TPB: %d | %s %s&bslash;n&quot;
comma
l_int|3
op_plus
id|i
comma
id|phyreg
comma
id|i
comma
(paren
id|phyreg
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
comma
(paren
id|phyreg
op_amp
l_int|0x30
)paren
op_rshift
l_int|4
comma
(paren
id|phyreg
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot;child&quot;
suffix:colon
l_string|&quot;parent&quot;
comma
(paren
id|phyreg
op_amp
l_int|0x04
)paren
ques
c_cond
l_string|&quot;connected&quot;
suffix:colon
l_string|&quot;disconnected&quot;
)paren
suffix:semicolon
)brace
id|phyreg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|3
op_plus
id|i
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;offset: %d val: 0x%02x -&gt; ENV: %s Reg_count: %d&bslash;n&quot;
comma
l_int|3
op_plus
id|i
comma
id|phyreg
comma
(paren
(paren
(paren
id|phyreg
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_string|&quot;backplane&quot;
suffix:colon
(paren
(paren
(paren
id|phyreg
op_amp
l_int|0xC0
)paren
op_rshift
l_int|6
)paren
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;cable&quot;
suffix:colon
l_string|&quot;reserved&quot;
comma
id|phyreg
op_amp
l_int|0x3f
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AR_resp_prg ctrl: %08x&bslash;n&quot;
comma
id|ohci-&gt;AR_resp_prg-&gt;control
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;AR_resp_prg status: %08x&bslash;n&quot;
comma
id|ohci-&gt;AR_resp_prg-&gt;status
)paren
suffix:semicolon
macro_line|#endif
r_return
id|p
op_minus
id|buf
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
DECL|function|ohci1394_read_proc
r_static
r_int
id|ohci1394_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
id|ohci_get_status
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#else
DECL|variable|ohci_proc_entry
r_struct
id|proc_dir_entry
id|ohci_proc_entry
op_assign
(brace
l_int|0
comma
multiline_comment|/* Inode number - dynamic */
l_int|8
comma
multiline_comment|/* Length of the file name */
l_string|&quot;ohci1394&quot;
comma
multiline_comment|/* The file name */
id|S_IFREG
op_or
id|S_IRUGO
comma
multiline_comment|/* File mode */
l_int|1
comma
multiline_comment|/* Number of links */
l_int|0
comma
l_int|0
comma
multiline_comment|/* The uid and gid for the file */
l_int|0
comma
multiline_comment|/* The size of the file reported by ls. */
l_int|NULL
comma
multiline_comment|/* functions which can be done on the inode */
id|ohci_get_info
comma
multiline_comment|/* The read function for this file */
l_int|NULL
)brace
suffix:semicolon
macro_line|#endif /* LINUX_VERSION_CODE */
macro_line|#endif /* CONFIG_PROC_FS */
DECL|function|remove_card
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;registers
)paren
id|iounmap
c_func
(paren
id|ohci-&gt;registers
)paren
suffix:semicolon
multiline_comment|/* Free AR response buffers and programs */
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_buf
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AR_RESP_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kfree
c_func
(paren
id|ohci-&gt;AR_resp_buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ohci-&gt;AR_resp_buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;AR_resp_prg
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AR_RESP_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kfree
c_func
(paren
id|ohci-&gt;AR_resp_prg
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ohci-&gt;AR_resp_prg
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ohci-&gt;AR_resp_spb
)paren
suffix:semicolon
multiline_comment|/* Free AT request buffer and program */
r_if
c_cond
(paren
id|ohci-&gt;AT_req_prg
)paren
id|kfree
c_func
(paren
id|ohci-&gt;AT_req_prg
)paren
suffix:semicolon
multiline_comment|/* Free Iso receive buffers and programs */
r_if
c_cond
(paren
id|ohci-&gt;IR_recv_buf
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IR_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kfree
c_func
(paren
id|ohci-&gt;IR_recv_buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ohci-&gt;IR_recv_buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;IR_recv_prg
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IR_NUM_DESC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kfree
c_func
(paren
id|ohci-&gt;IR_recv_prg
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ohci-&gt;IR_recv_prg
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ohci-&gt;IR_spb
)paren
suffix:semicolon
multiline_comment|/* Free self-id buffer */
r_if
c_cond
(paren
id|ohci-&gt;self_id_buffer
)paren
id|kfree
c_func
(paren
id|ohci-&gt;self_id_buffer
)paren
suffix:semicolon
multiline_comment|/* Free config rom */
r_if
c_cond
(paren
id|ohci-&gt;csr_config_rom
)paren
id|kfree
c_func
(paren
id|ohci-&gt;csr_config_rom
)paren
suffix:semicolon
multiline_comment|/* Free the IRQ */
id|free_irq
c_func
(paren
id|ohci-&gt;dev-&gt;irq
comma
id|ohci
)paren
suffix:semicolon
id|ohci-&gt;state
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|init_driver
r_static
r_int
id|init_driver
c_func
(paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|success
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|num_of_cards
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_DEBUG
comma
id|__PRETTY_FUNCTION__
l_string|&quot; called again&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;looking for Ohci1394 cards&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|supported_chips
(braket
id|i
)braket
(braket
l_int|0
)braket
op_ne
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|supported_chips
(braket
id|i
)braket
(braket
l_int|0
)braket
comma
id|supported_chips
(braket
id|i
)braket
(braket
l_int|1
)braket
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|add_card
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|success
op_eq
l_int|0
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;no operable Ohci1394 cards found&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
id|create_proc_read_entry
(paren
l_string|&quot;ohci1394&quot;
comma
l_int|0
comma
l_int|NULL
comma
id|ohci1394_read_proc
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|proc_register
c_func
(paren
op_amp
id|proc_root
comma
op_amp
id|ohci_proc_entry
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;unable to register proc file&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_ohci_rom
r_static
r_int
id|get_ohci_rom
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_const
id|quadlet_t
op_star
op_star
id|ptr
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
macro_line|#if 0
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request csr_rom address: %08X&quot;
comma
(paren
id|u32
)paren
id|ohci-&gt;csr_config_rom
)paren
suffix:semicolon
macro_line|#endif
op_star
id|ptr
op_assign
id|ohci-&gt;csr_config_rom
suffix:semicolon
r_return
r_sizeof
(paren
id|ohci_csr_rom
)paren
suffix:semicolon
)brace
DECL|function|get_ohci_template
r_struct
id|hpsb_host_template
op_star
id|get_ohci_template
c_func
(paren
r_void
)paren
(brace
r_static
r_struct
id|hpsb_host_template
id|tmpl
suffix:semicolon
r_static
r_int
id|initialized
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|initialized
)paren
(brace
multiline_comment|/* Initialize by field names so that a template structure&n;&t;&t; * reorganization does not influence this code. */
id|tmpl.name
op_assign
l_string|&quot;ohci1394&quot;
suffix:semicolon
id|tmpl.detect_hosts
op_assign
id|ohci_detect
suffix:semicolon
id|tmpl.initialize_host
op_assign
id|ohci_initialize
suffix:semicolon
id|tmpl.release_host
op_assign
id|ohci_remove
suffix:semicolon
id|tmpl.get_rom
op_assign
id|get_ohci_rom
suffix:semicolon
id|tmpl.transmit_packet
op_assign
id|ohci_transmit
suffix:semicolon
id|tmpl.devctl
op_assign
id|ohci_devctl
suffix:semicolon
id|initialized
op_assign
l_int|1
suffix:semicolon
)brace
r_return
op_amp
id|tmpl
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* EXPORT_NO_SYMBOLS; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;driver for PCI Ohci IEEE-1394 controller&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;ohci1394&quot;
)paren
suffix:semicolon
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|hpsb_unregister_lowlevel
c_func
(paren
id|get_ohci_template
c_func
(paren
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,3,0)
id|remove_proc_entry
(paren
l_string|&quot;ohci1394&quot;
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#else
id|proc_unregister
c_func
(paren
op_amp
id|proc_root
comma
id|ohci_proc_entry.low_ino
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;removed &quot;
id|OHCI1394_DRIVER_NAME
l_string|&quot; module&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|hpsb_register_lowlevel
c_func
(paren
id|get_ohci_template
c_func
(paren
)paren
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;registering failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
eof
