multiline_comment|/*&n; * IEEE 1394 for Linux&n; *&n; * Low level (host adapter) management.&n; *&n; * Copyright (C) 1999 Andreas E. Bombe&n; * Copyright (C) 1999 Emanuel Pirker&n; *&n; * This code is licensed under the GPL.  See the file COPYING in the root&n; * directory of the kernel sources for details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;highlevel.h&quot;
DECL|variable|templates
r_static
r_struct
id|hpsb_host_template
op_star
id|templates
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|templates_lock
id|spinlock_t
id|templates_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * This function calls the add_host/remove_host hooks for every host currently&n; * registered.  Init == TRUE means add_host.&n; */
DECL|function|hl_all_hosts
r_void
id|hl_all_hosts
c_func
(paren
r_struct
id|hpsb_highlevel
op_star
id|hl
comma
r_int
id|init
)paren
(brace
r_struct
id|hpsb_host_template
op_star
id|tmpl
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|templates_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tmpl
op_assign
id|templates
suffix:semicolon
id|tmpl
op_ne
l_int|NULL
suffix:semicolon
id|tmpl
op_assign
id|tmpl-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|host
op_assign
id|tmpl-&gt;hosts
suffix:semicolon
id|host
op_ne
l_int|NULL
suffix:semicolon
id|host
op_assign
id|host-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;initialized
)paren
(brace
r_if
c_cond
(paren
id|init
)paren
(brace
r_if
c_cond
(paren
id|hl-&gt;op-&gt;add_host
)paren
(brace
id|hl-&gt;op
op_member_access_from_pointer
id|add_host
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|hl-&gt;op-&gt;remove_host
)paren
(brace
id|hl-&gt;op
op_member_access_from_pointer
id|remove_host
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|templates_lock
)paren
suffix:semicolon
)brace
DECL|function|hpsb_inc_host_usage
r_int
id|hpsb_inc_host_usage
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|hpsb_host_template
op_star
id|tmpl
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|h
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|templates_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tmpl
op_assign
id|templates
suffix:semicolon
(paren
id|tmpl
op_ne
l_int|NULL
)paren
op_logical_and
op_logical_neg
id|retval
suffix:semicolon
id|tmpl
op_assign
id|tmpl-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|h
op_assign
id|tmpl-&gt;hosts
suffix:semicolon
id|h
op_ne
l_int|NULL
suffix:semicolon
id|h
op_assign
id|h-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|h
op_eq
id|host
)paren
(brace
id|tmpl
op_member_access_from_pointer
id|devctl
c_func
(paren
id|h
comma
id|MODIFY_USAGE
comma
l_int|1
)paren
suffix:semicolon
id|retval
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|templates_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hpsb_dec_host_usage
r_void
id|hpsb_dec_host_usage
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
id|host
op_member_access_from_pointer
r_template
op_member_access_from_pointer
id|devctl
c_func
(paren
id|host
comma
id|MODIFY_USAGE
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The following function is exported for module usage.  It will be called from&n; * the detect function of a adapter driver.&n; */
DECL|function|hpsb_get_host
r_struct
id|hpsb_host
op_star
id|hpsb_get_host
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
comma
r_int
id|hd_size
)paren
(brace
r_struct
id|hpsb_host
op_star
id|h
suffix:semicolon
id|h
op_assign
id|vmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hpsb_host
)paren
op_plus
id|hd_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|h
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hpsb_host
)paren
op_plus
id|hd_size
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|h-&gt;pending_packets
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|h-&gt;pending_pkt_lock
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|h-&gt;tlabel_count
comma
l_int|64
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|h-&gt;tlabel_lock
)paren
suffix:semicolon
id|h-&gt;timeout_tq.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|abort_timedouts
suffix:semicolon
id|h-&gt;timeout_tq.data
op_assign
id|h
suffix:semicolon
id|h-&gt;topology_map
op_assign
id|h-&gt;csr.topology_map
op_plus
l_int|3
suffix:semicolon
id|h-&gt;speed_map
op_assign
(paren
id|u8
op_star
)paren
(paren
id|h-&gt;csr.speed_map
op_plus
l_int|2
)paren
suffix:semicolon
id|h
op_member_access_from_pointer
r_template
op_assign
id|tmpl
suffix:semicolon
r_if
c_cond
(paren
id|hd_size
)paren
(brace
id|h-&gt;hostdata
op_assign
op_amp
id|h-&gt;embedded_hostdata
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmpl-&gt;hosts
op_eq
l_int|NULL
)paren
(brace
id|tmpl-&gt;hosts
op_assign
id|h
suffix:semicolon
)brace
r_else
(brace
r_struct
id|hpsb_host
op_star
id|last
op_assign
id|tmpl-&gt;hosts
suffix:semicolon
r_while
c_loop
(paren
id|last-&gt;next
op_ne
l_int|NULL
)paren
(brace
id|last
op_assign
id|last-&gt;next
suffix:semicolon
)brace
id|last-&gt;next
op_assign
id|h
suffix:semicolon
)brace
r_return
id|h
suffix:semicolon
)brace
DECL|function|free_all_hosts
r_static
r_void
id|free_all_hosts
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
r_struct
id|hpsb_host
op_star
id|next
comma
op_star
id|host
op_assign
id|tmpl-&gt;hosts
suffix:semicolon
r_while
c_loop
(paren
id|host
)paren
(brace
id|next
op_assign
id|host-&gt;next
suffix:semicolon
id|vfree
c_func
(paren
id|host
)paren
suffix:semicolon
id|host
op_assign
id|next
suffix:semicolon
)brace
)brace
DECL|function|init_hosts
r_static
r_void
id|init_hosts
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
r_int
id|count
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
id|count
op_assign
id|tmpl
op_member_access_from_pointer
id|detect_hosts
c_func
(paren
id|tmpl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|host
op_assign
id|tmpl-&gt;hosts
suffix:semicolon
id|host
op_ne
l_int|NULL
suffix:semicolon
id|host
op_assign
id|host-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|tmpl
op_member_access_from_pointer
id|initialize_host
c_func
(paren
id|host
)paren
)paren
(brace
id|host-&gt;initialized
op_assign
l_int|1
suffix:semicolon
id|highlevel_add_host
c_func
(paren
id|host
)paren
suffix:semicolon
id|hpsb_reset_bus
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
id|tmpl-&gt;number_of_hosts
op_assign
id|count
suffix:semicolon
id|HPSB_INFO
c_func
(paren
l_string|&quot;detected %d %s adapter%c&quot;
comma
id|count
comma
id|tmpl-&gt;name
comma
(paren
id|count
op_ne
l_int|1
ques
c_cond
l_char|&squot;s&squot;
suffix:colon
l_char|&squot; &squot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|shutdown_hosts
r_static
r_void
id|shutdown_hosts
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
r_for
c_loop
(paren
id|host
op_assign
id|tmpl-&gt;hosts
suffix:semicolon
id|host
op_ne
l_int|NULL
suffix:semicolon
id|host
op_assign
id|host-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;initialized
)paren
(brace
id|host-&gt;initialized
op_assign
l_int|0
suffix:semicolon
id|abort_requests
c_func
(paren
id|host
)paren
suffix:semicolon
id|highlevel_remove_host
c_func
(paren
id|host
)paren
suffix:semicolon
id|tmpl
op_member_access_from_pointer
id|release_host
c_func
(paren
id|host
)paren
suffix:semicolon
r_while
c_loop
(paren
id|test_bit
c_func
(paren
l_int|0
comma
op_amp
id|host-&gt;timeout_tq.sync
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|free_all_hosts
c_func
(paren
id|tmpl
)paren
suffix:semicolon
id|tmpl
op_member_access_from_pointer
id|release_host
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|tmpl-&gt;number_of_hosts
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|add_template
r_static
r_int
id|add_template
c_func
(paren
r_struct
id|hpsb_host_template
op_star
r_new
)paren
(brace
r_new
op_member_access_from_pointer
id|next
op_assign
l_int|NULL
suffix:semicolon
r_new
op_member_access_from_pointer
id|hosts
op_assign
l_int|NULL
suffix:semicolon
r_new
op_member_access_from_pointer
id|number_of_hosts
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|templates_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|templates
op_eq
l_int|NULL
)paren
(brace
id|templates
op_assign
r_new
suffix:semicolon
)brace
r_else
(brace
r_struct
id|hpsb_host_template
op_star
id|last
op_assign
id|templates
suffix:semicolon
r_while
c_loop
(paren
id|last-&gt;next
op_ne
l_int|NULL
)paren
(brace
id|last
op_assign
id|last-&gt;next
suffix:semicolon
)brace
id|last-&gt;next
op_assign
r_new
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|templates_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|remove_template
r_static
r_int
id|remove_template
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tmpl-&gt;number_of_hosts
)paren
(brace
id|HPSB_ERR
c_func
(paren
l_string|&quot;attempted to remove busy host template &quot;
l_string|&quot;of %s at address 0x%p&quot;
comma
id|tmpl-&gt;name
comma
id|tmpl
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|templates_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|templates
op_eq
id|tmpl
)paren
(brace
id|templates
op_assign
id|tmpl-&gt;next
suffix:semicolon
)brace
r_else
(brace
r_struct
id|hpsb_host_template
op_star
id|t
suffix:semicolon
id|t
op_assign
id|templates
suffix:semicolon
r_while
c_loop
(paren
id|t-&gt;next
op_ne
id|tmpl
op_logical_and
id|t-&gt;next
op_ne
l_int|NULL
)paren
(brace
id|t
op_assign
id|t-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|t-&gt;next
op_eq
l_int|NULL
)paren
(brace
id|HPSB_ERR
c_func
(paren
l_string|&quot;attempted to remove unregistered host template &quot;
l_string|&quot;of %s at address 0x%p&quot;
comma
id|tmpl-&gt;name
comma
id|tmpl
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|t-&gt;next
op_assign
id|tmpl-&gt;next
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|templates_lock
)paren
suffix:semicolon
id|inc_hpsb_generation
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * The following two functions are exported symbols for module usage.&n; */
DECL|function|hpsb_register_lowlevel
r_int
id|hpsb_register_lowlevel
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
id|add_template
c_func
(paren
id|tmpl
)paren
suffix:semicolon
id|HPSB_INFO
c_func
(paren
l_string|&quot;registered %s driver, initializing now&quot;
comma
id|tmpl-&gt;name
)paren
suffix:semicolon
id|init_hosts
c_func
(paren
id|tmpl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpsb_unregister_lowlevel
r_void
id|hpsb_unregister_lowlevel
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
id|shutdown_hosts
c_func
(paren
id|tmpl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remove_template
c_func
(paren
id|tmpl
)paren
)paren
(brace
id|HPSB_PANIC
c_func
(paren
l_string|&quot;remove_template failed on %s&quot;
comma
id|tmpl-&gt;name
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifndef MODULE
multiline_comment|/*&n; * This is the init function for builtin lowlevel drivers.  To add new drivers&n; * put their setup code (get and register template) here.  Module only&n; * drivers don&squot;t need to touch this.&n; */
DECL|macro|SETUP_TEMPLATE
mdefine_line|#define SETUP_TEMPLATE(name, visname) &bslash;&n;do {                                                                       &bslash;&n;        extern struct hpsb_host_template *get_ ## name ## _template(void); &bslash;&n;        t = get_ ## name ## _template();                                   &bslash;&n;                                                                           &bslash;&n;        if (t != NULL) {                                                   &bslash;&n;                if(!hpsb_register_lowlevel(t)) {                           &bslash;&n;                        count++;                                           &bslash;&n;                }                                                          &bslash;&n;        } else {                                                           &bslash;&n;                HPSB_WARN(visname &quot; driver returned no host template&quot;);    &bslash;&n;        }                                                                  &bslash;&n;} while (0)
DECL|function|register_builtin_lowlevels
r_void
id|__init
id|register_builtin_lowlevels
c_func
(paren
)paren
(brace
r_struct
id|hpsb_host_template
op_star
id|t
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Touch t to avoid warning if no drivers are configured to&n;         * be built directly into the kernel. */
id|t
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX
id|SETUP_TEMPLATE
c_func
(paren
id|lynx
comma
l_string|&quot;Lynx&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IEEE1394_AIC5800
id|SETUP_TEMPLATE
c_func
(paren
id|aic
comma
l_string|&quot;AIC-5800&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IEEE1394_OHCI1394
id|SETUP_TEMPLATE
c_func
(paren
id|ohci
comma
l_string|&quot;OHCI-1394&quot;
)paren
suffix:semicolon
macro_line|#endif
id|HPSB_INFO
c_func
(paren
l_string|&quot;%d host adapter%s initialized&quot;
comma
id|count
comma
(paren
id|count
op_ne
l_int|1
ques
c_cond
l_string|&quot;s&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|macro|SETUP_TEMPLATE
macro_line|#undef SETUP_TEMPLATE
macro_line|#endif /* !MODULE */
eof
