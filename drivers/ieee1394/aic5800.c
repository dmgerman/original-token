multiline_comment|/*&n; * +++ THIS DRIVER IS ORPHANED AND UNSUPPORTED +++&n; *&n; * aic5800.c - Adaptec AIC-5800 PCI-IEEE1394 chip driver&n; * Copyright (C)1999 Emanuel Pirker &lt;epirker@edu.uni-klu.ac.at&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;aic5800.h&quot;
singleline_comment|/// print general (card independent) information 
DECL|macro|PRINT_G
mdefine_line|#define PRINT_G(level, fmt, args...) printk(level &quot;aic5800: &quot; fmt &quot;&bslash;n&quot; , ## args)
singleline_comment|/// print card specific information 
DECL|macro|PRINT
mdefine_line|#define PRINT(level, card, fmt, args...) printk(level &quot;aic5800-%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
singleline_comment|/// card array 
DECL|variable|cards
r_static
r_struct
id|aic5800
id|cards
(braket
id|MAX_AIC5800_CARDS
)braket
suffix:semicolon
singleline_comment|/// holds the number of installed aic5800 cards
DECL|variable|num_of_cards
r_static
r_int
id|num_of_cards
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|add_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|aic5800
op_star
id|aic
)paren
suffix:semicolon
r_static
r_int
id|init_driver
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*****************************************************************&n; * Auxiliary functions needed to read the EEPROM&n; * Daniel Minitti&n; *****************************************************************/
DECL|macro|SEEPDOUT
mdefine_line|#define SEEPDOUT        0x1
DECL|macro|SEEPDIN
mdefine_line|#define SEEPDIN 0x02
DECL|macro|SEEPSK
mdefine_line|#define SEEPSK  0x04
DECL|macro|SEEPCS
mdefine_line|#define SEEPCS  0x08
DECL|macro|SEEPCYC
mdefine_line|#define SEEPCYC 0x10
DECL|macro|SEEPBUSY
mdefine_line|#define SEEPBUSY        0x20
DECL|macro|CLOCK_PULSE
mdefine_line|#define CLOCK_PULSE() {&bslash;&n;        int cnt=200;&bslash;&n;        while(cnt--&gt;0 &amp;&amp; reg_read(aic, misc_SEEPCTL) &amp; SEEPBUSY);&bslash;&n;        if (reg_read(aic, misc_SEEPCTL) &amp; SEEPBUSY) printk(&quot;BUSY &quot;);&bslash;&n;        }
DECL|function|read_seeprom_word
r_static
r_inline
r_int
r_int
id|read_seeprom_word
c_func
(paren
r_struct
id|aic5800
op_star
id|aic
comma
r_int
id|offset
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
id|temp
suffix:semicolon
r_int
r_char
id|read_cmd
(braket
l_int|3
)braket
op_assign
(brace
l_int|1
comma
l_int|1
comma
l_int|0
)brace
suffix:semicolon
r_int
r_int
id|rd
suffix:semicolon
singleline_comment|// send chip select for one clock cycle.
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|SEEPSK
op_or
id|SEEPCS
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// write start bit (1) &amp; READ op-code (10b)
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|read_cmd
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp
op_assign
id|SEEPCS
op_or
id|SEEPCYC
op_or
id|read_cmd
(braket
id|i
)braket
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|temp
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
id|temp
op_assign
id|temp
op_xor
id|SEEPSK
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|temp
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
)brace
singleline_comment|// write 8 bit address (MSB --&gt; LSB)
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|temp
op_assign
id|offset
suffix:semicolon
id|temp
op_assign
(paren
id|temp
op_rshift
id|i
)paren
op_amp
l_int|1
suffix:semicolon
id|temp
op_assign
id|SEEPCS
op_or
id|SEEPCYC
op_or
id|temp
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|temp
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
id|temp
op_assign
id|temp
op_xor
id|SEEPSK
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|temp
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
)brace
singleline_comment|// read 16 bit (MSB --&gt; LSB)
id|rd
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp
op_assign
id|SEEPCS
op_or
id|SEEPCYC
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|temp
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
id|temp
op_assign
id|temp
op_xor
id|SEEPSK
suffix:semicolon
id|rd
op_assign
(paren
id|rd
op_lshift
l_int|1
)paren
op_or
(paren
r_int
r_int
)paren
(paren
(paren
id|reg_read
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
)paren
op_amp
id|SEEPDIN
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|temp
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
)brace
singleline_comment|// reset chip select for the next command cycle
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|SEEPCYC
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|SEEPCYC
op_or
id|SEEPSK
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
id|SEEPCYC
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
comma
l_int|0
)paren
suffix:semicolon
id|CLOCK_PULSE
c_func
(paren
)paren
suffix:semicolon
r_return
id|rd
suffix:semicolon
)brace
DECL|macro|DEBUG_SEEPROM
macro_line|#undef DEBUG_SEEPROM
multiline_comment|/** Read 64-bit GUID (Global Unique ID) from SEEPROM&n; *&n; * It works well on AHA-8945.&n; * On AHA-8920 it works well only on first time, It returns ffff... on&n; * the other times.&n; *****************************************************************/
DECL|function|read_guid
r_static
r_int
r_int
r_int
id|read_guid
c_func
(paren
r_struct
id|aic5800
op_star
id|aic
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
r_int
id|guid
suffix:semicolon
macro_line|#ifdef DEBUG_SEEPROM
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SEEPCTL value = 0x%x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* read GUID */
id|guid
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0x10
suffix:semicolon
id|i
OL
l_int|0x14
suffix:semicolon
id|i
op_increment
)paren
id|guid
op_assign
(paren
id|guid
op_lshift
l_int|16
)paren
op_or
id|read_seeprom_word
c_func
(paren
id|aic
comma
id|i
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SEEPROM
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
(paren
r_int
r_int
)paren
id|read_seeprom_word
c_func
(paren
id|aic
comma
id|i
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;nGUID = &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|3
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
(paren
r_int
r_int
)paren
(paren
id|guid
op_rshift
(paren
l_int|16
op_star
id|i
)paren
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;nSEEPCTL value = 0x%x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|aic
comma
id|misc_SEEPCTL
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|guid
suffix:semicolon
)brace
DECL|macro|CLOCK_PULSE
macro_line|#undef CLOCK_PULSE()
DECL|function|aic_detect
r_static
r_int
id|aic_detect
c_func
(paren
r_struct
id|hpsb_host_template
op_star
id|tmpl
)paren
(brace
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
r_int
id|i
suffix:semicolon
id|init_driver
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_of_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|host
op_assign
id|hpsb_get_host
c_func
(paren
id|tmpl
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* simply don&squot;t init more after out of mem */
r_return
id|i
suffix:semicolon
)brace
id|host-&gt;hostdata
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
id|cards
(braket
id|i
)braket
dot
id|host
op_assign
id|host
suffix:semicolon
)brace
r_return
id|num_of_cards
suffix:semicolon
)brace
DECL|function|aic_devctl
r_static
r_int
id|aic_devctl
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_enum
id|devctl_cmd
id|cmd
comma
r_int
id|arg
)paren
(brace
r_struct
id|aic5800
op_star
id|aic
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
comma
op_star
id|lastpacket
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RESET_BUS
suffix:colon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_PhyControl
comma
l_int|0x00004140
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GET_CYCLE_COUNTER
suffix:colon
id|arg
op_assign
id|reg_read
c_func
(paren
id|aic
comma
id|misc_CycleTimer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_CYCLE_COUNTER
suffix:colon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_CycleTimer
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_BUS_ID
suffix:colon
id|reg_clear_bits
c_func
(paren
id|aic
comma
id|misc_NodeID
comma
l_int|0xFFC0
)paren
suffix:semicolon
id|reg_set_bits
c_func
(paren
id|aic
comma
id|misc_NodeID
comma
(paren
id|arg
op_lshift
l_int|6
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT_CYCLE_MASTER
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
multiline_comment|/* enable cycleMaster */
id|reg_set_bits
c_func
(paren
id|aic
comma
id|misc_Control
comma
l_int|0x20000
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* disable cycleMaster */
id|reg_clear_bits
c_func
(paren
id|aic
comma
id|misc_Control
comma
l_int|0x20000
)paren
suffix:semicolon
)brace
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CANCEL_REQUESTS
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|aic-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* stop any chip activity */
id|reg_write
c_func
(paren
id|aic
comma
id|AT_ChannelControl
comma
l_int|0x80000000
)paren
suffix:semicolon
id|packet
op_assign
id|aic-&gt;async_queue
suffix:semicolon
id|aic-&gt;async_queue
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|aic-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|packet
op_ne
l_int|NULL
)paren
(brace
id|lastpacket
op_assign
id|packet
suffix:semicolon
id|packet
op_assign
id|packet-&gt;xnext
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|lastpacket
comma
id|ACKX_ABORTED
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MODIFY_USAGE
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#if 0
r_case
id|DEBUG_DUMPINFO
suffix:colon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
id|AIC5800_DRIVER_NAME
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;  Register MMIO base: 0x%p&bslash;n&quot;
comma
id|aic-&gt;registers
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;  NodeID: 0x%x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|aic
comma
id|misc_NodeID
)paren
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;  #Intr: %lu  BusResets: %lu&bslash;n&quot;
comma
id|aic-&gt;NumInterrupts
comma
id|aic-&gt;NumBusResets
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;  TxPackets: %lu    RxPackets: %lu&bslash;n&quot;
comma
id|aic-&gt;TxPackets
comma
id|aic-&gt;RxPackets
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;  TxRdy: %lu  ATErr: %lu HdrErr: %lu TcodeErr: %lu SendRej: %lu&bslash;n&quot;
comma
id|aic-&gt;TxRdy
comma
id|aic-&gt;ATError
comma
id|aic-&gt;HdrErr
comma
id|aic-&gt;TCodeErr
comma
id|aic-&gt;SendRej
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|aic-&gt;id
comma
l_string|&quot;unknown devctl command %d&quot;
comma
id|cmd
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/** Initialize the host adapter chip and corresponding data&n;    structures. We reset the chip, enable transmitter, receiver,&n;    the physical DMA units, cycle timer, cycle source, reception&n;    of selfid packets and initialize several other registers. */
DECL|function|aic_initialize
r_static
r_int
id|aic_initialize
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|aic5800
op_star
id|aic
op_assign
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* Reset data structures */
id|aic-&gt;async_queue
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|aic-&gt;async_queue_lock
)paren
suffix:semicolon
multiline_comment|/* Reset the chip */
id|reg_write
c_func
(paren
id|aic
comma
id|misc_Reset
comma
l_int|0x37
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
singleline_comment|// FIXME
id|reg_write
c_func
(paren
id|aic
comma
id|misc_Reset
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Enable Transmitter/Receiver, enable physDMA,&n;     * enable CycleTimer, cycleSource */
id|reg_write
c_func
(paren
id|aic
comma
id|misc_Control
comma
l_int|0x82050003
)paren
suffix:semicolon
multiline_comment|/* Enable reception of SelfID packets */
id|reg_set_bits
c_func
(paren
id|aic
comma
id|misc_PacketControl
comma
l_int|0x20
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|AT_InterruptSelect
comma
l_int|0x00F0001
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|AT_BranchSelect
comma
l_int|0x0100010
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|AT_WaitSelect
comma
l_int|0x00F0001
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_ATRetries
comma
id|reg_read
c_func
(paren
id|aic
comma
id|misc_ATRetries
)paren
op_or
l_int|0x7
)paren
suffix:semicolon
multiline_comment|/* initialize AR DMA */
multiline_comment|/* unset run bit */
id|reg_write
c_func
(paren
id|aic
comma
id|AR_ChannelControl
comma
l_int|0x80000000
)paren
suffix:semicolon
multiline_comment|/* here we should have 0 iterations because of the code&n;       in the DmaAR handler. However, to be sure we do it */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|aic
comma
id|AR_ChannelStatus
)paren
op_amp
l_int|0x400
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|100000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|aic-&gt;id
comma
l_string|&quot;Huh! Can&squot;t set AR_ChannelControl... card can not receive!&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
(paren
id|aic-&gt;AR_program
)paren
op_member_access_from_pointer
id|control
op_assign
(paren
id|DMA_CMD_INPUTLAST
op_or
id|DMA_KEY_STREAM0
op_or
id|DMA_INTR_ALWAYS
op_or
id|DMA_BRANCH_ALWAYS
)paren
op_plus
id|AIC5800_ARFIFO_SIZE
suffix:semicolon
(paren
id|aic-&gt;AR_program
)paren
op_member_access_from_pointer
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|aic-&gt;rcv_page
)paren
suffix:semicolon
(paren
id|aic-&gt;AR_program
)paren
op_member_access_from_pointer
id|branchAddress
op_assign
id|virt_to_bus
c_func
(paren
id|aic-&gt;AR_program
)paren
suffix:semicolon
(paren
id|aic-&gt;AR_program
)paren
op_member_access_from_pointer
id|status
op_assign
id|AIC5800_ARFIFO_SIZE
suffix:semicolon
(paren
id|aic-&gt;AR_program
op_plus
l_int|1
)paren
op_member_access_from_pointer
id|control
op_assign
id|DMA_CMD_STOP
suffix:semicolon
(paren
id|aic-&gt;AR_program
op_plus
l_int|1
)paren
op_member_access_from_pointer
id|address
op_assign
l_int|0
suffix:semicolon
(paren
id|aic-&gt;AR_program
op_plus
l_int|1
)paren
op_member_access_from_pointer
id|branchAddress
op_assign
l_int|0
suffix:semicolon
(paren
id|aic-&gt;AR_program
op_plus
l_int|1
)paren
op_member_access_from_pointer
id|status
op_assign
l_int|0
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|AR_CommandPtr
comma
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|aic-&gt;AR_program
)paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|AR_ChannelControl
comma
l_int|0x80008000
)paren
suffix:semicolon
multiline_comment|/* Enable Interrupts */
id|reg_write
c_func
(paren
id|aic
comma
id|misc_InterruptClear
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_InterruptMask
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
multiline_comment|/*reg_write(aic, misc_InterruptMask, 0x00F1F03F);*/
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|aic_release
r_static
r_void
id|aic_release
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|aic5800
op_star
id|aic
suffix:semicolon
r_if
c_cond
(paren
id|host
op_ne
l_int|NULL
)paren
(brace
id|aic
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|remove_card
c_func
(paren
id|aic
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* This must be called with the async_queue_lock held. */
DECL|function|send_next_async
r_static
r_void
id|send_next_async
c_func
(paren
r_struct
id|aic5800
op_star
id|aic
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
op_assign
id|aic-&gt;async_queue
suffix:semicolon
multiline_comment|/* stop the channel program if it&squot;s still running */
id|reg_write
c_func
(paren
id|aic
comma
id|AT_ChannelControl
comma
l_int|0x80000000
)paren
suffix:semicolon
multiline_comment|/* re-format packet header for AIC-5800 chip */
id|packet-&gt;header
(braket
l_int|1
)braket
op_assign
(paren
id|packet-&gt;header
(braket
l_int|1
)braket
op_amp
l_int|0xFFFF
)paren
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF0000
)paren
suffix:semicolon
id|packet-&gt;header
(braket
l_int|0
)braket
op_assign
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
macro_line|#ifndef __BIG_ENDIAN
multiline_comment|/* Packet must be byte-swapped in non-big-endian environments, &n;     * see AIC-5800 specification...&n;     */
(brace
id|u32
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|packet-&gt;header_size
op_div
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|i
op_increment
)paren
id|packet-&gt;header
(braket
id|i
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|packet-&gt;header
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|packet-&gt;data_size
op_div
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|i
op_increment
)paren
id|packet-&gt;data
(braket
id|i
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|packet-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* typically we use only a few iterations here */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|aic
comma
id|AT_ChannelStatus
)paren
op_amp
l_int|0x400
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|5000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|aic-&gt;id
comma
l_string|&quot;runaway loop 1 in send_next_async() - bailing out...&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* set data buffer address and packet length */
id|memset
c_func
(paren
id|aic-&gt;AT_program
comma
l_int|0
comma
id|MAX_AT_PROGRAM_SIZE
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
)paren
(brace
id|aic-&gt;AT_program
(braket
l_int|0
)braket
dot
id|control
op_assign
(paren
id|DMA_CMD_OUTPUTMORE
op_or
id|DMA_KEY_STREAM0
)paren
op_plus
id|packet
op_member_access_from_pointer
id|header_size
suffix:semicolon
id|aic-&gt;AT_program
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|packet-&gt;header
)paren
suffix:semicolon
id|aic-&gt;AT_program
(braket
l_int|1
)braket
dot
id|control
op_assign
(paren
id|DMA_CMD_OUTPUTLAST
op_or
id|DMA_KEY_STREAM0
op_or
id|DMA_INTR_ALWAYS
)paren
op_plus
id|packet
op_member_access_from_pointer
id|data_size
suffix:semicolon
id|aic-&gt;AT_program
(braket
l_int|1
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|packet-&gt;data
)paren
suffix:semicolon
id|aic-&gt;AT_program
(braket
l_int|2
)braket
dot
id|control
op_assign
id|DMA_CMD_STOP
suffix:semicolon
)brace
r_else
(brace
id|aic-&gt;AT_program
(braket
l_int|0
)braket
dot
id|control
op_assign
(paren
id|DMA_CMD_OUTPUTLAST
op_or
id|DMA_INTR_ALWAYS
op_or
id|DMA_KEY_STREAM0
)paren
op_plus
id|packet
op_member_access_from_pointer
id|header_size
suffix:semicolon
id|aic-&gt;AT_program
(braket
l_int|0
)braket
dot
id|address
op_assign
id|virt_to_bus
c_func
(paren
id|packet-&gt;header
)paren
suffix:semicolon
id|aic-&gt;AT_program
(braket
l_int|1
)braket
dot
id|control
op_assign
id|DMA_CMD_STOP
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* set program start address */
id|reg_write
c_func
(paren
id|aic
comma
id|AT_CommandPtr
comma
(paren
r_int
r_int
)paren
id|virt_to_bus
c_func
(paren
id|aic-&gt;AT_program
)paren
)paren
suffix:semicolon
multiline_comment|/* typically we use only a few iterations here */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|aic
comma
id|AT_CommandPtr
)paren
op_ne
(paren
r_int
r_int
)paren
id|virt_to_bus
c_func
(paren
id|aic-&gt;AT_program
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|5000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|aic-&gt;id
comma
l_string|&quot;runaway loop 2 in send_next_async() - bailing out...&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* run program */
id|reg_write
c_func
(paren
id|aic
comma
id|AT_ChannelControl
comma
l_int|0x80008000
)paren
suffix:semicolon
)brace
DECL|function|aic_transmit
r_static
r_int
id|aic_transmit
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_struct
id|aic5800
op_star
id|aic
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|p
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
op_ge
l_int|4096
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|aic-&gt;id
comma
l_string|&quot;transmit packet data too big (%d)&quot;
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|packet-&gt;xnext
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|aic-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aic-&gt;async_queue
op_eq
l_int|NULL
)paren
(brace
id|aic-&gt;async_queue
op_assign
id|packet
suffix:semicolon
id|send_next_async
c_func
(paren
id|aic
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_assign
id|aic-&gt;async_queue
suffix:semicolon
r_while
c_loop
(paren
id|p-&gt;xnext
op_ne
l_int|NULL
)paren
(brace
id|p
op_assign
id|p-&gt;xnext
suffix:semicolon
)brace
id|p-&gt;xnext
op_assign
id|packet
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|aic-&gt;async_queue_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|get_phy_reg
r_static
r_int
id|get_phy_reg
c_func
(paren
r_struct
id|aic5800
op_star
id|aic
comma
r_int
id|addr
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|addr
OG
l_int|15
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|aic-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: PHY register address %d out of range&quot;
comma
id|addr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* request data from PHY */
id|reg_write
c_func
(paren
id|aic
comma
id|misc_PhyControl
comma
id|LINK_PHY_READ
op_or
id|LINK_PHY_ADDR
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
multiline_comment|/* read data from PhyControl register */
multiline_comment|/* note that we have to wait until the register is updated */
r_do
(brace
id|retval
op_assign
id|reg_read
c_func
(paren
id|aic
comma
id|misc_PhyControl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|10000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|aic-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: runaway loop, aborting&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|retval
op_amp
l_int|0xf000000
)paren
op_ne
id|LINK_PHY_RADDR
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
multiline_comment|/* we don&squot;t want a PhyInt interrupt */
id|reg_write
c_func
(paren
id|aic
comma
id|misc_InterruptClear
comma
id|INT_PhyInt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
op_minus
l_int|1
)paren
(brace
r_return
(paren
(paren
id|retval
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|generate_own_selfid
r_static
id|quadlet_t
id|generate_own_selfid
c_func
(paren
r_struct
id|aic5800
op_star
id|aic
comma
r_int
id|phyid
)paren
(brace
id|quadlet_t
id|lsid
suffix:semicolon
r_char
id|phyreg
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
id|phyreg
(braket
id|i
)braket
op_assign
id|get_phy_reg
c_func
(paren
id|aic
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* Standard PHY register map */
id|lsid
op_assign
l_int|0x80400000
op_or
(paren
id|phyid
op_lshift
l_int|24
)paren
suffix:semicolon
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|1
)braket
op_amp
l_int|0x3f
)paren
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* gap count */
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|2
)braket
op_amp
l_int|0xc0
)paren
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* max speed */
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|6
)braket
op_amp
l_int|0x01
)paren
op_lshift
l_int|11
suffix:semicolon
multiline_comment|/* contender (phy dep) */
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|6
)braket
op_amp
l_int|0x10
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* initiated reset */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|phyreg
(braket
l_int|2
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* ports */
r_if
c_cond
(paren
id|phyreg
(braket
l_int|3
op_plus
id|i
)braket
op_amp
l_int|0x4
)paren
(brace
id|lsid
op_or_assign
(paren
(paren
(paren
id|phyreg
(braket
l_int|3
op_plus
id|i
)braket
op_amp
l_int|0x8
)paren
op_or
l_int|0x10
)paren
op_rshift
l_int|3
)paren
op_lshift
(paren
l_int|6
op_minus
id|i
op_star
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|lsid
op_or_assign
l_int|1
op_lshift
(paren
l_int|6
op_minus
id|i
op_star
l_int|2
)paren
suffix:semicolon
)brace
)brace
r_return
id|lsid
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* moved out to make interrupt routine more readable */
DECL|function|handle_selfid
r_inline
r_static
r_void
id|handle_selfid
c_func
(paren
r_struct
id|aic5800
op_star
id|aic
comma
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|phyid
comma
r_int
id|isroot
comma
r_int
id|size
)paren
(brace
id|quadlet_t
op_star
id|q
op_assign
id|aic-&gt;rcv_page
suffix:semicolon
id|quadlet_t
id|lsid
suffix:semicolon
multiline_comment|/* we need our own self-id packet */
id|lsid
op_assign
id|generate_own_selfid
c_func
(paren
id|aic
comma
id|phyid
)paren
suffix:semicolon
multiline_comment|/* unconnected state? only begin and end marker in rcv_page */
r_if
c_cond
(paren
id|size
op_eq
l_int|8
)paren
(brace
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|lsid
)paren
suffix:semicolon
)brace
multiline_comment|/* process buffer... AIC&squot;s FIFO often contains some strangenesses */
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|q
(braket
l_int|0
)braket
op_eq
l_int|0xe0
)paren
(brace
multiline_comment|/* marker */
id|q
op_add_assign
l_int|1
suffix:semicolon
id|size
op_sub_assign
l_int|4
suffix:semicolon
r_continue
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|q
(braket
l_int|0
)braket
op_eq
l_int|0x1
)paren
(brace
multiline_comment|/* marker */
id|q
op_add_assign
l_int|1
suffix:semicolon
id|size
op_sub_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|q
(braket
l_int|0
)braket
op_eq
op_complement
id|q
(braket
l_int|1
)braket
)paren
(brace
multiline_comment|/* correct self-id */
r_if
c_cond
(paren
(paren
id|q
(braket
l_int|0
)braket
op_amp
l_int|0x3f800000
)paren
op_eq
(paren
(paren
id|phyid
op_plus
l_int|1
)paren
op_lshift
l_int|24
)paren
)paren
(brace
multiline_comment|/* its our turn now! */
singleline_comment|//PRINT(KERN_INFO, 
singleline_comment|//      aic-&gt;id, &quot;selfid packet 0x%x included&quot;, lsid);
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|lsid
)paren
suffix:semicolon
)brace
singleline_comment|//PRINT(KERN_INFO, aic-&gt;id, &quot;selfid packet 0x%x rcvd&quot;, q[0]);
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|q
op_add_assign
l_int|2
suffix:semicolon
id|size
op_sub_assign
l_int|8
suffix:semicolon
r_continue
suffix:semicolon
)brace
suffix:semicolon
)brace
multiline_comment|/* if we are root, our self-id packet is last */
r_if
c_cond
(paren
id|isroot
op_logical_and
id|phyid
op_ne
l_int|0
)paren
(brace
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|lsid
)paren
suffix:semicolon
)brace
id|hpsb_selfid_complete
c_func
(paren
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
)brace
DECL|function|aic_irq_handler
r_static
r_void
id|aic_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|aic5800
op_star
id|aic
op_assign
(paren
r_struct
id|aic5800
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|aic-&gt;host
suffix:semicolon
id|quadlet_t
op_star
id|q
op_assign
id|aic-&gt;rcv_page
suffix:semicolon
r_int
id|phyid
op_assign
op_minus
l_int|1
comma
id|isroot
op_assign
l_int|0
suffix:semicolon
id|u32
id|interruptEvent
op_assign
id|reg_read
c_func
(paren
id|aic
comma
id|misc_InterruptEvents
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|aic
comma
id|misc_InterruptClear
comma
id|interruptEvent
)paren
suffix:semicolon
singleline_comment|//printk(&quot;InterruptEvent 0x%x&bslash;n&quot;, interruptEvent);
r_if
c_cond
(paren
(paren
id|interruptEvent
op_amp
l_int|0x3f
)paren
op_eq
l_int|0x3f
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;Dma Engine Error&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_DmaAT
)paren
(brace
r_if
c_cond
(paren
id|aic-&gt;AT_program
(braket
l_int|0
)braket
dot
id|status
op_amp
l_int|0xFFFF
)paren
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;AT: could not transfer %d bytes&quot;
comma
id|aic-&gt;AT_program
(braket
l_int|0
)braket
dot
id|status
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_PhyInt
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;PhyInt&quot;
)paren
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_DmaAR
)paren
(brace
r_int
id|rcv_bytes
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* we calculate the number of received bytes from the&n;&t;   residual count field */
id|rcv_bytes
op_assign
id|AIC5800_ARFIFO_SIZE
op_minus
(paren
id|aic-&gt;AR_program-&gt;status
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
singleline_comment|//PRINT(KERN_INFO, aic-&gt;id, &quot;AR_status 0x%x, %d bytes read&quot;, aic-&gt;AR_program-&gt;status, rcv_bytes);
r_if
c_cond
(paren
(paren
id|aic-&gt;AR_program-&gt;status
op_amp
l_int|0x84000000
)paren
op_logical_and
(paren
id|aic-&gt;AR_program-&gt;status
op_amp
l_int|0xFFFF
)paren
op_ge
l_int|8
)paren
(brace
macro_line|#ifndef __BIG_ENDIAN 
multiline_comment|/* we have to do byte-swapping on non-bigendian architectures */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|rcv_bytes
op_div
r_sizeof
(paren
id|quadlet_t
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|q
op_assign
id|be32_to_cpu
c_func
(paren
op_star
id|q
)paren
suffix:semicolon
id|q
op_increment
suffix:semicolon
)brace
suffix:semicolon
id|q
op_assign
id|aic-&gt;rcv_page
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_star
id|q
op_eq
l_int|0xe0
)paren
(brace
id|phyid
op_assign
id|reg_read
c_func
(paren
id|aic
comma
id|misc_NodeID
)paren
suffix:semicolon
id|isroot
op_assign
id|phyid
op_amp
l_int|0x800000
suffix:semicolon
id|phyid
op_assign
id|phyid
op_amp
l_int|0x3F
suffix:semicolon
id|handle_selfid
c_func
(paren
id|aic
comma
id|host
comma
id|phyid
comma
id|isroot
comma
id|rcv_bytes
)paren
suffix:semicolon
)brace
r_else
(brace
id|hpsb_packet_received
c_func
(paren
id|host
comma
id|aic-&gt;rcv_page
comma
id|rcv_bytes
comma
l_int|0
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|aic-&gt;id
comma
l_string|&quot;AR DMA program status value 0x%x is incorrect!&quot;
comma
id|aic-&gt;AR_program-&gt;status
)paren
suffix:semicolon
)brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_BusReset
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;bus reset occured&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;in_bus_reset
)paren
(brace
id|hpsb_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
id|reg_set_bits
c_func
(paren
id|aic
comma
id|misc_Control
comma
l_int|0x1
)paren
suffix:semicolon
id|aic-&gt;NumBusResets
op_increment
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_RcvData
)paren
(brace
id|aic-&gt;RxPackets
op_increment
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_TxRdy
)paren
(brace
multiline_comment|/* async packet sent - transmitter ready */
id|u32
id|ack
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
r_if
c_cond
(paren
id|aic-&gt;async_queue
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|aic-&gt;async_queue_lock
)paren
suffix:semicolon
id|ack
op_assign
id|reg_read
c_func
(paren
id|aic
comma
id|AT_ChannelStatus
)paren
op_amp
l_int|0xF
suffix:semicolon
id|packet
op_assign
id|aic-&gt;async_queue
suffix:semicolon
id|aic-&gt;async_queue
op_assign
id|packet-&gt;xnext
suffix:semicolon
r_if
c_cond
(paren
id|aic-&gt;async_queue
op_ne
l_int|NULL
)paren
(brace
id|send_next_async
c_func
(paren
id|aic
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|aic-&gt;async_queue_lock
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;packet sent with ack code %d&quot;
comma
id|ack
)paren
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|packet
comma
id|ack
)paren
suffix:semicolon
)brace
singleline_comment|// else 
singleline_comment|//PRINT(KERN_INFO,aic-&gt;id,&quot;packet sent without async_queue (self-id?)&quot;);
id|aic-&gt;TxRdy
op_increment
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_ATError
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;ATError&quot;
)paren
suffix:semicolon
id|aic-&gt;ATError
op_increment
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_SendRej
)paren
(brace
id|aic-&gt;SendRej
op_increment
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_HdrErr
)paren
(brace
id|aic-&gt;HdrErr
op_increment
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|interruptEvent
op_amp
id|INT_TCodeErr
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;TCodeErr&quot;
)paren
suffix:semicolon
id|aic-&gt;TCodeErr
op_increment
suffix:semicolon
)brace
suffix:semicolon
id|aic-&gt;NumInterrupts
op_increment
suffix:semicolon
)brace
DECL|function|quadquadalign
r_inline
r_static
r_void
op_star
id|quadquadalign
c_func
(paren
r_void
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|buf
op_mod
l_int|0x10
op_ne
l_int|0
)paren
(brace
r_return
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|buf
op_plus
l_int|0x10
)paren
op_amp
l_int|0xFFFFFFF0
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
id|buf
suffix:semicolon
)brace
suffix:semicolon
)brace
DECL|function|add_card
r_static
r_int
id|add_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
DECL|macro|FAIL
mdefine_line|#define FAIL(fmt, args...) do {&bslash;&n;        PRINT_G(KERN_ERR, fmt , ## args); &bslash;&n;        num_of_cards--; &bslash;&n;        remove_card(aic); &bslash;&n;        return 1; } while (0)
r_struct
id|aic5800
op_star
id|aic
suffix:semicolon
multiline_comment|/* shortcut to currently handled device */
r_int
r_int
id|page
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|num_of_cards
op_eq
id|MAX_AIC5800_CARDS
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;cannot handle more than %d cards.  &quot;
l_string|&quot;Adjust MAX_AIC5800_CARDS in aic5800.h.&quot;
comma
id|MAX_AIC5800_CARDS
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|aic
op_assign
op_amp
id|cards
(braket
id|num_of_cards
op_increment
)braket
suffix:semicolon
id|aic-&gt;id
op_assign
id|num_of_cards
op_minus
l_int|1
suffix:semicolon
id|aic-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|aic_irq_handler
comma
id|SA_SHIRQ
comma
id|AIC5800_DRIVER_NAME
comma
id|aic
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;allocated interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate shared interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
)brace
id|page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_ne
l_int|0
)paren
(brace
id|aic-&gt;rcv_page
op_assign
id|phys_to_virt
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate receive buffer&quot;
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,13)
id|aic-&gt;registers
op_assign
id|ioremap_nocache
c_func
(paren
id|dev-&gt;base_address
(braket
l_int|0
)braket
comma
id|AIC5800_REGSPACE_SIZE
)paren
suffix:semicolon
macro_line|#else
id|aic-&gt;registers
op_assign
id|ioremap_nocache
c_func
(paren
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
comma
id|AIC5800_REGSPACE_SIZE
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|aic-&gt;registers
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to remap registers - card not accessible&quot;
)paren
suffix:semicolon
)brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|aic-&gt;id
comma
l_string|&quot;remapped memory space reg 0x%p&quot;
comma
id|aic-&gt;registers
)paren
suffix:semicolon
id|aic-&gt;pbuf
op_assign
id|kmalloc
c_func
(paren
id|AIC5800_PBUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aic-&gt;pbuf
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate program buffer&quot;
)paren
suffix:semicolon
)brace
id|aic-&gt;AT_program
op_assign
id|quadquadalign
c_func
(paren
id|aic-&gt;pbuf
)paren
suffix:semicolon
id|aic-&gt;AT_program
(braket
l_int|2
)braket
dot
id|control
op_assign
id|DMA_CMD_STOP
suffix:semicolon
id|aic-&gt;AR_program
op_assign
id|aic-&gt;AT_program
op_plus
id|MAX_AT_PROGRAM_SIZE
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
DECL|macro|FAIL
macro_line|#undef FAIL
)brace
DECL|function|remove_card
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|aic5800
op_star
id|aic
)paren
(brace
multiline_comment|/* Disable interrupts of this controller */
id|reg_write
c_func
(paren
id|aic
comma
id|misc_InterruptMask
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Free AR buffer */
id|free_page
c_func
(paren
id|virt_to_phys
c_func
(paren
id|aic-&gt;rcv_page
)paren
)paren
suffix:semicolon
multiline_comment|/* Free channel program buffer */
id|kfree
c_func
(paren
id|aic-&gt;pbuf
)paren
suffix:semicolon
multiline_comment|/* Free interrupt request */
id|free_irq
c_func
(paren
id|aic-&gt;dev-&gt;irq
comma
id|aic
)paren
suffix:semicolon
multiline_comment|/* Unmap register space */
id|iounmap
c_func
(paren
id|aic-&gt;registers
)paren
suffix:semicolon
)brace
DECL|function|init_driver
r_static
r_int
id|init_driver
c_func
(paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|success
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|num_of_cards
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_DEBUG
comma
id|__PRETTY_FUNCTION__
l_string|&quot; called again&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_ADAPTEC
comma
id|PCI_DEVICE_ID_ADAPTEC_5800
comma
id|dev
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|add_card
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|success
op_eq
l_int|0
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;no operable AIC-5800 based cards found&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** Prepare our local CSR ROM. This is done by using the software-stored&n;    ROM and inserting the GUID read from the EEPROM */
DECL|function|get_aic_rom
r_static
r_int
id|get_aic_rom
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_const
id|quadlet_t
op_star
op_star
id|ptr
)paren
(brace
r_struct
id|aic5800
op_star
id|aic
op_assign
id|host
op_member_access_from_pointer
id|hostdata
suffix:semicolon
id|u64
id|guid
suffix:semicolon
multiline_comment|/* Read the GUID from the card&squot;s EEPROM and put it into the right&n;       place in the CONFIG ROM. */
id|guid
op_assign
id|read_guid
c_func
(paren
id|aic
)paren
suffix:semicolon
id|aic5800_csr_rom
(braket
l_int|15
)braket
op_assign
(paren
id|u32
)paren
(paren
id|guid
op_rshift
l_int|32
)paren
suffix:semicolon
id|aic5800_csr_rom
(braket
l_int|16
)braket
op_assign
(paren
id|u32
)paren
(paren
id|guid
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|aic5800_csr_rom
suffix:semicolon
r_return
r_sizeof
(paren
id|aic5800_csr_rom
)paren
suffix:semicolon
)brace
DECL|function|get_aic_template
r_struct
id|hpsb_host_template
op_star
id|get_aic_template
c_func
(paren
r_void
)paren
(brace
r_static
r_struct
id|hpsb_host_template
id|tmpl
suffix:semicolon
r_static
r_int
id|initialized
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|initialized
)paren
(brace
multiline_comment|/* Initialize by field names so that a template structure&n;                 * reorganization does not influence this code. */
id|tmpl.name
op_assign
l_string|&quot;aic5800&quot;
suffix:semicolon
id|tmpl.detect_hosts
op_assign
id|aic_detect
suffix:semicolon
id|tmpl.initialize_host
op_assign
id|aic_initialize
suffix:semicolon
id|tmpl.release_host
op_assign
id|aic_release
suffix:semicolon
id|tmpl.get_rom
op_assign
id|get_aic_rom
suffix:semicolon
id|tmpl.transmit_packet
op_assign
id|aic_transmit
suffix:semicolon
id|tmpl.devctl
op_assign
id|aic_devctl
suffix:semicolon
id|initialized
op_assign
l_int|1
suffix:semicolon
)brace
r_return
op_amp
id|tmpl
suffix:semicolon
)brace
macro_line|#ifdef MODULE
multiline_comment|/* EXPORT_NO_SYMBOLS; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Emanuel Pirker &lt;epirker@edu.uni-klu.ac.at&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Adaptec AIC-5800 PCI-to-IEEE1394 controller driver&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;aic5800&quot;
)paren
suffix:semicolon
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|hpsb_unregister_lowlevel
c_func
(paren
id|get_aic_template
c_func
(paren
)paren
)paren
suffix:semicolon
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;removed &quot;
id|AIC5800_DRIVER_NAME
l_string|&quot; module&quot;
)paren
suffix:semicolon
)brace
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|hpsb_register_lowlevel
c_func
(paren
id|get_aic_template
c_func
(paren
)paren
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;registering failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif /* MODULE */
eof
