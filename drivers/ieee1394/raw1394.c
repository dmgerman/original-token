multiline_comment|/*&n; * IEEE 1394 for Linux&n; *&n; * Raw interface to the bus&n; *&n; * Copyright (C) 1999, 2000 Andreas E. Bombe&n; *&n; * This code is licensed under the GPL.  See the file COPYING in the root&n; * directory of the kernel sources for details.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,0)
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#endif
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;ieee1394_transactions.h&quot;
macro_line|#include &quot;raw1394.h&quot;
macro_line|#if BITS_PER_LONG == 64
DECL|macro|int2ptr
mdefine_line|#define int2ptr(x) ((void *)x)
DECL|macro|ptr2int
mdefine_line|#define ptr2int(x) ((u64)x)
macro_line|#else
DECL|macro|int2ptr
mdefine_line|#define int2ptr(x) ((void *)(u32)x)
DECL|macro|ptr2int
mdefine_line|#define ptr2int(x) ((u64)(u32)x)
macro_line|#endif
DECL|variable|devfs_handle
r_static
id|devfs_handle_t
id|devfs_handle
suffix:semicolon
DECL|variable|host_info_list
id|LIST_HEAD
c_func
(paren
id|host_info_list
)paren
suffix:semicolon
DECL|variable|host_count
r_static
r_int
id|host_count
suffix:semicolon
DECL|variable|host_info_lock
id|spinlock_t
id|host_info_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|hl_handle
r_static
r_struct
id|hpsb_highlevel
op_star
id|hl_handle
suffix:semicolon
DECL|variable|iso_buffer_size
r_static
id|atomic_t
id|iso_buffer_size
suffix:semicolon
DECL|variable|iso_buffer_max
r_static
r_const
r_int
id|iso_buffer_max
op_assign
l_int|4
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
multiline_comment|/* 4 MB */
r_static
r_void
id|queue_complete_cb
c_func
(paren
r_struct
id|pending_request
op_star
id|req
)paren
suffix:semicolon
DECL|function|__alloc_pending_request
r_static
r_struct
id|pending_request
op_star
id|__alloc_pending_request
c_func
(paren
r_int
id|flags
)paren
(brace
r_struct
id|pending_request
op_star
id|req
suffix:semicolon
id|req
op_assign
(paren
r_struct
id|pending_request
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pending_request
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|req
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pending_request
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|req-&gt;list
)paren
suffix:semicolon
id|req-&gt;tq.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|queue_complete_cb
suffix:semicolon
)brace
r_return
id|req
suffix:semicolon
)brace
DECL|function|alloc_pending_request
r_inline
r_static
r_struct
id|pending_request
op_star
id|alloc_pending_request
c_func
(paren
r_void
)paren
(brace
r_return
id|__alloc_pending_request
c_func
(paren
id|SLAB_KERNEL
)paren
suffix:semicolon
)brace
DECL|function|free_pending_request
r_static
r_void
id|free_pending_request
c_func
(paren
r_struct
id|pending_request
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;ibs
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|req-&gt;ibs-&gt;refcount
)paren
)paren
(brace
id|atomic_sub
c_func
(paren
id|req-&gt;ibs-&gt;data_size
comma
op_amp
id|iso_buffer_size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|req-&gt;ibs
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|req-&gt;free_data
)paren
(brace
id|kfree
c_func
(paren
id|req-&gt;data
)paren
suffix:semicolon
)brace
id|free_hpsb_packet
c_func
(paren
id|req-&gt;packet
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
DECL|function|queue_complete_req
r_static
r_void
id|queue_complete_req
c_func
(paren
r_struct
id|pending_request
op_star
id|req
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|file_info
op_star
id|fi
op_assign
id|req-&gt;file_info
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|req-&gt;list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|fi-&gt;req_complete
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
comma
id|flags
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|fi-&gt;complete_sem
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|fi-&gt;poll_wait_complete
)paren
suffix:semicolon
)brace
DECL|function|queue_complete_cb
r_static
r_void
id|queue_complete_cb
c_func
(paren
r_struct
id|pending_request
op_star
id|req
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|packet
op_assign
id|req-&gt;packet
suffix:semicolon
r_int
id|rcode
op_assign
(paren
id|packet-&gt;header
(braket
l_int|1
)braket
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
suffix:semicolon
r_switch
c_cond
(paren
id|packet-&gt;ack_code
)paren
(brace
r_case
id|ACKX_NONE
suffix:colon
r_case
id|ACKX_SEND_ERROR
suffix:colon
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_SEND_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACKX_ABORTED
suffix:colon
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_ABORTED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACKX_TIMEOUT
suffix:colon
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_TIMEOUT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|req-&gt;req.error
op_assign
(paren
id|packet-&gt;ack_code
op_lshift
l_int|16
)paren
op_or
id|rcode
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|packet-&gt;ack_code
op_eq
id|ACK_PENDING
)paren
op_logical_and
(paren
id|rcode
op_eq
id|RCODE_COMPLETE
)paren
)paren
)paren
(brace
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
)brace
id|free_tlabel
c_func
(paren
id|packet-&gt;host
comma
id|packet-&gt;node_id
comma
id|packet-&gt;tlabel
)paren
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
DECL|function|add_host
r_static
r_void
id|add_host
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
id|hi
op_assign
(paren
r_struct
id|host_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|host_info
)paren
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_ne
l_int|NULL
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hi-&gt;list
)paren
suffix:semicolon
id|hi-&gt;host
op_assign
id|host
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hi-&gt;file_info_list
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|hi-&gt;list
comma
op_amp
id|host_info_list
)paren
suffix:semicolon
id|host_count
op_increment
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
)brace
)brace
DECL|function|find_host_info
r_static
r_struct
id|host_info
op_star
id|find_host_info
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
id|lh
op_assign
id|host_info_list.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|host_info_list
)paren
(brace
id|hi
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|host_info
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi-&gt;host
op_eq
id|host
)paren
(brace
r_return
id|hi
suffix:semicolon
)brace
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|remove_host
r_static
r_void
id|remove_host
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
id|hi
op_assign
id|find_host_info
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_ne
l_int|NULL
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|hi-&gt;list
)paren
suffix:semicolon
id|host_count
op_decrement
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;raw1394: attempt to remove unknown host &quot;
l_string|&quot;0x%p&bslash;n&quot;
comma
id|host
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|hi
)paren
suffix:semicolon
)brace
DECL|function|host_reset
r_static
r_void
id|host_reset
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
r_struct
id|file_info
op_star
id|fi
suffix:semicolon
r_struct
id|pending_request
op_star
id|req
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host_info_lock
comma
id|flags
)paren
suffix:semicolon
id|hi
op_assign
id|find_host_info
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_ne
l_int|NULL
)paren
(brace
id|lh
op_assign
id|hi-&gt;file_info_list.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|hi-&gt;file_info_list
)paren
(brace
id|fi
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|file_info
comma
id|list
)paren
suffix:semicolon
id|req
op_assign
id|__alloc_pending_request
c_func
(paren
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_ne
l_int|NULL
)paren
(brace
id|req-&gt;file_info
op_assign
id|fi
suffix:semicolon
id|req-&gt;req.type
op_assign
id|RAW1394_REQ_BUS_RESET
suffix:semicolon
id|req-&gt;req.generation
op_assign
id|get_hpsb_generation
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;req.misc
op_assign
(paren
id|host-&gt;node_id
op_lshift
l_int|16
)paren
op_or
id|host-&gt;node_count
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;protocol_version
OG
l_int|3
)paren
(brace
id|req-&gt;req.misc
op_or_assign
(paren
(paren
id|host-&gt;irm_id
op_amp
id|NODE_MASK
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host_info_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|iso_receive
r_static
r_void
id|iso_receive
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|channel
comma
id|quadlet_t
op_star
id|data
comma
r_int
r_int
id|length
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
r_struct
id|file_info
op_star
id|fi
suffix:semicolon
r_struct
id|pending_request
op_star
id|req
suffix:semicolon
r_struct
id|iso_block_store
op_star
id|ibs
op_assign
l_int|NULL
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|reqs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|atomic_read
c_func
(paren
op_amp
id|iso_buffer_size
)paren
op_plus
id|length
)paren
OG
id|iso_buffer_max
)paren
(brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;dropped iso packet&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host_info_lock
comma
id|flags
)paren
suffix:semicolon
id|hi
op_assign
id|find_host_info
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|lh
op_assign
id|hi-&gt;file_info_list.next
suffix:semicolon
id|lh
op_ne
op_amp
id|hi-&gt;file_info_list
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
)paren
(brace
id|fi
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|file_info
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|fi-&gt;listen_channels
op_amp
(paren
l_int|1ULL
op_lshift
id|channel
)paren
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|req
op_assign
id|__alloc_pending_request
c_func
(paren
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ibs
)paren
(brace
id|ibs
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|iso_block_store
)paren
op_plus
id|length
comma
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ibs
)paren
(brace
id|kfree
c_func
(paren
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|atomic_add
c_func
(paren
id|length
comma
op_amp
id|iso_buffer_size
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ibs-&gt;refcount
comma
l_int|0
)paren
suffix:semicolon
id|ibs-&gt;data_size
op_assign
id|length
suffix:semicolon
id|memcpy
c_func
(paren
id|ibs-&gt;data
comma
id|data
comma
id|length
)paren
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|ibs-&gt;refcount
)paren
suffix:semicolon
id|req-&gt;file_info
op_assign
id|fi
suffix:semicolon
id|req-&gt;ibs
op_assign
id|ibs
suffix:semicolon
id|req-&gt;data
op_assign
id|ibs-&gt;data
suffix:semicolon
id|req-&gt;req.type
op_assign
id|RAW1394_REQ_ISO_RECEIVE
suffix:semicolon
id|req-&gt;req.generation
op_assign
id|get_hpsb_generation
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;req.misc
op_assign
l_int|0
suffix:semicolon
id|req-&gt;req.recvb
op_assign
id|ptr2int
c_func
(paren
id|fi-&gt;iso_buffer
)paren
suffix:semicolon
id|req-&gt;req.length
op_assign
id|MIN
c_func
(paren
id|length
comma
id|fi-&gt;iso_buffer_length
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|reqs
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host_info_lock
comma
id|flags
)paren
suffix:semicolon
id|lh
op_assign
id|reqs.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|reqs
)paren
(brace
id|req
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|pending_request
comma
id|list
)paren
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
)brace
DECL|function|fcp_request
r_static
r_void
id|fcp_request
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|nodeid
comma
r_int
id|direction
comma
r_int
id|cts
comma
id|u8
op_star
id|data
comma
r_int
r_int
id|length
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
r_struct
id|file_info
op_star
id|fi
suffix:semicolon
r_struct
id|pending_request
op_star
id|req
suffix:semicolon
r_struct
id|iso_block_store
op_star
id|ibs
op_assign
l_int|NULL
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|reqs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|atomic_read
c_func
(paren
op_amp
id|iso_buffer_size
)paren
op_plus
id|length
)paren
OG
id|iso_buffer_max
)paren
(brace
id|HPSB_INFO
c_func
(paren
l_string|&quot;dropped fcp request&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host_info_lock
comma
id|flags
)paren
suffix:semicolon
id|hi
op_assign
id|find_host_info
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_ne
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
id|lh
op_assign
id|hi-&gt;file_info_list.next
suffix:semicolon
id|lh
op_ne
op_amp
id|hi-&gt;file_info_list
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
)paren
(brace
id|fi
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|file_info
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fi-&gt;fcp_buffer
)paren
(brace
r_continue
suffix:semicolon
)brace
id|req
op_assign
id|__alloc_pending_request
c_func
(paren
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ibs
)paren
(brace
id|ibs
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|iso_block_store
)paren
op_plus
id|length
comma
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ibs
)paren
(brace
id|kfree
c_func
(paren
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|atomic_add
c_func
(paren
id|length
comma
op_amp
id|iso_buffer_size
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ibs-&gt;refcount
comma
l_int|0
)paren
suffix:semicolon
id|ibs-&gt;data_size
op_assign
id|length
suffix:semicolon
id|memcpy
c_func
(paren
id|ibs-&gt;data
comma
id|data
comma
id|length
)paren
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|ibs-&gt;refcount
)paren
suffix:semicolon
id|req-&gt;file_info
op_assign
id|fi
suffix:semicolon
id|req-&gt;ibs
op_assign
id|ibs
suffix:semicolon
id|req-&gt;data
op_assign
id|ibs-&gt;data
suffix:semicolon
id|req-&gt;req.type
op_assign
id|RAW1394_REQ_FCP_REQUEST
suffix:semicolon
id|req-&gt;req.generation
op_assign
id|get_hpsb_generation
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;req.misc
op_assign
id|nodeid
op_or
(paren
id|direction
op_lshift
l_int|16
)paren
suffix:semicolon
id|req-&gt;req.recvb
op_assign
id|ptr2int
c_func
(paren
id|fi-&gt;fcp_buffer
)paren
suffix:semicolon
id|req-&gt;req.length
op_assign
id|length
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|reqs
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host_info_lock
comma
id|flags
)paren
suffix:semicolon
id|lh
op_assign
id|reqs.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|reqs
)paren
(brace
id|req
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|pending_request
comma
id|list
)paren
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
)brace
DECL|function|dev_read
r_static
id|ssize_t
id|dev_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|offset_is_ignored
)paren
(brace
r_struct
id|file_info
op_star
id|fi
op_assign
(paren
r_struct
id|file_info
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|pending_request
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|buffer
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|fi-&gt;complete_sem
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|fi-&gt;complete_sem
)paren
)paren
(brace
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
id|lh
op_assign
id|fi-&gt;req_complete.next
suffix:semicolon
id|list_del
c_func
(paren
id|lh
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
id|req
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|pending_request
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;req.length
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|int2ptr
c_func
(paren
id|req-&gt;req.recvb
)paren
comma
id|req-&gt;data
comma
id|req-&gt;req.length
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_MEMFAULT
suffix:semicolon
)brace
)brace
id|__copy_to_user
c_func
(paren
id|buffer
comma
op_amp
id|req-&gt;req
comma
r_sizeof
(paren
id|req-&gt;req
)paren
)paren
suffix:semicolon
id|free_pending_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
DECL|function|state_opened
r_static
r_int
id|state_opened
c_func
(paren
r_struct
id|file_info
op_star
id|fi
comma
r_struct
id|pending_request
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;req.type
op_eq
id|RAW1394_REQ_INITIALIZE
)paren
(brace
r_switch
c_cond
(paren
id|req-&gt;req.misc
)paren
(brace
r_case
id|RAW1394_KERNELAPI_VERSION
suffix:colon
r_case
l_int|3
suffix:colon
id|fi-&gt;state
op_assign
id|initialized
suffix:semicolon
id|fi-&gt;protocol_version
op_assign
id|req-&gt;req.misc
suffix:semicolon
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_NONE
suffix:semicolon
id|req-&gt;req.generation
op_assign
id|get_hpsb_generation
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_COMPAT
suffix:semicolon
id|req-&gt;req.misc
op_assign
id|RAW1394_KERNELAPI_VERSION
suffix:semicolon
)brace
)brace
r_else
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_STATE_ORDER
suffix:semicolon
)brace
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
DECL|function|state_initialized
r_static
r_int
id|state_initialized
c_func
(paren
r_struct
id|file_info
op_star
id|fi
comma
r_struct
id|pending_request
op_star
id|req
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
r_struct
id|raw1394_khost_list
op_star
id|khl
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;req.generation
op_ne
id|get_hpsb_generation
c_func
(paren
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_GENERATION
suffix:semicolon
id|req-&gt;req.generation
op_assign
id|get_hpsb_generation
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|req-&gt;req.type
)paren
(brace
r_case
id|RAW1394_REQ_LIST_CARDS
suffix:colon
id|spin_lock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
id|khl
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|raw1394_khost_list
)paren
op_star
id|host_count
comma
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|khl
op_ne
l_int|NULL
)paren
(brace
id|req-&gt;req.misc
op_assign
id|host_count
suffix:semicolon
id|req-&gt;data
op_assign
(paren
id|quadlet_t
op_star
)paren
id|khl
suffix:semicolon
id|lh
op_assign
id|host_info_list.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|host_info_list
)paren
(brace
id|hi
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|host_info
comma
id|list
)paren
suffix:semicolon
id|khl-&gt;nodes
op_assign
id|hi-&gt;host-&gt;node_count
suffix:semicolon
id|strcpy
c_func
(paren
id|khl-&gt;name
comma
id|hi-&gt;host
op_member_access_from_pointer
r_template
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
id|khl
op_increment
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
)brace
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|khl
op_ne
l_int|NULL
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_NONE
suffix:semicolon
id|req-&gt;req.length
op_assign
id|MIN
c_func
(paren
id|req-&gt;req.length
comma
r_sizeof
(paren
r_struct
id|raw1394_khost_list
)paren
op_star
id|req-&gt;req.misc
)paren
suffix:semicolon
id|req-&gt;free_data
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RAW1394_REQ_SET_CARD
suffix:colon
id|lh
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;req.misc
OL
id|host_count
)paren
(brace
id|lh
op_assign
id|host_info_list.next
suffix:semicolon
r_while
c_loop
(paren
id|req-&gt;req.misc
op_decrement
)paren
(brace
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
)brace
id|hi
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|host_info
comma
id|list
)paren
suffix:semicolon
id|hpsb_inc_host_usage
c_func
(paren
id|hi-&gt;host
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|fi-&gt;list
comma
op_amp
id|hi-&gt;file_info_list
)paren
suffix:semicolon
id|fi-&gt;host
op_assign
id|hi-&gt;host
suffix:semicolon
id|fi-&gt;state
op_assign
id|connected
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lh
op_ne
l_int|NULL
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_NONE
suffix:semicolon
id|req-&gt;req.misc
op_assign
(paren
id|fi-&gt;host-&gt;node_id
op_lshift
l_int|16
)paren
op_or
id|fi-&gt;host-&gt;node_count
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;protocol_version
OG
l_int|3
)paren
(brace
id|req-&gt;req.misc
op_or_assign
(paren
id|fi-&gt;host-&gt;irm_id
op_amp
id|NODE_MASK
)paren
op_lshift
l_int|8
suffix:semicolon
)brace
)brace
r_else
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_INVALID_ARG
suffix:semicolon
)brace
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_STATE_ORDER
suffix:semicolon
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
DECL|function|handle_iso_listen
r_static
r_void
id|handle_iso_listen
c_func
(paren
r_struct
id|file_info
op_star
id|fi
comma
r_struct
id|pending_request
op_star
id|req
)paren
(brace
r_int
id|channel
op_assign
id|req-&gt;req.misc
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|channel
OG
l_int|63
)paren
op_logical_or
(paren
id|channel
OL
op_minus
l_int|64
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_INVALID_ARG
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|channel
op_ge
l_int|0
)paren
(brace
multiline_comment|/* allocate channel req.misc */
r_if
c_cond
(paren
id|fi-&gt;listen_channels
op_amp
(paren
l_int|1ULL
op_lshift
id|channel
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_ALREADY
suffix:semicolon
)brace
r_else
(brace
id|fi-&gt;listen_channels
op_or_assign
l_int|1ULL
op_lshift
id|channel
suffix:semicolon
id|hpsb_listen_channel
c_func
(paren
id|hl_handle
comma
id|fi-&gt;host
comma
id|channel
)paren
suffix:semicolon
id|fi-&gt;iso_buffer
op_assign
id|int2ptr
c_func
(paren
id|req-&gt;req.recvb
)paren
suffix:semicolon
id|fi-&gt;iso_buffer_length
op_assign
id|req-&gt;req.length
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* deallocate channel (one&squot;s complement neg) req.misc */
id|channel
op_assign
op_complement
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;listen_channels
op_amp
(paren
l_int|1ULL
op_lshift
id|channel
)paren
)paren
(brace
id|hpsb_unlisten_channel
c_func
(paren
id|hl_handle
comma
id|fi-&gt;host
comma
id|channel
)paren
suffix:semicolon
id|fi-&gt;listen_channels
op_and_assign
op_complement
(paren
l_int|1ULL
op_lshift
id|channel
)paren
suffix:semicolon
)brace
r_else
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_INVALID_ARG
suffix:semicolon
)brace
)brace
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
)brace
DECL|function|handle_fcp_listen
r_static
r_void
id|handle_fcp_listen
c_func
(paren
r_struct
id|file_info
op_star
id|fi
comma
r_struct
id|pending_request
op_star
id|req
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;req.misc
)paren
(brace
r_if
c_cond
(paren
id|fi-&gt;fcp_buffer
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_ALREADY
suffix:semicolon
)brace
r_else
(brace
id|fi-&gt;fcp_buffer
op_assign
(paren
id|u8
op_star
)paren
id|int2ptr
c_func
(paren
id|req-&gt;req.recvb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|fi-&gt;fcp_buffer
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_ALREADY
suffix:semicolon
)brace
r_else
(brace
id|fi-&gt;fcp_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
DECL|function|handle_local_request
r_static
r_int
id|handle_local_request
c_func
(paren
r_struct
id|file_info
op_star
id|fi
comma
r_struct
id|pending_request
op_star
id|req
comma
r_int
id|node
)paren
(brace
id|u64
id|addr
op_assign
id|req-&gt;req.address
op_amp
l_int|0xffffffffffffULL
suffix:semicolon
id|req-&gt;data
op_assign
id|kmalloc
c_func
(paren
id|req-&gt;req.length
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req-&gt;data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|req-&gt;free_data
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|req-&gt;req.type
)paren
(brace
r_case
id|RAW1394_REQ_ASYNC_READ
suffix:colon
id|req-&gt;req.error
op_assign
id|highlevel_read
c_func
(paren
id|fi-&gt;host
comma
id|node
comma
id|req-&gt;data
comma
id|addr
comma
id|req-&gt;req.length
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RAW1394_REQ_ASYNC_WRITE
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|req-&gt;data
comma
id|int2ptr
c_func
(paren
id|req-&gt;req.sendb
)paren
comma
id|req-&gt;req.length
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_MEMFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|req-&gt;req.error
op_assign
id|highlevel_write
c_func
(paren
id|fi-&gt;host
comma
id|node
comma
id|req-&gt;data
comma
id|addr
comma
id|req-&gt;req.length
)paren
suffix:semicolon
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RAW1394_REQ_LOCK
suffix:colon
r_if
c_cond
(paren
(paren
id|req-&gt;req.misc
op_eq
id|EXTCODE_FETCH_ADD
)paren
op_logical_or
(paren
id|req-&gt;req.misc
op_eq
id|EXTCODE_LITTLE_ADD
)paren
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;req.length
op_ne
l_int|4
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_INVALID_ARG
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|req-&gt;req.length
op_ne
l_int|8
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_INVALID_ARG
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|req-&gt;data
comma
id|int2ptr
c_func
(paren
id|req-&gt;req.sendb
)paren
comma
id|req-&gt;req.length
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_MEMFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;req.length
op_eq
l_int|8
)paren
(brace
id|req-&gt;req.error
op_assign
id|highlevel_lock
c_func
(paren
id|fi-&gt;host
comma
id|node
comma
id|req-&gt;data
comma
id|addr
comma
id|req-&gt;data
(braket
l_int|1
)braket
comma
id|req-&gt;data
(braket
l_int|0
)braket
comma
id|req-&gt;req.misc
)paren
suffix:semicolon
id|req-&gt;req.length
op_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|req-&gt;req.error
op_assign
id|highlevel_lock
c_func
(paren
id|fi-&gt;host
comma
id|node
comma
id|req-&gt;data
comma
id|addr
comma
id|req-&gt;data
(braket
l_int|0
)braket
comma
l_int|0
comma
id|req-&gt;req.misc
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RAW1394_REQ_LOCK64
suffix:colon
r_default
suffix:colon
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_STATE_ORDER
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;req.error
)paren
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|req-&gt;req.error
op_or_assign
l_int|0x00100000
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
DECL|function|handle_remote_request
r_static
r_int
id|handle_remote_request
c_func
(paren
r_struct
id|file_info
op_star
id|fi
comma
r_struct
id|pending_request
op_star
id|req
comma
r_int
id|node
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|packet
op_assign
l_int|NULL
suffix:semicolon
id|u64
id|addr
op_assign
id|req-&gt;req.address
op_amp
l_int|0xffffffffffffULL
suffix:semicolon
r_switch
c_cond
(paren
id|req-&gt;req.type
)paren
(brace
r_case
id|RAW1394_REQ_ASYNC_READ
suffix:colon
r_if
c_cond
(paren
id|req-&gt;req.length
op_eq
l_int|4
)paren
(brace
id|packet
op_assign
id|hpsb_make_readqpacket
c_func
(paren
id|fi-&gt;host
comma
id|node
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|req-&gt;data
op_assign
op_amp
id|packet-&gt;header
(braket
l_int|3
)braket
suffix:semicolon
)brace
r_else
(brace
id|packet
op_assign
id|hpsb_make_readbpacket
c_func
(paren
id|fi-&gt;host
comma
id|node
comma
id|addr
comma
id|req-&gt;req.length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|req-&gt;data
op_assign
id|packet-&gt;data
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RAW1394_REQ_ASYNC_WRITE
suffix:colon
r_if
c_cond
(paren
id|req-&gt;req.length
op_eq
l_int|4
)paren
(brace
id|quadlet_t
id|x
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|x
comma
id|int2ptr
c_func
(paren
id|req-&gt;req.sendb
)paren
comma
l_int|4
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_MEMFAULT
suffix:semicolon
)brace
id|packet
op_assign
id|hpsb_make_writeqpacket
c_func
(paren
id|fi-&gt;host
comma
id|node
comma
id|addr
comma
id|x
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
id|packet
op_assign
id|hpsb_make_writebpacket
c_func
(paren
id|fi-&gt;host
comma
id|node
comma
id|addr
comma
id|req-&gt;req.length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|packet-&gt;data
comma
id|int2ptr
c_func
(paren
id|req-&gt;req.sendb
)paren
comma
id|req-&gt;req.length
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_MEMFAULT
suffix:semicolon
)brace
)brace
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RAW1394_REQ_LOCK
suffix:colon
r_if
c_cond
(paren
(paren
id|req-&gt;req.misc
op_eq
id|EXTCODE_FETCH_ADD
)paren
op_logical_or
(paren
id|req-&gt;req.misc
op_eq
id|EXTCODE_LITTLE_ADD
)paren
)paren
(brace
r_if
c_cond
(paren
id|req-&gt;req.length
op_ne
l_int|4
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_INVALID_ARG
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|req-&gt;req.length
op_ne
l_int|8
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_INVALID_ARG
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|packet
op_assign
id|hpsb_make_lockpacket
c_func
(paren
id|fi-&gt;host
comma
id|node
comma
id|addr
comma
id|req-&gt;req.misc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|packet-&gt;data
comma
id|int2ptr
c_func
(paren
id|req-&gt;req.sendb
)paren
comma
id|req-&gt;req.length
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_MEMFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|req-&gt;data
op_assign
id|packet-&gt;data
suffix:semicolon
id|req-&gt;req.length
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RAW1394_REQ_LOCK64
suffix:colon
r_default
suffix:colon
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_STATE_ORDER
suffix:semicolon
)brace
id|req-&gt;packet
op_assign
id|packet
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;req.error
)paren
(brace
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
id|req-&gt;tq.data
op_assign
id|req
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|req-&gt;tq
comma
op_amp
id|packet-&gt;complete_tq
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|fi-&gt;req_pending
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpsb_send_packet
c_func
(paren
id|packet
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_SEND_ERROR
suffix:semicolon
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|free_tlabel
c_func
(paren
id|packet-&gt;host
comma
id|packet-&gt;node_id
comma
id|packet-&gt;tlabel
)paren
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
DECL|function|handle_iso_send
r_static
r_int
id|handle_iso_send
c_func
(paren
r_struct
id|file_info
op_star
id|fi
comma
r_struct
id|pending_request
op_star
id|req
comma
r_int
id|channel
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
id|packet
op_assign
id|alloc_hpsb_packet
c_func
(paren
id|req-&gt;req.length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|req-&gt;packet
op_assign
id|packet
suffix:semicolon
id|fill_iso_packet
c_func
(paren
id|packet
comma
id|req-&gt;req.length
comma
id|channel
op_amp
l_int|0x3f
comma
(paren
id|req-&gt;req.misc
op_rshift
l_int|16
)paren
op_amp
l_int|0x3
comma
id|req-&gt;req.misc
op_amp
l_int|0xf
)paren
suffix:semicolon
id|packet-&gt;type
op_assign
id|iso
suffix:semicolon
id|packet-&gt;speed_code
op_assign
id|req-&gt;req.address
op_amp
l_int|0x3
suffix:semicolon
id|packet-&gt;host
op_assign
id|fi-&gt;host
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|packet-&gt;data
comma
id|int2ptr
c_func
(paren
id|req-&gt;req.sendb
)paren
comma
id|req-&gt;req.length
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_MEMFAULT
suffix:semicolon
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
id|req-&gt;tq.data
op_assign
id|req
suffix:semicolon
id|req-&gt;tq.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|queue_complete_req
suffix:semicolon
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|req-&gt;tq
comma
op_amp
id|packet-&gt;complete_tq
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|req-&gt;list
comma
op_amp
id|fi-&gt;req_pending
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpsb_send_packet
c_func
(paren
id|packet
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_SEND_ERROR
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
DECL|function|state_connected
r_static
r_int
id|state_connected
c_func
(paren
r_struct
id|file_info
op_star
id|fi
comma
r_struct
id|pending_request
op_star
id|req
)paren
(brace
r_int
id|node
op_assign
id|req-&gt;req.address
op_rshift
l_int|48
suffix:semicolon
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_NONE
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;req.type
op_eq
id|RAW1394_REQ_ISO_SEND
)paren
(brace
r_return
id|handle_iso_send
c_func
(paren
id|fi
comma
id|req
comma
id|node
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;req.generation
op_ne
id|get_hpsb_generation
c_func
(paren
)paren
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_GENERATION
suffix:semicolon
id|req-&gt;req.generation
op_assign
id|get_hpsb_generation
c_func
(paren
)paren
suffix:semicolon
id|req-&gt;req.length
op_assign
l_int|0
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|req-&gt;req.type
)paren
(brace
r_case
id|RAW1394_REQ_ISO_LISTEN
suffix:colon
id|handle_iso_listen
c_func
(paren
id|fi
comma
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
r_case
id|RAW1394_REQ_FCP_LISTEN
suffix:colon
id|handle_fcp_listen
c_func
(paren
id|fi
comma
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
r_case
id|RAW1394_REQ_RESET_BUS
suffix:colon
id|hpsb_reset_bus
c_func
(paren
id|fi-&gt;host
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;req.length
op_eq
l_int|0
)paren
(brace
id|req-&gt;req.error
op_assign
id|RAW1394_ERROR_INVALID_ARG
suffix:semicolon
id|queue_complete_req
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fi-&gt;host-&gt;node_id
op_eq
id|node
)paren
(brace
r_return
id|handle_local_request
c_func
(paren
id|fi
comma
id|req
comma
id|node
)paren
suffix:semicolon
)brace
r_return
id|handle_remote_request
c_func
(paren
id|fi
comma
id|req
comma
id|node
)paren
suffix:semicolon
)brace
DECL|function|dev_write
r_static
id|ssize_t
id|dev_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|offset_is_ignored
)paren
(brace
r_struct
id|file_info
op_star
id|fi
op_assign
(paren
r_struct
id|file_info
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|pending_request
op_star
id|req
suffix:semicolon
id|ssize_t
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|req
op_assign
id|alloc_pending_request
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|req-&gt;file_info
op_assign
id|fi
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|req-&gt;req
comma
id|buffer
comma
r_sizeof
(paren
r_struct
id|raw1394_request
)paren
)paren
)paren
(brace
id|free_pending_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|fi-&gt;state
)paren
(brace
r_case
id|opened
suffix:colon
id|retval
op_assign
id|state_opened
c_func
(paren
id|fi
comma
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|initialized
suffix:colon
id|retval
op_assign
id|state_initialized
c_func
(paren
id|fi
comma
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|connected
suffix:colon
id|retval
op_assign
id|state_connected
c_func
(paren
id|fi
comma
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|free_pending_request
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|dev_poll
r_static
r_int
r_int
id|dev_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|pt
)paren
(brace
r_struct
id|file_info
op_star
id|fi
op_assign
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|mask
op_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|fi-&gt;poll_wait_complete
comma
id|pt
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|fi-&gt;req_complete
)paren
)paren
(brace
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|dev_open
r_static
r_int
id|dev_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|file_info
op_star
id|fi
suffix:semicolon
r_if
c_cond
(paren
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|V22_COMPAT_MOD_INC_USE_COUNT
suffix:semicolon
id|fi
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|file_info
)paren
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fi
op_eq
l_int|NULL
)paren
(brace
id|V22_COMPAT_MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|fi
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|file_info
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|fi-&gt;list
)paren
suffix:semicolon
id|fi-&gt;state
op_assign
id|opened
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|fi-&gt;req_pending
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|fi-&gt;req_complete
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|fi-&gt;complete_sem
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|fi-&gt;poll_wait_complete
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|fi
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dev_release
r_static
r_int
id|dev_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|file_info
op_star
id|fi
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|pending_request
op_star
id|req
suffix:semicolon
r_int
id|done
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fi-&gt;listen_channels
op_amp
(paren
l_int|1ULL
op_lshift
id|i
)paren
)paren
(brace
id|hpsb_unlisten_channel
c_func
(paren
id|hl_handle
comma
id|fi-&gt;host
comma
id|i
)paren
suffix:semicolon
)brace
)brace
id|spin_lock
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
id|fi-&gt;listen_channels
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|fi-&gt;req_complete
)paren
)paren
(brace
id|lh
op_assign
id|fi-&gt;req_complete.next
suffix:semicolon
id|list_del
c_func
(paren
id|lh
)paren
suffix:semicolon
id|req
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|pending_request
comma
id|list
)paren
suffix:semicolon
id|free_pending_request
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|fi-&gt;req_pending
)paren
)paren
(brace
id|done
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|fi-&gt;reqlists_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
(brace
id|down_interruptible
c_func
(paren
op_amp
id|fi-&gt;complete_sem
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|fi-&gt;state
op_eq
id|connected
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|fi-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
id|hpsb_dec_host_usage
c_func
(paren
id|fi-&gt;host
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|fi
)paren
suffix:semicolon
id|V22_COMPAT_MOD_DEC_USE_COUNT
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hl_ops
r_static
r_struct
id|hpsb_highlevel_ops
id|hl_ops
op_assign
(brace
id|add_host
suffix:colon
id|add_host
comma
id|remove_host
suffix:colon
id|remove_host
comma
id|host_reset
suffix:colon
id|host_reset
comma
id|iso_receive
suffix:colon
id|iso_receive
comma
id|fcp_request
suffix:colon
id|fcp_request
comma
)brace
suffix:semicolon
DECL|variable|file_ops
r_static
r_struct
id|file_operations
id|file_ops
op_assign
(brace
id|OWNER_THIS_MODULE
id|read
suffix:colon
id|dev_read
comma
id|write
suffix:colon
id|dev_write
comma
id|poll
suffix:colon
id|dev_poll
comma
id|open
suffix:colon
id|dev_open
comma
id|release
suffix:colon
id|dev_release
comma
)brace
suffix:semicolon
DECL|function|init_raw1394
r_int
id|init_raw1394
c_func
(paren
r_void
)paren
(brace
id|hl_handle
op_assign
id|hpsb_register_highlevel
c_func
(paren
id|RAW1394_DEVICE_NAME
comma
op_amp
id|hl_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hl_handle
op_eq
l_int|NULL
)paren
(brace
id|HPSB_ERR
c_func
(paren
l_string|&quot;raw1394 failed to register with ieee1394 highlevel&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|devfs_handle
op_assign
id|devfs_register
c_func
(paren
l_int|NULL
comma
id|RAW1394_DEVICE_NAME
comma
id|DEVFS_FL_NONE
comma
id|RAW1394_DEVICE_MAJOR
comma
l_int|0
comma
id|S_IFCHR
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
op_amp
id|file_ops
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devfs_register_chrdev
c_func
(paren
id|RAW1394_DEVICE_MAJOR
comma
id|RAW1394_DEVICE_NAME
comma
op_amp
id|file_ops
)paren
)paren
(brace
id|HPSB_ERR
c_func
(paren
l_string|&quot;raw1394 failed to register /dev/raw1394 device&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;raw1394: /dev/%s device initialized&bslash;n&quot;
comma
id|RAW1394_DEVICE_NAME
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_raw1394
r_void
id|cleanup_raw1394
c_func
(paren
r_void
)paren
(brace
id|devfs_unregister_chrdev
c_func
(paren
id|RAW1394_DEVICE_MAJOR
comma
id|RAW1394_DEVICE_NAME
)paren
suffix:semicolon
id|devfs_unregister
c_func
(paren
id|devfs_handle
)paren
suffix:semicolon
id|hpsb_unregister_highlevel
c_func
(paren
id|hl_handle
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|init_raw1394
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_return
id|cleanup_raw1394
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
