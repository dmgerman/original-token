multiline_comment|/*&n; * I2C driver for parallel port&n; *&n; * Author: Phil Blundell &lt;philb@gnu.org&gt;&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; *&n; * This driver implements a simple I2C protocol by bit-twiddling some&n; * signals on the parallel port.  Since the outputs on the parallel port&n; * aren&squot;t open collector, three lines rather than two are used:&n; *&n; *&t;D0&t;clock out&n; *&t;D1&t;data out&n; *&t;BUSY&t;data in&t;&n; */
macro_line|#include &lt;linux/parport.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/i2c-old.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
DECL|macro|I2C_DELAY
mdefine_line|#define I2C_DELAY   10
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
DECL|struct|parport_i2c_bus
r_struct
id|parport_i2c_bus
(brace
DECL|member|i2c
r_struct
id|i2c_bus
id|i2c
suffix:semicolon
DECL|member|next
r_struct
id|parport_i2c_bus
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|bus_list
r_static
r_struct
id|parport_i2c_bus
op_star
id|bus_list
suffix:semicolon
DECL|variable|bus_list_lock
r_static
id|spinlock_t
id|bus_list_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* software I2C functions */
DECL|function|i2c_setlines
r_static
r_void
id|i2c_setlines
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|clk
comma
r_int
id|data
)paren
(brace
r_struct
id|parport
op_star
id|p
op_assign
id|bus-&gt;data
suffix:semicolon
id|parport_write_data
c_func
(paren
id|p
comma
(paren
id|clk
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_or
(paren
id|data
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|I2C_DELAY
)paren
suffix:semicolon
)brace
DECL|function|i2c_getdataline
r_static
r_int
id|i2c_getdataline
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
)paren
(brace
r_struct
id|parport
op_star
id|p
op_assign
id|bus-&gt;data
suffix:semicolon
r_return
(paren
id|parport_read_status
c_func
(paren
id|p
)paren
op_amp
id|PARPORT_STATUS_BUSY
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
)brace
DECL|variable|parport_i2c_bus_template
r_static
r_struct
id|i2c_bus
id|parport_i2c_bus_template
op_assign
(brace
l_string|&quot;...&quot;
comma
id|I2C_BUSID_PARPORT
comma
l_int|NULL
comma
id|SPIN_LOCK_UNLOCKED
comma
l_int|NULL
comma
l_int|NULL
comma
id|i2c_setlines
comma
id|i2c_getdataline
comma
l_int|NULL
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|function|i2c_parport_attach
r_static
r_void
id|i2c_parport_attach
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_struct
id|parport_i2c_bus
op_star
id|b
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|parport_i2c_bus
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|b-&gt;i2c
op_assign
id|parport_i2c_bus_template
suffix:semicolon
id|b-&gt;i2c.data
op_assign
id|parport_get_port
(paren
id|port
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|b-&gt;i2c.name
comma
id|port-&gt;name
comma
l_int|32
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|bus_list_lock
)paren
suffix:semicolon
id|b-&gt;next
op_assign
id|bus_list
suffix:semicolon
id|bus_list
op_assign
id|b
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|bus_list_lock
)paren
suffix:semicolon
id|i2c_register_bus
c_func
(paren
op_amp
id|b-&gt;i2c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;i2c: attached to %s&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
)brace
DECL|function|i2c_parport_detach
r_static
r_void
id|i2c_parport_detach
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_struct
id|parport_i2c_bus
op_star
id|b
comma
op_star
id|old_b
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|bus_list_lock
)paren
suffix:semicolon
id|b
op_assign
id|bus_list
suffix:semicolon
r_while
c_loop
(paren
id|b
)paren
(brace
r_if
c_cond
(paren
id|b-&gt;i2c.data
op_eq
id|port
)paren
(brace
r_if
c_cond
(paren
id|old_b
)paren
id|old_b-&gt;next
op_assign
id|b-&gt;next
suffix:semicolon
r_else
id|bus_list
op_assign
id|b-&gt;next
suffix:semicolon
id|i2c_unregister_bus
c_func
(paren
op_amp
id|b-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|b
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|old_b
op_assign
id|b
suffix:semicolon
id|b
op_assign
id|b-&gt;next
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|bus_list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;i2c: detached from %s&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
)brace
DECL|variable|parport_i2c_driver
r_static
r_struct
id|parport_driver
id|parport_i2c_driver
op_assign
(brace
l_string|&quot;i2c&quot;
comma
id|i2c_parport_attach
comma
id|i2c_parport_detach
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|i2c_parport_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
id|printk
c_func
(paren
l_string|&quot;I2C: driver for parallel port v0.1 philb@gnu.org&bslash;n&quot;
)paren
suffix:semicolon
id|parport_register_driver
c_func
(paren
op_amp
id|parport_i2c_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|parport_i2c_bus
op_star
id|b
op_assign
id|bus_list
suffix:semicolon
r_while
c_loop
(paren
id|b
)paren
(brace
r_struct
id|parport_i2c_bus
op_star
id|next
op_assign
id|b-&gt;next
suffix:semicolon
id|i2c_unregister_bus
c_func
(paren
op_amp
id|b-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|b
)paren
suffix:semicolon
id|b
op_assign
id|next
suffix:semicolon
)brace
id|parport_unregister_driver
c_func
(paren
op_amp
id|parport_i2c_driver
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
