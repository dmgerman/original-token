multiline_comment|/* $Id: ffb_drv.c,v 1.7 2000/11/12 10:01:41 davem Exp $&n; * ffb_drv.c: Creator/Creator3D direct rendering driver.&n; *&n; * Copyright (C) 2000 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &quot;drmP.h&quot;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/upa.h&gt;
macro_line|#include &quot;ffb_drv.h&quot;
DECL|macro|FFB_NAME
mdefine_line|#define FFB_NAME&t;&quot;ffb&quot;
DECL|macro|FFB_DESC
mdefine_line|#define FFB_DESC&t;&quot;Creator/Creator3D&quot;
DECL|macro|FFB_DATE
mdefine_line|#define FFB_DATE&t;&quot;20000517&quot;
DECL|macro|FFB_MAJOR
mdefine_line|#define FFB_MAJOR&t;0
DECL|macro|FFB_MINOR
mdefine_line|#define FFB_MINOR&t;0
DECL|macro|FFB_PATCHLEVEL
mdefine_line|#define FFB_PATCHLEVEL&t;1
multiline_comment|/* Forward declarations. */
r_int
id|ffb_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|ffb_cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|ffb_version
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ffb_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|ffb_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|ffb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ffb_lock
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ffb_unlock
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|ffb_mmap
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
suffix:semicolon
multiline_comment|/* From ffb_context.c */
r_extern
r_int
id|ffb_resctx
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|ffb_addctx
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|ffb_modctx
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|ffb_getctx
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|ffb_switchctx
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|ffb_newctx
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|ffb_rmctx
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|ffb_context_switch
c_func
(paren
id|drm_device_t
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
DECL|variable|ffb_fops
r_static
r_struct
id|file_operations
id|ffb_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|open
suffix:colon
id|ffb_open
comma
id|flush
suffix:colon
id|drm_flush
comma
id|release
suffix:colon
id|ffb_release
comma
id|ioctl
suffix:colon
id|ffb_ioctl
comma
id|mmap
suffix:colon
id|ffb_mmap
comma
id|read
suffix:colon
id|drm_read
comma
id|fasync
suffix:colon
id|drm_fasync
comma
id|poll
suffix:colon
id|drm_poll
comma
)brace
suffix:semicolon
multiline_comment|/* This is just a template, we make a new copy for each FFB&n; * we discover at init time so that each one gets a unique&n; * misc device minor number.&n; */
DECL|variable|ffb_misc
r_static
r_struct
id|miscdevice
id|ffb_misc
op_assign
(brace
id|minor
suffix:colon
id|MISC_DYNAMIC_MINOR
comma
id|name
suffix:colon
id|FFB_NAME
comma
id|fops
suffix:colon
op_amp
id|ffb_fops
comma
)brace
suffix:semicolon
DECL|variable|ffb_ioctls
r_static
id|drm_ioctl_desc_t
id|ffb_ioctls
(braket
)braket
op_assign
(brace
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_VERSION
)paren
)braket
op_assign
(brace
id|ffb_version
comma
l_int|0
comma
l_int|0
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_GET_UNIQUE
)paren
)braket
op_assign
(brace
id|drm_getunique
comma
l_int|0
comma
l_int|0
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_GET_MAGIC
)paren
)braket
op_assign
(brace
id|drm_getmagic
comma
l_int|0
comma
l_int|0
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_IRQ_BUSID
)paren
)braket
op_assign
(brace
id|drm_irq_busid
comma
l_int|0
comma
l_int|1
)brace
comma
multiline_comment|/* XXX */
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_SET_UNIQUE
)paren
)braket
op_assign
(brace
id|drm_setunique
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_BLOCK
)paren
)braket
op_assign
(brace
id|drm_block
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_UNBLOCK
)paren
)braket
op_assign
(brace
id|drm_unblock
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_AUTH_MAGIC
)paren
)braket
op_assign
(brace
id|drm_authmagic
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_ADD_MAP
)paren
)braket
op_assign
(brace
id|drm_addmap
comma
l_int|1
comma
l_int|1
)brace
comma
multiline_comment|/* The implementation is currently a nop just like on tdfx.&n;&t; * Later we can do something more clever. -DaveM&n;&t; */
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_ADD_CTX
)paren
)braket
op_assign
(brace
id|ffb_addctx
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_RM_CTX
)paren
)braket
op_assign
(brace
id|ffb_rmctx
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_MOD_CTX
)paren
)braket
op_assign
(brace
id|ffb_modctx
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_GET_CTX
)paren
)braket
op_assign
(brace
id|ffb_getctx
comma
l_int|1
comma
l_int|0
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_SWITCH_CTX
)paren
)braket
op_assign
(brace
id|ffb_switchctx
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_NEW_CTX
)paren
)braket
op_assign
(brace
id|ffb_newctx
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_RES_CTX
)paren
)braket
op_assign
(brace
id|ffb_resctx
comma
l_int|1
comma
l_int|0
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_ADD_DRAW
)paren
)braket
op_assign
(brace
id|drm_adddraw
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_RM_DRAW
)paren
)braket
op_assign
(brace
id|drm_rmdraw
comma
l_int|1
comma
l_int|1
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_LOCK
)paren
)braket
op_assign
(brace
id|ffb_lock
comma
l_int|1
comma
l_int|0
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_UNLOCK
)paren
)braket
op_assign
(brace
id|ffb_unlock
comma
l_int|1
comma
l_int|0
)brace
comma
(braket
id|DRM_IOCTL_NR
c_func
(paren
id|DRM_IOCTL_FINISH
)paren
)braket
op_assign
(brace
id|drm_finish
comma
l_int|1
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|macro|FFB_IOCTL_COUNT
mdefine_line|#define FFB_IOCTL_COUNT DRM_ARRAY_SIZE(ffb_ioctls)
macro_line|#ifdef MODULE
DECL|variable|ffb
r_static
r_char
op_star
id|ffb
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David S. Miller (davem@redhat.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Sun Creator/Creator3D DRI&quot;
)paren
suffix:semicolon
DECL|function|ffb_takedown
r_static
r_int
id|ffb_takedown
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|drm_magic_entry_t
op_star
id|pt
comma
op_star
id|next
suffix:semicolon
id|drm_map_t
op_star
id|map
suffix:semicolon
id|drm_vma_entry_t
op_star
id|vma
comma
op_star
id|vma_next
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;struct_sem
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|dev-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;devname
)paren
(brace
id|drm_free
c_func
(paren
id|dev-&gt;devname
comma
id|strlen
c_func
(paren
id|dev-&gt;devname
)paren
op_plus
l_int|1
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|dev-&gt;devname
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;unique
)paren
(brace
id|drm_free
c_func
(paren
id|dev-&gt;unique
comma
id|strlen
c_func
(paren
id|dev-&gt;unique
)paren
op_plus
l_int|1
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|dev-&gt;unique
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;unique_len
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Clear pid list */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DRM_HASH_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|pt
op_assign
id|dev-&gt;magiclist
(braket
id|i
)braket
dot
id|head
suffix:semicolon
id|pt
suffix:semicolon
id|pt
op_assign
id|next
)paren
(brace
id|next
op_assign
id|pt-&gt;next
suffix:semicolon
id|drm_free
c_func
(paren
id|pt
comma
r_sizeof
(paren
op_star
id|pt
)paren
comma
id|DRM_MEM_MAGIC
)paren
suffix:semicolon
)brace
id|dev-&gt;magiclist
(braket
id|i
)braket
dot
id|head
op_assign
id|dev-&gt;magiclist
(braket
id|i
)braket
dot
id|tail
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Clear vma list (only built for debugging) */
r_if
c_cond
(paren
id|dev-&gt;vmalist
)paren
(brace
r_for
c_loop
(paren
id|vma
op_assign
id|dev-&gt;vmalist
suffix:semicolon
id|vma
suffix:semicolon
id|vma
op_assign
id|vma_next
)paren
(brace
id|vma_next
op_assign
id|vma-&gt;next
suffix:semicolon
id|drm_free
c_func
(paren
id|vma
comma
r_sizeof
(paren
op_star
id|vma
)paren
comma
id|DRM_MEM_VMAS
)paren
suffix:semicolon
)brace
id|dev-&gt;vmalist
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Clear map area information */
r_if
c_cond
(paren
id|dev-&gt;maplist
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;map_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|map
op_assign
id|dev-&gt;maplist
(braket
id|i
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|map-&gt;type
)paren
(brace
r_case
id|_DRM_REGISTERS
suffix:colon
r_case
id|_DRM_FRAME_BUFFER
suffix:colon
id|drm_ioremapfree
c_func
(paren
id|map-&gt;handle
comma
id|map-&gt;size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_DRM_SHM
suffix:colon
id|drm_free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|map-&gt;handle
comma
id|drm_order
c_func
(paren
id|map-&gt;size
)paren
op_minus
id|PAGE_SHIFT
comma
id|DRM_MEM_SAREA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|drm_free
c_func
(paren
id|map
comma
r_sizeof
(paren
op_star
id|map
)paren
comma
id|DRM_MEM_MAPS
)paren
suffix:semicolon
)brace
id|drm_free
c_func
(paren
id|dev-&gt;maplist
comma
id|dev-&gt;map_count
op_star
r_sizeof
(paren
op_star
id|dev-&gt;maplist
)paren
comma
id|DRM_MEM_MAPS
)paren
suffix:semicolon
id|dev-&gt;maplist
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;map_count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;lock.hw_lock
)paren
(brace
id|dev-&gt;lock.hw_lock
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* SHM removed */
id|dev-&gt;lock.pid
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|dev-&gt;lock.lock_queue
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;struct_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ffb_dev_table
id|drm_device_t
op_star
op_star
id|ffb_dev_table
suffix:semicolon
DECL|variable|ffb_dev_table_size
r_static
r_int
id|ffb_dev_table_size
suffix:semicolon
DECL|function|get_ffb_type
r_static
r_void
id|get_ffb_type
c_func
(paren
id|ffb_dev_priv_t
op_star
id|ffb_priv
comma
r_int
id|instance
)paren
(brace
r_volatile
r_int
r_char
op_star
id|strap_bits
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
id|strap_bits
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
(paren
id|ffb_priv-&gt;card_phys_base
op_plus
l_int|0x00200000UL
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t ask, you have to read the value twice for whatever&n;&t; * reason to get correct contents.&n;&t; */
id|val
op_assign
id|upa_readb
c_func
(paren
id|strap_bits
)paren
suffix:semicolon
id|val
op_assign
id|upa_readb
c_func
(paren
id|strap_bits
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|val
op_amp
l_int|0x78
)paren
(brace
r_case
(paren
l_int|0x0
op_lshift
l_int|5
)paren
op_or
(paren
l_int|0x0
op_lshift
l_int|3
)paren
suffix:colon
id|ffb_priv-&gt;ffb_type
op_assign
id|ffb1_prototype
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ffb%d: Detected FFB1 pre-FCS prototype&bslash;n&quot;
comma
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x0
op_lshift
l_int|5
)paren
op_or
(paren
l_int|0x1
op_lshift
l_int|3
)paren
suffix:colon
id|ffb_priv-&gt;ffb_type
op_assign
id|ffb1_standard
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ffb%d: Detected FFB1&bslash;n&quot;
comma
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x0
op_lshift
l_int|5
)paren
op_or
(paren
l_int|0x3
op_lshift
l_int|3
)paren
suffix:colon
id|ffb_priv-&gt;ffb_type
op_assign
id|ffb1_speedsort
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ffb%d: Detected FFB1-SpeedSort&bslash;n&quot;
comma
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x1
op_lshift
l_int|5
)paren
op_or
(paren
l_int|0x0
op_lshift
l_int|3
)paren
suffix:colon
id|ffb_priv-&gt;ffb_type
op_assign
id|ffb2_prototype
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ffb%d: Detected FFB2/vertical pre-FCS prototype&bslash;n&quot;
comma
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x1
op_lshift
l_int|5
)paren
op_or
(paren
l_int|0x1
op_lshift
l_int|3
)paren
suffix:colon
id|ffb_priv-&gt;ffb_type
op_assign
id|ffb2_vertical
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ffb%d: Detected FFB2/vertical&bslash;n&quot;
comma
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x1
op_lshift
l_int|5
)paren
op_or
(paren
l_int|0x2
op_lshift
l_int|3
)paren
suffix:colon
id|ffb_priv-&gt;ffb_type
op_assign
id|ffb2_vertical_plus
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ffb%d: Detected FFB2+/vertical&bslash;n&quot;
comma
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x2
op_lshift
l_int|5
)paren
op_or
(paren
l_int|0x0
op_lshift
l_int|3
)paren
suffix:colon
id|ffb_priv-&gt;ffb_type
op_assign
id|ffb2_horizontal
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ffb%d: Detected FFB2/horizontal&bslash;n&quot;
comma
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
l_int|0x2
op_lshift
l_int|5
)paren
op_or
(paren
l_int|0x2
op_lshift
l_int|3
)paren
suffix:colon
id|ffb_priv-&gt;ffb_type
op_assign
id|ffb2_horizontal
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ffb%d: Detected FFB2+/horizontal&bslash;n&quot;
comma
id|instance
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ffb_priv-&gt;ffb_type
op_assign
id|ffb2_vertical
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ffb%d: Unknown boardID[%08x], assuming FFB2&bslash;n&quot;
comma
id|instance
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
DECL|function|ffb_init_one
r_static
r_int
id|__init
id|ffb_init_one
c_func
(paren
r_int
id|prom_node
comma
r_int
id|instance
)paren
(brace
r_struct
id|linux_prom64_registers
id|regs
(braket
l_int|2
op_star
id|PROMREG_MAX
)braket
suffix:semicolon
id|drm_device_t
op_star
id|dev
suffix:semicolon
id|ffb_dev_priv_t
op_star
id|ffb_priv
suffix:semicolon
r_int
id|ret
comma
id|i
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|drm_device_t
)paren
op_plus
r_sizeof
(paren
id|ffb_dev_priv_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dev
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;count_lock
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|dev-&gt;struct_sem
comma
l_int|1
)paren
suffix:semicolon
id|ffb_priv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
id|ffb_priv-&gt;prom_node
op_assign
id|prom_node
suffix:semicolon
r_if
c_cond
(paren
id|prom_getproperty
c_func
(paren
id|ffb_priv-&gt;prom_node
comma
l_string|&quot;reg&quot;
comma
(paren
r_void
op_star
)paren
id|regs
comma
r_sizeof
(paren
id|regs
)paren
)paren
op_le
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ffb_priv-&gt;card_phys_base
op_assign
id|regs
(braket
l_int|0
)braket
dot
id|phys_addr
suffix:semicolon
id|ffb_priv-&gt;regs
op_assign
(paren
id|ffb_fbcPtr
)paren
(paren
id|regs
(braket
l_int|0
)braket
dot
id|phys_addr
op_plus
l_int|0x00600000UL
)paren
suffix:semicolon
id|get_ffb_type
c_func
(paren
id|ffb_priv
comma
id|instance
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FFB_MAX_CTXS
suffix:semicolon
id|i
op_increment
)paren
id|ffb_priv-&gt;hw_state
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ffb_dev_table
(braket
id|instance
)braket
op_assign
id|dev
suffix:semicolon
macro_line|#ifdef MODULE
id|drm_parse_options
c_func
(paren
id|ffb
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
op_amp
id|ffb_priv-&gt;miscdev
comma
op_amp
id|ffb_misc
comma
r_sizeof
(paren
id|ffb_misc
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|misc_register
c_func
(paren
op_amp
id|ffb_priv-&gt;miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ffb_dev_table
(braket
id|instance
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|dev-&gt;device
op_assign
id|MKDEV
c_func
(paren
id|MISC_MAJOR
comma
id|ffb_priv-&gt;miscdev.minor
)paren
suffix:semicolon
id|dev-&gt;name
op_assign
id|FFB_NAME
suffix:semicolon
id|drm_mem_init
c_func
(paren
)paren
suffix:semicolon
id|drm_proc_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DRM_INFO
c_func
(paren
l_string|&quot;Initialized %s %d.%d.%d %s on minor %d at %016lx&bslash;n&quot;
comma
id|FFB_NAME
comma
id|FFB_MAJOR
comma
id|FFB_MINOR
comma
id|FFB_PATCHLEVEL
comma
id|FFB_DATE
comma
id|ffb_priv-&gt;miscdev.minor
comma
id|ffb_priv-&gt;card_phys_base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_init_dev_table
r_static
r_int
id|__init
id|ffb_init_dev_table
c_func
(paren
r_void
)paren
(brace
r_int
id|root
comma
id|node
suffix:semicolon
r_int
id|total
op_assign
l_int|0
suffix:semicolon
id|root
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
r_for
c_loop
(paren
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|root
comma
l_string|&quot;SUNW,ffb&quot;
)paren
suffix:semicolon
id|node
suffix:semicolon
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|prom_getsibling
c_func
(paren
id|node
)paren
comma
l_string|&quot;SUNW,ffb&quot;
)paren
)paren
id|total
op_increment
suffix:semicolon
id|ffb_dev_table
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|drm_device_t
op_star
)paren
op_star
id|total
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ffb_dev_table
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ffb_dev_table_size
op_assign
id|total
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_init
r_int
id|__init
id|ffb_init
c_func
(paren
r_void
)paren
(brace
r_int
id|root
comma
id|node
comma
id|instance
comma
id|ret
suffix:semicolon
id|ret
op_assign
id|ffb_init_dev_table
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|instance
op_assign
l_int|0
suffix:semicolon
id|root
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
r_for
c_loop
(paren
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|root
comma
l_string|&quot;SUNW,ffb&quot;
)paren
suffix:semicolon
id|node
suffix:semicolon
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|prom_getsibling
c_func
(paren
id|node
)paren
comma
l_string|&quot;SUNW,ffb&quot;
)paren
)paren
(brace
id|ret
op_assign
id|ffb_init_one
c_func
(paren
id|node
comma
id|instance
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|instance
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_cleanup
r_void
id|__exit
id|ffb_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|instance
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|drm_proc_cleanup
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|instance
op_assign
l_int|0
suffix:semicolon
id|instance
OL
id|ffb_dev_table_size
suffix:semicolon
id|instance
op_increment
)paren
(brace
id|drm_device_t
op_star
id|dev
op_assign
id|ffb_dev_table
(braket
id|instance
)braket
suffix:semicolon
id|ffb_dev_priv_t
op_star
id|ffb_priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_continue
suffix:semicolon
id|ffb_priv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|misc_deregister
c_func
(paren
op_amp
id|ffb_priv-&gt;miscdev
)paren
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Cannot unload module&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DRM_INFO
c_func
(paren
l_string|&quot;Module unloaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ffb_takedown
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ffb_dev_table
(braket
id|instance
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ffb_dev_table
)paren
suffix:semicolon
id|ffb_dev_table
op_assign
l_int|NULL
suffix:semicolon
id|ffb_dev_table_size
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_version
r_static
r_int
id|ffb_version
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_version_t
id|version
suffix:semicolon
r_int
id|len
comma
id|ret
suffix:semicolon
id|ret
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|version
comma
(paren
id|drm_version_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|version.version_major
op_assign
id|FFB_MAJOR
suffix:semicolon
id|version.version_minor
op_assign
id|FFB_MINOR
suffix:semicolon
id|version.version_patchlevel
op_assign
id|FFB_PATCHLEVEL
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|FFB_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|version.name_len
)paren
id|len
op_assign
id|version.name_len
suffix:semicolon
id|version.name_len
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|version.name
)paren
(brace
id|ret
op_assign
id|copy_to_user
c_func
(paren
id|version.name
comma
id|FFB_NAME
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|len
op_assign
id|strlen
c_func
(paren
id|FFB_DATE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|version.date_len
)paren
id|len
op_assign
id|version.date_len
suffix:semicolon
id|version.date_len
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|version.date
)paren
(brace
id|ret
op_assign
id|copy_to_user
c_func
(paren
id|version.date
comma
id|FFB_DATE
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|len
op_assign
id|strlen
c_func
(paren
id|FFB_DESC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|version.desc_len
)paren
id|len
op_assign
id|version.desc_len
suffix:semicolon
id|version.desc_len
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|version.desc
)paren
(brace
id|ret
op_assign
id|copy_to_user
c_func
(paren
id|version.desc
comma
id|FFB_DESC
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ret
op_assign
id|copy_to_user
c_func
(paren
(paren
id|drm_version_t
op_star
)paren
id|arg
comma
op_amp
id|version
comma
r_sizeof
(paren
id|version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ffb_setup
r_static
r_int
id|ffb_setup
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;ioctl_count
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;vma_count
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;buf_use
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;buf_alloc
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;total_open
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;total_close
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;total_ioctl
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;total_irq
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;total_ctx
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;total_locks
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;total_unlocks
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;total_contends
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;total_sleeps
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DRM_HASH_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;magiclist
(braket
id|i
)braket
dot
id|head
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;magiclist
(braket
id|i
)braket
dot
id|tail
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dev-&gt;maplist
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;map_count
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;vmalist
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;lock.hw_lock
op_assign
l_int|NULL
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev-&gt;lock.lock_queue
)paren
suffix:semicolon
id|dev-&gt;queue_count
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;queue_reserved
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;queue_slots
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;queuelist
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;context_flag
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt_flag
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma_flag
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;last_context
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;last_switch
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;last_checked
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|dev-&gt;timer
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev-&gt;context_wait
)paren
suffix:semicolon
id|dev-&gt;ctx_start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;lck_start
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;buf_rp
op_assign
id|dev-&gt;buf
suffix:semicolon
id|dev-&gt;buf_wp
op_assign
id|dev-&gt;buf
suffix:semicolon
id|dev-&gt;buf_end
op_assign
id|dev-&gt;buf
op_plus
id|DRM_BSZ
suffix:semicolon
id|dev-&gt;buf_async
op_assign
l_int|NULL
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev-&gt;buf_readers
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev-&gt;buf_writers
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_open
r_static
r_int
id|ffb_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|drm_device_t
op_star
id|dev
suffix:semicolon
r_int
id|minor
comma
id|i
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ffb_dev_table_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ffb_dev_priv_t
op_star
id|ffb_priv
suffix:semicolon
id|ffb_priv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|ffb_dev_table
(braket
id|i
)braket
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ffb_priv-&gt;miscdev.minor
op_eq
id|minor
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|ffb_dev_table_size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev
op_assign
id|ffb_dev_table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;open_count = %d&bslash;n&quot;
comma
id|dev-&gt;open_count
)paren
suffix:semicolon
id|ret
op_assign
id|drm_open_helper
c_func
(paren
id|inode
comma
id|filp
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_open
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;count_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;open_count
op_increment
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;count_lock
)paren
suffix:semicolon
r_return
id|ffb_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;count_lock
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ffb_release
r_static
r_int
id|ffb_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;open_count = %d&bslash;n&quot;
comma
id|dev-&gt;open_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;lock.hw_lock
op_ne
l_int|NULL
op_logical_and
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_and
id|dev-&gt;lock.pid
op_eq
id|current-&gt;pid
)paren
(brace
id|ffb_dev_priv_t
op_star
id|fpriv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
r_int
id|context
op_assign
id|_DRM_LOCKING_CONTEXT
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
suffix:semicolon
r_int
id|idx
suffix:semicolon
multiline_comment|/* We have to free up the rogue hw context state&n;&t;&t; * holding error or else we will leak it.&n;&t;&t; */
id|idx
op_assign
id|context
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fpriv-&gt;hw_state
(braket
id|idx
)braket
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|fpriv-&gt;hw_state
(braket
id|idx
)braket
)paren
suffix:semicolon
id|fpriv-&gt;hw_state
(braket
id|idx
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|drm_release
c_func
(paren
id|inode
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_close
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;count_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|dev-&gt;open_count
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;ioctl_count
)paren
op_logical_or
id|dev-&gt;blocked
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Device busy: %d %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;ioctl_count
)paren
comma
id|dev-&gt;blocked
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;count_lock
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;count_lock
)paren
suffix:semicolon
id|ret
op_assign
id|ffb_takedown
c_func
(paren
id|dev
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;count_lock
)paren
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ffb_ioctl
r_static
r_int
id|ffb_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|nr
op_assign
id|DRM_IOCTL_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_ioctl_desc_t
op_star
id|ioctl
suffix:semicolon
id|drm_ioctl_t
op_star
id|func
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;ioctl_count
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_ioctl
)paren
suffix:semicolon
op_increment
id|priv-&gt;ioctl_count
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;pid = %d, cmd = 0x%02x, nr = 0x%02x, dev 0x%x, auth = %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|cmd
comma
id|nr
comma
id|dev-&gt;device
comma
id|priv-&gt;authenticated
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr
op_ge
id|FFB_IOCTL_COUNT
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|ioctl
op_assign
op_amp
id|ffb_ioctls
(braket
id|nr
)braket
suffix:semicolon
id|func
op_assign
id|ioctl-&gt;func
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|func
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;no function&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ioctl-&gt;root_only
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
op_logical_or
(paren
id|ioctl-&gt;auth_needed
op_logical_and
op_logical_neg
id|priv-&gt;authenticated
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EACCES
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
(paren
id|func
)paren
(paren
id|inode
comma
id|filp
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
)brace
id|atomic_dec
c_func
(paren
op_amp
id|dev-&gt;ioctl_count
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ffb_lock
r_static
r_int
id|ffb_lock
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|entry
comma
id|current
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|drm_lock_t
id|lock
suffix:semicolon
id|ret
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|lock
comma
(paren
id|drm_lock_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|lock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|lock.context
op_eq
id|DRM_KERNEL_CONTEXT
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d using kernel context %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|lock.context
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d (pid %d) requests lock (0x%08x), flags = 0x%08x&bslash;n&quot;
comma
id|lock.context
comma
id|current-&gt;pid
comma
id|dev-&gt;lock.hw_lock-&gt;lock
comma
id|lock.flags
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|dev-&gt;lock.lock_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;lock.hw_lock
)paren
(brace
multiline_comment|/* Device has been unregistered */
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|drm_lock_take
c_func
(paren
op_amp
id|dev-&gt;lock.hw_lock-&gt;lock
comma
id|lock.context
)paren
)paren
(brace
id|dev-&gt;lock.pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|dev-&gt;lock.lock_time
op_assign
id|jiffies
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_locks
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Got lock */
)brace
multiline_comment|/* Contention */
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_sleeps
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;policy
op_or_assign
id|SCHED_YIELD
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dev-&gt;lock.lock_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_and
(paren
id|dev-&gt;last_context
op_ne
id|lock.context
)paren
)paren
id|ffb_context_switch
c_func
(paren
id|dev
comma
id|dev-&gt;last_context
comma
id|lock.context
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d %s&bslash;n&quot;
comma
id|lock.context
comma
id|ret
ques
c_cond
l_string|&quot;interrupted&quot;
suffix:colon
l_string|&quot;has lock&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ffb_unlock
r_int
id|ffb_unlock
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_lock_t
id|lock
suffix:semicolon
r_int
r_int
id|old
comma
r_new
comma
id|prev
comma
id|ctx
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|lock
comma
(paren
id|drm_lock_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|lock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ctx
op_assign
id|lock.context
)paren
op_eq
id|DRM_KERNEL_CONTEXT
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d using kernel context %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|lock.context
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d frees lock (%d holds)&bslash;n&quot;
comma
id|lock.context
comma
id|_DRM_LOCKING_CONTEXT
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_unlocks
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_DRM_LOCK_IS_CONT
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
)paren
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_contends
)paren
suffix:semicolon
multiline_comment|/* We no longer really hold it, but if we are the next&n;&t; * agent to request it then we should just be able to&n;&t; * take it immediately and not eat the ioctl.&n;&t; */
id|dev-&gt;lock.pid
op_assign
l_int|0
suffix:semicolon
(brace
id|__volatile__
r_int
r_int
op_star
id|plock
op_assign
op_amp
id|dev-&gt;lock.hw_lock-&gt;lock
suffix:semicolon
r_do
(brace
id|old
op_assign
op_star
id|plock
suffix:semicolon
r_new
op_assign
id|ctx
suffix:semicolon
id|prev
op_assign
id|cmpxchg
c_func
(paren
id|plock
comma
id|old
comma
r_new
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|prev
op_ne
id|old
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|dev-&gt;lock.lock_queue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|align_fb_mapping
r_static
r_void
id|align_fb_mapping
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_int
r_int
id|j
comma
id|alignment
suffix:semicolon
id|j
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_for
c_loop
(paren
id|alignment
op_assign
(paren
l_int|4
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
id|alignment
OG
id|PAGE_SIZE
suffix:semicolon
id|alignment
op_rshift_assign
l_int|3
)paren
r_if
c_cond
(paren
id|j
op_ge
id|alignment
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|alignment
OG
id|PAGE_SIZE
)paren
(brace
id|j
op_assign
id|alignment
suffix:semicolon
id|alignment
op_assign
id|j
op_minus
(paren
id|vma-&gt;vm_start
op_amp
(paren
id|j
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alignment
op_ne
id|j
)paren
(brace
r_struct
id|vm_area_struct
op_star
id|vmm
op_assign
id|find_vma
c_func
(paren
id|current-&gt;mm
comma
id|vma-&gt;vm_start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vmm
op_logical_or
id|vmm-&gt;vm_start
op_ge
id|vma-&gt;vm_end
op_plus
id|alignment
)paren
(brace
id|vma-&gt;vm_start
op_add_assign
id|alignment
suffix:semicolon
id|vma-&gt;vm_end
op_add_assign
id|alignment
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* The problem here is, due to virtual cache aliasing,&n; * we must make sure the shared memory area lands in the&n; * same dcache line for both the kernel and all drm clients.&n; */
DECL|function|align_shm_mapping
r_static
r_void
id|align_shm_mapping
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|kvirt
)paren
(brace
id|kvirt
op_and_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|vma-&gt;vm_start
op_amp
id|PAGE_SIZE
)paren
op_ne
id|kvirt
)paren
(brace
r_struct
id|vm_area_struct
op_star
id|vmm
op_assign
id|find_vma
c_func
(paren
id|current-&gt;mm
comma
id|vma-&gt;vm_start
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vmm
op_logical_or
id|vmm-&gt;vm_start
op_ge
id|vma-&gt;vm_end
op_plus
id|PAGE_SIZE
)paren
(brace
id|vma-&gt;vm_start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|vma-&gt;vm_end
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
)brace
r_extern
r_struct
id|vm_operations_struct
id|drm_vm_ops
suffix:semicolon
r_extern
r_struct
id|vm_operations_struct
id|drm_vm_shm_ops
suffix:semicolon
r_extern
r_struct
id|vm_operations_struct
id|drm_vm_shm_lock_ops
suffix:semicolon
DECL|function|ffb_mmap
r_static
r_int
id|ffb_mmap
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_map_t
op_star
id|map
op_assign
l_int|NULL
suffix:semicolon
id|ffb_dev_priv_t
op_star
id|ffb_priv
suffix:semicolon
r_int
id|i
comma
id|minor
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;start = 0x%lx, end = 0x%lx, offset = 0x%lx&bslash;n&quot;
comma
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_end
comma
id|VM_OFFSET
c_func
(paren
id|vma
)paren
)paren
suffix:semicolon
id|minor
op_assign
id|MINOR
c_func
(paren
id|filp-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
id|ffb_priv
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ffb_dev_table_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ffb_priv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|ffb_dev_table
(braket
id|i
)braket
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ffb_priv-&gt;miscdev.minor
op_eq
id|minor
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|ffb_dev_table_size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* We don&squot;t support/need dma mappings, so... */
r_if
c_cond
(paren
op_logical_neg
id|VM_OFFSET
c_func
(paren
id|vma
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;map_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|off
suffix:semicolon
id|map
op_assign
id|dev-&gt;maplist
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Ok, a little hack to make 32-bit apps work. */
id|off
op_assign
(paren
id|map-&gt;offset
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|off
op_eq
id|VM_OFFSET
c_func
(paren
id|vma
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|dev-&gt;map_count
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|map
op_logical_or
(paren
(paren
id|map-&gt;flags
op_amp
id|_DRM_RESTRICTED
)paren
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;size
op_ne
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Set read-only attribute before mappings are created&n;&t; * so it works for fb/reg maps too.&n;&t; */
r_if
c_cond
(paren
id|map-&gt;flags
op_amp
id|_DRM_READ_ONLY
)paren
id|vma-&gt;vm_page_prot
op_assign
id|__pgprot
c_func
(paren
id|pte_val
c_func
(paren
id|pte_wrprotect
c_func
(paren
id|__pte
c_func
(paren
id|pgprot_val
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
)paren
)paren
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|map-&gt;type
)paren
(brace
r_case
id|_DRM_FRAME_BUFFER
suffix:colon
id|align_fb_mapping
c_func
(paren
id|vma
)paren
suffix:semicolon
multiline_comment|/* FALLTHROUGH */
r_case
id|_DRM_REGISTERS
suffix:colon
multiline_comment|/* In order to handle 32-bit drm apps/xserver we&n;&t;&t; * play a trick.  The mappings only really specify&n;&t;&t; * the 32-bit offset from the cards 64-bit base&n;&t;&t; * address, and we just add in the base here.&n;&t;&t; */
id|vma-&gt;vm_flags
op_or_assign
id|VM_IO
suffix:semicolon
r_if
c_cond
(paren
id|io_remap_page_range
c_func
(paren
id|vma-&gt;vm_start
comma
id|ffb_priv-&gt;card_phys_base
op_plus
id|VM_OFFSET
c_func
(paren
id|vma
)paren
comma
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_page_prot
comma
l_int|0
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|vma-&gt;vm_ops
op_assign
op_amp
id|drm_vm_ops
suffix:semicolon
r_break
suffix:semicolon
r_case
id|_DRM_SHM
suffix:colon
id|align_shm_mapping
c_func
(paren
id|vma
comma
(paren
r_int
r_int
)paren
id|dev-&gt;lock.hw_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;flags
op_amp
id|_DRM_CONTAINS_LOCK
)paren
id|vma-&gt;vm_ops
op_assign
op_amp
id|drm_vm_shm_lock_ops
suffix:semicolon
r_else
(brace
id|vma-&gt;vm_ops
op_assign
op_amp
id|drm_vm_shm_ops
suffix:semicolon
id|vma-&gt;vm_private_data
op_assign
(paren
r_void
op_star
)paren
id|map
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t let this area swap.  Change when&n;&t;&t; * DRM_KERNEL advisory is supported.&n;&t;&t; */
id|vma-&gt;vm_flags
op_or_assign
id|VM_LOCKED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* This should never happen. */
)brace
suffix:semicolon
id|vma-&gt;vm_flags
op_or_assign
id|VM_LOCKED
op_or
id|VM_SHM
suffix:semicolon
multiline_comment|/* Don&squot;t swap */
id|vma-&gt;vm_file
op_assign
id|filp
suffix:semicolon
multiline_comment|/* Needed for drm_vm_open() */
id|drm_vm_open
c_func
(paren
id|vma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ffb_init
id|module_init
c_func
(paren
id|ffb_init
)paren
suffix:semicolon
DECL|variable|ffb_cleanup
id|module_exit
c_func
(paren
id|ffb_cleanup
)paren
suffix:semicolon
eof
