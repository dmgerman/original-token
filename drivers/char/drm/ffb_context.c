multiline_comment|/* $Id: ffb_context.c,v 1.4 2000/08/29 07:01:55 davem Exp $&n; * ffb_context.c: Creator/Creator3D DRI/DRM context switching.&n; *&n; * Copyright (C) 2000 David S. Miller (davem@redhat.com)&n; *&n; * Almost entirely stolen from tdfx_context.c, see there&n; * for authors.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/upa.h&gt;
macro_line|#include &quot;drmP.h&quot;
macro_line|#include &quot;ffb_drv.h&quot;
DECL|function|ffb_alloc_queue
r_static
r_int
id|ffb_alloc_queue
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
id|is_2d_only
)paren
(brace
id|ffb_dev_priv_t
op_star
id|fpriv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|FFB_MAX_CTXS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fpriv-&gt;hw_state
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|FFB_MAX_CTXS
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|fpriv-&gt;hw_state
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ffb_hw_context
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fpriv-&gt;hw_state
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|fpriv-&gt;hw_state
(braket
id|i
)braket
op_member_access_from_pointer
id|is_2d_only
op_assign
id|is_2d_only
suffix:semicolon
multiline_comment|/* Plus one because 0 is the special DRM_KERNEL_CONTEXT. */
r_return
id|i
op_plus
l_int|1
suffix:semicolon
)brace
DECL|function|ffb_save_context
r_static
r_void
id|ffb_save_context
c_func
(paren
id|ffb_dev_priv_t
op_star
id|fpriv
comma
r_int
id|idx
)paren
(brace
id|ffb_fbcPtr
id|ffb
op_assign
id|fpriv-&gt;regs
suffix:semicolon
r_struct
id|ffb_hw_context
op_star
id|ctx
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ctx
op_assign
id|fpriv-&gt;hw_state
(braket
id|idx
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_eq
l_int|0
op_logical_or
id|ctx
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ctx-&gt;is_2d_only
)paren
(brace
multiline_comment|/* 2D applications only care about certain pieces&n;&t;&t; * of state.&n;&t;&t; */
id|ctx-&gt;drawop
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;drawop
)paren
suffix:semicolon
id|ctx-&gt;ppc
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;ppc
)paren
suffix:semicolon
id|ctx-&gt;wid
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;wid
)paren
suffix:semicolon
id|ctx-&gt;fg
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fg
)paren
suffix:semicolon
id|ctx-&gt;bg
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;bg
)paren
suffix:semicolon
id|ctx-&gt;xclip
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;xclip
)paren
suffix:semicolon
id|ctx-&gt;fbc
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fbc
)paren
suffix:semicolon
id|ctx-&gt;rop
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;rop
)paren
suffix:semicolon
id|ctx-&gt;cmp
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;cmp
)paren
suffix:semicolon
id|ctx-&gt;matchab
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;matchab
)paren
suffix:semicolon
id|ctx-&gt;magnab
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;magnab
)paren
suffix:semicolon
id|ctx-&gt;pmask
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;pmask
)paren
suffix:semicolon
id|ctx-&gt;xpmask
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;xpmask
)paren
suffix:semicolon
id|ctx-&gt;lpat
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;lpat
)paren
suffix:semicolon
id|ctx-&gt;fontxy
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fontxy
)paren
suffix:semicolon
id|ctx-&gt;fontw
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fontw
)paren
suffix:semicolon
id|ctx-&gt;fontinc
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fontinc
)paren
suffix:semicolon
multiline_comment|/* stencil/stencilctl only exists on FFB2+ and later&n;&t;&t; * due to the introduction of 3DRAM-III.&n;&t;&t; */
r_if
c_cond
(paren
id|fpriv-&gt;ffb_type
op_eq
id|ffb2_vertical_plus
op_logical_or
id|fpriv-&gt;ffb_type
op_eq
id|ffb2_horizontal_plus
)paren
(brace
id|ctx-&gt;stencil
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;stencil
)paren
suffix:semicolon
id|ctx-&gt;stencilctl
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;stencilctl
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|ctx-&gt;area_pattern
(braket
id|i
)braket
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;pattern
(braket
id|i
)braket
)paren
suffix:semicolon
id|ctx-&gt;ucsr
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;ucsr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Fetch drawop. */
id|ctx-&gt;drawop
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;drawop
)paren
suffix:semicolon
multiline_comment|/* If we were saving the vertex registers, this is where&n;&t; * we would do it.  We would save 32 32-bit words starting&n;&t; * at ffb-&gt;suvtx.&n;&t; */
multiline_comment|/* Capture rendering attributes. */
id|ctx-&gt;ppc
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;ppc
)paren
suffix:semicolon
multiline_comment|/* Pixel Processor Control */
id|ctx-&gt;wid
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;wid
)paren
suffix:semicolon
multiline_comment|/* Current WID */
id|ctx-&gt;fg
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fg
)paren
suffix:semicolon
multiline_comment|/* Constant FG color */
id|ctx-&gt;bg
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;bg
)paren
suffix:semicolon
multiline_comment|/* Constant BG color */
id|ctx-&gt;consty
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;consty
)paren
suffix:semicolon
multiline_comment|/* Constant Y */
id|ctx-&gt;constz
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;constz
)paren
suffix:semicolon
multiline_comment|/* Constant Z */
id|ctx-&gt;xclip
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;xclip
)paren
suffix:semicolon
multiline_comment|/* X plane clip */
id|ctx-&gt;dcss
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcss
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Slope */
id|ctx-&gt;vclipmin
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;vclipmin
)paren
suffix:semicolon
multiline_comment|/* Primary XY clip, minimum */
id|ctx-&gt;vclipmax
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;vclipmax
)paren
suffix:semicolon
multiline_comment|/* Primary XY clip, maximum */
id|ctx-&gt;vclipzmin
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;vclipzmin
)paren
suffix:semicolon
multiline_comment|/* Primary Z clip, minimum */
id|ctx-&gt;vclipzmax
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;vclipzmax
)paren
suffix:semicolon
multiline_comment|/* Primary Z clip, maximum */
id|ctx-&gt;dcsf
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcsf
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Front Bound */
id|ctx-&gt;dcsb
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcsb
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Back Bound */
id|ctx-&gt;dczf
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dczf
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Z Front */
id|ctx-&gt;dczb
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dczb
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Z Back */
id|ctx-&gt;blendc
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;blendc
)paren
suffix:semicolon
multiline_comment|/* Alpha Blend Control */
id|ctx-&gt;blendc1
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;blendc1
)paren
suffix:semicolon
multiline_comment|/* Alpha Blend Color 1 */
id|ctx-&gt;blendc2
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;blendc2
)paren
suffix:semicolon
multiline_comment|/* Alpha Blend Color 2 */
id|ctx-&gt;fbc
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fbc
)paren
suffix:semicolon
multiline_comment|/* Frame Buffer Control */
id|ctx-&gt;rop
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;rop
)paren
suffix:semicolon
multiline_comment|/* Raster Operation */
id|ctx-&gt;cmp
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;cmp
)paren
suffix:semicolon
multiline_comment|/* Compare Controls */
id|ctx-&gt;matchab
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;matchab
)paren
suffix:semicolon
multiline_comment|/* Buffer A/B Match Ops */
id|ctx-&gt;matchc
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;matchc
)paren
suffix:semicolon
multiline_comment|/* Buffer C Match Ops */
id|ctx-&gt;magnab
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;magnab
)paren
suffix:semicolon
multiline_comment|/* Buffer A/B Magnitude Ops */
id|ctx-&gt;magnc
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;magnc
)paren
suffix:semicolon
multiline_comment|/* Buffer C Magnitude Ops */
id|ctx-&gt;pmask
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;pmask
)paren
suffix:semicolon
multiline_comment|/* RGB Plane Mask */
id|ctx-&gt;xpmask
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;xpmask
)paren
suffix:semicolon
multiline_comment|/* X Plane Mask */
id|ctx-&gt;ypmask
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;ypmask
)paren
suffix:semicolon
multiline_comment|/* Y Plane Mask */
id|ctx-&gt;zpmask
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;zpmask
)paren
suffix:semicolon
multiline_comment|/* Z Plane Mask */
multiline_comment|/* Auxiliary Clips. */
id|ctx-&gt;auxclip0min
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;auxclip
(braket
l_int|0
)braket
dot
id|min
)paren
suffix:semicolon
id|ctx-&gt;auxclip0max
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;auxclip
(braket
l_int|0
)braket
dot
id|max
)paren
suffix:semicolon
id|ctx-&gt;auxclip1min
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;auxclip
(braket
l_int|1
)braket
dot
id|min
)paren
suffix:semicolon
id|ctx-&gt;auxclip1max
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;auxclip
(braket
l_int|1
)braket
dot
id|max
)paren
suffix:semicolon
id|ctx-&gt;auxclip2min
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;auxclip
(braket
l_int|2
)braket
dot
id|min
)paren
suffix:semicolon
id|ctx-&gt;auxclip2max
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;auxclip
(braket
l_int|2
)braket
dot
id|max
)paren
suffix:semicolon
id|ctx-&gt;auxclip3min
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;auxclip
(braket
l_int|3
)braket
dot
id|min
)paren
suffix:semicolon
id|ctx-&gt;auxclip3max
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;auxclip
(braket
l_int|3
)braket
dot
id|max
)paren
suffix:semicolon
id|ctx-&gt;lpat
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;lpat
)paren
suffix:semicolon
multiline_comment|/* Line Pattern */
id|ctx-&gt;fontxy
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fontxy
)paren
suffix:semicolon
multiline_comment|/* XY Font Coordinate */
id|ctx-&gt;fontw
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fontw
)paren
suffix:semicolon
multiline_comment|/* Font Width */
id|ctx-&gt;fontinc
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;fontinc
)paren
suffix:semicolon
multiline_comment|/* Font X/Y Increment */
multiline_comment|/* These registers/features only exist on FFB2 and later chips. */
r_if
c_cond
(paren
id|fpriv-&gt;ffb_type
op_ge
id|ffb2_prototype
)paren
(brace
id|ctx-&gt;dcss1
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcss1
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Slope 1 */
id|ctx-&gt;dcss2
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcss2
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Slope 2 */
id|ctx-&gt;dcss2
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcss3
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Slope 3 */
id|ctx-&gt;dcs2
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcs2
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale 2 */
id|ctx-&gt;dcs3
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcs3
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale 3 */
id|ctx-&gt;dcs4
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcs4
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale 4 */
id|ctx-&gt;dcd2
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcd2
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Depth 2 */
id|ctx-&gt;dcd3
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcd3
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Depth 3 */
id|ctx-&gt;dcd4
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;dcd4
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Depth 4 */
multiline_comment|/* And stencil/stencilctl only exists on FFB2+ and later&n;&t;&t; * due to the introduction of 3DRAM-III.&n;&t;&t; */
r_if
c_cond
(paren
id|fpriv-&gt;ffb_type
op_eq
id|ffb2_vertical_plus
op_logical_or
id|fpriv-&gt;ffb_type
op_eq
id|ffb2_horizontal_plus
)paren
(brace
id|ctx-&gt;stencil
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;stencil
)paren
suffix:semicolon
id|ctx-&gt;stencilctl
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;stencilctl
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Save the 32x32 area pattern. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|ctx-&gt;area_pattern
(braket
id|i
)braket
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;pattern
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Finally, stash away the User Constol/Status Register. */
id|ctx-&gt;ucsr
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;ucsr
)paren
suffix:semicolon
)brace
DECL|function|ffb_restore_context
r_static
r_void
id|ffb_restore_context
c_func
(paren
id|ffb_dev_priv_t
op_star
id|fpriv
comma
r_int
id|old
comma
r_int
id|idx
)paren
(brace
id|ffb_fbcPtr
id|ffb
op_assign
id|fpriv-&gt;regs
suffix:semicolon
r_struct
id|ffb_hw_context
op_star
id|ctx
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ctx
op_assign
id|fpriv-&gt;hw_state
(braket
id|idx
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_eq
l_int|0
op_logical_or
id|ctx
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ctx-&gt;is_2d_only
)paren
(brace
multiline_comment|/* 2D applications only care about certain pieces&n;&t;&t; * of state.&n;&t;&t; */
id|upa_writel
c_func
(paren
id|ctx-&gt;drawop
comma
op_amp
id|ffb-&gt;drawop
)paren
suffix:semicolon
multiline_comment|/* If we were restoring the vertex registers, this is where&n;&t;&t; * we would do it.  We would restore 32 32-bit words starting&n;&t;&t; * at ffb-&gt;suvtx.&n;&t;&t; */
id|upa_writel
c_func
(paren
id|ctx-&gt;ppc
comma
op_amp
id|ffb-&gt;ppc
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;wid
comma
op_amp
id|ffb-&gt;wid
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;fg
comma
op_amp
id|ffb-&gt;fg
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;bg
comma
op_amp
id|ffb-&gt;bg
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;xclip
comma
op_amp
id|ffb-&gt;xclip
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;fbc
comma
op_amp
id|ffb-&gt;fbc
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;rop
comma
op_amp
id|ffb-&gt;rop
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;cmp
comma
op_amp
id|ffb-&gt;cmp
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;matchab
comma
op_amp
id|ffb-&gt;matchab
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;magnab
comma
op_amp
id|ffb-&gt;magnab
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;pmask
comma
op_amp
id|ffb-&gt;pmask
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;xpmask
comma
op_amp
id|ffb-&gt;xpmask
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;lpat
comma
op_amp
id|ffb-&gt;lpat
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;fontxy
comma
op_amp
id|ffb-&gt;fontxy
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;fontw
comma
op_amp
id|ffb-&gt;fontw
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;fontinc
comma
op_amp
id|ffb-&gt;fontinc
)paren
suffix:semicolon
multiline_comment|/* stencil/stencilctl only exists on FFB2+ and later&n;&t;&t; * due to the introduction of 3DRAM-III.&n;&t;&t; */
r_if
c_cond
(paren
id|fpriv-&gt;ffb_type
op_eq
id|ffb2_vertical_plus
op_logical_or
id|fpriv-&gt;ffb_type
op_eq
id|ffb2_horizontal_plus
)paren
(brace
id|upa_writel
c_func
(paren
id|ctx-&gt;stencil
comma
op_amp
id|ffb-&gt;stencil
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;stencilctl
comma
op_amp
id|ffb-&gt;stencilctl
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
l_int|0x80000000
comma
op_amp
id|ffb-&gt;fbc
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
(paren
id|ctx-&gt;stencilctl
op_or
l_int|0x80000
)paren
comma
op_amp
id|ffb-&gt;rawstencilctl
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;fbc
comma
op_amp
id|ffb-&gt;fbc
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|upa_writel
c_func
(paren
id|ctx-&gt;area_pattern
(braket
id|i
)braket
comma
op_amp
id|ffb-&gt;pattern
(braket
id|i
)braket
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
(paren
id|ctx-&gt;ucsr
op_amp
l_int|0xf0000
)paren
comma
op_amp
id|ffb-&gt;ucsr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Restore drawop. */
id|upa_writel
c_func
(paren
id|ctx-&gt;drawop
comma
op_amp
id|ffb-&gt;drawop
)paren
suffix:semicolon
multiline_comment|/* If we were restoring the vertex registers, this is where&n;&t; * we would do it.  We would restore 32 32-bit words starting&n;&t; * at ffb-&gt;suvtx.&n;&t; */
multiline_comment|/* Restore rendering attributes. */
id|upa_writel
c_func
(paren
id|ctx-&gt;ppc
comma
op_amp
id|ffb-&gt;ppc
)paren
suffix:semicolon
multiline_comment|/* Pixel Processor Control */
id|upa_writel
c_func
(paren
id|ctx-&gt;wid
comma
op_amp
id|ffb-&gt;wid
)paren
suffix:semicolon
multiline_comment|/* Current WID */
id|upa_writel
c_func
(paren
id|ctx-&gt;fg
comma
op_amp
id|ffb-&gt;fg
)paren
suffix:semicolon
multiline_comment|/* Constant FG color */
id|upa_writel
c_func
(paren
id|ctx-&gt;bg
comma
op_amp
id|ffb-&gt;bg
)paren
suffix:semicolon
multiline_comment|/* Constant BG color */
id|upa_writel
c_func
(paren
id|ctx-&gt;consty
comma
op_amp
id|ffb-&gt;consty
)paren
suffix:semicolon
multiline_comment|/* Constant Y */
id|upa_writel
c_func
(paren
id|ctx-&gt;constz
comma
op_amp
id|ffb-&gt;constz
)paren
suffix:semicolon
multiline_comment|/* Constant Z */
id|upa_writel
c_func
(paren
id|ctx-&gt;xclip
comma
op_amp
id|ffb-&gt;xclip
)paren
suffix:semicolon
multiline_comment|/* X plane clip */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcss
comma
op_amp
id|ffb-&gt;dcss
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Slope */
id|upa_writel
c_func
(paren
id|ctx-&gt;vclipmin
comma
op_amp
id|ffb-&gt;vclipmin
)paren
suffix:semicolon
multiline_comment|/* Primary XY clip, minimum */
id|upa_writel
c_func
(paren
id|ctx-&gt;vclipmax
comma
op_amp
id|ffb-&gt;vclipmax
)paren
suffix:semicolon
multiline_comment|/* Primary XY clip, maximum */
id|upa_writel
c_func
(paren
id|ctx-&gt;vclipzmin
comma
op_amp
id|ffb-&gt;vclipzmin
)paren
suffix:semicolon
multiline_comment|/* Primary Z clip, minimum */
id|upa_writel
c_func
(paren
id|ctx-&gt;vclipzmax
comma
op_amp
id|ffb-&gt;vclipzmax
)paren
suffix:semicolon
multiline_comment|/* Primary Z clip, maximum */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcsf
comma
op_amp
id|ffb-&gt;dcsf
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Front Bound */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcsb
comma
op_amp
id|ffb-&gt;dcsb
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Back Bound */
id|upa_writel
c_func
(paren
id|ctx-&gt;dczf
comma
op_amp
id|ffb-&gt;dczf
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Z Front */
id|upa_writel
c_func
(paren
id|ctx-&gt;dczb
comma
op_amp
id|ffb-&gt;dczb
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Z Back */
id|upa_writel
c_func
(paren
id|ctx-&gt;blendc
comma
op_amp
id|ffb-&gt;blendc
)paren
suffix:semicolon
multiline_comment|/* Alpha Blend Control */
id|upa_writel
c_func
(paren
id|ctx-&gt;blendc1
comma
op_amp
id|ffb-&gt;blendc1
)paren
suffix:semicolon
multiline_comment|/* Alpha Blend Color 1 */
id|upa_writel
c_func
(paren
id|ctx-&gt;blendc2
comma
op_amp
id|ffb-&gt;blendc2
)paren
suffix:semicolon
multiline_comment|/* Alpha Blend Color 2 */
id|upa_writel
c_func
(paren
id|ctx-&gt;fbc
comma
op_amp
id|ffb-&gt;fbc
)paren
suffix:semicolon
multiline_comment|/* Frame Buffer Control */
id|upa_writel
c_func
(paren
id|ctx-&gt;rop
comma
op_amp
id|ffb-&gt;rop
)paren
suffix:semicolon
multiline_comment|/* Raster Operation */
id|upa_writel
c_func
(paren
id|ctx-&gt;cmp
comma
op_amp
id|ffb-&gt;cmp
)paren
suffix:semicolon
multiline_comment|/* Compare Controls */
id|upa_writel
c_func
(paren
id|ctx-&gt;matchab
comma
op_amp
id|ffb-&gt;matchab
)paren
suffix:semicolon
multiline_comment|/* Buffer A/B Match Ops */
id|upa_writel
c_func
(paren
id|ctx-&gt;matchc
comma
op_amp
id|ffb-&gt;matchc
)paren
suffix:semicolon
multiline_comment|/* Buffer C Match Ops */
id|upa_writel
c_func
(paren
id|ctx-&gt;magnab
comma
op_amp
id|ffb-&gt;magnab
)paren
suffix:semicolon
multiline_comment|/* Buffer A/B Magnitude Ops */
id|upa_writel
c_func
(paren
id|ctx-&gt;magnc
comma
op_amp
id|ffb-&gt;magnc
)paren
suffix:semicolon
multiline_comment|/* Buffer C Magnitude Ops */
id|upa_writel
c_func
(paren
id|ctx-&gt;pmask
comma
op_amp
id|ffb-&gt;pmask
)paren
suffix:semicolon
multiline_comment|/* RGB Plane Mask */
id|upa_writel
c_func
(paren
id|ctx-&gt;xpmask
comma
op_amp
id|ffb-&gt;xpmask
)paren
suffix:semicolon
multiline_comment|/* X Plane Mask */
id|upa_writel
c_func
(paren
id|ctx-&gt;ypmask
comma
op_amp
id|ffb-&gt;ypmask
)paren
suffix:semicolon
multiline_comment|/* Y Plane Mask */
id|upa_writel
c_func
(paren
id|ctx-&gt;zpmask
comma
op_amp
id|ffb-&gt;zpmask
)paren
suffix:semicolon
multiline_comment|/* Z Plane Mask */
multiline_comment|/* Auxiliary Clips. */
id|upa_writel
c_func
(paren
id|ctx-&gt;auxclip0min
comma
op_amp
id|ffb-&gt;auxclip
(braket
l_int|0
)braket
dot
id|min
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;auxclip0max
comma
op_amp
id|ffb-&gt;auxclip
(braket
l_int|0
)braket
dot
id|max
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;auxclip1min
comma
op_amp
id|ffb-&gt;auxclip
(braket
l_int|1
)braket
dot
id|min
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;auxclip1max
comma
op_amp
id|ffb-&gt;auxclip
(braket
l_int|1
)braket
dot
id|max
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;auxclip2min
comma
op_amp
id|ffb-&gt;auxclip
(braket
l_int|2
)braket
dot
id|min
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;auxclip2max
comma
op_amp
id|ffb-&gt;auxclip
(braket
l_int|2
)braket
dot
id|max
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;auxclip3min
comma
op_amp
id|ffb-&gt;auxclip
(braket
l_int|3
)braket
dot
id|min
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;auxclip3max
comma
op_amp
id|ffb-&gt;auxclip
(braket
l_int|3
)braket
dot
id|max
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;lpat
comma
op_amp
id|ffb-&gt;lpat
)paren
suffix:semicolon
multiline_comment|/* Line Pattern */
id|upa_writel
c_func
(paren
id|ctx-&gt;fontxy
comma
op_amp
id|ffb-&gt;fontxy
)paren
suffix:semicolon
multiline_comment|/* XY Font Coordinate */
id|upa_writel
c_func
(paren
id|ctx-&gt;fontw
comma
op_amp
id|ffb-&gt;fontw
)paren
suffix:semicolon
multiline_comment|/* Font Width */
id|upa_writel
c_func
(paren
id|ctx-&gt;fontinc
comma
op_amp
id|ffb-&gt;fontinc
)paren
suffix:semicolon
multiline_comment|/* Font X/Y Increment */
multiline_comment|/* These registers/features only exist on FFB2 and later chips. */
r_if
c_cond
(paren
id|fpriv-&gt;ffb_type
op_ge
id|ffb2_prototype
)paren
(brace
id|upa_writel
c_func
(paren
id|ctx-&gt;dcss1
comma
op_amp
id|ffb-&gt;dcss1
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Slope 1 */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcss2
comma
op_amp
id|ffb-&gt;dcss2
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Slope 2 */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcss3
comma
op_amp
id|ffb-&gt;dcss2
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale Slope 3 */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcs2
comma
op_amp
id|ffb-&gt;dcs2
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale 2 */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcs3
comma
op_amp
id|ffb-&gt;dcs3
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale 3 */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcs4
comma
op_amp
id|ffb-&gt;dcs4
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Scale 4 */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcd2
comma
op_amp
id|ffb-&gt;dcd2
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Depth 2 */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcd3
comma
op_amp
id|ffb-&gt;dcd3
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Depth 3 */
id|upa_writel
c_func
(paren
id|ctx-&gt;dcd4
comma
op_amp
id|ffb-&gt;dcd4
)paren
suffix:semicolon
multiline_comment|/* Depth Cue Depth 4 */
multiline_comment|/* And stencil/stencilctl only exists on FFB2+ and later&n;&t;&t; * due to the introduction of 3DRAM-III.&n;&t;&t; */
r_if
c_cond
(paren
id|fpriv-&gt;ffb_type
op_eq
id|ffb2_vertical_plus
op_logical_or
id|fpriv-&gt;ffb_type
op_eq
id|ffb2_horizontal_plus
)paren
(brace
multiline_comment|/* Unfortunately, there is a hardware bug on&n;&t;&t;&t; * the FFB2+ chips which prevents a normal write&n;&t;&t;&t; * to the stencil control register from working&n;&t;&t;&t; * as it should.&n;&t;&t;&t; *&n;&t;&t;&t; * The state controlled by the FFB stencilctl register&n;&t;&t;&t; * really gets transferred to the per-buffer instances&n;&t;&t;&t; * of the stencilctl register in the 3DRAM chips.&n;&t;&t;&t; *&n;&t;&t;&t; * The bug is that FFB does not update buffer C correctly,&n;&t;&t;&t; * so we have to do it by hand for them.&n;&t;&t;&t; */
multiline_comment|/* This will update buffers A and B. */
id|upa_writel
c_func
(paren
id|ctx-&gt;stencil
comma
op_amp
id|ffb-&gt;stencil
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
id|ctx-&gt;stencilctl
comma
op_amp
id|ffb-&gt;stencilctl
)paren
suffix:semicolon
multiline_comment|/* Force FFB to use buffer C 3dram regs. */
id|upa_writel
c_func
(paren
l_int|0x80000000
comma
op_amp
id|ffb-&gt;fbc
)paren
suffix:semicolon
id|upa_writel
c_func
(paren
(paren
id|ctx-&gt;stencilctl
op_or
l_int|0x80000
)paren
comma
op_amp
id|ffb-&gt;rawstencilctl
)paren
suffix:semicolon
multiline_comment|/* Now restore the correct FBC controls. */
id|upa_writel
c_func
(paren
id|ctx-&gt;fbc
comma
op_amp
id|ffb-&gt;fbc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Restore the 32x32 area pattern. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|upa_writel
c_func
(paren
id|ctx-&gt;area_pattern
(braket
id|i
)braket
comma
op_amp
id|ffb-&gt;pattern
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Finally, stash away the User Constol/Status Register.&n;&t; * The only state we really preserve here is the picking&n;&t; * control.&n;&t; */
id|upa_writel
c_func
(paren
(paren
id|ctx-&gt;ucsr
op_amp
l_int|0xf0000
)paren
comma
op_amp
id|ffb-&gt;ucsr
)paren
suffix:semicolon
)brace
DECL|macro|FFB_UCSR_FB_BUSY
mdefine_line|#define FFB_UCSR_FB_BUSY       0x01000000
DECL|macro|FFB_UCSR_RP_BUSY
mdefine_line|#define FFB_UCSR_RP_BUSY       0x02000000
DECL|macro|FFB_UCSR_ALL_BUSY
mdefine_line|#define FFB_UCSR_ALL_BUSY      (FFB_UCSR_RP_BUSY|FFB_UCSR_FB_BUSY)
DECL|function|FFBWait
r_static
r_void
id|FFBWait
c_func
(paren
id|ffb_fbcPtr
id|ffb
)paren
(brace
r_int
id|limit
op_assign
l_int|100000
suffix:semicolon
r_do
(brace
id|u32
id|regval
op_assign
id|upa_readl
c_func
(paren
op_amp
id|ffb-&gt;ucsr
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|regval
op_amp
id|FFB_UCSR_ALL_BUSY
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|limit
)paren
suffix:semicolon
)brace
DECL|function|ffb_context_switch
r_int
id|ffb_context_switch
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
id|old
comma
r_int
r_new
)paren
(brace
id|ffb_dev_priv_t
op_star
id|fpriv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_ctx
)paren
suffix:semicolon
macro_line|#if DRM_DMA_HISTOGRAM
id|dev-&gt;ctx_start
op_assign
id|get_cycles
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|DRM_DEBUG
c_func
(paren
l_string|&quot;Context switch from %d to %d&bslash;n&quot;
comma
id|old
comma
r_new
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
op_eq
id|dev-&gt;last_context
op_logical_or
id|dev-&gt;last_context
op_eq
l_int|0
)paren
(brace
id|dev-&gt;last_context
op_assign
r_new
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|FFBWait
c_func
(paren
id|fpriv-&gt;regs
)paren
suffix:semicolon
id|ffb_save_context
c_func
(paren
id|fpriv
comma
id|old
)paren
suffix:semicolon
id|ffb_restore_context
c_func
(paren
id|fpriv
comma
id|old
comma
r_new
)paren
suffix:semicolon
id|FFBWait
c_func
(paren
id|fpriv-&gt;regs
)paren
suffix:semicolon
id|dev-&gt;last_context
op_assign
r_new
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_resctx
r_int
id|ffb_resctx
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_ctx_res_t
id|res
suffix:semicolon
id|drm_ctx_t
id|ctx
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|DRM_RESERVED_CONTEXTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|res
comma
(paren
id|drm_ctx_res_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|res
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|res.count
op_ge
id|DRM_RESERVED_CONTEXTS
)paren
(brace
id|memset
c_func
(paren
op_amp
id|ctx
comma
l_int|0
comma
r_sizeof
(paren
id|ctx
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DRM_RESERVED_CONTEXTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ctx.handle
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|res.contexts
(braket
id|i
)braket
comma
op_amp
id|i
comma
r_sizeof
(paren
id|i
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
id|res.count
op_assign
id|DRM_RESERVED_CONTEXTS
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|drm_ctx_res_t
op_star
)paren
id|arg
comma
op_amp
id|res
comma
r_sizeof
(paren
id|res
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_addctx
r_int
id|ffb_addctx
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_ctx_t
id|ctx
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ctx
comma
(paren
id|drm_ctx_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ctx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|idx
op_assign
id|ffb_alloc_queue
c_func
(paren
id|dev
comma
(paren
id|ctx.flags
op_amp
id|_DRM_CONTEXT_2DONLY
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
)paren
r_return
op_minus
id|ENFILE
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|ctx.handle
)paren
suffix:semicolon
id|ctx.handle
op_assign
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|drm_ctx_t
op_star
)paren
id|arg
comma
op_amp
id|ctx
comma
r_sizeof
(paren
id|ctx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_modctx
r_int
id|ffb_modctx
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|ffb_dev_priv_t
op_star
id|fpriv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
r_struct
id|ffb_hw_context
op_star
id|hwctx
suffix:semicolon
id|drm_ctx_t
id|ctx
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ctx
comma
(paren
id|drm_ctx_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ctx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|idx
op_assign
id|ctx.handle
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_le
l_int|0
op_logical_or
id|idx
op_ge
id|FFB_MAX_CTXS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|hwctx
op_assign
id|fpriv-&gt;hw_state
(braket
id|idx
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hwctx
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ctx.flags
op_amp
id|_DRM_CONTEXT_2DONLY
)paren
op_eq
l_int|0
)paren
id|hwctx-&gt;is_2d_only
op_assign
l_int|0
suffix:semicolon
r_else
id|hwctx-&gt;is_2d_only
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_getctx
r_int
id|ffb_getctx
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|ffb_dev_priv_t
op_star
id|fpriv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
r_struct
id|ffb_hw_context
op_star
id|hwctx
suffix:semicolon
id|drm_ctx_t
id|ctx
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ctx
comma
(paren
id|drm_ctx_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ctx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|idx
op_assign
id|ctx.handle
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_le
l_int|0
op_logical_or
id|idx
op_ge
id|FFB_MAX_CTXS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|hwctx
op_assign
id|fpriv-&gt;hw_state
(braket
id|idx
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hwctx
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|hwctx-&gt;is_2d_only
op_ne
l_int|0
)paren
id|ctx.flags
op_assign
id|_DRM_CONTEXT_2DONLY
suffix:semicolon
r_else
id|ctx.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|drm_ctx_t
op_star
)paren
id|arg
comma
op_amp
id|ctx
comma
r_sizeof
(paren
id|ctx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_switchctx
r_int
id|ffb_switchctx
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_ctx_t
id|ctx
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ctx
comma
(paren
id|drm_ctx_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ctx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|ctx.handle
)paren
suffix:semicolon
r_return
id|ffb_context_switch
c_func
(paren
id|dev
comma
id|dev-&gt;last_context
comma
id|ctx.handle
)paren
suffix:semicolon
)brace
DECL|function|ffb_newctx
r_int
id|ffb_newctx
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_ctx_t
id|ctx
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ctx
comma
(paren
id|drm_ctx_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ctx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|ctx.handle
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ffb_rmctx
r_int
id|ffb_rmctx
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_ctx_t
id|ctx
suffix:semicolon
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|ffb_dev_priv_t
op_star
id|fpriv
op_assign
(paren
id|ffb_dev_priv_t
op_star
)paren
(paren
id|dev
op_plus
l_int|1
)paren
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ctx
comma
(paren
id|drm_ctx_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ctx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|ctx.handle
)paren
suffix:semicolon
id|idx
op_assign
id|ctx.handle
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
op_logical_or
id|idx
op_ge
id|FFB_MAX_CTXS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|fpriv-&gt;hw_state
(braket
id|idx
)braket
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|fpriv-&gt;hw_state
(braket
id|idx
)braket
)paren
suffix:semicolon
id|fpriv-&gt;hw_state
(braket
id|idx
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
