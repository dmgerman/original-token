multiline_comment|/* r128_drv.c -- ATI Rage 128 driver -*- linux-c -*-&n; * Created: Wed Apr  5 19:24:19 2000 by kevin@precisioninsight.com&n; *&n; * Copyright 2000 Precision Insight, Inc., Cedar Park, Texas.&n; * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.&n; * All Rights Reserved.&n; *&n; * Permission is hereby granted, free of charge, to any person obtaining a&n; * copy of this software and associated documentation files (the &quot;Software&quot;),&n; * to deal in the Software without restriction, including without limitation&n; * the rights to use, copy, modify, merge, publish, distribute, sublicense,&n; * and/or sell copies of the Software, and to permit persons to whom the&n; * Software is furnished to do so, subject to the following conditions:&n; *&n; * The above copyright notice and this permission notice (including the next&n; * paragraph) shall be included in all copies or substantial portions of the&n; * Software.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR&n; * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n; * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL&n; * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR&n; * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,&n; * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER&n; * DEALINGS IN THE SOFTWARE.&n; *&n; * Authors: Kevin E. Martin &lt;martin@valinux.com&gt;&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;drmP.h&quot;
macro_line|#include &quot;r128_drv.h&quot;
macro_line|#include &lt;linux/interrupt.h&gt;&t;/* For task queue support */
macro_line|#include &lt;linux/delay.h&gt;
DECL|macro|DO_REMAP
mdefine_line|#define DO_REMAP(_m) (_m)-&gt;handle = drm_ioremap((_m)-&gt;offset, (_m)-&gt;size)
DECL|macro|DO_REMAPFREE
mdefine_line|#define DO_REMAPFREE(_m)                                                    &bslash;&n;&t;do {                                                                &bslash;&n;&t;&t;if ((_m)-&gt;handle &amp;&amp; (_m)-&gt;size)                             &bslash;&n;&t;&t;&t;drm_ioremapfree((_m)-&gt;handle, (_m)-&gt;size);          &bslash;&n;&t;} while (0)
DECL|macro|DO_FIND_MAP
mdefine_line|#define DO_FIND_MAP(_m, _o)                                                 &bslash;&n;&t;do {                                                                &bslash;&n;&t;&t;int _i;                                                     &bslash;&n;&t;&t;for (_i = 0; _i &lt; dev-&gt;map_count; _i++) {                   &bslash;&n;&t;&t;&t;if (dev-&gt;maplist[_i]-&gt;offset == _o) {               &bslash;&n;&t;&t;&t;&t;_m = dev-&gt;maplist[_i];                      &bslash;&n;&t;&t;&t;&t;break;                                      &bslash;&n;&t;&t;&t;}                                                   &bslash;&n;&t;&t;}                                                           &bslash;&n;&t;} while (0)
DECL|macro|R128_MAX_VBUF_AGE
mdefine_line|#define R128_MAX_VBUF_AGE&t;0x10000000
DECL|macro|R128_VB_AGE_REG
mdefine_line|#define R128_VB_AGE_REG&t;&t;R128_GUI_SCRATCH_REG0
DECL|function|R128_READ_PLL
r_int
id|R128_READ_PLL
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
id|addr
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|R128_WRITE8
c_func
(paren
id|R128_CLOCK_CNTL_INDEX
comma
id|addr
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
id|R128_READ
c_func
(paren
id|R128_CLOCK_CNTL_DATA
)paren
suffix:semicolon
)brace
macro_line|#ifdef __i386__
DECL|function|r128_flush_write_combine
r_static
r_void
id|r128_flush_write_combine
c_func
(paren
r_void
)paren
(brace
r_int
id|xchangeDummy
suffix:semicolon
id|__asm__
r_volatile
(paren
l_string|&quot;push %%eax ;&quot;
l_string|&quot;xchg %%eax, %0 ;&quot;
l_string|&quot;pop %%eax&quot;
suffix:colon
suffix:colon
l_string|&quot;m&quot;
(paren
id|xchangeDummy
)paren
)paren
suffix:semicolon
id|__asm__
r_volatile
(paren
l_string|&quot;push %%eax ;&quot;
l_string|&quot;push %%ebx ;&quot;
l_string|&quot;push %%ecx ;&quot;
l_string|&quot;push %%edx ;&quot;
l_string|&quot;movl $0,%%eax ;&quot;
l_string|&quot;cpuid ;&quot;
l_string|&quot;pop %%edx ;&quot;
l_string|&quot;pop %%ecx ;&quot;
l_string|&quot;pop %%ebx ;&quot;
l_string|&quot;pop %%eax&quot;
suffix:colon
multiline_comment|/* no outputs */
suffix:colon
multiline_comment|/* no inputs */
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|function|r128_flush_write_combine
r_static
r_void
id|r128_flush_write_combine
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
DECL|function|r128_status
r_static
r_void
id|r128_status
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;GUI_STAT           = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_GUI_STAT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PM4_STAT           = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_STAT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PM4_BUFFER_DL_WPTR = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PM4_BUFFER_DL_RPTR = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_DL_RPTR
)paren
)paren
suffix:semicolon
)brace
DECL|function|r128_do_cleanup_cce
r_static
r_int
id|r128_do_cleanup_cce
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;dev_private
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|DO_REMAPFREE
c_func
(paren
id|dev_priv-&gt;agp_ring
)paren
suffix:semicolon
id|DO_REMAPFREE
c_func
(paren
id|dev_priv-&gt;agp_read_ptr
)paren
suffix:semicolon
id|DO_REMAPFREE
c_func
(paren
id|dev_priv-&gt;agp_vertbufs
)paren
suffix:semicolon
id|DO_REMAPFREE
c_func
(paren
id|dev_priv-&gt;agp_indbufs
)paren
suffix:semicolon
id|DO_REMAPFREE
c_func
(paren
id|dev_priv-&gt;agp_textures
)paren
suffix:semicolon
)brace
id|drm_free
c_func
(paren
id|dev-&gt;dev_private
comma
r_sizeof
(paren
id|drm_r128_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_do_init_cce
r_static
r_int
id|r128_do_init_cce
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_init_t
op_star
id|init
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev_priv
op_assign
id|drm_alloc
c_func
(paren
r_sizeof
(paren
id|drm_r128_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|memset
c_func
(paren
id|dev_priv
comma
l_int|0
comma
r_sizeof
(paren
id|drm_r128_private_t
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;is_pci
op_assign
id|init-&gt;is_pci
suffix:semicolon
id|dev_priv-&gt;usec_timeout
op_assign
id|init-&gt;usec_timeout
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;usec_timeout
template_param
id|R128_MAX_USEC_TIMEOUT
)paren
(brace
id|drm_free
c_func
(paren
id|dev_priv
comma
r_sizeof
(paren
op_star
id|dev_priv
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev_priv-&gt;cce_mode
op_assign
id|init-&gt;cce_mode
suffix:semicolon
id|dev_priv-&gt;cce_fifo_size
op_assign
id|init-&gt;cce_fifo_size
suffix:semicolon
id|dev_priv-&gt;cce_is_bm_mode
op_assign
(paren
(paren
id|init-&gt;cce_mode
op_eq
id|R128_PM4_192BM
)paren
op_logical_or
(paren
id|init-&gt;cce_mode
op_eq
id|R128_PM4_128BM_64INDBM
)paren
op_logical_or
(paren
id|init-&gt;cce_mode
op_eq
id|R128_PM4_64BM_128INDBM
)paren
op_logical_or
(paren
id|init-&gt;cce_mode
op_eq
id|R128_PM4_64BM_64VCBM_64INDBM
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;cce_secure
op_assign
id|init-&gt;cce_secure
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;cce_is_bm_mode
op_logical_and
id|dev_priv-&gt;is_pci
)paren
(brace
id|drm_free
c_func
(paren
id|dev_priv
comma
r_sizeof
(paren
op_star
id|dev_priv
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;map_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;maplist
(braket
id|i
)braket
op_member_access_from_pointer
id|type
op_eq
id|_DRM_SHM
)paren
(brace
id|dev_priv-&gt;sarea
op_assign
id|dev-&gt;maplist
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|DO_FIND_MAP
c_func
(paren
id|dev_priv-&gt;fb
comma
id|init-&gt;fb_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|DO_FIND_MAP
c_func
(paren
id|dev_priv-&gt;agp_ring
comma
id|init-&gt;agp_ring_offset
)paren
suffix:semicolon
id|DO_FIND_MAP
c_func
(paren
id|dev_priv-&gt;agp_read_ptr
comma
id|init-&gt;agp_read_ptr_offset
)paren
suffix:semicolon
id|DO_FIND_MAP
c_func
(paren
id|dev_priv-&gt;agp_vertbufs
comma
id|init-&gt;agp_vertbufs_offset
)paren
suffix:semicolon
id|DO_FIND_MAP
c_func
(paren
id|dev_priv-&gt;agp_indbufs
comma
id|init-&gt;agp_indbufs_offset
)paren
suffix:semicolon
id|DO_FIND_MAP
c_func
(paren
id|dev_priv-&gt;agp_textures
comma
id|init-&gt;agp_textures_offset
)paren
suffix:semicolon
)brace
id|DO_FIND_MAP
c_func
(paren
id|dev_priv-&gt;mmio
comma
id|init-&gt;mmio_offset
)paren
suffix:semicolon
id|dev_priv-&gt;sarea_priv
op_assign
(paren
id|drm_r128_sarea_t
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|dev_priv-&gt;sarea-&gt;handle
op_plus
id|init-&gt;sarea_priv_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|DO_REMAP
c_func
(paren
id|dev_priv-&gt;agp_ring
)paren
suffix:semicolon
id|DO_REMAP
c_func
(paren
id|dev_priv-&gt;agp_read_ptr
)paren
suffix:semicolon
id|DO_REMAP
c_func
(paren
id|dev_priv-&gt;agp_vertbufs
)paren
suffix:semicolon
macro_line|#if 0
id|DO_REMAP
c_func
(paren
id|dev_priv-&gt;agp_indirectbufs
)paren
suffix:semicolon
id|DO_REMAP
c_func
(paren
id|dev_priv-&gt;agp_textures
)paren
suffix:semicolon
macro_line|#endif
id|dev_priv-&gt;ring_size
op_assign
id|init-&gt;ring_size
suffix:semicolon
id|dev_priv-&gt;ring_sizel2qw
op_assign
id|drm_order
c_func
(paren
id|init-&gt;ring_size
op_div
l_int|8
)paren
suffix:semicolon
id|dev_priv-&gt;ring_entries
op_assign
id|init-&gt;ring_size
op_div
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|dev_priv-&gt;ring_read_ptr
op_assign
(paren
(paren
id|__volatile__
id|u32
op_star
)paren
id|dev_priv-&gt;agp_read_ptr-&gt;handle
)paren
suffix:semicolon
id|dev_priv-&gt;ring_start
op_assign
(paren
id|u32
op_star
)paren
id|dev_priv-&gt;agp_ring-&gt;handle
suffix:semicolon
id|dev_priv-&gt;ring_end
op_assign
(paren
(paren
id|u32
op_star
)paren
id|dev_priv-&gt;agp_ring-&gt;handle
op_plus
id|dev_priv-&gt;ring_entries
)paren
suffix:semicolon
)brace
id|dev_priv-&gt;submit_age
op_assign
l_int|0
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_VB_AGE_REG
comma
id|dev_priv-&gt;submit_age
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_init_cce
r_int
id|r128_init_cce
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_r128_init_t
id|init
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|init
comma
(paren
id|drm_r128_init_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|init
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|init.func
)paren
(brace
r_case
id|R128_INIT_CCE
suffix:colon
r_return
id|r128_do_init_cce
c_func
(paren
id|dev
comma
op_amp
id|init
)paren
suffix:semicolon
r_case
id|R128_CLEANUP_CCE
suffix:colon
r_return
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|r128_mark_vertbufs_done
r_static
r_void
id|r128_mark_vertbufs_done
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|drm_buf_t
op_star
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|buf_priv-&gt;age
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|r128_do_pixcache_flush
r_static
r_int
id|r128_do_pixcache_flush
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tmp
op_assign
id|R128_READ
c_func
(paren
id|R128_PC_NGUI_CTLSTAT
)paren
op_or
id|R128_PC_FLUSH_ALL
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PC_NGUI_CTLSTAT
comma
id|tmp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|R128_READ
c_func
(paren
id|R128_PC_NGUI_CTLSTAT
)paren
op_amp
id|R128_PC_BUSY
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|r128_do_wait_for_fifo
r_static
r_int
id|r128_do_wait_for_fifo
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
id|entries
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|slots
op_assign
id|R128_READ
c_func
(paren
id|R128_GUI_STAT
)paren
op_amp
id|R128_GUI_FIFOCNT_MASK
suffix:semicolon
r_if
c_cond
(paren
id|slots
op_ge
id|entries
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|r128_do_wait_for_idle
r_static
r_int
id|r128_do_wait_for_idle
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|r128_do_wait_for_fifo
c_func
(paren
id|dev
comma
l_int|64
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|R128_READ
c_func
(paren
id|R128_GUI_STAT
)paren
op_amp
id|R128_GUI_ACTIVE
)paren
)paren
(brace
(paren
r_void
)paren
id|r128_do_pixcache_flush
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|r128_do_engine_reset
r_int
id|r128_do_engine_reset
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|u32
id|clock_cntl_index
comma
id|mclk_cntl
comma
id|gen_reset_cntl
suffix:semicolon
(paren
r_void
)paren
id|r128_do_pixcache_flush
c_func
(paren
id|dev
)paren
suffix:semicolon
id|clock_cntl_index
op_assign
id|R128_READ
c_func
(paren
id|R128_CLOCK_CNTL_INDEX
)paren
suffix:semicolon
id|mclk_cntl
op_assign
id|R128_READ_PLL
c_func
(paren
id|dev
comma
id|R128_MCLK_CNTL
)paren
suffix:semicolon
id|R128_WRITE_PLL
c_func
(paren
id|R128_MCLK_CNTL
comma
id|mclk_cntl
op_or
id|R128_FORCE_GCP
op_or
id|R128_FORCE_PIPE3D_CP
)paren
suffix:semicolon
id|gen_reset_cntl
op_assign
id|R128_READ
c_func
(paren
id|R128_GEN_RESET_CNTL
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_GEN_RESET_CNTL
comma
id|gen_reset_cntl
op_or
id|R128_SOFT_RESET_GUI
)paren
suffix:semicolon
(paren
r_void
)paren
id|R128_READ
c_func
(paren
id|R128_GEN_RESET_CNTL
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_GEN_RESET_CNTL
comma
id|gen_reset_cntl
op_amp
op_complement
id|R128_SOFT_RESET_GUI
)paren
suffix:semicolon
(paren
r_void
)paren
id|R128_READ
c_func
(paren
id|R128_GEN_RESET_CNTL
)paren
suffix:semicolon
id|R128_WRITE_PLL
c_func
(paren
id|R128_MCLK_CNTL
comma
id|mclk_cntl
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_CLOCK_CNTL_INDEX
comma
id|clock_cntl_index
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_GEN_RESET_CNTL
comma
id|gen_reset_cntl
)paren
suffix:semicolon
multiline_comment|/* For CCE ring buffer only */
r_if
c_cond
(paren
id|dev_priv-&gt;cce_is_bm_mode
)paren
(brace
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
comma
l_int|0
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_RPTR
comma
l_int|0
)paren
suffix:semicolon
op_star
id|dev_priv-&gt;ring_read_ptr
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;ring_write
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reset the CCE mode */
(paren
r_void
)paren
id|r128_do_wait_for_idle
c_func
(paren
id|dev
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_CNTL
comma
id|dev_priv-&gt;cce_mode
op_or
id|dev_priv-&gt;ring_sizel2qw
)paren
suffix:semicolon
(paren
r_void
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_ADDR
)paren
suffix:semicolon
multiline_comment|/* as per the sample code */
id|R128_WRITE
c_func
(paren
id|R128_PM4_MICRO_CNTL
comma
id|R128_PM4_MICRO_FREERUN
)paren
suffix:semicolon
id|r128_mark_vertbufs_done
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_eng_reset
r_int
id|r128_eng_reset
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;r128_eng_reset called without holding the lock&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|r128_do_engine_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|r128_do_engine_flush
r_static
r_int
id|r128_do_engine_flush
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
comma
id|tmp
op_or
id|R128_PM4_BUFFER_DL_DONE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_eng_flush
r_int
id|r128_eng_flush
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;r128_eng_flush called without holding the lock&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|r128_do_engine_flush
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|r128_do_cce_wait_for_fifo
r_static
r_int
id|r128_do_cce_wait_for_fifo
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
id|entries
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|slots
op_assign
id|R128_READ
c_func
(paren
id|R128_PM4_STAT
)paren
op_amp
id|R128_PM4_FIFOCNT_MASK
suffix:semicolon
r_if
c_cond
(paren
id|slots
op_ge
id|entries
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|r128_do_cce_wait_for_idle
r_int
id|r128_do_cce_wait_for_idle
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;cce_is_bm_mode
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|dev_priv-&gt;ring_read_ptr
op_eq
id|dev_priv-&gt;sarea_priv-&gt;ring_write
)paren
(brace
r_int
id|pm4stat
op_assign
id|R128_READ
c_func
(paren
id|R128_PM4_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pm4stat
op_amp
id|R128_PM4_FIFOCNT_MASK
)paren
op_ge
id|dev_priv-&gt;cce_fifo_size
op_logical_and
op_logical_neg
(paren
id|pm4stat
op_amp
(paren
id|R128_PM4_BUSY
op_or
id|R128_PM4_GUI_ACTIVE
)paren
)paren
)paren
(brace
r_return
id|r128_do_pixcache_flush
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
r_int
id|ret
op_assign
id|r128_do_cce_wait_for_fifo
c_func
(paren
id|dev
comma
id|dev_priv-&gt;cce_fifo_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|pm4stat
op_assign
id|R128_READ
c_func
(paren
id|R128_PM4_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pm4stat
op_amp
(paren
id|R128_PM4_BUSY
op_or
id|R128_PM4_GUI_ACTIVE
)paren
)paren
)paren
(brace
r_return
id|r128_do_pixcache_flush
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
DECL|function|r128_cce_idle
r_int
id|r128_cce_idle
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;r128_wait_idle called without holding the lock&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|r128_do_cce_wait_for_idle
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|r128_submit_packets_ring_secure
r_static
r_int
id|r128_submit_packets_ring_secure
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|u32
op_star
id|commands
comma
r_int
op_star
id|count
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|write
op_assign
id|dev_priv-&gt;sarea_priv-&gt;ring_write
suffix:semicolon
r_int
op_star
id|write_ptr
op_assign
id|dev_priv-&gt;ring_start
op_plus
id|write
suffix:semicolon
r_int
id|c
op_assign
op_star
id|count
suffix:semicolon
id|u32
id|tmp
op_assign
l_int|0
suffix:semicolon
r_int
id|psize
op_assign
l_int|0
suffix:semicolon
r_int
id|writing
op_assign
l_int|1
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_while
c_loop
(paren
id|c
OG
l_int|0
)paren
(brace
id|tmp
op_assign
op_star
id|commands
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psize
)paren
(brace
id|writing
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET_MASK
)paren
op_eq
id|R128_CCE_PACKET0
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET0_REG_MASK
)paren
op_le
(paren
l_int|0x1004
op_rshift
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET0_REG_MASK
)paren
op_ne
(paren
id|R128_PM4_VC_FPU_SETUP
op_rshift
l_int|2
)paren
)paren
(brace
id|writing
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|psize
op_assign
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET_COUNT_MASK
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET_MASK
)paren
op_eq
id|R128_CCE_PACKET1
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET1_REG0_MASK
)paren
op_le
(paren
l_int|0x1004
op_rshift
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET1_REG0_MASK
)paren
op_ne
(paren
id|R128_PM4_VC_FPU_SETUP
op_rshift
l_int|2
)paren
)paren
(brace
id|writing
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET1_REG1_MASK
)paren
op_le
(paren
l_int|0x1004
op_lshift
l_int|9
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET1_REG1_MASK
)paren
op_ne
(paren
id|R128_PM4_VC_FPU_SETUP
op_lshift
l_int|9
)paren
)paren
(brace
id|writing
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|psize
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|psize
op_assign
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET_COUNT_MASK
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|2
suffix:semicolon
)brace
)brace
id|psize
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|writing
)paren
(brace
id|write
op_increment
suffix:semicolon
op_star
id|write_ptr
op_increment
op_assign
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|write
op_ge
id|dev_priv-&gt;ring_entries
)paren
(brace
id|write
op_assign
l_int|0
suffix:semicolon
id|write_ptr
op_assign
id|dev_priv-&gt;ring_start
suffix:semicolon
)brace
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|write
op_eq
op_star
id|dev_priv-&gt;ring_read_ptr
)paren
(brace
(paren
r_void
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_DL_RPTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_increment
op_ge
id|dev_priv-&gt;usec_timeout
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|c
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|write
OL
l_int|32
)paren
id|memcpy
c_func
(paren
id|dev_priv-&gt;ring_end
comma
id|dev_priv-&gt;ring_start
comma
id|write
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* Make sure WC cache has been flushed */
id|r128_flush_write_combine
c_func
(paren
)paren
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;ring_write
op_assign
id|write
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
comma
id|write
)paren
suffix:semicolon
op_star
id|count
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_submit_packets_pio_secure
r_static
r_int
id|r128_submit_packets_pio_secure
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|u32
op_star
id|commands
comma
r_int
op_star
id|count
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|u32
id|tmp
op_assign
l_int|0
suffix:semicolon
r_int
id|psize
op_assign
l_int|0
suffix:semicolon
r_int
id|writing
op_assign
l_int|1
suffix:semicolon
r_int
id|addr
op_assign
id|R128_PM4_FIFO_DATA_EVEN
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_while
c_loop
(paren
op_star
id|count
OG
l_int|0
)paren
(brace
id|tmp
op_assign
op_star
id|commands
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psize
)paren
(brace
id|writing
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET_MASK
)paren
op_eq
id|R128_CCE_PACKET0
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET0_REG_MASK
)paren
op_le
(paren
l_int|0x1004
op_rshift
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET0_REG_MASK
)paren
op_ne
(paren
id|R128_PM4_VC_FPU_SETUP
op_rshift
l_int|2
)paren
)paren
(brace
id|writing
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|psize
op_assign
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET_COUNT_MASK
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET_MASK
)paren
op_eq
id|R128_CCE_PACKET1
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET1_REG0_MASK
)paren
op_le
(paren
l_int|0x1004
op_rshift
l_int|2
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET1_REG0_MASK
)paren
op_ne
(paren
id|R128_PM4_VC_FPU_SETUP
op_rshift
l_int|2
)paren
)paren
(brace
id|writing
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET1_REG1_MASK
)paren
op_le
(paren
l_int|0x1004
op_lshift
l_int|9
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET1_REG1_MASK
)paren
op_ne
(paren
id|R128_PM4_VC_FPU_SETUP
op_lshift
l_int|9
)paren
)paren
(brace
id|writing
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|psize
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|psize
op_assign
(paren
(paren
id|tmp
op_amp
id|R128_CCE_PACKET_COUNT_MASK
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|2
suffix:semicolon
)brace
)brace
id|psize
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|writing
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|r128_do_cce_wait_for_fifo
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|addr
comma
id|tmp
)paren
suffix:semicolon
id|addr
op_xor_assign
l_int|0x0004
suffix:semicolon
)brace
op_star
id|count
op_sub_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr
op_eq
id|R128_PM4_FIFO_DATA_ODD
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|r128_do_cce_wait_for_fifo
c_func
(paren
id|dev
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|addr
comma
id|R128_CCE_PACKET2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_submit_packets_ring
r_static
r_int
id|r128_submit_packets_ring
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|u32
op_star
id|commands
comma
r_int
op_star
id|count
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|write
op_assign
id|dev_priv-&gt;sarea_priv-&gt;ring_write
suffix:semicolon
r_int
op_star
id|write_ptr
op_assign
id|dev_priv-&gt;ring_start
op_plus
id|write
suffix:semicolon
r_int
id|c
op_assign
op_star
id|count
suffix:semicolon
r_int
id|timeout
suffix:semicolon
r_while
c_loop
(paren
id|c
OG
l_int|0
)paren
(brace
id|write
op_increment
suffix:semicolon
op_star
id|write_ptr
op_increment
op_assign
op_star
id|commands
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|write
op_ge
id|dev_priv-&gt;ring_entries
)paren
(brace
id|write
op_assign
l_int|0
suffix:semicolon
id|write_ptr
op_assign
id|dev_priv-&gt;ring_start
suffix:semicolon
)brace
id|timeout
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|write
op_eq
op_star
id|dev_priv-&gt;ring_read_ptr
)paren
(brace
(paren
r_void
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_DL_RPTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_increment
op_ge
id|dev_priv-&gt;usec_timeout
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|c
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|write
OL
l_int|32
)paren
id|memcpy
c_func
(paren
id|dev_priv-&gt;ring_end
comma
id|dev_priv-&gt;ring_start
comma
id|write
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* Make sure WC cache has been flushed */
id|r128_flush_write_combine
c_func
(paren
)paren
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;ring_write
op_assign
id|write
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
comma
id|write
)paren
suffix:semicolon
op_star
id|count
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_submit_packets_pio
r_static
r_int
id|r128_submit_packets_pio
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|u32
op_star
id|commands
comma
r_int
op_star
id|count
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_while
c_loop
(paren
op_star
id|count
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|r128_do_cce_wait_for_fifo
c_func
(paren
id|dev
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_FIFO_DATA_EVEN
comma
op_star
id|commands
op_increment
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_FIFO_DATA_ODD
comma
op_star
id|commands
op_increment
)paren
suffix:semicolon
op_star
id|count
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|count
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|r128_do_cce_wait_for_fifo
c_func
(paren
id|dev
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_FIFO_DATA_EVEN
comma
op_star
id|commands
op_increment
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_FIFO_DATA_ODD
comma
id|R128_CCE_PACKET2
)paren
suffix:semicolon
op_star
id|count
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_do_submit_packets
r_static
r_int
id|r128_do_submit_packets
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|u32
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|c
op_assign
id|count
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;cce_is_bm_mode
)paren
(brace
r_int
id|left
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
id|dev_priv-&gt;ring_entries
)paren
(brace
id|c
op_assign
id|dev_priv-&gt;ring_entries
op_minus
l_int|1
suffix:semicolon
id|left
op_assign
id|count
op_minus
id|c
suffix:semicolon
)brace
multiline_comment|/* Since this is only used by the kernel we can use the&n;                   insecure ring buffer submit packet routine */
id|ret
op_assign
id|r128_submit_packets_ring
c_func
(paren
id|dev
comma
id|buffer
comma
op_amp
id|c
)paren
suffix:semicolon
id|c
op_add_assign
id|left
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Since this is only used by the kernel we can use the&n;                   insecure PIO submit packet routine */
id|ret
op_assign
id|r128_submit_packets_pio
c_func
(paren
id|dev
comma
id|buffer
comma
op_amp
id|c
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_else
r_return
id|c
suffix:semicolon
)brace
DECL|function|r128_submit_pkt
r_int
id|r128_submit_pkt
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_packet_t
id|packet
suffix:semicolon
id|u32
op_star
id|buffer
suffix:semicolon
r_int
id|c
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;r128_submit_pkt called without holding the lock&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|packet
comma
(paren
id|drm_r128_packet_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|packet
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|c
op_assign
id|packet.count
suffix:semicolon
id|size
op_assign
id|c
op_star
r_sizeof
(paren
op_star
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;cce_is_bm_mode
)paren
(brace
r_int
id|left
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ge
id|dev_priv-&gt;ring_entries
)paren
(brace
id|c
op_assign
id|dev_priv-&gt;ring_entries
op_minus
l_int|1
suffix:semicolon
id|size
op_assign
id|c
op_star
r_sizeof
(paren
op_star
id|buffer
)paren
suffix:semicolon
id|left
op_assign
id|packet.count
op_minus
id|c
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|size
comma
l_int|0
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buffer
comma
id|packet.buffer
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;cce_secure
)paren
id|ret
op_assign
id|r128_submit_packets_ring_secure
c_func
(paren
id|dev
comma
id|buffer
comma
op_amp
id|c
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|r128_submit_packets_ring
c_func
(paren
id|dev
comma
id|buffer
comma
op_amp
id|c
)paren
suffix:semicolon
id|c
op_add_assign
id|left
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|size
comma
l_int|0
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buffer
comma
id|packet.buffer
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;cce_secure
)paren
id|ret
op_assign
id|r128_submit_packets_pio_secure
c_func
(paren
id|dev
comma
id|buffer
comma
op_amp
id|c
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|r128_submit_packets_pio
c_func
(paren
id|dev
comma
id|buffer
comma
op_amp
id|c
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|packet.count
op_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|drm_r128_packet_t
op_star
)paren
id|arg
comma
op_amp
id|packet
comma
r_sizeof
(paren
id|packet
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
r_else
r_if
c_cond
(paren
id|c
OG
l_int|0
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_send_vertbufs
r_static
r_int
id|r128_send_vertbufs
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_vertex_t
op_star
id|v
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|u32
id|cce
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Make sure we have valid data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|v-&gt;send_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|idx
op_assign
id|v-&gt;send_indices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
op_logical_or
id|idx
op_ge
id|dma-&gt;buf_count
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Index %d (of %d max)&bslash;n&quot;
comma
id|idx
comma
id|dma-&gt;buf_count
op_minus
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d using buffer owned by %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|buf-&gt;pid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf-&gt;pending
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Sending pending buffer:&quot;
l_string|&quot; buffer %d, offset %d&bslash;n&quot;
comma
id|v-&gt;send_indices
(braket
id|i
)braket
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* Wait for idle, if we&squot;ve wrapped to make sure that all pending&n;           buffers have been processed */
r_if
c_cond
(paren
id|dev_priv-&gt;submit_age
op_eq
id|R128_MAX_VBUF_AGE
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|r128_do_cce_wait_for_idle
c_func
(paren
id|dev
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dev_priv-&gt;submit_age
op_assign
l_int|0
suffix:semicolon
id|r128_mark_vertbufs_done
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure WC cache has been flushed (if in PIO mode) */
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;cce_is_bm_mode
)paren
id|r128_flush_write_combine
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* FIXME: Add support for sending vertex buffer to the CCE here&n;&t;   instead of in client code.  The v-&gt;prim holds the primitive&n;&t;   type that should be drawn.  Loop over the list buffers in&n;&t;   send_indices[] and submit a packet for each VB.&n;&n;&t;   This will require us to loop over the clip rects here as&n;&t;   well, which implies that we extend the kernel driver to allow&n;&t;   cliprects to be stored here.  Note that the cliprects could&n;&t;   possibly come from the X server instead of the client, but&n;&t;   this will require additional changes to the DRI to allow for&n;&t;   this optimization. */
multiline_comment|/* Submit a CCE packet that writes submit_age to R128_VB_AGE_REG */
id|cce
(braket
l_int|0
)braket
op_assign
id|R128CCE0
c_func
(paren
id|R128_CCE_PACKET0
comma
id|R128_VB_AGE_REG
comma
l_int|0
)paren
suffix:semicolon
id|cce
(braket
l_int|1
)braket
op_assign
id|dev_priv-&gt;submit_age
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|r128_do_submit_packets
c_func
(paren
id|dev
comma
id|cce
comma
l_int|2
)paren
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Until we add support for sending VBs to the CCE in&n;&t;&t;   this routine, we can recover from this error.  After&n;&t;&t;   we add that support, we won&squot;t be able to easily&n;&t;&t;   recover, so we will probably have to implement&n;&t;&t;   another mechanism for handling timeouts from packets&n;&t;&t;   submitted directly by the kernel. */
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Now that the submit packet request has succeeded, we can mark&n;           the buffers as pending */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|v-&gt;send_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|v-&gt;send_indices
(braket
id|i
)braket
)braket
suffix:semicolon
id|buf-&gt;pending
op_assign
l_int|1
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|buf_priv-&gt;age
op_assign
id|dev_priv-&gt;submit_age
suffix:semicolon
)brace
id|dev_priv-&gt;submit_age
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_freelist_get
r_static
id|drm_buf_t
op_star
id|r128_freelist_get
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
r_int
id|i
comma
id|t
suffix:semicolon
multiline_comment|/* FIXME: Optimize -- use freelist code */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pid
op_eq
l_int|0
)paren
r_return
id|buf
suffix:semicolon
)brace
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|t
op_increment
)paren
(brace
id|u32
id|done_age
op_assign
id|R128_READ
c_func
(paren
id|R128_VB_AGE_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pending
op_logical_and
id|buf_priv-&gt;age
op_le
id|done_age
)paren
(brace
multiline_comment|/* The buffer has been processed, so it&n;                                   can now be used */
id|buf-&gt;pending
op_assign
l_int|0
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|r128_status
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|r128_get_vertbufs
r_static
r_int
id|r128_get_vertbufs
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_vertex_t
op_star
id|v
)paren
(brace
id|drm_buf_t
op_star
id|buf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|v-&gt;granted_count
suffix:semicolon
id|i
OL
id|v-&gt;request_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|r128_freelist_get
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_break
suffix:semicolon
id|buf-&gt;pid
op_assign
id|current-&gt;pid
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|v-&gt;request_indices
(braket
id|i
)braket
comma
op_amp
id|buf-&gt;idx
comma
r_sizeof
(paren
id|buf-&gt;idx
)paren
)paren
op_logical_or
id|copy_to_user
c_func
(paren
op_amp
id|v-&gt;request_sizes
(braket
id|i
)braket
comma
op_amp
id|buf-&gt;total
comma
r_sizeof
(paren
id|buf-&gt;total
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
op_increment
id|v-&gt;granted_count
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_vertex_buf
r_int
id|r128_vertex_buf
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
r_int
id|retcode
op_assign
l_int|0
suffix:semicolon
id|drm_r128_vertex_t
id|v
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;r128_vertex_buf called without holding the lock&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev_priv
op_logical_or
id|dev_priv-&gt;is_pci
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;r128_vertex_buf called with a PCI card&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
(paren
id|drm_r128_vertex_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d: %d send, %d req&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|v.send_count
comma
id|v.request_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v.send_count
template_param
id|dma-&gt;buf_count
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d trying to send %d buffers (of %d max)&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|v.send_count
comma
id|dma-&gt;buf_count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.request_count
template_param
id|dma-&gt;buf_count
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d trying to get %d buffers (of %d max)&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|v.request_count
comma
id|dma-&gt;buf_count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.send_count
)paren
(brace
id|retcode
op_assign
id|r128_send_vertbufs
c_func
(paren
id|dev
comma
op_amp
id|v
)paren
suffix:semicolon
)brace
id|v.granted_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retcode
op_logical_and
id|v.request_count
)paren
(brace
id|retcode
op_assign
id|r128_get_vertbufs
c_func
(paren
id|dev
comma
op_amp
id|v
)paren
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d returning, granted = %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|v.granted_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|drm_r128_vertex_t
op_star
)paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|retcode
suffix:semicolon
)brace
eof
