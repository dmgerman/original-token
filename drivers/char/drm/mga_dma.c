multiline_comment|/* mga_dma.c -- DMA support for mga g200/g400 -*- linux-c -*-&n; * Created: Mon Dec 13 01:50:01 1999 by jhartmann@precisioninsight.com&n; *&n; * Copyright 1999 Precision Insight, Inc., Cedar Park, Texas.&n; * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.&n; * All Rights Reserved.&n; *&n; * Permission is hereby granted, free of charge, to any person obtaining a&n; * copy of this software and associated documentation files (the &quot;Software&quot;),&n; * to deal in the Software without restriction, including without limitation&n; * the rights to use, copy, modify, merge, publish, distribute, sublicense,&n; * and/or sell copies of the Software, and to permit persons to whom the&n; * Software is furnished to do so, subject to the following conditions:&n; *&n; * The above copyright notice and this permission notice (including the next&n; * paragraph) shall be included in all copies or substantial portions of the&n; * Software.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR&n; * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n; * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL&n; * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR&n; * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,&n; * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER&n; * DEALINGS IN THE SOFTWARE.&n; *&n; * Authors: Rickard E. (Rik) Faith &lt;faith@valinux.com&gt;&n; *&t;    Jeff Hartmann &lt;jhartmann@valinux.com&gt;&n; *&t;    Keith Whitwell &lt;keithw@valinux.com&gt;&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;drmP.h&quot;
macro_line|#include &quot;mga_drv.h&quot;
macro_line|#include &lt;linux/interrupt.h&gt;&t;/* For task queue support */
DECL|macro|MGA_REG
mdefine_line|#define MGA_REG(reg)&t;&t;2
DECL|macro|MGA_BASE
mdefine_line|#define MGA_BASE(reg)&t;&t;((unsigned long) &bslash;&n;&t;&t;&t;&t;((drm_device_t *)dev)-&gt;maplist[MGA_REG(reg)]-&gt;handle)
DECL|macro|MGA_ADDR
mdefine_line|#define MGA_ADDR(reg)&t;&t;(MGA_BASE(reg) + reg)
DECL|macro|MGA_DEREF
mdefine_line|#define MGA_DEREF(reg)&t;&t;*(__volatile__ int *)MGA_ADDR(reg)
DECL|macro|MGA_READ
mdefine_line|#define MGA_READ(reg)&t;&t;MGA_DEREF(reg)
DECL|macro|MGA_WRITE
mdefine_line|#define MGA_WRITE(reg,val) &t;do { MGA_DEREF(reg) = val; } while (0)
DECL|macro|PDEA_pagpxfer_enable
mdefine_line|#define PDEA_pagpxfer_enable &t;     0x2
r_static
r_int
id|mga_flush_queue
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
suffix:semicolon
DECL|function|mga_alloc_page
r_static
r_int
r_int
id|mga_alloc_page
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
r_int
r_int
id|address
suffix:semicolon
id|address
op_assign
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|address
op_eq
l_int|0UL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|virt_to_page
c_func
(paren
id|address
)paren
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|PG_reserved
comma
op_amp
id|virt_to_page
c_func
(paren
id|address
)paren
op_member_access_from_pointer
id|flags
)paren
suffix:semicolon
r_return
id|address
suffix:semicolon
)brace
DECL|function|mga_free_page
r_static
r_void
id|mga_free_page
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
r_int
id|page
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
(brace
r_return
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|virt_to_page
c_func
(paren
id|page
)paren
op_member_access_from_pointer
id|count
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|PG_reserved
comma
op_amp
id|virt_to_page
c_func
(paren
id|page
)paren
op_member_access_from_pointer
id|flags
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|mga_delay
r_static
r_void
id|mga_delay
c_func
(paren
r_void
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* These are two age tags that will never be sent to&n; * the hardware */
DECL|macro|MGA_BUF_USED
mdefine_line|#define MGA_BUF_USED &t;0xffffffff
DECL|macro|MGA_BUF_FREE
mdefine_line|#define MGA_BUF_FREE&t;0
DECL|function|mga_freelist_init
r_static
r_int
id|mga_freelist_init
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
id|drm_mga_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|item
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev_priv-&gt;head
op_assign
id|drm_alloc
c_func
(paren
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;head
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev_priv-&gt;head
comma
l_int|0
comma
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;head-&gt;age
op_assign
id|MGA_BUF_USED
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|item
op_assign
id|drm_alloc
c_func
(paren
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|item
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|item
comma
l_int|0
comma
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
)paren
suffix:semicolon
id|item-&gt;age
op_assign
id|MGA_BUF_FREE
suffix:semicolon
id|item-&gt;prev
op_assign
id|dev_priv-&gt;head
suffix:semicolon
id|item-&gt;next
op_assign
id|dev_priv-&gt;head-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;head-&gt;next
op_ne
l_int|NULL
)paren
(brace
id|dev_priv-&gt;head-&gt;next-&gt;prev
op_assign
id|item
suffix:semicolon
)brace
r_if
c_cond
(paren
id|item-&gt;next
op_eq
l_int|NULL
)paren
(brace
id|dev_priv-&gt;tail
op_assign
id|item
suffix:semicolon
)brace
id|item-&gt;buf
op_assign
id|buf
suffix:semicolon
id|buf_priv-&gt;my_freelist
op_assign
id|item
suffix:semicolon
id|buf_priv-&gt;discard
op_assign
l_int|0
suffix:semicolon
id|buf_priv-&gt;dispatched
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;head-&gt;next
op_assign
id|item
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_freelist_cleanup
r_static
r_void
id|mga_freelist_cleanup
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|item
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|prev
suffix:semicolon
id|item
op_assign
id|dev_priv-&gt;head
suffix:semicolon
r_while
c_loop
(paren
id|item
)paren
(brace
id|prev
op_assign
id|item
suffix:semicolon
id|item
op_assign
id|item-&gt;next
suffix:semicolon
id|drm_free
c_func
(paren
id|prev
comma
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
)brace
id|dev_priv-&gt;head
op_assign
id|dev_priv-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Frees dispatch lock */
DECL|function|mga_dma_quiescent
r_static
r_inline
r_void
id|mga_dma_quiescent
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
r_int
r_int
id|end
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;dispatch_status = 0x%02lx&bslash;n&quot;
comma
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
id|end
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|3
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|MGA_IN_DISPATCH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|end
op_minus
id|jiffies
)paren
op_le
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;irqs: %d wanted %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;total_irq
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dma-&gt;total_lost
)paren
)paren
suffix:semicolon
id|DRM_ERROR
c_func
(paren
l_string|&quot;lockup: dispatch_status = 0x%02lx,&quot;
l_string|&quot; jiffies = %lu, end = %lu&bslash;n&quot;
comma
id|dev_priv-&gt;dispatch_status
comma
id|jiffies
comma
id|end
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2000
suffix:semicolon
id|i
op_increment
)paren
id|mga_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|end
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|3
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;quiescent status : %x&bslash;n&quot;
comma
id|MGA_READ
c_func
(paren
id|MGAREG_STATUS
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|MGA_READ
c_func
(paren
id|MGAREG_STATUS
)paren
op_amp
l_int|0x00030001
)paren
op_ne
l_int|0x00020000
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|end
op_minus
id|jiffies
)paren
op_le
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;irqs: %d wanted %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;total_irq
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dma-&gt;total_lost
)paren
)paren
suffix:semicolon
id|DRM_ERROR
c_func
(paren
l_string|&quot;lockup&bslash;n&quot;
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_IN_DISPATCH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2000
suffix:semicolon
id|i
op_increment
)paren
id|mga_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|sarea_priv-&gt;dirty
op_or_assign
id|MGA_DMA_FLUSH
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_IN_DISPATCH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;exit, dispatch_status = 0x%02lx&bslash;n&quot;
comma
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
)brace
DECL|function|mga_reset_freelist
r_static
r_void
id|mga_reset_freelist
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
id|drm_mga_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|buf_priv-&gt;my_freelist-&gt;age
op_assign
id|MGA_BUF_FREE
suffix:semicolon
)brace
)brace
multiline_comment|/* Least recently used :&n; * These operations are not atomic b/c they are protected by the&n; * hardware lock */
DECL|function|mga_freelist_get
id|drm_buf_t
op_star
id|mga_freelist_get
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|entry
comma
id|current
)paren
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|prev
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|next
suffix:semicolon
r_static
r_int
id|failed
op_assign
l_int|0
suffix:semicolon
r_int
id|return_null
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|failed
op_ge
l_int|1000
op_logical_and
id|dev_priv-&gt;tail-&gt;age
op_ge
id|dev_priv-&gt;last_prim_age
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;Waiting on freelist,&quot;
l_string|&quot; tail-&gt;age = %d, last_prim_age= %d&bslash;n&quot;
comma
id|dev_priv-&gt;tail-&gt;age
comma
id|dev_priv-&gt;last_prim_age
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|dev_priv-&gt;buf_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|MGA_IN_GETBUF
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|mga_dma_schedule
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;tail-&gt;age
OL
id|dev_priv-&gt;last_prim_age
)paren
(brace
r_break
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_sleeps
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
op_increment
id|return_null
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
id|MGA_IN_GETBUF
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dev_priv-&gt;buf_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|return_null
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_priv-&gt;tail-&gt;age
OL
id|dev_priv-&gt;last_prim_age
)paren
(brace
id|prev
op_assign
id|dev_priv-&gt;tail-&gt;prev
suffix:semicolon
id|next
op_assign
id|dev_priv-&gt;tail
suffix:semicolon
id|prev-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|next-&gt;prev
op_assign
id|next-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|dev_priv-&gt;tail
op_assign
id|prev
suffix:semicolon
id|next-&gt;age
op_assign
id|MGA_BUF_USED
suffix:semicolon
id|failed
op_assign
l_int|0
suffix:semicolon
r_return
id|next-&gt;buf
suffix:semicolon
)brace
id|failed
op_increment
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|mga_freelist_put
r_int
id|mga_freelist_put
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_buf_t
op_star
id|buf
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_buf_priv_t
op_star
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|prev
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|head
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|next
suffix:semicolon
r_if
c_cond
(paren
id|buf_priv-&gt;my_freelist-&gt;age
op_eq
id|MGA_BUF_USED
)paren
(brace
multiline_comment|/* Discarded buffer, put it on the tail */
id|next
op_assign
id|buf_priv-&gt;my_freelist
suffix:semicolon
id|next-&gt;age
op_assign
id|MGA_BUF_FREE
suffix:semicolon
id|prev
op_assign
id|dev_priv-&gt;tail
suffix:semicolon
id|prev-&gt;next
op_assign
id|next
suffix:semicolon
id|next-&gt;prev
op_assign
id|prev
suffix:semicolon
id|next-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|dev_priv-&gt;tail
op_assign
id|next
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normally aged buffer, put it on the head + 1,&n;&t;&t; * as the real head is a sentinal element&n;&t;&t; */
id|next
op_assign
id|buf_priv-&gt;my_freelist
suffix:semicolon
id|head
op_assign
id|dev_priv-&gt;head
suffix:semicolon
id|prev
op_assign
id|head-&gt;next
suffix:semicolon
id|head-&gt;next
op_assign
id|next
suffix:semicolon
id|prev-&gt;prev
op_assign
id|next
suffix:semicolon
id|next-&gt;prev
op_assign
id|head
suffix:semicolon
id|next-&gt;next
op_assign
id|prev
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_init_primary_bufs
r_static
r_int
id|mga_init_primary_bufs
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_mga_init_t
op_star
id|init
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_prim_buf_t
op_star
id|prim_buffer
suffix:semicolon
r_int
id|i
comma
id|temp
comma
id|size_of_buf
suffix:semicolon
r_int
id|offset
op_assign
id|init-&gt;reserved_map_agpstart
suffix:semicolon
id|dev_priv-&gt;primary_size
op_assign
(paren
(paren
id|init-&gt;primary_size
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
)paren
op_star
id|PAGE_SIZE
suffix:semicolon
id|size_of_buf
op_assign
id|dev_priv-&gt;primary_size
op_div
id|MGA_NUM_PRIM_BUFS
suffix:semicolon
id|dev_priv-&gt;warp_ucode_size
op_assign
id|init-&gt;warp_ucode_size
suffix:semicolon
id|dev_priv-&gt;prim_bufs
op_assign
id|drm_alloc
c_func
(paren
r_sizeof
(paren
id|drm_mga_prim_buf_t
op_star
)paren
op_star
(paren
id|MGA_NUM_PRIM_BUFS
op_plus
l_int|1
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;prim_bufs
op_eq
l_int|NULL
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Unable to allocate memory for prim_buf&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev_priv-&gt;prim_bufs
comma
l_int|0
comma
r_sizeof
(paren
id|drm_mga_prim_buf_t
op_star
)paren
op_star
(paren
id|MGA_NUM_PRIM_BUFS
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|temp
op_assign
id|init-&gt;warp_ucode_size
op_plus
id|dev_priv-&gt;primary_size
suffix:semicolon
id|temp
op_assign
(paren
(paren
id|temp
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
)paren
op_star
id|PAGE_SIZE
suffix:semicolon
id|dev_priv-&gt;ioremap
op_assign
id|drm_ioremap
c_func
(paren
id|dev-&gt;agp-&gt;base
op_plus
id|offset
comma
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;ioremap
op_eq
l_int|NULL
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Ioremap failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev_priv-&gt;wait_queue
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MGA_NUM_PRIM_BUFS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|prim_buffer
op_assign
id|drm_alloc
c_func
(paren
r_sizeof
(paren
id|drm_mga_prim_buf_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prim_buffer
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|prim_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|drm_mga_prim_buf_t
)paren
)paren
suffix:semicolon
id|prim_buffer-&gt;phys_head
op_assign
id|offset
op_plus
id|dev-&gt;agp-&gt;base
suffix:semicolon
id|prim_buffer-&gt;current_dma_ptr
op_assign
id|prim_buffer-&gt;head
op_assign
(paren
id|u32
op_star
)paren
(paren
id|dev_priv-&gt;ioremap
op_plus
id|offset
op_minus
id|init-&gt;reserved_map_agpstart
)paren
suffix:semicolon
id|prim_buffer-&gt;num_dwords
op_assign
l_int|0
suffix:semicolon
id|prim_buffer-&gt;max_dwords
op_assign
id|size_of_buf
op_div
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|prim_buffer-&gt;max_dwords
op_sub_assign
l_int|5
suffix:semicolon
multiline_comment|/* Leave room for the softrap */
id|prim_buffer-&gt;sec_used
op_assign
l_int|0
suffix:semicolon
id|prim_buffer-&gt;idx
op_assign
id|i
suffix:semicolon
id|prim_buffer-&gt;prim_age
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|offset
op_assign
id|offset
op_plus
id|size_of_buf
suffix:semicolon
id|dev_priv-&gt;prim_bufs
(braket
id|i
)braket
op_assign
id|prim_buffer
suffix:semicolon
)brace
id|dev_priv-&gt;current_prim_idx
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;next_prim
op_assign
id|dev_priv-&gt;last_prim
op_assign
id|dev_priv-&gt;current_prim
op_assign
id|dev_priv-&gt;prim_bufs
(braket
l_int|0
)braket
suffix:semicolon
id|dev_priv-&gt;next_prim_age
op_assign
l_int|2
suffix:semicolon
id|dev_priv-&gt;last_prim_age
op_assign
l_int|1
suffix:semicolon
id|set_bit
c_func
(paren
id|MGA_BUF_IN_USE
comma
op_amp
id|dev_priv-&gt;current_prim-&gt;buffer_status
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_fire_primary
r_void
id|mga_fire_primary
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_mga_prim_buf_t
op_star
id|prim
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_mga_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
r_int
id|use_agp
op_assign
id|PDEA_pagpxfer_enable
suffix:semicolon
r_int
r_int
id|end
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|next_idx
suffix:semicolon
id|PRIMLOCALS
suffix:semicolon
id|dev_priv-&gt;last_prim
op_assign
id|prim
suffix:semicolon
multiline_comment|/* We never check for overflow, b/c there is always room */
id|PRIMPTR
c_func
(paren
id|prim
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_dwords
op_le
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;num_dwords == 0 when dispatched&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_prim_wait
suffix:semicolon
)brace
id|PRIMOUTREG
c_func
(paren
id|MGAREG_DMAPAD
comma
l_int|0
)paren
suffix:semicolon
id|PRIMOUTREG
c_func
(paren
id|MGAREG_DMAPAD
comma
l_int|0
)paren
suffix:semicolon
id|PRIMOUTREG
c_func
(paren
id|MGAREG_DMAPAD
comma
l_int|0
)paren
suffix:semicolon
id|PRIMOUTREG
c_func
(paren
id|MGAREG_SOFTRAP
comma
l_int|0
)paren
suffix:semicolon
id|PRIMFINISH
c_func
(paren
id|prim
)paren
suffix:semicolon
id|end
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sarea_priv-&gt;dirty
op_amp
id|MGA_DMA_FLUSH
)paren
(brace
r_while
c_loop
(paren
(paren
id|MGA_READ
c_func
(paren
id|MGAREG_STATUS
)paren
op_amp
l_int|0x00030001
)paren
op_ne
l_int|0x00020000
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|end
op_minus
id|jiffies
)paren
op_le
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;irqs: %d wanted %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;total_irq
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dma-&gt;total_lost
)paren
)paren
suffix:semicolon
id|DRM_ERROR
c_func
(paren
l_string|&quot;lockup (flush)&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_prim_wait
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4096
suffix:semicolon
id|i
op_increment
)paren
id|mga_delay
c_func
(paren
)paren
suffix:semicolon
)brace
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
(paren
id|MGA_DMA_FLUSH
)paren
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
(paren
id|MGA_READ
c_func
(paren
id|MGAREG_STATUS
)paren
op_amp
l_int|0x00020001
)paren
op_ne
l_int|0x00020000
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|end
op_minus
id|jiffies
)paren
op_le
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;irqs: %d wanted %d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;total_irq
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dma-&gt;total_lost
)paren
)paren
suffix:semicolon
id|DRM_ERROR
c_func
(paren
l_string|&quot;lockup (wait)&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_prim_wait
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4096
suffix:semicolon
id|i
op_increment
)paren
id|mga_delay
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|mga_flush_write_combine
c_func
(paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev_priv-&gt;pending_bufs
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGAREG_PRIMADDRESS
comma
id|phys_head
op_or
id|TT_GENERAL
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGAREG_PRIMEND
comma
(paren
id|phys_head
op_plus
id|num_dwords
op_star
l_int|4
)paren
op_or
id|use_agp
)paren
suffix:semicolon
id|prim-&gt;num_dwords
op_assign
l_int|0
suffix:semicolon
id|sarea_priv-&gt;last_enqueue
op_assign
id|prim-&gt;prim_age
suffix:semicolon
id|next_idx
op_assign
id|prim-&gt;idx
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|next_idx
op_ge
id|MGA_NUM_PRIM_BUFS
)paren
(brace
id|next_idx
op_assign
l_int|0
suffix:semicolon
)brace
id|dev_priv-&gt;next_prim
op_assign
id|dev_priv-&gt;prim_bufs
(braket
id|next_idx
)braket
suffix:semicolon
r_return
suffix:semicolon
id|out_prim_wait
suffix:colon
id|prim-&gt;num_dwords
op_assign
l_int|0
suffix:semicolon
id|prim-&gt;sec_used
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_BUF_IN_USE
comma
op_amp
id|prim-&gt;buffer_status
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|dev_priv-&gt;wait_queue
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_BUF_SWAP_PENDING
comma
op_amp
id|prim-&gt;buffer_status
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_IN_DISPATCH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
)brace
DECL|function|mga_advance_primary
r_int
id|mga_advance_primary
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|entry
comma
id|current
)paren
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_prim_buf_t
op_star
id|prim_buffer
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
r_int
id|next_prim_idx
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This needs to reset the primary buffer if available,&n;&t; * we should collect stats on how many times it bites&n;&t; * it&squot;s tail */
id|next_prim_idx
op_assign
id|dev_priv-&gt;current_prim_idx
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|next_prim_idx
op_ge
id|MGA_NUM_PRIM_BUFS
)paren
(brace
id|next_prim_idx
op_assign
l_int|0
suffix:semicolon
)brace
id|prim_buffer
op_assign
id|dev_priv-&gt;prim_bufs
(braket
id|next_prim_idx
)braket
suffix:semicolon
id|set_bit
c_func
(paren
id|MGA_IN_WAIT
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
multiline_comment|/* In use is cleared in interrupt handler */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|MGA_BUF_IN_USE
comma
op_amp
id|prim_buffer-&gt;buffer_status
)paren
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|dev_priv-&gt;wait_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|mga_dma_schedule
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|MGA_BUF_IN_USE
comma
op_amp
id|prim_buffer-&gt;buffer_status
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_sleeps
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dma-&gt;total_missed_sched
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dev_priv-&gt;wait_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
id|MGA_IN_WAIT
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
multiline_comment|/* This primary buffer is now free to use */
id|prim_buffer-&gt;current_dma_ptr
op_assign
id|prim_buffer-&gt;head
suffix:semicolon
id|prim_buffer-&gt;num_dwords
op_assign
l_int|0
suffix:semicolon
id|prim_buffer-&gt;sec_used
op_assign
l_int|0
suffix:semicolon
id|prim_buffer-&gt;prim_age
op_assign
id|dev_priv-&gt;next_prim_age
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|prim_buffer-&gt;prim_age
op_eq
l_int|0
op_logical_or
id|prim_buffer-&gt;prim_age
op_eq
l_int|0xffffffff
)paren
(brace
id|mga_flush_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mga_dma_quiescent
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mga_reset_freelist
c_func
(paren
id|dev
)paren
suffix:semicolon
id|prim_buffer-&gt;prim_age
op_assign
(paren
id|dev_priv-&gt;next_prim_age
op_add_assign
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset all buffer status stuff */
id|clear_bit
c_func
(paren
id|MGA_BUF_NEEDS_OVERFLOW
comma
op_amp
id|prim_buffer-&gt;buffer_status
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_BUF_FORCE_FIRE
comma
op_amp
id|prim_buffer-&gt;buffer_status
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_BUF_SWAP_PENDING
comma
op_amp
id|prim_buffer-&gt;buffer_status
)paren
suffix:semicolon
id|dev_priv-&gt;current_prim
op_assign
id|prim_buffer
suffix:semicolon
id|dev_priv-&gt;current_prim_idx
op_assign
id|next_prim_idx
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* More dynamic performance decisions */
DECL|function|mga_decide_to_fire
r_static
r_inline
r_int
id|mga_decide_to_fire
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|MGA_BUF_FORCE_FIRE
comma
op_amp
id|dev_priv-&gt;next_prim-&gt;buffer_status
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|MGA_IN_GETBUF
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
op_logical_and
id|dev_priv-&gt;next_prim-&gt;num_dwords
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|MGA_IN_FLUSH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
op_logical_and
id|dev_priv-&gt;next_prim-&gt;num_dwords
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dev_priv-&gt;pending_bufs
)paren
op_le
id|MGA_NUM_PRIM_BUFS
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|MGA_BUF_SWAP_PENDING
comma
op_amp
id|dev_priv-&gt;next_prim-&gt;buffer_status
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dev_priv-&gt;pending_bufs
)paren
op_le
id|MGA_NUM_PRIM_BUFS
op_div
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|dev_priv-&gt;next_prim-&gt;sec_used
op_ge
id|MGA_DMA_BUF_NR
op_div
l_int|8
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dev_priv-&gt;pending_bufs
)paren
op_ge
id|MGA_NUM_PRIM_BUFS
op_div
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|dev_priv-&gt;next_prim-&gt;sec_used
op_ge
id|MGA_DMA_BUF_NR
op_div
l_int|4
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_dma_schedule
r_int
id|mga_dma_schedule
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
id|locked
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|dev-&gt;dma_flag
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|sch_out_wakeup
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|MGA_IN_FLUSH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
op_logical_or
id|test_bit
c_func
(paren
id|MGA_IN_WAIT
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
op_logical_or
id|test_bit
c_func
(paren
id|MGA_IN_GETBUF
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
)paren
(brace
id|locked
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|locked
op_logical_and
op_logical_neg
id|drm_lock_take
c_func
(paren
op_amp
id|dev-&gt;lock.hw_lock-&gt;lock
comma
id|DRM_KERNEL_CONTEXT
)paren
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|dev-&gt;dma_flag
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|sch_out_wakeup
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|MGA_IN_DISPATCH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
)paren
(brace
multiline_comment|/* Fire dma buffer */
r_if
c_cond
(paren
id|mga_decide_to_fire
c_func
(paren
id|dev
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|MGA_BUF_FORCE_FIRE
comma
op_amp
id|dev_priv-&gt;next_prim-&gt;buffer_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;current_prim
op_eq
id|dev_priv-&gt;next_prim
)paren
(brace
multiline_comment|/* Schedule overflow for a later time */
id|set_bit
c_func
(paren
id|MGA_BUF_NEEDS_OVERFLOW
comma
op_amp
id|dev_priv-&gt;next_prim-&gt;buffer_status
)paren
suffix:semicolon
)brace
id|mga_fire_primary
c_func
(paren
id|dev
comma
id|dev_priv-&gt;next_prim
)paren
suffix:semicolon
)brace
r_else
(brace
id|clear_bit
c_func
(paren
id|MGA_IN_DISPATCH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|locked
)paren
(brace
r_if
c_cond
(paren
id|drm_lock_free
c_func
(paren
id|dev
comma
op_amp
id|dev-&gt;lock.hw_lock-&gt;lock
comma
id|DRM_KERNEL_CONTEXT
)paren
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|dev-&gt;dma_flag
)paren
suffix:semicolon
id|sch_out_wakeup
suffix:colon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|MGA_IN_FLUSH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|dev_priv-&gt;pending_bufs
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Everything has been processed by the hardware */
id|clear_bit
c_func
(paren
id|MGA_IN_FLUSH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|dev_priv-&gt;flush_queue
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|MGA_IN_GETBUF
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
op_logical_and
id|dev_priv-&gt;tail-&gt;age
OL
id|dev_priv-&gt;last_prim_age
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|dev_priv-&gt;buf_queue
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|mga_dma_service
r_static
r_void
id|mga_dma_service
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|device
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|drm_device_t
op_star
id|dev
op_assign
(paren
id|drm_device_t
op_star
)paren
id|device
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_prim_buf_t
op_star
id|last_prim_buffer
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|MGA_READ
c_func
(paren
id|MGAREG_STATUS
)paren
op_amp
l_int|0x00000001
)paren
op_ne
l_int|0x00000001
)paren
(brace
r_return
suffix:semicolon
)brace
id|MGA_WRITE
c_func
(paren
id|MGAREG_ICLEAR
comma
l_int|0x00000001
)paren
suffix:semicolon
id|last_prim_buffer
op_assign
id|dev_priv-&gt;last_prim
suffix:semicolon
id|last_prim_buffer-&gt;num_dwords
op_assign
l_int|0
suffix:semicolon
id|last_prim_buffer-&gt;sec_used
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
op_assign
id|dev_priv-&gt;last_prim_age
op_assign
id|last_prim_buffer-&gt;prim_age
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_BUF_IN_USE
comma
op_amp
id|last_prim_buffer-&gt;buffer_status
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_BUF_SWAP_PENDING
comma
op_amp
id|last_prim_buffer-&gt;buffer_status
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|MGA_IN_DISPATCH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|dev_priv-&gt;pending_bufs
)paren
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|dev-&gt;tq
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|dev_priv-&gt;wait_queue
)paren
suffix:semicolon
)brace
DECL|function|mga_dma_task_queue
r_static
r_void
id|mga_dma_task_queue
c_func
(paren
r_void
op_star
id|device
)paren
(brace
id|mga_dma_schedule
c_func
(paren
(paren
id|drm_device_t
op_star
)paren
id|device
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|mga_dma_cleanup
r_int
id|mga_dma_cleanup
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;dev_private
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
id|mga_flush_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mga_dma_quiescent
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;ioremap
)paren
(brace
r_int
id|temp
op_assign
(paren
id|dev_priv-&gt;warp_ucode_size
op_plus
id|dev_priv-&gt;primary_size
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
op_star
id|PAGE_SIZE
suffix:semicolon
id|drm_ioremapfree
c_func
(paren
(paren
r_void
op_star
)paren
id|dev_priv-&gt;ioremap
comma
id|temp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_priv-&gt;status_page
op_ne
l_int|NULL
)paren
(brace
id|iounmap
c_func
(paren
id|dev_priv-&gt;status_page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_priv-&gt;real_status_page
op_ne
l_int|0UL
)paren
(brace
id|mga_free_page
c_func
(paren
id|dev
comma
id|dev_priv-&gt;real_status_page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_priv-&gt;prim_bufs
op_ne
l_int|NULL
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MGA_NUM_PRIM_BUFS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev_priv-&gt;prim_bufs
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|drm_free
c_func
(paren
id|dev_priv-&gt;prim_bufs
(braket
id|i
)braket
comma
r_sizeof
(paren
id|drm_mga_prim_buf_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
)brace
)brace
id|drm_free
c_func
(paren
id|dev_priv-&gt;prim_bufs
comma
r_sizeof
(paren
r_void
op_star
)paren
op_star
(paren
id|MGA_NUM_PRIM_BUFS
op_plus
l_int|1
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_priv-&gt;head
op_ne
l_int|NULL
)paren
(brace
id|mga_freelist_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|drm_free
c_func
(paren
id|dev-&gt;dev_private
comma
r_sizeof
(paren
id|drm_mga_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_dma_initialize
r_static
r_int
id|mga_dma_initialize
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_mga_init_t
op_star
id|init
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
suffix:semicolon
id|drm_map_t
op_star
id|sarea_map
op_assign
l_int|NULL
suffix:semicolon
id|dev_priv
op_assign
id|drm_alloc
c_func
(paren
r_sizeof
(paren
id|drm_mga_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|memset
c_func
(paren
id|dev_priv
comma
l_int|0
comma
r_sizeof
(paren
id|drm_mga_private_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|init-&gt;reserved_map_idx
op_ge
id|dev-&gt;map_count
)paren
op_logical_or
(paren
id|init-&gt;buffer_map_idx
op_ge
id|dev-&gt;map_count
)paren
)paren
(brace
id|mga_dma_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev_priv-&gt;reserved_map_idx
op_assign
id|init-&gt;reserved_map_idx
suffix:semicolon
id|dev_priv-&gt;buffer_map_idx
op_assign
id|init-&gt;buffer_map_idx
suffix:semicolon
id|sarea_map
op_assign
id|dev-&gt;maplist
(braket
l_int|0
)braket
suffix:semicolon
id|dev_priv-&gt;sarea_priv
op_assign
(paren
id|drm_mga_sarea_t
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|sarea_map-&gt;handle
op_plus
id|init-&gt;sarea_priv_offset
)paren
suffix:semicolon
multiline_comment|/* Scale primary size to the next page */
id|dev_priv-&gt;chipset
op_assign
id|init-&gt;chipset
suffix:semicolon
id|dev_priv-&gt;frontOffset
op_assign
id|init-&gt;frontOffset
suffix:semicolon
id|dev_priv-&gt;backOffset
op_assign
id|init-&gt;backOffset
suffix:semicolon
id|dev_priv-&gt;depthOffset
op_assign
id|init-&gt;depthOffset
suffix:semicolon
id|dev_priv-&gt;textureOffset
op_assign
id|init-&gt;textureOffset
suffix:semicolon
id|dev_priv-&gt;textureSize
op_assign
id|init-&gt;textureSize
suffix:semicolon
id|dev_priv-&gt;cpp
op_assign
id|init-&gt;cpp
suffix:semicolon
id|dev_priv-&gt;sgram
op_assign
id|init-&gt;sgram
suffix:semicolon
id|dev_priv-&gt;stride
op_assign
id|init-&gt;stride
suffix:semicolon
id|dev_priv-&gt;mAccess
op_assign
id|init-&gt;mAccess
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev_priv-&gt;flush_queue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev_priv-&gt;buf_queue
)paren
suffix:semicolon
id|dev_priv-&gt;WarpPipe
op_assign
l_int|0xff000000
suffix:semicolon
id|dev_priv-&gt;vertexsize
op_assign
l_int|0
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;chipset=%d ucode_size=%d backOffset=%x depthOffset=%x&bslash;n&quot;
comma
id|dev_priv-&gt;chipset
comma
id|dev_priv-&gt;warp_ucode_size
comma
id|dev_priv-&gt;backOffset
comma
id|dev_priv-&gt;depthOffset
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;cpp: %d sgram: %d stride: %d maccess: %x&bslash;n&quot;
comma
id|dev_priv-&gt;cpp
comma
id|dev_priv-&gt;sgram
comma
id|dev_priv-&gt;stride
comma
id|dev_priv-&gt;mAccess
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|dev_priv-&gt;WarpIndex
comma
op_amp
id|init-&gt;WarpIndex
comma
r_sizeof
(paren
id|drm_mga_warp_index_t
)paren
op_star
id|MGA_MAX_WARP_PIPES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mga_init_primary_bufs
c_func
(paren
id|dev
comma
id|init
)paren
op_ne
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Can not initialize primary buffers&bslash;n&quot;
)paren
suffix:semicolon
id|mga_dma_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev_priv-&gt;real_status_page
op_assign
id|mga_alloc_page
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;real_status_page
op_eq
l_int|0UL
)paren
(brace
id|mga_dma_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DRM_ERROR
c_func
(paren
l_string|&quot;Can not allocate status page&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dev_priv-&gt;status_page
op_assign
id|ioremap_nocache
c_func
(paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|dev_priv-&gt;real_status_page
)paren
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;status_page
op_eq
l_int|NULL
)paren
(brace
id|mga_dma_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|DRM_ERROR
c_func
(paren
l_string|&quot;Can not remap status page&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Write status page when secend or softrap occurs */
id|MGA_WRITE
c_func
(paren
id|MGAREG_PRIMPTR
comma
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|dev_priv-&gt;real_status_page
)paren
op_or
l_int|0x00000003
)paren
suffix:semicolon
multiline_comment|/* Private is now filled in, initialize the hardware */
(brace
id|PRIMLOCALS
suffix:semicolon
id|PRIMGETPTR
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|PRIMOUTREG
c_func
(paren
id|MGAREG_DMAPAD
comma
l_int|0
)paren
suffix:semicolon
id|PRIMOUTREG
c_func
(paren
id|MGAREG_DMAPAD
comma
l_int|0
)paren
suffix:semicolon
id|PRIMOUTREG
c_func
(paren
id|MGAREG_DWGSYNC
comma
l_int|0x0100
)paren
suffix:semicolon
id|PRIMOUTREG
c_func
(paren
id|MGAREG_SOFTRAP
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Poll for the first buffer to insure that&n;&t;&t; * the status register will be correct&n;&t;&t; */
id|mga_flush_write_combine
c_func
(paren
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGAREG_PRIMADDRESS
comma
id|phys_head
op_or
id|TT_GENERAL
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGAREG_PRIMEND
comma
(paren
(paren
id|phys_head
op_plus
id|num_dwords
op_star
l_int|4
)paren
op_or
id|PDEA_pagpxfer_enable
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|MGA_READ
c_func
(paren
id|MGAREG_DWGSYNC
)paren
op_ne
l_int|0x0100
)paren
(brace
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mga_freelist_init
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Could not initialize freelist&bslash;n&quot;
)paren
suffix:semicolon
id|mga_dma_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_dma_init
r_int
id|mga_dma_init
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_mga_init_t
id|init
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|init
comma
(paren
id|drm_mga_init_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|init
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|init.func
)paren
(brace
r_case
id|MGA_INIT_DMA
suffix:colon
r_return
id|mga_dma_initialize
c_func
(paren
id|dev
comma
op_amp
id|init
)paren
suffix:semicolon
r_case
id|MGA_CLEANUP_DMA
suffix:colon
r_return
id|mga_dma_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|mga_irq_install
r_int
id|mga_irq_install
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
id|irq
)paren
(brace
r_int
id|retcode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;struct_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
)paren
(brace
id|up
c_func
(paren
op_amp
id|dev-&gt;struct_sem
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|dev-&gt;irq
op_assign
id|irq
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dev-&gt;struct_sem
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;install irq handler %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|dev-&gt;context_flag
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;interrupt_flag
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma_flag
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma-&gt;next_buffer
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;dma-&gt;next_queue
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;dma-&gt;this_buffer
op_assign
l_int|NULL
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dev-&gt;tq.list
)paren
suffix:semicolon
id|dev-&gt;tq.sync
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;tq.routine
op_assign
id|mga_dma_task_queue
suffix:semicolon
id|dev-&gt;tq.data
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Before installing handler */
id|MGA_WRITE
c_func
(paren
id|MGAREG_IEN
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Install handler */
r_if
c_cond
(paren
(paren
id|retcode
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|mga_dma_service
comma
id|SA_SHIRQ
comma
id|dev-&gt;devname
comma
id|dev
)paren
)paren
)paren
(brace
id|down
c_func
(paren
op_amp
id|dev-&gt;struct_sem
)paren
suffix:semicolon
id|dev-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dev-&gt;struct_sem
)paren
suffix:semicolon
r_return
id|retcode
suffix:semicolon
)brace
multiline_comment|/* After installing handler */
id|MGA_WRITE
c_func
(paren
id|MGAREG_ICLEAR
comma
l_int|0x00000001
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGAREG_IEN
comma
l_int|0x00000001
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_irq_uninstall
r_int
id|mga_irq_uninstall
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
r_int
id|irq
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;struct_sem
)paren
suffix:semicolon
id|irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|dev-&gt;irq
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dev-&gt;struct_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|irq
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;remove irq handler %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGAREG_ICLEAR
comma
l_int|0x00000001
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGAREG_IEN
comma
l_int|0
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_control
r_int
id|mga_control
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_control_t
id|ctl
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ctl
comma
(paren
id|drm_control_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|ctl
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|ctl.func
)paren
(brace
r_case
id|DRM_INST_HANDLER
suffix:colon
r_return
id|mga_irq_install
c_func
(paren
id|dev
comma
id|ctl.irq
)paren
suffix:semicolon
r_case
id|DRM_UNINST_HANDLER
suffix:colon
r_return
id|mga_irq_uninstall
c_func
(paren
id|dev
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|mga_flush_queue
r_static
r_int
id|mga_flush_queue
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|entry
comma
id|current
)paren
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_priv-&gt;next_prim-&gt;num_dwords
op_ne
l_int|0
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|dev_priv-&gt;flush_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|MGA_IN_FLUSH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
)paren
id|DRM_ERROR
c_func
(paren
l_string|&quot;Incorrect mga_flush_queue logic&bslash;n&quot;
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|MGA_IN_FLUSH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
id|mga_dma_schedule
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|MGA_IN_FLUSH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
)paren
r_break
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_sleeps
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
multiline_comment|/* Can&squot;t restart */
id|clear_bit
c_func
(paren
id|MGA_IN_FLUSH
comma
op_amp
id|dev_priv-&gt;dispatch_status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dev_priv-&gt;flush_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Must be called with the lock held */
DECL|function|mga_reclaim_buffers
r_void
id|mga_reclaim_buffers
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|pid_t
id|pid
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dev_private
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma-&gt;buflist
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;buf_count=%d&bslash;n&quot;
comma
id|dma-&gt;buf_count
)paren
suffix:semicolon
id|mga_flush_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|drm_buf_t
op_star
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|drm_mga_buf_priv_t
op_star
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
multiline_comment|/* Only buffers that need to get reclaimed ever&n;&t;&t; * get set to free&n;&t;&t; */
r_if
c_cond
(paren
id|buf-&gt;pid
op_eq
id|pid
op_logical_and
id|buf_priv
)paren
(brace
r_if
c_cond
(paren
id|buf_priv-&gt;my_freelist-&gt;age
op_eq
id|MGA_BUF_USED
)paren
(brace
id|buf_priv-&gt;my_freelist-&gt;age
op_assign
id|MGA_BUF_FREE
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|mga_lock
r_int
id|mga_lock
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|entry
comma
id|current
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|drm_lock_t
id|lock
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|lock
comma
(paren
id|drm_lock_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|lock
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|lock.context
op_eq
id|DRM_KERNEL_CONTEXT
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d using kernel context %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|lock.context
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lock.context
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Only one queue:&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|dev-&gt;lock.lock_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;lock.hw_lock
)paren
(brace
multiline_comment|/* Device has been unregistered */
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|drm_lock_take
c_func
(paren
op_amp
id|dev-&gt;lock.hw_lock-&gt;lock
comma
id|lock.context
)paren
)paren
(brace
id|dev-&gt;lock.pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|dev-&gt;lock.lock_time
op_assign
id|jiffies
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_locks
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Got lock */
)brace
multiline_comment|/* Contention */
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;total_sleeps
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dev-&gt;lock.lock_queue
comma
op_amp
id|entry
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|sigemptyset
c_func
(paren
op_amp
id|dev-&gt;sigmask
)paren
suffix:semicolon
id|sigaddset
c_func
(paren
op_amp
id|dev-&gt;sigmask
comma
id|SIGSTOP
)paren
suffix:semicolon
id|sigaddset
c_func
(paren
op_amp
id|dev-&gt;sigmask
comma
id|SIGTSTP
)paren
suffix:semicolon
id|sigaddset
c_func
(paren
op_amp
id|dev-&gt;sigmask
comma
id|SIGTTIN
)paren
suffix:semicolon
id|sigaddset
c_func
(paren
op_amp
id|dev-&gt;sigmask
comma
id|SIGTTOU
)paren
suffix:semicolon
id|dev-&gt;sigdata.context
op_assign
id|lock.context
suffix:semicolon
id|dev-&gt;sigdata.lock
op_assign
id|dev-&gt;lock.hw_lock
suffix:semicolon
id|block_all_signals
c_func
(paren
id|drm_notifier
comma
op_amp
id|dev-&gt;sigdata
comma
op_amp
id|dev-&gt;sigmask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lock.flags
op_amp
id|_DRM_LOCK_QUIESCENT
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;_DRM_LOCK_QUIESCENT&bslash;n&quot;
)paren
suffix:semicolon
id|mga_flush_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mga_dma_quiescent
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ret
)paren
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%d %s&bslash;n&quot;
comma
id|lock.context
comma
id|ret
ques
c_cond
l_string|&quot;interrupted&quot;
suffix:colon
l_string|&quot;has lock&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|mga_flush_ioctl
r_int
id|mga_flush_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_lock_t
id|lock
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|lock
comma
(paren
id|drm_lock_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|lock
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;lock not held&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lock.flags
op_amp
id|_DRM_LOCK_FLUSH
op_logical_or
id|lock.flags
op_amp
id|_DRM_LOCK_FLUSH_ALL
)paren
(brace
id|drm_mga_prim_buf_t
op_star
id|temp_buf
suffix:semicolon
id|temp_buf
op_assign
id|dev_priv-&gt;current_prim
suffix:semicolon
r_if
c_cond
(paren
id|temp_buf
op_logical_and
id|temp_buf-&gt;num_dwords
)paren
(brace
id|set_bit
c_func
(paren
id|MGA_BUF_FORCE_FIRE
comma
op_amp
id|temp_buf-&gt;buffer_status
)paren
suffix:semicolon
id|mga_advance_primary
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|mga_dma_schedule
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lock.flags
op_amp
id|_DRM_LOCK_QUIESCENT
)paren
(brace
id|mga_flush_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|mga_dma_quiescent
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
