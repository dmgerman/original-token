multiline_comment|/*&n; * linux/drivers/char/joystick.c  Version 1.0.9&n; * Copyright (C) 1996-1998 Vojtech Pavlik&n; */
multiline_comment|/*&n; * This is joystick driver for Linux. It supports up to two analog joysticks&n; * on a PC compatible machine. See Documentation/joystick.txt for changelog&n; * and credits.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/joystick.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|PIT_HZ
mdefine_line|#define PIT_HZ&t;&t;&t;1193180L&t;/* PIT clock is 1.19318 MHz */
DECL|macro|JS_MAXTIME
mdefine_line|#define JS_MAXTIME&t;&t;PIT_HZ/250&t;/* timeout for read (4 ms) */
DECL|macro|JS_TIMER_PERIOD
mdefine_line|#define JS_TIMER_PERIOD&t;&t;HZ/50&t;&t;/* button valid time (20 ms) */
DECL|macro|JS_BH_MIN_PERIOD
mdefine_line|#define JS_BH_MIN_PERIOD&t;HZ/25&t;&t;/* axis min valid time (40 ms) */
DECL|macro|JS_BH_MAX_PERIOD
mdefine_line|#define JS_BH_MAX_PERIOD&t;HZ/25*2&t;&t;/* axis max valid time (80 ms) */
DECL|macro|JS_FIFO_SIZE
mdefine_line|#define JS_FIFO_SIZE&t;&t;16&t;&t;/* number of FIFO entries */
DECL|macro|JS_BUFF_SIZE
mdefine_line|#define JS_BUFF_SIZE&t;&t;32 &t;&t;/* output buffer size */
DECL|macro|JS_RETRIES
mdefine_line|#define JS_RETRIES&t;&t;4&t;&t;/* number of retries */
DECL|macro|JS_DEF_PREC
mdefine_line|#define JS_DEF_PREC&t;&t;16&t;&t;/* initial precision for all axes */
DECL|macro|JS_NUM
mdefine_line|#define JS_NUM&t;&t;&t;2&t;&t;/* number of joysticks */
DECL|macro|JS_AXES
mdefine_line|#define JS_AXES &t;&t;0x0f&t;&t;/* bit mask for all axes */
DECL|macro|JS_BUTTONS
mdefine_line|#define JS_BUTTONS&t;&t;0xf0&t;&t;/* bit mask for all buttons */
DECL|macro|PIT_MODE
mdefine_line|#define PIT_MODE &t;&t;0x43&t;&t;/* timer mode port */
DECL|macro|PIT_DATA
mdefine_line|#define PIT_DATA &t;&t;0x40&t;&t;/* timer 0 data port */
DECL|macro|JS_PORT
mdefine_line|#define JS_PORT &t;&t;0x201&t;&t;/* joystick port */
DECL|macro|JS_TRIGGER
mdefine_line|#define JS_TRIGGER&t;&t;0xff&t;&t;/* triggers one-shots */
DECL|macro|PIT_READ_TIMER
mdefine_line|#define PIT_READ_TIMER&t;&t;0x00&t;&t;/* to read timer 0 */
DECL|macro|DELTA
mdefine_line|#define DELTA(X,Y,Z)&t;((X)-(Y)+(((X)&gt;=(Y))?0:Z))&t;&t;&t;&t;/* cyclic delta */
DECL|macro|DELTA_T
mdefine_line|#define DELTA_T(X,Y)&t;DELTA((X),(Y),(PIT_HZ/HZ))&t;&t;&t;&t;/* for time measurement */
DECL|macro|DELTA_TX
mdefine_line|#define DELTA_TX(X,Y,Z)&t;DELTA_T((X),((Y)&amp;0xFF)|(((Z)&amp;0xFF)&lt;&lt;8))
DECL|macro|ROT
mdefine_line|#define ROT(A,B,C)&t;((((A)&lt;(C))&amp;&amp;(((B)&gt;(A))&amp;&amp;((B)&lt;(C))))||(((A)&gt;(C))&amp;&amp;(((B)&gt;(A))||((B)&lt;(C)))))
DECL|macro|GOF
mdefine_line|#define GOF(X)&t;&t;(((X)==JS_BUFF_SIZE-1)?0:(X)+1)
DECL|macro|GOFF
mdefine_line|#define GOFF(X)&t;&t;(((X)==JS_FIFO_SIZE-1)?0:(X)+1)
DECL|macro|GOB
mdefine_line|#define GOB(X)&t;&t;((X)?(X)-1:JS_BUFF_SIZE-1)
DECL|struct|js_data
r_struct
id|js_data
(brace
DECL|member|ahead
r_int
id|ahead
suffix:semicolon
DECL|member|bhead
r_int
id|bhead
suffix:semicolon
DECL|member|tail
r_int
id|tail
suffix:semicolon
DECL|member|buff
r_struct
id|js_event
id|buff
(braket
id|JS_BUFF_SIZE
)braket
suffix:semicolon
DECL|member|list
r_struct
id|js_list
op_star
id|list
suffix:semicolon
DECL|member|wait
r_struct
id|wait_queue
op_star
id|wait
suffix:semicolon
DECL|member|exist
r_int
r_int
id|exist
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|js_axis
r_struct
id|js_axis
(brace
DECL|member|value
r_int
id|value
suffix:semicolon
DECL|member|corr
r_struct
id|js_corr
id|corr
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|js_list
r_struct
id|js_list
(brace
DECL|member|next
r_struct
id|js_list
op_star
id|next
suffix:semicolon
multiline_comment|/* next-in-list pointer */
DECL|member|time
r_int
r_int
id|time
suffix:semicolon
multiline_comment|/* when the device was open */
DECL|member|tail
r_int
id|tail
suffix:semicolon
multiline_comment|/* a tail for js_buff */
DECL|member|startup
r_char
id|startup
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|js_fifo
r_struct
id|js_fifo
(brace
DECL|member|time
r_int
r_int
id|time
suffix:semicolon
DECL|member|event
r_int
r_int
id|event
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|jsd
r_static
r_struct
id|js_data
id|jsd
(braket
id|JS_NUM
)braket
suffix:semicolon
multiline_comment|/* joystick data */
DECL|variable|js_timer
r_static
r_struct
id|timer_list
id|js_timer
suffix:semicolon
multiline_comment|/* joystick timer */
DECL|variable|js_fifo_head
r_static
r_int
r_char
id|js_fifo_head
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* head of the fifo */
DECL|variable|js_fifo_tail
r_static
r_int
r_char
id|js_fifo_tail
op_assign
id|JS_FIFO_SIZE
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* tail of the fifo */
DECL|variable|js_fifo
r_static
r_struct
id|js_fifo
id|js_fifo
(braket
id|JS_FIFO_SIZE
)braket
suffix:semicolon
multiline_comment|/* the fifo */
DECL|variable|js_last_buttons
r_static
r_int
r_char
id|js_last_buttons
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* last read button state */
DECL|variable|js_bh_time
r_static
r_int
r_int
id|js_bh_time
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* last read axis time */
DECL|variable|js_mark_time
r_static
r_int
r_int
id|js_mark_time
op_assign
l_int|0
suffix:semicolon
DECL|variable|js_axes_exist
r_static
r_int
r_char
id|js_axes_exist
suffix:semicolon
multiline_comment|/* all axes that exist */
DECL|variable|js_buttons_exist
r_static
r_int
r_char
id|js_buttons_exist
suffix:semicolon
multiline_comment|/* all buttons that exist */
DECL|variable|js_axis
r_static
r_struct
id|js_axis
id|js_axis
(braket
l_int|4
)braket
suffix:semicolon
DECL|variable|js_buttons
r_static
r_int
r_int
id|js_buttons
op_assign
l_int|0
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Vojtech Pavlik &lt;vojtech@atrey.karlin.mff.cuni.cz&gt;&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;js&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|js
comma
l_string|&quot;1-2b&quot;
)paren
suffix:semicolon
DECL|variable|js
r_static
r_char
id|js
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/*&n; * get_pit() returns the immediate state of PIT0. Must be run&n; * with interrupts disabled.&n; */
DECL|function|get_pit
r_static
r_inline
r_int
id|get_pit
c_func
(paren
r_void
)paren
(brace
r_int
id|t
comma
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PIT_READ_TIMER
comma
id|PIT_MODE
)paren
suffix:semicolon
id|t
op_assign
id|inb
c_func
(paren
id|PIT_DATA
)paren
suffix:semicolon
id|t
op_or_assign
(paren
r_int
)paren
id|inb
c_func
(paren
id|PIT_DATA
)paren
op_lshift
l_int|8
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|t
suffix:semicolon
)brace
multiline_comment|/*&n; * count_bits() counts set bits in a byte.&n; */
DECL|function|count_bits
r_static
r_int
id|count_bits
c_func
(paren
r_int
r_int
id|c
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|c
)paren
(brace
id|i
op_add_assign
id|c
op_amp
l_int|1
suffix:semicolon
id|c
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/*&n; * js_correct() performs correction of raw joystick data.&n; */
DECL|function|js_correct
r_static
r_int
id|js_correct
c_func
(paren
r_int
id|value
comma
r_struct
id|js_corr
op_star
id|corr
)paren
(brace
r_int
id|t
suffix:semicolon
r_if
c_cond
(paren
id|corr-&gt;type
op_eq
id|JS_CORR_NONE
)paren
r_return
id|value
suffix:semicolon
id|t
op_assign
id|value
OG
id|corr-&gt;coef
(braket
l_int|0
)braket
ques
c_cond
(paren
id|value
OL
id|corr-&gt;coef
(braket
l_int|1
)braket
ques
c_cond
l_int|0
suffix:colon
id|value
op_minus
id|corr-&gt;coef
(braket
l_int|1
)braket
)paren
suffix:colon
id|value
op_minus
id|corr-&gt;coef
(braket
l_int|0
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|corr-&gt;type
)paren
(brace
r_case
id|JS_CORR_BROKEN
suffix:colon
id|t
op_assign
id|t
OL
l_int|0
ques
c_cond
(paren
(paren
id|corr-&gt;coef
(braket
l_int|2
)braket
op_star
id|t
)paren
op_rshift
l_int|14
)paren
suffix:colon
(paren
(paren
id|corr-&gt;coef
(braket
l_int|3
)braket
op_star
id|t
)paren
op_rshift
l_int|14
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|t
OL
op_minus
l_int|32767
)paren
r_return
op_minus
l_int|32767
suffix:semicolon
r_if
c_cond
(paren
id|t
OG
l_int|32767
)paren
r_return
l_int|32767
suffix:semicolon
r_return
id|t
suffix:semicolon
)brace
multiline_comment|/*&n; * js_compare() compares two close axis values and decides&n; * whether they are &quot;same&quot;.&n; */
DECL|function|js_compare
r_static
r_int
id|js_compare
c_func
(paren
r_int
id|x
comma
r_int
id|y
comma
r_int
id|prec
)paren
(brace
r_return
(paren
id|x
OL
id|y
op_plus
id|prec
)paren
op_logical_and
(paren
id|y
OL
id|x
op_plus
id|prec
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * js_probe() probes for joysticks&n; */
DECL|function|js_probe
r_inline
r_int
id|js_probe
c_func
(paren
r_void
)paren
(brace
r_int
id|t
suffix:semicolon
id|outb
c_func
(paren
id|JS_TRIGGER
comma
id|JS_PORT
)paren
suffix:semicolon
id|t
op_assign
id|get_pit
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|DELTA_T
c_func
(paren
id|t
comma
id|get_pit
c_func
(paren
)paren
)paren
OL
id|JS_MAXTIME
)paren
suffix:semicolon
id|t
op_assign
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|js
(braket
l_int|0
)braket
op_logical_or
id|js
(braket
l_int|1
)braket
)paren
(brace
id|jsd
(braket
l_int|0
)braket
dot
id|exist
op_assign
id|js
(braket
l_int|0
)braket
op_amp
op_complement
(paren
id|t
op_amp
id|JS_AXES
)paren
suffix:semicolon
id|jsd
(braket
l_int|1
)braket
dot
id|exist
op_assign
id|js
(braket
l_int|1
)braket
op_amp
op_complement
(paren
id|t
op_amp
id|JS_AXES
)paren
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|t
op_amp
id|JS_AXES
)paren
(brace
r_case
l_int|0x0c
suffix:colon
id|jsd
(braket
l_int|0
)braket
dot
id|exist
op_assign
l_int|0x33
suffix:semicolon
id|jsd
(braket
l_int|1
)braket
dot
id|exist
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* joystick 0 connected */
r_case
l_int|0x03
suffix:colon
id|jsd
(braket
l_int|0
)braket
dot
id|exist
op_assign
l_int|0xcc
suffix:semicolon
id|jsd
(braket
l_int|1
)braket
dot
id|exist
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* joystick 1 connected */
r_case
l_int|0x04
suffix:colon
id|jsd
(braket
l_int|0
)braket
dot
id|exist
op_assign
l_int|0xfb
suffix:semicolon
id|jsd
(braket
l_int|1
)braket
dot
id|exist
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 3-axis joystick connected */
r_case
l_int|0x00
suffix:colon
id|jsd
(braket
l_int|0
)braket
dot
id|exist
op_assign
l_int|0x33
suffix:semicolon
id|jsd
(braket
l_int|1
)braket
dot
id|exist
op_assign
l_int|0xcc
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* joysticks 0 and 1 connected */
r_default
suffix:colon
id|jsd
(braket
l_int|0
)braket
dot
id|exist
op_assign
l_int|0x00
suffix:semicolon
id|jsd
(braket
l_int|1
)braket
dot
id|exist
op_assign
l_int|0x00
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* no joysticks */
)brace
id|js_axes_exist
op_assign
(paren
id|jsd
(braket
l_int|0
)braket
dot
id|exist
op_or
id|jsd
(braket
l_int|1
)braket
dot
id|exist
)paren
op_amp
id|JS_AXES
suffix:semicolon
id|js_buttons_exist
op_assign
(paren
id|jsd
(braket
l_int|0
)braket
dot
id|exist
op_or
id|jsd
(braket
l_int|1
)braket
dot
id|exist
)paren
op_amp
id|JS_BUTTONS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * js_do_timer() controls the action by adding entries to the event&n; * fifo each time a button changes its state or axis valid time&n; * expires.&n; */
DECL|function|js_do_timer
r_static
r_void
id|js_do_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_int
id|t
op_assign
op_complement
id|inb
c_func
(paren
id|JS_PORT
)paren
op_amp
id|js_buttons_exist
suffix:semicolon
r_if
c_cond
(paren
(paren
id|js_last_buttons
op_ne
id|t
)paren
op_logical_and
(paren
id|js_fifo_head
op_ne
id|js_fifo_tail
)paren
)paren
(brace
id|js_fifo
(braket
id|js_fifo_head
)braket
dot
id|event
op_assign
id|js_last_buttons
op_assign
id|t
suffix:semicolon
id|js_fifo
(braket
id|js_fifo_head
)braket
dot
id|time
op_assign
id|jiffies
suffix:semicolon
id|js_fifo_head
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|js_fifo_head
op_eq
id|JS_FIFO_SIZE
)paren
id|js_fifo_head
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|js_mark_time
)paren
(brace
id|js_mark_time
op_assign
id|jiffies
suffix:semicolon
id|mark_bh
c_func
(paren
id|JS_BH
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|jiffies
OG
id|js_bh_time
op_plus
id|JS_BH_MAX_PERIOD
)paren
op_logical_and
op_logical_neg
id|js_mark_time
)paren
(brace
id|js_mark_time
op_assign
id|jiffies
suffix:semicolon
id|mark_bh
c_func
(paren
id|JS_BH
)paren
suffix:semicolon
)brace
id|js_timer.expires
op_assign
id|jiffies
op_plus
id|JS_TIMER_PERIOD
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|js_timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Put an event in the buffer. This requires additional queue processing&n; * done by js_sync_buff, otherwise the buffer will be corrupted.&n; */
DECL|function|js_add_event
r_static
r_void
id|js_add_event
c_func
(paren
r_int
id|i
comma
id|__u32
id|time
comma
id|__u8
id|type
comma
id|__u8
id|number
comma
id|__u16
id|value
)paren
(brace
r_int
id|ahead
op_assign
id|jsd
(braket
id|i
)braket
dot
id|ahead
op_increment
suffix:semicolon
id|jsd
(braket
id|i
)braket
dot
id|buff
(braket
id|ahead
)braket
dot
id|time
op_assign
id|time
suffix:semicolon
id|jsd
(braket
id|i
)braket
dot
id|buff
(braket
id|ahead
)braket
dot
id|type
op_assign
id|type
suffix:semicolon
id|jsd
(braket
id|i
)braket
dot
id|buff
(braket
id|ahead
)braket
dot
id|number
op_assign
id|number
suffix:semicolon
id|jsd
(braket
id|i
)braket
dot
id|buff
(braket
id|ahead
)braket
dot
id|value
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|jsd
(braket
id|i
)braket
dot
id|ahead
op_eq
id|JS_BUFF_SIZE
)paren
id|jsd
(braket
id|i
)braket
dot
id|ahead
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This checks for all owerflows caused by recent additions to the buffer.&n; * It does anything only if some processes are reading the data too slowly.&n; */
DECL|function|js_sync_buff
r_static
r_void
id|js_sync_buff
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|JS_NUM
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|jsd
(braket
id|i
)braket
dot
id|list
)paren
r_if
c_cond
(paren
id|jsd
(braket
id|i
)braket
dot
id|bhead
op_ne
id|jsd
(braket
id|i
)braket
dot
id|ahead
)paren
(brace
r_if
c_cond
(paren
id|ROT
c_func
(paren
id|jsd
(braket
id|i
)braket
dot
id|bhead
comma
id|jsd
(braket
id|i
)braket
dot
id|tail
comma
id|jsd
(braket
id|i
)braket
dot
id|ahead
)paren
op_logical_or
(paren
id|jsd
(braket
id|i
)braket
dot
id|tail
op_eq
id|jsd
(braket
id|i
)braket
dot
id|bhead
)paren
)paren
(brace
r_struct
id|js_list
op_star
id|curl
suffix:semicolon
id|curl
op_assign
id|jsd
(braket
id|i
)braket
dot
id|list
suffix:semicolon
r_while
c_loop
(paren
id|curl
)paren
(brace
r_if
c_cond
(paren
id|ROT
c_func
(paren
id|jsd
(braket
id|i
)braket
dot
id|bhead
comma
id|curl-&gt;tail
comma
id|jsd
(braket
id|i
)braket
dot
id|ahead
)paren
op_logical_or
(paren
id|curl-&gt;tail
op_eq
id|jsd
(braket
id|i
)braket
dot
id|bhead
)paren
)paren
(brace
id|curl-&gt;tail
op_assign
id|jsd
(braket
id|i
)braket
dot
id|ahead
suffix:semicolon
id|curl-&gt;startup
op_assign
id|jsd
(braket
id|i
)braket
dot
id|exist
suffix:semicolon
)brace
id|curl
op_assign
id|curl-&gt;next
suffix:semicolon
)brace
id|jsd
(braket
id|i
)braket
dot
id|tail
op_assign
id|jsd
(braket
id|i
)braket
dot
id|ahead
suffix:semicolon
)brace
id|jsd
(braket
id|i
)braket
dot
id|bhead
op_assign
id|jsd
(braket
id|i
)braket
dot
id|ahead
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|jsd
(braket
id|i
)braket
dot
id|wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * js_do_bh() does the main processing and adds events to output buffers.&n; */
DECL|function|js_do_bh
r_static
r_void
id|js_do_bh
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
r_int
r_int
id|t
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
OG
id|js_bh_time
op_plus
id|JS_BH_MIN_PERIOD
)paren
(brace
r_int
r_int
id|old_axis
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_int
id|t_low
comma
id|t_high
suffix:semicolon
r_int
r_int
id|flags
comma
id|joy_state
suffix:semicolon
r_int
r_int
id|t1l
comma
id|t1h
comma
id|jsm
suffix:semicolon
r_int
r_char
id|jss
suffix:semicolon
r_int
r_char
id|again
suffix:semicolon
r_int
r_char
id|retries
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|old_axis
(braket
id|i
)braket
op_assign
id|js_axis
(braket
id|i
)braket
dot
id|value
suffix:semicolon
r_do
(brace
id|i
op_assign
l_int|0
suffix:semicolon
id|again
op_assign
l_int|0
suffix:semicolon
id|t_low
op_assign
l_int|0
suffix:semicolon
id|t_high
op_assign
l_int|0
suffix:semicolon
id|joy_state
op_assign
id|JS_AXES
suffix:semicolon
multiline_comment|/*&n; * Measure the axes.&n; */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* no interrupts */
id|outb
c_func
(paren
id|JS_TRIGGER
comma
id|JS_PORT
)paren
suffix:semicolon
multiline_comment|/* trigger one-shots */
id|outb
c_func
(paren
id|PIT_READ_TIMER
comma
id|PIT_MODE
)paren
suffix:semicolon
multiline_comment|/* read timer */
id|t
op_assign
(paren
id|t1l
op_assign
id|inb
c_func
(paren
id|PIT_DATA
)paren
)paren
op_or
(paren
id|t1h
op_assign
id|inb
c_func
(paren
id|PIT_DATA
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_do
(brace
id|jss
op_assign
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jss
op_xor
id|joy_state
)paren
op_amp
id|js_axes_exist
)paren
(brace
id|t_low
op_assign
(paren
id|t_low
op_lshift
l_int|8
)paren
op_or
id|t1l
suffix:semicolon
id|t_high
op_assign
(paren
id|t_high
op_lshift
l_int|8
)paren
op_or
id|t1h
suffix:semicolon
id|joy_state
op_assign
(paren
id|joy_state
op_lshift
l_int|8
)paren
op_or
id|jss
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PIT_READ_TIMER
comma
id|PIT_MODE
)paren
suffix:semicolon
id|t1l
op_assign
id|inb
c_func
(paren
id|PIT_DATA
)paren
suffix:semicolon
id|t1h
op_assign
id|inb
c_func
(paren
id|PIT_DATA
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|jss
op_amp
id|js_axes_exist
)paren
op_logical_and
(paren
id|DELTA_TX
c_func
(paren
id|t
comma
id|t1l
comma
id|t1h
)paren
OL
id|JS_MAXTIME
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Process the gathered axis data in joy_state.&n; */
id|joy_state
op_xor_assign
(paren
(paren
id|joy_state
op_rshift
l_int|8
)paren
op_or
l_int|0xff000000L
)paren
suffix:semicolon
multiline_comment|/* More magic */
r_for
c_loop
(paren
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|joy_state
op_amp
id|js_axes_exist
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|jsm
op_assign
id|DELTA_TX
c_func
(paren
id|t
comma
id|t_low
comma
id|t_high
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|js_compare
c_func
(paren
id|jsm
comma
id|js_axis
(braket
id|j
)braket
dot
id|value
comma
id|js_axis
(braket
id|j
)braket
dot
id|corr.prec
)paren
)paren
(brace
r_if
c_cond
(paren
id|jsm
OL
id|js_axis
(braket
id|j
)braket
dot
id|value
op_logical_or
op_logical_neg
id|retries
)paren
id|js_axis
(braket
id|j
)braket
dot
id|value
op_assign
id|jsm
suffix:semicolon
id|again
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|joy_state
op_assign
id|joy_state
op_rshift
l_int|8
suffix:semicolon
id|t_low
op_assign
id|t_low
op_rshift
l_int|8
suffix:semicolon
id|t_high
op_assign
id|t_high
op_rshift
l_int|8
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|retries
op_increment
OL
id|JS_RETRIES
op_logical_and
id|again
)paren
suffix:semicolon
multiline_comment|/*&n; * Check if joystick lost.&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|JS_NUM
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|jsd
(braket
id|i
)braket
dot
id|exist
op_logical_and
(paren
(paren
id|jss
op_amp
id|jsd
(braket
id|i
)braket
dot
id|exist
op_amp
id|JS_AXES
)paren
op_eq
(paren
id|jsd
(braket
id|i
)braket
dot
id|exist
op_amp
id|JS_AXES
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;js%d: joystick lost.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|js_buttons_exist
op_and_assign
op_complement
id|jsd
(braket
id|i
)braket
dot
id|exist
suffix:semicolon
id|js_axes_exist
op_and_assign
op_complement
id|jsd
(braket
id|i
)braket
dot
id|exist
suffix:semicolon
id|jsd
(braket
id|i
)braket
dot
id|exist
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|jsd
(braket
id|i
)braket
dot
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|jss
op_amp
id|jsd
(braket
id|i
)braket
dot
id|exist
op_amp
id|JS_AXES
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;js%d: joystick broken. Check cables.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Put changed axes into output buffer.&n; */
r_if
c_cond
(paren
id|retries
OG
l_int|1
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|JS_NUM
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|jsd
(braket
id|i
)braket
dot
id|list
)paren
(brace
id|k
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|j
)paren
op_amp
id|jsd
(braket
id|i
)braket
dot
id|exist
)paren
(brace
r_if
c_cond
(paren
(paren
id|t
op_assign
id|js_correct
c_func
(paren
id|js_axis
(braket
id|j
)braket
dot
id|value
comma
op_amp
id|js_axis
(braket
id|j
)braket
dot
id|corr
)paren
)paren
op_ne
id|js_correct
c_func
(paren
id|old_axis
(braket
id|j
)braket
comma
op_amp
id|js_axis
(braket
id|j
)braket
dot
id|corr
)paren
)paren
id|js_add_event
c_func
(paren
id|i
comma
id|js_mark_time
comma
id|JS_EVENT_AXIS
comma
id|k
comma
id|t
)paren
suffix:semicolon
id|k
op_increment
suffix:semicolon
)brace
)brace
id|js_bh_time
op_assign
id|jiffies
suffix:semicolon
)brace
id|js_mark_time
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * And now process the button fifo.&n; */
r_while
c_loop
(paren
id|js_fifo_head
op_ne
(paren
id|t
op_assign
id|GOFF
c_func
(paren
id|js_fifo_tail
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|JS_NUM
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|jsd
(braket
id|i
)braket
dot
id|list
)paren
(brace
id|k
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|4
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|j
)paren
op_amp
id|jsd
(braket
id|i
)braket
dot
id|exist
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|j
)paren
op_amp
(paren
id|js_buttons
op_xor
id|js_fifo
(braket
id|t
)braket
dot
id|event
)paren
)paren
id|js_add_event
c_func
(paren
id|i
comma
id|js_fifo
(braket
id|t
)braket
dot
id|time
comma
id|JS_EVENT_BUTTON
comma
id|k
comma
(paren
id|js_fifo
(braket
id|t
)braket
dot
id|event
op_rshift
id|j
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|k
op_increment
suffix:semicolon
)brace
)brace
id|js_buttons
op_assign
id|js_fifo
(braket
id|js_fifo_tail
op_assign
id|t
)braket
dot
id|event
suffix:semicolon
)brace
multiline_comment|/*&n; * Synchronize the buffer.&n; */
id|js_sync_buff
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * js_lseek() just returns with error.&n; */
DECL|function|js_lseek
r_static
id|loff_t
id|js_lseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
multiline_comment|/*&n; * js_read() copies one or more entries from jsd[].buff to user&n; * space.&n; */
DECL|function|js_read
r_static
id|ssize_t
id|js_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|wait_queue
id|wait
op_assign
(brace
id|current
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|js_list
op_star
id|curl
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|js_event
op_star
id|buff
op_assign
(paren
r_void
op_star
)paren
id|buf
suffix:semicolon
r_int
r_int
id|blocks
op_assign
id|count
op_div
r_sizeof
(paren
r_struct
id|js_event
)paren
suffix:semicolon
r_int
r_int
id|i
op_assign
l_int|0
comma
id|j
suffix:semicolon
r_int
id|t
comma
id|u
op_assign
id|curl-&gt;tail
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Check user data.&n; */
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
op_ne
id|JOYSTICK_MAJOR
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_pos
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|blocks
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|curl
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|minor
OG
id|JS_NUM
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|jsd
(braket
id|minor
)braket
dot
id|exist
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n; * Handle (non)blocking i/o.&n; */
r_if
c_cond
(paren
(paren
id|GOF
c_func
(paren
id|curl-&gt;tail
)paren
op_eq
id|jsd
(braket
id|minor
)braket
dot
id|ahead
op_logical_and
op_logical_neg
id|curl-&gt;startup
op_logical_and
id|count
op_ne
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
op_logical_or
(paren
id|curl-&gt;startup
op_logical_and
op_logical_neg
id|js_bh_time
)paren
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|jsd
(braket
id|minor
)braket
dot
id|wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_while
c_loop
(paren
(paren
id|GOF
c_func
(paren
id|curl-&gt;tail
)paren
op_eq
id|jsd
(braket
id|minor
)braket
dot
id|ahead
op_logical_and
op_logical_neg
id|curl-&gt;startup
op_logical_and
id|count
op_ne
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
op_logical_or
(paren
id|curl-&gt;startup
op_logical_and
op_logical_neg
id|js_bh_time
)paren
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|jsd
(braket
id|minor
)braket
dot
id|exist
)paren
(brace
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|jsd
(braket
id|minor
)braket
dot
id|wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
multiline_comment|/*&n; * Do the i/o.&n; */
r_if
c_cond
(paren
id|count
op_ne
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
(brace
r_if
c_cond
(paren
id|curl-&gt;startup
)paren
(brace
r_struct
id|js_event
id|tmpevent
suffix:semicolon
multiline_comment|/*&n; * Initial button state.&n; */
id|t
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|4
op_logical_and
(paren
id|i
OL
id|blocks
)paren
op_logical_and
op_logical_neg
id|retval
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|jsd
(braket
id|minor
)braket
dot
id|exist
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
r_if
c_cond
(paren
id|curl-&gt;startup
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|tmpevent.type
op_assign
id|JS_EVENT_AXIS
op_or
id|JS_EVENT_INIT
suffix:semicolon
id|tmpevent.number
op_assign
id|t
suffix:semicolon
id|tmpevent.value
op_assign
id|js_correct
c_func
(paren
id|js_axis
(braket
id|j
)braket
dot
id|value
comma
op_amp
id|js_axis
(braket
id|j
)braket
dot
id|corr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|buff
(braket
id|i
)braket
comma
op_amp
id|tmpevent
comma
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
(paren
id|__u32
)paren
(paren
(paren
id|jiffies
op_minus
id|curl-&gt;time
)paren
op_star
(paren
l_int|1000
op_div
id|HZ
)paren
)paren
comma
op_amp
id|buff
(braket
id|i
)braket
dot
id|time
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|curl-&gt;startup
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|j
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|t
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * Initial axis state.&n; */
id|t
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|4
suffix:semicolon
id|j
OL
l_int|8
op_logical_and
(paren
id|i
OL
id|blocks
)paren
op_logical_and
op_logical_neg
id|retval
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|jsd
(braket
id|minor
)braket
dot
id|exist
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
r_if
c_cond
(paren
id|curl-&gt;startup
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|tmpevent.type
op_assign
id|JS_EVENT_BUTTON
op_or
id|JS_EVENT_INIT
suffix:semicolon
id|tmpevent.number
op_assign
id|t
suffix:semicolon
id|tmpevent.value
op_assign
(paren
id|js_buttons
op_rshift
id|j
)paren
op_amp
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|buff
(braket
id|i
)braket
comma
op_amp
id|tmpevent
comma
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
(paren
id|__u32
)paren
(paren
(paren
id|jiffies
op_minus
id|curl-&gt;time
)paren
op_star
(paren
l_int|1000
op_div
id|HZ
)paren
)paren
comma
op_amp
id|buff
(braket
id|i
)braket
dot
id|time
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|curl-&gt;startup
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|j
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|t
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Buffer data.&n; */
r_while
c_loop
(paren
(paren
id|jsd
(braket
id|minor
)braket
dot
id|ahead
op_ne
(paren
id|t
op_assign
id|GOF
c_func
(paren
id|curl-&gt;tail
)paren
)paren
)paren
op_logical_and
(paren
id|i
OL
id|blocks
)paren
op_logical_and
op_logical_neg
id|retval
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|buff
(braket
id|i
)braket
comma
op_amp
id|jsd
(braket
id|minor
)braket
dot
id|buff
(braket
id|t
)braket
comma
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
(paren
id|__u32
)paren
(paren
(paren
id|jsd
(braket
id|minor
)braket
dot
id|buff
(braket
id|t
)braket
dot
id|time
op_minus
id|curl-&gt;time
)paren
op_star
(paren
l_int|1000
op_div
id|HZ
)paren
)paren
comma
op_amp
id|buff
(braket
id|i
)braket
dot
id|time
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|curl-&gt;tail
op_assign
id|t
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/*&n; * Handle version 0.x compatibility.&n; */
(brace
r_struct
id|JS_DATA_TYPE
op_star
id|bufo
op_assign
(paren
r_void
op_star
)paren
id|buf
suffix:semicolon
r_int
id|buttons
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_complement
id|jsd
(braket
id|minor
)braket
dot
id|exist
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|i
op_increment
suffix:semicolon
id|copy_to_user
c_func
(paren
op_amp
id|bufo-&gt;x
comma
op_amp
id|js_axis
(braket
id|i
)braket
dot
id|value
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
r_while
c_loop
(paren
op_complement
id|jsd
(braket
id|minor
)braket
dot
id|exist
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|i
op_increment
suffix:semicolon
id|copy_to_user
c_func
(paren
op_amp
id|bufo-&gt;y
comma
op_amp
id|js_axis
(braket
id|i
)braket
dot
id|value
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|4
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|j
)paren
op_amp
id|jsd
(braket
id|minor
)braket
dot
id|exist
)paren
id|buttons
op_or_assign
(paren
op_logical_neg
op_logical_neg
(paren
id|js_last_buttons
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
)paren
op_lshift
(paren
id|i
op_increment
)paren
suffix:semicolon
id|copy_to_user
c_func
(paren
op_amp
id|bufo-&gt;buttons
comma
op_amp
id|buttons
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|curl-&gt;startup
op_assign
l_int|0
suffix:semicolon
id|curl-&gt;tail
op_assign
id|GOB
c_func
(paren
id|jsd
(braket
id|minor
)braket
dot
id|ahead
)paren
suffix:semicolon
id|retval
op_assign
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Check main tail and move it.&n; */
r_if
c_cond
(paren
id|u
op_eq
id|jsd
(braket
id|minor
)braket
dot
id|tail
)paren
(brace
id|t
op_assign
id|curl-&gt;tail
suffix:semicolon
id|curl
op_assign
id|jsd
(braket
id|minor
)braket
dot
id|list
suffix:semicolon
r_while
c_loop
(paren
id|curl
op_logical_and
id|curl-&gt;tail
op_ne
id|jsd
(braket
id|minor
)braket
dot
id|tail
)paren
(brace
r_if
c_cond
(paren
id|ROT
c_func
(paren
id|jsd
(braket
id|minor
)braket
dot
id|ahead
comma
id|t
comma
id|curl-&gt;tail
)paren
op_logical_or
(paren
id|jsd
(braket
id|minor
)braket
dot
id|ahead
op_eq
id|curl-&gt;tail
)paren
)paren
id|t
op_assign
id|curl-&gt;tail
suffix:semicolon
id|curl
op_assign
id|curl-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|curl
)paren
id|jsd
(braket
id|minor
)braket
dot
id|tail
op_assign
id|t
suffix:semicolon
)brace
r_return
id|retval
ques
c_cond
id|retval
suffix:colon
id|i
op_star
r_sizeof
(paren
r_struct
id|js_event
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * js_poll() does select() support.&n; */
DECL|function|js_poll
r_static
r_int
r_int
id|js_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|js_list
op_star
id|curl
suffix:semicolon
r_int
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
id|curl
op_assign
id|file-&gt;private_data
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|jsd
(braket
id|minor
)braket
dot
id|wait
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GOF
c_func
(paren
id|curl-&gt;tail
)paren
op_ne
id|jsd
(braket
id|minor
)braket
dot
id|ahead
)paren
r_return
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * js_ioctl handles misc ioctl calls.&n; */
DECL|function|js_ioctl
r_static
r_int
id|js_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ne
id|JOYSTICK_MAJOR
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|minor
OG
id|JS_NUM
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|jsd
(braket
id|minor
)braket
dot
id|exist
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|JSIOCGVERSION
suffix:colon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|JS_VERSION
comma
(paren
id|__u32
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|JSIOCGAXES
suffix:colon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|count_bits
c_func
(paren
id|jsd
(braket
id|minor
)braket
dot
id|exist
op_amp
id|JS_AXES
)paren
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|JSIOCGBUTTONS
suffix:colon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|count_bits
c_func
(paren
id|jsd
(braket
id|minor
)braket
dot
id|exist
op_amp
id|JS_BUTTONS
)paren
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|JSIOCSCORR
suffix:colon
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_amp
id|jsd
(braket
id|minor
)braket
dot
id|exist
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|js_axis
(braket
id|i
)braket
dot
id|corr
comma
(paren
r_void
op_star
)paren
id|arg
op_plus
id|j
op_star
r_sizeof
(paren
r_struct
id|js_corr
)paren
comma
r_sizeof
(paren
r_struct
id|js_corr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
id|js_bh_time
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JSIOCGCORR
suffix:colon
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_amp
id|jsd
(braket
id|minor
)braket
dot
id|exist
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
op_plus
id|j
op_star
r_sizeof
(paren
r_struct
id|js_corr
)paren
comma
op_amp
id|js_axis
(braket
id|i
)braket
dot
id|corr
comma
r_sizeof
(paren
r_struct
id|js_corr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|j
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * js_open() performs necessary initialization and adds&n; * an entry to the linked list.&n; */
DECL|function|js_open
r_static
r_int
id|js_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|js_list
op_star
id|curl
suffix:semicolon
r_int
id|t
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ne
id|JOYSTICK_MAJOR
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|minor
OG
id|JS_NUM
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|jsd
(braket
id|minor
)braket
dot
id|exist
)paren
(brace
id|js_probe
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jsd
(braket
id|minor
)braket
dot
id|exist
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;js%d: %d-axis %d-button joystick at %#x&bslash;n&quot;
comma
id|minor
comma
id|count_bits
c_func
(paren
id|jsd
(braket
id|minor
)braket
dot
id|exist
op_amp
id|JS_AXES
)paren
comma
id|count_bits
c_func
(paren
id|jsd
(braket
id|minor
)braket
dot
id|exist
op_amp
id|JS_BUTTONS
)paren
comma
id|JS_PORT
)paren
suffix:semicolon
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|jsd
(braket
l_int|0
)braket
dot
id|list
op_logical_and
op_logical_neg
id|jsd
(braket
l_int|1
)braket
dot
id|list
)paren
(brace
id|js_timer.expires
op_assign
id|jiffies
op_plus
id|JS_TIMER_PERIOD
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|js_timer
)paren
suffix:semicolon
)brace
id|curl
op_assign
id|jsd
(braket
id|minor
)braket
dot
id|list
suffix:semicolon
id|jsd
(braket
id|minor
)braket
dot
id|list
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|js_list
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|jsd
(braket
id|minor
)braket
dot
id|list-&gt;next
op_assign
id|curl
suffix:semicolon
id|jsd
(braket
id|minor
)braket
dot
id|list-&gt;startup
op_assign
id|jsd
(braket
id|minor
)braket
dot
id|exist
suffix:semicolon
id|jsd
(braket
id|minor
)braket
dot
id|list-&gt;tail
op_assign
id|t
op_assign
id|GOB
c_func
(paren
id|jsd
(braket
id|minor
)braket
dot
id|ahead
)paren
suffix:semicolon
id|jsd
(braket
id|minor
)braket
dot
id|list-&gt;time
op_assign
id|jiffies
suffix:semicolon
id|file-&gt;private_data
op_assign
id|jsd
(braket
id|minor
)braket
dot
id|list
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * js_release() removes an entry from list and deallocates memory&n; * used by it.&n; */
DECL|function|js_release
r_static
r_int
id|js_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|js_list
op_star
op_star
id|curp
comma
op_star
id|curl
suffix:semicolon
r_int
id|t
suffix:semicolon
id|curp
op_assign
op_amp
id|jsd
(braket
id|minor
)braket
dot
id|list
suffix:semicolon
id|curl
op_assign
id|file-&gt;private_data
suffix:semicolon
r_while
c_loop
(paren
op_star
id|curp
op_logical_and
(paren
op_star
id|curp
op_ne
id|curl
)paren
)paren
id|curp
op_assign
op_amp
(paren
(paren
op_star
id|curp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|curp
op_assign
(paren
op_star
id|curp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_if
c_cond
(paren
id|jsd
(braket
id|minor
)braket
dot
id|list
)paren
(brace
r_if
c_cond
(paren
id|curl-&gt;tail
op_eq
id|jsd
(braket
id|minor
)braket
dot
id|tail
)paren
(brace
id|curl
op_assign
id|jsd
(braket
id|minor
)braket
dot
id|list
suffix:semicolon
id|t
op_assign
id|curl-&gt;tail
suffix:semicolon
r_while
c_loop
(paren
id|curl
op_logical_and
id|curl-&gt;tail
op_ne
id|jsd
(braket
id|minor
)braket
dot
id|tail
)paren
(brace
r_if
c_cond
(paren
id|ROT
c_func
(paren
id|jsd
(braket
id|minor
)braket
dot
id|ahead
comma
id|t
comma
id|curl-&gt;tail
)paren
op_logical_or
(paren
id|jsd
(braket
id|minor
)braket
dot
id|ahead
op_eq
id|curl-&gt;tail
)paren
)paren
id|t
op_assign
id|curl-&gt;tail
suffix:semicolon
id|curl
op_assign
id|curl-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|curl
)paren
id|jsd
(braket
id|minor
)braket
dot
id|tail
op_assign
id|t
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|file-&gt;private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|jsd
(braket
l_int|0
)braket
dot
id|list
op_logical_and
op_logical_neg
id|jsd
(braket
l_int|1
)braket
dot
id|list
)paren
id|del_timer
c_func
(paren
op_amp
id|js_timer
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The operations structure.&n; */
DECL|variable|js_fops
r_static
r_struct
id|file_operations
id|js_fops
op_assign
(brace
id|js_lseek
comma
multiline_comment|/* js_lseek */
id|js_read
comma
multiline_comment|/* js_read */
l_int|NULL
comma
multiline_comment|/* js_write */
l_int|NULL
comma
multiline_comment|/* js_readdir */
id|js_poll
comma
multiline_comment|/* js_poll */
id|js_ioctl
comma
multiline_comment|/* js_ioctl */
l_int|NULL
comma
multiline_comment|/* js_mmap */
id|js_open
comma
multiline_comment|/* js_open */
l_int|NULL
comma
multiline_comment|/* js_flush */
id|js_release
comma
multiline_comment|/* js_release */
l_int|NULL
multiline_comment|/* js_sync */
)brace
suffix:semicolon
multiline_comment|/*&n; * js_setup() parses kernel command line parametres.&n; */
macro_line|#ifndef MODULE
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|js_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
(brace
id|js
(braket
l_int|0
)braket
op_assign
(paren
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
ques
c_cond
id|ints
(braket
l_int|1
)braket
suffix:colon
l_int|0
)paren
suffix:semicolon
id|js
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|1
)paren
ques
c_cond
id|ints
(braket
l_int|2
)braket
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * js_init() registres the driver and calls the probe function.&n; * also initializes some crucial variables.&n; */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
id|__initfunc
c_func
(paren
r_int
id|js_init
c_func
(paren
r_void
)paren
)paren
macro_line|#endif
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|JS_PORT
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;js: port %#x already in use&bslash;n&quot;
comma
id|JS_PORT
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|js_probe
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;js: no joysticks found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|JOYSTICK_MAJOR
comma
l_string|&quot;js&quot;
comma
op_amp
id|js_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;js: unable to get major %d for joystick&bslash;n&quot;
comma
id|JOYSTICK_MAJOR
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|JS_NUM
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|jsd
(braket
id|i
)braket
dot
id|exist
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;js%d: %d-axis %d-button joystick at %#x&bslash;n&quot;
comma
id|i
comma
id|count_bits
c_func
(paren
id|jsd
(braket
id|i
)braket
dot
id|exist
op_amp
id|JS_AXES
)paren
comma
id|count_bits
c_func
(paren
id|jsd
(braket
id|i
)braket
dot
id|exist
op_amp
id|JS_BUTTONS
)paren
comma
id|JS_PORT
)paren
suffix:semicolon
id|jsd
(braket
id|i
)braket
dot
id|ahead
op_assign
id|jsd
(braket
id|i
)braket
dot
id|bhead
op_assign
l_int|0
suffix:semicolon
id|jsd
(braket
id|i
)braket
dot
id|tail
op_assign
id|JS_BUFF_SIZE
op_minus
l_int|1
suffix:semicolon
id|jsd
(braket
id|i
)braket
dot
id|list
op_assign
l_int|NULL
suffix:semicolon
id|jsd
(braket
id|i
)braket
dot
id|wait
op_assign
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|jsd
(braket
id|i
)braket
dot
id|buff
comma
l_int|0
comma
id|JS_BUFF_SIZE
op_star
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|js_axis
(braket
id|i
)braket
dot
id|corr.type
op_assign
id|JS_CORR_NONE
suffix:semicolon
id|js_axis
(braket
id|i
)braket
dot
id|corr.prec
op_assign
id|JS_DEF_PREC
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|JS_PORT
comma
l_int|1
comma
l_string|&quot;js&quot;
)paren
suffix:semicolon
id|init_bh
c_func
(paren
id|JS_BH
comma
op_amp
id|js_do_bh
)paren
suffix:semicolon
id|enable_bh
c_func
(paren
id|JS_BH
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|js_timer
)paren
suffix:semicolon
id|js_timer.function
op_assign
id|js_do_timer
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * cleanup_module() handles module removal.&n; */
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|MOD_IN_USE
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;js: device busy, remove delayed&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|del_timer
c_func
(paren
op_amp
id|js_timer
)paren
suffix:semicolon
id|disable_bh
c_func
(paren
id|JS_BH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unregister_chrdev
c_func
(paren
id|JOYSTICK_MAJOR
comma
l_string|&quot;js&quot;
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;js: module cleanup failed&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|JS_PORT
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
