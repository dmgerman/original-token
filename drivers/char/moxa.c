multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *           moxa.c  -- MOXA Intellio family multiport serial driver.&n; *&n; *      Copyright (C) 1999-2000  Moxa Technologies (support@moxa.com.tw).&n; *&n; *      This code is loosely based on the Linux serial driver, written by&n; *      Linus Torvalds, Theodore T&squot;so and others.&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *      This program is distributed in the hope that it will be useful,&n; *      but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *      GNU General Public License for more details.&n; *&n; *      You should have received a copy of the GNU General Public License&n; *      along with this program; if not, write to the Free Software&n; *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/*&n; *    MOXA Intellio Series Driver&n; *      for             : LINUX&n; *      date            : 1999/1/7&n; *      version         : 5.1&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|MOXA_VERSION
mdefine_line|#define&t;&t;MOXA_VERSION&t;&t;&quot;5.1k&quot;
DECL|macro|MOXAMAJOR
mdefine_line|#define MOXAMAJOR       172
DECL|macro|MOXACUMAJOR
mdefine_line|#define MOXACUMAJOR     173
DECL|macro|put_to_user
mdefine_line|#define put_to_user(arg1, arg2) put_user(arg1, (unsigned long *)arg2)
DECL|macro|get_from_user
mdefine_line|#define get_from_user(arg1, arg2) get_user(arg1, (unsigned int *)arg2)
DECL|macro|MAX_BOARDS
mdefine_line|#define MAX_BOARDS &t;&t;4&t;/* Don&squot;t change this value */
DECL|macro|MAX_PORTS_PER_BOARD
mdefine_line|#define MAX_PORTS_PER_BOARD&t;32&t;/* Don&squot;t change this value */
DECL|macro|MAX_PORTS
mdefine_line|#define MAX_PORTS &t;&t;128&t;/* Don&squot;t change this value */
multiline_comment|/*&n; *    Define the Moxa PCI vendor and device IDs.&n; */
DECL|macro|MOXA_BUS_TYPE_ISA
mdefine_line|#define MOXA_BUS_TYPE_ISA&t;&t;0
DECL|macro|MOXA_BUS_TYPE_PCI
mdefine_line|#define MOXA_BUS_TYPE_PCI&t;&t;1
macro_line|#ifndef&t;PCI_VENDOR_ID_MOXA
DECL|macro|PCI_VENDOR_ID_MOXA
mdefine_line|#define&t;PCI_VENDOR_ID_MOXA&t;0x1393
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_CP204J
DECL|macro|PCI_DEVICE_ID_CP204J
mdefine_line|#define PCI_DEVICE_ID_CP204J&t;0x2040
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_C218
DECL|macro|PCI_DEVICE_ID_C218
mdefine_line|#define PCI_DEVICE_ID_C218&t;0x2180
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_C320
DECL|macro|PCI_DEVICE_ID_C320
mdefine_line|#define PCI_DEVICE_ID_C320&t;0x3200
macro_line|#endif
r_enum
(brace
DECL|enumerator|MOXA_BOARD_C218_PCI
id|MOXA_BOARD_C218_PCI
op_assign
l_int|1
comma
DECL|enumerator|MOXA_BOARD_C218_ISA
id|MOXA_BOARD_C218_ISA
comma
DECL|enumerator|MOXA_BOARD_C320_PCI
id|MOXA_BOARD_C320_PCI
comma
DECL|enumerator|MOXA_BOARD_C320_ISA
id|MOXA_BOARD_C320_ISA
comma
DECL|enumerator|MOXA_BOARD_CP204J
id|MOXA_BOARD_CP204J
comma
)brace
suffix:semicolon
DECL|variable|moxa_brdname
r_static
r_char
op_star
id|moxa_brdname
(braket
)braket
op_assign
(brace
l_string|&quot;C218 Turbo PCI series&quot;
comma
l_string|&quot;C218 Turbo ISA series&quot;
comma
l_string|&quot;C320 Turbo PCI series&quot;
comma
l_string|&quot;C320 Turbo ISA series&quot;
comma
l_string|&quot;CP-204J series&quot;
comma
)brace
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|vendor_id
r_int
r_int
id|vendor_id
suffix:semicolon
DECL|member|device_id
r_int
r_int
id|device_id
suffix:semicolon
DECL|member|board_type
r_int
r_int
id|board_type
suffix:semicolon
DECL|typedef|moxa_pciinfo
)brace
id|moxa_pciinfo
suffix:semicolon
DECL|variable|moxa_pcibrds
r_static
id|moxa_pciinfo
id|moxa_pcibrds
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_MOXA
comma
id|PCI_DEVICE_ID_C218
comma
id|MOXA_BOARD_C218_PCI
)brace
comma
(brace
id|PCI_VENDOR_ID_MOXA
comma
id|PCI_DEVICE_ID_C320
comma
id|MOXA_BOARD_C320_PCI
)brace
comma
(brace
id|PCI_VENDOR_ID_MOXA
comma
id|PCI_DEVICE_ID_CP204J
comma
id|MOXA_BOARD_CP204J
)brace
comma
)brace
suffix:semicolon
DECL|struct|_moxa_isa_board_conf
r_typedef
r_struct
id|_moxa_isa_board_conf
(brace
DECL|member|boardType
r_int
id|boardType
suffix:semicolon
DECL|member|numPorts
r_int
id|numPorts
suffix:semicolon
DECL|member|baseAddr
r_int
r_int
id|baseAddr
suffix:semicolon
DECL|typedef|moxa_isa_board_conf
)brace
id|moxa_isa_board_conf
suffix:semicolon
DECL|variable|moxa_isa_boards
r_static
id|moxa_isa_board_conf
id|moxa_isa_boards
(braket
)braket
op_assign
(brace
multiline_comment|/*       {MOXA_BOARD_C218_ISA,8,0xDC000}, */
)brace
suffix:semicolon
DECL|struct|_moxa_pci_devinfo
r_typedef
r_struct
id|_moxa_pci_devinfo
(brace
DECL|member|busNum
id|ushort
id|busNum
suffix:semicolon
DECL|member|devNum
id|ushort
id|devNum
suffix:semicolon
DECL|typedef|moxa_pci_devinfo
)brace
id|moxa_pci_devinfo
suffix:semicolon
DECL|struct|_moxa_board_conf
r_typedef
r_struct
id|_moxa_board_conf
(brace
DECL|member|boardType
r_int
id|boardType
suffix:semicolon
DECL|member|numPorts
r_int
id|numPorts
suffix:semicolon
DECL|member|baseAddr
r_int
r_int
id|baseAddr
suffix:semicolon
DECL|member|busType
r_int
id|busType
suffix:semicolon
DECL|member|pciInfo
id|moxa_pci_devinfo
id|pciInfo
suffix:semicolon
DECL|typedef|moxa_board_conf
)brace
id|moxa_board_conf
suffix:semicolon
DECL|variable|moxa_boards
r_static
id|moxa_board_conf
id|moxa_boards
(braket
id|MAX_BOARDS
)braket
suffix:semicolon
DECL|variable|moxaBaseAddr
r_static
r_int
r_int
id|moxaBaseAddr
(braket
id|MAX_BOARDS
)braket
suffix:semicolon
DECL|struct|moxa_str
r_struct
id|moxa_str
(brace
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|member|port
r_int
id|port
suffix:semicolon
DECL|member|close_delay
r_int
id|close_delay
suffix:semicolon
DECL|member|closing_wait
r_int
r_int
id|closing_wait
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|blocked_open
r_int
id|blocked_open
suffix:semicolon
DECL|member|event
r_int
id|event
suffix:semicolon
multiline_comment|/* long req&squot;d for set_bit --RR */
DECL|member|asyncflags
r_int
id|asyncflags
suffix:semicolon
DECL|member|session
r_int
id|session
suffix:semicolon
DECL|member|pgrp
r_int
id|pgrp
suffix:semicolon
DECL|member|statusflags
r_int
r_int
id|statusflags
suffix:semicolon
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
DECL|member|normal_termios
r_struct
id|termios
id|normal_termios
suffix:semicolon
DECL|member|callout_termios
r_struct
id|termios
id|callout_termios
suffix:semicolon
DECL|member|open_wait
id|wait_queue_head_t
id|open_wait
suffix:semicolon
DECL|member|close_wait
id|wait_queue_head_t
id|close_wait
suffix:semicolon
DECL|member|tqueue
r_struct
id|tq_struct
id|tqueue
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|mxser_mstatus
r_struct
id|mxser_mstatus
(brace
DECL|member|cflag
id|tcflag_t
id|cflag
suffix:semicolon
DECL|member|cts
r_int
id|cts
suffix:semicolon
DECL|member|dsr
r_int
id|dsr
suffix:semicolon
DECL|member|ri
r_int
id|ri
suffix:semicolon
DECL|member|dcd
r_int
id|dcd
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|GMStatus
r_static
r_struct
id|mxser_mstatus
id|GMStatus
(braket
id|MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* statusflags */
DECL|macro|TXSTOPPED
mdefine_line|#define TXSTOPPED&t;0x1
DECL|macro|LOWWAIT
mdefine_line|#define LOWWAIT &t;0x2
DECL|macro|EMPTYWAIT
mdefine_line|#define EMPTYWAIT&t;0x4
DECL|macro|THROTTLE
mdefine_line|#define THROTTLE&t;0x8
multiline_comment|/* event */
DECL|macro|MOXA_EVENT_HANGUP
mdefine_line|#define MOXA_EVENT_HANGUP&t;1
DECL|macro|SERIAL_DO_RESTART
mdefine_line|#define SERIAL_DO_RESTART
DECL|macro|SERIAL_TYPE_NORMAL
mdefine_line|#define SERIAL_TYPE_NORMAL&t;1
DECL|macro|SERIAL_TYPE_CALLOUT
mdefine_line|#define SERIAL_TYPE_CALLOUT&t;2
DECL|macro|WAKEUP_CHARS
mdefine_line|#define WAKEUP_CHARS&t;&t;256
DECL|macro|PORTNO
mdefine_line|#define PORTNO(x)&t;&t;(MINOR((x)-&gt;device) - (x)-&gt;driver.minor_start)
DECL|variable|verbose
r_static
r_int
id|verbose
op_assign
l_int|0
suffix:semicolon
DECL|variable|ttymajor
r_static
r_int
id|ttymajor
op_assign
id|MOXAMAJOR
suffix:semicolon
DECL|variable|calloutmajor
r_static
r_int
id|calloutmajor
op_assign
id|MOXACUMAJOR
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* Variables for insmod */
DECL|variable|baseaddr
r_static
r_int
id|baseaddr
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|type
r_static
r_int
id|type
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|numports
r_static
r_int
id|numports
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;William Chen&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;MOXA Intellio Family Multiport Board Device Driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|type
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|baseaddr
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|numports
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ttymajor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|calloutmajor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|verbose
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;
singleline_comment|//MODULE
DECL|variable|moxaDriver
r_static
r_struct
id|tty_driver
id|moxaDriver
suffix:semicolon
DECL|variable|moxaCallout
r_static
r_struct
id|tty_driver
id|moxaCallout
suffix:semicolon
DECL|variable|moxaTable
r_static
r_struct
id|tty_struct
op_star
id|moxaTable
(braket
id|MAX_PORTS
op_plus
l_int|1
)braket
suffix:semicolon
DECL|variable|moxaTermios
r_static
r_struct
id|termios
op_star
id|moxaTermios
(braket
id|MAX_PORTS
op_plus
l_int|1
)braket
suffix:semicolon
DECL|variable|moxaTermiosLocked
r_static
r_struct
id|termios
op_star
id|moxaTermiosLocked
(braket
id|MAX_PORTS
op_plus
l_int|1
)braket
suffix:semicolon
DECL|variable|moxaChannels
r_static
r_struct
id|moxa_str
id|moxaChannels
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|moxaRefcount
r_static
r_int
id|moxaRefcount
suffix:semicolon
DECL|variable|moxaXmitBuff
r_static
r_int
r_char
op_star
id|moxaXmitBuff
suffix:semicolon
DECL|variable|moxaTimer_on
r_static
r_int
id|moxaTimer_on
suffix:semicolon
DECL|variable|moxaTimer
r_static
r_struct
id|timer_list
id|moxaTimer
suffix:semicolon
DECL|variable|moxaEmptyTimer_on
r_static
r_int
id|moxaEmptyTimer_on
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|moxaEmptyTimer
r_static
r_struct
id|timer_list
id|moxaEmptyTimer
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|moxaBuffSem
r_static
r_struct
id|semaphore
id|moxaBuffSem
suffix:semicolon
r_int
id|moxa_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_int
id|init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * static functions:&n; */
r_static
r_int
id|moxa_get_PCI_conf
c_func
(paren
r_struct
id|pci_dev
op_star
comma
r_int
comma
id|moxa_board_conf
op_star
)paren
suffix:semicolon
r_static
r_void
id|do_moxa_softint
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_int
id|moxa_open
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_close
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|moxa_write
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_int
comma
r_const
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|moxa_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|moxa_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_int
r_char
)paren
suffix:semicolon
r_static
r_int
id|moxa_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|moxa_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|termios
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_stop
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_start
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|moxa_poll
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|set_tty_param
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|block_till_ready
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
comma
r_struct
id|moxa_str
op_star
)paren
suffix:semicolon
r_static
r_void
id|setup_empty_event
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|check_xmit_empty
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|shut_down
c_func
(paren
r_struct
id|moxa_str
op_star
)paren
suffix:semicolon
r_static
r_void
id|receive_data
c_func
(paren
r_struct
id|moxa_str
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * moxa board interface functions:&n; */
r_static
r_void
id|MoxaDriverInit
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|MoxaDriverIoctl
c_func
(paren
r_int
r_int
comma
r_int
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaDriverPoll
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortsOfCard
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortIsValid
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|MoxaPortEnable
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|MoxaPortDisable
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortGetMaxBaud
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortSetBaud
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortSetTermio
c_func
(paren
r_int
comma
r_struct
id|termios
op_star
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortGetLineOut
c_func
(paren
r_int
comma
r_int
op_star
comma
r_int
op_star
)paren
suffix:semicolon
r_static
r_void
id|MoxaPortLineCtrl
c_func
(paren
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|MoxaPortFlowCtrl
c_func
(paren
r_int
comma
r_int
comma
r_int
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortLineStatus
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortDCDChange
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortDCDON
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|MoxaPortFlushData
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortWriteData
c_func
(paren
r_int
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortReadData
c_func
(paren
r_int
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortTxQueue
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortRxQueue
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortTxFree
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|MoxaPortTxDisable
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|MoxaPortTxEnable
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|MoxaPortResetBrkCnt
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|MoxaPortSendBreak
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|moxa_get_serial_info
c_func
(paren
r_struct
id|moxa_str
op_star
comma
r_struct
id|serial_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|moxa_set_serial_info
c_func
(paren
r_struct
id|moxa_str
op_star
comma
r_struct
id|serial_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|MoxaSetFifo
c_func
(paren
r_int
id|port
comma
r_int
id|enable
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
l_string|&quot;Loading module moxa ...&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|moxa_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
l_string|&quot;Done&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
l_string|&quot;Unloading module moxa ...&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|moxaTimer_on
)paren
id|del_timer
c_func
(paren
op_amp
id|moxaTimer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|moxaEmptyTimer_on
(braket
id|i
)braket
)paren
id|del_timer
c_func
(paren
op_amp
id|moxaEmptyTimer
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_unregister_driver
c_func
(paren
op_amp
id|moxaCallout
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t unregister MOXA Intellio family callout driver&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_unregister_driver
c_func
(paren
op_amp
id|moxaDriver
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;Couldn&squot;t unregister MOXA Intellio family serial driver&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
l_string|&quot;Done&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|moxa_init
r_int
id|moxa_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|n
comma
id|numBoards
suffix:semicolon
r_struct
id|moxa_str
op_star
id|ch
suffix:semicolon
r_int
id|ret1
comma
id|ret2
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MOXA Intellio family driver version %s&bslash;n&quot;
comma
id|MOXA_VERSION
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|moxaBuffSem
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|moxaDriver
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|moxaCallout
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|moxaDriver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|moxaDriver.name
op_assign
l_string|&quot;ttya&quot;
suffix:semicolon
id|moxaDriver.major
op_assign
id|ttymajor
suffix:semicolon
id|moxaDriver.minor_start
op_assign
l_int|0
suffix:semicolon
id|moxaDriver.num
op_assign
id|MAX_PORTS
op_plus
l_int|1
suffix:semicolon
id|moxaDriver.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|moxaDriver.subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|moxaDriver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|moxaDriver.init_termios.c_iflag
op_assign
l_int|0
suffix:semicolon
id|moxaDriver.init_termios.c_oflag
op_assign
l_int|0
suffix:semicolon
id|moxaDriver.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|CLOCAL
op_or
id|HUPCL
suffix:semicolon
id|moxaDriver.init_termios.c_lflag
op_assign
l_int|0
suffix:semicolon
id|moxaDriver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|moxaDriver.refcount
op_assign
op_amp
id|moxaRefcount
suffix:semicolon
id|moxaDriver.table
op_assign
id|moxaTable
suffix:semicolon
id|moxaDriver.termios
op_assign
id|moxaTermios
suffix:semicolon
id|moxaDriver.termios_locked
op_assign
id|moxaTermiosLocked
suffix:semicolon
id|moxaDriver.open
op_assign
id|moxa_open
suffix:semicolon
id|moxaDriver.close
op_assign
id|moxa_close
suffix:semicolon
id|moxaDriver.write
op_assign
id|moxa_write
suffix:semicolon
id|moxaDriver.write_room
op_assign
id|moxa_write_room
suffix:semicolon
id|moxaDriver.flush_buffer
op_assign
id|moxa_flush_buffer
suffix:semicolon
id|moxaDriver.chars_in_buffer
op_assign
id|moxa_chars_in_buffer
suffix:semicolon
id|moxaDriver.flush_chars
op_assign
id|moxa_flush_chars
suffix:semicolon
id|moxaDriver.put_char
op_assign
id|moxa_put_char
suffix:semicolon
id|moxaDriver.ioctl
op_assign
id|moxa_ioctl
suffix:semicolon
id|moxaDriver.throttle
op_assign
id|moxa_throttle
suffix:semicolon
id|moxaDriver.unthrottle
op_assign
id|moxa_unthrottle
suffix:semicolon
id|moxaDriver.set_termios
op_assign
id|moxa_set_termios
suffix:semicolon
id|moxaDriver.stop
op_assign
id|moxa_stop
suffix:semicolon
id|moxaDriver.start
op_assign
id|moxa_start
suffix:semicolon
id|moxaDriver.hangup
op_assign
id|moxa_hangup
suffix:semicolon
id|moxaCallout
op_assign
id|moxaDriver
suffix:semicolon
id|moxaCallout.name
op_assign
l_string|&quot;ttyA&quot;
suffix:semicolon
id|moxaCallout.major
op_assign
id|calloutmajor
suffix:semicolon
id|moxaCallout.subtype
op_assign
id|SERIAL_TYPE_CALLOUT
suffix:semicolon
id|moxaXmitBuff
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|ch
op_assign
id|moxaChannels
suffix:semicolon
id|i
OL
id|MAX_PORTS
suffix:semicolon
id|i
op_increment
comma
id|ch
op_increment
)paren
(brace
id|ch-&gt;type
op_assign
id|PORT_16550A
suffix:semicolon
id|ch-&gt;port
op_assign
id|i
suffix:semicolon
id|ch-&gt;tqueue.routine
op_assign
id|do_moxa_softint
suffix:semicolon
id|ch-&gt;tqueue.data
op_assign
id|ch
suffix:semicolon
id|ch-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;close_delay
op_assign
l_int|5
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
id|ch-&gt;closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
id|ch-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;blocked_open
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;callout_termios
op_assign
id|moxaCallout.init_termios
suffix:semicolon
id|ch-&gt;normal_termios
op_assign
id|moxaDriver.init_termios
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ch-&gt;open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ch-&gt;close_wait
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_BOARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|moxa_boards
(braket
id|i
)braket
dot
id|boardType
op_assign
l_int|0
suffix:semicolon
id|moxa_boards
(braket
id|i
)braket
dot
id|numPorts
op_assign
l_int|0
suffix:semicolon
id|moxa_boards
(braket
id|i
)braket
dot
id|baseAddr
op_assign
l_int|0
suffix:semicolon
id|moxa_boards
(braket
id|i
)braket
dot
id|busType
op_assign
l_int|0
suffix:semicolon
id|moxa_boards
(braket
id|i
)braket
dot
id|pciInfo.busNum
op_assign
l_int|0
suffix:semicolon
id|moxa_boards
(braket
id|i
)braket
dot
id|pciInfo.devNum
op_assign
l_int|0
suffix:semicolon
)brace
id|MoxaDriverInit
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Tty devices major number = %d, callout devices major number = %d&bslash;n&quot;
comma
id|ttymajor
comma
id|calloutmajor
)paren
suffix:semicolon
id|ret1
op_assign
l_int|0
suffix:semicolon
id|ret2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret1
op_assign
id|tty_register_driver
c_func
(paren
op_amp
id|moxaDriver
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Couldn&squot;t install MOXA Smartio family driver !&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ret2
op_assign
id|tty_register_driver
c_func
(paren
op_amp
id|moxaCallout
)paren
)paren
)paren
(brace
id|tty_unregister_driver
c_func
(paren
op_amp
id|moxaDriver
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Couldn&squot;t install MOXA Smartio family callout driver !&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret1
op_logical_or
id|ret2
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|moxaEmptyTimer
(braket
id|i
)braket
)paren
suffix:semicolon
id|moxaEmptyTimer
(braket
id|i
)braket
dot
id|function
op_assign
id|check_xmit_empty
suffix:semicolon
id|moxaEmptyTimer
(braket
id|i
)braket
dot
id|data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|moxaChannels
(braket
id|i
)braket
suffix:semicolon
id|moxaEmptyTimer_on
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|moxaTimer
)paren
suffix:semicolon
id|moxaTimer.function
op_assign
id|moxa_poll
suffix:semicolon
id|moxaTimer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|50
)paren
suffix:semicolon
id|moxaTimer_on
op_assign
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|moxaTimer
)paren
suffix:semicolon
multiline_comment|/* Find the boards defined in source code */
id|numBoards
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_BOARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|moxa_isa_boards
(braket
id|i
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C218_ISA
)paren
op_logical_or
(paren
id|moxa_isa_boards
(braket
id|i
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_ISA
)paren
)paren
(brace
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|boardType
op_assign
id|moxa_isa_boards
(braket
id|i
)braket
dot
id|boardType
suffix:semicolon
r_if
c_cond
(paren
id|moxa_isa_boards
(braket
id|i
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C218_ISA
)paren
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|numPorts
op_assign
l_int|8
suffix:semicolon
r_else
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|numPorts
op_assign
id|moxa_isa_boards
(braket
id|i
)braket
dot
id|numPorts
suffix:semicolon
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|busType
op_assign
id|MOXA_BUS_TYPE_ISA
suffix:semicolon
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|baseAddr
op_assign
id|moxa_isa_boards
(braket
id|i
)braket
dot
id|baseAddr
suffix:semicolon
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
l_string|&quot;Board %2d: %s board(baseAddr=%lx)&bslash;n&quot;
comma
id|numBoards
op_plus
l_int|1
comma
id|moxa_brdname
(braket
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|boardType
op_minus
l_int|1
)braket
comma
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|baseAddr
)paren
suffix:semicolon
id|numBoards
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Find the boards defined form module args. */
macro_line|#ifdef MODULE
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_BOARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|type
(braket
id|i
)braket
op_eq
id|MOXA_BOARD_C218_ISA
)paren
op_logical_or
(paren
id|type
(braket
id|i
)braket
op_eq
id|MOXA_BOARD_C320_ISA
)paren
)paren
(brace
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
l_string|&quot;Board %2d: %s board(baseAddr=%lx)&bslash;n&quot;
comma
id|numBoards
op_plus
l_int|1
comma
id|moxa_brdname
(braket
id|type
(braket
id|i
)braket
op_minus
l_int|1
)braket
comma
(paren
r_int
r_int
)paren
id|baseaddr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|numBoards
op_ge
id|MAX_BOARDS
)paren
(brace
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
l_string|&quot;More than %d MOXA Intellio family boards found. Board is ignored.&quot;
comma
id|MAX_BOARDS
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|boardType
op_assign
id|type
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|moxa_isa_boards
(braket
id|i
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C218_ISA
)paren
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|numPorts
op_assign
l_int|8
suffix:semicolon
r_else
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|numPorts
op_assign
id|numports
(braket
id|i
)braket
suffix:semicolon
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|busType
op_assign
id|MOXA_BUS_TYPE_ISA
suffix:semicolon
id|moxa_boards
(braket
id|numBoards
)braket
dot
id|baseAddr
op_assign
id|baseaddr
(braket
id|i
)braket
suffix:semicolon
id|numBoards
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* Find PCI boards here */
macro_line|#ifdef CONFIG_PCI
(brace
r_struct
id|pci_dev
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
id|n
op_assign
r_sizeof
(paren
id|moxa_pcibrds
)paren
op_div
r_sizeof
(paren
id|moxa_pciinfo
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|n
)paren
(brace
r_while
c_loop
(paren
(paren
id|p
op_assign
id|pci_find_device
c_func
(paren
id|moxa_pcibrds
(braket
id|i
)braket
dot
id|vendor_id
comma
id|moxa_pcibrds
(braket
id|i
)braket
dot
id|device_id
comma
id|p
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|p
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|numBoards
op_ge
id|MAX_BOARDS
)paren
(brace
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
l_string|&quot;More than %d MOXA Intellio family boards found. Board is ignored.&quot;
comma
id|MAX_BOARDS
)paren
suffix:semicolon
)brace
r_else
(brace
id|moxa_get_PCI_conf
c_func
(paren
id|p
comma
id|moxa_pcibrds
(braket
id|i
)braket
dot
id|board_type
comma
op_amp
id|moxa_boards
(braket
id|numBoards
)braket
)paren
suffix:semicolon
id|numBoards
op_increment
suffix:semicolon
)brace
)brace
id|i
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|numBoards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|moxaBaseAddr
(braket
id|i
)braket
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
(paren
r_int
r_int
)paren
id|moxa_boards
(braket
id|i
)braket
dot
id|baseAddr
comma
l_int|0x4000
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|moxa_get_PCI_conf
r_static
r_int
id|moxa_get_PCI_conf
c_func
(paren
r_struct
id|pci_dev
op_star
id|p
comma
r_int
id|board_type
comma
id|moxa_board_conf
op_star
id|board
)paren
(brace
id|board-&gt;baseAddr
op_assign
id|pci_resource_start
(paren
id|p
comma
l_int|2
)paren
suffix:semicolon
id|board-&gt;boardType
op_assign
id|board_type
suffix:semicolon
r_switch
c_cond
(paren
id|board_type
)paren
(brace
r_case
id|MOXA_BOARD_C218_ISA
suffix:colon
r_case
id|MOXA_BOARD_C218_PCI
suffix:colon
id|board-&gt;numPorts
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MOXA_BOARD_CP204J
suffix:colon
id|board-&gt;numPorts
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|board-&gt;numPorts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|board-&gt;busType
op_assign
id|MOXA_BUS_TYPE_PCI
suffix:semicolon
id|board-&gt;pciInfo.busNum
op_assign
id|p-&gt;bus-&gt;number
suffix:semicolon
id|board-&gt;pciInfo.devNum
op_assign
id|p-&gt;devfn
op_rshift
l_int|3
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|do_moxa_softint
r_static
r_void
id|do_moxa_softint
c_func
(paren
r_void
op_star
id|private_
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|private_
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_logical_and
(paren
id|tty
op_assign
id|ch-&gt;tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|MOXA_EVENT_HANGUP
comma
op_amp
id|ch-&gt;event
)paren
)paren
(brace
id|tty_hangup
c_func
(paren
id|tty
)paren
suffix:semicolon
multiline_comment|/* FIXME: module removal race here - AKPM */
id|wake_up_interruptible
c_func
(paren
op_amp
id|ch-&gt;open_wait
)paren
suffix:semicolon
id|ch-&gt;asyncflags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CALLOUT_ACTIVE
)paren
suffix:semicolon
)brace
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|moxa_open
r_static
r_int
id|moxa_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
suffix:semicolon
r_int
id|port
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
r_int
id|page
suffix:semicolon
id|port
op_assign
id|PORTNO
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
id|MAX_PORTS
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MoxaPortIsValid
c_func
(paren
id|port
)paren
)paren
(brace
id|tty-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|moxaBuffSem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|moxaXmitBuff
)paren
(brace
id|page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
(brace
id|up
c_func
(paren
op_amp
id|moxaBuffSem
)paren
suffix:semicolon
r_return
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|moxaXmitBuff
)paren
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_else
id|moxaXmitBuff
op_assign
(paren
r_int
r_char
op_star
)paren
id|page
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|moxaBuffSem
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|ch
op_assign
op_amp
id|moxaChannels
(braket
id|port
)braket
suffix:semicolon
id|ch-&gt;count
op_increment
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|ch
suffix:semicolon
id|ch-&gt;tty
op_assign
id|tty
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;count
op_eq
l_int|1
op_logical_and
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_SPLIT_TERMIOS
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|SERIAL_TYPE_NORMAL
)paren
op_star
id|tty-&gt;termios
op_assign
id|ch-&gt;normal_termios
suffix:semicolon
r_else
op_star
id|tty-&gt;termios
op_assign
id|ch-&gt;callout_termios
suffix:semicolon
)brace
id|ch-&gt;session
op_assign
id|current-&gt;session
suffix:semicolon
id|ch-&gt;pgrp
op_assign
id|current-&gt;pgrp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
(brace
id|ch-&gt;statusflags
op_assign
l_int|0
suffix:semicolon
id|set_tty_param
c_func
(paren
id|tty
)paren
suffix:semicolon
id|MoxaPortLineCtrl
c_func
(paren
id|ch-&gt;port
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
id|MoxaPortEnable
c_func
(paren
id|ch-&gt;port
)paren
suffix:semicolon
id|ch-&gt;asyncflags
op_or_assign
id|ASYNC_INITIALIZED
suffix:semicolon
)brace
id|retval
op_assign
id|block_till_ready
c_func
(paren
id|tty
comma
id|filp
comma
id|ch
)paren
suffix:semicolon
id|moxa_unthrottle
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;type
op_eq
id|PORT_16550A
)paren
(brace
id|MoxaSetFifo
c_func
(paren
id|ch-&gt;port
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|MoxaSetFifo
c_func
(paren
id|ch-&gt;port
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
(paren
id|retval
)paren
suffix:semicolon
)brace
DECL|function|moxa_close
r_static
r_void
id|moxa_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
suffix:semicolon
r_int
id|port
suffix:semicolon
id|port
op_assign
id|PORTNO
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
id|MAX_PORTS
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|MoxaPortIsValid
c_func
(paren
id|port
)paren
)paren
(brace
macro_line|#ifdef SERIAL_DEBUG_CLOSE
id|printk
c_func
(paren
l_string|&quot;Invalid portno in moxa_close&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tty-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;driver_data
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|ch-&gt;count
op_ne
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;moxa_close: bad serial port count; tty-&gt;count is 1, &quot;
l_string|&quot;ch-&gt;count is %d&bslash;n&quot;
comma
id|ch-&gt;count
)paren
suffix:semicolon
id|ch-&gt;count
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|ch-&gt;count
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;moxa_close: bad serial port count, minor=%d&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
)paren
suffix:semicolon
id|ch-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch-&gt;count
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ch-&gt;asyncflags
op_or_assign
id|ASYNC_CLOSING
suffix:semicolon
multiline_comment|/*&n;&t; * Save the termios structure, since this port may have&n;&t; * separate termios for callout and dialin.&n;&t; */
r_if
c_cond
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
id|ch-&gt;normal_termios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
id|ch-&gt;callout_termios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_INITIALIZED
)paren
(brace
id|setup_empty_event
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
l_int|30
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* 30 seconds timeout */
id|moxaEmptyTimer_on
(braket
id|ch-&gt;port
)braket
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|moxaEmptyTimer
(braket
id|ch-&gt;port
)braket
)paren
suffix:semicolon
)brace
id|shut_down
c_func
(paren
id|ch
)paren
suffix:semicolon
id|MoxaPortFlushData
c_func
(paren
id|port
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver.flush_buffer
)paren
id|tty-&gt;driver
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
id|tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;event
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;tty
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;blocked_open
)paren
(brace
r_if
c_cond
(paren
id|ch-&gt;close_delay
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|ch-&gt;close_delay
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|ch-&gt;open_wait
)paren
suffix:semicolon
)brace
id|ch-&gt;asyncflags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CALLOUT_ACTIVE
op_or
id|ASYNC_CLOSING
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|ch-&gt;close_wait
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|moxa_write
r_static
r_int
id|moxa_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
suffix:semicolon
r_int
id|len
comma
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|temp
suffix:semicolon
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|port
op_assign
id|ch-&gt;port
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|copy_from_user
c_func
(paren
id|moxaXmitBuff
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|temp
op_assign
id|moxaXmitBuff
suffix:semicolon
)brace
r_else
id|temp
op_assign
(paren
r_int
r_char
op_star
)paren
id|buf
suffix:semicolon
id|len
op_assign
id|MoxaPortWriteData
c_func
(paren
id|port
comma
id|temp
comma
id|count
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*********************************************&n;&t;if ( !(ch-&gt;statusflags &amp; LOWWAIT) &amp;&amp;&n;&t;     ((len != count) || (MoxaPortTxFree(port) &lt;= 100)) )&n;&t;************************************************/
id|ch-&gt;statusflags
op_or_assign
id|LOWWAIT
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
DECL|function|moxa_write_room
r_static
r_int
id|moxa_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;stopped
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|MoxaPortTxFree
c_func
(paren
id|ch-&gt;port
)paren
)paren
suffix:semicolon
)brace
DECL|function|moxa_flush_buffer
r_static
r_void
id|moxa_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|MoxaPortFlushData
c_func
(paren
id|ch-&gt;port
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
DECL|function|moxa_chars_in_buffer
r_static
r_int
id|moxa_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
id|chars
suffix:semicolon
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
multiline_comment|/*&n;&t; * Sigh...I have to check if driver_data is NULL here, because&n;&t; * if an open() fails, the TTY subsystem eventually calls&n;&t; * tty_wait_until_sent(), which calls the driver&squot;s chars_in_buffer()&n;&t; * routine.  And since the open() failed, we return 0 here.  TDJ&n;&t; */
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|chars
op_assign
id|MoxaPortTxQueue
c_func
(paren
id|ch-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chars
)paren
(brace
multiline_comment|/*&n;&t;&t; * Make it possible to wakeup anything waiting for output&n;&t;&t; * in tty_ioctl.c, etc.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;statusflags
op_amp
id|EMPTYWAIT
)paren
)paren
id|setup_empty_event
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_return
(paren
id|chars
)paren
suffix:semicolon
)brace
DECL|function|moxa_flush_chars
r_static
r_void
id|moxa_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
multiline_comment|/*&n;&t; * Don&squot;t think I need this, because this is called to empty the TX&n;&t; * buffer for the 16450, 16550, etc.&n;&t; */
)brace
DECL|function|moxa_put_char
r_static
r_void
id|moxa_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|c
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
suffix:semicolon
r_int
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|port
op_assign
id|ch-&gt;port
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|moxaXmitBuff
(braket
l_int|0
)braket
op_assign
id|c
suffix:semicolon
id|MoxaPortWriteData
c_func
(paren
id|port
comma
id|moxaXmitBuff
comma
l_int|1
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/************************************************&n;&t;if ( !(ch-&gt;statusflags &amp; LOWWAIT) &amp;&amp; (MoxaPortTxFree(port) &lt;= 100) )&n;&t;*************************************************/
id|ch-&gt;statusflags
op_or_assign
id|LOWWAIT
suffix:semicolon
)brace
DECL|function|moxa_ioctl
r_static
r_int
id|moxa_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_register
r_int
id|port
suffix:semicolon
r_int
id|retval
comma
id|dtr
comma
id|rts
suffix:semicolon
r_int
r_int
id|flag
suffix:semicolon
id|port
op_assign
id|PORTNO
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|port
op_ne
id|MAX_PORTS
)paren
op_logical_and
(paren
op_logical_neg
id|ch
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TCSBRK
suffix:colon
multiline_comment|/* SVID version: non-zero arg --&gt; no break */
id|retval
op_assign
id|tty_check_change
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
(paren
id|retval
)paren
suffix:semicolon
id|setup_empty_event
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
id|MoxaPortSendBreak
c_func
(paren
id|ch-&gt;port
comma
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|TCSBRKP
suffix:colon
multiline_comment|/* support for POSIX tcsendbreak() */
id|retval
op_assign
id|tty_check_change
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
(paren
id|retval
)paren
suffix:semicolon
id|setup_empty_event
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
l_int|0
)paren
suffix:semicolon
id|MoxaPortSendBreak
c_func
(paren
id|ch-&gt;port
comma
id|arg
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|TIOCGSOFTCAR
suffix:colon
r_return
id|put_user
c_func
(paren
id|C_CLOCAL
c_func
(paren
id|tty
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCSSOFTCAR
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|retval
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|arg
op_assign
id|retval
suffix:semicolon
id|tty-&gt;termios-&gt;c_cflag
op_assign
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
op_complement
id|CLOCAL
)paren
op_or
(paren
id|arg
ques
c_cond
id|CLOCAL
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|C_CLOCAL
c_func
(paren
id|tty
)paren
)paren
id|ch-&gt;asyncflags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
r_else
id|ch-&gt;asyncflags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|TIOCMGET
suffix:colon
id|flag
op_assign
l_int|0
suffix:semicolon
id|MoxaPortGetLineOut
c_func
(paren
id|ch-&gt;port
comma
op_amp
id|dtr
comma
op_amp
id|rts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dtr
)paren
id|flag
op_or_assign
id|TIOCM_DTR
suffix:semicolon
r_if
c_cond
(paren
id|rts
)paren
id|flag
op_or_assign
id|TIOCM_RTS
suffix:semicolon
id|dtr
op_assign
id|MoxaPortLineStatus
c_func
(paren
id|ch-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dtr
op_amp
l_int|1
)paren
id|flag
op_or_assign
id|TIOCM_CTS
suffix:semicolon
r_if
c_cond
(paren
id|dtr
op_amp
l_int|2
)paren
id|flag
op_or_assign
id|TIOCM_DSR
suffix:semicolon
r_if
c_cond
(paren
id|dtr
op_amp
l_int|4
)paren
id|flag
op_or_assign
id|TIOCM_CD
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|flag
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|retval
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|MoxaPortGetLineOut
c_func
(paren
id|ch-&gt;port
comma
op_amp
id|dtr
comma
op_amp
id|rts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_amp
id|TIOCM_RTS
)paren
id|rts
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_amp
id|TIOCM_DTR
)paren
id|dtr
op_assign
l_int|1
suffix:semicolon
id|MoxaPortLineCtrl
c_func
(paren
id|ch-&gt;port
comma
id|dtr
comma
id|rts
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|retval
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|MoxaPortGetLineOut
c_func
(paren
id|ch-&gt;port
comma
op_amp
id|dtr
comma
op_amp
id|rts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_amp
id|TIOCM_RTS
)paren
id|rts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_amp
id|TIOCM_DTR
)paren
id|dtr
op_assign
l_int|0
suffix:semicolon
id|MoxaPortLineCtrl
c_func
(paren
id|ch-&gt;port
comma
id|dtr
comma
id|rts
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|retval
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|dtr
op_assign
id|rts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_amp
id|TIOCM_RTS
)paren
id|rts
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_amp
id|TIOCM_DTR
)paren
id|dtr
op_assign
l_int|1
suffix:semicolon
id|MoxaPortLineCtrl
c_func
(paren
id|ch-&gt;port
comma
id|dtr
comma
id|rts
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|TIOCGSERIAL
suffix:colon
r_return
(paren
id|moxa_get_serial_info
c_func
(paren
id|ch
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
)paren
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
r_return
(paren
id|moxa_set_serial_info
c_func
(paren
id|ch
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
)paren
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
id|MoxaDriverIoctl
c_func
(paren
id|cmd
comma
id|arg
comma
id|port
)paren
suffix:semicolon
)brace
r_return
(paren
id|retval
)paren
suffix:semicolon
)brace
DECL|function|moxa_throttle
r_static
r_void
id|moxa_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|ch-&gt;statusflags
op_or_assign
id|THROTTLE
suffix:semicolon
)brace
DECL|function|moxa_unthrottle
r_static
r_void
id|moxa_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|ch-&gt;statusflags
op_and_assign
op_complement
id|THROTTLE
suffix:semicolon
)brace
DECL|function|moxa_set_termios
r_static
r_void
id|moxa_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|set_tty_param
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
op_logical_and
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ch-&gt;open_wait
)paren
suffix:semicolon
)brace
DECL|function|moxa_stop
r_static
r_void
id|moxa_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|MoxaPortTxDisable
c_func
(paren
id|ch-&gt;port
)paren
suffix:semicolon
id|ch-&gt;statusflags
op_or_assign
id|TXSTOPPED
suffix:semicolon
)brace
DECL|function|moxa_start
r_static
r_void
id|moxa_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;statusflags
op_amp
id|TXSTOPPED
)paren
)paren
r_return
suffix:semicolon
id|MoxaPortTxEnable
c_func
(paren
id|ch-&gt;port
)paren
suffix:semicolon
id|ch-&gt;statusflags
op_and_assign
op_complement
id|TXSTOPPED
suffix:semicolon
)brace
DECL|function|moxa_hangup
r_static
r_void
id|moxa_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|moxa_flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|shut_down
c_func
(paren
id|ch
)paren
suffix:semicolon
id|ch-&gt;event
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;asyncflags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CALLOUT_ACTIVE
)paren
suffix:semicolon
id|ch-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|ch-&gt;open_wait
)paren
suffix:semicolon
)brace
DECL|function|moxa_poll
r_static
r_void
id|moxa_poll
c_func
(paren
r_int
r_int
id|ignored
)paren
(brace
r_register
r_int
id|card
suffix:semicolon
r_struct
id|moxa_str
op_star
id|ch
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tp
suffix:semicolon
r_int
id|i
comma
id|ports
suffix:semicolon
id|moxaTimer_on
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|moxaTimer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MoxaDriverPoll
c_func
(paren
)paren
OL
l_int|0
)paren
(brace
id|moxaTimer.function
op_assign
id|moxa_poll
suffix:semicolon
id|moxaTimer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|50
)paren
suffix:semicolon
id|moxaTimer_on
op_assign
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|moxaTimer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|card
op_assign
l_int|0
suffix:semicolon
id|card
OL
id|MAX_BOARDS
suffix:semicolon
id|card
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ports
op_assign
id|MoxaPortsOfCard
c_func
(paren
id|card
)paren
)paren
op_le
l_int|0
)paren
r_continue
suffix:semicolon
id|ch
op_assign
op_amp
id|moxaChannels
(braket
id|card
op_star
id|MAX_PORTS_PER_BOARD
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ports
suffix:semicolon
id|i
op_increment
comma
id|ch
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_INITIALIZED
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;statusflags
op_amp
id|THROTTLE
)paren
op_logical_and
(paren
id|MoxaPortRxQueue
c_func
(paren
id|ch-&gt;port
)paren
OG
l_int|0
)paren
)paren
id|receive_data
c_func
(paren
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tp
op_assign
id|ch-&gt;tty
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;statusflags
op_amp
id|LOWWAIT
)paren
(brace
r_if
c_cond
(paren
id|MoxaPortTxQueue
c_func
(paren
id|ch-&gt;port
)paren
op_le
id|WAKEUP_CHARS
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;stopped
)paren
(brace
id|ch-&gt;statusflags
op_and_assign
op_complement
id|LOWWAIT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tp-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tp-&gt;ldisc.write_wakeup
)paren
(paren
id|tp-&gt;ldisc.write_wakeup
)paren
(paren
id|tp
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tp-&gt;write_wait
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|I_IGNBRK
c_func
(paren
id|tp
)paren
op_logical_and
(paren
id|MoxaPortResetBrkCnt
c_func
(paren
id|ch-&gt;port
)paren
OG
l_int|0
)paren
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|tp
comma
l_int|0
comma
id|TTY_BREAK
)paren
suffix:semicolon
id|tty_schedule_flip
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MoxaPortDCDChange
c_func
(paren
id|ch-&gt;port
)paren
)paren
(brace
r_if
c_cond
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_CHECK_CD
)paren
(brace
r_if
c_cond
(paren
id|MoxaPortDCDON
c_func
(paren
id|ch-&gt;port
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ch-&gt;open_wait
)paren
suffix:semicolon
r_else
(brace
id|set_bit
c_func
(paren
id|MOXA_EVENT_HANGUP
comma
op_amp
id|ch-&gt;event
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|schedule_task
c_func
(paren
op_amp
id|ch-&gt;tqueue
)paren
op_eq
l_int|0
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
id|moxaTimer.function
op_assign
id|moxa_poll
suffix:semicolon
id|moxaTimer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|50
)paren
suffix:semicolon
id|moxaTimer_on
op_assign
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|moxaTimer
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
DECL|function|set_tty_param
r_static
r_void
id|set_tty_param
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_register
r_struct
id|termios
op_star
id|ts
suffix:semicolon
r_struct
id|moxa_str
op_star
id|ch
suffix:semicolon
r_int
id|rts
comma
id|cts
comma
id|txflow
comma
id|rxflow
comma
id|xany
suffix:semicolon
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|ts
op_assign
id|tty-&gt;termios
suffix:semicolon
r_if
c_cond
(paren
id|ts-&gt;c_cflag
op_amp
id|CLOCAL
)paren
id|ch-&gt;asyncflags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
r_else
id|ch-&gt;asyncflags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
id|rts
op_assign
id|cts
op_assign
id|txflow
op_assign
id|rxflow
op_assign
id|xany
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ts-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
id|rts
op_assign
id|cts
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ts-&gt;c_iflag
op_amp
id|IXON
)paren
id|txflow
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ts-&gt;c_iflag
op_amp
id|IXOFF
)paren
id|rxflow
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ts-&gt;c_iflag
op_amp
id|IXANY
)paren
id|xany
op_assign
l_int|1
suffix:semicolon
id|MoxaPortFlowCtrl
c_func
(paren
id|ch-&gt;port
comma
id|rts
comma
id|cts
comma
id|txflow
comma
id|rxflow
comma
id|xany
)paren
suffix:semicolon
id|MoxaPortSetTermio
c_func
(paren
id|ch-&gt;port
comma
id|ts
)paren
suffix:semicolon
)brace
DECL|function|block_till_ready
r_static
r_int
id|block_till_ready
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
r_struct
id|moxa_str
op_star
id|ch
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|do_clocal
op_assign
id|C_CLOCAL
c_func
(paren
id|tty
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the device is in the middle of being closed, then block&n;&t; * until it&squot;s done, and then try again.&n;&t; */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_CLOSING
)paren
)paren
(brace
r_if
c_cond
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_CLOSING
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|ch-&gt;close_wait
)paren
suffix:semicolon
macro_line|#ifdef SERIAL_DO_RESTART
r_if
c_cond
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
r_else
r_return
(paren
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
macro_line|#else
r_return
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;&t; * If this is a callout device, then just make sure the normal&n;&t; * device isn&squot;t being used.&n;&t; */
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|SERIAL_TYPE_CALLOUT
)paren
(brace
r_if
c_cond
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_SESSION_LOCKOUT
)paren
op_logical_and
(paren
id|ch-&gt;session
op_ne
id|current-&gt;session
)paren
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_PGRP_LOCKOUT
)paren
op_logical_and
(paren
id|ch-&gt;pgrp
op_ne
id|current-&gt;pgrp
)paren
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
id|ch-&gt;asyncflags
op_or_assign
id|ASYNC_CALLOUT_ACTIVE
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If non-blocking mode is set, then make the check up front&n;&t; * and then exit.&n;&t; */
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
r_return
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
id|ch-&gt;asyncflags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Block waiting for the carrier detect and the line to become free&n;&t; */
id|retval
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|ch-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
macro_line|#ifdef SERIAL_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;block_til_ready before block: ttys%d, count = %d&bslash;n&quot;
comma
id|ch-&gt;line
comma
id|ch-&gt;count
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
id|ch-&gt;count
op_decrement
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ch-&gt;blocked_open
op_increment
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
op_logical_neg
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
(brace
macro_line|#ifdef SERIAL_DO_RESTART
r_if
c_cond
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_else
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
macro_line|#else
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
op_logical_neg
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_CLOSING
)paren
op_logical_and
(paren
id|do_clocal
op_logical_or
id|MoxaPortDCDON
c_func
(paren
id|ch-&gt;port
)paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|ch-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
id|ch-&gt;count
op_increment
suffix:semicolon
id|ch-&gt;blocked_open
op_decrement
suffix:semicolon
macro_line|#ifdef SERIAL_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;block_til_ready after blocking: ttys%d, count = %d&bslash;n&quot;
comma
id|ch-&gt;line
comma
id|ch-&gt;count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|retval
)paren
r_return
(paren
id|retval
)paren
suffix:semicolon
id|ch-&gt;asyncflags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|setup_empty_event
r_static
r_void
id|setup_empty_event
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ch-&gt;statusflags
op_or_assign
id|EMPTYWAIT
suffix:semicolon
id|moxaEmptyTimer_on
(braket
id|ch-&gt;port
)braket
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|moxaEmptyTimer
(braket
id|ch-&gt;port
)braket
)paren
suffix:semicolon
id|moxaEmptyTimer
(braket
id|ch-&gt;port
)braket
dot
id|expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|moxaEmptyTimer_on
(braket
id|ch-&gt;port
)braket
op_assign
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|moxaEmptyTimer
(braket
id|ch-&gt;port
)braket
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|check_xmit_empty
r_static
r_void
id|check_xmit_empty
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|moxa_str
op_star
id|ch
suffix:semicolon
id|ch
op_assign
(paren
r_struct
id|moxa_str
op_star
)paren
id|data
suffix:semicolon
id|moxaEmptyTimer_on
(braket
id|ch-&gt;port
)braket
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|moxaEmptyTimer
(braket
id|ch-&gt;port
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;tty
op_logical_and
(paren
id|ch-&gt;statusflags
op_amp
id|EMPTYWAIT
)paren
)paren
(brace
r_if
c_cond
(paren
id|MoxaPortTxQueue
c_func
(paren
id|ch-&gt;port
)paren
op_eq
l_int|0
)paren
(brace
id|ch-&gt;statusflags
op_and_assign
op_complement
id|EMPTYWAIT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch-&gt;tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|ch-&gt;tty-&gt;ldisc.write_wakeup
)paren
(paren
id|ch-&gt;tty-&gt;ldisc.write_wakeup
)paren
(paren
id|ch-&gt;tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|ch-&gt;tty-&gt;write_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|moxaEmptyTimer
(braket
id|ch-&gt;port
)braket
dot
id|expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|moxaEmptyTimer_on
(braket
id|ch-&gt;port
)braket
op_assign
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|moxaEmptyTimer
(braket
id|ch-&gt;port
)braket
)paren
suffix:semicolon
)brace
r_else
id|ch-&gt;statusflags
op_and_assign
op_complement
id|EMPTYWAIT
suffix:semicolon
)brace
DECL|function|shut_down
r_static
r_void
id|shut_down
c_func
(paren
r_struct
id|moxa_str
op_star
id|ch
)paren
(brace
r_struct
id|tty_struct
op_star
id|tp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch-&gt;asyncflags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
r_return
suffix:semicolon
id|tp
op_assign
id|ch-&gt;tty
suffix:semicolon
id|MoxaPortDisable
c_func
(paren
id|ch-&gt;port
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we&squot;re a modem control device and HUPCL is on, drop RTS &amp; DTR.&n;&t; */
r_if
c_cond
(paren
id|tp-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
id|MoxaPortLineCtrl
c_func
(paren
id|ch-&gt;port
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ch-&gt;asyncflags
op_and_assign
op_complement
id|ASYNC_INITIALIZED
suffix:semicolon
)brace
DECL|function|receive_data
r_static
r_void
id|receive_data
c_func
(paren
r_struct
id|moxa_str
op_star
id|ch
)paren
(brace
r_struct
id|tty_struct
op_star
id|tp
suffix:semicolon
r_struct
id|termios
op_star
id|ts
suffix:semicolon
r_int
id|i
comma
id|count
comma
id|rc
comma
id|space
suffix:semicolon
r_int
r_char
op_star
id|charptr
comma
op_star
id|flagptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ts
op_assign
l_int|0
suffix:semicolon
id|tp
op_assign
id|ch-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tp
)paren
id|ts
op_assign
id|tp-&gt;termios
suffix:semicolon
multiline_comment|/**************************************************&n;&t;if ( !tp || !ts || !(ts-&gt;c_cflag &amp; CREAD) ) {&n;&t;*****************************************************/
r_if
c_cond
(paren
op_logical_neg
id|tp
op_logical_or
op_logical_neg
id|ts
)paren
(brace
id|MoxaPortFlushData
c_func
(paren
id|ch-&gt;port
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|space
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tp-&gt;flip.count
suffix:semicolon
r_if
c_cond
(paren
id|space
op_le
l_int|0
)paren
r_return
suffix:semicolon
id|charptr
op_assign
id|tp-&gt;flip.char_buf_ptr
suffix:semicolon
id|flagptr
op_assign
id|tp-&gt;flip.flag_buf_ptr
suffix:semicolon
id|rc
op_assign
id|tp-&gt;flip.count
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|count
op_assign
id|MoxaPortReadData
c_func
(paren
id|ch-&gt;port
comma
id|charptr
comma
id|space
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
op_star
id|flagptr
op_increment
op_assign
l_int|0
suffix:semicolon
id|charptr
op_add_assign
id|count
suffix:semicolon
id|rc
op_add_assign
id|count
suffix:semicolon
id|tp-&gt;flip.count
op_assign
id|rc
suffix:semicolon
id|tp-&gt;flip.char_buf_ptr
op_assign
id|charptr
suffix:semicolon
id|tp-&gt;flip.flag_buf_ptr
op_assign
id|flagptr
suffix:semicolon
id|tty_schedule_flip
c_func
(paren
id|ch-&gt;tty
)paren
suffix:semicolon
)brace
DECL|macro|Magic_code
mdefine_line|#define Magic_code&t;0x404
multiline_comment|/*&n; *    System Configuration&n; */
multiline_comment|/*&n; *    for C218 BIOS initialization&n; */
DECL|macro|C218_ConfBase
mdefine_line|#define C218_ConfBase&t;0x800
DECL|macro|C218_status
mdefine_line|#define C218_status&t;(C218_ConfBase + 0)&t;/* BIOS running status    */
DECL|macro|C218_diag
mdefine_line|#define C218_diag&t;(C218_ConfBase + 2)&t;/* diagnostic status      */
DECL|macro|C218_key
mdefine_line|#define C218_key&t;(C218_ConfBase + 4)&t;/* WORD (0x218 for C218) */
DECL|macro|C218DLoad_len
mdefine_line|#define C218DLoad_len&t;(C218_ConfBase + 6)&t;/* WORD           */
DECL|macro|C218check_sum
mdefine_line|#define C218check_sum&t;(C218_ConfBase + 8)&t;/* BYTE           */
DECL|macro|C218chksum_ok
mdefine_line|#define C218chksum_ok&t;(C218_ConfBase + 0x0a)&t;/* BYTE (1:ok)            */
DECL|macro|C218_TestRx
mdefine_line|#define C218_TestRx&t;(C218_ConfBase + 0x10)&t;/* 8 bytes for 8 ports    */
DECL|macro|C218_TestTx
mdefine_line|#define C218_TestTx&t;(C218_ConfBase + 0x18)&t;/* 8 bytes for 8 ports    */
DECL|macro|C218_RXerr
mdefine_line|#define C218_RXerr&t;(C218_ConfBase + 0x20)&t;/* 8 bytes for 8 ports    */
DECL|macro|C218_ErrFlag
mdefine_line|#define C218_ErrFlag&t;(C218_ConfBase + 0x28)&t;/* 8 bytes for 8 ports    */
DECL|macro|C218_LoadBuf
mdefine_line|#define C218_LoadBuf&t;0x0F00
DECL|macro|C218_KeyCode
mdefine_line|#define C218_KeyCode&t;0x218
DECL|macro|CP204J_KeyCode
mdefine_line|#define CP204J_KeyCode&t;0x204
multiline_comment|/*&n; *    for C320 BIOS initialization&n; */
DECL|macro|C320_ConfBase
mdefine_line|#define C320_ConfBase&t;0x800
DECL|macro|C320_LoadBuf
mdefine_line|#define C320_LoadBuf&t;0x0f00
DECL|macro|STS_init
mdefine_line|#define STS_init&t;0x05&t;/* for C320_status        */
DECL|macro|C320_status
mdefine_line|#define C320_status&t;C320_ConfBase + 0&t;/* BIOS running status    */
DECL|macro|C320_diag
mdefine_line|#define C320_diag&t;C320_ConfBase + 2&t;/* diagnostic status      */
DECL|macro|C320_key
mdefine_line|#define C320_key&t;C320_ConfBase + 4&t;/* WORD (0320H for C320) */
DECL|macro|C320DLoad_len
mdefine_line|#define C320DLoad_len&t;C320_ConfBase + 6&t;/* WORD           */
DECL|macro|C320check_sum
mdefine_line|#define C320check_sum&t;C320_ConfBase + 8&t;/* WORD           */
DECL|macro|C320chksum_ok
mdefine_line|#define C320chksum_ok&t;C320_ConfBase + 0x0a&t;/* WORD (1:ok)            */
DECL|macro|C320bapi_len
mdefine_line|#define C320bapi_len&t;C320_ConfBase + 0x0c&t;/* WORD           */
DECL|macro|C320UART_no
mdefine_line|#define C320UART_no&t;C320_ConfBase + 0x0e&t;/* WORD           */
DECL|macro|C320_KeyCode
mdefine_line|#define C320_KeyCode&t;0x320
DECL|macro|FixPage_addr
mdefine_line|#define FixPage_addr&t;0x0000&t;/* starting addr of static page  */
DECL|macro|DynPage_addr
mdefine_line|#define DynPage_addr&t;0x2000&t;/* starting addr of dynamic page */
DECL|macro|C218_start
mdefine_line|#define C218_start&t;0x3000&t;/* starting addr of C218 BIOS prg */
DECL|macro|Control_reg
mdefine_line|#define Control_reg&t;0x1ff0&t;/* select page and reset control */
DECL|macro|HW_reset
mdefine_line|#define HW_reset&t;0x80
multiline_comment|/*&n; *    Function Codes&n; */
DECL|macro|FC_CardReset
mdefine_line|#define FC_CardReset&t;0x80
DECL|macro|FC_ChannelReset
mdefine_line|#define FC_ChannelReset 1&t;/* C320 firmware not supported */
DECL|macro|FC_EnableCH
mdefine_line|#define FC_EnableCH&t;2
DECL|macro|FC_DisableCH
mdefine_line|#define FC_DisableCH&t;3
DECL|macro|FC_SetParam
mdefine_line|#define FC_SetParam&t;4
DECL|macro|FC_SetMode
mdefine_line|#define FC_SetMode&t;5
DECL|macro|FC_SetRate
mdefine_line|#define FC_SetRate&t;6
DECL|macro|FC_LineControl
mdefine_line|#define FC_LineControl&t;7
DECL|macro|FC_LineStatus
mdefine_line|#define FC_LineStatus&t;8
DECL|macro|FC_XmitControl
mdefine_line|#define FC_XmitControl&t;9
DECL|macro|FC_FlushQueue
mdefine_line|#define FC_FlushQueue&t;10
DECL|macro|FC_SendBreak
mdefine_line|#define FC_SendBreak&t;11
DECL|macro|FC_StopBreak
mdefine_line|#define FC_StopBreak&t;12
DECL|macro|FC_LoopbackON
mdefine_line|#define FC_LoopbackON&t;13
DECL|macro|FC_LoopbackOFF
mdefine_line|#define FC_LoopbackOFF&t;14
DECL|macro|FC_ClrIrqTable
mdefine_line|#define FC_ClrIrqTable&t;15
DECL|macro|FC_SendXon
mdefine_line|#define FC_SendXon&t;16
DECL|macro|FC_SetTermIrq
mdefine_line|#define FC_SetTermIrq&t;17&t;/* C320 firmware not supported */
DECL|macro|FC_SetCntIrq
mdefine_line|#define FC_SetCntIrq&t;18&t;/* C320 firmware not supported */
DECL|macro|FC_SetBreakIrq
mdefine_line|#define FC_SetBreakIrq&t;19
DECL|macro|FC_SetLineIrq
mdefine_line|#define FC_SetLineIrq&t;20
DECL|macro|FC_SetFlowCtl
mdefine_line|#define FC_SetFlowCtl&t;21
DECL|macro|FC_GenIrq
mdefine_line|#define FC_GenIrq&t;22
DECL|macro|FC_InCD180
mdefine_line|#define FC_InCD180&t;23
DECL|macro|FC_OutCD180
mdefine_line|#define FC_OutCD180&t;24
DECL|macro|FC_InUARTreg
mdefine_line|#define FC_InUARTreg&t;23
DECL|macro|FC_OutUARTreg
mdefine_line|#define FC_OutUARTreg&t;24
DECL|macro|FC_SetXonXoff
mdefine_line|#define FC_SetXonXoff&t;25
DECL|macro|FC_OutCD180CCR
mdefine_line|#define FC_OutCD180CCR&t;26
DECL|macro|FC_ExtIQueue
mdefine_line|#define FC_ExtIQueue&t;27
DECL|macro|FC_ExtOQueue
mdefine_line|#define FC_ExtOQueue&t;28
DECL|macro|FC_ClrLineIrq
mdefine_line|#define FC_ClrLineIrq&t;29
DECL|macro|FC_HWFlowCtl
mdefine_line|#define FC_HWFlowCtl&t;30
DECL|macro|FC_GetClockRate
mdefine_line|#define FC_GetClockRate 35
DECL|macro|FC_SetBaud
mdefine_line|#define FC_SetBaud&t;36
DECL|macro|FC_SetDataMode
mdefine_line|#define FC_SetDataMode  41
DECL|macro|FC_GetCCSR
mdefine_line|#define FC_GetCCSR      43
DECL|macro|FC_GetDataError
mdefine_line|#define FC_GetDataError 45
DECL|macro|FC_RxControl
mdefine_line|#define FC_RxControl&t;50
DECL|macro|FC_ImmSend
mdefine_line|#define FC_ImmSend&t;51
DECL|macro|FC_SetXonState
mdefine_line|#define FC_SetXonState&t;52
DECL|macro|FC_SetXoffState
mdefine_line|#define FC_SetXoffState&t;53
DECL|macro|FC_SetRxFIFOTrig
mdefine_line|#define FC_SetRxFIFOTrig 54
DECL|macro|FC_SetTxFIFOCnt
mdefine_line|#define FC_SetTxFIFOCnt 55
DECL|macro|FC_UnixRate
mdefine_line|#define FC_UnixRate&t;56
DECL|macro|FC_UnixResetTimer
mdefine_line|#define FC_UnixResetTimer 57
DECL|macro|RxFIFOTrig1
mdefine_line|#define&t;RxFIFOTrig1&t;0
DECL|macro|RxFIFOTrig4
mdefine_line|#define&t;RxFIFOTrig4&t;1
DECL|macro|RxFIFOTrig8
mdefine_line|#define&t;RxFIFOTrig8&t;2
DECL|macro|RxFIFOTrig14
mdefine_line|#define&t;RxFIFOTrig14&t;3
multiline_comment|/*&n; *    Dual-Ported RAM&n; */
DECL|macro|DRAM_global
mdefine_line|#define DRAM_global&t;0
DECL|macro|INT_data
mdefine_line|#define INT_data&t;(DRAM_global + 0)
DECL|macro|Config_base
mdefine_line|#define Config_base&t;(DRAM_global + 0x108)
DECL|macro|IRQindex
mdefine_line|#define IRQindex&t;(INT_data + 0)
DECL|macro|IRQpending
mdefine_line|#define IRQpending&t;(INT_data + 4)
DECL|macro|IRQtable
mdefine_line|#define IRQtable&t;(INT_data + 8)
multiline_comment|/*&n; *    Interrupt Status&n; */
DECL|macro|IntrRx
mdefine_line|#define IntrRx&t;&t;0x01&t;/* receiver data O.K.             */
DECL|macro|IntrTx
mdefine_line|#define IntrTx&t;&t;0x02&t;/* transmit buffer empty  */
DECL|macro|IntrFunc
mdefine_line|#define IntrFunc&t;0x04&t;/* function complete              */
DECL|macro|IntrBreak
mdefine_line|#define IntrBreak&t;0x08&t;/* received break         */
DECL|macro|IntrLine
mdefine_line|#define IntrLine&t;0x10&t;/* line status change&n;&t;&t;&t;&t;   for transmitter                */
DECL|macro|IntrIntr
mdefine_line|#define IntrIntr&t;0x20&t;/* received INTR code             */
DECL|macro|IntrQuit
mdefine_line|#define IntrQuit&t;0x40&t;/* received QUIT code             */
DECL|macro|IntrEOF
mdefine_line|#define IntrEOF &t;0x80&t;/* received EOF code              */
DECL|macro|IntrRxTrigger
mdefine_line|#define IntrRxTrigger &t;0x100&t;/* rx data count reach tigger value */
DECL|macro|IntrTxTrigger
mdefine_line|#define IntrTxTrigger &t;0x200&t;/* tx data count below trigger value */
DECL|macro|Magic_no
mdefine_line|#define Magic_no&t;(Config_base + 0)
DECL|macro|Card_model_no
mdefine_line|#define Card_model_no&t;(Config_base + 2)
DECL|macro|Total_ports
mdefine_line|#define Total_ports&t;(Config_base + 4)
DECL|macro|Module_cnt
mdefine_line|#define Module_cnt&t;(Config_base + 8)
DECL|macro|Module_no
mdefine_line|#define Module_no&t;(Config_base + 10)
DECL|macro|Timer_10ms
mdefine_line|#define Timer_10ms&t;(Config_base + 14)
DECL|macro|Disable_IRQ
mdefine_line|#define Disable_IRQ&t;(Config_base + 20)
DECL|macro|TMS320_PORT1
mdefine_line|#define TMS320_PORT1&t;(Config_base + 22)
DECL|macro|TMS320_PORT2
mdefine_line|#define TMS320_PORT2&t;(Config_base + 24)
DECL|macro|TMS320_CLOCK
mdefine_line|#define TMS320_CLOCK&t;(Config_base + 26)
multiline_comment|/*&n; *    DATA BUFFER in DRAM&n; */
DECL|macro|Extern_table
mdefine_line|#define Extern_table&t;0x400&t;/* Base address of the external table&n;&t;&t;&t;&t;   (24 words *    64) total 3K bytes&n;&t;&t;&t;&t;   (24 words * 128) total 6K bytes */
DECL|macro|Extern_size
mdefine_line|#define Extern_size&t;0x60&t;/* 96 bytes                       */
DECL|macro|RXrptr
mdefine_line|#define RXrptr&t;&t;0x00&t;/* read pointer for RX buffer     */
DECL|macro|RXwptr
mdefine_line|#define RXwptr&t;&t;0x02&t;/* write pointer for RX buffer    */
DECL|macro|TXrptr
mdefine_line|#define TXrptr&t;&t;0x04&t;/* read pointer for TX buffer     */
DECL|macro|TXwptr
mdefine_line|#define TXwptr&t;&t;0x06&t;/* write pointer for TX buffer    */
DECL|macro|HostStat
mdefine_line|#define HostStat&t;0x08&t;/* IRQ flag and general flag      */
DECL|macro|FlagStat
mdefine_line|#define FlagStat&t;0x0A
DECL|macro|FlowControl
mdefine_line|#define FlowControl&t;0x0C&t;/* B7 B6 B5 B4 B3 B2 B1 B0              */
multiline_comment|/*  x  x  x  x  |  |  |  |            */
multiline_comment|/*              |  |  |  + CTS flow   */
multiline_comment|/*              |  |  +--- RTS flow   */
multiline_comment|/*              |  +------ TX Xon/Xoff */
multiline_comment|/*              +--------- RX Xon/Xoff */
DECL|macro|Break_cnt
mdefine_line|#define Break_cnt&t;0x0E&t;/* received break count   */
DECL|macro|CD180TXirq
mdefine_line|#define CD180TXirq&t;0x10&t;/* if non-0: enable TX irq        */
DECL|macro|RX_mask
mdefine_line|#define RX_mask &t;0x12
DECL|macro|TX_mask
mdefine_line|#define TX_mask &t;0x14
DECL|macro|Ofs_rxb
mdefine_line|#define Ofs_rxb &t;0x16
DECL|macro|Ofs_txb
mdefine_line|#define Ofs_txb &t;0x18
DECL|macro|Page_rxb
mdefine_line|#define Page_rxb&t;0x1A
DECL|macro|Page_txb
mdefine_line|#define Page_txb&t;0x1C
DECL|macro|EndPage_rxb
mdefine_line|#define EndPage_rxb&t;0x1E
DECL|macro|EndPage_txb
mdefine_line|#define EndPage_txb&t;0x20
DECL|macro|Data_error
mdefine_line|#define Data_error&t;0x22
DECL|macro|RxTrigger
mdefine_line|#define RxTrigger&t;0x28
DECL|macro|TxTrigger
mdefine_line|#define TxTrigger&t;0x2a
DECL|macro|rRXwptr
mdefine_line|#define rRXwptr &t;0x34
DECL|macro|Low_water
mdefine_line|#define Low_water&t;0x36
DECL|macro|FuncCode
mdefine_line|#define FuncCode&t;0x40
DECL|macro|FuncArg
mdefine_line|#define FuncArg &t;0x42
DECL|macro|FuncArg1
mdefine_line|#define FuncArg1&t;0x44
DECL|macro|C218rx_size
mdefine_line|#define C218rx_size&t;0x2000&t;/* 8K bytes */
DECL|macro|C218tx_size
mdefine_line|#define C218tx_size&t;0x8000&t;/* 32K bytes */
DECL|macro|C218rx_mask
mdefine_line|#define C218rx_mask&t;(C218rx_size - 1)
DECL|macro|C218tx_mask
mdefine_line|#define C218tx_mask&t;(C218tx_size - 1)
DECL|macro|C320p8rx_size
mdefine_line|#define C320p8rx_size&t;0x2000
DECL|macro|C320p8tx_size
mdefine_line|#define C320p8tx_size&t;0x8000
DECL|macro|C320p8rx_mask
mdefine_line|#define C320p8rx_mask&t;(C320p8rx_size - 1)
DECL|macro|C320p8tx_mask
mdefine_line|#define C320p8tx_mask&t;(C320p8tx_size - 1)
DECL|macro|C320p16rx_size
mdefine_line|#define C320p16rx_size&t;0x2000
DECL|macro|C320p16tx_size
mdefine_line|#define C320p16tx_size&t;0x4000
DECL|macro|C320p16rx_mask
mdefine_line|#define C320p16rx_mask&t;(C320p16rx_size - 1)
DECL|macro|C320p16tx_mask
mdefine_line|#define C320p16tx_mask&t;(C320p16tx_size - 1)
DECL|macro|C320p24rx_size
mdefine_line|#define C320p24rx_size&t;0x2000
DECL|macro|C320p24tx_size
mdefine_line|#define C320p24tx_size&t;0x2000
DECL|macro|C320p24rx_mask
mdefine_line|#define C320p24rx_mask&t;(C320p24rx_size - 1)
DECL|macro|C320p24tx_mask
mdefine_line|#define C320p24tx_mask&t;(C320p24tx_size - 1)
DECL|macro|C320p32rx_size
mdefine_line|#define C320p32rx_size&t;0x1000
DECL|macro|C320p32tx_size
mdefine_line|#define C320p32tx_size&t;0x1000
DECL|macro|C320p32rx_mask
mdefine_line|#define C320p32rx_mask&t;(C320p32rx_size - 1)
DECL|macro|C320p32tx_mask
mdefine_line|#define C320p32tx_mask&t;(C320p32tx_size - 1)
DECL|macro|Page_size
mdefine_line|#define Page_size&t;0x2000
DECL|macro|Page_mask
mdefine_line|#define Page_mask&t;(Page_size - 1)
DECL|macro|C218rx_spage
mdefine_line|#define C218rx_spage&t;3
DECL|macro|C218tx_spage
mdefine_line|#define C218tx_spage&t;4
DECL|macro|C218rx_pageno
mdefine_line|#define C218rx_pageno&t;1
DECL|macro|C218tx_pageno
mdefine_line|#define C218tx_pageno&t;4
DECL|macro|C218buf_pageno
mdefine_line|#define C218buf_pageno&t;5
DECL|macro|C320p8rx_spage
mdefine_line|#define C320p8rx_spage&t;3
DECL|macro|C320p8tx_spage
mdefine_line|#define C320p8tx_spage&t;4
DECL|macro|C320p8rx_pgno
mdefine_line|#define C320p8rx_pgno&t;1
DECL|macro|C320p8tx_pgno
mdefine_line|#define C320p8tx_pgno&t;4
DECL|macro|C320p8buf_pgno
mdefine_line|#define C320p8buf_pgno&t;5
DECL|macro|C320p16rx_spage
mdefine_line|#define C320p16rx_spage 3
DECL|macro|C320p16tx_spage
mdefine_line|#define C320p16tx_spage 4
DECL|macro|C320p16rx_pgno
mdefine_line|#define C320p16rx_pgno&t;1
DECL|macro|C320p16tx_pgno
mdefine_line|#define C320p16tx_pgno&t;2
DECL|macro|C320p16buf_pgno
mdefine_line|#define C320p16buf_pgno 3
DECL|macro|C320p24rx_spage
mdefine_line|#define C320p24rx_spage 3
DECL|macro|C320p24tx_spage
mdefine_line|#define C320p24tx_spage 4
DECL|macro|C320p24rx_pgno
mdefine_line|#define C320p24rx_pgno&t;1
DECL|macro|C320p24tx_pgno
mdefine_line|#define C320p24tx_pgno&t;1
DECL|macro|C320p24buf_pgno
mdefine_line|#define C320p24buf_pgno 2
DECL|macro|C320p32rx_spage
mdefine_line|#define C320p32rx_spage 3
DECL|macro|C320p32tx_ofs
mdefine_line|#define C320p32tx_ofs&t;C320p32rx_size
DECL|macro|C320p32tx_spage
mdefine_line|#define C320p32tx_spage 3
DECL|macro|C320p32buf_pgno
mdefine_line|#define C320p32buf_pgno 1
multiline_comment|/*&n; *    Host Status&n; */
DECL|macro|WakeupRx
mdefine_line|#define WakeupRx&t;0x01
DECL|macro|WakeupTx
mdefine_line|#define WakeupTx&t;0x02
DECL|macro|WakeupBreak
mdefine_line|#define WakeupBreak&t;0x08
DECL|macro|WakeupLine
mdefine_line|#define WakeupLine&t;0x10
DECL|macro|WakeupIntr
mdefine_line|#define WakeupIntr&t;0x20
DECL|macro|WakeupQuit
mdefine_line|#define WakeupQuit&t;0x40
DECL|macro|WakeupEOF
mdefine_line|#define WakeupEOF&t;0x80&t;/* used in VTIME control */
DECL|macro|WakeupRxTrigger
mdefine_line|#define WakeupRxTrigger&t;0x100
DECL|macro|WakeupTxTrigger
mdefine_line|#define WakeupTxTrigger&t;0x200
multiline_comment|/*&n; *    Flag status&n; */
DECL|macro|Rx_over
mdefine_line|#define Rx_over&t;&t;0x01
DECL|macro|Xoff_state
mdefine_line|#define Xoff_state&t;0x02
DECL|macro|Tx_flowOff
mdefine_line|#define Tx_flowOff&t;0x04
DECL|macro|Tx_enable
mdefine_line|#define Tx_enable&t;0x08
DECL|macro|CTS_state
mdefine_line|#define CTS_state&t;0x10
DECL|macro|DSR_state
mdefine_line|#define DSR_state&t;0x20
DECL|macro|DCD_state
mdefine_line|#define DCD_state&t;0x80
multiline_comment|/*&n; *    FlowControl&n; */
DECL|macro|CTS_FlowCtl
mdefine_line|#define CTS_FlowCtl&t;1
DECL|macro|RTS_FlowCtl
mdefine_line|#define RTS_FlowCtl&t;2
DECL|macro|Tx_FlowCtl
mdefine_line|#define Tx_FlowCtl&t;4
DECL|macro|Rx_FlowCtl
mdefine_line|#define Rx_FlowCtl&t;8
DECL|macro|IXM_IXANY
mdefine_line|#define IXM_IXANY&t;0x10
DECL|macro|LowWater
mdefine_line|#define LowWater&t;128
DECL|macro|DTR_ON
mdefine_line|#define DTR_ON&t;&t;1
DECL|macro|RTS_ON
mdefine_line|#define RTS_ON&t;&t;2
DECL|macro|CTS_ON
mdefine_line|#define CTS_ON&t;&t;1
DECL|macro|DSR_ON
mdefine_line|#define DSR_ON&t;&t;2
DECL|macro|DCD_ON
mdefine_line|#define DCD_ON&t;&t;8
multiline_comment|/* mode definition */
DECL|macro|MX_CS8
mdefine_line|#define&t;MX_CS8&t;&t;0x03
DECL|macro|MX_CS7
mdefine_line|#define&t;MX_CS7&t;&t;0x02
DECL|macro|MX_CS6
mdefine_line|#define&t;MX_CS6&t;&t;0x01
DECL|macro|MX_CS5
mdefine_line|#define&t;MX_CS5&t;&t;0x00
DECL|macro|MX_STOP1
mdefine_line|#define&t;MX_STOP1&t;0x00
DECL|macro|MX_STOP15
mdefine_line|#define&t;MX_STOP15&t;0x04
DECL|macro|MX_STOP2
mdefine_line|#define&t;MX_STOP2&t;0x08
DECL|macro|MX_PARNONE
mdefine_line|#define&t;MX_PARNONE&t;0x00
DECL|macro|MX_PAREVEN
mdefine_line|#define&t;MX_PAREVEN&t;0x40
DECL|macro|MX_PARODD
mdefine_line|#define&t;MX_PARODD&t;0xC0
multiline_comment|/*&n; *    Query&n; */
DECL|macro|QueryPort
mdefine_line|#define QueryPort&t;MAX_PORTS
DECL|struct|mon_str
r_struct
id|mon_str
(brace
DECL|member|tick
r_int
id|tick
suffix:semicolon
DECL|member|rxcnt
r_int
id|rxcnt
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|member|txcnt
r_int
id|txcnt
(braket
id|MAX_PORTS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|typedef|mon_st
r_typedef
r_struct
id|mon_str
id|mon_st
suffix:semicolon
DECL|macro|DCD_changed
mdefine_line|#define &t;DCD_changed&t;0x01
DECL|macro|DCD_oldstate
mdefine_line|#define &t;DCD_oldstate&t;0x80
DECL|variable|moxaBuff
r_static
r_int
r_char
id|moxaBuff
(braket
l_int|10240
)braket
suffix:semicolon
DECL|variable|moxaIntNdx
r_static
r_int
r_int
id|moxaIntNdx
(braket
id|MAX_BOARDS
)braket
suffix:semicolon
DECL|variable|moxaIntPend
r_static
r_int
r_int
id|moxaIntPend
(braket
id|MAX_BOARDS
)braket
suffix:semicolon
DECL|variable|moxaIntTable
r_static
r_int
r_int
id|moxaIntTable
(braket
id|MAX_BOARDS
)braket
suffix:semicolon
DECL|variable|moxaChkPort
r_static
r_char
id|moxaChkPort
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|moxaLineCtrl
r_static
r_char
id|moxaLineCtrl
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|moxaTableAddr
r_static
r_int
r_int
id|moxaTableAddr
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|moxaCurBaud
r_static
r_int
id|moxaCurBaud
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|moxaDCDState
r_static
r_char
id|moxaDCDState
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|moxaLowChkFlag
r_static
r_char
id|moxaLowChkFlag
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|moxaLowWaterChk
r_static
r_int
id|moxaLowWaterChk
suffix:semicolon
DECL|variable|moxaCard
r_static
r_int
id|moxaCard
suffix:semicolon
DECL|variable|moxaLog
r_static
id|mon_st
id|moxaLog
suffix:semicolon
DECL|variable|moxaFuncTout
r_static
r_int
id|moxaFuncTout
suffix:semicolon
DECL|variable|moxaBreakCnt
r_static
id|ushort
id|moxaBreakCnt
(braket
id|MAX_PORTS
)braket
suffix:semicolon
r_static
r_void
id|moxadelay
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|moxafunc
c_func
(paren
r_int
r_int
comma
r_int
comma
id|ushort
)paren
suffix:semicolon
r_static
r_void
id|wait_finish
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|low_water_check
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|moxaloadbios
c_func
(paren
r_int
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|moxafindcard
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|moxaload320b
c_func
(paren
r_int
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|moxaloadcode
c_func
(paren
r_int
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|moxaloadc218
c_func
(paren
r_int
comma
r_int
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|moxaloadc320
c_func
(paren
r_int
comma
r_int
r_int
comma
r_int
comma
r_int
op_star
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************&n; *&t;Driver level functions: &t;&t;&t;&t;&t;     *&n; *&t;1. MoxaDriverInit(void);&t;&t;&t;&t;&t;     *&n; *&t;2. MoxaDriverIoctl(unsigned int cmd, unsigned long arg, int port);   *&n; *&t;3. MoxaDriverPoll(void);&t;&t;&t;&t;&t;     *&n; *****************************************************************************/
DECL|function|MoxaDriverInit
r_void
id|MoxaDriverInit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|moxaFuncTout
op_assign
id|HZ
op_div
l_int|2
suffix:semicolon
multiline_comment|/* 500 mini-seconds */
id|moxaCard
op_assign
l_int|0
suffix:semicolon
id|moxaLog.tick
op_assign
l_int|0
suffix:semicolon
id|moxaLowWaterChk
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|moxaChkPort
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|moxaLowChkFlag
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|moxaLineCtrl
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|moxaLog.rxcnt
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|moxaLog.txcnt
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|macro|MOXA
mdefine_line|#define&t;MOXA&t;&t;0x400
DECL|macro|MOXA_GET_IQUEUE
mdefine_line|#define MOXA_GET_IQUEUE &t;(MOXA + 1)&t;/* get input buffered count */
DECL|macro|MOXA_GET_OQUEUE
mdefine_line|#define MOXA_GET_OQUEUE &t;(MOXA + 2)&t;/* get output buffered count */
DECL|macro|MOXA_INIT_DRIVER
mdefine_line|#define MOXA_INIT_DRIVER&t;(MOXA + 6)&t;/* moxaCard=0 */
DECL|macro|MOXA_LOAD_BIOS
mdefine_line|#define MOXA_LOAD_BIOS&t;&t;(MOXA + 9)&t;/* download BIOS */
DECL|macro|MOXA_FIND_BOARD
mdefine_line|#define MOXA_FIND_BOARD&t;&t;(MOXA + 10)&t;/* Check if MOXA card exist? */
DECL|macro|MOXA_LOAD_C320B
mdefine_line|#define MOXA_LOAD_C320B&t;&t;(MOXA + 11)&t;/* download 320B firmware */
DECL|macro|MOXA_LOAD_CODE
mdefine_line|#define MOXA_LOAD_CODE&t;&t;(MOXA + 12)&t;/* download firmware */
DECL|macro|MOXA_GETDATACOUNT
mdefine_line|#define MOXA_GETDATACOUNT       (MOXA + 23)
DECL|macro|MOXA_GET_IOQUEUE
mdefine_line|#define MOXA_GET_IOQUEUE&t;(MOXA + 27)
DECL|macro|MOXA_FLUSH_QUEUE
mdefine_line|#define MOXA_FLUSH_QUEUE&t;(MOXA + 28)
DECL|macro|MOXA_GET_CONF
mdefine_line|#define MOXA_GET_CONF&t;&t;(MOXA + 35)&t;/* configuration */
DECL|macro|MOXA_GET_MAJOR
mdefine_line|#define MOXA_GET_MAJOR          (MOXA + 63)
DECL|macro|MOXA_GET_CUMAJOR
mdefine_line|#define MOXA_GET_CUMAJOR        (MOXA + 64)
DECL|macro|MOXA_GETMSTATUS
mdefine_line|#define MOXA_GETMSTATUS         (MOXA + 65)
DECL|struct|moxaq_str
r_struct
id|moxaq_str
(brace
DECL|member|inq
r_int
id|inq
suffix:semicolon
DECL|member|outq
r_int
id|outq
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|dl_str
r_struct
id|dl_str
(brace
DECL|member|buf
r_char
op_star
id|buf
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
DECL|member|cardno
r_int
id|cardno
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|temp_queue
r_static
r_struct
id|moxaq_str
id|temp_queue
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|dltmp
r_static
r_struct
id|dl_str
id|dltmp
suffix:semicolon
DECL|function|MoxaPortFlushData
r_void
id|MoxaPortFlushData
c_func
(paren
r_int
id|port
comma
r_int
id|mode
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mode
OL
l_int|0
)paren
op_logical_or
(paren
id|mode
OG
l_int|2
)paren
)paren
r_return
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_FlushQueue
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_ne
l_int|1
)paren
(brace
id|moxaLowChkFlag
(braket
id|port
)braket
op_assign
l_int|0
suffix:semicolon
id|low_water_check
c_func
(paren
id|ofsAddr
)paren
suffix:semicolon
)brace
)brace
DECL|function|MoxaDriverIoctl
r_int
id|MoxaDriverIoctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_int
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|MoxaPortTxQueue
c_func
(paren
r_int
)paren
comma
id|MoxaPortRxQueue
c_func
(paren
r_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
id|QueryPort
)paren
(brace
r_if
c_cond
(paren
(paren
id|cmd
op_ne
id|MOXA_GET_CONF
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_INIT_DRIVER
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_LOAD_BIOS
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_FIND_BOARD
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_LOAD_C320B
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_LOAD_CODE
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_GETDATACOUNT
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_GET_IOQUEUE
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_GET_MAJOR
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_GET_CUMAJOR
)paren
op_logical_and
(paren
id|cmd
op_ne
id|MOXA_GETMSTATUS
)paren
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MOXA_GET_CONF
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|moxa_boards
comma
id|MAX_BOARDS
op_star
r_sizeof
(paren
id|moxa_board_conf
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|MOXA_INIT_DRIVER
suffix:colon
r_if
c_cond
(paren
(paren
r_int
)paren
id|arg
op_eq
l_int|0x404
)paren
id|MoxaDriverInit
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|MOXA_GETDATACOUNT
suffix:colon
id|moxaLog.tick
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|moxaLog
comma
r_sizeof
(paren
id|mon_st
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|MOXA_FLUSH_QUEUE
suffix:colon
id|MoxaPortFlushData
c_func
(paren
id|port
comma
id|arg
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|MOXA_GET_IOQUEUE
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|moxaChkPort
(braket
id|i
)braket
)paren
(brace
id|temp_queue
(braket
id|i
)braket
dot
id|inq
op_assign
id|MoxaPortRxQueue
c_func
(paren
id|i
)paren
suffix:semicolon
id|temp_queue
(braket
id|i
)braket
dot
id|outq
op_assign
id|MoxaPortTxQueue
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|temp_queue
comma
r_sizeof
(paren
r_struct
id|moxaq_str
)paren
op_star
id|MAX_PORTS
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|MOXA_LOAD_BIOS
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dltmp
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|dl_str
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|i
op_assign
id|moxaloadbios
c_func
(paren
id|dltmp.cardno
comma
id|dltmp.buf
comma
id|dltmp.len
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
r_case
id|MOXA_FIND_BOARD
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dltmp
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|dl_str
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|moxafindcard
c_func
(paren
id|dltmp.cardno
)paren
suffix:semicolon
r_case
id|MOXA_LOAD_C320B
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dltmp
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|dl_str
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|moxaload320b
c_func
(paren
id|dltmp.cardno
comma
id|dltmp.buf
comma
id|dltmp.len
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_case
id|MOXA_LOAD_CODE
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dltmp
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|dl_str
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|i
op_assign
id|moxaloadcode
c_func
(paren
id|dltmp.cardno
comma
id|dltmp.buf
comma
id|dltmp.len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
r_case
id|MOXA_GET_OQUEUE
suffix:colon
id|i
op_assign
id|MoxaPortTxQueue
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|i
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|MOXA_GET_IQUEUE
suffix:colon
id|i
op_assign
id|MoxaPortRxQueue
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|i
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|MOXA_GET_MAJOR
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|ttymajor
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|MOXA_GET_CUMAJOR
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|calloutmajor
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|MOXA_GETMSTATUS
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|GMStatus
(braket
id|i
)braket
dot
id|ri
op_assign
l_int|0
suffix:semicolon
id|GMStatus
(braket
id|i
)braket
dot
id|dcd
op_assign
l_int|0
suffix:semicolon
id|GMStatus
(braket
id|i
)braket
dot
id|dsr
op_assign
l_int|0
suffix:semicolon
id|GMStatus
(braket
id|i
)braket
dot
id|cts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|moxaChkPort
(braket
id|i
)braket
)paren
(brace
r_continue
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|MoxaPortLineStatus
c_func
(paren
id|moxaChannels
(braket
id|i
)braket
dot
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|1
)paren
id|GMStatus
(braket
id|i
)braket
dot
id|cts
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|2
)paren
id|GMStatus
(braket
id|i
)braket
dot
id|dsr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|4
)paren
id|GMStatus
(braket
id|i
)braket
dot
id|dcd
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|moxaChannels
(braket
id|i
)braket
dot
id|tty
op_logical_or
op_logical_neg
id|moxaChannels
(braket
id|i
)braket
dot
id|tty-&gt;termios
)paren
id|GMStatus
(braket
id|i
)braket
dot
id|cflag
op_assign
id|moxaChannels
(braket
id|i
)braket
dot
id|normal_termios.c_cflag
suffix:semicolon
r_else
id|GMStatus
(braket
id|i
)braket
dot
id|cflag
op_assign
id|moxaChannels
(braket
id|i
)braket
dot
id|tty-&gt;termios-&gt;c_cflag
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|GMStatus
comma
r_sizeof
(paren
r_struct
id|mxser_mstatus
)paren
op_star
id|MAX_PORTS
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
(paren
op_minus
id|ENOIOCTLCMD
)paren
suffix:semicolon
)brace
DECL|function|MoxaDriverPoll
r_int
id|MoxaDriverPoll
c_func
(paren
r_void
)paren
(brace
r_register
id|ushort
id|temp
suffix:semicolon
r_register
r_int
id|card
suffix:semicolon
r_int
r_int
id|ip
comma
id|ofsAddr
suffix:semicolon
r_int
id|port
comma
id|p
comma
id|ports
suffix:semicolon
r_if
c_cond
(paren
id|moxaCard
op_eq
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|card
op_assign
l_int|0
suffix:semicolon
id|card
OL
id|MAX_BOARDS
suffix:semicolon
id|card
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ports
op_assign
id|moxa_boards
(braket
id|card
)braket
dot
id|numPorts
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|moxaIntPend
(braket
id|card
)braket
)paren
op_eq
l_int|0xff
)paren
(brace
id|ip
op_assign
id|moxaIntTable
(braket
id|card
)braket
op_plus
id|readb
c_func
(paren
id|moxaIntNdx
(braket
id|card
)braket
)paren
suffix:semicolon
id|p
op_assign
id|card
op_star
id|MAX_PORTS_PER_BOARD
suffix:semicolon
id|ports
op_lshift_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
id|ports
suffix:semicolon
id|port
op_add_assign
l_int|2
comma
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|temp
op_assign
id|readw
c_func
(paren
id|ip
op_plus
id|port
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|writew
c_func
(paren
l_int|0
comma
id|ip
op_plus
id|port
)paren
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|p
)braket
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|IntrTx
)paren
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|HostStat
)paren
op_amp
op_complement
id|WakeupTx
comma
id|ofsAddr
op_plus
id|HostStat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_amp
id|IntrBreak
)paren
(brace
id|moxaBreakCnt
(braket
id|p
)braket
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|temp
op_amp
id|IntrLine
)paren
(brace
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ofsAddr
op_plus
id|FlagStat
)paren
op_amp
id|DCD_state
)paren
(brace
r_if
c_cond
(paren
(paren
id|moxaDCDState
(braket
id|p
)braket
op_amp
id|DCD_oldstate
)paren
op_eq
l_int|0
)paren
id|moxaDCDState
(braket
id|p
)braket
op_assign
(paren
id|DCD_oldstate
op_or
id|DCD_changed
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|moxaDCDState
(braket
id|p
)braket
op_amp
id|DCD_oldstate
)paren
id|moxaDCDState
(braket
id|p
)braket
op_assign
id|DCD_changed
suffix:semicolon
)brace
)brace
)brace
)brace
id|writeb
c_func
(paren
l_int|0
comma
id|moxaIntPend
(braket
id|card
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|moxaLowWaterChk
)paren
(brace
id|p
op_assign
id|card
op_star
id|MAX_PORTS_PER_BOARD
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
id|ports
suffix:semicolon
id|port
op_increment
comma
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|moxaLowChkFlag
(braket
id|p
)braket
)paren
(brace
id|moxaLowChkFlag
(braket
id|p
)braket
op_assign
l_int|0
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|p
)braket
suffix:semicolon
id|low_water_check
c_func
(paren
id|ofsAddr
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|moxaLowWaterChk
op_assign
l_int|0
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&t;Card level function:&t;&t;&t;&t;&t;&t;     *&n; *&t;1. MoxaPortsOfCard(int cardno); &t;&t;&t;&t;     *&n; *****************************************************************************/
DECL|function|MoxaPortsOfCard
r_int
id|MoxaPortsOfCard
c_func
(paren
r_int
id|cardno
)paren
(brace
r_if
c_cond
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|boardType
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|numPorts
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&t;Port level functions:&t;&t;&t;&t;&t;&t;     *&n; *&t;1.  MoxaPortIsValid(int port);&t;&t;&t;&t;&t;     *&n; *&t;2.  MoxaPortEnable(int port);&t;&t;&t;&t;&t;     *&n; *&t;3.  MoxaPortDisable(int port);&t;&t;&t;&t;&t;     *&n; *&t;4.  MoxaPortGetMaxBaud(int port);&t;&t;&t;&t;     *&n; *&t;5.  MoxaPortGetCurBaud(int port);&t;&t;&t;&t;     *&n; *&t;6.  MoxaPortSetBaud(int port, long baud);&t;&t;&t;     *&n; *&t;7.  MoxaPortSetMode(int port, int databit, int stopbit, int parity); *&n; *&t;8.  MoxaPortSetTermio(int port, unsigned char *termio); &t;     *&n; *&t;9.  MoxaPortGetLineOut(int port, int *dtrState, int *rtsState);      *&n; *&t;10. MoxaPortLineCtrl(int port, int dtrState, int rtsState);&t;     *&n; *&t;11. MoxaPortFlowCtrl(int port, int rts, int cts, int rx, int tx,int xany);    *&n; *&t;12. MoxaPortLineStatus(int port);&t;&t;&t;&t;     *&n; *&t;13. MoxaPortDCDChange(int port);&t;&t;&t;&t;     *&n; *&t;14. MoxaPortDCDON(int port);&t;&t;&t;&t;&t;     *&n; *&t;15. MoxaPortFlushData(int port, int mode);&t;                     *&n; *&t;16. MoxaPortWriteData(int port, unsigned char * buffer, int length); *&n; *&t;17. MoxaPortReadData(int port, unsigned char * buffer, int length);  *&n; *&t;18. MoxaPortTxBufSize(int port);&t;&t;&t;&t;     *&n; *&t;19. MoxaPortRxBufSize(int port);&t;&t;&t;&t;     *&n; *&t;20. MoxaPortTxQueue(int port);&t;&t;&t;&t;&t;     *&n; *&t;21. MoxaPortTxFree(int port);&t;&t;&t;&t;&t;     *&n; *&t;22. MoxaPortRxQueue(int port);&t;&t;&t;&t;&t;     *&n; *&t;23. MoxaPortRxFree(int port);&t;&t;&t;&t;&t;     *&n; *&t;24. MoxaPortTxDisable(int port);&t;&t;&t;&t;     *&n; *&t;25. MoxaPortTxEnable(int port); &t;&t;&t;&t;     *&n; *&t;26. MoxaPortGetBrkCnt(int port);&t;&t;&t;&t;     *&n; *&t;27. MoxaPortResetBrkCnt(int port);&t;&t;&t;&t;     *&n; *&t;28. MoxaPortSetXonXoff(int port, int xonValue, int xoffValue);&t;     *&n; *&t;29. MoxaPortIsTxHold(int port); &t;&t;&t;&t;     *&n; *&t;30. MoxaPortSendBreak(int port, int ticks);&t;&t;&t;     *&n; *****************************************************************************/
multiline_comment|/*&n; *    Moxa Port Number Description:&n; *&n; *      MOXA serial driver supports up to 4 MOXA-C218/C320 boards. And,&n; *      the port number using in MOXA driver functions will be 0 to 31 for&n; *      first MOXA board, 32 to 63 for second, 64 to 95 for third and 96&n; *      to 127 for fourth. For example, if you setup three MOXA boards,&n; *      first board is C218, second board is C320-16 and third board is&n; *      C320-32. The port number of first board (C218 - 8 ports) is from&n; *      0 to 7. The port number of second board (C320 - 16 ports) is form&n; *      32 to 47. The port number of third board (C320 - 32 ports) is from&n; *      64 to 95. And those port numbers form 8 to 31, 48 to 63 and 96 to&n; *      127 will be invalid.&n; *&n; *&n; *      Moxa Functions Description:&n; *&n; *      Function 1:     Driver initialization routine, this routine must be&n; *                      called when initialized driver.&n; *      Syntax:&n; *      void MoxaDriverInit();&n; *&n; *&n; *      Function 2:     Moxa driver private IOCTL command processing.&n; *      Syntax:&n; *      int  MoxaDriverIoctl(unsigned int cmd, unsigned long arg, int port);&n; *&n; *           unsigned int cmd   : IOCTL command&n; *           unsigned long arg  : IOCTL argument&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    0  (OK)&n; *                      -EINVAL&n; *                      -ENOIOCTLCMD&n; *&n; *&n; *      Function 3:     Moxa driver polling process routine.&n; *      Syntax:&n; *      int  MoxaDriverPoll(void);&n; *&n; *           return:    0       ; polling O.K.&n; *                      -1      : no any Moxa card.             &n; *&n; *&n; *      Function 4:     Get the ports of this card.&n; *      Syntax:&n; *      int  MoxaPortsOfCard(int cardno);&n; *&n; *           int cardno         : card number (0 - 3)&n; *&n; *           return:    0       : this card is invalid&n; *                      8/16/24/32&n; *&n; *&n; *      Function 5:     Check this port is valid or invalid&n; *      Syntax:&n; *      int  MoxaPortIsValid(int port);&n; *           int port           : port number (0 - 127, ref port description)&n; *&n; *           return:    0       : this port is invalid&n; *                      1       : this port is valid&n; *&n; *&n; *      Function 6:     Enable this port to start Tx/Rx data.&n; *      Syntax:&n; *      void MoxaPortEnable(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *&n; *      Function 7:     Disable this port&n; *      Syntax:&n; *      void MoxaPortDisable(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *&n; *      Function 8:     Get the maximun available baud rate of this port.&n; *      Syntax:&n; *      long MoxaPortGetMaxBaud(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    0       : this port is invalid&n; *                      38400/57600/115200 bps&n; *&n; *&n; *      Function 9:     Get the current baud rate of this port.&n; *      Syntax:&n; *      long MoxaPortGetCurBaud(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    0       : this port is invalid&n; *                      50 - 115200 bps&n; *&n; *&n; *      Function 10:    Setting baud rate of this port.&n; *      Syntax:&n; *      long MoxaPortSetBaud(int port, long baud);&n; *           int port           : port number (0 - 127)&n; *           long baud          : baud rate (50 - 115200)&n; *&n; *           return:    0       : this port is invalid or baud &lt; 50&n; *                      50 - 115200 : the real baud rate set to the port, if&n; *                                    the argument baud is large than maximun&n; *                                    available baud rate, the real setting&n; *                                    baud rate will be the maximun baud rate.&n; *&n; *&n; *      Function 11:    Setting the data-bits/stop-bits/parity of this port&n; *      Syntax:&n; *      int  MoxaPortSetMode(int port, int databits, int stopbits, int parity);&n; *           int port           : port number (0 - 127)&n; *           int databits       : data bits (8/7/6/5)&n; *           int stopbits       : stop bits (2/1/0, 0 show 1.5 stop bits)&n; int parity     : parity (0:None,1:Odd,2:Even,3:Mark,4:Space)&n; *&n; *           return:    -1      : invalid parameter&n; *                      0       : setting O.K.&n; *&n; *&n; *      Function 12:    Configure the port.&n; *      Syntax:&n; *      int  MoxaPortSetTermio(int port, struct termios *termio);&n; *           int port           : port number (0 - 127)&n; *           struct termios * termio : termio structure pointer&n; *&n; *           return:    -1      : this port is invalid or termio == NULL&n; *                      0       : setting O.K.&n; *&n; *&n; *      Function 13:    Get the DTR/RTS state of this port.&n; *      Syntax:&n; *      int  MoxaPortGetLineOut(int port, int *dtrState, int *rtsState);&n; *           int port           : port number (0 - 127)&n; *           int * dtrState     : pointer to INT to receive the current DTR&n; *                                state. (if NULL, this function will not&n; *                                write to this address)&n; *           int * rtsState     : pointer to INT to receive the current RTS&n; *                                state. (if NULL, this function will not&n; *                                write to this address)&n; *&n; *           return:    -1      : this port is invalid&n; *                      0       : O.K.&n; *&n; *&n; *      Function 14:    Setting the DTR/RTS output state of this port.&n; *      Syntax:&n; *      void MoxaPortLineCtrl(int port, int dtrState, int rtsState);&n; *           int port           : port number (0 - 127)&n; *           int dtrState       : DTR output state (0: off, 1: on)&n; *           int rtsState       : RTS output state (0: off, 1: on)&n; *&n; *&n; *      Function 15:    Setting the flow control of this port.&n; *      Syntax:&n; *      void MoxaPortFlowCtrl(int port, int rtsFlow, int ctsFlow, int rxFlow,&n; *                            int txFlow,int xany);&n; *           int port           : port number (0 - 127)&n; *           int rtsFlow        : H/W RTS flow control (0: no, 1: yes)&n; *           int ctsFlow        : H/W CTS flow control (0: no, 1: yes)&n; *           int rxFlow         : S/W Rx XON/XOFF flow control (0: no, 1: yes)&n; *           int txFlow         : S/W Tx XON/XOFF flow control (0: no, 1: yes)&n; *           int xany           : S/W XANY flow control (0: no, 1: yes)&n; *&n; *&n; *      Function 16:    Get ths line status of this port&n; *      Syntax:&n; *      int  MoxaPortLineStatus(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    Bit 0 - CTS state (0: off, 1: on)&n; *                      Bit 1 - DSR state (0: off, 1: on)&n; *                      Bit 2 - DCD state (0: off, 1: on)&n; *&n; *&n; *      Function 17:    Check the DCD state has changed since the last read&n; *                      of this function.&n; *      Syntax:&n; *      int  MoxaPortDCDChange(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    0       : no changed&n; *                      1       : DCD has changed&n; *&n; *&n; *      Function 18:    Check ths current DCD state is ON or not.&n; *      Syntax:&n; *      int  MoxaPortDCDON(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    0       : DCD off&n; *                      1       : DCD on&n; *&n; *&n; *      Function 19:    Flush the Rx/Tx buffer data of this port.&n; *      Syntax:&n; *      void MoxaPortFlushData(int port, int mode);&n; *           int port           : port number (0 - 127)&n; *           int mode    &n; *                      0       : flush the Rx buffer &n; *                      1       : flush the Tx buffer &n; *                      2       : flush the Rx and Tx buffer &n; *&n; *&n; *      Function 20:    Write data.&n; *      Syntax:&n; *      int  MoxaPortWriteData(int port, unsigned char * buffer, int length);&n; *           int port           : port number (0 - 127)&n; *           unsigned char * buffer     : pointer to write data buffer.&n; *           int length         : write data length&n; *&n; *           return:    0 - length      : real write data length&n; *&n; *&n; *      Function 21:    Read data.&n; *      Syntax:&n; *      int  MoxaPortReadData(int port, unsigned char * buffer, int length);&n; *           int port           : port number (0 - 127)&n; *           unsigned char * buffer     : pointer to read data buffer.&n; *           int length         : read data buffer length&n; *&n; *           return:    0 - length      : real read data length&n; *&n; *&n; *      Function 22:    Get the Tx buffer size of this port&n; *      Syntax:&n; *      int  MoxaPortTxBufSize(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    ..      : Tx buffer size&n; *&n; *&n; *      Function 23:    Get the Rx buffer size of this port&n; *      Syntax:&n; *      int  MoxaPortRxBufSize(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    ..      : Rx buffer size&n; *&n; *&n; *      Function 24:    Get the Tx buffer current queued data bytes&n; *      Syntax:&n; *      int  MoxaPortTxQueue(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    ..      : Tx buffer current queued data bytes&n; *&n; *&n; *      Function 25:    Get the Tx buffer current free space&n; *      Syntax:&n; *      int  MoxaPortTxFree(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    ..      : Tx buffer current free space&n; *&n; *&n; *      Function 26:    Get the Rx buffer current queued data bytes&n; *      Syntax:&n; *      int  MoxaPortRxQueue(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    ..      : Rx buffer current queued data bytes&n; *&n; *&n; *      Function 27:    Get the Rx buffer current free space&n; *      Syntax:&n; *      int  MoxaPortRxFree(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    ..      : Rx buffer current free space&n; *&n; *&n; *      Function 28:    Disable port data transmission.&n; *      Syntax:&n; *      void MoxaPortTxDisable(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *&n; *      Function 29:    Enable port data transmission.&n; *      Syntax:&n; *      void MoxaPortTxEnable(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *&n; *      Function 30:    Get the received BREAK signal count.&n; *      Syntax:&n; *      int  MoxaPortGetBrkCnt(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    0 - ..  : BREAK signal count&n; *&n; *&n; *      Function 31:    Get the received BREAK signal count and reset it.&n; *      Syntax:&n; *      int  MoxaPortResetBrkCnt(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    0 - ..  : BREAK signal count&n; *&n; *&n; *      Function 32:    Set the S/W flow control new XON/XOFF value, default&n; *                      XON is 0x11 &amp; XOFF is 0x13.&n; *      Syntax:&n; *      void MoxaPortSetXonXoff(int port, int xonValue, int xoffValue);&n; *           int port           : port number (0 - 127)&n; *           int xonValue       : new XON value (0 - 255)&n; *           int xoffValue      : new XOFF value (0 - 255)&n; *&n; *&n; *      Function 33:    Check this port&squot;s transmission is hold by remote site&n; *                      because the flow control.&n; *      Syntax:&n; *      int  MoxaPortIsTxHold(int port);&n; *           int port           : port number (0 - 127)&n; *&n; *           return:    0       : normal&n; *                      1       : hold by remote site&n; *&n; *&n; *      Function 34:    Send out a BREAK signal.&n; *      Syntax:&n; *      void MoxaPortSendBreak(int port, int ms100);&n; *           int port           : port number (0 - 127)&n; *           int ms100          : break signal time interval.&n; *                                unit: 100 mini-second. if ms100 == 0, it will&n; *                                send out a about 250 ms BREAK signal.&n; *&n; */
DECL|function|MoxaPortIsValid
r_int
id|MoxaPortIsValid
c_func
(paren
r_int
id|port
)paren
(brace
r_if
c_cond
(paren
id|moxaCard
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|moxaChkPort
(braket
id|port
)braket
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortEnable
r_void
id|MoxaPortEnable
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_int
id|MoxaPortLineStatus
c_func
(paren
r_int
)paren
suffix:semicolon
r_int
id|lowwater
op_assign
l_int|512
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|writew
c_func
(paren
id|lowwater
comma
id|ofsAddr
op_plus
id|Low_water
)paren
suffix:semicolon
id|moxaBreakCnt
(braket
id|port
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_ISA
)paren
op_logical_or
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_PCI
)paren
)paren
(brace
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetBreakIrq
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|HostStat
)paren
op_or
id|WakeupBreak
comma
id|ofsAddr
op_plus
id|HostStat
)paren
suffix:semicolon
)brace
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetLineIrq
comma
id|Magic_code
)paren
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_FlushQueue
comma
l_int|2
)paren
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_EnableCH
comma
id|Magic_code
)paren
suffix:semicolon
id|MoxaPortLineStatus
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortDisable
r_void
id|MoxaPortDisable
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetFlowCtl
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable flow control */
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_ClrLineIrq
comma
id|Magic_code
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|ofsAddr
op_plus
id|HostStat
)paren
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_DisableCH
comma
id|Magic_code
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortGetMaxBaud
r_int
id|MoxaPortGetMaxBaud
c_func
(paren
r_int
id|port
)paren
(brace
r_if
c_cond
(paren
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_ISA
)paren
op_logical_or
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_PCI
)paren
)paren
r_return
(paren
l_int|460800L
)paren
suffix:semicolon
r_else
r_return
(paren
l_int|921600L
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortSetBaud
r_int
id|MoxaPortSetBaud
c_func
(paren
r_int
id|port
comma
r_int
id|baud
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_int
id|max
comma
id|clock
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
(paren
id|baud
OL
l_int|50L
)paren
op_logical_or
(paren
(paren
id|max
op_assign
id|MoxaPortGetMaxBaud
c_func
(paren
id|port
)paren
)paren
op_eq
l_int|0
)paren
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|baud
OG
id|max
)paren
id|baud
op_assign
id|max
suffix:semicolon
r_if
c_cond
(paren
id|max
op_eq
l_int|38400L
)paren
id|clock
op_assign
l_int|614400L
suffix:semicolon
multiline_comment|/* for 9.8304 Mhz : max. 38400 bps */
r_else
r_if
c_cond
(paren
id|max
op_eq
l_int|57600L
)paren
id|clock
op_assign
l_int|691200L
suffix:semicolon
multiline_comment|/* for 11.0592 Mhz : max. 57600 bps */
r_else
id|clock
op_assign
l_int|921600L
suffix:semicolon
multiline_comment|/* for 14.7456 Mhz : max. 115200 bps */
id|val
op_assign
id|clock
op_div
id|baud
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetBaud
comma
id|val
)paren
suffix:semicolon
id|baud
op_assign
id|clock
op_div
id|val
suffix:semicolon
id|moxaCurBaud
(braket
id|port
)braket
op_assign
id|baud
suffix:semicolon
r_return
(paren
id|baud
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortSetTermio
r_int
id|MoxaPortSetTermio
c_func
(paren
r_int
id|port
comma
r_struct
id|termios
op_star
id|termio
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|tcflag_t
id|cflag
suffix:semicolon
r_int
id|baud
suffix:semicolon
id|tcflag_t
id|mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|moxaChkPort
(braket
id|port
)braket
op_eq
l_int|0
op_logical_or
id|termio
op_eq
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|cflag
op_assign
id|termio-&gt;c_cflag
suffix:semicolon
multiline_comment|/* termio-&gt;c_cflag */
id|mode
op_assign
id|termio-&gt;c_cflag
op_amp
id|CSIZE
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
id|CS5
)paren
id|mode
op_assign
id|MX_CS5
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mode
op_eq
id|CS6
)paren
id|mode
op_assign
id|MX_CS6
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mode
op_eq
id|CS7
)paren
id|mode
op_assign
id|MX_CS7
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mode
op_eq
id|CS8
)paren
id|mode
op_assign
id|MX_CS8
suffix:semicolon
r_if
c_cond
(paren
id|termio-&gt;c_cflag
op_amp
id|CSTOPB
)paren
(brace
r_if
c_cond
(paren
id|mode
op_eq
id|MX_CS5
)paren
id|mode
op_or_assign
id|MX_STOP15
suffix:semicolon
r_else
id|mode
op_or_assign
id|MX_STOP2
suffix:semicolon
)brace
r_else
id|mode
op_or_assign
id|MX_STOP1
suffix:semicolon
r_if
c_cond
(paren
id|termio-&gt;c_cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|termio-&gt;c_cflag
op_amp
id|PARODD
)paren
id|mode
op_or_assign
id|MX_PARODD
suffix:semicolon
r_else
id|mode
op_or_assign
id|MX_PAREVEN
suffix:semicolon
)brace
r_else
id|mode
op_or_assign
id|MX_PARNONE
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetDataMode
comma
(paren
id|ushort
)paren
id|mode
)paren
suffix:semicolon
id|cflag
op_and_assign
(paren
id|CBAUD
op_or
id|CBAUDEX
)paren
suffix:semicolon
macro_line|#ifndef B921600
DECL|macro|B921600
mdefine_line|#define&t;B921600&t;(B460800+1)
macro_line|#endif
r_switch
c_cond
(paren
id|cflag
)paren
(brace
r_case
id|B921600
suffix:colon
id|baud
op_assign
l_int|921600L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B460800
suffix:colon
id|baud
op_assign
l_int|460800L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B230400
suffix:colon
id|baud
op_assign
l_int|230400L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|baud
op_assign
l_int|115200L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|baud
op_assign
l_int|57600L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|baud
op_assign
l_int|38400L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|baud
op_assign
l_int|19200L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B9600
suffix:colon
id|baud
op_assign
l_int|9600L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|baud
op_assign
l_int|4800L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|baud
op_assign
l_int|2400L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1800
suffix:colon
id|baud
op_assign
l_int|1800L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|baud
op_assign
l_int|1200L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|baud
op_assign
l_int|600L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B300
suffix:colon
id|baud
op_assign
l_int|300L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B200
suffix:colon
id|baud
op_assign
l_int|200L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B150
suffix:colon
id|baud
op_assign
l_int|150L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B134
suffix:colon
id|baud
op_assign
l_int|134L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B110
suffix:colon
id|baud
op_assign
l_int|110L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B75
suffix:colon
id|baud
op_assign
l_int|75L
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B50
suffix:colon
id|baud
op_assign
l_int|50L
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|baud
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_ISA
)paren
op_logical_or
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_PCI
)paren
)paren
(brace
r_if
c_cond
(paren
id|baud
op_eq
l_int|921600L
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|MoxaPortSetBaud
c_func
(paren
id|port
comma
id|baud
)paren
suffix:semicolon
r_if
c_cond
(paren
id|termio-&gt;c_iflag
op_amp
(paren
id|IXON
op_or
id|IXOFF
op_or
id|IXANY
)paren
)paren
(brace
id|writeb
c_func
(paren
id|termio-&gt;c_cc
(braket
id|VSTART
)braket
comma
id|ofsAddr
op_plus
id|FuncArg
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|termio-&gt;c_cc
(braket
id|VSTOP
)braket
comma
id|ofsAddr
op_plus
id|FuncArg1
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|FC_SetXonXoff
comma
id|ofsAddr
op_plus
id|FuncCode
)paren
suffix:semicolon
id|wait_finish
c_func
(paren
id|ofsAddr
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortGetLineOut
r_int
id|MoxaPortGetLineOut
c_func
(paren
r_int
id|port
comma
r_int
op_star
id|dtrState
comma
r_int
op_star
id|rtsState
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|MoxaPortIsValid
c_func
(paren
id|port
)paren
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dtrState
)paren
(brace
r_if
c_cond
(paren
id|moxaLineCtrl
(braket
id|port
)braket
op_amp
id|DTR_ON
)paren
op_star
id|dtrState
op_assign
l_int|1
suffix:semicolon
r_else
op_star
id|dtrState
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rtsState
)paren
(brace
r_if
c_cond
(paren
id|moxaLineCtrl
(braket
id|port
)braket
op_amp
id|RTS_ON
)paren
op_star
id|rtsState
op_assign
l_int|1
suffix:semicolon
r_else
op_star
id|rtsState
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortLineCtrl
r_void
id|MoxaPortLineCtrl
c_func
(paren
r_int
id|port
comma
r_int
id|dtr
comma
r_int
id|rts
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_int
id|mode
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dtr
)paren
id|mode
op_or_assign
id|DTR_ON
suffix:semicolon
r_if
c_cond
(paren
id|rts
)paren
id|mode
op_or_assign
id|RTS_ON
suffix:semicolon
id|moxaLineCtrl
(braket
id|port
)braket
op_assign
id|mode
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_LineControl
comma
id|mode
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortFlowCtrl
r_void
id|MoxaPortFlowCtrl
c_func
(paren
r_int
id|port
comma
r_int
id|rts
comma
r_int
id|cts
comma
r_int
id|txflow
comma
r_int
id|rxflow
comma
r_int
id|txany
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_int
id|mode
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rts
)paren
id|mode
op_or_assign
id|RTS_FlowCtl
suffix:semicolon
r_if
c_cond
(paren
id|cts
)paren
id|mode
op_or_assign
id|CTS_FlowCtl
suffix:semicolon
r_if
c_cond
(paren
id|txflow
)paren
id|mode
op_or_assign
id|Tx_FlowCtl
suffix:semicolon
r_if
c_cond
(paren
id|rxflow
)paren
id|mode
op_or_assign
id|Rx_FlowCtl
suffix:semicolon
r_if
c_cond
(paren
id|txany
)paren
id|mode
op_or_assign
id|IXM_IXANY
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetFlowCtl
comma
id|mode
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortLineStatus
r_int
id|MoxaPortLineStatus
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_int
id|val
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_ISA
)paren
op_logical_or
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_PCI
)paren
)paren
(brace
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_LineStatus
comma
l_int|0
)paren
suffix:semicolon
id|val
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|FuncArg
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|FlagStat
)paren
op_rshift
l_int|4
suffix:semicolon
)brace
id|val
op_and_assign
l_int|0x0B
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
l_int|8
)paren
(brace
id|val
op_or_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
(paren
id|moxaDCDState
(braket
id|port
)braket
op_amp
id|DCD_oldstate
)paren
op_eq
l_int|0
)paren
id|moxaDCDState
(braket
id|port
)braket
op_assign
(paren
id|DCD_oldstate
op_or
id|DCD_changed
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|moxaDCDState
(braket
id|port
)braket
op_amp
id|DCD_oldstate
)paren
id|moxaDCDState
(braket
id|port
)braket
op_assign
id|DCD_changed
suffix:semicolon
)brace
id|val
op_and_assign
l_int|7
suffix:semicolon
r_return
(paren
id|val
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortDCDChange
r_int
id|MoxaPortDCDChange
c_func
(paren
r_int
id|port
)paren
(brace
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
id|moxaChkPort
(braket
id|port
)braket
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|n
op_assign
id|moxaDCDState
(braket
id|port
)braket
suffix:semicolon
id|moxaDCDState
(braket
id|port
)braket
op_and_assign
op_complement
id|DCD_changed
suffix:semicolon
id|n
op_and_assign
id|DCD_changed
suffix:semicolon
r_return
(paren
id|n
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortDCDON
r_int
id|MoxaPortDCDON
c_func
(paren
r_int
id|port
)paren
(brace
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
id|moxaChkPort
(braket
id|port
)braket
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|moxaDCDState
(braket
id|port
)braket
op_amp
id|DCD_oldstate
)paren
id|n
op_assign
l_int|1
suffix:semicolon
r_else
id|n
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|n
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   int MoxaDumpMem(int port, unsigned char * buffer, int len)&n;   {&n;   int          i;&n;   unsigned long                baseAddr,ofsAddr,ofs;&n;&n;   baseAddr = moxaBaseAddr[port / MAX_PORTS_PER_BOARD];&n;   ofs = baseAddr + DynPage_addr + pageofs;&n;   if (len &gt; 0x2000L)&n;   len = 0x2000L;&n;   for (i = 0; i &lt; len; i++)&n;   buffer[i] = readb(ofs+i);&n;   }&n; */
DECL|function|MoxaPortWriteData
r_int
id|MoxaPortWriteData
c_func
(paren
r_int
id|port
comma
r_int
r_char
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_int
id|c
comma
id|total
comma
id|i
suffix:semicolon
id|ushort
id|tail
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|ushort
id|head
comma
id|tx_mask
comma
id|spage
comma
id|epage
suffix:semicolon
id|ushort
id|pageno
comma
id|pageofs
comma
id|bufhead
suffix:semicolon
r_int
r_int
id|baseAddr
comma
id|ofsAddr
comma
id|ofs
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|baseAddr
op_assign
id|moxaBaseAddr
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
suffix:semicolon
id|tx_mask
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TX_mask
)paren
suffix:semicolon
id|spage
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_txb
)paren
suffix:semicolon
id|epage
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|EndPage_txb
)paren
suffix:semicolon
id|tail
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TXwptr
)paren
suffix:semicolon
id|head
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TXrptr
)paren
suffix:semicolon
id|c
op_assign
(paren
id|head
OG
id|tail
)paren
ques
c_cond
(paren
id|head
op_minus
id|tail
op_minus
l_int|1
)paren
suffix:colon
(paren
id|head
op_minus
id|tail
op_plus
id|tx_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
OG
id|len
)paren
id|c
op_assign
id|len
suffix:semicolon
id|moxaLog.txcnt
(braket
id|port
)braket
op_add_assign
id|c
suffix:semicolon
id|total
op_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|spage
op_eq
id|epage
)paren
(brace
id|bufhead
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Ofs_txb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|spage
comma
id|baseAddr
op_plus
id|Control_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
id|c
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|head
OG
id|tail
)paren
id|len
op_assign
id|head
op_minus
id|tail
op_minus
l_int|1
suffix:semicolon
r_else
id|len
op_assign
id|tx_mask
op_plus
l_int|1
op_minus
id|tail
suffix:semicolon
id|len
op_assign
(paren
id|c
OG
id|len
)paren
ques
c_cond
id|len
suffix:colon
id|c
suffix:semicolon
id|ofs
op_assign
id|baseAddr
op_plus
id|DynPage_addr
op_plus
id|bufhead
op_plus
id|tail
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
op_star
id|buffer
op_increment
comma
id|ofs
op_plus
id|i
)paren
suffix:semicolon
id|tail
op_assign
(paren
id|tail
op_plus
id|len
)paren
op_amp
id|tx_mask
suffix:semicolon
id|c
op_sub_assign
id|len
suffix:semicolon
)brace
id|writew
c_func
(paren
id|tail
comma
id|ofsAddr
op_plus
id|TXwptr
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|c
suffix:semicolon
id|pageno
op_assign
id|spage
op_plus
(paren
id|tail
op_rshift
l_int|13
)paren
suffix:semicolon
id|pageofs
op_assign
id|tail
op_amp
id|Page_mask
suffix:semicolon
r_do
(brace
id|cnt
op_assign
id|Page_size
op_minus
id|pageofs
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|c
)paren
id|cnt
op_assign
id|c
suffix:semicolon
id|c
op_sub_assign
id|cnt
suffix:semicolon
id|writeb
c_func
(paren
id|pageno
comma
id|baseAddr
op_plus
id|Control_reg
)paren
suffix:semicolon
id|ofs
op_assign
id|baseAddr
op_plus
id|DynPage_addr
op_plus
id|pageofs
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
op_star
id|buffer
op_increment
comma
id|ofs
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|0
)paren
(brace
id|writew
c_func
(paren
(paren
id|tail
op_plus
id|len
)paren
op_amp
id|tx_mask
comma
id|ofsAddr
op_plus
id|TXwptr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|pageno
op_eq
id|epage
)paren
id|pageno
op_assign
id|spage
suffix:semicolon
id|pageofs
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
l_int|1
comma
id|ofsAddr
op_plus
id|CD180TXirq
)paren
suffix:semicolon
multiline_comment|/* start to send */
r_return
(paren
id|total
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortReadData
r_int
id|MoxaPortReadData
c_func
(paren
r_int
id|port
comma
r_int
r_char
op_star
id|buffer
comma
r_int
id|space
)paren
(brace
r_register
id|ushort
id|head
comma
id|pageofs
suffix:semicolon
r_int
id|i
comma
id|count
comma
id|cnt
comma
id|len
comma
id|total
comma
id|remain
suffix:semicolon
id|ushort
id|tail
comma
id|rx_mask
comma
id|spage
comma
id|epage
suffix:semicolon
id|ushort
id|pageno
comma
id|bufhead
suffix:semicolon
r_int
r_int
id|baseAddr
comma
id|ofsAddr
comma
id|ofs
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|baseAddr
op_assign
id|moxaBaseAddr
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
suffix:semicolon
id|head
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RXrptr
)paren
suffix:semicolon
id|tail
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RXwptr
)paren
suffix:semicolon
id|rx_mask
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
id|spage
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_rxb
)paren
suffix:semicolon
id|epage
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|EndPage_rxb
)paren
suffix:semicolon
id|count
op_assign
(paren
id|tail
op_ge
id|head
)paren
ques
c_cond
(paren
id|tail
op_minus
id|head
)paren
suffix:colon
(paren
id|tail
op_minus
id|head
op_plus
id|rx_mask
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
id|total
op_assign
(paren
id|space
OG
id|count
)paren
ques
c_cond
id|count
suffix:colon
id|space
suffix:semicolon
id|remain
op_assign
id|count
op_minus
id|total
suffix:semicolon
id|moxaLog.rxcnt
(braket
id|port
)braket
op_add_assign
id|total
suffix:semicolon
id|count
op_assign
id|total
suffix:semicolon
r_if
c_cond
(paren
id|spage
op_eq
id|epage
)paren
(brace
id|bufhead
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Ofs_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|spage
comma
id|baseAddr
op_plus
id|Control_reg
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tail
op_ge
id|head
)paren
id|len
op_assign
id|tail
op_minus
id|head
suffix:semicolon
r_else
id|len
op_assign
id|rx_mask
op_plus
l_int|1
op_minus
id|head
suffix:semicolon
id|len
op_assign
(paren
id|count
OG
id|len
)paren
ques
c_cond
id|len
suffix:colon
id|count
suffix:semicolon
id|ofs
op_assign
id|baseAddr
op_plus
id|DynPage_addr
op_plus
id|bufhead
op_plus
id|head
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
op_star
id|buffer
op_increment
op_assign
id|readb
c_func
(paren
id|ofs
op_plus
id|i
)paren
suffix:semicolon
id|head
op_assign
(paren
id|head
op_plus
id|len
)paren
op_amp
id|rx_mask
suffix:semicolon
id|count
op_sub_assign
id|len
suffix:semicolon
)brace
id|writew
c_func
(paren
id|head
comma
id|ofsAddr
op_plus
id|RXrptr
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|count
suffix:semicolon
id|pageno
op_assign
id|spage
op_plus
(paren
id|head
op_rshift
l_int|13
)paren
suffix:semicolon
id|pageofs
op_assign
id|head
op_amp
id|Page_mask
suffix:semicolon
r_do
(brace
id|cnt
op_assign
id|Page_size
op_minus
id|pageofs
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|writew
c_func
(paren
id|pageno
comma
id|baseAddr
op_plus
id|Control_reg
)paren
suffix:semicolon
id|ofs
op_assign
id|baseAddr
op_plus
id|DynPage_addr
op_plus
id|pageofs
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt
suffix:semicolon
id|i
op_increment
)paren
op_star
id|buffer
op_increment
op_assign
id|readb
c_func
(paren
id|ofs
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|writew
c_func
(paren
(paren
id|head
op_plus
id|len
)paren
op_amp
id|rx_mask
comma
id|ofsAddr
op_plus
id|RXrptr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_increment
id|pageno
op_eq
id|epage
)paren
id|pageno
op_assign
id|spage
suffix:semicolon
id|pageofs
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|readb
c_func
(paren
id|ofsAddr
op_plus
id|FlagStat
)paren
op_amp
id|Xoff_state
)paren
op_logical_and
(paren
id|remain
OL
id|LowWater
)paren
)paren
(brace
id|moxaLowWaterChk
op_assign
l_int|1
suffix:semicolon
id|moxaLowChkFlag
(braket
id|port
)braket
op_assign
l_int|1
suffix:semicolon
)brace
r_return
(paren
id|total
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortTxQueue
r_int
id|MoxaPortTxQueue
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|ushort
id|rptr
comma
id|wptr
comma
id|mask
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|rptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TXrptr
)paren
suffix:semicolon
id|wptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TXwptr
)paren
suffix:semicolon
id|mask
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TX_mask
)paren
suffix:semicolon
id|len
op_assign
(paren
id|wptr
op_minus
id|rptr
)paren
op_amp
id|mask
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortTxFree
r_int
id|MoxaPortTxFree
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|ushort
id|rptr
comma
id|wptr
comma
id|mask
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|rptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TXrptr
)paren
suffix:semicolon
id|wptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TXwptr
)paren
suffix:semicolon
id|mask
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TX_mask
)paren
suffix:semicolon
id|len
op_assign
id|mask
op_minus
(paren
(paren
id|wptr
op_minus
id|rptr
)paren
op_amp
id|mask
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortRxQueue
r_int
id|MoxaPortRxQueue
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|ushort
id|rptr
comma
id|wptr
comma
id|mask
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|rptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RXrptr
)paren
suffix:semicolon
id|wptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RXwptr
)paren
suffix:semicolon
id|mask
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
id|len
op_assign
(paren
id|wptr
op_minus
id|rptr
)paren
op_amp
id|mask
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortTxDisable
r_void
id|MoxaPortTxDisable
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetXoffState
comma
id|Magic_code
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortTxEnable
r_void
id|MoxaPortTxEnable
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetXonState
comma
id|Magic_code
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortResetBrkCnt
r_int
id|MoxaPortResetBrkCnt
c_func
(paren
r_int
id|port
)paren
(brace
id|ushort
id|cnt
suffix:semicolon
id|cnt
op_assign
id|moxaBreakCnt
(braket
id|port
)braket
suffix:semicolon
id|moxaBreakCnt
(braket
id|port
)braket
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|cnt
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortSendBreak
r_void
id|MoxaPortSendBreak
c_func
(paren
r_int
id|port
comma
r_int
id|ms100
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ms100
)paren
(brace
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SendBreak
comma
id|Magic_code
)paren
suffix:semicolon
id|moxadelay
c_func
(paren
id|ms100
op_star
(paren
id|HZ
op_div
l_int|10
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SendBreak
comma
id|Magic_code
)paren
suffix:semicolon
id|moxadelay
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* 250 ms */
)brace
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_StopBreak
comma
id|Magic_code
)paren
suffix:semicolon
)brace
DECL|function|moxa_get_serial_info
r_static
r_int
id|moxa_get_serial_info
c_func
(paren
r_struct
id|moxa_str
op_star
id|info
comma
r_struct
id|serial_struct
op_star
id|retinfo
)paren
(brace
r_struct
id|serial_struct
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retinfo
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tmp
comma
l_int|0
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|tmp.type
op_assign
id|info-&gt;type
suffix:semicolon
id|tmp.line
op_assign
id|info-&gt;port
suffix:semicolon
id|tmp.port
op_assign
l_int|0
suffix:semicolon
id|tmp.irq
op_assign
l_int|0
suffix:semicolon
id|tmp.flags
op_assign
id|info-&gt;asyncflags
suffix:semicolon
id|tmp.baud_base
op_assign
l_int|921600
suffix:semicolon
id|tmp.close_delay
op_assign
id|info-&gt;close_delay
suffix:semicolon
id|tmp.closing_wait
op_assign
id|info-&gt;closing_wait
suffix:semicolon
id|tmp.custom_divisor
op_assign
l_int|0
suffix:semicolon
id|tmp.hub6
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|retinfo
comma
op_amp
id|tmp
comma
r_sizeof
(paren
op_star
id|retinfo
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|moxa_set_serial_info
r_static
r_int
id|moxa_set_serial_info
c_func
(paren
r_struct
id|moxa_str
op_star
id|info
comma
r_struct
id|serial_struct
op_star
id|new_info
)paren
(brace
r_struct
id|serial_struct
id|new_serial
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|new_serial
comma
id|new_info
comma
r_sizeof
(paren
id|new_serial
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|new_serial.irq
op_ne
l_int|0
)paren
op_logical_or
(paren
id|new_serial.port
op_ne
l_int|0
)paren
op_logical_or
singleline_comment|//           (new_serial.type != info-&gt;type) ||
(paren
id|new_serial.custom_divisor
op_ne
l_int|0
)paren
op_logical_or
(paren
id|new_serial.baud_base
op_ne
l_int|921600
)paren
)paren
r_return
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|new_serial.flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
op_ne
(paren
id|info-&gt;asyncflags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
)paren
)paren
r_return
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;close_delay
op_assign
id|new_serial.close_delay
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|info-&gt;closing_wait
op_assign
id|new_serial.closing_wait
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
)brace
id|new_serial.flags
op_assign
(paren
id|new_serial.flags
op_amp
op_complement
id|ASYNC_FLAGS
)paren
suffix:semicolon
id|new_serial.flags
op_or_assign
(paren
id|info-&gt;asyncflags
op_amp
id|ASYNC_FLAGS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_serial.type
op_eq
id|PORT_16550A
)paren
(brace
id|MoxaSetFifo
c_func
(paren
id|info-&gt;port
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|MoxaSetFifo
c_func
(paren
id|info-&gt;port
comma
l_int|0
)paren
suffix:semicolon
)brace
id|info-&gt;type
op_assign
id|new_serial.type
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&t;Static local functions: &t;&t;&t;&t;&t;     *&n; *****************************************************************************/
multiline_comment|/*&n; * moxadelay - delays a specified number ticks&n; */
DECL|function|moxadelay
r_static
r_void
id|moxadelay
c_func
(paren
r_int
id|tick
)paren
(brace
r_int
r_int
id|st
comma
id|et
suffix:semicolon
id|st
op_assign
id|jiffies
suffix:semicolon
id|et
op_assign
id|st
op_plus
id|tick
suffix:semicolon
r_while
c_loop
(paren
id|jiffies
OL
id|et
)paren
suffix:semicolon
)brace
DECL|function|moxafunc
r_static
r_void
id|moxafunc
c_func
(paren
r_int
r_int
id|ofsAddr
comma
r_int
id|cmd
comma
id|ushort
id|arg
)paren
(brace
id|writew
c_func
(paren
id|arg
comma
id|ofsAddr
op_plus
id|FuncArg
)paren
suffix:semicolon
id|writew
c_func
(paren
id|cmd
comma
id|ofsAddr
op_plus
id|FuncCode
)paren
suffix:semicolon
id|wait_finish
c_func
(paren
id|ofsAddr
)paren
suffix:semicolon
)brace
DECL|function|wait_finish
r_static
r_void
id|wait_finish
c_func
(paren
r_int
r_int
id|ofsAddr
)paren
(brace
r_int
r_int
id|i
comma
id|j
suffix:semicolon
id|i
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|FuncCode
)paren
op_ne
l_int|0
)paren
(brace
id|j
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
(paren
id|j
op_minus
id|i
)paren
OG
id|moxaFuncTout
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
)brace
DECL|function|low_water_check
r_static
r_void
id|low_water_check
c_func
(paren
r_int
r_int
id|ofsAddr
)paren
(brace
r_int
id|len
suffix:semicolon
id|ushort
id|rptr
comma
id|wptr
comma
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|ofsAddr
op_plus
id|FlagStat
)paren
op_amp
id|Xoff_state
)paren
(brace
id|rptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RXrptr
)paren
suffix:semicolon
id|wptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RXwptr
)paren
suffix:semicolon
id|mask
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
id|len
op_assign
(paren
id|wptr
op_minus
id|rptr
)paren
op_amp
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|Low_water
)paren
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SendXon
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|moxaloadbios
r_static
r_int
id|moxaloadbios
c_func
(paren
r_int
id|cardno
comma
r_int
r_char
op_star
id|tmp
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|baseAddr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|moxaBuff
comma
id|tmp
comma
id|len
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|baseAddr
op_assign
id|moxaBaseAddr
(braket
id|cardno
)braket
suffix:semicolon
id|writeb
c_func
(paren
id|HW_reset
comma
id|baseAddr
op_plus
id|Control_reg
)paren
suffix:semicolon
multiline_comment|/* reset */
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* delay 10 ms */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4096
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* clear fix page */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
id|moxaBuff
(braket
id|i
)braket
comma
id|baseAddr
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* download BIOS */
id|writeb
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|Control_reg
)paren
suffix:semicolon
multiline_comment|/* restart */
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|moxafindcard
r_static
r_int
id|moxafindcard
c_func
(paren
r_int
id|cardno
)paren
(brace
r_int
r_int
id|baseAddr
suffix:semicolon
id|ushort
id|tmp
suffix:semicolon
id|baseAddr
op_assign
id|moxaBaseAddr
(braket
id|cardno
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|boardType
)paren
(brace
r_case
id|MOXA_BOARD_C218_ISA
suffix:colon
r_case
id|MOXA_BOARD_C218_PCI
suffix:colon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C218_key
)paren
)paren
op_ne
id|C218_KeyCode
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MOXA_BOARD_CP204J
suffix:colon
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C218_key
)paren
)paren
op_ne
id|CP204J_KeyCode
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C320_key
)paren
)paren
op_ne
id|C320_KeyCode
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tmp
op_assign
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C320_status
)paren
)paren
op_ne
id|STS_init
)paren
(brace
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|moxaload320b
r_static
r_int
id|moxaload320b
c_func
(paren
r_int
id|cardno
comma
r_int
r_char
op_star
id|tmp
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|baseAddr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|moxaBuff
comma
id|tmp
comma
id|len
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|baseAddr
op_assign
id|moxaBaseAddr
(braket
id|cardno
)braket
suffix:semicolon
id|writew
c_func
(paren
id|len
op_minus
l_int|7168
op_minus
l_int|2
comma
id|baseAddr
op_plus
id|C320bapi_len
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|1
comma
id|baseAddr
op_plus
id|Control_reg
)paren
suffix:semicolon
multiline_comment|/* Select Page 1 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|7168
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
id|moxaBuff
(braket
id|i
)braket
comma
id|baseAddr
op_plus
id|DynPage_addr
op_plus
id|i
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|2
comma
id|baseAddr
op_plus
id|Control_reg
)paren
suffix:semicolon
multiline_comment|/* Select Page 2 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|len
op_minus
l_int|7168
)paren
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
id|moxaBuff
(braket
id|i
op_plus
l_int|7168
)braket
comma
id|baseAddr
op_plus
id|DynPage_addr
op_plus
id|i
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|moxaloadcode
r_static
r_int
id|moxaloadcode
c_func
(paren
r_int
id|cardno
comma
r_int
r_char
op_star
id|tmp
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|baseAddr
comma
id|ofsAddr
suffix:semicolon
r_int
id|retval
comma
id|port
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|moxaBuff
comma
id|tmp
comma
id|len
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|baseAddr
op_assign
id|moxaBaseAddr
(braket
id|cardno
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|boardType
)paren
(brace
r_case
id|MOXA_BOARD_C218_ISA
suffix:colon
r_case
id|MOXA_BOARD_C218_PCI
suffix:colon
r_case
id|MOXA_BOARD_CP204J
suffix:colon
id|retval
op_assign
id|moxaloadc218
c_func
(paren
id|cardno
comma
id|baseAddr
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
(paren
id|retval
)paren
suffix:semicolon
id|port
op_assign
id|cardno
op_star
id|MAX_PORTS_PER_BOARD
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|moxa_boards
(braket
id|cardno
)braket
dot
id|numPorts
suffix:semicolon
id|i
op_increment
comma
id|port
op_increment
)paren
(brace
id|moxaChkPort
(braket
id|port
)braket
op_assign
l_int|1
suffix:semicolon
id|moxaCurBaud
(braket
id|port
)braket
op_assign
l_int|9600L
suffix:semicolon
id|moxaDCDState
(braket
id|port
)braket
op_assign
l_int|0
suffix:semicolon
id|moxaTableAddr
(braket
id|port
)braket
op_assign
id|baseAddr
op_plus
id|Extern_table
op_plus
id|Extern_size
op_star
id|i
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|writew
c_func
(paren
id|C218rx_mask
comma
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C218tx_mask
comma
id|ofsAddr
op_plus
id|TX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C218rx_spage
op_plus
id|i
op_star
id|C218buf_pageno
comma
id|ofsAddr
op_plus
id|Page_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_rxb
)paren
op_plus
id|C218rx_pageno
comma
id|ofsAddr
op_plus
id|EndPage_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C218tx_spage
op_plus
id|i
op_star
id|C218buf_pageno
comma
id|ofsAddr
op_plus
id|Page_txb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_txb
)paren
op_plus
id|C218tx_pageno
comma
id|ofsAddr
op_plus
id|EndPage_txb
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
id|moxaloadc320
c_func
(paren
id|cardno
comma
id|baseAddr
comma
id|len
comma
op_amp
id|moxa_boards
(braket
id|cardno
)braket
dot
id|numPorts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
(paren
id|retval
)paren
suffix:semicolon
id|port
op_assign
id|cardno
op_star
id|MAX_PORTS_PER_BOARD
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|moxa_boards
(braket
id|cardno
)braket
dot
id|numPorts
suffix:semicolon
id|i
op_increment
comma
id|port
op_increment
)paren
(brace
id|moxaChkPort
(braket
id|port
)braket
op_assign
l_int|1
suffix:semicolon
id|moxaCurBaud
(braket
id|port
)braket
op_assign
l_int|9600L
suffix:semicolon
id|moxaDCDState
(braket
id|port
)braket
op_assign
l_int|0
suffix:semicolon
id|moxaTableAddr
(braket
id|port
)braket
op_assign
id|baseAddr
op_plus
id|Extern_table
op_plus
id|Extern_size
op_star
id|i
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|numPorts
op_eq
l_int|8
)paren
(brace
id|writew
c_func
(paren
id|C320p8rx_mask
comma
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p8tx_mask
comma
id|ofsAddr
op_plus
id|TX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p8rx_spage
op_plus
id|i
op_star
id|C320p8buf_pgno
comma
id|ofsAddr
op_plus
id|Page_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_rxb
)paren
op_plus
id|C320p8rx_pgno
comma
id|ofsAddr
op_plus
id|EndPage_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p8tx_spage
op_plus
id|i
op_star
id|C320p8buf_pgno
comma
id|ofsAddr
op_plus
id|Page_txb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_txb
)paren
op_plus
id|C320p8tx_pgno
comma
id|ofsAddr
op_plus
id|EndPage_txb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|numPorts
op_eq
l_int|16
)paren
(brace
id|writew
c_func
(paren
id|C320p16rx_mask
comma
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p16tx_mask
comma
id|ofsAddr
op_plus
id|TX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p16rx_spage
op_plus
id|i
op_star
id|C320p16buf_pgno
comma
id|ofsAddr
op_plus
id|Page_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_rxb
)paren
op_plus
id|C320p16rx_pgno
comma
id|ofsAddr
op_plus
id|EndPage_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p16tx_spage
op_plus
id|i
op_star
id|C320p16buf_pgno
comma
id|ofsAddr
op_plus
id|Page_txb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_txb
)paren
op_plus
id|C320p16tx_pgno
comma
id|ofsAddr
op_plus
id|EndPage_txb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|numPorts
op_eq
l_int|24
)paren
(brace
id|writew
c_func
(paren
id|C320p24rx_mask
comma
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p24tx_mask
comma
id|ofsAddr
op_plus
id|TX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p24rx_spage
op_plus
id|i
op_star
id|C320p24buf_pgno
comma
id|ofsAddr
op_plus
id|Page_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_rxb
)paren
op_plus
id|C320p24rx_pgno
comma
id|ofsAddr
op_plus
id|EndPage_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p24tx_spage
op_plus
id|i
op_star
id|C320p24buf_pgno
comma
id|ofsAddr
op_plus
id|Page_txb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_txb
)paren
comma
id|ofsAddr
op_plus
id|EndPage_txb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|numPorts
op_eq
l_int|32
)paren
(brace
id|writew
c_func
(paren
id|C320p32rx_mask
comma
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p32tx_mask
comma
id|ofsAddr
op_plus
id|TX_mask
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p32tx_ofs
comma
id|ofsAddr
op_plus
id|Ofs_txb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p32rx_spage
op_plus
id|i
op_star
id|C320p32buf_pgno
comma
id|ofsAddr
op_plus
id|Page_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readb
c_func
(paren
id|ofsAddr
op_plus
id|Page_rxb
)paren
comma
id|ofsAddr
op_plus
id|EndPage_rxb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|C320p32tx_spage
op_plus
id|i
op_star
id|C320p32buf_pgno
comma
id|ofsAddr
op_plus
id|Page_txb
)paren
suffix:semicolon
id|writew
c_func
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|Page_txb
)paren
comma
id|ofsAddr
op_plus
id|EndPage_txb
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|moxaloadc218
r_static
r_int
id|moxaloadc218
c_func
(paren
r_int
id|cardno
comma
r_int
r_int
id|baseAddr
comma
r_int
id|len
)paren
(brace
r_char
id|retry
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|len1
comma
id|len2
suffix:semicolon
id|ushort
id|usum
comma
op_star
id|ptr
comma
id|keycode
suffix:semicolon
r_if
c_cond
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_CP204J
)paren
id|keycode
op_assign
id|CP204J_KeyCode
suffix:semicolon
r_else
id|keycode
op_assign
id|C218_KeyCode
suffix:semicolon
id|usum
op_assign
l_int|0
suffix:semicolon
id|len1
op_assign
id|len
op_rshift
l_int|1
suffix:semicolon
id|ptr
op_assign
(paren
id|ushort
op_star
)paren
id|moxaBuff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len1
suffix:semicolon
id|i
op_increment
)paren
id|usum
op_add_assign
op_star
(paren
id|ptr
op_plus
id|i
)paren
suffix:semicolon
id|retry
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|len1
op_assign
id|len
op_rshift
l_int|1
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len1
)paren
(brace
id|len2
op_assign
(paren
id|len1
OG
l_int|2048
)paren
ques
c_cond
l_int|2048
suffix:colon
id|len1
suffix:semicolon
id|len1
op_sub_assign
id|len2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len2
op_lshift
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
id|moxaBuff
(braket
id|i
op_plus
id|j
)braket
comma
id|baseAddr
op_plus
id|C218_LoadBuf
op_plus
id|i
)paren
suffix:semicolon
id|j
op_add_assign
id|i
suffix:semicolon
id|writew
c_func
(paren
id|len2
comma
id|baseAddr
op_plus
id|C218DLoad_len
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|C218_key
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C218_key
)paren
op_eq
id|keycode
)paren
r_break
suffix:semicolon
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* delay 10 ms */
)brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C218_key
)paren
op_ne
id|keycode
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|C218DLoad_len
)paren
suffix:semicolon
id|writew
c_func
(paren
id|usum
comma
id|baseAddr
op_plus
id|C218check_sum
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|C218_key
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C218_key
)paren
op_eq
id|keycode
)paren
r_break
suffix:semicolon
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* delay 10 ms */
)brace
id|retry
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|readb
c_func
(paren
id|baseAddr
op_plus
id|C218chksum_ok
)paren
op_ne
l_int|1
)paren
op_logical_and
(paren
id|retry
OL
l_int|3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|baseAddr
op_plus
id|C218chksum_ok
)paren
op_ne
l_int|1
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|C218_key
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_eq
id|Magic_code
)paren
r_break
suffix:semicolon
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* delay 10 ms */
)brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_ne
id|Magic_code
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|writew
c_func
(paren
l_int|1
comma
id|baseAddr
op_plus
id|Disable_IRQ
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|Magic_no
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_eq
id|Magic_code
)paren
r_break
suffix:semicolon
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* delay 10 ms */
)brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_ne
id|Magic_code
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|moxaCard
op_assign
l_int|1
suffix:semicolon
id|moxaIntNdx
(braket
id|cardno
)braket
op_assign
id|baseAddr
op_plus
id|IRQindex
suffix:semicolon
id|moxaIntPend
(braket
id|cardno
)braket
op_assign
id|baseAddr
op_plus
id|IRQpending
suffix:semicolon
id|moxaIntTable
(braket
id|cardno
)braket
op_assign
id|baseAddr
op_plus
id|IRQtable
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|moxaloadc320
r_static
r_int
id|moxaloadc320
c_func
(paren
r_int
id|cardno
comma
r_int
r_int
id|baseAddr
comma
r_int
id|len
comma
r_int
op_star
id|numPorts
)paren
(brace
id|ushort
id|usum
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|wlen
comma
id|len2
comma
id|retry
suffix:semicolon
id|ushort
op_star
id|uptr
suffix:semicolon
id|usum
op_assign
l_int|0
suffix:semicolon
id|wlen
op_assign
id|len
op_rshift
l_int|1
suffix:semicolon
id|uptr
op_assign
(paren
id|ushort
op_star
)paren
id|moxaBuff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|wlen
suffix:semicolon
id|i
op_increment
)paren
id|usum
op_add_assign
id|uptr
(braket
id|i
)braket
suffix:semicolon
id|retry
op_assign
l_int|0
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_do
(brace
r_while
c_loop
(paren
id|wlen
)paren
(brace
r_if
c_cond
(paren
id|wlen
OG
l_int|2048
)paren
id|len2
op_assign
l_int|2048
suffix:semicolon
r_else
id|len2
op_assign
id|wlen
suffix:semicolon
id|wlen
op_sub_assign
id|len2
suffix:semicolon
id|len2
op_lshift_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len2
suffix:semicolon
id|i
op_increment
)paren
id|writeb
c_func
(paren
id|moxaBuff
(braket
id|j
op_plus
id|i
)braket
comma
id|baseAddr
op_plus
id|C320_LoadBuf
op_plus
id|i
)paren
suffix:semicolon
id|len2
op_rshift_assign
l_int|1
suffix:semicolon
id|j
op_add_assign
id|i
suffix:semicolon
id|writew
c_func
(paren
id|len2
comma
id|baseAddr
op_plus
id|C320DLoad_len
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|C320_key
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C320_key
)paren
op_eq
id|C320_KeyCode
)paren
r_break
suffix:semicolon
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C320_key
)paren
op_ne
id|C320_KeyCode
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|C320DLoad_len
)paren
suffix:semicolon
id|writew
c_func
(paren
id|usum
comma
id|baseAddr
op_plus
id|C320check_sum
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|C320_key
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|C320_key
)paren
op_eq
id|C320_KeyCode
)paren
r_break
suffix:semicolon
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|retry
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|readb
c_func
(paren
id|baseAddr
op_plus
id|C320chksum_ok
)paren
op_ne
l_int|1
)paren
op_logical_and
(paren
id|retry
OL
l_int|3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|baseAddr
op_plus
id|C320chksum_ok
)paren
op_ne
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|C320_key
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|600
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_eq
id|Magic_code
)paren
r_break
suffix:semicolon
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_ne
id|Magic_code
)paren
r_return
(paren
op_minus
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|moxa_boards
(braket
id|cardno
)braket
dot
id|busType
op_eq
id|MOXA_BUS_TYPE_PCI
)paren
(brace
multiline_comment|/* ASIC board */
id|writew
c_func
(paren
l_int|0x3800
comma
id|baseAddr
op_plus
id|TMS320_PORT1
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0x3900
comma
id|baseAddr
op_plus
id|TMS320_PORT2
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|28499
comma
id|baseAddr
op_plus
id|TMS320_CLOCK
)paren
suffix:semicolon
)brace
r_else
(brace
id|writew
c_func
(paren
l_int|0x3200
comma
id|baseAddr
op_plus
id|TMS320_PORT1
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0x3400
comma
id|baseAddr
op_plus
id|TMS320_PORT2
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|19999
comma
id|baseAddr
op_plus
id|TMS320_CLOCK
)paren
suffix:semicolon
)brace
id|writew
c_func
(paren
l_int|1
comma
id|baseAddr
op_plus
id|Disable_IRQ
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|Magic_no
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|500
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_eq
id|Magic_code
)paren
r_break
suffix:semicolon
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_ne
id|Magic_code
)paren
r_return
(paren
op_minus
l_int|102
)paren
suffix:semicolon
id|j
op_assign
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Module_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_le
l_int|0
)paren
r_return
(paren
op_minus
l_int|101
)paren
suffix:semicolon
op_star
id|numPorts
op_assign
id|j
op_star
l_int|8
suffix:semicolon
id|writew
c_func
(paren
id|j
comma
id|baseAddr
op_plus
id|Module_no
)paren
suffix:semicolon
id|writew
c_func
(paren
l_int|0
comma
id|baseAddr
op_plus
id|Magic_no
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|600
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_eq
id|Magic_code
)paren
r_break
suffix:semicolon
id|moxadelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|baseAddr
op_plus
id|Magic_no
)paren
op_ne
id|Magic_code
)paren
r_return
(paren
op_minus
l_int|102
)paren
suffix:semicolon
id|moxaCard
op_assign
l_int|1
suffix:semicolon
id|moxaIntNdx
(braket
id|cardno
)braket
op_assign
id|baseAddr
op_plus
id|IRQindex
suffix:semicolon
id|moxaIntPend
(braket
id|cardno
)braket
op_assign
id|baseAddr
op_plus
id|IRQpending
suffix:semicolon
id|moxaIntTable
(braket
id|cardno
)braket
op_assign
id|baseAddr
op_plus
id|IRQtable
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|MoxaPortGetCurBaud
r_int
id|MoxaPortGetCurBaud
c_func
(paren
r_int
id|port
)paren
(brace
r_if
c_cond
(paren
id|moxaChkPort
(braket
id|port
)braket
op_eq
l_int|0
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_return
(paren
id|moxaCurBaud
(braket
id|port
)braket
)paren
suffix:semicolon
)brace
DECL|function|MoxaSetFifo
r_static
r_void
id|MoxaSetFifo
c_func
(paren
r_int
id|port
comma
r_int
id|enable
)paren
(brace
r_int
r_int
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|enable
)paren
(brace
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetRxFIFOTrig
comma
l_int|0
)paren
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetTxFIFOCnt
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetRxFIFOTrig
comma
l_int|3
)paren
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetTxFIFOCnt
comma
l_int|16
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0
r_int
id|MoxaPortSetMode
c_func
(paren
r_int
id|port
comma
r_int
id|databits
comma
r_int
id|stopbits
comma
r_int
id|parity
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_int
id|val
suffix:semicolon
id|val
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|databits
)paren
(brace
r_case
l_int|5
suffix:colon
id|val
op_or_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|val
op_or_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
id|val
op_or_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|val
op_or_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|stopbits
)paren
(brace
r_case
l_int|0
suffix:colon
id|val
op_or_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* stop bits 1.5 */
r_case
l_int|1
suffix:colon
id|val
op_or_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|val
op_or_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|parity
)paren
(brace
r_case
l_int|0
suffix:colon
id|val
op_or_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* None  */
r_case
l_int|1
suffix:colon
id|val
op_or_assign
l_int|0x08
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Odd   */
r_case
l_int|2
suffix:colon
id|val
op_or_assign
l_int|0x18
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Even  */
r_case
l_int|3
suffix:colon
id|val
op_or_assign
l_int|0x28
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Mark  */
r_case
l_int|4
suffix:colon
id|val
op_or_assign
l_int|0x38
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Space */
r_default
suffix:colon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_SetMode
comma
id|val
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_int
id|MoxaPortTxBufSize
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_int
id|size
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|size
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|TX_mask
)paren
suffix:semicolon
r_return
(paren
id|size
)paren
suffix:semicolon
)brace
r_int
id|MoxaPortRxBufSize
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_int
id|size
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|size
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
r_return
(paren
id|size
)paren
suffix:semicolon
)brace
r_int
id|MoxaPortRxFree
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|ushort
id|rptr
comma
id|wptr
comma
id|mask
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|rptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RXrptr
)paren
suffix:semicolon
id|wptr
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RXwptr
)paren
suffix:semicolon
id|mask
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|RX_mask
)paren
suffix:semicolon
id|len
op_assign
id|mask
op_minus
(paren
(paren
id|wptr
op_minus
id|rptr
)paren
op_amp
id|mask
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
r_int
id|MoxaPortGetBrkCnt
c_func
(paren
r_int
id|port
)paren
(brace
r_return
(paren
id|moxaBreakCnt
(braket
id|port
)braket
)paren
suffix:semicolon
)brace
r_void
id|MoxaPortSetXonXoff
c_func
(paren
r_int
id|port
comma
r_int
id|xonValue
comma
r_int
id|xoffValue
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
id|writew
c_func
(paren
id|xonValue
comma
id|ofsAddr
op_plus
id|FuncArg
)paren
suffix:semicolon
id|writew
c_func
(paren
id|xoffValue
comma
id|ofsAddr
op_plus
id|FuncArg1
)paren
suffix:semicolon
id|writew
c_func
(paren
id|FC_SetXonXoff
comma
id|ofsAddr
op_plus
id|FuncCode
)paren
suffix:semicolon
id|wait_finish
c_func
(paren
id|ofsAddr
)paren
suffix:semicolon
)brace
r_int
id|MoxaPortIsTxHold
c_func
(paren
r_int
id|port
)paren
(brace
r_int
r_int
id|ofsAddr
suffix:semicolon
r_int
id|val
suffix:semicolon
id|ofsAddr
op_assign
id|moxaTableAddr
(braket
id|port
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_ISA
)paren
op_logical_or
(paren
id|moxa_boards
(braket
id|port
op_div
id|MAX_PORTS_PER_BOARD
)braket
dot
id|boardType
op_eq
id|MOXA_BOARD_C320_PCI
)paren
)paren
(brace
id|moxafunc
c_func
(paren
id|ofsAddr
comma
id|FC_GetCCSR
comma
l_int|0
)paren
suffix:semicolon
id|val
op_assign
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|FuncArg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
l_int|0x04
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|readw
c_func
(paren
id|ofsAddr
op_plus
id|FlagStat
)paren
op_amp
id|Tx_flowOff
)paren
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
