macro_line|#include &lt;linux/autoconf.h&gt;&t;/* fastest method */
macro_line|#ifdef CONFIG_SCC
DECL|macro|BANNER
mdefine_line|#define BANNER &quot;Z8530 SCC driver v1.8.17test.17.7.95 PE1AYX (c)&bslash;n&quot;
multiline_comment|/* ******************************************************************** */
multiline_comment|/* *   SCC.C - Linux driver for Z8530 based HDLC cards for AX.25      *&t;*/
multiline_comment|/* ******************************************************************** */
multiline_comment|/* ********************************************************************&n;&n;&t;(c) Hans Alblas PE1AYX 1993,1994,1995&n;&t;          Released for GNU&n;&t;portions (c) 1995 by Joerg Reuter DL1BKE&n;&t;         (c) 1993 Guido ten Dolle PE1NNZ&n;&n;&n;   ********************************************************************&t;*/
multiline_comment|/*&n;&n;&n;   931100&t;- started with the projekt pe1ayx&n;   9406??&t;- KISS-parameter setting and BayCom USCC support dl1bke&n;   940613&t;- fixed memory leak ,main memory fragmentation problem,&n;                  speeded up the interupt routines ,has now its own&n;                  memory buffer pool and source cleanup. pe1ayx&n;   940620&t;- bug fixed in line disipline change ,local ringbuf&n;   &t;&t;  reorganisation ,and some little bugfixes.&n;   940715&t;- first release to the public (scc15b.tgz) pe1ayx&t;&t;                &n;   950228&t;- (hopefully) fixed the reason for kernel panics in&n;                  chk_rcv_queue() [stupid error] dl1bke&n;   950229       - buffer timeout for vergotten buffer :-( pe1ayx                &n;   950304       - fixed underrun/zcount handling dl1bke&n;   950305&t;- the driver registers port addresses now dl1bke&n;   950314&t;- fixed underrun interrupt handling again dl1bke&n;   950514&t;- fixed slip tty wakeup (it wil now work again with kernel ax25)pe1ayx&n;   950703&t;- rewrote the 8530 init/reset routines pe1ayx&n;   950712&t;- rewrote the RXirq + buffering routines pe1ayx&n;   950716&t;- It can now handle ax25 rx frame info &gt; 256&n;   O&t;&t;- rewrite TX + buffering (there is a little mem leak ,but&n;                  wil not be dangerous since my buffer timeout routine&n;                  wil put back vergotten buffers in the queue pe1ayx&n;   O&t;&t;- change the tty i/o so that the tty wakeup is handled properly&n;           &t;  pe1ayx&n;   &n;   Thanks to:&n;   DL1BKE Joerg - for some good ideas&n;   PE1CHL Rob&t;- for a lot of good ideas from his SCC driver for DOS&n;   PE1NNZ Guido - for his port of the original driver to Linux&n;   PA3AOU Harry - for ESCC testing, information supply and support&n;   &n;   PE1KOX Rob, DG1RTF Thomas, ON5QK Roland, &n;   &n;   and all who sent me bug reports and ideas... &n;   &n;   &n;      &n;*/
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/scc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &quot;scc_config.h&quot;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
r_int
id|scc_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|scc_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_int
id|scc_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|scc_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
suffix:semicolon
r_static
r_void
id|scc_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|scc_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|scc_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|scc_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|scc_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|scc_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
suffix:semicolon
r_static
r_void
id|scc_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|scc_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|scc_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|scc_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|z8530_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|scc_change_speed
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
)paren
suffix:semicolon
r_static
r_void
id|init_channel
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
)paren
suffix:semicolon
r_static
r_void
id|scc_key_trx
(paren
r_struct
id|scc_channel
op_star
id|scc
comma
r_char
id|tx
)paren
suffix:semicolon
r_static
r_void
id|scc_txint
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
suffix:semicolon
r_static
r_void
id|scc_exint
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
suffix:semicolon
r_static
r_void
id|scc_rxint
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
suffix:semicolon
r_static
r_void
id|scc_spint
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
suffix:semicolon
r_static
r_void
id|scc_isr
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|scc_timer
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|scc_init_timer
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
)paren
suffix:semicolon
multiline_comment|/* from serial.c */
macro_line|#ifndef MIN
DECL|macro|MIN
mdefine_line|#define MIN(a,b)&t;((a) &lt; (b) ? (a) : (b))
macro_line|#endif
DECL|variable|tmp_buf
r_static
r_int
r_char
op_star
id|tmp_buf
op_assign
l_int|0
suffix:semicolon
DECL|variable|tmp_buf_sem
r_static
r_struct
id|semaphore
id|tmp_buf_sem
op_assign
id|MUTEX
suffix:semicolon
DECL|variable|start_controle
r_static
r_int
r_int
id|start_controle
suffix:semicolon
DECL|variable|baud_table
r_static
r_int
id|baud_table
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|50
comma
l_int|75
comma
l_int|110
comma
l_int|134
comma
l_int|150
comma
l_int|200
comma
l_int|300
comma
l_int|600
comma
l_int|1200
comma
l_int|1800
comma
l_int|2400
comma
l_int|4800
comma
l_int|9600
comma
l_int|19200
comma
l_int|38400
comma
l_int|57600
comma
l_int|115200
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|scc_driver
r_struct
id|tty_driver
id|scc_driver
suffix:semicolon
multiline_comment|/* new in 1.1.xx */
DECL|variable|scc_refcount
r_static
r_int
id|scc_refcount
suffix:semicolon
DECL|variable|scc_table
r_static
r_struct
id|tty_struct
op_star
id|scc_table
(braket
l_int|2
op_star
id|MAXSCC
)braket
suffix:semicolon
DECL|variable|scc_termios
r_static
r_struct
id|termios
id|scc_termios
(braket
l_int|2
op_star
id|MAXSCC
)braket
suffix:semicolon
DECL|variable|scc_termios_locked
r_static
r_struct
id|termios
id|scc_termios_locked
(braket
l_int|2
op_star
id|MAXSCC
)braket
suffix:semicolon
DECL|variable|SCC_Info
r_struct
id|scc_channel
id|SCC_Info
(braket
l_int|2
op_star
id|MAXSCC
)braket
suffix:semicolon
multiline_comment|/* information per channel */
DECL|variable|Random
r_int
r_char
id|Random
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* random number for p-persist */
DECL|variable|Driver_Initialized
r_int
r_char
id|Driver_Initialized
op_assign
l_int|0
suffix:semicolon
DECL|variable|sccfreelist
r_static
r_struct
id|sccbuf
op_star
id|sccfreelist
(braket
id|MAX_IBUFS
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
DECL|variable|allocated_ibufs
r_static
r_int
id|allocated_ibufs
op_assign
l_int|0
suffix:semicolon
DECL|macro|SERIAL_TYPE_NORMAL
mdefine_line|#define SERIAL_TYPE_NORMAL&t;1
multiline_comment|/* ******************************************************************** */
multiline_comment|/* *&t;&t;&t;Port Access Functions&t;&t;&t;      * */
multiline_comment|/* ******************************************************************** */
r_static
r_inline
r_int
r_char
DECL|function|InReg
id|InReg
c_func
(paren
r_register
id|io_port
id|port
comma
r_register
r_int
r_char
id|reg
)paren
(brace
macro_line|#ifdef SCC_LDELAY
r_register
r_int
r_char
id|r
suffix:semicolon
id|Outb
c_func
(paren
id|port
comma
id|reg
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|r
op_assign
id|Inb
c_func
(paren
id|port
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
macro_line|#else
id|Outb
c_func
(paren
id|port
comma
id|reg
)paren
suffix:semicolon
r_return
id|Inb
c_func
(paren
id|port
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_inline
r_void
DECL|function|OutReg
id|OutReg
c_func
(paren
r_register
id|io_port
id|port
comma
r_register
r_int
r_char
id|reg
comma
r_register
r_int
r_char
id|val
)paren
(brace
macro_line|#ifdef SCC_LDELAY
id|Outb
c_func
(paren
id|port
comma
id|reg
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|Outb
c_func
(paren
id|port
comma
id|val
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
macro_line|#else
id|Outb
c_func
(paren
id|port
comma
id|reg
)paren
suffix:semicolon
id|Outb
c_func
(paren
id|port
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_inline
r_void
DECL|function|wr
id|wr
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
comma
r_register
r_int
r_char
id|reg
comma
r_register
r_int
r_char
id|val
)paren
(brace
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|reg
comma
(paren
id|scc-&gt;wreg
(braket
id|reg
)braket
op_assign
id|val
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|or
op_logical_or
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
comma
r_register
r_int
r_char
id|reg
comma
r_register
r_int
r_char
id|val
)paren
(brace
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|reg
comma
(paren
id|scc-&gt;wreg
(braket
id|reg
)braket
op_or_assign
id|val
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|cl
id|cl
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
comma
r_register
r_int
r_char
id|reg
comma
r_register
r_int
r_char
id|val
)paren
(brace
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|reg
comma
(paren
id|scc-&gt;wreg
(braket
id|reg
)braket
op_and_assign
op_complement
id|val
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************** */
multiline_comment|/* * &t;&t;&t;Memory Buffer Management&t;&t;&t;*/
multiline_comment|/* ******************************************************************** */
multiline_comment|/* allocate memory for the interrupt buffer pool */
DECL|function|scc_alloc_buffer_pool
r_void
id|scc_alloc_buffer_pool
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sccbuf
op_star
id|sccb
suffix:semicolon
r_struct
id|mbuf
op_star
id|bp
suffix:semicolon
id|start_controle
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_IBUFS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sccb
op_assign
(paren
r_struct
id|sccbuf
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sccbuf
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|bp
op_assign
(paren
r_struct
id|mbuf
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mbuf
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sccb
op_logical_and
id|bp
)paren
)paren
(brace
id|allocated_ibufs
op_assign
op_decrement
id|i
suffix:semicolon
r_if
c_cond
(paren
id|allocated_ibufs
OL
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;scc_alloc_buffer_pool() - can&squot;t get buffer space&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;Warning: scc_alloc_buffer_pool() - allocated only %i buffers&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sccfreelist
(braket
id|i
)braket
op_assign
id|sccb
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp
op_assign
id|bp
suffix:semicolon
id|memset
c_func
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mbuf
)paren
)paren
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|inuse
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;type
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;refcnt
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;size
op_assign
id|BUFSIZE
suffix:semicolon
)brace
id|allocated_ibufs
op_assign
id|MAX_IBUFS
suffix:semicolon
)brace
DECL|function|scc_count_used_buffers
r_int
r_int
id|scc_count_used_buffers
c_func
(paren
r_int
r_int
op_star
id|rx
comma
r_int
r_int
op_star
id|tx
)paren
(brace
r_int
r_int
id|i
comma
id|used
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rx
)paren
op_star
id|rx
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tx
)paren
op_star
id|tx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|allocated_ibufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|inuse
)paren
(brace
r_switch
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;type
)paren
(brace
r_case
id|BT_RECEIVE
suffix:colon
r_if
c_cond
(paren
id|rx
)paren
(paren
op_star
id|rx
)paren
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BT_TRANSMIT
suffix:colon
r_if
c_cond
(paren
id|tx
)paren
(paren
op_star
id|tx
)paren
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|used
op_increment
suffix:semicolon
)brace
)brace
r_return
id|used
suffix:semicolon
)brace
multiline_comment|/* Allocate mbuf */
r_struct
id|mbuf
op_star
DECL|function|scc_get_buffer
id|scc_get_buffer
c_func
(paren
r_char
id|type
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* just to be sure */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|allocated_ibufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|inuse
op_eq
l_int|0
)paren
(brace
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|inuse
op_assign
l_int|1
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;type
op_assign
id|type
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;next
op_assign
id|NULLBUF
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;anext
op_assign
id|NULLBUF
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;dup
op_assign
id|NULLBUF
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;size
op_assign
id|BUFSIZE
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;refcnt
op_assign
l_int|1
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;time_out
op_assign
id|CURRENT_TIME
op_plus
l_int|300
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nSCC scc_get_buffer(): buffer pool empty&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* should never happen */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|NULLBUF
suffix:semicolon
)brace
multiline_comment|/* Decrement the reference pointer in an mbuf. If it goes to zero,&n; * free all resources associated with mbuf.&n; * Return pointer to next mbuf in packet chain&n; */
r_struct
id|mbuf
op_star
DECL|function|scc_return_buffer
id|scc_return_buffer
c_func
(paren
r_register
r_struct
id|mbuf
op_star
id|bp
comma
r_char
id|type
)paren
(brace
r_struct
id|mbuf
op_star
id|bpnext
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bp
)paren
(brace
r_return
id|NULLBUF
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|bpnext
op_assign
id|bp-&gt;next
suffix:semicolon
multiline_comment|/*=========================================================================*/
multiline_comment|/*==      THIS IS A LITTLE ROUTINE TO FIX THE TX MEM LEAK                ==*/
multiline_comment|/*==             UNTIL I HAVE REWRITE THE TX ROUTINES                    ==*/
multiline_comment|/*==                 PE1AYX@PI8HRL.AMPR.ORG                              ==*/
multiline_comment|/*=========================================================================*/
id|start_controle
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|start_controle
OG
l_int|100
)paren
(brace
r_if
c_cond
(paren
id|bp-&gt;type
op_eq
id|BT_TRANSMIT
)paren
(brace
id|start_controle
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|allocated_ibufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|inuse
op_eq
l_int|1
)paren
r_if
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;type
op_eq
id|BT_TRANSMIT
)paren
r_if
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;time_out
OL
id|CURRENT_TIME
)paren
(brace
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;refcnt
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|inuse
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*=========================================================================*/
multiline_comment|/*==                END OF THAT SILLY STUPID ROUTINE                     ==*/
multiline_comment|/*=========================================================================*/
r_if
c_cond
(paren
id|bp-&gt;dup
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|allocated_ibufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp
op_eq
id|bp-&gt;dup
)paren
(brace
r_if
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;type
op_ne
id|type
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scc_return_buffer(bp-&gt;dup, %i): wrong buffer type %i&quot;
comma
id|type
comma
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;type
)paren
suffix:semicolon
)brace
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;refcnt
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|inuse
op_assign
l_int|0
suffix:semicolon
id|bp-&gt;dup
op_assign
id|NULLBUF
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Decrement reference count. If it has gone to zero, free it. */
r_if
c_cond
(paren
op_decrement
id|bp-&gt;refcnt
op_le
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|allocated_ibufs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp
op_eq
id|bp
)paren
(brace
r_if
c_cond
(paren
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;type
op_ne
id|type
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scc_return_buffer(bp, %i): wrong buffer type %i&quot;
comma
id|type
comma
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;type
)paren
suffix:semicolon
)brace
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|bp-&gt;refcnt
op_assign
l_int|0
suffix:semicolon
id|sccfreelist
(braket
id|i
)braket
op_member_access_from_pointer
id|inuse
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|bpnext
suffix:semicolon
)brace
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nscc_return_buffer(): bogus pointer %p&bslash;n&quot;
comma
id|bp
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|bpnext
suffix:semicolon
)brace
multiline_comment|/* Free packet (a chain of mbufs). Return pointer to next packet on queue,&n; * if any&n; */
r_struct
id|mbuf
op_star
DECL|function|scc_free_chain
id|scc_free_chain
c_func
(paren
r_register
r_struct
id|mbuf
op_star
id|bp
comma
r_char
id|type
)paren
(brace
r_register
r_struct
id|mbuf
op_star
id|abp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bp
)paren
(brace
r_return
id|NULLBUF
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|abp
op_assign
id|bp-&gt;anext
suffix:semicolon
r_while
c_loop
(paren
id|bp
)paren
id|bp
op_assign
id|scc_return_buffer
c_func
(paren
id|bp
comma
id|type
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_return
id|abp
suffix:semicolon
)brace
multiline_comment|/* Append mbuf to end of mbuf chain */
r_void
DECL|function|scc_append_to_chain
id|scc_append_to_chain
c_func
(paren
r_struct
id|mbuf
op_star
op_star
id|bph
comma
r_struct
id|mbuf
op_star
id|bp
)paren
(brace
r_register
r_struct
id|mbuf
op_star
id|p
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|bph
op_eq
id|NULLBUFP
op_logical_or
id|bp
op_eq
id|NULLBUF
)paren
(brace
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|bph
op_eq
id|NULLBUF
)paren
(brace
multiline_comment|/* First one on chain */
op_star
id|bph
op_assign
id|bp
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|p
op_assign
op_star
id|bph
suffix:semicolon
id|p-&gt;next
op_ne
id|NULLBUF
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
suffix:semicolon
)brace
id|p-&gt;next
op_assign
id|bp
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Append packet (chain of mbufs) to end of packet queue */
r_void
DECL|function|scc_enqueue
id|scc_enqueue
c_func
(paren
r_struct
id|mbuf
op_star
op_star
id|queue
comma
r_struct
id|mbuf
op_star
id|bp
)paren
(brace
r_register
r_struct
id|mbuf
op_star
id|p
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|queue
op_eq
id|NULLBUFP
op_logical_or
id|bp
op_eq
id|NULLBUF
)paren
(brace
r_return
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|queue
op_eq
id|NULLBUF
)paren
(brace
multiline_comment|/* List is empty, stick at front */
op_star
id|queue
op_assign
id|bp
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|p
op_assign
op_star
id|queue
suffix:semicolon
id|p-&gt;anext
op_ne
id|NULLBUF
suffix:semicolon
id|p
op_assign
id|p-&gt;anext
)paren
(brace
suffix:semicolon
)brace
id|p-&gt;anext
op_assign
id|bp
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************** */
multiline_comment|/* *&t;&t;&t;Interrupt Service Routines&t;&t;      * */
multiline_comment|/* ******************************************************************** */
multiline_comment|/* ----&gt; interrupt service routine for the 8530 &lt;---- */
multiline_comment|/* it&squot;s recommendet to keep this function &quot;inline&quot; ;-) */
r_static
r_inline
r_void
DECL|function|scc_isr_dispatch
id|scc_isr_dispatch
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
comma
r_register
r_int
id|vector
)paren
(brace
r_switch
c_cond
(paren
id|vector
op_amp
id|VECTOR_MASK
)paren
(brace
r_case
id|TXINT
suffix:colon
id|scc_txint
c_func
(paren
id|scc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXINT
suffix:colon
id|scc_exint
c_func
(paren
id|scc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RXINT
suffix:colon
id|scc_rxint
c_func
(paren
id|scc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SPINT
suffix:colon
id|scc_spint
c_func
(paren
id|scc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;scc_isr(): unknown interrupt status (addr %4.4x, state %2.2x)&bslash;n&quot;
comma
id|scc-&gt;ctrl
comma
id|vector
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* If the card has a latch for the interrupt vector (like the PA0HZP card)&n;   use it to get the number of the chip that generated the int.&n;   If not: poll all defined chips.&n; */
r_static
r_void
DECL|function|scc_isr
id|scc_isr
c_func
(paren
r_int
id|irq
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_register
r_int
r_char
id|vector
suffix:semicolon
r_register
r_struct
id|scc_channel
op_star
id|scc
suffix:semicolon
r_register
id|io_port
id|q
suffix:semicolon
r_register
id|io_port
op_star
id|p
suffix:semicolon
r_register
r_int
id|k
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Vector_Latch
)paren
(brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|Outb
c_func
(paren
id|Vector_Latch
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Generate INTACK */
multiline_comment|/* Read the vector */
r_if
c_cond
(paren
(paren
id|vector
op_assign
id|Inb
c_func
(paren
id|Vector_Latch
)paren
)paren
op_ge
l_int|16
op_star
id|Nchips
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Extract channel number and status from vector. */
multiline_comment|/* Isolate channel nummer */
multiline_comment|/* Call handler */
r_if
c_cond
(paren
id|vector
op_amp
l_int|0x01
)paren
r_break
suffix:semicolon
id|scc
op_assign
op_amp
id|SCC_Info
(braket
(paren
(paren
(paren
id|vector
op_rshift
l_int|1
)paren
op_amp
l_int|0x7c
)paren
op_xor
l_int|0x04
)paren
op_rshift
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scc-&gt;tty
)paren
r_break
suffix:semicolon
id|scc_isr_dispatch
c_func
(paren
id|scc
comma
id|vector
)paren
suffix:semicolon
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
l_int|0x38
)paren
suffix:semicolon
multiline_comment|/* Reset Highest IUS&quot; opcode to WR0 */
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Find the SCC generating the interrupt by polling all attached SCCs&n;&t; * reading RR3A (the interrupt pending register)&n;&t; */
id|k
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|SCC_ctrl
suffix:semicolon
r_while
c_loop
(paren
id|k
op_increment
OL
id|Nchips
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|q
op_assign
op_star
id|p
op_increment
)paren
)paren
r_break
suffix:semicolon
id|Outb
c_func
(paren
id|q
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Inb
c_func
(paren
id|q
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|q
op_assign
op_star
id|p
op_increment
)paren
)paren
r_break
suffix:semicolon
id|Outb
c_func
(paren
id|q
comma
l_int|2
)paren
suffix:semicolon
id|vector
op_assign
id|Inb
c_func
(paren
id|q
)paren
suffix:semicolon
multiline_comment|/* Read the vector */
multiline_comment|/* Extract channel number and status from vector. */
multiline_comment|/* Isolate channel nummer */
multiline_comment|/* Call handler */
r_if
c_cond
(paren
id|vector
op_amp
l_int|1
)paren
r_break
suffix:semicolon
id|scc
op_assign
op_amp
id|SCC_Info
(braket
(paren
(paren
(paren
id|vector
op_rshift
l_int|1
)paren
op_amp
l_int|0x7c
)paren
op_xor
l_int|0x04
)paren
op_rshift
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scc-&gt;tty
)paren
r_break
suffix:semicolon
multiline_comment|/* Isolate status info from vector, call handler */
id|scc_isr_dispatch
c_func
(paren
id|scc
comma
id|vector
)paren
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|SCC_ctrl
suffix:semicolon
)brace
r_else
id|p
op_increment
suffix:semicolon
)brace
id|sti
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ----&gt; four different interrupt handlers for Tx, Rx, changing of&t;*/
multiline_comment|/*       DCD/CTS and Rx/Tx errors&t;&t;&t;&t;&t;*/
DECL|function|prepare_next_txframe
r_static
r_inline
r_void
id|prepare_next_txframe
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_if
c_cond
(paren
(paren
id|scc-&gt;tbp
op_assign
id|scc-&gt;sndq
)paren
)paren
(brace
id|scc-&gt;sndq
op_assign
id|scc-&gt;sndq-&gt;anext
suffix:semicolon
id|scc-&gt;stat.tx_state
op_assign
id|TXS_NEWFRAME
suffix:semicolon
)brace
r_else
(brace
id|scc-&gt;stat.tx_state
op_assign
id|TXS_BUSY
suffix:semicolon
id|scc-&gt;t_tail
op_assign
id|scc-&gt;kiss.tailtime
suffix:semicolon
)brace
)brace
multiline_comment|/* Transmitter interrupt handler */
r_static
r_void
DECL|function|scc_txint
id|scc_txint
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_register
r_struct
id|mbuf
op_star
id|bp
suffix:semicolon
id|scc-&gt;stat.txints
op_increment
suffix:semicolon
id|bp
op_assign
id|scc-&gt;tbp
suffix:semicolon
r_while
c_loop
(paren
id|bp
op_logical_and
op_logical_neg
id|bp-&gt;cnt
)paren
multiline_comment|/* find next buffer */
id|bp
op_assign
id|scc_return_buffer
c_func
(paren
id|bp
comma
id|BT_TRANSMIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bp
op_eq
id|NULLBUF
)paren
multiline_comment|/* no more buffers in this frame */
(brace
r_if
c_cond
(paren
op_decrement
id|scc-&gt;stat.tx_queued
OL
l_int|0
)paren
id|scc-&gt;stat.tx_queued
op_assign
l_int|0
suffix:semicolon
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|RES_Tx_P
)paren
suffix:semicolon
multiline_comment|/* reset pending int */
id|cl
c_func
(paren
id|scc
comma
id|R10
comma
id|ABUNDER
)paren
suffix:semicolon
multiline_comment|/* frame complete, allow CRC transmit */
id|prepare_next_txframe
c_func
(paren
id|scc
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* okay, send byte */
r_if
c_cond
(paren
id|scc-&gt;stat.tx_state
op_eq
id|TXS_NEWFRAME
)paren
(brace
multiline_comment|/* first byte ? */
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|RES_Tx_CRC
)paren
suffix:semicolon
multiline_comment|/* reset CRC generator */
op_logical_or
(paren
id|scc
comma
id|R10
comma
id|ABUNDER
)paren
suffix:semicolon
multiline_comment|/* re-install underrun protection */
id|Outb
c_func
(paren
id|scc-&gt;data
comma
id|bp-&gt;data
(braket
id|bp-&gt;in_use
op_increment
)braket
)paren
suffix:semicolon
multiline_comment|/* send byte */
r_if
c_cond
(paren
op_logical_neg
id|scc-&gt;enhanced
)paren
multiline_comment|/* reset EOM latch */
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|RES_EOM_L
)paren
suffix:semicolon
id|scc-&gt;stat.tx_state
op_assign
id|TXS_ACTIVE
suffix:semicolon
multiline_comment|/* next byte... */
)brace
r_else
(brace
id|Outb
c_func
(paren
id|scc-&gt;data
comma
id|bp-&gt;data
(braket
id|bp-&gt;in_use
op_increment
)braket
)paren
suffix:semicolon
)brace
id|bp-&gt;cnt
op_decrement
suffix:semicolon
multiline_comment|/* decrease byte count */
id|scc-&gt;tbp
op_assign
id|bp
suffix:semicolon
multiline_comment|/* store buffer address */
)brace
)brace
multiline_comment|/* Throw away received mbuf(s) when an error occurred */
r_static
r_inline
r_void
DECL|function|flush_FIFO
id|flush_FIFO
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_register
r_int
id|k
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
l_int|3
suffix:semicolon
id|k
op_increment
)paren
id|Inb
c_func
(paren
id|scc-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;rxbufcnt
OG
l_int|0
)paren
(brace
id|scc-&gt;stat.rxerrs
op_increment
suffix:semicolon
id|scc-&gt;rxbufcnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* throw away frame */
)brace
)brace
multiline_comment|/* External/Status interrupt handler */
r_static
r_void
DECL|function|scc_exint
id|scc_exint
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_register
r_int
r_char
id|status
comma
id|changes
comma
id|chg_and_stat
suffix:semicolon
id|scc-&gt;stat.exints
op_increment
suffix:semicolon
id|status
op_assign
id|InReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R0
)paren
suffix:semicolon
id|changes
op_assign
id|status
op_xor
id|scc-&gt;status
suffix:semicolon
id|chg_and_stat
op_assign
id|changes
op_amp
id|status
suffix:semicolon
multiline_comment|/* ABORT: generated whenever DCD drops while receiving */
r_if
c_cond
(paren
id|chg_and_stat
op_amp
id|BRK_ABRT
)paren
multiline_comment|/* Received an ABORT */
id|flush_FIFO
c_func
(paren
id|scc
)paren
suffix:semicolon
multiline_comment|/* DCD: on = start to receive packet, off = ABORT condition */
multiline_comment|/* (a successfully received packet generates a special condition int) */
r_if
c_cond
(paren
id|changes
op_amp
id|DCD
)paren
multiline_comment|/* DCD input changed state */
(brace
r_if
c_cond
(paren
id|status
op_amp
id|DCD
)paren
multiline_comment|/* DCD is now ON */
(brace
r_if
c_cond
(paren
id|scc-&gt;modem.clocksrc
op_ne
id|CLK_EXTERNAL
)paren
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R14
comma
id|SEARCH
op_or
id|scc-&gt;wreg
(braket
id|R14
)braket
)paren
suffix:semicolon
multiline_comment|/* DPLL: enter search mode */
op_logical_or
(paren
id|scc
comma
id|R3
comma
id|ENT_HM
op_or
id|RxENABLE
)paren
suffix:semicolon
multiline_comment|/* enable the receiver, hunt mode */
)brace
r_else
(brace
multiline_comment|/* DCD is now OFF */
id|cl
c_func
(paren
id|scc
comma
id|R3
comma
id|ENT_HM
op_or
id|RxENABLE
)paren
suffix:semicolon
multiline_comment|/* disable the receiver */
id|flush_FIFO
c_func
(paren
id|scc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* CTS: use external TxDelay (what&squot;s that good for?!) */
r_if
c_cond
(paren
id|chg_and_stat
op_amp
id|CTS
)paren
multiline_comment|/* CTS is now ON */
(brace
r_if
c_cond
(paren
op_logical_neg
id|Running
c_func
(paren
id|t_txdel
)paren
op_logical_and
id|scc-&gt;kiss.txdelay
op_eq
l_int|0
)paren
multiline_comment|/* zero TXDELAY = wait for CTS */
id|scc-&gt;t_txdel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* kick it! */
)brace
r_if
c_cond
(paren
(paren
id|scc-&gt;stat.tx_state
op_eq
id|TXS_ACTIVE
)paren
op_logical_and
(paren
id|status
op_amp
id|TxEOM
)paren
)paren
(brace
id|scc-&gt;stat.tx_under
op_increment
suffix:semicolon
multiline_comment|/* oops, an underrun! count &squot;em */
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|RES_Tx_P
)paren
suffix:semicolon
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|RES_EXT_INT
)paren
suffix:semicolon
multiline_comment|/* reset ext/status interrupts */
id|scc-&gt;t_maxk
op_assign
l_int|1
suffix:semicolon
id|scc-&gt;tbp
op_assign
id|scc_free_chain
c_func
(paren
id|scc-&gt;tbp
comma
id|BT_TRANSMIT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|scc-&gt;stat.tx_queued
OL
l_int|0
)paren
id|scc-&gt;stat.tx_queued
op_assign
l_int|0
suffix:semicolon
op_logical_or
(paren
id|scc
comma
id|R10
comma
id|ABUNDER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|ZCOUNT
)paren
multiline_comment|/* Oops? */
(brace
id|scc-&gt;stat.tx_under
op_assign
l_int|9999
suffix:semicolon
multiline_comment|/* errr... yes. */
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|RES_Tx_P
)paren
suffix:semicolon
multiline_comment|/* just to be sure */
id|scc-&gt;t_maxk
op_assign
l_int|1
suffix:semicolon
id|scc-&gt;tbp
op_assign
id|scc_free_chain
c_func
(paren
id|scc-&gt;tbp
comma
id|BT_TRANSMIT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|scc-&gt;stat.tx_queued
OL
l_int|0
)paren
id|scc-&gt;stat.tx_queued
op_assign
l_int|0
suffix:semicolon
id|scc-&gt;kiss.tx_inhibit
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* don&squot;t try it again! */
)brace
id|scc-&gt;status
op_assign
id|status
suffix:semicolon
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|RES_EXT_INT
)paren
suffix:semicolon
)brace
multiline_comment|/* Receiver interrupt handler */
r_static
r_void
DECL|function|scc_rxint
id|scc_rxint
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_int
r_char
id|ch
suffix:semicolon
id|scc-&gt;stat.rxints
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|Running
c_func
(paren
id|t_maxk
)paren
op_logical_and
op_logical_neg
(paren
id|scc-&gt;kiss.fulldup
)paren
)paren
(brace
id|Inb
c_func
(paren
id|scc-&gt;data
)paren
suffix:semicolon
multiline_comment|/* discard char */
op_logical_or
(paren
id|scc
comma
id|R3
comma
id|ENT_HM
)paren
suffix:semicolon
multiline_comment|/* enter hunt mode for next flag */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scc-&gt;rxbufcnt
OG
l_int|2044
)paren
multiline_comment|/* no buffer available? */
(brace
id|Inb
c_func
(paren
id|scc-&gt;data
)paren
suffix:semicolon
multiline_comment|/* discard character */
op_logical_or
(paren
id|scc
comma
id|R3
comma
id|ENT_HM
)paren
suffix:semicolon
multiline_comment|/* enter hunt mode */
id|scc-&gt;rxbufcnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* throw away frame */
id|scc-&gt;stat.nospace
op_increment
suffix:semicolon
multiline_comment|/* and count this error */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scc-&gt;rxbufcnt
op_eq
l_int|0
)paren
multiline_comment|/* make begin of kissframe */
(brace
id|scc-&gt;rxbuf
(braket
id|scc-&gt;rxbufcnt
op_increment
)braket
op_assign
id|FEND
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;kiss.not_slip
)paren
id|scc-&gt;rxbuf
(braket
id|scc-&gt;rxbufcnt
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ch
op_assign
id|Inb
c_func
(paren
id|scc-&gt;data
)paren
)paren
(brace
r_case
id|FEND
suffix:colon
id|scc-&gt;rxbuf
(braket
id|scc-&gt;rxbufcnt
op_increment
)braket
op_assign
id|FESC
suffix:semicolon
id|scc-&gt;rxbuf
(braket
id|scc-&gt;rxbufcnt
op_increment
)braket
op_assign
id|TFEND
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FESC
suffix:colon
id|scc-&gt;rxbuf
(braket
id|scc-&gt;rxbufcnt
op_increment
)braket
op_assign
id|FESC
suffix:semicolon
id|scc-&gt;rxbuf
(braket
id|scc-&gt;rxbufcnt
op_increment
)braket
op_assign
id|TFESC
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|scc-&gt;rxbuf
(braket
id|scc-&gt;rxbufcnt
op_increment
)braket
op_assign
id|ch
suffix:semicolon
)brace
)brace
multiline_comment|/* Receive Special Condition interrupt handler */
r_static
r_void
DECL|function|scc_spint
id|scc_spint
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_register
r_int
r_char
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|cp
suffix:semicolon
r_char
op_star
id|fp
suffix:semicolon
r_int
id|count
suffix:semicolon
id|scc-&gt;stat.spints
op_increment
suffix:semicolon
id|status
op_assign
id|InReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R1
)paren
suffix:semicolon
multiline_comment|/* read Special Receive Condition status */
id|Inb
c_func
(paren
id|scc-&gt;data
)paren
suffix:semicolon
multiline_comment|/* read byte */
r_if
c_cond
(paren
id|status
op_amp
id|Rx_OVR
)paren
multiline_comment|/* RX_OVerRrun? */
(brace
id|scc-&gt;stat.rx_over
op_increment
suffix:semicolon
op_logical_or
(paren
id|scc
comma
id|R3
comma
id|ENT_HM
)paren
suffix:semicolon
multiline_comment|/* enter hunt mode */
id|scc-&gt;rxbufcnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* rewind the buffer */
)brace
r_if
c_cond
(paren
id|status
op_amp
id|END_FR
op_logical_and
id|scc-&gt;rxbufcnt
op_ne
l_int|0
)paren
multiline_comment|/* END of FRame */
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|CRC_ERR
)paren
op_logical_and
(paren
id|status
op_amp
l_int|0xe
)paren
op_eq
id|RES8
op_logical_and
id|scc-&gt;rxbufcnt
OG
l_int|0
)paren
(brace
id|scc-&gt;rxbufcnt
op_decrement
suffix:semicolon
multiline_comment|/*strip the CRC */
id|scc-&gt;rxbuf
(braket
id|scc-&gt;rxbufcnt
op_increment
)braket
op_assign
id|FEND
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|scc-&gt;rxbufcnt
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|scc-&gt;tty-&gt;flip.count
op_plus
l_int|1
)paren
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|scc-&gt;tty
comma
id|scc-&gt;rxbuf
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|scc-&gt;tty-&gt;flip.buf_num
)paren
(brace
id|cp
op_assign
id|scc-&gt;tty-&gt;flip.char_buf
op_plus
id|TTY_FLIPBUF_SIZE
suffix:semicolon
id|fp
op_assign
id|scc-&gt;tty-&gt;flip.flag_buf
op_plus
id|TTY_FLIPBUF_SIZE
suffix:semicolon
id|scc-&gt;tty-&gt;flip.buf_num
op_assign
l_int|0
suffix:semicolon
id|scc-&gt;tty-&gt;flip.char_buf_ptr
op_assign
id|scc-&gt;tty-&gt;flip.char_buf
suffix:semicolon
id|scc-&gt;tty-&gt;flip.flag_buf_ptr
op_assign
id|scc-&gt;tty-&gt;flip.flag_buf
suffix:semicolon
)brace
r_else
(brace
id|cp
op_assign
id|scc-&gt;tty-&gt;flip.char_buf
suffix:semicolon
id|fp
op_assign
id|scc-&gt;tty-&gt;flip.flag_buf
suffix:semicolon
id|scc-&gt;tty-&gt;flip.buf_num
op_assign
l_int|1
suffix:semicolon
id|scc-&gt;tty-&gt;flip.char_buf_ptr
op_assign
id|scc-&gt;tty-&gt;flip.char_buf
op_plus
id|TTY_FLIPBUF_SIZE
suffix:semicolon
id|scc-&gt;tty-&gt;flip.flag_buf_ptr
op_assign
id|scc-&gt;tty-&gt;flip.flag_buf
op_plus
id|TTY_FLIPBUF_SIZE
suffix:semicolon
)brace
id|count
op_assign
id|scc-&gt;tty-&gt;flip.count
suffix:semicolon
id|scc-&gt;tty-&gt;flip.count
op_assign
l_int|0
suffix:semicolon
id|scc-&gt;tty-&gt;ldisc
dot
id|receive_buf
c_func
(paren
id|scc-&gt;tty
comma
id|cp
comma
id|fp
comma
id|count
)paren
suffix:semicolon
id|tty_insert_flip_char
c_func
(paren
id|scc-&gt;tty
comma
id|scc-&gt;rxbuf
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|scc-&gt;tty-&gt;flip.buf_num
)paren
(brace
id|cp
op_assign
id|scc-&gt;tty-&gt;flip.char_buf
op_plus
id|TTY_FLIPBUF_SIZE
suffix:semicolon
id|fp
op_assign
id|scc-&gt;tty-&gt;flip.flag_buf
op_plus
id|TTY_FLIPBUF_SIZE
suffix:semicolon
id|scc-&gt;tty-&gt;flip.buf_num
op_assign
l_int|0
suffix:semicolon
id|scc-&gt;tty-&gt;flip.char_buf_ptr
op_assign
id|scc-&gt;tty-&gt;flip.char_buf
suffix:semicolon
id|scc-&gt;tty-&gt;flip.flag_buf_ptr
op_assign
id|scc-&gt;tty-&gt;flip.flag_buf
suffix:semicolon
)brace
r_else
(brace
id|cp
op_assign
id|scc-&gt;tty-&gt;flip.char_buf
suffix:semicolon
id|fp
op_assign
id|scc-&gt;tty-&gt;flip.flag_buf
suffix:semicolon
id|scc-&gt;tty-&gt;flip.buf_num
op_assign
l_int|1
suffix:semicolon
id|scc-&gt;tty-&gt;flip.char_buf_ptr
op_assign
id|scc-&gt;tty-&gt;flip.char_buf
op_plus
id|TTY_FLIPBUF_SIZE
suffix:semicolon
id|scc-&gt;tty-&gt;flip.flag_buf_ptr
op_assign
id|scc-&gt;tty-&gt;flip.flag_buf
op_plus
id|TTY_FLIPBUF_SIZE
suffix:semicolon
)brace
id|count
op_assign
id|scc-&gt;tty-&gt;flip.count
suffix:semicolon
id|scc-&gt;tty-&gt;flip.count
op_assign
l_int|0
suffix:semicolon
id|scc-&gt;tty-&gt;ldisc
dot
id|receive_buf
c_func
(paren
id|scc-&gt;tty
comma
id|cp
comma
id|fp
comma
id|count
)paren
suffix:semicolon
id|scc-&gt;stat.rxframes
op_increment
suffix:semicolon
id|scc-&gt;rxbufcnt
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|scc-&gt;rxbufcnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* frame is not good */
id|scc-&gt;stat.rxerrs
op_increment
suffix:semicolon
)brace
)brace
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|ERR_RES
)paren
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************** */
multiline_comment|/* *&t;&t;&t;Init Channel&t;&t;&t;&t;&t;*/
multiline_comment|/* ******************************************************************** */
multiline_comment|/* ----&gt; set SCC channel speed &lt;---- */
DECL|function|set_brg
r_static
r_inline
r_void
id|set_brg
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
comma
r_int
r_int
id|tc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* 2-step register accesses... */
id|cl
c_func
(paren
id|scc
comma
id|R14
comma
id|BRENABL
)paren
suffix:semicolon
multiline_comment|/* disable baudrate generator */
id|wr
c_func
(paren
id|scc
comma
id|R12
comma
id|tc
op_amp
l_int|255
)paren
suffix:semicolon
multiline_comment|/* brg rate LOW */
id|wr
c_func
(paren
id|scc
comma
id|R13
comma
id|tc
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* brg rate HIGH */
op_logical_or
(paren
id|scc
comma
id|R14
comma
id|BRENABL
)paren
suffix:semicolon
multiline_comment|/* enable baudrate generator */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|set_speed
r_static
r_inline
r_void
id|set_speed
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
id|set_brg
c_func
(paren
id|scc
comma
(paren
r_int
)paren
(paren
id|Clock
op_div
(paren
id|scc-&gt;modem.speed
op_star
l_int|64
)paren
)paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* ----&gt; initialize a SCC channel &lt;---- */
DECL|function|init_brg
r_static
r_inline
r_void
id|init_brg
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
id|wr
c_func
(paren
id|scc
comma
id|R14
comma
id|BRSRC
)paren
suffix:semicolon
multiline_comment|/* BRG source = PCLK */
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R14
comma
id|SSBR
op_or
id|scc-&gt;wreg
(braket
id|R14
)braket
)paren
suffix:semicolon
multiline_comment|/* DPLL source = BRG */
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R14
comma
id|SNRZI
op_or
id|scc-&gt;wreg
(braket
id|R14
)braket
)paren
suffix:semicolon
multiline_comment|/* DPLL NRZI mode */
)brace
r_static
r_void
DECL|function|init_channel
id|init_channel
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|wr
c_func
(paren
id|scc
comma
id|R1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* no W/REQ operation */
id|wr
c_func
(paren
id|scc
comma
id|R3
comma
id|Rx8
op_or
id|RxCRC_ENAB
)paren
suffix:semicolon
multiline_comment|/* RX 8 bits/char, CRC, disabled */
id|wr
c_func
(paren
id|scc
comma
id|R4
comma
id|X1CLK
op_or
id|SDLC
)paren
suffix:semicolon
multiline_comment|/* *1 clock, SDLC mode */
id|wr
c_func
(paren
id|scc
comma
id|R5
comma
id|Tx8
op_or
id|DTR
op_or
id|TxCRC_ENAB
)paren
suffix:semicolon
multiline_comment|/* TX 8 bits/char, disabled, DTR */
id|wr
c_func
(paren
id|scc
comma
id|R6
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* SDLC address zero (not used) */
id|wr
c_func
(paren
id|scc
comma
id|R7
comma
id|FLAG
)paren
suffix:semicolon
multiline_comment|/* SDLC flag value */
id|wr
c_func
(paren
id|scc
comma
id|R9
comma
id|VIS
)paren
suffix:semicolon
multiline_comment|/* vector includes status */
id|wr
c_func
(paren
id|scc
comma
id|R10
comma
(paren
id|scc-&gt;modem.nrz
ques
c_cond
id|NRZ
suffix:colon
id|NRZI
)paren
op_or
id|CRCPS
op_or
id|ABUNDER
)paren
suffix:semicolon
multiline_comment|/* abort on underrun, preset CRC generator, NRZ(I) */
id|wr
c_func
(paren
id|scc
comma
id|R14
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set clock sources:&n;&n;   CLK_DPLL: normal halfduplex operation&n;   &n;&t;&t;RxClk: use DPLL&n;&t;&t;TxClk: use DPLL&n;&t;&t;TRxC mode DPLL output&n;&t;&t;&n;   CLK_EXTERNAL: external clocking (G3RUH or DF9IC modem)&n;   &n;  &t;        BayCom: &t;&t;others:&n;  &t;        &n;  &t;        TxClk = pin RTxC&t;TxClk = pin TRxC&n;  &t;        RxClk = pin TRxC &t;RxClk = pin RTxC&n;  &t;     &n;&n;   CLK_DIVIDER:&n;   &t;&t;RxClk = use DPLL&n;   &t;&t;TxClk = pin RTxC&n;   &t;&t;&n;   &t;&t;BayCom:&t;&t;&t;others:&n;   &t;&t;pin TRxC = DPLL&t;&t;pin TRxC = BRG&n;   &t;&t;(RxClk * 1)&t;&t;(RxClk * 32)&n;*/
r_switch
c_cond
(paren
id|scc-&gt;modem.clocksrc
)paren
(brace
r_case
id|CLK_DPLL
suffix:colon
id|wr
c_func
(paren
id|scc
comma
id|R11
comma
id|RCDPLL
op_or
id|TCDPLL
op_or
id|TRxCOI
op_or
id|TRxCDP
)paren
suffix:semicolon
id|init_brg
c_func
(paren
id|scc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLK_DIVIDER
suffix:colon
id|wr
c_func
(paren
id|scc
comma
id|R11
comma
(paren
(paren
id|Board
op_amp
id|BAYCOM
)paren
ques
c_cond
id|TRxCDP
suffix:colon
id|TRxCBR
)paren
op_or
id|RCDPLL
op_or
id|TCRTxCP
op_or
id|TRxCOI
)paren
suffix:semicolon
id|init_brg
c_func
(paren
id|scc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLK_EXTERNAL
suffix:colon
id|wr
c_func
(paren
id|scc
comma
id|R11
comma
(paren
id|Board
op_amp
id|BAYCOM
)paren
ques
c_cond
id|RCTRxCP
op_or
id|TCRTxCP
suffix:colon
id|RCRTxCP
op_or
id|TCTRxCP
)paren
suffix:semicolon
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R14
comma
id|DISDPLL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* enable CTS (not for Baycom), ABORT &amp; DCD interrupts */
id|wr
c_func
(paren
id|scc
comma
id|R15
comma
(paren
(paren
id|Board
op_amp
id|BAYCOM
)paren
ques
c_cond
l_int|0
suffix:colon
id|CTSIE
)paren
op_or
id|BRKIE
op_or
id|DCDIE
op_or
id|TxUIE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;enhanced
)paren
(brace
op_logical_or
(paren
id|scc
comma
id|R15
comma
id|SHDLCE
op_or
id|FIFOE
)paren
suffix:semicolon
multiline_comment|/* enable FIFO, SDLC/HDLC Enhancements (From now R7 is R7&squot;) */
id|wr
c_func
(paren
id|scc
comma
id|R7
comma
id|AUTOEOM
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|InReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R0
)paren
)paren
op_amp
id|DCD
)paren
multiline_comment|/* DCD is now ON */
(brace
r_if
c_cond
(paren
id|scc-&gt;modem.clocksrc
op_ne
id|CLK_EXTERNAL
)paren
op_logical_or
(paren
id|scc
comma
id|R14
comma
id|SEARCH
)paren
suffix:semicolon
op_logical_or
(paren
id|scc
comma
id|R3
comma
id|ENT_HM
op_or
id|RxENABLE
)paren
suffix:semicolon
multiline_comment|/* enable the receiver, hunt mode */
)brace
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|RES_EXT_INT
)paren
suffix:semicolon
multiline_comment|/* reset ext/status interrupts */
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
id|RES_EXT_INT
)paren
suffix:semicolon
multiline_comment|/* must be done twice */
id|scc-&gt;status
op_assign
id|InReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R0
)paren
suffix:semicolon
multiline_comment|/* read initial status */
id|scc-&gt;rxbufcnt
op_assign
l_int|0
suffix:semicolon
op_logical_or
(paren
id|scc
comma
id|R1
comma
id|INT_ALL_Rx
op_or
id|TxINT_ENAB
op_or
id|EXT_INT_ENAB
)paren
suffix:semicolon
multiline_comment|/* enable interrupts */
op_logical_or
(paren
id|scc
comma
id|R9
comma
id|MIE
)paren
suffix:semicolon
multiline_comment|/* master interrupt enable */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|set_speed
c_func
(paren
id|scc
)paren
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************** */
multiline_comment|/* *&t;&t;&t;SCC timer functions&t;&t;&t;      * */
multiline_comment|/* ******************************************************************** */
multiline_comment|/* ----&gt; scc_key_trx sets the time constant for the baudrate &n;         generator and keys the transmitter&t;&t;     &lt;---- */
r_static
r_void
DECL|function|scc_key_trx
id|scc_key_trx
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
comma
r_char
id|tx
)paren
(brace
r_int
r_int
id|time_const
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;modem.speed
OL
id|baud_table
(braket
l_int|1
)braket
)paren
id|scc-&gt;modem.speed
op_assign
l_int|1200
suffix:semicolon
r_if
c_cond
(paren
id|Board
op_amp
id|PRIMUS
)paren
id|Outb
c_func
(paren
id|scc-&gt;ctrl
op_plus
l_int|4
comma
id|Option
op_or
(paren
id|tx
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|time_const
op_assign
(paren
r_int
)paren
(paren
id|Clock
op_div
(paren
id|scc-&gt;modem.speed
op_star
(paren
id|tx
ques
c_cond
l_int|2
suffix:colon
l_int|64
)paren
)paren
)paren
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;modem.clocksrc
op_eq
id|CLK_DPLL
)paren
(brace
multiline_comment|/* simplex operation */
r_if
c_cond
(paren
id|tx
)paren
(brace
id|cl
c_func
(paren
id|scc
comma
id|R3
comma
id|RxENABLE
op_or
id|ENT_HM
)paren
suffix:semicolon
multiline_comment|/* then switch off receiver */
id|set_brg
c_func
(paren
id|scc
comma
id|time_const
)paren
suffix:semicolon
multiline_comment|/* reprogram baudrate generator */
multiline_comment|/* DPLL -&gt; Rx clk, BRG -&gt; Tx CLK, TRxC mode output, TRxC = BRG */
id|wr
c_func
(paren
id|scc
comma
id|R11
comma
id|RCDPLL
op_or
id|TCBR
op_or
id|TRxCOI
op_or
id|TRxCBR
)paren
suffix:semicolon
op_logical_or
(paren
id|scc
comma
id|R5
comma
id|RTS
op_or
id|TxENAB
)paren
suffix:semicolon
multiline_comment|/* set the RTS line and enable TX */
)brace
r_else
(brace
id|cl
c_func
(paren
id|scc
comma
id|R5
comma
id|RTS
op_or
id|TxENAB
)paren
suffix:semicolon
id|set_brg
c_func
(paren
id|scc
comma
id|time_const
)paren
suffix:semicolon
multiline_comment|/* reprogram baudrate generator */
multiline_comment|/* DPLL -&gt; Rx clk, DPLL -&gt; Tx CLK, TRxC mode output, TRxC = DPLL */
id|wr
c_func
(paren
id|scc
comma
id|R11
comma
id|RCDPLL
op_or
id|TCDPLL
op_or
id|TRxCOI
op_or
id|TRxCDP
)paren
suffix:semicolon
op_logical_or
(paren
id|scc
comma
id|R3
comma
id|RxENABLE
op_or
id|ENT_HM
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|tx
)paren
op_logical_or
(paren
id|scc
comma
id|R5
comma
id|RTS
op_or
id|TxENAB
)paren
suffix:semicolon
multiline_comment|/* enable tx */
r_else
id|cl
c_func
(paren
id|scc
comma
id|R5
comma
id|RTS
op_or
id|TxENAB
)paren
suffix:semicolon
multiline_comment|/* disable tx */
)brace
)brace
multiline_comment|/* ----&gt; SCC timer interrupt handler and friends. Will be called every 1/TPS s &lt;---- */
DECL|variable|Rand
r_static
r_int
r_char
id|Rand
op_assign
l_int|17
suffix:semicolon
DECL|function|is_grouped
r_static
r_inline
r_int
id|is_grouped
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_int
id|k
suffix:semicolon
r_struct
id|scc_channel
op_star
id|scc2
suffix:semicolon
r_int
r_char
id|grp1
comma
id|grp2
suffix:semicolon
id|grp1
op_assign
id|scc-&gt;kiss.group
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
(paren
id|Nchips
op_star
l_int|2
)paren
suffix:semicolon
id|k
op_increment
)paren
(brace
id|scc2
op_assign
op_amp
id|SCC_Info
(braket
id|k
)braket
suffix:semicolon
id|grp2
op_assign
id|scc2-&gt;kiss.group
suffix:semicolon
r_if
c_cond
(paren
id|scc2
op_eq
id|scc
op_logical_or
op_logical_neg
(paren
id|scc2-&gt;tty
op_logical_and
id|grp2
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|grp1
op_amp
l_int|0x3f
)paren
op_eq
(paren
id|grp2
op_amp
l_int|0x3f
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|grp1
op_amp
id|TXGROUP
)paren
op_logical_and
(paren
id|scc2-&gt;wreg
(braket
id|R5
)braket
op_amp
id|RTS
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|grp1
op_amp
id|RXGROUP
)paren
op_logical_and
(paren
id|scc2-&gt;status
op_amp
id|DCD
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dw_slot_timeout
r_static
r_inline
r_void
id|dw_slot_timeout
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
id|scc-&gt;t_dwait
op_assign
id|TIMER_STOPPED
suffix:semicolon
id|scc-&gt;t_slot
op_assign
id|TIMER_STOPPED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scc-&gt;kiss.fulldup
)paren
(brace
id|Rand
op_assign
id|Rand
op_star
l_int|17
op_plus
l_int|31
suffix:semicolon
r_if
c_cond
(paren
(paren
id|scc-&gt;kiss.softdcd
ques
c_cond
op_logical_neg
(paren
id|scc-&gt;status
op_amp
id|SYNC_HUNT
)paren
suffix:colon
(paren
id|scc-&gt;status
op_amp
id|DCD
)paren
)paren
op_logical_or
(paren
id|scc-&gt;kiss.persist
)paren
OL
id|Rand
op_logical_or
(paren
id|scc-&gt;kiss.group
op_logical_and
id|is_grouped
c_func
(paren
id|scc
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|scc-&gt;t_mbusy
op_eq
id|TIMER_STOPPED
)paren
id|scc-&gt;t_mbusy
op_assign
id|TPS
op_star
id|scc-&gt;kiss.maxdefer
suffix:semicolon
id|scc-&gt;t_slot
op_assign
id|scc-&gt;kiss.slottime
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|scc-&gt;wreg
(braket
id|R5
)braket
op_amp
id|RTS
)paren
)paren
(brace
id|scc-&gt;t_txdel
op_assign
id|scc-&gt;kiss.txdelay
suffix:semicolon
id|scc_key_trx
c_func
(paren
id|scc
comma
id|TX_ON
)paren
suffix:semicolon
)brace
r_else
(brace
id|scc-&gt;t_txdel
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|txdel_timeout
r_static
r_inline
r_void
id|txdel_timeout
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
id|scc-&gt;t_txdel
op_assign
id|TIMER_STOPPED
suffix:semicolon
id|scc-&gt;t_maxk
op_assign
id|TPS
op_star
id|scc-&gt;kiss.maxkeyup
suffix:semicolon
id|prepare_next_txframe
c_func
(paren
id|scc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;stat.tx_state
op_ne
id|TXS_BUSY
)paren
id|scc_txint
c_func
(paren
id|scc
)paren
suffix:semicolon
)brace
DECL|function|tail_timeout
r_static
r_inline
r_void
id|tail_timeout
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
id|scc-&gt;t_tail
op_assign
id|TIMER_STOPPED
suffix:semicolon
multiline_comment|/* when fulldup is 0 or 1, switch off the transmitter.&n;&t; * when frames are still queued (because of transmit time limit),&n;&t; * restart the procedure to get the channel after MINTIME.&n;&t; * when fulldup is 2, the transmitter remains keyed and we&n;&t; * continue sending after waiting for waittime. IDLETIME is an &n;&t; * idle timeout in this case.&n;&t; */
r_if
c_cond
(paren
id|scc-&gt;kiss.fulldup
OL
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|scc-&gt;sndq
)paren
multiline_comment|/* we had a timeout? */
(brace
id|scc-&gt;stat.tx_state
op_assign
id|TXS_BUSY
suffix:semicolon
id|scc-&gt;t_dwait
op_assign
id|TPS
op_star
id|scc-&gt;kiss.mintime
suffix:semicolon
multiline_comment|/* try again */
)brace
id|scc-&gt;stat.tx_state
op_assign
id|TXS_IDLE
suffix:semicolon
id|scc-&gt;t_maxk
op_assign
id|TIMER_STOPPED
suffix:semicolon
id|scc_key_trx
c_func
(paren
id|scc
comma
id|TX_OFF
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scc-&gt;sndq
)paren
multiline_comment|/* maxkeyup expired */
multiline_comment|/* ?! */
(brace
id|scc-&gt;stat.tx_state
op_assign
id|TXS_BUSY
suffix:semicolon
id|scc-&gt;t_txdel
op_assign
id|TPS
op_star
id|scc-&gt;kiss.waittime
suffix:semicolon
)brace
r_else
id|scc-&gt;t_idle
op_assign
id|TPS
op_star
id|scc-&gt;kiss.idletime
suffix:semicolon
)brace
DECL|function|busy_timeout
r_static
r_inline
r_void
id|busy_timeout
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
macro_line|#ifdef&t;THROW_AWAY_AFTER_BUSY_TIMEOUT
r_register
r_struct
id|mbuf
op_star
id|bp
suffix:semicolon
multiline_comment|/* not tested */
id|bp
op_assign
id|scc-&gt;sndq
suffix:semicolon
r_while
c_loop
(paren
id|bp
)paren
id|bp
op_assign
id|scc_free_chain
c_func
(paren
id|bp
comma
id|BT_TRANSMIT
)paren
suffix:semicolon
id|scc-&gt;sndq
op_assign
id|NULLBUF
suffix:semicolon
id|scc-&gt;stat.tx_state
op_assign
id|TXS_IDLE
suffix:semicolon
macro_line|#else
id|scc-&gt;t_txdel
op_assign
id|scc-&gt;kiss.txdelay
suffix:semicolon
multiline_comment|/* brute force ... */
macro_line|#endif
id|scc-&gt;t_mbusy
op_assign
id|TIMER_STOPPED
suffix:semicolon
)brace
DECL|function|maxk_idle_timeout
r_static
r_inline
r_void
id|maxk_idle_timeout
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
id|scc-&gt;t_maxk
op_assign
id|TIMER_STOPPED
suffix:semicolon
id|scc-&gt;t_idle
op_assign
id|TIMER_STOPPED
suffix:semicolon
id|scc-&gt;stat.tx_state
op_assign
id|TXS_BUSY
suffix:semicolon
id|scc-&gt;t_tail
op_assign
id|scc-&gt;kiss.tailtime
suffix:semicolon
)brace
r_static
r_void
DECL|function|scc_timer
id|scc_timer
c_func
(paren
r_void
)paren
(brace
r_register
r_struct
id|scc_channel
op_star
id|scc
suffix:semicolon
r_register
r_int
id|chan
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|chan
op_assign
l_int|0
suffix:semicolon
id|chan
OL
(paren
id|Nchips
op_star
l_int|2
)paren
suffix:semicolon
id|chan
op_increment
)paren
(brace
id|scc
op_assign
op_amp
id|SCC_Info
(braket
id|chan
)braket
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;tty
op_logical_and
id|scc-&gt;init
)paren
(brace
multiline_comment|/* KISS-TNC emulation */
r_if
c_cond
(paren
id|Expired
c_func
(paren
id|t_dwait
)paren
)paren
id|dw_slot_timeout
c_func
(paren
id|scc
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Expired
c_func
(paren
id|t_slot
)paren
)paren
id|dw_slot_timeout
c_func
(paren
id|scc
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Expired
c_func
(paren
id|t_txdel
)paren
)paren
id|txdel_timeout
c_func
(paren
id|scc
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|Expired
c_func
(paren
id|t_tail
)paren
)paren
id|tail_timeout
c_func
(paren
id|scc
)paren
suffix:semicolon
multiline_comment|/* watchdogs */
r_if
c_cond
(paren
id|Expired
c_func
(paren
id|t_mbusy
)paren
)paren
id|busy_timeout
c_func
(paren
id|scc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Expired
c_func
(paren
id|t_maxk
)paren
)paren
id|maxk_idle_timeout
c_func
(paren
id|scc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Expired
c_func
(paren
id|t_idle
)paren
)paren
id|maxk_idle_timeout
c_func
(paren
id|scc
)paren
suffix:semicolon
)brace
)brace
id|timer_table
(braket
id|SCC_TIMER
)braket
dot
id|fn
op_assign
id|scc_timer
suffix:semicolon
id|timer_table
(braket
id|SCC_TIMER
)braket
dot
id|expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
id|TPS
suffix:semicolon
id|timer_active
op_or_assign
l_int|1
op_lshift
id|SCC_TIMER
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|scc_init_timer
id|scc_init_timer
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|Stop_Timer
c_func
(paren
id|t_dwait
)paren
suffix:semicolon
id|Stop_Timer
c_func
(paren
id|t_slot
)paren
suffix:semicolon
id|Stop_Timer
c_func
(paren
id|t_txdel
)paren
suffix:semicolon
id|Stop_Timer
c_func
(paren
id|t_tail
)paren
suffix:semicolon
id|Stop_Timer
c_func
(paren
id|t_mbusy
)paren
suffix:semicolon
id|Stop_Timer
c_func
(paren
id|t_maxk
)paren
suffix:semicolon
id|Stop_Timer
c_func
(paren
id|t_idle
)paren
suffix:semicolon
id|scc-&gt;stat.tx_state
op_assign
id|TXS_IDLE
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************** */
multiline_comment|/* *&t;&t;&t;KISS interpreter&t;&t;&t;      * */
multiline_comment|/* ******************************************************************** */
multiline_comment|/*&n; * this will set the &quot;kiss&quot; parameters through kiss itself&n; */
r_static
r_void
DECL|function|kiss_set_param
id|kiss_set_param
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
comma
r_char
id|cmd
comma
r_int
r_int
id|val
)paren
(brace
DECL|macro|VAL
mdefine_line|#define  VAL val=val*TPS/100
DECL|macro|SVAL
mdefine_line|#define SVAL val? val:TIMER_STOPPED
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|PARAM_TXDELAY
suffix:colon
id|scc-&gt;kiss.txdelay
op_assign
id|VAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_PERSIST
suffix:colon
id|scc-&gt;kiss.persist
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_SLOTTIME
suffix:colon
id|scc-&gt;kiss.slottime
op_assign
id|VAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_TXTAIL
suffix:colon
id|scc-&gt;kiss.tailtime
op_assign
id|VAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_FULLDUP
suffix:colon
id|scc-&gt;kiss.fulldup
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_WAIT
suffix:colon
id|scc-&gt;kiss.waittime
op_assign
id|VAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_MAXKEY
suffix:colon
id|scc-&gt;kiss.maxkeyup
op_assign
id|SVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_MIN
suffix:colon
id|scc-&gt;kiss.mintime
op_assign
id|SVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_IDLE
suffix:colon
id|scc-&gt;kiss.idletime
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_MAXDEFER
suffix:colon
id|scc-&gt;kiss.maxdefer
op_assign
id|SVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_GROUP
suffix:colon
id|scc-&gt;kiss.group
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_TX
suffix:colon
id|scc-&gt;kiss.tx_inhibit
op_assign
id|val
suffix:semicolon
r_case
id|PARAM_SOFTDCD
suffix:colon
id|scc-&gt;kiss.softdcd
op_assign
id|val
suffix:semicolon
)brace
r_return
suffix:semicolon
DECL|macro|VAL
macro_line|#undef  VAL
DECL|macro|SVAL
macro_line|#undef SVAL
)brace
multiline_comment|/* interpret frame: strip CRC and decode KISS */
DECL|function|kiss_interpret_frame
r_static
r_void
id|kiss_interpret_frame
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_int
r_char
id|kisscmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;sndq1-&gt;cnt
OL
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|scc-&gt;sndq1
)paren
id|scc_free_chain
c_func
(paren
id|scc-&gt;sndq1
comma
id|BT_TRANSMIT
)paren
suffix:semicolon
r_else
id|scc-&gt;sndq1
op_assign
id|NULLBUF
suffix:semicolon
id|scc-&gt;sndq2
op_assign
id|NULLBUF
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scc-&gt;kiss.not_slip
)paren
(brace
id|kisscmd
op_assign
id|scc-&gt;sndq1-&gt;data
(braket
id|scc-&gt;sndq1-&gt;in_use
op_increment
)braket
suffix:semicolon
id|scc-&gt;sndq1-&gt;cnt
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|kisscmd
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kisscmd
op_amp
l_int|0xa0
)paren
(brace
r_if
c_cond
(paren
id|scc-&gt;sndq1-&gt;cnt
OG
l_int|2
)paren
id|scc-&gt;sndq1-&gt;cnt
op_sub_assign
l_int|2
suffix:semicolon
r_else
(brace
id|scc_free_chain
c_func
(paren
id|scc-&gt;sndq1
comma
id|BT_TRANSMIT
)paren
suffix:semicolon
id|scc-&gt;sndq2
op_assign
id|NULLBUF
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|kisscmd
op_and_assign
l_int|0x1f
suffix:semicolon
r_if
c_cond
(paren
id|kisscmd
)paren
(brace
id|kiss_set_param
c_func
(paren
id|scc
comma
id|kisscmd
comma
id|scc-&gt;sndq1-&gt;data
(braket
id|scc-&gt;sndq1-&gt;in_use
)braket
)paren
suffix:semicolon
id|scc-&gt;sndq1-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|scc-&gt;sndq1-&gt;in_use
op_assign
l_int|0
suffix:semicolon
id|scc_free_chain
c_func
(paren
id|scc-&gt;sndq1
comma
id|BT_TRANSMIT
)paren
suffix:semicolon
id|scc-&gt;sndq2
op_assign
id|NULLBUF
suffix:semicolon
r_return
suffix:semicolon
)brace
id|scc_enqueue
c_func
(paren
op_amp
id|scc-&gt;sndq
comma
id|scc-&gt;sndq1
)paren
suffix:semicolon
multiline_comment|/* scc_enqueue packet */
id|scc-&gt;stat.txframes
op_increment
suffix:semicolon
id|scc-&gt;stat.tx_queued
op_increment
suffix:semicolon
id|scc-&gt;sndq2
op_assign
id|NULLBUF
suffix:semicolon
multiline_comment|/* acquire a new buffer next time */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;stat.tx_state
op_eq
id|TXS_IDLE
)paren
(brace
multiline_comment|/* when transmitter is idle */
id|scc_init_timer
c_func
(paren
id|scc
)paren
suffix:semicolon
id|scc-&gt;stat.tx_state
op_assign
id|TXS_BUSY
suffix:semicolon
id|scc-&gt;t_dwait
op_assign
(paren
id|scc-&gt;kiss.fulldup
ques
c_cond
l_int|0
suffix:colon
id|scc-&gt;kiss.waittime
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|kiss_store_byte
r_static
r_void
id|kiss_store_byte
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
comma
r_int
r_char
id|ch
)paren
(brace
r_if
c_cond
(paren
id|scc-&gt;sndq2
op_eq
id|NULLBUF
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;sndq2-&gt;cnt
op_eq
id|scc-&gt;sndq2-&gt;size
)paren
multiline_comment|/* buffer full? */
(brace
r_if
c_cond
(paren
(paren
id|scc-&gt;sndq2
op_assign
id|scc_get_buffer
c_func
(paren
id|BT_TRANSMIT
)paren
)paren
op_eq
id|NULLBUF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;nsccdrv: running out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|scc_append_to_chain
c_func
(paren
op_amp
id|scc-&gt;sndq1
comma
id|scc-&gt;sndq2
)paren
suffix:semicolon
multiline_comment|/* add buffer */
)brace
id|scc-&gt;sndq2-&gt;data
(braket
id|scc-&gt;sndq2-&gt;cnt
op_increment
)braket
op_assign
id|ch
suffix:semicolon
)brace
DECL|function|kiss_decode
r_static
r_inline
r_int
id|kiss_decode
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
comma
r_int
r_char
id|ch
)paren
(brace
r_switch
c_cond
(paren
id|scc-&gt;stat.tx_kiss_state
)paren
(brace
r_case
id|KISS_IDLE
suffix:colon
r_if
c_cond
(paren
id|ch
op_eq
id|FEND
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|scc-&gt;sndq2
op_assign
id|scc-&gt;sndq1
op_assign
id|scc_get_buffer
c_func
(paren
id|BT_TRANSMIT
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|scc-&gt;stat.tx_kiss_state
op_assign
id|KISS_DATA
suffix:semicolon
)brace
r_else
id|scc-&gt;stat.txerrs
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KISS_DATA
suffix:colon
r_if
c_cond
(paren
id|ch
op_eq
id|FESC
)paren
id|scc-&gt;stat.tx_kiss_state
op_assign
id|KISS_ESCAPE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ch
op_eq
id|FEND
)paren
(brace
id|kiss_interpret_frame
c_func
(paren
id|scc
)paren
suffix:semicolon
id|scc-&gt;stat.tx_kiss_state
op_assign
id|KISS_IDLE
suffix:semicolon
)brace
r_else
id|kiss_store_byte
c_func
(paren
id|scc
comma
id|ch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KISS_ESCAPE
suffix:colon
r_if
c_cond
(paren
id|ch
op_eq
id|TFEND
)paren
(brace
id|kiss_store_byte
c_func
(paren
id|scc
comma
id|FEND
)paren
suffix:semicolon
id|scc-&gt;stat.tx_kiss_state
op_assign
id|KISS_DATA
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ch
op_eq
id|TFESC
)paren
(brace
id|kiss_store_byte
c_func
(paren
id|scc
comma
id|FESC
)paren
suffix:semicolon
id|scc-&gt;stat.tx_kiss_state
op_assign
id|KISS_DATA
suffix:semicolon
)brace
r_else
(brace
id|scc_free_chain
c_func
(paren
id|scc-&gt;sndq1
comma
id|BT_TRANSMIT
)paren
suffix:semicolon
id|scc-&gt;sndq2
op_assign
id|NULLBUF
suffix:semicolon
id|scc-&gt;stat.txerrs
op_increment
suffix:semicolon
id|scc-&gt;stat.tx_kiss_state
op_assign
id|KISS_IDLE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* switch */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************* */
multiline_comment|/* *&t;&t;Init channel structures, special HW, etc...&t;     * */
multiline_comment|/* ******************************************************************* */
r_static
r_void
DECL|function|z8530_init
id|z8530_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
suffix:semicolon
r_int
id|chip
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* reset all scc chips */
r_for
c_loop
(paren
id|chip
op_assign
l_int|0
suffix:semicolon
id|chip
OL
id|Nchips
suffix:semicolon
id|chip
op_increment
)paren
(brace
multiline_comment|/* Special SCC cards */
r_if
c_cond
(paren
id|Board
op_amp
id|EAGLE
)paren
(brace
multiline_comment|/* this is an EAGLE card */
id|Outb
c_func
(paren
id|Special_Port
comma
l_int|0x08
)paren
suffix:semicolon
)brace
multiline_comment|/* enable interrupt on the board */
r_if
c_cond
(paren
id|Board
op_amp
(paren
id|PC100
op_or
id|PRIMUS
)paren
)paren
(brace
multiline_comment|/* this is a PC100/EAGLE card */
id|Outb
c_func
(paren
id|Special_Port
comma
id|Option
)paren
suffix:semicolon
)brace
multiline_comment|/* set the MODEM mode (22H normally) */
id|scc
op_assign
op_amp
id|SCC_Info
(braket
l_int|2
op_star
id|chip
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scc-&gt;ctrl
)paren
r_continue
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R9
comma
id|FHWRES
)paren
suffix:semicolon
multiline_comment|/* force hardware reset */
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R9
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* end hardware reset */
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R9
comma
id|CHRA
)paren
suffix:semicolon
multiline_comment|/* reset channel A */
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R9
comma
id|CHRB
)paren
suffix:semicolon
multiline_comment|/* reset channel B */
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* No Rx irq from channel A */
id|scc
op_assign
op_amp
id|SCC_Info
(braket
l_int|2
op_star
id|chip
op_plus
l_int|1
)braket
suffix:semicolon
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* No Rx irq from channel B */
id|scc
op_assign
op_amp
id|SCC_Info
(braket
l_int|2
op_star
id|chip
)braket
suffix:semicolon
id|OutReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R2
comma
id|chip
op_star
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Set Interrupt vector */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|Ivec
op_eq
l_int|2
)paren
id|Ivec
op_assign
l_int|9
suffix:semicolon
id|request_irq
c_func
(paren
id|Ivec
comma
id|scc_isr
comma
id|SA_INTERRUPT
comma
l_string|&quot;AX.25 SCC&quot;
)paren
suffix:semicolon
id|Driver_Initialized
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************** */
multiline_comment|/* * &t;Filesystem Routines: open, close, ioctl, settermios, etc      * */
multiline_comment|/* ******************************************************************** */
multiline_comment|/* scc_paranoia_check(): warn user if something went wrong&t;&t;*/
DECL|function|scc_paranoia_check
r_static
r_inline
r_int
id|scc_paranoia_check
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
comma
id|dev_t
id|device
comma
r_const
r_char
op_star
id|routine
)paren
(brace
macro_line|#ifdef SCC_PARANOIA_CHECK
r_static
r_const
r_char
op_star
id|badmagic
op_assign
l_string|&quot;Warning: bad magic number for Z8530 SCC struct (%d, %d) in %s&bslash;n&quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|badinfo
op_assign
l_string|&quot;Warning: Z8530 not found for (%d, %d) in %s&bslash;n&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scc-&gt;init
)paren
(brace
id|printk
c_func
(paren
id|badinfo
comma
id|MAJOR
c_func
(paren
id|device
)paren
comma
id|MINOR
c_func
(paren
id|device
)paren
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scc-&gt;magic
op_ne
id|SCC_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|badmagic
comma
id|MAJOR
c_func
(paren
id|device
)paren
comma
id|MINOR
c_func
(paren
id|device
)paren
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----&gt; this one is called whenever you open the device &lt;---- */
DECL|function|scc_open
r_int
id|scc_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
suffix:semicolon
r_int
id|chan
suffix:semicolon
id|chan
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chan
OL
l_int|0
)paren
op_logical_or
(paren
id|chan
op_ge
(paren
id|Nchips
op_star
l_int|2
)paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|scc
op_assign
op_amp
id|SCC_Info
(braket
id|chan
)braket
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|scc
suffix:semicolon
id|tty-&gt;termios-&gt;c_iflag
op_assign
id|IGNBRK
op_or
id|IGNPAR
suffix:semicolon
id|tty-&gt;termios-&gt;c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CLOCAL
suffix:semicolon
id|tty-&gt;termios-&gt;c_cflag
op_and_assign
op_complement
id|CBAUD
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Driver_Initialized
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;magic
op_ne
id|SCC_MAGIC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: scc_open(): bad magic number for device (%d, %d)&quot;
comma
id|MAJOR
c_func
(paren
id|tty-&gt;device
)paren
comma
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scc-&gt;tty
op_ne
l_int|NULL
)paren
(brace
id|scc-&gt;tty_opened
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|scc-&gt;init
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|scc-&gt;tty
op_assign
id|tty
suffix:semicolon
id|init_channel
c_func
(paren
id|scc
)paren
suffix:semicolon
id|scc-&gt;stat.tx_kiss_state
op_assign
id|KISS_IDLE
suffix:semicolon
multiline_comment|/* don&squot;t change this... */
id|scc-&gt;stat.rx_kiss_state
op_assign
id|KISS_IDLE
suffix:semicolon
multiline_comment|/* ...or this */
id|scc_init_timer
c_func
(paren
id|scc
)paren
suffix:semicolon
id|timer_table
(braket
id|SCC_TIMER
)braket
dot
id|fn
op_assign
id|scc_timer
suffix:semicolon
id|timer_table
(braket
id|SCC_TIMER
)braket
dot
id|expires
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* now! */
id|timer_active
op_or_assign
l_int|1
op_lshift
id|SCC_TIMER
suffix:semicolon
multiline_comment|/*====================new pe1ayx====================&n;planed for the new TX routines&n;&n;&t;if (!scc-&gt;xmit_buf) {&n;&t;&t;scc-&gt;xmit_buf = (unsigned char *) get_free_page(GFP_KERNEL);&n;&t;&t;if (!scc-&gt;xmit_buf)&n;&t;&t;&t;return -ENOMEM;&n;&t;}&n;&n;&t;scc-&gt;xmit_cnt = scc-&gt;xmit_head = scc-&gt;xmit_tail = 0;&n;&n;&n;====================new pe1ayx end================*/
r_if
c_cond
(paren
op_logical_neg
id|tmp_buf
)paren
(brace
id|tmp_buf
op_assign
(paren
r_int
r_char
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp_buf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----&gt; and this whenever you close the device &lt;---- */
r_static
r_void
DECL|function|scc_close
id|scc_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scc
op_logical_or
(paren
id|scc-&gt;magic
op_ne
id|SCC_MAGIC
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;tty_opened
)paren
(brace
id|scc-&gt;tty_opened
op_decrement
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tty-&gt;driver_data
op_assign
id|NULLBUF
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|Outb
c_func
(paren
id|scc-&gt;ctrl
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Make sure pointer is written */
id|wr
c_func
(paren
id|scc
comma
id|R1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|wr
c_func
(paren
id|scc
comma
id|R3
comma
l_int|0
)paren
suffix:semicolon
id|scc-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|tty-&gt;stopped
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * change scc_speed&n; */
r_static
r_void
DECL|function|scc_change_speed
id|scc_change_speed
c_func
(paren
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_if
c_cond
(paren
id|scc-&gt;tty
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|scc-&gt;modem.speed
op_assign
id|baud_table
(braket
id|scc-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|CBAUD
)braket
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;stat.tx_state
op_eq
l_int|0
)paren
multiline_comment|/* only switch baudrate on rx... ;-) */
id|set_speed
c_func
(paren
id|scc
)paren
suffix:semicolon
)brace
multiline_comment|/* ----&gt; ioctl-routine of the driver &lt;---- */
multiline_comment|/* perform ioctl on SCC (sdlc) channel&n; * this is used for AX.25 mode, and will set the &quot;kiss&quot; parameters&n; */
multiline_comment|/* TIOCMGET &t;- get modem status&t;arg: (unsigned long *) arg&n; * TIOCMBIS &t;- set PTT&t;&t;arg: ---&n; * TIOCMBIC &t;- reset PTT&t;&t;arg: ---&n; * TIOCMBIC &t;- set PTT&t;&t;arg: ---&n; * TIOCSCCINI&t;- initialize driver&t;arg: ---&n; * TIOCCHANINI&t;- initialize channel&t;arg: (struct scc_modem *) arg&n; * TIOCGKISS&t;- get level 1 parameter&t;arg: (struct ioctl_command *) arg&n; * TIOCSKISS&t;- set level 1 parameter arg: (struct ioctl_command *) arg&n; * TIOCSCCSTAT  - get driver status&t;arg: (struct scc_stat *) arg&n; */
r_static
r_int
DECL|function|scc_ioctl
id|scc_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
comma
id|r
suffix:semicolon
r_int
r_int
id|result
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
r_struct
id|ioctl_command
id|kiss_cmd
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;magic
op_ne
id|SCC_MAGIC
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR: scc_ioctl(): bad magic number for device %d,%d&quot;
comma
id|MAJOR
c_func
(paren
id|tty-&gt;device
)paren
comma
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|r
op_assign
id|NO_SUCH_PARAM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Driver_Initialized
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|TIOCSCCINI
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|scc_alloc_buffer_pool
c_func
(paren
)paren
suffix:semicolon
id|z8530_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* confuse the user */
)brace
r_if
c_cond
(paren
op_logical_neg
id|scc-&gt;init
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|TIOCCHANINI
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|scc-&gt;modem
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|scc_modem
)paren
)paren
suffix:semicolon
multiline_comment|/* default KISS Params */
r_if
c_cond
(paren
id|scc-&gt;modem.speed
OL
l_int|4800
)paren
(brace
id|scc-&gt;kiss.txdelay
op_assign
l_int|36
op_star
id|TPS
op_div
l_int|100
suffix:semicolon
multiline_comment|/* 360 ms */
id|scc-&gt;kiss.persist
op_assign
l_int|42
suffix:semicolon
multiline_comment|/* 25% persistence */
multiline_comment|/* was 25 */
id|scc-&gt;kiss.slottime
op_assign
l_int|16
op_star
id|TPS
op_div
l_int|100
suffix:semicolon
multiline_comment|/* 160 ms */
id|scc-&gt;kiss.tailtime
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* minimal reasonable value */
id|scc-&gt;kiss.fulldup
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CSMA */
id|scc-&gt;kiss.waittime
op_assign
l_int|50
op_star
id|TPS
op_div
l_int|100
suffix:semicolon
multiline_comment|/* 500 ms */
id|scc-&gt;kiss.maxkeyup
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* 10 s */
id|scc-&gt;kiss.mintime
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* 3 s */
id|scc-&gt;kiss.idletime
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* 30 s */
id|scc-&gt;kiss.maxdefer
op_assign
l_int|120
suffix:semicolon
multiline_comment|/* 2 min */
id|scc-&gt;kiss.not_slip
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* KISS mode */
id|scc-&gt;kiss.softdcd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* hardware dcd */
)brace
r_else
(brace
id|scc-&gt;kiss.txdelay
op_assign
l_int|10
op_star
id|TPS
op_div
l_int|100
suffix:semicolon
multiline_comment|/* 100 ms */
id|scc-&gt;kiss.persist
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* 25% persistence */
multiline_comment|/* was 25 */
id|scc-&gt;kiss.slottime
op_assign
l_int|8
op_star
id|TPS
op_div
l_int|100
suffix:semicolon
multiline_comment|/* 160 ms */
id|scc-&gt;kiss.tailtime
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* minimal reasonable value */
id|scc-&gt;kiss.fulldup
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CSMA */
id|scc-&gt;kiss.waittime
op_assign
l_int|50
op_star
id|TPS
op_div
l_int|100
suffix:semicolon
multiline_comment|/* 500 ms */
id|scc-&gt;kiss.maxkeyup
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* 7 s */
id|scc-&gt;kiss.mintime
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* 3 s */
id|scc-&gt;kiss.idletime
op_assign
l_int|30
suffix:semicolon
multiline_comment|/* 30 s */
id|scc-&gt;kiss.maxdefer
op_assign
l_int|120
suffix:semicolon
multiline_comment|/* 2 min */
id|scc-&gt;kiss.not_slip
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* KISS mode */
id|scc-&gt;kiss.softdcd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* hardware dcd */
)brace
id|scc-&gt;init
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TCSBRK
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMGET
suffix:colon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
r_int
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|scc-&gt;wreg
(braket
id|R5
)braket
op_amp
id|RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|scc-&gt;wreg
(braket
id|R5
)braket
op_amp
id|DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|InReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R0
)paren
op_amp
id|DCD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|InReg
c_func
(paren
id|scc-&gt;ctrl
comma
id|R0
)paren
op_amp
id|CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|put_fs_long
c_func
(paren
id|result
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_case
id|TIOCMBIC
suffix:colon
r_case
id|TIOCMSET
suffix:colon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMBIS
suffix:colon
id|scc-&gt;wreg
(braket
id|R5
)braket
op_or_assign
id|DTR
suffix:semicolon
id|scc-&gt;wreg
(braket
id|R5
)braket
op_or_assign
id|RTS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
id|scc-&gt;wreg
(braket
id|R5
)braket
op_and_assign
op_complement
id|DTR
suffix:semicolon
id|scc-&gt;wreg
(braket
id|R5
)braket
op_and_assign
op_complement
id|RTS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
id|value
op_assign
id|get_fs_long
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
id|TIOCM_DTR
)paren
(brace
id|scc-&gt;wreg
(braket
id|R5
)braket
op_or_assign
id|DTR
suffix:semicolon
)brace
r_else
id|scc-&gt;wreg
(braket
id|R5
)braket
op_and_assign
op_complement
id|DTR
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
id|TIOCM_RTS
)paren
(brace
id|scc-&gt;wreg
(braket
id|R5
)braket
op_or_assign
id|RTS
suffix:semicolon
)brace
r_else
id|scc-&gt;wreg
(braket
id|R5
)braket
op_and_assign
op_complement
id|RTS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;stat.tx_state
op_eq
id|TXS_IDLE
op_logical_and
op_logical_neg
id|Running
c_func
(paren
id|t_idle
)paren
)paren
(brace
id|maxk_idle_timeout
c_func
(paren
id|scc
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCGETS
suffix:colon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|termios
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|scc-&gt;tty-&gt;termios
comma
r_sizeof
(paren
r_struct
id|termios
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCSETS
suffix:colon
r_case
id|TCSETSF
suffix:colon
multiline_comment|/* should flush first, but... */
r_case
id|TCSETSW
suffix:colon
multiline_comment|/* should wait &squot;till flush, but... */
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|scc-&gt;tty-&gt;termios
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|termios
)paren
)paren
suffix:semicolon
id|scc_change_speed
c_func
(paren
id|scc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TIOCSCCSTAT
suffix:colon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|scc_stat
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|scc-&gt;stat.used_buf
op_assign
id|scc_count_used_buffers
c_func
(paren
op_amp
id|scc-&gt;stat.rx_alloc
comma
op_amp
id|scc-&gt;stat.tx_alloc
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|scc-&gt;stat
comma
r_sizeof
(paren
r_struct
id|scc_stat
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
DECL|macro|TICKS
mdefine_line|#define TICKS (100/TPS)
DECL|macro|CAST
mdefine_line|#define CAST(x) (unsigned long)(x)
DECL|macro|Val
mdefine_line|#define  Val&t;kiss_cmd.param
DECL|macro|VAL
mdefine_line|#define  VAL&t;kiss_cmd.param*TPS/100
DECL|macro|SVAL
mdefine_line|#define SVAL&t;kiss_cmd.param? kiss_cmd.param:TIMER_STOPPED
r_case
id|TIOCGKISS
suffix:colon
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|ioctl_command
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|kiss_cmd
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|ioctl_command
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|kiss_cmd.command
)paren
(brace
r_case
id|PARAM_TXDELAY
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.txdelay
op_star
id|TICKS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_PERSIST
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.persist
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_SLOTTIME
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.slottime
op_star
id|TICKS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_TXTAIL
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.tailtime
op_star
id|TICKS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_FULLDUP
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.fulldup
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_SOFTDCD
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.softdcd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_DTR
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
(paren
id|scc-&gt;wreg
(braket
id|R5
)braket
op_amp
id|DTR
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_RTS
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
(paren
id|scc-&gt;wreg
(braket
id|R5
)braket
op_amp
id|RTS
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_SPEED
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;modem.speed
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_GROUP
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.group
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_IDLE
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.idletime
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_MIN
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.mintime
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_MAXKEY
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.maxkeyup
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_WAIT
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.waittime
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_MAXDEFER
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.maxdefer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_TX
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
id|scc-&gt;kiss.tx_inhibit
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_SLIP
suffix:colon
id|r
op_assign
id|CAST
c_func
(paren
op_logical_neg
id|scc-&gt;kiss.not_slip
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|r
op_assign
id|NO_SUCH_PARAM
suffix:semicolon
)brace
id|kiss_cmd.param
op_assign
id|r
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|kiss_cmd
comma
r_sizeof
(paren
r_struct
id|ioctl_command
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSKISS
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|kiss_cmd
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|ioctl_command
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|kiss_cmd.command
)paren
(brace
r_case
id|PARAM_TXDELAY
suffix:colon
id|scc-&gt;kiss.txdelay
op_assign
id|VAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_PERSIST
suffix:colon
id|scc-&gt;kiss.persist
op_assign
id|Val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_SLOTTIME
suffix:colon
id|scc-&gt;kiss.slottime
op_assign
id|VAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_TXTAIL
suffix:colon
id|scc-&gt;kiss.tailtime
op_assign
id|VAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_FULLDUP
suffix:colon
id|scc-&gt;kiss.fulldup
op_assign
id|Val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_SOFTDCD
suffix:colon
id|scc-&gt;kiss.softdcd
op_assign
id|Val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_DTR
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* does someone need this? */
r_case
id|PARAM_RTS
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* or this? */
r_case
id|PARAM_SPEED
suffix:colon
id|scc-&gt;modem.speed
op_assign
id|Val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_GROUP
suffix:colon
id|scc-&gt;kiss.group
op_assign
id|Val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_IDLE
suffix:colon
id|scc-&gt;kiss.idletime
op_assign
id|Val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_MIN
suffix:colon
id|scc-&gt;kiss.mintime
op_assign
id|SVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_MAXKEY
suffix:colon
id|scc-&gt;kiss.maxkeyup
op_assign
id|SVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_WAIT
suffix:colon
id|scc-&gt;kiss.waittime
op_assign
id|Val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_MAXDEFER
suffix:colon
id|scc-&gt;kiss.maxdefer
op_assign
id|SVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_TX
suffix:colon
id|scc-&gt;kiss.tx_inhibit
op_assign
id|Val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARAM_SLIP
suffix:colon
id|scc-&gt;kiss.not_slip
op_assign
op_logical_neg
id|Val
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
DECL|macro|TICKS
macro_line|#undef TICKS
DECL|macro|CAST
macro_line|#undef CAST
DECL|macro|VAL
macro_line|#undef VAL
DECL|macro|SVAL
macro_line|#undef SVAL
DECL|macro|Val
macro_line|#undef Val
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
multiline_comment|/* ----- TERMIOS function ----- */
r_static
r_void
DECL|function|scc_set_termios
id|scc_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
r_return
suffix:semicolon
id|scc_change_speed
c_func
(paren
id|tty-&gt;driver_data
)paren
suffix:semicolon
)brace
DECL|function|check_tx_queue
r_static
r_inline
r_void
id|check_tx_queue
c_func
(paren
r_register
r_struct
id|scc_channel
op_star
id|scc
)paren
(brace
r_register
r_struct
id|mbuf
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;stat.tx_queued
OG
id|QUEUE_THRES
)paren
(brace
r_if
c_cond
(paren
id|scc-&gt;sndq1
op_eq
id|NULLBUF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;z8530drv: Warning - scc-&gt;stat.tx_queued shows overflow&quot;
l_string|&quot; (%d) but queue is empty&bslash;n&quot;
comma
id|scc-&gt;stat.tx_queued
)paren
suffix:semicolon
id|scc-&gt;stat.tx_queued
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* correct it */
id|scc-&gt;stat.nospace
op_assign
l_int|54321
suffix:semicolon
multiline_comment|/* draw attention to it */
r_return
suffix:semicolon
)brace
id|bp
op_assign
id|scc-&gt;sndq1-&gt;anext
suffix:semicolon
multiline_comment|/* don&squot;t use the one we currently use */
r_while
c_loop
(paren
id|bp
op_logical_and
(paren
id|scc-&gt;stat.tx_queued
OG
id|QUEUE_HYST
)paren
)paren
(brace
id|bp
op_assign
id|scc_free_chain
c_func
(paren
id|bp
comma
id|BT_TRANSMIT
)paren
suffix:semicolon
id|scc-&gt;stat.tx_queued
op_decrement
suffix:semicolon
id|scc-&gt;stat.nospace
op_increment
suffix:semicolon
)brace
id|scc-&gt;sndq1-&gt;anext
op_assign
id|bp
suffix:semicolon
)brace
)brace
multiline_comment|/* ----&gt; tx routine: decode KISS data and scc_enqueue it &lt;---- */
multiline_comment|/* send raw frame to SCC. used for AX.25 */
DECL|function|scc_write
r_int
id|scc_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_static
r_int
r_char
op_star
id|p
suffix:semicolon
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|cnt
comma
id|cnt2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|tmp_buf
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_write&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;kiss.tx_inhibit
)paren
r_return
id|count
suffix:semicolon
id|check_tx_queue
c_func
(paren
id|scc
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cnt2
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|cnt2
)paren
(brace
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cnt
op_assign
id|cnt2
OG
id|SERIAL_XMIT_SIZE
ques
c_cond
id|SERIAL_XMIT_SIZE
suffix:colon
id|cnt2
suffix:semicolon
id|cnt2
op_sub_assign
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|down
c_func
(paren
op_amp
id|tmp_buf_sem
)paren
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|tmp_buf
comma
id|buf
comma
id|cnt
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|tmp_buf_sem
)paren
suffix:semicolon
)brace
r_else
id|memcpy
c_func
(paren
id|tmp_buf
comma
id|buf
comma
id|cnt
)paren
suffix:semicolon
id|buf
op_add_assign
id|cnt
suffix:semicolon
id|p
op_assign
id|tmp_buf
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
r_if
c_cond
(paren
id|kiss_decode
c_func
(paren
id|scc
comma
op_star
id|p
op_increment
)paren
)paren
(brace
id|scc-&gt;stat.nospace
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* while cnt2 */
r_if
c_cond
(paren
(paren
id|scc-&gt;tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|scc-&gt;tty-&gt;ldisc.write_wakeup
)paren
(paren
id|scc-&gt;tty-&gt;ldisc.write_wakeup
)paren
(paren
id|scc-&gt;tty
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* put a single char into the buffer */
DECL|function|scc_put_char
r_static
r_void
id|scc_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_char
id|ch2
suffix:semicolon
r_if
c_cond
(paren
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_put_char&quot;
)paren
)paren
r_return
suffix:semicolon
id|ch2
op_assign
id|ch
suffix:semicolon
id|scc_write
c_func
(paren
id|tty
comma
l_int|0
comma
op_amp
id|ch2
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* that&squot;s all */
)brace
DECL|function|scc_flush_chars
r_static
r_void
id|scc_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_flush_chars&quot;
)paren
suffix:semicolon
multiline_comment|/* just to annoy the user... */
r_return
suffix:semicolon
multiline_comment|/* no flush needed */
)brace
multiline_comment|/* the kernel does NOT use this routine yet... */
DECL|function|scc_write_room
r_static
r_int
id|scc_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_write_room&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|scc-&gt;stat.tx_alloc
op_ge
id|QUEUE_THRES
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;scc_write_room(): buffer full (ignore)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|BUFSIZE
suffix:semicolon
)brace
DECL|function|scc_chars_in_buffer
r_static
r_int
id|scc_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|scc
op_logical_and
id|scc-&gt;sndq2
)paren
r_return
id|scc-&gt;sndq2-&gt;cnt
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scc_flush_buffer
r_static
r_void
id|scc_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_flush_buffer&quot;
)paren
)paren
r_return
suffix:semicolon
id|scc-&gt;stat.tx_kiss_state
op_assign
id|KISS_IDLE
suffix:semicolon
)brace
DECL|function|scc_throttle
r_static
r_void
id|scc_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_throttle&quot;
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* dummy */
)brace
DECL|function|scc_unthrottle
r_static
r_void
id|scc_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_unthrottle&quot;
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* dummy */
)brace
DECL|function|scc_start
r_static
r_void
id|scc_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_start&quot;
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* dummy */
)brace
DECL|function|scc_stop
r_static
r_void
id|scc_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_stop&quot;
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* dummy */
)brace
DECL|function|scc_hangup
r_void
id|scc_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|scc_channel
op_star
id|scc
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|scc_paranoia_check
c_func
(paren
id|scc
comma
id|tty-&gt;device
comma
l_string|&quot;scc_hangup&quot;
)paren
)paren
r_return
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************** */
multiline_comment|/* * &t;&t;&t;Init SCC driver &t;&t;&t;      * */
multiline_comment|/* ******************************************************************** */
DECL|function|scc_init
r_int
id|scc_init
(paren
r_int
id|kmem_start
)paren
(brace
r_int
id|chip
suffix:semicolon
macro_line|#ifdef VERBOSE_BOOTMSG
r_int
id|chan
suffix:semicolon
macro_line|#endif&t;
r_register
id|io_port
id|ctrl
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|scc_driver
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|scc_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|scc_driver.name
op_assign
l_string|&quot;sc&quot;
suffix:semicolon
id|scc_driver.major
op_assign
id|TTY_MAJOR
suffix:semicolon
id|scc_driver.minor_start
op_assign
l_int|96
suffix:semicolon
id|scc_driver.num
op_assign
id|Nchips
op_star
l_int|2
suffix:semicolon
id|scc_driver.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|scc_driver.subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
multiline_comment|/* not needed */
id|scc_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|scc_driver.init_termios.c_iflag
op_assign
id|IGNBRK
op_or
id|IGNPAR
suffix:semicolon
id|scc_driver.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CLOCAL
suffix:semicolon
id|scc_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|scc_driver.refcount
op_assign
op_amp
id|scc_refcount
suffix:semicolon
multiline_comment|/* not needed yet */
id|scc_driver.table
op_assign
id|scc_table
suffix:semicolon
id|scc_driver.termios
op_assign
(paren
r_struct
id|termios
op_star
op_star
)paren
id|scc_termios
suffix:semicolon
id|scc_driver.termios_locked
op_assign
(paren
r_struct
id|termios
op_star
op_star
)paren
id|scc_termios_locked
suffix:semicolon
id|scc_driver.open
op_assign
id|scc_open
suffix:semicolon
id|scc_driver.close
op_assign
id|scc_close
suffix:semicolon
id|scc_driver.write
op_assign
id|scc_write
suffix:semicolon
id|scc_driver.put_char
op_assign
id|scc_put_char
suffix:semicolon
id|scc_driver.flush_chars
op_assign
id|scc_flush_chars
suffix:semicolon
id|scc_driver.write_room
op_assign
id|scc_write_room
suffix:semicolon
id|scc_driver.chars_in_buffer
op_assign
id|scc_chars_in_buffer
suffix:semicolon
id|scc_driver.flush_buffer
op_assign
id|scc_flush_buffer
suffix:semicolon
id|scc_driver.ioctl
op_assign
id|scc_ioctl
suffix:semicolon
id|scc_driver.throttle
op_assign
id|scc_throttle
suffix:semicolon
id|scc_driver.unthrottle
op_assign
id|scc_unthrottle
suffix:semicolon
id|scc_driver.set_termios
op_assign
id|scc_set_termios
suffix:semicolon
id|scc_driver.stop
op_assign
id|scc_stop
suffix:semicolon
id|scc_driver.start
op_assign
id|scc_start
suffix:semicolon
id|scc_driver.hangup
op_assign
id|scc_hangup
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|scc_driver
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t register Z8530 SCC driver&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|BANNER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Nchips
OG
id|MAXSCC
)paren
id|Nchips
op_assign
id|MAXSCC
suffix:semicolon
multiline_comment|/* to avoid the &quot;DAU&quot; (duemmster anzunehmender User) */
multiline_comment|/* reset and pre-init all chips in the system */
r_for
c_loop
(paren
id|chip
op_assign
l_int|0
suffix:semicolon
id|chip
OL
id|Nchips
suffix:semicolon
id|chip
op_increment
)paren
(brace
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|SCC_Info
(braket
l_int|2
op_star
id|chip
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scc_channel
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|SCC_Info
(braket
l_int|2
op_star
id|chip
op_plus
l_int|1
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scc_channel
)paren
)paren
suffix:semicolon
id|ctrl
op_assign
id|SCC_ctrl
(braket
id|chip
op_star
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctrl
)paren
r_continue
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* because of 2-step accesses */
multiline_comment|/* Hmm... this may fail on fast systems with cards who don&squot;t delay the INTACK */
multiline_comment|/* If you are sure you specified the right port addresses and the driver doesn&squot;t */
multiline_comment|/* recognize the chips, define DONT_CHECK in scc_config.h */
macro_line|#ifndef DONT_CHECK
id|check_region
c_func
(paren
id|ctrl
comma
l_int|1
)paren
suffix:semicolon
id|Outb
c_func
(paren
id|ctrl
comma
l_int|0
)paren
suffix:semicolon
id|OutReg
c_func
(paren
id|ctrl
comma
id|R13
comma
l_int|0x55
)paren
suffix:semicolon
multiline_comment|/* is this chip realy there? */
r_if
c_cond
(paren
id|InReg
c_func
(paren
id|ctrl
comma
id|R13
)paren
op_ne
l_int|0x55
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
id|SCC_Info
(braket
l_int|2
op_star
id|chip
)braket
dot
id|magic
op_assign
id|SCC_MAGIC
suffix:semicolon
id|SCC_Info
(braket
l_int|2
op_star
id|chip
)braket
dot
id|ctrl
op_assign
id|SCC_ctrl
(braket
l_int|2
op_star
id|chip
)braket
suffix:semicolon
id|SCC_Info
(braket
l_int|2
op_star
id|chip
)braket
dot
id|data
op_assign
id|SCC_data
(braket
l_int|2
op_star
id|chip
)braket
suffix:semicolon
id|SCC_Info
(braket
l_int|2
op_star
id|chip
)braket
dot
id|enhanced
op_assign
id|SCC_Enhanced
(braket
id|chip
)braket
suffix:semicolon
id|SCC_Info
(braket
l_int|2
op_star
id|chip
op_plus
l_int|1
)braket
dot
id|magic
op_assign
id|SCC_MAGIC
suffix:semicolon
id|SCC_Info
(braket
l_int|2
op_star
id|chip
op_plus
l_int|1
)braket
dot
id|ctrl
op_assign
id|SCC_ctrl
(braket
l_int|2
op_star
id|chip
op_plus
l_int|1
)braket
suffix:semicolon
id|SCC_Info
(braket
l_int|2
op_star
id|chip
op_plus
l_int|1
)braket
dot
id|data
op_assign
id|SCC_data
(braket
l_int|2
op_star
id|chip
op_plus
l_int|1
)braket
suffix:semicolon
id|SCC_Info
(braket
l_int|2
op_star
id|chip
op_plus
l_int|1
)braket
dot
id|enhanced
op_assign
id|SCC_Enhanced
(braket
id|chip
)braket
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef VERBOSE_BOOTMSG
id|printk
c_func
(paren
l_string|&quot;Init Z8530 driver: %u channels, using irq %u&bslash;n&quot;
comma
id|Nchips
op_star
l_int|2
comma
id|Ivec
)paren
suffix:semicolon
r_for
c_loop
(paren
id|chan
op_assign
l_int|0
suffix:semicolon
id|chan
OL
id|Nchips
op_star
l_int|2
suffix:semicolon
id|chan
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;/dev/%s%i: data port = 0x%3.3x  control port = 0x%3.3x -- %s&bslash;n&quot;
comma
id|scc_driver.name
comma
id|chan
comma
id|SCC_data
(braket
id|chan
)braket
comma
id|SCC_ctrl
(braket
id|chan
)braket
comma
id|SCC_Info
(braket
id|chan
)braket
dot
id|ctrl
ques
c_cond
l_string|&quot;found&quot;
suffix:colon
l_string|&quot;missing&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCC_Info
(braket
id|chan
)braket
dot
id|ctrl
op_eq
l_int|0
)paren
(brace
id|SCC_ctrl
(braket
id|chan
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|request_region
c_func
(paren
id|SCC_ctrl
(braket
id|chan
)braket
comma
l_int|1
comma
l_string|&quot;scc ctrl&quot;
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|SCC_data
(braket
id|chan
)braket
comma
l_int|1
comma
l_string|&quot;scc data&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
id|printk
c_func
(paren
l_string|&quot;Init Z8530 driver: %u channels&bslash;n&quot;
comma
id|Nchips
op_star
l_int|2
)paren
suffix:semicolon
macro_line|#endif
r_return
id|kmem_start
suffix:semicolon
)brace
macro_line|#endif
eof
