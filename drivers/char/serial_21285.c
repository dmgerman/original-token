multiline_comment|/*&n; * linux/drivers/char/serial_21285.c&n; *&n; * Driver for the serial port on the 21285 StrongArm-110 core logic chip.&n; *&n; * Based on drivers/char/serial.c&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/dec21285.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
DECL|macro|BAUD_BASE
mdefine_line|#define BAUD_BASE&t;&t;(mem_fclk_21285/64)
DECL|macro|SERIAL_21285_NAME
mdefine_line|#define SERIAL_21285_NAME&t;&quot;ttyFB&quot;
DECL|macro|SERIAL_21285_MAJOR
mdefine_line|#define SERIAL_21285_MAJOR&t;204
DECL|macro|SERIAL_21285_MINOR
mdefine_line|#define SERIAL_21285_MINOR&t;4
DECL|macro|SERIAL_21285_AUXNAME
mdefine_line|#define SERIAL_21285_AUXNAME&t;&quot;cuafb&quot;
DECL|macro|SERIAL_21285_AUXMAJOR
mdefine_line|#define SERIAL_21285_AUXMAJOR&t;205
DECL|macro|SERIAL_21285_AUXMINOR
mdefine_line|#define SERIAL_21285_AUXMINOR&t;4
DECL|variable|rs285_driver
DECL|variable|callout_driver
r_static
r_struct
id|tty_driver
id|rs285_driver
comma
id|callout_driver
suffix:semicolon
DECL|variable|rs285_refcount
r_static
r_int
id|rs285_refcount
suffix:semicolon
DECL|variable|rs285_table
r_static
r_struct
id|tty_struct
op_star
id|rs285_table
(braket
l_int|1
)braket
suffix:semicolon
DECL|variable|rs285_termios
r_static
r_struct
id|termios
op_star
id|rs285_termios
(braket
l_int|1
)braket
suffix:semicolon
DECL|variable|rs285_termios_locked
r_static
r_struct
id|termios
op_star
id|rs285_termios_locked
(braket
l_int|1
)braket
suffix:semicolon
DECL|variable|wbuf
DECL|variable|putp
DECL|variable|getp
DECL|variable|x_char
r_static
r_char
id|wbuf
(braket
l_int|1000
)braket
comma
op_star
id|putp
op_assign
id|wbuf
comma
op_star
id|getp
op_assign
id|wbuf
comma
id|x_char
suffix:semicolon
DECL|variable|rs285_tty
r_static
r_struct
id|tty_struct
op_star
id|rs285_tty
suffix:semicolon
DECL|variable|rs285_use_count
r_static
r_int
id|rs285_use_count
suffix:semicolon
DECL|function|rs285_write_room
r_static
r_int
id|rs285_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
id|putp
op_ge
id|getp
ques
c_cond
(paren
r_sizeof
(paren
id|wbuf
)paren
op_minus
(paren
r_int
)paren
id|putp
op_plus
(paren
r_int
)paren
id|getp
)paren
suffix:colon
(paren
(paren
r_int
)paren
id|getp
op_minus
(paren
r_int
)paren
id|putp
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|rs285_rx_int
r_static
r_void
id|rs285_rx_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rs285_tty
)paren
(brace
id|disable_irq
c_func
(paren
id|IRQ_CONRX
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
op_star
id|CSR_UARTFLG
op_amp
l_int|0x10
)paren
)paren
(brace
r_int
id|ch
comma
id|flag
suffix:semicolon
id|ch
op_assign
op_star
id|CSR_UARTDR
suffix:semicolon
id|flag
op_assign
op_star
id|CSR_RXSTAT
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
l_int|4
)paren
id|tty_insert_flip_char
c_func
(paren
id|rs285_tty
comma
l_int|0
comma
id|TTY_OVERRUN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
l_int|2
)paren
id|flag
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|flag
op_amp
l_int|1
)paren
id|flag
op_assign
id|TTY_FRAME
suffix:semicolon
id|tty_insert_flip_char
c_func
(paren
id|rs285_tty
comma
id|ch
comma
id|flag
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|rs285_tty
)paren
suffix:semicolon
)brace
DECL|function|rs285_send_xchar
r_static
r_void
id|rs285_send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
id|x_char
op_assign
id|ch
suffix:semicolon
id|enable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
)brace
DECL|function|rs285_throttle
r_static
r_void
id|rs285_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|rs285_send_xchar
c_func
(paren
id|tty
comma
id|STOP_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
)brace
DECL|function|rs285_unthrottle
r_static
r_void
id|rs285_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|x_char
)paren
id|x_char
op_assign
l_int|0
suffix:semicolon
r_else
id|rs285_send_xchar
c_func
(paren
id|tty
comma
id|START_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|rs285_tx_int
r_static
r_void
id|rs285_tx_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
op_star
id|CSR_UARTFLG
op_amp
l_int|0x20
)paren
)paren
(brace
r_if
c_cond
(paren
id|x_char
)paren
(brace
op_star
id|CSR_UARTDR
op_assign
id|x_char
suffix:semicolon
id|x_char
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|putp
op_eq
id|getp
)paren
(brace
id|disable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|CSR_UARTDR
op_assign
op_star
id|getp
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|getp
op_ge
id|wbuf
op_plus
r_sizeof
(paren
id|wbuf
)paren
)paren
id|getp
op_assign
id|wbuf
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rs285_tty
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|rs285_tty-&gt;write_wait
)paren
suffix:semicolon
)brace
DECL|function|rs285_xmit
r_static
r_inline
r_int
id|rs285_xmit
c_func
(paren
r_int
id|ch
)paren
(brace
r_if
c_cond
(paren
id|putp
op_plus
l_int|1
op_eq
id|getp
op_logical_or
(paren
id|putp
op_plus
l_int|1
op_eq
id|wbuf
op_plus
r_sizeof
(paren
id|wbuf
)paren
op_logical_and
id|getp
op_eq
id|wbuf
)paren
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|putp
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|putp
op_ge
id|wbuf
op_plus
r_sizeof
(paren
id|wbuf
)paren
)paren
id|putp
op_assign
id|wbuf
suffix:semicolon
id|enable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|rs285_write
r_static
r_int
id|rs285_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
id|u_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|from_user
op_logical_and
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|buf
comma
id|count
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
id|__get_user
c_func
(paren
id|ch
comma
id|buf
op_plus
id|i
)paren
suffix:semicolon
r_else
id|ch
op_assign
id|buf
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rs285_xmit
c_func
(paren
id|ch
)paren
)paren
r_break
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
DECL|function|rs285_put_char
r_static
r_void
id|rs285_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
id|u_char
id|ch
)paren
(brace
id|rs285_xmit
c_func
(paren
id|ch
)paren
suffix:semicolon
)brace
DECL|function|rs285_chars_in_buffer
r_static
r_int
id|rs285_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
r_sizeof
(paren
id|wbuf
)paren
op_minus
id|rs285_write_room
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|rs285_flush_buffer
r_static
r_void
id|rs285_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|disable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
id|putp
op_assign
id|getp
op_assign
id|wbuf
suffix:semicolon
r_if
c_cond
(paren
id|x_char
)paren
id|enable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
)brace
DECL|function|rs285_set_cflag
r_static
r_inline
r_void
id|rs285_set_cflag
c_func
(paren
r_int
id|cflag
)paren
(brace
r_int
id|h_lcr
comma
id|baud
comma
id|quot
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|h_lcr
op_assign
l_int|0x10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|h_lcr
op_assign
l_int|0x30
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|h_lcr
op_assign
l_int|0x50
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* CS8 */
id|h_lcr
op_assign
l_int|0x70
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
id|h_lcr
op_or_assign
l_int|0x08
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
id|h_lcr
op_or_assign
l_int|0x02
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cflag
op_amp
id|PARODD
)paren
)paren
id|h_lcr
op_or_assign
l_int|0x04
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CBAUD
)paren
(brace
r_case
id|B200
suffix:colon
id|baud
op_assign
l_int|200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B300
suffix:colon
id|baud
op_assign
l_int|300
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|baud
op_assign
l_int|1200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1800
suffix:colon
id|baud
op_assign
l_int|1800
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|baud
op_assign
l_int|2400
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|baud
op_assign
l_int|4800
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
id|B9600
suffix:colon
id|baud
op_assign
l_int|9600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|baud
op_assign
l_int|19200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|baud
op_assign
l_int|38400
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|baud
op_assign
l_int|57600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|baud
op_assign
l_int|115200
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The documented expression for selecting the divisor is:&n;&t; *  BAUD_BASE / baud - 1&n;&t; * However, typically BAUD_BASE is not divisible by baud, so&n;&t; * we want to select the divisor that gives us the minimum&n;&t; * error.  Therefore, we want:&n;&t; *  int(BAUD_BASE / baud - 0.5) -&gt;&n;&t; *  int(BAUD_BASE / baud - (baud &gt;&gt; 1) / baud) -&gt;&n;&t; *  int((BAUD_BASE - (baud &gt;&gt; 1)) / baud)&n;&t; */
id|quot
op_assign
(paren
id|BAUD_BASE
op_minus
(paren
id|baud
op_rshift
l_int|1
)paren
)paren
op_div
id|baud
suffix:semicolon
op_star
id|CSR_UARTCON
op_assign
l_int|0
suffix:semicolon
op_star
id|CSR_L_UBRLCR
op_assign
id|quot
op_amp
l_int|0xff
suffix:semicolon
op_star
id|CSR_M_UBRLCR
op_assign
(paren
id|quot
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
suffix:semicolon
op_star
id|CSR_H_UBRLCR
op_assign
id|h_lcr
suffix:semicolon
op_star
id|CSR_UARTCON
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|rs285_set_termios
r_static
r_void
id|rs285_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
r_if
c_cond
(paren
id|old
op_logical_and
id|tty-&gt;termios-&gt;c_cflag
op_eq
id|old-&gt;c_cflag
)paren
r_return
suffix:semicolon
id|rs285_set_cflag
c_func
(paren
id|tty-&gt;termios-&gt;c_cflag
)paren
suffix:semicolon
)brace
DECL|function|rs285_stop
r_static
r_void
id|rs285_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|disable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
)brace
DECL|function|rs285_start
r_static
r_void
id|rs285_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|enable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
)brace
DECL|function|rs285_wait_until_sent
r_static
r_void
id|rs285_wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
(brace
r_int
id|orig_jiffies
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
op_star
id|CSR_UARTFLG
op_amp
l_int|8
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|orig_jiffies
op_plus
id|timeout
)paren
)paren
r_break
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
)brace
DECL|function|rs285_open
r_static
r_int
id|rs285_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|line
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|line
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
suffix:semicolon
r_if
c_cond
(paren
id|line
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|tty-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rs285_tty
)paren
id|rs285_tty
op_assign
id|tty
suffix:semicolon
id|enable_irq
c_func
(paren
id|IRQ_CONRX
)paren
suffix:semicolon
id|rs285_use_count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rs285_close
r_static
r_void
id|rs285_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|rs285_use_count
)paren
(brace
id|rs285_wait_until_sent
c_func
(paren
id|tty
comma
l_int|0
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|IRQ_CONRX
)paren
suffix:semicolon
id|disable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
id|rs285_tty
op_assign
l_int|NULL
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|rs285_init
r_static
r_int
id|__init
id|rs285_init
c_func
(paren
r_void
)paren
(brace
r_int
id|baud
op_assign
id|B9600
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_personal_server
c_func
(paren
)paren
)paren
id|baud
op_assign
id|B57600
suffix:semicolon
id|rs285_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|rs285_driver.driver_name
op_assign
l_string|&quot;serial_21285&quot;
suffix:semicolon
id|rs285_driver.name
op_assign
id|SERIAL_21285_NAME
suffix:semicolon
id|rs285_driver.major
op_assign
id|SERIAL_21285_MAJOR
suffix:semicolon
id|rs285_driver.minor_start
op_assign
id|SERIAL_21285_MINOR
suffix:semicolon
id|rs285_driver.num
op_assign
l_int|1
suffix:semicolon
id|rs285_driver.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|rs285_driver.subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|rs285_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|rs285_driver.init_termios.c_cflag
op_assign
id|baud
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|rs285_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|rs285_driver.refcount
op_assign
op_amp
id|rs285_refcount
suffix:semicolon
id|rs285_driver.table
op_assign
id|rs285_table
suffix:semicolon
id|rs285_driver.termios
op_assign
id|rs285_termios
suffix:semicolon
id|rs285_driver.termios_locked
op_assign
id|rs285_termios_locked
suffix:semicolon
id|rs285_driver.open
op_assign
id|rs285_open
suffix:semicolon
id|rs285_driver.close
op_assign
id|rs285_close
suffix:semicolon
id|rs285_driver.write
op_assign
id|rs285_write
suffix:semicolon
id|rs285_driver.put_char
op_assign
id|rs285_put_char
suffix:semicolon
id|rs285_driver.write_room
op_assign
id|rs285_write_room
suffix:semicolon
id|rs285_driver.chars_in_buffer
op_assign
id|rs285_chars_in_buffer
suffix:semicolon
id|rs285_driver.flush_buffer
op_assign
id|rs285_flush_buffer
suffix:semicolon
id|rs285_driver.throttle
op_assign
id|rs285_throttle
suffix:semicolon
id|rs285_driver.unthrottle
op_assign
id|rs285_unthrottle
suffix:semicolon
id|rs285_driver.send_xchar
op_assign
id|rs285_send_xchar
suffix:semicolon
id|rs285_driver.set_termios
op_assign
id|rs285_set_termios
suffix:semicolon
id|rs285_driver.stop
op_assign
id|rs285_stop
suffix:semicolon
id|rs285_driver.start
op_assign
id|rs285_start
suffix:semicolon
id|rs285_driver.wait_until_sent
op_assign
id|rs285_wait_until_sent
suffix:semicolon
id|callout_driver
op_assign
id|rs285_driver
suffix:semicolon
id|callout_driver.name
op_assign
id|SERIAL_21285_AUXNAME
suffix:semicolon
id|callout_driver.major
op_assign
id|SERIAL_21285_AUXMAJOR
suffix:semicolon
id|callout_driver.subtype
op_assign
id|SERIAL_TYPE_CALLOUT
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|IRQ_CONRX
comma
id|rs285_rx_int
comma
l_int|0
comma
l_string|&quot;rs285&quot;
comma
l_int|NULL
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t get rx irq for rs285&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|IRQ_CONTX
comma
id|rs285_tx_int
comma
l_int|0
comma
l_string|&quot;rs285&quot;
comma
l_int|NULL
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t get tx irq for rs285&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|rs285_driver
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Couldn&squot;t register 21285 serial driver&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|callout_driver
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Couldn&squot;t register 21285 callout driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rs285_fini
r_static
r_void
id|__exit
id|rs285_fini
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|callout_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to unregister 21285 callout driver &quot;
l_string|&quot;(%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|ret
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|rs285_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to unregister 21285 driver (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_CONTX
comma
l_int|NULL
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_CONRX
comma
l_int|NULL
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|rs285_init
id|module_init
c_func
(paren
id|rs285_init
)paren
suffix:semicolon
DECL|variable|rs285_fini
id|module_exit
c_func
(paren
id|rs285_fini
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_21285_CONSOLE
multiline_comment|/************** console driver *****************/
DECL|function|rs285_console_write
r_static
r_void
id|rs285_console_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|s
comma
id|u_int
id|count
)paren
(brace
r_int
id|i
suffix:semicolon
id|disable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
op_star
id|CSR_UARTFLG
op_amp
l_int|0x20
)paren
suffix:semicolon
op_star
id|CSR_UARTDR
op_assign
id|s
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|s
(braket
id|i
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
r_while
c_loop
(paren
op_star
id|CSR_UARTFLG
op_amp
l_int|0x20
)paren
suffix:semicolon
op_star
id|CSR_UARTDR
op_assign
l_char|&squot;&bslash;r&squot;
suffix:semicolon
)brace
)brace
id|enable_irq
c_func
(paren
id|IRQ_CONTX
)paren
suffix:semicolon
)brace
DECL|function|rs285_console_wait_key
r_static
r_int
id|rs285_console_wait_key
c_func
(paren
r_struct
id|console
op_star
id|co
)paren
(brace
r_int
id|c
suffix:semicolon
id|disable_irq
c_func
(paren
id|IRQ_CONRX
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|CSR_UARTFLG
op_amp
l_int|0x10
)paren
suffix:semicolon
id|c
op_assign
op_star
id|CSR_UARTDR
suffix:semicolon
id|enable_irq
c_func
(paren
id|IRQ_CONRX
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
DECL|function|rs285_console_device
r_static
id|kdev_t
id|rs285_console_device
c_func
(paren
r_struct
id|console
op_star
id|c
)paren
(brace
r_return
id|MKDEV
c_func
(paren
id|SERIAL_21285_MAJOR
comma
id|SERIAL_21285_MINOR
)paren
suffix:semicolon
)brace
DECL|function|rs285_console_setup
r_static
r_int
id|__init
id|rs285_console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_int
id|baud
op_assign
l_int|9600
suffix:semicolon
r_int
id|bits
op_assign
l_int|8
suffix:semicolon
r_int
id|parity
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_int
id|cflag
op_assign
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_personal_server
c_func
(paren
)paren
)paren
id|baud
op_assign
l_int|57600
suffix:semicolon
r_if
c_cond
(paren
id|options
)paren
(brace
r_char
op_star
id|s
op_assign
id|options
suffix:semicolon
id|baud
op_assign
id|simple_strtoul
c_func
(paren
id|options
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|s
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|s
op_le
l_char|&squot;9&squot;
)paren
id|s
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
)paren
id|parity
op_assign
op_star
id|s
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
)paren
id|bits
op_assign
op_star
id|s
op_minus
l_char|&squot;0&squot;
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *    Now construct a cflag setting.&n;&t; */
r_switch
c_cond
(paren
id|baud
)paren
(brace
r_case
l_int|1200
suffix:colon
id|cflag
op_or_assign
id|B1200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2400
suffix:colon
id|cflag
op_or_assign
id|B2400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|cflag
op_or_assign
id|B4800
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|cflag
op_or_assign
id|B9600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|cflag
op_or_assign
id|B19200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|cflag
op_or_assign
id|B38400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|cflag
op_or_assign
id|B57600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|cflag
op_or_assign
id|B115200
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cflag
op_or_assign
id|B9600
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|bits
)paren
(brace
r_case
l_int|7
suffix:colon
id|cflag
op_or_assign
id|CS7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cflag
op_or_assign
id|CS8
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|parity
)paren
(brace
r_case
l_char|&squot;o&squot;
suffix:colon
r_case
l_char|&squot;O&squot;
suffix:colon
id|cflag
op_or_assign
id|PARODD
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;e&squot;
suffix:colon
r_case
l_char|&squot;E&squot;
suffix:colon
id|cflag
op_or_assign
id|PARENB
suffix:semicolon
r_break
suffix:semicolon
)brace
id|co-&gt;cflag
op_assign
id|cflag
suffix:semicolon
id|rs285_set_cflag
c_func
(paren
id|cflag
)paren
suffix:semicolon
id|rs285_console_write
c_func
(paren
l_int|NULL
comma
l_string|&quot;&bslash;e[2J&bslash;e[Hboot &quot;
comma
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|options
)paren
id|rs285_console_write
c_func
(paren
l_int|NULL
comma
id|options
comma
id|strlen
c_func
(paren
id|options
)paren
)paren
suffix:semicolon
r_else
id|rs285_console_write
c_func
(paren
l_int|NULL
comma
l_string|&quot;no options&quot;
comma
l_int|10
)paren
suffix:semicolon
id|rs285_console_write
c_func
(paren
l_int|NULL
comma
l_string|&quot;&bslash;n&quot;
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|rs285_cons
r_static
r_struct
id|console
id|rs285_cons
op_assign
(brace
id|name
suffix:colon
id|SERIAL_21285_NAME
comma
id|write
suffix:colon
id|rs285_console_write
comma
id|device
suffix:colon
id|rs285_console_device
comma
id|wait_key
suffix:colon
id|rs285_console_wait_key
comma
id|setup
suffix:colon
id|rs285_console_setup
comma
id|flags
suffix:colon
id|CON_PRINTBUFFER
comma
id|index
suffix:colon
op_minus
l_int|1
comma
)brace
suffix:semicolon
DECL|function|rs285_console_init
r_void
id|__init
id|rs285_console_init
c_func
(paren
r_void
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|rs285_cons
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_SERIAL_21285_CONSOLE */
eof
