multiline_comment|/*&n; *  linux/drivers/char/tga.c&n; *&n; *  Copyright (C) 1995  Jay Estabrook&n; */
multiline_comment|/*&n; *&t;tga.c&n; *&n; * This module exports the console io support for DEC&squot;s TGA&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/kbd_kern.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/consolemap.h&gt;
macro_line|#include &lt;linux/selection.h&gt;
macro_line|#include &lt;linux/console_struct.h&gt;
r_extern
r_struct
id|console
id|vt_console_driver
suffix:semicolon
multiline_comment|/* TGA hardware description (minimal) */
multiline_comment|/*&n; * Offsets within Memory Space&n; */
DECL|macro|TGA_ROM_OFFSET
mdefine_line|#define&t;TGA_ROM_OFFSET&t;&t;&t;0x0000000
DECL|macro|TGA_REGS_OFFSET
mdefine_line|#define&t;TGA_REGS_OFFSET&t;&t;&t;0x0100000
DECL|macro|TGA_8PLANE_FB_OFFSET
mdefine_line|#define&t;TGA_8PLANE_FB_OFFSET&t;&t;0x0200000
DECL|macro|TGA_24PLANE_FB_OFFSET
mdefine_line|#define&t;TGA_24PLANE_FB_OFFSET&t;&t;0x0804000
DECL|macro|TGA_24PLUSZ_FB_OFFSET
mdefine_line|#define&t;TGA_24PLUSZ_FB_OFFSET&t;&t;0x1004000
DECL|macro|TGA_PLANEMASK_REG
mdefine_line|#define&t;TGA_PLANEMASK_REG&t;&t;0x0028
DECL|macro|TGA_MODE_REG
mdefine_line|#define&t;TGA_MODE_REG&t;&t;&t;0x0030
DECL|macro|TGA_RASTEROP_REG
mdefine_line|#define&t;TGA_RASTEROP_REG&t;&t;0x0034
DECL|macro|TGA_DEEP_REG
mdefine_line|#define&t;TGA_DEEP_REG&t;&t;&t;0x0050
DECL|macro|TGA_PIXELMASK_REG
mdefine_line|#define&t;TGA_PIXELMASK_REG&t;&t;0x005c
DECL|macro|TGA_CURSOR_BASE_REG
mdefine_line|#define&t;TGA_CURSOR_BASE_REG&t;&t;0x0060
DECL|macro|TGA_HORIZ_REG
mdefine_line|#define&t;TGA_HORIZ_REG&t;&t;&t;0x0064
DECL|macro|TGA_VERT_REG
mdefine_line|#define&t;TGA_VERT_REG&t;&t;&t;0x0068
DECL|macro|TGA_BASE_ADDR_REG
mdefine_line|#define&t;TGA_BASE_ADDR_REG&t;&t;0x006c
DECL|macro|TGA_VALID_REG
mdefine_line|#define&t;TGA_VALID_REG&t;&t;&t;0x0070
DECL|macro|TGA_CURSOR_XY_REG
mdefine_line|#define&t;TGA_CURSOR_XY_REG&t;&t;0x0074
DECL|macro|TGA_INTR_STAT_REG
mdefine_line|#define&t;TGA_INTR_STAT_REG&t;&t;0x007c
DECL|macro|TGA_RAMDAC_SETUP_REG
mdefine_line|#define&t;TGA_RAMDAC_SETUP_REG&t;&t;0x00c0
DECL|macro|TGA_BLOCK_COLOR0_REG
mdefine_line|#define&t;TGA_BLOCK_COLOR0_REG&t;&t;0x0140
DECL|macro|TGA_BLOCK_COLOR1_REG
mdefine_line|#define&t;TGA_BLOCK_COLOR1_REG&t;&t;0x0144
DECL|macro|TGA_CLOCK_REG
mdefine_line|#define&t;TGA_CLOCK_REG&t;&t;&t;0x01e8
DECL|macro|TGA_RAMDAC_REG
mdefine_line|#define&t;TGA_RAMDAC_REG&t;&t;&t;0x01f0
DECL|macro|TGA_CMD_STAT_REG
mdefine_line|#define&t;TGA_CMD_STAT_REG&t;&t;0x01f8
multiline_comment|/*&n; * useful defines for managing the BT485 on the 8-plane TGA&n; */
DECL|macro|BT485_READ_BIT
mdefine_line|#define&t;BT485_READ_BIT&t;&t;&t;0x01
DECL|macro|BT485_WRITE_BIT
mdefine_line|#define&t;BT485_WRITE_BIT&t;&t;&t;0x00
DECL|macro|BT485_ADDR_PAL_WRITE
mdefine_line|#define&t;BT485_ADDR_PAL_WRITE&t;&t;0x00
DECL|macro|BT485_DATA_PAL
mdefine_line|#define&t;BT485_DATA_PAL&t;&t;&t;0x02
DECL|macro|BT485_PIXEL_MASK
mdefine_line|#define&t;BT485_PIXEL_MASK&t;&t;0x04
DECL|macro|BT485_ADDR_PAL_READ
mdefine_line|#define&t;BT485_ADDR_PAL_READ&t;&t;0x06
DECL|macro|BT485_ADDR_CUR_WRITE
mdefine_line|#define&t;BT485_ADDR_CUR_WRITE&t;&t;0x08
DECL|macro|BT485_DATA_CUR
mdefine_line|#define&t;BT485_DATA_CUR&t;&t;&t;0x0a
DECL|macro|BT485_CMD_0
mdefine_line|#define&t;BT485_CMD_0&t;&t;&t;0x0c
DECL|macro|BT485_ADDR_CUR_READ
mdefine_line|#define&t;BT485_ADDR_CUR_READ&t;&t;0x0e
DECL|macro|BT485_CMD_1
mdefine_line|#define&t;BT485_CMD_1&t;&t;&t;0x10
DECL|macro|BT485_CMD_2
mdefine_line|#define&t;BT485_CMD_2&t;&t;&t;0x12
DECL|macro|BT485_STATUS
mdefine_line|#define&t;BT485_STATUS&t;&t;&t;0x14
DECL|macro|BT485_CMD_3
mdefine_line|#define&t;BT485_CMD_3&t;&t;&t;0x14
DECL|macro|BT485_CUR_RAM
mdefine_line|#define&t;BT485_CUR_RAM&t;&t;&t;0x16
DECL|macro|BT485_CUR_LOW_X
mdefine_line|#define&t;BT485_CUR_LOW_X&t;&t;&t;0x18
DECL|macro|BT485_CUR_HIGH_X
mdefine_line|#define&t;BT485_CUR_HIGH_X&t;&t;0x1a
DECL|macro|BT485_CUR_LOW_Y
mdefine_line|#define&t;BT485_CUR_LOW_Y&t;&t;&t;0x1c
DECL|macro|BT485_CUR_HIGH_Y
mdefine_line|#define&t;BT485_CUR_HIGH_Y&t;&t;0x1e
multiline_comment|/*&n; * useful defines for managing the BT463 on the 24-plane TGAs&n; */
DECL|macro|BT463_ADDR_LO
mdefine_line|#define&t;BT463_ADDR_LO&t;&t;0x0
DECL|macro|BT463_ADDR_HI
mdefine_line|#define&t;BT463_ADDR_HI&t;&t;0x1
DECL|macro|BT463_REG_ACC
mdefine_line|#define&t;BT463_REG_ACC&t;&t;0x2
DECL|macro|BT463_PALETTE
mdefine_line|#define&t;BT463_PALETTE&t;&t;0x3
DECL|macro|BT463_CUR_CLR_0
mdefine_line|#define&t;BT463_CUR_CLR_0&t;&t;0x0100
DECL|macro|BT463_CUR_CLR_1
mdefine_line|#define&t;BT463_CUR_CLR_1&t;&t;0x0101
DECL|macro|BT463_CMD_REG_0
mdefine_line|#define&t;BT463_CMD_REG_0&t;&t;0x0201
DECL|macro|BT463_CMD_REG_1
mdefine_line|#define&t;BT463_CMD_REG_1&t;&t;0x0202
DECL|macro|BT463_CMD_REG_2
mdefine_line|#define&t;BT463_CMD_REG_2&t;&t;0x0203
DECL|macro|BT463_READ_MASK_0
mdefine_line|#define&t;BT463_READ_MASK_0&t;0x0205
DECL|macro|BT463_READ_MASK_1
mdefine_line|#define&t;BT463_READ_MASK_1&t;0x0206
DECL|macro|BT463_READ_MASK_2
mdefine_line|#define&t;BT463_READ_MASK_2&t;0x0207
DECL|macro|BT463_READ_MASK_3
mdefine_line|#define&t;BT463_READ_MASK_3&t;0x0208
DECL|macro|BT463_BLINK_MASK_0
mdefine_line|#define&t;BT463_BLINK_MASK_0&t;0x0209
DECL|macro|BT463_BLINK_MASK_1
mdefine_line|#define&t;BT463_BLINK_MASK_1&t;0x020a
DECL|macro|BT463_BLINK_MASK_2
mdefine_line|#define&t;BT463_BLINK_MASK_2&t;0x020b
DECL|macro|BT463_BLINK_MASK_3
mdefine_line|#define&t;BT463_BLINK_MASK_3&t;0x020c
DECL|macro|BT463_WINDOW_TYPE_BASE
mdefine_line|#define&t;BT463_WINDOW_TYPE_BASE&t;0x0300
multiline_comment|/*&n; * built-in font management constants&n; *&n; * NOTE: the built-in font is 8x16, and the video resolution&n; * is 640x480 @ 60Hz.&n; * This means we could put 30 rows of text on the screen (480/16).&n; * However, we wish to make then TGA look just like a VGA, as the&n; * default, so, we pad the character to 8x18, and leave some scan&n; * lines at the bottom unused.&n; */
DECL|macro|TGA_F_WIDTH
mdefine_line|#define TGA_F_WIDTH 8
DECL|macro|TGA_F_HEIGHT
mdefine_line|#define TGA_F_HEIGHT 16
DECL|macro|TGA_F_HEIGHT_PADDED
mdefine_line|#define TGA_F_HEIGHT_PADDED 18
DECL|variable|tga_type
r_int
id|tga_type
suffix:semicolon
DECL|variable|tga_mem_base
r_int
r_int
id|tga_mem_base
suffix:semicolon
DECL|variable|tga_fb_base
r_int
r_int
id|tga_fb_base
suffix:semicolon
DECL|variable|tga_regs_base
r_int
r_int
id|tga_regs_base
suffix:semicolon
DECL|variable|tga_bpp
DECL|variable|tga_fb_width
DECL|variable|tga_fb_height
DECL|variable|tga_fb_stride
r_int
r_int
id|tga_bpp
comma
id|tga_fb_width
comma
id|tga_fb_height
comma
id|tga_fb_stride
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|fb_offset_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
id|TGA_8PLANE_FB_OFFSET
comma
id|TGA_24PLANE_FB_OFFSET
comma
l_int|0xffffffff
comma
id|TGA_24PLUSZ_FB_OFFSET
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|deep_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
l_int|0x00014000
comma
l_int|0x0001440d
comma
l_int|0xffffffff
comma
l_int|0x0001441d
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|rasterop_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
l_int|0x00000003
comma
l_int|0x00000303
comma
l_int|0xffffffff
comma
l_int|0x00000303
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|mode_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
l_int|0x00002000
comma
l_int|0x00002300
comma
l_int|0xffffffff
comma
l_int|0x00002300
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
r_int
id|base_addr_presets
(braket
l_int|4
)braket
id|__initdata
op_assign
(brace
l_int|0x00000000
comma
l_int|0x00000001
comma
l_int|0xffffffff
comma
l_int|0x00000001
)brace
suffix:semicolon
DECL|macro|TGA_WRITE_REG
mdefine_line|#define TGA_WRITE_REG(v,r) &bslash;&n;&t;{ writel((v), tga_regs_base+(r)); mb(); }
DECL|macro|TGA_READ_REG
mdefine_line|#define TGA_READ_REG(r) readl(tga_regs_base+(r))
DECL|macro|BT485_WRITE
mdefine_line|#define BT485_WRITE(v,r) &bslash;&n;&t;  TGA_WRITE_REG((r),TGA_RAMDAC_SETUP_REG);&t;&t;&bslash;&n;&t;  TGA_WRITE_REG(((v)&amp;0xff)|((r)&lt;&lt;8),TGA_RAMDAC_REG);
DECL|macro|BT463_LOAD_ADDR
mdefine_line|#define BT463_LOAD_ADDR(a) &bslash;&n;&t;TGA_WRITE_REG(BT463_ADDR_LO&lt;&lt;2, TGA_RAMDAC_SETUP_REG); &bslash;&n;&t;TGA_WRITE_REG((BT463_ADDR_LO&lt;&lt;10)|((a)&amp;0xff), TGA_RAMDAC_REG); &bslash;&n;&t;TGA_WRITE_REG(BT463_ADDR_HI&lt;&lt;2, TGA_RAMDAC_SETUP_REG); &bslash;&n;&t;TGA_WRITE_REG((BT463_ADDR_HI&lt;&lt;10)|(((a)&gt;&gt;8)&amp;0xff), TGA_RAMDAC_REG);
DECL|macro|BT463_WRITE
mdefine_line|#define BT463_WRITE(m,a,v) &bslash;&n;&t;BT463_LOAD_ADDR((a)); &bslash;&n;&t;TGA_WRITE_REG(((m)&lt;&lt;2),TGA_RAMDAC_SETUP_REG); &bslash;&n;&t;TGA_WRITE_REG(((m)&lt;&lt;10)|((v)&amp;0xff),TGA_RAMDAC_REG);
r_extern
r_char
id|tga_builtin_font
(braket
)braket
suffix:semicolon
r_void
id|tga_init_video
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|tga_clear_screen
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
DECL|function|set_palette
id|set_palette
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|console_blanked
op_logical_or
id|vt_cons
(braket
id|fg_console
)braket
op_member_access_from_pointer
id|vc_mode
op_eq
id|KD_GRAPHICS
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8-plane */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_ADDR_PAL_WRITE
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|BT485_DATA_PAL
comma
id|TGA_RAMDAC_SETUP_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
id|color_table
(braket
id|i
)braket
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_red
(braket
id|j
)braket
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_grn
(braket
id|j
)braket
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_blu
(braket
id|j
)braket
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|BT463_LOAD_ADDR
c_func
(paren
l_int|0x0000
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
(paren
id|BT463_PALETTE
op_lshift
l_int|2
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
id|color_table
(braket
id|i
)braket
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_red
(braket
id|j
)braket
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_grn
(braket
id|j
)braket
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_blu
(braket
id|j
)braket
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
)brace
)brace
r_void
DECL|function|__set_origin
id|__set_origin
c_func
(paren
r_int
r_int
id|offset
)paren
(brace
multiline_comment|/*&n;   * should not be called, but if so, do nothing...&n;   */
)brace
multiline_comment|/*&n; * Hide the cursor from view, during blanking, usually...&n; */
r_void
DECL|function|hide_cursor
id|hide_cursor
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
id|BT485_WRITE
c_func
(paren
l_int|0x20
comma
id|BT485_CMD_2
)paren
suffix:semicolon
)brace
r_else
(brace
id|TGA_WRITE_REG
c_func
(paren
l_int|0x03
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING and BLANK */
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|set_cursor
id|set_cursor
c_func
(paren
r_int
id|currcons
)paren
(brace
r_int
r_int
id|idx
comma
id|xt
comma
id|yt
comma
id|row
comma
id|col
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|currcons
op_ne
id|fg_console
op_logical_or
id|console_blanked
op_logical_or
id|vcmode
op_eq
id|KD_GRAPHICS
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|__real_origin
op_ne
id|__origin
)paren
id|__set_origin
c_func
(paren
id|__real_origin
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|deccm
)paren
(brace
id|idx
op_assign
(paren
id|pos
op_minus
id|video_mem_base
)paren
op_rshift
l_int|1
suffix:semicolon
id|col
op_assign
id|idx
op_mod
l_int|80
suffix:semicolon
id|row
op_assign
(paren
id|idx
op_minus
id|col
)paren
op_div
l_int|80
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8-plane */
id|xt
op_assign
id|col
op_star
id|TGA_F_WIDTH
op_plus
l_int|64
suffix:semicolon
id|yt
op_assign
id|row
op_star
id|TGA_F_HEIGHT_PADDED
op_plus
l_int|64
suffix:semicolon
multiline_comment|/* make sure it&squot;s enabled */
id|BT485_WRITE
c_func
(paren
l_int|0x22
comma
id|BT485_CMD_2
)paren
suffix:semicolon
multiline_comment|/* WIN cursor type */
id|BT485_WRITE
c_func
(paren
id|xt
comma
id|BT485_CUR_LOW_X
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
(paren
id|xt
op_rshift
l_int|8
)paren
comma
id|BT485_CUR_HIGH_X
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
id|yt
comma
id|BT485_CUR_LOW_Y
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
(paren
id|yt
op_rshift
l_int|8
)paren
comma
id|BT485_CUR_HIGH_Y
)paren
suffix:semicolon
)brace
r_else
(brace
id|xt
op_assign
id|col
op_star
id|TGA_F_WIDTH
op_plus
l_int|144
suffix:semicolon
id|yt
op_assign
id|row
op_star
id|TGA_F_HEIGHT_PADDED
op_plus
l_int|35
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x05
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING and CURSOR */
id|TGA_WRITE_REG
c_func
(paren
id|xt
op_or
(paren
id|yt
op_lshift
l_int|12
)paren
comma
id|TGA_CURSOR_XY_REG
)paren
suffix:semicolon
)brace
)brace
r_else
id|hide_cursor
c_func
(paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
r_int
id|con_type_init
c_func
(paren
r_int
r_int
id|kmem_start
comma
r_const
r_char
op_star
op_star
id|display_desc
)paren
)paren
(brace
id|can_do_color
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;        * fake the screen memory with some CPU memory&n;        */
id|video_mem_base
op_assign
id|kmem_start
suffix:semicolon
id|kmem_start
op_add_assign
id|video_screen_size
suffix:semicolon
id|video_mem_term
op_assign
id|kmem_start
suffix:semicolon
id|video_type
op_assign
id|VIDEO_TYPE_TGAC
suffix:semicolon
op_star
id|display_desc
op_assign
l_string|&quot;TGA&quot;
suffix:semicolon
r_return
id|kmem_start
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|con_type_init_finish
c_func
(paren
r_void
)paren
)paren
(brace
)brace
multiline_comment|/*&n; * NOTE: get_scrmem() and set_scrmem() are here only because&n; * the VGA version of set_scrmem() has some direct VGA references.&n; */
r_void
DECL|function|get_scrmem
id|get_scrmem
c_func
(paren
r_int
id|currcons
)paren
(brace
id|memcpyw
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|vc_scrbuf
(braket
id|currcons
)braket
comma
(paren
r_int
r_int
op_star
)paren
id|origin
comma
id|video_screen_size
)paren
suffix:semicolon
id|origin
op_assign
id|video_mem_start
op_assign
(paren
r_int
r_int
)paren
id|vc_scrbuf
(braket
id|currcons
)braket
suffix:semicolon
id|scr_end
op_assign
id|video_mem_end
op_assign
id|video_mem_start
op_plus
id|video_screen_size
suffix:semicolon
id|pos
op_assign
id|origin
op_plus
id|y
op_star
id|video_size_row
op_plus
(paren
id|x
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
r_void
DECL|function|set_scrmem
id|set_scrmem
c_func
(paren
r_int
id|currcons
comma
r_int
id|offset
)paren
(brace
r_if
c_cond
(paren
id|video_mem_term
op_minus
id|video_mem_base
OL
id|offset
op_plus
id|video_screen_size
)paren
id|offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* strange ... */
id|memcpyw
c_func
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|video_mem_base
op_plus
id|offset
)paren
comma
(paren
r_int
r_int
op_star
)paren
id|origin
comma
id|video_screen_size
)paren
suffix:semicolon
id|video_mem_start
op_assign
id|video_mem_base
suffix:semicolon
id|video_mem_end
op_assign
id|video_mem_term
suffix:semicolon
id|origin
op_assign
id|video_mem_base
op_plus
id|offset
suffix:semicolon
id|scr_end
op_assign
id|origin
op_plus
id|video_screen_size
suffix:semicolon
id|pos
op_assign
id|origin
op_plus
id|y
op_star
id|video_size_row
op_plus
(paren
id|x
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * PIO_FONT support.&n; *&n; * for now, we will use/allow *only* our built-in font...&n; */
r_int
DECL|function|set_get_font
id|set_get_font
c_func
(paren
r_char
op_star
id|arg
comma
r_int
id|set
comma
r_int
id|ch512
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * Adjust the screen to fit a font of a certain height&n; *&n; * Returns &lt; 0 for error, 0 if nothing changed, and the number&n; * of lines on the adjusted console if changed.&n; *&n; * for now, we only support the built-in font...&n; */
r_int
DECL|function|con_adjust_height
id|con_adjust_height
c_func
(paren
r_int
r_int
id|fontheight
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* NOTE:&n; * this is here, and not in console.c, because the VGA version&n; * tests the controller type to see if color can be done. We *KNOW*&n; * that we can do color on the TGA... :-)&n; *&n; * FIXME? maybe the init codes for VGA and TGA could set&n; * a flag for (in)ability to do colormap set/get???&n; */
r_int
DECL|function|set_get_cmap
id|set_get_cmap
c_func
(paren
r_int
r_char
op_star
id|arg
comma
r_int
id|set
)paren
(brace
r_int
id|i
suffix:semicolon
id|i
op_assign
id|verify_area
c_func
(paren
id|set
ques
c_cond
id|VERIFY_READ
suffix:colon
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
l_int|16
op_star
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|set
)paren
(brace
id|get_user
c_func
(paren
id|default_red
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
id|get_user
c_func
(paren
id|default_grn
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
id|get_user
c_func
(paren
id|default_blu
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
)brace
r_else
(brace
id|put_user
(paren
id|default_red
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
id|put_user
(paren
id|default_grn
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
id|put_user
(paren
id|default_blu
(braket
id|i
)braket
comma
id|arg
op_increment
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|set
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_NR_CONSOLES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|vc_cons_allocated
c_func
(paren
id|i
)paren
)paren
(brace
r_int
id|j
comma
id|k
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
id|k
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|16
suffix:semicolon
id|j
op_increment
)paren
(brace
id|vc_cons
(braket
id|i
)braket
dot
id|d-&gt;vc_palette
(braket
id|k
op_increment
)braket
op_assign
id|default_red
(braket
id|j
)braket
suffix:semicolon
id|vc_cons
(braket
id|i
)braket
dot
id|d-&gt;vc_palette
(braket
id|k
op_increment
)braket
op_assign
id|default_grn
(braket
id|j
)braket
suffix:semicolon
id|vc_cons
(braket
id|i
)braket
dot
id|d-&gt;vc_palette
(braket
id|k
op_increment
)braket
op_assign
id|default_blu
(braket
id|j
)braket
suffix:semicolon
)brace
)brace
id|set_palette
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * dummy routines for the VESA blanking code, which is VGA only,&n; * so we don&squot;t have to carry that stuff around for the TGA...&n; */
DECL|function|vesa_powerdown
r_void
id|vesa_powerdown
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|vesa_blank
r_void
id|vesa_blank
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|vesa_unblank
r_void
id|vesa_unblank
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|set_vesa_blanking
r_void
id|set_vesa_blanking
c_func
(paren
r_const
r_int
r_int
id|arg
)paren
(brace
)brace
multiline_comment|/*&n; *&t;See if we have a TGA card.&n; *&t;Just a placeholder at the moment, because of the strange&n; *&t;way the TGA card is initialized. This has to be enabled when&n; *&t;the kernel initializes PCI devices before the console.&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|con_is_present
c_func
(paren
r_void
)paren
)paren
(brace
macro_line|#if 0
r_int
r_char
id|pci_bus
comma
id|pci_devfn
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|pcibios_find_device
(paren
id|PCI_VENDOR_ID_DEC
comma
id|PCI_DEVICE_ID_DEC_TGA
comma
l_int|0
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_devfn
)paren
suffix:semicolon
r_return
(paren
id|status
op_eq
id|PCIBIOS_DEVICE_NOT_FOUND
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * video init code, called from within the PCI bus probing code;&n; * when TGA console is configured, at the end of the probing code,&n; * we call here to look for a TGA device, and proceed...&n; */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|tga_console_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
r_char
id|pci_bus
comma
id|pci_devfn
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * first, find the TGA among the PCI devices...&n;&t; */
id|status
op_assign
id|pcibios_find_device
(paren
id|PCI_VENDOR_ID_DEC
comma
id|PCI_DEVICE_ID_DEC_TGA
comma
l_int|0
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_devfn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|PCIBIOS_DEVICE_NOT_FOUND
)paren
(brace
multiline_comment|/* PANIC!!! */
id|printk
c_func
(paren
l_string|&quot;tga_console_init: TGA not found!!! :-(&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * read BASE_REG_0 for memory address&n;&t; */
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_devfn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|tga_mem_base
)paren
suffix:semicolon
id|tga_mem_base
op_and_assign
op_complement
l_int|15
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;tga_console_init: mem_base 0x%x&bslash;n&quot;
comma
id|tga_mem_base
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
id|tga_type
op_assign
(paren
id|readl
c_func
(paren
(paren
r_int
r_int
)paren
id|tga_mem_base
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_ne
l_int|0
op_logical_and
id|tga_type
op_ne
l_int|1
op_logical_and
id|tga_type
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TGA type (0x%x) unrecognized!&bslash;n&quot;
comma
id|tga_type
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tga_init_video
c_func
(paren
)paren
suffix:semicolon
id|tga_clear_screen
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * FINALLY, we can register TGA as console (whew!)&n;&t; */
macro_line|#ifdef CONFIG_VT_CONSOLE
id|register_console
c_func
(paren
op_amp
id|vt_console_driver
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|__initdata
r_int
r_char
id|PLLbits
(braket
l_int|7
)braket
id|__initdata
op_assign
(brace
l_int|0x80
comma
l_int|0x04
comma
l_int|0x00
comma
l_int|0x24
comma
l_int|0x44
comma
l_int|0x80
comma
l_int|0xb8
)brace
suffix:semicolon
DECL|variable|__initdata
r_const
r_int
r_int
id|bt485_cursor_source
(braket
l_int|64
)braket
id|__initdata
op_assign
(brace
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0x00000000000000ff
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|__initdata
r_const
r_int
r_int
id|bt463_cursor_source
(braket
l_int|256
)braket
id|__initdata
op_assign
(brace
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0xffff0000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0x00000000
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|tga_init_video
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
comma
id|j
comma
id|temp
suffix:semicolon
r_int
r_char
op_star
id|cbp
suffix:semicolon
id|tga_regs_base
op_assign
(paren
(paren
r_int
r_int
)paren
id|tga_mem_base
op_plus
id|TGA_REGS_OFFSET
)paren
suffix:semicolon
id|tga_fb_base
op_assign
(paren
(paren
r_int
r_int
)paren
id|tga_mem_base
op_plus
id|fb_offset_presets
(braket
id|tga_type
)braket
)paren
suffix:semicolon
multiline_comment|/* first, disable video timing */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x03
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING and BLANK */
multiline_comment|/* write the DEEP register */
r_while
c_loop
(paren
id|TGA_READ_REG
c_func
(paren
id|TGA_CMD_STAT_REG
)paren
op_amp
l_int|1
)paren
multiline_comment|/* wait for not busy */
r_continue
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|deep_presets
(braket
id|tga_type
)braket
comma
id|TGA_DEEP_REG
)paren
suffix:semicolon
r_while
c_loop
(paren
id|TGA_READ_REG
c_func
(paren
id|TGA_CMD_STAT_REG
)paren
op_amp
l_int|1
)paren
multiline_comment|/* wait for not busy */
r_continue
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* write some more registers */
id|TGA_WRITE_REG
c_func
(paren
id|rasterop_presets
(braket
id|tga_type
)braket
comma
id|TGA_RASTEROP_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|mode_presets
(braket
id|tga_type
)braket
comma
id|TGA_MODE_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|base_addr_presets
(braket
id|tga_type
)braket
comma
id|TGA_BASE_ADDR_REG
)paren
suffix:semicolon
multiline_comment|/* write the PLL for 640x480 @ 60Hz */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
l_int|7
suffix:semicolon
id|j
op_increment
)paren
(brace
id|temp
op_assign
(paren
id|PLLbits
(braket
id|i
)braket
op_rshift
(paren
l_int|7
op_minus
id|j
)paren
)paren
op_amp
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|6
op_logical_and
id|j
op_eq
l_int|7
)paren
id|temp
op_or_assign
l_int|2
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|temp
comma
id|TGA_CLOCK_REG
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* write some more registers */
id|TGA_WRITE_REG
c_func
(paren
l_int|0xffffffff
comma
id|TGA_PLANEMASK_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0xffffffff
comma
id|TGA_PIXELMASK_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x12345678
comma
id|TGA_BLOCK_COLOR0_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x12345678
comma
id|TGA_BLOCK_COLOR1_REG
)paren
suffix:semicolon
multiline_comment|/* init video timing regs for 640x480 @ 60 Hz */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x018608a0
comma
id|TGA_HORIZ_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x084251e0
comma
id|TGA_VERT_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8-plane */
id|tga_bpp
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* init BT485 RAMDAC registers */
id|BT485_WRITE
c_func
(paren
l_int|0xa2
comma
id|BT485_CMD_0
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
l_int|0x01
comma
id|BT485_ADDR_PAL_WRITE
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
l_int|0x14
comma
id|BT485_CMD_3
)paren
suffix:semicolon
multiline_comment|/* cursor 64x64 */
id|BT485_WRITE
c_func
(paren
l_int|0x40
comma
id|BT485_CMD_1
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
l_int|0x22
comma
id|BT485_CMD_2
)paren
suffix:semicolon
multiline_comment|/* WIN cursor type */
id|BT485_WRITE
c_func
(paren
l_int|0xff
comma
id|BT485_PIXEL_MASK
)paren
suffix:semicolon
multiline_comment|/* fill palette registers */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_ADDR_PAL_WRITE
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|BT485_DATA_PAL
comma
id|TGA_RAMDAC_SETUP_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
id|color_table
(braket
id|i
)braket
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_red
(braket
id|j
)braket
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_grn
(braket
id|j
)braket
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_blu
(braket
id|j
)braket
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|240
op_star
l_int|3
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|TGA_WRITE_REG
c_func
(paren
l_int|0x55
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT485_DATA_PAL
op_lshift
l_int|8
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
multiline_comment|/* initialize RAMDAC cursor colors */
id|BT485_WRITE
c_func
(paren
l_int|0
comma
id|BT485_ADDR_CUR_WRITE
)paren
suffix:semicolon
id|BT485_WRITE
c_func
(paren
l_int|0xaa
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* overscan WHITE */
id|BT485_WRITE
c_func
(paren
l_int|0xaa
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* overscan WHITE */
id|BT485_WRITE
c_func
(paren
l_int|0xaa
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* overscan WHITE */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 1 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 1 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 1 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 2 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 2 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 2 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 3 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 3 BLACK */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_DATA_CUR
)paren
suffix:semicolon
multiline_comment|/* color 3 BLACK */
multiline_comment|/* initialize RAMDAC cursor RAM */
id|BT485_WRITE
c_func
(paren
l_int|0x00
comma
id|BT485_ADDR_PAL_WRITE
)paren
suffix:semicolon
id|cbp
op_assign
(paren
r_int
r_char
op_star
)paren
id|bt485_cursor_source
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BT485_WRITE
c_func
(paren
op_star
id|cbp
op_increment
comma
id|BT485_CUR_RAM
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BT485_WRITE
c_func
(paren
l_int|0xff
comma
id|BT485_CUR_RAM
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* 24-plane or 24plusZ */
id|tga_bpp
op_assign
l_int|4
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x01
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING */
multiline_comment|/*&n;&t;   * init some registers&n;&t;   */
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_CMD_REG_0
comma
l_int|0x40
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_CMD_REG_1
comma
l_int|0x08
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_CMD_REG_2
comma
l_int|0x40
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_READ_MASK_0
comma
l_int|0xff
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_READ_MASK_1
comma
l_int|0xff
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_READ_MASK_2
comma
l_int|0xff
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_READ_MASK_3
comma
l_int|0x0f
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_BLINK_MASK_0
comma
l_int|0x00
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_BLINK_MASK_1
comma
l_int|0x00
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_BLINK_MASK_2
comma
l_int|0x00
)paren
suffix:semicolon
id|BT463_WRITE
c_func
(paren
id|BT463_REG_ACC
comma
id|BT463_BLINK_MASK_3
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   * fill the palette&n;&t;   */
id|BT463_LOAD_ADDR
c_func
(paren
l_int|0x0000
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
(paren
id|BT463_PALETTE
op_lshift
l_int|2
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|j
op_assign
id|color_table
(braket
id|i
)braket
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_red
(braket
id|j
)braket
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_grn
(braket
id|j
)braket
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
id|default_blu
(braket
id|j
)braket
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
op_star
l_int|3
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
id|TGA_WRITE_REG
c_func
(paren
l_int|0x55
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_PALETTE
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   * fill window type table after start of vertical retrace&n;&t;   */
r_while
c_loop
(paren
op_logical_neg
(paren
id|TGA_READ_REG
c_func
(paren
id|TGA_INTR_STAT_REG
)paren
op_amp
l_int|0x01
)paren
)paren
r_continue
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x01
comma
id|TGA_INTR_STAT_REG
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|TGA_READ_REG
c_func
(paren
id|TGA_INTR_STAT_REG
)paren
op_amp
l_int|0x01
)paren
)paren
r_continue
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x01
comma
id|TGA_INTR_STAT_REG
)paren
suffix:semicolon
id|BT463_LOAD_ADDR
c_func
(paren
id|BT463_WINDOW_TYPE_BASE
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
(paren
id|BT463_REG_ACC
op_lshift
l_int|2
)paren
comma
id|TGA_RAMDAC_SETUP_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x01
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x80
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   * init cursor colors&n;&t;   */
id|BT463_LOAD_ADDR
c_func
(paren
id|BT463_CUR_CLR_0
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* background */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* background */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* background */
id|TGA_WRITE_REG
c_func
(paren
l_int|0xff
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* foreground */
id|TGA_WRITE_REG
c_func
(paren
l_int|0xff
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* foreground */
id|TGA_WRITE_REG
c_func
(paren
l_int|0xff
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/* foreground */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
id|TGA_WRITE_REG
c_func
(paren
l_int|0x00
op_or
(paren
id|BT463_REG_ACC
op_lshift
l_int|10
)paren
comma
id|TGA_RAMDAC_REG
)paren
suffix:semicolon
multiline_comment|/*&n;&t;   * finally, init the cursor shape&n;&t;   */
id|temp
op_assign
id|tga_fb_base
op_minus
l_int|1024
suffix:semicolon
multiline_comment|/* this assumes video starts at base&n;&t;&t;&t;&t;       and base is beyond memory start*/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
id|bt463_cursor_source
(braket
id|i
)braket
comma
id|temp
op_plus
id|i
op_star
l_int|4
)paren
suffix:semicolon
)brace
id|TGA_WRITE_REG
c_func
(paren
id|temp
op_amp
l_int|0x000fffff
comma
id|TGA_CURSOR_BASE_REG
)paren
suffix:semicolon
)brace
multiline_comment|/* finally, enable video scan &amp; cursor&n;&t;   (and pray for the monitor... :-) */
id|TGA_WRITE_REG
c_func
(paren
l_int|0x05
comma
id|TGA_VALID_REG
)paren
suffix:semicolon
multiline_comment|/* SCANNING and CURSOR */
multiline_comment|/* oh, and set the globals describing the resolution... :-) */
id|tga_fb_width
op_assign
l_int|640
op_star
id|tga_bpp
suffix:semicolon
id|tga_fb_height
op_assign
l_int|480
suffix:semicolon
id|tga_fb_stride
op_assign
id|tga_fb_width
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|tga_clear_screen
c_func
(paren
r_void
)paren
)paren
(brace
r_register
r_int
id|i
comma
id|j
suffix:semicolon
r_register
r_int
r_int
op_star
id|dst
suffix:semicolon
id|dst
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|tga_fb_base
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tga_fb_height
suffix:semicolon
id|i
op_increment
comma
id|dst
op_add_assign
id|tga_fb_stride
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|tga_fb_stride
suffix:semicolon
id|j
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0
comma
(paren
id|dst
op_plus
id|j
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* also clear out the &quot;shadow&quot; screen memory */
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|video_mem_base
comma
l_int|0
comma
(paren
id|video_mem_term
op_minus
id|video_mem_base
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * tga_blitc&n; *&n; * Displays an ASCII character at a specified character cell&n; *  position.&n; *&n; * Called from scr_writew() when the destination is&n; *  the &quot;shadow&quot; screen&n; */
r_static
r_int
r_int
DECL|variable|fontmask_bits
id|fontmask_bits
(braket
l_int|16
)braket
op_assign
(brace
l_int|0x00000000
comma
l_int|0xff000000
comma
l_int|0x00ff0000
comma
l_int|0xffff0000
comma
l_int|0x0000ff00
comma
l_int|0xff00ff00
comma
l_int|0x00ffff00
comma
l_int|0xffffff00
comma
l_int|0x000000ff
comma
l_int|0xff0000ff
comma
l_int|0x00ff00ff
comma
l_int|0xffff00ff
comma
l_int|0x0000ffff
comma
l_int|0xff00ffff
comma
l_int|0x00ffffff
comma
l_int|0xffffffff
)brace
suffix:semicolon
r_int
DECL|function|tga_blitc
id|tga_blitc
c_func
(paren
r_int
r_int
id|charattr
comma
r_int
r_int
id|addr
)paren
(brace
r_int
id|row
comma
id|col
comma
id|temp
comma
id|c
comma
id|attrib
suffix:semicolon
r_register
r_int
r_int
id|fgmask
comma
id|bgmask
comma
id|data
comma
id|rowbits
suffix:semicolon
r_register
r_int
r_int
op_star
id|dst
suffix:semicolon
r_register
r_int
r_char
op_star
id|font_row
suffix:semicolon
r_register
r_int
id|i
comma
id|j
comma
id|stride
suffix:semicolon
id|c
op_assign
id|charattr
op_amp
l_int|0x00ff
suffix:semicolon
id|attrib
op_assign
(paren
id|charattr
op_rshift
l_int|8
)paren
op_amp
l_int|0x00ff
suffix:semicolon
multiline_comment|/*&n;   * extract foreground and background indices&n;   * NOTE: we always treat blink/underline bits as color for now...&n;   */
id|fgmask
op_assign
id|attrib
op_amp
l_int|0x0f
suffix:semicolon
id|bgmask
op_assign
(paren
id|attrib
op_rshift
l_int|4
)paren
op_amp
l_int|0x0f
suffix:semicolon
id|i
op_assign
(paren
id|c
op_amp
l_int|0xff
)paren
op_lshift
l_int|4
suffix:semicolon
multiline_comment|/* NOTE: assumption of 16 bytes per character bitmap */
multiline_comment|/*&n;   * calculate (row,col) from addr and video_mem_base&n;   */
id|temp
op_assign
(paren
id|addr
op_minus
id|video_mem_base
)paren
op_rshift
l_int|1
suffix:semicolon
id|col
op_assign
id|temp
op_mod
l_int|80
suffix:semicolon
id|row
op_assign
(paren
id|temp
op_minus
id|col
)paren
op_div
l_int|80
suffix:semicolon
multiline_comment|/*&n;   * calculate destination address&n;   */
id|dst
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|tga_fb_base
op_plus
(paren
id|row
op_star
id|tga_fb_width
op_star
id|TGA_F_HEIGHT_PADDED
)paren
op_plus
(paren
id|col
op_star
id|TGA_F_WIDTH
op_star
id|tga_bpp
)paren
)paren
suffix:semicolon
id|font_row
op_assign
(paren
r_int
r_char
op_star
)paren
op_amp
id|tga_builtin_font
(braket
id|i
)braket
suffix:semicolon
id|stride
op_assign
id|tga_fb_stride
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_eq
l_int|0
)paren
(brace
multiline_comment|/* 8-plane */
id|fgmask
op_assign
id|fgmask
op_lshift
l_int|8
op_or
id|fgmask
suffix:semicolon
id|fgmask
op_or_assign
id|fgmask
op_lshift
l_int|16
suffix:semicolon
id|bgmask
op_assign
id|bgmask
op_lshift
l_int|8
op_or
id|bgmask
suffix:semicolon
id|bgmask
op_or_assign
id|bgmask
op_lshift
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|TGA_F_HEIGHT_PADDED
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|j
OL
id|TGA_F_HEIGHT
)paren
(brace
id|rowbits
op_assign
id|font_row
(braket
id|j
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* dup the last n rows only if char &gt; 0x7f */
r_if
c_cond
(paren
id|c
op_amp
l_int|0x80
)paren
id|rowbits
op_assign
id|font_row
(braket
id|j
op_minus
(paren
id|TGA_F_HEIGHT_PADDED
op_minus
id|TGA_F_HEIGHT
)paren
)braket
suffix:semicolon
r_else
id|rowbits
op_assign
l_int|0
suffix:semicolon
)brace
id|data
op_assign
id|fontmask_bits
(braket
(paren
id|rowbits
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|data
op_assign
(paren
id|data
op_amp
id|fgmask
)paren
op_or
(paren
op_complement
id|data
op_amp
id|bgmask
)paren
suffix:semicolon
id|writel
c_func
(paren
id|data
comma
id|dst
)paren
suffix:semicolon
id|data
op_assign
id|fontmask_bits
(braket
id|rowbits
op_amp
l_int|0xf
)braket
suffix:semicolon
id|data
op_assign
(paren
id|data
op_amp
id|fgmask
)paren
op_or
(paren
op_complement
id|data
op_amp
id|bgmask
)paren
suffix:semicolon
id|writel
c_func
(paren
id|data
comma
(paren
id|dst
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|dst
op_add_assign
id|stride
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* 24-plane */
id|fgmask
op_assign
(paren
id|default_red
(braket
id|fgmask
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|default_grn
(braket
id|fgmask
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|default_blu
(braket
id|fgmask
)braket
op_lshift
l_int|0
)paren
suffix:semicolon
id|bgmask
op_assign
(paren
id|default_red
(braket
id|bgmask
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|default_grn
(braket
id|bgmask
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|default_blu
(braket
id|bgmask
)braket
op_lshift
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TGA_F_HEIGHT_PADDED
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|TGA_F_HEIGHT
)paren
(brace
id|rowbits
op_assign
id|font_row
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* dup the last n rows only if char &gt; 0x7f */
r_if
c_cond
(paren
id|c
op_amp
l_int|0x80
)paren
id|rowbits
op_assign
id|font_row
(braket
id|i
op_minus
(paren
id|TGA_F_HEIGHT_PADDED
op_minus
id|TGA_F_HEIGHT
)paren
)braket
suffix:semicolon
r_else
id|rowbits
op_assign
l_int|0
suffix:semicolon
)brace
id|data
op_assign
l_int|1
op_lshift
(paren
id|TGA_F_WIDTH
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|TGA_F_WIDTH
suffix:semicolon
id|j
op_increment
comma
id|data
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|rowbits
op_amp
id|data
)paren
id|writel
c_func
(paren
id|fgmask
comma
(paren
id|dst
op_plus
id|j
)paren
)paren
suffix:semicolon
r_else
id|writel
c_func
(paren
id|bgmask
comma
(paren
id|dst
op_plus
id|j
)paren
)paren
suffix:semicolon
)brace
id|dst
op_add_assign
id|stride
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * font table of displayable characters.&n; */
DECL|variable|tga_builtin_font
r_char
id|tga_builtin_font
(braket
)braket
op_assign
initialization_block
suffix:semicolon
eof
