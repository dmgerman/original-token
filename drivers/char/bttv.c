multiline_comment|/* &n;    bttv - Bt848 frame grabber driver&n;&n;    Copyright (C) 1996,97,98 Ralph  Metzler (rjkm@thp.uni-koeln.de)&n;                           &amp; Marcus Metzler (mocm@thp.uni-koeln.de)&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;    &n;    Modified to put the RISC code writer in the kernel and to fit a&n;    common (and I hope safe) kernel interface. When we have an X extension&n;    all will now be really sweet.&n; &n;    TODO:  &n;   &n;    * move norm from tuner to channel struct!?&n;      composite source from a satellite tuner can deliver different norms&n;      depending on tuned channel&n;    * mmap VBI data?&n;    * use new PCI routines&n;    * fix RAW Composite grabbing for NTSC &n;    * allow for different VDELAY in RAW grabbing?&n;    * extra modules for tda9850, tda8425, any volunteers???&n;    * support 15bpp&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &quot;bttv.h&quot;
macro_line|#include &quot;tuner.h&quot;
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)&t;&t;/* Debug driver */&t;
DECL|macro|IDEBUG
mdefine_line|#define IDEBUG(x) &t;&t;/* Debug interrupt handler */
id|MODULE_PARM
c_func
(paren
id|vidmem
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|triton1
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|remap
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|radio
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|card
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pll
comma
l_string|&quot;1-4i&quot;
)paren
suffix:semicolon
r_static
r_int
id|find_vga
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|bt848_set_risc_jmps
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
suffix:semicolon
multiline_comment|/* Anybody who uses more than four? */
DECL|macro|BTTV_MAX
mdefine_line|#define BTTV_MAX 4
DECL|variable|vidmem
r_static
r_int
r_int
id|vidmem
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* manually set video mem address */
DECL|variable|triton1
r_static
r_int
id|triton1
op_assign
l_int|0
suffix:semicolon
DECL|variable|remap
r_static
r_int
r_int
id|remap
(braket
id|BTTV_MAX
)braket
suffix:semicolon
multiline_comment|/* remap Bt848 */
DECL|variable|radio
r_static
r_int
r_int
id|radio
(braket
id|BTTV_MAX
)braket
suffix:semicolon
DECL|variable|card
r_static
r_int
r_int
id|card
(braket
id|BTTV_MAX
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|pll
r_static
r_int
r_int
id|pll
(braket
id|BTTV_MAX
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|bttv_num
r_static
r_int
id|bttv_num
suffix:semicolon
multiline_comment|/* number of Bt848s in use */
DECL|variable|bttvs
r_static
r_struct
id|bttv
id|bttvs
(braket
id|BTTV_MAX
)braket
suffix:semicolon
DECL|macro|I2C_TIMING
mdefine_line|#define I2C_TIMING (0x7&lt;&lt;4)
DECL|macro|I2C_DELAY
mdefine_line|#define I2C_DELAY   10
DECL|macro|I2C_SET
mdefine_line|#define I2C_SET(CTRL,DATA) &bslash;&n;    { btwrite((CTRL&lt;&lt;1)|(DATA), BT848_I2C); udelay(I2C_DELAY); }
DECL|macro|I2C_GET
mdefine_line|#define I2C_GET()   (btread(BT848_I2C)&amp;1)
DECL|macro|AUDIO_MUTE_DELAY
mdefine_line|#define AUDIO_MUTE_DELAY 10000
DECL|macro|FREQ_CHANGE_DELAY
mdefine_line|#define FREQ_CHANGE_DELAY 20000
DECL|macro|EEPROM_WRITE_DELAY
mdefine_line|#define EEPROM_WRITE_DELAY 20000
multiline_comment|/*******************************/
multiline_comment|/* Memory management functions */
multiline_comment|/*******************************/
multiline_comment|/* convert virtual user memory address to physical address */
multiline_comment|/* (virt_to_phys only works for kmalloced kernel memory) */
DECL|function|uvirt_to_phys
r_static
r_inline
r_int
r_int
id|uvirt_to_phys
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
id|pgd_t
op_star
id|pgd
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
id|pgd
op_assign
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|adr
multiline_comment|/*&amp;(~PGDIR_MASK)*/
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
(brace
r_return
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|pte_page
c_func
(paren
id|pte
)paren
op_or
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|uvirt_to_bus
r_static
r_inline
r_int
r_int
id|uvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_return
id|virt_to_bus
c_func
(paren
id|phys_to_virt
c_func
(paren
id|uvirt_to_phys
c_func
(paren
id|adr
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* convert virtual kernel memory address to physical address */
multiline_comment|/* (virt_to_phys only works for kmalloced kernel memory) */
DECL|function|kvirt_to_phys
r_static
r_inline
r_int
r_int
id|kvirt_to_phys
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_return
id|uvirt_to_phys
c_func
(paren
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
)paren
suffix:semicolon
)brace
DECL|function|kvirt_to_bus
r_static
r_inline
r_int
r_int
id|kvirt_to_bus
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_return
id|uvirt_to_bus
c_func
(paren
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
)paren
suffix:semicolon
)brace
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
id|mem
op_assign
id|vmalloc
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* Clear the ram out, no junk to the user */
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_phys
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_reserve
c_func
(paren
id|MAP_NR
c_func
(paren
id|phys_to_virt
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
)brace
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_phys
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|MAP_NR
c_func
(paren
id|phys_to_virt
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Create the giant waste of buffer space we need for now&n; *&t;until we get DMA to user space sorted out (probably 2.3.x)&n; *&n; *&t;We only create this as and when someone uses mmap&n; */
DECL|function|fbuffer_alloc
r_static
r_int
id|fbuffer_alloc
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;fbuffer
)paren
(brace
id|btv-&gt;fbuffer
op_assign
(paren
r_int
r_char
op_star
)paren
id|rvmalloc
c_func
(paren
l_int|2
op_star
id|BTTV_MAX_FBUF
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv%d: Double alloc of fbuffer!&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;fbuffer
)paren
(brace
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
multiline_comment|/* I2C functions                                                           */
multiline_comment|/* software I2C functions */
DECL|function|i2c_setlines
r_static
r_void
id|i2c_setlines
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|ctrl
comma
r_int
id|data
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|bus-&gt;data
suffix:semicolon
id|btwrite
c_func
(paren
(paren
id|ctrl
op_lshift
l_int|1
)paren
op_or
id|data
comma
id|BT848_I2C
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|I2C_DELAY
)paren
suffix:semicolon
)brace
DECL|function|i2c_getdataline
r_static
r_int
id|i2c_getdataline
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|bus-&gt;data
suffix:semicolon
r_return
id|btread
c_func
(paren
id|BT848_I2C
)paren
op_amp
l_int|1
suffix:semicolon
)brace
multiline_comment|/* hardware I2C functions */
multiline_comment|/* read I2C */
DECL|function|I2CRead
r_static
r_int
id|I2CRead
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
r_char
id|addr
)paren
(brace
id|u32
id|i
suffix:semicolon
id|u32
id|stat
suffix:semicolon
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|bus-&gt;data
suffix:semicolon
multiline_comment|/* clear status bit ; BT848_INT_RACK is ro */
id|btwrite
c_func
(paren
id|BT848_INT_I2CDONE
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
id|btwrite
c_func
(paren
(paren
(paren
id|addr
op_amp
l_int|0xff
)paren
op_lshift
l_int|24
)paren
op_or
id|btv-&gt;i2c_command
comma
id|BT848_I2C
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Timeout for I2CRead is 1 second (this should be enough, really!)&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|stat
op_assign
id|btread
c_func
(paren
id|BT848_INT_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|BT848_INT_I2CDONE
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: I2CRead timeout&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|BT848_INT_RACK
)paren
)paren
r_return
op_minus
l_int|2
suffix:semicolon
id|i
op_assign
(paren
id|btread
c_func
(paren
id|BT848_I2C
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* set both to write both bytes, reset it to write only b1 */
DECL|function|I2CWrite
r_static
r_int
id|I2CWrite
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
r_char
id|addr
comma
r_int
r_char
id|b1
comma
r_int
r_char
id|b2
comma
r_int
id|both
)paren
(brace
id|u32
id|i
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|u32
id|stat
suffix:semicolon
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|bus-&gt;data
suffix:semicolon
multiline_comment|/* clear status bit; BT848_INT_RACK is ro */
id|btwrite
c_func
(paren
id|BT848_INT_I2CDONE
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
id|data
op_assign
(paren
(paren
id|addr
op_amp
l_int|0xff
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|b1
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
id|btv-&gt;i2c_command
suffix:semicolon
r_if
c_cond
(paren
id|both
)paren
(brace
id|data
op_or_assign
(paren
(paren
id|b2
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|data
op_or_assign
id|BT848_I2C_W3B
suffix:semicolon
)brace
id|btwrite
c_func
(paren
id|data
comma
id|BT848_I2C
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0x1000
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|stat
op_assign
id|btread
c_func
(paren
id|BT848_INT_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|BT848_INT_I2CDONE
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: I2CWrite timeout&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|BT848_INT_RACK
)paren
)paren
r_return
op_minus
l_int|2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* read EEPROM */
DECL|function|readee
r_static
r_void
id|readee
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
r_char
op_star
id|eedata
)paren
(brace
r_int
id|i
comma
id|k
suffix:semicolon
r_if
c_cond
(paren
id|I2CWrite
c_func
(paren
id|bus
comma
l_int|0xa0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: readee error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|k
op_assign
id|I2CRead
c_func
(paren
id|bus
comma
l_int|0xa1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: readee error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|eedata
(braket
id|i
)braket
op_assign
id|k
suffix:semicolon
)brace
)brace
multiline_comment|/* write EEPROM */
DECL|function|writeee
r_static
r_void
id|writeee
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
r_char
op_star
id|eedata
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|I2CWrite
c_func
(paren
id|bus
comma
l_int|0xa0
comma
id|i
comma
id|eedata
(braket
id|i
)braket
comma
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: writeee error (%d)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
id|EEPROM_WRITE_DELAY
)paren
suffix:semicolon
)brace
)brace
DECL|function|attach_inform
r_void
id|attach_inform
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|id
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|bus-&gt;data
suffix:semicolon
r_int
id|tunertype
suffix:semicolon
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
id|I2C_DRIVERID_MSP3400
suffix:colon
id|btv-&gt;have_msp3400
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2C_DRIVERID_TUNER
suffix:colon
id|btv-&gt;have_tuner
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;tuner_type
op_ne
op_minus
l_int|1
)paren
(brace
id|tunertype
op_assign
id|btv-&gt;tuner_type
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_TUNER
comma
id|TUNER_SET_TYPE
comma
op_amp
id|tunertype
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
DECL|function|detach_inform
r_void
id|detach_inform
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|id
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|bus-&gt;data
suffix:semicolon
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
id|I2C_DRIVERID_MSP3400
suffix:colon
id|btv-&gt;have_msp3400
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2C_DRIVERID_TUNER
suffix:colon
id|btv-&gt;have_tuner
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|variable|bttv_i2c_bus_template
r_static
r_struct
id|i2c_bus
id|bttv_i2c_bus_template
op_assign
(brace
l_string|&quot;bt848&quot;
comma
id|I2C_BUSID_BT848
comma
l_int|NULL
comma
id|SPIN_LOCK_UNLOCKED
comma
id|attach_inform
comma
id|detach_inform
comma
id|i2c_setlines
comma
id|i2c_getdataline
comma
id|I2CRead
comma
id|I2CWrite
comma
)brace
suffix:semicolon
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|struct|tvcard
r_struct
id|tvcard
(brace
DECL|member|inputs
r_int
id|inputs
suffix:semicolon
DECL|member|tuner
r_int
id|tuner
suffix:semicolon
DECL|member|svhs
r_int
id|svhs
suffix:semicolon
DECL|member|gpiomask
id|u32
id|gpiomask
suffix:semicolon
DECL|member|muxsel
id|u32
id|muxsel
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|audiomux
id|u32
id|audiomux
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* Tuner, Radio, internal, external, mute, stereo */
DECL|member|gpiomask2
id|u32
id|gpiomask2
suffix:semicolon
multiline_comment|/* GPIO MUX mask */
)brace
suffix:semicolon
DECL|variable|tvcards
r_static
r_struct
id|tvcard
id|tvcards
(braket
)braket
op_assign
(brace
multiline_comment|/* default */
(brace
l_int|3
comma
l_int|0
comma
l_int|2
comma
l_int|0
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
comma
multiline_comment|/* MIRO */
(brace
l_int|4
comma
l_int|0
comma
l_int|2
comma
l_int|15
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|10
)brace
)brace
comma
multiline_comment|/* Hauppauge */
(brace
l_int|3
comma
l_int|0
comma
l_int|2
comma
l_int|7
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|4
)brace
)brace
comma
multiline_comment|/* STB */
(brace
l_int|3
comma
l_int|0
comma
l_int|2
comma
l_int|7
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|4
comma
l_int|0
comma
l_int|2
comma
l_int|3
comma
l_int|1
)brace
)brace
comma
multiline_comment|/* Intel??? */
(brace
l_int|3
comma
l_int|0
comma
l_int|2
comma
l_int|7
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|4
)brace
)brace
comma
multiline_comment|/* Diamond DTV2000 */
(brace
l_int|3
comma
l_int|0
comma
l_int|2
comma
l_int|3
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
comma
l_int|0
comma
l_int|1
comma
l_int|3
)brace
)brace
comma
multiline_comment|/* AVerMedia TVPhone */
(brace
l_int|3
comma
l_int|0
comma
l_int|3
comma
l_int|15
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|12
comma
l_int|0
comma
l_int|11
comma
l_int|11
comma
l_int|0
)brace
)brace
comma
multiline_comment|/* Matrix Vision MV-Delta */
(brace
l_int|5
comma
op_minus
l_int|1
comma
l_int|3
comma
l_int|0
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|0
comma
l_int|0
)brace
)brace
comma
multiline_comment|/* Fly Video II */
(brace
l_int|3
comma
l_int|0
comma
l_int|2
comma
l_int|0xc00
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|0xc00
comma
l_int|0x800
comma
l_int|0x400
comma
l_int|0xc00
comma
l_int|0
)brace
)brace
comma
multiline_comment|/* TurboTV */
(brace
l_int|3
comma
l_int|0
comma
l_int|2
comma
l_int|3
comma
(brace
l_int|2
comma
l_int|3
comma
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|0
)brace
)brace
comma
)brace
suffix:semicolon
DECL|macro|TVCARDS
mdefine_line|#define TVCARDS (sizeof(tvcards)/sizeof(tvcard))
multiline_comment|/*&n; *&t;Tuner, Radio, internal, external and mute &n; */
DECL|function|audio
r_static
r_void
id|audio
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
id|mode
)paren
(brace
id|btaor
c_func
(paren
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|gpiomask
comma
op_complement
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|gpiomask
comma
id|BT848_GPIO_OUT_EN
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|AUDIO_MUTE
suffix:colon
id|btv-&gt;audio
op_or_assign
id|AUDIO_MUTE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_UNMUTE
suffix:colon
id|btv-&gt;audio
op_and_assign
op_complement
id|AUDIO_MUTE
suffix:semicolon
id|mode
op_assign
id|btv-&gt;audio
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_OFF
suffix:colon
id|mode
op_assign
id|AUDIO_OFF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_ON
suffix:colon
id|mode
op_assign
id|btv-&gt;audio
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|btv-&gt;audio
op_and_assign
id|AUDIO_MUTE
suffix:semicolon
id|btv-&gt;audio
op_or_assign
id|mode
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* if audio mute or not in H-lock, turn audio off */
r_if
c_cond
(paren
(paren
id|btv-&gt;audio
op_amp
id|AUDIO_MUTE
)paren
macro_line|#if 0&t;
op_logical_or
(paren
op_logical_neg
id|btv-&gt;radio
op_logical_and
op_logical_neg
(paren
id|btread
c_func
(paren
id|BT848_DSTATUS
)paren
op_amp
id|BT848_DSTATUS_HLOC
)paren
)paren
macro_line|#endif&t;    
)paren
id|mode
op_assign
id|AUDIO_OFF
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mode
op_eq
l_int|0
)paren
op_logical_and
(paren
id|btv-&gt;radio
)paren
)paren
id|mode
op_assign
l_int|1
suffix:semicolon
id|btaor
c_func
(paren
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|audiomux
(braket
id|mode
)braket
comma
op_complement
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|gpiomask
comma
id|BT848_GPIO_DATA
)paren
suffix:semicolon
)brace
DECL|function|bt848_dma
r_extern
r_inline
r_void
id|bt848_dma
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
id|btor
c_func
(paren
l_int|3
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
r_else
id|btand
c_func
(paren
op_complement
l_int|3
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
)brace
DECL|function|bt848_cap
r_static
r_void
id|bt848_cap
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
(brace
id|btv-&gt;cap
op_or_assign
l_int|3
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
)brace
r_else
(brace
id|btv-&gt;cap
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* If Bt848a or Bt849, use PLL for PAL/SECAM and crystal for NTSC*/
multiline_comment|/* Frequency = (F_input / PLL_X) * PLL_I.PLL_F/PLL_C &n;   PLL_X = Reference pre-divider (0=1, 1=2) &n;   PLL_C = Post divider (0=6, 1=4)&n;   PLL_I = Integer input &n;   PLL_F = Fractional input &n;   &n;   F_input = 28.636363 MHz: &n;   PAL (CLKx2 = 35.46895 MHz): PLL_X = 1, PLL_I = 0x0E, PLL_F = 0xDCF9, PLL_C = 0&n;*/
DECL|function|set_pll_freq
r_static
r_void
id|set_pll_freq
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
r_int
id|fin
comma
r_int
r_int
id|fout
)paren
(brace
r_int
r_char
id|fl
comma
id|fh
comma
id|fi
suffix:semicolon
multiline_comment|/* prevent overflows */
id|fin
op_div_assign
l_int|4
suffix:semicolon
id|fout
op_div_assign
l_int|4
suffix:semicolon
id|fout
op_mul_assign
l_int|12
suffix:semicolon
id|fi
op_assign
id|fout
op_div
id|fin
suffix:semicolon
id|fout
op_assign
(paren
id|fout
op_minus
id|fin
op_star
id|fi
)paren
op_star
l_int|256
suffix:semicolon
id|fh
op_assign
id|fout
op_div
id|fin
suffix:semicolon
id|fout
op_assign
(paren
id|fout
op_minus
id|fin
op_star
id|fh
)paren
op_star
l_int|256
suffix:semicolon
id|fl
op_assign
id|fout
op_div
id|fin
suffix:semicolon
multiline_comment|/*printk(&quot;0x%02x 0x%02x 0x%02x&bslash;n&quot;, fi, fh, fl);*/
id|btwrite
c_func
(paren
id|fl
comma
id|BT848_PLL_F_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|fh
comma
id|BT848_PLL_F_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|fi
op_or
id|BT848_PLL_X
comma
id|BT848_PLL_XCI
)paren
suffix:semicolon
)brace
DECL|function|set_pll
r_static
r_int
id|set_pll
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|tv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;pll.pll_crystal
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|btread
c_func
(paren
id|BT848_IFORM
)paren
op_amp
id|btv-&gt;pll.pll_crystal
)paren
)paren
(brace
multiline_comment|/* printk (&quot;switching PLL off&bslash;n&quot;);*/
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_TGCTRL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_PLL_XCI
)paren
suffix:semicolon
id|btv-&gt;pll.pll_crystal
op_and_assign
op_complement
l_int|2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* do not set pll again if already active */
r_if
c_cond
(paren
id|btv-&gt;pll.pll_crystal
op_amp
l_int|2
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* printk (&quot;setting PLL for PAL/SECAM&bslash;n&quot;);*/
id|set_pll_freq
c_func
(paren
id|btv
comma
id|btv-&gt;pll.pll_ifreq
comma
id|btv-&gt;pll.pll_ofreq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Let other people run while the PLL stabilizes&n;&t; */
id|tv
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
multiline_comment|/* .1 seconds */
r_do
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|tv
)paren
)paren
(brace
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|btread
c_func
(paren
id|BT848_DSTATUS
)paren
op_amp
id|BT848_DSTATUS_PLOCK
)paren
)paren
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_DSTATUS
)paren
suffix:semicolon
r_else
(brace
id|btwrite
c_func
(paren
l_int|0x08
comma
id|BT848_TGCTRL
)paren
suffix:semicolon
id|btv-&gt;pll.pll_crystal
op_or_assign
l_int|2
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|bt848_muxsel
r_static
r_void
id|bt848_muxsel
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
r_int
id|input
)paren
(brace
id|btaor
c_func
(paren
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|gpiomask2
comma
op_complement
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|gpiomask2
comma
id|BT848_GPIO_OUT_EN
)paren
suffix:semicolon
multiline_comment|/* This seems to get rid of some synchronization problems */
id|btand
c_func
(paren
op_complement
(paren
l_int|3
op_lshift
l_int|5
)paren
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|input
op_mod_assign
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|inputs
suffix:semicolon
r_if
c_cond
(paren
id|input
op_eq
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|svhs
)paren
(brace
id|btor
c_func
(paren
id|BT848_CONTROL_COMP
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btor
c_func
(paren
id|BT848_CONTROL_COMP
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
r_else
(brace
id|btand
c_func
(paren
op_complement
id|BT848_CONTROL_COMP
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|BT848_CONTROL_COMP
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
id|btaor
c_func
(paren
(paren
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|muxsel
(braket
id|input
op_amp
l_int|7
)braket
op_amp
l_int|3
)paren
op_lshift
l_int|5
comma
op_complement
(paren
l_int|3
op_lshift
l_int|5
)paren
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
(paren
id|input
op_ne
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|tuner
)paren
ques
c_cond
id|AUDIO_EXTERN
suffix:colon
id|AUDIO_TUNER
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|muxsel
(braket
id|input
)braket
op_rshift
l_int|4
comma
op_complement
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|gpiomask2
comma
id|BT848_GPIO_DATA
)paren
suffix:semicolon
)brace
DECL|macro|VBIBUF_SIZE
mdefine_line|#define VBIBUF_SIZE 65536
multiline_comment|/* Maximum sample number per VBI line is 2044, can NTSC deliver this? &n;   Note that we write 2048-aligned to keep alignment to memory pages &n;*/
DECL|macro|VBI_SPL
mdefine_line|#define VBI_SPL 2044
multiline_comment|/* RISC command to write one VBI data line */
DECL|macro|VBI_RISC
mdefine_line|#define VBI_RISC BT848_RISC_WRITE|VBI_SPL|BT848_RISC_EOL|BT848_RISC_SOL
DECL|function|make_vbitab
r_static
r_void
id|make_vbitab
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
op_star
id|po
op_assign
(paren
r_int
r_int
op_star
)paren
id|btv-&gt;vbi_odd
suffix:semicolon
r_int
r_int
op_star
id|pe
op_assign
(paren
r_int
r_int
op_star
)paren
id|btv-&gt;vbi_even
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vbiodd: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|btv-&gt;vbi_odd
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vbievn: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|btv-&gt;vbi_even
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;po: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|po
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;pe: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|pe
)paren
)paren
suffix:semicolon
op_star
(paren
id|po
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|po
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|po
op_increment
)paren
op_assign
id|VBI_RISC
suffix:semicolon
op_star
(paren
id|po
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
(paren
r_int
r_int
)paren
id|btv-&gt;vbibuf
op_plus
id|i
op_star
l_int|2048
)paren
suffix:semicolon
)brace
op_star
(paren
id|po
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
op_star
(paren
id|po
op_increment
)paren
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|4
)paren
suffix:semicolon
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|pe
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|VBI_RISC
suffix:semicolon
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
(paren
r_int
r_int
)paren
id|btv-&gt;vbibuf
op_plus
id|i
op_star
l_int|2048
)paren
suffix:semicolon
)brace
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
op_or
id|BT848_RISC_IRQ
op_or
(paren
l_int|0x01
op_lshift
l_int|16
)paren
suffix:semicolon
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|10
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;po: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|po
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;pe: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|pe
)paren
)paren
suffix:semicolon
)brace
DECL|variable|fmtbppx2
r_int
id|fmtbppx2
(braket
l_int|16
)braket
op_assign
(brace
l_int|8
comma
l_int|6
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|3
comma
l_int|2
comma
l_int|2
comma
l_int|4
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|palette2fmt
r_int
id|palette2fmt
(braket
)braket
op_assign
(brace
l_int|0
comma
id|BT848_COLOR_FMT_Y8
comma
id|BT848_COLOR_FMT_RGB8
comma
id|BT848_COLOR_FMT_RGB16
comma
id|BT848_COLOR_FMT_RGB24
comma
id|BT848_COLOR_FMT_RGB32
comma
id|BT848_COLOR_FMT_RGB15
comma
id|BT848_COLOR_FMT_YUY2
comma
id|BT848_COLOR_FMT_BtYUV
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|BT848_COLOR_FMT_RAW
comma
id|BT848_COLOR_FMT_YCrCb422
comma
id|BT848_COLOR_FMT_YCrCb411
comma
)brace
suffix:semicolon
DECL|macro|PALETTEFMT_MAX
mdefine_line|#define PALETTEFMT_MAX 11
DECL|function|make_rawrisctab
r_static
r_int
id|make_rawrisctab
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
r_int
op_star
id|ro
comma
r_int
r_int
op_star
id|re
comma
r_int
r_int
op_star
id|vbuf
)paren
(brace
r_int
r_int
id|line
suffix:semicolon
r_int
r_int
id|bpl
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* bytes per line */
r_int
r_int
id|vadr
op_assign
(paren
r_int
r_int
)paren
id|vbuf
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* In PAL 650 blocks of 256 DWORDs are sampled, but only if VDELAY&n;           is 2 and without separate VBI grabbing.&n;           We&squot;ll have to handle this inside the IRQ handler ... */
r_for
c_loop
(paren
id|line
op_assign
l_int|0
suffix:semicolon
id|line
OL
l_int|640
suffix:semicolon
id|line
op_increment
)paren
(brace
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|BT848_RISC_WRITE
op_or
id|bpl
op_or
id|BT848_RISC_SOL
op_or
id|BT848_RISC_EOL
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
id|vadr
)paren
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|BT848_RISC_WRITE
op_or
id|bpl
op_or
id|BT848_RISC_SOL
op_or
id|BT848_RISC_EOL
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
id|vadr
op_plus
id|BTTV_MAX_FBUF
op_div
l_int|2
)paren
suffix:semicolon
id|vadr
op_add_assign
id|bpl
suffix:semicolon
)brace
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|btv-&gt;bus_vbi_even
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
op_or
id|BT848_RISC_IRQ
op_or
(paren
l_int|2
op_lshift
l_int|16
)paren
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|btv-&gt;bus_vbi_odd
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|make_vrisctab
r_static
r_int
id|make_vrisctab
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
r_int
op_star
id|ro
comma
r_int
r_int
op_star
id|re
comma
r_int
r_int
op_star
id|vbuf
comma
r_int
r_int
id|width
comma
r_int
r_int
id|height
comma
r_int
r_int
id|fmt
)paren
(brace
r_int
r_int
id|line
suffix:semicolon
r_int
r_int
id|bpl
suffix:semicolon
multiline_comment|/* bytes per line */
r_int
r_int
id|bl
suffix:semicolon
r_int
r_int
id|todo
suffix:semicolon
r_int
r_int
op_star
op_star
id|rp
suffix:semicolon
r_int
id|inter
suffix:semicolon
r_int
r_int
id|vadr
op_assign
(paren
r_int
r_int
)paren
id|vbuf
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;gfmt
op_eq
id|BT848_COLOR_FMT_RAW
)paren
r_return
id|make_rawrisctab
c_func
(paren
id|btv
comma
id|ro
comma
id|re
comma
id|vbuf
)paren
suffix:semicolon
id|inter
op_assign
(paren
id|height
OG
id|btv-&gt;win.cropheight
op_div
l_int|2
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|bpl
op_assign
id|width
op_star
id|fmtbppx2
(braket
id|fmt
op_amp
l_int|0xf
)braket
op_div
l_int|2
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|line
op_assign
l_int|0
suffix:semicolon
id|line
OL
(paren
id|height
op_lshift
(paren
l_int|1
op_xor
id|inter
)paren
)paren
suffix:semicolon
id|line
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inter
)paren
id|rp
op_assign
(paren
id|line
op_amp
l_int|1
)paren
ques
c_cond
op_amp
id|re
suffix:colon
op_amp
id|ro
suffix:semicolon
r_else
id|rp
op_assign
(paren
id|line
OG
id|height
)paren
ques
c_cond
op_amp
id|re
suffix:colon
op_amp
id|ro
suffix:semicolon
id|bl
op_assign
id|PAGE_SIZE
op_minus
(paren
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_amp
id|vadr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bpl
op_le
id|bl
)paren
(brace
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|BT848_RISC_WRITE
op_or
id|BT848_RISC_SOL
op_or
id|BT848_RISC_EOL
op_or
id|bpl
suffix:semicolon
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
id|vadr
)paren
suffix:semicolon
id|vadr
op_add_assign
id|bpl
suffix:semicolon
)brace
r_else
(brace
id|todo
op_assign
id|bpl
suffix:semicolon
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|BT848_RISC_WRITE
op_or
id|BT848_RISC_SOL
op_or
id|bl
suffix:semicolon
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
id|vadr
)paren
suffix:semicolon
id|vadr
op_add_assign
id|bl
suffix:semicolon
id|todo
op_sub_assign
id|bl
suffix:semicolon
r_while
c_loop
(paren
id|todo
OG
id|PAGE_SIZE
)paren
(brace
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|BT848_RISC_WRITE
op_or
id|PAGE_SIZE
suffix:semicolon
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
id|vadr
)paren
suffix:semicolon
id|vadr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|todo
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|BT848_RISC_WRITE
op_or
id|BT848_RISC_EOL
op_or
id|todo
suffix:semicolon
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
id|vadr
)paren
suffix:semicolon
id|vadr
op_add_assign
id|todo
suffix:semicolon
)brace
)brace
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|btv-&gt;bus_vbi_even
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
op_or
id|BT848_RISC_IRQ
op_or
(paren
l_int|2
op_lshift
l_int|16
)paren
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|btv-&gt;bus_vbi_odd
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* does this really make a difference ???? */
DECL|macro|BURST_MAX
mdefine_line|#define BURST_MAX 4096
DECL|function|write_risc_segment
r_static
r_inline
r_void
id|write_risc_segment
c_func
(paren
r_int
r_int
op_star
op_star
id|rp
comma
r_int
r_int
id|line_adr
comma
r_int
r_int
id|command
comma
r_int
op_star
id|x
comma
id|uint
id|dx
comma
id|uint
id|bpp
comma
id|uint
id|width
)paren
(brace
r_int
r_int
id|flags
comma
id|len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dx
)paren
r_return
suffix:semicolon
id|len
op_assign
id|dx
op_star
id|bpp
suffix:semicolon
macro_line|#ifdef LIMIT_DMA
r_if
c_cond
(paren
id|command
op_eq
id|BT848_RISC_WRITEC
)paren
(brace
r_int
r_int
id|dx2
op_assign
id|BURST_MAX
op_div
id|bpp
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
id|BURST_MAX
)paren
(brace
id|write_risc_segment
c_func
(paren
id|rp
comma
id|line_adr
comma
id|command
comma
op_amp
id|x
comma
id|dx2
comma
id|bpp
comma
id|width
)paren
suffix:semicolon
id|dx
op_sub_assign
id|dx2
suffix:semicolon
id|len
op_assign
id|dx
op_star
id|bpp
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* mask upper 8 bits for 24+8 bit overlay modes */
id|flags
op_assign
(paren
(paren
id|bpp
op_eq
l_int|4
)paren
ques
c_cond
id|BT848_RISC_BYTE3
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|x
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|command
op_eq
id|BT848_RISC_SKIP
)paren
(brace
r_if
c_cond
(paren
id|dx
OL
id|width
)paren
(brace
id|flags
op_or_assign
id|BT848_RISC_BYTE_ALL
suffix:semicolon
id|command
op_assign
id|BT848_RISC_WRITE
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|command
op_eq
id|BT848_RISC_WRITEC
)paren
id|command
op_assign
id|BT848_RISC_WRITE
suffix:semicolon
id|flags
op_or_assign
id|BT848_RISC_SOL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|x
op_plus
id|dx
op_eq
id|width
)paren
id|flags
op_or_assign
id|BT848_RISC_EOL
suffix:semicolon
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|command
op_or
id|flags
op_or
id|len
suffix:semicolon
r_if
c_cond
(paren
id|command
op_eq
id|BT848_RISC_WRITE
)paren
op_star
(paren
(paren
op_star
id|rp
)paren
op_increment
)paren
op_assign
id|line_adr
op_plus
op_star
id|x
op_star
id|bpp
suffix:semicolon
op_star
id|x
op_add_assign
id|dx
suffix:semicolon
)brace
DECL|function|make_clip_tab
r_static
r_void
id|make_clip_tab
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|video_clip
op_star
id|cr
comma
r_int
id|ncr
)paren
(brace
r_int
id|i
comma
id|t
suffix:semicolon
r_int
id|yy
comma
id|y
comma
id|x
comma
id|dx
suffix:semicolon
r_struct
id|video_clip
id|first
comma
op_star
id|cur
comma
op_star
id|cur2
comma
op_star
id|nx
comma
id|first2
comma
op_star
id|prev
comma
op_star
id|nx2
suffix:semicolon
r_int
id|bpp
comma
id|bpl
comma
id|width
comma
id|height
comma
id|inter
suffix:semicolon
r_int
r_int
op_star
op_star
id|rp
comma
op_star
id|ro
comma
op_star
id|re
suffix:semicolon
r_int
r_int
id|adr
suffix:semicolon
r_int
id|cx
comma
id|cx2
comma
id|cy
comma
id|cy2
suffix:semicolon
id|inter
op_assign
(paren
id|btv-&gt;win.interlace
op_amp
l_int|1
)paren
op_xor
l_int|1
suffix:semicolon
id|bpp
op_assign
id|btv-&gt;win.bpp
suffix:semicolon
id|bpl
op_assign
id|btv-&gt;win.bpl
suffix:semicolon
id|ro
op_assign
id|btv-&gt;risc_odd
suffix:semicolon
id|re
op_assign
id|btv-&gt;risc_even
suffix:semicolon
id|width
op_assign
id|btv-&gt;win.width
suffix:semicolon
id|height
op_assign
id|btv-&gt;win.height
suffix:semicolon
id|adr
op_assign
id|btv-&gt;win.vidadr
op_plus
id|btv-&gt;win.x
op_star
id|bpp
op_plus
id|btv-&gt;win.y
op_star
id|bpl
suffix:semicolon
multiline_comment|/* clip clipping rects against viewing window AND screen &n;&t;   so we do not have to rely on the user program&n;&t; */
id|cx
op_assign
(paren
id|btv-&gt;win.x
OL
l_int|0
)paren
ques
c_cond
(paren
op_minus
id|btv-&gt;win.x
)paren
suffix:colon
l_int|0
suffix:semicolon
id|cy
op_assign
(paren
id|btv-&gt;win.y
OL
l_int|0
)paren
ques
c_cond
(paren
op_minus
id|btv-&gt;win.y
)paren
suffix:colon
l_int|0
suffix:semicolon
id|cx2
op_assign
(paren
id|btv-&gt;win.x
op_plus
id|width
OG
id|btv-&gt;win.swidth
)paren
ques
c_cond
(paren
id|btv-&gt;win.swidth
op_minus
id|btv-&gt;win.x
)paren
suffix:colon
id|width
suffix:semicolon
id|cy2
op_assign
(paren
id|btv-&gt;win.y
op_plus
id|height
OG
id|btv-&gt;win.sheight
)paren
ques
c_cond
(paren
id|btv-&gt;win.sheight
op_minus
id|btv-&gt;win.y
)paren
suffix:colon
id|height
suffix:semicolon
id|first.next
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|t
op_assign
id|cy
op_minus
id|cr
(braket
id|i
)braket
dot
id|y
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cr
(braket
id|i
)braket
dot
id|height
op_le
id|t
)paren
r_continue
suffix:semicolon
id|cr
(braket
id|i
)braket
dot
id|height
op_sub_assign
id|t
suffix:semicolon
id|cr
(braket
id|i
)braket
dot
id|y
op_assign
id|cy
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|t
op_assign
id|cy2
op_minus
id|cr
(braket
id|i
)braket
dot
id|y
)paren
OL
id|cr
(braket
id|i
)braket
dot
id|height
)paren
(brace
r_if
c_cond
(paren
id|t
op_le
l_int|0
)paren
r_continue
suffix:semicolon
id|cr
(braket
id|i
)braket
dot
id|height
op_assign
id|t
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|t
op_assign
id|cx
op_minus
id|cr
(braket
id|i
)braket
dot
id|x
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cr
(braket
id|i
)braket
dot
id|width
op_le
id|t
)paren
r_continue
suffix:semicolon
id|cr
(braket
id|i
)braket
dot
id|width
op_sub_assign
id|t
suffix:semicolon
id|cr
(braket
id|i
)braket
dot
id|x
op_assign
id|cx
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|t
op_assign
id|cx2
op_minus
id|cr
(braket
id|i
)braket
dot
id|x
)paren
OL
id|cr
(braket
id|i
)braket
dot
id|width
)paren
(brace
r_if
c_cond
(paren
id|t
op_le
l_int|0
)paren
r_continue
suffix:semicolon
id|cr
(braket
id|i
)braket
dot
id|width
op_assign
id|t
suffix:semicolon
)brace
id|cur
op_assign
op_amp
id|first
suffix:semicolon
r_while
c_loop
(paren
(paren
id|nx
op_assign
id|cur-&gt;next
)paren
op_logical_and
(paren
id|cr
(braket
id|i
)braket
dot
id|y
OG
id|cur-&gt;next-&gt;y
)paren
)paren
id|cur
op_assign
id|nx
suffix:semicolon
id|cur-&gt;next
op_assign
op_amp
(paren
id|cr
(braket
id|i
)braket
)paren
suffix:semicolon
id|cr
(braket
id|i
)braket
dot
id|next
op_assign
id|nx
suffix:semicolon
)brace
id|first2.next
op_assign
l_int|NULL
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* loop through all lines */
r_for
c_loop
(paren
id|yy
op_assign
l_int|0
suffix:semicolon
id|yy
OL
(paren
id|height
op_lshift
id|inter
)paren
suffix:semicolon
id|yy
op_increment
)paren
(brace
id|y
op_assign
id|yy
op_rshift
id|inter
suffix:semicolon
id|rp
op_assign
(paren
id|yy
op_amp
l_int|1
)paren
ques
c_cond
op_amp
id|re
suffix:colon
op_amp
id|ro
suffix:semicolon
multiline_comment|/* remove rects with y2 &gt; y */
r_if
c_cond
(paren
(paren
id|cur
op_assign
id|first2.next
)paren
)paren
(brace
id|prev
op_assign
op_amp
id|first2
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|cur-&gt;y
op_plus
id|cur-&gt;height
op_le
id|y
)paren
id|prev-&gt;next
op_assign
id|cur-&gt;next
suffix:semicolon
r_else
id|prev
op_assign
id|cur
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|cur
op_assign
id|cur-&gt;next
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* add rect to second (x-sorted) list if rect.y == y  */
r_if
c_cond
(paren
(paren
id|cur
op_assign
id|first.next
)paren
)paren
(brace
r_while
c_loop
(paren
(paren
id|cur
)paren
op_logical_and
(paren
id|cur-&gt;y
op_eq
id|y
)paren
)paren
(brace
id|first.next
op_assign
id|cur-&gt;next
suffix:semicolon
id|cur2
op_assign
op_amp
id|first2
suffix:semicolon
r_while
c_loop
(paren
(paren
id|nx2
op_assign
id|cur2-&gt;next
)paren
op_logical_and
(paren
id|cur-&gt;x
OG
id|cur2-&gt;next-&gt;x
)paren
)paren
id|cur2
op_assign
id|nx2
suffix:semicolon
id|cur2-&gt;next
op_assign
id|cur
suffix:semicolon
id|cur-&gt;next
op_assign
id|nx2
suffix:semicolon
id|cur
op_assign
id|first.next
suffix:semicolon
)brace
)brace
id|x
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|btv-&gt;win.y
op_plus
id|y
op_le
l_int|0
)paren
op_logical_or
(paren
id|btv-&gt;win.y
op_plus
id|y
op_ge
id|btv-&gt;win.sheight
)paren
)paren
id|write_risc_segment
c_func
(paren
id|rp
comma
id|adr
comma
id|BT848_RISC_SKIP
comma
op_amp
id|x
comma
id|width
comma
id|bpp
comma
id|width
)paren
suffix:semicolon
r_else
(brace
id|dx
op_assign
id|cx
suffix:semicolon
r_for
c_loop
(paren
id|cur2
op_assign
id|first2.next
suffix:semicolon
id|cur2
suffix:semicolon
id|cur2
op_assign
id|cur2-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|x
op_plus
id|dx
OL
id|cur2-&gt;x
)paren
(brace
id|write_risc_segment
c_func
(paren
id|rp
comma
id|adr
comma
id|BT848_RISC_SKIP
comma
op_amp
id|x
comma
id|dx
comma
id|bpp
comma
id|width
)paren
suffix:semicolon
id|dx
op_assign
id|cur2-&gt;x
op_minus
id|x
suffix:semicolon
id|write_risc_segment
c_func
(paren
id|rp
comma
id|adr
comma
id|BT848_RISC_WRITEC
comma
op_amp
id|x
comma
id|dx
comma
id|bpp
comma
id|width
)paren
suffix:semicolon
id|dx
op_assign
id|cur2-&gt;width
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|x
op_plus
id|dx
OL
id|cur2-&gt;x
op_plus
id|cur2-&gt;width
)paren
id|dx
op_assign
id|cur2-&gt;x
op_plus
id|cur2-&gt;width
op_minus
id|x
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cx2
OL
id|width
)paren
(brace
id|write_risc_segment
c_func
(paren
id|rp
comma
id|adr
comma
id|BT848_RISC_SKIP
comma
op_amp
id|x
comma
id|dx
comma
id|bpp
comma
id|width
)paren
suffix:semicolon
id|write_risc_segment
c_func
(paren
id|rp
comma
id|adr
comma
id|BT848_RISC_WRITEC
comma
op_amp
id|x
comma
id|cx2
op_minus
id|x
comma
id|bpp
comma
id|width
)paren
suffix:semicolon
id|dx
op_assign
id|width
op_minus
id|x
suffix:semicolon
)brace
id|write_risc_segment
c_func
(paren
id|rp
comma
id|adr
comma
id|BT848_RISC_SKIP
comma
op_amp
id|x
comma
id|dx
comma
id|bpp
comma
id|width
)paren
suffix:semicolon
id|write_risc_segment
c_func
(paren
id|rp
comma
id|adr
comma
id|BT848_RISC_WRITEC
comma
op_amp
id|x
comma
id|width
op_minus
id|x
comma
id|bpp
comma
id|width
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|inter
)paren
op_logical_or
(paren
id|yy
op_amp
l_int|1
)paren
)paren
id|adr
op_add_assign
id|bpl
suffix:semicolon
)brace
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
op_star
(paren
id|ro
op_increment
)paren
op_assign
id|btv-&gt;bus_vbi_even
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
op_star
(paren
id|re
op_increment
)paren
op_assign
id|btv-&gt;bus_vbi_odd
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set the registers for the size we have specified. Don&squot;t bother&n; *&t;trying to understand this without the BT848 manual in front of&n; *&t;you [AC]. &n; *&n; *&t;PS: The manual is free for download in .pdf format from &n; *&t;www.brooktree.com - nicely done those folks.&n; */
DECL|struct|tvnorm
r_struct
id|tvnorm
(brace
DECL|member|Fsc
id|u32
id|Fsc
suffix:semicolon
DECL|member|swidth
DECL|member|sheight
id|u16
id|swidth
comma
id|sheight
suffix:semicolon
multiline_comment|/* scaled standard width, height */
DECL|member|totalwidth
id|u16
id|totalwidth
suffix:semicolon
DECL|member|adelay
DECL|member|bdelay
DECL|member|iform
id|u8
id|adelay
comma
id|bdelay
comma
id|iform
suffix:semicolon
DECL|member|scaledtwidth
id|u32
id|scaledtwidth
suffix:semicolon
DECL|member|hdelayx1
DECL|member|hactivex1
id|u16
id|hdelayx1
comma
id|hactivex1
suffix:semicolon
DECL|member|vdelay
DECL|member|fporch
id|u16
id|vdelay
comma
id|fporch
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|tvnorms
r_static
r_struct
id|tvnorm
id|tvnorms
(braket
)braket
op_assign
(brace
multiline_comment|/* PAL-BDGHI */
multiline_comment|/* max. active video is actually 922, but 924 is divisible by 4 and 3! */
(brace
l_int|35468950
comma
l_int|924
comma
l_int|576
comma
l_int|1135
comma
l_int|0x7f
comma
l_int|0x72
comma
(paren
id|BT848_IFORM_PAL_BDGHI
op_or
id|BT848_IFORM_XT1
)paren
comma
l_int|1135
comma
l_int|186
comma
l_int|924
comma
l_int|0x20
)brace
comma
multiline_comment|/*&n;        { 35468950, &n;          768, 576, 1135, 0x7f, 0x72, (BT848_IFORM_PAL_BDGHI|BT848_IFORM_XT1),&n;&t;  944, 186, 922, 0x20},&n;*/
multiline_comment|/* NTSC */
(brace
l_int|28636363
comma
l_int|640
comma
l_int|480
comma
l_int|910
comma
l_int|0x68
comma
l_int|0x5d
comma
(paren
id|BT848_IFORM_NTSC
op_or
id|BT848_IFORM_XT0
)paren
comma
l_int|780
comma
l_int|135
comma
l_int|754
comma
l_int|0x1a
)brace
comma
multiline_comment|/* SECAM */
(brace
l_int|28636363
comma
l_int|640
comma
l_int|480
comma
l_int|910
comma
l_int|0x68
comma
l_int|0x5d
comma
(paren
id|BT848_IFORM_PAL_M
op_or
id|BT848_IFORM_XT0
)paren
comma
l_int|780
comma
l_int|135
comma
l_int|754
comma
l_int|0x16
)brace
comma
multiline_comment|/* PAL-M */
(brace
l_int|28636363
comma
l_int|640
comma
l_int|480
comma
l_int|910
comma
l_int|0x68
comma
l_int|0x5d
comma
(paren
id|BT848_IFORM_PAL_M
op_or
id|BT848_IFORM_XT0
)paren
comma
l_int|780
comma
l_int|135
comma
l_int|754
comma
l_int|0x16
)brace
comma
multiline_comment|/* PAL-N */
(brace
l_int|35468950
comma
l_int|768
comma
l_int|576
comma
l_int|1135
comma
l_int|0x7f
comma
l_int|0x72
comma
(paren
id|BT848_IFORM_PAL_N
op_or
id|BT848_IFORM_XT1
)paren
comma
l_int|944
comma
l_int|186
comma
l_int|922
comma
l_int|0x20
)brace
comma
multiline_comment|/* PAL-NC */
(brace
l_int|35468950
comma
l_int|768
comma
l_int|576
comma
l_int|1135
comma
l_int|0x7f
comma
l_int|0x72
comma
(paren
id|BT848_IFORM_PAL_NC
op_or
id|BT848_IFORM_XT0
)paren
comma
l_int|944
comma
l_int|186
comma
l_int|922
comma
l_int|0x20
)brace
comma
multiline_comment|/* NTSC-Japan */
(brace
l_int|28636363
comma
l_int|640
comma
l_int|480
comma
l_int|910
comma
l_int|0x68
comma
l_int|0x5d
comma
(paren
id|BT848_IFORM_NTSC_J
op_or
id|BT848_IFORM_XT0
)paren
comma
l_int|780
comma
l_int|135
comma
l_int|754
comma
l_int|0x16
)brace
comma
)brace
suffix:semicolon
DECL|macro|TVNORMS
mdefine_line|#define TVNORMS (sizeof(tvnorms)/sizeof(tvnorm))
multiline_comment|/* set geometry for even/odd frames &n;   just if you are wondering:&n;   handling of even and odd frames will be separated, e.g. for grabbing&n;   the even ones as RGB into videomem and the others as YUV in main memory for &n;   compressing and sending to the video conferencing partner.&n;&n;*/
DECL|function|bt848_set_eogeo
r_static
r_inline
r_void
id|bt848_set_eogeo
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
id|odd
comma
id|u8
id|vtc
comma
id|u16
id|hscale
comma
id|u16
id|vscale
comma
id|u16
id|hactive
comma
id|u16
id|vactive
comma
id|u16
id|hdelay
comma
id|u16
id|vdelay
comma
id|u8
id|crop
)paren
(brace
r_int
id|off
op_assign
id|odd
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x00
suffix:semicolon
id|btwrite
c_func
(paren
id|vtc
comma
id|BT848_E_VTC
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hscale
op_rshift
l_int|8
comma
id|BT848_E_HSCALE_HI
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hscale
op_amp
l_int|0xff
comma
id|BT848_E_HSCALE_LO
op_plus
id|off
)paren
suffix:semicolon
id|btaor
c_func
(paren
(paren
id|vscale
op_rshift
l_int|8
)paren
comma
l_int|0xe0
comma
id|BT848_E_VSCALE_HI
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|vscale
op_amp
l_int|0xff
comma
id|BT848_E_VSCALE_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hactive
op_amp
l_int|0xff
comma
id|BT848_E_HACTIVE_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hdelay
op_amp
l_int|0xff
comma
id|BT848_E_HDELAY_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|vactive
op_amp
l_int|0xff
comma
id|BT848_E_VACTIVE_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|vdelay
op_amp
l_int|0xff
comma
id|BT848_E_VDELAY_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|crop
comma
id|BT848_E_CROP
op_plus
id|off
)paren
suffix:semicolon
)brace
DECL|function|bt848_set_geo
r_static
r_void
id|bt848_set_geo
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|u16
id|width
comma
id|u16
id|height
comma
id|u16
id|fmt
)paren
(brace
id|u16
id|vscale
comma
id|hscale
suffix:semicolon
id|u32
id|xsf
comma
id|sr
suffix:semicolon
id|u16
id|hdelay
comma
id|vdelay
suffix:semicolon
id|u16
id|hactive
comma
id|vactive
suffix:semicolon
id|u16
id|inter
suffix:semicolon
id|u8
id|crop
comma
id|vtc
suffix:semicolon
r_struct
id|tvnorm
op_star
id|tvn
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|width
op_logical_or
op_logical_neg
id|height
)paren
r_return
suffix:semicolon
id|tvn
op_assign
op_amp
id|tvnorms
(braket
id|btv-&gt;win.norm
)braket
suffix:semicolon
id|btv-&gt;win.cropheight
op_assign
id|tvn-&gt;sheight
suffix:semicolon
id|btv-&gt;win.cropwidth
op_assign
id|tvn-&gt;swidth
suffix:semicolon
multiline_comment|/*&n;&t;if (btv-&gt;win.cropwidth&gt;tvn-&gt;cropwidth)&n;                btv-&gt;win.cropwidth=tvn-&gt;cropwidth;&n;&t;if (btv-&gt;win.cropheight&gt;tvn-&gt;cropheight)&n;&t;        btv-&gt;win.cropheight=tvn-&gt;cropheight;&n;&n;&t;if (width&gt;btv-&gt;win.cropwidth)&n;                width=btv-&gt;win.cropwidth;&n;&t;if (height&gt;btv-&gt;win.cropheight)&n;&t;        height=btv-&gt;win.cropheight;&n;*/
id|btwrite
c_func
(paren
id|tvn-&gt;adelay
comma
id|BT848_ADELAY
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|tvn-&gt;bdelay
comma
id|BT848_BDELAY
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|tvn-&gt;iform
comma
op_complement
(paren
id|BT848_IFORM_NORM
op_or
id|BT848_IFORM_XTBOTH
)paren
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|set_pll
c_func
(paren
id|btv
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|fmt
comma
id|BT848_COLOR_FMT
)paren
suffix:semicolon
id|hactive
op_assign
id|width
suffix:semicolon
id|vtc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Some people say interpolation looks bad ... */
multiline_comment|/* vtc = (hactive &lt; 193) ? 2 : ((hactive &lt; 385) ? 1 : 0); */
id|btv-&gt;win.interlace
op_assign
(paren
id|height
OG
id|btv-&gt;win.cropheight
op_div
l_int|2
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|inter
op_assign
(paren
id|btv-&gt;win.interlace
op_amp
l_int|1
)paren
op_xor
l_int|1
suffix:semicolon
id|vdelay
op_assign
id|btv-&gt;win.cropy
op_plus
id|tvn-&gt;vdelay
suffix:semicolon
id|xsf
op_assign
(paren
id|hactive
op_star
id|tvn-&gt;scaledtwidth
)paren
op_div
id|btv-&gt;win.cropwidth
suffix:semicolon
id|hscale
op_assign
(paren
(paren
id|tvn-&gt;totalwidth
op_star
l_int|4096UL
)paren
op_div
id|xsf
op_minus
l_int|4096
)paren
suffix:semicolon
id|hdelay
op_assign
id|tvn-&gt;hdelayx1
op_plus
id|btv-&gt;win.cropx
suffix:semicolon
id|hdelay
op_assign
(paren
id|hdelay
op_star
id|hactive
)paren
op_div
id|btv-&gt;win.cropwidth
suffix:semicolon
id|hdelay
op_and_assign
l_int|0x3fe
suffix:semicolon
id|sr
op_assign
(paren
(paren
id|btv-&gt;win.cropheight
op_rshift
id|inter
)paren
op_star
l_int|512
)paren
op_div
id|height
op_minus
l_int|512
suffix:semicolon
id|vscale
op_assign
(paren
l_int|0x10000UL
op_minus
id|sr
)paren
op_amp
l_int|0x1fff
suffix:semicolon
id|vactive
op_assign
id|btv-&gt;win.cropheight
suffix:semicolon
id|crop
op_assign
(paren
(paren
id|hactive
op_rshift
l_int|8
)paren
op_amp
l_int|0x03
)paren
op_or
(paren
(paren
id|hdelay
op_rshift
l_int|6
)paren
op_amp
l_int|0x0c
)paren
op_or
(paren
(paren
id|vactive
op_rshift
l_int|4
)paren
op_amp
l_int|0x30
)paren
op_or
(paren
(paren
id|vdelay
op_rshift
l_int|2
)paren
op_amp
l_int|0xc0
)paren
suffix:semicolon
id|vscale
op_or_assign
id|btv-&gt;win.interlace
ques
c_cond
(paren
id|BT848_VSCALE_INT
op_lshift
l_int|8
)paren
suffix:colon
l_int|0
suffix:semicolon
id|bt848_set_eogeo
c_func
(paren
id|btv
comma
l_int|0
comma
id|vtc
comma
id|hscale
comma
id|vscale
comma
id|hactive
comma
id|vactive
comma
id|hdelay
comma
id|vdelay
comma
id|crop
)paren
suffix:semicolon
id|bt848_set_eogeo
c_func
(paren
id|btv
comma
l_int|1
comma
id|vtc
comma
id|hscale
comma
id|vscale
comma
id|hactive
comma
id|vactive
comma
id|hdelay
comma
id|vdelay
comma
id|crop
)paren
suffix:semicolon
)brace
DECL|variable|bpp2fmt
r_int
id|bpp2fmt
(braket
l_int|4
)braket
op_assign
(brace
id|BT848_COLOR_FMT_RGB8
comma
id|BT848_COLOR_FMT_RGB16
comma
id|BT848_COLOR_FMT_RGB24
comma
id|BT848_COLOR_FMT_RGB32
)brace
suffix:semicolon
DECL|function|bt848_set_winsize
r_static
r_void
id|bt848_set_winsize
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
r_int
r_int
id|format
suffix:semicolon
id|btv-&gt;win.color_fmt
op_assign
id|format
op_assign
(paren
id|btv-&gt;win.depth
op_eq
l_int|15
)paren
ques
c_cond
id|BT848_COLOR_FMT_RGB15
suffix:colon
id|bpp2fmt
(braket
(paren
id|btv-&gt;win.bpp
op_minus
l_int|1
)paren
op_amp
l_int|3
)braket
suffix:semicolon
multiline_comment|/*&t;RGB8 seems to be a 9x5x5 GRB color cube starting at&n;&t; *&t;color 16. Why the h... can&squot;t they even mention this in the&n;&t; *&t;data sheet?  [AC - because it&squot;s a standard format so I guess&n;&t; *&t;it never occurred to them]&n;&t; *&t;Enable dithering in this mode.&n;&t; */
r_if
c_cond
(paren
id|format
op_eq
id|BT848_COLOR_FMT_RGB8
)paren
id|btand
c_func
(paren
op_complement
id|BT848_CAP_CTL_DITH_FRAME
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
r_else
id|btor
c_func
(paren
id|BT848_CAP_CTL_DITH_FRAME
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
id|bt848_set_geo
c_func
(paren
id|btv
comma
id|btv-&gt;win.width
comma
id|btv-&gt;win.height
comma
id|format
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set TSA5522 synthesizer frequency in 1/16 Mhz steps&n; */
DECL|function|set_freq
r_static
r_void
id|set_freq
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
r_int
id|freq
)paren
(brace
r_int
id|fixme
op_assign
id|freq
suffix:semicolon
multiline_comment|/* XXX */
r_int
id|oldAudio
op_assign
id|btv-&gt;audio
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_MUTE
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|AUDIO_MUTE_DELAY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;radio
)paren
(brace
r_if
c_cond
(paren
id|btv-&gt;have_tuner
)paren
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_TUNER
comma
id|TUNER_SET_RADIOFREQ
comma
op_amp
id|fixme
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;have_msp3400
)paren
(brace
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_SET_RADIO
comma
l_int|0
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_NEWCHANNEL
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|btv-&gt;have_tuner
)paren
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_TUNER
comma
id|TUNER_SET_TVFREQ
comma
op_amp
id|fixme
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;have_msp3400
)paren
(brace
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_SET_TVNORM
comma
op_amp
(paren
id|btv-&gt;win.norm
)paren
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_NEWCHANNEL
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|oldAudio
op_amp
id|AUDIO_MUTE
)paren
)paren
(brace
id|udelay
c_func
(paren
id|FREQ_CHANGE_DELAY
)paren
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_UNMUTE
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Grab into virtual memory.&n; *&t;Currently only does double buffering. Do we need more?&n; */
DECL|function|vgrab
r_static
r_int
id|vgrab
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|video_mmap
op_star
id|mp
)paren
(brace
r_int
r_int
op_star
id|ro
comma
op_star
id|re
suffix:semicolon
r_int
r_int
op_star
id|vbuf
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;fbuffer
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|fbuffer_alloc
c_func
(paren
id|btv
)paren
)paren
(brace
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|btv-&gt;grabbing
op_ge
id|MAX_GBUFFERS
)paren
(brace
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;No grabbing past the end of the buffer!&n;&t; */
r_if
c_cond
(paren
id|mp-&gt;frame
OG
l_int|1
op_logical_or
id|mp-&gt;frame
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;height
OL
l_int|0
op_logical_or
id|mp-&gt;width
OL
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*      This doesn&#xfffd;t work like this for NTSC anyway.&n;        So, better check the total image size ...&n;*/
multiline_comment|/*&n;&t;if(mp-&gt;height&gt;576 || mp-&gt;width&gt;768)&n;&t;&t;return -EINVAL;&n;*/
r_if
c_cond
(paren
id|mp-&gt;height
op_star
id|mp-&gt;width
op_star
id|fmtbppx2
(braket
id|mp-&gt;format
op_amp
l_int|0x0f
)braket
op_div
l_int|2
OG
id|BTTV_MAX_FBUF
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; *&t;FIXME: Check the format of the grab here. This is probably&n;&t; *&t;also less restrictive than the normal overlay grabs. Stuff&n;&t; *&t;like QCIF has meaning as a capture.&n;&t; */
multiline_comment|/*&n;&t; *&t;Ok load up the BT848&n;&t; */
id|vbuf
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|btv-&gt;fbuffer
op_plus
id|BTTV_MAX_FBUF
op_star
id|mp-&gt;frame
)paren
suffix:semicolon
multiline_comment|/*&t;if (!(btread(BT848_DSTATUS)&amp;BT848_DSTATUS_HLOC))&n;                return -EAGAIN;*/
id|ro
op_assign
id|btv-&gt;grisc
op_plus
(paren
(paren
(paren
id|btv-&gt;grabcount
op_increment
)paren
op_amp
l_int|1
)paren
ques
c_cond
l_int|4096
suffix:colon
l_int|0
)paren
suffix:semicolon
id|re
op_assign
id|ro
op_plus
l_int|2048
suffix:semicolon
id|btv-&gt;gwidth
op_assign
id|mp-&gt;width
suffix:semicolon
id|btv-&gt;gheight
op_assign
id|mp-&gt;height
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;format
OG
id|PALETTEFMT_MAX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|btv-&gt;gfmt
op_assign
id|palette2fmt
(braket
id|mp-&gt;format
)braket
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;gfmt
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|make_vrisctab
c_func
(paren
id|btv
comma
id|ro
comma
id|re
comma
id|vbuf
comma
id|btv-&gt;gwidth
comma
id|btv-&gt;gheight
comma
id|btv-&gt;gfmt
)paren
suffix:semicolon
multiline_comment|/* bt848_set_risc_jmps(btv); */
id|btor
c_func
(paren
l_int|3
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
id|btor
c_func
(paren
l_int|3
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
id|btv-&gt;frame_stat
(braket
id|mp-&gt;frame
)braket
op_assign
id|GBUFFER_GRABBING
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;grabbing
)paren
(brace
id|btv-&gt;gro_next
op_assign
id|virt_to_bus
c_func
(paren
id|ro
)paren
suffix:semicolon
id|btv-&gt;gre_next
op_assign
id|virt_to_bus
c_func
(paren
id|re
)paren
suffix:semicolon
id|btv-&gt;grf_next
op_assign
id|mp-&gt;frame
suffix:semicolon
)brace
r_else
(brace
id|btv-&gt;gro
op_assign
id|virt_to_bus
c_func
(paren
id|ro
)paren
suffix:semicolon
id|btv-&gt;gre
op_assign
id|virt_to_bus
c_func
(paren
id|re
)paren
suffix:semicolon
id|btv-&gt;grf
op_assign
id|mp-&gt;frame
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|btv-&gt;grabbing
op_increment
)paren
)paren
id|btv-&gt;risc_jmp
(braket
l_int|12
)braket
op_assign
id|BT848_RISC_JUMP
op_or
(paren
l_int|0x8
op_lshift
l_int|16
)paren
op_or
id|BT848_RISC_IRQ
suffix:semicolon
multiline_comment|/* interruptible_sleep_on(&amp;btv-&gt;capq); */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bttv_write
r_static
r_int
id|bttv_write
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|bttv_read
r_static
r_int
id|bttv_read
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|v
suffix:semicolon
r_int
id|q
comma
id|todo
suffix:semicolon
id|todo
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|todo
op_logical_and
id|todo
OG
(paren
id|q
op_assign
id|VBIBUF_SIZE
op_minus
id|btv-&gt;vbip
)paren
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
(paren
r_void
op_star
)paren
id|btv-&gt;vbibuf
op_plus
id|btv-&gt;vbip
comma
id|q
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|todo
op_sub_assign
id|q
suffix:semicolon
id|buf
op_add_assign
id|q
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|todo
op_logical_and
id|q
op_eq
id|VBIBUF_SIZE
op_minus
id|btv-&gt;vbip
)paren
(brace
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
id|todo
)paren
(brace
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
r_return
id|count
op_minus
id|todo
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|btv-&gt;vbiq
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
id|todo
op_eq
id|count
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_else
r_return
id|count
op_minus
id|todo
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|todo
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
(paren
r_void
op_star
)paren
id|btv-&gt;vbibuf
op_plus
id|btv-&gt;vbip
comma
id|todo
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|btv-&gt;vbip
op_add_assign
id|todo
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Open a bttv card. Right now the flags stuff is just playing&n; */
DECL|function|bttv_open
r_static
r_int
id|bttv_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|dev
suffix:semicolon
r_int
id|users
comma
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|flags
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|btv-&gt;user
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|btv-&gt;user
op_increment
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_UNMUTE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|users
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bttv_num
suffix:semicolon
id|i
op_increment
)paren
id|users
op_add_assign
id|bttvs
(braket
id|i
)braket
dot
id|user
suffix:semicolon
r_if
c_cond
(paren
id|users
op_eq
l_int|1
)paren
id|find_vga
c_func
(paren
)paren
suffix:semicolon
id|btv-&gt;fbuffer
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;fbuffer
)paren
id|btv-&gt;fbuffer
op_assign
(paren
r_int
r_char
op_star
)paren
id|rvmalloc
c_func
(paren
l_int|2
op_star
id|BTTV_MAX_FBUF
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;fbuffer
)paren
(brace
id|btv-&gt;user
op_decrement
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|btv-&gt;grabbing
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;grab
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;lastgrab
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_GBUFFERS
suffix:semicolon
id|i
op_increment
)paren
id|btv-&gt;frame_stat
(braket
id|i
)braket
op_assign
id|GBUFFER_UNUSED
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_break
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bttv_close
r_static
r_void
id|bttv_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|dev
suffix:semicolon
id|btv-&gt;user
op_decrement
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_MUTE
)paren
suffix:semicolon
id|btv-&gt;cap
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;fbuffer
)paren
(brace
id|rvfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;fbuffer
comma
l_int|2
op_star
id|BTTV_MAX_FBUF
)paren
suffix:semicolon
)brace
id|btv-&gt;fbuffer
op_assign
l_int|0
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/***********************************/
multiline_comment|/* ioctls and supporting functions */
multiline_comment|/***********************************/
DECL|function|bt848_bright
r_extern
r_inline
r_void
id|bt848_bright
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|bright
)paren
(brace
id|btwrite
c_func
(paren
id|bright
op_amp
l_int|0xff
comma
id|BT848_BRIGHT
)paren
suffix:semicolon
)brace
DECL|function|bt848_hue
r_extern
r_inline
r_void
id|bt848_hue
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|hue
)paren
(brace
id|btwrite
c_func
(paren
id|hue
op_amp
l_int|0xff
comma
id|BT848_HUE
)paren
suffix:semicolon
)brace
DECL|function|bt848_contrast
r_extern
r_inline
r_void
id|bt848_contrast
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|cont
)paren
(brace
r_int
r_int
id|conthi
suffix:semicolon
id|conthi
op_assign
(paren
id|cont
op_rshift
l_int|6
)paren
op_amp
l_int|4
suffix:semicolon
id|btwrite
c_func
(paren
id|cont
op_amp
l_int|0xff
comma
id|BT848_CONTRAST_LO
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|conthi
comma
op_complement
l_int|4
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|conthi
comma
op_complement
l_int|4
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|bt848_sat_u
r_extern
r_inline
r_void
id|bt848_sat_u
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
r_int
id|data
)paren
(brace
id|u32
id|datahi
suffix:semicolon
id|datahi
op_assign
(paren
id|data
op_rshift
l_int|7
)paren
op_amp
l_int|2
suffix:semicolon
id|btwrite
c_func
(paren
id|data
op_amp
l_int|0xff
comma
id|BT848_SAT_U_LO
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|datahi
comma
op_complement
l_int|2
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|datahi
comma
op_complement
l_int|2
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|bt848_sat_v
r_static
r_inline
r_void
id|bt848_sat_v
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
r_int
id|data
)paren
(brace
id|u32
id|datahi
suffix:semicolon
id|datahi
op_assign
(paren
id|data
op_rshift
l_int|8
)paren
op_amp
l_int|1
suffix:semicolon
id|btwrite
c_func
(paren
id|data
op_amp
l_int|0xff
comma
id|BT848_SAT_V_LO
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|datahi
comma
op_complement
l_int|1
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|datahi
comma
op_complement
l_int|1
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;ioctl routine&n; */
DECL|function|bttv_ioctl
r_static
r_int
id|bttv_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
r_char
id|eedata
(braket
l_int|256
)braket
suffix:semicolon
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|dev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|strcpy
c_func
(paren
id|b.name
comma
id|btv-&gt;video_dev.name
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_TUNER
op_or
id|VID_TYPE_TELETEXT
op_or
id|VID_TYPE_OVERLAY
op_or
id|VID_TYPE_CLIPPING
op_or
id|VID_TYPE_FRAMERAM
op_or
id|VID_TYPE_SCALES
suffix:semicolon
id|b.channels
op_assign
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|inputs
suffix:semicolon
id|b.audios
op_assign
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|inputs
suffix:semicolon
id|b.maxwidth
op_assign
l_int|768
suffix:semicolon
id|b.maxheight
op_assign
l_int|576
suffix:semicolon
id|b.minwidth
op_assign
l_int|32
suffix:semicolon
id|b.minheight
op_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|v.flags
op_assign
id|VIDEO_VC_AUDIO
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|v.norm
op_assign
id|btv-&gt;win.norm
suffix:semicolon
r_if
c_cond
(paren
id|v.channel
op_ge
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|inputs
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|v.channel
op_eq
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|tuner
)paren
(brace
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Television&quot;
)paren
suffix:semicolon
id|v.flags
op_or_assign
id|VIDEO_VC_TUNER
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_TV
suffix:semicolon
id|v.tuners
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|v.channel
op_eq
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|svhs
)paren
(brace
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;SVHS&quot;
)paren
suffix:semicolon
)brace
r_else
id|sprintf
c_func
(paren
id|v.name
comma
l_string|&quot;Composite%d&quot;
comma
id|v.channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Each channel has 1 tuner&n;&t;&t; */
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.channel
OG
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|inputs
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|bt848_muxsel
c_func
(paren
id|btv
comma
id|v.channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v.norm
op_ne
id|VIDEO_MODE_PAL
op_logical_and
id|v.norm
op_ne
id|VIDEO_MODE_NTSC
op_logical_and
id|v.norm
op_ne
id|VIDEO_MODE_SECAM
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|btv-&gt;win.norm
op_assign
id|v.norm
suffix:semicolon
id|bt848_set_winsize
c_func
(paren
id|btv
)paren
suffix:semicolon
id|btv-&gt;channel
op_assign
id|v.channel
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.tuner
op_logical_or
id|btv-&gt;channel
)paren
(brace
multiline_comment|/* Only tuner 0 */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Television&quot;
)paren
suffix:semicolon
id|v.rangelow
op_assign
l_int|0
suffix:semicolon
id|v.rangehigh
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|v.flags
op_assign
id|VIDEO_TUNER_PAL
op_or
id|VIDEO_TUNER_NTSC
op_or
id|VIDEO_TUNER_SECAM
suffix:semicolon
id|v.mode
op_assign
id|btv-&gt;win.norm
suffix:semicolon
id|v.signal
op_assign
(paren
id|btread
c_func
(paren
id|BT848_DSTATUS
)paren
op_amp
id|BT848_DSTATUS_HLOC
)paren
ques
c_cond
l_int|0xFFFF
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We have but one tuner */
r_case
id|VIDIOCSTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Only one channel has a tuner */
r_if
c_cond
(paren
id|v.tuner
op_ne
id|tvcards
(braket
id|btv-&gt;type
)braket
dot
id|tuner
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.mode
op_ne
id|VIDEO_MODE_PAL
op_logical_and
id|v.mode
op_ne
id|VIDEO_MODE_NTSC
op_logical_and
id|v.mode
op_ne
id|VIDEO_MODE_SECAM
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|btv-&gt;win.norm
op_assign
id|v.mode
suffix:semicolon
id|bt848_set_winsize
c_func
(paren
id|btv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
op_assign
id|btv-&gt;picture
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;win.depth
op_eq
l_int|8
)paren
(brace
id|p.palette
op_assign
id|VIDEO_PALETTE_HI240
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.depth
op_eq
l_int|15
)paren
(brace
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB555
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.depth
op_eq
l_int|16
)paren
(brace
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB565
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.depth
op_eq
l_int|24
)paren
(brace
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB24
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.depth
op_eq
l_int|32
)paren
(brace
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
r_int
id|format
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* We want -128 to 127 we get 0-65535 */
id|bt848_bright
c_func
(paren
id|btv
comma
(paren
id|p.brightness
op_rshift
l_int|8
)paren
op_minus
l_int|128
)paren
suffix:semicolon
multiline_comment|/* 0-511 for the colour */
id|bt848_sat_u
c_func
(paren
id|btv
comma
id|p.colour
op_rshift
l_int|7
)paren
suffix:semicolon
id|bt848_sat_v
c_func
(paren
id|btv
comma
(paren
(paren
id|p.colour
op_rshift
l_int|7
)paren
op_star
l_int|201L
)paren
op_div
l_int|237
)paren
suffix:semicolon
multiline_comment|/* -128 to 127 */
id|bt848_hue
c_func
(paren
id|btv
comma
(paren
id|p.hue
op_rshift
l_int|8
)paren
op_minus
l_int|128
)paren
suffix:semicolon
multiline_comment|/* 0-511 */
id|bt848_contrast
c_func
(paren
id|btv
comma
id|p.contrast
op_rshift
l_int|7
)paren
suffix:semicolon
id|btv-&gt;picture
op_assign
id|p
suffix:semicolon
multiline_comment|/* set palette if bpp matches */
r_if
c_cond
(paren
id|p.palette
OL
r_sizeof
(paren
id|palette2fmt
)paren
op_div
r_sizeof
(paren
r_int
)paren
)paren
(brace
id|format
op_assign
id|palette2fmt
(braket
id|p.palette
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fmtbppx2
(braket
id|format
op_amp
l_int|0x0f
)braket
op_div
l_int|2
op_eq
id|btv-&gt;win.bpp
)paren
id|btv-&gt;win.color_fmt
op_assign
id|format
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
r_struct
id|video_clip
op_star
id|vcp
suffix:semicolon
r_int
id|on
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.flags
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|btv-&gt;win.x
op_assign
id|vw.x
suffix:semicolon
id|btv-&gt;win.y
op_assign
id|vw.y
suffix:semicolon
id|btv-&gt;win.width
op_assign
id|vw.width
suffix:semicolon
id|btv-&gt;win.height
op_assign
id|vw.height
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;win.height
OG
id|btv-&gt;win.cropheight
op_div
l_int|2
)paren
(brace
id|btv-&gt;win.interlace
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|btv-&gt;win.interlace
op_assign
l_int|0
suffix:semicolon
id|on
op_assign
(paren
id|btv-&gt;cap
op_amp
l_int|3
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|bt848_cap
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
id|bt848_set_winsize
c_func
(paren
id|btv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vw.clipcount
OG
l_int|256
)paren
(brace
r_return
op_minus
id|EDOM
suffix:semicolon
)brace
multiline_comment|/* Too many! */
multiline_comment|/*&n;&t;&t;&t; *&t;Do any clips.&n;&t;&t;&t; */
id|vcp
op_assign
id|vmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
(paren
id|vw.clipcount
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcp
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.clipcount
op_logical_and
id|copy_from_user
c_func
(paren
id|vcp
comma
id|vw.clips
comma
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
id|vw.clipcount
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|make_clip_tab
c_func
(paren
id|btv
comma
id|vcp
comma
id|vw.clipcount
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|vcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
op_logical_and
id|btv-&gt;win.vidadr
op_ne
l_int|0
)paren
(brace
id|bt848_cap
c_func
(paren
id|btv
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
multiline_comment|/* Oh for a COBOL move corresponding .. */
id|vw.x
op_assign
id|btv-&gt;win.x
suffix:semicolon
id|vw.y
op_assign
id|btv-&gt;win.y
suffix:semicolon
id|vw.width
op_assign
id|btv-&gt;win.width
suffix:semicolon
id|vw.height
op_assign
id|btv-&gt;win.height
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;win.interlace
)paren
(brace
id|vw.flags
op_or_assign
id|VIDEO_WINDOW_INTERLACE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCCAPTURE
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v
op_eq
l_int|0
)paren
(brace
id|bt848_cap
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|btv-&gt;win.vidadr
op_eq
l_int|0
op_logical_or
id|btv-&gt;win.width
op_eq
l_int|0
op_logical_or
id|btv-&gt;win.height
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bt848_cap
c_func
(paren
id|btv
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|v
suffix:semicolon
id|v.base
op_assign
(paren
r_void
op_star
)paren
id|btv-&gt;win.vidadr
suffix:semicolon
id|v.height
op_assign
id|btv-&gt;win.sheight
suffix:semicolon
id|v.width
op_assign
id|btv-&gt;win.swidth
suffix:semicolon
id|v.depth
op_assign
id|btv-&gt;win.depth
suffix:semicolon
id|v.bytesperline
op_assign
id|btv-&gt;win.bpl
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|v
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.depth
op_ne
l_int|8
op_logical_and
id|v.depth
op_ne
l_int|15
op_logical_and
id|v.depth
op_ne
l_int|16
op_logical_and
id|v.depth
op_ne
l_int|24
op_logical_and
id|v.depth
op_ne
l_int|32
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|btv-&gt;win.vidadr
op_assign
(paren
r_int
r_int
)paren
id|v.base
suffix:semicolon
id|btv-&gt;win.sheight
op_assign
id|v.height
suffix:semicolon
id|btv-&gt;win.swidth
op_assign
id|v.width
suffix:semicolon
id|btv-&gt;win.bpp
op_assign
(paren
(paren
id|v.depth
op_plus
l_int|7
)paren
op_amp
l_int|0x38
)paren
op_div
l_int|8
suffix:semicolon
id|btv-&gt;win.depth
op_assign
id|v.depth
suffix:semicolon
id|btv-&gt;win.bpl
op_assign
id|v.bytesperline
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Display at %p is %d by %d, bytedepth %d, bpl %d&bslash;n&quot;
comma
id|v.base
comma
id|v.width
comma
id|v.height
comma
id|btv-&gt;win.bpp
comma
id|btv-&gt;win.bpl
)paren
)paren
suffix:semicolon
id|bt848_set_winsize
c_func
(paren
id|btv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCKEY
suffix:colon
(brace
multiline_comment|/* Will be handled higher up .. */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFREQ
suffix:colon
(brace
r_int
r_int
id|v
op_assign
id|btv-&gt;win.freq
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSFREQ
suffix:colon
(brace
r_int
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|btv-&gt;win.freq
op_assign
id|v
suffix:semicolon
id|set_freq
c_func
(paren
id|btv
comma
id|btv-&gt;win.freq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGAUDIO
suffix:colon
(brace
r_struct
id|video_audio
id|v
suffix:semicolon
id|v
op_assign
id|btv-&gt;audio_dev
suffix:semicolon
id|v.flags
op_and_assign
op_complement
(paren
id|VIDEO_AUDIO_MUTE
op_or
id|VIDEO_AUDIO_MUTABLE
)paren
suffix:semicolon
id|v.flags
op_or_assign
id|VIDEO_AUDIO_MUTABLE
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;TV&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;have_msp3400
)paren
(brace
id|v.flags
op_or_assign
id|VIDEO_AUDIO_VOLUME
op_or
id|VIDEO_AUDIO_BASS
op_or
id|VIDEO_AUDIO_TREBLE
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_GET_VOLUME
comma
op_amp
(paren
id|v.volume
)paren
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_GET_BASS
comma
op_amp
(paren
id|v.bass
)paren
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_GET_TREBLE
comma
op_amp
(paren
id|v.treble
)paren
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_GET_STEREO
comma
op_amp
(paren
id|v.mode
)paren
)paren
suffix:semicolon
)brace
r_else
id|v.mode
op_assign
id|VIDEO_SOUND_MONO
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSAUDIO
suffix:colon
(brace
r_struct
id|video_audio
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_MUTE
)paren
(brace
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_MUTE
)paren
suffix:semicolon
)brace
multiline_comment|/* One audio source per tuner */
r_if
c_cond
(paren
id|v.audio
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bt848_muxsel
c_func
(paren
id|btv
comma
id|v.audio
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_MUTE
)paren
)paren
(brace
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_UNMUTE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;have_msp3400
)paren
(brace
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_SET_VOLUME
comma
op_amp
(paren
id|v.volume
)paren
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_SET_BASS
comma
op_amp
(paren
id|v.bass
)paren
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_SET_TREBLE
comma
op_amp
(paren
id|v.treble
)paren
)paren
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_SET_STEREO
comma
op_amp
(paren
id|v.mode
)paren
)paren
suffix:semicolon
)brace
id|btv-&gt;audio_dev
op_assign
id|v
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSYNC
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|i
comma
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|btv-&gt;frame_stat
(braket
id|i
)braket
)paren
(brace
r_case
id|GBUFFER_UNUSED
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|GBUFFER_GRABBING
suffix:colon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|btv-&gt;capq
)paren
suffix:semicolon
multiline_comment|/* fall */
r_case
id|GBUFFER_DONE
suffix:colon
id|btv-&gt;frame_stat
(braket
id|i
)braket
op_assign
id|GBUFFER_UNUSED
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|BTTV_WRITEE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
id|eedata
comma
(paren
r_void
op_star
)paren
id|arg
comma
l_int|256
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|writeee
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|eedata
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|BTTV_READEE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|readee
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|eedata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
id|eedata
comma
l_int|256
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BTTV_FIELDNR
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|btv-&gt;last_field
comma
r_sizeof
(paren
id|btv-&gt;last_field
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BTTV_PLLSET
suffix:colon
(brace
r_struct
id|bttv_pll_info
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|btv-&gt;pll
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|btv-&gt;pll.pll_ifreq
op_assign
id|p.pll_ifreq
suffix:semicolon
id|btv-&gt;pll.pll_ofreq
op_assign
id|p.pll_ofreq
suffix:semicolon
id|btv-&gt;pll.pll_crystal
op_assign
id|p.pll_crystal
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
id|vm
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;frame_stat
(braket
id|vm.frame
)braket
op_eq
id|GBUFFER_GRABBING
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_return
id|vgrab
c_func
(paren
id|btv
comma
op_amp
id|vm
)paren
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
id|vm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|vm
comma
l_int|0
comma
r_sizeof
(paren
id|vm
)paren
)paren
suffix:semicolon
id|vm.size
op_assign
id|BTTV_MAX_FBUF
op_star
l_int|2
suffix:semicolon
id|vm.frames
op_assign
l_int|2
suffix:semicolon
id|vm.offsets
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|vm.offsets
(braket
l_int|1
)braket
op_assign
id|BTTV_MAX_FBUF
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vm
comma
r_sizeof
(paren
id|vm
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGUNIT
suffix:colon
(brace
r_struct
id|video_unit
id|vu
suffix:semicolon
id|vu.video
op_assign
id|btv-&gt;video_dev.minor
suffix:semicolon
id|vu.vbi
op_assign
id|btv-&gt;vbi_dev.minor
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;radio_dev.minor
op_ne
op_minus
l_int|1
)paren
(brace
id|vu.radio
op_assign
id|btv-&gt;radio_dev.minor
suffix:semicolon
)brace
r_else
id|vu.radio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vu.audio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;have_msp3400
)paren
(brace
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_MSP3400
comma
id|MSP_GET_UNIT
comma
op_amp
id|vu.audio
)paren
suffix:semicolon
)brace
id|vu.teletext
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|vu
comma
r_sizeof
(paren
id|vu
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bttv_init_done
r_static
r_int
id|bttv_init_done
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;This maps the vmalloced and reserved fbuffer to user space.&n; *&n; *  FIXME: &n; *  - PAGE_READONLY should suffice!?&n; *  - remap_page_range is kind of inefficient for page by page remapping.&n; *    But e.g. pte_alloc() does not work in modules ... :-(&n; */
DECL|function|bttv_mmap
r_static
r_int
id|bttv_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|dev
suffix:semicolon
r_int
r_int
id|start
op_assign
(paren
r_int
r_int
)paren
id|adr
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
l_int|2
op_star
id|BTTV_MAX_FBUF
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;fbuffer
)paren
(brace
r_if
c_cond
(paren
id|fbuffer_alloc
c_func
(paren
id|btv
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|pos
op_assign
(paren
r_int
r_int
)paren
id|btv-&gt;fbuffer
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_phys
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|bttv_template
r_static
r_struct
id|video_device
id|bttv_template
op_assign
(brace
l_string|&quot;UNSET&quot;
comma
id|VID_TYPE_TUNER
op_or
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_OVERLAY
op_or
id|VID_TYPE_TELETEXT
comma
id|VID_HARDWARE_BT848
comma
id|bttv_open
comma
id|bttv_close
comma
id|bttv_read
comma
id|bttv_write
comma
l_int|NULL
comma
multiline_comment|/* poll */
id|bttv_ioctl
comma
id|bttv_mmap
comma
id|bttv_init_done
comma
l_int|NULL
comma
l_int|0
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|function|vbi_read
r_static
r_int
id|vbi_read
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
(paren
id|v
op_minus
l_int|2
)paren
suffix:semicolon
r_int
id|q
comma
id|todo
suffix:semicolon
id|todo
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|todo
op_logical_and
id|todo
OG
(paren
id|q
op_assign
id|VBIBUF_SIZE
op_minus
id|btv-&gt;vbip
)paren
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
(paren
r_void
op_star
)paren
id|btv-&gt;vbibuf
op_plus
id|btv-&gt;vbip
comma
id|q
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|todo
op_sub_assign
id|q
suffix:semicolon
id|buf
op_add_assign
id|q
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|todo
op_logical_and
id|q
op_eq
id|VBIBUF_SIZE
op_minus
id|btv-&gt;vbip
)paren
(brace
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
id|todo
)paren
(brace
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
r_return
id|count
op_minus
id|todo
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|btv-&gt;vbiq
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
id|todo
op_eq
id|count
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_else
r_return
id|count
op_minus
id|todo
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|todo
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
(paren
r_void
op_star
)paren
id|btv-&gt;vbibuf
op_plus
id|btv-&gt;vbip
comma
id|todo
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|btv-&gt;vbip
op_add_assign
id|todo
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|vbi_poll
r_static
r_int
r_int
id|vbi_poll
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
(paren
id|dev
op_minus
l_int|2
)paren
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|btv-&gt;vbiq
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;vbip
OL
id|VBIBUF_SIZE
)paren
id|mask
op_or_assign
(paren
id|POLLIN
op_or
id|POLLRDNORM
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|vbi_open
r_static
r_int
id|vbi_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
(paren
id|dev
op_minus
l_int|2
)paren
suffix:semicolon
id|btv-&gt;vbip
op_assign
id|VBIBUF_SIZE
suffix:semicolon
id|btv-&gt;cap
op_or_assign
l_int|0x0c
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vbi_close
r_static
r_void
id|vbi_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
(paren
id|dev
op_minus
l_int|2
)paren
suffix:semicolon
id|btv-&gt;cap
op_and_assign
op_complement
l_int|0x0c
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|vbi_ioctl
r_static
r_int
id|vbi_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|vbi_template
r_static
r_struct
id|video_device
id|vbi_template
op_assign
(brace
l_string|&quot;bttv vbi&quot;
comma
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_TELETEXT
comma
id|VID_HARDWARE_BT848
comma
id|vbi_open
comma
id|vbi_close
comma
id|vbi_read
comma
id|bttv_write
comma
id|vbi_poll
comma
id|vbi_ioctl
comma
l_int|NULL
comma
multiline_comment|/* no mmap yet */
id|bttv_init_done
comma
l_int|NULL
comma
l_int|0
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|function|radio_open
r_static
r_int
id|radio_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
(paren
id|dev
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;user
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|btv-&gt;user
op_increment
suffix:semicolon
id|set_freq
c_func
(paren
id|btv
comma
l_int|400
op_star
l_int|16
)paren
suffix:semicolon
id|btv-&gt;radio
op_assign
l_int|1
suffix:semicolon
id|bt848_muxsel
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_UNMUTE
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radio_close
r_static
r_void
id|radio_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
(paren
id|dev
op_minus
l_int|1
)paren
suffix:semicolon
id|btv-&gt;user
op_decrement
suffix:semicolon
id|btv-&gt;radio
op_assign
l_int|0
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_MUTE
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|radio_read
r_static
r_int
id|radio_read
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|radio_ioctl
r_static
r_int
id|radio_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
(paren
id|dev
op_minus
l_int|1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|v
suffix:semicolon
id|strcpy
c_func
(paren
id|v.name
comma
id|btv-&gt;video_dev.name
)paren
suffix:semicolon
id|v.type
op_assign
id|VID_TYPE_TUNER
suffix:semicolon
id|v.channels
op_assign
l_int|1
suffix:semicolon
id|v.audios
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* No we don&squot;t do pictures */
id|v.maxwidth
op_assign
l_int|0
suffix:semicolon
id|v.maxheight
op_assign
l_int|0
suffix:semicolon
id|v.minwidth
op_assign
l_int|0
suffix:semicolon
id|v.minheight
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|VIDIOCGTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.tuner
op_logical_or
id|btv-&gt;channel
)paren
(brace
multiline_comment|/* Only tuner 0 */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Radio&quot;
)paren
suffix:semicolon
id|v.rangelow
op_assign
(paren
r_int
)paren
(paren
l_float|87.5
op_star
l_int|16
)paren
suffix:semicolon
id|v.rangehigh
op_assign
(paren
r_int
)paren
(paren
l_int|108
op_star
l_int|16
)paren
suffix:semicolon
id|v.flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX */
id|v.mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Only channel 0 has a tuner */
r_if
c_cond
(paren
id|v.tuner
op_ne
l_int|0
op_logical_or
id|btv-&gt;channel
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* XXX anything to do ??? */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFREQ
suffix:colon
r_case
id|VIDIOCSFREQ
suffix:colon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_case
id|VIDIOCSAUDIO
suffix:colon
id|bttv_ioctl
c_func
(paren
(paren
r_struct
id|video_device
op_star
)paren
id|btv
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|radio_template
r_static
r_struct
id|video_device
id|radio_template
op_assign
(brace
l_string|&quot;bttv radio&quot;
comma
id|VID_TYPE_TUNER
comma
id|VID_HARDWARE_BT848
comma
id|radio_open
comma
id|radio_close
comma
id|radio_read
comma
multiline_comment|/* just returns -EINVAL */
id|bttv_write
comma
multiline_comment|/* just returns -EINVAL */
l_int|NULL
comma
multiline_comment|/* no poll */
id|radio_ioctl
comma
l_int|NULL
comma
multiline_comment|/* no mmap */
id|bttv_init_done
comma
multiline_comment|/* just returns 0 */
l_int|NULL
comma
l_int|0
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|struct|vidbases
r_struct
id|vidbases
(brace
DECL|member|vendor
DECL|member|device
r_int
r_int
id|vendor
comma
id|device
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|badr
id|uint
id|badr
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|vbs
r_static
r_struct
id|vidbases
id|vbs
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_ATI
comma
id|PCI_DEVICE_ID_ATI_215CT222
comma
l_string|&quot;ATI MACH64 CT&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_ATI
comma
id|PCI_DEVICE_ID_ATI_210888GX
comma
l_string|&quot;ATI MACH64 Winturbo&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_ATI
comma
id|PCI_DEVICE_ID_ATI_215GT
comma
l_string|&quot;ATI MACH64 GT&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_CIRRUS
comma
l_int|0
comma
l_string|&quot;Cirrus Logic&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_DEC
comma
id|PCI_DEVICE_ID_DEC_TGA
comma
l_string|&quot;DEC DC21030&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_MATROX
comma
id|PCI_DEVICE_ID_MATROX_MIL
comma
l_string|&quot;Matrox Millennium&quot;
comma
id|PCI_BASE_ADDRESS_1
)brace
comma
(brace
id|PCI_VENDOR_ID_MATROX
comma
id|PCI_DEVICE_ID_MATROX_MIL_2
comma
l_string|&quot;Matrox Millennium II&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_MATROX
comma
id|PCI_DEVICE_ID_MATROX_MIL_2_AGP
comma
l_string|&quot;Matrox Millennium II AGP&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_MATROX
comma
l_int|0x051a
comma
l_string|&quot;Matrox Mystique&quot;
comma
id|PCI_BASE_ADDRESS_1
)brace
comma
(brace
id|PCI_VENDOR_ID_N9
comma
id|PCI_DEVICE_ID_N9_I128
comma
l_string|&quot;Number Nine Imagine 128&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_N9
comma
id|PCI_DEVICE_ID_N9_I128_2
comma
l_string|&quot;Number Nine Imagine 128 Series 2&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_S3
comma
l_int|0
comma
l_string|&quot;S3&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_TSENG
comma
l_int|0
comma
l_string|&quot;TSENG&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_NVIDIA_SGS
comma
id|PCI_DEVICE_ID_NVIDIA_SGS_RIVA128
comma
l_string|&quot;Riva128&quot;
comma
id|PCI_BASE_ADDRESS_1
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* DEC TGA offsets stolen from XFree-3.2 */
DECL|variable|dec_offsets
r_static
id|uint
id|dec_offsets
(braket
l_int|4
)braket
op_assign
(brace
l_int|0x200000
comma
l_int|0x804000
comma
l_int|0
comma
l_int|0x1004000
)brace
suffix:semicolon
DECL|macro|NR_CARDS
mdefine_line|#define NR_CARDS (sizeof(vbs)/sizeof(struct vidbases))
multiline_comment|/* Scan for PCI display adapter&n;   if more than one card is present the last one is used for now */
DECL|function|find_vga
r_static
r_int
id|find_vga
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|badr
suffix:semicolon
r_int
id|found
op_assign
l_int|0
comma
id|i
comma
id|tga_type
suffix:semicolon
r_int
r_int
id|vidadr
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|pci_devices
suffix:semicolon
id|dev
op_ne
l_int|NULL
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|dev
op_member_access_from_pointer
r_class
op_ne
id|PCI_CLASS_NOT_DEFINED_VGA
op_logical_and
(paren
(paren
id|dev
op_member_access_from_pointer
r_class
)paren
op_rshift
l_int|16
op_ne
id|PCI_BASE_CLASS_DISPLAY
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
id|badr
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: PCI display adapter: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;vendor
op_eq
id|vbs
(braket
id|i
)braket
dot
id|vendor
)paren
(brace
r_if
c_cond
(paren
id|vbs
(braket
id|i
)braket
dot
id|device
)paren
r_if
c_cond
(paren
id|vbs
(braket
id|i
)braket
dot
id|device
op_ne
id|dev-&gt;device
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s.&bslash;n&quot;
comma
id|vbs
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
id|badr
op_assign
id|vbs
(braket
id|i
)braket
dot
id|badr
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|badr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: Unknown video memory base address.&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|badr
comma
op_amp
id|vidadr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vidadr
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: Memory seems to be I/O memory.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: Check entry for your card type in bttv.c vidbases struct.&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|vidadr
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vidadr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: Memory @ 0, must be something wrong!&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_DEC
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_DEC_TGA
)paren
(brace
id|tga_type
op_assign
(paren
id|readl
c_func
(paren
(paren
r_int
r_int
)paren
id|vidadr
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_ne
l_int|0
op_logical_and
id|tga_type
op_ne
l_int|1
op_logical_and
id|tga_type
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: TGA type (0x%x) unrecognized!&bslash;n&quot;
comma
id|tga_type
)paren
suffix:semicolon
id|found
op_decrement
suffix:semicolon
)brace
id|vidadr
op_add_assign
id|dec_offsets
(braket
id|tga_type
)braket
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: memory @ 0x%08x, &quot;
comma
id|vidadr
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;devfn: 0x%04x.&bslash;n&quot;
comma
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
id|found
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vidmem
)paren
(brace
id|vidadr
op_assign
id|vidmem
op_lshift
l_int|20
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: Video memory override: 0x%08x&bslash;n&quot;
comma
id|vidadr
)paren
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BTTV_MAX
suffix:semicolon
id|i
op_increment
)paren
id|bttvs
(braket
id|i
)braket
dot
id|win.vidadr
op_assign
id|vidadr
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
DECL|macro|TRITON_PCON
mdefine_line|#define  TRITON_PCON&t;           0x50 
DECL|macro|TRITON_BUS_CONCURRENCY
mdefine_line|#define  TRITON_BUS_CONCURRENCY   (1&lt;&lt;0)
DECL|macro|TRITON_STREAMING
mdefine_line|#define  TRITON_STREAMING&t;  (1&lt;&lt;1)
DECL|macro|TRITON_WRITE_BURST
mdefine_line|#define  TRITON_WRITE_BURST&t;  (1&lt;&lt;2)
DECL|macro|TRITON_PEER_CONCURRENCY
mdefine_line|#define  TRITON_PEER_CONCURRENCY  (1&lt;&lt;3)
DECL|function|handle_chipset
r_static
r_void
id|handle_chipset
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&t;Just in case some nut set this to something dangerous */
r_if
c_cond
(paren
id|triton1
)paren
id|triton1
op_assign
id|BT848_INT_ETBF
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_496
comma
id|dev
)paren
)paren
)paren
(brace
multiline_comment|/* Beware the SiS 85C496 my friend - rev 49 don&squot;t work with a bttv */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;BT848 and SIS 85C496 chipset don&squot;t always work together.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* dev == NULL */
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82441
comma
id|dev
)paren
)paren
)paren
(brace
r_int
r_char
id|b
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x53
comma
op_amp
id|b
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: Host bridge: 82441FX Natoma, &quot;
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;bufcon=0x%02x&bslash;n&quot;
comma
id|b
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82437
comma
id|dev
)paren
)paren
)paren
(brace
multiline_comment|/*&t;&t;unsigned char b;&n;&t;&t;unsigned char bo;*/
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: Host bridge 82437FX Triton PIIX&bslash;n&quot;
)paren
suffix:semicolon
id|triton1
op_assign
id|BT848_INT_ETBF
suffix:semicolon
macro_line|#if 0&t;&t;&t;
multiline_comment|/* The ETBF bit SHOULD make all this unnecessary */
multiline_comment|/* 430FX (Triton I) freezes with bus concurrency on -&gt; switch it off */
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|TRITON_PCON
comma
op_amp
id|b
)paren
suffix:semicolon
id|bo
op_assign
id|b
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: 82437FX: PCON: 0x%x&bslash;n&quot;
comma
id|b
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|b
op_amp
id|TRITON_BUS_CONCURRENCY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: 82437FX: disabling bus concurrency&bslash;n&quot;
)paren
suffix:semicolon
id|b
op_or_assign
id|TRITON_BUS_CONCURRENCY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|b
op_amp
id|TRITON_PEER_CONCURRENCY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: 82437FX: disabling peer concurrency&bslash;n&quot;
)paren
suffix:semicolon
id|b
op_and_assign
op_complement
id|TRITON_PEER_CONCURRENCY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|b
op_amp
id|TRITON_STREAMING
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: 82437FX: disabling streaming&bslash;n&quot;
)paren
suffix:semicolon
id|b
op_or_assign
id|TRITON_STREAMING
suffix:semicolon
)brace
r_if
c_cond
(paren
id|b
op_ne
id|bo
)paren
(brace
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|TRITON_PCON
comma
id|b
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: 82437FX: PCON changed to: 0x%x&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
DECL|function|init_tda8425
r_static
r_void
id|init_tda8425
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
)paren
(brace
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA8425
comma
id|TDA8425_VL
comma
l_int|0xFC
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* volume left 0dB  */
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA8425
comma
id|TDA8425_VR
comma
l_int|0xFC
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* volume right 0dB */
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA8425
comma
id|TDA8425_BA
comma
l_int|0xF6
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* bass 0dB         */
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA8425
comma
id|TDA8425_TR
comma
l_int|0xF6
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* treble 0dB       */
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA8425
comma
id|TDA8425_S1
comma
l_int|0xCE
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* mute off         */
)brace
DECL|function|init_tda9850
r_static
r_void
id|init_tda9850
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
)paren
(brace
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA9850
comma
id|TDA9850_CON1
comma
l_int|0x08
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* noise threshold st */
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA9850
comma
id|TDA9850_CON2
comma
l_int|0x08
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* noise threshold sap */
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA9850
comma
id|TDA9850_CON3
comma
l_int|0x40
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* stereo mode */
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA9850
comma
id|TDA9850_CON4
comma
l_int|0x07
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 0 dB input gain?*/
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA9850
comma
id|TDA9850_ALI1
comma
l_int|0x10
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* wideband alignment? */
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA9850
comma
id|TDA9850_ALI2
comma
l_int|0x10
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* spectral alignment? */
id|I2CWrite
c_func
(paren
id|bus
comma
id|I2C_TDA9850
comma
id|TDA9850_ALI3
comma
l_int|0x03
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Figure out card and tuner type */
DECL|function|idcard
r_static
r_void
id|idcard
c_func
(paren
r_int
id|i
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
op_amp
id|bttvs
(braket
id|i
)braket
suffix:semicolon
r_int
id|tunertype
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_GPIO_OUT_EN
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: GPIO: 0x%08x&bslash;n&quot;
comma
id|i
comma
id|btread
c_func
(paren
id|BT848_GPIO_DATA
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Default the card to the user-selected one. */
id|btv-&gt;type
op_assign
id|card
(braket
id|i
)braket
suffix:semicolon
id|btv-&gt;tuner_type
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* use default tuner type */
multiline_comment|/* If we were asked to auto-detect, then do so! &n;&t;   Right now this will only recognize Miro, Hauppauge or STB&n;&t;   */
r_if
c_cond
(paren
id|btv-&gt;type
op_eq
id|BTTV_UNKNOWN
)paren
(brace
id|btv-&gt;type
op_assign
id|BTTV_MIRO
suffix:semicolon
r_if
c_cond
(paren
id|I2CRead
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_HAUPEE
)paren
op_ge
l_int|0
)paren
id|btv-&gt;type
op_assign
id|BTTV_HAUPPAUGE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|I2CRead
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_STBEE
)paren
op_ge
l_int|0
)paren
id|btv-&gt;type
op_assign
id|BTTV_STB
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;type
op_eq
id|BTTV_MIRO
)paren
(brace
multiline_comment|/* auto detect tuner for MIRO cards */
id|btv-&gt;tuner_type
op_assign
(paren
(paren
id|btread
c_func
(paren
id|BT848_GPIO_DATA
)paren
op_rshift
l_int|10
)paren
op_minus
l_int|1
)paren
op_amp
l_int|7
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|I2CRead
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_TDA9850
)paren
op_ge
l_int|0
)paren
(brace
id|btv-&gt;audio_chip
op_assign
id|TDA9850
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv%d: audio chip: TDA9850&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I2CRead
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_TDA8425
)paren
op_ge
l_int|0
)paren
(brace
id|btv-&gt;audio_chip
op_assign
id|TDA8425
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bttv%d: audio chip: TDA8425&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|btv-&gt;audio_chip
)paren
(brace
r_case
id|TDA9850
suffix:colon
id|init_tda9850
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TDA8425
suffix:colon
id|init_tda8425
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* How do I detect the tuner type for other cards but Miro ??? */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv%d: model: &quot;
comma
id|btv-&gt;nr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|btv-&gt;type
)paren
(brace
r_case
id|BTTV_MIRO
suffix:colon
id|printk
c_func
(paren
l_string|&quot;MIRO&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;have_tuner
)paren
(brace
id|tunertype
op_assign
(paren
(paren
id|btread
c_func
(paren
id|BT848_GPIO_DATA
)paren
op_rshift
l_int|10
)paren
op_minus
l_int|1
)paren
op_amp
l_int|7
suffix:semicolon
id|i2c_control_device
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
id|I2C_DRIVERID_TUNER
comma
id|TUNER_SET_TYPE
comma
op_amp
id|tunertype
)paren
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(Miro)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_HAUPPAUGE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;HAUPPAUGE&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(Hauppauge)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_STB
suffix:colon
id|printk
c_func
(paren
l_string|&quot;STB&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(STB)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_INTEL
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Intel&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(Intel)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_DIAMOND
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Diamond&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(Diamond)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_AVERMEDIA
suffix:colon
id|printk
c_func
(paren
l_string|&quot;AVerMedia&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(AVerMedia)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_MATRIX_VISION
suffix:colon
id|printk
c_func
(paren
l_string|&quot;MATRIX-Vision&bslash;n&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(MATRIX-Vision)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_MUTE
)paren
suffix:semicolon
)brace
DECL|function|bt848_set_risc_jmps
r_static
r_void
id|bt848_set_risc_jmps
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
r_int
id|flags
op_assign
id|btv-&gt;cap
suffix:semicolon
multiline_comment|/* Sync to start of odd field */
id|btv-&gt;risc_jmp
(braket
l_int|0
)braket
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_RISC_RESYNC
op_or
id|BT848_FIFO_STATUS_VRE
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Jump to odd vbi sub */
id|btv-&gt;risc_jmp
(braket
l_int|2
)braket
op_assign
id|BT848_RISC_JUMP
op_or
(paren
l_int|0x5
op_lshift
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|8
)paren
id|btv-&gt;risc_jmp
(braket
l_int|3
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;vbi_odd
)paren
suffix:semicolon
r_else
id|btv-&gt;risc_jmp
(braket
l_int|3
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Jump to odd sub */
id|btv-&gt;risc_jmp
(braket
l_int|4
)braket
op_assign
id|BT848_RISC_JUMP
op_or
(paren
l_int|0x6
op_lshift
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|2
)paren
id|btv-&gt;risc_jmp
(braket
l_int|5
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_odd
)paren
suffix:semicolon
r_else
id|btv-&gt;risc_jmp
(braket
l_int|5
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Sync to start of even field */
id|btv-&gt;risc_jmp
(braket
l_int|6
)braket
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_RISC_RESYNC
op_or
id|BT848_FIFO_STATUS_VRO
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Jump to even vbi sub */
id|btv-&gt;risc_jmp
(braket
l_int|8
)braket
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|4
)paren
id|btv-&gt;risc_jmp
(braket
l_int|9
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;vbi_even
)paren
suffix:semicolon
r_else
id|btv-&gt;risc_jmp
(braket
l_int|9
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Jump to even sub */
id|btv-&gt;risc_jmp
(braket
l_int|10
)braket
op_assign
id|BT848_RISC_JUMP
op_or
(paren
l_int|8
op_lshift
l_int|20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|1
)paren
id|btv-&gt;risc_jmp
(braket
l_int|11
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_even
)paren
suffix:semicolon
r_else
id|btv-&gt;risc_jmp
(braket
l_int|11
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|12
)paren
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|12
)braket
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|13
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
)paren
suffix:semicolon
multiline_comment|/* enable capturing and DMA */
id|btaor
c_func
(paren
id|flags
comma
op_complement
l_int|0x0f
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|0x0f
)paren
id|bt848_dma
c_func
(paren
id|btv
comma
l_int|3
)paren
suffix:semicolon
r_else
id|bt848_dma
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|init_bt848
r_static
r_int
id|init_bt848
c_func
(paren
r_int
id|i
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
op_amp
id|bttvs
(braket
id|i
)braket
suffix:semicolon
id|btv-&gt;user
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset the bt848 */
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_SRESET
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: bt848_mem: 0x%08x&bslash;n&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|btv-&gt;bt848_mem
)paren
)paren
suffix:semicolon
macro_line|#ifdef RESET_MSP_HAUPPAUGE
multiline_comment|/* Reset the MSP on some Hauppauge cards */
multiline_comment|/* Thanks to Ky&#xfffd;sti M&#xfffd;lkki (kmalkki@cc.hut.fi)! */
multiline_comment|/* Can this hurt cards without one? What about Miros with MSP? */
id|btaor
c_func
(paren
l_int|32
comma
op_complement
l_int|32
comma
id|BT848_GPIO_OUT_EN
)paren
suffix:semicolon
id|btaor
c_func
(paren
l_int|0
comma
op_complement
l_int|32
comma
id|BT848_GPIO_DATA
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2500
)paren
suffix:semicolon
id|btaor
c_func
(paren
l_int|32
comma
op_complement
l_int|32
comma
id|BT848_GPIO_DATA
)paren
suffix:semicolon
id|btaor
c_func
(paren
l_int|0
comma
op_complement
l_int|32
comma
id|BT848_GPIO_OUT_EN
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* default setup for max. PAL size in a 1024xXXX hicolor framebuffer */
id|btv-&gt;win.norm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* change this to 1 for NTSC, 2 for SECAM */
id|btv-&gt;win.interlace
op_assign
l_int|1
suffix:semicolon
id|btv-&gt;win.x
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;win.y
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;win.width
op_assign
l_int|768
suffix:semicolon
multiline_comment|/* 640 */
id|btv-&gt;win.height
op_assign
l_int|576
suffix:semicolon
multiline_comment|/* 480 */
id|btv-&gt;win.cropwidth
op_assign
l_int|768
suffix:semicolon
multiline_comment|/* 640 */
id|btv-&gt;win.cropheight
op_assign
l_int|576
suffix:semicolon
multiline_comment|/* 480 */
id|btv-&gt;win.cropx
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;win.cropy
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;win.bpp
op_assign
l_int|2
suffix:semicolon
id|btv-&gt;win.depth
op_assign
l_int|16
suffix:semicolon
id|btv-&gt;win.color_fmt
op_assign
id|BT848_COLOR_FMT_RGB16
suffix:semicolon
id|btv-&gt;win.bpl
op_assign
l_int|1024
op_star
id|btv-&gt;win.bpp
suffix:semicolon
id|btv-&gt;win.swidth
op_assign
l_int|1024
suffix:semicolon
id|btv-&gt;win.sheight
op_assign
l_int|768
suffix:semicolon
id|btv-&gt;cap
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;gmode
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;risc_odd
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;risc_even
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;risc_jmp
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;vbibuf
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;grisc
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;grabbing
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;grabcount
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;grab
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;lastgrab
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;field
op_assign
id|btv-&gt;last_field
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* i2c */
id|memcpy
c_func
(paren
op_amp
(paren
id|btv-&gt;i2c
)paren
comma
op_amp
id|bttv_i2c_bus_template
comma
r_sizeof
(paren
r_struct
id|i2c_bus
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|btv-&gt;i2c.name
comma
l_string|&quot;bt848-%d&quot;
comma
id|i
)paren
suffix:semicolon
id|btv-&gt;i2c.data
op_assign
id|btv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|btv-&gt;risc_odd
op_assign
(paren
r_int
r_int
op_star
)paren
id|kmalloc
c_func
(paren
id|RISCMEM_LEN
op_div
l_int|2
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|btv-&gt;risc_even
op_assign
(paren
r_int
r_int
op_star
)paren
id|kmalloc
c_func
(paren
id|RISCMEM_LEN
op_div
l_int|2
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|btv-&gt;risc_jmp
op_assign
(paren
r_int
r_int
op_star
)paren
id|kmalloc
c_func
(paren
l_int|2048
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;risc_jmp: %p&bslash;n&quot;
comma
id|btv-&gt;risc_jmp
)paren
)paren
suffix:semicolon
id|btv-&gt;vbi_odd
op_assign
id|btv-&gt;risc_jmp
op_plus
l_int|16
suffix:semicolon
id|btv-&gt;vbi_even
op_assign
id|btv-&gt;vbi_odd
op_plus
l_int|256
suffix:semicolon
id|btv-&gt;bus_vbi_odd
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|12
)paren
suffix:semicolon
id|btv-&gt;bus_vbi_even
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|6
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|2
)paren
comma
id|BT848_RISC_STRT_ADD
)paren
suffix:semicolon
id|btv-&gt;vbibuf
op_assign
(paren
r_int
r_char
op_star
)paren
id|vmalloc
c_func
(paren
id|VBIBUF_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;vbibuf
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|btv-&gt;grisc
op_assign
(paren
r_int
r_int
op_star
)paren
id|kmalloc
c_func
(paren
l_int|32768
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|btv-&gt;vbibuf
comma
l_int|0
comma
id|VBIBUF_SIZE
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want to return random&n;&t;                                        memory to the user */
id|btv-&gt;fbuffer
op_assign
l_int|NULL
suffix:semicolon
id|bt848_muxsel
c_func
(paren
id|btv
comma
l_int|1
)paren
suffix:semicolon
id|bt848_set_winsize
c_func
(paren
id|btv
)paren
suffix:semicolon
multiline_comment|/*&t;btwrite(0, BT848_TDEC); */
id|btwrite
c_func
(paren
l_int|0x10
comma
id|BT848_COLOR_CTL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0xfc
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
multiline_comment|/* select direct input */
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_GPIO_REG_INP
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0xff
comma
id|BT848_VBI_PACK_SIZE
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|1
comma
id|BT848_VBI_PACK_DEL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|BT848_IFORM_MUX1
op_or
id|BT848_IFORM_XTAUTO
op_or
id|BT848_IFORM_PAL_BDGHI
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0xd8
comma
id|BT848_CONTRAST_LO
)paren
suffix:semicolon
id|bt848_bright
c_func
(paren
id|btv
comma
l_int|0x10
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x20
comma
id|BT848_E_VSCALE_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x20
comma
id|BT848_O_VSCALE_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
multiline_comment|/*BT848_ADC_SYNC_T|*/
id|BT848_ADC_RESERVED
op_or
id|BT848_ADC_CRUSH
comma
id|BT848_ADC
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|BT848_CONTROL_LDEC
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|BT848_CONTROL_LDEC
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
id|btv-&gt;picture.colour
op_assign
l_int|254
op_lshift
l_int|7
suffix:semicolon
id|btv-&gt;picture.brightness
op_assign
l_int|128
op_lshift
l_int|8
suffix:semicolon
id|btv-&gt;picture.hue
op_assign
l_int|128
op_lshift
l_int|8
suffix:semicolon
id|btv-&gt;picture.contrast
op_assign
l_int|0xd8
op_lshift
l_int|7
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_E_SCLOOP
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_O_SCLOOP
)paren
suffix:semicolon
multiline_comment|/* clear interrupt status */
id|btwrite
c_func
(paren
l_int|0xfffffUL
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
multiline_comment|/* set interrupt mask */
id|btwrite
c_func
(paren
id|btv-&gt;triton1
op_or
multiline_comment|/*BT848_INT_PABORT|BT848_INT_RIPERR|BT848_INT_PPERR|&n;                  BT848_INT_FDSR|BT848_INT_FTRGT|BT848_INT_FBUS|*/
id|BT848_INT_VSYNC
op_or
id|BT848_INT_SCERR
op_or
id|BT848_INT_RISCI
op_or
id|BT848_INT_OCERR
op_or
id|BT848_INT_VPRES
op_or
id|BT848_INT_FMTCHG
op_or
id|BT848_INT_HLOCK
comma
id|BT848_INT_MASK
)paren
suffix:semicolon
id|make_vbitab
c_func
(paren
id|btv
)paren
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now add the template and register the device unit.&n;&t; */
id|memcpy
c_func
(paren
op_amp
id|btv-&gt;video_dev
comma
op_amp
id|bttv_template
comma
r_sizeof
(paren
id|bttv_template
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|btv-&gt;vbi_dev
comma
op_amp
id|vbi_template
comma
r_sizeof
(paren
id|vbi_template
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|btv-&gt;radio_dev
comma
op_amp
id|radio_template
comma
r_sizeof
(paren
id|radio_template
)paren
)paren
suffix:semicolon
id|idcard
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|btv-&gt;video_dev
comma
id|VFL_TYPE_GRABBER
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|btv-&gt;vbi_dev
comma
id|VFL_TYPE_VBI
)paren
OL
l_int|0
)paren
(brace
id|video_unregister_device
c_func
(paren
op_amp
id|btv-&gt;video_dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|radio
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|btv-&gt;radio_dev
comma
id|VFL_TYPE_RADIO
)paren
OL
l_int|0
)paren
(brace
id|video_unregister_device
c_func
(paren
op_amp
id|btv-&gt;vbi_dev
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|btv-&gt;video_dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|i2c_register_bus
c_func
(paren
op_amp
id|btv-&gt;i2c
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bttv_irq
r_static
r_void
id|bttv_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|stat
comma
id|astat
suffix:semicolon
id|u32
id|dstat
suffix:semicolon
r_int
id|count
suffix:semicolon
r_struct
id|bttv
op_star
id|btv
suffix:semicolon
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|dev_id
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* get/clear interrupt status bits */
id|stat
op_assign
id|btread
c_func
(paren
id|BT848_INT_STAT
)paren
suffix:semicolon
id|astat
op_assign
id|stat
op_amp
id|btread
c_func
(paren
id|BT848_INT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|astat
)paren
r_return
suffix:semicolon
id|btwrite
c_func
(paren
id|astat
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: astat %08x&bslash;n&quot;
comma
id|btv-&gt;nr
comma
id|astat
)paren
)paren
suffix:semicolon
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d:  stat %08x&bslash;n&quot;
comma
id|btv-&gt;nr
comma
id|stat
)paren
)paren
suffix:semicolon
multiline_comment|/* get device status bits */
id|dstat
op_assign
id|btread
c_func
(paren
id|BT848_DSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_FMTCHG
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_FMTCHG&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
multiline_comment|/*btv-&gt;win.norm&amp;=&n;&t;&t;&t;  (dstat&amp;BT848_DSTATUS_NUML) ? (~1) : (~0); */
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_VPRES
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_VPRES&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_VSYNC
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_VSYNC&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_SCERR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_SCERR&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
id|bt848_dma
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
id|bt848_dma
c_func
(paren
id|btv
comma
l_int|1
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|btv-&gt;vbiq
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|btv-&gt;capq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_RISCI
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_RISCI&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
multiline_comment|/* captured VBI frame */
r_if
c_cond
(paren
id|stat
op_amp
(paren
l_int|1
op_lshift
l_int|28
)paren
)paren
(brace
id|btv-&gt;vbip
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|btv-&gt;vbiq
)paren
suffix:semicolon
)brace
multiline_comment|/* captured full frame */
r_if
c_cond
(paren
id|stat
op_amp
(paren
l_int|2
op_lshift
l_int|28
)paren
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|btv-&gt;capq
)paren
suffix:semicolon
id|btv-&gt;last_field
op_assign
id|btv-&gt;field
suffix:semicolon
id|btv-&gt;grab
op_increment
suffix:semicolon
id|btv-&gt;frame_stat
(braket
id|btv-&gt;grf
)braket
op_assign
id|GBUFFER_DONE
suffix:semicolon
r_if
c_cond
(paren
(paren
op_decrement
id|btv-&gt;grabbing
)paren
)paren
(brace
id|btv-&gt;gro
op_assign
id|btv-&gt;gro_next
suffix:semicolon
id|btv-&gt;gre
op_assign
id|btv-&gt;gre_next
suffix:semicolon
id|btv-&gt;grf
op_assign
id|btv-&gt;grf_next
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|5
)braket
op_assign
id|btv-&gt;gro
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|11
)braket
op_assign
id|btv-&gt;gre
suffix:semicolon
id|bt848_set_geo
c_func
(paren
id|btv
comma
id|btv-&gt;gwidth
comma
id|btv-&gt;gheight
comma
id|btv-&gt;gfmt
)paren
suffix:semicolon
)brace
r_else
(brace
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
id|bt848_set_geo
c_func
(paren
id|btv
comma
id|btv-&gt;win.width
comma
id|btv-&gt;win.height
comma
id|btv-&gt;win.color_fmt
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|btv-&gt;capq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
(paren
l_int|8
op_lshift
l_int|28
)paren
)paren
(brace
id|btv-&gt;risc_jmp
(braket
l_int|5
)braket
op_assign
id|btv-&gt;gro
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|11
)braket
op_assign
id|btv-&gt;gre
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|12
)braket
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
id|bt848_set_geo
c_func
(paren
id|btv
comma
id|btv-&gt;gwidth
comma
id|btv-&gt;gheight
comma
id|btv-&gt;gfmt
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_OCERR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_OCERR&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_PABORT
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_PABORT&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_RIPERR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_RIPERR&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_PPERR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_PPERR&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_FDSR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_FDSR&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_FTRGT
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_FTRGT&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_FBUS
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv%d: IRQ_FBUS&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_HLOCK
)paren
(brace
r_if
c_cond
(paren
(paren
id|dstat
op_amp
id|BT848_DSTATUS_HLOC
)paren
op_logical_or
(paren
id|btv-&gt;radio
)paren
)paren
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_ON
)paren
suffix:semicolon
r_else
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_OFF
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_I2CDONE
)paren
(brace
)brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|10
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;bttv%d: irq loop %d&bslash;n&quot;
comma
id|btv-&gt;nr
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|20
)paren
(brace
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_INT_MASK
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv%d: IRQ lockup, cleared int mask&bslash;n&quot;
comma
id|btv-&gt;nr
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Scan for a Bt848 card, request the irq and map the io memory &n; */
DECL|function|configure_bt848
r_int
id|configure_bt848
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_int
id|bttv_num
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_char
id|bus
comma
id|devfn
comma
id|command
suffix:semicolon
r_struct
id|bttv
op_star
id|btv
suffix:semicolon
id|btv
op_assign
op_amp
id|bttvs
(braket
id|bttv_num
)braket
suffix:semicolon
id|btv-&gt;dev
op_assign
id|dev
suffix:semicolon
id|btv-&gt;nr
op_assign
id|bttv_num
suffix:semicolon
id|btv-&gt;bus
op_assign
id|bus
op_assign
id|dev-&gt;bus-&gt;number
suffix:semicolon
id|btv-&gt;devfn
op_assign
id|devfn
op_assign
id|dev-&gt;devfn
suffix:semicolon
id|btv-&gt;bt848_mem
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbibuf
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;risc_jmp
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbi_odd
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbi_even
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbiq
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;capq
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;capqo
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;capqe
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbip
op_assign
id|VBIBUF_SIZE
suffix:semicolon
id|btv-&gt;id
op_assign
id|dev-&gt;device
suffix:semicolon
id|btv-&gt;irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|btv-&gt;bt848_adr
op_assign
id|dev-&gt;base_address
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;id
op_ge
l_int|878
)paren
id|btv-&gt;i2c_command
op_assign
l_int|0x83
suffix:semicolon
r_else
id|btv-&gt;i2c_command
op_assign
(paren
id|I2C_TIMING
op_or
id|BT848_I2C_SCL
op_or
id|BT848_I2C_SDA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap
(braket
id|bttv_num
)braket
)paren
(brace
r_if
c_cond
(paren
id|remap
(braket
id|bttv_num
)braket
OL
l_int|0x1000
)paren
id|remap
(braket
id|bttv_num
)braket
op_lshift_assign
l_int|20
suffix:semicolon
id|remap
(braket
id|bttv_num
)braket
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv%d: remapping to : 0x%08x.&bslash;n&quot;
comma
id|bttv_num
comma
id|remap
(braket
id|bttv_num
)braket
)paren
suffix:semicolon
id|remap
(braket
id|bttv_num
)braket
op_or_assign
id|btv-&gt;bt848_adr
op_amp
(paren
op_complement
id|PCI_BASE_ADDRESS_MEM_MASK
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_BASE_ADDRESS_0
comma
id|remap
(braket
id|bttv_num
)braket
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|btv-&gt;bt848_adr
)paren
suffix:semicolon
id|btv-&gt;dev-&gt;base_address
(braket
l_int|0
)braket
op_assign
id|btv-&gt;bt848_adr
suffix:semicolon
)brace
id|btv-&gt;bt848_adr
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|btv-&gt;revision
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv%d: Brooktree Bt%d (rev %d) &quot;
comma
id|bttv_num
comma
id|btv-&gt;id
comma
id|btv-&gt;revision
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bus: %d, devfn: %d, &quot;
comma
id|btv-&gt;bus
comma
id|btv-&gt;devfn
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;irq: %d, &quot;
comma
id|btv-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;memory: 0x%08x.&bslash;n&quot;
comma
id|btv-&gt;bt848_adr
)paren
suffix:semicolon
id|btv-&gt;pll.pll_ifreq
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;pll.pll_ifreq
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;pll.pll_crystal
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pll
(braket
id|btv-&gt;nr
)braket
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|btv-&gt;id
op_eq
l_int|848
op_logical_and
id|btv-&gt;revision
op_eq
l_int|0x11
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv%d: internal PLL, single crystal operation enabled&bslash;n&quot;
comma
id|bttv_num
)paren
suffix:semicolon
id|btv-&gt;pll.pll_ofreq
op_assign
l_int|28636363
suffix:semicolon
id|btv-&gt;pll.pll_ifreq
op_assign
l_int|35468950
suffix:semicolon
id|btv-&gt;pll.pll_crystal
op_assign
id|BT848_IFORM_XT1
suffix:semicolon
)brace
id|btv-&gt;bt848_mem
op_assign
id|ioremap
c_func
(paren
id|btv-&gt;bt848_adr
comma
l_int|0x1000
)paren
suffix:semicolon
multiline_comment|/* clear interrupt mask */
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_INT_MASK
)paren
suffix:semicolon
id|result
op_assign
id|request_irq
c_func
(paren
id|btv-&gt;irq
comma
id|bttv_irq
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
l_string|&quot;bttv&quot;
comma
(paren
r_void
op_star
)paren
id|btv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EINVAL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv%d: Bad irq number or handler&bslash;n&quot;
comma
id|bttv_num
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EBUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv%d: IRQ %d busy, change your PnP config in BIOS&bslash;n&quot;
comma
id|bttv_num
comma
id|btv-&gt;irq
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
id|btv-&gt;triton1
op_assign
id|triton1
ques
c_cond
id|BT848_INT_ETBF
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|triton1
op_logical_and
id|btv-&gt;id
op_ge
l_int|878
)paren
(brace
id|btv-&gt;triton1
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bttv: Enabling 430FX compatibilty for bt878&bslash;n&quot;
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|BT878_DEVCTRL
comma
op_amp
id|command
)paren
suffix:semicolon
id|command
op_or_assign
id|BT878_EN_TBFX
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|BT878_DEVCTRL
comma
id|command
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|BT878_DEVCTRL
comma
op_amp
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|command
op_amp
id|BT878_EN_TBFX
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bttv: 430FX compatibility could not be enabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_bt848
r_static
r_int
id|find_bt848
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|pci_devices
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|bttv_num
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_BROOKTREE
)paren
r_if
c_cond
(paren
(paren
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_BT848
)paren
op_logical_or
(paren
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_BT849
)paren
op_logical_or
(paren
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_BT878
)paren
op_logical_or
(paren
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_BT879
)paren
)paren
id|result
op_assign
id|configure_bt848
c_func
(paren
id|dev
comma
id|bttv_num
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|dev
op_assign
id|dev-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bttv_num
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: %d Bt848 card(s) found.&bslash;n&quot;
comma
id|bttv_num
)paren
suffix:semicolon
)brace
r_return
id|bttv_num
suffix:semicolon
)brace
DECL|function|release_bttv
r_static
r_void
id|release_bttv
c_func
(paren
r_void
)paren
(brace
id|u8
id|command
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|bttv
op_star
id|btv
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bttv_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|btv
op_assign
op_amp
id|bttvs
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* turn off all capturing, DMA and IRQs */
id|btand
c_func
(paren
op_complement
l_int|15
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
multiline_comment|/* first disable interrupts before unmapping the memory! */
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_INT_MASK
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0xffffffffUL
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x0
comma
id|BT848_GPIO_OUT_EN
)paren
suffix:semicolon
multiline_comment|/* unregister i2c_bus */
id|i2c_unregister_bus
c_func
(paren
(paren
op_amp
id|btv-&gt;i2c
)paren
)paren
suffix:semicolon
multiline_comment|/* disable PCI bus-mastering */
id|pci_read_config_byte
c_func
(paren
id|btv-&gt;dev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
multiline_comment|/* Should this be &amp;=~ ?? */
id|command
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|btv-&gt;dev
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
multiline_comment|/* unmap and free memory */
r_if
c_cond
(paren
id|btv-&gt;grisc
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;grisc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;risc_odd
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;risc_odd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;risc_even
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;risc_even
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;free: risc_jmp: 0x%08x.&bslash;n&quot;
comma
id|btv-&gt;risc_jmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;risc_jmp
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;risc_jmp
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bt848_vbibuf: 0x%08x.&bslash;n&quot;
comma
id|btv-&gt;vbibuf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;vbibuf
)paren
id|vfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;vbibuf
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|btv-&gt;irq
comma
id|btv
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bt848_mem: 0x%08x.&bslash;n&quot;
comma
id|btv-&gt;bt848_mem
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;bt848_mem
)paren
id|iounmap
c_func
(paren
id|btv-&gt;bt848_mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;video_dev.minor
op_ne
op_minus
l_int|1
)paren
(brace
id|video_unregister_device
c_func
(paren
op_amp
id|btv-&gt;video_dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;vbi_dev.minor
op_ne
op_minus
l_int|1
)paren
(brace
id|video_unregister_device
c_func
(paren
op_amp
id|btv-&gt;vbi_dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|radio
op_logical_and
id|btv-&gt;radio_dev.minor
op_ne
op_minus
l_int|1
)paren
id|video_unregister_device
c_func
(paren
op_amp
id|btv-&gt;radio_dev
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
macro_line|#else
r_int
id|init_bttv_cards
c_func
(paren
r_struct
id|video_init
op_star
id|unused
)paren
(brace
macro_line|#endif
r_int
id|i
suffix:semicolon
id|handle_chipset
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|find_bt848
c_func
(paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* initialize Bt848s */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bttv_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|init_bt848
c_func
(paren
id|i
)paren
OL
l_int|0
)paren
(brace
id|release_bttv
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|release_bttv
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Local variables:&n; * c-indent-level: 8&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -8&n; * c-argdecl-indent: 8&n; * c-label-offset: -8&n; * c-continued-statement-offset: 8&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
