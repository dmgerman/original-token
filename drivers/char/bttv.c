multiline_comment|/* &n;    bttv - Bt848 frame grabber driver&n;&n;    Copyright (C) 1996,97 Ralph Metzler (rjkm@thp.uni-koeln.de)&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;    &n;    Modified to put the RISC code writer in the kernel and to fit a&n;    common (and I hope safe) kernel interface. When we have an X extension&n;    all will now be really sweet.&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/bios32.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;bttv.h&quot;
macro_line|#include &quot;tuner.h&quot;
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x)&t;&t;/* Debug driver */&t;
DECL|macro|IDEBUG
mdefine_line|#define IDEBUG(x)&t;&t;/* Debug interrupt handler */
DECL|variable|remap
r_static
r_int
r_int
id|remap
op_assign
l_int|0
suffix:semicolon
DECL|variable|vidmem
r_static
r_int
r_int
id|vidmem
op_assign
l_int|0
suffix:semicolon
DECL|variable|tuner
r_static
r_int
r_int
id|tuner
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Default tuner */
id|MODULE_PARM
c_func
(paren
id|tuner
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
r_static
r_int
id|find_vga
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|bt848_set_risc_jmps
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
suffix:semicolon
multiline_comment|/* Anybody who uses more than four? */
DECL|macro|BTTV_MAX
mdefine_line|#define BTTV_MAX 4
DECL|variable|bttv_num
r_static
r_int
id|bttv_num
suffix:semicolon
DECL|variable|bttvs
r_static
r_struct
id|bttv
id|bttvs
(braket
id|BTTV_MAX
)braket
suffix:semicolon
DECL|macro|I2C_TIMING
mdefine_line|#define I2C_TIMING (0x7&lt;&lt;4)
DECL|macro|I2C_COMMAND
mdefine_line|#define I2C_COMMAND (I2C_TIMING | BT848_I2C_SCL | BT848_I2C_SDA)
DECL|macro|AUDIO_MUTE_DELAY
mdefine_line|#define AUDIO_MUTE_DELAY 10000
DECL|macro|FREQ_CHANGE_DELAY
mdefine_line|#define FREQ_CHANGE_DELAY 20000
DECL|macro|EEPROM_WRITE_DELAY
mdefine_line|#define EEPROM_WRITE_DELAY 20000
multiline_comment|/*******************************/
multiline_comment|/* Memory management functions */
multiline_comment|/*******************************/
multiline_comment|/* convert virtual user memory address to physical address */
multiline_comment|/* (virt_to_phys only works for kmalloced kernel memory) */
DECL|function|uvirt_to_phys
r_static
r_inline
id|ulong
id|uvirt_to_phys
c_func
(paren
id|ulong
id|adr
)paren
(brace
id|pgd_t
op_star
id|pgd
suffix:semicolon
id|pmd_t
op_star
id|pmd
suffix:semicolon
id|pte_t
op_star
id|ptep
comma
id|pte
suffix:semicolon
multiline_comment|/*  printk(&quot;adr: 0x%08x&bslash;n&quot;,adr);*/
id|pgd
op_assign
id|pgd_offset
c_func
(paren
id|current-&gt;mm
comma
id|adr
)paren
suffix:semicolon
multiline_comment|/*  printk(&quot;pgd: 0x%08x&bslash;n&quot;,pgd);*/
r_if
c_cond
(paren
id|pgd_none
c_func
(paren
op_star
id|pgd
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|pmd
op_assign
id|pmd_offset
c_func
(paren
id|pgd
comma
id|adr
)paren
suffix:semicolon
multiline_comment|/*  printk(&quot;pmd: 0x%08x&bslash;n&quot;,pmd); */
r_if
c_cond
(paren
id|pmd_none
c_func
(paren
op_star
id|pmd
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ptep
op_assign
id|pte_offset
c_func
(paren
id|pmd
comma
id|adr
op_amp
(paren
op_complement
id|PGDIR_MASK
)paren
)paren
suffix:semicolon
id|pte
op_assign
op_star
id|ptep
suffix:semicolon
r_if
c_cond
(paren
id|pte_present
c_func
(paren
id|pte
)paren
)paren
(brace
r_return
(paren
id|pte_page
c_func
(paren
id|pte
)paren
op_or
(paren
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* convert virtual kernel memory address to physical address */
multiline_comment|/* (virt_to_phys only works for kmalloced kernel memory) */
DECL|function|kvirt_to_phys
r_static
r_inline
id|ulong
id|kvirt_to_phys
c_func
(paren
id|ulong
id|adr
)paren
(brace
r_return
id|uvirt_to_phys
c_func
(paren
id|VMALLOC_VMADDR
c_func
(paren
id|adr
)paren
)paren
suffix:semicolon
)brace
DECL|function|kvirt_to_bus
r_static
r_inline
id|ulong
id|kvirt_to_bus
c_func
(paren
id|ulong
id|adr
)paren
(brace
r_return
id|virt_to_bus
c_func
(paren
id|phys_to_virt
c_func
(paren
id|kvirt_to_phys
c_func
(paren
id|adr
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*****************/
multiline_comment|/* I2C functions */
multiline_comment|/*****************/
DECL|function|I2CRead
r_static
r_int
id|I2CRead
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
id|addr
)paren
(brace
id|u32
id|i
suffix:semicolon
id|u32
id|stat
suffix:semicolon
multiline_comment|/* clear status bit ; BT848_INT_RACK is ro */
id|btwrite
c_func
(paren
id|BT848_INT_I2CDONE
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
id|btwrite
c_func
(paren
(paren
(paren
id|addr
op_amp
l_int|0xff
)paren
op_lshift
l_int|24
)paren
op_or
id|I2C_COMMAND
comma
id|BT848_I2C
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0x7fffffff
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|stat
op_assign
id|btread
c_func
(paren
id|BT848_INT_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|BT848_INT_I2CDONE
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|BT848_INT_RACK
)paren
)paren
r_return
op_minus
l_int|2
suffix:semicolon
id|i
op_assign
(paren
id|btread
c_func
(paren
id|BT848_I2C
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* set both to write both bytes, reset it to write only b1 */
DECL|function|I2CWrite
r_static
r_int
id|I2CWrite
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|unchar
id|addr
comma
id|unchar
id|b1
comma
id|unchar
id|b2
comma
r_int
id|both
)paren
(brace
id|u32
id|i
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|u32
id|stat
suffix:semicolon
multiline_comment|/* clear status bit; BT848_INT_RACK is ro */
id|btwrite
c_func
(paren
id|BT848_INT_I2CDONE
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
id|data
op_assign
(paren
(paren
id|addr
op_amp
l_int|0xff
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
id|b1
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
op_or
id|I2C_COMMAND
suffix:semicolon
r_if
c_cond
(paren
id|both
)paren
(brace
id|data
op_or_assign
(paren
(paren
id|b2
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|data
op_or_assign
id|BT848_I2C_W3B
suffix:semicolon
)brace
id|btwrite
c_func
(paren
id|data
comma
id|BT848_I2C
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0x7fffffff
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|stat
op_assign
id|btread
c_func
(paren
id|BT848_INT_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|BT848_INT_I2CDONE
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|BT848_INT_RACK
)paren
)paren
r_return
op_minus
l_int|2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|readee
r_static
r_void
id|readee
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|unchar
op_star
id|eedata
)paren
(brace
r_int
id|i
comma
id|k
suffix:semicolon
r_if
c_cond
(paren
id|I2CWrite
c_func
(paren
id|btv
comma
l_int|0xa0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: readee error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|k
op_assign
id|I2CRead
c_func
(paren
id|btv
comma
l_int|0xa1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: readee error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|eedata
(braket
id|i
)braket
op_assign
id|k
suffix:semicolon
)brace
)brace
DECL|function|writeee
r_static
r_void
id|writeee
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|unchar
op_star
id|eedata
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|I2CWrite
c_func
(paren
id|btv
comma
l_int|0xa0
comma
id|i
comma
id|eedata
(braket
id|i
)braket
comma
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: writeee error (%d)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
id|EEPROM_WRITE_DELAY
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Tuner, internal, external and mute &n; */
DECL|variable|audiomuxs
r_static
id|unchar
id|audiomuxs
(braket
)braket
(braket
l_int|4
)braket
op_assign
(brace
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
multiline_comment|/* unknown */
(brace
l_int|0x02
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x0a
)brace
comma
multiline_comment|/* MIRO */
(brace
l_int|0x00
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x04
)brace
comma
multiline_comment|/* Hauppauge */
(brace
l_int|0x04
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x01
)brace
comma
multiline_comment|/* STB */
(brace
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x04
)brace
comma
multiline_comment|/* Intel??? */
(brace
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x04
)brace
comma
multiline_comment|/* Diamond DTV2000??? */
)brace
suffix:semicolon
DECL|function|audio
r_static
r_void
id|audio
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
id|mode
)paren
(brace
id|btwrite
c_func
(paren
l_int|0x0f
comma
id|BT848_GPIO_OUT_EN
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_GPIO_REG_INP
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|AUDIO_UNMUTE
suffix:colon
id|btv-&gt;audio
op_and_assign
op_complement
id|AUDIO_MUTE
suffix:semicolon
id|mode
op_assign
id|btv-&gt;audio
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_OFF
suffix:colon
id|mode
op_assign
id|AUDIO_OFF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AUDIO_ON
suffix:colon
id|mode
op_assign
id|btv-&gt;audio
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|btv-&gt;audio
op_and_assign
id|AUDIO_MUTE
suffix:semicolon
id|btv-&gt;audio
op_or_assign
id|mode
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|btv-&gt;audio
op_amp
id|AUDIO_MUTE
)paren
op_logical_or
op_logical_neg
(paren
id|btread
c_func
(paren
id|BT848_DSTATUS
)paren
op_amp
id|BT848_DSTATUS_HLOC
)paren
)paren
id|mode
op_assign
id|AUDIO_OFF
suffix:semicolon
id|btaor
c_func
(paren
id|audiomuxs
(braket
id|btv-&gt;type
)braket
(braket
id|mode
)braket
comma
op_complement
l_int|0x0f
comma
id|BT848_GPIO_DATA
)paren
suffix:semicolon
)brace
DECL|function|bt848_dma
r_extern
r_inline
r_void
id|bt848_dma
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
id|btor
c_func
(paren
l_int|3
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
r_else
id|btand
c_func
(paren
op_complement
l_int|3
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
)brace
DECL|function|bt848_cap
r_static
r_void
id|bt848_cap
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
(brace
id|btv-&gt;cap
op_or_assign
l_int|3
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
)brace
r_else
(brace
id|btv-&gt;cap
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
)brace
)brace
DECL|function|bt848_muxsel
r_static
r_void
id|bt848_muxsel
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|input
)paren
(brace
id|input
op_and_assign
l_int|3
suffix:semicolon
multiline_comment|/* This seems to get rid of some synchronization problems */
id|btand
c_func
(paren
op_complement
(paren
l_int|3
op_lshift
l_int|5
)paren
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input
op_eq
l_int|3
)paren
(brace
id|btor
c_func
(paren
id|BT848_CONTROL_COMP
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btor
c_func
(paren
id|BT848_CONTROL_COMP
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
r_else
(brace
id|btand
c_func
(paren
op_complement
id|BT848_CONTROL_COMP
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|BT848_CONTROL_COMP
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|input
op_eq
l_int|2
)paren
id|input
op_assign
l_int|3
suffix:semicolon
id|btaor
c_func
(paren
(paren
(paren
id|input
op_plus
l_int|2
)paren
op_amp
l_int|3
)paren
op_lshift
l_int|5
comma
op_complement
(paren
l_int|3
op_lshift
l_int|5
)paren
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|input
ques
c_cond
id|AUDIO_EXTERN
suffix:colon
id|AUDIO_TUNER
)paren
suffix:semicolon
)brace
DECL|macro|VBIBUF_SIZE
mdefine_line|#define VBIBUF_SIZE 65536
DECL|function|make_vbitab
r_static
r_void
id|make_vbitab
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
r_int
id|i
suffix:semicolon
id|dword
op_star
id|po
op_assign
(paren
id|dword
op_star
)paren
id|btv-&gt;vbi_odd
suffix:semicolon
id|dword
op_star
id|pe
op_assign
(paren
id|dword
op_star
)paren
id|btv-&gt;vbi_even
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vbiodd: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|btv-&gt;vbi_odd
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vbievn: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|btv-&gt;vbi_even
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;po: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|po
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;pe: 0x%08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|pe
)paren
)paren
suffix:semicolon
op_star
(paren
id|po
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|po
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|po
op_increment
)paren
op_assign
id|BT848_RISC_WRITE
op_or
l_int|2044
op_or
id|BT848_RISC_EOL
op_or
id|BT848_RISC_SOL
op_or
(paren
l_int|13
op_lshift
l_int|20
)paren
suffix:semicolon
op_star
(paren
id|po
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
(paren
id|ulong
)paren
id|btv-&gt;vbibuf
op_plus
id|i
op_star
l_int|2048
)paren
suffix:semicolon
)brace
op_star
(paren
id|po
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
op_star
(paren
id|po
op_increment
)paren
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|4
)paren
suffix:semicolon
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
op_star
(paren
id|pe
op_increment
)paren
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|16
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|BT848_RISC_WRITE
op_or
l_int|2044
op_or
id|BT848_RISC_EOL
op_or
id|BT848_RISC_SOL
suffix:semicolon
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|kvirt_to_bus
c_func
(paren
(paren
id|ulong
)paren
id|btv-&gt;vbibuf
op_plus
id|i
op_star
l_int|2048
)paren
suffix:semicolon
)brace
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|BT848_RISC_JUMP
op_or
id|BT848_RISC_IRQ
op_or
(paren
l_int|0x01
op_lshift
l_int|16
)paren
suffix:semicolon
op_star
(paren
id|pe
op_increment
)paren
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set the registers for the size we have specified. Don&squot;t bother&n; *&t;trying to understand this without the BT848 manual in front of&n; *&t;you [AC]. &n; *&n; *&t;PS: The manual is free for download in .pdf format from &n; *&t;www.brooktree.com - nicely done those folks.&n; */
DECL|function|bt848_set_size
r_static
r_void
id|bt848_set_size
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
id|u16
id|vscale
comma
id|hscale
suffix:semicolon
id|u32
id|xsf
comma
id|sr
suffix:semicolon
id|u16
id|hdelay
comma
id|vdelay
suffix:semicolon
id|u16
id|hactive
comma
id|vactive
suffix:semicolon
id|u16
id|inter
suffix:semicolon
id|u8
id|crop
suffix:semicolon
multiline_comment|/*&n;&t; *&t;No window , no try...&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;win.width
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;win.height
)paren
r_return
suffix:semicolon
id|inter
op_assign
(paren
id|btv-&gt;win.interlace
op_amp
l_int|1
)paren
op_xor
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|btv-&gt;win.bpp
)paren
(brace
multiline_comment|/*&n;&t;&t; * RGB8 seems to be a 9x5x5 GRB color cube starting at color 16&n;&t;&t; * Why the h... can&squot;t they even mention this in the datasheet???&n;&t;&t; */
r_case
l_int|1
suffix:colon
id|btwrite
c_func
(paren
id|BT848_COLOR_FMT_RGB8
comma
id|BT848_COLOR_FMT
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
l_int|0x10
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
multiline_comment|/* Dithering looks much better in this mode */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|btwrite
c_func
(paren
id|BT848_COLOR_FMT_RGB16
comma
id|BT848_COLOR_FMT
)paren
suffix:semicolon
id|btor
c_func
(paren
l_int|0x10
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|btwrite
c_func
(paren
id|BT848_COLOR_FMT_RGB24
comma
id|BT848_COLOR_FMT
)paren
suffix:semicolon
id|btor
c_func
(paren
l_int|0x10
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|btwrite
c_func
(paren
id|BT848_COLOR_FMT_RGB32
comma
id|BT848_COLOR_FMT
)paren
suffix:semicolon
id|btor
c_func
(paren
l_int|0x10
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Set things up according to the final picture width.&n;&t; */
id|hactive
op_assign
id|btv-&gt;win.width
suffix:semicolon
r_if
c_cond
(paren
id|hactive
OL
l_int|193
)paren
(brace
id|btwrite
(paren
l_int|2
comma
id|BT848_E_VTC
)paren
suffix:semicolon
id|btwrite
(paren
l_int|2
comma
id|BT848_O_VTC
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hactive
OL
l_int|385
)paren
(brace
id|btwrite
(paren
l_int|1
comma
id|BT848_E_VTC
)paren
suffix:semicolon
id|btwrite
(paren
l_int|1
comma
id|BT848_O_VTC
)paren
suffix:semicolon
)brace
r_else
(brace
id|btwrite
(paren
l_int|0
comma
id|BT848_E_VTC
)paren
suffix:semicolon
id|btwrite
(paren
l_int|0
comma
id|BT848_O_VTC
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Ok are we doing Never The Same Color or PAL ?&n;&t; */
r_if
c_cond
(paren
id|btv-&gt;win.norm
op_eq
l_int|1
)paren
(brace
id|btv-&gt;win.cropwidth
op_assign
l_int|640
suffix:semicolon
id|btv-&gt;win.cropheight
op_assign
l_int|480
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x68
comma
id|BT848_ADELAY
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x5d
comma
id|BT848_BDELAY
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|BT848_IFORM_NTSC
comma
op_complement
l_int|7
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|BT848_IFORM_XT0
comma
op_complement
l_int|0x18
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|xsf
op_assign
(paren
id|btv-&gt;win.width
op_star
l_int|365625UL
)paren
op_div
l_int|300000UL
suffix:semicolon
id|hscale
op_assign
(paren
(paren
l_int|910UL
op_star
l_int|4096UL
)paren
op_div
id|xsf
op_minus
l_int|4096
)paren
suffix:semicolon
id|vdelay
op_assign
id|btv-&gt;win.cropy
op_plus
l_int|0x16
suffix:semicolon
id|hdelay
op_assign
(paren
(paren
id|hactive
op_star
l_int|135
)paren
op_div
l_int|754
op_plus
id|btv-&gt;win.cropx
)paren
op_amp
l_int|0x3fe
suffix:semicolon
)brace
r_else
(brace
id|btv-&gt;win.cropwidth
op_assign
l_int|768
suffix:semicolon
id|btv-&gt;win.cropheight
op_assign
l_int|576
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;win.norm
op_eq
l_int|0
)paren
(brace
id|btwrite
c_func
(paren
l_int|0x7f
comma
id|BT848_ADELAY
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x72
comma
id|BT848_BDELAY
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|BT848_IFORM_PAL_BDGHI
comma
op_complement
id|BT848_IFORM_NORM
comma
id|BT848_IFORM
)paren
suffix:semicolon
)brace
r_else
(brace
id|btwrite
c_func
(paren
l_int|0x7f
comma
id|BT848_ADELAY
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_BDELAY
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|BT848_IFORM_SECAM
comma
op_complement
id|BT848_IFORM_NORM
comma
id|BT848_IFORM
)paren
suffix:semicolon
)brace
id|btaor
c_func
(paren
id|BT848_IFORM_XT1
comma
op_complement
l_int|0x18
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|xsf
op_assign
(paren
id|btv-&gt;win.width
op_star
l_int|36875UL
)paren
op_div
l_int|30000UL
suffix:semicolon
id|hscale
op_assign
(paren
(paren
l_int|1135UL
op_star
l_int|4096UL
)paren
op_div
id|xsf
op_minus
l_int|4096
)paren
suffix:semicolon
id|vdelay
op_assign
id|btv-&gt;win.cropy
op_plus
l_int|0x20
suffix:semicolon
id|hdelay
op_assign
(paren
(paren
id|hactive
op_star
l_int|186
)paren
op_div
l_int|922
op_plus
id|btv-&gt;win.cropx
)paren
op_amp
l_int|0x3fe
suffix:semicolon
)brace
id|sr
op_assign
(paren
(paren
id|btv-&gt;win.cropheight
op_rshift
id|inter
)paren
op_star
l_int|512
)paren
op_div
id|btv-&gt;win.height
op_minus
l_int|512
suffix:semicolon
id|vscale
op_assign
(paren
l_int|0x10000UL
op_minus
id|sr
)paren
op_amp
l_int|0x1fff
suffix:semicolon
id|vactive
op_assign
id|btv-&gt;win.cropheight
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;bttv: hscale=0x%04x, &quot;
comma
id|hscale
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bttv: vscale=0x%04x&bslash;n&quot;
comma
id|vscale
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bttv: hdelay =0x%04x&bslash;n&quot;
comma
id|hdelay
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bttv: hactive=0x%04x&bslash;n&quot;
comma
id|hactive
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bttv: vdelay =0x%04x&bslash;n&quot;
comma
id|vdelay
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bttv: vactive=0x%04x&bslash;n&quot;
comma
id|vactive
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; *&t;Interlace is set elsewhere according to the final image &n;&t; *&t;size we desire&n;&t; */
r_if
c_cond
(paren
id|btv-&gt;win.interlace
)paren
(brace
id|btor
c_func
(paren
id|BT848_VSCALE_INT
comma
id|BT848_E_VSCALE_HI
)paren
suffix:semicolon
id|btor
c_func
(paren
id|BT848_VSCALE_INT
comma
id|BT848_O_VSCALE_HI
)paren
suffix:semicolon
)brace
r_else
(brace
id|btand
c_func
(paren
op_complement
id|BT848_VSCALE_INT
comma
id|BT848_E_VSCALE_HI
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|BT848_VSCALE_INT
comma
id|BT848_O_VSCALE_HI
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Load her up&n;&t; */
id|btwrite
c_func
(paren
id|hscale
op_rshift
l_int|8
comma
id|BT848_E_HSCALE_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hscale
op_rshift
l_int|8
comma
id|BT848_O_HSCALE_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hscale
op_amp
l_int|0xff
comma
id|BT848_E_HSCALE_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hscale
op_amp
l_int|0xff
comma
id|BT848_O_HSCALE_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
(paren
id|vscale
op_rshift
l_int|8
)paren
op_or
(paren
id|btread
c_func
(paren
id|BT848_E_VSCALE_HI
)paren
op_amp
l_int|0xe0
)paren
comma
id|BT848_E_VSCALE_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
(paren
id|vscale
op_rshift
l_int|8
)paren
op_or
(paren
id|btread
c_func
(paren
id|BT848_O_VSCALE_HI
)paren
op_amp
l_int|0xe0
)paren
comma
id|BT848_O_VSCALE_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|vscale
op_amp
l_int|0xff
comma
id|BT848_E_VSCALE_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|vscale
op_amp
l_int|0xff
comma
id|BT848_O_VSCALE_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hactive
op_amp
l_int|0xff
comma
id|BT848_E_HACTIVE_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hactive
op_amp
l_int|0xff
comma
id|BT848_O_HACTIVE_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hdelay
op_amp
l_int|0xff
comma
id|BT848_E_HDELAY_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|hdelay
op_amp
l_int|0xff
comma
id|BT848_O_HDELAY_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|vactive
op_amp
l_int|0xff
comma
id|BT848_E_VACTIVE_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|vactive
op_amp
l_int|0xff
comma
id|BT848_O_VACTIVE_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|vdelay
op_amp
l_int|0xff
comma
id|BT848_E_VDELAY_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|vdelay
op_amp
l_int|0xff
comma
id|BT848_O_VDELAY_LO
)paren
suffix:semicolon
id|crop
op_assign
(paren
(paren
id|hactive
op_rshift
l_int|8
)paren
op_amp
l_int|0x03
)paren
op_or
(paren
(paren
id|hdelay
op_rshift
l_int|6
)paren
op_amp
l_int|0x0c
)paren
op_or
(paren
(paren
id|vactive
op_rshift
l_int|4
)paren
op_amp
l_int|0x30
)paren
op_or
(paren
(paren
id|vdelay
op_rshift
l_int|2
)paren
op_amp
l_int|0xc0
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|crop
comma
id|BT848_E_CROP
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|crop
comma
id|BT848_O_CROP
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;The floats in the tuner struct are computed at compile time&n; *&t;by gcc and cast back to integers. Thus we don&squot;t violate the&n; *&t;&quot;no float in kernel&quot; rule.&n; */
DECL|variable|tuners
r_static
r_struct
id|tunertype
id|tuners
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Temic PAL&quot;
comma
id|TEMIC
comma
id|PAL
comma
l_int|16
op_star
l_float|140.25
comma
l_int|16
op_star
l_float|463.25
comma
l_int|0x02
comma
l_int|0x04
comma
l_int|0x01
comma
l_int|0x8e
comma
l_int|0xc2
)brace
comma
(brace
l_string|&quot;Philips PAL_I&quot;
comma
id|Philips
comma
id|PAL_I
comma
l_int|16
op_star
l_float|140.25
comma
l_int|16
op_star
l_float|463.25
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;Philips NTSC&quot;
comma
id|Philips
comma
id|NTSC
comma
l_int|16
op_star
l_float|157.25
comma
l_int|16
op_star
l_float|451.25
comma
l_int|0xA0
comma
l_int|0x90
comma
l_int|0x30
comma
l_int|0x8e
comma
l_int|0xc0
)brace
comma
(brace
l_string|&quot;Philips SECAM&quot;
comma
id|Philips
comma
id|SECAM
comma
l_int|16
op_star
l_float|168.25
comma
l_int|16
op_star
l_float|447.25
comma
l_int|0xA3
comma
l_int|0x93
comma
l_int|0x33
comma
l_int|0x8e
comma
l_int|0xc0
)brace
comma
(brace
l_string|&quot;NoTuner&quot;
comma
id|NoTuner
comma
id|NOTUNER
comma
l_int|0
comma
l_int|0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
comma
(brace
l_string|&quot;Philips PAL&quot;
comma
id|Philips
comma
id|PAL
comma
l_int|16
op_star
l_float|168.25
comma
l_int|16
op_star
l_float|447.25
comma
l_int|0xA0
comma
l_int|0x90
comma
l_int|0x30
comma
l_int|0x8e
comma
l_int|0xc0
)brace
comma
(brace
l_string|&quot;Temic NTSC&quot;
comma
id|TEMIC
comma
id|NTSC
comma
l_int|16
op_star
l_float|157.25
comma
l_int|16
op_star
l_float|463.25
comma
l_int|0x02
comma
l_int|0x04
comma
l_int|0x01
comma
l_int|0x8e
comma
l_int|0xc2
)brace
comma
(brace
l_string|&quot;TEMIC PAL_I&quot;
comma
id|TEMIC
comma
id|PAL_I
comma
l_int|0
comma
l_int|0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xc2
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Set TSA5522 synthesizer frequency in 1/16 Mhz steps&n; */
DECL|function|set_freq
r_static
r_void
id|set_freq
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|ushort
id|freq
)paren
(brace
id|u8
id|config
suffix:semicolon
id|u16
id|div
suffix:semicolon
r_struct
id|tunertype
op_star
id|tun
op_assign
op_amp
id|tuners
(braket
id|btv-&gt;tuner
)braket
suffix:semicolon
r_int
id|oldAudio
op_assign
id|btv-&gt;audio
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_MUTE
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|AUDIO_MUTE_DELAY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freq
OL
id|tun-&gt;thresh1
)paren
id|config
op_assign
id|tun-&gt;VHF_L
suffix:semicolon
r_else
r_if
c_cond
(paren
id|freq
OL
id|tun-&gt;thresh2
)paren
id|config
op_assign
id|tun-&gt;VHF_H
suffix:semicolon
r_else
id|config
op_assign
id|tun-&gt;UHF
suffix:semicolon
id|div
op_assign
id|freq
op_plus
l_int|623
suffix:semicolon
multiline_comment|/* div=((freq+16*38.9));*/
id|div
op_and_assign
l_int|0x7fff
suffix:semicolon
r_if
c_cond
(paren
id|I2CWrite
c_func
(paren
id|btv
comma
id|btv-&gt;tuneradr
comma
(paren
id|div
op_rshift
l_int|8
)paren
op_amp
l_int|0x7f
comma
id|div
op_amp
l_int|0xff
comma
l_int|1
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|I2CWrite
c_func
(paren
id|btv
comma
id|btv-&gt;tuneradr
comma
id|tun-&gt;config
comma
id|config
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|oldAudio
op_amp
id|AUDIO_MUTE
)paren
)paren
(brace
id|udelay
c_func
(paren
id|FREQ_CHANGE_DELAY
)paren
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_UNMUTE
)paren
suffix:semicolon
)brace
)brace
DECL|function|bttv_write
r_static
r_int
id|bttv_write
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|bttv_read
r_static
r_int
id|bttv_read
c_func
(paren
r_struct
id|video_device
op_star
id|v
comma
r_char
op_star
id|buf
comma
r_int
r_int
id|count
comma
r_int
id|nonblock
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|v
suffix:semicolon
r_int
id|q
comma
id|todo
suffix:semicolon
id|todo
op_assign
id|count
suffix:semicolon
r_while
c_loop
(paren
id|todo
op_logical_and
id|todo
OG
(paren
id|q
op_assign
id|VBIBUF_SIZE
op_minus
id|btv-&gt;vbip
)paren
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
(paren
r_void
op_star
)paren
id|btv-&gt;vbibuf
op_plus
id|btv-&gt;vbip
comma
id|q
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|todo
op_sub_assign
id|q
suffix:semicolon
id|buf
op_add_assign
id|q
suffix:semicolon
multiline_comment|/*&t;&t;btv-&gt;vbip=0; */
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|todo
op_logical_and
id|q
op_eq
id|VBIBUF_SIZE
op_minus
id|btv-&gt;vbip
)paren
(brace
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
id|todo
)paren
(brace
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
r_return
id|count
op_minus
id|todo
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|btv-&gt;vbiq
)paren
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
id|todo
op_eq
id|count
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_else
r_return
id|count
op_minus
id|todo
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|todo
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|buf
comma
(paren
r_void
op_star
)paren
id|btv-&gt;vbibuf
op_plus
id|btv-&gt;vbip
comma
id|todo
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|btv-&gt;vbip
op_add_assign
id|todo
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Open a bttv card. Right now the flags stuff is just playing&n; */
DECL|function|bttv_open
r_static
r_int
id|bttv_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|dev
suffix:semicolon
r_int
id|users
comma
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|flags
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|btv-&gt;user
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|btv-&gt;user
op_increment
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_UNMUTE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|users
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bttv_num
suffix:semicolon
id|i
op_increment
)paren
id|users
op_add_assign
id|bttvs
(braket
id|i
)braket
dot
id|user
suffix:semicolon
r_if
c_cond
(paren
id|users
op_eq
l_int|1
)paren
id|find_vga
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|btv-&gt;vbip
op_assign
id|VBIBUF_SIZE
suffix:semicolon
id|btv-&gt;cap
op_or_assign
l_int|0x0c
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bttv_close
r_static
r_void
id|bttv_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|dev
suffix:semicolon
id|btv-&gt;user
op_decrement
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_MUTE
)paren
suffix:semicolon
id|btv-&gt;cap
op_and_assign
op_complement
l_int|3
suffix:semicolon
macro_line|#if 0 /* FIXME */&t;
r_if
c_cond
(paren
id|minor
op_amp
l_int|0x20
)paren
(brace
id|btv-&gt;cap
op_and_assign
op_complement
l_int|0x0c
suffix:semicolon
)brace
macro_line|#endif&t;
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/***********************************/
multiline_comment|/* ioctls and supporting functions */
multiline_comment|/***********************************/
DECL|function|bt848_bright
r_extern
r_inline
r_void
id|bt848_bright
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|bright
)paren
(brace
id|btwrite
c_func
(paren
id|bright
op_amp
l_int|0xff
comma
id|BT848_BRIGHT
)paren
suffix:semicolon
)brace
DECL|function|bt848_hue
r_extern
r_inline
r_void
id|bt848_hue
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|hue
)paren
(brace
id|btwrite
c_func
(paren
id|hue
op_amp
l_int|0xff
comma
id|BT848_HUE
)paren
suffix:semicolon
)brace
DECL|function|bt848_contrast
r_extern
r_inline
r_void
id|bt848_contrast
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|uint
id|cont
)paren
(brace
r_int
r_int
id|conthi
suffix:semicolon
id|conthi
op_assign
(paren
id|cont
op_rshift
l_int|6
)paren
op_amp
l_int|4
suffix:semicolon
id|btwrite
c_func
(paren
id|cont
op_amp
l_int|0xff
comma
id|BT848_CONTRAST_LO
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|conthi
comma
op_complement
l_int|4
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|conthi
comma
op_complement
l_int|4
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|bt848_sat_u
r_extern
r_inline
r_void
id|bt848_sat_u
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|ulong
id|data
)paren
(brace
id|u32
id|datahi
suffix:semicolon
id|datahi
op_assign
(paren
id|data
op_rshift
l_int|7
)paren
op_amp
l_int|2
suffix:semicolon
id|btwrite
c_func
(paren
id|data
op_amp
l_int|0xff
comma
id|BT848_SAT_U_LO
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|datahi
comma
op_complement
l_int|2
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|datahi
comma
op_complement
l_int|2
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
DECL|function|bt848_sat_v
r_static
r_inline
r_void
id|bt848_sat_v
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
id|ulong
id|data
)paren
(brace
id|u32
id|datahi
suffix:semicolon
id|datahi
op_assign
(paren
id|data
op_rshift
l_int|8
)paren
op_amp
l_int|1
suffix:semicolon
id|btwrite
c_func
(paren
id|data
op_amp
l_int|0xff
comma
id|BT848_SAT_V_LO
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|datahi
comma
op_complement
l_int|1
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|datahi
comma
op_complement
l_int|1
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Cliprect -&gt; risc table.&n; *&n; *&t;FIXME: This is generating wrong code when we have some kinds of&n; *&t;rectangle lists. If you generate overlapped rectangles then it&n; *&t;gets a bit confused. Since we add the frame buffer clip rectangles&n; *&t;we need to fix this. Better yet to rewrite this function.&n; */
DECL|function|write_risc_data
r_static
r_void
id|write_risc_data
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|video_clip
op_star
id|vp
comma
r_int
id|count
)paren
(brace
r_int
id|i
suffix:semicolon
id|u32
id|yy
comma
id|y
comma
id|x
comma
id|dx
comma
id|ox
suffix:semicolon
id|u32
op_star
id|rmem
comma
op_star
id|rmem2
suffix:semicolon
r_struct
id|video_clip
id|first
comma
op_star
id|cur
comma
op_star
id|cur2
comma
op_star
id|nx
comma
id|first2
comma
op_star
id|prev
comma
op_star
id|nx2
suffix:semicolon
id|u32
op_star
id|rp
comma
id|rpo
op_assign
l_int|0
comma
id|rpe
op_assign
l_int|0
comma
id|p
comma
id|bpsl
suffix:semicolon
id|u32
op_star
id|rpp
suffix:semicolon
id|u32
id|mask
suffix:semicolon
r_int
id|interlace
suffix:semicolon
r_int
id|depth
suffix:semicolon
id|rmem
op_assign
(paren
id|u32
op_star
)paren
id|btv-&gt;risc_odd
suffix:semicolon
id|rmem2
op_assign
(paren
id|u32
op_star
)paren
id|btv-&gt;risc_even
suffix:semicolon
id|depth
op_assign
id|btv-&gt;win.bpp
suffix:semicolon
multiline_comment|/* create y-sorted list  */
id|first.next
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cur
op_assign
op_amp
id|first
suffix:semicolon
r_while
c_loop
(paren
(paren
id|nx
op_assign
id|cur-&gt;next
)paren
op_logical_and
(paren
id|vp
(braket
id|i
)braket
dot
id|y
OG
id|cur-&gt;next-&gt;y
)paren
)paren
id|cur
op_assign
id|nx
suffix:semicolon
id|cur-&gt;next
op_assign
op_amp
(paren
id|vp
(braket
id|i
)braket
)paren
suffix:semicolon
id|vp
(braket
id|i
)braket
dot
id|next
op_assign
id|nx
suffix:semicolon
)brace
id|first2.next
op_assign
l_int|NULL
suffix:semicolon
id|rmem
(braket
id|rpo
op_increment
)braket
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
id|rmem
(braket
id|rpo
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
id|rmem2
(braket
id|rpe
op_increment
)braket
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
suffix:semicolon
id|rmem2
(braket
id|rpe
op_increment
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;32bit depth frame buffers need extra flags setting&n;&t; */
r_if
c_cond
(paren
id|depth
op_eq
l_int|4
)paren
id|mask
op_assign
id|BT848_RISC_BYTE3
suffix:semicolon
r_else
id|mask
op_assign
l_int|0
suffix:semicolon
id|bpsl
op_assign
id|btv-&gt;win.width
op_star
id|btv-&gt;win.bpp
suffix:semicolon
id|p
op_assign
id|btv-&gt;win.vidadr
op_plus
id|btv-&gt;win.x
op_star
id|btv-&gt;win.bpp
op_plus
id|btv-&gt;win.y
op_star
id|btv-&gt;win.bpl
suffix:semicolon
id|interlace
op_assign
id|btv-&gt;win.interlace
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Loop through all lines &n;&t; */
r_for
c_loop
(paren
id|yy
op_assign
l_int|0
suffix:semicolon
id|yy
OL
(paren
id|btv-&gt;win.height
op_lshift
(paren
l_int|1
op_xor
id|interlace
)paren
)paren
suffix:semicolon
id|yy
op_increment
)paren
(brace
id|y
op_assign
id|yy
op_rshift
(paren
l_int|1
op_xor
id|interlace
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Even or odd frame generation. We have to &n;&t;&t; *&t;write the RISC instructions to the right stream.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|y
op_amp
l_int|1
)paren
)paren
(brace
id|rp
op_assign
op_amp
id|rpo
suffix:semicolon
id|rpp
op_assign
id|rmem
suffix:semicolon
)brace
r_else
(brace
id|rp
op_assign
op_amp
id|rpe
suffix:semicolon
id|rpp
op_assign
id|rmem2
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;first2 is the header of a list of &quot;active&quot; rectangles. We add&n;&t;&t; *&t;rectangles as we hit their top and remove them as they fall off&n;&t;&t; *&t;the bottom&n;&t;&t; */
multiline_comment|/* remove rects with y2 &gt; y */
r_if
c_cond
(paren
(paren
id|cur
op_assign
id|first2.next
)paren
)paren
(brace
id|prev
op_assign
op_amp
id|first2
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|cur-&gt;y
op_plus
id|cur-&gt;height
OL
id|y
)paren
id|prev-&gt;next
op_assign
id|cur-&gt;next
suffix:semicolon
r_else
id|prev
op_assign
id|cur
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|cur
op_assign
id|cur-&gt;next
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Fixme - we have to handle overlapped rectangles&n;&t;&t; *&t;here, but the overlap might be partial&n;&t;&t; */
multiline_comment|/* add rect to second (x-sorted) list if rect.y == y  */
r_if
c_cond
(paren
(paren
id|cur
op_assign
id|first.next
)paren
)paren
(brace
r_while
c_loop
(paren
(paren
id|cur
)paren
op_logical_and
(paren
id|cur-&gt;y
op_eq
id|y
)paren
)paren
(brace
id|first.next
op_assign
id|cur-&gt;next
suffix:semicolon
id|cur2
op_assign
op_amp
id|first2
suffix:semicolon
r_while
c_loop
(paren
(paren
id|nx2
op_assign
id|cur2-&gt;next
)paren
op_logical_and
(paren
id|cur-&gt;x
OG
id|cur2-&gt;next-&gt;x
)paren
)paren
id|cur2
op_assign
id|nx2
suffix:semicolon
id|cur2-&gt;next
op_assign
id|cur
suffix:semicolon
id|cur-&gt;next
op_assign
id|nx2
suffix:semicolon
id|cur
op_assign
id|first.next
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; *&t;Begin writing the RISC script&n;&t;&t; */
id|dx
op_assign
id|x
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Starting at x position 0 on a new scan line&n;&t;&t; *&t;write to location p, don&squot;t yet write the number&n;&t;&t; *&t;of pixels for the instruction&n;&t;&t; */
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_increment
)braket
op_assign
id|BT848_RISC_WRITE
op_or
id|BT848_RISC_SOL
suffix:semicolon
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_increment
)braket
op_assign
id|p
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;For each rectangle we have in the &quot;active&quot; list - sorted left to&n;&t;&t; *&t;right..&n;&t;&t; */
r_for
c_loop
(paren
id|cur2
op_assign
id|first2.next
suffix:semicolon
id|cur2
suffix:semicolon
id|cur2
op_assign
id|cur2-&gt;next
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; *&t;If we are to the left of the first drawing area&n;&t;&t;&t; */
r_if
c_cond
(paren
id|x
op_plus
id|dx
OL
id|cur2-&gt;x
)paren
(brace
multiline_comment|/* Bytes pending ? */
r_if
c_cond
(paren
id|dx
)paren
(brace
multiline_comment|/* For a delta away from the start we need to write a SKIP */
r_if
c_cond
(paren
id|x
)paren
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_increment
)braket
op_assign
id|BT848_RISC_SKIP
op_or
(paren
id|dx
op_star
id|depth
)paren
suffix:semicolon
r_else
multiline_comment|/* Rewrite the start of line WRITE to a SKIP */
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_minus
l_int|2
)braket
op_or_assign
id|BT848_RISC_BYTE_ALL
op_or
(paren
id|dx
op_star
id|depth
)paren
suffix:semicolon
multiline_comment|/* Move X to the next point (drawing start) */
id|x
op_assign
id|x
op_plus
id|dx
suffix:semicolon
)brace
multiline_comment|/* Ok how far are we from the start of the next rectangle ? */
id|dx
op_assign
id|cur2-&gt;x
op_minus
id|x
suffix:semicolon
multiline_comment|/* dx is now the size of data to write */
multiline_comment|/* If this isnt the left edge generate a &quot;write continue&quot; */
r_if
c_cond
(paren
id|x
)paren
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_increment
)braket
op_assign
id|BT848_RISC_WRITEC
op_or
(paren
id|dx
op_star
id|depth
)paren
op_or
id|mask
suffix:semicolon
r_else
multiline_comment|/* Fill in the byte count on the initial WRITE */
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_minus
l_int|2
)braket
op_or_assign
(paren
id|dx
op_star
id|depth
)paren
op_or
id|mask
suffix:semicolon
multiline_comment|/* Move to the start of the rectangle */
id|x
op_assign
id|cur2-&gt;x
suffix:semicolon
multiline_comment|/* x is our left dx is byte size of hole */
id|dx
op_assign
id|cur2-&gt;width
op_plus
l_int|1
suffix:semicolon
)brace
r_else
multiline_comment|/* Already in a clip zone.. set dx */
r_if
c_cond
(paren
id|x
op_plus
id|dx
OL
id|cur2-&gt;x
op_plus
id|cur2-&gt;width
)paren
id|dx
op_assign
id|cur2-&gt;x
op_plus
id|cur2-&gt;width
op_minus
id|x
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* now treat the rest of the line */
id|ox
op_assign
id|x
suffix:semicolon
r_if
c_cond
(paren
id|dx
)paren
(brace
multiline_comment|/* Complete the SKIP to eat to the end of the gap */
r_if
c_cond
(paren
id|x
)paren
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_increment
)braket
op_assign
id|BT848_RISC_SKIP
op_or
(paren
id|dx
op_star
id|depth
)paren
suffix:semicolon
r_else
multiline_comment|/* Rewrite to SKIP start to this point */
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_minus
l_int|2
)braket
op_or_assign
id|BT848_RISC_BYTE_ALL
op_or
(paren
id|dx
op_star
id|depth
)paren
suffix:semicolon
id|x
op_assign
id|x
op_plus
id|dx
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Not at the right hand edge ?&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|dx
op_assign
id|btv-&gt;win.width
op_minus
id|x
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Write to edge of display */
r_if
c_cond
(paren
id|x
)paren
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_increment
)braket
op_assign
id|BT848_RISC_WRITEC
op_or
(paren
id|dx
op_star
id|depth
)paren
op_or
id|BT848_RISC_EOL
op_or
id|mask
suffix:semicolon
r_else
multiline_comment|/* Entire frame is a write - patch first order */
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_minus
l_int|2
)braket
op_or_assign
(paren
id|dx
op_star
id|depth
)paren
op_or
id|BT848_RISC_EOL
op_or
id|mask
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* End of line if needed */
r_if
c_cond
(paren
id|ox
)paren
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_minus
l_int|1
)braket
op_or_assign
id|BT848_RISC_EOL
op_or
id|mask
suffix:semicolon
r_else
(brace
multiline_comment|/* Skip the line : write a SKIP + start/end of line marks */
(paren
op_star
id|rp
)paren
op_decrement
suffix:semicolon
id|rpp
(braket
(paren
op_star
id|rp
)paren
op_minus
l_int|1
)braket
op_assign
id|BT848_RISC_SKIP
op_or
(paren
id|btv-&gt;win.width
op_star
id|depth
)paren
op_or
id|BT848_RISC_EOL
op_or
id|BT848_RISC_SOL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; *&t;Move the video render pointer on a line &n;&t;&t; */
r_if
c_cond
(paren
id|interlace
op_logical_or
(paren
id|y
op_amp
l_int|1
)paren
)paren
id|p
op_add_assign
id|btv-&gt;win.bpl
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Attach the interframe jumps&n;&t; */
id|rmem
(braket
id|rpo
op_increment
)braket
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
id|rmem
(braket
id|rpo
op_increment
)braket
op_assign
id|btv-&gt;bus_vbi_even
suffix:semicolon
id|rmem2
(braket
id|rpe
op_increment
)braket
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
id|rmem2
(braket
id|rpe
op_increment
)braket
op_assign
id|btv-&gt;bus_vbi_odd
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Helper for adding clips.&n; */
DECL|function|new_risc_clip
r_static
r_void
id|new_risc_clip
c_func
(paren
r_struct
id|video_window
op_star
id|vw
comma
r_struct
id|video_clip
op_star
id|vcp
comma
r_int
id|x
comma
r_int
id|y
comma
r_int
id|w
comma
r_int
id|h
)paren
(brace
id|vcp
(braket
id|vw-&gt;clipcount
)braket
dot
id|x
op_assign
id|x
suffix:semicolon
id|vcp
(braket
id|vw-&gt;clipcount
)braket
dot
id|y
op_assign
id|y
suffix:semicolon
id|vcp
(braket
id|vw-&gt;clipcount
)braket
dot
id|width
op_assign
id|w
suffix:semicolon
id|vcp
(braket
id|vw-&gt;clipcount
)braket
dot
id|height
op_assign
id|h
suffix:semicolon
id|vw-&gt;clipcount
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;ioctl routine&n; */
DECL|function|bttv_ioctl
r_static
r_int
id|bttv_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
r_char
id|eedata
(braket
l_int|256
)braket
suffix:semicolon
multiline_comment|/*&t;unsigned long data;*/
multiline_comment|/*&t;static ushort creg;*/
r_struct
id|bttv
op_star
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|dev
suffix:semicolon
r_static
r_int
id|lastchan
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
id|b
suffix:semicolon
id|strcpy
c_func
(paren
id|b.name
comma
id|btv-&gt;video_dev.name
)paren
suffix:semicolon
id|b.type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_TUNER
op_or
id|VID_TYPE_TELETEXT
op_or
id|VID_TYPE_OVERLAY
op_or
id|VID_TYPE_CLIPPING
op_or
id|VID_TYPE_FRAMERAM
op_or
id|VID_TYPE_SCALES
suffix:semicolon
id|b.channels
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* tv  , input, svhs */
id|b.audios
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* tv, input, svhs */
id|b.maxwidth
op_assign
l_int|768
suffix:semicolon
id|b.maxheight
op_assign
l_int|576
suffix:semicolon
id|b.minwidth
op_assign
l_int|32
suffix:semicolon
id|b.minheight
op_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|b
comma
r_sizeof
(paren
id|b
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|v.flags
op_assign
id|VIDEO_VC_AUDIO
suffix:semicolon
id|v.tuners
op_assign
l_int|0
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
r_switch
c_cond
(paren
id|v.channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Television&quot;
)paren
suffix:semicolon
id|v.flags
op_or_assign
id|VIDEO_VC_TUNER
suffix:semicolon
id|v.type
op_assign
id|VIDEO_TYPE_TV
suffix:semicolon
id|v.tuners
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Composite1&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Composite2&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;SVHS&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Each channel has 1 tuner&n;&t;&t; */
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|bt848_muxsel
c_func
(paren
id|btv
comma
id|v
)paren
suffix:semicolon
id|lastchan
op_assign
id|v
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.tuner
op_logical_or
id|lastchan
)paren
(brace
multiline_comment|/* Only tuner 0 */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|v.name
comma
l_string|&quot;Television&quot;
)paren
suffix:semicolon
id|v.rangelow
op_assign
l_int|0
suffix:semicolon
id|v.rangehigh
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|v.flags
op_assign
id|VIDEO_TUNER_PAL
op_or
id|VIDEO_TUNER_NTSC
suffix:semicolon
id|v.mode
op_assign
id|btv-&gt;win.norm
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We have but tuner 0 */
r_case
id|VIDIOCSTUNER
suffix:colon
(brace
r_struct
id|video_tuner
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Only channel 0 has a tuner */
r_if
c_cond
(paren
id|v.tuner
op_ne
l_int|0
op_logical_or
id|lastchan
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.mode
op_ne
id|VIDEO_MODE_PAL
op_logical_and
id|v.mode
op_ne
id|VIDEO_MODE_NTSC
)paren
(brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|btv-&gt;win.norm
op_assign
id|v.mode
suffix:semicolon
id|bt848_set_size
c_func
(paren
id|btv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
op_assign
id|btv-&gt;picture
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;win.bpp
op_eq
l_int|8
)paren
(brace
id|p.palette
op_assign
id|VIDEO_PALETTE_HI240
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.bpp
op_eq
l_int|16
)paren
(brace
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB565
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.bpp
op_eq
l_int|24
)paren
(brace
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB24
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.bpp
op_eq
l_int|32
)paren
(brace
id|p.palette
op_assign
id|VIDEO_PALETTE_RGB32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|p
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|p
comma
id|arg
comma
r_sizeof
(paren
id|p
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* We want -128 to 127 we get 0-65535 */
id|bt848_bright
c_func
(paren
id|btv
comma
(paren
id|p.brightness
op_rshift
l_int|8
)paren
op_minus
l_int|128
)paren
suffix:semicolon
multiline_comment|/* 0-511 for the colour */
id|bt848_sat_u
c_func
(paren
id|btv
comma
id|p.colour
op_rshift
l_int|7
)paren
suffix:semicolon
id|bt848_sat_v
c_func
(paren
id|btv
comma
(paren
(paren
id|p.colour
op_rshift
l_int|7
)paren
op_star
l_int|201L
)paren
op_div
l_int|237
)paren
suffix:semicolon
multiline_comment|/* -128 to 127 */
id|bt848_hue
c_func
(paren
id|btv
comma
(paren
id|p.hue
op_rshift
l_int|8
)paren
op_minus
l_int|128
)paren
suffix:semicolon
multiline_comment|/* 0-511 */
id|bt848_contrast
c_func
(paren
id|btv
comma
id|p.contrast
op_rshift
l_int|7
)paren
suffix:semicolon
id|btv-&gt;picture
op_assign
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
r_struct
id|video_clip
op_star
id|vcp
suffix:semicolon
r_int
id|on
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vw
comma
id|arg
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.flags
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|btv-&gt;win.x
op_assign
id|vw.x
suffix:semicolon
id|btv-&gt;win.y
op_assign
id|vw.y
suffix:semicolon
id|btv-&gt;win.width
op_assign
id|vw.width
suffix:semicolon
id|btv-&gt;win.height
op_assign
id|vw.height
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;win.height
OG
id|btv-&gt;win.cropheight
op_div
l_int|2
)paren
(brace
id|btv-&gt;win.interlace
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|btv-&gt;win.interlace
op_assign
l_int|0
suffix:semicolon
id|on
op_assign
(paren
id|btv-&gt;cap
op_amp
l_int|3
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|bt848_cap
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
id|bt848_set_size
c_func
(paren
id|btv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vw.clipcount
OG
l_int|256
)paren
(brace
r_return
op_minus
id|EDOM
suffix:semicolon
)brace
multiline_comment|/* Too many! */
multiline_comment|/*&n;&t;&t;&t; *&t;Do any clips.&n;&t;&t;&t; */
id|vcp
op_assign
id|vmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
(paren
id|vw.clipcount
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcp
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vw.clipcount
op_logical_and
id|copy_from_user
c_func
(paren
id|vcp
comma
id|vw.clips
comma
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
id|vw.clipcount
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Impose display clips&n;&t;&t;&t; */
r_if
c_cond
(paren
id|btv-&gt;win.x
OL
l_int|0
)paren
(brace
id|new_risc_clip
c_func
(paren
op_amp
id|vw
comma
id|vcp
comma
l_int|0
comma
l_int|0
comma
op_minus
id|btv-&gt;win.x
comma
id|btv-&gt;win.height
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.y
OL
l_int|0
)paren
(brace
id|new_risc_clip
c_func
(paren
op_amp
id|vw
comma
id|vcp
comma
l_int|0
comma
l_int|0
comma
id|btv-&gt;win.width
op_minus
l_int|1
comma
op_minus
id|btv-&gt;win.y
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.x
op_plus
id|btv-&gt;win.width
OG
id|btv-&gt;win.swidth
)paren
(brace
id|new_risc_clip
c_func
(paren
op_amp
id|vw
comma
id|vcp
comma
id|btv-&gt;win.swidth
op_minus
id|btv-&gt;win.x
comma
l_int|0
comma
id|btv-&gt;win.width
op_minus
l_int|1
comma
id|btv-&gt;win.height
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.y
op_plus
id|btv-&gt;win.height
OG
id|btv-&gt;win.sheight
)paren
(brace
id|new_risc_clip
c_func
(paren
op_amp
id|vw
comma
id|vcp
comma
l_int|0
comma
id|btv-&gt;win.sheight
op_minus
id|btv-&gt;win.y
comma
id|btv-&gt;win.width
op_minus
l_int|1
comma
id|btv-&gt;win.height
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; *&t;Question: Do we need to walk the clip list&n;&t;&t;&t; *&t;and saw off any clips outside the window &n;&t;&t;&t; *&t;frame or will write_risc_tab do the right&n;&t;&t;&t; *&t;thing ?&n;&t;&t;&t; */
id|write_risc_data
c_func
(paren
id|btv
comma
id|vcp
comma
id|vw.clipcount
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|vcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
(brace
id|bt848_cap
c_func
(paren
id|btv
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
id|vw
suffix:semicolon
multiline_comment|/* Oh for a COBOL move corresponding .. */
id|vw.x
op_assign
id|btv-&gt;win.x
suffix:semicolon
id|vw.y
op_assign
id|btv-&gt;win.y
suffix:semicolon
id|vw.width
op_assign
id|btv-&gt;win.width
suffix:semicolon
id|vw.height
op_assign
id|btv-&gt;win.height
suffix:semicolon
id|vw.chromakey
op_assign
l_int|0
suffix:semicolon
id|vw.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;win.interlace
)paren
(brace
id|vw.flags
op_or_assign
id|VIDEO_WINDOW_INTERLACE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vw
comma
r_sizeof
(paren
id|vw
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCCAPTURE
suffix:colon
(brace
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;win.vidadr
op_eq
l_int|0
op_logical_or
id|btv-&gt;win.width
op_eq
l_int|0
op_logical_or
id|btv-&gt;win.height
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v
op_eq
l_int|0
)paren
(brace
id|bt848_cap
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|bt848_cap
c_func
(paren
id|btv
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|v
suffix:semicolon
id|v.base
op_assign
(paren
r_void
op_star
)paren
id|btv-&gt;win.vidadr
suffix:semicolon
id|v.height
op_assign
id|btv-&gt;win.sheight
suffix:semicolon
id|v.width
op_assign
id|btv-&gt;win.swidth
suffix:semicolon
id|v.depth
op_assign
id|btv-&gt;win.bpp
op_star
l_int|8
suffix:semicolon
id|v.bytesperline
op_assign
id|btv-&gt;win.bpl
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSFBUF
suffix:colon
(brace
r_struct
id|video_buffer
id|v
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.depth
op_ne
l_int|8
op_logical_and
id|v.depth
op_ne
l_int|16
op_logical_and
id|v.depth
op_ne
l_int|24
op_logical_and
id|v.depth
op_ne
l_int|32
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|btv-&gt;win.vidadr
op_assign
(paren
r_int
)paren
id|v.base
suffix:semicolon
id|btv-&gt;win.sheight
op_assign
id|v.height
suffix:semicolon
id|btv-&gt;win.swidth
op_assign
id|v.width
suffix:semicolon
id|btv-&gt;win.bpp
op_assign
id|v.depth
op_div
l_int|8
suffix:semicolon
id|btv-&gt;win.bpl
op_assign
id|v.bytesperline
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Display at %p is %d by %d, bytedepth %d, bpl %d&bslash;n&quot;
comma
id|v.base
comma
id|v.width
comma
id|v.height
comma
id|btv-&gt;win.bpp
comma
id|btv-&gt;win.bpl
)paren
)paren
suffix:semicolon
id|bt848_set_size
c_func
(paren
id|btv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCKEY
suffix:colon
(brace
multiline_comment|/* Will be handled higher up .. */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGFREQ
suffix:colon
(brace
r_int
r_int
id|v
op_assign
id|btv-&gt;win.freq
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|v
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSFREQ
suffix:colon
(brace
r_int
r_int
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|btv-&gt;win.freq
op_assign
id|v
suffix:semicolon
id|set_freq
c_func
(paren
id|btv
comma
id|btv-&gt;win.freq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGAUDIO
suffix:colon
(brace
r_struct
id|video_audio
id|vp
suffix:semicolon
id|vp
op_assign
id|btv-&gt;audio_dev
suffix:semicolon
id|vp.flags
op_and_assign
op_complement
(paren
id|VIDEO_AUDIO_MUTE
op_or
id|VIDEO_AUDIO_MUTABLE
)paren
suffix:semicolon
id|vp.flags
op_or_assign
id|VIDEO_AUDIO_MUTABLE
suffix:semicolon
id|strcpy
c_func
(paren
id|vp.name
comma
l_string|&quot;TV&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSAUDIO
suffix:colon
(brace
r_struct
id|video_audio
id|v
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|v
comma
id|arg
comma
r_sizeof
(paren
id|v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_MUTE
)paren
(brace
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_MUTE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v.audio
l_int|2
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bt848_muxsel
c_func
(paren
id|btv
comma
id|v.audio
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|v.flags
op_amp
id|VIDEO_AUDIO_MUTE
)paren
)paren
(brace
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_UNMUTE
)paren
suffix:semicolon
)brace
id|btv-&gt;audio_dev
op_assign
id|v
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|BTTV_WRITEEE
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_void
op_star
)paren
id|eedata
comma
(paren
r_void
op_star
)paren
id|arg
comma
l_int|256
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|writeee
c_func
(paren
id|btv
comma
id|eedata
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_READEE
suffix:colon
id|readee
c_func
(paren
id|btv
comma
id|eedata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
id|eedata
comma
l_int|256
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bttv_init_done
r_static
r_int
id|bttv_init_done
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|bttv_template
r_static
r_struct
id|video_device
id|bttv_template
op_assign
(brace
l_string|&quot;UNSET&quot;
comma
id|VID_TYPE_TUNER
op_or
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_OVERLAY
op_or
id|VID_TYPE_TELETEXT
comma
id|VID_HARDWARE_BT848
comma
id|bttv_open
comma
id|bttv_close
comma
id|bttv_read
comma
id|bttv_write
comma
id|bttv_ioctl
comma
l_int|NULL
comma
multiline_comment|/* no mmap yet */
id|bttv_init_done
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|struct|vidbases
r_struct
id|vidbases
(brace
DECL|member|vendor
DECL|member|device
id|ushort
id|vendor
comma
id|device
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|badr
id|uint
id|badr
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|vbs
r_static
r_struct
id|vidbases
id|vbs
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_TSENG
comma
l_int|0
comma
l_string|&quot;TSENG&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_MATROX
comma
id|PCI_DEVICE_ID_MATROX_MIL
comma
l_string|&quot;Matrox Millennium&quot;
comma
id|PCI_BASE_ADDRESS_1
)brace
comma
(brace
id|PCI_VENDOR_ID_MATROX
comma
l_int|0x051a
comma
l_string|&quot;Matrox Mystique&quot;
comma
id|PCI_BASE_ADDRESS_1
)brace
comma
(brace
id|PCI_VENDOR_ID_S3
comma
l_int|0
comma
l_string|&quot;S3&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_ATI
comma
id|PCI_DEVICE_ID_ATI_210888GX
comma
l_string|&quot;ATI MACH64 Winturbo&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_CIRRUS
comma
l_int|0
comma
l_string|&quot;Cirrus Logic&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_N9
comma
id|PCI_DEVICE_ID_N9_I128
comma
l_string|&quot;Number Nine Imagine 128&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
(brace
id|PCI_VENDOR_ID_DEC
comma
id|PCI_DEVICE_ID_DEC_TGA
comma
l_string|&quot;DEC DC21030&quot;
comma
id|PCI_BASE_ADDRESS_0
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* DEC TGA offsets stolen from XFree-3.2 */
DECL|variable|dec_offsets
r_static
id|uint
id|dec_offsets
(braket
l_int|4
)braket
op_assign
(brace
l_int|0x200000
comma
l_int|0x804000
comma
l_int|0
comma
l_int|0x1004000
)brace
suffix:semicolon
DECL|macro|NR_CARDS
mdefine_line|#define NR_CARDS (sizeof(vbs)/sizeof(struct vidbases))
multiline_comment|/* Scan for PCI display adapter&n;   if more than one card is present the last one is used for now */
DECL|function|find_vga
r_static
r_int
id|find_vga
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|devfn
comma
r_class
comma
id|vendev
suffix:semicolon
id|ushort
id|vendor
comma
id|device
comma
id|badr
suffix:semicolon
r_int
id|found
op_assign
l_int|0
comma
id|bus
op_assign
l_int|0
comma
id|i
comma
id|tga_type
suffix:semicolon
r_int
r_int
id|vidadr
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|devfn
op_assign
l_int|0
suffix:semicolon
id|devfn
OL
l_int|0xff
suffix:semicolon
id|devfn
op_increment
)paren
(brace
r_if
c_cond
(paren
id|PCI_FUNC
c_func
(paren
id|devfn
)paren
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vendev
op_eq
l_int|0xffffffff
op_logical_or
id|vendev
op_eq
l_int|0x00000000
)paren
r_continue
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_VENDOR_ID
comma
op_amp
id|vendor
)paren
suffix:semicolon
id|pcibios_read_config_word
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_DEVICE_ID
comma
op_amp
id|device
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|devfn
comma
id|PCI_CLASS_REVISION
comma
op_amp
r_class
)paren
suffix:semicolon
r_class
op_assign
r_class
op_rshift
l_int|16
suffix:semicolon
multiline_comment|/*&t;&t;if (class == PCI_CLASS_DISPLAY_VGA) {*/
r_if
c_cond
(paren
(paren
r_class
op_rshift
l_int|8
)paren
op_eq
id|PCI_BASE_CLASS_DISPLAY
op_logical_or
multiline_comment|/* Number 9 GXE64Pro needs this */
r_class
op_eq
id|PCI_CLASS_NOT_DEFINED_VGA
)paren
(brace
id|badr
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: PCI display adapter: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|vendor
op_eq
id|vbs
(braket
id|i
)braket
dot
id|vendor
)paren
(brace
r_if
c_cond
(paren
id|vbs
(braket
id|i
)braket
dot
id|device
)paren
r_if
c_cond
(paren
id|vbs
(braket
id|i
)braket
dot
id|device
op_ne
id|device
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s.&bslash;n&quot;
comma
id|vbs
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
id|badr
op_assign
id|vbs
(braket
id|i
)braket
dot
id|badr
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|badr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: Unknown video memory base address.&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pcibios_read_config_dword
c_func
(paren
id|bus
comma
id|devfn
comma
id|badr
comma
op_amp
id|vidadr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vidadr
op_amp
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: Memory seems to be I/O memory.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: Check entry for your card type in bttv.c vidbases struct.&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|vidadr
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vidadr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: Memory @ 0, must be something wrong!&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vendor
op_eq
id|PCI_VENDOR_ID_DEC
)paren
r_if
c_cond
(paren
id|device
op_eq
id|PCI_DEVICE_ID_DEC_TGA
)paren
(brace
id|tga_type
op_assign
(paren
id|readl
c_func
(paren
(paren
r_int
r_int
)paren
id|vidadr
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|tga_type
op_ne
l_int|0
op_logical_and
id|tga_type
op_ne
l_int|1
op_logical_and
id|tga_type
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: TGA type (0x%x) unrecognized!&bslash;n&quot;
comma
id|tga_type
)paren
suffix:semicolon
id|found
op_decrement
suffix:semicolon
)brace
id|vidadr
op_add_assign
id|dec_offsets
(braket
id|tga_type
)braket
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: memory @ 0x%08x, &quot;
comma
id|vidadr
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;devfn: 0x%04x.&bslash;n&quot;
comma
id|devfn
)paren
)paren
suffix:semicolon
id|found
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|vidmem
)paren
(brace
id|vidadr
op_assign
id|vidmem
op_lshift
l_int|20
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: Video memory override: 0x%08x&bslash;n&quot;
comma
id|vidadr
)paren
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BTTV_MAX
suffix:semicolon
id|i
op_increment
)paren
id|bttvs
(braket
id|i
)braket
dot
id|win.vidadr
op_assign
id|vidadr
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
DECL|macro|TRITON_PCON
mdefine_line|#define  TRITON_PCON&t;           0x50 
DECL|macro|TRITON_BUS_CONCURRENCY
mdefine_line|#define  TRITON_BUS_CONCURRENCY   (1&lt;&lt;0)
DECL|macro|TRITON_STREAMING
mdefine_line|#define  TRITON_STREAMING&t;  (1&lt;&lt;1)
DECL|macro|TRITON_WRITE_BURST
mdefine_line|#define  TRITON_WRITE_BURST&t;  (1&lt;&lt;2)
DECL|macro|TRITON_PEER_CONCURRENCY
mdefine_line|#define  TRITON_PEER_CONCURRENCY  (1&lt;&lt;3)
DECL|function|handle_chipset
r_static
r_void
id|handle_chipset
c_func
(paren
r_void
)paren
(brace
r_int
id|index
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
l_int|8
suffix:semicolon
id|index
op_increment
)paren
(brace
r_int
r_char
id|bus
comma
id|devfn
suffix:semicolon
r_int
r_char
id|b
comma
id|bo
suffix:semicolon
multiline_comment|/* nothing wrong with this one, just checking buffer control config */
r_if
c_cond
(paren
op_logical_neg
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82441
comma
id|index
comma
op_amp
id|bus
comma
op_amp
id|devfn
)paren
)paren
(brace
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|devfn
comma
l_int|0x53
comma
op_amp
id|b
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: Host bridge: 82441FX Natoma, &quot;
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;bufcon=0x%02x&bslash;n&quot;
comma
id|b
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82437
comma
id|index
comma
op_amp
id|bus
comma
op_amp
id|devfn
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: Host bridge 82437FX Triton PIIX&bslash;n&quot;
)paren
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|bus
comma
id|devfn
comma
id|TRITON_PCON
comma
op_amp
id|b
)paren
suffix:semicolon
id|bo
op_assign
id|b
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: 82437FX: PCON: 0x%x&bslash;n&quot;
comma
id|b
)paren
)paren
suffix:semicolon
multiline_comment|/* 430FX (Triton I) freezes with bus concurrency on -&gt; switch it off */
r_if
c_cond
(paren
op_logical_neg
(paren
id|b
op_amp
id|TRITON_BUS_CONCURRENCY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: 82437FX: disabling bus concurrency&bslash;n&quot;
)paren
suffix:semicolon
id|b
op_or_assign
id|TRITON_BUS_CONCURRENCY
suffix:semicolon
)brace
multiline_comment|/* still freezes on other boards -&gt; switch off even more */
r_if
c_cond
(paren
id|b
op_amp
id|TRITON_PEER_CONCURRENCY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: 82437FX: disabling peer concurrency&bslash;n&quot;
)paren
suffix:semicolon
id|b
op_and_assign
op_complement
id|TRITON_PEER_CONCURRENCY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|b
op_amp
id|TRITON_STREAMING
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;bttv: 82437FX: disabling streaming&bslash;n&quot;
)paren
suffix:semicolon
id|b
op_or_assign
id|TRITON_STREAMING
suffix:semicolon
)brace
r_if
c_cond
(paren
id|b
op_ne
id|bo
)paren
(brace
id|pcibios_write_config_byte
c_func
(paren
id|bus
comma
id|devfn
comma
id|TRITON_PCON
comma
id|b
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: 82437FX: PCON changed to: 0x%x&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|init_tda9850
r_static
r_void
id|init_tda9850
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
id|I2CWrite
c_func
(paren
id|btv
comma
id|I2C_TDA9850
comma
id|TDA9850_CON3
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Figure out card and tuner type */
DECL|function|idcard
r_static
r_void
id|idcard
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
r_int
id|i
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_GPIO_OUT_EN
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: GPIO: 0x%08x&bslash;n&quot;
comma
id|btread
c_func
(paren
id|BT848_GPIO_DATA
)paren
)paren
)paren
suffix:semicolon
id|btv-&gt;type
op_assign
id|BTTV_MIRO
suffix:semicolon
id|btv-&gt;tuner
op_assign
id|tuner
suffix:semicolon
r_if
c_cond
(paren
id|I2CRead
c_func
(paren
id|btv
comma
id|I2C_HAUPEE
)paren
op_ge
l_int|0
)paren
id|btv-&gt;type
op_assign
id|BTTV_HAUPPAUGE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|I2CRead
c_func
(paren
id|btv
comma
id|I2C_STBEE
)paren
op_ge
l_int|0
)paren
id|btv-&gt;type
op_assign
id|BTTV_STB
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0xc0
suffix:semicolon
id|i
OL
l_int|0xd0
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|I2CRead
c_func
(paren
id|btv
comma
id|i
)paren
op_ge
l_int|0
)paren
(brace
id|btv-&gt;tuneradr
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|btv-&gt;dbx
op_assign
id|I2CRead
c_func
(paren
id|btv
comma
id|I2C_TDA9850
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;dbx
)paren
id|init_tda9850
c_func
(paren
id|btv
)paren
suffix:semicolon
multiline_comment|/* How do I detect the tuner type for other cards but Miro ??? */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: model: &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|btv-&gt;type
)paren
(brace
r_case
id|BTTV_MIRO
suffix:colon
id|btv-&gt;tuner
op_assign
(paren
(paren
id|btread
c_func
(paren
id|BT848_GPIO_DATA
)paren
op_rshift
l_int|10
)paren
op_minus
l_int|1
)paren
op_amp
l_int|7
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MIRO&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(Miro)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_HAUPPAUGE
suffix:colon
id|printk
c_func
(paren
l_string|&quot;HAUPPAUGE&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(Hauppauge)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_STB
suffix:colon
id|printk
c_func
(paren
l_string|&quot;STB&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(STB)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_INTEL
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Intel&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(Intel)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BTTV_DIAMOND
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Diamond&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|btv-&gt;video_dev.name
comma
l_string|&quot;BT848(Diamond)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; (%s @ 0x%02x)&bslash;n&quot;
comma
id|tuners
(braket
id|btv-&gt;tuner
)braket
dot
id|name
comma
id|btv-&gt;tuneradr
)paren
suffix:semicolon
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_MUTE
)paren
suffix:semicolon
)brace
DECL|function|bt848_set_risc_jmps
r_static
r_void
id|bt848_set_risc_jmps
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
r_int
id|flags
op_assign
id|btv-&gt;cap
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|0
)braket
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_RISC_RESYNC
op_or
id|BT848_FIFO_STATUS_VRE
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|2
)braket
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|8
)paren
id|btv-&gt;risc_jmp
(braket
l_int|3
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;vbi_odd
)paren
suffix:semicolon
r_else
id|btv-&gt;risc_jmp
(braket
l_int|3
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|4
)paren
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|4
)braket
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|2
)paren
id|btv-&gt;risc_jmp
(braket
l_int|5
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_odd
)paren
suffix:semicolon
r_else
id|btv-&gt;risc_jmp
(braket
l_int|5
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|6
)paren
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|6
)braket
op_assign
id|BT848_RISC_SYNC
op_or
id|BT848_RISC_RESYNC
op_or
id|BT848_FIFO_STATUS_VRO
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|8
)braket
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|4
)paren
id|btv-&gt;risc_jmp
(braket
l_int|9
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;vbi_even
)paren
suffix:semicolon
r_else
id|btv-&gt;risc_jmp
(braket
l_int|9
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|10
)paren
suffix:semicolon
id|btv-&gt;risc_jmp
(braket
l_int|10
)braket
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|1
)paren
id|btv-&gt;risc_jmp
(braket
l_int|11
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_even
)paren
suffix:semicolon
r_else
id|btv-&gt;risc_jmp
(braket
l_int|11
)braket
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|flags
comma
op_complement
l_int|0x0f
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
l_int|0x0f
)paren
id|bt848_dma
c_func
(paren
id|btv
comma
l_int|3
)paren
suffix:semicolon
r_else
id|bt848_dma
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|init_bt848
r_static
r_int
id|init_bt848
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
multiline_comment|/* reset the bt848 */
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_SRESET
)paren
suffix:semicolon
id|btv-&gt;user
op_assign
l_int|0
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: bt848_mem: 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|btv-&gt;bt848_mem
)paren
)paren
suffix:semicolon
multiline_comment|/* default setup for max. PAL size in a 1024xXXX hicolor framebuffer */
id|btv-&gt;win.norm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* change this to 1 for NTSC, 2 for SECAM */
id|btv-&gt;win.interlace
op_assign
l_int|1
suffix:semicolon
id|btv-&gt;win.x
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;win.y
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;win.width
op_assign
l_int|768
suffix:semicolon
multiline_comment|/* 640 */
id|btv-&gt;win.height
op_assign
l_int|576
suffix:semicolon
multiline_comment|/* 480 */
id|btv-&gt;win.cropwidth
op_assign
l_int|768
suffix:semicolon
multiline_comment|/* 640 */
id|btv-&gt;win.cropheight
op_assign
l_int|576
suffix:semicolon
multiline_comment|/* 480 */
id|btv-&gt;win.cropx
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;win.cropy
op_assign
l_int|0
suffix:semicolon
id|btv-&gt;win.bpp
op_assign
l_int|2
suffix:semicolon
id|btv-&gt;win.bpl
op_assign
l_int|1024
op_star
id|btv-&gt;win.bpp
suffix:semicolon
id|btv-&gt;win.swidth
op_assign
l_int|1024
suffix:semicolon
id|btv-&gt;win.sheight
op_assign
l_int|768
suffix:semicolon
id|btv-&gt;cap
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|btv-&gt;risc_odd
op_assign
(paren
id|dword
op_star
)paren
id|kmalloc
c_func
(paren
id|RISCMEM_LEN
op_div
l_int|2
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|btv-&gt;risc_even
op_assign
(paren
id|dword
op_star
)paren
id|kmalloc
c_func
(paren
id|RISCMEM_LEN
op_div
l_int|2
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|btv-&gt;risc_jmp
op_assign
(paren
id|dword
op_star
)paren
id|kmalloc
c_func
(paren
l_int|1024
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|btv-&gt;vbi_odd
op_assign
id|btv-&gt;risc_jmp
op_plus
l_int|12
suffix:semicolon
id|btv-&gt;vbi_even
op_assign
id|btv-&gt;vbi_odd
op_plus
l_int|256
suffix:semicolon
id|btv-&gt;bus_vbi_odd
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
)paren
suffix:semicolon
id|btv-&gt;bus_vbi_even
op_assign
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|6
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|virt_to_bus
c_func
(paren
id|btv-&gt;risc_jmp
op_plus
l_int|2
)paren
comma
id|BT848_RISC_STRT_ADD
)paren
suffix:semicolon
id|btv-&gt;vbibuf
op_assign
(paren
id|unchar
op_star
)paren
id|vmalloc
c_func
(paren
id|VBIBUF_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;vbibuf
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|bt848_muxsel
c_func
(paren
id|btv
comma
l_int|1
)paren
suffix:semicolon
id|bt848_set_size
c_func
(paren
id|btv
)paren
suffix:semicolon
multiline_comment|/*&t;btwrite(0, BT848_TDEC); */
id|btwrite
c_func
(paren
l_int|0x10
comma
id|BT848_COLOR_CTL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x0ff
comma
id|BT848_VBI_PACK_SIZE
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|1
comma
id|BT848_VBI_PACK_DEL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0xfc
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|BT848_IFORM_MUX1
op_or
id|BT848_IFORM_XTAUTO
op_or
id|BT848_IFORM_PAL_BDGHI
comma
id|BT848_IFORM
)paren
suffix:semicolon
id|bt848_bright
c_func
(paren
id|btv
comma
l_int|0x10
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0xd8
comma
id|BT848_CONTRAST_LO
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x60
comma
id|BT848_E_VSCALE_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x60
comma
id|BT848_O_VSCALE_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
multiline_comment|/*BT848_ADC_SYNC_T|*/
id|BT848_ADC_RESERVED
op_or
id|BT848_ADC_CRUSH
comma
id|BT848_ADC
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|BT848_CONTROL_LDEC
comma
id|BT848_E_CONTROL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|BT848_CONTROL_LDEC
comma
id|BT848_O_CONTROL
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_E_SCLOOP
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x00
comma
id|BT848_O_SCLOOP
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0xffffffUL
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
multiline_comment|/*&t;  BT848_INT_PABORT|BT848_INT_RIPERR|BT848_INT_PPERR|BT848_INT_FDSR|&n;&t;  BT848_INT_FTRGT|BT848_INT_FBUS|*/
id|btwrite
c_func
(paren
id|BT848_INT_ETBF
op_or
id|BT848_INT_SCERR
op_or
id|BT848_INT_RISCI
op_or
id|BT848_INT_OCERR
op_or
id|BT848_INT_VPRES
op_or
id|BT848_INT_FMTCHG
op_or
id|BT848_INT_HLOCK
comma
id|BT848_INT_MASK
)paren
suffix:semicolon
multiline_comment|/*&t;make_risctab(btv); */
id|make_vbitab
c_func
(paren
id|btv
)paren
suffix:semicolon
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now add the template and register the device unit.&n;&t; */
id|memcpy
c_func
(paren
op_amp
id|btv-&gt;video_dev
comma
op_amp
id|bttv_template
comma
r_sizeof
(paren
id|bttv_template
)paren
)paren
suffix:semicolon
id|idcard
c_func
(paren
id|btv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|btv-&gt;video_dev
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bttv_irq
r_static
r_void
id|bttv_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|stat
comma
id|astat
suffix:semicolon
id|u32
id|dstat
suffix:semicolon
r_int
id|count
suffix:semicolon
r_struct
id|bttv
op_star
id|btv
suffix:semicolon
id|btv
op_assign
(paren
r_struct
id|bttv
op_star
)paren
id|dev_id
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* get/clear interrupt status bits */
id|stat
op_assign
id|btread
c_func
(paren
id|BT848_INT_STAT
)paren
suffix:semicolon
id|astat
op_assign
id|stat
op_amp
id|btread
c_func
(paren
id|BT848_INT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|astat
)paren
r_return
suffix:semicolon
id|btwrite
c_func
(paren
id|astat
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: astat %08x&bslash;n&quot;
comma
id|astat
)paren
)paren
suffix:semicolon
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv:  stat %08x&bslash;n&quot;
comma
id|stat
)paren
)paren
suffix:semicolon
multiline_comment|/* get device status bits */
id|dstat
op_assign
id|btread
c_func
(paren
id|BT848_DSTATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_FMTCHG
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_FMTCHG&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&t;&t;&t;btv-&gt;win.norm&amp;=(dstat&amp;BT848_DSTATUS_NUML) ? (~1) : (~0); */
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_VPRES
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_VPRES&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_VSYNC
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_VSYNC&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_SCERR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_SCERR&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|bt848_dma
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
id|bt848_dma
c_func
(paren
id|btv
comma
l_int|1
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|btv-&gt;vbiq
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|btv-&gt;capq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_RISCI
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_RISCI&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* printk (&quot;bttv: IRQ_RISCI%d&bslash;n&quot;,stat&gt;&gt;28); */
r_if
c_cond
(paren
id|stat
op_amp
(paren
l_int|1
op_lshift
l_int|28
)paren
)paren
(brace
id|btv-&gt;vbip
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|btv-&gt;vbiq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
op_amp
(paren
l_int|2
op_lshift
l_int|28
)paren
)paren
(brace
id|bt848_set_risc_jmps
c_func
(paren
id|btv
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|btv-&gt;capq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_OCERR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_OCERR&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_PABORT
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_PABORT&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_RIPERR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_RIPERR&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_PPERR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_PPERR&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_FDSR
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_FDSR&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_FTRGT
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_FTRGT&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_FBUS
)paren
(brace
id|IDEBUG
c_func
(paren
id|printk
(paren
l_string|&quot;bttv: IRQ_FBUS&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_HLOCK
)paren
(brace
r_if
c_cond
(paren
id|dstat
op_amp
id|BT848_DSTATUS_HLOC
)paren
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_ON
)paren
suffix:semicolon
r_else
id|audio
c_func
(paren
id|btv
comma
id|AUDIO_OFF
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|astat
op_amp
id|BT848_INT_I2CDONE
)paren
(brace
)brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|10
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;bttv: irq loop %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|20
)paren
(brace
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_INT_MASK
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: IRQ lockup, cleared int mask&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Scan for a Bt848 card, request the irq and map the io memory &n; */
DECL|function|find_bt848
r_static
r_int
id|find_bt848
c_func
(paren
r_void
)paren
(brace
r_int
id|pci_index
suffix:semicolon
r_int
r_char
id|command
comma
id|latency
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
r_char
id|bus
comma
id|devfn
suffix:semicolon
r_struct
id|bttv
op_star
id|btv
suffix:semicolon
id|bttv_num
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: PCI-BIOS not present or not accessable!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|pci_index
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_BROOKTREE
comma
id|PCI_DEVICE_ID_BT848
comma
id|pci_index
comma
op_amp
id|bus
comma
op_amp
id|devfn
)paren
suffix:semicolon
op_increment
id|pci_index
)paren
(brace
id|btv
op_assign
op_amp
id|bttvs
(braket
id|bttv_num
)braket
suffix:semicolon
id|btv-&gt;bus
op_assign
id|bus
suffix:semicolon
id|btv-&gt;devfn
op_assign
id|devfn
suffix:semicolon
id|btv-&gt;bt848_mem
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbibuf
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;risc_jmp
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbi_odd
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbi_even
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbiq
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;capq
op_assign
l_int|NULL
suffix:semicolon
id|btv-&gt;vbip
op_assign
id|VBIBUF_SIZE
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|btv-&gt;irq
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|btv-&gt;bt848_adr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap
op_logical_and
(paren
op_logical_neg
id|bttv_num
)paren
)paren
(brace
id|remap
op_lshift_assign
l_int|20
suffix:semicolon
id|remap
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Remapping to : 0x%08x.&bslash;n&quot;
comma
id|remap
)paren
suffix:semicolon
id|remap
op_or_assign
id|btv-&gt;bt848_adr
op_amp
(paren
op_complement
id|PCI_BASE_ADDRESS_MEM_MASK
)paren
suffix:semicolon
id|pcibios_write_config_dword
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_BASE_ADDRESS_0
comma
id|remap
)paren
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_BASE_ADDRESS_0
comma
op_amp
id|btv-&gt;bt848_adr
)paren
suffix:semicolon
)brace
id|btv-&gt;bt848_adr
op_and_assign
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|btv-&gt;revision
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: Brooktree Bt848 (rev %d) &quot;
comma
id|btv-&gt;revision
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bus: %d, devfn: %d, &quot;
comma
id|btv-&gt;bus
comma
id|btv-&gt;devfn
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;irq: %d, &quot;
comma
id|btv-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;memory: 0x%08x.&bslash;n&quot;
comma
id|btv-&gt;bt848_adr
)paren
suffix:semicolon
id|btv-&gt;bt848_mem
op_assign
id|ioremap
c_func
(paren
id|btv-&gt;bt848_adr
comma
l_int|0x1000
)paren
suffix:semicolon
id|result
op_assign
id|request_irq
c_func
(paren
id|btv-&gt;irq
comma
id|bttv_irq
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
l_string|&quot;bttv&quot;
comma
(paren
r_void
op_star
)paren
id|btv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EINVAL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: Bad irq number or handler&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EBUSY
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: IRQ %d busy, change your PnP config in BIOS&bslash;n&quot;
comma
id|btv-&gt;irq
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
multiline_comment|/* Enable bus-mastering */
id|pcibios_read_config_byte
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
id|command
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
id|pcibios_read_config_byte
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|command
op_amp
id|PCI_COMMAND_MASTER
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bttv: PCI bus-mastering could not be enabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|pcibios_read_config_byte
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|latency
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|latency
)paren
(brace
id|latency
op_assign
l_int|32
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_LATENCY_TIMER
comma
id|latency
)paren
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv: latency: %02x&bslash;n&quot;
comma
id|latency
)paren
)paren
suffix:semicolon
id|bttv_num
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bttv_num
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bttv: %d Bt848 card(s) found.&bslash;n&quot;
comma
id|bttv_num
)paren
suffix:semicolon
)brace
r_return
id|bttv_num
suffix:semicolon
)brace
DECL|function|release_bttv
r_static
r_void
id|release_bttv
c_func
(paren
r_void
)paren
(brace
id|u8
id|command
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|bttv
op_star
id|btv
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bttv_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|btv
op_assign
op_amp
id|bttvs
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* turn off all capturing, DMA and IRQs */
multiline_comment|/* first disable interrupts before unmapping the memory! */
id|btwrite
c_func
(paren
l_int|0
comma
id|BT848_INT_MASK
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0xffffffffUL
comma
id|BT848_INT_STAT
)paren
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0x0
comma
id|BT848_GPIO_OUT_EN
)paren
suffix:semicolon
id|bt848_cap
c_func
(paren
id|btv
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable PCI bus-mastering */
id|pcibios_read_config_byte
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
id|command
op_or_assign
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pcibios_write_config_byte
c_func
(paren
id|btv-&gt;bus
comma
id|btv-&gt;devfn
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
multiline_comment|/* unmap and free memory */
r_if
c_cond
(paren
id|btv-&gt;risc_odd
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;risc_odd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;risc_even
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;risc_even
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;free: risc_jmp: 0x%08x.&bslash;n&quot;
comma
id|btv-&gt;risc_jmp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;risc_jmp
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;risc_jmp
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bt848_vbibuf: 0x%08x.&bslash;n&quot;
comma
id|btv-&gt;vbibuf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;vbibuf
)paren
id|vfree
c_func
(paren
(paren
r_void
op_star
)paren
id|btv-&gt;vbibuf
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|btv-&gt;irq
comma
id|btv
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bt848_mem: 0x%08x.&bslash;n&quot;
comma
id|btv-&gt;bt848_mem
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;bt848_mem
)paren
id|iounmap
c_func
(paren
id|btv-&gt;bt848_mem
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|btv-&gt;video_dev
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
macro_line|#else
r_int
id|init_bttv_cards
c_func
(paren
r_struct
id|video_init
op_star
id|unused
)paren
(brace
macro_line|#endif
r_int
id|i
suffix:semicolon
id|handle_chipset
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|find_bt848
c_func
(paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bttv_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|init_bt848
c_func
(paren
op_amp
id|bttvs
(braket
id|i
)braket
)paren
OL
l_int|0
)paren
(brace
id|release_bttv
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|release_bttv
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
