multiline_comment|/*&n; * linux/drivers/char/mouse.c&n; *&n; * Generic mouse open routine by Johan Myreen&n; *&n; * Based on code from Linus&n; *&n; * Teemu Rantanen&squot;s Microsoft Busmouse support and Derrick Cole&squot;s&n; *   changes incorporated into 0.97pl4&n; *   by Peter Cervasio (pete%q106fm.uucp@wupost.wustl.edu) (08SEP92)&n; *   See busmouse.c for particulars.&n; *&n; * Made things a lot mode modular - easy to compile in just one or two&n; * of the mouse drivers, as they are now completely independent. Linus.&n; *&n; * Support for loadable modules. 8-Sep-95 Philip Blundell &lt;pjb27@cam.ac.uk&gt;&n; */
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#else
DECL|macro|MOD_INC_USE_COUNT
mdefine_line|#define MOD_INC_USE_COUNT
DECL|macro|MOD_DEC_USE_COUNT
mdefine_line|#define MOD_DEC_USE_COUNT
macro_line|#endif
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mouse.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &quot;mouse.h&quot;
multiline_comment|/*&n; * Head entry for the doubly linked mouse list&n; */
DECL|variable|mouse_list
r_static
r_struct
id|mouse
id|mouse_list
op_assign
(brace
l_int|0
comma
l_string|&quot;head&quot;
comma
l_int|NULL
comma
op_amp
id|mouse_list
comma
op_amp
id|mouse_list
)brace
suffix:semicolon
macro_line|#ifndef MODULE
r_extern
r_int
r_int
id|bus_mouse_init
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
r_int
id|psaux_init
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
r_int
id|ms_bus_mouse_init
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
r_int
id|atixl_busmouse_init
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
macro_line|#endif
DECL|function|mouse_open
r_static
r_int
id|mouse_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|mouse
op_star
id|c
op_assign
id|mouse_list.next
suffix:semicolon
id|file-&gt;f_op
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|c
op_ne
op_amp
id|mouse_list
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;minor
op_eq
id|minor
)paren
(brace
id|file-&gt;f_op
op_assign
id|c-&gt;fops
suffix:semicolon
r_break
suffix:semicolon
)brace
id|c
op_assign
id|c-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_op
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|file-&gt;f_op
op_member_access_from_pointer
id|open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
DECL|variable|mouse_fops
r_static
r_struct
id|file_operations
id|mouse_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* seek */
l_int|NULL
comma
multiline_comment|/* read */
l_int|NULL
comma
multiline_comment|/* write */
l_int|NULL
comma
multiline_comment|/* readdir */
l_int|NULL
comma
multiline_comment|/* select */
l_int|NULL
comma
multiline_comment|/* ioctl */
l_int|NULL
comma
multiline_comment|/* mmap */
id|mouse_open
comma
l_int|NULL
multiline_comment|/* release */
)brace
suffix:semicolon
DECL|function|mouse_register
r_int
id|mouse_register
c_func
(paren
r_struct
id|mouse
op_star
id|mouse
)paren
(brace
r_if
c_cond
(paren
id|mouse-&gt;next
op_logical_or
id|mouse-&gt;prev
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|mouse-&gt;next
op_assign
op_amp
id|mouse_list
suffix:semicolon
id|mouse-&gt;prev
op_assign
id|mouse_list.prev
suffix:semicolon
id|mouse-&gt;prev-&gt;next
op_assign
id|mouse
suffix:semicolon
id|mouse-&gt;next-&gt;prev
op_assign
id|mouse
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mouse_deregister
r_int
id|mouse_deregister
c_func
(paren
r_struct
id|mouse
op_star
id|mouse
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mouse-&gt;next
op_logical_or
op_logical_neg
id|mouse-&gt;prev
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|mouse-&gt;prev-&gt;next
op_assign
id|mouse-&gt;next
suffix:semicolon
id|mouse-&gt;next-&gt;prev
op_assign
id|mouse-&gt;prev
suffix:semicolon
id|mouse-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|mouse-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|variable|kernel_version
r_char
id|kernel_version
(braket
)braket
op_assign
id|UTS_RELEASE
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
r_int
id|mouse_init
c_func
(paren
r_int
r_int
id|kmem_start
)paren
macro_line|#endif
(brace
macro_line|#ifndef MODULE
macro_line|#ifdef CONFIG_BUSMOUSE
id|kmem_start
op_assign
id|bus_mouse_init
c_func
(paren
id|kmem_start
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if defined CONFIG_PSMOUSE || defined CONFIG_82C710_MOUSE
id|kmem_start
op_assign
id|psaux_init
c_func
(paren
id|kmem_start
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_MS_BUSMOUSE
id|kmem_start
op_assign
id|ms_bus_mouse_init
c_func
(paren
id|kmem_start
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ATIXL_BUSMOUSE
id|kmem_start
op_assign
id|atixl_busmouse_init
c_func
(paren
id|kmem_start
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif /* !MODULE */
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|MOUSE_MAJOR
comma
l_string|&quot;mouse&quot;
comma
op_amp
id|mouse_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;unable to get major %d for mouse devices&bslash;n&quot;
comma
id|MOUSE_MAJOR
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef MODULE
r_return
l_int|0
suffix:semicolon
macro_line|#else
r_return
id|kmem_start
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|mouse_data
op_star
id|c
op_assign
id|mouse_list
comma
op_star
id|n
suffix:semicolon
r_if
c_cond
(paren
id|MOD_IN_USE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mouse: in use, remove delayed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|unregister_chrdev
c_func
(paren
id|MOUSE_MAJOR
comma
l_string|&quot;mouse&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|c
)paren
(brace
id|n
op_assign
id|c-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|c
)paren
suffix:semicolon
id|c
op_assign
id|n
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
