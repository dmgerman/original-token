multiline_comment|/*&n; * programming the msp34* sound processor family&n; *&n; * (c) 1997,1998 Gerd Knorr &lt;kraxel@cs.tu-berlin.de&gt;&n; *&n; * what works and what doesn&squot;t:&n; *&n; *  AM-Mono&n; *      probably doesn&squot;t (untested)&n; *&n; *  FM-Mono&n; *      should work. The stereo modes are backward compatible to FM-mono,&n; *      therefore FM-Mono should be allways available.&n; *&n; *  FM-Stereo (B/G, used in germany)&n; *      should work, with autodetect&n; *&n; *  FM-Stereo (satellite)&n; *      should work, no autodetect (i.e. default is mono, but you can&n; *      switch to stereo -- untested)&n; *&n; *  NICAM (B/G, used in UK, Scandinavia and Spain)&n; *      should work, with autodetect. Support for NICAM was added by&n; *      Pekka Pietikainen &lt;pp@netppl.fi&gt;&n; *&n; *&n; * TODO:&n; *   - better SAT support&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
multiline_comment|/* #include &lt;asm/smp_lock.h&gt; */
multiline_comment|/* kernel_thread */
DECL|macro|__KERNEL_SYSCALLS__
mdefine_line|#define __KERNEL_SYSCALLS__
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &quot;i2c.h&quot;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &quot;msp3400.h&quot;
multiline_comment|/* sound mixer stuff */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt; 0x020140 /* need modular sound driver */
macro_line|# if defined(CONFIG_SOUND) || defined(CONFIG_SOUND_MODULE)
DECL|macro|REGISTER_MIXER
macro_line|#  define REGISTER_MIXER 1
macro_line|# endif
macro_line|#endif
DECL|variable|debug
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* insmod parameter */
DECL|struct|msp3400c
r_struct
id|msp3400c
(brace
DECL|member|bus
r_struct
id|i2c_bus
op_star
id|bus
suffix:semicolon
DECL|member|nicam
r_int
id|nicam
suffix:semicolon
DECL|member|mode
r_int
id|mode
suffix:semicolon
DECL|member|norm
r_int
id|norm
suffix:semicolon
DECL|member|stereo
r_int
id|stereo
suffix:semicolon
DECL|member|mixer
r_int
id|mixer
suffix:semicolon
DECL|member|left
DECL|member|right
r_int
id|left
comma
id|right
suffix:semicolon
multiline_comment|/* volume */
DECL|member|bass
DECL|member|treble
r_int
id|bass
comma
id|treble
suffix:semicolon
multiline_comment|/* thread */
DECL|member|thread
r_struct
id|task_struct
op_star
id|thread
suffix:semicolon
DECL|member|wait
r_struct
id|semaphore
op_star
id|wait
suffix:semicolon
DECL|member|notify
r_struct
id|semaphore
op_star
id|notify
suffix:semicolon
DECL|member|active
DECL|member|restart
DECL|member|rmmod
r_int
id|active
comma
id|restart
comma
id|rmmod
suffix:semicolon
DECL|member|watch_stereo
r_int
id|watch_stereo
suffix:semicolon
DECL|member|wake_stereo
r_struct
id|timer_list
id|wake_stereo
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|VIDEO_MODE_RADIO
mdefine_line|#define VIDEO_MODE_RADIO 16      /* norm magic for radio mode */
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|macro|dprintk
mdefine_line|#define dprintk     if (debug) printk
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|macro|I2C_MSP3400C
mdefine_line|#define I2C_MSP3400C       0x80
DECL|macro|I2C_MSP3400C_DEM
mdefine_line|#define I2C_MSP3400C_DEM   0x10
DECL|macro|I2C_MSP3400C_DFP
mdefine_line|#define I2C_MSP3400C_DFP   0x12
multiline_comment|/* ----------------------------------------------------------------------- */
multiline_comment|/* functions for talking to the MSP3400C Sound processor                   */
DECL|function|msp3400c_reset
r_static
r_int
id|msp3400c_reset
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|mdelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|i2c_start
c_func
(paren
id|bus
)paren
suffix:semicolon
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|I2C_MSP3400C
comma
l_int|2000
)paren
suffix:semicolon
id|i2c_sendbyte
c_func
(paren
id|bus
comma
l_int|0x00
comma
l_int|0
)paren
suffix:semicolon
id|i2c_sendbyte
c_func
(paren
id|bus
comma
l_int|0x80
comma
l_int|0
)paren
suffix:semicolon
id|i2c_sendbyte
c_func
(paren
id|bus
comma
l_int|0x00
comma
l_int|0
)paren
suffix:semicolon
id|i2c_stop
c_func
(paren
id|bus
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|i2c_start
c_func
(paren
id|bus
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|I2C_MSP3400C
comma
l_int|2000
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
l_int|0x00
comma
l_int|0
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
l_int|0x00
comma
l_int|0
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
l_int|0x00
comma
l_int|0
)paren
)paren
(brace
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;msp3400: chip reset failed, penguin on i2c bus?&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|i2c_stop
c_func
(paren
id|bus
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|msp3400c_read
id|msp3400c_read
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|dev
comma
r_int
id|addr
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|val
op_assign
l_int|0
suffix:semicolon
id|i2c_start
c_func
(paren
id|bus
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|I2C_MSP3400C
comma
l_int|2000
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|dev
op_plus
l_int|1
comma
l_int|0
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|addr
op_rshift
l_int|8
comma
l_int|0
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|addr
op_amp
l_int|0xff
comma
l_int|0
)paren
)paren
(brace
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|i2c_start
c_func
(paren
id|bus
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|I2C_MSP3400C
op_plus
l_int|1
comma
l_int|2000
)paren
)paren
(brace
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|val
op_or_assign
(paren
r_int
)paren
id|i2c_readbyte
c_func
(paren
id|bus
comma
l_int|0
)paren
op_lshift
l_int|8
suffix:semicolon
id|val
op_or_assign
(paren
r_int
)paren
id|i2c_readbyte
c_func
(paren
id|bus
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|i2c_stop
c_func
(paren
id|bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_minus
l_int|1
op_eq
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;msp3400: I/O error, trying reset (read %s 0x%x)&bslash;n&quot;
comma
(paren
id|dev
op_eq
id|I2C_MSP3400C_DEM
)paren
ques
c_cond
l_string|&quot;Demod&quot;
suffix:colon
l_string|&quot;Audio&quot;
comma
id|addr
)paren
suffix:semicolon
id|msp3400c_reset
c_func
(paren
id|bus
)paren
suffix:semicolon
)brace
r_return
id|val
suffix:semicolon
)brace
r_static
r_int
DECL|function|msp3400c_write
id|msp3400c_write
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|dev
comma
r_int
id|addr
comma
r_int
id|val
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|i2c_start
c_func
(paren
id|bus
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|I2C_MSP3400C
comma
l_int|2000
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|dev
comma
l_int|0
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|addr
op_rshift
l_int|8
comma
l_int|0
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|addr
op_amp
l_int|0xff
comma
l_int|0
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|val
op_rshift
l_int|8
comma
l_int|0
)paren
op_logical_or
l_int|0
op_ne
id|i2c_sendbyte
c_func
(paren
id|bus
comma
id|val
op_amp
l_int|0xff
comma
l_int|0
)paren
)paren
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
id|i2c_stop
c_func
(paren
id|bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_minus
l_int|1
op_eq
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;msp3400: I/O error, trying reset (write %s 0x%x)&bslash;n&quot;
comma
(paren
id|dev
op_eq
id|I2C_MSP3400C_DEM
)paren
ques
c_cond
l_string|&quot;Demod&quot;
suffix:colon
l_string|&quot;Audio&quot;
comma
id|addr
)paren
suffix:semicolon
id|msp3400c_reset
c_func
(paren
id|bus
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------ */
multiline_comment|/* This macro is allowed for *constants* only, gcc must calculate it&n;   at compile time.  Remember -- no floats in kernel mode */
DECL|macro|MSP_CARRIER
mdefine_line|#define MSP_CARRIER(freq) ((int)((float)(freq/18.432)*(1&lt;&lt;24)))
DECL|macro|MSP_MODE_AM_DETECT
mdefine_line|#define MSP_MODE_AM_DETECT   0
DECL|macro|MSP_MODE_FM_RADIO
mdefine_line|#define MSP_MODE_FM_RADIO    2
DECL|macro|MSP_MODE_FM_TERRA
mdefine_line|#define MSP_MODE_FM_TERRA    3
DECL|macro|MSP_MODE_FM_SAT
mdefine_line|#define MSP_MODE_FM_SAT      4
DECL|macro|MSP_MODE_FM_NICAM1
mdefine_line|#define MSP_MODE_FM_NICAM1   5
DECL|macro|MSP_MODE_FM_NICAM2
mdefine_line|#define MSP_MODE_FM_NICAM2   6
DECL|struct|MSP_INIT_DATA_DEM
r_static
r_struct
id|MSP_INIT_DATA_DEM
(brace
DECL|member|fir1
r_int
id|fir1
(braket
l_int|6
)braket
suffix:semicolon
DECL|member|fir2
r_int
id|fir2
(braket
l_int|6
)braket
suffix:semicolon
DECL|member|cdo1
r_int
id|cdo1
suffix:semicolon
DECL|member|cdo2
r_int
id|cdo2
suffix:semicolon
DECL|member|ad_cv
r_int
id|ad_cv
suffix:semicolon
DECL|member|mode_reg
r_int
id|mode_reg
suffix:semicolon
DECL|member|dfp_src
r_int
id|dfp_src
suffix:semicolon
DECL|member|dfp_matrix
r_int
id|dfp_matrix
suffix:semicolon
DECL|variable|msp_init_data
)brace
id|msp_init_data
(braket
)braket
op_assign
(brace
multiline_comment|/* AM (for carrier detect / msp3400) */
(brace
(brace
l_int|75
comma
l_int|19
comma
l_int|36
comma
l_int|35
comma
l_int|39
comma
l_int|40
)brace
comma
(brace
l_int|75
comma
l_int|19
comma
l_int|36
comma
l_int|35
comma
l_int|39
comma
l_int|40
)brace
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
l_int|0x00d0
comma
l_int|0x0500
comma
l_int|0x0020
comma
l_int|0x3000
)brace
comma
multiline_comment|/* AM (for carrier detect / msp3410) */
(brace
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|8
comma
l_int|2
comma
l_int|59
comma
l_int|126
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|8
comma
l_int|2
comma
l_int|59
comma
l_int|126
)brace
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
l_int|0x00d0
comma
l_int|0x0100
comma
l_int|0x0020
comma
l_int|0x3000
)brace
comma
multiline_comment|/* FM Radio */
(brace
(brace
op_minus
l_int|8
comma
op_minus
l_int|8
comma
l_int|4
comma
l_int|6
comma
l_int|78
comma
l_int|107
)brace
comma
(brace
op_minus
l_int|8
comma
op_minus
l_int|8
comma
l_int|4
comma
l_int|6
comma
l_int|78
comma
l_int|107
)brace
comma
id|MSP_CARRIER
c_func
(paren
l_float|10.7
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|10.7
)paren
comma
l_int|0x00d0
comma
l_int|0x0480
comma
l_int|0x0020
comma
l_int|0x3002
)brace
comma
multiline_comment|/* Terrestial FM-mono */
(brace
(brace
l_int|3
comma
l_int|18
comma
l_int|27
comma
l_int|48
comma
l_int|66
comma
l_int|72
)brace
comma
(brace
l_int|3
comma
l_int|18
comma
l_int|27
comma
l_int|48
comma
l_int|66
comma
l_int|72
)brace
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
l_int|0x00d0
comma
l_int|0x0480
comma
l_int|0x0030
comma
l_int|0x3000
)brace
comma
multiline_comment|/* Sat FM-mono */
(brace
(brace
l_int|1
comma
l_int|9
comma
l_int|14
comma
l_int|24
comma
l_int|33
comma
l_int|37
)brace
comma
(brace
l_int|3
comma
l_int|18
comma
l_int|27
comma
l_int|48
comma
l_int|66
comma
l_int|72
)brace
comma
id|MSP_CARRIER
c_func
(paren
l_float|6.5
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|6.5
)paren
comma
l_int|0x00c6
comma
l_int|0x0480
comma
l_int|0x0000
comma
l_int|0x3000
)brace
comma
multiline_comment|/* NICAM B/G, D/K */
(brace
(brace
op_minus
l_int|2
comma
op_minus
l_int|8
comma
op_minus
l_int|10
comma
l_int|10
comma
l_int|50
comma
l_int|86
)brace
comma
(brace
l_int|3
comma
l_int|18
comma
l_int|27
comma
l_int|48
comma
l_int|66
comma
l_int|72
)brace
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
l_int|0x00d0
comma
l_int|0x0040
comma
l_int|0x0120
comma
l_int|0x3000
)brace
comma
multiline_comment|/* NICAM I */
(brace
(brace
l_int|2
comma
l_int|4
comma
op_minus
l_int|6
comma
op_minus
l_int|4
comma
l_int|40
comma
l_int|94
)brace
comma
(brace
l_int|3
comma
l_int|18
comma
l_int|27
comma
l_int|48
comma
l_int|66
comma
l_int|72
)brace
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
l_int|0x00d0
comma
l_int|0x0040
comma
l_int|0x0120
comma
l_int|0x3000
)brace
comma
)brace
suffix:semicolon
DECL|struct|CARRIER_DETECT
r_struct
id|CARRIER_DETECT
(brace
DECL|member|cdo
r_int
id|cdo
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|carrier_detect_main
r_static
r_struct
id|CARRIER_DETECT
id|carrier_detect_main
(braket
)braket
op_assign
(brace
multiline_comment|/* main carrier */
(brace
id|MSP_CARRIER
c_func
(paren
l_float|4.5
)paren
comma
l_string|&quot;4.5   NTSC&quot;
)brace
comma
(brace
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
comma
l_string|&quot;5.5   PAL B/G&quot;
)brace
comma
(brace
id|MSP_CARRIER
c_func
(paren
l_float|6.0
)paren
comma
l_string|&quot;6.0   PAL I&quot;
)brace
comma
(brace
id|MSP_CARRIER
c_func
(paren
l_float|6.5
)paren
comma
l_string|&quot;6.5   PAL SAT / SECAM&quot;
)brace
)brace
suffix:semicolon
DECL|variable|carrier_detect_55
r_static
r_struct
id|CARRIER_DETECT
id|carrier_detect_55
(braket
)braket
op_assign
(brace
multiline_comment|/* PAL B/G */
(brace
id|MSP_CARRIER
c_func
(paren
l_float|5.7421875
)paren
comma
l_string|&quot;5.742 PAL B/G FM-stereo&quot;
)brace
comma
(brace
id|MSP_CARRIER
c_func
(paren
l_float|5.85
)paren
comma
l_string|&quot;5.85  PAL B/G NICAM&quot;
)brace
)brace
suffix:semicolon
DECL|variable|carrier_detect_65
r_static
r_struct
id|CARRIER_DETECT
id|carrier_detect_65
(braket
)braket
op_assign
(brace
multiline_comment|/* PAL SAT / SECAM */
(brace
id|MSP_CARRIER
c_func
(paren
l_float|7.02
)paren
comma
l_string|&quot;7.02  PAL SAT FM-stereo s/b&quot;
)brace
comma
(brace
id|MSP_CARRIER
c_func
(paren
l_float|7.20
)paren
comma
l_string|&quot;7.20  PAL SAT FM-stereo s&quot;
)brace
comma
(brace
id|MSP_CARRIER
c_func
(paren
l_float|7.38
)paren
comma
l_string|&quot;7.38  PAL SAT FM-stereo b&quot;
)brace
comma
)brace
suffix:semicolon
DECL|macro|CARRIER_COUNT
mdefine_line|#define CARRIER_COUNT(x) (sizeof(x)/sizeof(struct CARRIER_DETECT))
multiline_comment|/* ------------------------------------------------------------------------ */
DECL|function|msp3400c_setcarrier
r_static
r_void
id|msp3400c_setcarrier
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|cdo1
comma
r_int
id|cdo2
)paren
(brace
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x0093
comma
id|cdo1
op_amp
l_int|0xfff
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x009b
comma
id|cdo1
op_rshift
l_int|12
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x00a3
comma
id|cdo2
op_amp
l_int|0xfff
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x00ab
comma
id|cdo2
op_rshift
l_int|12
)paren
suffix:semicolon
)brace
DECL|function|msp3400c_setvolume
r_static
r_void
id|msp3400c_setvolume
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|left
comma
r_int
id|right
)paren
(brace
r_int
id|vol
comma
id|val
comma
id|balance
suffix:semicolon
id|vol
op_assign
(paren
id|left
OG
id|right
)paren
ques
c_cond
id|left
suffix:colon
id|right
suffix:semicolon
id|val
op_assign
(paren
id|vol
op_star
l_int|0x73
op_div
l_int|65535
)paren
op_lshift
l_int|8
suffix:semicolon
id|balance
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vol
OG
l_int|0
)paren
id|balance
op_assign
(paren
(paren
id|right
op_minus
id|left
)paren
op_star
l_int|127
)paren
op_div
id|vol
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: setvolume: %d:%d 0x%02x 0x%02x&bslash;n&quot;
comma
id|left
comma
id|right
comma
id|val
op_rshift
l_int|8
comma
id|balance
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0000
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* loudspeaker */
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0006
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* headphones  */
multiline_comment|/* scart - on/off only */
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0007
comma
id|val
ques
c_cond
l_int|0x4000
suffix:colon
l_int|0
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0001
comma
id|balance
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
DECL|function|msp3400c_setbass
r_static
r_void
id|msp3400c_setbass
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|bass
)paren
(brace
r_int
id|val
op_assign
(paren
(paren
id|bass
op_minus
l_int|32768
)paren
op_star
l_int|0x60
op_div
l_int|65535
)paren
op_lshift
l_int|8
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: setbass: %d 0x%02x&bslash;n&quot;
comma
id|bass
comma
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0002
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* loudspeaker */
)brace
DECL|function|msp3400c_settreble
r_static
r_void
id|msp3400c_settreble
c_func
(paren
r_struct
id|i2c_bus
op_star
id|bus
comma
r_int
id|treble
)paren
(brace
r_int
id|val
op_assign
(paren
(paren
id|treble
op_minus
l_int|32768
)paren
op_star
l_int|0x60
op_div
l_int|65535
)paren
op_lshift
l_int|8
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: settreble: %d 0x%02x&bslash;n&quot;
comma
id|treble
comma
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0003
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* loudspeaker */
)brace
DECL|function|msp3400c_setmode
r_static
r_void
id|msp3400c_setmode
c_func
(paren
r_struct
id|msp3400c
op_star
id|msp
comma
r_int
id|type
)paren
(brace
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: setmode: %d&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
id|msp-&gt;mode
op_assign
id|type
suffix:semicolon
id|msp-&gt;stereo
op_assign
id|VIDEO_SOUND_MONO
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x00bb
comma
multiline_comment|/* ad_cv */
id|msp_init_data
(braket
id|type
)braket
dot
id|ad_cv
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|5
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
multiline_comment|/* fir 1 */
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x0001
comma
id|msp_init_data
(braket
id|type
)braket
dot
id|fir1
(braket
id|i
)braket
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x0005
comma
l_int|0x0004
)paren
suffix:semicolon
multiline_comment|/* fir 2 */
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x0005
comma
l_int|0x0040
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x0005
comma
l_int|0x0000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|5
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x0005
comma
id|msp_init_data
(braket
id|type
)braket
dot
id|fir2
(braket
id|i
)braket
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x0083
comma
multiline_comment|/* MODE_REG */
id|msp_init_data
(braket
id|type
)braket
dot
id|mode_reg
)paren
suffix:semicolon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|msp_init_data
(braket
id|type
)braket
dot
id|cdo1
comma
id|msp_init_data
(braket
id|type
)braket
dot
id|cdo2
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0008
comma
id|msp_init_data
(braket
id|type
)braket
dot
id|dfp_src
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0009
comma
id|msp_init_data
(braket
id|type
)braket
dot
id|dfp_src
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x000a
comma
id|msp_init_data
(braket
id|type
)braket
dot
id|dfp_src
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x000e
comma
id|msp_init_data
(braket
id|type
)braket
dot
id|dfp_matrix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;nicam
)paren
(brace
multiline_comment|/* msp3410 needs some more initialization */
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0010
comma
l_int|0x3000
)paren
suffix:semicolon
)brace
)brace
DECL|function|msp3400c_setstereo
r_static
r_void
id|msp3400c_setstereo
c_func
(paren
r_struct
id|msp3400c
op_star
id|msp
comma
r_int
id|mode
)paren
(brace
r_int
id|nicam
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* channel source: FM/AM or nicam */
multiline_comment|/* switch demodulator */
r_switch
c_cond
(paren
id|msp-&gt;mode
)paren
(brace
r_case
id|MSP_MODE_FM_TERRA
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: B/G setstereo: %d&bslash;n&quot;
comma
id|mode
)paren
suffix:semicolon
id|msp-&gt;stereo
op_assign
id|mode
suffix:semicolon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.7421875
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|VIDEO_SOUND_STEREO
suffix:colon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x000e
comma
l_int|0x3001
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_MONO
suffix:colon
r_case
id|VIDEO_SOUND_LANG1
suffix:colon
r_case
id|VIDEO_SOUND_LANG2
suffix:colon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x000e
comma
l_int|0x3000
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MSP_MODE_FM_SAT
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: sat setstereo: %d&bslash;n&quot;
comma
id|mode
)paren
suffix:semicolon
id|msp-&gt;stereo
op_assign
id|mode
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|VIDEO_SOUND_MONO
suffix:colon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|MSP_CARRIER
c_func
(paren
l_float|6.5
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|6.5
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_STEREO
suffix:colon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|MSP_CARRIER
c_func
(paren
l_float|7.2
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|7.02
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_LANG1
suffix:colon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|MSP_CARRIER
c_func
(paren
l_float|7.38
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|7.02
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_LANG2
suffix:colon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|MSP_CARRIER
c_func
(paren
l_float|7.38
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|7.02
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MSP_MODE_FM_NICAM1
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: NICAM1 setstereo: %d&bslash;n&quot;
comma
id|mode
)paren
suffix:semicolon
id|msp-&gt;stereo
op_assign
id|mode
suffix:semicolon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.85
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
)paren
suffix:semicolon
id|nicam
op_assign
l_int|0x0100
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* can&squot;t do stereo - abort here */
r_return
suffix:semicolon
)brace
multiline_comment|/* switch audio */
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|VIDEO_SOUND_STEREO
suffix:colon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0008
comma
l_int|0x0020
op_or
id|nicam
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0009
comma
l_int|0x0020
op_or
id|nicam
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x000a
comma
l_int|0x0020
op_or
id|nicam
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0005
comma
l_int|0x4000
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_MONO
suffix:colon
r_case
id|VIDEO_SOUND_LANG1
suffix:colon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0008
comma
l_int|0x0000
op_or
id|nicam
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0009
comma
l_int|0x0000
op_or
id|nicam
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x000a
comma
l_int|0x0000
op_or
id|nicam
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_SOUND_LANG2
suffix:colon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0008
comma
l_int|0x0010
op_or
id|nicam
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0009
comma
l_int|0x0010
op_or
id|nicam
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x000a
comma
l_int|0x0010
op_or
id|nicam
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|struct|REGISTER_DUMP
r_struct
id|REGISTER_DUMP
(brace
DECL|member|addr
r_int
id|addr
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|d1
r_struct
id|REGISTER_DUMP
id|d1
(braket
)braket
op_assign
(brace
(brace
l_int|0x007e
comma
l_string|&quot;autodetect&quot;
)brace
comma
(brace
l_int|0x0023
comma
l_string|&quot;C_AD_BITS &quot;
)brace
comma
(brace
l_int|0x0038
comma
l_string|&quot;ADD_BITS  &quot;
)brace
comma
(brace
l_int|0x003e
comma
l_string|&quot;CIB_BITS  &quot;
)brace
comma
(brace
l_int|0x0057
comma
l_string|&quot;ERROR_RATE&quot;
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * A kernel thread for msp3400 control -- we don&squot;t want to block the&n; * in the ioctl while doing the sound carrier &amp; stereo detect&n; */
DECL|function|msp3400c_stereo_wake
r_static
r_void
id|msp3400c_stereo_wake
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|msp3400c
op_star
id|msp
op_assign
(paren
r_struct
id|msp3400c
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* XXX alpha ??? */
r_if
c_cond
(paren
op_logical_neg
id|msp-&gt;active
)paren
id|up
c_func
(paren
id|msp-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|msp3400c_thread
r_static
r_int
id|msp3400c_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|msp3400c
op_star
id|msp
op_assign
id|data
suffix:semicolon
r_struct
id|semaphore
id|sem
op_assign
id|MUTEX_LOCKED
suffix:semicolon
r_struct
id|CARRIER_DETECT
op_star
id|cd
suffix:semicolon
r_int
id|count
comma
id|max1
comma
id|max2
comma
id|val1
comma
id|val2
comma
id|val
comma
id|this
suffix:semicolon
r_int
id|newstereo
suffix:semicolon
multiline_comment|/* lock_kernel(); */
id|exit_mm
c_func
(paren
id|current
)paren
suffix:semicolon
id|current-&gt;session
op_assign
l_int|1
suffix:semicolon
id|current-&gt;pgrp
op_assign
l_int|1
suffix:semicolon
id|sigfillset
c_func
(paren
op_amp
id|current-&gt;blocked
)paren
suffix:semicolon
id|current-&gt;fs-&gt;umask
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;msp3400&quot;
)paren
suffix:semicolon
id|msp-&gt;wait
op_assign
op_amp
id|sem
suffix:semicolon
id|msp-&gt;thread
op_assign
id|current
suffix:semicolon
multiline_comment|/* unlock_kernel(); */
id|dprintk
c_func
(paren
l_string|&quot;msp3400: thread: start&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;notify
op_ne
l_int|NULL
)paren
(brace
id|up
c_func
(paren
id|msp-&gt;notify
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|msp-&gt;rmmod
)paren
r_goto
id|done
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: thread: sleep&bslash;n&quot;
)paren
suffix:semicolon
id|down_interruptible
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: thread: wakeup&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;rmmod
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|VIDEO_MODE_RADIO
op_eq
id|msp-&gt;norm
)paren
r_continue
suffix:semicolon
multiline_comment|/* nothing to do */
id|msp-&gt;active
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;watch_stereo
)paren
(brace
multiline_comment|/* do that stereo/multilang handling */
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|newstereo
op_assign
id|msp-&gt;stereo
suffix:semicolon
r_switch
c_cond
(paren
id|msp-&gt;mode
)paren
(brace
r_case
id|MSP_MODE_FM_TERRA
suffix:colon
id|val
op_assign
id|msp3400c_read
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x18
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: stereo detect register: %d&bslash;n&quot;
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
l_int|4096
)paren
(brace
id|newstereo
op_assign
id|VIDEO_SOUND_STEREO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|val
OL
op_minus
l_int|4096
)paren
(brace
id|newstereo
op_assign
id|VIDEO_SOUND_LANG1
suffix:semicolon
)brace
r_else
(brace
id|newstereo
op_assign
id|VIDEO_SOUND_MONO
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MSP_MODE_FM_NICAM1
suffix:colon
id|val
op_assign
id|msp3400c_read
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DEM
comma
l_int|0x23
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|val
op_amp
l_int|0x1e
)paren
op_rshift
l_int|1
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|8
suffix:colon
id|newstereo
op_assign
id|VIDEO_SOUND_STEREO
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|newstereo
op_assign
id|VIDEO_SOUND_MONO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msp-&gt;stereo
op_ne
id|newstereo
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;msp3400: watch: stereo %d ==&gt; %d&bslash;n&quot;
comma
id|msp-&gt;stereo
comma
id|newstereo
)paren
suffix:semicolon
id|msp3400c_setstereo
c_func
(paren
id|msp
comma
id|newstereo
)paren
suffix:semicolon
)brace
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;watch_stereo
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|msp-&gt;wake_stereo
)paren
suffix:semicolon
id|msp-&gt;wake_stereo.expires
op_assign
id|jiffies
op_plus
l_int|5
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|msp-&gt;wake_stereo
)paren
suffix:semicolon
)brace
id|msp-&gt;active
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|restart
suffix:colon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_setvolume
c_func
(paren
id|msp-&gt;bus
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|msp3400c_setmode
c_func
(paren
id|msp
comma
id|MSP_MODE_AM_DETECT
)paren
suffix:semicolon
id|val1
op_assign
id|val2
op_assign
id|max1
op_assign
id|max2
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|msp-&gt;wake_stereo
)paren
suffix:semicolon
id|msp-&gt;watch_stereo
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* carrier detect pass #1 -- main carrier */
id|cd
op_assign
id|carrier_detect_main
suffix:semicolon
id|count
op_assign
id|CARRIER_COUNT
c_func
(paren
id|carrier_detect_main
)paren
suffix:semicolon
r_for
c_loop
(paren
id|this
op_assign
l_int|0
suffix:semicolon
id|this
OL
id|count
suffix:semicolon
id|this
op_increment
)paren
(brace
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|cd
(braket
id|this
)braket
dot
id|cdo
comma
id|cd
(braket
id|this
)braket
dot
id|cdo
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|25
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;restart
)paren
(brace
id|msp-&gt;restart
op_assign
l_int|0
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|val
op_assign
id|msp3400c_read
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x1b
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val1
OL
id|val
)paren
id|val1
op_assign
id|val
comma
id|max1
op_assign
id|this
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: carrier1 val: %5d / %s&bslash;n&quot;
comma
id|val
comma
id|cd
(braket
id|this
)braket
dot
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/* carrier detect pass #2 -- second (stereo) carrier */
r_switch
c_cond
(paren
id|max1
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* 5.5 */
id|cd
op_assign
id|carrier_detect_55
suffix:semicolon
id|count
op_assign
id|CARRIER_COUNT
c_func
(paren
id|carrier_detect_55
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* 6.5 */
id|cd
op_assign
id|carrier_detect_65
suffix:semicolon
id|count
op_assign
id|CARRIER_COUNT
c_func
(paren
id|carrier_detect_65
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
multiline_comment|/* 4.5 */
r_case
l_int|2
suffix:colon
multiline_comment|/* 6.0 */
r_default
suffix:colon
id|cd
op_assign
l_int|NULL
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|this
op_assign
l_int|0
suffix:semicolon
id|this
OL
id|count
suffix:semicolon
id|this
op_increment
)paren
(brace
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|cd
(braket
id|this
)braket
dot
id|cdo
comma
id|cd
(braket
id|this
)braket
dot
id|cdo
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|25
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;restart
)paren
(brace
id|msp-&gt;restart
op_assign
l_int|0
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|val
op_assign
id|msp3400c_read
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x1b
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val2
OL
id|val
)paren
id|val2
op_assign
id|val
comma
id|max2
op_assign
id|this
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: carrier2 val: %5d / %s&bslash;n&quot;
comma
id|val
comma
id|cd
(braket
id|this
)braket
dot
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/* programm the msp3400 according to the results */
r_switch
c_cond
(paren
id|max1
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* 4.5 */
r_case
l_int|1
suffix:colon
multiline_comment|/* 5.5 */
id|msp3400c_setmode
c_func
(paren
id|msp
comma
id|MSP_MODE_FM_TERRA
)paren
suffix:semicolon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|carrier_detect_main
(braket
id|max1
)braket
dot
id|cdo
comma
id|carrier_detect_main
(braket
id|max1
)braket
dot
id|cdo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max2
op_eq
l_int|0
)paren
(brace
multiline_comment|/* B/G FM-stereo */
id|msp3400c_setstereo
c_func
(paren
id|msp
comma
id|VIDEO_SOUND_MONO
)paren
suffix:semicolon
id|msp-&gt;watch_stereo
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|max2
op_eq
l_int|1
op_logical_and
id|msp-&gt;nicam
)paren
(brace
multiline_comment|/* B/G NICAM */
id|msp3400c_setmode
c_func
(paren
id|msp
comma
id|MSP_MODE_FM_NICAM1
)paren
suffix:semicolon
multiline_comment|/* msp3400c_write(msp-&gt;bus, I2C_MSP3400C_DFP, 0x21, 0x01); */
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.85
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|5.5
)paren
)paren
suffix:semicolon
id|msp-&gt;watch_stereo
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* 6.0 */
r_case
l_int|3
suffix:colon
multiline_comment|/* 6.5 */
r_default
suffix:colon
id|msp3400c_setmode
c_func
(paren
id|msp
comma
id|MSP_MODE_FM_TERRA
)paren
suffix:semicolon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|carrier_detect_main
(braket
id|max1
)braket
dot
id|cdo
comma
id|carrier_detect_main
(braket
id|max1
)braket
dot
id|cdo
)paren
suffix:semicolon
id|msp3400c_setstereo
c_func
(paren
id|msp
comma
id|VIDEO_SOUND_STEREO
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* unmute */
id|msp3400c_setvolume
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;left
comma
id|msp-&gt;right
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;watch_stereo
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|msp-&gt;wake_stereo
)paren
suffix:semicolon
id|msp-&gt;wake_stereo.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|msp-&gt;wake_stereo
)paren
suffix:semicolon
)brace
id|msp-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
id|done
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;msp3400: thread: exit&bslash;n&quot;
)paren
suffix:semicolon
id|msp-&gt;wait
op_assign
l_int|NULL
suffix:semicolon
id|msp-&gt;active
op_assign
l_int|0
suffix:semicolon
id|msp-&gt;thread
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;notify
op_ne
l_int|NULL
)paren
(brace
id|up
c_func
(paren
id|msp-&gt;notify
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 0 /* not finished yet */
r_static
r_int
id|msp3410d_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|msp3400c
op_star
id|msp
op_assign
id|data
suffix:semicolon
r_struct
id|semaphore
id|sem
op_assign
id|MUTEX_LOCKED
suffix:semicolon
r_int
id|i
comma
id|val
suffix:semicolon
multiline_comment|/* lock_kernel(); */
id|exit_mm
c_func
(paren
id|current
)paren
suffix:semicolon
id|current-&gt;session
op_assign
l_int|1
suffix:semicolon
id|current-&gt;pgrp
op_assign
l_int|1
suffix:semicolon
id|sigfillset
c_func
(paren
op_amp
id|current-&gt;blocked
)paren
suffix:semicolon
id|current-&gt;fs-&gt;umask
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;msp3410 (nicam)&quot;
)paren
suffix:semicolon
id|msp-&gt;wait
op_assign
op_amp
id|sem
suffix:semicolon
id|msp-&gt;thread
op_assign
id|current
suffix:semicolon
multiline_comment|/* unlock_kernel(); */
id|dprintk
c_func
(paren
l_string|&quot;msp3410: thread: start&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;notify
op_ne
l_int|NULL
)paren
(brace
id|up
c_func
(paren
id|msp-&gt;notify
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|msp-&gt;rmmod
)paren
r_goto
id|done
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3410: thread: sleep&bslash;n&quot;
)paren
suffix:semicolon
id|down_interruptible
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;msp3410: thread: wakeup&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;rmmod
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|VIDEO_MODE_RADIO
op_eq
id|msp-&gt;norm
)paren
r_continue
suffix:semicolon
multiline_comment|/* nothing to do */
id|msp-&gt;active
op_assign
l_int|1
suffix:semicolon
id|restart
suffix:colon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* mute */
id|msp3400c_setvolume
c_func
(paren
id|msp-&gt;bus
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* quick &amp; dirty hack:&n;&t;&t;   get the audio proccessor into some useful state */
id|msp3400c_setmode
c_func
(paren
id|msp
comma
id|MSP_MODE_FM_NICAM1
)paren
suffix:semicolon
multiline_comment|/* kick autodetect */
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x20
comma
l_int|0x01
)paren
suffix:semicolon
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x21
comma
l_int|0x01
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* wait 1 sec */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|current-&gt;timeout
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;restart
)paren
(brace
id|msp-&gt;restart
op_assign
l_int|0
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* debug register dump */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|d1
)paren
op_div
r_sizeof
(paren
r_struct
id|REGISTER_DUMP
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|val
op_assign
id|msp3400c_read
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DEM
comma
id|d1
(braket
id|i
)braket
dot
id|addr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;msp3400: %s = 0x%x&bslash;n&quot;
comma
id|d1
(braket
id|i
)braket
dot
id|name
comma
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/* unmute */
id|msp3400c_setvolume
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;volume
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
id|done
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;msp3410: thread: exit&bslash;n&quot;
)paren
suffix:semicolon
id|msp-&gt;wait
op_assign
l_int|NULL
suffix:semicolon
id|msp-&gt;active
op_assign
l_int|0
suffix:semicolon
id|msp-&gt;thread
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;notify
op_ne
l_int|NULL
)paren
(brace
id|up
c_func
(paren
id|msp-&gt;notify
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* ----------------------------------------------------------------------- */
multiline_comment|/* mixer stuff -- with the modular sound driver in 2.1.x we can easily     */
multiline_comment|/* register the msp3400 as mixer device                                    */
macro_line|#ifdef REGISTER_MIXER
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;../drivers/sound/sound_config.h&gt;
macro_line|#include &lt;../drivers/sound/dev_table.h&gt;
DECL|function|mix_to_v4l
r_static
r_int
id|mix_to_v4l
c_func
(paren
r_int
id|i
)paren
(brace
r_int
id|r
suffix:semicolon
id|r
op_assign
(paren
(paren
id|i
op_amp
l_int|0xff
)paren
op_star
l_int|65536
op_plus
l_int|50
)paren
op_div
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|r
OG
l_int|65535
)paren
id|r
op_assign
l_int|65535
suffix:semicolon
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
id|r
op_assign
l_int|0
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|v4l_to_mix
r_static
r_int
id|v4l_to_mix
c_func
(paren
r_int
id|i
)paren
(brace
r_int
id|r
suffix:semicolon
id|r
op_assign
(paren
id|i
op_star
l_int|100
op_plus
l_int|32768
)paren
op_div
l_int|65536
suffix:semicolon
r_if
c_cond
(paren
id|r
OG
l_int|100
)paren
id|r
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
id|r
op_assign
l_int|0
suffix:semicolon
r_return
id|r
op_or
(paren
id|r
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
DECL|function|v4l_to_mix2
r_static
r_int
id|v4l_to_mix2
c_func
(paren
r_int
id|l
comma
r_int
id|r
)paren
(brace
id|r
op_assign
(paren
id|r
op_star
l_int|100
op_plus
l_int|32768
)paren
op_div
l_int|65536
suffix:semicolon
r_if
c_cond
(paren
id|r
OG
l_int|100
)paren
id|r
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
id|r
op_assign
l_int|0
suffix:semicolon
id|l
op_assign
(paren
id|l
op_star
l_int|100
op_plus
l_int|32768
)paren
op_div
l_int|65536
suffix:semicolon
r_if
c_cond
(paren
id|l
OG
l_int|100
)paren
id|l
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
id|l
OL
l_int|0
)paren
id|l
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|r
op_lshift
l_int|8
)paren
op_or
id|l
suffix:semicolon
)brace
DECL|function|msp3400c_mixer_ioctl
r_static
r_int
id|msp3400c_mixer_ioctl
c_func
(paren
r_int
id|dev
comma
r_int
r_int
id|cmd
comma
id|caddr_t
id|arg
)paren
(brace
r_struct
id|msp3400c
op_star
id|msp
op_assign
id|mixer_devs
(braket
id|dev
)braket
op_member_access_from_pointer
id|devc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
comma
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|_SIOC_DIR
c_func
(paren
id|cmd
)paren
op_amp
id|_SIOC_WRITE
)paren
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_RECMASK
)paren
suffix:colon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_CAPS
)paren
suffix:colon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_RECSRC
)paren
suffix:colon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_RECSRC
)paren
suffix:colon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_STEREODEVS
)paren
suffix:colon
id|ret
op_assign
id|SOUND_MASK_VOLUME
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_DEVMASK
)paren
suffix:colon
id|ret
op_assign
id|SOUND_MASK_VOLUME
op_or
id|SOUND_MASK_BASS
op_or
id|SOUND_MASK_TREBLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_VOLUME
)paren
suffix:colon
id|msp-&gt;left
op_assign
id|mix_to_v4l
c_func
(paren
id|val
)paren
suffix:semicolon
id|msp-&gt;right
op_assign
id|mix_to_v4l
c_func
(paren
id|val
op_rshift
l_int|8
)paren
suffix:semicolon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_setvolume
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;left
comma
id|msp-&gt;right
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* fall */
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_VOLUME
)paren
suffix:colon
id|ret
op_assign
id|v4l_to_mix2
c_func
(paren
id|msp-&gt;left
comma
id|msp-&gt;right
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_BASS
)paren
suffix:colon
id|msp-&gt;bass
op_assign
id|mix_to_v4l
c_func
(paren
id|val
)paren
suffix:semicolon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_setbass
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;bass
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* fall */
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_BASS
)paren
suffix:colon
id|ret
op_assign
id|v4l_to_mix
c_func
(paren
id|msp-&gt;bass
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_TREBLE
)paren
suffix:colon
id|msp-&gt;treble
op_assign
id|mix_to_v4l
c_func
(paren
id|val
)paren
suffix:semicolon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_settreble
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;treble
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
multiline_comment|/* fall */
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_TREBLE
)paren
suffix:colon
id|ret
op_assign
id|v4l_to_mix
c_func
(paren
id|msp-&gt;treble
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|ret
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|msp3400c_mixer
r_struct
id|mixer_operations
id|msp3400c_mixer
op_assign
(brace
l_string|&quot;video4linux&quot;
comma
l_string|&quot;TV card sound (msp3400)&quot;
comma
id|msp3400c_mixer_ioctl
)brace
suffix:semicolon
DECL|function|msp3400c_mixer_init
r_static
r_int
id|msp3400c_mixer_init
c_func
(paren
r_struct
id|msp3400c
op_star
id|msp
)paren
(brace
r_int
id|m
suffix:semicolon
id|msp-&gt;mixer
op_assign
id|m
op_assign
id|sound_alloc_mixerdev
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|mixer_devs
(braket
id|m
)braket
op_assign
(paren
r_struct
id|mixer_operations
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mixer_operations
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mixer_devs
(braket
id|m
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;msp3400c: can&squot;t allocate memory&bslash;n&quot;
)paren
suffix:semicolon
id|sound_unload_mixerdev
c_func
(paren
id|m
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|mixer_devs
(braket
id|m
)braket
comma
op_amp
id|msp3400c_mixer
comma
r_sizeof
(paren
r_struct
id|mixer_operations
)paren
)paren
suffix:semicolon
id|mixer_devs
(braket
id|m
)braket
op_member_access_from_pointer
id|devc
op_assign
id|msp
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|msp3400c_mixer_close
r_static
r_int
id|msp3400c_mixer_close
c_func
(paren
r_struct
id|msp3400c
op_star
id|msp
)paren
(brace
r_int
id|m
op_assign
id|msp-&gt;mixer
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ne
op_minus
l_int|1
)paren
(brace
id|sound_unload_mixerdev
c_func
(paren
id|m
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mixer_devs
(braket
id|m
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|function|msp3400c_attach
r_static
r_int
id|msp3400c_attach
c_func
(paren
r_struct
id|i2c_device
op_star
id|device
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|semaphore
id|sem
op_assign
id|MUTEX_LOCKED
suffix:semicolon
r_struct
id|msp3400c
op_star
id|msp
suffix:semicolon
r_int
id|rev1
comma
id|rev2
suffix:semicolon
id|device-&gt;data
op_assign
id|msp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|msp3400c
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|msp
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|msp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|msp3400c
)paren
)paren
suffix:semicolon
id|msp-&gt;bus
op_assign
id|device-&gt;bus
suffix:semicolon
id|msp-&gt;left
op_assign
l_int|65535
suffix:semicolon
id|msp-&gt;right
op_assign
l_int|65535
suffix:semicolon
id|msp-&gt;bass
op_assign
l_int|32768
suffix:semicolon
id|msp-&gt;treble
op_assign
l_int|32768
suffix:semicolon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_minus
l_int|1
op_eq
id|msp3400c_reset
c_func
(paren
id|msp-&gt;bus
)paren
)paren
(brace
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|msp
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|msp3400c_setmode
c_func
(paren
id|msp
comma
id|MSP_MODE_FM_TERRA
)paren
suffix:semicolon
id|msp3400c_setvolume
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;left
comma
id|msp-&gt;right
)paren
suffix:semicolon
id|msp3400c_setbass
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;bass
)paren
suffix:semicolon
id|msp3400c_settreble
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;treble
)paren
suffix:semicolon
id|rev1
op_assign
id|msp3400c_read
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x1e
)paren
suffix:semicolon
id|rev2
op_assign
id|msp3400c_read
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x1f
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* this will turn on a 1kHz beep - might be useful for debugging... */
id|msp3400c_write
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x0014
comma
l_int|0x1040
)paren
suffix:semicolon
macro_line|#endif
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|device-&gt;name
comma
l_string|&quot;MSP34%02d%c-%c%d&quot;
comma
(paren
id|rev2
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
(paren
id|rev1
op_amp
l_int|0xff
)paren
op_plus
l_char|&squot;@&squot;
comma
(paren
(paren
id|rev1
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_plus
l_char|&squot;@&squot;
comma
id|rev2
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|msp-&gt;nicam
op_assign
(paren
(paren
(paren
id|rev2
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
op_eq
l_int|10
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* timer for stereo checking */
id|msp-&gt;wake_stereo.function
op_assign
id|msp3400c_stereo_wake
suffix:semicolon
id|msp-&gt;wake_stereo.data
op_assign
(paren
r_int
r_int
)paren
id|msp
suffix:semicolon
multiline_comment|/* startup control thread */
id|MOD_INC_USE_COUNT
suffix:semicolon
id|msp-&gt;notify
op_assign
op_amp
id|sem
suffix:semicolon
id|kernel_thread
c_func
(paren
id|msp3400c_thread
comma
(paren
r_void
op_star
)paren
id|msp
comma
l_int|0
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
id|msp-&gt;notify
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msp-&gt;active
)paren
id|up
c_func
(paren
id|msp-&gt;wait
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;msp3400: init: chip=%s&quot;
comma
id|device-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;nicam
)paren
id|printk
c_func
(paren
l_string|&quot;, has NICAM support&quot;
)paren
suffix:semicolon
macro_line|#ifdef REGISTER_MIXER
r_if
c_cond
(paren
l_int|0
op_eq
id|msp3400c_mixer_init
c_func
(paren
id|msp
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;, registered as sound mixer&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|msp3400c_detach
r_static
r_int
id|msp3400c_detach
c_func
(paren
r_struct
id|i2c_device
op_star
id|device
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|semaphore
id|sem
op_assign
id|MUTEX_LOCKED
suffix:semicolon
r_struct
id|msp3400c
op_star
id|msp
op_assign
(paren
r_struct
id|msp3400c
op_star
)paren
id|device-&gt;data
suffix:semicolon
macro_line|#ifdef REGISTER_MIXER
id|msp3400c_mixer_close
c_func
(paren
id|msp
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* shutdown control thread */
id|del_timer
c_func
(paren
op_amp
id|msp-&gt;wake_stereo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msp-&gt;thread
)paren
(brace
id|msp-&gt;notify
op_assign
op_amp
id|sem
suffix:semicolon
id|msp-&gt;rmmod
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msp-&gt;active
)paren
id|up
c_func
(paren
id|msp-&gt;wait
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sem
)paren
suffix:semicolon
id|msp-&gt;notify
op_assign
l_int|NULL
suffix:semicolon
)brace
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_reset
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|msp
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|msp3400c_command
r_static
r_int
id|msp3400c_command
c_func
(paren
r_struct
id|i2c_device
op_star
id|device
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|msp3400c
op_star
id|msp
op_assign
(paren
r_struct
id|msp3400c
op_star
)paren
id|device-&gt;data
suffix:semicolon
r_int
op_star
id|iarg
op_assign
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MSP_SET_RADIO
suffix:colon
id|msp-&gt;norm
op_assign
id|VIDEO_MODE_RADIO
suffix:semicolon
id|msp-&gt;watch_stereo
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|msp-&gt;wake_stereo
)paren
suffix:semicolon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_setmode
c_func
(paren
id|msp
comma
id|MSP_MODE_FM_RADIO
)paren
suffix:semicolon
id|msp3400c_setcarrier
c_func
(paren
id|msp-&gt;bus
comma
id|MSP_CARRIER
c_func
(paren
l_float|10.7
)paren
comma
id|MSP_CARRIER
c_func
(paren
l_float|10.7
)paren
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_SET_TVNORM
suffix:colon
id|msp-&gt;norm
op_assign
op_star
id|iarg
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_NEWCHANNEL
suffix:colon
id|msp-&gt;watch_stereo
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|msp-&gt;wake_stereo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msp-&gt;active
)paren
id|up
c_func
(paren
id|msp-&gt;wait
)paren
suffix:semicolon
r_else
id|msp-&gt;restart
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_GET_VOLUME
suffix:colon
op_star
id|iarg
op_assign
(paren
id|msp-&gt;left
OG
id|msp-&gt;right
)paren
ques
c_cond
id|msp-&gt;left
suffix:colon
id|msp-&gt;right
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_SET_VOLUME
suffix:colon
id|msp-&gt;left
op_assign
id|msp-&gt;right
op_assign
op_star
id|iarg
suffix:semicolon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_setvolume
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;left
comma
id|msp-&gt;right
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_GET_BASS
suffix:colon
op_star
id|iarg
op_assign
id|msp-&gt;bass
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_SET_BASS
suffix:colon
id|msp-&gt;bass
op_assign
op_star
id|iarg
suffix:semicolon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_setbass
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;bass
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_GET_TREBLE
suffix:colon
op_star
id|iarg
op_assign
id|msp-&gt;treble
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_SET_TREBLE
suffix:colon
id|msp-&gt;treble
op_assign
op_star
id|iarg
suffix:semicolon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_settreble
c_func
(paren
id|msp-&gt;bus
comma
id|msp-&gt;treble
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_GET_STEREO
suffix:colon
op_star
id|iarg
op_assign
id|msp-&gt;stereo
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MSP_SET_STEREO
suffix:colon
r_if
c_cond
(paren
op_star
id|iarg
)paren
(brace
id|msp-&gt;watch_stereo
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|msp-&gt;wake_stereo
)paren
suffix:semicolon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
id|msp3400c_setstereo
c_func
(paren
id|msp
comma
op_star
id|iarg
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MSP_GET_DC
suffix:colon
id|LOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
op_star
id|iarg
op_assign
(paren
r_int
)paren
id|msp3400c_read
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x1b
)paren
op_plus
(paren
r_int
)paren
id|msp3400c_read
c_func
(paren
id|msp-&gt;bus
comma
id|I2C_MSP3400C_DFP
comma
l_int|0x1c
)paren
suffix:semicolon
id|UNLOCK_I2C_BUS
c_func
(paren
id|msp-&gt;bus
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|variable|i2c_driver_msp
r_struct
id|i2c_driver
id|i2c_driver_msp
op_assign
(brace
l_string|&quot;msp3400&quot;
comma
multiline_comment|/* name       */
id|I2C_DRIVERID_MSP3400
comma
multiline_comment|/* ID         */
id|I2C_MSP3400C
comma
id|I2C_MSP3400C
comma
multiline_comment|/* addr range */
id|msp3400c_attach
comma
id|msp3400c_detach
comma
id|msp3400c_command
)brace
suffix:semicolon
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|msp3400c_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
id|i2c_register_driver
c_func
(paren
op_amp
id|i2c_driver_msp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|i2c_unregister_driver
c_func
(paren
op_amp
id|i2c_driver_msp
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
