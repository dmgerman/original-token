multiline_comment|/*&n; *&t;$Id: scan_keyb.c,v 1.2 2000/07/04 06:24:42 yaegashi Exp $ &n; *&t;Copyright (C) 2000 YAEGASHI Takeshi&n; *&t;Generic scan keyboard driver&n; */
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kbd_ll.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/kbd_kern.h&gt;
DECL|struct|scan_keyboard
r_struct
id|scan_keyboard
(brace
DECL|member|next
r_struct
id|scan_keyboard
op_star
id|next
suffix:semicolon
DECL|member|scan
r_void
(paren
op_star
id|scan
)paren
(paren
r_int
r_char
op_star
id|buffer
)paren
suffix:semicolon
DECL|member|table
r_const
r_int
r_char
op_star
id|table
suffix:semicolon
DECL|member|s0
DECL|member|s1
r_int
r_char
op_star
id|s0
comma
op_star
id|s1
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|keyboards
r_static
r_struct
id|scan_keyboard
op_star
id|keyboards
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|task_scan_kbd
r_static
r_struct
id|tq_struct
id|task_scan_kbd
suffix:semicolon
DECL|function|check_kbd
r_static
r_void
id|check_kbd
c_func
(paren
r_const
r_int
r_char
op_star
id|table
comma
r_int
r_char
op_star
r_new
comma
r_int
r_char
op_star
id|old
comma
r_int
id|length
)paren
(brace
r_int
id|need_tasklet_schedule
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_xor
comma
id|bit
suffix:semicolon
r_while
c_loop
(paren
id|length
op_decrement
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
op_xor
op_assign
op_star
r_new
op_xor
op_star
id|old
)paren
op_eq
l_int|0
)paren
(brace
id|table
op_add_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|bit
op_assign
l_int|0x80
suffix:semicolon
id|bit
op_ne
l_int|0
suffix:semicolon
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_xor
op_amp
id|bit
)paren
(brace
id|handle_scancode
c_func
(paren
op_star
id|table
comma
op_logical_neg
(paren
op_star
r_new
op_amp
id|bit
)paren
)paren
suffix:semicolon
id|need_tasklet_schedule
op_assign
l_int|1
suffix:semicolon
)brace
id|table
op_increment
suffix:semicolon
)brace
)brace
r_new
op_increment
suffix:semicolon
id|old
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|need_tasklet_schedule
)paren
(brace
id|tasklet_schedule
c_func
(paren
op_amp
id|keyboard_tasklet
)paren
suffix:semicolon
)brace
)brace
DECL|function|scan_kbd
r_static
r_void
id|scan_kbd
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
r_struct
id|scan_keyboard
op_star
id|kbd
suffix:semicolon
r_for
c_loop
(paren
id|kbd
op_assign
id|keyboards
suffix:semicolon
id|kbd
op_ne
l_int|NULL
suffix:semicolon
id|kbd
op_assign
id|kbd-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|jiffies
op_amp
l_int|1
)paren
(brace
id|kbd
op_member_access_from_pointer
id|scan
c_func
(paren
id|kbd-&gt;s0
)paren
suffix:semicolon
id|check_kbd
c_func
(paren
id|kbd-&gt;table
comma
id|kbd-&gt;s0
comma
id|kbd-&gt;s1
comma
id|kbd-&gt;length
)paren
suffix:semicolon
)brace
r_else
(brace
id|kbd
op_member_access_from_pointer
id|scan
c_func
(paren
id|kbd-&gt;s1
)paren
suffix:semicolon
id|check_kbd
c_func
(paren
id|kbd-&gt;table
comma
id|kbd-&gt;s1
comma
id|kbd-&gt;s0
comma
id|kbd-&gt;length
)paren
suffix:semicolon
)brace
)brace
id|queue_task
c_func
(paren
op_amp
id|task_scan_kbd
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
DECL|function|register_scan_keyboard
r_int
id|register_scan_keyboard
c_func
(paren
r_void
(paren
op_star
id|scan
)paren
(paren
r_int
r_char
op_star
id|buffer
)paren
comma
r_const
r_int
r_char
op_star
id|table
comma
r_int
id|length
)paren
(brace
r_struct
id|scan_keyboard
op_star
id|kbd
suffix:semicolon
id|kbd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scan_keyboard
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd
op_eq
l_int|NULL
)paren
r_goto
id|error_out
suffix:semicolon
id|kbd-&gt;scan
op_assign
id|scan
suffix:semicolon
id|kbd-&gt;table
op_assign
id|table
suffix:semicolon
id|kbd-&gt;length
op_assign
id|length
suffix:semicolon
id|kbd-&gt;s0
op_assign
id|kmalloc
c_func
(paren
id|length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd-&gt;s0
op_eq
l_int|NULL
)paren
r_goto
id|error_free_kbd
suffix:semicolon
id|kbd-&gt;s1
op_assign
id|kmalloc
c_func
(paren
id|length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd-&gt;s1
op_eq
l_int|NULL
)paren
r_goto
id|error_free_s0
suffix:semicolon
id|kbd
op_member_access_from_pointer
id|scan
c_func
(paren
id|kbd-&gt;s0
)paren
suffix:semicolon
id|kbd
op_member_access_from_pointer
id|scan
c_func
(paren
id|kbd-&gt;s1
)paren
suffix:semicolon
id|kbd-&gt;next
op_assign
id|keyboards
suffix:semicolon
id|keyboards
op_assign
id|kbd
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error_free_s0
suffix:colon
id|kfree
c_func
(paren
id|kbd-&gt;s0
)paren
suffix:semicolon
id|error_free_kbd
suffix:colon
id|kfree
c_func
(paren
id|kbd
)paren
suffix:semicolon
id|error_out
suffix:colon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|scan_kbd_init
r_void
id|__init
id|scan_kbd_init
c_func
(paren
r_void
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
id|task_scan_kbd.list
)paren
suffix:semicolon
id|task_scan_kbd.sync
op_assign
l_int|0
suffix:semicolon
id|task_scan_kbd.routine
op_assign
id|scan_kbd
suffix:semicolon
id|task_scan_kbd.data
op_assign
l_int|NULL
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|task_scan_kbd
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Generic scan keyboard driver initialized&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
