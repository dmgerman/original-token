multiline_comment|/*&n; * Microsoft busmouse driver based on Logitech driver (see busmouse.c)&n; *&n; * Microsoft BusMouse support by Teemu Rantanen (tvr@cs.hut.fi) (02AUG92)&n; *&n; * Microsoft Bus Mouse support modified by Derrick Cole (cole@concert.net)&n; *    8/28/92&n; *&n; * Microsoft Bus Mouse support folded into 0.97pl4 code&n; *    by Peter Cervasio (pete%q106fm.uucp@wupost.wustl.edu) (08SEP92)&n; * Changes:  Logitech and Microsoft support in the same kernel.&n; *           Defined new constants in busmouse.h for MS mice.&n; *           Added int mse_busmouse_type to distinguish busmouse types&n; *           Added a couple of new functions to handle differences in using&n; *             MS vs. Logitech (where the int variable wasn&squot;t appropriate).&n; *&n; * Modified by Peter Cervasio (address above) (26SEP92)&n; * Changes:  Included code to (properly?) detect when a Microsoft mouse is&n; *           really attached to the machine.  Don&squot;t know what this does to&n; *           Logitech bus mice, but all it does is read ports.&n; *&n; * Modified by Christoph Niemann (niemann@rubdv15.etdv.ruhr-uni-bochum.de)&n; * Changes:  Better interrupt-handler (like in busmouse.c).&n; *&t;     Some changes to reduce code-size.&n; *&t;     Changed detection code to use inb_p() instead of doing empty&n; *&t;     loops to delay i/o.&n; *&n; * Modularised 8-Sep-95 Philip Blundell &lt;pjb27@cam.ac.uk&gt;&n; *&n; * Converted to use new generic busmouse code.  5 Apr 1998&n; *   Russell King &lt;rmk@arm.uk.linux.org&gt;&n; *&n; * version 0.3b&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/logibusmouse.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;busmouse.h&quot;
DECL|variable|msedev
r_static
r_int
id|msedev
suffix:semicolon
DECL|variable|mouse_irq
r_static
r_int
id|mouse_irq
op_assign
id|MOUSE_IRQ
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mouse_irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|msmouse_setup
r_static
r_int
id|__init
id|msmouse_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|4
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
id|mouse_irq
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;msmouse=&quot;
comma
id|msmouse_setup
)paren
suffix:semicolon
macro_line|#endif /* !MODULE */
DECL|function|ms_mouse_interrupt
r_static
r_void
id|ms_mouse_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_char
id|dx
comma
id|dy
suffix:semicolon
r_int
r_char
id|buttons
suffix:semicolon
id|outb
c_func
(paren
id|MS_MSE_COMMAND_MODE
comma
id|MS_MSE_CONTROL_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|MS_MSE_DATA_PORT
)paren
op_or
l_int|0x20
)paren
comma
id|MS_MSE_DATA_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|MS_MSE_READ_X
comma
id|MS_MSE_CONTROL_PORT
)paren
suffix:semicolon
id|dx
op_assign
id|inb
c_func
(paren
id|MS_MSE_DATA_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|MS_MSE_READ_Y
comma
id|MS_MSE_CONTROL_PORT
)paren
suffix:semicolon
id|dy
op_assign
id|inb
c_func
(paren
id|MS_MSE_DATA_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
id|MS_MSE_READ_BUTTONS
comma
id|MS_MSE_CONTROL_PORT
)paren
suffix:semicolon
id|buttons
op_assign
op_complement
(paren
id|inb
c_func
(paren
id|MS_MSE_DATA_PORT
)paren
)paren
op_amp
l_int|0x07
suffix:semicolon
id|outb
c_func
(paren
id|MS_MSE_COMMAND_MODE
comma
id|MS_MSE_CONTROL_PORT
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|inb
c_func
(paren
id|MS_MSE_DATA_PORT
)paren
op_amp
l_int|0xdf
)paren
comma
id|MS_MSE_DATA_PORT
)paren
suffix:semicolon
multiline_comment|/* why did the original have:&n;&t; * if (dx != 0 || dy != 0 || buttons != mouse.buttons ||&n;&t; *    ((~buttons) &amp; 0x07))&n;&t; *    ^^^^^^^^^^^^^^^^^^^ this?&n;&t; */
id|busmouse_add_movementbuttons
c_func
(paren
id|msedev
comma
id|dx
comma
op_minus
id|dy
comma
id|buttons
)paren
suffix:semicolon
)brace
DECL|function|release_mouse
r_static
r_int
id|release_mouse
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|MS_MSE_INT_OFF
c_func
(paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|mouse_irq
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|open_mouse
r_static
r_int
id|open_mouse
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|mouse_irq
comma
id|ms_mouse_interrupt
comma
l_int|0
comma
l_string|&quot;MS Busmouse&quot;
comma
l_int|NULL
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|outb
c_func
(paren
id|MS_MSE_START
comma
id|MS_MSE_CONTROL_PORT
)paren
suffix:semicolon
id|MS_MSE_INT_ON
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|msbusmouse
r_static
r_struct
id|busmouse
id|msbusmouse
op_assign
(brace
id|MICROSOFT_BUSMOUSE
comma
l_string|&quot;msbusmouse&quot;
comma
id|THIS_MODULE
comma
id|open_mouse
comma
id|release_mouse
comma
l_int|0
)brace
suffix:semicolon
DECL|function|ms_bus_mouse_init
r_static
r_int
id|__init
id|ms_bus_mouse_init
c_func
(paren
r_void
)paren
(brace
r_int
id|present
op_assign
l_int|0
suffix:semicolon
r_int
id|mse_byte
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|MS_MSE_CONTROL_PORT
comma
l_int|0x04
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|inb_p
c_func
(paren
id|MS_MSE_SIGNATURE_PORT
)paren
op_eq
l_int|0xde
)paren
(brace
id|mse_byte
op_assign
id|inb_p
c_func
(paren
id|MS_MSE_SIGNATURE_PORT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|inb_p
c_func
(paren
id|MS_MSE_SIGNATURE_PORT
)paren
op_eq
l_int|0xde
)paren
(brace
r_if
c_cond
(paren
id|inb_p
c_func
(paren
id|MS_MSE_SIGNATURE_PORT
)paren
op_eq
id|mse_byte
)paren
id|present
op_assign
l_int|1
suffix:semicolon
r_else
id|present
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|present
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|present
op_eq
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|MS_MSE_INT_OFF
c_func
(paren
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|MS_MSE_CONTROL_PORT
comma
l_int|0x04
comma
l_string|&quot;MS Busmouse&quot;
)paren
suffix:semicolon
id|msedev
op_assign
id|register_busmouse
c_func
(paren
op_amp
id|msbusmouse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msedev
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unable to register msbusmouse driver.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Microsoft BusMouse detected and installed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|msedev
OL
l_int|0
ques
c_cond
id|msedev
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|ms_bus_mouse_exit
r_static
r_void
id|__exit
id|ms_bus_mouse_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_busmouse
c_func
(paren
id|msedev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|MS_MSE_CONTROL_PORT
comma
l_int|0x04
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|ms_bus_mouse_init
)paren
id|module_exit
c_func
(paren
id|ms_bus_mouse_exit
)paren
eof
