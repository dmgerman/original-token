multiline_comment|/*&n; *      Copyright (C) 1993-1995 Bas Laarhoven.&n;&n; This program is free software; you can redistribute it and/or modify&n; it under the terms of the GNU General Public License as published by&n; the Free Software Foundation; either version 2, or (at your option)&n; any later version.&n;&n; This program is distributed in the hope that it will be useful,&n; but WITHOUT ANY WARRANTY; without even the implied warranty of&n; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; GNU General Public License for more details.&n;&n; You should have received a copy of the GNU General Public License&n; along with this program; see the file COPYING.  If not, write to&n; the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.&n;&n; *&n; *      This file contains the non-read/write ftape functions&n; *      for the QIC-40/80 floppy-tape driver for Linux.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ftape.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &quot;tracing.h&quot;
macro_line|#include &quot;ftape-eof.h&quot;
macro_line|#include &quot;ftape-io.h&quot;
macro_line|#include &quot;ftape-ctl.h&quot;
macro_line|#include &quot;ftape-write.h&quot;
macro_line|#include &quot;ftape-read.h&quot;
macro_line|#include &quot;ftape-rw.h&quot;
macro_line|#include &quot;qic117.h&quot;
macro_line|#include &quot;ftape-bsm.h&quot;
multiline_comment|/*      Global vars.&n; */
DECL|variable|segments_per_track
r_int
id|segments_per_track
op_assign
l_int|102
suffix:semicolon
DECL|variable|segments_per_head
r_int
id|segments_per_head
op_assign
l_int|1020
suffix:semicolon
DECL|variable|segments_per_cylinder
r_int
id|segments_per_cylinder
op_assign
l_int|4
suffix:semicolon
DECL|variable|tracks_per_tape
r_int
id|tracks_per_tape
op_assign
l_int|20
suffix:semicolon
DECL|variable|ftape_failure
r_int
id|ftape_failure
op_assign
l_int|1
suffix:semicolon
DECL|variable|ftape_seg_pos
r_int
id|ftape_seg_pos
op_assign
l_int|0
suffix:semicolon
DECL|variable|first_data_segment
r_int
id|first_data_segment
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|ftape_state
r_int
id|ftape_state
op_assign
id|idle
suffix:semicolon
multiline_comment|/* use buffer_state_enum */
DECL|variable|history
id|history_record
id|history
suffix:semicolon
DECL|variable|write_protected
r_int
id|write_protected
suffix:semicolon
DECL|variable|ftape_offline
r_int
id|ftape_offline
op_assign
l_int|0
suffix:semicolon
DECL|variable|no_tape
r_int
id|no_tape
op_assign
l_int|1
suffix:semicolon
DECL|variable|formatted
r_int
id|formatted
op_assign
l_int|0
suffix:semicolon
DECL|variable|ftape_data_rate
r_int
id|ftape_data_rate
op_assign
l_int|0
suffix:semicolon
DECL|variable|going_offline
r_int
id|going_offline
op_assign
l_int|0
suffix:semicolon
DECL|variable|read_only
r_int
id|read_only
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*      Local vars.&n; */
DECL|variable|ftape_last_error
r_static
r_int
id|ftape_last_error
op_assign
l_int|0
suffix:semicolon
DECL|variable|vendors
r_static
r_const
id|vendor_struct
id|vendors
(braket
)braket
op_assign
id|QIC117_VENDORS
suffix:semicolon
DECL|variable|methods
r_static
r_const
id|wakeup_method
id|methods
(braket
)braket
op_assign
id|WAKEUP_METHODS
suffix:semicolon
DECL|variable|init_drive_needed
r_static
r_int
id|init_drive_needed
op_assign
l_int|1
suffix:semicolon
DECL|function|ftape_not_operational
r_static
r_int
id|ftape_not_operational
c_func
(paren
r_int
id|status
)paren
(brace
multiline_comment|/* return true if status indicates tape can not be used.&n;&t; */
r_return
(paren
(paren
id|status
op_xor
id|QIC_STATUS_CARTRIDGE_PRESENT
)paren
op_amp
(paren
id|QIC_STATUS_ERROR
op_or
id|QIC_STATUS_CARTRIDGE_PRESENT
op_or
id|QIC_STATUS_NEW_CARTRIDGE
)paren
)paren
suffix:semicolon
)brace
DECL|function|ftape_seek_to_eot
r_int
id|ftape_seek_to_eot
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|8
comma
l_string|&quot;ftape_seek_to_eot&quot;
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|status
suffix:semicolon
id|result
op_assign
id|ftape_ready_wait
c_func
(paren
id|timeout.pause
comma
op_amp
id|status
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_amp
id|QIC_STATUS_AT_EOT
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;failed&quot;
)paren
suffix:semicolon
id|TRACE_EXIT
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ftape_not_operational
c_func
(paren
id|status
)paren
)paren
(brace
id|TRACE_EXIT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|result
op_assign
id|ftape_command_wait
c_func
(paren
id|QIC_PHYSICAL_FORWARD
comma
id|timeout.rewind
comma
op_amp
id|status
)paren
suffix:semicolon
)brace
id|TRACE_EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ftape_seek_to_bot
r_int
id|ftape_seek_to_bot
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|8
comma
l_string|&quot;ftape_seek_to_bot&quot;
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|status
suffix:semicolon
id|result
op_assign
id|ftape_ready_wait
c_func
(paren
id|timeout.pause
comma
op_amp
id|status
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_amp
id|QIC_STATUS_AT_BOT
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;failed&quot;
)paren
suffix:semicolon
id|TRACE_EXIT
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ftape_not_operational
c_func
(paren
id|status
)paren
)paren
(brace
id|TRACE_EXIT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|result
op_assign
id|ftape_command_wait
c_func
(paren
id|QIC_PHYSICAL_REVERSE
comma
id|timeout.rewind
comma
op_amp
id|status
)paren
suffix:semicolon
)brace
id|TRACE_EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ftape_reset_position
r_void
id|ftape_reset_position
c_func
(paren
r_void
)paren
(brace
id|ftape_seg_pos
op_assign
id|first_data_segment
suffix:semicolon
id|reset_eof_list
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|ftape_new_cartridge
r_int
id|ftape_new_cartridge
c_func
(paren
r_void
)paren
(brace
id|location.track
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* force seek on first access */
id|first_data_segment
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* unknown */
id|ftape_zap_read_buffers
c_func
(paren
)paren
suffix:semicolon
id|ftape_zap_write_buffers
c_func
(paren
)paren
suffix:semicolon
id|ftape_reset_position
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ftape_abort_operation
r_int
id|ftape_abort_operation
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|5
comma
l_string|&quot;ftape_abort_operation&quot;
)paren
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|runner_status
op_eq
id|running
)paren
(brace
id|TRACE
c_func
(paren
l_int|5
comma
l_string|&quot;aborting runner, waiting&quot;
)paren
suffix:semicolon
id|runner_status
op_assign
id|do_abort
suffix:semicolon
multiline_comment|/* set timeout so that the tape will run to logical EOT&n;&t;&t; * if we missed the last sector and there are no queue pulses.&n;&t;&t; */
id|result
op_assign
id|ftape_dumb_stop
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|runner_status
op_assign
id|idle
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|runner_status
op_ne
id|idle
)paren
(brace
r_if
c_cond
(paren
id|runner_status
op_eq
id|do_abort
)paren
(brace
id|TRACE
c_func
(paren
l_int|5
comma
l_string|&quot;forcing runner abort&quot;
)paren
suffix:semicolon
)brace
id|TRACE
c_func
(paren
l_int|5
comma
l_string|&quot;stopping tape&quot;
)paren
suffix:semicolon
id|result
op_assign
id|ftape_command_wait
c_func
(paren
id|QIC_STOP_TAPE
comma
id|timeout.stop
comma
op_amp
id|status
)paren
suffix:semicolon
id|location.known
op_assign
l_int|0
suffix:semicolon
id|runner_status
op_assign
id|idle
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_BUFFERS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|buffer
(braket
id|i
)braket
dot
id|status
op_assign
id|waiting
suffix:semicolon
)brace
id|head
op_assign
id|tail
op_assign
l_int|0
suffix:semicolon
id|TRACE_EXIT
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|lookup_vendor_id
r_int
id|lookup_vendor_id
c_func
(paren
r_int
id|vendor_id
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|vendors
(braket
id|i
)braket
dot
id|vendor_id
op_ne
id|vendor_id
)paren
(brace
r_if
c_cond
(paren
op_increment
id|i
op_ge
id|NR_ITEMS
c_func
(paren
id|vendors
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|i
suffix:semicolon
)brace
DECL|function|ftape_detach_drive
r_void
id|ftape_detach_drive
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|8
comma
l_string|&quot;ftape_detach_drive&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
l_int|5
comma
l_string|&quot;disabling tape drive and fdc&quot;
)paren
suffix:semicolon
id|ftape_put_drive_to_sleep
c_func
(paren
id|drive_type
)paren
suffix:semicolon
id|fdc_catch_stray_interrupts
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* one always comes */
id|fdc_disable
c_func
(paren
)paren
suffix:semicolon
id|fdc_release_irq_and_dma
c_func
(paren
)paren
suffix:semicolon
id|TRACE_EXIT
suffix:semicolon
)brace
DECL|function|clear_history
r_static
r_void
id|clear_history
c_func
(paren
r_void
)paren
(brace
id|history.used
op_assign
l_int|0
suffix:semicolon
id|history.id_am_errors
op_assign
id|history.id_crc_errors
op_assign
id|history.data_am_errors
op_assign
id|history.data_crc_errors
op_assign
id|history.overrun_errors
op_assign
id|history.no_data_errors
op_assign
id|history.retries
op_assign
id|history.crc_errors
op_assign
id|history.crc_failures
op_assign
id|history.ecc_failures
op_assign
id|history.corrected
op_assign
id|history.defects
op_assign
id|history.rewinds
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ftape_activate_drive
r_int
id|ftape_activate_drive
c_func
(paren
id|vendor_struct
op_star
id|drive_type
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|5
comma
l_string|&quot;ftape_activate_drive&quot;
)paren
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* If we already know the drive type, wake it up.&n;&t; * Else try to find out what kind of drive is attached.&n;&t; */
r_if
c_cond
(paren
id|drive_type-&gt;wake_up
op_ne
id|unknown_wake_up
)paren
(brace
id|TRACE
c_func
(paren
l_int|5
comma
l_string|&quot;enabling tape drive and fdc&quot;
)paren
suffix:semicolon
id|result
op_assign
id|ftape_wakeup_drive
c_func
(paren
id|drive_type-&gt;wake_up
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;known wakeup method failed&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
id|old_tracing
op_assign
id|tracing
suffix:semicolon
id|wake_up_types
id|method
suffix:semicolon
multiline_comment|/*  Try to awaken the drive using all known methods.&n;&t;&t; *  Lower tracing for a while.&n;&t;&t; */
r_if
c_cond
(paren
id|tracing
op_le
l_int|4
)paren
(brace
id|tracing
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|method
op_assign
id|no_wake_up
suffix:semicolon
id|method
OL
id|NR_ITEMS
c_func
(paren
id|methods
)paren
suffix:semicolon
op_increment
id|method
)paren
(brace
id|drive_type-&gt;wake_up
op_assign
id|method
suffix:semicolon
macro_line|#if 0
multiline_comment|/*  Test setup for dual drive configuration in dodo.&n;&t;&t;&t; *  /dev/rft2 uses mountain wakeup only -&gt; Archive QIC-80&n;&t;&t;&t; *  /dev/rft3 uses colorado wakeup only -&gt; Jumbo QIC-40&n;&t;&t;&t; *  Other systems will use the normal scheme.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|FTAPE_UNIT
OL
l_int|2
)paren
op_logical_or
(paren
id|FTAPE_UNIT
op_eq
l_int|2
op_logical_and
id|method
op_eq
id|wake_up_mountain
)paren
op_logical_or
(paren
id|FTAPE_UNIT
op_eq
l_int|3
op_logical_and
id|method
op_eq
id|wake_up_colorado
)paren
)paren
(brace
id|result
op_assign
id|ftape_wakeup_drive
c_func
(paren
id|drive_type-&gt;wake_up
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#else
id|result
op_assign
id|ftape_wakeup_drive
c_func
(paren
id|drive_type-&gt;wake_up
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
r_int
id|tracing
op_assign
id|old_tracing
suffix:semicolon
multiline_comment|/* fool TRACE */
id|TRACEx1
c_func
(paren
l_int|2
comma
l_string|&quot;drive wakeup method: %s&quot;
comma
id|methods
(braket
id|drive_type-&gt;wake_up
)braket
dot
id|name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|tracing
op_assign
id|old_tracing
suffix:semicolon
r_if
c_cond
(paren
id|method
op_ge
id|NR_ITEMS
c_func
(paren
id|methods
)paren
)paren
(brace
multiline_comment|/* no response at all, cannot open this drive */
id|drive_type-&gt;wake_up
op_assign
id|unknown_wake_up
suffix:semicolon
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;no tape drive found !&quot;
)paren
suffix:semicolon
id|tracing
op_assign
id|old_tracing
suffix:semicolon
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
id|TRACE_EXIT
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ftape_get_drive_status
r_int
id|ftape_get_drive_status
c_func
(paren
r_int
op_star
id|new_tape
comma
r_int
op_star
id|no_tape
comma
r_int
op_star
id|wp_tape
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|5
comma
l_string|&quot;ftape_get_drive_status&quot;
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|status
suffix:semicolon
op_star
id|no_tape
op_assign
op_star
id|wp_tape
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*    Tape drive is activated now.&n;&t; *    First clear error status if present.&n;&t; */
r_do
(brace
id|result
op_assign
id|ftape_ready_wait
c_func
(paren
id|timeout.reset
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ETIME
)paren
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;ftape_ready_wait timeout&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EINTR
)paren
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;ftape_ready_wait aborted&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;ftape_ready_wait failed&quot;
)paren
suffix:semicolon
)brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*  Clear error condition (drive is ready !)&n;&t;&t; */
r_if
c_cond
(paren
id|status
op_amp
id|QIC_STATUS_ERROR
)paren
(brace
r_int
id|error
suffix:semicolon
r_int
id|command
suffix:semicolon
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;error status set&quot;
)paren
suffix:semicolon
id|result
op_assign
id|ftape_report_error
c_func
(paren
op_amp
id|error
comma
op_amp
id|command
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|TRACEi
c_func
(paren
l_int|1
comma
l_string|&quot;report_error_code failed:&quot;
comma
id|result
)paren
suffix:semicolon
id|ftape_reset_drive
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* hope it&squot;s working next time */
id|init_drive_needed
op_assign
l_int|1
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|error
op_ne
l_int|0
)paren
(brace
id|TRACEi
c_func
(paren
l_int|4
comma
l_string|&quot;error code   :&quot;
comma
id|error
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|4
comma
l_string|&quot;error command:&quot;
comma
id|command
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|QIC_STATUS_NEW_CARTRIDGE
)paren
(brace
r_int
id|error
suffix:semicolon
r_int
id|command
suffix:semicolon
r_int
id|old_tracing
op_assign
id|tracing
suffix:semicolon
multiline_comment|/*  Undocumented feature: Must clear (not present!) error &n;&t;&t;&t; *  here or we&squot;ll fail later.&n;&t;&t;&t; */
id|tracing
op_assign
l_int|0
suffix:semicolon
id|ftape_report_error
c_func
(paren
op_amp
id|error
comma
op_amp
id|command
comma
l_int|1
)paren
suffix:semicolon
id|tracing
op_assign
id|old_tracing
suffix:semicolon
id|TRACE
c_func
(paren
l_int|3
comma
l_string|&quot;status: new cartridge&quot;
)paren
suffix:semicolon
op_star
id|new_tape
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|status
op_amp
id|QIC_STATUS_ERROR
)paren
suffix:semicolon
op_star
id|no_tape
op_assign
op_logical_neg
(paren
id|status
op_amp
id|QIC_STATUS_CARTRIDGE_PRESENT
)paren
suffix:semicolon
op_star
id|wp_tape
op_assign
(paren
id|status
op_amp
id|QIC_STATUS_WRITE_PROTECT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|no_tape
)paren
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;no cartridge present&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_star
id|wp_tape
)paren
(brace
id|TRACE
c_func
(paren
l_int|2
comma
l_string|&quot;Write protected cartridge&quot;
)paren
suffix:semicolon
)brace
)brace
id|TRACE_EXIT
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ftape_log_vendor_id
r_void
id|ftape_log_vendor_id
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|5
comma
l_string|&quot;ftape_log_vendor_id&quot;
)paren
suffix:semicolon
r_int
id|vendor_index
suffix:semicolon
id|ftape_report_vendor_id
c_func
(paren
op_amp
id|drive_type.vendor_id
)paren
suffix:semicolon
id|vendor_index
op_assign
id|lookup_vendor_id
c_func
(paren
id|drive_type.vendor_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drive_type.vendor_id
op_eq
id|UNKNOWN_VENDOR
op_logical_and
id|drive_type.wake_up
op_eq
id|wake_up_colorado
)paren
(brace
id|vendor_index
op_assign
l_int|0
suffix:semicolon
id|drive_type.vendor_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* hack to get rid of all this mail */
)brace
r_if
c_cond
(paren
id|vendor_index
OL
l_int|0
)paren
(brace
multiline_comment|/* Unknown vendor id, first time opening device.&n;&t;&t; * The drive_type remains set to type found at wakeup time, this&n;&t;&t; * will probably keep the driver operating for this new vendor.&n;&t;&t; */
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;============ unknown vendor id ===========&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;A new, yet unsupported tape drive is found&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;Please report the following values:&quot;
)paren
suffix:semicolon
id|TRACEx1
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;   Vendor id     : 0x%04x&quot;
comma
id|drive_type.vendor_id
)paren
suffix:semicolon
id|TRACEx1
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;   Wakeup method : %s&quot;
comma
id|methods
(braket
id|drive_type.wake_up
)braket
dot
id|name
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;And a description of your tape drive to:&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;Kai Harrekilde-Petersen &lt;khp@pip.dknet.dk&gt;&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;==========================================&quot;
)paren
suffix:semicolon
id|drive_type.speed
op_assign
l_int|500
suffix:semicolon
multiline_comment|/* deci-ips: very safe value */
)brace
r_else
(brace
id|drive_type.name
op_assign
id|vendors
(braket
id|vendor_index
)braket
dot
id|name
suffix:semicolon
id|drive_type.speed
op_assign
id|vendors
(braket
id|vendor_index
)braket
dot
id|speed
suffix:semicolon
id|TRACEx1
c_func
(paren
l_int|3
comma
l_string|&quot;tape drive type: %s&quot;
comma
id|drive_type.name
)paren
suffix:semicolon
multiline_comment|/* scan all methods for this vendor_id in table */
r_while
c_loop
(paren
id|drive_type.wake_up
op_ne
id|vendors
(braket
id|vendor_index
)braket
dot
id|wake_up
)paren
(brace
r_if
c_cond
(paren
id|vendor_index
OL
id|NR_ITEMS
c_func
(paren
id|vendors
)paren
op_minus
l_int|1
op_logical_and
id|vendors
(braket
id|vendor_index
op_plus
l_int|1
)braket
dot
id|vendor_id
op_eq
id|drive_type.vendor_id
)paren
(brace
op_increment
id|vendor_index
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|drive_type.wake_up
op_ne
id|vendors
(braket
id|vendor_index
)braket
dot
id|wake_up
)paren
(brace
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;==========================================&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;wakeup type mismatch:&quot;
)paren
suffix:semicolon
id|TRACEx2
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;found: %s, expected: %s&quot;
comma
id|methods
(braket
id|drive_type.wake_up
)braket
dot
id|name
comma
id|methods
(braket
id|vendors
(braket
id|vendor_index
)braket
dot
id|wake_up
)braket
dot
id|name
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;please report this to &lt;khp@pip.dknet.dk&gt;&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;==========================================&quot;
)paren
suffix:semicolon
)brace
)brace
id|TRACE_EXIT
suffix:semicolon
)brace
DECL|function|ftape_calc_timeouts
r_void
id|ftape_calc_timeouts
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|8
comma
l_string|&quot;ftape_calc_timeouts&quot;
)paren
suffix:semicolon
r_int
id|speed
suffix:semicolon
multiline_comment|/* deci-ips ! */
r_int
id|length
suffix:semicolon
multiline_comment|/*                           tape transport speed&n;&t; *  data rate:        QIC-40   QIC-80   QIC-3010 QIC-3020&n;&t; *&n;&t; *    250 Kbps        25 ips     n/a      n/a      n/a&n;&t; *    500 Kbps        50 ips   34 ips   22.6 ips   n/a&n;&t; *      1 Mbps          n/a    68 ips   45.2 ips 22.6 ips&n;&t; *      2 Mbps          n/a      n/a      n/a    45.2 ips&n;&t; *&n;&t; *  fast tape transport speed is at least 68 ips.&n;&t; */
r_switch
c_cond
(paren
id|qic_std
)paren
(brace
r_case
id|QIC_TAPE_QIC40
suffix:colon
id|speed
op_assign
(paren
id|ftape_data_rate
op_eq
l_int|3
)paren
ques
c_cond
l_int|250
suffix:colon
l_int|500
suffix:semicolon
r_break
suffix:semicolon
r_case
id|QIC_TAPE_QIC80
suffix:colon
id|speed
op_assign
(paren
id|ftape_data_rate
op_eq
l_int|2
)paren
ques
c_cond
l_int|340
suffix:colon
l_int|680
suffix:semicolon
r_break
suffix:semicolon
r_case
id|QIC_TAPE_QIC3010
suffix:colon
id|speed
op_assign
(paren
id|ftape_data_rate
op_eq
l_int|2
)paren
ques
c_cond
l_int|226
suffix:colon
l_int|452
suffix:semicolon
r_break
suffix:semicolon
r_case
id|QIC_TAPE_QIC3020
suffix:colon
id|speed
op_assign
(paren
id|ftape_data_rate
op_eq
l_int|1
)paren
ques
c_cond
l_int|226
suffix:colon
l_int|452
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;Unknown qic_std (bug) ?&quot;
)paren
suffix:semicolon
id|speed
op_assign
l_int|500
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tape_len
op_le
l_int|0
)paren
(brace
multiline_comment|/*  Handle unknown length tapes as 1100 ft ones (worst case)&n;&t;&t; */
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;Unknown tape length, using worst case timing values!&quot;
)paren
suffix:semicolon
id|length
op_assign
l_int|1100
suffix:semicolon
)brace
r_else
(brace
id|length
op_assign
id|tape_len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|drive_type.speed
op_eq
l_int|0
)paren
(brace
r_int
r_int
id|t0
suffix:semicolon
r_int
id|dt
suffix:semicolon
id|ftape_seek_to_bot
c_func
(paren
)paren
suffix:semicolon
id|t0
op_assign
id|jiffies
suffix:semicolon
id|ftape_seek_to_eot
c_func
(paren
)paren
suffix:semicolon
id|ftape_seek_to_bot
c_func
(paren
)paren
suffix:semicolon
id|dt
op_assign
(paren
r_int
)paren
(paren
(paren
id|jiffies
op_minus
id|t0
)paren
op_star
id|MSPT
)paren
suffix:semicolon
id|drive_type.speed
op_assign
(paren
l_int|2
op_star
l_int|12
op_star
id|length
op_star
l_int|1000
)paren
op_div
id|dt
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;==========================================&quot;
)paren
suffix:semicolon
id|TRACEx1
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;drive : %s&quot;
comma
id|drive_type.name
)paren
suffix:semicolon
id|TRACEx2
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;delta time = %d, length = %d&quot;
comma
id|dt
comma
id|length
)paren
suffix:semicolon
id|TRACEx1
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;has max tape speed of %d ips&quot;
comma
id|drive_type.speed
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;please report this to &lt;khp@pip.dknet.dk&gt;&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
op_minus
l_int|1
comma
l_string|&quot;==========================================&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*  time to go from bot to eot at normal speed (data rate):&n;&t; *  time = (1+delta) * length (ft) * 12 (inch/ft) / speed (ips)&n;&t; *  delta = 10 % for seek speed, 20 % for rewind speed.&n;&t; */
id|timeout.seek
op_assign
(paren
id|length
op_star
l_int|132
op_star
id|SECOND
)paren
op_div
id|speed
suffix:semicolon
id|timeout.rewind
op_assign
(paren
id|length
op_star
l_int|144
op_star
id|SECOND
)paren
op_div
(paren
l_int|10
op_star
id|drive_type.speed
)paren
suffix:semicolon
id|timeout.reset
op_assign
l_int|20
op_star
id|SECOND
op_plus
id|timeout.rewind
suffix:semicolon
id|TRACEx2
c_func
(paren
l_int|4
comma
l_string|&quot;speed = %d, length = %d&quot;
comma
id|speed
comma
id|length
)paren
suffix:semicolon
id|TRACEx1
c_func
(paren
l_int|4
comma
l_string|&quot;seek timeout: %d sec&quot;
comma
(paren
id|timeout.seek
op_plus
l_int|500
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|TRACEx1
c_func
(paren
l_int|4
comma
l_string|&quot;rewind timeout: %d sec&quot;
comma
(paren
id|timeout.rewind
op_plus
l_int|500
)paren
op_div
l_int|1000
)paren
suffix:semicolon
id|TRACE_EXIT
suffix:semicolon
)brace
DECL|function|ftape_init_drive
r_int
id|ftape_init_drive
c_func
(paren
r_int
op_star
id|formatted
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|5
comma
l_string|&quot;ftape_init_drive&quot;
)paren
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|status
suffix:semicolon
id|result
op_assign
id|ftape_report_raw_drive_status
c_func
(paren
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
op_logical_and
(paren
id|status
op_amp
id|QIC_STATUS_CARTRIDGE_PRESENT
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|QIC_STATUS_AT_BOT
)paren
)paren
(brace
multiline_comment|/*  Antique drives will get here after a soft reset,&n;&t;&t;&t; *  modern ones only if the driver is loaded when the&n;&t;&t;&t; *  tape wasn&squot;t rewound properly.&n;&t;&t;&t; */
id|ftape_seek_to_bot
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|QIC_STATUS_REFERENCED
)paren
)paren
(brace
id|TRACE
c_func
(paren
l_int|5
comma
l_string|&quot;starting seek_load_point&quot;
)paren
suffix:semicolon
id|result
op_assign
id|ftape_command_wait
c_func
(paren
id|QIC_SEEK_LOAD_POINT
comma
id|timeout.reset
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;seek_load_point failed (command)&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
r_int
id|rate
suffix:semicolon
op_star
id|formatted
op_assign
(paren
id|status
op_amp
id|QIC_STATUS_REFERENCED
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|formatted
)paren
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;Warning: tape is not formatted !&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*  Select highest rate supported by both fdc and drive.&n;&t;&t; *  Start with highest rate supported by the fdc.&n;&t;&t; */
r_if
c_cond
(paren
id|fdc.type
op_ge
id|i82078_1
)paren
id|rate
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fdc.type
op_ge
id|i82077
)paren
id|rate
op_assign
l_int|1
suffix:semicolon
r_else
id|rate
op_assign
l_int|2
suffix:semicolon
r_do
(brace
id|result
op_assign
id|ftape_set_data_rate
c_func
(paren
id|rate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
id|ftape_calc_timeouts
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_increment
id|rate
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rate
OL
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
multiline_comment|/* Tape should be at bot if new cartridge ! */
id|ftape_new_cartridge
c_func
(paren
)paren
suffix:semicolon
)brace
id|init_drive_needed
op_assign
l_int|0
suffix:semicolon
id|TRACE_EXIT
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*      OPEN routine called by kernel-interface code&n; */
DECL|function|_ftape_open
r_int
id|_ftape_open
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|8
comma
l_string|&quot;_ftape_open&quot;
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_static
r_int
id|new_tape
op_assign
l_int|1
suffix:semicolon
id|result
op_assign
id|fdc_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
id|result
op_assign
id|ftape_activate_drive
c_func
(paren
op_amp
id|drive_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|fdc_disable
c_func
(paren
)paren
suffix:semicolon
id|fdc_release_irq_and_dma
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
id|ftape_get_drive_status
c_func
(paren
op_amp
id|new_tape
comma
op_amp
id|no_tape
comma
op_amp
id|write_protected
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|ftape_detach_drive
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|drive_type.vendor_id
op_eq
id|UNKNOWN_VENDOR
)paren
(brace
id|ftape_log_vendor_id
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|no_tape
)paren
(brace
id|ftape_offline
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|new_tape
)paren
(brace
id|ftape_offline
op_assign
l_int|0
suffix:semicolon
id|init_drive_needed
op_assign
l_int|1
suffix:semicolon
id|read_only
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* enable writes again */
)brace
r_if
c_cond
(paren
op_logical_neg
id|ftape_offline
op_logical_and
id|init_drive_needed
)paren
(brace
id|result
op_assign
id|ftape_init_drive
c_func
(paren
op_amp
id|formatted
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
id|new_tape
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ftape_detach_drive
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
id|clear_history
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|TRACE_EXIT
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*      RELEASE routine called by kernel-interface code&n; */
DECL|function|_ftape_close
r_int
id|_ftape_close
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|8
comma
l_string|&quot;_ftape_close&quot;
)paren
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|last_segment
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ftape_offline
)paren
(brace
id|result
op_assign
id|ftape_flush_buffers
c_func
(paren
)paren
suffix:semicolon
id|last_segment
op_assign
id|ftape_seg_pos
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ftape_unit
op_amp
id|FTAPE_NO_REWIND
)paren
)paren
(brace
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
id|result
op_assign
id|ftape_update_header_segments
c_func
(paren
l_int|NULL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;error: update of header segments failed&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;error: unable to update header segments&quot;
)paren
suffix:semicolon
)brace
)brace
id|ftape_abort_operation
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ftape_unit
op_amp
id|FTAPE_NO_REWIND
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|no_tape
)paren
(brace
id|TRACE
c_func
(paren
l_int|5
comma
l_string|&quot;rewinding tape&quot;
)paren
suffix:semicolon
id|result
op_assign
id|ftape_seek_to_bot
c_func
(paren
)paren
suffix:semicolon
)brace
id|ftape_reset_position
c_func
(paren
)paren
suffix:semicolon
id|ftape_zap_read_buffers
c_func
(paren
)paren
suffix:semicolon
id|ftape_zap_write_buffers
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|ftape_detach_drive
c_func
(paren
)paren
suffix:semicolon
id|fdc_uninit
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|history.used
)paren
(brace
id|TRACE
c_func
(paren
l_int|3
comma
l_string|&quot;== Non-fatal errors this run: ==&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
l_int|3
comma
l_string|&quot;fdc isr statistics:&quot;
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; id_am_errors     :&quot;
comma
id|history.id_am_errors
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; id_crc_errors    :&quot;
comma
id|history.id_crc_errors
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; data_am_errors   :&quot;
comma
id|history.data_am_errors
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; data_crc_errors  :&quot;
comma
id|history.data_crc_errors
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; overrun_errors   :&quot;
comma
id|history.overrun_errors
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; no_data_errors   :&quot;
comma
id|history.no_data_errors
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; retries          :&quot;
comma
id|history.retries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|history.used
op_amp
l_int|1
)paren
(brace
id|TRACE
c_func
(paren
l_int|3
comma
l_string|&quot;ecc statistics:&quot;
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; crc_errors       :&quot;
comma
id|history.crc_errors
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; crc_failures     :&quot;
comma
id|history.crc_failures
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; ecc_failures     :&quot;
comma
id|history.ecc_failures
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot; sectors corrected:&quot;
comma
id|history.corrected
)paren
suffix:semicolon
)brace
id|TRACEx2
c_func
(paren
l_int|3
comma
l_string|&quot;media defects     : %d%s&quot;
comma
id|history.defects
comma
id|history.defects
ques
c_cond
l_string|&quot; !!!&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot;repositions       :&quot;
comma
id|history.rewinds
)paren
suffix:semicolon
id|TRACEi
c_func
(paren
l_int|3
comma
l_string|&quot;last segment      :&quot;
comma
id|last_segment
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|going_offline
)paren
(brace
id|going_offline
op_assign
l_int|0
suffix:semicolon
id|ftape_offline
op_assign
l_int|1
suffix:semicolon
)brace
id|TRACE_EXIT
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*      IOCTL routine called by kernel-interface code&n; */
DECL|function|_ftape_ioctl
r_int
id|_ftape_ioctl
c_func
(paren
r_int
r_int
id|command
comma
r_void
op_star
id|arg
)paren
(brace
id|TRACE_FUN
c_func
(paren
l_int|8
comma
l_string|&quot;ftape_ioctl&quot;
)paren
suffix:semicolon
r_int
id|result
op_assign
id|EINVAL
suffix:semicolon
r_union
(brace
r_struct
id|mtop
id|mtop
suffix:semicolon
r_struct
id|mtget
id|mtget
suffix:semicolon
)brace
id|krnl_arg
suffix:semicolon
r_int
id|arg_size
op_assign
(paren
id|command
op_amp
id|IOCSIZE_MASK
)paren
op_rshift
id|IOCSIZE_SHIFT
suffix:semicolon
multiline_comment|/* This check will only catch arguments that are too large !&n;&t; */
r_if
c_cond
(paren
(paren
id|command
op_amp
id|IOC_INOUT
)paren
op_logical_and
id|arg_size
OG
r_sizeof
(paren
id|krnl_arg
)paren
)paren
(brace
id|TRACEi
c_func
(paren
l_int|1
comma
l_string|&quot;bad argument size:&quot;
comma
id|arg_size
)paren
suffix:semicolon
id|TRACE_EXIT
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command
op_amp
id|IOC_IN
)paren
(brace
r_int
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|arg
comma
id|arg_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|TRACE_EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|memcpy_fromfs
c_func
(paren
op_amp
id|krnl_arg.mtop
comma
id|arg
comma
id|arg_size
)paren
suffix:semicolon
)brace
id|TRACEx1
c_func
(paren
l_int|5
comma
l_string|&quot;called with ioctl command: 0x%08x&quot;
comma
id|command
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
multiline_comment|/* cpio compatibility&n;&t;&t; * mtrasx and mtreset are mt extension by Hennus Bergman&n;&t;&t; * mtseek and mttell are mt extension by eddy olk&n;&t;&t; */
r_case
id|MTIOCTOP
suffix:colon
id|TRACEx1
c_func
(paren
l_int|5
comma
l_string|&quot;calling MTIOCTOP command: 0x%08x&quot;
comma
id|krnl_arg.mtop.mt_op
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|krnl_arg.mtop.mt_op
)paren
(brace
r_case
id|MTNOP
suffix:colon
multiline_comment|/* gnu mt calls MTNOP before MTIOCGET to set status */
id|result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTRESET
suffix:colon
id|result
op_assign
id|ftape_reset_drive
c_func
(paren
)paren
suffix:semicolon
id|init_drive_needed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
op_logical_or
id|ftape_offline
)paren
(brace
r_break
suffix:semicolon
)brace
id|result
op_assign
id|ftape_seek_to_bot
c_func
(paren
)paren
suffix:semicolon
id|ftape_reset_position
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTREW
suffix:colon
r_case
id|MTOFFL
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ftape_flush_buffers
c_func
(paren
)paren
suffix:semicolon
id|ftape_update_header_segments
c_func
(paren
l_int|NULL
comma
l_int|1
)paren
suffix:semicolon
id|result
op_assign
id|ftape_seek_to_bot
c_func
(paren
)paren
suffix:semicolon
id|ftape_reset_position
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|krnl_arg.mtop.mt_op
op_eq
id|MTOFFL
)paren
(brace
id|going_offline
op_assign
l_int|1
suffix:semicolon
id|TRACE
c_func
(paren
l_int|4
comma
l_string|&quot;Putting tape drive offline&quot;
)paren
suffix:semicolon
)brace
id|result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTRETEN
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|result
op_assign
id|ftape_seek_to_eot
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
id|result
op_assign
id|ftape_seek_to_bot
c_func
(paren
)paren
suffix:semicolon
)brace
id|ftape_reset_position
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTERASE
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|result
op_assign
id|ftape_erase
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTEOM
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|result
op_assign
id|ftape_seek_eom
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSFM
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|eof_mark
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* position ready to extend */
r_case
id|MTFSF
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|result
op_assign
id|ftape_seek_eof
c_func
(paren
id|krnl_arg.mtop.mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSFM
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|eof_mark
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* position ready to extend */
r_case
id|MTBSF
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|result
op_assign
id|ftape_seek_eof
c_func
(paren
op_minus
id|krnl_arg.mtop.mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSR
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tracing
op_assign
id|krnl_arg.mtop.mt_count
suffix:semicolon
id|TRACEx1
c_func
(paren
l_int|2
comma
l_string|&quot;tracing set to %d&quot;
comma
id|tracing
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSR
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if 0
id|result
op_assign
id|ftape_fix
c_func
(paren
)paren
suffix:semicolon
macro_line|#else
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MTWEOF
suffix:colon
r_if
c_cond
(paren
id|ftape_offline
)paren
(brace
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|result
op_assign
id|ftape_weof
c_func
(paren
id|krnl_arg.mtop.mt_count
comma
id|ftape_seg_pos
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
id|ftape_seg_pos
op_add_assign
id|krnl_arg.mtop.mt_count
op_minus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* MTRASx and MTRESET are mt extension by Hennus Bergman&n;&t;&t;&t; */
r_case
id|MTRAS1
suffix:colon
r_case
id|MTRAS2
suffix:colon
r_case
id|MTRAS3
suffix:colon
r_case
id|MTSEEK
suffix:colon
r_case
id|MTTELL
suffix:colon
r_default
suffix:colon
id|TRACEi
c_func
(paren
l_int|1
comma
l_string|&quot;MTIOCTOP sub-command not implemented:&quot;
comma
id|krnl_arg.mtop.mt_op
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MTIOCGET
suffix:colon
id|krnl_arg.mtget.mt_type
op_assign
id|drive_type.vendor_id
op_plus
l_int|0x800000
suffix:semicolon
id|krnl_arg.mtget.mt_resid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not implemented */
id|krnl_arg.mtget.mt_dsreg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* status register */
id|krnl_arg.mtget.mt_gstat
op_assign
multiline_comment|/* device independent status */
(paren
(paren
id|ftape_offline
)paren
ques
c_cond
l_int|0
suffix:colon
id|GMT_ONLINE
c_func
(paren
op_minus
l_int|1L
)paren
)paren
op_or
(paren
(paren
id|write_protected
)paren
ques
c_cond
id|GMT_WR_PROT
c_func
(paren
op_minus
l_int|1L
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|no_tape
)paren
ques
c_cond
id|GMT_DR_OPEN
c_func
(paren
op_minus
l_int|1L
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|krnl_arg.mtget.mt_erreg
op_assign
id|ftape_last_error
suffix:semicolon
multiline_comment|/* error register */
id|result
op_assign
id|ftape_file_no
c_func
(paren
op_amp
id|krnl_arg.mtget.mt_fileno
comma
op_amp
id|krnl_arg.mtget.mt_blkno
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTIOCPOS
suffix:colon
id|TRACE
c_func
(paren
l_int|5
comma
l_string|&quot;Mag tape ioctl command: MTIOCPOS&quot;
)paren
suffix:semicolon
id|TRACE
c_func
(paren
l_int|1
comma
l_string|&quot;MTIOCPOS command not implemented&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command
op_amp
id|IOC_OUT
)paren
(brace
r_int
id|error
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|arg
comma
id|arg_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|TRACE_EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|memcpy_tofs
c_func
(paren
id|arg
comma
op_amp
id|krnl_arg
comma
id|arg_size
)paren
suffix:semicolon
)brace
id|TRACE_EXIT
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ftape_init_driver
r_void
id|ftape_init_driver
c_func
(paren
r_void
)paren
(brace
id|drive_type.vendor_id
op_assign
id|UNKNOWN_VENDOR
suffix:semicolon
id|drive_type.speed
op_assign
l_int|0
suffix:semicolon
id|drive_type.wake_up
op_assign
id|unknown_wake_up
suffix:semicolon
id|drive_type.name
op_assign
l_string|&quot;Unkown&quot;
suffix:semicolon
id|timeout.seek
op_assign
l_int|650
op_star
id|SECOND
suffix:semicolon
id|timeout.reset
op_assign
l_int|670
op_star
id|SECOND
suffix:semicolon
id|timeout.rewind
op_assign
l_int|650
op_star
id|SECOND
suffix:semicolon
id|timeout.head_seek
op_assign
l_int|15
op_star
id|SECOND
suffix:semicolon
id|timeout.stop
op_assign
l_int|5
op_star
id|SECOND
suffix:semicolon
id|timeout.pause
op_assign
l_int|16
op_star
id|SECOND
suffix:semicolon
id|qic_std
op_assign
op_minus
l_int|1
suffix:semicolon
id|tape_len
op_assign
op_minus
l_int|1
suffix:semicolon
id|current_command
op_assign
l_int|0
suffix:semicolon
id|current_cylinder
op_assign
op_minus
l_int|1
suffix:semicolon
id|segments_per_track
op_assign
l_int|102
suffix:semicolon
id|segments_per_head
op_assign
l_int|1020
suffix:semicolon
id|segments_per_cylinder
op_assign
l_int|4
suffix:semicolon
id|tracks_per_tape
op_assign
l_int|20
suffix:semicolon
id|ftape_failure
op_assign
l_int|1
suffix:semicolon
id|ftape_seg_pos
op_assign
l_int|0
suffix:semicolon
id|first_data_segment
op_assign
op_minus
l_int|1
suffix:semicolon
id|ftape_state
op_assign
id|idle
suffix:semicolon
id|no_tape
op_assign
l_int|1
suffix:semicolon
id|formatted
op_assign
l_int|0
suffix:semicolon
id|ftape_data_rate
op_assign
l_int|0
suffix:semicolon
id|going_offline
op_assign
l_int|0
suffix:semicolon
id|read_only
op_assign
l_int|0
suffix:semicolon
id|init_drive_needed
op_assign
l_int|1
suffix:semicolon
id|header_segment_1
op_assign
op_minus
l_int|1
suffix:semicolon
id|header_segment_2
op_assign
op_minus
l_int|1
suffix:semicolon
id|used_header_segment
op_assign
op_minus
l_int|1
suffix:semicolon
id|location.track
op_assign
op_minus
l_int|1
suffix:semicolon
id|location.known
op_assign
l_int|0
suffix:semicolon
id|tape_running
op_assign
l_int|0
suffix:semicolon
id|might_be_off_track
op_assign
l_int|1
suffix:semicolon
id|ftape_new_cartridge
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* init some tape related variables */
id|ftape_init_bsm
c_func
(paren
)paren
suffix:semicolon
)brace
eof
