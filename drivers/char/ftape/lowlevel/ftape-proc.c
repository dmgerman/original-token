multiline_comment|/*&n; *      Copyright (C) 1997 Claus-Justus Heine&n;&n; This program is free software; you can redistribute it and/or modify&n; it under the terms of the GNU General Public License as published by&n; the Free Software Foundation; either version 2, or (at your option)&n; any later version.&n;&n; This program is distributed in the hope that it will be useful,&n; but WITHOUT ANY WARRANTY; without even the implied warranty of&n; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; GNU General Public License for more details.&n;&n; You should have received a copy of the GNU General Public License&n; along with this program; see the file COPYING.  If not, write to&n; the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.&n;&n; *&n; * $Source: /homes/cvs/ftape-stacked/ftape/lowlevel/ftape-proc.c,v $&n; * $Revision: 1.11 $&n; * $Date: 1997/10/24 14:47:37 $&n; *&n; *      This file contains the procfs interface for the&n; *      QIC-40/80/3010/3020 floppy-tape driver &quot;ftape&quot; for Linux.&n;&n; *&t;Old code removed, switched to dynamic proc entry.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#if defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_FT_PROC_FS)
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/ftape.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/qic117.h&gt;
macro_line|#include &quot;../lowlevel/ftape-io.h&quot;
macro_line|#include &quot;../lowlevel/ftape-ctl.h&quot;
macro_line|#include &quot;../lowlevel/ftape-proc.h&quot;
macro_line|#include &quot;../lowlevel/ftape-tracing.h&quot;
DECL|function|get_driver_info
r_static
r_int
id|get_driver_info
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_const
r_char
op_star
id|debug_level
(braket
)braket
op_assign
(brace
l_string|&quot;bugs&quot;
comma
l_string|&quot;errors&quot;
comma
l_string|&quot;warnings&quot;
comma
l_string|&quot;informational&quot;
comma
l_string|&quot;noisy&quot;
comma
l_string|&quot;program flow&quot;
comma
l_string|&quot;fdc and dma&quot;
comma
l_string|&quot;data flow&quot;
comma
l_string|&quot;anything&quot;
)brace
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;version       : %s&bslash;n&quot;
l_string|&quot;used data rate: %d kbit/sec&bslash;n&quot;
l_string|&quot;dma memory    : %d kb&bslash;n&quot;
l_string|&quot;debug messages: %s&bslash;n&quot;
comma
id|FTAPE_VERSION
comma
id|ft_data_rate
comma
id|FT_BUFF_SIZE
op_star
id|ft_nr_buffers
op_rshift
l_int|10
comma
id|debug_level
(braket
id|TRACE_LEVEL
)braket
)paren
suffix:semicolon
)brace
DECL|function|get_tapedrive_info
r_static
r_int
id|get_tapedrive_info
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;vendor id : 0x%04x&bslash;n&quot;
l_string|&quot;drive name: %s&bslash;n&quot;
l_string|&quot;wind speed: %d ips&bslash;n&quot;
l_string|&quot;wakeup    : %s&bslash;n&quot;
l_string|&quot;max. rate : %d kbit/sec&bslash;n&quot;
comma
id|ft_drive_type.vendor_id
comma
id|ft_drive_type.name
comma
id|ft_drive_type.speed
comma
(paren
(paren
id|ft_drive_type.wake_up
op_eq
id|no_wake_up
)paren
ques
c_cond
l_string|&quot;No wakeup needed&quot;
suffix:colon
(paren
(paren
id|ft_drive_type.wake_up
op_eq
id|wake_up_colorado
)paren
ques
c_cond
l_string|&quot;Colorado&quot;
suffix:colon
(paren
(paren
id|ft_drive_type.wake_up
op_eq
id|wake_up_mountain
)paren
ques
c_cond
l_string|&quot;Mountain&quot;
suffix:colon
(paren
(paren
id|ft_drive_type.wake_up
op_eq
id|wake_up_insight
)paren
ques
c_cond
l_string|&quot;Motor on&quot;
suffix:colon
l_string|&quot;Unknown&quot;
)paren
)paren
)paren
)paren
comma
id|ft_drive_max_rate
)paren
suffix:semicolon
)brace
DECL|function|get_cartridge_info
r_static
r_int
id|get_cartridge_info
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|ftape_init_drive_needed
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;uninitialized&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ft_no_tape
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;no cartridge inserted&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;segments  : %5d&bslash;n&quot;
l_string|&quot;tracks    : %5d&bslash;n&quot;
l_string|&quot;length    : %5dft&bslash;n&quot;
l_string|&quot;formatted : %3s&bslash;n&quot;
l_string|&quot;writable  : %3s&bslash;n&quot;
l_string|&quot;QIC spec. : QIC-%s&bslash;n&quot;
l_string|&quot;fmt-code  : %1d&bslash;n&quot;
comma
id|ft_segments_per_track
comma
id|ft_tracks_per_tape
comma
id|ftape_tape_len
comma
(paren
id|ft_formatted
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
(paren
id|ft_write_protected
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;no&quot;
suffix:colon
l_string|&quot;yes&quot;
comma
(paren
(paren
id|ft_qic_std
op_eq
id|QIC_TAPE_QIC40
)paren
ques
c_cond
l_string|&quot;40&quot;
suffix:colon
(paren
(paren
id|ft_qic_std
op_eq
id|QIC_TAPE_QIC80
)paren
ques
c_cond
l_string|&quot;80&quot;
suffix:colon
(paren
(paren
id|ft_qic_std
op_eq
id|QIC_TAPE_QIC3010
)paren
ques
c_cond
l_string|&quot;3010&quot;
suffix:colon
(paren
(paren
id|ft_qic_std
op_eq
id|QIC_TAPE_QIC3020
)paren
ques
c_cond
l_string|&quot;3020&quot;
suffix:colon
l_string|&quot;???&quot;
)paren
)paren
)paren
)paren
comma
id|ft_format_code
)paren
suffix:semicolon
)brace
DECL|function|get_controller_info
r_static
r_int
id|get_controller_info
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_const
r_char
op_star
id|fdc_name
(braket
)braket
op_assign
(brace
l_string|&quot;no fdc&quot;
comma
l_string|&quot;i8272&quot;
comma
l_string|&quot;i82077&quot;
comma
l_string|&quot;i82077AA&quot;
comma
l_string|&quot;Colorado FC-10 or FC-20&quot;
comma
l_string|&quot;i82078&quot;
comma
l_string|&quot;i82078_1&quot;
)brace
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;FDC type  : %s&bslash;n&quot;
l_string|&quot;FDC base  : 0x%03x&bslash;n&quot;
l_string|&quot;FDC irq   : %d&bslash;n&quot;
l_string|&quot;FDC dma   : %d&bslash;n&quot;
l_string|&quot;FDC thr.  : %d&bslash;n&quot;
l_string|&quot;max. rate : %d kbit/sec&bslash;n&quot;
comma
id|ft_mach2
ques
c_cond
l_string|&quot;Mountain MACH-2&quot;
suffix:colon
id|fdc_name
(braket
id|fdc.type
)braket
comma
id|fdc.sra
comma
id|fdc.irq
comma
id|fdc.dma
comma
id|ft_fdc_threshold
comma
id|ft_fdc_max_rate
)paren
suffix:semicolon
)brace
DECL|function|get_history_info
r_static
r_int
id|get_history_info
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_int
id|len
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;&bslash;nFDC isr statistics&bslash;n&quot;
l_string|&quot; id_am_errors     : %3d&bslash;n&quot;
l_string|&quot; id_crc_errors    : %3d&bslash;n&quot;
l_string|&quot; data_am_errors   : %3d&bslash;n&quot;
l_string|&quot; data_crc_errors  : %3d&bslash;n&quot;
l_string|&quot; overrun_errors   : %3d&bslash;n&quot;
l_string|&quot; no_data_errors   : %3d&bslash;n&quot;
l_string|&quot; retries          : %3d&bslash;n&quot;
comma
id|ft_history.id_am_errors
comma
id|ft_history.id_crc_errors
comma
id|ft_history.data_am_errors
comma
id|ft_history.data_crc_errors
comma
id|ft_history.overrun_errors
comma
id|ft_history.no_data_errors
comma
id|ft_history.retries
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;nECC statistics&bslash;n&quot;
l_string|&quot; crc_errors       : %3d&bslash;n&quot;
l_string|&quot; crc_failures     : %3d&bslash;n&quot;
l_string|&quot; ecc_failures     : %3d&bslash;n&quot;
l_string|&quot; sectors corrected: %3d&bslash;n&quot;
comma
id|ft_history.crc_errors
comma
id|ft_history.crc_failures
comma
id|ft_history.ecc_failures
comma
id|ft_history.corrected
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;ntape quality statistics&bslash;n&quot;
l_string|&quot; media defects    : %3d&bslash;n&quot;
comma
id|ft_history.defects
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;ntape motion statistics&bslash;n&quot;
l_string|&quot; repositions      : %3d&bslash;n&quot;
comma
id|ft_history.rewinds
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|ftape_read_proc
r_int
id|ftape_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|ptr
op_assign
id|page
suffix:semicolon
r_int
id|len
suffix:semicolon
id|ptr
op_add_assign
id|sprintf
c_func
(paren
id|ptr
comma
l_string|&quot;Kernel Driver&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|ptr
op_add_assign
id|get_driver_info
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|ptr
op_add_assign
id|sprintf
c_func
(paren
id|ptr
comma
l_string|&quot;&bslash;nTape Drive&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|ptr
op_add_assign
id|get_tapedrive_info
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|ptr
op_add_assign
id|sprintf
c_func
(paren
id|ptr
comma
l_string|&quot;&bslash;nFDC Controller&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|ptr
op_add_assign
id|get_controller_info
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|ptr
op_add_assign
id|sprintf
c_func
(paren
id|ptr
comma
l_string|&quot;&bslash;nTape Cartridge&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|ptr
op_add_assign
id|get_cartridge_info
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|ptr
op_add_assign
id|sprintf
c_func
(paren
id|ptr
comma
l_string|&quot;&bslash;nHistory Record&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|ptr
op_add_assign
id|get_history_info
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|page
)paren
suffix:semicolon
op_star
id|start
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|off
op_plus
id|count
op_ge
id|len
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
op_star
id|eof
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
DECL|function|ftape_proc_init
r_int
id|__init
id|ftape_proc_init
c_func
(paren
r_void
)paren
(brace
r_return
id|create_proc_read_entry
c_func
(paren
l_string|&quot;ftape&quot;
comma
l_int|0
comma
op_amp
id|proc_root
comma
id|ftape_read_proc
comma
l_int|NULL
)paren
op_ne
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|ftape_proc_destroy
r_void
id|ftape_proc_destroy
c_func
(paren
r_void
)paren
(brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;ftape&quot;
comma
op_amp
id|proc_root
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif /* defined(CONFIG_PROC_FS) &amp;&amp; defined(CONFIG_FT_PROC_FS) */
eof
