multiline_comment|/*&n; *      Copyright (C) 1995-1997 Claus-Justus Heine.&n;&n; This program is free software; you can redistribute it and/or modify&n; it under the terms of the GNU General Public License as published by&n; the Free Software Foundation; either version 2, or (at your option)&n; any later version.&n;&n; This program is distributed in the hope that it will be useful,&n; but WITHOUT ANY WARRANTY; without even the implied warranty of&n; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; GNU General Public License for more details.&n;&n; You should have received a copy of the GNU General Public License&n; along with this program; see the file COPYING.  If not, write to&n; the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.&n;&n; *&n; * $Source: /homes/cvs/ftape-stacked/ftape/zftape/zftape-buffers.c,v $&n; * $Revision: 1.2 $&n; * $Date: 1997/10/05 19:18:59 $&n; *&n; *      This file contains the dynamic buffer allocation routines &n; *      of zftape&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/zftape.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VER(2,1,0)
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#endif
macro_line|#include &quot;../zftape/zftape-init.h&quot;
macro_line|#include &quot;../zftape/zftape-eof.h&quot;
macro_line|#include &quot;../zftape/zftape-ctl.h&quot;
macro_line|#include &quot;../zftape/zftape-write.h&quot;
macro_line|#include &quot;../zftape/zftape-read.h&quot;
macro_line|#include &quot;../zftape/zftape-rw.h&quot;
macro_line|#include &quot;../zftape/zftape-vtbl.h&quot;
multiline_comment|/*  global variables&n; */
multiline_comment|/*  local varibales&n; */
DECL|variable|used_memory
r_static
r_int
r_int
id|used_memory
suffix:semicolon
DECL|variable|peak_memory
r_static
r_int
r_int
id|peak_memory
suffix:semicolon
DECL|function|zft_memory_stats
r_void
id|zft_memory_stats
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
id|ft_t_flow
)paren
suffix:semicolon
id|TRACE
c_func
(paren
id|ft_t_noise
comma
l_string|&quot;Memory usage (vmalloc allocations):&bslash;n&quot;
id|KERN_INFO
l_string|&quot;total allocated: %d&bslash;n&quot;
id|KERN_INFO
l_string|&quot;peak allocation: %d&quot;
comma
id|used_memory
comma
id|peak_memory
)paren
suffix:semicolon
id|peak_memory
op_assign
id|used_memory
suffix:semicolon
id|TRACE_EXIT
suffix:semicolon
)brace
DECL|function|zft_vcalloc_once
r_int
id|zft_vcalloc_once
c_func
(paren
r_void
op_star
r_new
comma
r_int
id|size
)paren
(brace
id|TRACE_FUN
c_func
(paren
id|ft_t_flow
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zft_vmalloc_once
c_func
(paren
r_new
comma
id|size
)paren
OL
l_int|0
)paren
(brace
id|TRACE_EXIT
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
op_star
(paren
r_void
op_star
op_star
)paren
r_new
comma
l_char|&squot;&bslash;0&squot;
comma
id|size
)paren
suffix:semicolon
id|TRACE_EXIT
l_int|0
suffix:semicolon
)brace
DECL|function|zft_vmalloc_once
r_int
id|zft_vmalloc_once
c_func
(paren
r_void
op_star
r_new
comma
r_int
id|size
)paren
(brace
id|TRACE_FUN
c_func
(paren
id|ft_t_flow
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_void
op_star
op_star
)paren
r_new
op_ne
l_int|NULL
op_logical_or
id|size
op_eq
l_int|0
)paren
(brace
id|TRACE_EXIT
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
(paren
r_void
op_star
op_star
)paren
r_new
op_assign
id|vmalloc
c_func
(paren
id|size
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|TRACE_EXIT
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|used_memory
op_add_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|peak_memory
OL
id|used_memory
)paren
(brace
id|peak_memory
op_assign
id|used_memory
suffix:semicolon
)brace
id|TRACE_ABORT
c_func
(paren
l_int|0
comma
id|ft_t_noise
comma
l_string|&quot;allocated buffer @ %p, %d bytes&quot;
comma
op_star
(paren
r_void
op_star
op_star
)paren
r_new
comma
id|size
)paren
suffix:semicolon
)brace
DECL|function|zft_vcalloc_always
r_int
id|zft_vcalloc_always
c_func
(paren
r_void
op_star
r_new
comma
r_int
id|size
)paren
(brace
id|TRACE_FUN
c_func
(paren
id|ft_t_flow
)paren
suffix:semicolon
id|zft_vfree
c_func
(paren
r_new
comma
id|size
)paren
suffix:semicolon
id|TRACE_EXIT
id|zft_vcalloc_once
c_func
(paren
r_new
comma
id|size
)paren
suffix:semicolon
)brace
DECL|function|zft_vmalloc_always
r_int
id|zft_vmalloc_always
c_func
(paren
r_void
op_star
r_new
comma
r_int
id|size
)paren
(brace
id|TRACE_FUN
c_func
(paren
id|ft_t_flow
)paren
suffix:semicolon
id|zft_vfree
c_func
(paren
r_new
comma
id|size
)paren
suffix:semicolon
id|TRACE_EXIT
id|zft_vmalloc_once
c_func
(paren
r_new
comma
id|size
)paren
suffix:semicolon
)brace
DECL|function|zft_vfree
r_void
id|zft_vfree
c_func
(paren
r_void
op_star
id|old
comma
r_int
id|size
)paren
(brace
id|TRACE_FUN
c_func
(paren
id|ft_t_flow
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_void
op_star
op_star
)paren
id|old
)paren
(brace
id|vfree
c_func
(paren
op_star
(paren
r_void
op_star
op_star
)paren
id|old
)paren
suffix:semicolon
id|used_memory
op_sub_assign
id|size
suffix:semicolon
id|TRACE
c_func
(paren
id|ft_t_noise
comma
l_string|&quot;released buffer @ %p, %d bytes&quot;
comma
op_star
(paren
r_void
op_star
op_star
)paren
id|old
comma
id|size
)paren
suffix:semicolon
op_star
(paren
r_void
op_star
op_star
)paren
id|old
op_assign
l_int|NULL
suffix:semicolon
)brace
id|TRACE_EXIT
suffix:semicolon
)brace
DECL|function|zft_kmalloc
r_void
op_star
id|zft_kmalloc
c_func
(paren
r_int
id|size
)paren
(brace
r_void
op_star
r_new
suffix:semicolon
r_while
c_loop
(paren
(paren
r_new
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
r_new
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|used_memory
op_add_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|peak_memory
OL
id|used_memory
)paren
(brace
id|peak_memory
op_assign
id|used_memory
suffix:semicolon
)brace
r_return
r_new
suffix:semicolon
)brace
DECL|function|zft_kfree
r_void
id|zft_kfree
c_func
(paren
r_void
op_star
id|old
comma
r_int
id|size
)paren
(brace
id|kfree
c_func
(paren
id|old
)paren
suffix:semicolon
id|used_memory
op_sub_assign
id|size
suffix:semicolon
)brace
multiline_comment|/* there are some more buffers that are allocated on demand.&n; * cleanup_module() calles this function to be sure to have released&n; * them &n; */
DECL|function|zft_uninit_mem
r_void
id|zft_uninit_mem
c_func
(paren
r_void
)paren
(brace
id|TRACE_FUN
c_func
(paren
id|ft_t_flow
)paren
suffix:semicolon
id|zft_vfree
c_func
(paren
op_amp
id|zft_hseg_buf
comma
id|FT_SEGMENT_SIZE
)paren
suffix:semicolon
id|zft_vfree
c_func
(paren
op_amp
id|zft_deblock_buf
comma
id|FT_SEGMENT_SIZE
)paren
suffix:semicolon
id|zft_deblock_segment
op_assign
op_minus
l_int|1
suffix:semicolon
id|zft_free_vtbl
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zft_cmpr_lock
c_func
(paren
l_int|0
multiline_comment|/* don&squot;t load */
)paren
op_eq
l_int|0
)paren
(brace
(paren
op_star
id|zft_cmpr_ops-&gt;cleanup
)paren
(paren
)paren
suffix:semicolon
(paren
op_star
id|zft_cmpr_ops-&gt;reset
)paren
(paren
)paren
suffix:semicolon
multiline_comment|/* unlock it again */
)brace
id|zft_memory_stats
c_func
(paren
)paren
suffix:semicolon
id|TRACE_EXIT
suffix:semicolon
)brace
eof
