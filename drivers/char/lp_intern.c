multiline_comment|/*&n; * split into mid and low-level for better support of different hardware&n; * by Joerg Dorchain (dorchain@mpi-sb.mpg.de)&n; *&n; * Amiga printer device by Michael Rausch (linux@uni-koblenz.de);&n; * Atari support added by Andreas Schwab (schwab@ls5.informatik.uni-dortmund.de);&n; * based upon work from&n; *&n; * Copyright (C) 1992 by Jim Weigand and Linus Torvalds&n; * Copyright (C) 1992,1993 by Michael K. Johnson&n; * - Thanks much to Gunter Windau for pointing out to me where the error&n; *   checking ought to be.&n; * Copyright (C) 1993 by Nigel Gamble (added interrupt code)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/lp_intern.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#ifdef CONFIG_AMIGA
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_ATARI
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/atarihw.h&gt;
macro_line|#endif
r_static
r_void
id|lp_int_out
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|lp_int_busy
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|lp_int_pout
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|lp_int_online
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|lp_int_interrupt
c_func
(paren
r_int
)paren
suffix:semicolon
r_int
id|lp_internal_init
c_func
(paren
r_struct
id|lp_struct
op_star
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
DECL|function|lp_int_out
id|lp_int_out
(paren
r_int
id|c
comma
r_int
id|dev
)paren
(brace
r_switch
c_cond
(paren
id|boot_info.machtype
)paren
(brace
macro_line|#ifdef CONFIG_AMIGA
r_case
id|MACH_AMIGA
suffix:colon
(brace
r_int
id|wait
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|wait
op_ne
id|lp_table
(braket
id|dev
)braket
dot
id|wait
)paren
id|wait
op_increment
suffix:semicolon
id|ciaa.prb
op_assign
id|c
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ATARI
r_case
id|MACH_ATARI
suffix:colon
(brace
r_int
id|wait
op_assign
l_int|0
suffix:semicolon
id|sound_ym.rd_data_reg_sel
op_assign
l_int|15
suffix:semicolon
id|sound_ym.wd_data
op_assign
id|c
suffix:semicolon
id|sound_ym.rd_data_reg_sel
op_assign
l_int|14
suffix:semicolon
r_while
c_loop
(paren
id|wait
op_ne
id|lp_table
(braket
id|dev
)braket
dot
id|wait
)paren
id|wait
op_increment
suffix:semicolon
id|sound_ym.wd_data
op_assign
id|sound_ym.rd_data_reg_sel
op_amp
op_complement
(paren
l_int|1
op_lshift
l_int|5
)paren
suffix:semicolon
r_while
c_loop
(paren
id|wait
)paren
id|wait
op_decrement
suffix:semicolon
id|sound_ym.wd_data
op_assign
id|sound_ym.rd_data_reg_sel
op_or
(paren
l_int|1
op_lshift
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
r_static
r_int
DECL|function|lp_int_busy
id|lp_int_busy
(paren
r_int
id|dev
)paren
(brace
r_switch
c_cond
(paren
id|boot_info.machtype
)paren
(brace
macro_line|#ifdef CONFIG_AMIGA
r_case
id|MACH_AMIGA
suffix:colon
r_return
id|ciab.pra
op_amp
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ATARI
r_case
id|MACH_ATARI
suffix:colon
r_return
id|mfp.par_dt_reg
op_amp
l_int|1
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|lp_int_pout
id|lp_int_pout
(paren
r_int
id|dev
)paren
(brace
r_switch
c_cond
(paren
id|boot_info.machtype
)paren
(brace
macro_line|#ifdef CONFIG_AMIGA
r_case
id|MACH_AMIGA
suffix:colon
r_return
id|ciab.pra
op_amp
l_int|2
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ATARI
r_case
id|MACH_ATARI
suffix:colon
macro_line|#endif
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|lp_int_online
id|lp_int_online
(paren
r_int
id|dev
)paren
(brace
r_switch
c_cond
(paren
id|boot_info.machtype
)paren
(brace
macro_line|#ifdef CONFIG_AMIGA
r_case
id|MACH_AMIGA
suffix:colon
r_return
id|ciab.pra
op_amp
l_int|4
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_ATARI
r_case
id|MACH_ATARI
suffix:colon
r_return
op_logical_neg
(paren
id|mfp.par_dt_reg
op_amp
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|lp_int_interrupt
r_static
r_int
id|lp_int_interrupt
c_func
(paren
r_int
id|dev
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|lp_internal_init
r_int
id|lp_internal_init
c_func
(paren
r_struct
id|lp_struct
op_star
id|lp_table
comma
r_int
id|entry
comma
r_int
id|max_lp
comma
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
id|max_lp
op_minus
id|entry
OL
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_AMIGA
r_if
c_cond
(paren
id|MACH_IS_AMIGA
)paren
(brace
id|ciaa.ddrb
op_assign
l_int|0xff
suffix:semicolon
id|ciab.ddra
op_and_assign
l_int|0xf8
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_ATARI
r_if
c_cond
(paren
id|MACH_IS_ATARI
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|sound_ym.rd_data_reg_sel
op_assign
l_int|7
suffix:semicolon
id|sound_ym.wd_data
op_assign
(paren
id|sound_ym.rd_data_reg_sel
op_amp
l_int|0x3f
)paren
op_or
l_int|0xc0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
id|lp_table
(braket
id|entry
)braket
dot
id|name
op_assign
l_string|&quot;Builtin LP&quot;
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|lp_out
op_assign
id|lp_int_out
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|lp_is_busy
op_assign
id|lp_int_busy
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|lp_has_pout
op_assign
id|lp_int_pout
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|lp_is_online
op_assign
id|lp_int_online
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|lp_my_interrupt
op_assign
id|lp_int_interrupt
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|flags
op_assign
id|LP_EXIST
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|chars
op_assign
id|LP_INIT_CHAR
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|time
op_assign
id|LP_INIT_TIME
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|wait
op_assign
id|LP_INIT_WAIT
suffix:semicolon
id|lp_table
(braket
id|entry
)braket
dot
id|lp_wait_q
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;lp%d: internal port&bslash;n&quot;
comma
id|entry
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
eof
