multiline_comment|/* r3964 linediscipline for linux&n; *&n; * -----------------------------------------------------------&n; * Copyright by &n; * Philips Automation Projects&n; * Kassel (Germany)&n; * http://www.pap-philips.de&n; * -----------------------------------------------------------&n; * This software may be used and distributed according to the terms of&n; * the GNU Public License, incorporated herein by reference.&n; *&n; * Author:&n; * L. Haag&n; *&n; * $Log: n_r3964.c,v $&n; * Revision 1.8  2000/03/23 14:14:54  dwmw2&n; * Fix race in sleeping in r3964_read()&n; *&n; * Revision 1.7  1999/28/08 11:41:50  dwmw2&n; * Port to 2.3 kernel&n; *&n; * Revision 1.6  1998/09/30 00:40:40  dwmw2&n; * Fixed compilation on 2.0.x kernels&n; * Updated to newly registered tty-ldisc number 9&n; *&n; * Revision 1.5  1998/09/04 21:57:36  dwmw2&n; * Signal handling bug fixes, port to 2.1.x.&n; *&n; * Revision 1.4  1998/04/02 20:26:59  lhaag&n; * select, blocking, ...&n; *&n; * Revision 1.3  1998/02/12 18:58:43  root&n; * fixed some memory leaks&n; * calculation of checksum characters&n; *&n; * Revision 1.2  1998/02/07 13:03:34  root&n; * ioctl read_telegram&n; *&n; * Revision 1.1  1998/02/06 19:21:03  root&n; * Initial revision&n; *&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;   /* used in new tty drivers */
macro_line|#include &lt;linux/signal.h&gt;   /* used in new tty drivers */
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/n_r3964.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
singleline_comment|//#define DEBUG_QUEUE
multiline_comment|/* Log successfull handshake and protocol operations  */
singleline_comment|//#define DEBUG_PROTO_S
multiline_comment|/* Log handshake and protocol errors: */
singleline_comment|//#define DEBUG_PROTO_E
multiline_comment|/* Log Linediscipline operations (open, close, read, write...): */
singleline_comment|//#define DEBUG_LDISC
multiline_comment|/* Log module and memory operations (init, cleanup; kmalloc, kfree): */
singleline_comment|//#define DEBUG_MODUL
multiline_comment|/* Macro helpers for debug output: */
DECL|macro|TRACE
mdefine_line|#define TRACE(format, args...) printk(&quot;r3964: &quot; format &quot;&bslash;n&quot; , ## args);
macro_line|#ifdef DEBUG_MODUL
DECL|macro|TRACE_M
mdefine_line|#define TRACE_M(format, args...) printk(&quot;r3964: &quot; format &quot;&bslash;n&quot; , ## args);
macro_line|#else
DECL|macro|TRACE_M
mdefine_line|#define TRACE_M(fmt, arg...) /**/
macro_line|#endif
macro_line|#ifdef DEBUG_PROTO_S
DECL|macro|TRACE_PS
mdefine_line|#define TRACE_PS(format, args...) printk(&quot;r3964: &quot; format &quot;&bslash;n&quot; , ## args);
macro_line|#else
DECL|macro|TRACE_PS
mdefine_line|#define TRACE_PS(fmt, arg...) /**/
macro_line|#endif
macro_line|#ifdef DEBUG_PROTO_E
DECL|macro|TRACE_PE
mdefine_line|#define TRACE_PE(format, args...) printk(&quot;r3964: &quot; format &quot;&bslash;n&quot; , ## args);
macro_line|#else
DECL|macro|TRACE_PE
mdefine_line|#define TRACE_PE(fmt, arg...) /**/
macro_line|#endif
macro_line|#ifdef DEBUG_LDISC
DECL|macro|TRACE_L
mdefine_line|#define TRACE_L(format, args...) printk(&quot;r3964: &quot; format &quot;&bslash;n&quot; , ## args);
macro_line|#else
DECL|macro|TRACE_L
mdefine_line|#define TRACE_L(fmt, arg...) /**/
macro_line|#endif
macro_line|#ifdef DEBUG_QUEUE
DECL|macro|TRACE_Q
mdefine_line|#define TRACE_Q(format, args...) printk(&quot;r3964: &quot; format &quot;&bslash;n&quot; , ## args);
macro_line|#else
DECL|macro|TRACE_Q
mdefine_line|#define TRACE_Q(fmt, arg...) /**/
macro_line|#endif
r_static
r_void
id|on_timer_1
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_void
id|on_timer_2
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_void
id|add_tx_queue
c_func
(paren
r_struct
id|r3964_info
op_star
comma
r_struct
id|r3964_block_header
op_star
)paren
suffix:semicolon
r_static
r_void
id|remove_from_tx_queue
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_int
id|error_code
)paren
suffix:semicolon
r_static
r_void
id|put_char
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_int
r_char
id|ch
)paren
suffix:semicolon
r_static
r_void
id|trigger_transmit
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
suffix:semicolon
r_static
r_void
id|retry_transmit
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
suffix:semicolon
r_static
r_void
id|transmit_block
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
suffix:semicolon
r_static
r_void
id|receive_char
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_const
r_int
r_char
id|c
)paren
suffix:semicolon
r_static
r_void
id|receive_error
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_const
r_char
id|flag
)paren
suffix:semicolon
r_static
r_void
id|on_timeout
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
suffix:semicolon
r_static
r_int
id|enable_signals
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
id|pid_t
id|pid
comma
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|read_telegram
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
id|pid_t
id|pid
comma
r_int
r_char
op_star
id|buf
)paren
suffix:semicolon
r_static
r_void
id|add_msg
c_func
(paren
r_struct
id|r3964_client_info
op_star
id|pClient
comma
r_int
id|msg_id
comma
r_int
id|arg
comma
r_int
id|error_code
comma
r_struct
id|r3964_block_header
op_star
id|pBlock
)paren
suffix:semicolon
r_static
r_struct
id|r3964_message
op_star
id|remove_msg
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_struct
id|r3964_client_info
op_star
id|pClient
)paren
suffix:semicolon
r_static
r_void
id|remove_client_block
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_struct
id|r3964_client_info
op_star
id|pClient
)paren
suffix:semicolon
r_static
r_int
id|r3964_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|r3964_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|r3964_read
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|nr
)paren
suffix:semicolon
r_static
r_int
id|r3964_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|nr
)paren
suffix:semicolon
r_static
r_int
id|r3964_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|r3964_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
suffix:semicolon
r_static
r_int
r_int
id|r3964_poll
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
suffix:semicolon
r_static
r_void
id|r3964_receive_buf
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|cp
comma
r_char
op_star
id|fp
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|r3964_receive_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
DECL|variable|tty_ldisc_N_R3964
r_static
r_struct
id|tty_ldisc
id|tty_ldisc_N_R3964
op_assign
(brace
id|TTY_LDISC_MAGIC
comma
multiline_comment|/* magic */
l_string|&quot;R3964&quot;
comma
multiline_comment|/* name */
l_int|0
comma
multiline_comment|/* num */
l_int|0
comma
multiline_comment|/* flags */
id|r3964_open
comma
multiline_comment|/* open */
id|r3964_close
comma
multiline_comment|/* close */
l_int|0
comma
multiline_comment|/* flush_buffer */
l_int|0
comma
multiline_comment|/* chars_in_buffer */
id|r3964_read
comma
multiline_comment|/* read */
id|r3964_write
comma
multiline_comment|/* write */
id|r3964_ioctl
comma
multiline_comment|/* ioctl */
id|r3964_set_termios
comma
multiline_comment|/* set_termios */
id|r3964_poll
comma
multiline_comment|/* poll */
id|r3964_receive_buf
comma
multiline_comment|/* receive_buf */
id|r3964_receive_room
comma
multiline_comment|/* receive_room */
l_int|0
multiline_comment|/* write_wakeup */
)brace
suffix:semicolon
DECL|function|dump_block
r_static
r_void
id|dump_block
c_func
(paren
r_const
r_int
r_char
op_star
id|block
comma
r_int
r_int
id|length
)paren
(brace
r_int
r_int
id|i
comma
id|j
suffix:semicolon
r_char
id|linebuf
(braket
l_int|16
op_star
l_int|3
op_plus
l_int|1
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_add_assign
l_int|16
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
(paren
id|j
OL
l_int|16
)paren
op_logical_and
(paren
id|j
op_plus
id|i
OL
id|length
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|linebuf
op_plus
l_int|3
op_star
id|j
comma
l_string|&quot;%02x &quot;
comma
id|block
(braket
id|i
op_plus
id|j
)braket
)paren
suffix:semicolon
)brace
id|linebuf
(braket
l_int|3
op_star
id|j
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|TRACE_PS
c_func
(paren
l_string|&quot;%s&quot;
comma
id|linebuf
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*************************************************************&n; * Driver initialisation&n; *************************************************************/
multiline_comment|/*************************************************************&n; * Module support routines&n; *************************************************************/
DECL|function|r3964_exit
r_static
r_void
id|__exit
id|r3964_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|status
suffix:semicolon
id|TRACE_M
(paren
l_string|&quot;cleanup_module()&quot;
)paren
suffix:semicolon
id|status
op_assign
id|tty_register_ldisc
c_func
(paren
id|N_R3964
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;r3964: error unregistering linediscipline: %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
r_else
(brace
id|TRACE_L
c_func
(paren
l_string|&quot;linediscipline successfully unregistered&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|r3964_init
r_static
r_int
id|__init
id|r3964_init
c_func
(paren
r_void
)paren
(brace
r_int
id|status
suffix:semicolon
id|printk
(paren
l_string|&quot;r3964: Philips r3964 Driver $Revision: 1.8 $&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;    * Register the tty line discipline&n;    */
id|status
op_assign
id|tty_register_ldisc
(paren
id|N_R3964
comma
op_amp
id|tty_ldisc_N_R3964
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|TRACE_L
c_func
(paren
l_string|&quot;line discipline %d registered&quot;
comma
id|N_R3964
)paren
suffix:semicolon
id|TRACE_L
c_func
(paren
l_string|&quot;flags=%x num=%x&quot;
comma
id|tty_ldisc_N_R3964.flags
comma
id|tty_ldisc_N_R3964.num
)paren
suffix:semicolon
id|TRACE_L
c_func
(paren
l_string|&quot;open=%x&quot;
comma
(paren
r_int
)paren
id|tty_ldisc_N_R3964.open
)paren
suffix:semicolon
id|TRACE_L
c_func
(paren
l_string|&quot;tty_ldisc_N_R3964 = %x&quot;
comma
(paren
r_int
)paren
op_amp
id|tty_ldisc_N_R3964
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;r3964: error registering line discipline: %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|variable|r3964_init
id|module_init
c_func
(paren
id|r3964_init
)paren
suffix:semicolon
DECL|variable|r3964_exit
id|module_exit
c_func
(paren
id|r3964_exit
)paren
suffix:semicolon
multiline_comment|/*************************************************************&n; * Protocol implementation routines&n; *************************************************************/
DECL|function|on_timer_1
r_static
r_void
id|on_timer_1
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_struct
id|r3964_info
op_star
id|pInfo
op_assign
(paren
r_struct
id|r3964_info
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;count_down
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|pInfo-&gt;count_down
)paren
(brace
id|on_timeout
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
)brace
id|queue_task
c_func
(paren
op_amp
id|pInfo-&gt;bh_2
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
DECL|function|on_timer_2
r_static
r_void
id|on_timer_2
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_struct
id|r3964_info
op_star
id|pInfo
op_assign
(paren
r_struct
id|r3964_info
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;count_down
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|pInfo-&gt;count_down
)paren
(brace
id|on_timeout
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
)brace
id|queue_task
c_func
(paren
op_amp
id|pInfo-&gt;bh_1
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
DECL|function|add_tx_queue
r_static
r_void
id|add_tx_queue
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_struct
id|r3964_block_header
op_star
id|pHeader
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pHeader-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;tx_last
op_eq
l_int|NULL
)paren
(brace
id|pInfo-&gt;tx_first
op_assign
id|pInfo-&gt;tx_last
op_assign
id|pHeader
suffix:semicolon
)brace
r_else
(brace
id|pInfo-&gt;tx_last-&gt;next
op_assign
id|pHeader
suffix:semicolon
id|pInfo-&gt;tx_last
op_assign
id|pHeader
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|TRACE_Q
c_func
(paren
l_string|&quot;add_tx_queue %x, length %d, tx_first = %x&quot;
comma
(paren
r_int
)paren
id|pHeader
comma
id|pHeader-&gt;length
comma
(paren
r_int
)paren
id|pInfo-&gt;tx_first
)paren
suffix:semicolon
)brace
DECL|function|remove_from_tx_queue
r_static
r_void
id|remove_from_tx_queue
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_int
id|error_code
)paren
(brace
r_struct
id|r3964_block_header
op_star
id|pHeader
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef DEBUG_QUEUE
r_struct
id|r3964_block_header
op_star
id|pDump
suffix:semicolon
macro_line|#endif
id|pHeader
op_assign
id|pInfo-&gt;tx_first
suffix:semicolon
r_if
c_cond
(paren
id|pHeader
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_QUEUE
id|printk
c_func
(paren
l_string|&quot;r3964: remove_from_tx_queue: %x, length %d - &quot;
comma
(paren
r_int
)paren
id|pHeader
comma
(paren
r_int
)paren
id|pHeader-&gt;length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pDump
op_assign
id|pHeader
suffix:semicolon
id|pDump
suffix:semicolon
id|pDump
op_assign
id|pDump-&gt;next
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
(paren
r_int
)paren
id|pDump
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pHeader-&gt;owner
)paren
(brace
r_if
c_cond
(paren
id|error_code
)paren
(brace
id|add_msg
c_func
(paren
id|pHeader-&gt;owner
comma
id|R3964_MSG_ACK
comma
l_int|0
comma
id|error_code
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
id|add_msg
c_func
(paren
id|pHeader-&gt;owner
comma
id|R3964_MSG_ACK
comma
id|pHeader-&gt;length
comma
id|error_code
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
(paren
op_amp
id|pInfo-&gt;read_wait
)paren
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pInfo-&gt;tx_first
op_assign
id|pHeader-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;tx_first
op_eq
l_int|NULL
)paren
(brace
id|pInfo-&gt;tx_last
op_assign
l_int|NULL
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pHeader
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;remove_from_tx_queue - kfree %x&quot;
comma
(paren
r_int
)paren
id|pHeader
)paren
suffix:semicolon
id|TRACE_Q
c_func
(paren
l_string|&quot;remove_from_tx_queue: tx_first = %x, tx_last = %x&quot;
comma
(paren
r_int
)paren
id|pInfo-&gt;tx_first
comma
(paren
r_int
)paren
id|pInfo-&gt;tx_last
)paren
suffix:semicolon
)brace
DECL|function|add_rx_queue
r_static
r_void
id|add_rx_queue
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_struct
id|r3964_block_header
op_star
id|pHeader
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pHeader-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;rx_last
op_eq
l_int|NULL
)paren
(brace
id|pInfo-&gt;rx_first
op_assign
id|pInfo-&gt;rx_last
op_assign
id|pHeader
suffix:semicolon
)brace
r_else
(brace
id|pInfo-&gt;rx_last-&gt;next
op_assign
id|pHeader
suffix:semicolon
id|pInfo-&gt;rx_last
op_assign
id|pHeader
suffix:semicolon
)brace
id|pInfo-&gt;blocks_in_rx_queue
op_increment
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|TRACE_Q
c_func
(paren
l_string|&quot;add_rx_queue: %x, length = %d, rx_first = %x, count = %d&quot;
comma
(paren
r_int
)paren
id|pHeader
comma
id|pHeader-&gt;length
comma
(paren
r_int
)paren
id|pInfo-&gt;rx_first
comma
id|pInfo-&gt;blocks_in_rx_queue
)paren
suffix:semicolon
)brace
DECL|function|remove_from_rx_queue
r_static
r_void
id|remove_from_rx_queue
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_struct
id|r3964_block_header
op_star
id|pHeader
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|r3964_block_header
op_star
id|pFind
suffix:semicolon
r_if
c_cond
(paren
id|pHeader
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|TRACE_Q
c_func
(paren
l_string|&quot;remove_from_rx_queue: rx_first = %x, rx_last = %x, count = %d&quot;
comma
(paren
r_int
)paren
id|pInfo-&gt;rx_first
comma
(paren
r_int
)paren
id|pInfo-&gt;rx_last
comma
id|pInfo-&gt;blocks_in_rx_queue
)paren
suffix:semicolon
id|TRACE_Q
c_func
(paren
l_string|&quot;remove_from_rx_queue: %x, length %d&quot;
comma
(paren
r_int
)paren
id|pHeader
comma
(paren
r_int
)paren
id|pHeader-&gt;length
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;rx_first
op_eq
id|pHeader
)paren
(brace
multiline_comment|/* Remove the first block in the linked list: */
id|pInfo-&gt;rx_first
op_assign
id|pHeader-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;rx_first
op_eq
l_int|NULL
)paren
(brace
id|pInfo-&gt;rx_last
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pInfo-&gt;blocks_in_rx_queue
op_decrement
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Find block to remove: */
r_for
c_loop
(paren
id|pFind
op_assign
id|pInfo-&gt;rx_first
suffix:semicolon
id|pFind
suffix:semicolon
id|pFind
op_assign
id|pFind-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pFind-&gt;next
op_eq
id|pHeader
)paren
(brace
multiline_comment|/* Got it. */
id|pFind-&gt;next
op_assign
id|pHeader-&gt;next
suffix:semicolon
id|pInfo-&gt;blocks_in_rx_queue
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|pFind-&gt;next
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Oh, removed the last one! */
id|pInfo-&gt;rx_last
op_assign
id|pFind
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pHeader
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;remove_from_rx_queue - kfree %x&quot;
comma
(paren
r_int
)paren
id|pHeader
)paren
suffix:semicolon
id|TRACE_Q
c_func
(paren
l_string|&quot;remove_from_rx_queue: rx_first = %x, rx_last = %x, count = %d&quot;
comma
(paren
r_int
)paren
id|pInfo-&gt;rx_first
comma
(paren
r_int
)paren
id|pInfo-&gt;rx_last
comma
id|pInfo-&gt;blocks_in_rx_queue
)paren
suffix:semicolon
)brace
DECL|function|put_char
r_static
r_void
id|put_char
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_int
r_char
id|ch
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|pInfo-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;driver.put_char
)paren
(brace
id|tty-&gt;driver
dot
id|put_char
c_func
(paren
id|tty
comma
id|ch
)paren
suffix:semicolon
)brace
id|pInfo-&gt;bcc
op_xor_assign
id|ch
suffix:semicolon
)brace
DECL|function|flush
r_static
r_void
id|flush
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|pInfo-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;driver.flush_chars
)paren
(brace
id|tty-&gt;driver
dot
id|flush_chars
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
)brace
DECL|function|trigger_transmit
r_static
r_void
id|trigger_transmit
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pInfo-&gt;state
op_eq
id|R3964_IDLE
)paren
op_logical_and
(paren
id|pInfo-&gt;tx_first
op_ne
l_int|NULL
)paren
)paren
(brace
id|pInfo-&gt;state
op_assign
id|R3964_TX_REQUEST
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
id|R3964_TO_QVZ
suffix:semicolon
id|pInfo-&gt;nRetry
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;flags
op_and_assign
op_complement
id|R3964_ERROR
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|TRACE_PS
c_func
(paren
l_string|&quot;trigger_transmit - sent STX&quot;
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|pInfo
comma
id|STX
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|pInfo-&gt;bcc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|retry_transmit
r_static
r_void
id|retry_transmit
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
(brace
r_if
c_cond
(paren
id|pInfo-&gt;nRetry
OL
id|R3964_MAX_RETRIES
)paren
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;transmission failed. Retry #%d&quot;
comma
id|pInfo-&gt;nRetry
)paren
suffix:semicolon
id|pInfo-&gt;bcc
op_assign
l_int|0
suffix:semicolon
id|put_char
c_func
(paren
id|pInfo
comma
id|STX
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_TX_REQUEST
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
id|R3964_TO_QVZ
suffix:semicolon
id|pInfo-&gt;nRetry
op_increment
suffix:semicolon
)brace
r_else
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;transmission failed after %d retries&quot;
comma
id|R3964_MAX_RETRIES
)paren
suffix:semicolon
id|remove_from_tx_queue
c_func
(paren
id|pInfo
comma
id|R3964_TX_FAIL
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|pInfo
comma
id|NAK
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_IDLE
suffix:semicolon
id|trigger_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
)brace
DECL|function|transmit_block
r_static
r_void
id|transmit_block
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|pInfo-&gt;tty
suffix:semicolon
r_struct
id|r3964_block_header
op_star
id|pBlock
op_assign
id|pInfo-&gt;tx_first
suffix:semicolon
r_int
id|room
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|pBlock
op_eq
l_int|NULL
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;driver.write_room
)paren
(brace
id|room
op_assign
id|tty-&gt;driver
dot
id|write_room
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
id|TRACE_PS
c_func
(paren
l_string|&quot;transmit_block %x, room %d, length %d&quot;
comma
(paren
r_int
)paren
id|pBlock
comma
id|room
comma
id|pBlock-&gt;length
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pInfo-&gt;tx_position
OL
id|pBlock-&gt;length
)paren
(brace
r_if
c_cond
(paren
id|room
OL
l_int|2
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pBlock-&gt;data
(braket
id|pInfo-&gt;tx_position
)braket
op_eq
id|DLE
)paren
(brace
multiline_comment|/* send additional DLE char: */
id|put_char
c_func
(paren
id|pInfo
comma
id|DLE
)paren
suffix:semicolon
)brace
id|put_char
c_func
(paren
id|pInfo
comma
id|pBlock-&gt;data
(braket
id|pInfo-&gt;tx_position
op_increment
)braket
)paren
suffix:semicolon
id|room
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pInfo-&gt;tx_position
op_eq
id|pBlock-&gt;length
)paren
op_logical_and
(paren
id|room
op_ge
l_int|3
)paren
)paren
(brace
id|put_char
c_func
(paren
id|pInfo
comma
id|DLE
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|pInfo
comma
id|ETX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;flags
op_amp
id|R3964_BCC
)paren
(brace
id|put_char
c_func
(paren
id|pInfo
comma
id|pInfo-&gt;bcc
)paren
suffix:semicolon
)brace
id|pInfo-&gt;state
op_assign
id|R3964_WAIT_FOR_TX_ACK
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
id|R3964_TO_QVZ
suffix:semicolon
)brace
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
DECL|function|on_receive_block
r_static
r_void
id|on_receive_block
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
(brace
r_int
r_int
id|length
suffix:semicolon
r_struct
id|r3964_client_info
op_star
id|pClient
suffix:semicolon
r_struct
id|r3964_block_header
op_star
id|pBlock
suffix:semicolon
id|length
op_assign
id|pInfo-&gt;rx_position
suffix:semicolon
multiline_comment|/* compare byte checksum characters: */
r_if
c_cond
(paren
id|pInfo-&gt;flags
op_amp
id|R3964_BCC
)paren
(brace
r_if
c_cond
(paren
id|pInfo-&gt;bcc
op_ne
id|pInfo-&gt;last_rx
)paren
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;checksum error - got %x but expected %x&quot;
comma
id|pInfo-&gt;last_rx
comma
id|pInfo-&gt;bcc
)paren
suffix:semicolon
id|pInfo-&gt;flags
op_or_assign
id|R3964_CHECKSUM
suffix:semicolon
)brace
)brace
multiline_comment|/* check for errors (parity, overrun,...): */
r_if
c_cond
(paren
id|pInfo-&gt;flags
op_amp
id|R3964_ERROR
)paren
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;on_receive_block - transmission failed error %x&quot;
comma
id|pInfo-&gt;flags
op_amp
id|R3964_ERROR
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|pInfo
comma
id|NAK
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;nRetry
OL
id|R3964_MAX_RETRIES
)paren
(brace
id|pInfo-&gt;state
op_assign
id|R3964_WAIT_FOR_RX_REPEAT
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
id|R3964_TO_RX_PANIC
suffix:semicolon
id|pInfo-&gt;nRetry
op_increment
suffix:semicolon
)brace
r_else
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;on_receive_block - failed after max retries&quot;
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_IDLE
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* received block; submit DLE: */
id|put_char
c_func
(paren
id|pInfo
comma
id|DLE
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
l_int|0
suffix:semicolon
id|TRACE_PS
c_func
(paren
l_string|&quot; rx success: got %d chars&quot;
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* prepare struct r3964_block_header: */
id|pBlock
op_assign
id|kmalloc
c_func
(paren
id|length
op_plus
r_sizeof
(paren
r_struct
id|r3964_block_header
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;on_receive_block - kmalloc %x&quot;
comma
(paren
r_int
)paren
id|pBlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pBlock
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|pBlock-&gt;length
op_assign
id|length
suffix:semicolon
id|pBlock-&gt;data
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|pBlock
)paren
op_plus
r_sizeof
(paren
r_struct
id|r3964_block_header
)paren
suffix:semicolon
id|pBlock-&gt;locks
op_assign
l_int|0
suffix:semicolon
id|pBlock-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|pBlock-&gt;owner
op_assign
l_int|NULL
suffix:semicolon
id|memcpy
c_func
(paren
id|pBlock-&gt;data
comma
id|pInfo-&gt;rx_buf
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* queue block into rx_queue: */
id|add_rx_queue
c_func
(paren
id|pInfo
comma
id|pBlock
)paren
suffix:semicolon
multiline_comment|/* notify attached client processes: */
r_for
c_loop
(paren
id|pClient
op_assign
id|pInfo-&gt;firstClient
suffix:semicolon
id|pClient
suffix:semicolon
id|pClient
op_assign
id|pClient-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pClient-&gt;sig_flags
op_amp
id|R3964_SIG_DATA
)paren
(brace
id|add_msg
c_func
(paren
id|pClient
comma
id|R3964_MSG_DATA
comma
id|length
comma
id|R3964_OK
comma
id|pBlock
)paren
suffix:semicolon
)brace
)brace
id|wake_up_interruptible
(paren
op_amp
id|pInfo-&gt;read_wait
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_IDLE
suffix:semicolon
id|trigger_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
DECL|function|receive_char
r_static
r_void
id|receive_char
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_const
r_int
r_char
id|c
)paren
(brace
r_switch
c_cond
(paren
id|pInfo-&gt;state
)paren
(brace
r_case
id|R3964_TX_REQUEST
suffix:colon
r_if
c_cond
(paren
id|c
op_eq
id|DLE
)paren
(brace
id|TRACE_PS
c_func
(paren
l_string|&quot;TX_REQUEST - got DLE&quot;
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_TRANSMITTING
suffix:semicolon
id|pInfo-&gt;tx_position
op_assign
l_int|0
suffix:semicolon
id|transmit_block
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|c
op_eq
id|STX
)paren
(brace
r_if
c_cond
(paren
id|pInfo-&gt;nRetry
op_eq
l_int|0
)paren
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;TX_REQUEST - init conflict&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;priority
op_eq
id|R3964_SLAVE
)paren
(brace
r_goto
id|start_receiving
suffix:semicolon
)brace
)brace
r_else
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;TX_REQUEST - secondary init conflict!?&quot;
l_string|&quot; Switching to SLAVE mode for next rx.&quot;
)paren
suffix:semicolon
r_goto
id|start_receiving
suffix:semicolon
)brace
)brace
r_else
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;TX_REQUEST - char != DLE: %x&quot;
comma
id|c
)paren
suffix:semicolon
id|retry_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|R3964_TRANSMITTING
suffix:colon
r_if
c_cond
(paren
id|c
op_eq
id|NAK
)paren
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;TRANSMITTING - got NAK&quot;
)paren
suffix:semicolon
id|retry_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
r_else
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;TRANSMITTING - got illegal char&quot;
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_WAIT_ZVZ_BEFORE_TX_RETRY
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
id|R3964_TO_ZVZ
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|R3964_WAIT_FOR_TX_ACK
suffix:colon
r_if
c_cond
(paren
id|c
op_eq
id|DLE
)paren
(brace
id|TRACE_PS
c_func
(paren
l_string|&quot;WAIT_FOR_TX_ACK - got DLE&quot;
)paren
suffix:semicolon
id|remove_from_tx_queue
c_func
(paren
id|pInfo
comma
id|R3964_OK
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_IDLE
suffix:semicolon
id|trigger_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
r_else
(brace
id|retry_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|R3964_WAIT_FOR_RX_REPEAT
suffix:colon
multiline_comment|/* FALLTROUGH */
r_case
id|R3964_IDLE
suffix:colon
r_if
c_cond
(paren
id|c
op_eq
id|STX
)paren
(brace
multiline_comment|/* Prevent rx_queue from overflow: */
r_if
c_cond
(paren
id|pInfo-&gt;blocks_in_rx_queue
op_ge
id|R3964_MAX_BLOCKS_IN_RX_QUEUE
)paren
(brace
id|TRACE_PE
c_func
(paren
l_string|&quot;IDLE - got STX but no space in rx_queue!&quot;
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_WAIT_FOR_RX_BUF
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
id|R3964_TO_NO_BUF
suffix:semicolon
r_break
suffix:semicolon
)brace
id|start_receiving
suffix:colon
multiline_comment|/* Ok, start receiving: */
id|TRACE_PS
c_func
(paren
l_string|&quot;IDLE - got STX&quot;
)paren
suffix:semicolon
id|pInfo-&gt;rx_position
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;last_rx
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;flags
op_and_assign
op_complement
id|R3964_ERROR
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_RECEIVING
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
id|R3964_TO_ZVZ
suffix:semicolon
id|pInfo-&gt;nRetry
op_assign
l_int|0
suffix:semicolon
id|put_char
c_func
(paren
id|pInfo
comma
id|DLE
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|pInfo-&gt;bcc
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|R3964_RECEIVING
suffix:colon
r_if
c_cond
(paren
id|pInfo-&gt;rx_position
OL
id|RX_BUF_SIZE
)paren
(brace
id|pInfo-&gt;bcc
op_xor_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
id|DLE
)paren
(brace
r_if
c_cond
(paren
id|pInfo-&gt;last_rx
op_eq
id|DLE
)paren
(brace
id|pInfo-&gt;last_rx
op_assign
l_int|0
suffix:semicolon
r_goto
id|char_to_buf
suffix:semicolon
)brace
id|pInfo-&gt;last_rx
op_assign
id|DLE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|c
op_eq
id|ETX
)paren
op_logical_and
(paren
id|pInfo-&gt;last_rx
op_eq
id|DLE
)paren
)paren
(brace
r_if
c_cond
(paren
id|pInfo-&gt;flags
op_amp
id|R3964_BCC
)paren
(brace
id|pInfo-&gt;state
op_assign
id|R3964_WAIT_FOR_BCC
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
id|R3964_TO_ZVZ
suffix:semicolon
)brace
r_else
(brace
id|on_receive_block
c_func
(paren
id|pInfo
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|pInfo-&gt;last_rx
op_assign
id|c
suffix:semicolon
id|char_to_buf
suffix:colon
id|pInfo-&gt;rx_buf
(braket
id|pInfo-&gt;rx_position
op_increment
)braket
op_assign
id|c
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
id|R3964_TO_ZVZ
suffix:semicolon
)brace
)brace
multiline_comment|/* else: overflow-msg? BUF_SIZE&gt;MTU; should not happen? */
r_break
suffix:semicolon
r_case
id|R3964_WAIT_FOR_BCC
suffix:colon
id|pInfo-&gt;last_rx
op_assign
id|c
suffix:semicolon
id|on_receive_block
c_func
(paren
id|pInfo
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|receive_error
r_static
r_void
id|receive_error
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_const
r_char
id|flag
)paren
(brace
r_switch
c_cond
(paren
id|flag
)paren
(brace
r_case
id|TTY_NORMAL
suffix:colon
r_break
suffix:semicolon
r_case
id|TTY_BREAK
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;received break&quot;
)paren
id|pInfo-&gt;flags
op_or_assign
id|R3964_BREAK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TTY_PARITY
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;parity error&quot;
)paren
id|pInfo-&gt;flags
op_or_assign
id|R3964_PARITY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TTY_FRAME
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;frame error&quot;
)paren
id|pInfo-&gt;flags
op_or_assign
id|R3964_FRAME
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TTY_OVERRUN
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;frame overrun&quot;
)paren
id|pInfo-&gt;flags
op_or_assign
id|R3964_OVERRUN
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;receive_error - unknown flag %d&quot;
comma
id|flag
)paren
suffix:semicolon
id|pInfo-&gt;flags
op_or_assign
id|R3964_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|on_timeout
r_static
r_void
id|on_timeout
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
)paren
(brace
r_switch
c_cond
(paren
id|pInfo-&gt;state
)paren
(brace
r_case
id|R3964_TX_REQUEST
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;TX_REQUEST - timeout&quot;
)paren
suffix:semicolon
id|retry_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R3964_WAIT_ZVZ_BEFORE_TX_RETRY
suffix:colon
id|put_char
c_func
(paren
id|pInfo
comma
id|NAK
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|retry_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R3964_WAIT_FOR_TX_ACK
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;WAIT_FOR_TX_ACK - timeout&quot;
)paren
suffix:semicolon
id|retry_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R3964_WAIT_FOR_RX_BUF
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;WAIT_FOR_RX_BUF - timeout&quot;
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|pInfo
comma
id|NAK
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_IDLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R3964_RECEIVING
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;RECEIVING - timeout after %d chars&quot;
comma
id|pInfo-&gt;rx_position
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|pInfo
comma
id|NAK
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_IDLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R3964_WAIT_FOR_RX_REPEAT
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;WAIT_FOR_RX_REPEAT - timeout&quot;
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_IDLE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R3964_WAIT_FOR_BCC
suffix:colon
id|TRACE_PE
c_func
(paren
l_string|&quot;WAIT_FOR_BCC - timeout&quot;
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|pInfo
comma
id|NAK
)paren
suffix:semicolon
id|flush
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_IDLE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|findClient
r_static
r_struct
id|r3964_client_info
op_star
id|findClient
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
id|pid_t
id|pid
)paren
(brace
r_struct
id|r3964_client_info
op_star
id|pClient
suffix:semicolon
r_for
c_loop
(paren
id|pClient
op_assign
id|pInfo-&gt;firstClient
suffix:semicolon
id|pClient
suffix:semicolon
id|pClient
op_assign
id|pClient-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pClient-&gt;pid
op_eq
id|pid
)paren
(brace
r_return
id|pClient
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|enable_signals
r_static
r_int
id|enable_signals
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
id|pid_t
id|pid
comma
r_int
id|arg
)paren
(brace
r_struct
id|r3964_client_info
op_star
id|pClient
suffix:semicolon
r_struct
id|r3964_client_info
op_star
op_star
id|ppClient
suffix:semicolon
r_struct
id|r3964_message
op_star
id|pMsg
suffix:semicolon
r_if
c_cond
(paren
(paren
id|arg
op_amp
id|R3964_SIG_ALL
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Remove client from client list */
r_for
c_loop
(paren
id|ppClient
op_assign
op_amp
id|pInfo-&gt;firstClient
suffix:semicolon
op_star
id|ppClient
suffix:semicolon
id|ppClient
op_assign
op_amp
(paren
op_star
id|ppClient
)paren
op_member_access_from_pointer
id|next
)paren
(brace
id|pClient
op_assign
op_star
id|ppClient
suffix:semicolon
r_if
c_cond
(paren
id|pClient-&gt;pid
op_eq
id|pid
)paren
(brace
id|TRACE_PS
c_func
(paren
l_string|&quot;removing client %d from client list&quot;
comma
id|pid
)paren
suffix:semicolon
op_star
id|ppClient
op_assign
id|pClient-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|pClient-&gt;msg_count
)paren
(brace
id|pMsg
op_assign
id|remove_msg
c_func
(paren
id|pInfo
comma
id|pClient
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pMsg
)paren
(brace
id|kfree
c_func
(paren
id|pMsg
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;enable_signals - msg kfree %x&quot;
comma
(paren
r_int
)paren
id|pMsg
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|pClient
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;enable_signals - kfree %x&quot;
comma
(paren
r_int
)paren
id|pClient
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|pClient
op_assign
id|findClient
c_func
(paren
id|pInfo
comma
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pClient
)paren
(brace
multiline_comment|/* update signal options */
id|pClient-&gt;sig_flags
op_assign
id|arg
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* add client to client list */
id|pClient
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|r3964_client_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;enable_signals - kmalloc %x&quot;
comma
(paren
r_int
)paren
id|pClient
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pClient
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|TRACE_PS
c_func
(paren
l_string|&quot;add client %d to client list&quot;
comma
id|pid
)paren
suffix:semicolon
id|pClient-&gt;sig_flags
op_assign
id|arg
suffix:semicolon
id|pClient-&gt;pid
op_assign
id|pid
suffix:semicolon
id|pClient-&gt;next
op_assign
id|pInfo-&gt;firstClient
suffix:semicolon
id|pClient-&gt;first_msg
op_assign
l_int|NULL
suffix:semicolon
id|pClient-&gt;last_msg
op_assign
l_int|NULL
suffix:semicolon
id|pClient-&gt;next_block_to_read
op_assign
l_int|NULL
suffix:semicolon
id|pClient-&gt;msg_count
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;firstClient
op_assign
id|pClient
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|read_telegram
r_static
r_int
id|read_telegram
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
id|pid_t
id|pid
comma
r_int
r_char
op_star
id|buf
)paren
(brace
r_struct
id|r3964_client_info
op_star
id|pClient
suffix:semicolon
r_struct
id|r3964_block_header
op_star
id|block
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pClient
op_assign
id|findClient
c_func
(paren
id|pInfo
comma
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pClient
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|block
op_assign
id|pClient-&gt;next_block_to_read
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|block
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|copy_to_user
(paren
id|buf
comma
id|block-&gt;data
comma
id|block-&gt;length
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|remove_client_block
c_func
(paren
id|pInfo
comma
id|pClient
)paren
suffix:semicolon
r_return
id|block-&gt;length
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|add_msg
r_static
r_void
id|add_msg
c_func
(paren
r_struct
id|r3964_client_info
op_star
id|pClient
comma
r_int
id|msg_id
comma
r_int
id|arg
comma
r_int
id|error_code
comma
r_struct
id|r3964_block_header
op_star
id|pBlock
)paren
(brace
r_struct
id|r3964_message
op_star
id|pMsg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|pClient-&gt;msg_count
OL
id|R3964_MAX_MSG_COUNT
op_minus
l_int|1
)paren
(brace
id|queue_the_message
suffix:colon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pMsg
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|r3964_message
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;add_msg - kmalloc %x&quot;
comma
(paren
r_int
)paren
id|pMsg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pMsg
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|pMsg-&gt;msg_id
op_assign
id|msg_id
suffix:semicolon
id|pMsg-&gt;arg
op_assign
id|arg
suffix:semicolon
id|pMsg-&gt;error_code
op_assign
id|error_code
suffix:semicolon
id|pMsg-&gt;block
op_assign
id|pBlock
suffix:semicolon
id|pMsg-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pClient-&gt;last_msg
op_eq
l_int|NULL
)paren
(brace
id|pClient-&gt;first_msg
op_assign
id|pClient-&gt;last_msg
op_assign
id|pMsg
suffix:semicolon
)brace
r_else
(brace
id|pClient-&gt;last_msg-&gt;next
op_assign
id|pMsg
suffix:semicolon
id|pClient-&gt;last_msg
op_assign
id|pMsg
suffix:semicolon
)brace
id|pClient-&gt;msg_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pBlock
op_ne
l_int|NULL
)paren
(brace
id|pBlock-&gt;locks
op_increment
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|pClient-&gt;last_msg-&gt;msg_id
op_eq
id|R3964_MSG_ACK
)paren
op_logical_and
(paren
id|pClient-&gt;last_msg-&gt;error_code
op_eq
id|R3964_OVERFLOW
)paren
)paren
(brace
id|pClient-&gt;last_msg-&gt;arg
op_increment
suffix:semicolon
id|TRACE_PE
c_func
(paren
l_string|&quot;add_msg - inc prev OVERFLOW-msg&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|msg_id
op_assign
id|R3964_MSG_ACK
suffix:semicolon
id|arg
op_assign
l_int|0
suffix:semicolon
id|error_code
op_assign
id|R3964_OVERFLOW
suffix:semicolon
id|pBlock
op_assign
l_int|NULL
suffix:semicolon
id|TRACE_PE
c_func
(paren
l_string|&quot;add_msg - queue OVERFLOW-msg&quot;
)paren
suffix:semicolon
r_goto
id|queue_the_message
suffix:semicolon
)brace
)brace
multiline_comment|/* Send SIGIO signal to client process: */
r_if
c_cond
(paren
id|pClient-&gt;sig_flags
op_amp
id|R3964_USE_SIGIO
)paren
(brace
id|kill_proc
c_func
(paren
id|pClient-&gt;pid
comma
id|SIGIO
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|function|remove_msg
r_static
r_struct
id|r3964_message
op_star
id|remove_msg
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_struct
id|r3964_client_info
op_star
id|pClient
)paren
(brace
r_struct
id|r3964_message
op_star
id|pMsg
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|pClient-&gt;first_msg
)paren
(brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pMsg
op_assign
id|pClient-&gt;first_msg
suffix:semicolon
id|pClient-&gt;first_msg
op_assign
id|pMsg-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|pClient-&gt;first_msg
op_eq
l_int|NULL
)paren
(brace
id|pClient-&gt;last_msg
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pClient-&gt;msg_count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|pMsg-&gt;block
)paren
(brace
id|remove_client_block
c_func
(paren
id|pInfo
comma
id|pClient
)paren
suffix:semicolon
id|pClient-&gt;next_block_to_read
op_assign
id|pMsg-&gt;block
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
r_return
id|pMsg
suffix:semicolon
)brace
DECL|function|remove_client_block
r_static
r_void
id|remove_client_block
c_func
(paren
r_struct
id|r3964_info
op_star
id|pInfo
comma
r_struct
id|r3964_client_info
op_star
id|pClient
)paren
(brace
r_struct
id|r3964_block_header
op_star
id|block
suffix:semicolon
id|TRACE_PS
c_func
(paren
l_string|&quot;remove_client_block PID %d&quot;
comma
id|pClient-&gt;pid
)paren
suffix:semicolon
id|block
op_assign
id|pClient-&gt;next_block_to_read
suffix:semicolon
r_if
c_cond
(paren
id|block
)paren
(brace
id|block-&gt;locks
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|block-&gt;locks
op_eq
l_int|0
)paren
(brace
id|remove_from_rx_queue
c_func
(paren
id|pInfo
comma
id|block
)paren
suffix:semicolon
)brace
)brace
id|pClient-&gt;next_block_to_read
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*************************************************************&n; * Line discipline routines&n; *************************************************************/
DECL|function|r3964_open
r_static
r_int
id|r3964_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|r3964_info
op_star
id|pInfo
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|TRACE_L
c_func
(paren
l_string|&quot;open&quot;
)paren
suffix:semicolon
id|TRACE_L
c_func
(paren
l_string|&quot;tty=%x, PID=%d, disc_data=%x&quot;
comma
(paren
r_int
)paren
id|tty
comma
id|current-&gt;pid
comma
(paren
r_int
)paren
id|tty-&gt;disc_data
)paren
suffix:semicolon
id|pInfo
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|r3964_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_open - info kmalloc %x&quot;
comma
(paren
r_int
)paren
id|pInfo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pInfo
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;r3964: failed to alloc info structure&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pInfo-&gt;rx_buf
op_assign
id|kmalloc
c_func
(paren
id|RX_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_open - rx_buf kmalloc %x&quot;
comma
(paren
r_int
)paren
id|pInfo-&gt;rx_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pInfo-&gt;rx_buf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;r3964: failed to alloc receive buffer&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_open - info kfree %x&quot;
comma
(paren
r_int
)paren
id|pInfo
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pInfo-&gt;tx_buf
op_assign
id|kmalloc
c_func
(paren
id|TX_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_open - tx_buf kmalloc %x&quot;
comma
(paren
r_int
)paren
id|pInfo-&gt;tx_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pInfo-&gt;tx_buf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;r3964: failed to alloc transmit buffer&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pInfo-&gt;rx_buf
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_open - rx_buf kfree %x&quot;
comma
(paren
r_int
)paren
id|pInfo-&gt;rx_buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_open - info kfree %x&quot;
comma
(paren
r_int
)paren
id|pInfo
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pInfo-&gt;tty
op_assign
id|tty
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|pInfo-&gt;read_wait
)paren
suffix:semicolon
id|pInfo-&gt;priority
op_assign
id|R3964_MASTER
suffix:semicolon
id|pInfo-&gt;rx_first
op_assign
id|pInfo-&gt;rx_last
op_assign
l_int|NULL
suffix:semicolon
id|pInfo-&gt;tx_first
op_assign
id|pInfo-&gt;tx_last
op_assign
l_int|NULL
suffix:semicolon
id|pInfo-&gt;rx_position
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;tx_position
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;last_rx
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;blocks_in_rx_queue
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;firstClient
op_assign
l_int|NULL
suffix:semicolon
id|pInfo-&gt;state
op_assign
id|R3964_IDLE
suffix:semicolon
id|pInfo-&gt;flags
op_assign
id|R3964_DEBUG
suffix:semicolon
id|pInfo-&gt;count_down
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;nRetry
op_assign
l_int|0
suffix:semicolon
id|tty-&gt;disc_data
op_assign
id|pInfo
suffix:semicolon
multiline_comment|/*&n;    * Add &squot;on_timer&squot; to timer task queue&n;    * (will be called from timer bh)&n;    */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|pInfo-&gt;bh_1.list
)paren
suffix:semicolon
id|pInfo-&gt;bh_1.sync
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;bh_1.routine
op_assign
op_amp
id|on_timer_1
suffix:semicolon
id|pInfo-&gt;bh_1.data
op_assign
id|pInfo
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|pInfo-&gt;bh_2.list
)paren
suffix:semicolon
id|pInfo-&gt;bh_2.sync
op_assign
l_int|0
suffix:semicolon
id|pInfo-&gt;bh_2.routine
op_assign
op_amp
id|on_timer_2
suffix:semicolon
id|pInfo-&gt;bh_2.data
op_assign
id|pInfo
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|pInfo-&gt;bh_1
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r3964_close
r_static
r_void
id|r3964_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|r3964_info
op_star
id|pInfo
op_assign
(paren
r_struct
id|r3964_info
op_star
)paren
id|tty-&gt;disc_data
suffix:semicolon
r_struct
id|r3964_client_info
op_star
id|pClient
comma
op_star
id|pNext
suffix:semicolon
r_struct
id|r3964_message
op_star
id|pMsg
suffix:semicolon
r_struct
id|r3964_block_header
op_star
id|pHeader
comma
op_star
id|pNextHeader
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|TRACE_L
c_func
(paren
l_string|&quot;close&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;     * Make sure that our task queue isn&squot;t activated.  If it&n;     * is, take it out of the linked list.&n;     */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tqueue_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;bh_1.sync
)paren
id|list_del
c_func
(paren
op_amp
id|pInfo-&gt;bh_1.list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pInfo-&gt;bh_2.sync
)paren
id|list_del
c_func
(paren
op_amp
id|pInfo-&gt;bh_2.list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tqueue_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Remove client-structs and message queues: */
id|pClient
op_assign
id|pInfo-&gt;firstClient
suffix:semicolon
r_while
c_loop
(paren
id|pClient
)paren
(brace
id|pNext
op_assign
id|pClient-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|pClient-&gt;msg_count
)paren
(brace
id|pMsg
op_assign
id|remove_msg
c_func
(paren
id|pInfo
comma
id|pClient
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pMsg
)paren
(brace
id|kfree
c_func
(paren
id|pMsg
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_close - msg kfree %x&quot;
comma
(paren
r_int
)paren
id|pMsg
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|pClient
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_close - client kfree %x&quot;
comma
(paren
r_int
)paren
id|pClient
)paren
suffix:semicolon
id|pClient
op_assign
id|pNext
suffix:semicolon
)brace
multiline_comment|/* Remove jobs from tx_queue: */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pHeader
op_assign
id|pInfo-&gt;tx_first
suffix:semicolon
id|pInfo-&gt;tx_first
op_assign
id|pInfo-&gt;tx_last
op_assign
l_int|NULL
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pHeader
)paren
(brace
id|pNextHeader
op_assign
id|pHeader-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|pHeader
)paren
suffix:semicolon
id|pHeader
op_assign
id|pNextHeader
suffix:semicolon
)brace
multiline_comment|/* Free buffers: */
id|wake_up_interruptible
c_func
(paren
op_amp
id|pInfo-&gt;read_wait
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pInfo-&gt;rx_buf
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_close - rx_buf kfree %x&quot;
comma
(paren
r_int
)paren
id|pInfo-&gt;rx_buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pInfo-&gt;tx_buf
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_close - tx_buf kfree %x&quot;
comma
(paren
r_int
)paren
id|pInfo-&gt;tx_buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pInfo
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_close - info kfree %x&quot;
comma
(paren
r_int
)paren
id|pInfo
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|r3964_read
r_static
r_int
id|r3964_read
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|nr
)paren
(brace
r_struct
id|r3964_info
op_star
id|pInfo
op_assign
(paren
r_struct
id|r3964_info
op_star
)paren
id|tty-&gt;disc_data
suffix:semicolon
r_struct
id|r3964_client_info
op_star
id|pClient
suffix:semicolon
r_struct
id|r3964_message
op_star
id|pMsg
suffix:semicolon
r_struct
id|r3964_client_message
id|theMsg
suffix:semicolon
id|DECLARE_WAITQUEUE
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|pid
op_assign
id|current-&gt;pid
suffix:semicolon
r_int
id|count
suffix:semicolon
id|TRACE_L
c_func
(paren
l_string|&quot;read()&quot;
)paren
suffix:semicolon
id|pClient
op_assign
id|findClient
c_func
(paren
id|pInfo
comma
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pClient
)paren
(brace
id|pMsg
op_assign
id|remove_msg
c_func
(paren
id|pInfo
comma
id|pClient
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pMsg
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no messages available. */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* block until there is a message: */
id|add_wait_queue
c_func
(paren
op_amp
id|pInfo-&gt;read_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|repeat
suffix:colon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|pMsg
op_assign
id|remove_msg
c_func
(paren
id|pInfo
comma
id|pClient
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pMsg
op_logical_and
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|pInfo-&gt;read_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
multiline_comment|/* If we still haven&squot;t got a message, we must have been signalled */
r_if
c_cond
(paren
op_logical_neg
id|pMsg
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
multiline_comment|/* deliver msg to client process: */
id|theMsg.msg_id
op_assign
id|pMsg-&gt;msg_id
suffix:semicolon
id|theMsg.arg
op_assign
id|pMsg-&gt;arg
suffix:semicolon
id|theMsg.error_code
op_assign
id|pMsg-&gt;error_code
suffix:semicolon
id|count
op_assign
r_sizeof
(paren
r_struct
id|r3964_client_message
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pMsg
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_read - msg kfree %x&quot;
comma
(paren
r_int
)paren
id|pMsg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|theMsg
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|TRACE_PS
c_func
(paren
l_string|&quot;read - return %d&quot;
comma
id|count
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
DECL|function|r3964_write
r_static
r_int
id|r3964_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_const
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|r3964_info
op_star
id|pInfo
op_assign
(paren
r_struct
id|r3964_info
op_star
)paren
id|tty-&gt;disc_data
suffix:semicolon
r_struct
id|r3964_block_header
op_star
id|pHeader
suffix:semicolon
r_struct
id|r3964_client_info
op_star
id|pClient
suffix:semicolon
r_int
r_char
op_star
id|new_data
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|pid
suffix:semicolon
id|TRACE_L
c_func
(paren
l_string|&quot;write request, %d characters&quot;
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* &n; * Verify the pointers &n; */
r_if
c_cond
(paren
op_logical_neg
id|pInfo
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|status
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
id|data
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
(brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Ensure that the caller does not wish to send too much.&n; */
r_if
c_cond
(paren
id|count
OG
id|R3964_MTU
)paren
(brace
r_if
c_cond
(paren
id|pInfo-&gt;flags
op_amp
id|R3964_DEBUG
)paren
(brace
id|TRACE_L
(paren
id|KERN_WARNING
l_string|&quot;r3964_write: truncating user packet &quot;
l_string|&quot;from %u to mtu %d&quot;
comma
id|count
comma
id|R3964_MTU
)paren
suffix:semicolon
)brace
id|count
op_assign
id|R3964_MTU
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a buffer for the data and fetch it from the user space.&n; */
id|new_data
op_assign
id|kmalloc
(paren
id|count
op_plus
r_sizeof
(paren
r_struct
id|r3964_block_header
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|TRACE_M
c_func
(paren
l_string|&quot;r3964_write - kmalloc %x&quot;
comma
(paren
r_int
)paren
id|new_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_data
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pInfo-&gt;flags
op_amp
id|R3964_DEBUG
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;r3964_write: no memory&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|pHeader
op_assign
(paren
r_struct
id|r3964_block_header
op_star
)paren
id|new_data
suffix:semicolon
id|pHeader-&gt;data
op_assign
id|new_data
op_plus
r_sizeof
(paren
r_struct
id|r3964_block_header
)paren
suffix:semicolon
id|pHeader-&gt;length
op_assign
id|count
suffix:semicolon
id|pHeader-&gt;locks
op_assign
l_int|0
suffix:semicolon
id|pHeader-&gt;owner
op_assign
l_int|NULL
suffix:semicolon
id|pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|pClient
op_assign
id|findClient
c_func
(paren
id|pInfo
comma
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pClient
)paren
(brace
id|pHeader-&gt;owner
op_assign
id|pClient
suffix:semicolon
)brace
id|copy_from_user
(paren
id|pHeader-&gt;data
comma
id|data
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* We already verified this */
r_if
c_cond
(paren
id|pInfo-&gt;flags
op_amp
id|R3964_DEBUG
)paren
(brace
id|dump_block
c_func
(paren
id|pHeader-&gt;data
comma
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Add buffer to transmit-queue:&n; */
id|add_tx_queue
c_func
(paren
id|pInfo
comma
id|pHeader
)paren
suffix:semicolon
id|trigger_transmit
c_func
(paren
id|pInfo
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r3964_ioctl
r_static
r_int
id|r3964_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|r3964_info
op_star
id|pInfo
op_assign
(paren
r_struct
id|r3964_info
op_star
)paren
id|tty-&gt;disc_data
suffix:semicolon
r_if
c_cond
(paren
id|pInfo
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|R3964_ENABLE_SIGNALS
suffix:colon
r_return
id|enable_signals
c_func
(paren
id|pInfo
comma
id|current-&gt;pid
comma
id|arg
)paren
suffix:semicolon
r_case
id|R3964_SETPRIORITY
suffix:colon
r_if
c_cond
(paren
id|arg
id|R3964_SLAVE
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pInfo-&gt;priority
op_assign
id|arg
op_amp
l_int|0xff
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|R3964_USE_BCC
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|pInfo-&gt;flags
op_or_assign
id|R3964_BCC
suffix:semicolon
)brace
r_else
id|pInfo-&gt;flags
op_and_assign
op_complement
id|R3964_BCC
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|R3964_READ_TELEGRAM
suffix:colon
r_return
id|read_telegram
c_func
(paren
id|pInfo
comma
id|current-&gt;pid
comma
(paren
r_int
r_char
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
DECL|function|r3964_set_termios
r_static
r_void
id|r3964_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
id|TRACE_L
c_func
(paren
l_string|&quot;set_termios&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Called without the kernel lock held - fine */
DECL|function|r3964_poll
r_static
r_int
r_int
id|r3964_poll
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|r3964_info
op_star
id|pInfo
op_assign
(paren
r_struct
id|r3964_info
op_star
)paren
id|tty-&gt;disc_data
suffix:semicolon
r_int
id|pid
op_assign
id|current-&gt;pid
suffix:semicolon
r_struct
id|r3964_client_info
op_star
id|pClient
suffix:semicolon
r_struct
id|r3964_message
op_star
id|pMsg
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|result
op_assign
id|POLLOUT
suffix:semicolon
id|TRACE_L
c_func
(paren
l_string|&quot;POLL&quot;
)paren
suffix:semicolon
id|pClient
op_assign
id|findClient
c_func
(paren
id|pInfo
comma
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pClient
)paren
(brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|pInfo-&gt;read_wait
comma
id|wait
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|pMsg
op_assign
id|pClient-&gt;first_msg
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pMsg
)paren
(brace
id|result
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
)brace
r_else
(brace
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|r3964_receive_buf
r_static
r_void
id|r3964_receive_buf
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|cp
comma
r_char
op_star
id|fp
comma
r_int
id|count
)paren
(brace
r_struct
id|r3964_info
op_star
id|pInfo
op_assign
(paren
r_struct
id|r3964_info
op_star
)paren
id|tty-&gt;disc_data
suffix:semicolon
r_const
r_int
r_char
op_star
id|p
suffix:semicolon
r_char
op_star
id|f
comma
id|flags
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|count
comma
id|p
op_assign
id|cp
comma
id|f
op_assign
id|fp
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
comma
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|f
)paren
id|flags
op_assign
op_star
id|f
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_eq
id|TTY_NORMAL
)paren
(brace
id|receive_char
c_func
(paren
id|pInfo
comma
op_star
id|p
)paren
suffix:semicolon
)brace
r_else
(brace
id|receive_error
c_func
(paren
id|pInfo
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|r3964_receive_room
r_static
r_int
id|r3964_receive_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|TRACE_L
c_func
(paren
l_string|&quot;receive_room&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
eof
