multiline_comment|/* -*- linux-c -*-&n; *&n; *&t;$Id: sysrq.c,v 1.15 1998/08/23 14:56:41 mj Exp $&n; *&n; *&t;Linux Magic System Request Key Hacks&n; *&n; *&t;(c) 1997 Martin Mares &lt;mj@atrey.karlin.mff.cuni.cz&gt;&n; *&t;based on ideas by Pavel Machek &lt;pavel@atrey.karlin.mff.cuni.cz&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/mount.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/sysrq.h&gt;
macro_line|#include &lt;linux/kbd_kern.h&gt;
macro_line|#include &lt;linux/quotaops.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
r_extern
r_void
id|wakeup_bdflush
c_func
(paren
r_int
)paren
suffix:semicolon
r_extern
r_void
id|reset_vc
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_struct
id|list_head
id|super_blocks
suffix:semicolon
multiline_comment|/* Whether we react on sysrq keys or just ignore them */
DECL|variable|sysrq_enabled
r_int
id|sysrq_enabled
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Machine specific power off function */
DECL|variable|sysrq_power_off
r_void
(paren
op_star
id|sysrq_power_off
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|sysrq_power_off
id|EXPORT_SYMBOL
c_func
(paren
id|sysrq_power_off
)paren
suffix:semicolon
multiline_comment|/* Send a signal to all user processes */
DECL|function|send_sig_all
r_static
r_void
id|send_sig_all
c_func
(paren
r_int
id|sig
comma
r_int
id|even_init
)paren
(brace
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
id|for_each_task
c_func
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;mm
)paren
(brace
multiline_comment|/* Not swapper nor kernel thread */
r_if
c_cond
(paren
id|p-&gt;pid
op_eq
l_int|1
op_logical_and
id|even_init
)paren
multiline_comment|/* Ugly hack to kill init */
id|p-&gt;pid
op_assign
l_int|0x8000
suffix:semicolon
id|force_sig
c_func
(paren
id|sig
comma
id|p
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * This function is called by the keyboard handler when SysRq is pressed&n; * and any other keycode arrives.&n; */
DECL|function|handle_sysrq
r_void
id|handle_sysrq
c_func
(paren
r_int
id|key
comma
r_struct
id|pt_regs
op_star
id|pt_regs
comma
r_struct
id|kbd_struct
op_star
id|kbd
comma
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
id|orig_log_level
op_assign
id|console_loglevel
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sysrq_enabled
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|key
)paren
r_return
suffix:semicolon
id|console_loglevel
op_assign
l_int|7
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SysRq: &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|key
)paren
(brace
r_case
l_char|&squot;r&squot;
suffix:colon
multiline_comment|/* R -- Reset raw mode */
r_if
c_cond
(paren
id|kbd
)paren
(brace
id|kbd-&gt;kbdmode
op_assign
id|VC_XLATE
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Keyboard mode set to XLATE&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_VT
r_case
l_char|&squot;k&squot;
suffix:colon
multiline_comment|/* K -- SAK */
id|printk
c_func
(paren
l_string|&quot;SAK&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
id|do_SAK
c_func
(paren
id|tty
)paren
suffix:semicolon
id|reset_vc
c_func
(paren
id|fg_console
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
l_char|&squot;b&squot;
suffix:colon
multiline_comment|/* B -- boot immediately */
id|printk
c_func
(paren
l_string|&quot;Resetting&bslash;n&quot;
)paren
suffix:semicolon
id|machine_restart
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;o&squot;
suffix:colon
multiline_comment|/* O -- power off */
r_if
c_cond
(paren
id|sysrq_power_off
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Power off&bslash;n&quot;
)paren
suffix:semicolon
id|sysrq_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_char|&squot;s&squot;
suffix:colon
multiline_comment|/* S -- emergency sync */
id|printk
c_func
(paren
l_string|&quot;Emergency Sync&bslash;n&quot;
)paren
suffix:semicolon
id|emergency_sync_scheduled
op_assign
id|EMERG_SYNC
suffix:semicolon
id|wakeup_bdflush
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;u&squot;
suffix:colon
multiline_comment|/* U -- emergency remount R/O */
id|printk
c_func
(paren
l_string|&quot;Emergency Remount R/O&bslash;n&quot;
)paren
suffix:semicolon
id|emergency_sync_scheduled
op_assign
id|EMERG_REMOUNT
suffix:semicolon
id|wakeup_bdflush
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;p&squot;
suffix:colon
multiline_comment|/* P -- show PC */
id|printk
c_func
(paren
l_string|&quot;Show Regs&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pt_regs
)paren
id|show_regs
c_func
(paren
id|pt_regs
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;t&squot;
suffix:colon
multiline_comment|/* T -- show task info */
id|printk
c_func
(paren
l_string|&quot;Show State&bslash;n&quot;
)paren
suffix:semicolon
id|show_state
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;m&squot;
suffix:colon
multiline_comment|/* M -- show memory info */
id|printk
c_func
(paren
l_string|&quot;Show Memory&bslash;n&quot;
)paren
suffix:semicolon
id|show_mem
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;0&squot;
dot
dot
dot
l_char|&squot;9&squot;
suffix:colon
multiline_comment|/* 0-9 -- set console logging level */
id|orig_log_level
op_assign
id|key
op_minus
l_char|&squot;0&squot;
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Log level set to %d&bslash;n&quot;
comma
id|orig_log_level
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;e&squot;
suffix:colon
multiline_comment|/* E -- terminate all user processes */
id|printk
c_func
(paren
l_string|&quot;Terminate All Tasks&bslash;n&quot;
)paren
suffix:semicolon
id|send_sig_all
c_func
(paren
id|SIGTERM
comma
l_int|0
)paren
suffix:semicolon
id|orig_log_level
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* We probably have killed syslogd */
r_break
suffix:semicolon
r_case
l_char|&squot;i&squot;
suffix:colon
multiline_comment|/* I -- kill all user processes */
id|printk
c_func
(paren
l_string|&quot;Kill All Tasks&bslash;n&quot;
)paren
suffix:semicolon
id|send_sig_all
c_func
(paren
id|SIGKILL
comma
l_int|0
)paren
suffix:semicolon
id|orig_log_level
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;l&squot;
suffix:colon
multiline_comment|/* L -- kill all processes including init */
id|printk
c_func
(paren
l_string|&quot;Kill ALL Tasks (even init)&bslash;n&quot;
)paren
suffix:semicolon
id|send_sig_all
c_func
(paren
id|SIGKILL
comma
l_int|1
)paren
suffix:semicolon
id|orig_log_level
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Unknown: help */
r_if
c_cond
(paren
id|kbd
)paren
id|printk
c_func
(paren
l_string|&quot;unRaw &quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_VT
r_if
c_cond
(paren
id|tty
)paren
id|printk
c_func
(paren
l_string|&quot;saK &quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;Boot &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sysrq_power_off
)paren
id|printk
c_func
(paren
l_string|&quot;Off &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Sync Unmount showPc showTasks showMem loglevel0-8 tErm kIll killalL&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t use &squot;A&squot; as it&squot;s handled specially on the Sparc */
)brace
id|console_loglevel
op_assign
id|orig_log_level
suffix:semicolon
)brace
multiline_comment|/* Aux routines for the syncer */
DECL|function|is_local_disk
r_static
r_int
id|is_local_disk
c_func
(paren
id|kdev_t
id|dev
)paren
multiline_comment|/* Guess if the device is a local hard drive */
(brace
r_int
r_int
id|major
op_assign
id|MAJOR
c_func
(paren
id|dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|major
)paren
(brace
r_case
id|IDE0_MAJOR
suffix:colon
r_case
id|IDE1_MAJOR
suffix:colon
r_case
id|IDE2_MAJOR
suffix:colon
r_case
id|IDE3_MAJOR
suffix:colon
r_case
id|SCSI_DISK0_MAJOR
suffix:colon
r_case
id|SCSI_DISK1_MAJOR
suffix:colon
r_case
id|SCSI_DISK2_MAJOR
suffix:colon
r_case
id|SCSI_DISK3_MAJOR
suffix:colon
r_case
id|SCSI_DISK4_MAJOR
suffix:colon
r_case
id|SCSI_DISK5_MAJOR
suffix:colon
r_case
id|SCSI_DISK6_MAJOR
suffix:colon
r_case
id|SCSI_DISK7_MAJOR
suffix:colon
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|go_sync
r_static
r_void
id|go_sync
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|remount_flag
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%sing device %s ... &quot;
comma
id|remount_flag
ques
c_cond
l_string|&quot;Remount&quot;
suffix:colon
l_string|&quot;Sync&quot;
comma
id|kdevname
c_func
(paren
id|sb-&gt;s_dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remount_flag
)paren
(brace
multiline_comment|/* Remount R/O */
r_int
id|ret
comma
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;R/O&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|file_list_lock
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|sb-&gt;s_files.next
suffix:semicolon
id|p
op_ne
op_amp
id|sb-&gt;s_files
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|file
comma
id|f_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_dentry
op_logical_and
id|file_count
c_func
(paren
id|file
)paren
op_logical_and
id|S_ISREG
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
id|file-&gt;f_mode
op_and_assign
op_complement
l_int|2
suffix:semicolon
)brace
id|file_list_unlock
c_func
(paren
)paren
suffix:semicolon
id|DQUOT_OFF
c_func
(paren
id|sb
)paren
suffix:semicolon
id|fsync_dev
c_func
(paren
id|sb-&gt;s_dev
)paren
suffix:semicolon
id|flags
op_assign
id|MS_RDONLY
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_op
op_logical_and
id|sb-&gt;s_op-&gt;remount_fs
)paren
(brace
id|ret
op_assign
id|sb-&gt;s_op
op_member_access_from_pointer
id|remount_fs
c_func
(paren
id|sb
comma
op_amp
id|flags
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
l_string|&quot;error %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_else
(brace
id|sb-&gt;s_flags
op_assign
(paren
id|sb-&gt;s_flags
op_amp
op_complement
id|MS_RMT_MASK
)paren
op_or
(paren
id|flags
op_amp
id|MS_RMT_MASK
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;OK&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;nothing to do&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|fsync_dev
c_func
(paren
id|sb-&gt;s_dev
)paren
suffix:semicolon
multiline_comment|/* Sync only */
id|printk
c_func
(paren
l_string|&quot;OK&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Emergency Sync or Unmount. We cannot do it directly, so we set a special&n; * flag and wake up the bdflush kernel thread which immediately calls this function.&n; * We process all mounted hard drives first to recover from crashed experimental&n; * block devices and malfunctional network filesystems.&n; */
DECL|variable|emergency_sync_scheduled
r_int
id|emergency_sync_scheduled
suffix:semicolon
DECL|function|do_emergency_sync
r_void
id|do_emergency_sync
c_func
(paren
r_void
)paren
(brace
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
r_int
id|remount_flag
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|remount_flag
op_assign
(paren
id|emergency_sync_scheduled
op_eq
id|EMERG_REMOUNT
)paren
suffix:semicolon
id|emergency_sync_scheduled
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|sb
op_assign
id|sb_entry
c_func
(paren
id|super_blocks.next
)paren
suffix:semicolon
id|sb
op_ne
id|sb_entry
c_func
(paren
op_amp
id|super_blocks
)paren
suffix:semicolon
id|sb
op_assign
id|sb_entry
c_func
(paren
id|sb-&gt;s_list.next
)paren
)paren
r_if
c_cond
(paren
id|is_local_disk
c_func
(paren
id|sb-&gt;s_dev
)paren
)paren
id|go_sync
c_func
(paren
id|sb
comma
id|remount_flag
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sb
op_assign
id|sb_entry
c_func
(paren
id|super_blocks.next
)paren
suffix:semicolon
id|sb
op_ne
id|sb_entry
c_func
(paren
op_amp
id|super_blocks
)paren
suffix:semicolon
id|sb
op_assign
id|sb_entry
c_func
(paren
id|sb-&gt;s_list.next
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|is_local_disk
c_func
(paren
id|sb-&gt;s_dev
)paren
op_logical_and
id|MAJOR
c_func
(paren
id|sb-&gt;s_dev
)paren
)paren
id|go_sync
c_func
(paren
id|sb
comma
id|remount_flag
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Done.&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
