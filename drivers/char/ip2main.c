multiline_comment|/*&n;*&n;*   (c) 1999 by Computone Corporation&n;*&n;********************************************************************************&n;*&n;*   PACKAGE:     Linux tty Device Driver for IntelliPort family of multiport&n;*                serial I/O controllers.&n;*&n;*   DESCRIPTION: Mainline code for the device driver&n;*&n;*******************************************************************************/
singleline_comment|// ToDo:
singleline_comment|//
singleline_comment|// Done:
singleline_comment|//
singleline_comment|// 1.2.9
singleline_comment|// Four box EX was barfing on &gt;128k kmalloc, made structure smaller by
singleline_comment|// reducing output buffer size
singleline_comment|//
singleline_comment|// 1.2.8
singleline_comment|// Device file system support (MHW)
singleline_comment|//
singleline_comment|// 1.2.7 
singleline_comment|// Fixed
singleline_comment|// Reload of ip2 without unloading ip2main hangs system on cat of /proc/modules
singleline_comment|//
singleline_comment|// 1.2.6
singleline_comment|//Fixes DCD problems
singleline_comment|//&t;DCD was not reported when CLOCAL was set on call to TIOCMGET
singleline_comment|//
singleline_comment|//Enhancements:
singleline_comment|//&t;TIOCMGET requests and waits for status return
singleline_comment|//&t;No DSS interrupts enabled except for DCD when needed
singleline_comment|//
singleline_comment|// For internal use only
singleline_comment|//
singleline_comment|//#define IP2DEBUG_INIT
singleline_comment|//#define IP2DEBUG_OPEN
singleline_comment|//#define IP2DEBUG_WRITE
singleline_comment|//#define IP2DEBUG_READ
singleline_comment|//#define IP2DEBUG_IOCTL
singleline_comment|//#define IP2DEBUG_IPL
singleline_comment|//#define IP2DEBUG_TRACE
singleline_comment|//#define DEBUG_FIFO
multiline_comment|/************/
multiline_comment|/* Includes */
multiline_comment|/************/
macro_line|#include &lt;linux/config.h&gt;
singleline_comment|// Uncomment the following if you want it compiled with modversions
macro_line|#ifdef MODULE
macro_line|#&t;if defined(CONFIG_MODVERSIONS) &amp;&amp; !defined(MODVERSIONS)
DECL|macro|MODVERSIONS
macro_line|#&t;&t;define MODVERSIONS
macro_line|#&t;endif
macro_line|#&t;ifdef MODVERSIONS
macro_line|#&t;&t;include &lt;linux/modversions.h&gt;
macro_line|#&t;endif
macro_line|#endif
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#ifdef&t;CONFIG_DEVFS_FS
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/cdk.h&gt;
macro_line|#include &lt;linux/comstats.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#ifndef KERNEL_VERSION
DECL|macro|KERNEL_VERSION
mdefine_line|#define KERNEL_VERSION(ver,rel,seq) (((ver)&lt;&lt;16) | ((rel)&lt;&lt;8) | (seq))
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
macro_line|#&t;include &lt;linux/vmalloc.h&gt;
macro_line|#&t;include &lt;linux/init.h&gt;
macro_line|#&t;include &lt;asm/serial.h&gt;
macro_line|#else
macro_line|#&t;include &lt;linux/bios32.h&gt;
macro_line|#endif
singleline_comment|// These VERSION switches maybe inexact because I simply don&squot;t know
singleline_comment|// when the various features appeared in the 2.1.XX kernels.
singleline_comment|// They are good enough for 2.0 vs 2.2 and if you are fooling with
singleline_comment|// the 2.1.XX stuff then it would be trivial for you to fix.
singleline_comment|// Most of these macros were stolen from some other drivers
singleline_comment|// so blame them.
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,4)
macro_line|#&t;include &lt;asm/segment.h&gt;
DECL|macro|GET_USER
macro_line|#&t;define GET_USER(error,value,addr) error = get_user(value,addr)
DECL|macro|COPY_FROM_USER
macro_line|#&t;define COPY_FROM_USER(error,dest,src,size) error = copy_from_user(dest,src,size) ? -EFAULT : 0
DECL|macro|PUT_USER
macro_line|#&t;define PUT_USER(error,value,addr) error = put_user(value,addr)
DECL|macro|COPY_TO_USER
macro_line|#&t;define COPY_TO_USER(error,dest,src,size) error = copy_to_user(dest,src,size) ? -EFAULT : 0
macro_line|#&t;if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,5)
macro_line|#&t;&t;include &lt;asm/uaccess.h&gt;
DECL|macro|pcibios_strerror
macro_line|#&t;&t;define&t;&t;pcibios_strerror(status)&t;&bslash;&n;&t;&t;&t;&t;&t;printk( KERN_ERR &quot;IP2: PCI error 0x%x &bslash;n&quot;, status );
macro_line|#&t;endif
macro_line|#else  /* 2.0.x and 2.1.x before 2.1.4 */
DECL|macro|proc_register_dynamic
macro_line|#&t;define&t;&t;proc_register_dynamic(a,b) proc_register(a,b) 
DECL|macro|GET_USER
macro_line|#&t;define GET_USER(error,value,addr)&t;&t;&t;&t;&t;  &bslash;&n;&t;do {&t;&t;&t;&t;&t;&t;&t;&t;&t;  &bslash;&n;&t;&t;error = verify_area (VERIFY_READ, (void *) addr, sizeof (value)); &bslash;&n;&t;&t;if (error == 0)&t;&t;&t;&t;&t;&t;&t;  &bslash;&n;&t;&t;&t;value = get_user(addr);&t;&t;&t;&t;&t;  &bslash;&n;&t;} while (0)
DECL|macro|COPY_FROM_USER
macro_line|#&t;define COPY_FROM_USER(error,dest,src,size)&t;&t;&t;&t;  &bslash;&n;&t;do {&t;&t;&t;&t;&t;&t;&t;&t;&t;  &bslash;&n;&t;&t;error = verify_area (VERIFY_READ, (void *) src, size);&t;&t;  &bslash;&n;&t;&t;if (error == 0)&t;&t;&t;&t;&t;&t;&t;  &bslash;&n;&t;&t;&t;memcpy_fromfs (dest, src, size);&t;&t;&t;  &bslash;&n;&t;} while (0)
DECL|macro|PUT_USER
macro_line|#&t;define PUT_USER(error,value,addr)&t;&t;&t;&t;&t;   &bslash;&n;&t;do {&t;&t;&t;&t;&t;&t;&t;&t;&t;   &bslash;&n;&t;&t;error = verify_area (VERIFY_WRITE, (void *) addr, sizeof (value)); &bslash;&n;&t;&t;if (error == 0)&t;&t;&t;&t;&t;&t;&t;   &bslash;&n;&t;&t;&t;put_user (value, addr);&t;&t;&t;&t;&t;   &bslash;&n;&t;} while (0)
DECL|macro|COPY_TO_USER
macro_line|#&t;define COPY_TO_USER(error,dest,src,size)&t;&t;&t;&t;  &bslash;&n;&t;do {&t;&t;&t;&t;&t;&t;&t;&t;&t;  &bslash;&n;&t;&t;error = verify_area (VERIFY_WRITE, (void *) dest, size);&t;&t;  &bslash;&n;&t;&t;if (error == 0)&t;&t;&t;&t;&t;&t;&t;  &bslash;&n;&t;&t;&t;memcpy_tofs (dest, src, size);&t;&t;&t;&t;  &bslash;&n;&t;} while (0)
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)
DECL|macro|__init
mdefine_line|#define __init
DECL|macro|__initfunc
mdefine_line|#define __initfunc(a) a
DECL|macro|__initdata
mdefine_line|#define __initdata
DECL|macro|ioremap
mdefine_line|#define ioremap(a,b) vremap((a),(b))
DECL|macro|iounmap
mdefine_line|#define iounmap(a) vfree((a))
DECL|macro|SERIAL_TYPE_NORMAL
mdefine_line|#define SERIAL_TYPE_NORMAL&t;1
DECL|macro|SERIAL_TYPE_CALLOUT
mdefine_line|#define SERIAL_TYPE_CALLOUT&t;2
DECL|macro|schedule_timeout
mdefine_line|#define schedule_timeout(a){current-&gt;timeout = jiffies + (a); schedule();}
DECL|macro|signal_pending
mdefine_line|#define signal_pending(a) ((a)-&gt;signal &amp; ~(a)-&gt;blocked)
DECL|macro|in_interrupt
mdefine_line|#define in_interrupt()&t;intr_count
macro_line|#endif
macro_line|#include &quot;./ip2/ip2types.h&quot;
macro_line|#include &quot;./ip2/ip2trace.h&quot;
macro_line|#include &quot;./ip2/ip2ioctl.h&quot;
macro_line|#include &quot;./ip2/ip2.h&quot;
macro_line|#include &quot;./ip2/i2ellis.h&quot;
macro_line|#include &quot;./ip2/i2lib.h&quot;
multiline_comment|/*****************&n; * /proc/ip2mem  *&n; *****************/
macro_line|#include &lt;linux/proc_fs.h&gt;
r_static
r_int
id|ip2_read_procmem
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
r_int
id|ip2_read_proc
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
op_star
comma
r_void
op_star
)paren
suffix:semicolon
multiline_comment|/********************/
multiline_comment|/* Type Definitions */
multiline_comment|/********************/
multiline_comment|/*************/
multiline_comment|/* Constants */
multiline_comment|/*************/
multiline_comment|/* String constants to identify ourselves */
DECL|variable|pcName
r_static
r_char
op_star
id|pcName
op_assign
l_string|&quot;Computone IntelliPort Plus multiport driver&quot;
suffix:semicolon
DECL|variable|pcVersion
r_static
r_char
op_star
id|pcVersion
op_assign
l_string|&quot;1.2.9&quot;
suffix:semicolon
multiline_comment|/* String constants for port names */
DECL|variable|pcDriver_name
r_static
r_char
op_star
id|pcDriver_name
op_assign
l_string|&quot;ip2&quot;
suffix:semicolon
macro_line|#ifdef&t;CONFIG_DEVFS_FS
DECL|variable|pcTty
r_static
r_char
op_star
id|pcTty
op_assign
l_string|&quot;ttf/%d&quot;
suffix:semicolon
DECL|variable|pcCallout
r_static
r_char
op_star
id|pcCallout
op_assign
l_string|&quot;cuf/%d&quot;
suffix:semicolon
macro_line|#else
DECL|variable|pcTty
r_static
r_char
op_star
id|pcTty
op_assign
l_string|&quot;ttyF&quot;
suffix:semicolon
DECL|variable|pcCallout
r_static
r_char
op_star
id|pcCallout
op_assign
l_string|&quot;cuf&quot;
suffix:semicolon
macro_line|#endif
DECL|variable|pcIpl
r_static
r_char
op_star
id|pcIpl
op_assign
l_string|&quot;ip2ipl&quot;
suffix:semicolon
multiline_comment|/* Serial subtype definitions */
DECL|macro|SERIAL_TYPE_NORMAL
mdefine_line|#define SERIAL_TYPE_NORMAL    1
DECL|macro|SERIAL_TYPE_CALLOUT
mdefine_line|#define SERIAL_TYPE_CALLOUT   2
singleline_comment|// cheezy kludge or genius - you decide?
r_int
id|ip2_loadmain
c_func
(paren
r_int
op_star
comma
r_int
op_star
comma
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|Fip_firmware
r_static
r_int
r_char
op_star
id|Fip_firmware
suffix:semicolon
DECL|variable|Fip_firmware_size
r_static
r_int
id|Fip_firmware_size
suffix:semicolon
multiline_comment|/***********************/
multiline_comment|/* Function Prototypes */
multiline_comment|/***********************/
multiline_comment|/* Global module entry functions */
macro_line|#ifdef MODULE
r_int
id|init_module
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
r_int
id|old_ip2_init
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Private (static) functions */
r_static
r_int
id|ip2_open
c_func
(paren
id|PTTY
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_void
id|ip2_close
c_func
(paren
id|PTTY
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|ip2_write
c_func
(paren
id|PTTY
comma
r_int
comma
r_const
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ip2_putchar
c_func
(paren
id|PTTY
comma
r_int
r_char
)paren
suffix:semicolon
r_static
r_void
id|ip2_flush_chars
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_int
id|ip2_write_room
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_int
id|ip2_chars_in_buf
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_void
id|ip2_flush_buffer
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_int
id|ip2_ioctl
c_func
(paren
id|PTTY
comma
r_struct
id|file
op_star
comma
id|UINT
comma
id|ULONG
)paren
suffix:semicolon
r_static
r_void
id|ip2_set_termios
c_func
(paren
id|PTTY
comma
r_struct
id|termios
op_star
)paren
suffix:semicolon
r_static
r_void
id|ip2_set_line_discipline
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_void
id|ip2_throttle
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_void
id|ip2_unthrottle
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_void
id|ip2_stop
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_void
id|ip2_start
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_void
id|ip2_hangup
c_func
(paren
id|PTTY
)paren
suffix:semicolon
r_static
r_void
id|set_irq
c_func
(paren
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ip2_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|ip2_poll
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_inline
r_void
id|service_all_boards
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_inline
r_void
id|do_input
c_func
(paren
id|i2ChanStrPtr
id|pCh
)paren
suffix:semicolon
r_static
r_inline
r_void
id|do_status
c_func
(paren
id|i2ChanStrPtr
id|pCh
)paren
suffix:semicolon
r_static
r_void
id|ip2_wait_until_sent
c_func
(paren
id|PTTY
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|set_params
(paren
id|i2ChanStrPtr
comma
r_struct
id|termios
op_star
)paren
suffix:semicolon
r_static
r_int
id|set_modem_info
c_func
(paren
id|i2ChanStrPtr
comma
r_int
r_int
comma
r_int
r_int
op_star
)paren
suffix:semicolon
r_static
r_int
id|get_serial_info
c_func
(paren
id|i2ChanStrPtr
comma
r_struct
id|serial_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|set_serial_info
c_func
(paren
id|i2ChanStrPtr
comma
r_struct
id|serial_struct
op_star
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)
r_static
r_int
id|ip2_ipl_read
c_func
(paren
r_struct
id|inode
op_star
comma
r_char
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
macro_line|#else
r_static
id|ssize_t
id|ip2_ipl_read
c_func
(paren
r_struct
id|file
op_star
comma
r_char
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
id|ssize_t
id|ip2_ipl_write
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|ip2_ipl_ioctl
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
id|UINT
comma
id|ULONG
)paren
suffix:semicolon
r_static
r_int
id|ip2_ipl_open
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_void
id|ip2trace
c_func
(paren
r_int
r_int
comma
r_int
r_char
comma
r_int
r_char
comma
r_int
r_int
comma
dot
dot
dot
)paren
suffix:semicolon
r_static
r_int
id|DumpTraceBuffer
c_func
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|DumpFifoBuffer
c_func
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ip2_init_board
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
r_int
id|find_eisa_board
c_func
(paren
r_int
)paren
suffix:semicolon
multiline_comment|/***************/
multiline_comment|/* Static Data */
multiline_comment|/***************/
DECL|variable|ip2_tty_driver
r_static
r_struct
id|tty_driver
id|ip2_tty_driver
suffix:semicolon
DECL|variable|ip2_callout_driver
r_static
r_struct
id|tty_driver
id|ip2_callout_driver
suffix:semicolon
DECL|variable|ref_count
r_static
r_int
id|ref_count
suffix:semicolon
multiline_comment|/* Here, then is a table of board pointers which the interrupt routine should&n; * scan through to determine who it must service.&n; */
DECL|variable|i2nBoards
r_static
r_int
r_int
id|i2nBoards
suffix:semicolon
singleline_comment|// Number of boards here
DECL|variable|i2BoardPtrTable
r_static
id|i2eBordStrPtr
id|i2BoardPtrTable
(braket
id|IP2_MAX_BOARDS
)braket
suffix:semicolon
DECL|variable|DevTable
r_static
id|i2ChanStrPtr
id|DevTable
(braket
id|IP2_MAX_PORTS
)braket
suffix:semicolon
singleline_comment|//DevTableMem just used to save addresses for kfree
DECL|variable|DevTableMem
r_static
r_void
op_star
id|DevTableMem
(braket
id|IP2_MAX_BOARDS
)braket
suffix:semicolon
DECL|variable|TtyTable
r_static
r_struct
id|tty_struct
op_star
id|TtyTable
(braket
id|IP2_MAX_PORTS
)braket
suffix:semicolon
DECL|variable|Termios
r_static
r_struct
id|termios
op_star
id|Termios
(braket
id|IP2_MAX_PORTS
)braket
suffix:semicolon
DECL|variable|TermiosLocked
r_static
r_struct
id|termios
op_star
id|TermiosLocked
(braket
id|IP2_MAX_PORTS
)braket
suffix:semicolon
multiline_comment|/* This is the driver descriptor for the ip2ipl device, which is used to&n; * download the loadware to the boards.&n; */
DECL|variable|ip2_ipl
r_static
r_struct
id|file_operations
id|ip2_ipl
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|read
suffix:colon
id|ip2_ipl_read
comma
id|write
suffix:colon
id|ip2_ipl_write
comma
id|ioctl
suffix:colon
id|ip2_ipl_ioctl
comma
id|open
suffix:colon
id|ip2_ipl_open
comma
)brace
suffix:semicolon
DECL|variable|irq_counter
r_static
r_int
id|irq_counter
suffix:semicolon
DECL|variable|bh_counter
r_static
r_int
id|bh_counter
suffix:semicolon
singleline_comment|// Use immediate queue to service interrupts
singleline_comment|//#define USE_IQI&t;// PCI&amp;2.2 needs work
singleline_comment|//#define USE_IQ&t;// PCI&amp;2.2 needs work
multiline_comment|/* The timer_list entry for our poll routine. If interrupt operation is not&n; * selected, the board is serviced periodically to see if anything needs doing.&n; */
DECL|macro|POLL_TIMEOUT
mdefine_line|#define  POLL_TIMEOUT   (jiffies + 1)
DECL|variable|PollTimer
r_static
r_struct
id|timer_list
id|PollTimer
op_assign
(brace
id|function
suffix:colon
id|ip2_poll
)brace
suffix:semicolon
DECL|variable|TimerOn
r_static
r_char
id|TimerOn
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
multiline_comment|/* Trace (debug) buffer data */
DECL|macro|TRACEMAX
mdefine_line|#define TRACEMAX  1000
DECL|variable|tracebuf
r_static
r_int
r_int
id|tracebuf
(braket
id|TRACEMAX
)braket
suffix:semicolon
DECL|variable|tracestuff
r_static
r_int
id|tracestuff
suffix:semicolon
DECL|variable|tracestrip
r_static
r_int
id|tracestrip
suffix:semicolon
DECL|variable|tracewrap
r_static
r_int
id|tracewrap
suffix:semicolon
macro_line|#endif
multiline_comment|/**********/
multiline_comment|/* Macros */
multiline_comment|/**********/
macro_line|#if defined(MODULE) &amp;&amp; defined(IP2DEBUG_OPEN)
DECL|macro|DBG_CNT
mdefine_line|#define DBG_CNT(s) printk(KERN_DEBUG &quot;(%s): [%x] refc=%d, ttyc=%d, modc=%x -&gt; %s&bslash;n&quot;, &bslash;&n;&t;&t;    kdevname(tty-&gt;device),(pCh-&gt;flags),ref_count, &bslash;&n;&t;&t;    tty-&gt;count,/*GET_USE_COUNT(module)*/0,s)
macro_line|#else
DECL|macro|DBG_CNT
mdefine_line|#define DBG_CNT(s)
macro_line|#endif
DECL|macro|MIN
mdefine_line|#define MIN(a,b)&t;( ( (a) &lt; (b) ) ? (a) : (b) )
DECL|macro|MAX
mdefine_line|#define MAX(a,b)&t;( ( (a) &gt; (b) ) ? (a) : (b) )
multiline_comment|/********/
multiline_comment|/* Code */
multiline_comment|/********/
macro_line|#include &quot;./ip2/i2ellis.c&quot;    /* Extremely low-level interface services */
macro_line|#include &quot;./ip2/i2cmd.c&quot;      /* Standard loadware command definitions */
macro_line|#include &quot;./ip2/i2lib.c&quot;      /* High level interface services */
multiline_comment|/* Configuration area for modprobe */
macro_line|#ifdef MODULE
macro_line|#&t;if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Doug McNash&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Computone IntelliPort Plus Driver&quot;
)paren
suffix:semicolon
macro_line|#&t;endif&t;/* LINUX_VERSION */
macro_line|#endif&t;/* MODULE */
DECL|variable|poll_only
r_static
r_int
id|poll_only
suffix:semicolon
DECL|variable|Eisa_irq
r_static
r_int
id|Eisa_irq
suffix:semicolon
DECL|variable|Eisa_slot
r_static
r_int
id|Eisa_slot
suffix:semicolon
DECL|variable|iindx
r_static
r_int
id|iindx
suffix:semicolon
DECL|variable|rirqs
r_static
r_char
id|rirqs
(braket
id|IP2_MAX_BOARDS
)braket
suffix:semicolon
DECL|variable|Valid_Irqs
r_static
r_int
id|Valid_Irqs
(braket
)braket
op_assign
(brace
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|7
comma
l_int|10
comma
l_int|11
comma
l_int|12
comma
l_int|15
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/******************************************************************************/
multiline_comment|/* Initialisation Section                                                     */
multiline_comment|/******************************************************************************/
r_int
DECL|function|ip2_loadmain
id|ip2_loadmain
c_func
(paren
r_int
op_star
id|iop
comma
r_int
op_star
id|irqp
comma
r_int
r_char
op_star
id|firmware
comma
r_int
id|firmsize
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* process command line arguments to modprobe or insmod i.e. iop &amp; irqp */
multiline_comment|/* otherwise ip2config is initialized by what&squot;s in ip2/ip2.h */
multiline_comment|/* command line trumps initialization in ip2.h */
multiline_comment|/* first two args are null if builtin to kernel */
r_if
c_cond
(paren
(paren
id|irqp
op_ne
l_int|NULL
)paren
op_logical_or
(paren
id|iop
op_ne
l_int|NULL
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|irqp
op_logical_and
id|irqp
(braket
id|i
)braket
)paren
(brace
id|ip2config.irq
(braket
id|i
)braket
op_assign
id|irqp
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iop
op_logical_and
id|iop
(braket
id|i
)braket
)paren
(brace
id|ip2config.addr
(braket
id|i
)braket
op_assign
id|iop
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
)brace
id|Fip_firmware
op_assign
id|firmware
suffix:semicolon
id|Fip_firmware_size
op_assign
id|firmsize
suffix:semicolon
r_return
id|old_ip2_init
c_func
(paren
)paren
suffix:semicolon
)brace
singleline_comment|// Some functions to keep track of what irq&squot;s we have
r_static
r_int
id|__init
DECL|function|is_valid_irq
id|is_valid_irq
c_func
(paren
r_int
id|irq
)paren
(brace
r_int
op_star
id|i
op_assign
id|Valid_Irqs
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|i
op_ne
l_int|0
)paren
op_logical_and
(paren
op_star
id|i
op_ne
id|irq
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
)brace
r_return
(paren
op_star
id|i
)paren
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|mark_requested_irq
id|mark_requested_irq
c_func
(paren
r_char
id|irq
)paren
(brace
id|rirqs
(braket
id|iindx
op_increment
)braket
op_assign
id|irq
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|clear_requested_irq
id|clear_requested_irq
c_func
(paren
r_char
id|irq
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|rirqs
(braket
id|i
)braket
op_eq
id|irq
)paren
(brace
id|rirqs
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|have_requested_irq
id|have_requested_irq
c_func
(paren
r_char
id|irq
)paren
(brace
singleline_comment|// array init to zeros so 0 irq will not be requested as a side effect
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|rirqs
(braket
id|i
)braket
op_eq
id|irq
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   init_module()                                                  */
multiline_comment|/* Parameters: None                                                           */
multiline_comment|/* Returns:    Success (0)                                                    */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This is a required entry point for an installable module. It simply calls  */
multiline_comment|/* the driver initialisation function and returns what it returns.            */
multiline_comment|/******************************************************************************/
macro_line|#ifdef MODULE
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef IP2DEBUG_INIT
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Loading module ...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|//was&t;return old_ip2_init();
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   cleanup_module()                                               */
multiline_comment|/* Parameters: None                                                           */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This is a required entry point for an installable module. It has to return */
multiline_comment|/* the device and the driver to a passive state. It should not be necessary   */
multiline_comment|/* to reset the board fully, especially as the loadware is downloaded         */
multiline_comment|/* externally rather than in the driver. We just want to disable the board    */
multiline_comment|/* and clear the loadware to a reset state. To allow this there has to be a   */
multiline_comment|/* way to detect whether the board has the loadware running at init time to   */
multiline_comment|/* handle subsequent installations of the driver. All memory allocated by the */
multiline_comment|/* driver should be returned since it may be unloaded from memory.            */
multiline_comment|/******************************************************************************/
macro_line|#ifdef MODULE
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef IP2DEBUG_INIT
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Unloading %s: version %s&bslash;n&quot;
comma
id|pcName
comma
id|pcVersion
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Stop poll timer if we had one. */
r_if
c_cond
(paren
id|TimerOn
)paren
(brace
id|del_timer
(paren
op_amp
id|PollTimer
)paren
suffix:semicolon
id|TimerOn
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reset the boards we have. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|i2BoardPtrTable
(braket
id|i
)braket
)paren
(brace
id|iiReset
c_func
(paren
id|i2BoardPtrTable
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The following is done at most once, if any boards were installed. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|i2BoardPtrTable
(braket
id|i
)braket
)paren
(brace
id|iiResetDelay
c_func
(paren
id|i2BoardPtrTable
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* free io addresses and Tibet */
id|release_region
c_func
(paren
id|ip2config.addr
(braket
id|i
)braket
comma
l_int|8
)paren
suffix:semicolon
macro_line|#ifdef&t;CONFIG_DEVFS_FS
id|devfs_unregister
(paren
id|i2BoardPtrTable
(braket
id|i
)braket
op_member_access_from_pointer
id|devfs_ipl_handle
)paren
suffix:semicolon
id|devfs_unregister
(paren
id|i2BoardPtrTable
(braket
id|i
)braket
op_member_access_from_pointer
id|devfs_stat_handle
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Disable and remove interrupt handler. */
r_if
c_cond
(paren
(paren
id|ip2config.irq
(braket
id|i
)braket
OG
l_int|0
)paren
op_logical_and
id|have_requested_irq
c_func
(paren
id|ip2config.irq
(braket
id|i
)braket
)paren
)paren
(brace
id|free_irq
(paren
id|ip2config.irq
(braket
id|i
)braket
comma
(paren
r_void
op_star
)paren
op_amp
id|pcName
)paren
suffix:semicolon
id|clear_requested_irq
c_func
(paren
id|ip2config.irq
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|tty_unregister_driver
(paren
op_amp
id|ip2_tty_driver
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: failed to unregister tty driver (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|tty_unregister_driver
(paren
op_amp
id|ip2_callout_driver
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: failed to unregister callout driver (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
macro_line|#ifdef&t;CONFIG_DEVFS_FS
r_if
c_cond
(paren
(paren
id|err
op_assign
id|devfs_unregister_chrdev
(paren
id|IP2_IPL_MAJOR
comma
id|pcIpl
)paren
)paren
)paren
macro_line|#else
r_if
c_cond
(paren
(paren
id|err
op_assign
id|unregister_chrdev
(paren
id|IP2_IPL_MAJOR
comma
id|pcIpl
)paren
)paren
)paren
macro_line|#endif
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: failed to unregister IPL driver (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;ip2mem&quot;
comma
op_amp
id|proc_root
)paren
suffix:semicolon
singleline_comment|// free memory
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_void
op_star
id|pB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|i
)braket
)paren
op_ne
l_int|0
)paren
(brace
id|kfree
(paren
id|pB
)paren
suffix:semicolon
id|i2BoardPtrTable
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|DevTableMem
(braket
id|i
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
id|kfree
(paren
id|DevTableMem
(braket
id|i
)braket
)paren
suffix:semicolon
id|DevTableMem
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* Cleanup the iiEllis subsystem. */
id|iiEllisCleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_INIT
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2 Unloaded&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* MODULE */
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   old_ip2_init()                                                 */
multiline_comment|/* Parameters: irq, io from command line of insmod et. al.                    */
multiline_comment|/* Returns:    Success (0)                                                    */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This was the required entry point for all drivers (now in ip2.c)           */
multiline_comment|/* It performs all                                                            */
multiline_comment|/* initialisation of the devices and driver structures, and registers itself  */
multiline_comment|/* with the relevant kernel modules.                                          */
multiline_comment|/******************************************************************************/
multiline_comment|/* SA_INTERRUPT- if set blocks all interrupts else only this line */
multiline_comment|/* SA_SHIRQ    - for shared irq PCI or maybe EISA only */
multiline_comment|/* SA_RANDOM   - can be source for cert. random number generators */
DECL|macro|IP2_SA_FLAGS
mdefine_line|#define IP2_SA_FLAGS&t;0
r_int
id|__init
DECL|function|old_ip2_init
id|old_ip2_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef&t;CONFIG_DEVFS_FS
r_static
id|devfs_handle_t
id|devfs_handle
suffix:semicolon
r_int
id|j
comma
id|box
suffix:semicolon
macro_line|#endif
r_int
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|loaded
suffix:semicolon
id|i2eBordStrPtr
id|pB
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|ITRC_NO_PORT
comma
id|ITRC_INIT
comma
id|ITRC_ENTER
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Announce our presence */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s version %s&bslash;n&quot;
comma
id|pcName
comma
id|pcVersion
)paren
suffix:semicolon
singleline_comment|// ip2 can be unloaded and reloaded for no good reason
singleline_comment|// we can&squot;t let that happen here or bad things happen
singleline_comment|// second load hoses board but not system - fixme later
r_if
c_cond
(paren
id|loaded
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Still loaded&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|loaded
op_increment
suffix:semicolon
multiline_comment|/* if all irq config is zero we shall poll_only */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|poll_only
op_or_assign
id|ip2config.irq
(braket
id|i
)braket
suffix:semicolon
)brace
id|poll_only
op_assign
op_logical_neg
id|poll_only
suffix:semicolon
multiline_comment|/* Initialise the iiEllis subsystem. */
id|iiEllisInit
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize arrays. */
id|memset
c_func
(paren
id|i2BoardPtrTable
comma
l_int|0
comma
r_sizeof
id|i2BoardPtrTable
)paren
suffix:semicolon
id|memset
c_func
(paren
id|DevTable
comma
l_int|0
comma
r_sizeof
id|DevTable
)paren
suffix:semicolon
id|memset
c_func
(paren
id|TtyTable
comma
l_int|0
comma
r_sizeof
id|TtyTable
)paren
suffix:semicolon
id|memset
c_func
(paren
id|Termios
comma
l_int|0
comma
r_sizeof
id|Termios
)paren
suffix:semicolon
id|memset
c_func
(paren
id|TermiosLocked
comma
l_int|0
comma
r_sizeof
id|TermiosLocked
)paren
suffix:semicolon
multiline_comment|/* Initialise all the boards we can find (up to the maximum). */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_switch
c_cond
(paren
id|ip2config.addr
(braket
id|i
)braket
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* skip this slot even if card is present */
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* ISA */
multiline_comment|/* ISA address must be specified */
r_if
c_cond
(paren
(paren
id|ip2config.addr
(braket
id|i
)braket
OL
l_int|0x100
)paren
op_logical_or
(paren
id|ip2config.addr
(braket
id|i
)braket
OG
l_int|0x3f8
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;IP2: Bad ISA board %d address %x&bslash;n&quot;
comma
id|i
comma
id|ip2config.addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|ip2config.addr
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ip2config.type
(braket
id|i
)braket
op_assign
id|ISA
suffix:semicolon
multiline_comment|/* Check for valid irq argument, set for polling if invalid */
r_if
c_cond
(paren
id|ip2config.irq
(braket
id|i
)braket
op_logical_and
op_logical_neg
id|is_valid_irq
c_func
(paren
id|ip2config.irq
(braket
id|i
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: Bad IRQ(%d) specified&bslash;n&quot;
comma
id|ip2config.irq
(braket
id|i
)braket
)paren
suffix:semicolon
id|ip2config.irq
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
singleline_comment|// 0 is polling and is valid in that sense
)brace
)brace
r_break
suffix:semicolon
r_case
id|PCI
suffix:colon
macro_line|#ifdef CONFIG_PCI
macro_line|#if (LINUX_VERSION_CODE &lt; 0x020163) /* 2.1.99 */
r_if
c_cond
(paren
id|pcibios_present
c_func
(paren
)paren
)paren
(brace
r_int
r_char
id|pci_bus
comma
id|pci_devfn
suffix:semicolon
r_int
id|Pci_index
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|pcibios_find_device
c_func
(paren
id|PCI_VENDOR_ID_COMPUTONE
comma
id|PCI_DEVICE_ID_COMPUTONE_IP2EX
comma
id|Pci_index
comma
op_amp
id|pci_bus
comma
op_amp
id|pci_devfn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_int
r_char
id|pci_irq
suffix:semicolon
id|ip2config.type
(braket
id|i
)braket
op_assign
id|PCI
suffix:semicolon
multiline_comment|/* &n;&t;&t;&t;&t;&t; * Update Pci_index, so that the next time we go&n;&t;&t;&t;&t;&t; * searching for a PCI board we find a different&n;&t;&t;&t;&t;&t; * one.&n;&t;&t;&t;&t;&t; */
op_increment
id|Pci_index
suffix:semicolon
id|pcibios_read_config_dword
c_func
(paren
id|pci_bus
comma
id|pci_devfn
comma
id|PCI_BASE_ADDRESS_1
comma
op_amp
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
l_int|1
)paren
(brace
id|ip2config.addr
(braket
id|i
)braket
op_assign
(paren
id|USHORT
)paren
(paren
id|addr
op_amp
l_int|0xfffe
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: PCI I/O address error&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pcibios_read_config_byte
c_func
(paren
id|pci_bus
comma
id|pci_devfn
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|pci_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_valid_irq
c_func
(paren
id|pci_irq
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: Bad PCI BIOS IRQ(%d)&bslash;n&quot;
comma
id|pci_irq
)paren
suffix:semicolon
id|pci_irq
op_assign
l_int|0
suffix:semicolon
)brace
id|ip2config.irq
(braket
id|i
)braket
op_assign
id|pci_irq
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// ann error
id|ip2config.addr
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|PCIBIOS_DEVICE_NOT_FOUND
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: PCI board %d not found&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
id|pcibios_strerror
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#else /* LINUX_VERSION_CODE &gt; 2.1.99 */
r_if
c_cond
(paren
id|pci_present
c_func
(paren
)paren
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci_dev_i
op_assign
l_int|NULL
suffix:semicolon
id|pci_dev_i
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_COMPUTONE
comma
id|PCI_DEVICE_ID_COMPUTONE_IP2EX
comma
id|pci_dev_i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev_i
op_ne
l_int|NULL
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
r_int
r_char
id|pci_irq
suffix:semicolon
id|ip2config.type
(braket
id|i
)braket
op_assign
id|PCI
suffix:semicolon
id|status
op_assign
id|pci_read_config_dword
c_func
(paren
id|pci_dev_i
comma
id|PCI_BASE_ADDRESS_1
comma
op_amp
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
l_int|1
)paren
(brace
id|ip2config.addr
(braket
id|i
)braket
op_assign
(paren
id|USHORT
)paren
(paren
id|addr
op_amp
l_int|0xfffe
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: PCI I/O address error&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|status
op_assign
id|pci_read_config_byte
c_func
(paren
id|pci_dev_i
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|pci_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_valid_irq
c_func
(paren
id|pci_irq
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: Bad PCI BIOS IRQ(%d)&bslash;n&quot;
comma
id|pci_irq
)paren
suffix:semicolon
id|pci_irq
op_assign
l_int|0
suffix:semicolon
)brace
id|ip2config.irq
(braket
id|i
)braket
op_assign
id|pci_irq
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// ann error
id|ip2config.addr
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|PCIBIOS_DEVICE_NOT_FOUND
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: PCI board %d not found&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
id|pcibios_strerror
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif&t;/* ! 2_0_X */
macro_line|#else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: PCI card specified but PCI support not&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: configured in this kernel.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: Recompile kernel with CONFIG_PCI defined!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PCI */
r_break
suffix:semicolon
r_case
id|EISA
suffix:colon
r_if
c_cond
(paren
(paren
id|ip2config.addr
(braket
id|i
)braket
op_assign
id|find_eisa_board
c_func
(paren
id|Eisa_slot
op_plus
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Eisa_irq set as side effect, boo */
id|ip2config.type
(braket
id|i
)braket
op_assign
id|EISA
suffix:semicolon
)brace
id|ip2config.irq
(braket
id|i
)braket
op_assign
id|Eisa_irq
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* switch */
)brace
multiline_comment|/* for */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|ip2config.addr
(braket
id|i
)braket
)paren
(brace
id|pB
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|i2eBordStr
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pB
op_ne
l_int|NULL
)paren
(brace
id|i2BoardPtrTable
(braket
id|i
)braket
op_assign
id|pB
suffix:semicolon
id|memset
c_func
(paren
id|pB
comma
l_int|0
comma
r_sizeof
(paren
id|i2eBordStr
)paren
)paren
suffix:semicolon
id|iiSetAddress
c_func
(paren
id|pB
comma
id|ip2config.addr
(braket
id|i
)braket
comma
id|ii2DelayTimer
)paren
suffix:semicolon
id|iiReset
c_func
(paren
id|pB
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: board memory allocation error&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
(paren
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|i
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
id|iiResetDelay
c_func
(paren
id|pB
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|i2BoardPtrTable
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|ip2_init_board
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|ITRC_NO_PORT
comma
id|ITRC_INIT
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Zero out the normal tty device structure. */
id|memset
(paren
op_amp
id|ip2_tty_driver
comma
l_int|0
comma
r_sizeof
id|ip2_tty_driver
)paren
suffix:semicolon
multiline_comment|/* Initialise the relevant fields. */
id|ip2_tty_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|ip2_tty_driver.name
op_assign
id|pcTty
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,0)
id|ip2_tty_driver.driver_name
op_assign
id|pcDriver_name
suffix:semicolon
id|ip2_tty_driver.read_proc
op_assign
id|ip2_read_proc
suffix:semicolon
macro_line|#endif
id|ip2_tty_driver.major
op_assign
id|IP2_TTY_MAJOR
suffix:semicolon
id|ip2_tty_driver.minor_start
op_assign
l_int|0
suffix:semicolon
id|ip2_tty_driver.num
op_assign
id|IP2_MAX_PORTS
suffix:semicolon
id|ip2_tty_driver.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|ip2_tty_driver.subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|ip2_tty_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|ip2_tty_driver.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
macro_line|#ifdef&t;CONFIG_DEVFS_FS
id|ip2_tty_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
op_or
id|TTY_DRIVER_NO_DEVFS
suffix:semicolon
macro_line|#else
id|ip2_tty_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
macro_line|#endif
id|ip2_tty_driver.refcount
op_assign
op_amp
id|ref_count
suffix:semicolon
id|ip2_tty_driver.table
op_assign
id|TtyTable
suffix:semicolon
id|ip2_tty_driver.termios
op_assign
id|Termios
suffix:semicolon
id|ip2_tty_driver.termios_locked
op_assign
id|TermiosLocked
suffix:semicolon
multiline_comment|/* Setup the pointers to the implemented functions. */
id|ip2_tty_driver.open
op_assign
id|ip2_open
suffix:semicolon
id|ip2_tty_driver.close
op_assign
id|ip2_close
suffix:semicolon
id|ip2_tty_driver.write
op_assign
id|ip2_write
suffix:semicolon
id|ip2_tty_driver.put_char
op_assign
id|ip2_putchar
suffix:semicolon
id|ip2_tty_driver.flush_chars
op_assign
id|ip2_flush_chars
suffix:semicolon
id|ip2_tty_driver.write_room
op_assign
id|ip2_write_room
suffix:semicolon
id|ip2_tty_driver.chars_in_buffer
op_assign
id|ip2_chars_in_buf
suffix:semicolon
id|ip2_tty_driver.flush_buffer
op_assign
id|ip2_flush_buffer
suffix:semicolon
id|ip2_tty_driver.ioctl
op_assign
id|ip2_ioctl
suffix:semicolon
id|ip2_tty_driver.throttle
op_assign
id|ip2_throttle
suffix:semicolon
id|ip2_tty_driver.unthrottle
op_assign
id|ip2_unthrottle
suffix:semicolon
id|ip2_tty_driver.set_termios
op_assign
id|ip2_set_termios
suffix:semicolon
id|ip2_tty_driver.set_ldisc
op_assign
id|ip2_set_line_discipline
suffix:semicolon
id|ip2_tty_driver.stop
op_assign
id|ip2_stop
suffix:semicolon
id|ip2_tty_driver.start
op_assign
id|ip2_start
suffix:semicolon
id|ip2_tty_driver.hangup
op_assign
id|ip2_hangup
suffix:semicolon
multiline_comment|/* Initialise the callout driver structure from the tty driver, and&n;&t; * make the needed adjustments.&n;&t; */
id|ip2_callout_driver
op_assign
id|ip2_tty_driver
suffix:semicolon
id|ip2_callout_driver.name
op_assign
id|pcCallout
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,1,0)
id|ip2_callout_driver.driver_name
op_assign
id|pcDriver_name
suffix:semicolon
id|ip2_callout_driver.read_proc
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|ip2_callout_driver.major
op_assign
id|IP2_CALLOUT_MAJOR
suffix:semicolon
id|ip2_callout_driver.subtype
op_assign
id|SERIAL_TYPE_CALLOUT
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|ITRC_NO_PORT
comma
id|ITRC_INIT
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Register the tty devices. */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|tty_register_driver
(paren
op_amp
id|ip2_tty_driver
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: failed to register tty driver (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|err
op_assign
id|tty_register_driver
(paren
op_amp
id|ip2_callout_driver
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: failed to register callout driver (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Register the IPL driver. */
macro_line|#ifdef&t;CONFIG_DEVFS_FS
r_if
c_cond
(paren
(paren
id|err
op_assign
id|devfs_register_chrdev
(paren
id|IP2_IPL_MAJOR
comma
id|pcIpl
comma
op_amp
id|ip2_ipl
)paren
)paren
)paren
macro_line|#else
r_if
c_cond
(paren
(paren
id|err
op_assign
id|register_chrdev
(paren
id|IP2_IPL_MAJOR
comma
id|pcIpl
comma
op_amp
id|ip2_ipl
)paren
)paren
)paren
macro_line|#endif
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: failed to register IPL device (%d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Register the read_procmem thing */
r_if
c_cond
(paren
op_logical_neg
id|create_proc_info_entry
c_func
(paren
l_string|&quot;ip2mem&quot;
comma
l_int|0
comma
op_amp
id|proc_root
comma
id|ip2_read_procmem
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: failed to register read_procmem&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|ITRC_NO_PORT
comma
id|ITRC_INIT
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Register the interrupt handler or poll handler, depending upon the&n;&t;&t; * specified interrupt.&n;&t;&t; */
macro_line|#ifdef&t;CONFIG_DEVFS_FS
r_if
c_cond
(paren
op_logical_neg
id|devfs_handle
)paren
id|devfs_handle
op_assign
id|devfs_mk_dir
(paren
l_int|NULL
comma
l_string|&quot;ip2&quot;
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
macro_line|#ifdef&t;CONFIG_DEVFS_FS
r_char
id|name
(braket
l_int|16
)braket
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
l_int|0
op_eq
id|ip2config.addr
(braket
id|i
)braket
)paren
(brace
r_continue
suffix:semicolon
)brace
macro_line|#ifdef&t;CONFIG_DEVFS_FS
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;ipl%d&quot;
comma
id|i
)paren
suffix:semicolon
id|i2BoardPtrTable
(braket
id|i
)braket
op_member_access_from_pointer
id|devfs_ipl_handle
op_assign
id|devfs_register
(paren
id|devfs_handle
comma
id|name
comma
id|DEVFS_FL_DEFAULT
comma
id|IP2_IPL_MAJOR
comma
l_int|4
op_star
id|i
comma
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
op_or
id|S_IFCHR
comma
op_amp
id|ip2_ipl
comma
l_int|NULL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;stat%d&quot;
comma
id|i
)paren
suffix:semicolon
id|i2BoardPtrTable
(braket
id|i
)braket
op_member_access_from_pointer
id|devfs_stat_handle
op_assign
id|devfs_register
(paren
id|devfs_handle
comma
id|name
comma
id|DEVFS_FL_DEFAULT
comma
id|IP2_IPL_MAJOR
comma
l_int|4
op_star
id|i
op_plus
l_int|1
comma
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
op_or
id|S_IFCHR
comma
op_amp
id|ip2_ipl
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|box
op_assign
l_int|0
suffix:semicolon
id|box
OL
id|ABS_MAX_BOXES
suffix:semicolon
op_increment
id|box
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ABS_BIGGEST_BOX
suffix:semicolon
op_increment
id|j
)paren
(brace
r_if
c_cond
(paren
id|pB-&gt;i2eChannelMap
(braket
id|box
)braket
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|tty_register_devfs
c_func
(paren
op_amp
id|ip2_tty_driver
comma
l_int|0
comma
id|j
op_plus
id|ABS_BIGGEST_BOX
op_star
(paren
id|box
op_plus
id|i
op_star
id|ABS_MAX_BOXES
)paren
)paren
suffix:semicolon
id|tty_register_devfs
c_func
(paren
op_amp
id|ip2_callout_driver
comma
l_int|0
comma
id|j
op_plus
id|ABS_BIGGEST_BOX
op_star
(paren
id|box
op_plus
id|i
op_star
id|ABS_MAX_BOXES
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|poll_only
)paren
(brace
id|ip2config.irq
(braket
id|i
)braket
op_assign
id|CIR_POLL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip2config.irq
(braket
id|i
)braket
op_eq
id|CIR_POLL
)paren
(brace
id|retry
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|TimerOn
)paren
(brace
id|PollTimer.expires
op_assign
id|POLL_TIMEOUT
suffix:semicolon
id|add_timer
(paren
op_amp
id|PollTimer
)paren
suffix:semicolon
id|TimerOn
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IP2: polling&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|have_requested_irq
c_func
(paren
id|ip2config.irq
(braket
id|i
)braket
)paren
)paren
r_continue
suffix:semicolon
id|rc
op_assign
id|request_irq
c_func
(paren
id|ip2config.irq
(braket
id|i
)braket
comma
id|ip2_interrupt
comma
id|IP2_SA_FLAGS
op_or
(paren
id|ip2config.type
(braket
id|i
)braket
op_eq
id|PCI
ques
c_cond
id|SA_SHIRQ
suffix:colon
l_int|0
)paren
comma
id|pcName
comma
(paren
r_void
op_star
)paren
op_amp
id|pcName
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: an request_irq failed: error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|ip2config.irq
(braket
id|i
)braket
op_assign
id|CIR_POLL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IP2: Polling %ld/sec.&bslash;n&quot;
comma
(paren
id|POLL_TIMEOUT
op_minus
id|jiffies
)paren
)paren
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
id|mark_requested_irq
c_func
(paren
id|ip2config.irq
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Initialise the interrupt handler bottom half (aka slih). */
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|i2BoardPtrTable
(braket
id|i
)braket
)paren
(brace
id|set_irq
c_func
(paren
id|i
comma
id|ip2config.irq
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* set and enable board interrupt */
)brace
)brace
)brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|ITRC_NO_PORT
comma
id|ITRC_INIT
comma
id|ITRC_RETURN
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_init_board()                                               */
multiline_comment|/* Parameters: Index of board in configuration structure                      */
multiline_comment|/* Returns:    Success (0)                                                    */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This function initializes the specified board. The loadware is copied to   */
multiline_comment|/* the board, the channel structures are initialized, and the board details   */
multiline_comment|/* are reported on the console.                                               */
multiline_comment|/******************************************************************************/
r_static
r_void
id|__init
DECL|function|ip2_init_board
id|ip2_init_board
c_func
(paren
r_int
id|boardnum
)paren
(brace
r_int
id|i
comma
id|rc
suffix:semicolon
r_int
id|nports
op_assign
l_int|0
comma
id|nboxes
op_assign
l_int|0
suffix:semicolon
id|i2ChanStrPtr
id|pCh
suffix:semicolon
id|i2eBordStrPtr
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|boardnum
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iiInitialize
(paren
id|pB
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;IP2: Failed to initialize board at 0x%x, error %d&bslash;n&quot;
comma
id|pB-&gt;i2eBase
comma
id|pB-&gt;i2eError
)paren
suffix:semicolon
id|kfree
(paren
id|pB
)paren
suffix:semicolon
id|i2BoardPtrTable
(braket
id|boardnum
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Board %d: addr=0x%x irq=%d &quot;
comma
id|boardnum
op_plus
l_int|1
comma
id|ip2config.addr
(braket
id|boardnum
)braket
comma
id|ip2config.irq
(braket
id|boardnum
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|rc
op_assign
id|check_region
c_func
(paren
id|ip2config.addr
(braket
id|boardnum
)braket
comma
l_int|8
)paren
)paren
)paren
(brace
id|i2BoardPtrTable
(braket
id|boardnum
)braket
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;bad addr=0x%x rc = %d&bslash;n&quot;
comma
id|ip2config.addr
(braket
id|boardnum
)braket
comma
id|rc
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|ip2config.addr
(braket
id|boardnum
)braket
comma
l_int|8
comma
id|pcName
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iiDownloadAll
(paren
id|pB
comma
(paren
id|loadHdrStrPtr
)paren
id|Fip_firmware
comma
l_int|1
comma
id|Fip_firmware_size
)paren
op_ne
id|II_DOWN_GOOD
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;IP2:failed to download loadware &quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;fv=%d.%d.%d lv=%d.%d.%d&bslash;n&quot;
comma
id|pB-&gt;i2ePom.e.porVersion
comma
id|pB-&gt;i2ePom.e.porRevision
comma
id|pB-&gt;i2ePom.e.porSubRev
comma
id|pB-&gt;i2eLVersion
comma
id|pB-&gt;i2eLRevision
comma
id|pB-&gt;i2eLSub
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pB-&gt;i2ePom.e.porID
op_amp
op_complement
id|POR_ID_RESERVED
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: Unknown board type, ID = %x&quot;
comma
id|pB-&gt;i2ePom.e.porID
)paren
suffix:semicolon
id|nports
op_assign
l_int|0
suffix:semicolon
r_goto
id|ex_exit
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POR_ID_II_4
suffix:colon
multiline_comment|/* IntelliPort-II, ISA-4 (4xRJ45) */
id|printk
(paren
id|KERN_INFO
l_string|&quot;ISA-4&quot;
)paren
suffix:semicolon
id|nports
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POR_ID_II_8
suffix:colon
multiline_comment|/* IntelliPort-II, 8-port using standard brick. */
id|printk
(paren
id|KERN_INFO
l_string|&quot;ISA-8 std&quot;
)paren
suffix:semicolon
id|nports
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POR_ID_II_8R
suffix:colon
multiline_comment|/* IntelliPort-II, 8-port using RJ11&squot;s (no CTS) */
id|printk
(paren
id|KERN_INFO
l_string|&quot;ISA-8 RJ11&quot;
)paren
suffix:semicolon
id|nports
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POR_ID_FIIEX
suffix:colon
multiline_comment|/* IntelliPort IIEX */
(brace
r_int
id|portnum
op_assign
id|IP2_PORTS_PER_BOARD
op_star
id|boardnum
suffix:semicolon
r_int
id|box
suffix:semicolon
r_for
c_loop
(paren
id|box
op_assign
l_int|0
suffix:semicolon
id|box
OL
id|ABS_MAX_BOXES
suffix:semicolon
op_increment
id|box
)paren
(brace
r_if
c_cond
(paren
id|pB-&gt;i2eChannelMap
(braket
id|box
)braket
op_ne
l_int|0
)paren
(brace
op_increment
id|nboxes
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ABS_BIGGEST_BOX
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|pB-&gt;i2eChannelMap
(braket
id|box
)braket
op_amp
l_int|1
op_lshift
id|i
)paren
(brace
op_increment
id|nports
suffix:semicolon
)brace
)brace
)brace
id|DevTableMem
(braket
id|boardnum
)braket
op_assign
id|pCh
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|i2ChanStr
)paren
op_star
id|nports
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2InitChannels
c_func
(paren
id|pB
comma
id|nports
comma
id|pCh
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2InitChannels failed: %d&bslash;n&quot;
comma
id|pB-&gt;i2eError
)paren
suffix:semicolon
)brace
id|pB-&gt;i2eChannelPtr
op_assign
op_amp
id|DevTable
(braket
id|portnum
)braket
suffix:semicolon
id|pB-&gt;i2eChannelCnt
op_assign
id|ABS_MOST_PORTS
suffix:semicolon
r_for
c_loop
(paren
id|box
op_assign
l_int|0
suffix:semicolon
id|box
OL
id|ABS_MAX_BOXES
suffix:semicolon
op_increment
id|box
comma
id|portnum
op_add_assign
id|ABS_BIGGEST_BOX
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ABS_BIGGEST_BOX
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|pB-&gt;i2eChannelMap
(braket
id|box
)braket
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|DevTable
(braket
id|portnum
op_plus
id|i
)braket
op_assign
id|pCh
suffix:semicolon
id|pCh-&gt;port_index
op_assign
id|portnum
op_plus
id|i
suffix:semicolon
id|pCh
op_increment
suffix:semicolon
)brace
)brace
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IP2: EX box=%d ports=%d %d bit&quot;
comma
id|nboxes
comma
id|nports
comma
id|pB-&gt;i2eDataWidth16
ques
c_cond
l_int|16
suffix:colon
l_int|8
)paren
suffix:semicolon
)brace
r_goto
id|ex_exit
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DevTableMem
(braket
id|boardnum
)braket
op_assign
id|pCh
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|i2ChanStr
)paren
op_star
id|nports
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|pB-&gt;i2eChannelPtr
op_assign
id|pCh
suffix:semicolon
id|pB-&gt;i2eChannelCnt
op_assign
id|nports
suffix:semicolon
id|i2InitChannels
(paren
id|pB
comma
id|pB-&gt;i2eChannelCnt
comma
id|pCh
)paren
suffix:semicolon
id|pB-&gt;i2eChannelPtr
op_assign
op_amp
id|DevTable
(braket
id|IP2_PORTS_PER_BOARD
op_star
id|boardnum
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pB-&gt;i2eChannelCnt
suffix:semicolon
op_increment
id|i
)paren
(brace
id|DevTable
(braket
id|IP2_PORTS_PER_BOARD
op_star
id|boardnum
op_plus
id|i
)braket
op_assign
id|pCh
suffix:semicolon
id|pCh-&gt;port_index
op_assign
(paren
id|IP2_PORTS_PER_BOARD
op_star
id|boardnum
)paren
op_plus
id|i
suffix:semicolon
id|pCh
op_increment
suffix:semicolon
)brace
id|ex_exit
suffix:colon
id|printk
(paren
id|KERN_INFO
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   find_eisa_board ( int start_slot )                             */
multiline_comment|/* Parameters: First slot to check                                            */
multiline_comment|/* Returns:    Address of EISA IntelliPort II controller                      */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This function searches for an EISA IntelliPort controller, starting        */
multiline_comment|/* from the specified slot number. If the motherboard is not identified as an */
multiline_comment|/* EISA motherboard, or no valid board ID is selected it returns 0. Otherwise */
multiline_comment|/* it returns the base address of the controller.                             */
multiline_comment|/******************************************************************************/
r_static
r_int
r_int
id|__init
DECL|function|find_eisa_board
id|find_eisa_board
c_func
(paren
r_int
id|start_slot
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|idm
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|idp
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|base
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|value
suffix:semicolon
r_int
id|setup_address
suffix:semicolon
r_int
id|setup_irq
suffix:semicolon
r_int
id|ismine
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * First a check for an EISA motherboard, which we do by comparing the&n;&t; * EISA ID registers for the system board and the first couple of slots.&n;&t; * No slot ID should match the system board ID, but on an ISA or PCI&n;&t; * machine the odds are that an empty bus will return similar values for&n;&t; * each slot.&n;&t; */
id|i
op_assign
l_int|0x0c80
suffix:semicolon
id|value
op_assign
(paren
id|inb
c_func
(paren
id|i
)paren
op_lshift
l_int|24
)paren
op_plus
(paren
id|inb
c_func
(paren
id|i
op_plus
l_int|1
)paren
op_lshift
l_int|16
)paren
op_plus
(paren
id|inb
c_func
(paren
id|i
op_plus
l_int|2
)paren
op_lshift
l_int|8
)paren
op_plus
id|inb
c_func
(paren
id|i
op_plus
l_int|3
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0x1c80
suffix:semicolon
id|i
op_le
l_int|0x4c80
suffix:semicolon
id|i
op_add_assign
l_int|0x1000
)paren
(brace
id|j
op_assign
(paren
id|inb
c_func
(paren
id|i
)paren
op_lshift
l_int|24
)paren
op_plus
(paren
id|inb
c_func
(paren
id|i
op_plus
l_int|1
)paren
op_lshift
l_int|16
)paren
op_plus
(paren
id|inb
c_func
(paren
id|i
op_plus
l_int|2
)paren
op_lshift
l_int|8
)paren
op_plus
id|inb
c_func
(paren
id|i
op_plus
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
id|j
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * OK, so we are inclined to believe that this is an EISA machine. Find&n;&t; * an IntelliPort controller.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|start_slot
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|base
op_assign
id|i
op_lshift
l_int|12
suffix:semicolon
id|idm
op_assign
(paren
id|inb
c_func
(paren
id|base
op_plus
l_int|0xc80
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|inb
c_func
(paren
id|base
op_plus
l_int|0xc81
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|idp
op_assign
(paren
id|inb
c_func
(paren
id|base
op_plus
l_int|0xc82
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|inb
c_func
(paren
id|base
op_plus
l_int|0xc83
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|ismine
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|idm
op_eq
l_int|0x0e8e
)paren
(brace
r_if
c_cond
(paren
id|idp
op_eq
l_int|0x0281
op_logical_or
id|idp
op_eq
l_int|0x0218
)paren
(brace
id|ismine
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|idp
op_eq
l_int|0x0282
op_logical_or
id|idp
op_eq
l_int|0x0283
)paren
(brace
id|ismine
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Can do edge-trigger */
)brace
r_if
c_cond
(paren
id|ismine
)paren
(brace
id|Eisa_slot
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ismine
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* It&squot;s some sort of EISA card, but at what address is it configured? */
id|setup_address
op_assign
id|base
op_plus
l_int|0xc88
suffix:semicolon
id|value
op_assign
id|inb
c_func
(paren
id|base
op_plus
l_int|0xc86
)paren
suffix:semicolon
id|setup_irq
op_assign
(paren
id|value
op_amp
l_int|8
)paren
ques
c_cond
id|Valid_Irqs
(braket
id|value
op_amp
l_int|7
)braket
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ismine
op_amp
l_int|2
)paren
op_logical_and
op_logical_neg
(paren
id|value
op_amp
l_int|0x10
)paren
)paren
(brace
id|ismine
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Could be edging, but not */
)brace
r_if
c_cond
(paren
id|Eisa_irq
op_eq
l_int|0
)paren
(brace
id|Eisa_irq
op_assign
id|setup_irq
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|Eisa_irq
op_ne
id|setup_irq
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;IP2: EISA irq mismatch between EISA controllers&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef IP2DEBUG_INIT
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Computone EISA board in slot %d, I.D. 0x%x%x, Address 0x%x&quot;
comma
id|base
op_rshift
l_int|12
comma
id|idm
comma
id|idp
comma
id|setup_address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Eisa_irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;, Interrupt %d %s&bslash;n&quot;
comma
id|setup_irq
comma
(paren
id|ismine
op_amp
l_int|2
)paren
ques
c_cond
l_string|&quot;(edge)&quot;
suffix:colon
l_string|&quot;(level)&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;, (polled)&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|setup_address
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   set_irq()                                                      */
multiline_comment|/* Parameters: index to board in board table                                  */
multiline_comment|/*             IRQ to use                                                     */
multiline_comment|/* Returns:    Success (0)                                                    */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|set_irq
id|set_irq
c_func
(paren
r_int
id|boardnum
comma
r_int
id|boardIrq
)paren
(brace
r_int
r_char
id|tempCommand
(braket
l_int|16
)braket
suffix:semicolon
id|i2eBordStrPtr
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|boardnum
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;&t; * Notify the boards they may generate interrupts. This is done by&n;&t; * sending an in-line command to channel 0 on each board. This is why&n;&t; * the channels have to be defined already. For each board, if the&n;&t; * interrupt has never been defined, we must do so NOW, directly, since&n;&t; * board will not send flow control or even give an interrupt until this&n;&t; * is done.  If polling we must send 0 as the interrupt parameter.&n;&t; */
singleline_comment|// We will get an interrupt here at the end of this function
id|iiDisableMailIrq
c_func
(paren
id|pB
)paren
suffix:semicolon
multiline_comment|/* We build up the entire packet header. */
id|CHANNEL_OF
c_func
(paren
id|tempCommand
)paren
op_assign
l_int|0
suffix:semicolon
id|PTYPE_OF
c_func
(paren
id|tempCommand
)paren
op_assign
id|PTYPE_INLINE
suffix:semicolon
id|CMD_COUNT_OF
c_func
(paren
id|tempCommand
)paren
op_assign
l_int|2
suffix:semicolon
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|0
)braket
op_assign
id|CMDVALUE_IRQ
suffix:semicolon
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|1
)braket
op_assign
id|boardIrq
suffix:semicolon
multiline_comment|/*&n;&t; * Write to FIFO; don&squot;t bother to adjust fifo capacity for this, since&n;&t; * board will respond almost immediately after SendMail hit.&n;&t; */
id|WRITE_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pB-&gt;write_fifo_spinlock
comma
id|flags
)paren
suffix:semicolon
id|iiWriteBuf
c_func
(paren
id|pB
comma
id|tempCommand
comma
l_int|4
)paren
suffix:semicolon
id|WRITE_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pB-&gt;write_fifo_spinlock
comma
id|flags
)paren
suffix:semicolon
id|pB-&gt;i2eUsingIrq
op_assign
id|boardIrq
suffix:semicolon
id|pB-&gt;i2eOutMailWaiting
op_or_assign
id|MB_OUT_STUFFED
suffix:semicolon
multiline_comment|/* Need to update number of boards before you enable mailbox int */
op_increment
id|i2nBoards
suffix:semicolon
id|CHANNEL_OF
c_func
(paren
id|tempCommand
)paren
op_assign
l_int|0
suffix:semicolon
id|PTYPE_OF
c_func
(paren
id|tempCommand
)paren
op_assign
id|PTYPE_BYPASS
suffix:semicolon
id|CMD_COUNT_OF
c_func
(paren
id|tempCommand
)paren
op_assign
l_int|6
suffix:semicolon
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|0
)braket
op_assign
l_int|88
suffix:semicolon
singleline_comment|// SILO
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|1
)braket
op_assign
l_int|64
suffix:semicolon
singleline_comment|// chars
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|2
)braket
op_assign
l_int|32
suffix:semicolon
singleline_comment|// ms
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|3
)braket
op_assign
l_int|28
suffix:semicolon
singleline_comment|// MAX_BLOCK
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|4
)braket
op_assign
l_int|64
suffix:semicolon
singleline_comment|// chars
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|5
)braket
op_assign
l_int|87
suffix:semicolon
singleline_comment|// HW_TEST
id|WRITE_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pB-&gt;write_fifo_spinlock
comma
id|flags
)paren
suffix:semicolon
id|iiWriteBuf
c_func
(paren
id|pB
comma
id|tempCommand
comma
l_int|8
)paren
suffix:semicolon
id|WRITE_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pB-&gt;write_fifo_spinlock
comma
id|flags
)paren
suffix:semicolon
id|CHANNEL_OF
c_func
(paren
id|tempCommand
)paren
op_assign
l_int|0
suffix:semicolon
id|PTYPE_OF
c_func
(paren
id|tempCommand
)paren
op_assign
id|PTYPE_BYPASS
suffix:semicolon
id|CMD_COUNT_OF
c_func
(paren
id|tempCommand
)paren
op_assign
l_int|1
suffix:semicolon
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|0
)braket
op_assign
l_int|84
suffix:semicolon
multiline_comment|/* get BOX_IDS */
id|iiWriteBuf
c_func
(paren
id|pB
comma
id|tempCommand
comma
l_int|3
)paren
suffix:semicolon
macro_line|#ifdef XXX
singleline_comment|// enable heartbeat for test porpoises
id|CHANNEL_OF
c_func
(paren
id|tempCommand
)paren
op_assign
l_int|0
suffix:semicolon
id|PTYPE_OF
c_func
(paren
id|tempCommand
)paren
op_assign
id|PTYPE_BYPASS
suffix:semicolon
id|CMD_COUNT_OF
c_func
(paren
id|tempCommand
)paren
op_assign
l_int|2
suffix:semicolon
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|0
)braket
op_assign
l_int|44
suffix:semicolon
multiline_comment|/* get ping */
(paren
id|CMD_OF
c_func
(paren
id|tempCommand
)paren
)paren
(braket
l_int|1
)braket
op_assign
l_int|200
suffix:semicolon
multiline_comment|/* 200 ms */
id|WRITE_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pB-&gt;write_fifo_spinlock
comma
id|flags
)paren
suffix:semicolon
id|iiWriteBuf
c_func
(paren
id|pB
comma
id|tempCommand
comma
l_int|4
)paren
suffix:semicolon
id|WRITE_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pB-&gt;write_fifo_spinlock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|iiEnableMailIrq
c_func
(paren
id|pB
)paren
suffix:semicolon
id|iiSendPendingMail
c_func
(paren
id|pB
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Interrupt Handler Section                                                  */
multiline_comment|/******************************************************************************/
r_static
r_inline
r_void
DECL|function|service_all_boards
id|service_all_boards
c_func
(paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|i2eBordStrPtr
id|pB
suffix:semicolon
multiline_comment|/* Service every board on the list */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pB
)paren
(brace
id|i2ServiceBoard
c_func
(paren
id|pB
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef USE_IQI
r_static
r_struct
id|tq_struct
DECL|variable|senior_service
id|senior_service
op_assign
(brace
singleline_comment|// it&squot;s the death that worse than fate
l_int|NULL
comma
l_int|0
comma
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|service_all_boards
comma
l_int|NULL
comma
singleline_comment|//later - board address XXX
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_interrupt(int irq, void *dev_id, struct pt_regs * regs)    */
multiline_comment|/* Parameters: irq - interrupt number                                         */
multiline_comment|/*             pointer to optional device ID structure                        */
multiline_comment|/*             pointer to register structure                                  */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_interrupt
id|ip2_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
id|i2eBordStrPtr
id|pB
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|ITRC_NO_PORT
comma
id|ITRC_INTR
comma
l_int|99
comma
l_int|1
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef USE_IQI
id|queue_task
c_func
(paren
op_amp
id|senior_service
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
macro_line|#else
multiline_comment|/* Service just the boards on the list using this irq */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|i2nBoards
suffix:semicolon
op_increment
id|i
)paren
(brace
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pB
op_logical_and
(paren
id|pB-&gt;i2eUsingIrq
op_eq
id|irq
)paren
)paren
(brace
id|i2ServiceBoard
c_func
(paren
id|pB
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* USE_IQI */
op_increment
id|irq_counter
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|ITRC_NO_PORT
comma
id|ITRC_INTR
comma
id|ITRC_RETURN
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_poll(unsigned long arg)                                    */
multiline_comment|/* Parameters: ?                                                              */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This function calls the library routine i2ServiceBoard for each board in   */
multiline_comment|/* the board table. This is used instead of the interrupt routine when polled */
multiline_comment|/* mode is specified.                                                         */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_poll
id|ip2_poll
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|ITRC_NO_PORT
comma
id|ITRC_INTR
comma
l_int|100
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|TimerOn
op_assign
l_int|0
suffix:semicolon
singleline_comment|// it&squot;s the truth but not checked in service
id|bh_counter
op_increment
suffix:semicolon
macro_line|#ifdef USE_IQI
id|queue_task
c_func
(paren
op_amp
id|senior_service
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
macro_line|#else
singleline_comment|// Just polled boards, service_all might be better
id|ip2_interrupt
c_func
(paren
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif /* USE_IQI */
id|PollTimer.expires
op_assign
id|POLL_TIMEOUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|PollTimer
)paren
suffix:semicolon
id|TimerOn
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|ITRC_NO_PORT
comma
id|ITRC_INTR
comma
id|ITRC_RETURN
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_inline
r_void
DECL|function|do_input
id|do_input
c_func
(paren
id|i2ChanStrPtr
id|pCh
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
c_func
(paren
id|CHANN
comma
id|ITRC_INPUT
comma
l_int|21
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|// Data input
r_if
c_cond
(paren
id|pCh-&gt;pTTY
op_ne
l_int|NULL
)paren
(brace
id|READ_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pCh-&gt;Ibuf_spinlock
comma
id|flags
)paren
r_if
c_cond
(paren
op_logical_neg
id|pCh-&gt;throttled
op_logical_and
(paren
id|pCh-&gt;Ibuf_stuff
op_ne
id|pCh-&gt;Ibuf_strip
)paren
)paren
(brace
id|READ_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Ibuf_spinlock
comma
id|flags
)paren
id|i2Input
c_func
(paren
id|pCh
)paren
suffix:semicolon
)brace
r_else
id|READ_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Ibuf_spinlock
comma
id|flags
)paren
)brace
r_else
(brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
c_func
(paren
id|CHANN
comma
id|ITRC_INPUT
comma
l_int|22
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|i2InputFlush
c_func
(paren
id|pCh
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// code duplicated from n_tty (ldisc)
r_static
r_inline
r_void
DECL|function|isig
id|isig
c_func
(paren
r_int
id|sig
comma
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|flush
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;pgrp
OG
l_int|0
)paren
id|kill_pg
c_func
(paren
id|tty-&gt;pgrp
comma
id|sig
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flush
op_logical_or
op_logical_neg
id|L_NOFLSH
c_func
(paren
id|tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
id|tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|i2InputFlush
c_func
(paren
id|tty-&gt;driver_data
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|do_status
id|do_status
c_func
(paren
id|i2ChanStrPtr
id|pCh
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|i2GetStatus
c_func
(paren
id|pCh
comma
(paren
id|I2_BRK
op_or
id|I2_PAR
op_or
id|I2_FRA
op_or
id|I2_OVR
)paren
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_STATUS
comma
l_int|21
comma
l_int|1
comma
id|status
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pCh-&gt;pTTY
op_logical_and
(paren
id|status
op_amp
(paren
id|I2_BRK
op_or
id|I2_PAR
op_or
id|I2_FRA
op_or
id|I2_OVR
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|I2_BRK
)paren
)paren
(brace
singleline_comment|// code duplicated from n_tty (ldisc)
r_if
c_cond
(paren
id|I_IGNBRK
c_func
(paren
id|pCh-&gt;pTTY
)paren
)paren
r_goto
id|skip_this
suffix:semicolon
r_if
c_cond
(paren
id|I_BRKINT
c_func
(paren
id|pCh-&gt;pTTY
)paren
)paren
(brace
id|isig
c_func
(paren
id|SIGINT
comma
id|pCh-&gt;pTTY
comma
l_int|1
)paren
suffix:semicolon
r_goto
id|skip_this
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|pCh-&gt;pTTY-&gt;read_wait
)paren
suffix:semicolon
)brace
macro_line|#ifdef NEVER_HAPPENS_AS_SETUP_XXX
singleline_comment|// and can&squot;t work because we don&squot;t know the_char
singleline_comment|// as the_char is reported on a seperate path
singleline_comment|// The intelligent board does this stuff as setup
(brace
r_char
id|brkf
op_assign
id|TTY_NORMAL
suffix:semicolon
r_int
r_char
id|brkc
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|I2_BRK
)paren
)paren
(brace
id|brkf
op_assign
id|TTY_BREAK
suffix:semicolon
id|brkc
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|I2_PAR
)paren
(brace
id|brkf
op_assign
id|TTY_PARITY
suffix:semicolon
id|brkc
op_assign
id|the_char
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|I2_FRA
)paren
(brace
id|brkf
op_assign
id|TTY_FRAME
suffix:semicolon
id|brkc
op_assign
id|the_char
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|I2_OVR
)paren
(brace
id|brkf
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|brkc
op_assign
id|the_char
suffix:semicolon
)brace
id|tmp
op_assign
id|pCh-&gt;pTTY-&gt;real_raw
suffix:semicolon
id|pCh-&gt;pTTY-&gt;real_raw
op_assign
l_int|0
suffix:semicolon
id|pCh-&gt;pTTY-&gt;ldisc
dot
id|receive_buf
c_func
(paren
id|pCh-&gt;pTTY
comma
op_amp
id|brkc
comma
op_amp
id|brkf
comma
l_int|1
)paren
suffix:semicolon
id|pCh-&gt;pTTY-&gt;real_raw
op_assign
id|tmp
suffix:semicolon
)brace
macro_line|#endif /* NEVER_HAPPENS_AS_SETUP_XXX */
)brace
id|skip_this
suffix:colon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|I2_DDCD
op_or
id|I2_DDSR
op_or
id|I2_DCTS
op_or
id|I2_DRI
)paren
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|pCh-&gt;delta_msr_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CHECK_CD
)paren
op_logical_and
(paren
id|status
op_amp
id|I2_DDCD
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|I2_DCD
)paren
(brace
r_if
c_cond
(paren
id|pCh-&gt;wopen
)paren
(brace
id|wake_up_interruptible
(paren
op_amp
id|pCh-&gt;open_wait
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
)paren
(brace
r_if
c_cond
(paren
id|pCh-&gt;pTTY
op_logical_and
(paren
op_logical_neg
(paren
id|pCh-&gt;pTTY-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
)paren
)paren
(brace
id|tty_hangup
c_func
(paren
id|pCh-&gt;pTTY
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_STATUS
comma
l_int|26
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Device Open/Close/Ioctl Entry Point Section                                */
multiline_comment|/******************************************************************************/
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   open_sanity_check()                                            */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/*             Pointer to file structure                                      */
multiline_comment|/* Returns:    Success or failure                                             */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* Verifies the structure magic numbers and cross links.                      */
multiline_comment|/******************************************************************************/
macro_line|#ifdef IP2DEBUG_OPEN
r_static
r_void
DECL|function|open_sanity_check
id|open_sanity_check
c_func
(paren
id|i2ChanStrPtr
id|pCh
comma
id|i2eBordStrPtr
id|pBrd
)paren
(brace
r_if
c_cond
(paren
id|pBrd-&gt;i2eValid
op_ne
id|I2E_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: invalid board structure&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pBrd
op_ne
id|pCh-&gt;pMyBord
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: board structure pointer mismatch (%p)&bslash;n&quot;
comma
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pBrd-&gt;i2eChannelCnt
OL
id|pCh-&gt;port_index
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;IP2: bad device index (%d)&bslash;n&quot;
comma
id|pCh-&gt;port_index
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_amp
(paren
(paren
id|i2ChanStrPtr
)paren
id|pBrd-&gt;i2eChannelPtr
)paren
(braket
id|pCh-&gt;port_index
)braket
op_ne
id|pCh
)paren
(brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IP2: all pointers check out!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_open()                                                     */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/*             Pointer to file structure                                      */
multiline_comment|/* Returns:    Success or failure                                             */
multiline_comment|/*                                                                            */
multiline_comment|/* Description: (MANDATORY)                                                   */
multiline_comment|/* A successful device open has to run a gauntlet of checks before it         */
multiline_comment|/* completes. After some sanity checking and pointer setup, the function      */
multiline_comment|/* blocks until all conditions are satisfied. It then initialises the port to */
multiline_comment|/* the default characteristics and returns.                                   */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|ip2_open
id|ip2_open
c_func
(paren
id|PTTY
id|tty
comma
r_struct
id|file
op_star
id|pFile
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|do_clocal
op_assign
l_int|0
suffix:semicolon
id|i2ChanStrPtr
id|pCh
op_assign
id|DevTable
(braket
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
)braket
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
comma
id|ITRC_OPEN
comma
id|ITRC_ENTER
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pCh
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Setup pointer links in device and tty structures */
id|pCh-&gt;pTTY
op_assign
id|tty
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|pCh
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#ifdef IP2DEBUG_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
"&bslash;"
l_string|&quot;IP2:open(tty=%p,pFile=%p):dev=%x,maj=%d,min=%d,ch=%d,idx=%d&bslash;n&quot;
comma
id|tty
comma
id|pFile
comma
id|tty-&gt;device
comma
id|MAJOR
c_func
(paren
id|tty-&gt;device
)paren
comma
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
comma
id|pCh-&gt;infl.hd.i2sChannel
comma
id|pCh-&gt;port_index
)paren
suffix:semicolon
id|open_sanity_check
(paren
id|pCh
comma
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
macro_line|#endif
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|3
comma
id|CMD_DTRUP
comma
id|CMD_RTSUP
comma
id|CMD_DCD_REP
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_or_assign
(paren
id|I2_DTR
op_or
id|I2_RTS
)paren
suffix:semicolon
id|serviceOutgoingFifo
c_func
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
multiline_comment|/* Block here until the port is ready (per serial and istallion) */
multiline_comment|/*&n;&t; * 1. If the port is in the middle of closing wait for the completion&n;&t; *    and then return the appropriate error.&n;&t; */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|pFile
)paren
op_logical_or
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
)paren
(brace
r_if
c_cond
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|pCh-&gt;close_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|pFile
)paren
)paren
(brace
r_return
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * 2. If this is a callout device, make sure the normal port is not in&n;&t; *    use, and that someone else doesn&squot;t have the callout device locked.&n;&t; *    (These are the only tests the standard serial driver makes for&n;&t; *    callout devices.)&n;&t; */
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|SERIAL_TYPE_CALLOUT
)paren
(brace
r_if
c_cond
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_SESSION_LOCKOUT
)paren
op_logical_and
(paren
id|pCh-&gt;session
op_ne
id|current-&gt;session
)paren
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_PGRP_LOCKOUT
)paren
op_logical_and
(paren
id|pCh-&gt;pgrp
op_ne
id|current-&gt;pgrp
)paren
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|pCh-&gt;flags
op_or_assign
id|ASYNC_CALLOUT_ACTIVE
suffix:semicolon
r_goto
id|noblock
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * 3. Handle a non-blocking open of a normal port.&n;&t; */
r_if
c_cond
(paren
(paren
id|pFile-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_logical_or
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|pCh-&gt;flags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_goto
id|noblock
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * 4. Now loop waiting for the port to be free and carrier present&n;&t; *    (if required).&n;&t; */
r_if
c_cond
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
(brace
r_if
c_cond
(paren
id|pCh-&gt;NormalTermios.c_cflag
op_amp
id|CLOCAL
)paren
(brace
id|do_clocal
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
(brace
id|do_clocal
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#ifdef IP2DEBUG_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;OpenBlock: do_clocal = %d&bslash;n&quot;
comma
id|do_clocal
)paren
suffix:semicolon
macro_line|#endif
op_increment
id|pCh-&gt;wopen
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|2
comma
id|CMD_DTRUP
comma
id|CMD_RTSUP
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_or_assign
(paren
id|I2_DTR
op_or
id|I2_RTS
)paren
suffix:semicolon
id|serviceOutgoingFifo
c_func
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|pFile
)paren
)paren
(brace
r_return
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EBUSY
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
op_logical_neg
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
op_logical_and
(paren
id|do_clocal
op_logical_or
(paren
id|pCh-&gt;dataSetIn
op_amp
id|I2_DCD
)paren
)paren
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef IP2DEBUG_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ASYNC_CALLOUT_ACTIVE = %s&bslash;n&quot;
comma
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
ques
c_cond
l_string|&quot;True&quot;
suffix:colon
l_string|&quot;False&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ASYNC_CLOSING = %s&bslash;n&quot;
comma
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
ques
c_cond
l_string|&quot;True&quot;
suffix:colon
l_string|&quot;False&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;OpenBlock: waiting for CD or signal&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_OPEN
comma
l_int|3
comma
l_int|2
comma
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
comma
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* check for signal */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|rc
op_assign
(paren
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|pCh-&gt;open_wait
)paren
suffix:semicolon
)brace
op_decrement
id|pCh-&gt;wopen
suffix:semicolon
singleline_comment|//why count?
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_OPEN
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
id|pCh-&gt;flags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
id|noblock
suffix:colon
multiline_comment|/* first open - Assign termios structure to port */
r_if
c_cond
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|0
comma
l_int|2
comma
id|CMD_CTSFL_DSAB
comma
id|CMD_RTSFL_DSAB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_SPLIT_TERMIOS
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|SERIAL_TYPE_NORMAL
)paren
(brace
op_star
id|tty-&gt;termios
op_assign
id|pCh-&gt;NormalTermios
suffix:semicolon
)brace
r_else
(brace
op_star
id|tty-&gt;termios
op_assign
id|pCh-&gt;CalloutTermios
suffix:semicolon
)brace
)brace
multiline_comment|/* Now we must send the termios settings to the loadware */
id|set_params
c_func
(paren
id|pCh
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* override previous and never reset ??? */
id|pCh-&gt;session
op_assign
id|current-&gt;session
suffix:semicolon
id|pCh-&gt;pgrp
op_assign
id|current-&gt;pgrp
suffix:semicolon
multiline_comment|/*&n;&t; * Now set any i2lib options. These may go away if the i2lib code ends&n;&t; * up rolled into the mainline.&n;&t; */
id|pCh-&gt;channelOptions
op_or_assign
id|CO_NBLOCK_WRITE
suffix:semicolon
macro_line|#ifdef IP2DEBUG_OPEN
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2: open completed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|serviceOutgoingFifo
c_func
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_OPEN
comma
id|ITRC_RETURN
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_close()                                                    */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/*             Pointer to file structure                                      */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_close
id|ip2_close
c_func
(paren
id|PTTY
id|tty
comma
r_struct
id|file
op_star
id|pFile
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pCh
)paren
(brace
r_return
suffix:semicolon
)brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_CLOSE
comma
id|ITRC_ENTER
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IP2DEBUG_OPEN
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;IP2:close ttyF%02X:&bslash;n&quot;
comma
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty_hung_up_p
(paren
id|pFile
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_CLOSE
comma
l_int|2
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;count
OG
l_int|1
)paren
(brace
multiline_comment|/* not the last close */
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_CLOSE
comma
l_int|2
comma
l_int|1
comma
l_int|3
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|pCh-&gt;flags
op_or_assign
id|ASYNC_CLOSING
suffix:semicolon
singleline_comment|// last close actually
multiline_comment|/*&n;&t; * Save the termios structure, since this port may have separate termios&n;&t; * for callout and dialin.&n;&t; */
r_if
c_cond
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
id|pCh-&gt;NormalTermios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
r_if
c_cond
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
id|pCh-&gt;CalloutTermios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pCh-&gt;ClosingWaitTime
op_ne
id|ASYNC_CLOSING_WAIT_NONE
)paren
(brace
multiline_comment|/*&n;&t;&t; * Before we drop DTR, make sure the transmitter has completely drained.&n;&t;&t; * This uses an timeout, after which the close&n;&t;&t; * completes.&n;&t;&t; */
id|ip2_wait_until_sent
c_func
(paren
id|tty
comma
id|pCh-&gt;ClosingWaitTime
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * At this point we stop accepting input. Here we flush the channel&n;&t; * input buffer which will allow the board to send up more data. Any&n;&t; * additional input is tossed at interrupt/poll time.&n;&t; */
id|i2InputFlush
c_func
(paren
id|pCh
)paren
suffix:semicolon
multiline_comment|/* disable DSS reporting */
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|4
comma
id|CMD_DCD_NREP
comma
id|CMD_CTS_NREP
comma
id|CMD_DSR_NREP
comma
id|CMD_RI_NREP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|2
comma
id|CMD_RTSDN
comma
id|CMD_DTRDN
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_and_assign
op_complement
(paren
id|I2_DTR
op_or
id|I2_RTS
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_PAUSE
c_func
(paren
l_int|25
)paren
)paren
suffix:semicolon
)brace
id|serviceOutgoingFifo
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver.flush_buffer
)paren
id|tty-&gt;driver
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
id|tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
id|pCh-&gt;pTTY
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pCh-&gt;wopen
)paren
(brace
r_if
c_cond
(paren
id|pCh-&gt;ClosingDelay
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|pCh-&gt;ClosingDelay
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|pCh-&gt;open_wait
)paren
suffix:semicolon
)brace
id|pCh-&gt;flags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CALLOUT_ACTIVE
op_or
id|ASYNC_CLOSING
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|pCh-&gt;close_wait
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_OPEN
id|DBG_CNT
c_func
(paren
l_string|&quot;ip2_close: after wakeups--&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_CLOSE
comma
id|ITRC_RETURN
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_hangup()                                                   */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_hangup
id|ip2_hangup
(paren
id|PTTY
id|tty
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_HANGUP
comma
id|ITRC_ENTER
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|ip2_flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
multiline_comment|/* disable DSS reporting */
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|0
comma
l_int|1
comma
id|CMD_DCD_NREP
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|0
comma
l_int|2
comma
id|CMD_CTSFL_DSAB
comma
id|CMD_RTSFL_DSAB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|0
comma
l_int|2
comma
id|CMD_RTSDN
comma
id|CMD_DTRDN
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_and_assign
op_complement
(paren
id|I2_DTR
op_or
id|I2_RTS
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_PAUSE
c_func
(paren
l_int|25
)paren
)paren
suffix:semicolon
)brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|1
comma
l_int|3
comma
id|CMD_CTS_NREP
comma
id|CMD_DSR_NREP
comma
id|CMD_RI_NREP
)paren
suffix:semicolon
id|serviceOutgoingFifo
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|pCh-&gt;delta_msr_wait
)paren
suffix:semicolon
id|pCh-&gt;flags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CALLOUT_ACTIVE
)paren
suffix:semicolon
id|pCh-&gt;pTTY
op_assign
l_int|NULL
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|pCh-&gt;open_wait
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_HANGUP
comma
id|ITRC_RETURN
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/******************************************************************************/
multiline_comment|/* Device Output Section                                                      */
multiline_comment|/******************************************************************************/
multiline_comment|/******************************************************************************/
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_write()                                                    */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/*             Flag denoting data is in user (1) or kernel (0) space          */
multiline_comment|/*             Pointer to data                                                */
multiline_comment|/*             Number of bytes to write                                       */
multiline_comment|/* Returns:    Number of bytes actually written                               */
multiline_comment|/*                                                                            */
multiline_comment|/* Description: (MANDATORY)                                                   */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|ip2_write
id|ip2_write
c_func
(paren
id|PTTY
id|tty
comma
r_int
id|user
comma
r_const
r_int
r_char
op_star
id|pData
comma
r_int
id|count
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|bytesSent
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_WRITE
comma
id|ITRC_ENTER
comma
l_int|2
comma
id|count
comma
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Flush out any buffered data left over from ip2_putchar() calls. */
id|ip2_flush_chars
c_func
(paren
id|tty
)paren
suffix:semicolon
multiline_comment|/* This is the actual move bit. Make sure it does what we need!!!!! */
id|WRITE_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
id|bytesSent
op_assign
id|i2Output
c_func
(paren
id|pCh
comma
id|pData
comma
id|count
comma
id|user
)paren
suffix:semicolon
id|WRITE_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_WRITE
comma
id|ITRC_RETURN
comma
l_int|1
comma
id|bytesSent
)paren
suffix:semicolon
macro_line|#endif
r_return
id|bytesSent
OG
l_int|0
ques
c_cond
id|bytesSent
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_putchar()                                                  */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/*             Character to write                                             */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_putchar
id|ip2_putchar
c_func
(paren
id|PTTY
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
singleline_comment|//&t;ip2trace (CHANN, ITRC_PUTC, ITRC_ENTER, 1, ch );
macro_line|#endif
id|WRITE_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
id|pCh-&gt;Pbuf
(braket
id|pCh-&gt;Pbuf_stuff
op_increment
)braket
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|pCh-&gt;Pbuf_stuff
op_eq
r_sizeof
id|pCh-&gt;Pbuf
)paren
(brace
id|WRITE_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
id|ip2_flush_chars
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_else
id|WRITE_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
singleline_comment|//&t;ip2trace (CHANN, ITRC_PUTC, ITRC_RETURN, 1, ch );
macro_line|#endif
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_flush_chars()                                              */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_flush_chars
id|ip2_flush_chars
c_func
(paren
id|PTTY
id|tty
)paren
(brace
r_int
id|strip
suffix:semicolon
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|WRITE_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pCh-&gt;Pbuf_stuff
)paren
(brace
macro_line|#ifdef IP2DEBUG_TRACE
singleline_comment|//&t;ip2trace (CHANN, ITRC_PUTC, 10, 1, strip );
macro_line|#endif
singleline_comment|//
singleline_comment|// We may need to restart i2Output if it does not fullfill this request
singleline_comment|//
id|strip
op_assign
id|i2Output
c_func
(paren
id|pCh
comma
id|pCh-&gt;Pbuf
comma
id|pCh-&gt;Pbuf_stuff
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strip
op_ne
id|pCh-&gt;Pbuf_stuff
)paren
(brace
id|memmove
c_func
(paren
id|pCh-&gt;Pbuf
comma
op_amp
id|pCh-&gt;Pbuf
(braket
id|strip
)braket
comma
id|pCh-&gt;Pbuf_stuff
op_minus
id|strip
)paren
suffix:semicolon
)brace
id|pCh-&gt;Pbuf_stuff
op_sub_assign
id|strip
suffix:semicolon
)brace
id|WRITE_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_write_room()                                               */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/* Returns:    Number of bytes that the driver can accept                     */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|ip2_write_room
id|ip2_write_room
(paren
id|PTTY
id|tty
)paren
(brace
r_int
id|bytesFree
suffix:semicolon
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|READ_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
id|bytesFree
op_assign
id|i2OutputFree
c_func
(paren
id|pCh
)paren
op_minus
id|pCh-&gt;Pbuf_stuff
suffix:semicolon
id|READ_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_WRITE
comma
l_int|11
comma
l_int|1
comma
id|bytesFree
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
(paren
id|bytesFree
OG
l_int|0
)paren
ques
c_cond
id|bytesFree
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_chars_in_buf()                                             */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/* Returns:    Number of bytes queued for transmission                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|ip2_chars_in_buf
id|ip2_chars_in_buf
(paren
id|PTTY
id|tty
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_WRITE
comma
l_int|12
comma
l_int|1
comma
id|pCh-&gt;Obuf_char_count
op_plus
id|pCh-&gt;Pbuf_stuff
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IP2DEBUG_WRITE
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2: chars in buffer = %d (%d,%d)&bslash;n&quot;
comma
id|pCh-&gt;Obuf_char_count
op_plus
id|pCh-&gt;Pbuf_stuff
comma
id|pCh-&gt;Obuf_char_count
comma
id|pCh-&gt;Pbuf_stuff
)paren
suffix:semicolon
macro_line|#endif
id|READ_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pCh-&gt;Obuf_spinlock
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|pCh-&gt;Obuf_char_count
suffix:semicolon
id|READ_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Obuf_spinlock
comma
id|flags
)paren
suffix:semicolon
id|READ_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
id|rc
op_add_assign
id|pCh-&gt;Pbuf_stuff
suffix:semicolon
id|READ_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_flush_buffer()                                             */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_flush_buffer
id|ip2_flush_buffer
c_func
(paren
id|PTTY
id|tty
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_FLUSH
comma
id|ITRC_ENTER
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IP2DEBUG_WRITE
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2: flush buffer&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|WRITE_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
id|pCh-&gt;Pbuf_stuff
op_assign
l_int|0
suffix:semicolon
id|WRITE_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Pbuf_spinlock
comma
id|flags
)paren
suffix:semicolon
id|i2FlushOutput
c_func
(paren
id|pCh
)paren
suffix:semicolon
id|ip2_owake
c_func
(paren
id|tty
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_FLUSH
comma
id|ITRC_RETURN
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_wait_until_sent()                                          */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/*             Timeout for wait.                                              */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This function is used in place of the normal tty_wait_until_sent, which    */
multiline_comment|/* only waits for the driver buffers to be empty (or rather, those buffers    */
multiline_comment|/* reported by chars_in_buffer) which doesn&squot;t work for IP2 due to the         */
multiline_comment|/* indeterminate number of bytes buffered on the board.                       */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_wait_until_sent
id|ip2_wait_until_sent
(paren
id|PTTY
id|tty
comma
r_int
id|timeout
)paren
(brace
r_int
id|i
op_assign
id|jiffies
suffix:semicolon
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|timeout
op_minus
(paren
id|jiffies
op_minus
id|i
)paren
)paren
OG
l_int|0
)paren
id|i2DrainOutput
c_func
(paren
id|pCh
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/******************************************************************************/
multiline_comment|/* Device Input Section                                                       */
multiline_comment|/******************************************************************************/
multiline_comment|/******************************************************************************/
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_throttle()                                                 */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_throttle
id|ip2_throttle
(paren
id|PTTY
id|tty
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef IP2DEBUG_READ
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2: throttle&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Signal the poll/interrupt handlers not to forward incoming data to&n;&t; * the line discipline. This will cause the buffers to fill up in the&n;&t; * library and thus cause the library routines to send the flow control&n;&t; * stuff.&n;&t; */
id|pCh-&gt;throttled
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_unthrottle()                                               */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_unthrottle
id|ip2_unthrottle
(paren
id|PTTY
id|tty
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef IP2DEBUG_READ
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2: unthrottle&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Pass incoming data up to the line discipline again. */
id|pCh-&gt;throttled
op_assign
l_int|0
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|0
comma
l_int|1
comma
id|CMD_RESUME
)paren
suffix:semicolon
id|serviceOutgoingFifo
c_func
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
id|READ_LOCK_IRQSAVE
c_func
(paren
op_amp
id|pCh-&gt;Ibuf_spinlock
comma
id|flags
)paren
r_if
c_cond
(paren
id|pCh-&gt;Ibuf_stuff
op_ne
id|pCh-&gt;Ibuf_strip
)paren
(brace
id|READ_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Ibuf_spinlock
comma
id|flags
)paren
macro_line|#ifdef IP2DEBUG_READ
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;i2Input called from unthrottle&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|i2Input
c_func
(paren
id|pCh
)paren
suffix:semicolon
)brace
r_else
id|READ_UNLOCK_IRQRESTORE
c_func
(paren
op_amp
id|pCh-&gt;Ibuf_spinlock
comma
id|flags
)paren
)brace
r_static
r_void
DECL|function|ip2_start
id|ip2_start
(paren
id|PTTY
id|tty
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|DevTable
(braket
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
)braket
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|0
comma
l_int|1
comma
id|CMD_RESUME
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_UNSUSPEND
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_RESUME
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_WRITE
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2: start tx&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_void
DECL|function|ip2_stop
id|ip2_stop
(paren
id|PTTY
id|tty
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|DevTable
(braket
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
)braket
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_SUSPEND
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_WRITE
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2: stop tx&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Device Ioctl Section                                                       */
multiline_comment|/******************************************************************************/
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_ioctl()                                                    */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/*             Pointer to file structure                                      */
multiline_comment|/*             Command                                                        */
multiline_comment|/*             Argument                                                       */
multiline_comment|/* Returns:    Success or failure                                             */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|ip2_ioctl
id|ip2_ioctl
(paren
id|PTTY
id|tty
comma
r_struct
id|file
op_star
id|pFile
comma
id|UINT
id|cmd
comma
id|ULONG
id|arg
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
id|DevTable
(braket
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
)braket
suffix:semicolon
r_struct
id|async_icount
id|cprev
comma
id|cnow
suffix:semicolon
multiline_comment|/* kernel counter temps */
r_struct
id|serial_icounter_struct
op_star
id|p_cuser
suffix:semicolon
multiline_comment|/* user space */
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|pCh
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
id|ITRC_ENTER
comma
l_int|2
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IP2DEBUG_IOCTL
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;IP2: ioctl cmd (%x), arg (%lx)&bslash;n&quot;
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCGSERIAL
suffix:colon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|2
comma
l_int|1
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
id|get_serial_info
c_func
(paren
id|pCh
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|3
comma
l_int|1
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
id|set_serial_info
c_func
(paren
id|pCh
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCXONC
suffix:colon
id|rc
op_assign
id|tty_check_change
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|arg
)paren
(brace
r_case
id|TCOOFF
suffix:colon
singleline_comment|//return  -ENOIOCTLCMD;
r_break
suffix:semicolon
r_case
id|TCOON
suffix:colon
singleline_comment|//return  -ENOIOCTLCMD;
r_break
suffix:semicolon
r_case
id|TCIOFF
suffix:colon
r_if
c_cond
(paren
id|STOP_CHAR
c_func
(paren
id|tty
)paren
op_ne
id|__DISABLED_CHAR
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_XMIT_NOW
c_func
(paren
id|STOP_CHAR
c_func
(paren
id|tty
)paren
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TCION
suffix:colon
r_if
c_cond
(paren
id|START_CHAR
c_func
(paren
id|tty
)paren
op_ne
id|__DISABLED_CHAR
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_XMIT_NOW
c_func
(paren
id|START_CHAR
c_func
(paren
id|tty
)paren
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|TCSBRK
suffix:colon
multiline_comment|/* SVID version: non-zero arg --&gt; no break */
id|rc
op_assign
id|tty_check_change
c_func
(paren
id|tty
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|4
comma
l_int|1
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|ip2_wait_until_sent
c_func
(paren
id|tty
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_SEND_BRK
c_func
(paren
l_int|250
)paren
)paren
suffix:semicolon
id|serviceOutgoingFifo
c_func
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|TCSBRKP
suffix:colon
multiline_comment|/* support for POSIX tcsendbreak() */
id|rc
op_assign
id|tty_check_change
c_func
(paren
id|tty
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|5
comma
l_int|1
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|ip2_wait_until_sent
c_func
(paren
id|tty
comma
l_int|0
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_SEND_BRK
c_func
(paren
id|arg
ques
c_cond
id|arg
op_star
l_int|100
suffix:colon
l_int|250
)paren
)paren
suffix:semicolon
id|serviceOutgoingFifo
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCGSOFTCAR
suffix:colon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|6
comma
l_int|1
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
id|PUT_USER
c_func
(paren
id|rc
comma
id|C_CLOCAL
c_func
(paren
id|tty
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSOFTCAR
suffix:colon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|7
comma
l_int|1
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
id|GET_USER
c_func
(paren
id|rc
comma
id|arg
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|tty-&gt;termios-&gt;c_cflag
op_assign
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
op_complement
id|CLOCAL
)paren
op_or
(paren
id|arg
ques
c_cond
id|CLOCAL
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMGET
suffix:colon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|8
comma
l_int|1
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;FIXME - the following code is causing a NULL pointer dereference in&n;&t;2.3.51 in an interrupt handler.  It&squot;s suppose to prompt the board&n;&t;to return the DSS signal status immediately.  Why doesn&squot;t it do&n;&t;the same thing in 2.2.14?&n;*/
multiline_comment|/*&n;&t;&t;i2QueueCommands(PTYPE_BYPASS, pCh, 100, 1, CMD_DSS_NOW);&n;&t;&t;serviceOutgoingFifo( pCh-&gt;pMyBord );&n;&t;&t;interruptible_sleep_on(&amp;pCh-&gt;dss_now_wait);&n;&t;&t;if (signal_pending(current)) {&n;&t;&t;&t;return -EINTR;&n;&t;&t;}&n;*/
id|PUT_USER
c_func
(paren
id|rc
comma
(paren
(paren
id|pCh-&gt;dataSetOut
op_amp
id|I2_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|pCh-&gt;dataSetOut
op_amp
id|I2_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|pCh-&gt;dataSetIn
op_amp
id|I2_DCD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|pCh-&gt;dataSetIn
op_amp
id|I2_RI
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|pCh-&gt;dataSetIn
op_amp
id|I2_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|pCh-&gt;dataSetIn
op_amp
id|I2_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_case
id|TIOCMBIC
suffix:colon
r_case
id|TIOCMSET
suffix:colon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|9
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
id|set_modem_info
c_func
(paren
id|pCh
comma
id|cmd
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for any of the 4 modem inputs (DCD,RI,DSR,CTS) to change - mask&n;&t; * passed in arg for lines of interest (use |&squot;ed TIOCM_RNG/DSR/CD/CTS&n;&t; * for masking). Caller should use TIOCGICOUNT to see which one it was&n;&t; */
r_case
id|TIOCMIWAIT
suffix:colon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cprev
op_assign
id|pCh-&gt;icount
suffix:semicolon
multiline_comment|/* note the counters on entry */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|4
comma
id|CMD_DCD_REP
comma
id|CMD_CTS_REP
comma
id|CMD_DSR_REP
comma
id|CMD_RI_REP
)paren
suffix:semicolon
id|serviceOutgoingFifo
c_func
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|10
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|interruptible_sleep_on
c_func
(paren
op_amp
id|pCh-&gt;delta_msr_wait
)paren
suffix:semicolon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|11
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* see if a signal did it */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cnow
op_assign
id|pCh-&gt;icount
suffix:semicolon
multiline_comment|/* atomic copy */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnow.rng
op_eq
id|cprev.rng
op_logical_and
id|cnow.dsr
op_eq
id|cprev.dsr
op_logical_and
id|cnow.dcd
op_eq
id|cprev.dcd
op_logical_and
id|cnow.cts
op_eq
id|cprev.cts
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* no change =&gt; rc */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|arg
op_amp
id|TIOCM_RNG
)paren
op_logical_and
(paren
id|cnow.rng
op_ne
id|cprev.rng
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DSR
)paren
op_logical_and
(paren
id|cnow.dsr
op_ne
id|cprev.dsr
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CD
)paren
op_logical_and
(paren
id|cnow.dcd
op_ne
id|cprev.dcd
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CTS
)paren
op_logical_and
(paren
id|cnow.cts
op_ne
id|cprev.cts
)paren
)paren
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cprev
op_assign
id|cnow
suffix:semicolon
)brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|3
comma
id|CMD_CTS_NREP
comma
id|CMD_DSR_NREP
comma
id|CMD_RI_NREP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_CHECK_CD
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DCD_NREP
)paren
suffix:semicolon
)brace
id|serviceOutgoingFifo
c_func
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * Get counter of input serial line interrupts (DCD,RI,DSR,CTS)&n;&t; * Return: write counters to the user passed counter struct&n;&t; * NB: both 1-&gt;0 and 0-&gt;1 transitions are counted except for RI where&n;&t; * only 0-&gt;1 is counted. The controller is quite capable of counting&n;&t; * both, but this done to preserve compatibility with the standard&n;&t; * serial driver.&n;&t; */
r_case
id|TIOCGICOUNT
suffix:colon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|11
comma
l_int|1
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cnow
op_assign
id|pCh-&gt;icount
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|p_cuser
op_assign
(paren
r_struct
id|serial_icounter_struct
op_star
)paren
id|arg
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.cts
comma
op_amp
id|p_cuser-&gt;cts
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.dsr
comma
op_amp
id|p_cuser-&gt;dsr
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.rng
comma
op_amp
id|p_cuser-&gt;rng
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.dcd
comma
op_amp
id|p_cuser-&gt;dcd
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.rx
comma
op_amp
id|p_cuser-&gt;rx
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.tx
comma
op_amp
id|p_cuser-&gt;tx
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.frame
comma
op_amp
id|p_cuser-&gt;frame
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.overrun
comma
op_amp
id|p_cuser-&gt;overrun
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.parity
comma
op_amp
id|p_cuser-&gt;parity
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.brk
comma
op_amp
id|p_cuser-&gt;brk
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|cnow.buf_overrun
comma
op_amp
id|p_cuser-&gt;buf_overrun
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * The rest are not supported by this driver. By returning -ENOIOCTLCMD they&n;&t; * will be passed to the line discipline for it to handle.&n;&t; */
r_case
id|TIOCSERCONFIG
suffix:colon
r_case
id|TIOCSERGWILD
suffix:colon
r_case
id|TIOCSERGETLSR
suffix:colon
r_case
id|TIOCSERSWILD
suffix:colon
r_case
id|TIOCSERGSTRUCT
suffix:colon
r_case
id|TIOCSERGETMULTI
suffix:colon
r_case
id|TIOCSERSETMULTI
suffix:colon
r_default
suffix:colon
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
l_int|12
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
id|CHANN
comma
id|ITRC_IOCTL
comma
id|ITRC_RETURN
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   set_modem_info()                                               */
multiline_comment|/* Parameters: Pointer to channel structure                                   */
multiline_comment|/*             Specific ioctl command                                         */
multiline_comment|/*             Pointer to source for new settings                             */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This returns the current settings of the dataset signal inputs to the user */
multiline_comment|/* program.                                                                   */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|set_modem_info
id|set_modem_info
c_func
(paren
id|i2ChanStrPtr
id|pCh
comma
r_int
id|cmd
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
r_int
id|arg
suffix:semicolon
id|GET_USER
c_func
(paren
id|rc
comma
id|arg
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMBIS
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_RTSUP
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_or_assign
id|I2_RTS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DTRUP
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_or_assign
id|I2_DTR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_RTSDN
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_and_assign
op_complement
id|I2_RTS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DTRDN
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_and_assign
op_complement
id|I2_DTR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
r_if
c_cond
(paren
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
op_logical_and
op_logical_neg
(paren
id|pCh-&gt;dataSetOut
op_amp
id|I2_RTS
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_RTSUP
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_or_assign
id|I2_RTS
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
op_logical_and
(paren
id|pCh-&gt;dataSetOut
op_amp
id|I2_RTS
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_RTSDN
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_and_assign
op_complement
id|I2_RTS
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
op_logical_and
op_logical_neg
(paren
id|pCh-&gt;dataSetOut
op_amp
id|I2_DTR
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DTRUP
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_or_assign
id|I2_DTR
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
op_logical_and
(paren
id|pCh-&gt;dataSetOut
op_amp
id|I2_DTR
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DTRDN
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_and_assign
op_complement
id|I2_DTR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|serviceOutgoingFifo
c_func
(paren
id|pCh-&gt;pMyBord
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   GetSerialInfo()                                                */
multiline_comment|/* Parameters: Pointer to channel structure                                   */
multiline_comment|/*             Pointer to old termios structure                               */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This is to support the setserial command, and requires processing of the   */
multiline_comment|/* standard Linux serial structure.                                           */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|get_serial_info
id|get_serial_info
(paren
id|i2ChanStrPtr
id|pCh
comma
r_struct
id|serial_struct
op_star
id|retinfo
)paren
(brace
r_struct
id|serial_struct
id|tmp
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retinfo
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|memset
(paren
op_amp
id|tmp
comma
l_int|0
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|tmp.type
op_assign
id|pCh-&gt;pMyBord-&gt;channelBtypes.bid_value
(braket
(paren
id|pCh-&gt;port_index
op_amp
(paren
id|IP2_PORTS_PER_BOARD
op_minus
l_int|1
)paren
)paren
op_div
l_int|16
)braket
suffix:semicolon
r_if
c_cond
(paren
id|BID_HAS_654
c_func
(paren
id|tmp.type
)paren
)paren
(brace
id|tmp.type
op_assign
id|PORT_16650
suffix:semicolon
)brace
r_else
(brace
id|tmp.type
op_assign
id|PORT_CIRRUS
suffix:semicolon
)brace
id|tmp.line
op_assign
id|pCh-&gt;port_index
suffix:semicolon
id|tmp.port
op_assign
id|pCh-&gt;pMyBord-&gt;i2eBase
suffix:semicolon
id|tmp.irq
op_assign
id|ip2config.irq
(braket
id|pCh-&gt;port_index
op_div
l_int|64
)braket
suffix:semicolon
id|tmp.flags
op_assign
id|pCh-&gt;flags
suffix:semicolon
id|tmp.baud_base
op_assign
id|pCh-&gt;BaudBase
suffix:semicolon
id|tmp.close_delay
op_assign
id|pCh-&gt;ClosingDelay
suffix:semicolon
id|tmp.closing_wait
op_assign
id|pCh-&gt;ClosingWaitTime
suffix:semicolon
id|tmp.custom_divisor
op_assign
id|pCh-&gt;BaudDivisor
suffix:semicolon
id|COPY_TO_USER
c_func
(paren
id|rc
comma
id|retinfo
comma
op_amp
id|tmp
comma
r_sizeof
(paren
op_star
id|retinfo
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   SetSerialInfo()                                                */
multiline_comment|/* Parameters: Pointer to channel structure                                   */
multiline_comment|/*             Pointer to old termios structure                               */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This function provides support for setserial, which uses the TIOCSSERIAL   */
multiline_comment|/* ioctl. Not all setserial parameters are relevant. If the user attempts to  */
multiline_comment|/* change the IRQ, address or type of the port the ioctl fails.               */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|set_serial_info
id|set_serial_info
c_func
(paren
id|i2ChanStrPtr
id|pCh
comma
r_struct
id|serial_struct
op_star
id|new_info
)paren
(brace
r_struct
id|serial_struct
id|ns
suffix:semicolon
r_int
id|old_flags
comma
id|old_baud_divisor
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_info
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|COPY_FROM_USER
c_func
(paren
id|rc
comma
op_amp
id|ns
comma
id|new_info
comma
r_sizeof
(paren
id|ns
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We don&squot;t allow setserial to change IRQ, board address, type or baud&n;&t; * base. Also line nunber as such is meaningless but we use it for our&n;&t; * array index so it is fixed also.&n;&t; */
r_if
c_cond
(paren
(paren
id|ns.irq
op_ne
id|ip2config.irq
(braket
id|pCh-&gt;port_index
)braket
)paren
op_logical_or
(paren
(paren
r_int
)paren
id|ns.port
op_ne
(paren
(paren
r_int
)paren
(paren
id|pCh-&gt;pMyBord-&gt;i2eBase
)paren
)paren
)paren
op_logical_or
(paren
id|ns.baud_base
op_ne
id|pCh-&gt;BaudBase
)paren
op_logical_or
(paren
id|ns.line
op_ne
id|pCh-&gt;port_index
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|old_flags
op_assign
id|pCh-&gt;flags
suffix:semicolon
id|old_baud_divisor
op_assign
id|pCh-&gt;BaudDivisor
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|suser
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|ns.close_delay
op_ne
id|pCh-&gt;ClosingDelay
)paren
op_logical_or
(paren
(paren
id|ns.flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
op_ne
(paren
id|pCh-&gt;flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|pCh-&gt;flags
op_assign
(paren
id|pCh-&gt;flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
op_or
(paren
id|ns.flags
op_amp
id|ASYNC_USR_MASK
)paren
suffix:semicolon
id|pCh-&gt;BaudDivisor
op_assign
id|ns.custom_divisor
suffix:semicolon
)brace
r_else
(brace
id|pCh-&gt;flags
op_assign
(paren
id|pCh-&gt;flags
op_amp
op_complement
id|ASYNC_FLAGS
)paren
op_or
(paren
id|ns.flags
op_amp
id|ASYNC_FLAGS
)paren
suffix:semicolon
id|pCh-&gt;BaudDivisor
op_assign
id|ns.custom_divisor
suffix:semicolon
id|pCh-&gt;ClosingDelay
op_assign
id|ns.close_delay
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|pCh-&gt;ClosingWaitTime
op_assign
id|ns.closing_wait
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|old_flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_ne
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
)paren
op_logical_or
(paren
id|old_baud_divisor
op_ne
id|pCh-&gt;BaudDivisor
)paren
)paren
(brace
singleline_comment|// Invalidate speed and reset parameters
id|set_params
c_func
(paren
id|pCh
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_set_termios()                                              */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/*             Pointer to old termios structure                               */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_set_termios
id|ip2_set_termios
c_func
(paren
id|PTTY
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
id|i2ChanStrPtr
id|pCh
op_assign
(paren
id|i2ChanStrPtr
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef IP2DEBUG_IOCTL
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2: set termios %p&bslash;n&quot;
comma
id|old_termios
)paren
suffix:semicolon
macro_line|#endif
id|set_params
c_func
(paren
id|pCh
comma
id|old_termios
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_set_line_discipline()                                      */
multiline_comment|/* Parameters: Pointer to tty structure                                       */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:  Does nothing                                                 */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|ip2_set_line_discipline
id|ip2_set_line_discipline
(paren
id|PTTY
id|tty
)paren
(brace
macro_line|#ifdef IP2DEBUG_IOCTL
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2: set line discipline&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IP2DEBUG_TRACE
id|ip2trace
(paren
(paren
(paren
id|i2ChanStrPtr
)paren
id|tty-&gt;driver_data
)paren
op_member_access_from_pointer
id|port_index
comma
id|ITRC_IOCTL
comma
l_int|16
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   SetLine Characteristics()                                      */
multiline_comment|/* Parameters: Pointer to channel structure                                   */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/* This routine is called to update the channel structure with the new line   */
multiline_comment|/* characteristics, and send the appropriate commands to the board when they  */
multiline_comment|/* change.                                                                    */
multiline_comment|/******************************************************************************/
r_static
r_void
DECL|function|set_params
id|set_params
c_func
(paren
id|i2ChanStrPtr
id|pCh
comma
r_struct
id|termios
op_star
id|o_tios
)paren
(brace
id|tcflag_t
id|cflag
comma
id|iflag
comma
id|lflag
suffix:semicolon
r_char
id|stop_char
comma
id|start_char
suffix:semicolon
r_struct
id|termios
id|dummy
suffix:semicolon
id|lflag
op_assign
id|pCh-&gt;pTTY-&gt;termios-&gt;c_lflag
suffix:semicolon
id|cflag
op_assign
id|pCh-&gt;pTTY-&gt;termios-&gt;c_cflag
suffix:semicolon
id|iflag
op_assign
id|pCh-&gt;pTTY-&gt;termios-&gt;c_iflag
suffix:semicolon
r_if
c_cond
(paren
id|o_tios
op_eq
l_int|NULL
)paren
(brace
id|dummy.c_lflag
op_assign
op_complement
id|lflag
suffix:semicolon
id|dummy.c_cflag
op_assign
op_complement
id|cflag
suffix:semicolon
id|dummy.c_iflag
op_assign
op_complement
id|iflag
suffix:semicolon
id|o_tios
op_assign
op_amp
id|dummy
suffix:semicolon
)brace
(brace
r_switch
c_cond
(paren
id|cflag
op_amp
id|CBAUD
)paren
(brace
r_case
id|B0
suffix:colon
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|2
comma
id|CMD_RTSDN
comma
id|CMD_DTRDN
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_and_assign
op_complement
(paren
id|I2_DTR
op_or
id|I2_RTS
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_PAUSE
c_func
(paren
l_int|25
)paren
)paren
suffix:semicolon
id|pCh-&gt;pTTY-&gt;termios-&gt;c_cflag
op_or_assign
(paren
id|CBAUD
op_amp
id|o_tios-&gt;c_cflag
)paren
suffix:semicolon
r_goto
id|service_it
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * This is the speed that is overloaded with all the other high&n;&t;&t;&t; * speeds, depending upon the flag settings.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_HI
)paren
(brace
id|pCh-&gt;speed
op_assign
id|CBR_57600
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_VHI
)paren
(brace
id|pCh-&gt;speed
op_assign
id|CBR_115200
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pCh-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_CUST
)paren
(brace
id|pCh-&gt;speed
op_assign
id|CBR_C1
suffix:semicolon
)brace
r_else
(brace
id|pCh-&gt;speed
op_assign
id|CBR_38400
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|B50
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_50
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B75
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_75
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B110
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_110
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B134
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_134
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B150
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_150
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B200
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B300
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_300
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_1200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1800
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_1800
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_2400
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_4800
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B9600
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_9600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_19200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_57600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_115200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B153600
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_153600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B230400
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_230400
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B307200
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_307200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B460800
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_460800
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B921600
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_921600
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|pCh-&gt;speed
op_assign
id|CBR_9600
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pCh-&gt;speed
op_eq
id|CBR_C1
)paren
(brace
singleline_comment|// Process the custom speed parameters.
r_int
id|bps
op_assign
id|pCh-&gt;BaudBase
op_div
id|pCh-&gt;BaudDivisor
suffix:semicolon
r_if
c_cond
(paren
id|bps
op_eq
l_int|921600
)paren
(brace
id|pCh-&gt;speed
op_assign
id|CBR_921600
suffix:semicolon
)brace
r_else
(brace
id|bps
op_assign
id|bps
op_div
l_int|10
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_BAUD_DEF1
c_func
(paren
id|bps
)paren
)paren
suffix:semicolon
)brace
)brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_SETBAUD
c_func
(paren
id|pCh-&gt;speed
)paren
)paren
suffix:semicolon
id|i2QueueCommands
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|2
comma
id|CMD_DTRUP
comma
id|CMD_RTSUP
)paren
suffix:semicolon
id|pCh-&gt;dataSetOut
op_or_assign
(paren
id|I2_DTR
op_or
id|I2_RTS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|CSTOPB
op_amp
id|cflag
)paren
op_xor
(paren
id|CSTOPB
op_amp
id|o_tios-&gt;c_cflag
)paren
)paren
(brace
id|i2QueueCommands
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_SETSTOP
c_func
(paren
(paren
id|cflag
op_amp
id|CSTOPB
)paren
ques
c_cond
id|CST_2
suffix:colon
id|CST_1
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|PARENB
op_or
id|PARODD
)paren
op_amp
id|cflag
)paren
op_xor
(paren
(paren
id|PARENB
op_or
id|PARODD
)paren
op_amp
id|o_tios-&gt;c_cflag
)paren
)paren
(brace
id|i2QueueCommands
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_SETPAR
c_func
(paren
(paren
id|cflag
op_amp
id|PARENB
ques
c_cond
(paren
id|cflag
op_amp
id|PARODD
ques
c_cond
id|CSP_OD
suffix:colon
id|CSP_EV
)paren
suffix:colon
id|CSP_NP
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* byte size and parity */
r_if
c_cond
(paren
(paren
id|CSIZE
op_amp
id|cflag
)paren
op_xor
(paren
id|CSIZE
op_amp
id|o_tios-&gt;c_cflag
)paren
)paren
(brace
r_int
id|datasize
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|datasize
op_assign
id|CSZ_5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|datasize
op_assign
id|CSZ_6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|datasize
op_assign
id|CSZ_7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|datasize
op_assign
id|CSZ_8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|datasize
op_assign
id|CSZ_5
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* as per serial.c */
)brace
id|i2QueueCommands
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_SETBITS
c_func
(paren
id|datasize
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Process CTS flow control flag setting */
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|2
comma
id|CMD_CTSFL_ENAB
comma
id|CMD_RTSFL_ENAB
)paren
suffix:semicolon
)brace
r_else
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|2
comma
id|CMD_CTSFL_DSAB
comma
id|CMD_RTSFL_DSAB
)paren
suffix:semicolon
)brace
singleline_comment|//
singleline_comment|// Process XON/XOFF flow control flags settings
singleline_comment|//
id|stop_char
op_assign
id|STOP_CHAR
c_func
(paren
id|pCh-&gt;pTTY
)paren
suffix:semicolon
id|start_char
op_assign
id|START_CHAR
c_func
(paren
id|pCh-&gt;pTTY
)paren
suffix:semicolon
singleline_comment|//////////// can&squot;t be &bslash;000
r_if
c_cond
(paren
id|stop_char
op_eq
id|__DISABLED_CHAR
)paren
(brace
id|stop_char
op_assign
op_complement
id|__DISABLED_CHAR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|start_char
op_eq
id|__DISABLED_CHAR
)paren
(brace
id|start_char
op_assign
op_complement
id|__DISABLED_CHAR
suffix:semicolon
)brace
singleline_comment|/////////////////////////////////
r_if
c_cond
(paren
id|o_tios-&gt;c_cc
(braket
id|VSTART
)braket
op_ne
id|start_char
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DEF_IXON
c_func
(paren
id|start_char
)paren
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DEF_OXON
c_func
(paren
id|start_char
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|o_tios-&gt;c_cc
(braket
id|VSTOP
)braket
op_ne
id|stop_char
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DEF_IXOFF
c_func
(paren
id|stop_char
)paren
)paren
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DEF_OXOFF
c_func
(paren
id|stop_char
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stop_char
op_eq
id|__DISABLED_CHAR
)paren
(brace
id|stop_char
op_assign
op_complement
id|__DISABLED_CHAR
suffix:semicolon
singleline_comment|//TEST123
r_goto
id|no_xoff
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|iflag
op_amp
(paren
id|IXOFF
)paren
)paren
op_xor
(paren
id|o_tios-&gt;c_iflag
op_amp
(paren
id|IXOFF
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|iflag
op_amp
id|IXOFF
)paren
(brace
singleline_comment|// Enable XOFF output flow control
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_OXON_OPT
c_func
(paren
id|COX_XON
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Disable XOFF output flow control
id|no_xoff
suffix:colon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_OXON_OPT
c_func
(paren
id|COX_NONE
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|start_char
op_eq
id|__DISABLED_CHAR
)paren
(brace
r_goto
id|no_xon
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|iflag
op_amp
(paren
id|IXON
op_or
id|IXANY
)paren
)paren
op_xor
(paren
id|o_tios-&gt;c_iflag
op_amp
(paren
id|IXON
op_or
id|IXANY
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|iflag
op_amp
id|IXON
)paren
(brace
r_if
c_cond
(paren
id|iflag
op_amp
id|IXANY
)paren
(brace
singleline_comment|// Enable XON/XANY output flow control
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_IXON_OPT
c_func
(paren
id|CIX_XANY
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Enable XON output flow control
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_IXON_OPT
c_func
(paren
id|CIX_XON
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// Disable XON output flow control
id|no_xon
suffix:colon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_IXON_OPT
c_func
(paren
id|CIX_NONE
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|iflag
op_amp
id|ISTRIP
)paren
op_xor
(paren
id|o_tios-&gt;c_iflag
op_amp
(paren
id|ISTRIP
)paren
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_ISTRIP_OPT
c_func
(paren
(paren
id|iflag
op_amp
id|ISTRIP
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|iflag
op_amp
id|INPCK
)paren
op_xor
(paren
id|o_tios-&gt;c_iflag
op_amp
(paren
id|INPCK
)paren
)paren
)paren
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_PARCHK
c_func
(paren
(paren
id|iflag
op_amp
id|INPCK
)paren
ques
c_cond
id|CPK_ENAB
suffix:colon
id|CPK_DSAB
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|iflag
op_amp
(paren
id|IGNBRK
op_or
id|PARMRK
op_or
id|BRKINT
op_or
id|IGNPAR
)paren
)paren
op_xor
(paren
id|o_tios-&gt;c_iflag
op_amp
(paren
id|IGNBRK
op_or
id|PARMRK
op_or
id|BRKINT
op_or
id|IGNPAR
)paren
)paren
)paren
(brace
r_char
id|brkrpt
op_assign
l_int|0
suffix:semicolon
r_char
id|parrpt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNBRK
)paren
(brace
multiline_comment|/* Ignore breaks altogether */
multiline_comment|/* Ignore breaks altogether */
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_BRK_NREP
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|iflag
op_amp
id|BRKINT
)paren
(brace
r_if
c_cond
(paren
id|iflag
op_amp
id|PARMRK
)paren
(brace
id|brkrpt
op_assign
l_int|0x0a
suffix:semicolon
singleline_comment|// exception an inline triple
)brace
r_else
(brace
id|brkrpt
op_assign
l_int|0x1a
suffix:semicolon
singleline_comment|// exception and NULL
)brace
id|brkrpt
op_or_assign
l_int|0x04
suffix:semicolon
singleline_comment|// flush input
)brace
r_else
(brace
r_if
c_cond
(paren
id|iflag
op_amp
id|PARMRK
)paren
(brace
id|brkrpt
op_assign
l_int|0x0b
suffix:semicolon
singleline_comment|//POSIX triple &bslash;0377 &bslash;0 &bslash;0
)brace
r_else
(brace
id|brkrpt
op_assign
l_int|0x01
suffix:semicolon
singleline_comment|// Null only
)brace
)brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_BRK_REP
c_func
(paren
id|brkrpt
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNPAR
)paren
(brace
id|parrpt
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* would be 2 for not cirrus bug */
multiline_comment|/* would be 0x20 cept for cirrus bug */
)brace
r_else
(brace
r_if
c_cond
(paren
id|iflag
op_amp
id|PARMRK
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Replace error characters with 3-byte sequence (&bslash;0377,&bslash;0,char)&n;&t;&t;&t;&t; */
id|parrpt
op_assign
l_int|0x04
suffix:semicolon
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_ISTRIP_OPT
c_func
(paren
(paren
r_char
)paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|parrpt
op_assign
l_int|0x03
suffix:semicolon
)brace
)brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_SET_ERROR
c_func
(paren
id|parrpt
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
(brace
singleline_comment|// Status reporting fails for DCD if this is off
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DCD_NREP
)paren
suffix:semicolon
id|pCh-&gt;flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
)brace
r_else
(brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_INLINE
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_DCD_REP
)paren
suffix:semicolon
id|pCh-&gt;flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
)brace
macro_line|#ifdef XXX
id|do_flags_thing
suffix:colon
singleline_comment|// This is a test, we don&squot;t do the flags thing
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|cflag
op_or_assign
l_int|014000000000
suffix:semicolon
)brace
id|i2QueueCommands
c_func
(paren
id|PTYPE_BYPASS
comma
id|pCh
comma
l_int|100
comma
l_int|1
comma
id|CMD_UNIX_FLAGS
c_func
(paren
id|iflag
comma
id|cflag
comma
id|lflag
)paren
)paren
suffix:semicolon
macro_line|#endif
id|service_it
suffix:colon
id|i2DrainOutput
c_func
(paren
id|pCh
comma
l_int|100
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* IPL Device Section                                                         */
multiline_comment|/******************************************************************************/
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_ipl_read()                                                  */
multiline_comment|/* Parameters: Pointer to device inode                                        */
multiline_comment|/*             Pointer to file structure                                      */
multiline_comment|/*             Pointer to data                                                */
multiline_comment|/*             Number of bytes to read                                        */
multiline_comment|/* Returns:    Success or failure                                             */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:   Ugly                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
macro_line|#if LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,1,0)
r_int
id|ip2_ipl_read
c_func
(paren
r_struct
id|inode
op_star
id|pInode
comma
r_char
op_star
id|pData
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
DECL|variable|minor
r_int
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|pInode-&gt;i_rdev
)paren
suffix:semicolon
macro_line|#else
id|ssize_t
DECL|function|ip2_ipl_read
id|ip2_ipl_read
c_func
(paren
r_struct
id|file
op_star
id|pFile
comma
r_char
op_star
id|pData
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
(brace
r_int
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|pFile-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
macro_line|#endif
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef IP2DEBUG_IPL
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2IPL: read %p, %d bytes&bslash;n&quot;
comma
id|pData
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|minor
)paren
(brace
r_case
l_int|0
suffix:colon
singleline_comment|// IPL device
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
singleline_comment|// Status dump
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
singleline_comment|// Ping device
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
singleline_comment|// Trace device
id|rc
op_assign
id|DumpTraceBuffer
(paren
id|pData
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
singleline_comment|// Trace device
id|rc
op_assign
id|DumpFifoBuffer
(paren
id|pData
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|DumpFifoBuffer
id|DumpFifoBuffer
(paren
r_char
op_star
id|pData
comma
r_int
id|count
)paren
(brace
macro_line|#ifdef DEBUG_FIFO
r_int
id|rc
suffix:semicolon
id|COPY_TO_USER
c_func
(paren
id|rc
comma
id|pData
comma
id|DBGBuf
comma
id|count
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Last index %d&bslash;n&quot;
comma
id|I
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
macro_line|#endif&t;/* DEBUG_FIFO */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|DumpTraceBuffer
id|DumpTraceBuffer
(paren
r_char
op_star
id|pData
comma
r_int
id|count
)paren
(brace
macro_line|#ifdef IP2DEBUG_TRACE
r_int
id|rc
suffix:semicolon
r_int
id|dumpcount
suffix:semicolon
r_int
id|chunk
suffix:semicolon
r_int
op_star
id|pIndex
op_assign
(paren
r_int
op_star
)paren
id|pData
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
(paren
r_sizeof
(paren
r_int
)paren
op_star
l_int|6
)paren
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|PUT_USER
c_func
(paren
id|rc
comma
id|tracewrap
comma
id|pIndex
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|TRACEMAX
comma
op_increment
id|pIndex
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|tracestrip
comma
op_increment
id|pIndex
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|tracestuff
comma
op_increment
id|pIndex
)paren
suffix:semicolon
id|pData
op_add_assign
r_sizeof
(paren
r_int
)paren
op_star
l_int|6
suffix:semicolon
id|count
op_sub_assign
r_sizeof
(paren
r_int
)paren
op_star
l_int|6
suffix:semicolon
id|dumpcount
op_assign
id|tracestuff
op_minus
id|tracestrip
suffix:semicolon
r_if
c_cond
(paren
id|dumpcount
OL
l_int|0
)paren
(brace
id|dumpcount
op_add_assign
id|TRACEMAX
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dumpcount
OG
id|count
)paren
(brace
id|dumpcount
op_assign
id|count
suffix:semicolon
)brace
id|chunk
op_assign
id|TRACEMAX
op_minus
id|tracestrip
suffix:semicolon
r_if
c_cond
(paren
id|dumpcount
OG
id|chunk
)paren
(brace
id|COPY_TO_USER
c_func
(paren
id|rc
comma
id|pData
comma
op_amp
id|tracebuf
(braket
id|tracestrip
)braket
comma
id|chunk
op_star
r_sizeof
(paren
id|tracebuf
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|pData
op_add_assign
id|chunk
op_star
r_sizeof
(paren
id|tracebuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|tracestrip
op_assign
l_int|0
suffix:semicolon
id|chunk
op_assign
id|dumpcount
op_minus
id|chunk
suffix:semicolon
)brace
r_else
(brace
id|chunk
op_assign
id|dumpcount
suffix:semicolon
)brace
id|COPY_TO_USER
c_func
(paren
id|rc
comma
id|pData
comma
op_amp
id|tracebuf
(braket
id|tracestrip
)braket
comma
id|chunk
op_star
r_sizeof
(paren
id|tracebuf
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|tracestrip
op_add_assign
id|chunk
suffix:semicolon
id|tracewrap
op_assign
l_int|0
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|tracestrip
comma
op_increment
id|pIndex
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|tracestuff
comma
op_increment
id|pIndex
)paren
suffix:semicolon
r_return
id|dumpcount
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_ipl_write()                                                 */
multiline_comment|/* Parameters:                                                                */
multiline_comment|/*             Pointer to file structure                                      */
multiline_comment|/*             Pointer to data                                                */
multiline_comment|/*             Number of bytes to write                                       */
multiline_comment|/* Returns:    Success or failure                                             */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
id|ssize_t
DECL|function|ip2_ipl_write
id|ip2_ipl_write
c_func
(paren
r_struct
id|file
op_star
id|pFile
comma
r_const
r_char
op_star
id|pData
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
(brace
macro_line|#ifdef IP2DEBUG_IPL
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2IPL: write %p, %d bytes&bslash;n&quot;
comma
id|pData
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_ipl_ioctl()                                                */
multiline_comment|/* Parameters: Pointer to device inode                                        */
multiline_comment|/*             Pointer to file structure                                      */
multiline_comment|/*             Command                                                        */
multiline_comment|/*             Argument                                                       */
multiline_comment|/* Returns:    Success or failure                                             */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|ip2_ipl_ioctl
id|ip2_ipl_ioctl
(paren
r_struct
id|inode
op_star
id|pInode
comma
r_struct
id|file
op_star
id|pFile
comma
id|UINT
id|cmd
comma
id|ULONG
id|arg
)paren
(brace
r_int
r_int
id|iplminor
op_assign
id|MINOR
c_func
(paren
id|pInode-&gt;i_rdev
)paren
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|ULONG
op_star
id|pIndex
op_assign
(paren
id|ULONG
op_star
)paren
id|arg
suffix:semicolon
id|i2eBordStrPtr
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|iplminor
op_div
l_int|4
)braket
suffix:semicolon
id|i2ChanStrPtr
id|pCh
suffix:semicolon
macro_line|#ifdef IP2DEBUG_IPL
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2IPL: ioctl cmd %d, arg %ld&bslash;n&quot;
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|iplminor
)paren
(brace
r_case
l_int|0
suffix:colon
singleline_comment|// IPL device
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
singleline_comment|// Status dump
r_case
l_int|5
suffix:colon
r_case
l_int|9
suffix:colon
r_case
l_int|13
suffix:colon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
l_int|64
suffix:colon
multiline_comment|/* Driver - ip2stat */
id|PUT_USER
c_func
(paren
id|rc
comma
id|ref_count
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|irq_counter
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|bh_counter
comma
id|pIndex
op_increment
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|65
suffix:colon
multiline_comment|/* Board  - ip2stat */
r_if
c_cond
(paren
id|pB
)paren
(brace
id|COPY_TO_USER
c_func
(paren
id|rc
comma
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
id|pB
comma
r_sizeof
(paren
id|i2eBordStr
)paren
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|INB
c_func
(paren
id|pB-&gt;i2eStatus
)paren
comma
(paren
id|ULONG
op_star
)paren
(paren
id|arg
op_plus
(paren
id|ULONG
)paren
(paren
op_amp
id|pB-&gt;i2eStatus
)paren
op_minus
(paren
id|ULONG
)paren
id|pB
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|pCh
op_assign
id|DevTable
(braket
id|cmd
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pCh
)paren
(brace
id|COPY_TO_USER
c_func
(paren
id|rc
comma
(paren
r_char
op_star
)paren
id|arg
comma
(paren
r_char
op_star
)paren
id|pCh
comma
r_sizeof
(paren
id|i2ChanStr
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|cmd
OL
l_int|64
ques
c_cond
op_minus
id|ENODEV
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
singleline_comment|// Ping device
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
singleline_comment|// Trace device
r_if
c_cond
(paren
id|cmd
op_eq
l_int|1
)paren
(brace
id|PUT_USER
c_func
(paren
id|rc
comma
id|iiSendPendingMail
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2InitChannels
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2QueueNeeds
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2QueueCommands
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2GetStatus
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2Input
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2InputFlush
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2Output
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2FlushOutput
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2DrainWakeup
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2DrainOutput
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2OutputFree
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2StripFifo
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2StuffFifoBypass
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2StuffFifoFlow
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2StuffFifoInline
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|i2ServiceBoard
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|serviceOutgoingFifo
comma
id|pIndex
op_increment
)paren
suffix:semicolon
singleline_comment|// PUT_USER(rc, ip2_init, pIndex++ );
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_init_board
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|find_eisa_board
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|set_irq
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_interrupt
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_poll
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|service_all_boards
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|do_input
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|do_status
comma
id|pIndex
op_increment
)paren
suffix:semicolon
macro_line|#ifndef IP2DEBUG_OPEN
id|PUT_USER
c_func
(paren
id|rc
comma
l_int|0
comma
id|pIndex
op_increment
)paren
suffix:semicolon
macro_line|#else
id|PUT_USER
c_func
(paren
id|rc
comma
id|open_sanity_check
comma
id|pIndex
op_increment
)paren
suffix:semicolon
macro_line|#endif
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_open
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_close
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_hangup
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_write
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_putchar
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_flush_chars
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_write_room
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_chars_in_buf
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_flush_buffer
comma
id|pIndex
op_increment
)paren
suffix:semicolon
singleline_comment|//PUT_USER(rc, ip2_wait_until_sent, pIndex++ );
id|PUT_USER
c_func
(paren
id|rc
comma
l_int|0
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_throttle
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_unthrottle
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_ioctl
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|set_modem_info
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|get_serial_info
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|set_serial_info
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_set_termios
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|ip2_set_line_discipline
comma
id|pIndex
op_increment
)paren
suffix:semicolon
id|PUT_USER
c_func
(paren
id|rc
comma
id|set_params
comma
id|pIndex
op_increment
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_ipl_open()                                                 */
multiline_comment|/* Parameters: Pointer to device inode                                        */
multiline_comment|/*             Pointer to file structure                                      */
multiline_comment|/* Returns:    Success or failure                                             */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_static
r_int
DECL|function|ip2_ipl_open
id|ip2_ipl_open
c_func
(paren
r_struct
id|inode
op_star
id|pInode
comma
r_struct
id|file
op_star
id|pFile
)paren
(brace
r_int
r_int
id|iplminor
op_assign
id|MINOR
c_func
(paren
id|pInode-&gt;i_rdev
)paren
suffix:semicolon
id|i2eBordStrPtr
id|pB
suffix:semicolon
id|i2ChanStrPtr
id|pCh
suffix:semicolon
macro_line|#ifdef IP2DEBUG_IPL
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IP2IPL: open&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|iplminor
)paren
(brace
singleline_comment|// These are the IPL devices
r_case
l_int|0
suffix:colon
r_case
l_int|4
suffix:colon
r_case
l_int|8
suffix:colon
r_case
l_int|12
suffix:colon
r_break
suffix:semicolon
singleline_comment|// These are the status devices
r_case
l_int|1
suffix:colon
r_case
l_int|5
suffix:colon
r_case
l_int|9
suffix:colon
r_case
l_int|13
suffix:colon
r_break
suffix:semicolon
singleline_comment|// These are the debug devices
r_case
l_int|2
suffix:colon
r_case
l_int|6
suffix:colon
r_case
l_int|10
suffix:colon
r_case
l_int|14
suffix:colon
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|iplminor
op_div
l_int|4
)braket
suffix:semicolon
id|pCh
op_assign
(paren
id|i2ChanStrPtr
)paren
id|pB-&gt;i2eChannelPtr
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// This is the trace device
r_case
l_int|3
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2_read_procmem                                               */
multiline_comment|/* Parameters:                                                                */
multiline_comment|/*                                                                            */
multiline_comment|/* Returns: Length of output                                                  */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*   Supplies some driver operating parameters                                */
multiline_comment|/*&t;Not real useful unless your debugging the fifo&t;&t;&t;&t;&t;&t;&t;  */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
DECL|macro|LIMIT
mdefine_line|#define LIMIT  (PAGE_SIZE - 120)
r_static
r_int
DECL|function|ip2_read_procmem
id|ip2_read_procmem
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
)paren
(brace
id|i2eBordStrPtr
id|pB
suffix:semicolon
id|i2ChanStrPtr
id|pCh
suffix:semicolon
id|PTTY
id|tty
suffix:semicolon
r_int
id|i
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
DECL|macro|FMTLINE
mdefine_line|#define FMTLINE&t;&quot;%3d: 0x%08x 0x%08x 0%011o 0%011o&bslash;n&quot;
DECL|macro|FMTLIN2
mdefine_line|#define FMTLIN2&t;&quot;     0x%04x 0x%04x tx flow 0x%x&bslash;n&quot;
DECL|macro|FMTLIN3
mdefine_line|#define FMTLIN3&t;&quot;     0x%04x 0x%04x rc flow&bslash;n&quot;
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pB
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;board %d:&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;&bslash;tFifo rem: %d mty: %x outM %x&bslash;n&quot;
comma
id|pB-&gt;i2eFifoRemains
comma
id|pB-&gt;i2eWaitingForEmptyFifo
comma
id|pB-&gt;i2eOutMailWaiting
)paren
suffix:semicolon
)brace
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;#: tty flags, port flags,     cflags,     iflags&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|len
OG
id|LIMIT
)paren
r_break
suffix:semicolon
id|pCh
op_assign
id|DevTable
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pCh
)paren
(brace
id|tty
op_assign
id|pCh-&gt;pTTY
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_logical_and
id|tty-&gt;count
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
id|FMTLINE
comma
id|i
comma
(paren
r_int
)paren
id|tty-&gt;flags
comma
id|pCh-&gt;flags
comma
id|tty-&gt;termios-&gt;c_cflag
comma
id|tty-&gt;termios-&gt;c_iflag
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
id|FMTLIN2
comma
id|pCh-&gt;outfl.asof
comma
id|pCh-&gt;outfl.room
comma
id|pCh-&gt;channelNeeds
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
id|FMTLIN3
comma
id|pCh-&gt;infl.asof
comma
id|pCh-&gt;infl.room
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the handler for /proc/tty/driver/ip2&n; *&n; * This stretch of code has been largely plagerized from at least three&n; * different sources including ip2mkdev.c and a couple of other drivers.&n; * The bugs are all mine.  :-)&t;=mhw=&n; */
DECL|function|ip2_read_proc
r_int
id|ip2_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|i
comma
id|j
comma
id|box
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|boxes
op_assign
l_int|0
suffix:semicolon
r_int
id|ports
op_assign
l_int|0
suffix:semicolon
r_int
id|tports
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
id|i2eBordStrPtr
id|pB
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;ip2info: 1.0 driver: %s&bslash;n&quot;
comma
id|pcVersion
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Driver: SMajor=%d CMajor=%d IMajor=%d MaxBoards=%d MaxBoxes=%d MaxPorts=%d&bslash;n&quot;
comma
id|IP2_TTY_MAJOR
comma
id|IP2_CALLOUT_MAJOR
comma
id|IP2_IPL_MAJOR
comma
id|IP2_MAX_BOARDS
comma
id|ABS_MAX_BOXES
comma
id|ABS_BIGGEST_BOX
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IP2_MAX_BOARDS
suffix:semicolon
op_increment
id|i
)paren
(brace
multiline_comment|/* This need to be reset for a board by board count... */
id|boxes
op_assign
l_int|0
suffix:semicolon
id|pB
op_assign
id|i2BoardPtrTable
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pB
)paren
(brace
r_switch
c_cond
(paren
id|pB-&gt;i2ePom.e.porID
op_amp
op_complement
id|POR_ID_RESERVED
)paren
(brace
r_case
id|POR_ID_FIIEX
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Board %d: EX ports=&quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|box
op_assign
l_int|0
suffix:semicolon
id|box
OL
id|ABS_MAX_BOXES
suffix:semicolon
op_increment
id|box
)paren
(brace
id|ports
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pB-&gt;i2eChannelMap
(braket
id|box
)braket
op_ne
l_int|0
)paren
(brace
op_increment
id|boxes
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ABS_BIGGEST_BOX
suffix:semicolon
op_increment
id|j
)paren
(brace
r_if
c_cond
(paren
id|pB-&gt;i2eChannelMap
(braket
id|box
)braket
op_amp
l_int|1
op_lshift
id|j
)paren
(brace
op_increment
id|ports
suffix:semicolon
)brace
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d,&quot;
comma
id|ports
)paren
suffix:semicolon
id|tports
op_add_assign
id|ports
suffix:semicolon
)brace
op_decrement
id|len
suffix:semicolon
multiline_comment|/* Backup over that last comma */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; boxes=%d width=%d&quot;
comma
id|boxes
comma
id|pB-&gt;i2eDataWidth16
ques
c_cond
l_int|16
suffix:colon
l_int|8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POR_ID_II_4
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Board %d: ISA-4 ports=4 boxes=1&quot;
comma
id|i
)paren
suffix:semicolon
id|tports
op_assign
id|ports
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POR_ID_II_8
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Board %d: ISA-8-std ports=8 boxes=1&quot;
comma
id|i
)paren
suffix:semicolon
id|tports
op_assign
id|ports
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|POR_ID_II_8R
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Board %d: ISA-8-RJ11 ports=8 boxes=1&quot;
comma
id|i
)paren
suffix:semicolon
id|tports
op_assign
id|ports
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Board %d: unknown&quot;
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t try and probe for minor numbers */
id|tports
op_assign
id|ports
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Don&squot;t try and probe for minor numbers */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;Board %d: vacant&quot;
comma
id|i
)paren
suffix:semicolon
id|tports
op_assign
id|ports
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tports
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; minors=&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|box
op_assign
l_int|0
suffix:semicolon
id|box
OL
id|ABS_MAX_BOXES
suffix:semicolon
op_increment
id|box
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ABS_BIGGEST_BOX
suffix:semicolon
op_increment
id|j
)paren
(brace
r_if
c_cond
(paren
id|pB-&gt;i2eChannelMap
(braket
id|box
)braket
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d,&quot;
comma
id|j
op_plus
id|ABS_BIGGEST_BOX
op_star
(paren
id|box
op_plus
id|i
op_star
id|ABS_MAX_BOXES
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|page
(braket
id|len
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
multiline_comment|/* Overwrite that last comma */
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_plus
id|begin
OG
id|off
op_plus
id|count
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
id|begin
OL
id|off
)paren
(brace
id|begin
op_add_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_ge
id|IP2_MAX_BOARDS
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ge
id|len
op_plus
id|begin
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
(paren
id|off
op_minus
id|begin
)paren
suffix:semicolon
r_return
(paren
(paren
id|count
OL
id|begin
op_plus
id|len
op_minus
id|off
)paren
ques
c_cond
id|count
suffix:colon
id|begin
op_plus
id|len
op_minus
id|off
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************************************************/
multiline_comment|/* Function:   ip2trace()                                                     */
multiline_comment|/* Parameters: Value to add to trace buffer                                   */
multiline_comment|/* Returns:    Nothing                                                        */
multiline_comment|/*                                                                            */
multiline_comment|/* Description:                                                               */
multiline_comment|/*                                                                            */
multiline_comment|/*                                                                            */
multiline_comment|/******************************************************************************/
r_void
DECL|function|ip2trace
id|ip2trace
(paren
r_int
r_int
id|pn
comma
r_int
r_char
id|cat
comma
r_int
r_char
id|label
comma
r_int
r_int
id|codes
comma
dot
dot
dot
)paren
(brace
macro_line|#ifdef IP2DEBUG_TRACE
r_int
id|flags
suffix:semicolon
r_int
r_int
op_star
id|pCode
op_assign
op_amp
id|codes
suffix:semicolon
r_union
id|ip2breadcrumb
id|bc
suffix:semicolon
id|i2ChanStrPtr
id|pCh
suffix:semicolon
id|tracebuf
(braket
id|tracestuff
op_increment
)braket
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|tracestuff
op_eq
id|TRACEMAX
)paren
(brace
id|tracestuff
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tracestuff
op_eq
id|tracestrip
)paren
(brace
r_if
c_cond
(paren
op_increment
id|tracestrip
op_eq
id|TRACEMAX
)paren
(brace
id|tracestrip
op_assign
l_int|0
suffix:semicolon
)brace
op_increment
id|tracewrap
suffix:semicolon
)brace
id|bc.hdr.port
op_assign
l_int|0xff
op_amp
id|pn
suffix:semicolon
id|bc.hdr.cat
op_assign
id|cat
suffix:semicolon
id|bc.hdr.codes
op_assign
(paren
r_int
r_char
)paren
(paren
id|codes
op_amp
l_int|0xff
)paren
suffix:semicolon
id|bc.hdr.label
op_assign
id|label
suffix:semicolon
id|tracebuf
(braket
id|tracestuff
op_increment
)braket
op_assign
id|bc.value
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|tracestuff
op_eq
id|TRACEMAX
)paren
(brace
id|tracestuff
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tracestuff
op_eq
id|tracestrip
)paren
(brace
r_if
c_cond
(paren
op_increment
id|tracestrip
op_eq
id|TRACEMAX
)paren
(brace
id|tracestrip
op_assign
l_int|0
suffix:semicolon
)brace
op_increment
id|tracewrap
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|codes
op_decrement
)paren
r_break
suffix:semicolon
id|tracebuf
(braket
id|tracestuff
op_increment
)braket
op_assign
op_star
op_increment
id|pCode
suffix:semicolon
)brace
macro_line|#endif
)brace
eof
