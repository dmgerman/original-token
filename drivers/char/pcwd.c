multiline_comment|/*&n; * PC Watchdog Driver&n; * by Ken Hollis (khollis@bitgate.com)&n; *&n; * Permission granted from Simon Machell (73244.1270@compuserve.com)&n; * Written for the Linux Kernel, and GPLed by Ken Hollis&n; *&n; * 960107&t;Added request_region routines, modulized the whole thing.&n; * 960108&t;Fixed end-of-file pointer (Thanks to Dan Hollis), added&n; *&t;&t;WD_TIMEOUT define.&n; * 960216&t;Added eof marker on the file, and changed verbose messages.&n; * 960716&t;Made functional and cosmetic changes to the source for&n; *&t;&t;inclusion in Linux 2.0.x kernels, thanks to Alan Cox.&n; * 960717&t;Removed read/seek routines, replaced with ioctl.  Also, added&n; *&t;&t;check_region command due to Alan&squot;s suggestion.&n; * 960821&t;Made changes to compile in newer 2.0.x kernels.  Added&n; *&t;&t;&quot;cold reboot sense&quot; entry.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pcwd.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|WD_VER
mdefine_line|#define WD_VER                  &quot;0.50 (08/21/96)&quot;
DECL|macro|WD_MINOR
mdefine_line|#define&t;WD_MINOR&t;&t;130&t;/* Minor device number */
DECL|macro|WD_TIMEOUT
mdefine_line|#define&t;WD_TIMEOUT&t;&t;3&t;/* 1 1/2 seconds for a timeout */
DECL|macro|WD_TIMERRESET_PORT1
mdefine_line|#define WD_TIMERRESET_PORT1     0x270&t;/* Reset port - first choice */
DECL|macro|WD_TIMERRESET_PORT2
mdefine_line|#define WD_TIMERRESET_PORT2     0x370&t;/* Reset port - second choice */
DECL|macro|WD_CTLSTAT_PORT1
mdefine_line|#define WD_CTLSTAT_PORT1        0x271&t;/* Control port - first choice */
DECL|macro|WD_CTLSTAT_PORT2
mdefine_line|#define WD_CTLSTAT_PORT2        0x371&t;/* Control port - second choice */
DECL|macro|WD_PORT_EXTENT
mdefine_line|#define&t;WD_PORT_EXTENT&t;&t;2&t;/* Takes up two addresses */
DECL|macro|WD_WDRST
mdefine_line|#define WD_WDRST                0x01&t;/* Previously reset state */
DECL|macro|WD_T110
mdefine_line|#define WD_T110                 0x02&t;/* Temperature overheat sense */
DECL|macro|WD_HRTBT
mdefine_line|#define WD_HRTBT                0x04&t;/* Heartbeat sense */
DECL|macro|WD_RLY2
mdefine_line|#define WD_RLY2                 0x08&t;/* External relay triggered */
DECL|macro|WD_SRLY2
mdefine_line|#define WD_SRLY2                0x80&t;/* Software external relay triggered */
DECL|variable|current_ctlport
DECL|variable|current_readport
r_static
r_int
id|current_ctlport
comma
id|current_readport
suffix:semicolon
DECL|variable|is_open
DECL|variable|is_eof
r_static
r_int
id|is_open
comma
id|is_eof
suffix:semicolon
DECL|function|pcwd_checkcard
r_int
id|pcwd_checkcard
c_func
(paren
r_void
)paren
(brace
r_int
id|card_dat
comma
id|prev_card_dat
comma
id|found
op_assign
l_int|0
comma
id|count
op_assign
l_int|0
comma
id|done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* As suggested by Alan Cox */
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|current_ctlport
comma
id|WD_PORT_EXTENT
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcwd: Port 0x%x unavailable.&bslash;n&quot;
comma
id|current_ctlport
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|card_dat
op_assign
l_int|0x00
suffix:semicolon
id|prev_card_dat
op_assign
l_int|0x00
suffix:semicolon
id|prev_card_dat
op_assign
id|inb
c_func
(paren
id|current_readport
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OL
id|WD_TIMEOUT
)paren
(brace
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: Run #%d on port 0x%03x&bslash;n&quot;
comma
id|count
comma
id|current_readport
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Read the raw card data from the port, and strip off the&n;&t;   first 4 bits */
id|card_dat
op_assign
id|inb_p
c_func
(paren
id|current_readport
)paren
suffix:semicolon
id|card_dat
op_and_assign
l_int|0x000F
suffix:semicolon
multiline_comment|/* Sleep 1/2 second (or 500000 microseconds :) */
id|udelay
c_func
(paren
l_int|500000L
)paren
suffix:semicolon
id|done
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0x0F usually means that no card data is present, or the card&n;&t;   is not installed on this port.  If 0x0F is present here, it&squot;s&n;&t;   normally safe to assume there&squot;s no card at that base address. */
r_if
c_cond
(paren
id|card_dat
op_eq
l_int|0x0F
)paren
(brace
id|count
op_increment
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: I show nothing on this port.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* If there&squot;s a heart beat in both instances, then this means we&n;&t;   found our card.  This also means that either the card was&n;&t;   previously reset, or the computer was power-cycled. */
r_if
c_cond
(paren
(paren
id|card_dat
op_amp
id|WD_HRTBT
)paren
op_logical_and
(paren
id|prev_card_dat
op_amp
id|WD_HRTBT
)paren
op_logical_and
(paren
op_logical_neg
id|done
)paren
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
id|done
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: I show alternate heart beats.  Card detected.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
multiline_comment|/* If the card data is exactly the same as the previous card data,&n;&t;   it&squot;s safe to assume that we should check again.  The manual says&n;&t;   that the heart beat will change every second (or the bit will&n;&t;   toggle), and this can be used to see if the card is there.  If&n;&t;   the card was powered up with a cold boot, then the card will&n;&t;   not start blinking until 2.5 minutes after a reboot, so this&n;&t;   bit will stay at 1. */
r_if
c_cond
(paren
(paren
id|card_dat
op_eq
id|prev_card_dat
)paren
op_logical_and
(paren
op_logical_neg
id|done
)paren
)paren
(brace
id|count
op_increment
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: The card data is exactly the same (possibility).&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|done
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* If the card data is toggling any bits, this means that the heart&n;&t;   beat was detected, or something else about the card is set. */
r_if
c_cond
(paren
(paren
id|card_dat
op_ne
id|prev_card_dat
)paren
op_logical_and
(paren
op_logical_neg
id|done
)paren
)paren
(brace
id|done
op_assign
l_int|1
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: I show alternate heart beats.  Card detected.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
multiline_comment|/* Otherwise something else strange happened. */
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
id|count
op_increment
suffix:semicolon
)brace
r_return
(paren
id|found
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_showprevstate
r_void
id|pcwd_showprevstate
c_func
(paren
r_void
)paren
(brace
r_int
id|card_status
op_assign
l_int|0x0000
suffix:semicolon
id|card_status
op_assign
id|inb
c_func
(paren
id|current_readport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card_status
op_amp
id|WD_WDRST
)paren
id|printk
c_func
(paren
l_string|&quot;pcwd: Previous reboot was caused by the card.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card_status
op_amp
id|WD_T110
)paren
id|printk
c_func
(paren
l_string|&quot;pcwd: CPU overheat sense.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|card_status
op_amp
id|WD_WDRST
)paren
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|card_status
op_amp
id|WD_T110
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;pcwd: Cold boot sense.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|pcwd_return_data
r_static
r_int
id|pcwd_return_data
c_func
(paren
r_void
)paren
(brace
r_return
id|inb
c_func
(paren
id|current_readport
)paren
suffix:semicolon
)brace
DECL|function|pcwd_write
r_static
r_int
id|pcwd_write
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
id|wdrst_stat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_open
)paren
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: write request&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|wdrst_stat
op_assign
id|inb_p
c_func
(paren
id|current_readport
)paren
suffix:semicolon
id|wdrst_stat
op_and_assign
l_int|0x0F
suffix:semicolon
id|wdrst_stat
op_or_assign
id|WD_WDRST
suffix:semicolon
id|outb_p
c_func
(paren
id|wdrst_stat
comma
id|current_ctlport
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pcwd_ioctl
r_static
r_int
id|pcwd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|i
comma
id|cdat
comma
id|rv
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|PCWD_GETSTAT
suffix:colon
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_else
(brace
id|cdat
op_assign
id|pcwd_return_data
c_func
(paren
)paren
suffix:semicolon
id|rv
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cdat
op_amp
id|WD_WDRST
)paren
id|rv
op_or_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|cdat
op_amp
id|WD_T110
)paren
id|rv
op_or_assign
l_int|0x02
suffix:semicolon
id|put_user
c_func
(paren
id|rv
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PCWD_PING
suffix:colon
id|pcwd_write
c_func
(paren
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Is this legal? */
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_open
r_static
r_int
id|pcwd_open
c_func
(paren
r_struct
id|inode
op_star
id|ino
comma
r_struct
id|file
op_star
id|filep
)paren
(brace
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: open request&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MOD_INC_USE_COUNT
suffix:semicolon
id|is_eof
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_close
r_static
r_void
id|pcwd_close
c_func
(paren
r_struct
id|inode
op_star
id|ino
comma
r_struct
id|file
op_star
id|filep
)paren
(brace
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: close request&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|variable|pcwd_fops
r_static
r_struct
id|file_operations
id|pcwd_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* Seek */
l_int|NULL
comma
multiline_comment|/* Read */
id|pcwd_write
comma
multiline_comment|/* Write */
l_int|NULL
comma
multiline_comment|/* Readdir */
l_int|NULL
comma
multiline_comment|/* Select */
id|pcwd_ioctl
comma
multiline_comment|/* IOctl */
l_int|NULL
comma
multiline_comment|/* MMAP */
id|pcwd_open
comma
multiline_comment|/* Open */
id|pcwd_close
multiline_comment|/* Close */
)brace
suffix:semicolon
DECL|variable|pcwd_miscdev
r_static
r_struct
id|miscdevice
id|pcwd_miscdev
op_assign
(brace
id|WD_MINOR
comma
l_string|&quot;pcwatchdog&quot;
comma
op_amp
id|pcwd_fops
)brace
suffix:semicolon
macro_line|#ifdef&t;MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|pcwatchdog_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: Success.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;pcwd: v%s Ken Hollis (khollis@bitgate.com)&bslash;n&quot;
comma
id|WD_VER
)paren
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: About to perform card autosense loop.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|is_eof
op_assign
l_int|0
suffix:semicolon
id|is_open
op_assign
l_int|0
suffix:semicolon
id|current_ctlport
op_assign
id|WD_TIMERRESET_PORT1
suffix:semicolon
id|current_readport
op_assign
id|WD_CTLSTAT_PORT1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcwd_checkcard
c_func
(paren
)paren
)paren
(brace
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: Trying port 0x370.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|current_ctlport
op_assign
id|WD_TIMERRESET_PORT2
suffix:semicolon
id|current_readport
op_assign
id|WD_CTLSTAT_PORT2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcwd_checkcard
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pcwd: No card detected, or wrong port assigned.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;pcwd: Watchdog Rev.A detected at port 0x370&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;pcwd: Watchdog Rev.A detected at port 0x270&bslash;n&quot;
)paren
suffix:semicolon
id|pcwd_showprevstate
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: Requesting region entry&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|request_region
c_func
(paren
id|current_ctlport
comma
id|WD_PORT_EXTENT
comma
l_string|&quot;PCWD Rev.A (Berkshire)&quot;
)paren
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: character device creation.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|misc_register
c_func
(paren
op_amp
id|pcwd_miscdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef&t;MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|misc_deregister
c_func
(paren
op_amp
id|pcwd_miscdev
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|current_ctlport
comma
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef&t;DEBUG
id|printk
c_func
(paren
l_string|&quot;pcwd: Cleanup successful.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif
multiline_comment|/*&n;** TODO:&n;**&n;**&t;Both Revisions:&n;**&t;o) Support for revision B of the Watchdog Card&n;**&t;o) Implement the rest of the IOCTLs as discussed with Alan Cox&n;**&t;o) Implement only card heartbeat reset via IOCTL, not via write&n;**&t;o) Faster card detection routines&n;**&t;o) /proc device creation&n;**&n;**&t;Revision B functions:&n;**&t;o) /dev/temp device creation for temperature device (possibly use&n;**&t;   the one from the WDT drivers?)&n;**&t;o) Direct Motorola controller chip access via read/write routines&n;**&t;o) Autoprobe IO Ports for autodetection (possibly by chip detect?)&n;*/
eof
