multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; *      main.c  --  Linux soundcard HF FSK driver.&n; *&n; *      Copyright (C) 1997  Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *        Swiss Federal Institute of Technology (ETH), Electronics Lab&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *      This program is distributed in the hope that it will be useful,&n; *      but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *      GNU General Public License for more details.&n; *&n; *      You should have received a copy of the GNU General Public License&n; *      along with this program; if not, write to the Free Software&n; *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Command line options (insmod command line)&n; *&n; *  History:&n; *   0.1  15.04.97  Adapted from baycom.c and made network driver interface&n; *   0.2  05.07.97  All floating point stuff thrown out due to Linus&squot; rantings :)&n; *&n; */
multiline_comment|/*****************************************************************************/
macro_line|#include &lt;linux/config.h&gt; /* for CONFIG_HFMODEM_WSS and CONFIG_HFMODEM_SBC */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/hfmodem.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * currently this module is supposed to support both module styles, i.e.&n; * the old one present up to about 2.1.9, and the new one functioning&n; * starting with 2.1.21. The reason is I have a kit allowing to compile&n; * this module also under 2.0.x which was requested by several people.&n; * This will go in 2.2&n; */
macro_line|#include &lt;linux/version.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#else
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
DECL|macro|put_user
macro_line|#undef put_user
DECL|macro|get_user
macro_line|#undef get_user
DECL|macro|put_user
mdefine_line|#define put_user(x,ptr) ({ __put_user((unsigned long)(x),(ptr),sizeof(*(ptr))); 0; })
DECL|macro|get_user
mdefine_line|#define get_user(x,ptr) ({ x = ((__typeof__(*(ptr)))__get_user((ptr),sizeof(*(ptr)))); 0; })
DECL|function|copy_from_user
r_extern
r_inline
r_int
id|copy_from_user
c_func
(paren
r_void
op_star
id|to
comma
r_const
r_void
op_star
id|from
comma
r_int
r_int
id|n
)paren
(brace
r_int
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|to
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|copy_to_user
r_extern
r_inline
r_int
id|copy_to_user
c_func
(paren
r_void
op_star
id|to
comma
r_const
r_void
op_star
id|from
comma
r_int
r_int
id|n
)paren
(brace
r_int
id|i
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|to
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|memcpy_tofs
c_func
(paren
id|to
comma
id|from
comma
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20123
macro_line|#include &lt;linux/init.h&gt;
macro_line|#else
DECL|macro|__init
mdefine_line|#define __init
DECL|macro|__initdata
mdefine_line|#define __initdata
DECL|macro|__initfunc
mdefine_line|#define __initfunc(x) x
macro_line|#endif
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|hfmodem_drvname
multiline_comment|/*static*/
r_const
r_char
id|hfmodem_drvname
(braket
)braket
op_assign
l_string|&quot;hfmodem&quot;
suffix:semicolon
DECL|variable|hfmodem_drvinfo
r_static
r_const
r_char
id|hfmodem_drvinfo
(braket
)braket
op_assign
id|KERN_INFO
l_string|&quot;hfmodem: (C) 1997 Thomas Sailer, HB9JNX/AE4WA&bslash;n&quot;
id|KERN_INFO
l_string|&quot;hfmodem: version 0.2 compiled &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * currently we support only one device&n; */
DECL|variable|hfmodem_state
r_struct
id|hfmodem_state
id|hfmodem_state
(braket
id|NR_DEVICE
)braket
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/*&n; * ===================== port checking routines ========================&n; */
DECL|macro|UART_RBR
mdefine_line|#define UART_RBR(iobase) (iobase+0)
DECL|macro|UART_THR
mdefine_line|#define UART_THR(iobase) (iobase+0)
DECL|macro|UART_IER
mdefine_line|#define UART_IER(iobase) (iobase+1)
DECL|macro|UART_IIR
mdefine_line|#define UART_IIR(iobase) (iobase+2)
DECL|macro|UART_FCR
mdefine_line|#define UART_FCR(iobase) (iobase+2)
DECL|macro|UART_LCR
mdefine_line|#define UART_LCR(iobase) (iobase+3)
DECL|macro|UART_MCR
mdefine_line|#define UART_MCR(iobase) (iobase+4)
DECL|macro|UART_LSR
mdefine_line|#define UART_LSR(iobase) (iobase+5)
DECL|macro|UART_MSR
mdefine_line|#define UART_MSR(iobase) (iobase+6)
DECL|macro|UART_SCR
mdefine_line|#define UART_SCR(iobase) (iobase+7)
DECL|macro|UART_DLL
mdefine_line|#define UART_DLL(iobase) (iobase+0)
DECL|macro|UART_DLM
mdefine_line|#define UART_DLM(iobase) (iobase+1)
DECL|macro|SER_EXTENT
mdefine_line|#define SER_EXTENT 8
DECL|macro|LPT_DATA
mdefine_line|#define LPT_DATA(iobase)    (iobase+0)
DECL|macro|LPT_STATUS
mdefine_line|#define LPT_STATUS(iobase)  (iobase+1)
DECL|macro|LPT_CONTROL
mdefine_line|#define LPT_CONTROL(iobase) (iobase+2)
DECL|macro|LPT_IRQ_ENABLE
mdefine_line|#define LPT_IRQ_ENABLE      0x10
DECL|macro|MIDI_DATA
mdefine_line|#define MIDI_DATA(iobase)     (iobase)
DECL|macro|MIDI_STATUS
mdefine_line|#define MIDI_STATUS(iobase)   (iobase+1)
DECL|macro|MIDI_READ_FULL
mdefine_line|#define MIDI_READ_FULL 0x80   /* attention: negative logic!! */
DECL|macro|MIDI_WRITE_EMPTY
mdefine_line|#define MIDI_WRITE_EMPTY 0x40 /* attention: negative logic!! */
DECL|macro|MIDI_EXTENT
mdefine_line|#define MIDI_EXTENT 2
DECL|macro|SP_SER
mdefine_line|#define SP_SER  1
DECL|macro|SP_PAR
mdefine_line|#define SP_PAR  2
DECL|macro|SP_MIDI
mdefine_line|#define SP_MIDI 4
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|parptt_wakeup
r_static
r_void
id|parptt_wakeup
c_func
(paren
r_void
op_star
id|handle
)paren
(brace
r_struct
id|hfmodem_state
op_star
id|dev
op_assign
(paren
r_struct
id|hfmodem_state
op_star
)paren
id|handle
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: parptt: why am I being woken up?&bslash;n&quot;
comma
id|hfmodem_drvname
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parport_claim
c_func
(paren
id|dev-&gt;ptt_out.pardev
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: parptt: I&squot;m broken.&bslash;n&quot;
comma
id|hfmodem_drvname
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|check_lpt
c_func
(paren
r_struct
id|hfmodem_state
op_star
id|dev
comma
r_int
r_int
id|iobase
)paren
)paren
(brace
r_struct
id|parport
op_star
id|pp
op_assign
id|parport_enumerate
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pp
op_logical_and
id|pp-&gt;base
op_ne
id|iobase
)paren
id|pp
op_assign
id|pp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;ptt_out.pardev
op_assign
id|parport_register_device
c_func
(paren
id|pp
comma
id|hfmodem_drvname
comma
l_int|NULL
comma
id|parptt_wakeup
comma
l_int|NULL
comma
id|PARPORT_DEV_EXCL
comma
id|dev
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|enum|uart
DECL|enumerator|c_uart_unknown
DECL|enumerator|c_uart_8250
DECL|enumerator|c_uart_16450
DECL|enumerator|c_uart_16550
DECL|enumerator|c_uart_16550A
r_enum
id|uart
(brace
id|c_uart_unknown
comma
id|c_uart_8250
comma
id|c_uart_16450
comma
id|c_uart_16550
comma
id|c_uart_16550A
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_const
r_char
op_star
id|uart_str
(braket
)braket
id|__initdata
op_assign
(brace
l_string|&quot;unknown&quot;
comma
l_string|&quot;8250&quot;
comma
l_string|&quot;16450&quot;
comma
l_string|&quot;16550&quot;
comma
l_string|&quot;16550A&quot;
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_enum
id|uart
id|check_uart
c_func
(paren
r_int
r_int
id|iobase
)paren
)paren
(brace
r_int
r_char
id|b1
comma
id|b2
comma
id|b3
suffix:semicolon
r_enum
id|uart
id|u
suffix:semicolon
r_enum
id|uart
id|uart_tab
(braket
)braket
op_assign
(brace
id|c_uart_16450
comma
id|c_uart_unknown
comma
id|c_uart_16550
comma
id|c_uart_16550A
)brace
suffix:semicolon
r_if
c_cond
(paren
id|iobase
op_le
l_int|0
op_logical_or
id|iobase
OG
l_int|0x1000
op_minus
id|SER_EXTENT
)paren
r_return
id|c_uart_unknown
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|SER_EXTENT
)paren
)paren
r_return
id|c_uart_unknown
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|b1
op_or
l_int|0x10
comma
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* loopback mode */
id|b2
op_assign
id|inb
c_func
(paren
id|UART_MSR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x1a
comma
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b3
op_assign
id|inb
c_func
(paren
id|UART_MSR
c_func
(paren
id|iobase
)paren
)paren
op_amp
l_int|0xf0
suffix:semicolon
id|outb
c_func
(paren
id|b1
comma
id|UART_MCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* restore old values */
id|outb
c_func
(paren
id|b2
comma
id|UART_MSR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b3
op_ne
l_int|0x90
)paren
r_return
id|c_uart_unknown
suffix:semicolon
id|inb
c_func
(paren
id|UART_RBR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|inb
c_func
(paren
id|UART_RBR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
id|UART_FCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
multiline_comment|/* enable FIFOs */
id|u
op_assign
id|uart_tab
(braket
(paren
id|inb
c_func
(paren
id|UART_IIR
c_func
(paren
id|iobase
)paren
)paren
op_rshift
l_int|6
)paren
op_amp
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|u
op_eq
id|c_uart_16450
)paren
(brace
id|outb
c_func
(paren
l_int|0x5a
comma
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b1
op_assign
id|inb
c_func
(paren
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xa5
comma
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b2
op_assign
id|inb
c_func
(paren
id|UART_SCR
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b1
op_ne
l_int|0x5a
)paren
op_logical_or
(paren
id|b2
op_ne
l_int|0xa5
)paren
)paren
id|u
op_assign
id|c_uart_8250
suffix:semicolon
)brace
r_return
id|u
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_int
id|check_midi
c_func
(paren
r_int
r_int
id|iobase
)paren
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|b
suffix:semicolon
r_if
c_cond
(paren
id|iobase
op_le
l_int|0
op_logical_or
id|iobase
OG
l_int|0x1000
op_minus
id|MIDI_EXTENT
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|iobase
comma
id|MIDI_EXTENT
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|MIDI_STATUS
c_func
(paren
id|iobase
)paren
)paren
op_amp
id|MIDI_WRITE_EMPTY
)paren
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|MIDI_DATA
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|b
op_assign
id|inb
c_func
(paren
id|MIDI_STATUS
c_func
(paren
id|iobase
)paren
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|b
op_amp
id|MIDI_WRITE_EMPTY
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|MIDI_STATUS
c_func
(paren
id|iobase
)paren
)paren
op_amp
id|MIDI_WRITE_EMPTY
)paren
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|jiffies
op_minus
id|timeout
)paren
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|output_status
r_static
r_void
id|output_status
c_func
(paren
r_struct
id|hfmodem_state
op_star
id|dev
comma
r_int
id|ptt
)paren
(brace
r_int
id|dcd
op_assign
l_int|0
suffix:semicolon
id|ptt
op_assign
op_logical_neg
op_logical_neg
id|ptt
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ptt_out.flags
op_amp
id|SP_SER
)paren
(brace
id|outb
c_func
(paren
id|dcd
op_or
(paren
id|ptt
op_lshift
l_int|1
)paren
comma
id|UART_MCR
c_func
(paren
id|dev-&gt;ptt_out.seriobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x40
op_amp
(paren
op_minus
id|ptt
)paren
comma
id|UART_LCR
c_func
(paren
id|dev-&gt;ptt_out.seriobase
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;ptt_out.flags
op_amp
id|SP_PAR
)paren
(brace
id|outb
c_func
(paren
id|ptt
op_or
(paren
id|dcd
op_lshift
l_int|1
)paren
comma
id|LPT_DATA
c_func
(paren
id|dev-&gt;ptt_out.pariobase
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;ptt_out.flags
op_amp
id|SP_MIDI
op_logical_and
id|ptt
)paren
(brace
id|outb
c_func
(paren
l_int|0
comma
id|MIDI_DATA
c_func
(paren
id|dev-&gt;ptt_out.midiiobase
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_static
r_void
id|output_check
c_func
(paren
r_struct
id|hfmodem_state
op_star
id|dev
)paren
)paren
(brace
r_enum
id|uart
id|u
op_assign
id|c_uart_unknown
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|u
op_assign
id|check_uart
c_func
(paren
id|dev-&gt;ptt_out.seriobase
)paren
)paren
)paren
op_ne
id|c_uart_unknown
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PTT output: uart found at address 0x%x type %s&bslash;n&quot;
comma
id|hfmodem_drvname
comma
id|dev-&gt;ptt_out.seriobase
comma
id|uart_str
(braket
id|u
)braket
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;ptt_out.seriobase
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PTT output: no uart found at address 0x%x&bslash;n&quot;
comma
id|hfmodem_drvname
comma
id|dev-&gt;ptt_out.seriobase
)paren
suffix:semicolon
id|dev-&gt;ptt_out.seriobase
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_lpt
c_func
(paren
id|dev
comma
id|dev-&gt;ptt_out.pariobase
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PTT output: parallel port found at address 0x%x&bslash;n&quot;
comma
id|hfmodem_drvname
comma
id|dev-&gt;ptt_out.pariobase
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;ptt_out.pariobase
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PTT output: no parallel port found at address 0x%x&bslash;n&quot;
comma
id|hfmodem_drvname
comma
id|dev-&gt;ptt_out.pariobase
)paren
suffix:semicolon
id|dev-&gt;ptt_out.pariobase
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;ptt_out.pardev
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;ptt_out.midiiobase
OG
l_int|0
op_logical_and
id|dev-&gt;ptt_out.midiiobase
op_le
l_int|0x1000
op_minus
id|MIDI_EXTENT
op_logical_and
id|check_midi
c_func
(paren
id|dev-&gt;ptt_out.midiiobase
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PTT output: midi port found at address 0x%x&bslash;n&quot;
comma
id|hfmodem_drvname
comma
id|dev-&gt;ptt_out.midiiobase
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|dev-&gt;ptt_out.midiiobase
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PTT output: no midi port found at address 0x%x&bslash;n&quot;
comma
id|hfmodem_drvname
comma
id|dev-&gt;ptt_out.midiiobase
)paren
suffix:semicolon
id|dev-&gt;ptt_out.midiiobase
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|output_open
r_static
r_void
id|output_open
c_func
(paren
r_struct
id|hfmodem_state
op_star
id|dev
)paren
(brace
id|dev-&gt;ptt_out.flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ptt_out.seriobase
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|check_region
c_func
(paren
id|dev-&gt;ptt_out.seriobase
comma
id|SER_EXTENT
)paren
)paren
(brace
id|request_region
c_func
(paren
id|dev-&gt;ptt_out.seriobase
comma
id|SER_EXTENT
comma
l_string|&quot;hfmodem ser ptt&quot;
)paren
suffix:semicolon
id|dev-&gt;ptt_out.flags
op_or_assign
id|SP_SER
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|UART_IER
c_func
(paren
id|dev-&gt;ptt_out.seriobase
)paren
)paren
suffix:semicolon
multiline_comment|/* 5 bits, 1 stop, no parity, no break, Div latch access */
id|outb
c_func
(paren
l_int|0x80
comma
id|UART_LCR
c_func
(paren
id|dev-&gt;ptt_out.seriobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|UART_DLM
c_func
(paren
id|dev-&gt;ptt_out.seriobase
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|1
comma
id|UART_DLL
c_func
(paren
id|dev-&gt;ptt_out.seriobase
)paren
)paren
suffix:semicolon
multiline_comment|/* as fast as possible */
multiline_comment|/* LCR and MCR set by output_status */
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PTT output: serial port at 0x%x busy&bslash;n&quot;
comma
id|hfmodem_drvname
comma
id|dev-&gt;ptt_out.seriobase
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;ptt_out.pariobase
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|parport_claim
c_func
(paren
id|dev-&gt;ptt_out.pardev
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PTT output: parallel port at 0x%x busy&bslash;n&quot;
comma
id|hfmodem_drvname
comma
id|dev-&gt;ptt_out.pariobase
)paren
suffix:semicolon
r_else
id|dev-&gt;ptt_out.flags
op_or_assign
id|SP_PAR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;ptt_out.midiiobase
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|check_region
c_func
(paren
id|dev-&gt;ptt_out.midiiobase
comma
id|MIDI_EXTENT
)paren
)paren
(brace
id|request_region
c_func
(paren
id|dev-&gt;ptt_out.midiiobase
comma
id|MIDI_EXTENT
comma
l_string|&quot;hfmodem midi ptt&quot;
)paren
suffix:semicolon
id|dev-&gt;ptt_out.flags
op_or_assign
id|SP_MIDI
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: PTT output: midi port at 0x%x busy&bslash;n&quot;
comma
id|hfmodem_drvname
comma
id|dev-&gt;ptt_out.midiiobase
)paren
suffix:semicolon
)brace
id|output_status
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: PTT output:&quot;
comma
id|hfmodem_drvname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ptt_out.flags
op_amp
id|SP_SER
)paren
id|printk
c_func
(paren
l_string|&quot; serial interface at 0x%x&quot;
comma
id|dev-&gt;ptt_out.seriobase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ptt_out.flags
op_amp
id|SP_PAR
)paren
id|printk
c_func
(paren
l_string|&quot; parallel interface at 0x%x&quot;
comma
id|dev-&gt;ptt_out.pariobase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ptt_out.flags
op_amp
id|SP_MIDI
)paren
id|printk
c_func
(paren
l_string|&quot; mpu401 (midi) interface at 0x%x&quot;
comma
id|dev-&gt;ptt_out.midiiobase
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;ptt_out.flags
)paren
id|printk
c_func
(paren
l_string|&quot; none&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|output_close
r_static
r_void
id|output_close
c_func
(paren
r_struct
id|hfmodem_state
op_star
id|dev
)paren
(brace
multiline_comment|/* release regions used for PTT output */
id|output_status
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ptt_out.flags
op_amp
id|SP_SER
)paren
id|release_region
c_func
(paren
id|dev-&gt;ptt_out.seriobase
comma
id|SER_EXTENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ptt_out.flags
op_amp
id|SP_PAR
)paren
id|parport_release
c_func
(paren
id|dev-&gt;ptt_out.pardev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ptt_out.flags
op_amp
id|SP_MIDI
)paren
id|release_region
c_func
(paren
id|dev-&gt;ptt_out.midiiobase
comma
id|MIDI_EXTENT
)paren
suffix:semicolon
id|dev-&gt;ptt_out.flags
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|macro|INC_SAMPLE
mdefine_line|#define INC_SAMPLE   (1000000/HFMODEM_SRATE)
DECL|macro|INC_FRAGMENT
mdefine_line|#define INC_FRAGMENT (HFMODEM_FRAGSAMPLES*1000000/HFMODEM_SRATE)
DECL|macro|SIZE
mdefine_line|#define SIZE         (HFMODEM_FRAGSAMPLES*HFMODEM_NUMFRAGS)
DECL|function|hfmodem_interrupt
r_static
r_void
id|hfmodem_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|hfmodem_state
op_star
id|dev
op_assign
(paren
r_struct
id|hfmodem_state
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|dmaptr
suffix:semicolon
id|__s16
op_star
id|s
suffix:semicolon
r_int
r_int
id|curfrag
comma
id|nfrags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hfmodem_time_t
id|l1time
suffix:semicolon
id|dmaptr
op_assign
id|dev-&gt;scops
op_member_access_from_pointer
id|intack
c_func
(paren
id|dev
)paren
suffix:semicolon
id|l1time
op_assign
id|hfmodem_refclock_current
c_func
(paren
id|dev
comma
(paren
(paren
id|SIZE
op_plus
id|dmaptr
op_minus
id|dev-&gt;dma.last_dmaptr
)paren
op_mod
id|SIZE
)paren
op_star
id|INC_SAMPLE
comma
l_int|1
)paren
suffix:semicolon
id|curfrag
op_assign
(paren
id|dev-&gt;dma.last_dmaptr
op_assign
id|dmaptr
)paren
op_div
id|HFMODEM_FRAGSAMPLES
suffix:semicolon
id|l1time
op_sub_assign
id|INC_SAMPLE
op_star
(paren
id|SIZE
op_plus
id|dmaptr
op_minus
id|dev-&gt;dma.fragptr
op_star
id|HFMODEM_FRAGSAMPLES
)paren
op_mod
id|SIZE
suffix:semicolon
id|sti
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * handle receiving&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;dma.ptt_frames
op_le
l_int|0
)paren
(brace
r_while
c_loop
(paren
id|dev-&gt;dma.fragptr
op_ne
id|curfrag
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;dma.fragptr
OL
id|HFMODEM_EXCESSFRAGS
)paren
(brace
id|s
op_assign
id|dev-&gt;dma.buf
op_plus
id|SIZE
op_plus
id|HFMODEM_FRAGSAMPLES
op_star
id|dev-&gt;dma.fragptr
suffix:semicolon
id|memcpy
c_func
(paren
id|s
comma
id|s
op_minus
id|SIZE
comma
id|HFMODEM_FRAGSIZE
)paren
suffix:semicolon
)brace
r_else
id|s
op_assign
id|dev-&gt;dma.buf
op_plus
id|HFMODEM_FRAGSAMPLES
op_star
id|dev-&gt;dma.fragptr
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;sbuf.kbuf
op_logical_and
id|dev-&gt;sbuf.kptr
op_logical_and
id|dev-&gt;sbuf.rem
OG
l_int|0
)paren
(brace
id|i
op_assign
id|HFMODEM_FRAGSAMPLES
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
id|dev-&gt;sbuf.rem
)paren
id|i
op_assign
id|dev-&gt;sbuf.rem
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;sbuf.kptr
comma
id|s
comma
id|i
op_star
r_sizeof
(paren
id|s
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|dev-&gt;sbuf.rem
op_sub_assign
id|i
suffix:semicolon
id|dev-&gt;sbuf.kptr
op_add_assign
id|i
suffix:semicolon
)brace
id|hfmodem_input_samples
c_func
(paren
id|dev
comma
id|l1time
comma
id|INC_SAMPLE
comma
id|s
)paren
suffix:semicolon
id|l1time
op_add_assign
id|INC_FRAGMENT
suffix:semicolon
id|dev-&gt;dma.fragptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma.fragptr
op_ge
id|HFMODEM_NUMFRAGS
)paren
id|dev-&gt;dma.fragptr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * check for output&n;&t;&t; */
r_if
c_cond
(paren
id|hfmodem_next_tx_event
c_func
(paren
id|dev
comma
id|l1time
)paren
OG
(paren
r_int
)paren
id|INC_FRAGMENT
op_div
l_int|2
)paren
r_goto
id|int_return
suffix:semicolon
multiline_comment|/*&n;&t;&t; * start output&n;&t;&t; */
id|output_status
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|dev-&gt;scops
op_member_access_from_pointer
id|prepare_output
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;dma.last_dmaptr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * clock adjust&n;&t;&t; */
id|l1time
op_assign
id|hfmodem_refclock_current
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * fill first two fragments&n;&t;&t; */
id|dev-&gt;dma.ptt_frames
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
op_logical_and
id|i
OL
id|HFMODEM_NUMFRAGS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hfmodem_output_samples
c_func
(paren
id|dev
comma
id|l1time
op_plus
id|i
op_star
id|INC_FRAGMENT
comma
id|INC_SAMPLE
comma
id|dev-&gt;dma.buf
op_plus
id|i
op_star
id|HFMODEM_FRAGSAMPLES
)paren
)paren
id|dev-&gt;dma.ptt_frames
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|dev-&gt;dma.lastfrag
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;scops
op_member_access_from_pointer
id|trigger_output
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * finish already pending rx requests&n;&t;&t; */
id|hfmodem_finish_pending_rx_requests
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|int_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * handle transmitting&n;&t; */
id|nfrags
op_assign
id|HFMODEM_NUMFRAGS
op_plus
id|curfrag
op_minus
id|dev-&gt;dma.lastfrag
suffix:semicolon
id|dev-&gt;dma.lastfrag
op_assign
id|curfrag
suffix:semicolon
r_if
c_cond
(paren
id|nfrags
op_ge
id|HFMODEM_NUMFRAGS
)paren
id|nfrags
op_sub_assign
id|HFMODEM_NUMFRAGS
suffix:semicolon
id|dev-&gt;dma.ptt_frames
op_sub_assign
id|nfrags
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma.ptt_frames
OL
l_int|0
)paren
id|dev-&gt;dma.ptt_frames
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|dev-&gt;dma.ptt_frames
OL
id|HFMODEM_NUMFRAGS
op_logical_and
id|dev-&gt;dma.ptt_frames
OL
l_int|4
op_logical_and
id|hfmodem_output_samples
c_func
(paren
id|dev
comma
id|l1time
op_plus
id|dev-&gt;dma.ptt_frames
op_star
id|INC_FRAGMENT
comma
id|INC_SAMPLE
comma
id|dev-&gt;dma.buf
op_plus
id|HFMODEM_FRAGSAMPLES
op_star
(paren
(paren
id|curfrag
op_plus
id|dev-&gt;dma.ptt_frames
)paren
op_mod
id|HFMODEM_NUMFRAGS
)paren
)paren
)paren
id|dev-&gt;dma.ptt_frames
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dma.ptt_frames
OG
l_int|0
)paren
r_goto
id|int_return
suffix:semicolon
multiline_comment|/* &n;&t; * start receiving&n;&t; */
id|output_status
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|dev-&gt;dma.last_dmaptr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma.lastfrag
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma.fragptr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma.ptt_frames
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;scops
op_member_access_from_pointer
id|prepare_input
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;scops
op_member_access_from_pointer
id|trigger_input
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hfmodem_refclock_current
c_func
(paren
id|dev
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* needed to reset the time difference */
id|int_return
suffix:colon
id|hfmodem_wakeup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|hfmodem_close
r_static
r_int
id|hfmodem_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|hfmodem_state
op_star
id|dev
op_assign
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;active
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|dev-&gt;active
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;scops
op_member_access_from_pointer
id|stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;io.irq
comma
id|dev
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|dev-&gt;io.dma
)paren
suffix:semicolon
id|free_dma
c_func
(paren
id|dev-&gt;io.dma
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|dev-&gt;io.base_addr
comma
id|dev-&gt;scops-&gt;extent
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|dev-&gt;dma.buf
comma
id|HFMODEM_FRAGSIZE
op_star
(paren
id|HFMODEM_NUMFRAGS
op_plus
id|HFMODEM_EXCESSFRAGS
)paren
)paren
suffix:semicolon
id|hfmodem_clear_rq
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;sbuf.kbuf
)paren
(brace
id|kfree_s
c_func
(paren
id|dev-&gt;sbuf.kbuf
comma
id|dev-&gt;sbuf.size
)paren
suffix:semicolon
id|dev-&gt;sbuf.kbuf
op_assign
id|dev-&gt;sbuf.kptr
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;sbuf.size
op_assign
id|dev-&gt;sbuf.rem
op_assign
l_int|0
suffix:semicolon
)brace
id|output_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|hfmodem_open
r_static
r_int
id|hfmodem_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|hfmodem_state
op_star
id|dev
op_assign
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;active
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;scops
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/*&n;&t; * clear vars&n;&t; */
id|memset
c_func
(paren
op_amp
id|dev-&gt;l1
comma
l_int|0
comma
r_sizeof
(paren
id|dev-&gt;l1
)paren
)paren
suffix:semicolon
id|dev-&gt;dma.last_dmaptr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma.lastfrag
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma.fragptr
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;dma.ptt_frames
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * allocate memory&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;dma.buf
op_assign
id|kmalloc
c_func
(paren
id|HFMODEM_FRAGSIZE
op_star
(paren
id|HFMODEM_NUMFRAGS
op_plus
id|HFMODEM_EXCESSFRAGS
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * allocate resources&n;&t; */
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dev-&gt;io.dma
comma
id|hfmodem_drvname
)paren
)paren
(brace
id|kfree_s
c_func
(paren
id|dev-&gt;dma.buf
comma
id|HFMODEM_FRAGSIZE
op_star
(paren
id|HFMODEM_NUMFRAGS
op_plus
id|HFMODEM_EXCESSFRAGS
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;io.irq
comma
id|hfmodem_interrupt
comma
id|SA_INTERRUPT
comma
id|hfmodem_drvname
comma
id|dev
)paren
)paren
(brace
id|free_dma
c_func
(paren
id|dev-&gt;io.dma
)paren
suffix:semicolon
id|kfree_s
c_func
(paren
id|dev-&gt;dma.buf
comma
id|HFMODEM_FRAGSIZE
op_star
(paren
id|HFMODEM_NUMFRAGS
op_plus
id|HFMODEM_EXCESSFRAGS
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|request_region
c_func
(paren
id|dev-&gt;io.base_addr
comma
id|dev-&gt;scops-&gt;extent
comma
id|hfmodem_drvname
)paren
suffix:semicolon
multiline_comment|/* clear requests */
id|dev-&gt;active
op_increment
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|hfmodem_refclock_init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|output_open
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;scops
op_member_access_from_pointer
id|init
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;scops
op_member_access_from_pointer
id|prepare_input
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;scops
op_member_access_from_pointer
id|trigger_input
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|hfmodem_fops
r_static
r_struct
id|file_operations
id|hfmodem_fops
op_assign
(brace
l_int|NULL
comma
multiline_comment|/* hfmodem_seek */
l_int|NULL
comma
multiline_comment|/* hfmodem_read */
l_int|NULL
comma
multiline_comment|/* hfmodem_write */
l_int|NULL
comma
multiline_comment|/* hfmodem_readdir */
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20100
id|hfmodem_poll
comma
multiline_comment|/* hfmodem_poll */
macro_line|#else 
id|hfmodem_select
comma
multiline_comment|/* hfmodem_select */
macro_line|#endif
id|hfmodem_ioctl
comma
multiline_comment|/* hfmodem_ioctl */
l_int|NULL
comma
multiline_comment|/* hfmodem_mmap */
id|hfmodem_open
comma
multiline_comment|/* hfmodem_open */
l_int|NULL
comma
multiline_comment|/* flush */
id|hfmodem_close
comma
multiline_comment|/* hfmodem_close */
l_int|NULL
comma
multiline_comment|/* hfmodem_fsync */
l_int|NULL
comma
multiline_comment|/* hfmodem_fasync */
l_int|NULL
comma
multiline_comment|/* hfmodem_check_media_change */
l_int|NULL
multiline_comment|/* hfmodem_revalidate */
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|hfmodem_device
r_static
r_struct
id|miscdevice
id|hfmodem_device
op_assign
(brace
id|HFMODEM_MINOR
comma
id|hfmodem_drvname
comma
op_amp
id|hfmodem_fops
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#ifdef MODULE
multiline_comment|/*&n; * Command line parameters&n; */
DECL|variable|hw
r_static
r_int
id|hw
op_assign
l_int|0
suffix:semicolon
DECL|variable|iobase
r_static
r_int
r_int
id|iobase
op_assign
l_int|0x220
suffix:semicolon
DECL|variable|irq
r_static
r_int
r_int
id|irq
op_assign
l_int|7
suffix:semicolon
DECL|variable|dma
r_static
r_int
r_int
id|dma
op_assign
l_int|1
suffix:semicolon
DECL|variable|serio
r_static
r_int
r_int
id|serio
op_assign
l_int|0
suffix:semicolon
DECL|variable|pario
r_static
r_int
r_int
id|pario
op_assign
l_int|0
suffix:semicolon
DECL|variable|midiio
r_static
r_int
r_int
id|midiio
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= 0x20115
id|MODULE_PARM
c_func
(paren
id|hw
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|hw
comma
l_string|&quot;hardware type: 0=SBC, 1=WSS&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|iobase
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|iobase
comma
l_string|&quot;io base address&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;interrupt number&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dma
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dma
comma
l_string|&quot;dma number (&gt;=4 for SB16/32/64/etc, &lt;=3 for the rest)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|serio
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|serio
comma
l_string|&quot;address of serial port to output PTT&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|pario
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pario
comma
l_string|&quot;address of parial port to output PTT&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|midiio
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|midiio
comma
l_string|&quot;address of midi (MPU401) port to output PTT&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Thomas M. Sailer, sailer@ife.ee.ethz.ch, hb9jnx@hb9w.che.eu&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;HF FSK modem code&quot;
)paren
suffix:semicolon
multiline_comment|/* these are the module parameters from refclock.c */
id|MODULE_PARM
c_func
(paren
id|scale_tvusec
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|scale_tvusec
comma
"&quot;"
id|Scaling
id|value
r_for
id|the
id|tv_usec
id|field
(paren
id|can
id|be
id|obta
id|ined
id|by
id|refclock
)paren
"&quot;"
)paren
suffix:semicolon
macro_line|#ifdef __i386__
id|MODULE_PARM
c_func
(paren
id|scale_rdtsc
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|scale_rdtsc
comma
"&quot;"
id|Scaling
id|value
r_for
id|the
id|rdtsc
id|counter
(paren
id|can
id|be
id|obtai
id|ned
id|by
id|refclock
)paren
"&quot;"
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|rdtsc_ok
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|rdtsc_ok
comma
"&quot;"
id|Set
id|to
l_int|0
id|to
id|disable
id|the
id|use
id|of
id|the
id|rdtsc
id|instruction
"&quot;"
)paren
suffix:semicolon
macro_line|#endif /* __i386__ */
macro_line|#endif
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|init_module
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|hfmodem_drvinfo
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hfmodem_state
comma
l_int|0
comma
r_sizeof
(paren
id|hfmodem_state
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hfmodem_correlator_cache
comma
l_int|0
comma
r_sizeof
(paren
id|hfmodem_correlator_cache
)paren
)paren
suffix:semicolon
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|io.base_addr
op_assign
id|iobase
suffix:semicolon
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|io.irq
op_assign
id|irq
suffix:semicolon
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|io.dma
op_assign
id|dma
suffix:semicolon
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|ptt_out.seriobase
op_assign
id|serio
suffix:semicolon
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|ptt_out.pariobase
op_assign
id|pario
suffix:semicolon
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|ptt_out.midiiobase
op_assign
id|midiio
suffix:semicolon
id|hfmodem_refclock_probe
c_func
(paren
)paren
suffix:semicolon
id|output_check
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_HFMODEM_WSS) &amp;&amp; defined(CONFIG_HFMODEM_SBC)
r_if
c_cond
(paren
id|hw
)paren
id|i
op_assign
id|hfmodem_wssprobe
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|i
op_assign
id|hfmodem_sbcprobe
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#else
id|i
op_assign
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef CONFIG_HFMODEM_WSS
id|i
op_assign
id|hfmodem_wssprobe
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_HFMODEM_SBC
id|i
op_assign
id|hfmodem_sbcprobe
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|misc_register
c_func
(paren
op_amp
id|hfmodem_device
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: cannot register misc device&bslash;n&quot;
comma
id|hfmodem_drvname
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|hfmodem_state
op_star
id|dev
op_assign
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ptt_out.pariobase
OG
l_int|0
)paren
id|parport_unregister_device
c_func
(paren
id|dev-&gt;ptt_out.pardev
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|hfmodem_device
)paren
suffix:semicolon
)brace
macro_line|#else /* MODULE */
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|hw
r_static
r_int
id|hw
op_assign
l_int|0
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|hfmodem_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
(brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OL
l_int|7
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: setup: too few parameters&bslash;n&quot;
comma
id|hfmodem_drvname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|hfmodem_state
comma
l_int|0
comma
r_sizeof
(paren
id|hfmodem_state
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hfmodem_correlator_cache
comma
l_int|0
comma
r_sizeof
(paren
id|hfmodem_correlator_cache
)paren
)paren
suffix:semicolon
id|hw
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|io.base_addr
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|io.irq
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|io.dma
op_assign
id|ints
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|8
)paren
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|ptt_out.seriobase
op_assign
id|ints
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|9
)paren
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|ptt_out.pariobase
op_assign
id|ints
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|10
)paren
id|hfmodem_state
(braket
l_int|0
)braket
dot
id|ptt_out.midiiobase
op_assign
id|ints
(braket
l_int|7
)braket
suffix:semicolon
id|hfmodem_refclock_setscale
c_func
(paren
id|ints
(braket
id|ints
(braket
l_int|0
)braket
op_minus
l_int|2
)braket
comma
id|ints
(braket
id|ints
(braket
l_int|0
)braket
op_minus
l_int|1
)braket
comma
id|ints
(braket
id|ints
(braket
l_int|0
)braket
)braket
)paren
suffix:semicolon
)brace
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|hfmodem_init
c_func
(paren
r_void
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|hfmodem_drvinfo
)paren
suffix:semicolon
id|hfmodem_refclock_probe
c_func
(paren
)paren
suffix:semicolon
id|output_check
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_HFMODEM_WSS) &amp;&amp; defined(CONFIG_HFMODEM_SBC)
r_if
c_cond
(paren
id|hw
)paren
id|i
op_assign
id|hfmodem_wssprobe
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|i
op_assign
id|hfmodem_sbcprobe
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#else
id|i
op_assign
op_minus
id|EINVAL
suffix:semicolon
macro_line|#ifdef CONFIG_HFMODEM_WSS
id|i
op_assign
id|hfmodem_wssprobe
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_HFMODEM_SBC
id|i
op_assign
id|hfmodem_sbcprobe
c_func
(paren
op_amp
id|hfmodem_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
id|i
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: soundcard probe failed&bslash;n&quot;
comma
id|hfmodem_drvname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_assign
id|misc_register
c_func
(paren
op_amp
id|hfmodem_device
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: cannot register misc device&bslash;n&quot;
comma
id|hfmodem_drvname
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
macro_line|#endif /* MODULE */
eof
