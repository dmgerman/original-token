multiline_comment|/*&n; * joystick.c  Version 1.2&n; *&n; * Copyright (c) 1996-1998 Vojtech Pavlik&n; */
multiline_comment|/*&n; * This is the main joystick driver for Linux. It doesn&squot;t support any&n; * devices directly, rather is lets you use sub-modules to do that job. See&n; * Documentation/joystick.txt for more info.&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or &n; * (at your option) any later version.&n; * &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; * &n; * Should you need to contact me, the author, you can do so either by&n; * e-mail - mail your message to &lt;vojtech@ucw.cz&gt;, or by paper mail:&n; * Vojtech Pavlik, Ucitelska 1576, Prague 8, 182 00 Czech Republic&n; */
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/joystick.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#endif
multiline_comment|/*&n; * Configurable parameters.&n; */
DECL|macro|JS_REFRESH_TIME
mdefine_line|#define JS_REFRESH_TIME&t;&t;HZ/50&t;/* Time between two reads of joysticks (20ms) */
multiline_comment|/*&n; * Buffer macros.&n; */
DECL|macro|ROT
mdefine_line|#define ROT(A,B,C)&t;((((A)&lt;(C))&amp;&amp;(((B)&gt;(A))&amp;&amp;((B)&lt;(C))))||(((A)&gt;(C))&amp;&amp;(((B)&gt;(A))||((B)&lt;(C)))))
DECL|macro|GOF
mdefine_line|#define GOF(X)&t;&t;(((X)==JS_BUFF_SIZE-1)?0:(X)+1)
DECL|macro|GOB
mdefine_line|#define GOB(X)&t;&t;((X)?(X)-1:JS_BUFF_SIZE-1)
DECL|macro|DIFF
mdefine_line|#define DIFF(X,Y)&t;((X)&gt;(Y)?(X)-(Y):(Y)-(X))
multiline_comment|/*&n; * Global variables.&n; */
DECL|variable|js_comp_glue
r_static
r_struct
id|JS_DATA_SAVE_TYPE
id|js_comp_glue
suffix:semicolon
DECL|variable|js_port
r_static
r_struct
id|js_port
op_star
id|js_port
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|js_dev
r_static
r_struct
id|js_dev
op_star
id|js_dev
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|js_timer
r_static
r_struct
id|timer_list
id|js_timer
suffix:semicolon
DECL|variable|js_lock
id|spinlock_t
id|js_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|js_use_count
r_static
r_int
id|js_use_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Exported variables.&n; */
DECL|variable|js_time_speed
r_int
r_int
id|js_time_speed
op_assign
l_int|0
suffix:semicolon
DECL|variable|js_get_time
id|js_time_func
id|js_get_time
suffix:semicolon
DECL|variable|js_delta
id|js_delta_func
id|js_delta
suffix:semicolon
DECL|variable|js_time_speed_a
r_int
r_int
id|js_time_speed_a
op_assign
l_int|0
suffix:semicolon
DECL|variable|js_get_time_a
id|js_time_func
id|js_get_time_a
suffix:semicolon
DECL|variable|js_delta_a
id|js_delta_func
id|js_delta_a
suffix:semicolon
multiline_comment|/*&n; * Module info.&n; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Vojtech Pavlik &lt;vojtech@ucw.cz&gt;&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;js&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * js_get_time_*() are different functions to get current time.&n; * js_delta_*() are functions to compute time difference.&n; */
macro_line|#ifdef __i386__
DECL|function|js_get_time_rdtsc
r_static
r_int
r_int
id|js_get_time_rdtsc
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|x
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;rdtsc&quot;
suffix:colon
l_string|&quot;=A&quot;
(paren
id|x
)paren
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
DECL|function|js_get_time_pit
r_static
r_int
r_int
id|js_get_time_pit
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|x
suffix:semicolon
id|__save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
l_int|0x43
)paren
suffix:semicolon
id|x
op_assign
id|inb
c_func
(paren
l_int|0x40
)paren
suffix:semicolon
id|x
op_or_assign
id|inb
c_func
(paren
l_int|0x40
)paren
op_lshift
l_int|8
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
DECL|function|js_delta_pit
r_static
r_int
id|js_delta_pit
c_func
(paren
r_int
r_int
id|x
comma
r_int
r_int
id|y
)paren
(brace
r_return
id|y
op_minus
id|x
op_plus
(paren
id|y
OL
id|x
ques
c_cond
l_int|1193180L
op_div
id|HZ
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|js_get_time_counter
r_static
r_int
r_int
id|js_get_time_counter
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|time_counter
op_assign
l_int|0
suffix:semicolon
r_return
id|time_counter
op_increment
suffix:semicolon
)brace
macro_line|#else
macro_line|#ifdef __alpha__
DECL|function|js_get_time_rpcc
r_static
r_int
r_int
id|js_get_time_rpcc
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|x
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;rpcc %0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|x
)paren
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
macro_line|#else
macro_line|#ifndef MODULE
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
DECL|function|js_get_time_system
r_static
r_int
r_int
id|js_get_time_system
c_func
(paren
r_void
)paren
(brace
r_static
r_struct
id|timeval
id|js_tv
suffix:semicolon
id|get_fast_time
c_func
(paren
op_amp
id|js_tv
)paren
suffix:semicolon
r_return
id|js_tv.tv_sec
op_star
l_int|1000000L
op_plus
id|js_tv.tv_usec
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
macro_line|#endif
macro_line|#endif
DECL|function|js_delta_normal
r_static
r_int
id|js_delta_normal
c_func
(paren
r_int
r_int
id|x
comma
r_int
r_int
id|y
)paren
(brace
r_return
id|x
op_minus
id|y
suffix:semicolon
)brace
multiline_comment|/*&n; * js_calibrate_time() calibrates a given timer.&n; */
DECL|function|js_calibrate_time
r_static
r_int
id|__init
id|js_calibrate_time
c_func
(paren
id|js_time_func
id|get_time
comma
id|js_delta_func
id|delta
)paren
(brace
r_int
r_int
id|t1
comma
id|t2
comma
id|t3
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
id|t1
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|t2
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|t3
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|delta
c_func
(paren
id|t2
comma
id|t1
)paren
op_minus
id|delta
c_func
(paren
id|t3
comma
id|t2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * js_calibrate_time_counter() calibrates the counter timer, which can&squot;t&n; * be calibrated using the above function.&n; */
macro_line|#ifdef __i386__
DECL|function|js_calibrate_time_counter
r_static
r_int
id|__init
id|js_calibrate_time_counter
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|i
comma
id|j
comma
id|t1
comma
id|t2
comma
id|t3
suffix:semicolon
id|j
op_assign
id|jiffies
suffix:semicolon
r_do
(brace
id|inb
c_func
(paren
l_int|0x201
)paren
suffix:semicolon
id|t1
op_assign
id|js_get_time_counter
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|j
op_eq
id|jiffies
)paren
suffix:semicolon
id|j
op_assign
id|jiffies
suffix:semicolon
r_do
(brace
id|inb
c_func
(paren
l_int|0x201
)paren
suffix:semicolon
id|t2
op_assign
id|js_get_time_counter
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|j
op_eq
id|jiffies
)paren
suffix:semicolon
id|j
op_assign
(paren
id|t2
op_minus
id|t1
)paren
op_star
id|HZ
op_div
l_int|1000
suffix:semicolon
id|t1
op_assign
id|js_get_time_pit
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|inb
c_func
(paren
l_int|0x201
)paren
suffix:semicolon
id|js_get_time_counter
c_func
(paren
)paren
suffix:semicolon
)brace
id|t2
op_assign
id|js_get_time_pit
c_func
(paren
)paren
suffix:semicolon
id|t3
op_assign
id|js_get_time_pit
c_func
(paren
)paren
suffix:semicolon
id|i
op_assign
l_int|1193180L
op_div
(paren
id|js_delta_pit
c_func
(paren
id|t2
comma
id|t1
)paren
op_minus
id|js_delta_pit
c_func
(paren
id|t3
comma
id|t2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DIFF
c_func
(paren
id|i
comma
id|j
)paren
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;js: Counter timer calibration unsure,&quot;
l_string|&quot; pass1 (0.%d MHz) and pass2 (0.%d MHz) differ.&bslash;n&quot;
comma
id|j
comma
id|i
)paren
suffix:semicolon
r_return
(paren
id|i
op_plus
id|j
)paren
op_rshift
l_int|1
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * js_setup_time chooses the best available timers&n; * on the system and calibrates them.&n; */
DECL|function|js_setup_time
r_static
r_int
id|__init
id|js_setup_time
c_func
(paren
r_void
)paren
(brace
r_int
id|t
suffix:semicolon
r_char
op_star
id|name
comma
op_star
id|name_a
suffix:semicolon
id|name
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|name_a
op_assign
l_string|&quot;&quot;
suffix:semicolon
id|js_time_speed
op_assign
l_int|0
suffix:semicolon
id|js_time_speed_a
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef __i386__
id|t
op_assign
id|js_calibrate_time
c_func
(paren
id|js_get_time_pit
comma
id|js_delta_pit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DIFF
c_func
(paren
id|t
comma
l_int|1193
)paren
OG
l_int|5
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;js: Measured PIT speed is %d.%03d MHz, but should be 1.193 MHz.&bslash;n&quot;
id|KERN_WARNING
l_string|&quot;js: This is probably caused by wrong BogoMIPS value. It is: %ld, should be: %ld.&bslash;n&quot;
comma
id|t
op_div
l_int|1000
comma
id|t
op_mod
l_int|1000
comma
id|loops_per_sec
op_div
l_int|500000
comma
id|loops_per_sec
op_div
(paren
id|t
op_star
l_int|500000
op_div
l_int|1193
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|JS_HAS_RDTSC
op_logical_and
(paren
id|t
op_assign
id|js_calibrate_time
c_func
(paren
id|js_get_time_rdtsc
comma
id|js_delta_normal
)paren
)paren
OG
l_int|0
)paren
(brace
id|js_time_speed_a
op_assign
id|t
suffix:semicolon
id|js_get_time_a
op_assign
id|js_get_time_rdtsc
suffix:semicolon
id|js_delta_a
op_assign
id|js_delta_normal
suffix:semicolon
id|js_time_speed
op_assign
id|t
suffix:semicolon
id|js_get_time
op_assign
id|js_get_time_rdtsc
suffix:semicolon
id|js_delta
op_assign
id|js_delta_normal
suffix:semicolon
id|name
op_assign
l_string|&quot;RDTSC&quot;
suffix:semicolon
)brace
r_else
(brace
id|js_time_speed_a
op_assign
id|t
suffix:semicolon
id|js_get_time_a
op_assign
id|js_get_time_pit
suffix:semicolon
id|js_delta_a
op_assign
id|js_delta_pit
suffix:semicolon
id|name_a
op_assign
l_string|&quot;PIT&quot;
suffix:semicolon
id|t
op_assign
id|js_calibrate_time_counter
c_func
(paren
)paren
suffix:semicolon
id|js_time_speed
op_assign
id|t
suffix:semicolon
id|js_get_time
op_assign
id|js_get_time_counter
suffix:semicolon
id|js_delta
op_assign
id|js_delta_normal
suffix:semicolon
id|name
op_assign
l_string|&quot;counter&quot;
suffix:semicolon
)brace
macro_line|#else
macro_line|#ifdef __alpha__
id|t
op_assign
id|js_calibrate_time
c_func
(paren
id|js_get_time_rpcc
comma
id|js_delta_normal
)paren
suffix:semicolon
id|js_time_speed_a
op_assign
id|t
suffix:semicolon
id|js_get_time_a
op_assign
id|js_get_time_rpcc
suffix:semicolon
id|js_delta_a
op_assign
id|js_delta_normal
suffix:semicolon
id|js_time_speed
op_assign
id|t
suffix:semicolon
id|js_get_time
op_assign
id|js_get_time_rpcc
suffix:semicolon
id|js_delta
op_assign
id|js_delta_normal
suffix:semicolon
id|name
op_assign
l_string|&quot;RPCC&quot;
suffix:semicolon
macro_line|#else
macro_line|#ifndef MODULE
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
id|t
op_assign
id|js_calibrate_time
c_func
(paren
id|js_get_time_system
comma
id|js_delta_normal
)paren
suffix:semicolon
id|js_time_speed_a
op_assign
id|t
suffix:semicolon
id|js_get_time_a
op_assign
id|js_get_time_system
suffix:semicolon
id|js_delta_a
op_assign
id|js_delta_normal
suffix:semicolon
id|js_time_speed
op_assign
id|t
suffix:semicolon
id|js_get_time
op_assign
id|js_get_time_system
suffix:semicolon
id|js_delta
op_assign
id|js_delta_normal
suffix:semicolon
id|name
op_assign
l_string|&quot;system&quot;
suffix:semicolon
macro_line|#endif
macro_line|#endif
macro_line|#endif
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;js: Version %d.%d.%d &quot;
comma
id|JS_VERSION
op_rshift
l_int|16
op_amp
l_int|0xff
comma
id|JS_VERSION
op_rshift
l_int|8
op_amp
l_int|0xff
comma
id|JS_VERSION
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|js_time_speed_a
op_le
l_int|0
op_logical_or
id|js_time_speed
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;using &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|js_time_speed
OG
l_int|10000
)paren
(brace
id|t
op_assign
id|js_time_speed
op_div
l_int|1000
op_plus
(paren
id|js_time_speed
op_mod
l_int|1000
op_ge
l_int|500
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d MHz &quot;
comma
id|t
)paren
suffix:semicolon
)brace
r_else
(brace
id|t
op_assign
id|js_time_speed
op_div
l_int|10
op_plus
(paren
id|js_time_speed
op_mod
l_int|10
op_ge
l_int|5
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d.%02d MHz &quot;
comma
id|t
op_div
l_int|100
comma
id|t
op_mod
l_int|100
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|js_get_time_a
op_ne
id|js_get_time
)paren
(brace
id|t
op_assign
id|js_time_speed_a
op_div
l_int|10
op_plus
(paren
id|js_time_speed_a
op_mod
l_int|10
op_ge
l_int|5
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s timer and %d.%02d MHz %s timer.&bslash;n&quot;
comma
id|name
comma
id|t
op_div
l_int|100
comma
id|t
op_mod
l_int|100
comma
id|name_a
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s timer.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * js_correct() performs correction of raw joystick data.&n; */
DECL|function|js_correct
r_static
r_int
id|js_correct
c_func
(paren
r_int
id|value
comma
r_struct
id|js_corr
op_star
id|corr
)paren
(brace
r_switch
c_cond
(paren
id|corr-&gt;type
)paren
(brace
r_case
id|JS_CORR_NONE
suffix:colon
r_break
suffix:semicolon
r_case
id|JS_CORR_BROKEN
suffix:colon
id|value
op_assign
id|value
OG
id|corr-&gt;coef
(braket
l_int|0
)braket
ques
c_cond
(paren
id|value
OL
id|corr-&gt;coef
(braket
l_int|1
)braket
ques
c_cond
l_int|0
suffix:colon
(paren
(paren
id|corr-&gt;coef
(braket
l_int|3
)braket
op_star
(paren
id|value
op_minus
id|corr-&gt;coef
(braket
l_int|1
)braket
)paren
)paren
op_rshift
l_int|14
)paren
)paren
suffix:colon
(paren
(paren
id|corr-&gt;coef
(braket
l_int|2
)braket
op_star
(paren
id|value
op_minus
id|corr-&gt;coef
(braket
l_int|0
)braket
)paren
)paren
op_rshift
l_int|14
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
OL
op_minus
l_int|32767
)paren
r_return
op_minus
l_int|32767
suffix:semicolon
r_if
c_cond
(paren
id|value
OG
l_int|32767
)paren
r_return
l_int|32767
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/*&n; * js_button() returns value of button number i.&n; */
DECL|function|js_button
r_static
r_inline
r_int
id|js_button
c_func
(paren
r_int
op_star
id|buttons
comma
r_int
id|i
)paren
(brace
r_return
(paren
id|buttons
(braket
id|i
op_rshift
l_int|5
)braket
op_rshift
(paren
id|i
op_amp
l_int|0x1f
)paren
)paren
op_amp
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * js_add_event() adds an event to the buffer. This requires additional&n; * queue post-processing done by js_sync_buff.&n; */
DECL|function|js_add_event
r_static
r_void
id|js_add_event
c_func
(paren
r_struct
id|js_dev
op_star
id|jd
comma
id|__u32
id|time
comma
id|__u8
id|type
comma
id|__u8
id|number
comma
id|__s16
id|value
)paren
(brace
id|jd-&gt;buff
(braket
id|jd-&gt;ahead
)braket
dot
id|time
op_assign
id|time
suffix:semicolon
id|jd-&gt;buff
(braket
id|jd-&gt;ahead
)braket
dot
id|type
op_assign
id|type
suffix:semicolon
id|jd-&gt;buff
(braket
id|jd-&gt;ahead
)braket
dot
id|number
op_assign
id|number
suffix:semicolon
id|jd-&gt;buff
(braket
id|jd-&gt;ahead
)braket
dot
id|value
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|jd-&gt;ahead
op_eq
id|JS_BUFF_SIZE
)paren
id|jd-&gt;ahead
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * js_flush_data() does the same as js_process_data, except for that it doesn&squot;t&n; * generate any events - it just copies the data from new to cur.&n; */
DECL|function|js_flush_data
r_static
r_void
id|js_flush_data
c_func
(paren
r_struct
id|js_dev
op_star
id|jd
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
(paren
id|jd-&gt;num_buttons
op_minus
l_int|1
)paren
op_rshift
l_int|5
)paren
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|jd-&gt;cur.buttons
(braket
id|i
)braket
op_assign
id|jd
op_member_access_from_pointer
r_new
dot
id|buttons
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|jd-&gt;num_axes
suffix:semicolon
id|i
op_increment
)paren
id|jd-&gt;cur.axes
(braket
id|i
)braket
op_assign
id|jd
op_member_access_from_pointer
r_new
dot
id|axes
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; * js_process_data() finds changes in button states and axis positions and adds&n; * them as events to the buffer.&n; */
DECL|function|js_process_data
r_static
r_void
id|js_process_data
c_func
(paren
r_struct
id|js_dev
op_star
id|jd
)paren
(brace
r_int
id|i
comma
id|t
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|jd-&gt;num_buttons
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|t
op_assign
id|js_button
c_func
(paren
id|jd
op_member_access_from_pointer
r_new
dot
id|buttons
comma
id|i
)paren
)paren
op_ne
id|js_button
c_func
(paren
id|jd-&gt;cur.buttons
comma
id|i
)paren
)paren
(brace
id|js_add_event
c_func
(paren
id|jd
comma
id|jiffies
comma
id|JS_EVENT_BUTTON
comma
id|i
comma
id|t
)paren
suffix:semicolon
id|jd-&gt;cur.buttons
(braket
id|i
op_rshift
l_int|5
)braket
op_xor_assign
(paren
l_int|1
op_lshift
(paren
id|i
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|jd-&gt;num_axes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|t
op_assign
id|js_correct
c_func
(paren
id|jd
op_member_access_from_pointer
r_new
dot
id|axes
(braket
id|i
)braket
comma
op_amp
id|jd-&gt;corr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|jd-&gt;corr
(braket
id|i
)braket
dot
id|prec
op_eq
op_minus
l_int|1
)paren
op_logical_and
id|t
)paren
op_logical_or
(paren
(paren
id|DIFF
c_func
(paren
id|jd
op_member_access_from_pointer
r_new
dot
id|axes
(braket
id|i
)braket
comma
id|jd-&gt;cur.axes
(braket
id|i
)braket
)paren
OG
id|jd-&gt;corr
(braket
id|i
)braket
dot
id|prec
)paren
op_logical_and
(paren
id|t
op_ne
id|js_correct
c_func
(paren
id|jd-&gt;cur.axes
(braket
id|i
)braket
comma
op_amp
id|jd-&gt;corr
(braket
id|i
)braket
)paren
)paren
)paren
)paren
(brace
id|js_add_event
c_func
(paren
id|jd
comma
id|jiffies
comma
id|JS_EVENT_AXIS
comma
id|i
comma
id|t
)paren
suffix:semicolon
id|jd-&gt;cur.axes
(braket
id|i
)braket
op_assign
id|jd
op_member_access_from_pointer
r_new
dot
id|axes
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * js_sync_buff() checks for all overflows caused by recent additions to the buffer.&n; * These happen only if some process is reading the data too slowly. It&n; * wakes up any process waiting for data.&n; */
DECL|function|js_sync_buff
r_static
r_void
id|js_sync_buff
c_func
(paren
r_struct
id|js_dev
op_star
id|jd
)paren
(brace
r_struct
id|js_list
op_star
id|curl
op_assign
id|jd-&gt;list
suffix:semicolon
r_if
c_cond
(paren
id|jd-&gt;bhead
op_ne
id|jd-&gt;ahead
)paren
(brace
r_if
c_cond
(paren
id|ROT
c_func
(paren
id|jd-&gt;bhead
comma
id|jd-&gt;tail
comma
id|jd-&gt;ahead
)paren
op_logical_or
(paren
id|jd-&gt;tail
op_eq
id|jd-&gt;bhead
)paren
)paren
(brace
r_while
c_loop
(paren
id|curl
)paren
(brace
r_if
c_cond
(paren
id|ROT
c_func
(paren
id|jd-&gt;bhead
comma
id|curl-&gt;tail
comma
id|jd-&gt;ahead
)paren
op_logical_or
(paren
id|curl-&gt;tail
op_eq
id|jd-&gt;bhead
)paren
)paren
(brace
id|curl-&gt;tail
op_assign
id|jd-&gt;ahead
suffix:semicolon
id|curl-&gt;startup
op_assign
l_int|0
suffix:semicolon
)brace
id|curl
op_assign
id|curl-&gt;next
suffix:semicolon
)brace
id|jd-&gt;tail
op_assign
id|jd-&gt;ahead
suffix:semicolon
)brace
id|jd-&gt;bhead
op_assign
id|jd-&gt;ahead
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|jd-&gt;wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * js_do_timer() acts as an interrupt replacement. It reads the data&n; * from all ports and then generates events for all devices.&n; */
DECL|function|js_do_timer
r_static
r_void
id|js_do_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|js_port
op_star
id|curp
op_assign
id|js_port
suffix:semicolon
r_struct
id|js_dev
op_star
id|curd
op_assign
id|js_dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_while
c_loop
(paren
id|curp
op_ne
l_int|NULL
)paren
(brace
id|curp
op_member_access_from_pointer
id|read
c_func
(paren
id|curp-&gt;info
comma
id|curp-&gt;axes
comma
id|curp-&gt;buttons
)paren
suffix:semicolon
id|curp
op_assign
id|curp-&gt;next
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|curd
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|data
)paren
(brace
id|js_process_data
c_func
(paren
id|curd
)paren
suffix:semicolon
id|js_sync_buff
c_func
(paren
id|curd
)paren
suffix:semicolon
)brace
r_else
(brace
id|js_flush_data
c_func
(paren
id|curd
)paren
suffix:semicolon
)brace
id|curd
op_assign
id|curd-&gt;next
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
id|js_timer.expires
op_assign
id|jiffies
op_plus
id|JS_REFRESH_TIME
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|js_timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * js_read() copies one or more entries from jsd[].buff to user&n; * space.&n; */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
DECL|function|js_read
r_static
id|ssize_t
id|js_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
macro_line|#else
r_static
r_int
id|js_read
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
macro_line|#endif
(brace
r_struct
id|wait_queue
id|wait
op_assign
(brace
id|current
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|js_event
op_star
id|buff
op_assign
(paren
r_void
op_star
)paren
id|buf
suffix:semicolon
r_struct
id|js_list
op_star
id|curl
suffix:semicolon
r_struct
id|js_dev
op_star
id|jd
suffix:semicolon
r_int
r_int
id|blocks
op_assign
id|count
op_div
r_sizeof
(paren
r_struct
id|js_event
)paren
suffix:semicolon
r_int
id|written
op_assign
l_int|0
suffix:semicolon
r_int
id|new_tail
comma
id|orig_tail
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|curl
op_assign
id|file-&gt;private_data
suffix:semicolon
id|jd
op_assign
id|curl-&gt;dev
suffix:semicolon
id|orig_tail
op_assign
id|curl-&gt;tail
suffix:semicolon
multiline_comment|/*&n; * Check user data.&n; */
r_if
c_cond
(paren
op_logical_neg
id|blocks
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n; * Lock it.&n; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n; * Handle (non)blocking i/o.&n; */
r_if
c_cond
(paren
id|count
op_ne
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
(brace
r_if
c_cond
(paren
id|GOF
c_func
(paren
id|curl-&gt;tail
)paren
op_eq
id|jd-&gt;bhead
op_logical_and
id|curl-&gt;startup
op_eq
id|jd-&gt;num_axes
op_plus
id|jd-&gt;num_buttons
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|jd-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_while
c_loop
(paren
id|GOF
c_func
(paren
id|curl-&gt;tail
)paren
op_eq
id|jd-&gt;bhead
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|jd-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retval
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Initial state.&n; */
r_while
c_loop
(paren
id|curl-&gt;startup
OL
id|jd-&gt;num_axes
op_plus
id|jd-&gt;num_buttons
op_logical_and
id|written
OL
id|blocks
op_logical_and
op_logical_neg
id|retval
)paren
(brace
r_struct
id|js_event
id|tmpevent
suffix:semicolon
r_if
c_cond
(paren
id|curl-&gt;startup
OL
id|jd-&gt;num_buttons
)paren
(brace
id|tmpevent.type
op_assign
id|JS_EVENT_BUTTON
op_or
id|JS_EVENT_INIT
suffix:semicolon
id|tmpevent.value
op_assign
id|js_button
c_func
(paren
id|jd-&gt;cur.buttons
comma
id|curl-&gt;startup
)paren
suffix:semicolon
id|tmpevent.number
op_assign
id|curl-&gt;startup
suffix:semicolon
)brace
r_else
(brace
id|tmpevent.type
op_assign
id|JS_EVENT_AXIS
op_or
id|JS_EVENT_INIT
suffix:semicolon
id|tmpevent.value
op_assign
id|js_correct
c_func
(paren
id|jd-&gt;cur.axes
(braket
id|curl-&gt;startup
op_minus
id|jd-&gt;num_buttons
)braket
comma
op_amp
id|jd-&gt;corr
(braket
id|curl-&gt;startup
op_minus
id|jd-&gt;num_buttons
)braket
)paren
suffix:semicolon
id|tmpevent.number
op_assign
id|curl-&gt;startup
op_minus
id|jd-&gt;num_buttons
suffix:semicolon
)brace
id|tmpevent.time
op_assign
id|jiffies
op_star
(paren
l_int|1000
op_div
id|HZ
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|buff
(braket
id|written
)braket
comma
op_amp
id|tmpevent
comma
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
(paren
id|retval
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
op_amp
id|buff
(braket
id|written
)braket
comma
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
)paren
)paren
id|memcpy_tofs
c_func
(paren
op_amp
id|buff
(braket
id|written
)braket
comma
op_amp
id|tmpevent
comma
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
suffix:semicolon
macro_line|#endif
id|curl-&gt;startup
op_increment
suffix:semicolon
id|written
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * Buffer data.&n; */
r_while
c_loop
(paren
(paren
id|jd-&gt;bhead
op_ne
(paren
id|new_tail
op_assign
id|GOF
c_func
(paren
id|curl-&gt;tail
)paren
)paren
)paren
op_logical_and
(paren
id|written
OL
id|blocks
)paren
op_logical_and
op_logical_neg
id|retval
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|buff
(braket
id|written
)braket
comma
op_amp
id|jd-&gt;buff
(braket
id|new_tail
)braket
comma
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
(paren
id|__u32
)paren
(paren
id|jd-&gt;buff
(braket
id|new_tail
)braket
dot
id|time
op_star
(paren
l_int|1000
op_div
id|HZ
)paren
)paren
comma
op_amp
id|buff
(braket
id|written
)braket
dot
id|time
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
(paren
id|retval
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
op_amp
id|buff
(braket
id|written
)braket
comma
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
)paren
)paren
(brace
id|memcpy_tofs
c_func
(paren
op_amp
id|buff
(braket
id|written
)braket
comma
op_amp
id|jd-&gt;buff
(braket
id|new_tail
)braket
comma
r_sizeof
(paren
r_struct
id|js_event
)paren
)paren
suffix:semicolon
id|put_user
c_func
(paren
(paren
id|__u32
)paren
(paren
id|jd-&gt;buff
(braket
id|new_tail
)braket
dot
id|time
op_star
(paren
l_int|1000
op_div
id|HZ
)paren
)paren
comma
op_amp
id|buff
(braket
id|written
)braket
dot
id|time
)paren
suffix:semicolon
)brace
macro_line|#endif
id|curl-&gt;tail
op_assign
id|new_tail
suffix:semicolon
id|written
op_increment
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/*&n; * Handle version 0.x compatibility.&n; */
(brace
r_struct
id|JS_DATA_TYPE
id|data
suffix:semicolon
id|data.buttons
op_assign
id|jd
op_member_access_from_pointer
r_new
dot
id|buttons
(braket
l_int|0
)braket
suffix:semicolon
id|data.x
op_assign
id|jd-&gt;num_axes
OL
l_int|1
ques
c_cond
l_int|0
suffix:colon
(paren
(paren
id|js_correct
c_func
(paren
id|jd
op_member_access_from_pointer
r_new
dot
id|axes
(braket
l_int|0
)braket
comma
op_amp
id|jd-&gt;corr
(braket
l_int|0
)braket
)paren
op_div
l_int|256
)paren
op_plus
l_int|128
)paren
op_rshift
id|js_comp_glue.JS_CORR.x
suffix:semicolon
id|data.y
op_assign
id|jd-&gt;num_axes
OL
l_int|2
ques
c_cond
l_int|0
suffix:colon
(paren
(paren
id|js_correct
c_func
(paren
id|jd
op_member_access_from_pointer
r_new
dot
id|axes
(braket
l_int|1
)braket
comma
op_amp
id|jd-&gt;corr
(braket
l_int|1
)braket
)paren
op_div
l_int|256
)paren
op_plus
l_int|128
)paren
op_rshift
id|js_comp_glue.JS_CORR.y
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
id|retval
op_assign
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|data
comma
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
(paren
id|retval
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|buf
comma
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
)paren
)paren
(brace
id|memcpy_tofs
c_func
(paren
id|buf
comma
op_amp
id|data
comma
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|curl-&gt;startup
op_assign
l_int|0
suffix:semicolon
id|curl-&gt;tail
op_assign
id|GOB
c_func
(paren
id|jd-&gt;bhead
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|retval
op_assign
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Check main tail and move it.&n; */
r_if
c_cond
(paren
id|orig_tail
op_eq
id|jd-&gt;tail
)paren
(brace
id|new_tail
op_assign
id|curl-&gt;tail
suffix:semicolon
id|curl
op_assign
id|jd-&gt;list
suffix:semicolon
r_while
c_loop
(paren
id|curl
op_ne
l_int|NULL
op_logical_and
id|curl-&gt;tail
op_ne
id|jd-&gt;tail
)paren
(brace
r_if
c_cond
(paren
id|ROT
c_func
(paren
id|jd-&gt;bhead
comma
id|new_tail
comma
id|curl-&gt;tail
)paren
op_logical_or
(paren
id|jd-&gt;bhead
op_eq
id|curl-&gt;tail
)paren
)paren
id|new_tail
op_assign
id|curl-&gt;tail
suffix:semicolon
id|curl
op_assign
id|curl-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curl
op_eq
l_int|NULL
)paren
id|jd-&gt;tail
op_assign
id|new_tail
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
ques
c_cond
id|retval
suffix:colon
id|written
op_star
r_sizeof
(paren
r_struct
id|js_event
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * js_poll() does select() support.&n; */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
DECL|function|js_poll
r_static
r_int
r_int
id|js_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|js_list
op_star
id|curl
op_assign
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|curl-&gt;dev-&gt;wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|GOF
c_func
(paren
id|curl-&gt;tail
)paren
op_ne
id|curl-&gt;dev-&gt;bhead
op_logical_or
id|curl-&gt;startup
OL
id|curl-&gt;dev-&gt;num_axes
op_plus
id|curl-&gt;dev-&gt;num_buttons
)paren
id|retval
op_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
macro_line|#else
DECL|function|js_select
r_static
r_int
id|js_select
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
(brace
r_struct
id|js_list
op_star
id|curl
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|sel_type
op_eq
id|SEL_IN
)paren
(brace
r_if
c_cond
(paren
id|GOF
c_func
(paren
id|curl-&gt;tail
)paren
op_ne
id|curl-&gt;dev-&gt;bhead
)paren
r_return
l_int|1
suffix:semicolon
id|select_wait
c_func
(paren
op_amp
id|curl-&gt;dev-&gt;wait
comma
id|wait
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * js_ioctl handles misc ioctl calls.&n; */
DECL|function|js_ioctl
r_static
r_int
id|js_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|js_list
op_star
id|curl
suffix:semicolon
r_struct
id|js_dev
op_star
id|jd
suffix:semicolon
r_int
id|len
suffix:semicolon
id|curl
op_assign
id|file-&gt;private_data
suffix:semicolon
id|jd
op_assign
id|curl-&gt;dev
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/*&n; * 0.x compatibility&n; */
r_case
id|JS_SET_CAL
suffix:colon
r_return
id|copy_from_user
c_func
(paren
op_amp
id|js_comp_glue.JS_CORR
comma
(paren
r_struct
id|JS_DATA_TYPE
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|JS_GET_CAL
suffix:colon
r_return
id|copy_to_user
c_func
(paren
(paren
r_struct
id|JS_DATA_TYPE
op_star
)paren
id|arg
comma
op_amp
id|js_comp_glue.JS_CORR
comma
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|JS_SET_TIMEOUT
suffix:colon
r_return
id|get_user
c_func
(paren
id|js_comp_glue.JS_TIMEOUT
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|JS_GET_TIMEOUT
suffix:colon
r_return
id|put_user
c_func
(paren
id|js_comp_glue.JS_TIMEOUT
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|JS_SET_TIMELIMIT
suffix:colon
r_return
id|get_user
c_func
(paren
id|js_comp_glue.JS_TIMELIMIT
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|JS_GET_TIMELIMIT
suffix:colon
r_return
id|put_user
c_func
(paren
id|js_comp_glue.JS_TIMELIMIT
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|JS_SET_ALL
suffix:colon
r_return
id|copy_from_user
c_func
(paren
op_amp
id|js_comp_glue
comma
(paren
r_struct
id|JS_DATA_SAVE_TYPE
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|JS_DATA_SAVE_TYPE
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|JS_GET_ALL
suffix:colon
r_return
id|copy_to_user
c_func
(paren
(paren
r_struct
id|JS_DATA_SAVE_TYPE
op_star
)paren
id|arg
comma
op_amp
id|js_comp_glue
comma
r_sizeof
(paren
r_struct
id|JS_DATA_SAVE_TYPE
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/*&n; * 1.x ioctl calls&n; */
r_case
id|JSIOCGVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|JS_VERSION
comma
(paren
id|__u32
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|JSIOCGAXES
suffix:colon
r_return
id|put_user
c_func
(paren
id|jd-&gt;num_axes
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|JSIOCGBUTTONS
suffix:colon
r_return
id|put_user
c_func
(paren
id|jd-&gt;num_buttons
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|JSIOCSCORR
suffix:colon
r_return
id|copy_from_user
c_func
(paren
id|jd-&gt;corr
comma
(paren
r_struct
id|js_corr
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|js_corr
)paren
op_star
id|jd-&gt;num_axes
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|JSIOCGCORR
suffix:colon
r_return
id|copy_to_user
c_func
(paren
(paren
r_struct
id|js_corr
op_star
)paren
id|arg
comma
id|jd-&gt;corr
comma
r_sizeof
(paren
r_struct
id|js_corr
)paren
op_star
id|jd-&gt;num_axes
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
(paren
id|cmd
op_amp
op_complement
(paren
id|_IOC_SIZEMASK
op_lshift
id|_IOC_SIZESHIFT
)paren
)paren
op_eq
id|JSIOCGNAME
c_func
(paren
l_int|0
)paren
)paren
(brace
id|len
op_assign
id|strlen
c_func
(paren
id|jd-&gt;name
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
)paren
id|len
op_assign
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|jd-&gt;name
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
)brace
macro_line|#else
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/*&n; * 0.x compatibility&n; */
r_case
id|JS_SET_CAL
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_struct
id|JS_DATA_TYPE
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|js_comp_glue.JS_CORR
comma
(paren
r_struct
id|JS_DATA_SAVE_TYPE
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JS_GET_CAL
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_struct
id|JS_DATA_TYPE
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_struct
id|JS_DATA_SAVE_TYPE
op_star
)paren
id|arg
comma
op_amp
id|js_comp_glue.JS_CORR
comma
r_sizeof
(paren
r_struct
id|JS_DATA_TYPE
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JS_SET_TIMEOUT
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|js_comp_glue.JS_TIMEOUT
op_assign
id|get_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JS_GET_TIMEOUT
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|put_user
c_func
(paren
id|js_comp_glue.JS_TIMEOUT
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JS_SET_TIMELIMIT
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|js_comp_glue.JS_TIMELIMIT
op_assign
id|get_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JS_GET_TIMELIMIT
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|put_user
c_func
(paren
id|js_comp_glue.JS_TIMELIMIT
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JS_SET_ALL
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_struct
id|JS_DATA_SAVE_TYPE
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|JS_DATA_SAVE_TYPE
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
op_amp
id|js_comp_glue
comma
(paren
r_struct
id|JS_DATA_SAVE_TYPE
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|JS_DATA_SAVE_TYPE
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JS_GET_ALL
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_struct
id|JS_DATA_SAVE_TYPE
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|JS_DATA_SAVE_TYPE
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_struct
id|JS_DATA_SAVE_TYPE
op_star
)paren
id|arg
comma
op_amp
id|js_comp_glue
comma
r_sizeof
(paren
r_struct
id|JS_DATA_SAVE_TYPE
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n; * 1.x ioctl calls&n; */
r_case
id|JSIOCGVERSION
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
id|__u32
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|__u32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|put_user
c_func
(paren
id|JS_VERSION
comma
(paren
id|__u32
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JSIOCGAXES
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
id|__u8
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|__u8
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|put_user
c_func
(paren
id|jd-&gt;num_axes
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JSIOCGBUTTONS
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
id|__u8
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|__u8
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|put_user
c_func
(paren
id|jd-&gt;num_buttons
comma
(paren
id|__u8
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JSIOCSCORR
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_struct
id|js_corr
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|js_corr
)paren
op_star
id|jd-&gt;num_axes
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_fromfs
c_func
(paren
id|jd-&gt;corr
comma
(paren
r_struct
id|js_corr
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|js_corr
)paren
op_star
id|jd-&gt;num_axes
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|JSIOCGCORR
suffix:colon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_struct
id|js_corr
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|js_corr
)paren
op_star
id|jd-&gt;num_axes
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_struct
id|js_corr
op_star
)paren
id|arg
comma
id|jd-&gt;corr
comma
r_sizeof
(paren
r_struct
id|js_corr
)paren
op_star
id|jd-&gt;num_axes
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
(paren
id|cmd
op_amp
op_complement
(paren
id|_IOC_SIZEMASK
op_lshift
id|_IOC_SIZESHIFT
)paren
)paren
op_eq
id|JSIOCGNAME
c_func
(paren
l_int|0
)paren
)paren
(brace
id|len
op_assign
id|strlen
c_func
(paren
id|jd-&gt;name
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_char
op_star
)paren
id|arg
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
)paren
id|len
op_assign
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|memcpy_tofs
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|jd-&gt;name
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
)brace
macro_line|#endif
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * js_open() performs necessary initialization and adds&n; * an entry to the linked list.&n; */
DECL|function|js_open
r_static
r_int
id|js_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|js_list
op_star
id|curl
comma
op_star
r_new
suffix:semicolon
r_struct
id|js_dev
op_star
id|jd
op_assign
id|js_dev
suffix:semicolon
r_int
id|i
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ne
id|JOYSTICK_MAJOR
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
OG
l_int|0
op_logical_and
id|jd
op_ne
l_int|NULL
)paren
(brace
id|jd
op_assign
id|jd-&gt;next
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jd
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|jd
op_member_access_from_pointer
id|open
c_func
(paren
id|jd
)paren
)paren
)paren
r_return
id|result
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|js_use_count
op_increment
)paren
id|js_do_timer
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_new
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|js_list
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
id|curl
op_assign
id|jd-&gt;list
suffix:semicolon
id|jd-&gt;list
op_assign
r_new
suffix:semicolon
id|jd-&gt;list-&gt;next
op_assign
id|curl
suffix:semicolon
id|jd-&gt;list-&gt;dev
op_assign
id|jd
suffix:semicolon
id|jd-&gt;list-&gt;startup
op_assign
l_int|0
suffix:semicolon
id|jd-&gt;list-&gt;tail
op_assign
id|GOB
c_func
(paren
id|jd-&gt;bhead
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|jd-&gt;list
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * js_release() removes an entry from list and deallocates memory&n; * used by it.&n; */
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
DECL|function|js_release
r_static
r_int
id|js_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
macro_line|#else
r_static
r_void
id|js_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
macro_line|#endif
(brace
r_struct
id|js_list
op_star
id|curl
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|js_dev
op_star
id|jd
op_assign
id|curl-&gt;dev
suffix:semicolon
r_struct
id|js_list
op_star
op_star
id|curp
op_assign
op_amp
id|jd-&gt;list
suffix:semicolon
r_int
id|new_tail
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|curp
op_logical_and
(paren
op_star
id|curp
op_ne
id|curl
)paren
)paren
id|curp
op_assign
op_amp
(paren
(paren
op_star
id|curp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|curp
op_assign
(paren
op_star
id|curp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_if
c_cond
(paren
id|jd-&gt;list
op_ne
l_int|NULL
)paren
r_if
c_cond
(paren
id|curl-&gt;tail
op_eq
id|jd-&gt;tail
)paren
(brace
id|curl
op_assign
id|jd-&gt;list
suffix:semicolon
id|new_tail
op_assign
id|curl-&gt;tail
suffix:semicolon
r_while
c_loop
(paren
id|curl
op_ne
l_int|NULL
op_logical_and
id|curl-&gt;tail
op_ne
id|jd-&gt;tail
)paren
(brace
r_if
c_cond
(paren
id|ROT
c_func
(paren
id|jd-&gt;bhead
comma
id|new_tail
comma
id|curl-&gt;tail
)paren
op_logical_or
(paren
id|jd-&gt;bhead
op_eq
id|curl-&gt;tail
)paren
)paren
id|new_tail
op_assign
id|curl-&gt;tail
suffix:semicolon
id|curl
op_assign
id|curl-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|curl
)paren
id|jd-&gt;tail
op_assign
id|new_tail
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|file-&gt;private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|js_use_count
)paren
id|del_timer
c_func
(paren
op_amp
id|js_timer
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|jd
op_member_access_from_pointer
id|close
c_func
(paren
id|jd
)paren
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * js_dump_mem() dumps all data structures in memory.&n; * It&squot;s used for debugging only.&n; */
macro_line|#if 0
r_static
r_void
id|js_dump_mem
c_func
(paren
r_void
)paren
(brace
r_struct
id|js_port
op_star
id|curp
op_assign
id|js_port
suffix:semicolon
r_struct
id|js_dev
op_star
id|curd
op_assign
id|js_dev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;,--- Dumping Devices:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;| js_dev = %x&bslash;n&quot;
comma
(paren
r_int
)paren
id|js_dev
)paren
suffix:semicolon
r_while
c_loop
(paren
id|curd
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|  %s-device %x, next %x axes %d, buttons %d, port %x - %#x&bslash;n&quot;
comma
id|curd-&gt;next
ques
c_cond
l_string|&quot;|&quot;
suffix:colon
l_string|&quot;`&quot;
comma
(paren
r_int
)paren
id|curd
comma
(paren
r_int
)paren
id|curd-&gt;next
comma
id|curd-&gt;num_axes
comma
id|curd-&gt;num_buttons
comma
(paren
r_int
)paren
id|curd-&gt;port
comma
id|curd-&gt;port-&gt;io
)paren
suffix:semicolon
id|curd
op_assign
id|curd-&gt;next
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&gt;--- Dumping ports:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;| js_port = %x&bslash;n&quot;
comma
(paren
r_int
)paren
id|js_port
)paren
suffix:semicolon
r_while
c_loop
(paren
id|curp
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;|  %s-port %x, next %x, io %#x, devices %d&bslash;n&quot;
comma
id|curp-&gt;next
ques
c_cond
l_string|&quot;|&quot;
suffix:colon
l_string|&quot;`&quot;
comma
(paren
r_int
)paren
id|curp
comma
(paren
r_int
)paren
id|curp-&gt;next
comma
id|curp-&gt;io
comma
id|curp-&gt;ndevs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|curp-&gt;ndevs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|curd
op_assign
id|curp-&gt;devs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|curd
)paren
id|printk
c_func
(paren
l_string|&quot;|  %s %s-device %x, next %x axes %d, buttons %d, port %x&bslash;n&quot;
comma
id|curp-&gt;next
ques
c_cond
l_string|&quot;|&quot;
suffix:colon
l_string|&quot; &quot;
comma
(paren
id|i
OL
id|curp-&gt;ndevs
op_minus
l_int|1
)paren
ques
c_cond
l_string|&quot;|&quot;
suffix:colon
l_string|&quot;`&quot;
comma
(paren
r_int
)paren
id|curd
comma
(paren
r_int
)paren
id|curd-&gt;next
comma
id|curd-&gt;num_axes
comma
id|curd-&gt;num_buttons
comma
(paren
r_int
)paren
id|curd-&gt;port
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;|  %s %s-device %x, not there&bslash;n&quot;
comma
id|curp-&gt;next
ques
c_cond
l_string|&quot;|&quot;
suffix:colon
l_string|&quot; &quot;
comma
(paren
id|i
OL
id|curp-&gt;ndevs
op_minus
l_int|1
)paren
ques
c_cond
l_string|&quot;|&quot;
suffix:colon
l_string|&quot;`&quot;
comma
(paren
r_int
)paren
id|curd
)paren
suffix:semicolon
)brace
id|curp
op_assign
id|curp-&gt;next
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;`--- Done&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|js_register_port
r_struct
id|js_port
op_star
id|js_register_port
c_func
(paren
r_struct
id|js_port
op_star
id|port
comma
r_void
op_star
id|info
comma
r_int
id|devs
comma
r_int
id|infos
comma
id|js_read_func
id|read
)paren
(brace
r_struct
id|js_port
op_star
op_star
id|ptrp
op_assign
op_amp
id|js_port
suffix:semicolon
r_struct
id|js_port
op_star
id|curp
suffix:semicolon
r_void
op_star
id|all
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|all
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|js_port
)paren
op_plus
l_int|4
op_star
id|devs
op_star
r_sizeof
(paren
r_void
op_star
)paren
op_plus
id|infos
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|curp
op_assign
id|all
suffix:semicolon
id|curp-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|curp-&gt;prev
op_assign
id|port
suffix:semicolon
id|curp-&gt;read
op_assign
id|read
suffix:semicolon
id|curp-&gt;ndevs
op_assign
id|devs
suffix:semicolon
id|curp-&gt;devs
op_assign
id|all
op_add_assign
r_sizeof
(paren
r_struct
id|js_port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devs
suffix:semicolon
id|i
op_increment
)paren
id|curp-&gt;devs
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|curp-&gt;axes
op_assign
id|all
op_add_assign
id|devs
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|curp-&gt;buttons
op_assign
(paren
r_void
op_star
)paren
id|all
op_add_assign
id|devs
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|curp-&gt;corr
op_assign
id|all
op_add_assign
id|devs
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|infos
)paren
(brace
id|curp-&gt;info
op_assign
id|all
op_add_assign
id|devs
op_star
r_sizeof
(paren
r_void
op_star
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|curp-&gt;info
comma
id|info
comma
id|infos
)paren
suffix:semicolon
)brace
r_else
(brace
id|curp-&gt;info
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|ptrp
op_ne
l_int|NULL
)paren
id|ptrp
op_assign
op_amp
(paren
(paren
op_star
id|ptrp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|ptrp
op_assign
id|curp
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|curp
suffix:semicolon
)brace
DECL|function|js_unregister_port
r_struct
id|js_port
op_star
id|js_unregister_port
c_func
(paren
r_struct
id|js_port
op_star
id|port
)paren
(brace
r_struct
id|js_port
op_star
op_star
id|curp
op_assign
op_amp
id|js_port
suffix:semicolon
r_struct
id|js_port
op_star
id|prev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|curp
op_ne
l_int|NULL
op_logical_and
(paren
op_star
id|curp
op_ne
id|port
)paren
)paren
id|curp
op_assign
op_amp
(paren
(paren
op_star
id|curp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|curp
op_assign
(paren
op_star
id|curp
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
id|prev
op_assign
id|port-&gt;prev
suffix:semicolon
id|kfree
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
id|prev
suffix:semicolon
)brace
DECL|function|js_register_device
r_int
id|js_register_device
c_func
(paren
r_struct
id|js_port
op_star
id|port
comma
r_int
id|number
comma
r_int
id|axes
comma
r_int
id|buttons
comma
r_char
op_star
id|name
comma
id|js_ops_func
id|open
comma
id|js_ops_func
id|close
)paren
(brace
r_struct
id|js_dev
op_star
op_star
id|ptrd
op_assign
op_amp
id|js_dev
suffix:semicolon
r_struct
id|js_dev
op_star
id|curd
suffix:semicolon
r_void
op_star
id|all
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|all
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|js_dev
)paren
op_plus
l_int|2
op_star
id|axes
op_star
r_sizeof
(paren
r_int
)paren
op_plus
l_int|2
op_star
(paren
(paren
(paren
id|buttons
op_minus
l_int|1
)paren
op_rshift
l_int|5
)paren
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_int
)paren
op_plus
id|axes
op_star
r_sizeof
(paren
r_struct
id|js_corr
)paren
op_plus
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|curd
op_assign
id|all
suffix:semicolon
id|curd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|curd-&gt;list
op_assign
l_int|NULL
suffix:semicolon
id|curd-&gt;port
op_assign
id|port
suffix:semicolon
id|curd-&gt;wait
op_assign
l_int|NULL
suffix:semicolon
id|curd-&gt;open
op_assign
id|open
suffix:semicolon
id|curd-&gt;close
op_assign
id|close
suffix:semicolon
id|curd-&gt;ahead
op_assign
l_int|0
suffix:semicolon
id|curd-&gt;bhead
op_assign
l_int|0
suffix:semicolon
id|curd-&gt;tail
op_assign
id|JS_BUFF_SIZE
op_minus
l_int|1
suffix:semicolon
id|curd-&gt;num_axes
op_assign
id|axes
suffix:semicolon
id|curd-&gt;num_buttons
op_assign
id|buttons
suffix:semicolon
id|curd-&gt;cur.axes
op_assign
id|all
op_add_assign
r_sizeof
(paren
r_struct
id|js_dev
)paren
suffix:semicolon
id|curd-&gt;cur.buttons
op_assign
id|all
op_add_assign
id|axes
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|curd
op_member_access_from_pointer
r_new
dot
id|axes
op_assign
id|all
op_add_assign
(paren
(paren
(paren
id|buttons
op_minus
l_int|1
)paren
op_rshift
l_int|5
)paren
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|curd
op_member_access_from_pointer
r_new
dot
id|buttons
op_assign
id|all
op_add_assign
id|axes
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|curd-&gt;corr
op_assign
id|all
op_add_assign
(paren
(paren
(paren
id|buttons
op_minus
l_int|1
)paren
op_rshift
l_int|5
)paren
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|curd-&gt;name
op_assign
id|all
op_add_assign
id|axes
op_star
r_sizeof
(paren
r_struct
id|js_corr
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|curd-&gt;name
comma
id|name
)paren
suffix:semicolon
id|port-&gt;devs
(braket
id|number
)braket
op_assign
id|curd
suffix:semicolon
id|port-&gt;axes
(braket
id|number
)braket
op_assign
id|curd
op_member_access_from_pointer
r_new
dot
id|axes
suffix:semicolon
id|port-&gt;buttons
(braket
id|number
)braket
op_assign
id|curd
op_member_access_from_pointer
r_new
dot
id|buttons
suffix:semicolon
id|port-&gt;corr
(braket
id|number
)braket
op_assign
id|curd-&gt;corr
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|ptrd
op_ne
l_int|NULL
)paren
(brace
id|ptrd
op_assign
op_amp
(paren
op_star
id|ptrd
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
op_star
id|ptrd
op_assign
id|curd
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|js_unregister_device
r_void
id|js_unregister_device
c_func
(paren
r_struct
id|js_dev
op_star
id|dev
)paren
(brace
r_struct
id|js_dev
op_star
op_star
id|curd
op_assign
op_amp
id|js_dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|curd
op_ne
l_int|NULL
op_logical_and
(paren
op_star
id|curd
op_ne
id|dev
)paren
)paren
id|curd
op_assign
op_amp
(paren
(paren
op_star
id|curd
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
op_star
id|curd
op_assign
(paren
op_star
id|curd
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|js_lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The operations structure.&n; */
DECL|variable|js_fops
r_static
r_struct
id|file_operations
id|js_fops
op_assign
(brace
id|read
suffix:colon
id|js_read
comma
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,1,0)
id|poll
suffix:colon
id|js_poll
comma
macro_line|#else
id|select
suffix:colon
id|js_select
comma
macro_line|#endif
id|ioctl
suffix:colon
id|js_ioctl
comma
id|open
suffix:colon
id|js_open
comma
id|release
suffix:colon
id|js_release
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * js_init() registers the driver and calls the probe function.&n; * also initializes some crucial variables.&n; */
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
r_int
id|__init
id|js_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
r_int
id|result
suffix:semicolon
id|js_setup_time
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|JOYSTICK_MAJOR
comma
l_string|&quot;js&quot;
comma
op_amp
id|js_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;js: unable to get major %d for joystick&bslash;n&quot;
comma
id|JOYSTICK_MAJOR
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|js_lock
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|js_timer
)paren
suffix:semicolon
id|js_timer.function
op_assign
id|js_do_timer
suffix:semicolon
id|js_timer.data
op_assign
l_int|1
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|js_comp_glue
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|JS_DATA_SAVE_TYPE
)paren
)paren
suffix:semicolon
id|js_comp_glue.JS_TIMEOUT
op_assign
id|JS_DEF_TIMEOUT
suffix:semicolon
id|js_comp_glue.JS_TIMELIMIT
op_assign
id|JS_DEF_TIMELIMIT
suffix:semicolon
macro_line|#ifdef MODULE
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#else
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifdef CONFIG_JOY_LIGHTNING
r_if
c_cond
(paren
op_logical_neg
id|js_l4_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_JOY_SIDEWINDER
r_if
c_cond
(paren
op_logical_neg
id|js_sw_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_JOY_ASSASIN
r_if
c_cond
(paren
op_logical_neg
id|js_as_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_JOY_LOGITECH
r_if
c_cond
(paren
op_logical_neg
id|js_lt_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_JOY_THRUSTMASTER
r_if
c_cond
(paren
op_logical_neg
id|js_tm_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_JOY_GRAVIS
r_if
c_cond
(paren
op_logical_neg
id|js_gr_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_JOY_ANALOG
r_if
c_cond
(paren
op_logical_neg
id|js_an_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_JOY_CONSOLE
r_if
c_cond
(paren
op_logical_neg
id|js_console_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_JOY_DB9
r_if
c_cond
(paren
op_logical_neg
id|js_db9_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_JOY_AMIGA
r_if
c_cond
(paren
op_logical_neg
id|js_am_init
c_func
(paren
)paren
)paren
id|result
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|result
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;js: no joysticks found&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * cleanup_module() handles module removal.&n; */
macro_line|#ifdef MODULE
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|js_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unregister_chrdev
c_func
(paren
id|JOYSTICK_MAJOR
comma
l_string|&quot;js&quot;
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;js: can&squot;t unregister device&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
