multiline_comment|/*&n; *  joydump.c  Version 1.2&n; *&n; *  Copyright (c) 1996-1998 Vojtech Pavlik&n; */
multiline_comment|/*&n; * This is just a very simple driver that can dump the data&n; * out of the joystick port into the syslog ...&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or &n; * (at your option) any later version.&n; * &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; * &n; * Should you need to contact me, the author, you can do so either by&n; * e-mail - mail your message to &lt;vojtech@ucw.cz&gt;, or by paper mail:&n; * Vojtech Pavlik, Ucitelska 1576, Prague 8, 182 00 Czech Republic&n; */
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/joystick.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Vojtech Pavlik &lt;vojtech@ucw.cz&gt;&quot;
)paren
suffix:semicolon
DECL|macro|JS_PORT
mdefine_line|#define JS_PORT 0x201
macro_line|#ifdef __i386__
DECL|function|get_time
r_static
r_int
r_int
id|get_time
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|x
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;rdtsc&quot;
suffix:colon
l_string|&quot;=A&quot;
(paren
id|x
)paren
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
macro_line|#else
macro_line|#ifdef&t;__alpha__
DECL|function|get_time
r_static
r_int
r_int
id|get_time
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|x
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;rpcc %0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|x
)paren
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
macro_line|#else
macro_line|#error &quot;Sorry, you need a precise timer for this - define some in joydump.c&quot;
macro_line|#endif
macro_line|#endif
DECL|macro|BUF_SIZE
mdefine_line|#define BUF_SIZE 128
DECL|struct|datatype
r_struct
id|datatype
(brace
DECL|member|time
r_int
r_int
id|time
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|buf
r_static
r_struct
id|datatype
id|buf
(braket
id|BUF_SIZE
)braket
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|t
comma
id|t1
suffix:semicolon
r_int
id|timeout
comma
id|div
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|u
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;joydump: ,------------------- START ------------------.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Calibrate.&n; */
id|__save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
id|t
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|t1
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|timeout
op_assign
id|t1
op_minus
id|t
suffix:semicolon
id|div
op_assign
id|timeout
op_div
l_int|1000
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;joydump: | Timer ticks at %d.%02d MHz.                 |&bslash;n&quot;
comma
id|timeout
op_div
l_int|1000
comma
id|timeout
op_div
l_int|10
op_mod
l_int|100
)paren
suffix:semicolon
id|__save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
id|t
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|t1
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;joydump: | I/O at %#x takes %d.%02d us.                |&bslash;n&quot;
comma
id|JS_PORT
comma
(paren
id|t1
op_minus
id|t
)paren
op_div
id|div
op_div
l_int|10
comma
(paren
id|t1
op_minus
id|t
)paren
op_star
l_int|10
op_div
id|div
op_mod
l_int|100
)paren
suffix:semicolon
id|timeout
op_mul_assign
l_int|20
suffix:semicolon
multiline_comment|/*&n; * Gather data.&n; */
id|__save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|__cli
c_func
(paren
)paren
suffix:semicolon
id|u
op_assign
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
id|t
op_assign
id|t1
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
dot
id|data
op_assign
id|u
suffix:semicolon
id|buf
(braket
l_int|0
)braket
dot
id|time
op_assign
id|t1
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|u
comma
id|JS_PORT
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|BUF_SIZE
op_logical_and
id|t1
op_minus
id|t
OL
id|timeout
)paren
(brace
id|t1
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|buf
(braket
id|i
)braket
dot
id|data
op_assign
id|inb
c_func
(paren
id|JS_PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
id|i
)braket
dot
id|data
op_ne
id|u
)paren
(brace
id|u
op_assign
id|buf
(braket
id|i
)braket
dot
id|data
suffix:semicolon
id|buf
(braket
id|i
)braket
dot
id|time
op_assign
id|t1
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
)brace
id|__restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n; * Dump data.&n; */
id|t
op_assign
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;joydump: &gt;------------------- DATA -------------------&lt;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;joydump: | index: %3d delta: %3d.%02d us data: &quot;
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|7
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
id|printk
c_func
(paren
l_string|&quot;%d&quot;
comma
(paren
id|buf
(braket
l_int|0
)braket
dot
id|data
op_rshift
id|j
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; |&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|t
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;joydump: | index: %3d delta: %3d.%02d us data: &quot;
comma
id|i
comma
(paren
id|buf
(braket
id|i
)braket
dot
id|time
op_minus
id|buf
(braket
id|i
op_minus
l_int|1
)braket
dot
id|time
)paren
op_div
id|div
comma
(paren
id|buf
(braket
id|i
)braket
dot
id|time
op_minus
id|buf
(braket
id|i
op_minus
l_int|1
)braket
dot
id|time
)paren
op_star
l_int|100
op_div
id|div
op_mod
l_int|100
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|7
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
id|printk
c_func
(paren
l_string|&quot;%d&quot;
comma
(paren
id|buf
(braket
id|i
)braket
dot
id|data
op_rshift
id|j
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; |&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;joydump: `-------------------- END -------------------&squot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
)brace
eof
