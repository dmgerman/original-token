multiline_comment|/* sunmouse.c: Sun mouse driver for the Sparc&n; *&n; * Copyright (C) 1995 David S. Miller (davem@caip.rutgers.edu)&n; * Copyright (C) 1995 Miguel de Icaza (miguel@nuclecu.unam.mx)&n; *&n; * Parts based on the psaux.c driver written by:&n; * Johan Myreen.&n; *&n; * Dec/19/95 Added SunOS mouse ioctls - miguel.&n; * Jan/5/96  Added VUID support, sigio support - miguel.&n; * Mar/5/96  Added proper mouse stream support - miguel.&n; */
multiline_comment|/* The mouse is run off of one of the Zilog serial ports.  On&n; * that port is the mouse and the keyboard, each gets a zs channel.&n; * The mouse itself is mouse-systems in nature.  So the protocol is:&n; *&n; * Byte 1) Button state which is bit-encoded as&n; *            0x4 == left-button down, else up&n; *            0x2 == middle-button down, else up&n; *            0x1 == right-button down, else up&n; *&n; * Byte 2) Delta-x&n; * Byte 3) Delta-y&n; * Byte 4) Delta-x again&n; * Byte 5) Delta-y again&n; *&n; * One day this driver will have to support more than one mouse in the system.&n; *&n; * This driver has two modes of operation: the default VUID_NATIVE is&n; * set when the device is opened and allows the application to see the&n; * mouse character stream as we get it from the serial (for gpm for&n; * example).  The second method, VUID_FIRM_EVENT will provide cooked&n; * events in Firm_event records.&n; * */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/vuid_event.h&gt;
macro_line|#include &lt;linux/random.h&gt;
multiline_comment|/* The following keeps track of software state for the Sun&n; * mouse.&n; */
DECL|macro|STREAM_SIZE
mdefine_line|#define STREAM_SIZE   2048
DECL|macro|EV_SIZE
mdefine_line|#define EV_SIZE       (STREAM_SIZE/sizeof (Firm_event))
DECL|macro|BUTTON_LEFT
mdefine_line|#define BUTTON_LEFT   4
DECL|macro|BUTTON_MIDDLE
mdefine_line|#define BUTTON_MIDDLE 2
DECL|macro|BUTTON_RIGHT
mdefine_line|#define BUTTON_RIGHT  1
DECL|struct|sun_mouse
r_struct
id|sun_mouse
(brace
DECL|member|transaction
r_int
r_char
id|transaction
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* Each protocol transaction */
DECL|member|byte
r_int
r_char
id|byte
suffix:semicolon
multiline_comment|/* Counter, starts at 0 */
DECL|member|button_state
r_int
r_char
id|button_state
suffix:semicolon
multiline_comment|/* Current button state */
DECL|member|prev_state
r_int
r_char
id|prev_state
suffix:semicolon
multiline_comment|/* Previous button state */
DECL|member|delta_x
r_int
id|delta_x
suffix:semicolon
multiline_comment|/* Current delta-x */
DECL|member|delta_y
r_int
id|delta_y
suffix:semicolon
multiline_comment|/* Current delta-y */
DECL|member|present
r_int
id|present
suffix:semicolon
DECL|member|ready
r_int
id|ready
suffix:semicolon
multiline_comment|/* set if there if data is available */
DECL|member|active
r_int
id|active
suffix:semicolon
multiline_comment|/* set if device is open */
DECL|member|vuid_mode
r_int
id|vuid_mode
suffix:semicolon
multiline_comment|/* VUID_NATIVE or VUID_FIRM_EVENT */
DECL|member|proc_list
r_struct
id|wait_queue
op_star
id|proc_list
suffix:semicolon
DECL|member|fasync
r_struct
id|fasync_struct
op_star
id|fasync
suffix:semicolon
multiline_comment|/* The event/stream queue */
DECL|member|head
r_int
r_int
id|head
suffix:semicolon
DECL|member|tail
r_int
r_int
id|tail
suffix:semicolon
r_union
(brace
DECL|member|stream
r_char
id|stream
(braket
id|STREAM_SIZE
)braket
suffix:semicolon
DECL|member|ev
id|Firm_event
id|ev
(braket
l_int|0
)braket
suffix:semicolon
DECL|member|queue
)brace
id|queue
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|sunmouse
r_static
r_struct
id|sun_mouse
id|sunmouse
suffix:semicolon
DECL|macro|gen_events
mdefine_line|#define gen_events (sunmouse.vuid_mode != VUID_NATIVE)
DECL|macro|bstate
mdefine_line|#define bstate sunmouse.button_state
DECL|macro|pstate
mdefine_line|#define pstate sunmouse.prev_state
r_extern
r_void
id|mouse_put_char
c_func
(paren
r_char
id|ch
)paren
suffix:semicolon
multiline_comment|/* #define SMOUSE_DEBUG */
r_static
r_void
DECL|function|push_event
id|push_event
(paren
id|Firm_event
op_star
id|ev
)paren
(brace
r_int
id|next
op_assign
(paren
id|sunmouse.head
op_plus
l_int|1
)paren
op_mod
id|EV_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ne
id|sunmouse.tail
)paren
(brace
id|sunmouse.queue.ev
(braket
id|sunmouse.head
)braket
op_assign
op_star
id|ev
suffix:semicolon
id|sunmouse.head
op_assign
id|next
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|queue_empty
id|queue_empty
(paren
r_void
)paren
(brace
r_return
id|sunmouse.head
op_eq
id|sunmouse.tail
suffix:semicolon
)brace
r_static
id|Firm_event
op_star
DECL|function|get_from_queue
id|get_from_queue
(paren
r_void
)paren
(brace
id|Firm_event
op_star
id|result
suffix:semicolon
id|result
op_assign
op_amp
id|sunmouse.queue.ev
(braket
id|sunmouse.tail
)braket
suffix:semicolon
id|sunmouse.tail
op_assign
(paren
id|sunmouse.tail
op_plus
l_int|1
)paren
op_mod
id|EV_SIZE
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_void
DECL|function|push_char
id|push_char
(paren
r_char
id|c
)paren
(brace
r_int
id|next
op_assign
(paren
id|sunmouse.head
op_plus
l_int|1
)paren
op_mod
id|STREAM_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ne
id|sunmouse.tail
)paren
(brace
id|sunmouse.queue.stream
(braket
id|sunmouse.head
)braket
op_assign
id|c
suffix:semicolon
id|sunmouse.head
op_assign
id|next
suffix:semicolon
)brace
id|sunmouse.ready
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sunmouse.fasync
)paren
id|kill_fasync
(paren
id|sunmouse.fasync
comma
id|SIGIO
)paren
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|sunmouse.proc_list
)paren
suffix:semicolon
)brace
multiline_comment|/* The following is called from the zs driver when bytes are received on&n; * the Mouse zs8530 channel.&n; */
r_void
DECL|function|sun_mouse_inbyte
id|sun_mouse_inbyte
c_func
(paren
r_int
r_char
id|byte
comma
r_int
r_char
id|status
)paren
(brace
r_int
r_char
id|mvalue
suffix:semicolon
r_int
id|d
suffix:semicolon
id|Firm_event
id|ev
suffix:semicolon
id|add_mouse_randomness
(paren
id|byte
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sunmouse.active
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|gen_events
)paren
(brace
id|push_char
(paren
id|byte
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Check for framing errors and parity errors */
multiline_comment|/* XXX TODO XXX */
multiline_comment|/* If the mouse sends us a byte from 0x80 to 0x87&n;&t; * we are starting at byte zero in the transaction&n;&t; * protocol.&n;&t; */
r_if
c_cond
(paren
id|byte
op_ge
l_int|0x80
op_logical_and
id|byte
op_le
l_int|0x87
)paren
(brace
id|sunmouse.byte
op_assign
l_int|0
suffix:semicolon
)brace
id|mvalue
op_assign
(paren
r_int
r_char
)paren
id|byte
suffix:semicolon
r_switch
c_cond
(paren
id|sunmouse.byte
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Button state */
id|sunmouse.button_state
op_assign
(paren
op_complement
id|byte
)paren
op_amp
l_int|0x7
suffix:semicolon
macro_line|#ifdef SMOUSE_DEBUG
id|printk
c_func
(paren
l_string|&quot;B&lt;Left %s, Middle %s, Right %s&gt;&quot;
comma
(paren
(paren
id|sunmouse.button_state
op_amp
l_int|0x4
)paren
ques
c_cond
l_string|&quot;DOWN&quot;
suffix:colon
l_string|&quot;UP&quot;
)paren
comma
(paren
(paren
id|sunmouse.button_state
op_amp
l_int|0x2
)paren
ques
c_cond
l_string|&quot;DOWN&quot;
suffix:colon
l_string|&quot;UP&quot;
)paren
comma
(paren
(paren
id|sunmouse.button_state
op_amp
l_int|0x1
)paren
ques
c_cond
l_string|&quot;DOWN&quot;
suffix:colon
l_string|&quot;UP&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
id|sunmouse.byte
op_increment
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Delta-x 1 */
macro_line|#ifdef SMOUSE_DEBUG
id|printk
c_func
(paren
l_string|&quot;DX1&lt;%d&gt;&quot;
comma
id|mvalue
)paren
suffix:semicolon
macro_line|#endif
id|sunmouse.delta_x
op_assign
id|mvalue
suffix:semicolon
id|sunmouse.byte
op_increment
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Delta-y 1 */
macro_line|#ifdef SMOUSE_DEBUG
id|printk
c_func
(paren
l_string|&quot;DY1&lt;%d&gt;&quot;
comma
id|mvalue
)paren
suffix:semicolon
macro_line|#endif
id|sunmouse.delta_y
op_assign
id|mvalue
suffix:semicolon
id|sunmouse.byte
op_increment
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* Delta-x 2 */
macro_line|#ifdef SMOUSE_DEBUG
id|printk
c_func
(paren
l_string|&quot;DX2&lt;%d&gt;&quot;
comma
id|mvalue
)paren
suffix:semicolon
macro_line|#endif
id|sunmouse.delta_x
op_add_assign
id|mvalue
suffix:semicolon
id|sunmouse.byte
op_increment
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* Last byte, Delta-y 2 */
macro_line|#ifdef SMOUSE_DEBUG
id|printk
c_func
(paren
l_string|&quot;DY2&lt;%d&gt;&quot;
comma
id|mvalue
)paren
suffix:semicolon
macro_line|#endif
id|sunmouse.delta_y
op_add_assign
id|mvalue
suffix:semicolon
id|sunmouse.byte
op_assign
l_int|69
suffix:semicolon
multiline_comment|/* Some ridiculous value */
r_break
suffix:semicolon
r_case
l_int|69
suffix:colon
multiline_comment|/* Until we get the (0x80 -&gt; 0x87) value we aren&squot;t&n;&t;&t; * in the middle of a real transaction, so just&n;&t;&t; * return.&n;&t;&t; */
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;sunmouse: bogon transaction state&bslash;n&quot;
)paren
suffix:semicolon
id|sunmouse.byte
op_assign
l_int|69
suffix:semicolon
multiline_comment|/* What could cause this? */
r_return
suffix:semicolon
)brace
suffix:semicolon
id|d
op_assign
id|bstate
op_xor
id|pstate
suffix:semicolon
id|pstate
op_assign
id|bstate
suffix:semicolon
r_if
c_cond
(paren
id|d
)paren
(brace
r_if
c_cond
(paren
id|d
op_amp
id|BUTTON_LEFT
)paren
(brace
id|ev.id
op_assign
id|MS_LEFT
suffix:semicolon
id|ev.value
op_assign
id|bstate
op_amp
id|BUTTON_LEFT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d
op_amp
id|BUTTON_RIGHT
)paren
(brace
id|ev.id
op_assign
id|MS_RIGHT
suffix:semicolon
id|ev.value
op_assign
id|bstate
op_amp
id|BUTTON_RIGHT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d
op_amp
id|BUTTON_MIDDLE
)paren
(brace
id|ev.id
op_assign
id|MS_MIDDLE
suffix:semicolon
id|ev.value
op_assign
id|bstate
op_amp
id|BUTTON_MIDDLE
suffix:semicolon
)brace
id|ev.time
op_assign
id|xtime
suffix:semicolon
id|ev.value
op_assign
id|ev.value
ques
c_cond
id|VKEY_DOWN
suffix:colon
id|VKEY_UP
suffix:semicolon
id|push_event
(paren
op_amp
id|ev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sunmouse.delta_x
)paren
(brace
id|ev.id
op_assign
id|LOC_X_DELTA
suffix:semicolon
id|ev.time
op_assign
id|xtime
suffix:semicolon
id|ev.value
op_assign
id|sunmouse.delta_x
suffix:semicolon
id|push_event
(paren
op_amp
id|ev
)paren
suffix:semicolon
id|sunmouse.delta_x
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sunmouse.delta_y
)paren
(brace
id|ev.id
op_assign
id|LOC_Y_DELTA
suffix:semicolon
id|ev.time
op_assign
id|xtime
suffix:semicolon
id|ev.value
op_assign
id|sunmouse.delta_y
suffix:semicolon
id|push_event
(paren
op_amp
id|ev
)paren
suffix:semicolon
)brace
multiline_comment|/* We just completed a transaction, wake up whoever is awaiting&n;&t; * this event.&n;&t; */
id|sunmouse.ready
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sunmouse.fasync
)paren
id|kill_fasync
(paren
id|sunmouse.fasync
comma
id|SIGIO
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|sunmouse.proc_list
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|sun_mouse_open
id|sun_mouse_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sunmouse.present
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sunmouse.active
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|sunmouse.active
op_assign
l_int|1
suffix:semicolon
id|sunmouse.ready
op_assign
id|sunmouse.delta_x
op_assign
id|sunmouse.delta_y
op_assign
l_int|0
suffix:semicolon
id|sunmouse.button_state
op_assign
l_int|0x80
suffix:semicolon
id|sunmouse.vuid_mode
op_assign
id|VUID_NATIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sun_mouse_fasync
id|sun_mouse_fasync
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|on
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|fasync_helper
(paren
id|inode
comma
id|filp
comma
id|on
comma
op_amp
id|sunmouse.fasync
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|sun_mouse_close
id|sun_mouse_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|sunmouse.active
op_assign
id|sunmouse.ready
op_assign
l_int|0
suffix:semicolon
id|sun_mouse_fasync
(paren
id|inode
comma
id|file
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sun_mouse_write
id|sun_mouse_write
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* foo on you */
)brace
r_static
r_int
DECL|function|sun_mouse_read
id|sun_mouse_read
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_struct
id|wait_queue
id|wait
op_assign
(brace
id|current
comma
l_int|NULL
)brace
suffix:semicolon
r_if
c_cond
(paren
id|queue_empty
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
id|add_wait_queue
(paren
op_amp
id|sunmouse.proc_list
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
id|queue_empty
(paren
)paren
op_logical_and
op_logical_neg
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule
(paren
)paren
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
(paren
op_amp
id|sunmouse.proc_list
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gen_events
)paren
(brace
r_char
op_star
id|p
op_assign
id|buffer
comma
op_star
id|end
op_assign
id|buffer
op_plus
id|count
suffix:semicolon
r_while
c_loop
(paren
id|p
OL
id|end
op_logical_and
op_logical_neg
id|queue_empty
(paren
)paren
)paren
(brace
op_star
(paren
id|Firm_event
op_star
)paren
id|p
op_assign
op_star
id|get_from_queue
(paren
)paren
suffix:semicolon
id|p
op_add_assign
r_sizeof
(paren
id|Firm_event
)paren
suffix:semicolon
)brace
id|sunmouse.ready
op_assign
op_logical_neg
id|queue_empty
(paren
)paren
suffix:semicolon
id|inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_return
id|p
op_minus
id|buffer
suffix:semicolon
)brace
r_else
(brace
r_int
id|c
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
id|count
suffix:semicolon
op_logical_neg
id|queue_empty
(paren
)paren
op_logical_and
id|c
suffix:semicolon
id|c
op_decrement
)paren
(brace
op_star
id|buffer
op_increment
op_assign
id|sunmouse.queue.stream
(braket
id|sunmouse.tail
)braket
suffix:semicolon
id|sunmouse.tail
op_assign
(paren
id|sunmouse.tail
op_plus
l_int|1
)paren
op_mod
id|STREAM_SIZE
suffix:semicolon
)brace
id|sunmouse.ready
op_assign
op_logical_neg
id|queue_empty
(paren
)paren
suffix:semicolon
id|inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_return
id|count
op_minus
id|c
suffix:semicolon
)brace
multiline_comment|/* Only called if nothing was sent */
r_if
c_cond
(paren
id|current-&gt;signal
op_amp
op_complement
id|current-&gt;blocked
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sun_mouse_select
id|sun_mouse_select
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|sel_type
comma
id|select_table
op_star
id|wait
)paren
(brace
r_if
c_cond
(paren
id|sel_type
op_ne
id|SEL_IN
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sunmouse.ready
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|select_wait
c_func
(paren
op_amp
id|sunmouse.proc_list
comma
id|wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|sun_mouse_ioctl
id|sun_mouse_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* VUIDGFORMAT - Get input device byte stream format */
r_case
id|_IOR
c_func
(paren
l_char|&squot;v&squot;
comma
l_int|2
comma
r_int
)paren
suffix:colon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_WRITE
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|sunmouse.vuid_mode
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* VUIDSFORMAT - Set input device byte stream format*/
r_case
id|_IOW
c_func
(paren
l_char|&squot;v&squot;
comma
l_int|1
comma
r_int
)paren
suffix:colon
id|i
op_assign
id|verify_area
(paren
id|VERIFY_READ
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|VUID_NATIVE
op_logical_or
id|i
op_eq
id|VUID_FIRM_EVENT
)paren
(brace
id|sunmouse.vuid_mode
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
id|sunmouse.head
op_assign
id|sunmouse.tail
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;[MOUSE-ioctl: %8.8x]&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sun_mouse_fops
r_struct
id|file_operations
id|sun_mouse_fops
op_assign
(brace
l_int|NULL
comma
id|sun_mouse_read
comma
id|sun_mouse_write
comma
l_int|NULL
comma
id|sun_mouse_select
comma
id|sun_mouse_ioctl
comma
l_int|NULL
comma
id|sun_mouse_open
comma
id|sun_mouse_close
comma
l_int|NULL
comma
id|sun_mouse_fasync
comma
)brace
suffix:semicolon
DECL|variable|sun_mouse_mouse
r_static
r_struct
id|miscdevice
id|sun_mouse_mouse
op_assign
(brace
id|SUN_MOUSE_MINOR
comma
l_string|&quot;sunmouse&quot;
comma
op_amp
id|sun_mouse_fops
)brace
suffix:semicolon
r_int
DECL|function|sun_mouse_init
id|sun_mouse_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Sun Mouse-Systems mouse driver version 1.00&bslash;n&quot;
)paren
suffix:semicolon
id|sunmouse.present
op_assign
l_int|1
suffix:semicolon
id|sunmouse.ready
op_assign
id|sunmouse.active
op_assign
l_int|0
suffix:semicolon
id|misc_register
(paren
op_amp
id|sun_mouse_mouse
)paren
suffix:semicolon
id|sunmouse.delta_x
op_assign
id|sunmouse.delta_y
op_assign
l_int|0
suffix:semicolon
id|sunmouse.button_state
op_assign
l_int|0x80
suffix:semicolon
id|sunmouse.proc_list
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|sun_mouse_zsinit
id|sun_mouse_zsinit
c_func
(paren
r_void
)paren
(brace
id|sunmouse.ready
op_assign
l_int|1
suffix:semicolon
)brace
eof
