DECL|macro|BLOCKMOVE
macro_line|#undef&t;BLOCKMOVE
DECL|macro|Z_WAKE
mdefine_line|#define&t;Z_WAKE
DECL|macro|Z_EXT_CHARS_IN_BUFFER
macro_line|#undef&t;Z_EXT_CHARS_IN_BUFFER
DECL|variable|rcsid
r_static
r_char
id|rcsid
(braket
)braket
op_assign
l_string|&quot;$Revision: 2.3.2.8 $$Date: 2000/07/06 18:14:16 $&quot;
suffix:semicolon
multiline_comment|/*&n; *  linux/drivers/char/cyclades.c&n; *&n; * This file contains the driver for the Cyclades async multiport&n; * serial boards.&n; *&n; * Initially written by Randolph Bentson &lt;bentson@grieg.seaslug.org&gt;.&n; * Modified and maintained by Marcio Saito &lt;marcio@cyclades.com&gt;.&n; * Currently maintained by Ivan Passos &lt;ivan@cyclades.com&gt;.&n; *&n; * For Technical support and installation problems, please send e-mail&n; * to support@cyclades.com.&n; *&n; * Much of the design and some of the code came from serial.c&n; * which was copyright (C) 1991, 1992  Linus Torvalds.  It was&n; * extensively rewritten by Theodore Ts&squot;o, 8/16/92 -- 9/14/92,&n; * and then fixed as suggested by Michael K. Johnson 12/12/92.&n; *&n; * This version supports shared IRQ&squot;s (only for PCI boards).&n; *&n; * $Log: cyclades.c,v $&n; * Revision 2.3.2.8   2000/07/06 18:14:16 ivan&n; * Fixed the PCI detection function to work properly on Alpha systems.&n; * Implemented support for TIOCSERGETLSR ioctl.&n; * Implemented full support for non-standard baud rates.&n; *&n; * Revision 2.3.2.7   2000/06/01 18:26:34 ivan&n; * Request PLX I/O region, although driver doesn&squot;t use it, to avoid&n; * problems with other drivers accessing it.&n; * Removed count for on-board buffer characters in cy_chars_in_buffer&n; * (Cyclades-Z only).&n; *&n; * Revision 2.3.2.6   2000/05/05 13:56:05 ivan&n; * Driver now reports physical instead of virtual memory addresses.&n; * Masks were added to some Cyclades-Z read accesses.&n; * Implemented workaround for PLX9050 bug that would cause a system lockup&n; * in certain systems, depending on the MMIO addresses allocated to the&n; * board.&n; * Changed the Tx interrupt programming in the CD1400 chips to boost up&n; * performance (Cyclom-Y only).&n; * Code is now compliant with the new module interface (module_[init|exit]).&n; * Make use of the PCI helper functions to access PCI resources.&n; * Did some code &quot;housekeeping&quot;.&n; *&n; * Revision 2.3.2.5   2000/01/19 14:35:33 ivan&n; * Fixed bug in cy_set_termios on CRTSCTS flag turnoff.&n; *&n; * Revision 2.3.2.4   2000/01/17 09:19:40 ivan&n; * Fixed SMP locking in Cyclom-Y interrupt handler.&n; *&n; * Revision 2.3.2.3   1999/12/28 12:11:39 ivan&n; * Added a new cyclades_card field called nports to allow the driver to&n; * know the exact number of ports found by the Z firmware after its load;&n; * RX buffer contention prevention logic on interrupt op mode revisited&n; * (Cyclades-Z only);&n; * Revisited printk&squot;s for Z debug;&n; * Driver now makes sure that the constant SERIAL_XMIT_SIZE is defined;&n; *&n; * Revision 2.3.2.2   1999/10/01 11:27:43 ivan&n; * Fixed bug in cyz_poll that would make all ports but port 0 &n; * unable to transmit/receive data (Cyclades-Z only);&n; * Implemented logic to prevent the RX buffer from being stuck with data&n; * due to a driver / firmware race condition in interrupt op mode&n; * (Cyclades-Z only);&n; * Fixed bug in block_til_ready logic that would lead to a system crash;&n; * Revisited cy_close spinlock usage;&n; *&n; * Revision 2.3.2.1   1999/09/28 11:01:22 ivan&n; * Revisited CONFIG_PCI conditional compilation for PCI board support;&n; * Implemented TIOCGICOUNT and TIOCMIWAIT ioctl support;&n; * _Major_ cleanup on the Cyclades-Z interrupt support code / logic;&n; * Removed CTS handling from the driver -- this is now completely handled&n; * by the firmware (Cyclades-Z only);&n; * Flush RX on-board buffers on a port open (Cyclades-Z only);&n; * Fixed handling of ASYNC_SPD_* TTY flags;&n; * Module unload now unmaps all memory area allocated by ioremap;&n; *&n; * Revision 2.3.1.1   1999/07/15 16:45:53 ivan&n; * Removed CY_PROC conditional compilation;&n; * Implemented SMP-awareness for the driver;&n; * Implemented a new ISA IRQ autoprobe that uses the irq_probe_[on|off] &n; * functions;&n; * The driver now accepts memory addresses (maddr=0xMMMMM) and IRQs&n; * (irq=NN) as parameters (only for ISA boards);&n; * Fixed bug in set_line_char that would prevent the Cyclades-Z &n; * ports from being configured at speeds above 115.2Kbps;&n; * Fixed bug in cy_set_termios that would prevent XON/XOFF flow control&n; * switching from working properly;&n; * The driver now only prints IRQ info for the Cyclades-Z if it&squot;s &n; * configured to work in interrupt mode;&n; *&n; * Revision 2.2.2.3   1999/06/28 11:13:29 ivan&n; * Added support for interrupt mode operation for the Z cards;&n; * Removed the driver inactivity control for the Z;&n; * Added a missing MOD_DEC_USE_COUNT in the cy_open function for when &n; * the Z firmware is not loaded yet;&n; * Replaced the &quot;manual&quot; Z Tx flush buffer by a call to a FW command of &n; * same functionality;&n; * Implemented workaround for IRQ setting loss on the PCI configuration &n; * registers after a PCI bridge EEPROM reload (affects PLX9060 only);&n; *&n; * Revision 2.2.2.2  1999/05/14 17:18:15 ivan&n; * /proc entry location changed to /proc/tty/driver/cyclades;&n; * Added support to shared IRQ&squot;s (only for PCI boards);&n; * Added support for Cobalt Qube2 systems;&n; * IRQ [de]allocation scheme revisited;&n; * BREAK implementation changed in order to make use of the &squot;break_ctl&squot;&n; * TTY facility;&n; * Fixed typo in TTY structure field &squot;driver_name&squot;;&n; * Included a PCI bridge reset and EEPROM reload in the board &n; * initialization code (for both Y and Z series).&n; *&n; * Revision 2.2.2.1  1999/04/08 16:17:43 ivan&n; * Fixed a bug in cy_wait_until_sent that was preventing the port to be &n; * closed properly after a SIGINT;&n; * Module usage counter scheme revisited;&n; * Added support to the upcoming Y PCI boards (i.e., support to additional&n; * PCI Device ID&squot;s).&n; * &n; * Revision 2.2.1.10 1999/01/20 16:14:29 ivan&n; * Removed all unnecessary page-alignement operations in ioremap calls&n; * (ioremap is currently safe for these operations).&n; *&n; * Revision 2.2.1.9  1998/12/30 18:18:30 ivan&n; * Changed access to PLX PCI bridge registers from I/O to MMIO, in &n; * order to make PLX9050-based boards work with certain motherboards.&n; *&n; * Revision 2.2.1.8  1998/11/13 12:46:20 ivan&n; * cy_close function now resets (correctly) the tty-&gt;closing flag;&n; * JIFFIES_DIFF macro fixed.&n; *&n; * Revision 2.2.1.7  1998/09/03 12:07:28 ivan&n; * Fixed bug in cy_close function, which was not informing HW of&n; * which port should have the reception disabled before doing so;&n; * fixed Cyclom-8YoP hardware detection bug.&n; *&n; * Revision 2.2.1.6  1998/08/20 17:15:39 ivan&n; * Fixed bug in cy_close function, which causes malfunction&n; * of one of the first 4 ports when a higher port is closed&n; * (Cyclom-Y only).&n; *&n; * Revision 2.2.1.5  1998/08/10 18:10:28 ivan&n; * Fixed Cyclom-4Yo hardware detection bug.&n; *&n; * Revision 2.2.1.4  1998/08/04 11:02:50 ivan&n; * /proc/cyclades implementation with great collaboration of &n; * Marc Lewis &lt;marc@blarg.net&gt;;&n; * cyy_interrupt was changed to avoid occurence of kernel oopses&n; * during PPP operation.&n; *&n; * Revision 2.2.1.3  1998/06/01 12:09:10 ivan&n; * General code review in order to comply with 2.1 kernel standards;&n; * data loss prevention for slow devices revisited (cy_wait_until_sent&n; * was created);&n; * removed conditional compilation for new/old PCI structure support &n; * (now the driver only supports the new PCI structure).&n; *&n; * Revision 2.2.1.1  1998/03/19 16:43:12 ivan&n; * added conditional compilation for new/old PCI structure support;&n; * removed kernel series (2.0.x / 2.1.x) conditional compilation.&n; *&n; * Revision 2.1.1.3  1998/03/16 18:01:12 ivan&n; * cleaned up the data loss fix;&n; * fixed XON/XOFF handling once more (Cyclades-Z);&n; * general review of the driver routines;&n; * introduction of a mechanism to prevent data loss with slow &n; * printers, by forcing a delay before closing the port.&n; *&n; * Revision 2.1.1.2  1998/02/17 16:50:00 ivan&n; * fixed detection/handling of new CD1400 in Ye boards;&n; * fixed XON/XOFF handling (Cyclades-Z);&n; * fixed data loss caused by a premature port close;&n; * introduction of a flag that holds the CD1400 version ID per port&n; * (used by the CYGETCD1400VER new ioctl).&n; *&n; * Revision 2.1.1.1  1997/12/03 17:31:19 ivan&n; * Code review for the module cleanup routine;&n; * fixed RTS and DTR status report for new CD1400&squot;s in get_modem_info;&n; * includes anonymous changes regarding signal_pending.&n; * &n; * Revision 2.1  1997/11/01 17:42:41 ivan&n; * Changes in the driver to support Alpha systems (except 8Zo V_1);&n; * BREAK fix for the Cyclades-Z boards;&n; * driver inactivity control by FW implemented;&n; * introduction of flag that allows driver to take advantage of &n; * a special CD1400 feature related to HW flow control;&n; * added support for the CD1400  rev. J (Cyclom-Y boards);&n; * introduction of ioctls to:&n; *  - control the rtsdtr_inv flag (Cyclom-Y);&n; *  - control the rflow flag (Cyclom-Y);&n; *  - adjust the polling interval (Cyclades-Z);&n; *&n; * Revision 1.36.4.33  1997/06/27 19:00:00  ivan&n; * Fixes related to kernel version conditional &n; * compilation.&n; *  &n; * Revision 1.36.4.32  1997/06/14 19:30:00  ivan&n; * Compatibility issues between kernels 2.0.x and &n; * 2.1.x (mainly related to clear_bit function).&n; *  &n; * Revision 1.36.4.31  1997/06/03 15:30:00  ivan&n; * Changes to define the memory window according to the &n; * board type.&n; *  &n; * Revision 1.36.4.30  1997/05/16 15:30:00  daniel&n; * Changes to suport new cycladesZ boards.&n; *&n; * Revision 1.36.4.29  1997/05/12 11:30:00  daniel&n; * Merge of Bentson&squot;s and Daniel&squot;s version 1.36.4.28.&n; * Corrects bug in cy_detect_pci: check if there are more&n; * ports than the number of static structs allocated.&n; * Warning message during initialization if this driver is&n; * used with the new generation of cycladesZ boards.  Those&n; * will be supported only in next release of the driver.&n; * Corrects bug in cy_detect_pci and cy_detect_isa that&n; * returned wrong number of VALID boards, when a cyclomY&n; * was found with no serial modules connected.&n; * Changes to use current (2.1.x) kernel subroutine names&n; * and created macros for compilation with 2.0.x kernel,&n; * instead of the other way around.&n; *&n; * Revision 1.36.4.28  1997/05/?? ??:00:00  bentson&n; * Change queue_task_irq_off to queue_task_irq.&n; * The inline function queue_task_irq_off (tqueue.h)&n; * was removed from latest releases of 2.1.x kernel.&n; * Use of macro __init to mark the initialization&n; * routines, so memory can be reused.&n; * Also incorporate implementation of critical region&n; * in function cleanup_module() created by anonymous&n; * linuxer.&n; *&n; * Revision 1.36.4.28  1997/04/25 16:00:00  daniel&n; * Change to support new firmware that solves DCD problem:&n; * application could fail to receive SIGHUP signal when DCD&n; * varying too fast.&n; *&n; * Revision 1.36.4.27  1997/03/26 10:30:00  daniel&n; * Changed for suport linux versions 2.1.X.&n; * Backward compatible with linux versions 2.0.X.&n; * Corrected illegal use of filler field in&n; * CH_CTRL struct.&n; * Deleted some debug messages.&n; *&n; * Revision 1.36.4.26  1997/02/27 12:00:00  daniel&n; * Included check for NULL tty pointer in cyz_poll.&n; *&n; * Revision 1.36.4.25  1997/02/26 16:28:30  bentson&n; * Bill Foster at Blarg! Online services noticed that&n; * some of the switch elements of -Z modem control&n; * lacked a closing &quot;break;&quot;&n; *&n; * Revision 1.36.4.24  1997/02/24 11:00:00  daniel&n; * Changed low water threshold for buffer xmit_buf&n; *&n; * Revision 1.36.4.23  1996/12/02 21:50:16  bentson&n; * Marcio provided fix to modem status fetch for -Z&n; *&n; * Revision 1.36.4.22  1996/10/28 22:41:17  bentson&n; * improve mapping of -Z control page (thanks to Steve&n; * Price &lt;stevep@fa.tdktca.com&gt; for help on this)&n; *&n; * Revision 1.36.4.21  1996/09/10 17:00:10  bentson&n; * shift from CPU-bound to memcopy in cyz_polling operation&n; *&n; * Revision 1.36.4.20  1996/09/09 18:30:32  Bentson&n; * Added support to set and report higher speeds.&n; *&n; * Revision 1.36.4.19c  1996/08/09 10:00:00  Marcio Saito&n; * Some fixes in the HW flow control for the BETA release.&n; * Don&squot;t try to register the IRQ.&n; *&n; * Revision 1.36.4.19  1996/08/08 16:23:18  Bentson&n; * make sure &quot;cyc&quot; appears in all kernel messages; all soft interrupts&n; * handled by same routine; recognize out-of-band reception; comment&n; * out some diagnostic messages; leave RTS/CTS flow control to hardware;&n; * fix race condition in -Z buffer management; only -Y needs to explictly&n; * flush chars; tidy up some startup messages;&n; *&n; * Revision 1.36.4.18  1996/07/25 18:57:31  bentson&n; * shift MOD_INC_USE_COUNT location to match&n; * serial.c; purge some diagnostic messages;&n; *&n; * Revision 1.36.4.17  1996/07/25 18:01:08  bentson&n; * enable modem status messages and fetch &amp; process them; note&n; * time of last activity type for each port; set_line_char now&n; * supports more than line 0 and treats 0 baud correctly;&n; * get_modem_info senses rs_status;&n; *&n; * Revision 1.36.4.16  1996/07/20 08:43:15  bentson&n; * barely works--now&squot;s time to turn on&n; * more features &squot;til it breaks&n; *&n; * Revision 1.36.4.15  1996/07/19 22:30:06  bentson&n; * check more -Z board status; shorten boot message&n; *&n; * Revision 1.36.4.14  1996/07/19 22:20:37  bentson&n; * fix reference to ch_ctrl in startup; verify return&n; * values from cyz_issue_cmd and cyz_update_channel;&n; * more stuff to get modem control correct;&n; *&n; * Revision 1.36.4.13  1996/07/11 19:53:33  bentson&n; * more -Z stuff folded in; re-order changes to put -Z stuff&n; * after -Y stuff (to make changes clearer)&n; *&n; * Revision 1.36.4.12  1996/07/11 15:40:55  bentson&n; * Add code to poll Cyclades-Z.  Add code to get &amp; set RS-232 control.&n; * Add code to send break.  Clear firmware ID word at startup (so&n; * that other code won&squot;t talk to inactive board).&n; *&n; * Revision 1.36.4.11  1996/07/09 05:28:29  bentson&n; * add code for -Z in set_line_char&n; *&n; * Revision 1.36.4.10  1996/07/08 19:28:37  bentson&n; * fold more -Z stuff (or in some cases, error messages)&n; * into driver; add text to &quot;don&squot;t know what to do&quot; messages.&n; *&n; * Revision 1.36.4.9  1996/07/08 18:38:38  bentson&n; * moved compile-time flags near top of file; cosmetic changes&n; * to narrow text (to allow 2-up printing); changed many declarations&n; * to &quot;static&quot; to limit external symbols; shuffled code order to&n; * coalesce -Y and -Z specific code, also to put internal functions&n; * in order of tty_driver structure; added code to recognize -Z&n; * ports (and for moment, do nothing or report error); add cy_startup&n; * to parse boot command line for extra base addresses for ISA probes;&n; *&n; * Revision 1.36.4.8  1996/06/25 17:40:19  bentson&n; * reorder some code, fix types of some vars (int vs. long),&n; * add cy_setup to support user declared ISA addresses&n; *&n; * Revision 1.36.4.7  1996/06/21 23:06:18  bentson&n; * dump ioctl based firmware load (it&squot;s now a user level&n; * program); ensure uninitialzed ports cannot be used&n; *&n; * Revision 1.36.4.6  1996/06/20 23:17:19  bentson&n; * rename vars and restructure some code&n; *&n; * Revision 1.36.4.5  1996/06/14 15:09:44  bentson&n; * get right status back after boot load&n; *&n; * Revision 1.36.4.4  1996/06/13 19:51:44  bentson&n; * successfully loads firmware&n; *&n; * Revision 1.36.4.3  1996/06/13 06:08:33  bentson&n; * add more of the code for the boot/load ioctls&n; *&n; * Revision 1.36.4.2  1996/06/11 21:00:51  bentson&n; * start to add Z functionality--starting with ioctl&n; * for loading firmware&n; *&n; * Revision 1.36.4.1  1996/06/10 18:03:02  bentson&n; * added code to recognize Z/PCI card at initialization; report&n; * presence, but card is not initialized (because firmware needs&n; * to be loaded)&n; *&n; * Revision 1.36.3.8  1996/06/07 16:29:00  bentson&n; * starting minor number at zero; added missing verify_area&n; * as noted by Heiko Eissfeldt &lt;heiko@colossus.escape.de&gt;&n; *&n; * Revision 1.36.3.7  1996/04/19 21:06:18  bentson&n; * remove unneeded boot message &amp; fix CLOCAL hardware flow&n; * control (Miquel van Smoorenburg &lt;miquels@Q.cistron.nl&gt;);&n; * remove unused diagnostic statements; minor 0 is first;&n; *&n; * Revision 1.36.3.6  1996/03/13 13:21:17  marcio&n; * The kernel function vremap (available only in later 1.3.xx kernels)&n; * allows the access to memory addresses above the RAM. This revision&n; * of the driver supports PCI boards below 1Mb (device id 0x100) and&n; * above 1Mb (device id 0x101).&n; *&n; * Revision 1.36.3.5  1996/03/07 15:20:17  bentson&n; * Some global changes to interrupt handling spilled into&n; * this driver--mostly unused arguments in system function&n; * calls.  Also added change by Marcio Saito which should&n; * reduce lost interrupts at startup by fast processors.&n; *&n; * Revision 1.36.3.4  1995/11/13  20:45:10  bentson&n; * Changes by Corey Minyard &lt;minyard@wf-rch.cirr.com&gt; distributed&n; * in 1.3.41 kernel to remove a possible race condition, extend&n; * some error messages, and let the driver run as a loadable module&n; * Change by Alan Wendt &lt;alan@ez0.ezlink.com&gt; to remove a&n; * possible race condition.&n; * Change by Marcio Saito &lt;marcio@cyclades.com&gt; to fix PCI addressing.&n; *&n; * Revision 1.36.3.3  1995/11/13  19:44:48  bentson&n; * Changes by Linus Torvalds in 1.3.33 kernel distribution&n; * required due to reordering of driver initialization.&n; * Drivers are now initialized *after* memory management.&n; *&n; * Revision 1.36.3.2  1995/09/08  22:07:14  bentson&n; * remove printk from ISR; fix typo&n; *&n; * Revision 1.36.3.1  1995/09/01  12:00:42  marcio&n; * Minor fixes in the PCI board support. PCI function calls in&n; * conditional compilation (CONFIG_PCI). Thanks to Jim Duncan&n; * &lt;duncan@okay.com&gt;. &quot;bad serial count&quot; message removed.&n; *&n; * Revision 1.36.3  1995/08/22  09:19:42  marcio&n; * Cyclom-Y/PCI support added. Changes in the cy_init routine and&n; * board initialization. Changes in the boot messages. The driver&n; * supports up to 4 boards and 64 ports by default.&n; *&n; * Revision 1.36.1.4  1995/03/29  06:14:14  bentson&n; * disambiguate between Cyclom-16Y and Cyclom-32Ye;&n; *&n; * Revision 1.36.1.3  1995/03/23  22:15:35  bentson&n; * add missing break in modem control block in ioctl switch statement&n; * (discovered by Michael Edward Chastain &lt;mec@jobe.shell.portal.com&gt;);&n; *&n; * Revision 1.36.1.2  1995/03/22  19:16:22  bentson&n; * make sure CTS flow control is set as soon as possible (thanks&n; * to note from David Lambert &lt;lambert@chesapeake.rps.slb.com&gt;);&n; *&n; * Revision 1.36.1.1  1995/03/13  15:44:43  bentson&n; * initialize defaults for receive threshold and stale data timeout;&n; * cosmetic changes;&n; *&n; * Revision 1.36  1995/03/10  23:33:53  bentson&n; * added support of chips 4-7 in 32 port Cyclom-Ye;&n; * fix cy_interrupt pointer dereference problem&n; * (Joe Portman &lt;baron@aa.net&gt;);&n; * give better error response if open is attempted on non-existent port&n; * (Zachariah Vaum &lt;jchryslr@netcom.com&gt;);&n; * correct command timeout (Kenneth Lerman &lt;lerman@@seltd.newnet.com&gt;);&n; * conditional compilation for -16Y on systems with fast, noisy bus;&n; * comment out diagnostic print function;&n; * cleaned up table of base addresses;&n; * set receiver time-out period register to correct value,&n; * set receive threshold to better default values,&n; * set chip timer to more accurate 200 Hz ticking,&n; * add code to monitor and modify receive parameters&n; * (Rik Faith &lt;faith@cs.unc.edu&gt; Nick Simicich&n; * &lt;njs@scifi.emi.net&gt;);&n; *&n; * Revision 1.35  1994/12/16  13:54:18  steffen&n; * additional patch by Marcio Saito for board detection&n; * Accidently left out in 1.34&n; *&n; * Revision 1.34  1994/12/10  12:37:12  steffen&n; * This is the corrected version as suggested by Marcio Saito&n; *&n; * Revision 1.33  1994/12/01  22:41:18  bentson&n; * add hooks to support more high speeds directly; add tytso&n; * patch regarding CLOCAL wakeups&n; *&n; * Revision 1.32  1994/11/23  19:50:04  bentson&n; * allow direct kernel control of higher signalling rates;&n; * look for cards at additional locations&n; *&n; * Revision 1.31  1994/11/16  04:33:28  bentson&n; * ANOTHER fix from Corey Minyard, minyard@wf-rch.cirr.com--&n; * a problem in chars_in_buffer has been resolved by some&n; * small changes;  this should yield smoother output&n; *&n; * Revision 1.30  1994/11/16  04:28:05  bentson&n; * Fix from Corey Minyard, Internet: minyard@metronet.com,&n; * UUCP: minyard@wf-rch.cirr.com, WORK: minyardbnr.ca, to&n; * cy_hangup that appears to clear up much (all?) of the&n; * DTR glitches; also he&squot;s added/cleaned-up diagnostic messages&n; *&n; * Revision 1.29  1994/11/16  04:16:07  bentson&n; * add change proposed by Ralph Sims, ralphs@halcyon.com, to&n; * operate higher speeds in same way as other serial ports;&n; * add more serial ports (for up to two 16-port muxes).&n; *&n; * Revision 1.28  1994/11/04  00:13:16  root&n; * turn off diagnostic messages&n; *&n; * Revision 1.27  1994/11/03  23:46:37  root&n; * bunch of changes to bring driver into greater conformance&n; * with the serial.c driver (looking for missed fixes)&n; *&n; * Revision 1.26  1994/11/03  22:40:36  root&n; * automatic interrupt probing fixed.&n; *&n; * Revision 1.25  1994/11/03  20:17:02  root&n; * start to implement auto-irq&n; *&n; * Revision 1.24  1994/11/03  18:01:55  root&n; * still working on modem signals--trying not to drop DTR&n; * during the getty/login processes&n; *&n; * Revision 1.23  1994/11/03  17:51:36  root&n; * extend baud rate support; set receive threshold as function&n; * of baud rate; fix some problems with RTS/CTS;&n; *&n; * Revision 1.22  1994/11/02  18:05:35  root&n; * changed arguments to udelay to type long to get&n; * delays to be of correct duration&n; *&n; * Revision 1.21  1994/11/02  17:37:30  root&n; * employ udelay (after calibrating loops_per_second earlier&n; * in init/main.c) instead of using home-grown delay routines&n; *&n; * Revision 1.20  1994/11/02  03:11:38  root&n; * cy_chars_in_buffer forces a return value of 0 to let&n; * login work (don&squot;t know why it does); some functions&n; * that were returning EFAULT, now executes the code;&n; * more work on deciding when to disable xmit interrupts;&n; *&n; * Revision 1.19  1994/11/01  20:10:14  root&n; * define routine to start transmission interrupts (by enabling&n; * transmit interrupts); directly enable/disable modem interrupts;&n; *&n; * Revision 1.18  1994/11/01  18:40:45  bentson&n; * Don&squot;t always enable transmit interrupts in startup; interrupt on&n; * TxMpty instead of TxRdy to help characters get out before shutdown;&n; * restructure xmit interrupt to check for chars first and quit if&n; * none are ready to go; modem status (MXVRx) is upright, _not_ inverted&n; * (to my view);&n; *&n; * Revision 1.17  1994/10/30  04:39:45  bentson&n; * rename serial_driver and callout_driver to cy_serial_driver and&n; * cy_callout_driver to avoid linkage interference; initialize&n; * info-&gt;type to PORT_CIRRUS; ruggedize paranoia test; elide -&gt;port&n; * from cyclades_port structure; add paranoia check to cy_close;&n; *&n; * Revision 1.16  1994/10/30  01:14:33  bentson&n; * change major numbers; add some _early_ return statements;&n; *&n; * Revision 1.15  1994/10/29  06:43:15  bentson&n; * final tidying up for clean compile;  enable some error reporting&n; *&n; * Revision 1.14  1994/10/28  20:30:22  Bentson&n; * lots of changes to drag the driver towards the new tty_io&n; * structures and operation.  not expected to work, but may&n; * compile cleanly.&n; *&n; * Revision 1.13  1994/07/21  23:08:57  Bentson&n; * add some diagnostic cruft; support 24 lines (for testing&n; * both -8Y and -16Y cards; be more thorough in servicing all&n; * chips during interrupt; add &quot;volatile&quot; a few places to&n; * circumvent compiler optimizations; fix base &amp; offset&n; * computations in block_til_ready (was causing chip 0 to&n; * stop operation)&n; *&n; * Revision 1.12  1994/07/19  16:42:11  Bentson&n; * add some hackery for kernel version 1.1.8; expand&n; * error messages; refine timing for delay loops and&n; * declare loop params volatile&n; *&n; * Revision 1.11  1994/06/11  21:53:10  bentson&n; * get use of save_car right in transmit interrupt service&n; *&n; * Revision 1.10.1.1  1994/06/11  21:31:18  bentson&n; * add some diagnostic printing; try to fix save_car stuff&n; *&n; * Revision 1.10  1994/06/11  20:36:08  bentson&n; * clean up compiler warnings&n; *&n; * Revision 1.9  1994/06/11  19:42:46  bentson&n; * added a bunch of code to support modem signalling&n; *&n; * Revision 1.8  1994/06/11  17:57:07  bentson&n; * recognize break &amp; parity error&n; *&n; * Revision 1.7  1994/06/05  05:51:34  bentson&n; * Reorder baud table to be monotonic; add cli to CP; discard&n; * incoming characters and status if the line isn&squot;t open; start to&n; * fold code into cy_throttle; start to port get_serial_info,&n; * set_serial_info, get_modem_info, set_modem_info, and send_break&n; * from serial.c; expand cy_ioctl; relocate and expand config_setup;&n; * get flow control characters from tty struct; invalidate ports w/o&n; * hardware;&n; *&n; * Revision 1.6  1994/05/31  18:42:21  bentson&n; * add a loop-breaker in the interrupt service routine;&n; * note when port is initialized so that it can be shut&n; * down under the right conditions; receive works without&n; * any obvious errors&n; *&n; * Revision 1.5  1994/05/30  00:55:02  bentson&n; * transmit works without obvious errors&n; *&n; * Revision 1.4  1994/05/27  18:46:27  bentson&n; * incorporated more code from lib_y.c; can now print short&n; * strings under interrupt control to port zero; seems to&n; * select ports/channels/lines correctly&n; *&n; * Revision 1.3  1994/05/25  22:12:44  bentson&n; * shifting from multi-port on a card to proper multiplexor&n; * data structures;  added skeletons of most routines&n; *&n; * Revision 1.2  1994/05/19  13:21:43  bentson&n; * start to crib from other sources&n; *&n; */
multiline_comment|/* If you need to install more boards than NR_CARDS, change the constant&n;   in the definition below. No other change is necessary to support up to&n;   eight boards. Beyond that you&squot;ll have to extend cy_isa_addresses. */
DECL|macro|NR_CARDS
mdefine_line|#define NR_CARDS        4
multiline_comment|/*&n;   If the total number of ports is larger than NR_PORTS, change this&n;   constant in the definition below. No other change is necessary to&n;   support more boards/ports. */
DECL|macro|NR_PORTS
mdefine_line|#define NR_PORTS        256
DECL|macro|ZE_V1_NPORTS
mdefine_line|#define ZE_V1_NPORTS&t;64
DECL|macro|ZO_V1
mdefine_line|#define ZO_V1&t;0
DECL|macro|ZO_V2
mdefine_line|#define ZO_V2&t;1
DECL|macro|ZE_V1
mdefine_line|#define ZE_V1&t;2
DECL|macro|SERIAL_PARANOIA_CHECK
mdefine_line|#define&t;SERIAL_PARANOIA_CHECK
DECL|macro|CY_DEBUG_OPEN
macro_line|#undef&t;CY_DEBUG_OPEN
DECL|macro|CY_DEBUG_THROTTLE
macro_line|#undef&t;CY_DEBUG_THROTTLE
DECL|macro|CY_DEBUG_OTHER
macro_line|#undef&t;CY_DEBUG_OTHER
DECL|macro|CY_DEBUG_IO
macro_line|#undef&t;CY_DEBUG_IO
DECL|macro|CY_DEBUG_COUNT
macro_line|#undef&t;CY_DEBUG_COUNT
DECL|macro|CY_DEBUG_DTR
macro_line|#undef&t;CY_DEBUG_DTR
DECL|macro|CY_DEBUG_WAIT_UNTIL_SENT
macro_line|#undef&t;CY_DEBUG_WAIT_UNTIL_SENT
DECL|macro|CY_DEBUG_INTERRUPTS
macro_line|#undef&t;CY_DEBUG_INTERRUPTS
DECL|macro|CY_16Y_HACK
macro_line|#undef&t;CY_16Y_HACK
DECL|macro|CY_ENABLE_MONITORING
macro_line|#undef&t;CY_ENABLE_MONITORING
DECL|macro|CY_PCI_DEBUG
macro_line|#undef&t;CY_PCI_DEBUG
macro_line|#if 0
mdefine_line|#define PAUSE __asm__(&quot;nop&quot;);
macro_line|#else
DECL|macro|PAUSE
mdefine_line|#define PAUSE ;
macro_line|#endif
DECL|macro|cy_min
mdefine_line|#define cy_min(a,b) (((a)&lt;(b))?(a):(b))
multiline_comment|/*&n; * Include section &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/cyclades.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
DECL|macro|CY_LOCK
mdefine_line|#define&t;CY_LOCK(info,flags)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;do {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;spin_lock_irqsave(&amp;cy_card[info-&gt;card].card_lock, flags); &bslash;&n;&t;&t;} while (0)
DECL|macro|CY_UNLOCK
mdefine_line|#define&t;CY_UNLOCK(info,flags)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;do {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;spin_unlock_irqrestore(&amp;cy_card[info-&gt;card].card_lock, flags); &bslash;&n;&t;&t;} while (0)
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#ifdef CONFIG_COBALT_27
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
DECL|macro|CACHED_TO_UNCACHED
mdefine_line|#define&t;CACHED_TO_UNCACHED(x)&t;(((unsigned long)(x) &amp; &bslash;&n;&t;&t;&t;&t;  (unsigned long)0x1fffffff) + KSEG1)
macro_line|#endif
DECL|macro|cy_put_user
mdefine_line|#define cy_put_user&t;put_user
r_static
r_int
r_int
DECL|function|cy_get_user
id|cy_get_user
c_func
(paren
r_int
r_int
op_star
id|addr
)paren
(brace
r_int
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|error
op_assign
id|get_user
(paren
id|result
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|printk
(paren
l_string|&quot;cyclades: cy_get_user: error == %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
macro_line|#ifndef MIN
DECL|macro|MIN
mdefine_line|#define MIN(a,b)        ((a) &lt; (b) ? (a) : (b))
macro_line|#endif
DECL|macro|IS_CYC_Z
mdefine_line|#define IS_CYC_Z(card) ((card).num_chips == -1)
DECL|macro|Z_FPGA_CHECK
mdefine_line|#define Z_FPGA_CHECK(card) &bslash;&n;    ((cy_readl(&amp;((struct RUNTIME_9060 *) &bslash;&n;&t;&t; ((card).ctl_addr))-&gt;init_ctrl) &amp; (1&lt;&lt;17)) != 0)
DECL|macro|ISZLOADED
mdefine_line|#define ISZLOADED(card)&t;(((ZO_V1==cy_readl(&amp;((struct RUNTIME_9060 *) &bslash;&n;&t;&t;&t;((card).ctl_addr))-&gt;mail_box_0)) || &bslash;&n;&t;&t;&t;Z_FPGA_CHECK(card)) &amp;&amp; &bslash;&n;&t;&t;&t;(ZFIRM_ID==cy_readl(&amp;((struct FIRM_ID *) &bslash;&n;&t;&t;&t;((card).base_addr+ID_ADDRESS))-&gt;signature)))
macro_line|#ifndef SERIAL_XMIT_SIZE
DECL|macro|SERIAL_XMIT_SIZE
mdefine_line|#define&t;SERIAL_XMIT_SIZE&t;(MIN(PAGE_SIZE, 4096))
macro_line|#endif
DECL|macro|WAKEUP_CHARS
mdefine_line|#define WAKEUP_CHARS&t;&t;256
DECL|macro|STD_COM_FLAGS
mdefine_line|#define STD_COM_FLAGS (0)
DECL|macro|JIFFIES_DIFF
mdefine_line|#define&t;JIFFIES_DIFF(n, j)&t;((j) - (n))
r_static
id|DECLARE_TASK_QUEUE
c_func
(paren
id|tq_cyclades
)paren
suffix:semicolon
DECL|variable|cy_serial_driver
DECL|variable|cy_callout_driver
r_static
r_struct
id|tty_driver
id|cy_serial_driver
comma
id|cy_callout_driver
suffix:semicolon
DECL|variable|serial_refcount
r_static
r_int
id|serial_refcount
suffix:semicolon
macro_line|#ifdef CONFIG_ISA
multiline_comment|/* This is the address lookup table. The driver will probe for&n;   Cyclom-Y/ISA boards at all addresses in here. If you want the&n;   driver to probe addresses at a different address, add it to&n;   this table.  If the driver is probing some other board and&n;   causing problems, remove the offending address from this table.&n;   The cy_setup function extracts additional addresses from the&n;   boot options line.  The form is &quot;cyclades=address,address...&quot;&n;*/
DECL|variable|cy_isa_addresses
r_static
r_int
r_char
op_star
id|cy_isa_addresses
(braket
)braket
op_assign
(brace
(paren
r_int
r_char
op_star
)paren
l_int|0xD0000
comma
(paren
r_int
r_char
op_star
)paren
l_int|0xD2000
comma
(paren
r_int
r_char
op_star
)paren
l_int|0xD4000
comma
(paren
r_int
r_char
op_star
)paren
l_int|0xD6000
comma
(paren
r_int
r_char
op_star
)paren
l_int|0xD8000
comma
(paren
r_int
r_char
op_star
)paren
l_int|0xDA000
comma
(paren
r_int
r_char
op_star
)paren
l_int|0xDC000
comma
(paren
r_int
r_char
op_star
)paren
l_int|0xDE000
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|NR_ISA_ADDRS
mdefine_line|#define NR_ISA_ADDRS (sizeof(cy_isa_addresses)/sizeof(unsigned char*))
macro_line|#ifdef MODULE
DECL|variable|maddr
r_static
r_int
id|maddr
(braket
id|NR_CARDS
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
(braket
id|NR_CARDS
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|maddr
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|NR_CARDS
)paren
l_string|&quot;l&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|NR_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif /* CONFIG_ISA */
multiline_comment|/* This is the per-card data structure containing address, irq, number of&n;   channels, etc. This driver supports a maximum of NR_CARDS cards.&n;*/
DECL|variable|cy_card
r_static
r_struct
id|cyclades_card
id|cy_card
(braket
id|NR_CARDS
)braket
suffix:semicolon
multiline_comment|/* This is the per-channel data structure containing pointers, flags&n; and variables for the port. This driver supports a maximum of NR_PORTS.&n;*/
DECL|variable|cy_port
r_static
r_struct
id|cyclades_port
id|cy_port
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|cy_next_channel
r_static
r_int
id|cy_next_channel
suffix:semicolon
multiline_comment|/* next minor available */
DECL|variable|serial_table
r_static
r_struct
id|tty_struct
op_star
id|serial_table
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|serial_termios
r_static
r_struct
id|termios
op_star
id|serial_termios
(braket
id|NR_PORTS
)braket
suffix:semicolon
DECL|variable|serial_termios_locked
r_static
r_struct
id|termios
op_star
id|serial_termios_locked
(braket
id|NR_PORTS
)braket
suffix:semicolon
multiline_comment|/*&n; * tmp_buf is used as a temporary buffer by serial_write.  We need to&n; * lock it in case the copy_from_user blocks while swapping in a page,&n; * and some other program tries to do a serial write at the same time.&n; * Since the lock will only come under contention when the system is&n; * swapping and available memory is low, it makes sense to share one&n; * buffer across all the serial ports, since it significantly saves&n; * memory if large numbers of serial ports are open.  This buffer is&n; * allocated when the first cy_open occurs.&n; */
DECL|variable|tmp_buf
r_static
r_int
r_char
op_star
id|tmp_buf
suffix:semicolon
DECL|variable|tmp_buf_sem
id|DECLARE_MUTEX
c_func
(paren
id|tmp_buf_sem
)paren
suffix:semicolon
multiline_comment|/*&n; * This is used to look up the divisor speeds and the timeouts&n; * We&squot;re normally limited to 15 distinct baud rates.  The extra&n; * are accessed via settings in info-&gt;flags.&n; *      0,     1,     2,     3,     4,     5,     6,     7,     8,     9,&n; *     10,    11,    12,    13,    14,    15,    16,    17,    18,    19,&n; *                                               HI            VHI&n; *     20&n; */
DECL|variable|baud_table
r_static
r_int
id|baud_table
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|50
comma
l_int|75
comma
l_int|110
comma
l_int|134
comma
l_int|150
comma
l_int|200
comma
l_int|300
comma
l_int|600
comma
l_int|1200
comma
l_int|1800
comma
l_int|2400
comma
l_int|4800
comma
l_int|9600
comma
l_int|19200
comma
l_int|38400
comma
l_int|57600
comma
l_int|76800
comma
l_int|115200
comma
l_int|150000
comma
l_int|230400
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|baud_co_25
r_static
r_char
id|baud_co_25
(braket
)braket
op_assign
(brace
multiline_comment|/* 25 MHz clock option table */
multiline_comment|/* value =&gt;    00    01   02    03    04 */
multiline_comment|/* divide by    8    32   128   512  2048 */
l_int|0x00
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|baud_bpr_25
r_static
r_char
id|baud_bpr_25
(braket
)braket
op_assign
(brace
multiline_comment|/* 25 MHz baud rate period table */
l_int|0x00
comma
l_int|0xf5
comma
l_int|0xa3
comma
l_int|0x6f
comma
l_int|0x5c
comma
l_int|0x51
comma
l_int|0xf5
comma
l_int|0xa3
comma
l_int|0x51
comma
l_int|0xa3
comma
l_int|0x6d
comma
l_int|0x51
comma
l_int|0xa3
comma
l_int|0x51
comma
l_int|0xa3
comma
l_int|0x51
comma
l_int|0x36
comma
l_int|0x29
comma
l_int|0x1b
comma
l_int|0x15
)brace
suffix:semicolon
DECL|variable|baud_co_60
r_static
r_char
id|baud_co_60
(braket
)braket
op_assign
(brace
multiline_comment|/* 60 MHz clock option table (CD1400 J) */
multiline_comment|/* value =&gt;    00    01   02    03    04 */
multiline_comment|/* divide by    8    32   128   512  2048 */
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|baud_bpr_60
r_static
r_char
id|baud_bpr_60
(braket
)braket
op_assign
(brace
multiline_comment|/* 60 MHz baud rate period table (CD1400 J) */
l_int|0x00
comma
l_int|0x82
comma
l_int|0x21
comma
l_int|0xff
comma
l_int|0xdb
comma
l_int|0xc3
comma
l_int|0x92
comma
l_int|0x62
comma
l_int|0xc3
comma
l_int|0x62
comma
l_int|0x41
comma
l_int|0xc3
comma
l_int|0x62
comma
l_int|0xc3
comma
l_int|0x62
comma
l_int|0xc3
comma
l_int|0x82
comma
l_int|0x62
comma
l_int|0x41
comma
l_int|0x32
comma
l_int|0x21
)brace
suffix:semicolon
DECL|variable|baud_cor3
r_static
r_char
id|baud_cor3
(braket
)braket
op_assign
(brace
multiline_comment|/* receive threshold */
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x07
comma
l_int|0x07
)brace
suffix:semicolon
multiline_comment|/*&n; * The Cyclades driver implements HW flow control as any serial driver.&n; * The cyclades_port structure member rflow and the vector rflow_thr &n; * allows us to take advantage of a special feature in the CD1400 to avoid &n; * data loss even when the system interrupt latency is too high. These flags &n; * are to be used only with very special applications. Setting these flags &n; * requires the use of a special cable (DTR and RTS reversed). In the new &n; * CD1400-based boards (rev. 6.00 or later), there is no need for special &n; * cables.&n; */
DECL|variable|rflow_thr
r_static
r_char
id|rflow_thr
(braket
)braket
op_assign
(brace
multiline_comment|/* rflow threshold */
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
)brace
suffix:semicolon
multiline_comment|/*  The Cyclom-Ye has placed the sequential chips in non-sequential&n; *  address order.  This look-up table overcomes that problem.&n; */
DECL|variable|cy_chip_offset
r_static
r_int
id|cy_chip_offset
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x0400
comma
l_int|0x0800
comma
l_int|0x0C00
comma
l_int|0x0200
comma
l_int|0x0600
comma
l_int|0x0A00
comma
l_int|0x0E00
)brace
suffix:semicolon
multiline_comment|/* PCI related definitions */
DECL|variable|cy_pci_nboard
r_static
r_int
r_int
id|cy_pci_nboard
suffix:semicolon
DECL|variable|cy_isa_nboard
r_static
r_int
r_int
id|cy_isa_nboard
suffix:semicolon
DECL|variable|cy_nboard
r_static
r_int
r_int
id|cy_nboard
suffix:semicolon
macro_line|#ifdef CONFIG_PCI
DECL|variable|cy_pci_dev_id
r_static
r_int
r_int
id|cy_pci_dev_id
(braket
)braket
op_assign
(brace
id|PCI_DEVICE_ID_CYCLOM_Y_Lo
comma
multiline_comment|/* PCI &lt; 1Mb */
id|PCI_DEVICE_ID_CYCLOM_Y_Hi
comma
multiline_comment|/* PCI &gt; 1Mb */
id|PCI_DEVICE_ID_CYCLOM_4Y_Lo
comma
multiline_comment|/* 4Y PCI &lt; 1Mb */
id|PCI_DEVICE_ID_CYCLOM_4Y_Hi
comma
multiline_comment|/* 4Y PCI &gt; 1Mb */
id|PCI_DEVICE_ID_CYCLOM_8Y_Lo
comma
multiline_comment|/* 8Y PCI &lt; 1Mb */
id|PCI_DEVICE_ID_CYCLOM_8Y_Hi
comma
multiline_comment|/* 8Y PCI &gt; 1Mb */
id|PCI_DEVICE_ID_CYCLOM_Z_Lo
comma
multiline_comment|/* Z PCI &lt; 1Mb */
id|PCI_DEVICE_ID_CYCLOM_Z_Hi
comma
multiline_comment|/* Z PCI &gt; 1Mb */
l_int|0
multiline_comment|/* end of table */
)brace
suffix:semicolon
macro_line|#endif
r_static
r_void
id|cy_start
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|set_line_char
c_func
(paren
r_struct
id|cyclades_port
op_star
)paren
suffix:semicolon
r_static
r_int
id|cyz_issue_cmd
c_func
(paren
r_struct
id|cyclades_card
op_star
comma
id|uclong
comma
id|ucchar
comma
id|uclong
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ISA
r_static
r_int
id|detect_isa_irq
(paren
r_volatile
id|ucchar
op_star
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_ISA */
r_static
r_int
id|cyclades_get_proc_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
op_star
comma
r_void
op_star
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_CYZ_INTR
r_static
r_void
id|cyz_poll
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* The Cyclades-Z polling cycle is defined by this variable */
DECL|variable|cyz_polling_cycle
r_static
r_int
id|cyz_polling_cycle
op_assign
id|CZ_DEF_POLL
suffix:semicolon
DECL|variable|cyz_timeron
r_static
r_int
id|cyz_timeron
op_assign
l_int|0
suffix:semicolon
DECL|variable|cyz_timerlist
r_static
r_struct
id|timer_list
id|cyz_timerlist
op_assign
(brace
id|function
suffix:colon
id|cyz_poll
)brace
suffix:semicolon
macro_line|#else /* CONFIG_CYZ_INTR */
r_static
r_void
id|cyz_rx_restart
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
DECL|variable|cyz_rx_full_timer
r_static
r_struct
id|timer_list
id|cyz_rx_full_timer
(braket
id|NR_PORTS
)braket
suffix:semicolon
macro_line|#endif /* CONFIG_CYZ_INTR */
r_static
r_inline
r_int
DECL|function|serial_paranoia_check
id|serial_paranoia_check
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
id|kdev_t
id|device
comma
r_const
r_char
op_star
id|routine
)paren
(brace
macro_line|#ifdef SERIAL_PARANOIA_CHECK
r_static
r_const
r_char
op_star
id|badmagic
op_assign
l_string|&quot;cyc Warning: bad magic number for serial struct (%s) in %s&bslash;n&quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|badinfo
op_assign
l_string|&quot;cyc Warning: null cyclades_port for (%s) in %s&bslash;n&quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|badrange
op_assign
l_string|&quot;cyc Warning: cyclades_port out of range for (%s) in %s&bslash;n&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
id|badinfo
comma
id|kdevname
c_func
(paren
id|device
)paren
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|info
OL
(paren
r_int
)paren
(paren
op_amp
id|cy_port
(braket
l_int|0
)braket
)paren
op_logical_or
(paren
r_int
)paren
(paren
op_amp
id|cy_port
(braket
id|NR_PORTS
)braket
)paren
OL
(paren
r_int
)paren
id|info
)paren
(brace
id|printk
c_func
(paren
id|badrange
comma
id|kdevname
c_func
(paren
id|device
)paren
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;magic
op_ne
id|CYCLADES_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|badmagic
comma
id|kdevname
c_func
(paren
id|device
)paren
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* serial_paranoia_check */
multiline_comment|/*&n; * This routine is used by the interrupt handler to schedule&n; * processing in the software interrupt portion of the driver&n; * (also known as the &quot;bottom half&quot;).  This can be called any&n; * number of times for any channel without harm.&n; */
r_static
r_inline
r_void
DECL|function|cy_sched_event
id|cy_sched_event
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
id|event
)paren
(brace
id|info-&gt;event
op_or_assign
l_int|1
op_lshift
id|event
suffix:semicolon
multiline_comment|/* remember what kind of event and who */
id|queue_task
c_func
(paren
op_amp
id|info-&gt;tqueue
comma
op_amp
id|tq_cyclades
)paren
suffix:semicolon
multiline_comment|/* it belongs to */
id|mark_bh
c_func
(paren
id|CYCLADES_BH
)paren
suffix:semicolon
multiline_comment|/* then trigger event */
)brace
multiline_comment|/* cy_sched_event */
multiline_comment|/*&n; * This routine is used to handle the &quot;bottom half&quot; processing for the&n; * serial driver, known also the &quot;software interrupt&quot; processing.&n; * This processing is done at the kernel interrupt level, after the&n; * cy#/_interrupt() has returned, BUT WITH INTERRUPTS TURNED ON.  This&n; * is where time-consuming activities which can not be done in the&n; * interrupt driver proper are done; the interrupt driver schedules&n; * them using cy_sched_event(), and they get done here.&n; *&n; * This is done through one level of indirection--the task queue.&n; * When a hardware interrupt service routine wants service by the&n; * driver&squot;s bottom half, it enqueues the appropriate tq_struct (one&n; * per port) to the tq_cyclades work queue and sets a request flag&n; * via mark_bh for processing that queue.  When the time is right,&n; * do_cyclades_bh is called (because of the mark_bh) and it requests&n; * that the work queue be processed.&n; *&n; * Although this may seem unwieldy, it gives the system a way to&n; * pass an argument (in this case the pointer to the cyclades_port&n; * structure) to the bottom half of the driver.  Previous kernels&n; * had to poll every port to see if that port needed servicing.&n; */
r_static
r_void
DECL|function|do_cyclades_bh
id|do_cyclades_bh
c_func
(paren
r_void
)paren
(brace
id|run_task_queue
c_func
(paren
op_amp
id|tq_cyclades
)paren
suffix:semicolon
)brace
multiline_comment|/* do_cyclades_bh */
r_static
r_void
DECL|function|do_softint
id|do_softint
c_func
(paren
r_void
op_star
id|private_
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|private_
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|Cy_EVENT_HANGUP
comma
op_amp
id|info-&gt;event
)paren
)paren
(brace
id|tty_hangup
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CALLOUT_ACTIVE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|Cy_EVENT_OPEN_WAKEUP
comma
op_amp
id|info-&gt;event
)paren
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CYZ_INTR
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|Cy_EVENT_Z_RX_FULL
comma
op_amp
id|info-&gt;event
)paren
)paren
(brace
r_if
c_cond
(paren
id|cyz_rx_full_timer
(braket
id|info-&gt;line
)braket
dot
id|function
op_eq
l_int|NULL
)paren
(brace
id|cyz_rx_full_timer
(braket
id|info-&gt;line
)braket
dot
id|expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|cyz_rx_full_timer
(braket
id|info-&gt;line
)braket
dot
id|function
op_assign
id|cyz_rx_restart
suffix:semicolon
id|cyz_rx_full_timer
(braket
id|info-&gt;line
)braket
dot
id|data
op_assign
(paren
r_int
r_int
)paren
id|info
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cyz_rx_full_timer
(braket
id|info-&gt;line
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|Cy_EVENT_DELTA_WAKEUP
comma
op_amp
id|info-&gt;event
)paren
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;delta_msr_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|Cy_EVENT_WRITE_WAKEUP
comma
op_amp
id|info-&gt;event
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(brace
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
macro_line|#ifdef Z_WAKE
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|Cy_EVENT_SHUTDOWN_WAKEUP
comma
op_amp
id|info-&gt;event
)paren
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;shutdown_wait
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* do_softint */
multiline_comment|/***********************************************************/
multiline_comment|/********* Start of block of Cyclom-Y specific code ********/
multiline_comment|/* This routine waits up to 1000 micro-seconds for the previous&n;   command to the Cirrus chip to complete and then issues the&n;   new command.  An error is returned if the previous command&n;   didn&squot;t finish within the time limit.&n;&n;   This function is only called from inside spinlock-protected code.&n; */
r_static
r_int
DECL|function|cyy_issue_cmd
id|cyy_issue_cmd
c_func
(paren
r_volatile
id|ucchar
op_star
id|base_addr
comma
id|u_char
id|cmd
comma
r_int
id|index
)paren
(brace
r_volatile
r_int
id|i
suffix:semicolon
multiline_comment|/* Check to see that the previous command has completed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|100
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyCCR
op_lshift
id|index
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10L
)paren
suffix:semicolon
)brace
multiline_comment|/* if the CCR never cleared, the previous command&n;       didn&squot;t finish within the &quot;reasonable time&quot; */
r_if
c_cond
(paren
id|i
op_eq
l_int|100
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Issue the new command */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCCR
op_lshift
id|index
)paren
comma
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* cyy_issue_cmd */
macro_line|#ifdef CONFIG_ISA
multiline_comment|/* ISA interrupt detection code */
r_static
r_int
DECL|function|detect_isa_irq
id|detect_isa_irq
(paren
r_volatile
id|ucchar
op_star
id|address
)paren
(brace
r_int
id|irq
suffix:semicolon
r_int
r_int
id|irqs
comma
id|flags
suffix:semicolon
r_int
id|save_xir
comma
id|save_car
suffix:semicolon
r_int
id|index
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* IRQ probing is only for ISA */
multiline_comment|/* forget possible initially masked and pending IRQ */
id|irq
op_assign
id|probe_irq_off
c_func
(paren
id|probe_irq_on
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear interrupts on the board first */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|address
op_plus
(paren
id|Cy_ClrIntr
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Cy_ClrIntr is 0x1800 */
id|irqs
op_assign
id|probe_irq_on
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Wait ... */
id|udelay
c_func
(paren
l_int|5000L
)paren
suffix:semicolon
multiline_comment|/* Enable the Tx interrupts on the CD1400 */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|address
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
id|cyy_issue_cmd
c_func
(paren
id|address
comma
id|CyCHAN_CTL
op_or
id|CyENB_XMTR
comma
id|index
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|address
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|address
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|address
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_or
id|CyTxRdy
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Wait ... */
id|udelay
c_func
(paren
l_int|5000L
)paren
suffix:semicolon
multiline_comment|/* Check which interrupt is in use */
id|irq
op_assign
id|probe_irq_off
c_func
(paren
id|irqs
)paren
suffix:semicolon
multiline_comment|/* Clean up */
id|save_xir
op_assign
(paren
id|u_char
)paren
id|cy_readb
c_func
(paren
id|address
op_plus
(paren
id|CyTIR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|save_car
op_assign
id|cy_readb
c_func
(paren
id|address
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|address
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|save_xir
op_amp
l_int|0x3
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|address
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|address
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyTxRdy
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|address
op_plus
(paren
id|CyTIR
op_lshift
id|index
)paren
comma
(paren
id|save_xir
op_amp
l_int|0x3f
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|address
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|save_car
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|address
op_plus
(paren
id|Cy_ClrIntr
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Cy_ClrIntr is 0x1800 */
r_return
(paren
id|irq
OG
l_int|0
)paren
ques
c_cond
id|irq
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ISA */
multiline_comment|/* The real interrupt service routine is called&n;   whenever the card wants its hand held--chars&n;   received, out buffer empty, modem change, etc.&n; */
r_static
r_void
DECL|function|cyy_interrupt
id|cyy_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|status
suffix:semicolon
r_struct
id|cyclades_card
op_star
id|cinfo
suffix:semicolon
r_struct
id|cyclades_port
op_star
id|info
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|base_addr
comma
op_star
id|card_base_addr
suffix:semicolon
r_int
id|chip
suffix:semicolon
r_int
id|save_xir
comma
id|channel
comma
id|save_car
suffix:semicolon
r_char
id|data
suffix:semicolon
r_volatile
r_int
id|char_count
suffix:semicolon
r_int
id|outch
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|index
suffix:semicolon
r_int
id|too_many
suffix:semicolon
r_int
id|had_work
suffix:semicolon
r_int
id|mdm_change
suffix:semicolon
r_int
id|mdm_status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cinfo
op_assign
(paren
r_struct
id|cyclades_card
op_star
)paren
id|dev_id
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef CY_DEBUG_INTERRUPTS
id|printk
c_func
(paren
l_string|&quot;cyy_interrupt: spurious interrupt %d&bslash;n&bslash;r&quot;
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
multiline_comment|/* spurious interrupt */
)brace
id|card_base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
id|cinfo-&gt;base_addr
suffix:semicolon
id|index
op_assign
id|cinfo-&gt;bus_index
suffix:semicolon
multiline_comment|/* This loop checks all chips in the card.  Make a note whenever&n;       _any_ chip had some work to do, as this is considered an&n;       indication that there will be more to do.  Only when no chip&n;       has any work does this outermost loop exit.&n;     */
r_do
(brace
id|had_work
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|chip
op_assign
l_int|0
suffix:semicolon
id|chip
OL
id|cinfo-&gt;num_chips
suffix:semicolon
id|chip
op_increment
)paren
(brace
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|too_many
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySVRR
op_lshift
id|index
)paren
)paren
)paren
op_ne
l_int|0x00
)paren
(brace
id|had_work
op_increment
suffix:semicolon
multiline_comment|/* The purpose of the following test is to ensure that&n;                   no chip can monopolize the driver.  This forces the&n;                   chips to be checked in a round-robin fashion (after&n;                   draining each of a bunch (1000) of characters).&n;                 */
r_if
c_cond
(paren
l_int|1000
OL
id|too_many
op_increment
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|CySRReceive
)paren
(brace
multiline_comment|/* reception interrupt */
macro_line|#ifdef CY_DEBUG_INTERRUPTS
id|printk
c_func
(paren
l_string|&quot;cyy_interrupt: rcvd intr, chip %d&bslash;n&bslash;r&quot;
comma
id|chip
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* determine the channel &amp; change to that context */
id|spin_lock
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
id|save_xir
op_assign
(paren
id|u_char
)paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRIR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|channel
op_assign
(paren
id|u_short
)paren
(paren
id|save_xir
op_amp
id|CyIRChannel
)paren
suffix:semicolon
id|i
op_assign
id|channel
op_plus
id|chip
op_star
l_int|4
op_plus
id|cinfo-&gt;first_line
suffix:semicolon
id|info
op_assign
op_amp
id|cy_port
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;last_active
op_assign
id|jiffies
suffix:semicolon
id|save_car
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
id|save_xir
)paren
suffix:semicolon
multiline_comment|/* if there is nowhere to put the data, discard it */
r_if
c_cond
(paren
id|info-&gt;tty
op_eq
l_int|0
)paren
(brace
id|j
op_assign
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRIVR
op_lshift
id|index
)paren
)paren
op_amp
id|CyIVRMask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
id|CyIVRRxEx
)paren
(brace
multiline_comment|/* exception */
id|data
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDSR
op_lshift
id|index
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* normal character reception */
id|char_count
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDCR
op_lshift
id|index
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|char_count
op_decrement
)paren
(brace
id|data
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDSR
op_lshift
id|index
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* there is an open port for this data */
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
id|j
op_assign
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRIVR
op_lshift
id|index
)paren
)paren
op_amp
id|CyIVRMask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
id|CyIVRRxEx
)paren
(brace
multiline_comment|/* exception */
id|data
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDSR
op_lshift
id|index
)paren
)paren
suffix:semicolon
multiline_comment|/* For statistics only */
r_if
c_cond
(paren
id|data
op_amp
id|CyBREAK
)paren
id|info-&gt;icount.brk
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|data
op_amp
id|CyFRAME
)paren
(brace
id|info-&gt;icount.frame
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data
op_amp
id|CyPARITY
)paren
(brace
id|info-&gt;icount.parity
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data
op_amp
id|CyOVERRUN
)paren
(brace
id|info-&gt;icount.overrun
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
op_amp
id|info-&gt;ignore_status_mask
)paren
(brace
id|info-&gt;icount.rx
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|tty-&gt;flip.count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|data
op_amp
id|info-&gt;read_status_mask
)paren
(brace
r_if
c_cond
(paren
id|data
op_amp
id|CyBREAK
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_BREAK
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDSR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SAK
)paren
(brace
id|do_SAK
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|data
op_amp
id|CyFRAME
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_FRAME
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDSR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
id|info-&gt;idle_stats.frame_errs
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data
op_amp
id|CyPARITY
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_PARITY
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDSR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
id|info-&gt;idle_stats.parity_errs
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data
op_amp
id|CyOVERRUN
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_OVERRUN
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
multiline_comment|/* If the flip buffer itself is&n;                                           overflowing, we still lose&n;                                           the next incoming character.&n;                                         */
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDSR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
)brace
id|info-&gt;idle_stats.overruns
op_increment
suffix:semicolon
multiline_comment|/* These two conditions may imply */
multiline_comment|/* a normal read should be done. */
multiline_comment|/* }else if(data &amp; CyTIMEOUT){ */
multiline_comment|/* }else if(data &amp; CySPECHAR){ */
)brace
r_else
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* there was a software buffer&n;&t;&t;&t;&t;   overrun and nothing could be&n;&t;&t;&t;&t;   done about it!!! */
id|info-&gt;icount.buf_overrun
op_increment
suffix:semicolon
id|info-&gt;idle_stats.overruns
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* normal character reception */
multiline_comment|/* load # chars available from the chip */
id|char_count
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDCR
op_lshift
id|index
)paren
)paren
suffix:semicolon
macro_line|#ifdef CY_ENABLE_MONITORING
op_increment
id|info-&gt;mon.int_count
suffix:semicolon
id|info-&gt;mon.char_count
op_add_assign
id|char_count
suffix:semicolon
r_if
c_cond
(paren
id|char_count
OG
id|info-&gt;mon.char_max
)paren
id|info-&gt;mon.char_max
op_assign
id|char_count
suffix:semicolon
id|info-&gt;mon.char_last
op_assign
id|char_count
suffix:semicolon
macro_line|#endif
id|info-&gt;idle_stats.recv_bytes
op_add_assign
id|char_count
suffix:semicolon
id|info-&gt;idle_stats.recv_idle
op_assign
id|jiffies
suffix:semicolon
r_while
c_loop
(paren
id|char_count
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
(brace
r_break
suffix:semicolon
)brace
id|tty-&gt;flip.count
op_increment
suffix:semicolon
id|data
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRDSR
op_lshift
id|index
)paren
)paren
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|data
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
macro_line|#ifdef CY_16Y_HACK
id|udelay
c_func
(paren
l_int|10L
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
id|queue_task
c_func
(paren
op_amp
id|tty-&gt;flip.tqueue
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* end of service */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyRIR
op_lshift
id|index
)paren
comma
(paren
id|save_xir
op_amp
l_int|0x3f
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|save_car
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|CySRTransmit
)paren
(brace
multiline_comment|/* transmission interrupt */
multiline_comment|/* Since we only get here when the transmit buffer&n;                       is empty, we know we can always stuff a dozen&n;                       characters. */
macro_line|#ifdef CY_DEBUG_INTERRUPTS
id|printk
c_func
(paren
l_string|&quot;cyy_interrupt: xmit intr, chip %d&bslash;n&bslash;r&quot;
comma
id|chip
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* determine the channel &amp; change to that context */
id|spin_lock
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
id|save_xir
op_assign
(paren
id|u_char
)paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyTIR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|channel
op_assign
(paren
id|u_short
)paren
(paren
id|save_xir
op_amp
id|CyIRChannel
)paren
suffix:semicolon
id|i
op_assign
id|channel
op_plus
id|chip
op_star
l_int|4
op_plus
id|cinfo-&gt;first_line
suffix:semicolon
id|save_car
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
id|save_xir
)paren
suffix:semicolon
multiline_comment|/* validate the port# (as configured and open) */
r_if
c_cond
(paren
(paren
id|i
OL
l_int|0
)paren
op_logical_or
(paren
id|NR_PORTS
op_le
id|i
)paren
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyTxRdy
)paren
suffix:semicolon
r_goto
id|txend
suffix:semicolon
)brace
id|info
op_assign
op_amp
id|cy_port
(braket
id|i
)braket
suffix:semicolon
id|info-&gt;last_active
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
op_eq
l_int|0
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyTxRdy
)paren
suffix:semicolon
r_goto
id|txdone
suffix:semicolon
)brace
multiline_comment|/* load the on-chip space for outbound data */
id|char_count
op_assign
id|info-&gt;xmit_fifo_size
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;x_char
)paren
(brace
multiline_comment|/* send special char */
id|outch
op_assign
id|info-&gt;x_char
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTDR
op_lshift
id|index
)paren
comma
id|outch
)paren
suffix:semicolon
id|char_count
op_decrement
suffix:semicolon
id|info-&gt;icount.tx
op_increment
suffix:semicolon
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;breakon
op_logical_or
id|info-&gt;breakoff
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;breakon
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTDR
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTDR
op_lshift
id|index
)paren
comma
l_int|0x81
)paren
suffix:semicolon
id|info-&gt;breakon
op_assign
l_int|0
suffix:semicolon
id|char_count
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;breakoff
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTDR
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTDR
op_lshift
id|index
)paren
comma
l_int|0x83
)paren
suffix:semicolon
id|info-&gt;breakoff
op_assign
l_int|0
suffix:semicolon
id|char_count
op_sub_assign
l_int|2
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|char_count
op_decrement
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;xmit_cnt
)paren
(brace
r_if
c_cond
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
id|CyTxMpty
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyTxMpty
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
(paren
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyTxRdy
)paren
op_or
id|CyTxMpty
)paren
)paren
suffix:semicolon
)brace
r_goto
id|txdone
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;xmit_buf
op_eq
l_int|0
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyTxRdy
)paren
suffix:semicolon
r_goto
id|txdone
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tty-&gt;stopped
op_logical_or
id|info-&gt;tty-&gt;hw_stopped
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyTxRdy
)paren
suffix:semicolon
r_goto
id|txdone
suffix:semicolon
)brace
multiline_comment|/* Because the Embedded Transmit Commands have&n;                           been enabled, we must check to see if the&n;&t;&t;&t;   escape character, NULL, is being sent.  If it&n;&t;&t;&t;   is, we must ensure that there is room for it&n;&t;&t;&t;   to be doubled in the output stream.  Therefore&n;&t;&t;&t;   we no longer advance the pointer when the&n;&t;&t;&t;   character is fetched, but rather wait until&n;&t;&t;&t;   after the check for a NULL output character.&n;&t;&t;&t;   This is necessary because there may not be&n;&t;&t;&t;   room for the two chars needed to send a NULL.)&n;                         */
id|outch
op_assign
id|info-&gt;xmit_buf
(braket
id|info-&gt;xmit_tail
)braket
suffix:semicolon
r_if
c_cond
(paren
id|outch
)paren
(brace
id|info-&gt;xmit_cnt
op_decrement
suffix:semicolon
id|info-&gt;xmit_tail
op_assign
(paren
id|info-&gt;xmit_tail
op_plus
l_int|1
)paren
op_amp
(paren
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTDR
op_lshift
id|index
)paren
comma
id|outch
)paren
suffix:semicolon
id|info-&gt;icount.tx
op_increment
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|char_count
OG
l_int|1
)paren
(brace
id|info-&gt;xmit_cnt
op_decrement
suffix:semicolon
id|info-&gt;xmit_tail
op_assign
(paren
id|info-&gt;xmit_tail
op_plus
l_int|1
)paren
op_amp
(paren
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTDR
op_lshift
id|index
)paren
comma
id|outch
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTDR
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
id|info-&gt;icount.tx
op_increment
suffix:semicolon
id|char_count
op_decrement
suffix:semicolon
)brace
r_else
(brace
)brace
)brace
)brace
id|txdone
suffix:colon
r_if
c_cond
(paren
id|info-&gt;xmit_cnt
OL
id|WAKEUP_CHARS
)paren
(brace
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_WRITE_WAKEUP
)paren
suffix:semicolon
)brace
id|txend
suffix:colon
multiline_comment|/* end of service */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTIR
op_lshift
id|index
)paren
comma
(paren
id|save_xir
op_amp
l_int|0x3f
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|save_car
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|CySRModem
)paren
(brace
multiline_comment|/* modem interrupt */
multiline_comment|/* determine the channel &amp; change to that context */
id|spin_lock
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
id|save_xir
op_assign
(paren
id|u_char
)paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMIR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|channel
op_assign
(paren
id|u_short
)paren
(paren
id|save_xir
op_amp
id|CyIRChannel
)paren
suffix:semicolon
id|info
op_assign
op_amp
id|cy_port
(braket
id|channel
op_plus
id|chip
op_star
l_int|4
op_plus
id|cinfo-&gt;first_line
)braket
suffix:semicolon
id|info-&gt;last_active
op_assign
id|jiffies
suffix:semicolon
id|save_car
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
id|save_xir
)paren
suffix:semicolon
id|mdm_change
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMISR
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|mdm_status
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
op_eq
l_int|0
)paren
(brace
multiline_comment|/* no place for data, ignore it*/
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mdm_change
op_amp
id|CyANY_DELTA
)paren
(brace
multiline_comment|/* For statistics only */
r_if
c_cond
(paren
id|mdm_change
op_amp
id|CyDCD
)paren
id|info-&gt;icount.dcd
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mdm_change
op_amp
id|CyCTS
)paren
id|info-&gt;icount.cts
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mdm_change
op_amp
id|CyDSR
)paren
id|info-&gt;icount.dsr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mdm_change
op_amp
id|CyRI
)paren
id|info-&gt;icount.rng
op_increment
suffix:semicolon
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_DELTA_WAKEUP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mdm_change
op_amp
id|CyDCD
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CHECK_CD
)paren
)paren
(brace
r_if
c_cond
(paren
id|mdm_status
op_amp
id|CyDCD
)paren
(brace
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_OPEN_WAKEUP
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_NOHUP
)paren
)paren
)paren
(brace
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_HANGUP
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|mdm_change
op_amp
id|CyCTS
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CTS_FLOW
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tty-&gt;hw_stopped
)paren
(brace
r_if
c_cond
(paren
id|mdm_status
op_amp
id|CyCTS
)paren
(brace
multiline_comment|/* cy_start isn&squot;t used&n;&t;&t;&t;&t;         because... !!! */
id|info-&gt;tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_or
id|CyTxRdy
)paren
suffix:semicolon
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_WRITE_WAKEUP
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|mdm_status
op_amp
id|CyCTS
)paren
)paren
(brace
multiline_comment|/* cy_stop isn&squot;t used&n;&t;&t;&t;&t;         because ... !!! */
id|info-&gt;tty-&gt;hw_stopped
op_assign
l_int|1
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyTxRdy
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|mdm_change
op_amp
id|CyDSR
)paren
(brace
)brace
r_if
c_cond
(paren
id|mdm_change
op_amp
id|CyRI
)paren
(brace
)brace
)brace
multiline_comment|/* end of service */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMIR
op_lshift
id|index
)paren
comma
(paren
id|save_xir
op_amp
l_int|0x3f
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
id|save_car
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end while status != 0 */
)brace
multiline_comment|/* end loop for chips... */
)brace
r_while
c_loop
(paren
id|had_work
)paren
(brace
suffix:semicolon
)brace
multiline_comment|/* clear interrupts */
id|spin_lock
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|card_base_addr
op_plus
(paren
id|Cy_ClrIntr
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Cy_ClrIntr is 0x1800 */
id|spin_unlock
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* cyy_interrupt */
multiline_comment|/***********************************************************/
multiline_comment|/********* End of block of Cyclom-Y specific code **********/
multiline_comment|/******** Start of block of Cyclades-Z specific code *********/
multiline_comment|/***********************************************************/
r_static
r_int
DECL|function|cyz_fetch_msg
id|cyz_fetch_msg
c_func
(paren
r_struct
id|cyclades_card
op_star
id|cinfo
comma
id|uclong
op_star
id|channel
comma
id|ucchar
op_star
id|cmd
comma
id|uclong
op_star
id|param
)paren
(brace
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_int
r_int
id|loc_doorbell
suffix:semicolon
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISZLOADED
c_func
(paren
op_star
id|cinfo
)paren
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
id|zfw_ctrl-&gt;board_ctrl
suffix:semicolon
id|loc_doorbell
op_assign
id|cy_readl
c_func
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
(paren
id|cinfo-&gt;ctl_addr
)paren
)paren
op_member_access_from_pointer
id|loc_doorbell
)paren
suffix:semicolon
r_if
c_cond
(paren
id|loc_doorbell
)paren
(brace
op_star
id|cmd
op_assign
(paren
r_char
)paren
(paren
l_int|0xff
op_amp
id|loc_doorbell
)paren
suffix:semicolon
op_star
id|channel
op_assign
id|cy_readl
c_func
(paren
op_amp
id|board_ctrl-&gt;fwcmd_channel
)paren
suffix:semicolon
op_star
id|param
op_assign
(paren
id|uclong
)paren
id|cy_readl
c_func
(paren
op_amp
id|board_ctrl-&gt;fwcmd_param
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
(paren
id|cinfo-&gt;ctl_addr
)paren
)paren
op_member_access_from_pointer
id|loc_doorbell
comma
l_int|0xffffffff
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* cyz_fetch_msg */
r_static
r_int
DECL|function|cyz_issue_cmd
id|cyz_issue_cmd
c_func
(paren
r_struct
id|cyclades_card
op_star
id|cinfo
comma
id|uclong
id|channel
comma
id|ucchar
id|cmd
comma
id|uclong
id|param
)paren
(brace
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_volatile
id|uclong
op_star
id|pci_doorbell
suffix:semicolon
r_int
id|index
suffix:semicolon
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISZLOADED
c_func
(paren
op_star
id|cinfo
)paren
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
id|zfw_ctrl-&gt;board_ctrl
suffix:semicolon
id|index
op_assign
l_int|0
suffix:semicolon
id|pci_doorbell
op_assign
(paren
id|uclong
op_star
)paren
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
(paren
id|cinfo-&gt;ctl_addr
)paren
)paren
op_member_access_from_pointer
id|pci_doorbell
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|cy_readl
c_func
(paren
id|pci_doorbell
)paren
op_amp
l_int|0xff
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|index
op_increment
op_eq
l_int|1000
)paren
(brace
r_return
(paren
r_int
)paren
(paren
id|cy_readl
c_func
(paren
id|pci_doorbell
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|50L
)paren
suffix:semicolon
)brace
id|cy_writel
c_func
(paren
(paren
id|u_long
)paren
op_amp
id|board_ctrl-&gt;hcmd_channel
comma
id|channel
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
(paren
id|u_long
)paren
op_amp
id|board_ctrl-&gt;hcmd_param
comma
id|param
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
(paren
id|u_long
)paren
id|pci_doorbell
comma
(paren
r_int
)paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* cyz_issue_cmd */
r_static
r_void
DECL|function|cyz_handle_rx
id|cyz_handle_rx
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_volatile
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
comma
r_volatile
r_struct
id|BUF_CTRL
op_star
id|buf_ctrl
)paren
(brace
r_struct
id|cyclades_card
op_star
id|cinfo
op_assign
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_volatile
r_int
id|char_count
suffix:semicolon
macro_line|#ifdef BLOCKMOVE
r_int
id|small_count
suffix:semicolon
macro_line|#else
r_char
id|data
suffix:semicolon
macro_line|#endif
r_volatile
id|uclong
id|rx_put
comma
id|rx_get
comma
id|new_rx_get
comma
id|rx_bufsize
comma
id|rx_bufaddr
suffix:semicolon
id|rx_get
op_assign
id|new_rx_get
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;rx_get
)paren
suffix:semicolon
id|rx_put
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;rx_put
)paren
suffix:semicolon
id|rx_bufsize
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;rx_bufsize
)paren
suffix:semicolon
id|rx_bufaddr
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;rx_bufaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx_put
op_ge
id|rx_get
)paren
id|char_count
op_assign
id|rx_put
op_minus
id|rx_get
suffix:semicolon
r_else
id|char_count
op_assign
id|rx_put
op_minus
id|rx_get
op_plus
id|rx_bufsize
suffix:semicolon
r_if
c_cond
(paren
id|char_count
)paren
(brace
id|info-&gt;last_active
op_assign
id|jiffies
suffix:semicolon
id|info-&gt;jiffies
(braket
l_int|1
)braket
op_assign
id|jiffies
suffix:semicolon
macro_line|#ifdef CY_ENABLE_MONITORING
id|info-&gt;mon.int_count
op_increment
suffix:semicolon
id|info-&gt;mon.char_count
op_add_assign
id|char_count
suffix:semicolon
r_if
c_cond
(paren
id|char_count
OG
id|info-&gt;mon.char_max
)paren
id|info-&gt;mon.char_max
op_assign
id|char_count
suffix:semicolon
id|info-&gt;mon.char_last
op_assign
id|char_count
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tty
op_eq
l_int|0
)paren
(brace
multiline_comment|/* flush received characters */
id|new_rx_get
op_assign
(paren
id|new_rx_get
op_plus
id|char_count
)paren
op_amp
(paren
id|rx_bufsize
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;rflush_count
op_increment
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef BLOCKMOVE
multiline_comment|/* we&squot;d like to use memcpy(t, f, n) and memset(s, c, count)&n;&t;       for performance, but because of buffer boundaries, there&n;&t;       may be several steps to the operation */
r_while
c_loop
(paren
l_int|0
OL
(paren
id|small_count
op_assign
id|cy_min
c_func
(paren
(paren
id|rx_bufsize
op_minus
id|new_rx_get
)paren
comma
id|cy_min
c_func
(paren
(paren
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
)paren
comma
id|char_count
)paren
)paren
)paren
)paren
(brace
id|memcpy_fromio
c_func
(paren
id|tty-&gt;flip.char_buf_ptr
comma
(paren
r_char
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
id|rx_bufaddr
op_plus
id|new_rx_get
)paren
comma
id|small_count
)paren
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|small_count
suffix:semicolon
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
id|TTY_NORMAL
comma
id|small_count
)paren
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|small_count
suffix:semicolon
id|new_rx_get
op_assign
(paren
id|new_rx_get
op_plus
id|small_count
)paren
op_amp
(paren
id|rx_bufsize
op_minus
l_int|1
)paren
suffix:semicolon
id|char_count
op_sub_assign
id|small_count
suffix:semicolon
id|info-&gt;icount.rx
op_add_assign
id|small_count
suffix:semicolon
id|info-&gt;idle_stats.recv_bytes
op_add_assign
id|small_count
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|small_count
suffix:semicolon
)brace
macro_line|#else
r_while
c_loop
(paren
id|char_count
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
(brace
r_break
suffix:semicolon
)brace
id|data
op_assign
id|cy_readb
c_func
(paren
id|cinfo-&gt;base_addr
op_plus
id|rx_bufaddr
op_plus
id|new_rx_get
)paren
suffix:semicolon
id|new_rx_get
op_assign
(paren
id|new_rx_get
op_plus
l_int|1
)paren
op_amp
(paren
id|rx_bufsize
op_minus
l_int|1
)paren
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|data
suffix:semicolon
id|info-&gt;idle_stats.recv_bytes
op_increment
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_CYZ_INTR
multiline_comment|/* Recalculate the number of chars in the RX buffer and issue&n;&t;       a cmd in case it&squot;s higher than the RX high water mark */
id|rx_put
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;rx_put
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx_put
op_ge
id|rx_get
)paren
id|char_count
op_assign
id|rx_put
op_minus
id|rx_get
suffix:semicolon
r_else
id|char_count
op_assign
id|rx_put
op_minus
id|rx_get
op_plus
id|rx_bufsize
suffix:semicolon
r_if
c_cond
(paren
id|char_count
op_ge
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;rx_threshold
)paren
)paren
(brace
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_Z_RX_FULL
)paren
suffix:semicolon
)brace
macro_line|#endif
id|info-&gt;idle_stats.recv_idle
op_assign
id|jiffies
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tty-&gt;flip.tqueue
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Update rx_get */
id|cy_writel
c_func
(paren
op_amp
id|buf_ctrl-&gt;rx_get
comma
id|new_rx_get
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|cyz_handle_tx
id|cyz_handle_tx
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_volatile
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
comma
r_volatile
r_struct
id|BUF_CTRL
op_star
id|buf_ctrl
)paren
(brace
r_struct
id|cyclades_card
op_star
id|cinfo
op_assign
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_char
id|data
suffix:semicolon
r_volatile
r_int
id|char_count
suffix:semicolon
macro_line|#ifdef BLOCKMOVE
r_int
id|small_count
suffix:semicolon
macro_line|#endif
r_volatile
id|uclong
id|tx_put
comma
id|tx_get
comma
id|tx_bufsize
comma
id|tx_bufaddr
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;xmit_cnt
op_le
l_int|0
)paren
multiline_comment|/* Nothing to transmit */
r_return
suffix:semicolon
id|tx_get
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;tx_get
)paren
suffix:semicolon
id|tx_put
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;tx_put
)paren
suffix:semicolon
id|tx_bufsize
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;tx_bufsize
)paren
suffix:semicolon
id|tx_bufaddr
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;tx_bufaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_put
op_ge
id|tx_get
)paren
id|char_count
op_assign
id|tx_get
op_minus
id|tx_put
op_minus
l_int|1
op_plus
id|tx_bufsize
suffix:semicolon
r_else
id|char_count
op_assign
id|tx_get
op_minus
id|tx_put
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|char_count
)paren
(brace
r_if
c_cond
(paren
id|tty
op_eq
l_int|0
)paren
(brace
r_goto
id|ztxdone
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;x_char
)paren
(brace
multiline_comment|/* send special char */
id|data
op_assign
id|info-&gt;x_char
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|cinfo-&gt;base_addr
op_plus
id|tx_bufaddr
op_plus
id|tx_put
)paren
comma
id|data
)paren
suffix:semicolon
id|tx_put
op_assign
(paren
id|tx_put
op_plus
l_int|1
)paren
op_amp
(paren
id|tx_bufsize
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
id|char_count
op_decrement
suffix:semicolon
id|info-&gt;icount.tx
op_increment
suffix:semicolon
id|info-&gt;last_active
op_assign
id|jiffies
suffix:semicolon
id|info-&gt;jiffies
(braket
l_int|2
)braket
op_assign
id|jiffies
suffix:semicolon
)brace
macro_line|#ifdef BLOCKMOVE
r_while
c_loop
(paren
l_int|0
OL
(paren
id|small_count
op_assign
id|cy_min
c_func
(paren
(paren
id|tx_bufsize
op_minus
id|tx_put
)paren
comma
id|cy_min
(paren
(paren
id|SERIAL_XMIT_SIZE
op_minus
id|info-&gt;xmit_tail
)paren
comma
id|cy_min
c_func
(paren
id|info-&gt;xmit_cnt
comma
id|char_count
)paren
)paren
)paren
)paren
)paren
(brace
id|memcpy_toio
c_func
(paren
(paren
r_char
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
id|tx_bufaddr
op_plus
id|tx_put
)paren
comma
op_amp
id|info-&gt;xmit_buf
(braket
id|info-&gt;xmit_tail
)braket
comma
id|small_count
)paren
suffix:semicolon
id|tx_put
op_assign
(paren
id|tx_put
op_plus
id|small_count
)paren
op_amp
(paren
id|tx_bufsize
op_minus
l_int|1
)paren
suffix:semicolon
id|char_count
op_sub_assign
id|small_count
suffix:semicolon
id|info-&gt;icount.tx
op_add_assign
id|small_count
suffix:semicolon
id|info-&gt;xmit_cnt
op_sub_assign
id|small_count
suffix:semicolon
id|info-&gt;xmit_tail
op_assign
(paren
id|info-&gt;xmit_tail
op_plus
id|small_count
)paren
op_amp
(paren
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;last_active
op_assign
id|jiffies
suffix:semicolon
id|info-&gt;jiffies
(braket
l_int|2
)braket
op_assign
id|jiffies
suffix:semicolon
)brace
macro_line|#else
r_while
c_loop
(paren
id|info-&gt;xmit_cnt
op_logical_and
id|char_count
)paren
(brace
id|data
op_assign
id|info-&gt;xmit_buf
(braket
id|info-&gt;xmit_tail
)braket
suffix:semicolon
id|info-&gt;xmit_cnt
op_decrement
suffix:semicolon
id|info-&gt;xmit_tail
op_assign
(paren
id|info-&gt;xmit_tail
op_plus
l_int|1
)paren
op_amp
(paren
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
id|cinfo-&gt;base_addr
op_plus
id|tx_bufaddr
op_plus
id|tx_put
comma
id|data
)paren
suffix:semicolon
id|tx_put
op_assign
(paren
id|tx_put
op_plus
l_int|1
)paren
op_amp
(paren
id|tx_bufsize
op_minus
l_int|1
)paren
suffix:semicolon
id|char_count
op_decrement
suffix:semicolon
id|info-&gt;icount.tx
op_increment
suffix:semicolon
id|info-&gt;last_active
op_assign
id|jiffies
suffix:semicolon
id|info-&gt;jiffies
(braket
l_int|2
)braket
op_assign
id|jiffies
suffix:semicolon
)brace
macro_line|#endif
id|ztxdone
suffix:colon
r_if
c_cond
(paren
id|info-&gt;xmit_cnt
OL
id|WAKEUP_CHARS
)paren
(brace
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_WRITE_WAKEUP
)paren
suffix:semicolon
)brace
multiline_comment|/* Update tx_put */
id|cy_writel
c_func
(paren
op_amp
id|buf_ctrl-&gt;tx_put
comma
id|tx_put
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|cyz_handle_cmd
id|cyz_handle_cmd
c_func
(paren
r_struct
id|cyclades_card
op_star
id|cinfo
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_struct
id|cyclades_port
op_star
id|info
suffix:semicolon
r_static
r_volatile
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_static
r_volatile
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_static
r_volatile
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_static
r_volatile
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
suffix:semicolon
r_static
r_volatile
r_struct
id|BUF_CTRL
op_star
id|buf_ctrl
suffix:semicolon
id|uclong
id|channel
suffix:semicolon
id|ucchar
id|cmd
suffix:semicolon
id|uclong
id|param
suffix:semicolon
id|uclong
id|hw_ver
comma
id|fw_ver
suffix:semicolon
r_int
id|special_count
suffix:semicolon
r_int
id|delta_count
suffix:semicolon
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;board_ctrl
)paren
suffix:semicolon
id|fw_ver
op_assign
id|cy_readl
c_func
(paren
op_amp
id|board_ctrl-&gt;fw_version
)paren
suffix:semicolon
id|hw_ver
op_assign
id|cy_readl
c_func
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
(paren
id|cinfo-&gt;ctl_addr
)paren
)paren
op_member_access_from_pointer
id|mail_box_0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_CYZ_INTR
r_if
c_cond
(paren
op_logical_neg
id|cinfo-&gt;nports
)paren
id|cinfo-&gt;nports
op_assign
(paren
r_int
)paren
id|cy_readl
c_func
(paren
op_amp
id|board_ctrl-&gt;n_channel
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|cyz_fetch_msg
c_func
(paren
id|cinfo
comma
op_amp
id|channel
comma
op_amp
id|cmd
comma
op_amp
id|param
)paren
op_eq
l_int|1
)paren
(brace
id|special_count
op_assign
l_int|0
suffix:semicolon
id|delta_count
op_assign
l_int|0
suffix:semicolon
id|info
op_assign
op_amp
id|cy_port
(braket
id|channel
op_plus
id|cinfo-&gt;first_line
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty
op_assign
id|info-&gt;tty
)paren
op_eq
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|ch_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;ch_ctrl
(braket
id|channel
)braket
)paren
suffix:semicolon
id|buf_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;buf_ctrl
(braket
id|channel
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|C_CM_PR_ERROR
suffix:colon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_PARITY
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
id|special_count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C_CM_FR_ERROR
suffix:colon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_FRAME
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
id|special_count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C_CM_RXBRK
suffix:colon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_BREAK
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.rx
op_increment
suffix:semicolon
id|special_count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C_CM_MDCD
suffix:colon
id|info-&gt;icount.dcd
op_increment
suffix:semicolon
id|delta_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CHECK_CD
)paren
(brace
r_if
c_cond
(paren
(paren
id|fw_ver
OG
l_int|241
ques
c_cond
(paren
(paren
id|u_long
)paren
id|param
)paren
suffix:colon
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl-&gt;rs_status
)paren
)paren
op_amp
id|C_RS_DCD
)paren
(brace
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_OPEN_WAKEUP
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_NOHUP
)paren
)paren
)paren
(brace
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_HANGUP
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|C_CM_MCTS
suffix:colon
id|info-&gt;icount.cts
op_increment
suffix:semicolon
id|delta_count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C_CM_MRI
suffix:colon
id|info-&gt;icount.rng
op_increment
suffix:semicolon
id|delta_count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C_CM_MDSR
suffix:colon
id|info-&gt;icount.dsr
op_increment
suffix:semicolon
id|delta_count
op_increment
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef Z_WAKE
r_case
id|C_CM_IOCTLW
suffix:colon
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_SHUTDOWN_WAKEUP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_CYZ_INTR
r_case
id|C_CM_RXHIWM
suffix:colon
r_case
id|C_CM_RXNNDT
suffix:colon
r_case
id|C_CM_INTBACK2
suffix:colon
multiline_comment|/* Reception Interrupt */
macro_line|#ifdef CY_DEBUG_INTERRUPTS
id|printk
c_func
(paren
l_string|&quot;cyz_interrupt: rcvd intr, card %d, port %ld&bslash;n&bslash;r&quot;
comma
id|info-&gt;card
comma
id|channel
)paren
suffix:semicolon
macro_line|#endif
id|cyz_handle_rx
c_func
(paren
id|info
comma
id|ch_ctrl
comma
id|buf_ctrl
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|C_CM_TXBEMPTY
suffix:colon
r_case
id|C_CM_TXLOWWM
suffix:colon
r_case
id|C_CM_INTBACK
suffix:colon
multiline_comment|/* Transmission Interrupt */
macro_line|#ifdef CY_DEBUG_INTERRUPTS
id|printk
c_func
(paren
l_string|&quot;cyz_interrupt: xmit intr, card %d, port %ld&bslash;n&bslash;r&quot;
comma
id|info-&gt;card
comma
id|channel
)paren
suffix:semicolon
macro_line|#endif
id|cyz_handle_tx
c_func
(paren
id|info
comma
id|ch_ctrl
comma
id|buf_ctrl
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_CYZ_INTR */
r_case
id|C_CM_FATAL
suffix:colon
multiline_comment|/* should do something with this !!! */
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|delta_count
)paren
(brace
id|cy_sched_event
c_func
(paren
id|info
comma
id|Cy_EVENT_DELTA_WAKEUP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|special_count
)paren
(brace
id|queue_task
c_func
(paren
op_amp
id|tty-&gt;flip.tqueue
comma
op_amp
id|tq_timer
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef CONFIG_CYZ_INTR
r_static
r_void
DECL|function|cyz_interrupt
id|cyz_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|cyclades_card
op_star
id|cinfo
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cinfo
op_assign
(paren
r_struct
id|cyclades_card
op_star
)paren
id|dev_id
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef CY_DEBUG_INTERRUPTS
id|printk
c_func
(paren
l_string|&quot;cyz_interrupt: spurious interrupt %d&bslash;n&bslash;r&quot;
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
multiline_comment|/* spurious interrupt */
)brace
r_if
c_cond
(paren
op_logical_neg
id|ISZLOADED
c_func
(paren
op_star
id|cinfo
)paren
)paren
(brace
macro_line|#ifdef CY_DEBUG_INTERRUPTS
id|printk
c_func
(paren
l_string|&quot;cyz_interrupt: board not yet loaded (IRQ%d).&bslash;n&bslash;r&quot;
comma
id|irq
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* Handle the interrupts */
id|cyz_handle_cmd
c_func
(paren
id|cinfo
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* cyz_interrupt */
r_static
r_void
DECL|function|cyz_rx_restart
id|cyz_rx_restart
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|arg
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|uclong
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|card
)braket
comma
id|channel
comma
id|C_CM_INTBACK2
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:cyz_rx_restart retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
id|cyz_rx_full_timer
(braket
id|info-&gt;line
)braket
dot
id|function
op_assign
l_int|NULL
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#else /* CONFIG_CYZ_INTR */
r_static
r_void
DECL|function|cyz_poll
id|cyz_poll
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|cyclades_card
op_star
id|cinfo
suffix:semicolon
r_struct
id|cyclades_port
op_star
id|info
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_static
r_volatile
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_static
r_volatile
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_static
r_volatile
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_static
r_volatile
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
suffix:semicolon
r_static
r_volatile
r_struct
id|BUF_CTRL
op_star
id|buf_ctrl
suffix:semicolon
r_int
id|card
comma
id|port
suffix:semicolon
id|cyz_timerlist.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
)paren
suffix:semicolon
r_for
c_loop
(paren
id|card
op_assign
l_int|0
suffix:semicolon
id|card
OL
id|NR_CARDS
suffix:semicolon
id|card
op_increment
)paren
(brace
id|cinfo
op_assign
op_amp
id|cy_card
(braket
id|card
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
op_star
id|cinfo
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISZLOADED
c_func
(paren
op_star
id|cinfo
)paren
)paren
r_continue
suffix:semicolon
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;board_ctrl
)paren
suffix:semicolon
multiline_comment|/* Skip first polling cycle to avoid racing conditions with the FW */
r_if
c_cond
(paren
op_logical_neg
id|cinfo-&gt;intr_enabled
)paren
(brace
id|cinfo-&gt;nports
op_assign
(paren
r_int
)paren
id|cy_readl
c_func
(paren
op_amp
id|board_ctrl-&gt;n_channel
)paren
suffix:semicolon
id|cinfo-&gt;intr_enabled
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|cyz_handle_cmd
c_func
(paren
id|cinfo
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
id|cinfo-&gt;nports
suffix:semicolon
id|port
op_increment
)paren
(brace
id|info
op_assign
op_amp
id|cy_port
(braket
id|port
op_plus
id|cinfo-&gt;first_line
)braket
suffix:semicolon
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
id|ch_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;ch_ctrl
(braket
id|port
)braket
)paren
suffix:semicolon
id|buf_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;buf_ctrl
(braket
id|port
)braket
)paren
suffix:semicolon
id|cyz_handle_rx
c_func
(paren
id|info
comma
id|ch_ctrl
comma
id|buf_ctrl
)paren
suffix:semicolon
id|cyz_handle_tx
c_func
(paren
id|info
comma
id|ch_ctrl
comma
id|buf_ctrl
)paren
suffix:semicolon
)brace
multiline_comment|/* poll every &squot;cyz_polling_cycle&squot; period */
id|cyz_timerlist.expires
op_assign
id|jiffies
op_plus
id|cyz_polling_cycle
suffix:semicolon
)brace
id|add_timer
c_func
(paren
op_amp
id|cyz_timerlist
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* cyz_poll */
macro_line|#endif /* CONFIG_CYZ_INTR */
multiline_comment|/********** End of block of Cyclades-Z specific code *********/
multiline_comment|/***********************************************************/
multiline_comment|/* This is called whenever a port becomes active;&n;   interrupts are enabled and DTR &amp; RTS are turned on.&n; */
r_static
r_int
DECL|function|startup
id|startup
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_int
r_int
id|page
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
id|page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
(brace
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;type
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tty
)paren
(brace
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
)brace
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;xmit_buf
)paren
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_else
id|info-&gt;xmit_buf
op_assign
(paren
r_int
r_char
op_star
)paren
id|page
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|set_line_char
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc startup card %d, chip %d, channel %d, base_addr %lx&bslash;n&quot;
comma
id|card
comma
id|chip
comma
id|channel
comma
(paren
r_int
)paren
id|base_addr
)paren
suffix:semicolon
multiline_comment|/**/
macro_line|#endif
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|ulong
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|ulong
)paren
id|base_addr
op_plus
(paren
id|CyRTPR
op_lshift
id|index
)paren
comma
(paren
id|info-&gt;default_timeout
ques
c_cond
id|info-&gt;default_timeout
suffix:colon
l_int|0x02
)paren
)paren
suffix:semicolon
multiline_comment|/* 10ms rx timeout */
id|cyy_issue_cmd
c_func
(paren
id|base_addr
comma
id|CyCHAN_CTL
op_or
id|CyENB_RCVR
op_or
id|CyENB_XMTR
comma
id|index
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|ulong
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|ulong
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
id|CyRTS
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|ulong
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
id|CyDTR
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:startup raising DTR&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;     status: 0x%x, 0x%x&bslash;n&quot;
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_or
id|CyRxData
)paren
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ASYNC_INITIALIZED
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
(brace
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
)brace
id|info-&gt;xmit_cnt
op_assign
id|info-&gt;xmit_head
op_assign
id|info-&gt;xmit_tail
op_assign
l_int|0
suffix:semicolon
id|info-&gt;breakon
op_assign
id|info-&gt;breakoff
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|info-&gt;idle_stats
comma
l_int|0
comma
r_sizeof
(paren
id|info-&gt;idle_stats
)paren
)paren
suffix:semicolon
id|info-&gt;idle_stats.in_use
op_assign
id|info-&gt;idle_stats.recv_idle
op_assign
id|info-&gt;idle_stats.xmit_idle
op_assign
id|jiffies
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
)paren
suffix:semicolon
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISZLOADED
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
id|zfw_ctrl-&gt;board_ctrl
suffix:semicolon
id|ch_ctrl
op_assign
id|zfw_ctrl-&gt;ch_ctrl
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc startup Z card %d, channel %d, base_addr %lx&bslash;n&quot;
comma
id|card
comma
id|channel
comma
(paren
r_int
)paren
id|base_addr
)paren
suffix:semicolon
multiline_comment|/**/
macro_line|#endif
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|op_mode
comma
id|C_CH_ENABLE
)paren
suffix:semicolon
macro_line|#ifdef Z_WAKE
macro_line|#ifdef CONFIG_CYZ_INTR
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|intr_enable
comma
id|C_IN_TXBEMPTY
op_or
id|C_IN_TXLOWWM
op_or
id|C_IN_RXHIWM
op_or
id|C_IN_RXNNDT
op_or
id|C_IN_IOCTLW
op_or
id|C_IN_MDCD
)paren
suffix:semicolon
macro_line|#else
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|intr_enable
comma
id|C_IN_IOCTLW
op_or
id|C_IN_MDCD
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_CYZ_INTR */
macro_line|#else
macro_line|#ifdef CONFIG_CYZ_INTR
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|intr_enable
comma
id|C_IN_TXBEMPTY
op_or
id|C_IN_TXLOWWM
op_or
id|C_IN_RXHIWM
op_or
id|C_IN_RXNNDT
op_or
id|C_IN_MDCD
)paren
suffix:semicolon
macro_line|#else
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|intr_enable
comma
id|C_IN_MDCD
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_CYZ_INTR */
macro_line|#endif /* Z_WAKE */
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|card
)braket
comma
id|channel
comma
id|C_CM_IOCTL
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:startup(1) retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
multiline_comment|/* Flush RX buffers before raising DTR and RTS */
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|card
)braket
comma
id|channel
comma
id|C_CM_FLUSH_RX
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:startup(2) retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
multiline_comment|/* set timeout !!! */
multiline_comment|/* set RTS and DTR !!! */
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_or
id|C_RS_RTS
op_or
id|C_RS_DTR
)paren
suffix:semicolon
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
comma
id|channel
comma
id|C_CM_IOCTLM
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:startup(3) retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:startup raising Z DTR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* enable send, recv, modem !!! */
id|info-&gt;flags
op_or_assign
id|ASYNC_INITIALIZED
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
(brace
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
)brace
id|info-&gt;xmit_cnt
op_assign
id|info-&gt;xmit_head
op_assign
id|info-&gt;xmit_tail
op_assign
l_int|0
suffix:semicolon
id|info-&gt;breakon
op_assign
id|info-&gt;breakoff
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|info-&gt;idle_stats
comma
l_int|0
comma
r_sizeof
(paren
id|info-&gt;idle_stats
)paren
)paren
suffix:semicolon
id|info-&gt;idle_stats.in_use
op_assign
id|info-&gt;idle_stats.recv_idle
op_assign
id|info-&gt;idle_stats.xmit_idle
op_assign
id|jiffies
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot; cyc startup done&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
id|errout
suffix:colon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* startup */
r_static
r_void
DECL|function|start_xmit
id|start_xmit
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
id|channel
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_or
id|CyTxRdy
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef CONFIG_CYZ_INTR
r_int
id|retval
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|card
)braket
comma
id|channel
comma
id|C_CM_INTBACK
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:start_xmit retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
macro_line|#else /* CONFIG_CYZ_INTR */
multiline_comment|/* Don&squot;t have to do anything at this time */
macro_line|#endif /* CONFIG_CYZ_INTR */
)brace
)brace
multiline_comment|/* start_xmit */
multiline_comment|/*&n; * This routine shuts down a serial port; interrupts are disabled,&n; * and DTR is dropped if the hangup on close termio flag is on.&n; */
r_static
r_void
DECL|function|shutdown
id|shutdown
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cy_card
(braket
id|card
)braket
dot
id|first_line
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc shutdown Y card %d, chip %d, channel %d, base_addr %lx&bslash;n&quot;
comma
id|card
comma
id|chip
comma
id|channel
comma
(paren
r_int
)paren
id|base_addr
)paren
suffix:semicolon
macro_line|#endif
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Clear delta_msr_wait queue to avoid mem leaks. */
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;delta_msr_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;xmit_buf
)paren
(brace
r_int
r_char
op_star
id|temp
suffix:semicolon
id|temp
op_assign
id|info-&gt;xmit_buf
suffix:semicolon
id|info-&gt;xmit_buf
op_assign
l_int|0
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|temp
)paren
suffix:semicolon
)brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
(paren
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
op_complement
id|CyRTS
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
op_complement
id|CyDTR
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc shutdown dropping DTR&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;     status: 0x%x, 0x%x&bslash;n&quot;
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
id|cyy_issue_cmd
c_func
(paren
id|base_addr
comma
id|CyCHAN_CTL
op_or
id|CyDIS_RCVR
comma
id|index
)paren
suffix:semicolon
multiline_comment|/* it may be appropriate to clear _XMIT at&n;&t;       some later date (after testing)!!! */
r_if
c_cond
(paren
id|info-&gt;tty
)paren
(brace
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
)brace
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_INITIALIZED
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc shutdown Z card %d, channel %d, base_addr %lx&bslash;n&quot;
comma
id|card
comma
id|channel
comma
(paren
r_int
)paren
id|base_addr
)paren
suffix:semicolon
macro_line|#endif
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISZLOADED
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;board_ctrl
)paren
suffix:semicolon
id|ch_ctrl
op_assign
id|zfw_ctrl-&gt;ch_ctrl
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;xmit_buf
)paren
(brace
r_int
r_char
op_star
id|temp
suffix:semicolon
id|temp
op_assign
id|info-&gt;xmit_buf
suffix:semicolon
id|info-&gt;xmit_buf
op_assign
l_int|0
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|temp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
(paren
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
)paren
(brace
id|cy_writel
c_func
(paren
(paren
id|u_long
)paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
(paren
id|uclong
)paren
(paren
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_amp
op_complement
(paren
id|C_RS_RTS
op_or
id|C_RS_DTR
)paren
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
comma
id|channel
comma
id|C_CM_IOCTLM
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:shutdown retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:shutdown dropping Z DTR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|info-&gt;tty
)paren
(brace
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
)brace
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_INITIALIZED
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot; cyc shutdown done&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* shutdown */
multiline_comment|/*&n; * ------------------------------------------------------------&n; * cy_open() and friends&n; * ------------------------------------------------------------&n; */
r_static
r_int
DECL|function|block_til_ready
id|block_til_ready
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
r_struct
id|cyclades_port
op_star
id|info
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|cyclades_card
op_star
id|cinfo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_char
op_star
id|base_addr
suffix:semicolon
id|cinfo
op_assign
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cinfo-&gt;first_line
suffix:semicolon
multiline_comment|/*&n;     * If the device is in the middle of being closed, then block&n;     * until it&squot;s done, and then try again.&n;     */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
)brace
r_return
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     * If this is a callout device, then just make sure the normal&n;     * device isn&squot;t being used.&n;     */
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|SERIAL_TYPE_CALLOUT
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SESSION_LOCKOUT
)paren
op_logical_and
(paren
id|info-&gt;session
op_ne
id|current-&gt;session
)paren
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ASYNC_PGRP_LOCKOUT
)paren
op_logical_and
(paren
id|info-&gt;pgrp
op_ne
id|current-&gt;pgrp
)paren
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|info-&gt;flags
op_or_assign
id|ASYNC_CALLOUT_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * If non-blocking mode is set, then make the check up front&n;     * and then exit.&n;     */
r_if
c_cond
(paren
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_logical_or
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|info-&gt;flags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;     * Block waiting for the carrier detect and the line to become&n;     * free (i.e., not in use by the callout).  While we are in&n;     * this loop, info-&gt;count is dropped by one, so that&n;     * cy_close() knows when to free things.  We restore it upon&n;     * exit, either normal or abnormal.&n;     */
id|retval
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc block_til_ready before block: ttyC%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
multiline_comment|/**/
macro_line|#endif
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
id|info-&gt;count
op_decrement
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_COUNT
id|printk
c_func
(paren
l_string|&quot;cyc block_til_ready: (%d): decrementing count to %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;blocked_open
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
op_star
id|cinfo
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cinfo-&gt;bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_char
op_star
)paren
(paren
id|cinfo-&gt;base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
id|CyRTS
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
id|CyDTR
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:block_til_ready raising DTR&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;     status: 0x%x, 0x%x&bslash;n&quot;
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
(brace
id|retval
op_assign
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
op_logical_and
(paren
id|C_CLOCAL
c_func
(paren
id|tty
)paren
op_logical_or
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
op_amp
id|CyDCD
)paren
)paren
)paren
(brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc block_til_ready blocking: ttyC%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
multiline_comment|/**/
macro_line|#endif
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|base_addr
op_assign
(paren
r_char
op_star
)paren
(paren
id|cinfo-&gt;base_addr
)paren
suffix:semicolon
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISZLOADED
c_func
(paren
op_star
id|cinfo
)paren
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
id|zfw_ctrl-&gt;board_ctrl
suffix:semicolon
id|ch_ctrl
op_assign
id|zfw_ctrl-&gt;ch_ctrl
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
)paren
(brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_or
(paren
id|C_RS_RTS
op_or
id|C_RS_DTR
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
comma
id|channel
comma
id|C_CM_IOCTLM
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:block_til_ready retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:block_til_ready raising Z DTR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
(brace
id|retval
op_assign
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
op_logical_and
(paren
id|C_CLOCAL
c_func
(paren
id|tty
)paren
op_logical_or
(paren
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_status
)paren
op_amp
id|C_RS_DCD
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc block_til_ready blocking: ttyC%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
multiline_comment|/**/
macro_line|#endif
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
id|info-&gt;count
op_increment
suffix:semicolon
macro_line|#ifdef CY_DEBUG_COUNT
id|printk
c_func
(paren
l_string|&quot;cyc:block_til_ready (%d): incrementing count to %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
)brace
id|info-&gt;blocked_open
op_decrement
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc:block_til_ready after blocking: ttyC%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
multiline_comment|/**/
macro_line|#endif
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* block_til_ready */
multiline_comment|/*&n; * This routine is called whenever a serial port is opened.  It&n; * performs the serial-specific initialization for the tty structure.&n; */
r_static
r_int
DECL|function|cy_open
id|cy_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
suffix:semicolon
r_int
id|retval
comma
id|line
suffix:semicolon
r_int
r_int
id|page
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|line
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
op_minus
id|tty-&gt;driver.minor_start
suffix:semicolon
r_if
c_cond
(paren
(paren
id|line
OL
l_int|0
)paren
op_logical_or
(paren
id|NR_PORTS
op_le
id|line
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|info
op_assign
op_amp
id|cy_port
(braket
id|line
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;line
OL
l_int|0
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* If the card&squot;s firmware hasn&squot;t been loaded,&n;       treat it as absent from the system.  This&n;       will make the user pay attention.&n;    */
r_if
c_cond
(paren
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ISZLOADED
c_func
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|ZE_V1
op_eq
id|cy_readl
c_func
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
(paren
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
)paren
dot
id|ctl_addr
)paren
)paren
op_member_access_from_pointer
id|mail_box_0
)paren
)paren
op_logical_and
id|Z_FPGA_CHECK
c_func
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
)paren
)paren
op_logical_and
(paren
id|ZFIRM_HLT
op_eq
id|cy_readl
c_func
(paren
op_amp
(paren
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
)paren
dot
id|base_addr
op_plus
id|ID_ADDRESS
)paren
)paren
op_member_access_from_pointer
id|signature
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;cyc:Cyclades-Z Error: you need an external power supply for this number of ports.&bslash;n&bslash;rFirmware halted.&bslash;r&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:Cyclades-Z firmware not yet loaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CYZ_INTR
r_else
(brace
multiline_comment|/* In case this Z board is operating in interrupt mode, its &n;&t;       interrupts should be enabled as soon as the first open happens &n;&t;       to one of its ports. */
r_if
c_cond
(paren
op_logical_neg
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|intr_enabled
)paren
(brace
multiline_comment|/* Enable interrupts on the PLX chip */
id|cy_writew
c_func
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|ctl_addr
op_plus
l_int|0x68
comma
id|cy_readw
c_func
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|ctl_addr
op_plus
l_int|0x68
)paren
op_or
l_int|0x0900
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts on the FW */
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
comma
l_int|0
comma
id|C_CM_IRQ_ENBL
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:IRQ enable retval was %x&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
)brace
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|intr_enabled
op_assign
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_CYZ_INTR */
)brace
macro_line|#ifdef CY_DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot;cyc:cy_open ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
id|tty-&gt;driver_data
op_assign
id|info
suffix:semicolon
id|info-&gt;tty
op_assign
id|tty
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_open&quot;
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc:cy_open ttyC%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
multiline_comment|/**/
macro_line|#endif
id|info-&gt;count
op_increment
suffix:semicolon
macro_line|#ifdef CY_DEBUG_COUNT
id|printk
c_func
(paren
l_string|&quot;cyc:cy_open (%d): incrementing count to %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|tmp_buf
)paren
(brace
id|page
op_assign
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|tmp_buf
)paren
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_else
id|tmp_buf
op_assign
(paren
r_int
r_char
op_star
)paren
id|page
suffix:semicolon
)brace
multiline_comment|/*&n;     * If the port is the middle of closing, bail out now&n;     */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
r_return
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     * Start up serial port&n;     */
id|retval
op_assign
id|startup
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_return
id|retval
suffix:semicolon
)brace
id|retval
op_assign
id|block_til_ready
c_func
(paren
id|tty
comma
id|filp
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc:cy_open returning after block_til_ready with %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
macro_line|#endif
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPLIT_TERMIOS
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|SERIAL_TYPE_NORMAL
)paren
op_star
id|tty-&gt;termios
op_assign
id|info-&gt;normal_termios
suffix:semicolon
r_else
op_star
id|tty-&gt;termios
op_assign
id|info-&gt;callout_termios
suffix:semicolon
)brace
id|info-&gt;session
op_assign
id|current-&gt;session
suffix:semicolon
id|info-&gt;pgrp
op_assign
id|current-&gt;pgrp
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot; cyc:cy_open done&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/**/
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* cy_open */
multiline_comment|/*&n; * cy_wait_until_sent() --- wait until the transmitter is empty&n; */
r_static
r_void
DECL|function|cy_wait_until_sent
id|cy_wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_int
r_int
id|orig_jiffies
comma
id|char_time
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_wait_until_sent&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;xmit_fifo_size
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* Just in case.... */
id|orig_jiffies
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/*&n;     * Set the check interval to be 1/5 of the estimated time to&n;     * send a single character, and make it at least 1.  The check&n;     * interval should also be less than the timeout.&n;     * &n;     * Note: we have to use pretty tight timings here to satisfy&n;     * the NIST-PCTS.&n;     */
id|char_time
op_assign
(paren
id|info-&gt;timeout
op_minus
id|HZ
op_div
l_int|50
)paren
op_div
id|info-&gt;xmit_fifo_size
suffix:semicolon
id|char_time
op_assign
id|char_time
op_div
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|char_time
op_eq
l_int|0
)paren
id|char_time
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|timeout
OL
l_int|0
)paren
id|timeout
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
id|char_time
op_assign
id|MIN
c_func
(paren
id|char_time
comma
id|timeout
)paren
suffix:semicolon
multiline_comment|/*&n;     * If the transmitter hasn&squot;t cleared in twice the approximate&n;     * amount of time to send the entire FIFO, it probably won&squot;t&n;     * ever clear.  This assumes the UART isn&squot;t doing flow&n;     * control, which is currently the case.  Hence, if it ever&n;     * takes longer than info-&gt;timeout, this is probably due to a&n;     * UART bug of some kind.  So, we clamp the timeout parameter at&n;     * 2*info-&gt;timeout.&n;     */
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_logical_or
id|timeout
OG
l_int|2
op_star
id|info-&gt;timeout
)paren
id|timeout
op_assign
l_int|2
op_star
id|info-&gt;timeout
suffix:semicolon
macro_line|#ifdef CY_DEBUG_WAIT_UNTIL_SENT
id|printk
c_func
(paren
l_string|&quot;In cy_wait_until_sent(%d) check=%lu...&quot;
comma
id|timeout
comma
id|char_time
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;jiff=%lu...&quot;
comma
id|jiffies
)paren
suffix:semicolon
macro_line|#endif
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
id|CyTxRdy
)paren
(brace
macro_line|#ifdef CY_DEBUG_WAIT_UNTIL_SENT
id|printk
c_func
(paren
l_string|&quot;Not clean (jiff=%lu)...&quot;
comma
id|jiffies
)paren
suffix:semicolon
macro_line|#endif
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|char_time
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|orig_jiffies
op_plus
id|timeout
)paren
)paren
r_break
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Nothing to do!
)brace
multiline_comment|/* Run one more char cycle */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|char_time
op_star
l_int|5
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
macro_line|#ifdef CY_DEBUG_WAIT_UNTIL_SENT
id|printk
c_func
(paren
l_string|&quot;Clean (jiff=%lu)...done&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * This routine is called when a particular tty device is closed.&n; */
r_static
r_void
DECL|function|cy_close
id|cy_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot;cyc:cy_close ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|info
op_logical_or
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_close&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* If the TTY is being hung up, nothing to do */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_OPEN
id|printk
c_func
(paren
l_string|&quot;cyc:cy_close ttyC%d, count = %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;count
op_ne
l_int|1
)paren
)paren
(brace
multiline_comment|/*&n;         * Uh, oh.  tty-&gt;count is 1, which means that the tty&n;         * structure will be freed.  Info-&gt;count should always&n;         * be one in these conditions.  If it&squot;s greater than&n;         * one, we&squot;ve got real problems, since it means the&n;         * serial port won&squot;t be shutdown.&n;         */
id|printk
c_func
(paren
l_string|&quot;cyc:cy_close: bad serial port count; tty-&gt;count is 1, &quot;
l_string|&quot;info-&gt;count is %d&bslash;n&quot;
comma
id|info-&gt;count
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_COUNT
id|printk
c_func
(paren
l_string|&quot;cyc:cy_close at (%d): decrementing count to %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|info-&gt;count
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_decrement
id|info-&gt;count
OL
l_int|0
)paren
(brace
macro_line|#ifdef CY_DEBUG_COUNT
id|printk
c_func
(paren
l_string|&quot;cyc:cyc_close setting count to 0&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;count
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|info-&gt;flags
op_or_assign
id|ASYNC_CLOSING
suffix:semicolon
multiline_comment|/*&n;     * Save the termios structure, since this port may have&n;     * separate termios for callout and dialin.&n;     */
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
id|info-&gt;normal_termios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
id|info-&gt;callout_termios
op_assign
op_star
id|tty-&gt;termios
suffix:semicolon
multiline_comment|/*&n;    * Now we wait for the transmit buffer to clear; and we notify&n;    * the line discipline to only process XON/XOFF characters.&n;    */
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;closing_wait
op_ne
id|CY_CLOSING_WAIT_NONE
)paren
(brace
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
id|info-&gt;closing_wait
)paren
suffix:semicolon
)brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
)paren
)paren
(brace
r_int
id|channel
op_assign
id|info-&gt;line
op_minus
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|first_line
suffix:semicolon
r_int
id|index
op_assign
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|bus_index
suffix:semicolon
r_int
r_char
op_star
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|channel
op_rshift
l_int|2
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
multiline_comment|/* Stop accepting input */
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|ulong
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyRxData
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
(brace
multiline_comment|/* Waiting for on-board buffers to be empty before closing &n;&t;       the port */
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_wait_until_sent
c_func
(paren
id|tty
comma
id|info-&gt;timeout
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#ifdef Z_WAKE
multiline_comment|/* Waiting for on-board buffers to be empty before closing the port */
r_int
r_char
op_star
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|base_addr
suffix:semicolon
r_struct
id|FIRM_ID
op_star
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
op_assign
id|zfw_ctrl-&gt;ch_ctrl
suffix:semicolon
r_int
id|channel
op_assign
id|info-&gt;line
op_minus
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|first_line
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|flow_status
)paren
op_ne
id|C_FS_TXIDLE
)paren
(brace
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
comma
id|channel
comma
id|C_CM_IOCTLW
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:cy_close retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|info-&gt;shutdown_wait
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver.flush_buffer
)paren
id|tty-&gt;driver
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;ldisc.flush_buffer
)paren
id|tty-&gt;ldisc
dot
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
id|info-&gt;event
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;blocked_open
)paren
(brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;close_delay
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|info-&gt;close_delay
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CALLOUT_ACTIVE
op_or
id|ASYNC_CLOSING
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot; cyc:cy_close done&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* cy_close */
multiline_comment|/* This routine gets called when tty_write has put something into&n; * the write_queue.  The characters may come from user space or&n; * kernel space.&n; *&n; * This routine will return the number of characters actually&n; * accepted for writing.&n; *&n; * If the port is not already transmitting stuff, start it off by&n; * enabling interrupts.  The interrupt service routine will then&n; * ensure that the characters are sent.&n; * If the port is already active, there is no need to kick it.&n; *&n; */
r_static
r_int
DECL|function|cy_write
id|cy_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|c
comma
id|ret
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CY_DEBUG_IO
id|printk
c_func
(paren
l_string|&quot;cyc:cy_write ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_write&quot;
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|info-&gt;xmit_buf
op_logical_or
op_logical_neg
id|tmp_buf
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
id|down
c_func
(paren
op_amp
id|tmp_buf_sem
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c
op_assign
id|MIN
c_func
(paren
id|count
comma
id|MIN
c_func
(paren
id|SERIAL_XMIT_SIZE
op_minus
id|info-&gt;xmit_cnt
op_minus
l_int|1
comma
id|SERIAL_XMIT_SIZE
op_minus
id|info-&gt;xmit_head
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|c
op_sub_assign
id|copy_from_user
c_func
(paren
id|tmp_buf
comma
id|buf
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|c
op_assign
id|MIN
c_func
(paren
id|c
comma
id|MIN
c_func
(paren
id|SERIAL_XMIT_SIZE
op_minus
id|info-&gt;xmit_cnt
op_minus
l_int|1
comma
id|SERIAL_XMIT_SIZE
op_minus
id|info-&gt;xmit_head
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;xmit_buf
op_plus
id|info-&gt;xmit_head
comma
id|tmp_buf
comma
id|c
)paren
suffix:semicolon
id|info-&gt;xmit_head
op_assign
(paren
(paren
id|info-&gt;xmit_head
op_plus
id|c
)paren
op_amp
(paren
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|info-&gt;xmit_cnt
op_add_assign
id|c
suffix:semicolon
id|buf
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|ret
op_add_assign
id|c
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|tmp_buf_sem
)paren
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c
op_assign
id|MIN
c_func
(paren
id|count
comma
id|MIN
c_func
(paren
id|SERIAL_XMIT_SIZE
op_minus
id|info-&gt;xmit_cnt
op_minus
l_int|1
comma
id|SERIAL_XMIT_SIZE
op_minus
id|info-&gt;xmit_head
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|info-&gt;xmit_buf
op_plus
id|info-&gt;xmit_head
comma
id|buf
comma
id|c
)paren
suffix:semicolon
id|info-&gt;xmit_head
op_assign
(paren
id|info-&gt;xmit_head
op_plus
id|c
)paren
op_amp
(paren
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;xmit_cnt
op_add_assign
id|c
suffix:semicolon
id|buf
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|ret
op_add_assign
id|c
suffix:semicolon
)brace
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;idle_stats.xmit_bytes
op_add_assign
id|ret
suffix:semicolon
id|info-&gt;idle_stats.xmit_idle
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;xmit_cnt
op_logical_and
op_logical_neg
id|tty-&gt;stopped
op_logical_and
op_logical_neg
id|tty-&gt;hw_stopped
)paren
(brace
id|start_xmit
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* cy_write */
multiline_comment|/*&n; * This routine is called by the kernel to write a single&n; * character to the tty device.  If the kernel uses this routine,&n; * it must call the flush_chars() routine (if defined) when it is&n; * done stuffing characters into the driver.  If there is no room&n; * in the queue, the character is ignored.&n; */
r_static
r_void
DECL|function|cy_put_char
id|cy_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef CY_DEBUG_IO
id|printk
c_func
(paren
l_string|&quot;cyc:cy_put_char ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_put_char&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|info-&gt;xmit_buf
)paren
r_return
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;xmit_cnt
op_ge
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
(brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|info-&gt;xmit_buf
(braket
id|info-&gt;xmit_head
op_increment
)braket
op_assign
id|ch
suffix:semicolon
id|info-&gt;xmit_head
op_and_assign
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
suffix:semicolon
id|info-&gt;xmit_cnt
op_increment
suffix:semicolon
id|info-&gt;idle_stats.xmit_bytes
op_increment
suffix:semicolon
id|info-&gt;idle_stats.xmit_idle
op_assign
id|jiffies
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* cy_put_char */
multiline_comment|/*&n; * This routine is called by the kernel after it has written a&n; * series of characters to the tty device using put_char().  &n; */
r_static
r_void
DECL|function|cy_flush_chars
id|cy_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef CY_DEBUG_IO
id|printk
c_func
(paren
l_string|&quot;cyc:cy_flush_chars ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_flush_chars&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;xmit_cnt
op_le
l_int|0
op_logical_or
id|tty-&gt;stopped
op_logical_or
id|tty-&gt;hw_stopped
op_logical_or
op_logical_neg
id|info-&gt;xmit_buf
)paren
r_return
suffix:semicolon
id|start_xmit
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* cy_flush_chars */
multiline_comment|/*&n; * This routine returns the numbers of characters the tty driver&n; * will accept for queuing to be written.  This number is subject&n; * to change as output buffers get emptied, or if the output flow&n; * control is activated.&n; */
r_static
r_int
DECL|function|cy_write_room
id|cy_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|ret
suffix:semicolon
macro_line|#ifdef CY_DEBUG_IO
id|printk
c_func
(paren
l_string|&quot;cyc:cy_write_room ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_write_room&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
id|SERIAL_XMIT_SIZE
op_minus
id|info-&gt;xmit_cnt
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* cy_write_room */
r_static
r_int
DECL|function|cy_chars_in_buffer
id|cy_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|card
comma
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_chars_in_buffer&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
macro_line|#ifdef Z_EXT_CHARS_IN_BUFFER
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
macro_line|#endif /* Z_EXT_CHARS_IN_BUFFER */
macro_line|#ifdef CY_DEBUG_IO
id|printk
c_func
(paren
l_string|&quot;cyc:cy_chars_in_buffer ttyC%d %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;xmit_cnt
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_return
id|info-&gt;xmit_cnt
suffix:semicolon
macro_line|#ifdef Z_EXT_CHARS_IN_BUFFER
)brace
r_else
(brace
r_static
r_volatile
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_static
r_volatile
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_static
r_volatile
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
suffix:semicolon
r_static
r_volatile
r_struct
id|BUF_CTRL
op_star
id|buf_ctrl
suffix:semicolon
r_int
id|char_count
suffix:semicolon
r_volatile
id|uclong
id|tx_put
comma
id|tx_get
comma
id|tx_bufsize
suffix:semicolon
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|ch_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;ch_ctrl
(braket
id|channel
)braket
)paren
suffix:semicolon
id|buf_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;buf_ctrl
(braket
id|channel
)braket
)paren
suffix:semicolon
id|tx_get
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;tx_get
)paren
suffix:semicolon
id|tx_put
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;tx_put
)paren
suffix:semicolon
id|tx_bufsize
op_assign
id|cy_readl
c_func
(paren
op_amp
id|buf_ctrl-&gt;tx_bufsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tx_put
op_ge
id|tx_get
)paren
id|char_count
op_assign
id|tx_put
op_minus
id|tx_get
suffix:semicolon
r_else
id|char_count
op_assign
id|tx_put
op_minus
id|tx_get
op_plus
id|tx_bufsize
suffix:semicolon
macro_line|#ifdef CY_DEBUG_IO
id|printk
c_func
(paren
l_string|&quot;cyc:cy_chars_in_buffer ttyC%d %d&bslash;n&quot;
comma
id|info-&gt;line
comma
id|info-&gt;xmit_cnt
op_plus
id|char_count
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_return
(paren
id|info-&gt;xmit_cnt
op_plus
id|char_count
)paren
suffix:semicolon
)brace
macro_line|#endif /* Z_EXT_CHARS_IN_BUFFER */
)brace
multiline_comment|/* cy_chars_in_buffer */
multiline_comment|/*&n; * ------------------------------------------------------------&n; * cy_ioctl() and friends&n; * ------------------------------------------------------------&n; */
r_static
r_void
DECL|function|cyy_baud_calc
id|cyy_baud_calc
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
id|uclong
id|baud
)paren
(brace
r_int
id|co
comma
id|co_val
comma
id|bpr
suffix:semicolon
id|uclong
id|cy_clock
op_assign
(paren
(paren
id|info-&gt;chip_rev
op_ge
id|CD1400_REV_J
)paren
ques
c_cond
l_int|60000000
suffix:colon
l_int|25000000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|baud
op_eq
l_int|0
)paren
(brace
id|info-&gt;tbpr
op_assign
id|info-&gt;tco
op_assign
id|info-&gt;rbpr
op_assign
id|info-&gt;rco
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* determine which prescaler to use */
r_for
c_loop
(paren
id|co
op_assign
l_int|4
comma
id|co_val
op_assign
l_int|2048
suffix:semicolon
id|co
suffix:semicolon
id|co
op_decrement
comma
id|co_val
op_rshift_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|cy_clock
op_div
id|co_val
op_div
id|baud
OG
l_int|63
)paren
r_break
suffix:semicolon
)brace
id|bpr
op_assign
(paren
id|cy_clock
op_div
id|co_val
op_star
l_int|2
op_div
id|baud
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|bpr
OG
l_int|255
)paren
id|bpr
op_assign
l_int|255
suffix:semicolon
id|info-&gt;tbpr
op_assign
id|info-&gt;rbpr
op_assign
id|bpr
suffix:semicolon
id|info-&gt;tco
op_assign
id|info-&gt;rco
op_assign
id|co
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine finds or computes the various line characteristics.&n; * It used to be called config_setup&n; */
r_static
r_void
DECL|function|set_line_char
id|set_line_char
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_int
id|cflag
comma
id|iflag
suffix:semicolon
r_int
r_int
id|chip_number
suffix:semicolon
r_int
id|baud
comma
id|baud_rate
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
op_logical_neg
id|info-&gt;tty-&gt;termios
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;line
op_eq
op_minus
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
id|cflag
op_assign
id|info-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|iflag
op_assign
id|info-&gt;tty-&gt;termios-&gt;c_iflag
suffix:semicolon
multiline_comment|/*&n;     * Set up the tty-&gt;alt_speed kludge&n;     */
r_if
c_cond
(paren
id|info-&gt;tty
)paren
(brace
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_HI
)paren
id|info-&gt;tty-&gt;alt_speed
op_assign
l_int|57600
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_VHI
)paren
id|info-&gt;tty-&gt;alt_speed
op_assign
l_int|115200
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_SHI
)paren
id|info-&gt;tty-&gt;alt_speed
op_assign
l_int|230400
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_WARP
)paren
id|info-&gt;tty-&gt;alt_speed
op_assign
l_int|460800
suffix:semicolon
)brace
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
id|chip_number
op_assign
id|channel
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
multiline_comment|/* baud rate */
id|baud
op_assign
id|tty_get_baud_rate
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|baud
op_eq
l_int|38400
)paren
op_logical_and
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_CUST
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;custom_divisor
)paren
id|baud_rate
op_assign
id|info-&gt;baud
op_div
id|info-&gt;custom_divisor
suffix:semicolon
r_else
id|baud_rate
op_assign
id|info-&gt;baud
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|baud
OG
id|CD1400_MAX_SPEED
)paren
(brace
id|baud
op_assign
id|CD1400_MAX_SPEED
suffix:semicolon
)brace
multiline_comment|/* find the baud index */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|20
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|baud
op_eq
id|baud_table
(braket
id|i
)braket
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|20
)paren
(brace
id|i
op_assign
l_int|19
suffix:semicolon
multiline_comment|/* CD1400_MAX_SPEED */
)brace
r_if
c_cond
(paren
(paren
id|baud
op_eq
l_int|38400
)paren
op_logical_and
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_CUST
)paren
)paren
(brace
id|cyy_baud_calc
c_func
(paren
id|info
comma
id|baud_rate
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;chip_rev
op_ge
id|CD1400_REV_J
)paren
(brace
multiline_comment|/* It is a CD1400 rev. J or later */
id|info-&gt;tbpr
op_assign
id|baud_bpr_60
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Tx BPR */
id|info-&gt;tco
op_assign
id|baud_co_60
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Tx CO */
id|info-&gt;rbpr
op_assign
id|baud_bpr_60
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Rx BPR */
id|info-&gt;rco
op_assign
id|baud_co_60
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Rx CO */
)brace
r_else
(brace
id|info-&gt;tbpr
op_assign
id|baud_bpr_25
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Tx BPR */
id|info-&gt;tco
op_assign
id|baud_co_25
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Tx CO */
id|info-&gt;rbpr
op_assign
id|baud_bpr_25
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Rx BPR */
id|info-&gt;rco
op_assign
id|baud_co_25
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Rx CO */
)brace
)brace
r_if
c_cond
(paren
id|baud_table
(braket
id|i
)braket
op_eq
l_int|134
)paren
(brace
multiline_comment|/* get it right for 134.5 baud */
id|info-&gt;timeout
op_assign
(paren
id|info-&gt;xmit_fifo_size
op_star
id|HZ
op_star
l_int|30
op_div
l_int|269
)paren
op_plus
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|baud
op_eq
l_int|38400
)paren
op_logical_and
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_CUST
)paren
)paren
(brace
id|info-&gt;timeout
op_assign
(paren
id|info-&gt;xmit_fifo_size
op_star
id|HZ
op_star
l_int|15
op_div
id|baud_rate
)paren
op_plus
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|baud_table
(braket
id|i
)braket
)paren
(brace
id|info-&gt;timeout
op_assign
(paren
id|info-&gt;xmit_fifo_size
op_star
id|HZ
op_star
l_int|15
op_div
id|baud_table
(braket
id|i
)braket
)paren
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* this needs to be propagated into the card info */
)brace
r_else
(brace
id|info-&gt;timeout
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* By tradition (is it a standard?) a baud rate of zero&n;&t;   implies the line should be/has been closed.  A bit&n;&t;   later in this routine such a test is performed. */
multiline_comment|/* byte size and parity */
id|info-&gt;cor5
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cor4
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cor3
op_assign
(paren
id|info-&gt;default_threshold
ques
c_cond
id|info-&gt;default_threshold
suffix:colon
id|baud_cor3
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* receive threshold */
id|info-&gt;cor2
op_assign
id|CyETC
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|info-&gt;cor1
op_assign
id|Cy_5_BITS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|info-&gt;cor1
op_assign
id|Cy_6_BITS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|info-&gt;cor1
op_assign
id|Cy_7_BITS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|info-&gt;cor1
op_assign
id|Cy_8_BITS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
(brace
id|info-&gt;cor1
op_or_assign
id|Cy_2_STOP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
(brace
id|info-&gt;cor1
op_or_assign
id|CyPARITY_O
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;cor1
op_or_assign
id|CyPARITY_E
suffix:semicolon
)brace
)brace
r_else
(brace
id|info-&gt;cor1
op_or_assign
id|CyPARITY_NONE
suffix:semicolon
)brace
multiline_comment|/* CTS flow control flag */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|info-&gt;flags
op_or_assign
id|ASYNC_CTS_FLOW
suffix:semicolon
id|info-&gt;cor2
op_or_assign
id|CyCtsAE
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_CTS_FLOW
suffix:semicolon
id|info-&gt;cor2
op_and_assign
op_complement
id|CyCtsAE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
r_else
id|info-&gt;flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
multiline_comment|/***********************************************&n;&t;    The hardware option, CyRtsAO, presents RTS when&n;&t;    the chip has characters to send.  Since most modems&n;&t;    use RTS as reverse (inbound) flow control, this&n;&t;    option is not used.  If inbound flow control is&n;&t;    necessary, DTR can be programmed to provide the&n;&t;    appropriate signals for use with a non-standard&n;&t;    cable.  Contact Marcio Saito for details.&n;&t; ***********************************************/
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
multiline_comment|/* tx and rx baud rate */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTCOR
op_lshift
id|index
)paren
comma
id|info-&gt;tco
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyTBPR
op_lshift
id|index
)paren
comma
id|info-&gt;tbpr
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyRCOR
op_lshift
id|index
)paren
comma
id|info-&gt;rco
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyRBPR
op_lshift
id|index
)paren
comma
id|info-&gt;rbpr
)paren
suffix:semicolon
multiline_comment|/* set line characteristics  according configuration */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySCHR1
op_lshift
id|index
)paren
comma
id|START_CHAR
c_func
(paren
id|info-&gt;tty
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySCHR2
op_lshift
id|index
)paren
comma
id|STOP_CHAR
c_func
(paren
id|info-&gt;tty
)paren
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCOR1
op_lshift
id|index
)paren
comma
id|info-&gt;cor1
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCOR2
op_lshift
id|index
)paren
comma
id|info-&gt;cor2
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCOR3
op_lshift
id|index
)paren
comma
id|info-&gt;cor3
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCOR4
op_lshift
id|index
)paren
comma
id|info-&gt;cor4
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCOR5
op_lshift
id|index
)paren
comma
id|info-&gt;cor5
)paren
suffix:semicolon
id|cyy_issue_cmd
c_func
(paren
id|base_addr
comma
id|CyCOR_CHANGE
op_or
id|CyCOR1ch
op_or
id|CyCOR2ch
op_or
id|CyCOR3ch
comma
id|index
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
multiline_comment|/* !!! Is this needed? */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyRTPR
op_lshift
id|index
)paren
comma
(paren
id|info-&gt;default_timeout
ques
c_cond
id|info-&gt;default_timeout
suffix:colon
l_int|0x02
)paren
)paren
suffix:semicolon
multiline_comment|/* 10ms rx timeout */
r_if
c_cond
(paren
id|C_CLOCAL
c_func
(paren
id|info-&gt;tty
)paren
)paren
(brace
multiline_comment|/* without modem intr */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_or
id|CyMdmCh
)paren
suffix:semicolon
multiline_comment|/* act on 1-&gt;0 modem transitions */
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
op_logical_and
id|info-&gt;rflow
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMCOR1
op_lshift
id|index
)paren
comma
(paren
id|CyCTS
op_or
id|rflow_thr
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMCOR1
op_lshift
id|index
)paren
comma
id|CyCTS
)paren
suffix:semicolon
)brace
multiline_comment|/* act on 0-&gt;1 modem transitions */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMCOR2
op_lshift
id|index
)paren
comma
id|CyCTS
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* without modem intr */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_or
id|CyMdmCh
)paren
suffix:semicolon
multiline_comment|/* act on 1-&gt;0 modem transitions */
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
op_logical_and
id|info-&gt;rflow
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMCOR1
op_lshift
id|index
)paren
comma
(paren
id|CyDSR
op_or
id|CyCTS
op_or
id|CyRI
op_or
id|CyDCD
op_or
id|rflow_thr
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMCOR1
op_lshift
id|index
)paren
comma
id|CyDSR
op_or
id|CyCTS
op_or
id|CyRI
op_or
id|CyDCD
)paren
suffix:semicolon
)brace
multiline_comment|/* act on 0-&gt;1 modem transitions */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMCOR2
op_lshift
id|index
)paren
comma
id|CyDSR
op_or
id|CyCTS
op_or
id|CyRI
op_or
id|CyDCD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
multiline_comment|/* baud rate is zero, turn off line */
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
op_complement
id|CyRTS
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
op_complement
id|CyDTR
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_line_char dropping DTR&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
"&quot;"
id|status
suffix:colon
l_int|0
id|x
op_mod
id|x
comma
l_int|0
id|x
op_mod
id|x
"&bslash;"
id|n
"&quot;"
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
id|CyRTS
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
id|CyDTR
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_line_char raising DTR&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;     status: 0x%x, 0x%x&bslash;n&quot;
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|info-&gt;tty
)paren
(brace
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
suffix:semicolon
r_struct
id|BUF_CTRL
op_star
id|buf_ctrl
suffix:semicolon
id|uclong
id|sw_flow
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISZLOADED
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
id|zfw_ctrl-&gt;board_ctrl
suffix:semicolon
id|ch_ctrl
op_assign
op_amp
(paren
id|zfw_ctrl-&gt;ch_ctrl
(braket
id|channel
)braket
)paren
suffix:semicolon
id|buf_ctrl
op_assign
op_amp
id|zfw_ctrl-&gt;buf_ctrl
(braket
id|channel
)braket
suffix:semicolon
multiline_comment|/* baud rate */
id|baud
op_assign
id|tty_get_baud_rate
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|baud
op_eq
l_int|38400
)paren
op_logical_and
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_CUST
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;custom_divisor
)paren
id|baud_rate
op_assign
id|info-&gt;baud
op_div
id|info-&gt;custom_divisor
suffix:semicolon
r_else
id|baud_rate
op_assign
id|info-&gt;baud
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|baud
OG
id|CYZ_MAX_SPEED
)paren
(brace
id|baud
op_assign
id|CYZ_MAX_SPEED
suffix:semicolon
)brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_baud
comma
id|baud
)paren
suffix:semicolon
r_if
c_cond
(paren
id|baud
op_eq
l_int|134
)paren
(brace
multiline_comment|/* get it right for 134.5 baud */
id|info-&gt;timeout
op_assign
(paren
id|info-&gt;xmit_fifo_size
op_star
id|HZ
op_star
l_int|30
op_div
l_int|269
)paren
op_plus
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|baud
op_eq
l_int|38400
)paren
op_logical_and
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SPD_MASK
)paren
op_eq
id|ASYNC_SPD_CUST
)paren
)paren
(brace
id|info-&gt;timeout
op_assign
(paren
id|info-&gt;xmit_fifo_size
op_star
id|HZ
op_star
l_int|15
op_div
id|baud_rate
)paren
op_plus
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|baud
)paren
(brace
id|info-&gt;timeout
op_assign
(paren
id|info-&gt;xmit_fifo_size
op_star
id|HZ
op_star
l_int|15
op_div
id|baud
)paren
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* this needs to be propagated into the card info */
)brace
r_else
(brace
id|info-&gt;timeout
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* byte size and parity */
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_data_l
comma
id|C_DL_CS5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_data_l
comma
id|C_DL_CS6
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_data_l
comma
id|C_DL_CS7
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_data_l
comma
id|C_DL_CS8
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
(brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_data_l
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_data_l
)paren
op_or
id|C_DL_2STOP
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_data_l
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_data_l
)paren
op_or
id|C_DL_1STOP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
(brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_parity
comma
id|C_PR_ODD
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_parity
comma
id|C_PR_EVEN
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;comm_parity
comma
id|C_PR_NONE
)paren
suffix:semicolon
)brace
multiline_comment|/* CTS flow control flag */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;hw_flow
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl-&gt;hw_flow
)paren
op_or
id|C_RS_CTS
op_or
id|C_RS_RTS
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;hw_flow
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl-&gt;hw_flow
)paren
op_amp
op_complement
(paren
id|C_RS_CTS
op_or
id|C_RS_RTS
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* As the HW flow control is done in firmware, the driver doesn&squot;t&n;&t;   need to care about it */
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_CTS_FLOW
suffix:semicolon
multiline_comment|/* XON/XOFF/XANY flow control flags */
id|sw_flow
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IXON
)paren
(brace
id|sw_flow
op_or_assign
id|C_FL_OXX
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IXANY
)paren
id|sw_flow
op_or_assign
id|C_FL_OIXANY
suffix:semicolon
)brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;sw_flow
comma
id|sw_flow
)paren
suffix:semicolon
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|card
)braket
comma
id|channel
comma
id|C_CM_IOCTL
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:set_line_char retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
multiline_comment|/* CD sensitivity */
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
(brace
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
)brace
r_if
c_cond
(paren
id|baud
op_eq
l_int|0
)paren
(brace
multiline_comment|/* baud rate is zero, turn off line */
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl-&gt;rs_control
)paren
op_amp
op_complement
id|C_RS_DTR
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_line_char dropping Z DTR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl-&gt;rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl-&gt;rs_control
)paren
op_or
id|C_RS_DTR
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_line_char raising Z DTR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|card
)braket
comma
id|channel
comma
id|C_CM_IOCTLM
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:set_line_char(2) retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tty
)paren
(brace
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* set_line_char */
r_static
r_int
DECL|function|get_serial_info
id|get_serial_info
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_struct
id|serial_struct
op_star
id|retinfo
)paren
(brace
r_struct
id|serial_struct
id|tmp
suffix:semicolon
r_struct
id|cyclades_card
op_star
id|cinfo
op_assign
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retinfo
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tmp
comma
l_int|0
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|tmp.type
op_assign
id|info-&gt;type
suffix:semicolon
id|tmp.line
op_assign
id|info-&gt;line
suffix:semicolon
id|tmp.port
op_assign
id|info-&gt;card
op_star
l_int|0x100
op_plus
id|info-&gt;line
op_minus
id|cinfo-&gt;first_line
suffix:semicolon
id|tmp.irq
op_assign
id|cinfo-&gt;irq
suffix:semicolon
id|tmp.flags
op_assign
id|info-&gt;flags
suffix:semicolon
id|tmp.close_delay
op_assign
id|info-&gt;close_delay
suffix:semicolon
id|tmp.baud_base
op_assign
id|info-&gt;baud
suffix:semicolon
id|tmp.custom_divisor
op_assign
id|info-&gt;custom_divisor
suffix:semicolon
id|tmp.hub6
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*!!!*/
r_return
id|copy_to_user
c_func
(paren
id|retinfo
comma
op_amp
id|tmp
comma
r_sizeof
(paren
op_star
id|retinfo
)paren
)paren
ques
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get_serial_info */
r_static
r_int
DECL|function|set_serial_info
id|set_serial_info
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_struct
id|serial_struct
op_star
id|new_info
)paren
(brace
r_struct
id|serial_struct
id|new_serial
suffix:semicolon
r_struct
id|cyclades_port
id|old_info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|new_serial
comma
id|new_info
comma
r_sizeof
(paren
id|new_serial
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|old_info
op_assign
op_star
id|info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_serial.close_delay
op_ne
id|info-&gt;close_delay
)paren
op_logical_or
(paren
id|new_serial.baud_base
op_ne
id|info-&gt;baud
)paren
op_logical_or
(paren
(paren
id|new_serial.flags
op_amp
id|ASYNC_FLAGS
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
op_ne
(paren
id|info-&gt;flags
op_amp
id|ASYNC_FLAGS
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|info-&gt;flags
op_assign
(paren
(paren
id|info-&gt;flags
op_amp
op_complement
id|ASYNC_USR_MASK
)paren
op_or
(paren
id|new_serial.flags
op_amp
id|ASYNC_USR_MASK
)paren
)paren
suffix:semicolon
id|info-&gt;baud
op_assign
id|new_serial.baud_base
suffix:semicolon
id|info-&gt;custom_divisor
op_assign
id|new_serial.custom_divisor
suffix:semicolon
r_goto
id|check_and_exit
suffix:semicolon
)brace
multiline_comment|/*&n;     * OK, past this point, all the error checking has been done.&n;     * At this point, we start making changes.....&n;     */
id|info-&gt;baud
op_assign
id|new_serial.baud_base
suffix:semicolon
id|info-&gt;custom_divisor
op_assign
id|new_serial.custom_divisor
suffix:semicolon
id|info-&gt;flags
op_assign
(paren
(paren
id|info-&gt;flags
op_amp
op_complement
id|ASYNC_FLAGS
)paren
op_or
(paren
id|new_serial.flags
op_amp
id|ASYNC_FLAGS
)paren
)paren
suffix:semicolon
id|info-&gt;close_delay
op_assign
id|new_serial.close_delay
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|info-&gt;closing_wait
op_assign
id|new_serial.closing_wait
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|check_and_exit
suffix:colon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
(brace
id|set_line_char
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
id|startup
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* set_serial_info */
multiline_comment|/*&n; * get_lsr_info - get line status register info&n; *&n; * Purpose: Let user call ioctl() to get info when the UART physically&n; *&t;    is emptied.  On bus types like RS485, the transmitter must&n; *&t;    release the bus after transmitting. This must be done when&n; *&t;    the transmit shift register is empty, not be done when the&n; *&t;    transmit holding register is empty.  This functionality&n; *&t;    allows an RS485 driver to be written in user space.&n; */
DECL|function|get_lsr_info
r_static
r_int
id|get_lsr_info
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
(paren
id|CyTxRdy
op_or
id|CyTxMpty
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
id|status
ques
c_cond
l_int|0
suffix:colon
id|TIOCSER_TEMT
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Not supported yet */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|cy_put_user
c_func
(paren
id|result
comma
(paren
r_int
r_int
op_star
)paren
id|value
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|get_modem_info
id|get_modem_info
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|lstatus
suffix:semicolon
r_int
r_int
id|result
suffix:semicolon
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
id|status
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|status
op_or_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|result
op_assign
(paren
(paren
id|status
op_amp
id|CyRTS
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|CyDTR
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
(paren
(paren
id|status
op_amp
id|CyRTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|CyDTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
id|result
op_or_assign
(paren
(paren
id|status
op_amp
id|CyDCD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|CyRI
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|CyDSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|CyCTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy_card
(braket
id|card
)braket
dot
id|num_chips
op_ne
op_minus
l_int|1
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISZLOADED
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
id|zfw_ctrl-&gt;board_ctrl
suffix:semicolon
id|ch_ctrl
op_assign
id|zfw_ctrl-&gt;ch_ctrl
suffix:semicolon
id|lstatus
op_assign
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_status
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|lstatus
op_amp
id|C_RS_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|lstatus
op_amp
id|C_RS_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|lstatus
op_amp
id|C_RS_DCD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|lstatus
op_amp
id|C_RS_RI
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|lstatus
op_amp
id|C_RS_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|lstatus
op_amp
id|C_RS_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_return
id|cy_put_user
c_func
(paren
id|result
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/* get_modem_info */
r_static
r_int
DECL|function|set_modem_info
id|set_modem_info
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
id|cmd
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|arg
op_assign
id|cy_get_user
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|value
)paren
suffix:semicolon
r_struct
id|FIRM_ID
op_star
id|firm_id
suffix:semicolon
r_struct
id|ZFW_CTRL
op_star
id|zfw_ctrl
suffix:semicolon
r_struct
id|BOARD_CTRL
op_star
id|board_ctrl
suffix:semicolon
r_struct
id|CH_CTRL
op_star
id|ch_ctrl
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMBIS
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
id|CyDTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
id|CyRTS
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
id|CyRTS
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
id|CyDTR
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_modem_info raising DTR&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;     status: 0x%x, 0x%x&bslash;n&quot;
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
op_complement
id|CyDTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
op_complement
id|CyRTS
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
op_complement
id|CyRTS
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
op_complement
id|CyDTR
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_modem_info dropping DTR&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;     status: 0x%x, 0x%x&bslash;n&quot;
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
id|CyDTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
id|CyRTS
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
op_complement
id|CyDTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
op_complement
id|CyRTS
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
id|CyRTS
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
id|CyDTR
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_modem_info raising DTR&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;     status: 0x%x, 0x%x&bslash;n&quot;
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
op_complement
id|CyRTS
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
op_complement
id|CyDTR
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_modem_info dropping DTR&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;     status: 0x%x, 0x%x&bslash;n&quot;
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
)paren
suffix:semicolon
id|firm_id
op_assign
(paren
r_struct
id|FIRM_ID
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
id|ID_ADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISZLOADED
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|zfw_ctrl
op_assign
(paren
r_struct
id|ZFW_CTRL
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_readl
c_func
(paren
op_amp
id|firm_id-&gt;zfwctrl_addr
)paren
op_amp
l_int|0xfffff
)paren
)paren
suffix:semicolon
id|board_ctrl
op_assign
op_amp
id|zfw_ctrl-&gt;board_ctrl
suffix:semicolon
id|ch_ctrl
op_assign
id|zfw_ctrl-&gt;ch_ctrl
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCMBIS
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_or
id|C_RS_RTS
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_or
id|C_RS_DTR
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_modem_info raising Z DTR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMBIC
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_amp
op_complement
id|C_RS_RTS
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_amp
op_complement
id|C_RS_DTR
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_modem_info clearing Z DTR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIOCMSET
suffix:colon
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_RTS
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_or
id|C_RS_RTS
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_amp
op_complement
id|C_RS_RTS
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_amp
id|TIOCM_DTR
)paren
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_or
id|C_RS_DTR
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_modem_info raising Z DTR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
comma
id|cy_readl
c_func
(paren
op_amp
id|ch_ctrl
(braket
id|channel
)braket
dot
id|rs_control
)paren
op_amp
op_complement
id|C_RS_DTR
)paren
suffix:semicolon
macro_line|#ifdef CY_DEBUG_DTR
id|printk
c_func
(paren
l_string|&quot;cyc:set_modem_info clearing Z DTR&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
comma
id|channel
comma
id|C_CM_IOCTLM
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:set_modem_info retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set_modem_info */
multiline_comment|/*&n; * cy_break() --- routine which turns the break handling on or off&n; */
r_static
r_void
DECL|function|cy_break
id|cy_break
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_break&quot;
)paren
)paren
r_return
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
)paren
)paren
(brace
multiline_comment|/* Let the transmit ISR take care of this (since it&n;&t;   requires stuffing characters into the output stream).&n;        */
r_if
c_cond
(paren
id|break_state
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;breakon
)paren
(brace
id|info-&gt;breakon
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;xmit_cnt
)paren
(brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|start_xmit
c_func
(paren
id|info
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;breakoff
)paren
(brace
id|info-&gt;breakoff
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;xmit_cnt
)paren
(brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|start_xmit
c_func
(paren
id|info
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|break_state
op_eq
op_minus
l_int|1
)paren
(brace
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
comma
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|first_line
)paren
comma
id|C_CM_SET_BREAK
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:cy_break (set) retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
comma
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|first_line
)paren
comma
id|C_CM_CLR_BREAK
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc:cy_break (clr) retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
)brace
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* cy_break */
r_static
r_int
DECL|function|get_mon_info
id|get_mon_info
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_struct
id|cyclades_monitor
op_star
id|mon
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|mon
comma
op_amp
id|info-&gt;mon
comma
r_sizeof
(paren
r_struct
id|cyclades_monitor
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|info-&gt;mon.int_count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;mon.char_count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;mon.char_max
op_assign
l_int|0
suffix:semicolon
id|info-&gt;mon.char_last
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get_mon_info */
r_static
r_int
DECL|function|set_threshold
id|set_threshold
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
id|value
)paren
(brace
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|channel
comma
id|chip
comma
id|index
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cy_card
(braket
id|card
)braket
dot
id|first_line
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|info-&gt;cor3
op_and_assign
op_complement
id|CyREC_FIFO
suffix:semicolon
id|info-&gt;cor3
op_or_assign
id|value
op_amp
id|CyREC_FIFO
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCOR3
op_lshift
id|index
)paren
comma
id|info-&gt;cor3
)paren
suffix:semicolon
id|cyy_issue_cmd
c_func
(paren
id|base_addr
comma
id|CyCOR_CHANGE
op_or
id|CyCOR3ch
comma
id|index
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Nothing to do!
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set_threshold */
r_static
r_int
DECL|function|get_threshold
id|get_threshold
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|channel
comma
id|chip
comma
id|index
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cy_card
(braket
id|card
)braket
dot
id|first_line
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyCOR3
op_lshift
id|index
)paren
)paren
op_amp
id|CyREC_FIFO
suffix:semicolon
r_return
id|cy_put_user
c_func
(paren
id|tmp
comma
id|value
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Nothing to do!
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* get_threshold */
r_static
r_int
DECL|function|set_default_threshold
id|set_default_threshold
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
id|value
)paren
(brace
id|info-&gt;default_threshold
op_assign
id|value
op_amp
l_int|0x0f
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set_default_threshold */
r_static
r_int
DECL|function|get_default_threshold
id|get_default_threshold
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_return
id|cy_put_user
c_func
(paren
id|info-&gt;default_threshold
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/* get_default_threshold */
r_static
r_int
DECL|function|set_timeout
id|set_timeout
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
id|value
)paren
(brace
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|channel
comma
id|chip
comma
id|index
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cy_card
(braket
id|card
)braket
dot
id|first_line
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyRTPR
op_lshift
id|index
)paren
comma
id|value
op_amp
l_int|0xff
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Nothing to do!
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set_timeout */
r_static
r_int
DECL|function|get_timeout
id|get_timeout
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|channel
comma
id|chip
comma
id|index
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cy_card
(braket
id|card
)braket
dot
id|first_line
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyRTPR
op_lshift
id|index
)paren
)paren
suffix:semicolon
r_return
id|cy_put_user
c_func
(paren
id|tmp
comma
id|value
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Nothing to do!
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* get_timeout */
r_static
r_int
DECL|function|set_default_timeout
id|set_default_timeout
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
id|value
)paren
(brace
id|info-&gt;default_timeout
op_assign
id|value
op_amp
l_int|0xff
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set_default_timeout */
r_static
r_int
DECL|function|get_default_timeout
id|get_default_timeout
c_func
(paren
r_struct
id|cyclades_port
op_star
id|info
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_return
id|cy_put_user
c_func
(paren
id|info-&gt;default_timeout
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/* get_default_timeout */
multiline_comment|/*&n; * This routine allows the tty driver to implement device-&n; * specific ioctl&squot;s.  If the ioctl number passed in cmd is&n; * not recognized by the driver, it should return ENOIOCTLCMD.&n; */
r_static
r_int
DECL|function|cy_ioctl
id|cy_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|cyclades_icount
id|cprev
comma
id|cnow
suffix:semicolon
multiline_comment|/* kernel counter temps */
r_struct
id|serial_icounter_struct
op_star
id|p_cuser
suffix:semicolon
multiline_comment|/* user space */
r_int
id|ret_val
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_ioctl&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot;cyc:cy_ioctl ttyC%d, cmd = %x arg = %lx&bslash;n&quot;
comma
id|info-&gt;line
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CYGETMON
suffix:colon
id|ret_val
op_assign
id|get_mon_info
c_func
(paren
id|info
comma
(paren
r_struct
id|cyclades_monitor
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYGETTHRESH
suffix:colon
id|ret_val
op_assign
id|get_threshold
c_func
(paren
id|info
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYSETTHRESH
suffix:colon
id|ret_val
op_assign
id|set_threshold
c_func
(paren
id|info
comma
(paren
r_int
r_int
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYGETDEFTHRESH
suffix:colon
id|ret_val
op_assign
id|get_default_threshold
c_func
(paren
id|info
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYSETDEFTHRESH
suffix:colon
id|ret_val
op_assign
id|set_default_threshold
c_func
(paren
id|info
comma
(paren
r_int
r_int
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYGETTIMEOUT
suffix:colon
id|ret_val
op_assign
id|get_timeout
c_func
(paren
id|info
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYSETTIMEOUT
suffix:colon
id|ret_val
op_assign
id|set_timeout
c_func
(paren
id|info
comma
(paren
r_int
r_int
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYGETDEFTIMEOUT
suffix:colon
id|ret_val
op_assign
id|get_default_timeout
c_func
(paren
id|info
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYSETDEFTIMEOUT
suffix:colon
id|ret_val
op_assign
id|set_default_timeout
c_func
(paren
id|info
comma
(paren
r_int
r_int
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYSETRFLOW
suffix:colon
id|info-&gt;rflow
op_assign
(paren
r_int
)paren
id|arg
suffix:semicolon
id|ret_val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYGETRFLOW
suffix:colon
id|ret_val
op_assign
id|info-&gt;rflow
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYSETRTSDTR_INV
suffix:colon
id|info-&gt;rtsdtr_inv
op_assign
(paren
r_int
)paren
id|arg
suffix:semicolon
id|ret_val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYGETRTSDTR_INV
suffix:colon
id|ret_val
op_assign
id|info-&gt;rtsdtr_inv
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYGETCARDINFO
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
(paren
r_void
op_star
)paren
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
comma
r_sizeof
(paren
r_struct
id|cyclades_card
)paren
)paren
)paren
(brace
id|ret_val
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ret_val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYGETCD1400VER
suffix:colon
id|ret_val
op_assign
id|info-&gt;chip_rev
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifndef CONFIG_CYZ_INTR
r_case
id|CYZSETPOLLCYCLE
suffix:colon
id|cyz_polling_cycle
op_assign
(paren
id|arg
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
id|ret_val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYZGETPOLLCYCLE
suffix:colon
id|ret_val
op_assign
(paren
id|cyz_polling_cycle
op_star
l_int|1000
)paren
op_div
id|HZ
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* CONFIG_CYZ_INTR */
r_case
id|CYSETWAIT
suffix:colon
id|info-&gt;closing_wait
op_assign
(paren
r_int
r_int
)paren
id|arg
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
id|ret_val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CYGETWAIT
suffix:colon
id|ret_val
op_assign
id|info-&gt;closing_wait
op_div
(paren
id|HZ
op_div
l_int|100
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMGET
suffix:colon
id|ret_val
op_assign
id|get_modem_info
c_func
(paren
id|info
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMBIS
suffix:colon
r_case
id|TIOCMBIC
suffix:colon
r_case
id|TIOCMSET
suffix:colon
id|ret_val
op_assign
id|set_modem_info
c_func
(paren
id|info
comma
id|cmd
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCGSERIAL
suffix:colon
id|ret_val
op_assign
id|get_serial_info
c_func
(paren
id|info
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
id|ret_val
op_assign
id|set_serial_info
c_func
(paren
id|info
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSERGETLSR
suffix:colon
multiline_comment|/* Get line status register */
id|ret_val
op_assign
id|get_lsr_info
c_func
(paren
id|info
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for any of the 4 modem inputs (DCD,RI,DSR,CTS) to change &n;&t; * - mask passed in arg for lines of interest&n;&t; *   (use |&squot;ed TIOCM_RNG/DSR/CD/CTS for masking)&n;&t; * Caller should use TIOCGICOUNT to see which one it was&n;&t; */
r_case
id|TIOCMIWAIT
suffix:colon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* note the counters on entry */
id|cprev
op_assign
id|info-&gt;icount
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|info-&gt;delta_msr_wait
)paren
suffix:semicolon
multiline_comment|/* see if a signal did it */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cnow
op_assign
id|info-&gt;icount
suffix:semicolon
multiline_comment|/* atomic copy */
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnow.rng
op_eq
id|cprev.rng
op_logical_and
id|cnow.dsr
op_eq
id|cprev.dsr
op_logical_and
id|cnow.dcd
op_eq
id|cprev.dcd
op_logical_and
id|cnow.cts
op_eq
id|cprev.cts
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* no change =&gt; error */
)brace
r_if
c_cond
(paren
(paren
(paren
id|arg
op_amp
id|TIOCM_RNG
)paren
op_logical_and
(paren
id|cnow.rng
op_ne
id|cprev.rng
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DSR
)paren
op_logical_and
(paren
id|cnow.dsr
op_ne
id|cprev.dsr
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CD
)paren
op_logical_and
(paren
id|cnow.dcd
op_ne
id|cprev.dcd
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CTS
)paren
op_logical_and
(paren
id|cnow.cts
op_ne
id|cprev.cts
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|cprev
op_assign
id|cnow
suffix:semicolon
)brace
multiline_comment|/* NOTREACHED */
multiline_comment|/*&n;&t; * Get counter of input serial line interrupts (DCD,RI,DSR,CTS)&n;&t; * Return: write counters to the user passed counter struct&n;&t; * NB: both 1-&gt;0 and 0-&gt;1 transitions are counted except for&n;&t; *     RI where only 0-&gt;1 is counted.&n;&t; */
r_case
id|TIOCGICOUNT
suffix:colon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cnow
op_assign
id|info-&gt;icount
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|p_cuser
op_assign
(paren
r_struct
id|serial_icounter_struct
op_star
)paren
id|arg
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.cts
comma
op_amp
id|p_cuser-&gt;cts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.dsr
comma
op_amp
id|p_cuser-&gt;dsr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.rng
comma
op_amp
id|p_cuser-&gt;rng
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.dcd
comma
op_amp
id|p_cuser-&gt;dcd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.rx
comma
op_amp
id|p_cuser-&gt;rx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.tx
comma
op_amp
id|p_cuser-&gt;tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.frame
comma
op_amp
id|p_cuser-&gt;frame
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.overrun
comma
op_amp
id|p_cuser-&gt;overrun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.parity
comma
op_amp
id|p_cuser-&gt;parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.brk
comma
op_amp
id|p_cuser-&gt;brk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
id|put_user
c_func
(paren
id|cnow.buf_overrun
comma
op_amp
id|p_cuser-&gt;buf_overrun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_val
)paren
r_return
id|ret_val
suffix:semicolon
id|ret_val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret_val
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
macro_line|#ifdef CY_DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot; cyc:cy_ioctl done&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret_val
suffix:semicolon
)brace
multiline_comment|/* cy_ioctl */
multiline_comment|/*&n; * This routine allows the tty driver to be notified when&n; * device&squot;s termios settings have changed.  Note that a&n; * well-designed tty driver should be prepared to accept the case&n; * where old == NULL, and try to do something rational.&n; */
r_static
r_void
DECL|function|cy_set_termios
id|cy_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot;cyc:cy_set_termios ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
op_logical_and
(paren
(paren
id|tty-&gt;termios-&gt;c_iflag
op_amp
(paren
id|IXON
op_or
id|IXANY
)paren
)paren
op_eq
(paren
id|old_termios-&gt;c_iflag
op_amp
(paren
id|IXON
op_or
id|IXANY
)paren
)paren
)paren
)paren
r_return
suffix:semicolon
id|set_line_char
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
id|cy_start
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n;     * No need to wake up processes in open wait, since they&n;     * sample the CLOCAL flag once, and don&squot;t recheck it.&n;     * XXX  It&squot;s not clear whether the current behavior is correct&n;     * or not.  Hence, this may change.....&n;     */
r_if
c_cond
(paren
op_logical_neg
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
op_logical_and
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* cy_set_termios */
multiline_comment|/* This routine is called by the upper-layer tty layer to signal&n;   that incoming characters should be throttled because the input&n;   buffers are close to full.&n; */
r_static
r_void
DECL|function|cy_throttle
id|cy_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
macro_line|#ifdef CY_DEBUG_THROTTLE
r_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cyc:throttle %s: %d....ttyC%d&bslash;n&quot;
comma
id|tty_name
c_func
(paren
id|tty
comma
id|buf
)paren
comma
id|tty-&gt;ldisc
dot
id|chars_in_buffer
c_func
(paren
id|tty
)paren
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_throttle&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
id|info-&gt;x_char
op_assign
id|STOP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
multiline_comment|/* Should use the &quot;Send Special Character&quot; feature!!! */
)brace
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cy_card
(braket
id|card
)braket
dot
id|first_line
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
op_complement
id|CyDTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
op_complement
id|CyRTS
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Nothing to do!
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* cy_throttle */
multiline_comment|/*&n; * This routine notifies the tty driver that it should signal&n; * that characters can now be sent to the tty without fear of&n; * overrunning the input buffers of the line disciplines.&n; */
r_static
r_void
DECL|function|cy_unthrottle
id|cy_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|card
comma
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
macro_line|#ifdef CY_DEBUG_THROTTLE
r_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;cyc:unthrottle %s: %d....ttyC%d&bslash;n&quot;
comma
id|tty_name
c_func
(paren
id|tty
comma
id|buf
)paren
comma
id|tty-&gt;ldisc
dot
id|chars_in_buffer
c_func
(paren
id|tty
)paren
comma
id|info-&gt;line
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_unthrottle&quot;
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;x_char
)paren
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
r_else
id|info-&gt;x_char
op_assign
id|START_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
multiline_comment|/* Should use the &quot;Send Special Character&quot; feature!!! */
)brace
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cy_card
(braket
id|card
)braket
dot
id|first_line
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|index
op_assign
id|cy_card
(braket
id|card
)braket
dot
id|bus_index
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rtsdtr_inv
)paren
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR2
op_lshift
id|index
)paren
comma
id|CyDTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyMSVR1
op_lshift
id|index
)paren
comma
id|CyRTS
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Nothing to do!
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* cy_unthrottle */
multiline_comment|/* cy_start and cy_stop provide software output flow control as a&n;   function of XON/XOFF, software CTS, and other such stuff.&n;*/
r_static
r_void
DECL|function|cy_stop
id|cy_stop
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|cyclades_card
op_star
id|cinfo
suffix:semicolon
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot;cyc:cy_stop ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_stop&quot;
)paren
)paren
r_return
suffix:semicolon
id|cinfo
op_assign
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cinfo-&gt;first_line
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
op_star
id|cinfo
)paren
)paren
(brace
id|index
op_assign
id|cinfo-&gt;bus_index
suffix:semicolon
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
(paren
id|channel
op_amp
l_int|0x0003
)paren
)paren
suffix:semicolon
multiline_comment|/* index channel */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_amp
op_complement
id|CyTxRdy
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Nothing to do!
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* cy_stop */
r_static
r_void
DECL|function|cy_start
id|cy_start
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|cyclades_card
op_star
id|cinfo
suffix:semicolon
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_char
op_star
id|base_addr
suffix:semicolon
r_int
id|chip
comma
id|channel
comma
id|index
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot;cyc:cy_start ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_start&quot;
)paren
)paren
r_return
suffix:semicolon
id|cinfo
op_assign
op_amp
id|cy_card
(braket
id|info-&gt;card
)braket
suffix:semicolon
id|channel
op_assign
id|info-&gt;line
op_minus
id|cinfo-&gt;first_line
suffix:semicolon
id|index
op_assign
id|cinfo-&gt;bus_index
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_CYC_Z
c_func
(paren
op_star
id|cinfo
)paren
)paren
(brace
id|chip
op_assign
id|channel
op_rshift
l_int|2
suffix:semicolon
id|channel
op_and_assign
l_int|0x03
suffix:semicolon
id|base_addr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|cy_card
(braket
id|info-&gt;card
)braket
dot
id|base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip
)braket
op_lshift
id|index
)paren
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCAR
op_lshift
id|index
)paren
comma
(paren
id|u_char
)paren
(paren
id|channel
op_amp
l_int|0x0003
)paren
)paren
suffix:semicolon
multiline_comment|/* index channel */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
comma
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CySRER
op_lshift
id|index
)paren
)paren
op_or
id|CyTxRdy
)paren
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// Nothing to do!
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* cy_start */
r_static
r_void
DECL|function|cy_flush_buffer
id|cy_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|card
comma
id|channel
comma
id|retval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef CY_DEBUG_IO
id|printk
c_func
(paren
l_string|&quot;cyc:cy_flush_buffer ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_flush_buffer&quot;
)paren
)paren
r_return
suffix:semicolon
id|card
op_assign
id|info-&gt;card
suffix:semicolon
id|channel
op_assign
(paren
id|info-&gt;line
)paren
op_minus
(paren
id|cy_card
(braket
id|card
)braket
dot
id|first_line
)paren
suffix:semicolon
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;xmit_cnt
op_assign
id|info-&gt;xmit_head
op_assign
id|info-&gt;xmit_tail
op_assign
l_int|0
suffix:semicolon
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_CYC_Z
c_func
(paren
id|cy_card
(braket
id|card
)braket
)paren
)paren
(brace
multiline_comment|/* If it is a Z card, flush the on-board &n;&t;&t;&t;&t;      buffers as well */
id|CY_LOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
id|cyz_issue_cmd
c_func
(paren
op_amp
id|cy_card
(braket
id|card
)braket
comma
id|channel
comma
id|C_CM_FLUSH_TX
comma
l_int|0L
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cyc: flush_buffer retval on ttyC%d was %x&bslash;n&quot;
comma
id|info-&gt;line
comma
id|retval
)paren
suffix:semicolon
)brace
id|CY_UNLOCK
c_func
(paren
id|info
comma
id|flags
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* cy_flush_buffer */
multiline_comment|/*&n; * cy_hangup() --- called by tty_hangup() when a hangup is signaled.&n; */
r_static
r_void
DECL|function|cy_hangup
id|cy_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
op_assign
(paren
r_struct
id|cyclades_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
macro_line|#ifdef CY_DEBUG_OTHER
id|printk
c_func
(paren
l_string|&quot;cyc:cy_hangup ttyC%d&bslash;n&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
multiline_comment|/* */
macro_line|#endif
r_if
c_cond
(paren
id|serial_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;device
comma
l_string|&quot;cy_hangup&quot;
)paren
)paren
r_return
suffix:semicolon
id|cy_flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;event
op_assign
l_int|0
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CY_DEBUG_COUNT
id|printk
c_func
(paren
l_string|&quot;cyc:cy_hangup (%d): setting count to 0&bslash;n&quot;
comma
id|current-&gt;pid
)paren
suffix:semicolon
macro_line|#endif
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CALLOUT_ACTIVE
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* cy_hangup */
multiline_comment|/*&n; * ---------------------------------------------------------------------&n; * cy_init() and friends&n; *&n; * cy_init() is called at boot-time to initialize the serial driver.&n; * ---------------------------------------------------------------------&n; */
multiline_comment|/* initialize chips on Cyclom-Y card -- return number of valid&n;   chips (which is number of ports/4) */
r_static
r_int
r_int
id|__init
DECL|function|cyy_init_card
id|cyy_init_card
c_func
(paren
r_volatile
id|ucchar
op_star
id|true_base_addr
comma
r_int
id|index
)paren
(brace
r_int
r_int
id|chip_number
suffix:semicolon
r_volatile
id|ucchar
op_star
id|base_addr
suffix:semicolon
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|true_base_addr
op_plus
(paren
id|Cy_HwReset
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Cy_HwReset is 0x1400 */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|true_base_addr
op_plus
(paren
id|Cy_ClrIntr
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Cy_ClrIntr is 0x1800 */
id|udelay
c_func
(paren
l_int|500L
)paren
suffix:semicolon
r_for
c_loop
(paren
id|chip_number
op_assign
l_int|0
suffix:semicolon
id|chip_number
OL
id|CyMAX_CHIPS_PER_CARD
suffix:semicolon
id|chip_number
op_increment
)paren
(brace
id|base_addr
op_assign
id|true_base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip_number
)braket
op_lshift
id|index
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyCCR
op_lshift
id|index
)paren
)paren
op_ne
l_int|0x00
)paren
(brace
multiline_comment|/*************&n;            printk(&quot; chip #%d at %#6lx is never idle (CCR != 0)&bslash;n&quot;,&n;               chip_number, (unsigned long)base_addr);&n;            *************/
r_return
id|chip_number
suffix:semicolon
)brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyGFRCR
op_lshift
id|index
)paren
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10L
)paren
suffix:semicolon
multiline_comment|/* The Cyclom-16Y does not decode address bit 9 and therefore&n;           cannot distinguish between references to chip 0 and a non-&n;           existent chip 4.  If the preceding clearing of the supposed&n;           chip 4 GFRCR register appears at chip 0, there is no chip 4&n;           and this must be a Cyclom-16Y, not a Cyclom-32Ye.&n;        */
r_if
c_cond
(paren
id|chip_number
op_eq
l_int|4
op_logical_and
id|cy_readb
c_func
(paren
id|true_base_addr
op_plus
(paren
id|cy_chip_offset
(braket
l_int|0
)braket
op_lshift
id|index
)paren
op_plus
(paren
id|CyGFRCR
op_lshift
id|index
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
id|chip_number
suffix:semicolon
)brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyCCR
op_lshift
id|index
)paren
comma
id|CyCHIP_RESET
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyGFRCR
op_lshift
id|index
)paren
)paren
op_eq
l_int|0x00
)paren
(brace
multiline_comment|/*&n;            printk(&quot; chip #%d at %#6lx is not responding &quot;,&n;               chip_number, (unsigned long)base_addr);&n;            printk(&quot;(GFRCR stayed 0)&bslash;n&quot;,&n;            */
r_return
id|chip_number
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
l_int|0xf0
op_amp
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyGFRCR
op_lshift
id|index
)paren
)paren
)paren
)paren
op_ne
l_int|0x40
)paren
(brace
multiline_comment|/*&n;            printk(&quot; chip #%d at %#6lx is not valid (GFRCR == %#2x)&bslash;n&quot;,&n;               chip_number, (unsigned long)base_addr,&n;&t;       base_addr[CyGFRCR&lt;&lt;index]);&n;            */
r_return
id|chip_number
suffix:semicolon
)brace
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyGCR
op_lshift
id|index
)paren
comma
id|CyCH0_SERIAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy_readb
c_func
(paren
id|base_addr
op_plus
(paren
id|CyGFRCR
op_lshift
id|index
)paren
)paren
op_ge
id|CD1400_REV_J
)paren
(brace
multiline_comment|/* It is a CD1400 rev. J or later */
multiline_comment|/* Impossible to reach 5ms with this chip. &n;&t;       Changed to 2ms instead (f = 500 Hz). */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyPPR
op_lshift
id|index
)paren
comma
id|CyCLOCK_60_2MS
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* f = 200 Hz */
id|cy_writeb
c_func
(paren
(paren
id|u_long
)paren
id|base_addr
op_plus
(paren
id|CyPPR
op_lshift
id|index
)paren
comma
id|CyCLOCK_25_5MS
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;        printk(&quot; chip #%d at %#6lx is rev 0x%2x&bslash;n&quot;,&n;               chip_number, (unsigned long)base_addr,&n;&t;       cy_readb(base_addr+(CyGFRCR&lt;&lt;index)));&n;    */
)brace
r_return
id|chip_number
suffix:semicolon
)brace
multiline_comment|/* cyy_init_card */
multiline_comment|/*&n; * ---------------------------------------------------------------------&n; * cy_detect_isa() - Probe for Cyclom-Y/ISA boards.&n; * sets global variables and return the number of ISA boards found.&n; * ---------------------------------------------------------------------&n; */
r_static
r_int
id|__init
DECL|function|cy_detect_isa
id|cy_detect_isa
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_ISA
r_int
r_int
id|cy_isa_irq
comma
id|nboard
suffix:semicolon
r_volatile
id|ucchar
op_star
id|cy_isa_address
suffix:semicolon
r_int
r_int
id|i
comma
id|j
comma
id|cy_isa_nchan
suffix:semicolon
macro_line|#ifdef MODULE
r_int
id|isparam
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|nboard
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
multiline_comment|/* Check for module parameters */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|maddr
(braket
id|i
)braket
op_logical_or
id|i
)paren
(brace
id|isparam
op_assign
l_int|1
suffix:semicolon
id|cy_isa_addresses
(braket
id|i
)braket
op_assign
(paren
id|ucchar
op_star
)paren
id|maddr
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|maddr
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* scan the address table probing for Cyclom-Y/ISA boards */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_ISA_ADDRS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cy_isa_address
op_assign
id|cy_isa_addresses
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cy_isa_address
op_eq
l_int|0x0000
)paren
(brace
r_return
id|nboard
suffix:semicolon
)brace
multiline_comment|/* probe for CD1400... */
macro_line|#if !defined(__alpha__)
id|cy_isa_address
op_assign
id|ioremap
c_func
(paren
(paren
id|ulong
)paren
id|cy_isa_address
comma
id|CyISA_Ywin
)paren
suffix:semicolon
macro_line|#endif
id|cy_isa_nchan
op_assign
id|CyPORTS_PER_CHIP
op_star
id|cyy_init_card
c_func
(paren
id|cy_isa_address
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy_isa_nchan
op_eq
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_if
c_cond
(paren
id|isparam
op_logical_and
id|irq
(braket
id|i
)braket
)paren
id|cy_isa_irq
op_assign
id|irq
(braket
id|i
)braket
suffix:semicolon
r_else
macro_line|#endif
multiline_comment|/* find out the board&squot;s irq by probing */
id|cy_isa_irq
op_assign
id|detect_isa_irq
c_func
(paren
id|cy_isa_address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy_isa_irq
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/ISA found at 0x%lx &quot;
comma
(paren
r_int
r_int
)paren
id|cy_isa_address
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but the IRQ could not be detected.&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cy_next_channel
op_plus
id|cy_isa_nchan
)paren
OG
id|NR_PORTS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/ISA found at 0x%lx &quot;
comma
(paren
r_int
r_int
)paren
id|cy_isa_address
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no more channels are available.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_PORTS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|nboard
suffix:semicolon
)brace
multiline_comment|/* fill the next cy_card structure available */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_CARDS
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cy_card
(braket
id|j
)braket
dot
id|base_addr
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
id|NR_CARDS
)paren
(brace
multiline_comment|/* no more cy_cards available */
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/ISA found at 0x%lx &quot;
comma
(paren
r_int
r_int
)paren
id|cy_isa_address
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no more cards can be used .&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_CARDS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|nboard
suffix:semicolon
)brace
multiline_comment|/* allocate IRQ */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|cy_isa_irq
comma
id|cyy_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;Cyclom-Y&quot;
comma
op_amp
id|cy_card
(braket
id|j
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/ISA found at 0x%lx &quot;
comma
(paren
r_int
r_int
)paren
id|cy_isa_address
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but could not allocate IRQ#%d.&bslash;n&quot;
comma
id|cy_isa_irq
)paren
suffix:semicolon
r_return
id|nboard
suffix:semicolon
)brace
multiline_comment|/* set cy_card */
id|cy_card
(braket
id|j
)braket
dot
id|base_addr
op_assign
(paren
id|u_long
)paren
id|cy_isa_address
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|ctl_addr
op_assign
l_int|0
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|irq
op_assign
(paren
r_int
)paren
id|cy_isa_irq
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|bus_index
op_assign
l_int|0
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|first_line
op_assign
id|cy_next_channel
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|num_chips
op_assign
id|cy_isa_nchan
op_div
l_int|4
suffix:semicolon
id|nboard
op_increment
suffix:semicolon
multiline_comment|/* print message */
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/ISA #%d: 0x%lx-0x%lx, IRQ%d, &quot;
comma
id|j
op_plus
l_int|1
comma
(paren
r_int
r_int
)paren
id|cy_isa_address
comma
(paren
r_int
r_int
)paren
(paren
id|cy_isa_address
op_plus
(paren
id|CyISA_Ywin
op_minus
l_int|1
)paren
)paren
comma
id|cy_isa_irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d channels starting from port %d.&bslash;n&quot;
comma
id|cy_isa_nchan
comma
id|cy_next_channel
)paren
suffix:semicolon
id|cy_next_channel
op_add_assign
id|cy_isa_nchan
suffix:semicolon
)brace
r_return
id|nboard
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif /* CONFIG_ISA */
)brace
multiline_comment|/* cy_detect_isa */
r_static
r_void
DECL|function|plx_init
id|plx_init
c_func
(paren
id|uclong
id|addr
comma
id|uclong
id|initctl
)paren
(brace
multiline_comment|/* Reset PLX */
id|cy_writel
c_func
(paren
id|addr
op_plus
id|initctl
comma
id|cy_readl
c_func
(paren
id|addr
op_plus
id|initctl
)paren
op_or
l_int|0x40000000
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100L
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
id|addr
op_plus
id|initctl
comma
id|cy_readl
c_func
(paren
id|addr
op_plus
id|initctl
)paren
op_amp
op_complement
l_int|0x40000000
)paren
suffix:semicolon
multiline_comment|/* Reload Config. Registers from EEPROM */
id|cy_writel
c_func
(paren
id|addr
op_plus
id|initctl
comma
id|cy_readl
c_func
(paren
id|addr
op_plus
id|initctl
)paren
op_or
l_int|0x20000000
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100L
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
id|addr
op_plus
id|initctl
comma
id|cy_readl
c_func
(paren
id|addr
op_plus
id|initctl
)paren
op_amp
op_complement
l_int|0x20000000
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ---------------------------------------------------------------------&n; * cy_detect_pci() - Test PCI bus presence and Cyclom-Ye/PCI.&n; * sets global variables and return the number of PCI boards found.&n; * ---------------------------------------------------------------------&n; */
r_static
r_int
id|__init
DECL|function|cy_detect_pci
id|cy_detect_pci
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PCI
r_struct
id|pci_dev
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
id|cyy_rev_id
suffix:semicolon
r_int
r_char
id|cy_pci_irq
op_assign
l_int|0
suffix:semicolon
id|uclong
id|cy_pci_phys0
comma
id|cy_pci_phys1
comma
id|cy_pci_phys2
suffix:semicolon
id|uclong
id|cy_pci_addr0
comma
id|cy_pci_addr2
suffix:semicolon
r_int
r_int
id|i
comma
id|j
comma
id|cy_pci_nchan
comma
id|plx_ver
suffix:semicolon
r_int
r_int
id|device_id
comma
id|dev_index
op_assign
l_int|0
suffix:semicolon
id|uclong
id|mailbox
suffix:semicolon
id|uclong
id|Ze_addr0
(braket
id|NR_CARDS
)braket
comma
id|Ze_addr2
(braket
id|NR_CARDS
)braket
comma
id|ZeIndex
op_assign
l_int|0
suffix:semicolon
id|uclong
id|Ze_phys0
(braket
id|NR_CARDS
)braket
comma
id|Ze_phys2
(braket
id|NR_CARDS
)braket
suffix:semicolon
r_int
r_char
id|Ze_irq
(braket
id|NR_CARDS
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* look for a Cyclades card by vendor and device id */
r_while
c_loop
(paren
(paren
id|device_id
op_assign
id|cy_pci_dev_id
(braket
id|dev_index
)braket
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|pdev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_CYCLADES
comma
id|device_id
comma
id|pdev
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|dev_index
op_increment
suffix:semicolon
multiline_comment|/* try next device id */
)brace
r_else
(brace
r_break
suffix:semicolon
multiline_comment|/* found a board */
)brace
)brace
r_if
c_cond
(paren
id|device_id
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* read PCI configuration area */
id|cy_pci_irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|cy_pci_phys0
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|cy_pci_phys1
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|1
)paren
suffix:semicolon
id|cy_pci_phys2
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_REVISION_ID
comma
op_amp
id|cyy_rev_id
)paren
suffix:semicolon
id|device_id
op_and_assign
op_complement
id|PCI_DEVICE_ID_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|device_id
op_eq
id|PCI_DEVICE_ID_CYCLOM_Y_Lo
)paren
op_logical_or
(paren
id|device_id
op_eq
id|PCI_DEVICE_ID_CYCLOM_Y_Hi
)paren
)paren
(brace
macro_line|#ifdef CY_PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI (bus=0x0%x, pci_id=0x%x, &quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rev_id=%d) IRQ%d&bslash;n&quot;
comma
id|cyy_rev_id
comma
(paren
r_int
)paren
id|cy_pci_irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI:found  winaddr=0x%lx ctladdr=0x%lx&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
comma
(paren
id|ulong
)paren
id|cy_pci_phys0
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|2
)paren
op_amp
id|IORESOURCE_IO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  Warning: PCI I/O bit incorrectly set. &quot;
l_string|&quot;Ignoring it...&bslash;n&quot;
)paren
suffix:semicolon
id|pdev-&gt;resource
(braket
l_int|2
)braket
dot
id|flags
op_and_assign
op_complement
id|IORESOURCE_IO
suffix:semicolon
)brace
multiline_comment|/* Although we don&squot;t use this I/O region, we should&n;&t;&t;   request it from the kernel anyway, to avoid problems&n;&t;&t;   with other drivers accessing it. */
id|request_region
c_func
(paren
id|cy_pci_phys1
comma
id|CyPCI_Yctl
comma
l_string|&quot;Cyclom-Y&quot;
)paren
suffix:semicolon
macro_line|#if defined(__alpha__)
r_if
c_cond
(paren
id|device_id
op_eq
id|PCI_DEVICE_ID_CYCLOM_Y_Lo
)paren
(brace
multiline_comment|/* below 1M? */
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI (bus=0x0%x, pci_id=0x%x, &quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rev_id=%d) IRQ%d&bslash;n&quot;
comma
id|cyy_rev_id
comma
(paren
r_int
)paren
id|cy_pci_irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI:found  winaddr=0x%lx ctladdr=0x%lx&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
comma
(paren
id|ulong
)paren
id|cy_pci_phys0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI not supported for low addresses in &quot;
l_string|&quot;Alpha systems.&bslash;n&quot;
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
id|cy_pci_addr0
op_assign
(paren
id|ulong
)paren
id|ioremap
c_func
(paren
id|cy_pci_phys0
comma
id|CyPCI_Yctl
)paren
suffix:semicolon
id|cy_pci_addr2
op_assign
(paren
id|ulong
)paren
id|ioremap
c_func
(paren
id|cy_pci_phys2
comma
id|CyPCI_Ywin
)paren
suffix:semicolon
macro_line|#ifdef CY_PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI: relocate winaddr=0x%lx ctladdr=0x%lx&bslash;n&quot;
comma
(paren
id|u_long
)paren
id|cy_pci_addr2
comma
(paren
id|u_long
)paren
id|cy_pci_addr0
)paren
suffix:semicolon
macro_line|#endif
id|cy_pci_nchan
op_assign
(paren
r_int
r_int
)paren
(paren
id|CyPORTS_PER_CHIP
op_star
id|cyy_init_card
c_func
(paren
(paren
r_volatile
id|ucchar
op_star
)paren
id|cy_pci_addr2
comma
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy_pci_nchan
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y PCI host card with &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;no Serial-Modules at 0x%lx.&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cy_next_channel
op_plus
id|cy_pci_nchan
)paren
OG
id|NR_PORTS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no channels are available.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_PORTS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* fill the next cy_card structure available */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_CARDS
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cy_card
(braket
id|j
)braket
dot
id|base_addr
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
id|NR_CARDS
)paren
(brace
multiline_comment|/* no more cy_cards available */
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no more cards can be used.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_CARDS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* allocate IRQ */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|cy_pci_irq
comma
id|cyy_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;Cyclom-Y&quot;
comma
op_amp
id|cy_card
(braket
id|j
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but could not allocate IRQ%d.&bslash;n&quot;
comma
id|cy_pci_irq
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* set cy_card */
id|cy_card
(braket
id|j
)braket
dot
id|base_phys
op_assign
(paren
id|ulong
)paren
id|cy_pci_phys2
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|ctl_phys
op_assign
(paren
id|ulong
)paren
id|cy_pci_phys0
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|base_addr
op_assign
(paren
id|ulong
)paren
id|cy_pci_addr2
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|ctl_addr
op_assign
(paren
id|ulong
)paren
id|cy_pci_addr0
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|irq
op_assign
(paren
r_int
)paren
id|cy_pci_irq
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|bus_index
op_assign
l_int|1
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|first_line
op_assign
id|cy_next_channel
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|num_chips
op_assign
id|cy_pci_nchan
op_div
l_int|4
suffix:semicolon
multiline_comment|/* enable interrupts in the PCI interface */
id|plx_ver
op_assign
id|cy_readb
c_func
(paren
id|cy_pci_addr2
op_plus
id|CyPLX_VER
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_switch
c_cond
(paren
id|plx_ver
)paren
(brace
r_case
id|PLX_9050
suffix:colon
id|cy_writeb
c_func
(paren
id|cy_pci_addr0
op_plus
l_int|0x4c
comma
l_int|0x43
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PLX_9060
suffix:colon
r_case
id|PLX_9080
suffix:colon
r_default
suffix:colon
multiline_comment|/* Old boards, use PLX_9060 */
id|plx_init
c_func
(paren
id|cy_pci_addr0
comma
l_int|0x6c
)paren
suffix:semicolon
multiline_comment|/* For some yet unknown reason, once the PLX9060 reloads&n;&t;&t;       the EEPROM, the IRQ is lost and, thus, we have to&n;&t;&t;       re-write it to the PCI config. registers.&n;&t;&t;       This will remain here until we find a permanent fix. */
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_INTERRUPT_LINE
comma
id|cy_pci_irq
)paren
suffix:semicolon
id|cy_writew
c_func
(paren
id|cy_pci_addr0
op_plus
l_int|0x68
comma
id|cy_readw
c_func
(paren
id|cy_pci_addr0
op_plus
l_int|0x68
)paren
op_or
l_int|0x0900
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* print message */
id|printk
c_func
(paren
l_string|&quot;Cyclom-Y/PCI #%d: 0x%lx-0x%lx, IRQ%d, &quot;
comma
id|j
op_plus
l_int|1
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
comma
(paren
id|ulong
)paren
(paren
id|cy_pci_phys2
op_plus
id|CyPCI_Ywin
op_minus
l_int|1
)paren
comma
(paren
r_int
)paren
id|cy_pci_irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d channels starting from port %d.&bslash;n&quot;
comma
id|cy_pci_nchan
comma
id|cy_next_channel
)paren
suffix:semicolon
id|cy_next_channel
op_add_assign
id|cy_pci_nchan
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|device_id
op_eq
id|PCI_DEVICE_ID_CYCLOM_Z_Lo
)paren
(brace
multiline_comment|/* print message */
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z/PCI (bus=0x0%x, pci_id=0x%x, &quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rev_id=%d) IRQ%d&bslash;n&quot;
comma
id|cyy_rev_id
comma
(paren
r_int
)paren
id|cy_pci_irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z/PCI: found winaddr=0x%lx ctladdr=0x%lx&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
comma
(paren
id|ulong
)paren
id|cy_pci_phys0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z/PCI not supported for low addresses&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|device_id
op_eq
id|PCI_DEVICE_ID_CYCLOM_Z_Hi
)paren
(brace
macro_line|#ifdef CY_PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z/PCI (bus=0x0%x, pci_id=0x%x, &quot;
comma
id|pdev-&gt;bus-&gt;number
comma
id|pdev-&gt;devfn
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rev_id=%d) IRQ%d&bslash;n&quot;
comma
id|cyy_rev_id
comma
(paren
r_int
)paren
id|cy_pci_irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z/PCI: found winaddr=0x%lx ctladdr=0x%lx&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
comma
(paren
id|ulong
)paren
id|cy_pci_phys0
)paren
suffix:semicolon
macro_line|#endif
id|cy_pci_addr0
op_assign
(paren
id|ulong
)paren
id|ioremap
c_func
(paren
id|cy_pci_phys0
comma
id|CyPCI_Zctl
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts on the PLX before resetting it */
id|cy_writew
c_func
(paren
id|cy_pci_addr0
op_plus
l_int|0x68
comma
id|cy_readw
c_func
(paren
id|cy_pci_addr0
op_plus
l_int|0x68
)paren
op_amp
op_complement
l_int|0x0900
)paren
suffix:semicolon
id|plx_init
c_func
(paren
id|cy_pci_addr0
comma
l_int|0x6c
)paren
suffix:semicolon
multiline_comment|/* For some yet unknown reason, once the PLX9060 reloads&n;&t;&t;   the EEPROM, the IRQ is lost and, thus, we have to&n;&t;&t;   re-write it to the PCI config. registers.&n;&t;&t;   This will remain here until we find a permanent fix. */
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_INTERRUPT_LINE
comma
id|cy_pci_irq
)paren
suffix:semicolon
id|mailbox
op_assign
(paren
id|uclong
)paren
id|cy_readl
c_func
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
id|cy_pci_addr0
)paren
op_member_access_from_pointer
id|mail_box_0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
l_int|2
)paren
op_amp
id|IORESOURCE_IO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  Warning: PCI I/O bit incorrectly set. &quot;
l_string|&quot;Ignoring it...&bslash;n&quot;
)paren
suffix:semicolon
id|pdev-&gt;resource
(braket
l_int|2
)braket
dot
id|flags
op_and_assign
op_complement
id|IORESOURCE_IO
suffix:semicolon
)brace
multiline_comment|/* Although we don&squot;t use this I/O region, we should&n;&t;&t;   request it from the kernel anyway, to avoid problems&n;&t;&t;   with other drivers accessing it. */
id|request_region
c_func
(paren
id|cy_pci_phys1
comma
id|CyPCI_Zctl
comma
l_string|&quot;Cyclades-Z&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mailbox
op_eq
id|ZE_V1
)paren
(brace
id|cy_pci_addr2
op_assign
(paren
id|ulong
)paren
id|ioremap
c_func
(paren
id|cy_pci_phys2
comma
id|CyPCI_Ze_win
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ZeIndex
op_eq
id|NR_CARDS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclades-Ze/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no more cards can be used.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_CARDS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|Ze_phys0
(braket
id|ZeIndex
)braket
op_assign
id|cy_pci_phys0
suffix:semicolon
id|Ze_phys2
(braket
id|ZeIndex
)braket
op_assign
id|cy_pci_phys2
suffix:semicolon
id|Ze_addr0
(braket
id|ZeIndex
)braket
op_assign
id|cy_pci_addr0
suffix:semicolon
id|Ze_addr2
(braket
id|ZeIndex
)braket
op_assign
id|cy_pci_addr2
suffix:semicolon
id|Ze_irq
(braket
id|ZeIndex
)braket
op_assign
id|cy_pci_irq
suffix:semicolon
id|ZeIndex
op_increment
suffix:semicolon
)brace
id|i
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
id|cy_pci_addr2
op_assign
(paren
id|ulong
)paren
id|ioremap
c_func
(paren
id|cy_pci_phys2
comma
id|CyPCI_Zwin
)paren
suffix:semicolon
)brace
macro_line|#ifdef CY_PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z/PCI: relocate winaddr=0x%lx ctladdr=0x%lx&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|cy_pci_addr2
comma
(paren
id|ulong
)paren
id|cy_pci_addr0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mailbox
op_eq
id|ZO_V1
)paren
(brace
id|cy_writel
c_func
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
(paren
id|cy_pci_addr0
)paren
)paren
op_member_access_from_pointer
id|loc_addr_base
comma
id|WIN_CREG
)paren
suffix:semicolon
id|PAUSE
id|printk
c_func
(paren
l_string|&quot;Cyclades-8Zo/PCI: FPGA id %lx, ver %lx&bslash;n&quot;
comma
(paren
id|ulong
)paren
(paren
l_int|0xff
op_amp
id|cy_readl
c_func
(paren
op_amp
(paren
(paren
r_struct
id|CUSTOM_REG
op_star
)paren
(paren
id|cy_pci_addr2
)paren
)paren
op_member_access_from_pointer
id|fpga_id
)paren
)paren
comma
(paren
id|ulong
)paren
(paren
l_int|0xff
op_amp
id|cy_readl
c_func
(paren
op_amp
(paren
(paren
r_struct
id|CUSTOM_REG
op_star
)paren
(paren
id|cy_pci_addr2
)paren
)paren
op_member_access_from_pointer
id|fpga_version
)paren
)paren
)paren
suffix:semicolon
id|cy_writel
c_func
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
(paren
id|cy_pci_addr0
)paren
)paren
op_member_access_from_pointer
id|loc_addr_base
comma
id|WIN_RAM
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z/PCI: New Cyclades-Z board.  FPGA not loaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* The following clears the firmware id word.  This ensures&n;&t;       that the driver will not attempt to talk to the board&n;&t;       until it has been properly initialized.&n;&t;     */
id|PAUSE
r_if
c_cond
(paren
(paren
id|mailbox
op_eq
id|ZO_V1
)paren
op_logical_or
(paren
id|mailbox
op_eq
id|ZO_V2
)paren
)paren
id|cy_writel
c_func
(paren
(paren
id|ulong
)paren
(paren
id|cy_pci_addr2
op_plus
id|ID_ADDRESS
)paren
comma
l_int|0L
)paren
suffix:semicolon
multiline_comment|/* This must be a Cyclades-8Zo/PCI.  The extendable&n;                   version will have a different device_id and will&n;                   be allocated its maximum number of ports. */
id|cy_pci_nchan
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cy_next_channel
op_plus
id|cy_pci_nchan
)paren
OG
id|NR_PORTS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclades-8Zo/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no channels are available.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_PORTS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* fill the next cy_card structure available */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_CARDS
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cy_card
(braket
id|j
)braket
dot
id|base_addr
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
id|NR_CARDS
)paren
(brace
multiline_comment|/* no more cy_cards available */
id|printk
c_func
(paren
l_string|&quot;Cyclades-8Zo/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no more cards can be used.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_CARDS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CYZ_INTR
multiline_comment|/* allocate IRQ only if board has an IRQ */
r_if
c_cond
(paren
(paren
id|cy_pci_irq
op_ne
l_int|0
)paren
op_logical_and
(paren
id|cy_pci_irq
op_ne
l_int|255
)paren
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|cy_pci_irq
comma
id|cyz_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;Cyclades-Z&quot;
comma
op_amp
id|cy_card
(braket
id|j
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclom-8Zo/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but could not allocate IRQ%d.&bslash;n&quot;
comma
id|cy_pci_irq
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_CYZ_INTR */
multiline_comment|/* set cy_card */
id|cy_card
(braket
id|j
)braket
dot
id|base_phys
op_assign
id|cy_pci_phys2
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|ctl_phys
op_assign
id|cy_pci_phys0
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|base_addr
op_assign
id|cy_pci_addr2
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|ctl_addr
op_assign
id|cy_pci_addr0
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|irq
op_assign
(paren
r_int
)paren
id|cy_pci_irq
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|bus_index
op_assign
l_int|1
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|first_line
op_assign
id|cy_next_channel
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|num_chips
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* print message */
macro_line|#ifdef CONFIG_CYZ_INTR
multiline_comment|/* don&squot;t report IRQ if board is no IRQ */
r_if
c_cond
(paren
(paren
id|cy_pci_irq
op_ne
l_int|0
)paren
op_logical_and
(paren
id|cy_pci_irq
op_ne
l_int|255
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclades-8Zo/PCI #%d: 0x%lx-0x%lx, IRQ%d, &quot;
comma
id|j
op_plus
l_int|1
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
comma
(paren
id|ulong
)paren
(paren
id|cy_pci_phys2
op_plus
id|CyPCI_Zwin
op_minus
l_int|1
)paren
comma
(paren
r_int
)paren
id|cy_pci_irq
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif /* CONFIG_CYZ_INTR */
id|printk
c_func
(paren
l_string|&quot;Cyclades-8Zo/PCI #%d: 0x%lx-0x%lx, &quot;
comma
id|j
op_plus
l_int|1
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
comma
(paren
id|ulong
)paren
(paren
id|cy_pci_phys2
op_plus
id|CyPCI_Zwin
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d channels starting from port %d.&bslash;n&quot;
comma
id|cy_pci_nchan
comma
id|cy_next_channel
)paren
suffix:semicolon
id|cy_next_channel
op_add_assign
id|cy_pci_nchan
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
suffix:semicolon
id|ZeIndex
op_ne
l_int|0
op_logical_and
id|i
OL
id|NR_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cy_pci_phys0
op_assign
id|Ze_phys0
(braket
l_int|0
)braket
suffix:semicolon
id|cy_pci_phys2
op_assign
id|Ze_phys2
(braket
l_int|0
)braket
suffix:semicolon
id|cy_pci_addr0
op_assign
id|Ze_addr0
(braket
l_int|0
)braket
suffix:semicolon
id|cy_pci_addr2
op_assign
id|Ze_addr2
(braket
l_int|0
)braket
suffix:semicolon
id|cy_pci_irq
op_assign
id|Ze_irq
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ZeIndex
op_minus
l_int|1
suffix:semicolon
id|j
op_increment
)paren
(brace
id|Ze_phys0
(braket
id|j
)braket
op_assign
id|Ze_phys0
(braket
id|j
op_plus
l_int|1
)braket
suffix:semicolon
id|Ze_phys2
(braket
id|j
)braket
op_assign
id|Ze_phys2
(braket
id|j
op_plus
l_int|1
)braket
suffix:semicolon
id|Ze_addr0
(braket
id|j
)braket
op_assign
id|Ze_addr0
(braket
id|j
op_plus
l_int|1
)braket
suffix:semicolon
id|Ze_addr2
(braket
id|j
)braket
op_assign
id|Ze_addr2
(braket
id|j
op_plus
l_int|1
)braket
suffix:semicolon
id|Ze_irq
(braket
id|j
)braket
op_assign
id|Ze_irq
(braket
id|j
op_plus
l_int|1
)braket
suffix:semicolon
)brace
id|ZeIndex
op_decrement
suffix:semicolon
id|mailbox
op_assign
(paren
id|uclong
)paren
id|cy_readl
c_func
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
id|cy_pci_addr0
)paren
op_member_access_from_pointer
id|mail_box_0
)paren
suffix:semicolon
macro_line|#ifdef CY_PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z/PCI: relocate winaddr=0x%lx ctladdr=0x%lx&bslash;n&quot;
comma
(paren
id|ulong
)paren
id|cy_pci_addr2
comma
(paren
id|ulong
)paren
id|cy_pci_addr0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z/PCI: New Cyclades-Z board.  FPGA not loaded&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|PAUSE
multiline_comment|/* This must be the new Cyclades-Ze/PCI. */
id|cy_pci_nchan
op_assign
id|ZE_V1_NPORTS
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cy_next_channel
op_plus
id|cy_pci_nchan
)paren
OG
id|NR_PORTS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclades-Ze/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no channels are available.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_PORTS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* fill the next cy_card structure available */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NR_CARDS
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cy_card
(braket
id|j
)braket
dot
id|base_addr
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
id|NR_CARDS
)paren
(brace
multiline_comment|/* no more cy_cards available */
id|printk
c_func
(paren
l_string|&quot;Cyclades-Ze/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no more cards can be used.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_CARDS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CYZ_INTR
multiline_comment|/* allocate IRQ only if board has an IRQ */
r_if
c_cond
(paren
(paren
id|cy_pci_irq
op_ne
l_int|0
)paren
op_logical_and
(paren
id|cy_pci_irq
op_ne
l_int|255
)paren
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|cy_pci_irq
comma
id|cyz_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;Cyclades-Z&quot;
comma
op_amp
id|cy_card
(braket
id|j
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclom-Ze/PCI found at 0x%lx &quot;
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but could not allocate IRQ%d.&bslash;n&quot;
comma
id|cy_pci_irq
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_CYZ_INTR */
multiline_comment|/* set cy_card */
id|cy_card
(braket
id|j
)braket
dot
id|base_phys
op_assign
id|cy_pci_phys2
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|ctl_phys
op_assign
id|cy_pci_phys0
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|base_addr
op_assign
id|cy_pci_addr2
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|ctl_addr
op_assign
id|cy_pci_addr0
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|irq
op_assign
(paren
r_int
)paren
id|cy_pci_irq
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|bus_index
op_assign
l_int|1
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|first_line
op_assign
id|cy_next_channel
suffix:semicolon
id|cy_card
(braket
id|j
)braket
dot
id|num_chips
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* print message */
macro_line|#ifdef CONFIG_CYZ_INTR
multiline_comment|/* don&squot;t report IRQ if board is no IRQ */
r_if
c_cond
(paren
(paren
id|cy_pci_irq
op_ne
l_int|0
)paren
op_logical_and
(paren
id|cy_pci_irq
op_ne
l_int|255
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclades-Ze/PCI #%d: 0x%lx-0x%lx, IRQ%d, &quot;
comma
id|j
op_plus
l_int|1
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
comma
(paren
id|ulong
)paren
(paren
id|cy_pci_phys2
op_plus
id|CyPCI_Ze_win
op_minus
l_int|1
)paren
comma
(paren
r_int
)paren
id|cy_pci_irq
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif /* CONFIG_CYZ_INTR */
id|printk
c_func
(paren
l_string|&quot;Cyclades-Ze/PCI #%d: 0x%lx-0x%lx, &quot;
comma
id|j
op_plus
l_int|1
comma
(paren
id|ulong
)paren
id|cy_pci_phys2
comma
(paren
id|ulong
)paren
(paren
id|cy_pci_phys2
op_plus
id|CyPCI_Ze_win
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%d channels starting from port %d.&bslash;n&quot;
comma
id|cy_pci_nchan
comma
id|cy_next_channel
)paren
suffix:semicolon
id|cy_next_channel
op_add_assign
id|cy_pci_nchan
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ZeIndex
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cyclades-Ze/PCI found at 0x%x &quot;
comma
(paren
r_int
r_int
)paren
id|Ze_phys2
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;but no more cards can be used.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Change NR_CARDS in cyclades.c and recompile kernel.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif /* ifdef CONFIG_PCI */
)brace
multiline_comment|/* cy_detect_pci */
multiline_comment|/*&n; * This routine prints out the appropriate serial driver version number&n; * and identifies which options were configured into this driver.&n; */
r_static
r_inline
r_void
DECL|function|show_version
id|show_version
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|rcsvers
comma
op_star
id|rcsdate
comma
op_star
id|tmp
suffix:semicolon
id|rcsvers
op_assign
id|strchr
c_func
(paren
id|rcsid
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
id|rcsvers
op_increment
suffix:semicolon
id|tmp
op_assign
id|strchr
c_func
(paren
id|rcsvers
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
op_star
id|tmp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|rcsdate
op_assign
id|strchr
c_func
(paren
id|tmp
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
id|rcsdate
op_increment
suffix:semicolon
id|tmp
op_assign
id|strrchr
c_func
(paren
id|rcsdate
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
op_star
id|tmp
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Cyclades driver %s %s&bslash;n&quot;
comma
id|rcsvers
comma
id|rcsdate
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;        built %s %s&bslash;n&quot;
comma
id|__DATE__
comma
id|__TIME__
)paren
suffix:semicolon
)brace
multiline_comment|/* show_version */
r_static
r_int
DECL|function|cyclades_get_proc_info
id|cyclades_get_proc_info
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
r_int
id|size
suffix:semicolon
id|__u32
id|cur_jifs
op_assign
id|jiffies
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;Dev TimeOpen   BytesOut  IdleOut    BytesIn   IdleIn  Overruns  Ldisc&bslash;n&quot;
)paren
suffix:semicolon
id|pos
op_add_assign
id|size
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
multiline_comment|/* Output one line for each known port */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PORTS
op_logical_and
id|cy_port
(braket
id|i
)braket
dot
id|line
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
id|info
op_assign
op_amp
id|cy_port
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;count
)paren
id|size
op_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%3d %8lu %10lu %8lu %10lu %8lu %9lu %6ld&bslash;n&quot;
comma
id|info-&gt;line
comma
id|JIFFIES_DIFF
c_func
(paren
id|info-&gt;idle_stats.in_use
comma
id|cur_jifs
)paren
op_div
id|HZ
comma
id|info-&gt;idle_stats.xmit_bytes
comma
id|JIFFIES_DIFF
c_func
(paren
id|info-&gt;idle_stats.xmit_idle
comma
id|cur_jifs
)paren
op_div
id|HZ
comma
id|info-&gt;idle_stats.recv_bytes
comma
id|JIFFIES_DIFF
c_func
(paren
id|info-&gt;idle_stats.recv_idle
comma
id|cur_jifs
)paren
op_div
id|HZ
comma
id|info-&gt;idle_stats.overruns
comma
(paren
r_int
)paren
id|info-&gt;tty-&gt;ldisc.num
)paren
suffix:semicolon
r_else
id|size
op_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%3d %8lu %10lu %8lu %10lu %8lu %9lu %6ld&bslash;n&quot;
comma
id|info-&gt;line
comma
l_int|0L
comma
l_int|0L
comma
l_int|0L
comma
l_int|0L
comma
l_int|0L
comma
l_int|0L
comma
l_int|0L
)paren
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
r_goto
id|done
suffix:semicolon
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|done
suffix:colon
op_star
id|start
op_assign
id|buf
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
multiline_comment|/* Start of wanted data */
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
multiline_comment|/* Start slop */
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
multiline_comment|/* Ending slop */
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* The serial driver boot-time initialization code!&n;    Hardware I/O ports are mapped to character special devices on a&n;    first found, first allocated manner.  That is, this code searches&n;    for Cyclom cards in the system.  As each is found, it is probed&n;    to discover how many chips (and thus how many ports) are present.&n;    These ports are mapped to the tty ports 32 and upward in monotonic&n;    fashion.  If an 8-port card is replaced with a 16-port card, the&n;    port mapping on a following card will shift.&n;&n;    This approach is different from what is used in the other serial&n;    device driver because the Cyclom is more properly a multiplexer,&n;    not just an aggregation of serial ports on one card.&n;&n;    If there are more cards with more ports than have been&n;    statically allocated above, a warning is printed and the&n;    extra ports are ignored.&n; */
r_int
id|__init
DECL|function|cy_init
id|cy_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|cyclades_port
op_star
id|info
suffix:semicolon
r_struct
id|cyclades_card
op_star
id|cinfo
suffix:semicolon
r_int
id|number_z_boards
op_assign
l_int|0
suffix:semicolon
r_int
id|board
comma
id|port
comma
id|i
comma
id|index
suffix:semicolon
r_int
r_int
id|mailbox
suffix:semicolon
r_int
r_int
id|chip_number
suffix:semicolon
r_int
id|nports
suffix:semicolon
id|init_bh
c_func
(paren
id|CYCLADES_BH
comma
id|do_cyclades_bh
)paren
suffix:semicolon
id|show_version
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the tty_driver structure */
id|memset
c_func
(paren
op_amp
id|cy_serial_driver
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty_driver
)paren
)paren
suffix:semicolon
id|cy_serial_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|cy_serial_driver.driver_name
op_assign
l_string|&quot;cyclades&quot;
suffix:semicolon
id|cy_serial_driver.name
op_assign
l_string|&quot;ttyC&quot;
suffix:semicolon
id|cy_serial_driver.major
op_assign
id|CYCLADES_MAJOR
suffix:semicolon
id|cy_serial_driver.minor_start
op_assign
l_int|0
suffix:semicolon
id|cy_serial_driver.num
op_assign
id|NR_PORTS
suffix:semicolon
id|cy_serial_driver.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|cy_serial_driver.subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|cy_serial_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|cy_serial_driver.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|cy_serial_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|cy_serial_driver.refcount
op_assign
op_amp
id|serial_refcount
suffix:semicolon
id|cy_serial_driver.table
op_assign
id|serial_table
suffix:semicolon
id|cy_serial_driver.termios
op_assign
id|serial_termios
suffix:semicolon
id|cy_serial_driver.termios_locked
op_assign
id|serial_termios_locked
suffix:semicolon
id|cy_serial_driver.open
op_assign
id|cy_open
suffix:semicolon
id|cy_serial_driver.close
op_assign
id|cy_close
suffix:semicolon
id|cy_serial_driver.write
op_assign
id|cy_write
suffix:semicolon
id|cy_serial_driver.put_char
op_assign
id|cy_put_char
suffix:semicolon
id|cy_serial_driver.flush_chars
op_assign
id|cy_flush_chars
suffix:semicolon
id|cy_serial_driver.write_room
op_assign
id|cy_write_room
suffix:semicolon
id|cy_serial_driver.chars_in_buffer
op_assign
id|cy_chars_in_buffer
suffix:semicolon
id|cy_serial_driver.flush_buffer
op_assign
id|cy_flush_buffer
suffix:semicolon
id|cy_serial_driver.ioctl
op_assign
id|cy_ioctl
suffix:semicolon
id|cy_serial_driver.throttle
op_assign
id|cy_throttle
suffix:semicolon
id|cy_serial_driver.unthrottle
op_assign
id|cy_unthrottle
suffix:semicolon
id|cy_serial_driver.set_termios
op_assign
id|cy_set_termios
suffix:semicolon
id|cy_serial_driver.stop
op_assign
id|cy_stop
suffix:semicolon
id|cy_serial_driver.start
op_assign
id|cy_start
suffix:semicolon
id|cy_serial_driver.hangup
op_assign
id|cy_hangup
suffix:semicolon
id|cy_serial_driver.break_ctl
op_assign
id|cy_break
suffix:semicolon
id|cy_serial_driver.wait_until_sent
op_assign
id|cy_wait_until_sent
suffix:semicolon
id|cy_serial_driver.read_proc
op_assign
id|cyclades_get_proc_info
suffix:semicolon
multiline_comment|/*&n;     * The callout device is just like normal device except for&n;     * major number and the subtype code.&n;     */
id|cy_callout_driver
op_assign
id|cy_serial_driver
suffix:semicolon
id|cy_callout_driver.name
op_assign
l_string|&quot;cub&quot;
suffix:semicolon
id|cy_callout_driver.major
op_assign
id|CYCLADESAUX_MAJOR
suffix:semicolon
id|cy_callout_driver.subtype
op_assign
id|SERIAL_TYPE_CALLOUT
suffix:semicolon
id|cy_callout_driver.read_proc
op_assign
l_int|0
suffix:semicolon
id|cy_callout_driver.proc_entry
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|cy_serial_driver
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t register Cyclades serial driver&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
op_amp
id|cy_callout_driver
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t register Cyclades callout driver&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* base_addr=0 indicates board not found */
id|cy_card
(braket
id|i
)braket
dot
id|base_addr
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* the code below is responsible to find the boards. Each different&n;       type of board has its own detection routine. If a board is found,&n;       the next cy_card structure available is set by the detection&n;       routine. These functions are responsible for checking the&n;       availability of cy_card and cy_port data structures and updating&n;       the cy_next_channel. */
multiline_comment|/* look for isa boards */
id|cy_isa_nboard
op_assign
id|cy_detect_isa
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* look for pci boards */
id|cy_pci_nboard
op_assign
id|cy_detect_pci
c_func
(paren
)paren
suffix:semicolon
id|cy_nboard
op_assign
id|cy_isa_nboard
op_plus
id|cy_pci_nboard
suffix:semicolon
multiline_comment|/* invalidate remaining cy_card structures */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cy_card
(braket
id|i
)braket
dot
id|base_addr
op_eq
l_int|0
)paren
(brace
id|cy_card
(braket
id|i
)braket
dot
id|first_line
op_assign
op_minus
l_int|1
suffix:semicolon
id|cy_card
(braket
id|i
)braket
dot
id|ctl_addr
op_assign
l_int|0
suffix:semicolon
id|cy_card
(braket
id|i
)braket
dot
id|irq
op_assign
l_int|0
suffix:semicolon
id|cy_card
(braket
id|i
)braket
dot
id|bus_index
op_assign
l_int|0
suffix:semicolon
id|cy_card
(braket
id|i
)braket
dot
id|first_line
op_assign
l_int|0
suffix:semicolon
id|cy_card
(braket
id|i
)braket
dot
id|num_chips
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* invalidate remaining cy_port structures */
r_for
c_loop
(paren
id|i
op_assign
id|cy_next_channel
suffix:semicolon
id|i
OL
id|NR_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cy_port
(braket
id|i
)braket
dot
id|line
op_assign
op_minus
l_int|1
suffix:semicolon
id|cy_port
(braket
id|i
)braket
dot
id|magic
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* initialize per-port data structures for each valid board found */
r_for
c_loop
(paren
id|board
op_assign
l_int|0
suffix:semicolon
id|board
OL
id|cy_nboard
suffix:semicolon
id|board
op_increment
)paren
(brace
id|cinfo
op_assign
op_amp
id|cy_card
(braket
id|board
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;num_chips
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Cyclades-Z */
id|number_z_boards
op_increment
suffix:semicolon
id|mailbox
op_assign
id|cy_readl
c_func
(paren
op_amp
(paren
(paren
r_struct
id|RUNTIME_9060
op_star
)paren
id|cy_card
(braket
id|board
)braket
dot
id|ctl_addr
)paren
op_member_access_from_pointer
id|mail_box_0
)paren
suffix:semicolon
id|nports
op_assign
(paren
id|mailbox
op_eq
id|ZE_V1
)paren
ques
c_cond
id|ZE_V1_NPORTS
suffix:colon
l_int|8
suffix:semicolon
id|cinfo-&gt;intr_enabled
op_assign
l_int|0
suffix:semicolon
id|cinfo-&gt;nports
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Will be correctly set later, after &n;&t;&t;&t;&t;      Z FW is loaded */
id|spin_lock_init
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
id|cinfo-&gt;first_line
suffix:semicolon
id|port
OL
id|cinfo-&gt;first_line
op_plus
id|nports
suffix:semicolon
id|port
op_increment
)paren
(brace
id|info
op_assign
op_amp
id|cy_port
(braket
id|port
)braket
suffix:semicolon
id|info-&gt;magic
op_assign
id|CYCLADES_MAGIC
suffix:semicolon
id|info-&gt;type
op_assign
id|PORT_STARTECH
suffix:semicolon
id|info-&gt;card
op_assign
id|board
suffix:semicolon
id|info-&gt;line
op_assign
id|port
suffix:semicolon
id|info-&gt;chip_rev
op_assign
l_int|0
suffix:semicolon
id|info-&gt;flags
op_assign
id|STD_COM_FLAGS
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mailbox
op_eq
id|ZO_V1
)paren
id|info-&gt;xmit_fifo_size
op_assign
id|CYZ_FIFO_SIZE
suffix:semicolon
r_else
id|info-&gt;xmit_fifo_size
op_assign
l_int|4
op_star
id|CYZ_FIFO_SIZE
suffix:semicolon
id|info-&gt;cor1
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cor2
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cor3
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cor4
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cor5
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tbpr
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tco
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rbpr
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rco
op_assign
l_int|0
suffix:semicolon
id|info-&gt;custom_divisor
op_assign
l_int|0
suffix:semicolon
id|info-&gt;close_delay
op_assign
l_int|5
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
id|info-&gt;closing_wait
op_assign
id|CLOSING_WAIT_DELAY
suffix:semicolon
id|info-&gt;icount.cts
op_assign
id|info-&gt;icount.dsr
op_assign
id|info-&gt;icount.rng
op_assign
id|info-&gt;icount.dcd
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.rx
op_assign
id|info-&gt;icount.tx
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.frame
op_assign
id|info-&gt;icount.parity
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.overrun
op_assign
id|info-&gt;icount.brk
op_assign
l_int|0
suffix:semicolon
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
id|info-&gt;event
op_assign
l_int|0
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;blocked_open
op_assign
l_int|0
suffix:semicolon
id|info-&gt;default_threshold
op_assign
l_int|0
suffix:semicolon
id|info-&gt;default_timeout
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tqueue.routine
op_assign
id|do_softint
suffix:semicolon
id|info-&gt;tqueue.data
op_assign
id|info
suffix:semicolon
id|info-&gt;callout_termios
op_assign
id|cy_callout_driver.init_termios
suffix:semicolon
id|info-&gt;normal_termios
op_assign
id|cy_serial_driver.init_termios
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;shutdown_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;delta_msr_wait
)paren
suffix:semicolon
multiline_comment|/* info-&gt;session */
multiline_comment|/* info-&gt;pgrp */
id|info-&gt;read_status_mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* info-&gt;timeout */
multiline_comment|/* Bentson&squot;s vars */
id|info-&gt;jiffies
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|info-&gt;jiffies
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|info-&gt;jiffies
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rflush_count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_CYZ_INTR
id|cyz_rx_full_timer
(braket
id|port
)braket
dot
id|function
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
r_continue
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Cyclom-Y of some kind*/
id|index
op_assign
id|cinfo-&gt;bus_index
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|cinfo-&gt;card_lock
)paren
suffix:semicolon
id|cinfo-&gt;nports
op_assign
id|CyPORTS_PER_CHIP
op_star
id|cinfo-&gt;num_chips
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
id|cinfo-&gt;first_line
suffix:semicolon
id|port
OL
id|cinfo-&gt;first_line
op_plus
id|cinfo-&gt;nports
suffix:semicolon
id|port
op_increment
)paren
(brace
id|info
op_assign
op_amp
id|cy_port
(braket
id|port
)braket
suffix:semicolon
id|info-&gt;magic
op_assign
id|CYCLADES_MAGIC
suffix:semicolon
id|info-&gt;type
op_assign
id|PORT_CIRRUS
suffix:semicolon
id|info-&gt;card
op_assign
id|board
suffix:semicolon
id|info-&gt;line
op_assign
id|port
suffix:semicolon
id|info-&gt;flags
op_assign
id|STD_COM_FLAGS
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|info-&gt;xmit_fifo_size
op_assign
id|CyMAX_CHAR_FIFO
suffix:semicolon
id|info-&gt;cor1
op_assign
id|CyPARITY_NONE
op_or
id|Cy_1_STOP
op_or
id|Cy_8_BITS
suffix:semicolon
id|info-&gt;cor2
op_assign
id|CyETC
suffix:semicolon
id|info-&gt;cor3
op_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* _very_ small rcv threshold */
id|info-&gt;cor4
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cor5
op_assign
l_int|0
suffix:semicolon
id|info-&gt;custom_divisor
op_assign
l_int|0
suffix:semicolon
id|info-&gt;close_delay
op_assign
l_int|5
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
id|info-&gt;closing_wait
op_assign
id|CLOSING_WAIT_DELAY
suffix:semicolon
id|info-&gt;icount.cts
op_assign
id|info-&gt;icount.dsr
op_assign
id|info-&gt;icount.rng
op_assign
id|info-&gt;icount.dcd
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.rx
op_assign
id|info-&gt;icount.tx
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.frame
op_assign
id|info-&gt;icount.parity
op_assign
l_int|0
suffix:semicolon
id|info-&gt;icount.overrun
op_assign
id|info-&gt;icount.brk
op_assign
l_int|0
suffix:semicolon
id|chip_number
op_assign
(paren
id|port
op_minus
id|cinfo-&gt;first_line
)paren
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;chip_rev
op_assign
id|cy_readb
c_func
(paren
id|cinfo-&gt;base_addr
op_plus
(paren
id|cy_chip_offset
(braket
id|chip_number
)braket
op_lshift
id|index
)paren
op_plus
(paren
id|CyGFRCR
op_lshift
id|index
)paren
)paren
)paren
op_ge
id|CD1400_REV_J
)paren
(brace
multiline_comment|/* It is a CD1400 rev. J or later */
id|info-&gt;tbpr
op_assign
id|baud_bpr_60
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* Tx BPR */
id|info-&gt;tco
op_assign
id|baud_co_60
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* Tx CO */
id|info-&gt;rbpr
op_assign
id|baud_bpr_60
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* Rx BPR */
id|info-&gt;rco
op_assign
id|baud_co_60
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* Rx CO */
id|info-&gt;rflow
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rtsdtr_inv
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;tbpr
op_assign
id|baud_bpr_25
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* Tx BPR */
id|info-&gt;tco
op_assign
id|baud_co_25
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* Tx CO */
id|info-&gt;rbpr
op_assign
id|baud_bpr_25
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* Rx BPR */
id|info-&gt;rco
op_assign
id|baud_co_25
(braket
l_int|13
)braket
suffix:semicolon
multiline_comment|/* Rx CO */
id|info-&gt;rflow
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rtsdtr_inv
op_assign
l_int|0
suffix:semicolon
)brace
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
id|info-&gt;event
op_assign
l_int|0
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;blocked_open
op_assign
l_int|0
suffix:semicolon
id|info-&gt;default_threshold
op_assign
l_int|0
suffix:semicolon
id|info-&gt;default_timeout
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tqueue.routine
op_assign
id|do_softint
suffix:semicolon
id|info-&gt;tqueue.data
op_assign
id|info
suffix:semicolon
id|info-&gt;callout_termios
op_assign
id|cy_callout_driver.init_termios
suffix:semicolon
id|info-&gt;normal_termios
op_assign
id|cy_serial_driver.init_termios
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;shutdown_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;delta_msr_wait
)paren
suffix:semicolon
multiline_comment|/* info-&gt;session */
multiline_comment|/* info-&gt;pgrp */
id|info-&gt;read_status_mask
op_assign
id|CyTIMEOUT
op_or
id|CySPECHAR
op_or
id|CyBREAK
op_or
id|CyPARITY
op_or
id|CyFRAME
op_or
id|CyOVERRUN
suffix:semicolon
multiline_comment|/* info-&gt;timeout */
)brace
)brace
)brace
macro_line|#ifndef CONFIG_CYZ_INTR
r_if
c_cond
(paren
id|number_z_boards
op_logical_and
op_logical_neg
id|cyz_timeron
)paren
(brace
id|cyz_timeron
op_increment
suffix:semicolon
id|cyz_timerlist.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cyz_timerlist
)paren
suffix:semicolon
macro_line|#ifdef CY_PCI_DEBUG
id|printk
c_func
(paren
l_string|&quot;Cyclades-Z polling initialized&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* CONFIG_CYZ_INTR */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* cy_init */
macro_line|#ifdef MODULE
r_void
DECL|function|cy_cleanup_module
id|cy_cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|e1
comma
id|e2
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifndef CONFIG_CYZ_INTR
r_if
c_cond
(paren
id|cyz_timeron
)paren
(brace
id|cyz_timeron
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cyz_timerlist
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_CYZ_INTR */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|remove_bh
c_func
(paren
id|CYCLADES_BH
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e1
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|cy_serial_driver
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;cyc: failed to unregister Cyclades serial driver(%d)&bslash;n&quot;
comma
id|e1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e2
op_assign
id|tty_unregister_driver
c_func
(paren
op_amp
id|cy_callout_driver
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;cyc: failed to unregister Cyclades callout driver (%d)&bslash;n&quot;
comma
id|e2
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CARDS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cy_card
(braket
id|i
)braket
dot
id|base_addr
op_ne
l_int|0
)paren
(brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|cy_card
(braket
id|i
)braket
dot
id|base_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy_card
(braket
id|i
)braket
dot
id|ctl_addr
op_ne
l_int|0
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|cy_card
(braket
id|i
)braket
dot
id|ctl_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy_card
(braket
id|i
)braket
dot
id|irq
macro_line|#ifndef CONFIG_CYZ_INTR
op_logical_and
id|cy_card
(braket
id|i
)braket
dot
id|num_chips
op_ne
op_minus
l_int|1
multiline_comment|/* not a Z card */
macro_line|#endif /* CONFIG_CYZ_INTR */
)paren
id|free_irq
c_func
(paren
id|cy_card
(braket
id|i
)braket
dot
id|irq
comma
op_amp
id|cy_card
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tmp_buf
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|tmp_buf
)paren
suffix:semicolon
id|tmp_buf
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* cy_cleanup_module */
multiline_comment|/* Module entry-points */
DECL|variable|cy_init
id|module_init
c_func
(paren
id|cy_init
)paren
suffix:semicolon
DECL|variable|cy_cleanup_module
id|module_exit
c_func
(paren
id|cy_cleanup_module
)paren
suffix:semicolon
macro_line|#else /* MODULE */
multiline_comment|/* called by linux/init/main.c to parse command line options */
r_void
DECL|function|cy_setup
id|cy_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
macro_line|#ifdef CONFIG_ISA
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_ISA_ADDRS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cy_isa_addresses
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|1
suffix:semicolon
id|j
op_le
id|ints
(braket
l_int|0
)braket
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OL
id|NR_ISA_ADDRS
)paren
(brace
id|cy_isa_addresses
(braket
id|i
op_increment
)braket
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|ints
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_ISA */
)brace
multiline_comment|/* cy_setup */
macro_line|#endif /* MODULE */
eof
