multiline_comment|/*&n; * Macintosh ADB Mouse driver for Linux&n; *&n; * 27 Oct 1997 Michael Schmitz&n; *&n; * Apple mouse protocol according to:&n; *&n; * Device code shamelessly stolen from:&n; */
multiline_comment|/*&n; * Atari Mouse Driver for Linux&n; * by Robert de Vries (robert@and.nl) 19Jul93&n; *&n; * 16 Nov 1994 Andreas Schwab&n; * Compatibility with busmouse&n; * Support for three button mouse (shamelessly stolen from MiNT)&n; * third button wired to one of the joystick directions on joystick 1&n; *&n; * 1996/02/11 Andreas Schwab&n; * Module support&n; * Allow multiple open&squot;s&n; *&n; * Converted to use new generic busmouse code.  5 Apr 1998&n; *   Russell King &lt;rmk@arm.uk.linux.org&gt;&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/mac_mouse.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;busmouse.h&quot;
DECL|variable|msedev
r_static
r_int
id|msedev
suffix:semicolon
DECL|variable|mac_mouse_x_threshold
DECL|variable|mac_mouse_y_threshold
r_static
r_int
id|mac_mouse_x_threshold
op_assign
l_int|2
comma
id|mac_mouse_y_threshold
op_assign
l_int|2
suffix:semicolon
DECL|variable|mac_mouse_buttons
r_static
r_int
id|mac_mouse_buttons
op_assign
l_int|0
suffix:semicolon
r_extern
r_void
(paren
op_star
id|mac_mouse_interrupt_hook
)paren
(paren
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_extern
r_int
id|mac_emulate_button2
suffix:semicolon
r_extern
r_int
id|mac_emulate_button3
suffix:semicolon
r_extern
r_int
id|console_loglevel
suffix:semicolon
multiline_comment|/*&n; *&t;XXX: need to figure out what ADB mouse packets mean ... &n; *&t;This is the stuff stolen from the Atari driver ...&n; */
DECL|function|mac_mouse_interrupt
r_static
r_void
id|mac_mouse_interrupt
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|nb
)paren
(brace
r_static
r_int
id|buttons
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* all mouse buttons _up_ !! */
multiline_comment|/*&n;    Handler 1 -- 100cpi original Apple mouse protocol.&n;    Handler 2 -- 200cpi original Apple mouse protocol.&n;&n;    For Apple&squot;s standard one-button mouse protocol the data array will&n;    contain the following values:&n;&n;                BITS    COMMENTS&n;    data[0] = 0000 0000 ADB packet identifer.&n;    data[1] = ???? ???? (?)&n;    data[2] = ???? ??00 Bits 0-1 should be zero for a mouse device.&n;    data[3] = bxxx xxxx First button and x-axis motion.&n;    data[4] = byyy yyyy Second button and y-axis motion.&n;&n;    NOTE: data[0] is confirmed by the parent function and need not be&n;    checked here.&n;  */
multiline_comment|/*&n;    Handler 4 -- Apple Extended mouse protocol.&n;&n;    For Apple&squot;s 3-button mouse protocol the data array will contain the&n;    following values:&n;&n;&t;&t;BITS    COMMENTS&n;    data[0] = 0000 0000 ADB packet identifer.&n;    data[1] = 0100 0000 Extended protocol register.&n;&t;      Bits 6-7 are the device id, which should be 1.&n;&t;      Bits 4-5 are resolution which is in &quot;units/inch&quot;.&n;&t;      The Logitech MouseMan returns these bits clear but it has&n;&t;      200/300cpi resolution.&n;&t;      Bits 0-3 are unique vendor id.&n;    data[2] = 0011 1100 Bits 0-1 should be zero for a mouse device.&n;&t;      Bits 2-3 should be 8 + 4.&n;&t;&t;      Bits 4-7 should be 3 for a mouse device.&n;    data[3] = bxxx xxxx Left button and x-axis motion.&n;    data[4] = byyy yyyy Second button and y-axis motion.&n;    data[5] = byyy bxxx Third button and fourth button.  &n;    &t;      Y is additiona. high bits of y-axis motion.  &n;    &t;      X is additional high bits of x-axis motion.&n;&n;    NOTE: data[0] and data[2] are confirmed by the parent function and&n;    need not be checked here.&n;  */
multiline_comment|/*&n;     * &squot;buttons&squot; here means &squot;button down&squot; states!&n;     * Button 1 (left)  : bit 2, busmouse button 3&n;     * Button 2 (right) : bit 0, busmouse button 1&n;     * Button 3 (middle): bit 1, busmouse button 2&n;     */
multiline_comment|/* x/y and buttons swapped */
r_if
c_cond
(paren
id|buf
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
(brace
multiline_comment|/* real packet : use buttons? */
macro_line|#ifdef DEBUG_ADBMOUSE
r_if
c_cond
(paren
id|console_loglevel
op_ge
l_int|8
)paren
id|printk
c_func
(paren
l_string|&quot;mac_mouse: real data; &quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* button 1 (left, bit 2) : always significant ! */
id|buttons
op_assign
(paren
id|buttons
op_amp
l_int|3
)paren
op_or
(paren
id|buf
(braket
l_int|3
)braket
op_amp
l_int|0x80
ques
c_cond
l_int|4
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 1+2 unchanged */
multiline_comment|/* button 2 (right, bit 0) present ? */
r_if
c_cond
(paren
op_logical_neg
id|mac_emulate_button2
)paren
id|buttons
op_assign
(paren
id|buttons
op_amp
l_int|6
)paren
op_or
(paren
id|buf
(braket
l_int|4
)braket
op_amp
l_int|0x80
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 2+3 unchanged */
multiline_comment|/* button 2 (middle) present? */
multiline_comment|/* data valid only if extended mouse format ! (buf[3] = 0 else)*/
r_if
c_cond
(paren
op_logical_neg
id|mac_emulate_button3
op_logical_and
id|buf
(braket
l_int|1
)braket
op_amp
l_int|0x40
)paren
id|buttons
op_assign
(paren
id|buttons
op_amp
l_int|5
)paren
op_or
(paren
id|buf
(braket
l_int|5
)braket
op_amp
l_int|0x80
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 1+3 unchanged */
)brace
r_else
(brace
multiline_comment|/* fake packet : use 2+3 */
macro_line|#ifdef DEBUG_ADBMOUSE
r_if
c_cond
(paren
id|console_loglevel
op_ge
l_int|8
)paren
id|printk
c_func
(paren
l_string|&quot;mac_mouse: fake data; &quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* we only see state changes here, but the fake driver takes care&n;&t; * to preserve state... button 1 state must stay unchanged! */
id|buttons
op_assign
(paren
id|buttons
op_amp
l_int|4
)paren
op_or
(paren
(paren
id|buf
(braket
l_int|4
)braket
op_amp
l_int|0x80
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_or
(paren
id|buf
(braket
l_int|5
)braket
op_amp
l_int|0x80
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
id|busmouse_add_movementbuttons
c_func
(paren
id|msedev
comma
(paren
(paren
id|buf
(braket
l_int|4
)braket
op_amp
l_int|0x7f
)paren
OL
l_int|64
ques
c_cond
(paren
id|buf
(braket
l_int|4
)braket
op_amp
l_int|0x7f
)paren
suffix:colon
(paren
id|buf
(braket
l_int|4
)braket
op_amp
l_int|0x7f
)paren
op_minus
l_int|128
)paren
comma
op_minus
(paren
(paren
id|buf
(braket
l_int|3
)braket
op_amp
l_int|0x7f
)paren
OL
l_int|64
ques
c_cond
(paren
id|buf
(braket
l_int|3
)braket
op_amp
l_int|0x7f
)paren
suffix:colon
(paren
id|buf
(braket
l_int|3
)braket
op_amp
l_int|0x7f
)paren
op_minus
l_int|128
)paren
comma
id|buttons
op_amp
l_int|7
)paren
suffix:semicolon
)brace
DECL|function|release_mouse
r_static
r_int
id|release_mouse
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|mac_mouse_interrupt_hook
op_assign
l_int|NULL
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|open_mouse
r_static
r_int
id|open_mouse
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|mac_mouse_interrupt_hook
op_assign
id|mac_mouse_interrupt
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|ADB_MOUSE_MINOR
mdefine_line|#define ADB_MOUSE_MINOR&t;10
DECL|variable|macmouse
r_static
r_struct
id|busmouse
id|macmouse
op_assign
(brace
id|ADB_MOUSE_MINOR
comma
l_string|&quot;adbmouse&quot;
comma
id|open_mouse
comma
id|release_mouse
comma
l_int|0
)brace
suffix:semicolon
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_int
id|mac_mouse_init
c_func
(paren
r_void
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_MAC
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|msedev
op_assign
id|register_busmouse
c_func
(paren
op_amp
id|macmouse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msedev
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unable to register ADB mouse driver.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Macintosh ADB mouse installed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|msedev
OL
l_int|0
ques
c_cond
id|msedev
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|macro|MIN_THRESHOLD
mdefine_line|#define&t;MIN_THRESHOLD 1
DECL|macro|MAX_THRESHOLD
mdefine_line|#define&t;MAX_THRESHOLD 20&t;/* more seems not reasonable... */
DECL|function|__initfunc
id|__initfunc
c_func
(paren
r_void
id|mac_mouse_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
)paren
(brace
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mac_mouse_setup: no arguments!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;mac_mouse_setup: too many arguments&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ints
(braket
l_int|1
)braket
template_param
id|MAX_THRESHOLD
)paren
id|printk
c_func
(paren
l_string|&quot;mac_mouse_setup: bad threshold value (ignored)&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|mac_mouse_x_threshold
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
id|mac_mouse_y_threshold
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|ints
(braket
l_int|2
)braket
template_param
id|MAX_THRESHOLD
)paren
id|printk
c_func
(paren
l_string|&quot;mac_mouse_setup: bad threshold value (ignored)&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|mac_mouse_y_threshold
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
)brace
)brace
)brace
macro_line|#ifdef MODULE
macro_line|#include &lt;asm/setup.h&gt;
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|mac_mouse_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|unregister_busmouse
c_func
(paren
id|msedev
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
