multiline_comment|/*&n; * Hitachi H8/337 Microcontroller driver&n; *&n; * The H8 is used to deal with the power and thermal environment&n; * of a system.&n; *&n; * Fixes:&n; *&t;June 1999, AV&t;added releasing /proc/driver/h8&n; *&t;Feb  2000, Borislav Deianov&n; *&t;&t;&t;changed queues to use list.h instead of lists.h&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/linkage.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
DECL|macro|__KERNEL_SYSCALLS__
mdefine_line|#define __KERNEL_SYSCALLS__
macro_line|#include &lt;asm/unistd.h&gt;
macro_line|#include &quot;h8.h&quot;
DECL|macro|DEBUG_H8
mdefine_line|#define DEBUG_H8
macro_line|#ifdef DEBUG_H8
DECL|macro|Dprintk
mdefine_line|#define Dprintk&t;&t;printk
macro_line|#else
DECL|macro|Dprintk
mdefine_line|#define Dprintk
macro_line|#endif
DECL|macro|XDprintk
mdefine_line|#define XDprintk if(h8_debug==-1)printk
multiline_comment|/*&n; * The h8 device is one of the misc char devices.&n; */
DECL|macro|H8_MINOR_DEV
mdefine_line|#define H8_MINOR_DEV   140
multiline_comment|/*&n; * Forward declarations.&n; */
r_static
r_int
id|h8_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|h8_display_blank
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|h8_display_unblank
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|h8_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|h8_get_info
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
)paren
suffix:semicolon
multiline_comment|/*&n; * Support Routines.&n; */
r_static
r_void
id|h8_hw_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|h8_start_new_cmd
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|h8_send_next_cmd_byte
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|h8_read_event_status
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|h8_sync
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|h8_q_cmd
c_func
(paren
id|u_char
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|h8_cmd_done
c_func
(paren
id|h8_cmd_q_t
op_star
id|qp
)paren
suffix:semicolon
r_static
r_int
id|h8_alloc_queues
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
id|u_long
id|h8_get_cpu_speed
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|h8_get_curr_temp
c_func
(paren
id|u_char
id|curr_temp
(braket
)braket
)paren
suffix:semicolon
r_static
r_void
id|h8_get_max_temp
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|h8_get_upper_therm_thold
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|h8_set_upper_therm_thold
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|h8_get_ext_status
c_func
(paren
id|u_char
id|stat_word
(braket
)braket
)paren
suffix:semicolon
r_static
r_int
id|h8_monitor_thread
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_int
id|h8_manage_therm
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|h8_set_cpu_speed
c_func
(paren
r_int
id|speed_divisor
)paren
suffix:semicolon
r_static
r_void
id|h8_start_monitor_timer
c_func
(paren
r_int
r_int
id|secs
)paren
suffix:semicolon
r_static
r_void
id|h8_activate_monitor
c_func
(paren
r_int
r_int
id|unused
)paren
suffix:semicolon
multiline_comment|/* in arch/alpha/kernel/lca.c */
r_extern
r_void
id|lca_clock_print
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_int
id|lca_get_clock
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|lca_clock_fiddle
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|h8_set_event_mask
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|h8_clear_event_mask
c_func
(paren
r_int
)paren
suffix:semicolon
multiline_comment|/*&n; * Driver structures&n; */
DECL|variable|h8_monitor_timer
r_static
r_struct
id|timer_list
id|h8_monitor_timer
suffix:semicolon
DECL|variable|h8_monitor_timer_active
r_static
r_int
id|h8_monitor_timer_active
op_assign
l_int|0
suffix:semicolon
DECL|variable|driver_version
r_static
r_char
id|driver_version
(braket
)braket
op_assign
l_string|&quot;X0.0&quot;
suffix:semicolon
multiline_comment|/* no spaces */
DECL|variable|intrbuf
r_union
id|intr_buf
id|intrbuf
suffix:semicolon
DECL|variable|intr_buf_ptr
r_int
id|intr_buf_ptr
suffix:semicolon
DECL|variable|xx
r_union
id|intr_buf
id|xx
suffix:semicolon
DECL|variable|last_temp
id|u_char
id|last_temp
suffix:semicolon
multiline_comment|/*&n; * I/O Macros for register reads and writes.&n; */
DECL|macro|H8_READ
mdefine_line|#define H8_READ(a) &t;inb((a))
DECL|macro|H8_WRITE
mdefine_line|#define H8_WRITE(d,a)&t;outb((d),(a))
DECL|macro|H8_GET_STATUS
mdefine_line|#define&t;H8_GET_STATUS&t;H8_READ((h8_base) + H8_STATUS_REG_OFF)
DECL|macro|H8_READ_DATA
mdefine_line|#define H8_READ_DATA&t;H8_READ((h8_base) + H8_DATA_REG_OFF)
DECL|macro|WRITE_DATA
mdefine_line|#define WRITE_DATA(d)&t;H8_WRITE((d), h8_base + H8_DATA_REG_OFF)
DECL|macro|WRITE_CMD
mdefine_line|#define WRITE_CMD(d)&t;H8_WRITE((d), h8_base + H8_CMD_REG_OFF)
DECL|variable|h8_base
r_int
r_int
id|h8_base
op_assign
id|H8_BASE_ADDR
suffix:semicolon
DECL|variable|h8_irq
r_int
r_int
id|h8_irq
op_assign
id|H8_IRQ
suffix:semicolon
DECL|variable|h8_state
r_int
r_int
id|h8_state
op_assign
id|H8_IDLE
suffix:semicolon
DECL|variable|h8_index
r_int
r_int
id|h8_index
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|h8_enabled
r_int
r_int
id|h8_enabled
op_assign
l_int|0
suffix:semicolon
DECL|variable|h8_actq
id|LIST_HEAD
c_func
(paren
id|h8_actq
)paren
suffix:semicolon
DECL|variable|h8_cmdq
id|LIST_HEAD
c_func
(paren
id|h8_cmdq
)paren
suffix:semicolon
DECL|variable|h8_freeq
id|LIST_HEAD
c_func
(paren
id|h8_freeq
)paren
suffix:semicolon
multiline_comment|/* &n; * Globals used in thermal control of Alphabook1.&n; */
DECL|variable|cpu_speed_divisor
r_int
id|cpu_speed_divisor
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|h8_event_mask
r_int
id|h8_event_mask
op_assign
l_int|0
suffix:semicolon
DECL|variable|h8_monitor_wait
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|h8_monitor_wait
)paren
suffix:semicolon
DECL|variable|h8_command_mask
r_int
r_int
id|h8_command_mask
op_assign
l_int|0
suffix:semicolon
DECL|variable|h8_uthermal_threshold
r_int
id|h8_uthermal_threshold
op_assign
id|DEFAULT_UTHERMAL_THRESHOLD
suffix:semicolon
DECL|variable|h8_uthermal_window
r_int
id|h8_uthermal_window
op_assign
id|UTH_HYSTERESIS
suffix:semicolon
DECL|variable|h8_debug
r_int
id|h8_debug
op_assign
l_int|0xfffffdfc
suffix:semicolon
DECL|variable|h8_ldamp
r_int
id|h8_ldamp
op_assign
id|MHZ_115
suffix:semicolon
DECL|variable|h8_udamp
r_int
id|h8_udamp
op_assign
id|MHZ_57
suffix:semicolon
DECL|variable|h8_current_temp
id|u_char
id|h8_current_temp
op_assign
l_int|0
suffix:semicolon
DECL|variable|h8_system_temp
id|u_char
id|h8_system_temp
op_assign
l_int|0
suffix:semicolon
DECL|variable|h8_sync_channel
r_int
id|h8_sync_channel
op_assign
l_int|0
suffix:semicolon
DECL|variable|h8_sync_wait
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|h8_sync_wait
)paren
suffix:semicolon
DECL|variable|h8_init_performed
r_int
id|h8_init_performed
suffix:semicolon
multiline_comment|/* CPU speeds and clock divisor values */
DECL|variable|speed_tab
r_int
id|speed_tab
(braket
l_int|6
)braket
op_assign
(brace
l_int|230
comma
l_int|153
comma
l_int|115
comma
l_int|57
comma
l_int|28
comma
l_int|14
)brace
suffix:semicolon
multiline_comment|/*&n; * H8 interrupt handler&n; */
DECL|function|h8_intr
r_static
r_void
id|h8_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u_char
id|stat_reg
comma
id|data_reg
suffix:semicolon
id|h8_cmd_q_t
op_star
id|qp
op_assign
id|list_entry
c_func
(paren
id|h8_actq.next
comma
id|h8_cmd_q_t
comma
id|link
)paren
suffix:semicolon
id|stat_reg
op_assign
id|H8_GET_STATUS
suffix:semicolon
id|data_reg
op_assign
id|H8_READ_DATA
suffix:semicolon
id|XDprintk
c_func
(paren
l_string|&quot;h8_intr: state %d status 0x%x data 0x%x&bslash;n&quot;
comma
id|h8_state
comma
id|stat_reg
comma
id|data_reg
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|h8_state
)paren
(brace
multiline_comment|/* Response to an asynchronous event. */
r_case
id|H8_IDLE
suffix:colon
(brace
multiline_comment|/* H8_IDLE */
r_if
c_cond
(paren
id|stat_reg
op_amp
id|H8_OFULL
)paren
(brace
r_if
c_cond
(paren
id|data_reg
op_eq
id|H8_INTR
)paren
(brace
id|h8_state
op_assign
id|H8_INTR_MODE
suffix:semicolon
multiline_comment|/* Executing a command to determine what happened. */
id|WRITE_CMD
c_func
(paren
id|H8_RD_EVENT_STATUS
)paren
suffix:semicolon
id|intr_buf_ptr
op_assign
l_int|1
suffix:semicolon
id|WRITE_CMD
c_func
(paren
id|H8_RD_EVENT_STATUS
)paren
suffix:semicolon
)brace
r_else
(brace
id|Dprintk
c_func
(paren
l_string|&quot;h8_intr: idle stat 0x%x data 0x%x&bslash;n&quot;
comma
id|stat_reg
comma
id|data_reg
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|Dprintk
c_func
(paren
l_string|&quot;h8_intr: bogus interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|H8_INTR_MODE
suffix:colon
(brace
multiline_comment|/* H8_INTR_MODE */
id|XDprintk
c_func
(paren
l_string|&quot;H8 intr/intr_mode&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_reg
op_eq
id|H8_BYTE_LEVEL_ACK
)paren
(brace
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data_reg
op_eq
id|H8_CMD_ACK
)paren
(brace
r_return
suffix:semicolon
)brace
r_else
(brace
id|intrbuf.byte
(braket
id|intr_buf_ptr
)braket
op_assign
id|data_reg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intr_buf_ptr
)paren
(brace
id|h8_state
op_assign
id|H8_IDLE
suffix:semicolon
id|h8_read_event_status
c_func
(paren
)paren
suffix:semicolon
)brace
id|intr_buf_ptr
op_decrement
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Placed in this state by h8_start_new_cmd(). */
r_case
id|H8_XMIT
suffix:colon
(brace
multiline_comment|/* H8_XMIT */
id|XDprintk
c_func
(paren
l_string|&quot;H8 intr/xmit&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* If a byte level acknowledgement has been received */
r_if
c_cond
(paren
id|data_reg
op_eq
id|H8_BYTE_LEVEL_ACK
)paren
(brace
id|XDprintk
c_func
(paren
l_string|&quot;H8 intr/xmit BYTE ACK&bslash;n&quot;
)paren
suffix:semicolon
id|qp-&gt;nacks
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|qp-&gt;nacks
OG
id|qp-&gt;ncmd
)paren
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x1
)paren
(brace
id|Dprintk
c_func
(paren
l_string|&quot;h8intr: bogus # of acks!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t;&t; * If the number of bytes sent is less than the total &n;&t;&t; * number of bytes in the command.&n;&t;&t; */
r_if
c_cond
(paren
id|qp-&gt;cnt
OL
id|qp-&gt;ncmd
)paren
(brace
id|h8_send_next_cmd_byte
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
multiline_comment|/* If the complete command has produced an acknowledgement. */
)brace
r_else
r_if
c_cond
(paren
id|data_reg
op_eq
id|H8_CMD_ACK
)paren
(brace
id|XDprintk
c_func
(paren
l_string|&quot;H8 intr/xmit CMD ACK&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* If there are response bytes */
r_if
c_cond
(paren
id|qp-&gt;nrsp
)paren
id|h8_state
op_assign
id|H8_RCV
suffix:semicolon
r_else
id|h8_state
op_assign
id|H8_IDLE
suffix:semicolon
id|qp-&gt;cnt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* Error, need to start over with a clean slate. */
)brace
r_else
r_if
c_cond
(paren
id|data_reg
op_eq
id|H8_NACK
)paren
(brace
id|XDprintk
c_func
(paren
l_string|&quot;h8_intr: NACK received restarting command&bslash;n&quot;
)paren
suffix:semicolon
id|qp-&gt;nacks
op_assign
l_int|0
suffix:semicolon
id|qp-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|h8_state
op_assign
id|H8_IDLE
suffix:semicolon
id|WRITE_CMD
c_func
(paren
id|H8_SYNC
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
id|Dprintk
(paren
l_string|&quot;h8intr: xmit unknown data 0x%x &bslash;n&quot;
comma
id|data_reg
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|H8_RESYNC
suffix:colon
(brace
multiline_comment|/* H8_RESYNC */
id|XDprintk
c_func
(paren
l_string|&quot;H8 intr/resync&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_reg
op_eq
id|H8_BYTE_LEVEL_ACK
)paren
(brace
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|data_reg
op_eq
id|H8_SYNC_BYTE
)paren
(brace
id|h8_state
op_assign
id|H8_IDLE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|h8_actq
)paren
)paren
id|h8_send_next_cmd_byte
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|Dprintk
(paren
l_string|&quot;h8_intr: resync unknown data 0x%x &bslash;n&quot;
comma
id|data_reg
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|H8_RCV
suffix:colon
(brace
multiline_comment|/* H8_RCV */
id|XDprintk
c_func
(paren
l_string|&quot;H8 intr/rcv&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qp-&gt;cnt
OL
id|qp-&gt;nrsp
)paren
(brace
id|qp-&gt;rcvbuf
(braket
id|qp-&gt;cnt
)braket
op_assign
id|data_reg
suffix:semicolon
id|qp-&gt;cnt
op_increment
suffix:semicolon
multiline_comment|/* If command reception finished. */
r_if
c_cond
(paren
id|qp-&gt;cnt
op_eq
id|qp-&gt;nrsp
)paren
(brace
id|h8_state
op_assign
id|H8_IDLE
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|qp-&gt;link
)paren
suffix:semicolon
id|h8_cmd_done
(paren
id|qp
)paren
suffix:semicolon
multiline_comment|/* More commands to send over? */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|h8_cmdq
)paren
)paren
id|h8_start_new_cmd
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_else
(brace
id|Dprintk
(paren
l_string|&quot;h8intr: rcv overflow cmd 0x%x&bslash;n&quot;
comma
id|qp-&gt;cmdbuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
multiline_comment|/* default */
id|Dprintk
c_func
(paren
l_string|&quot;H8 intr/unknown&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
DECL|function|h8_cleanup
r_static
r_void
id|__exit
id|h8_cleanup
(paren
r_void
)paren
(brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;driver/h8&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|h8_base
comma
l_int|8
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|h8_irq
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|h8_init
r_static
r_int
id|__init
id|h8_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|h8_irq
comma
id|h8_intr
comma
id|SA_INTERRUPT
comma
l_string|&quot;h8&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;H8: error: IRQ %d is not free&bslash;n&quot;
comma
id|h8_irq
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;H8 at 0x%x IRQ %d&bslash;n&quot;
comma
id|h8_base
comma
id|h8_irq
)paren
suffix:semicolon
id|create_proc_info_entry
c_func
(paren
l_string|&quot;driver/h8&quot;
comma
l_int|0
comma
l_int|NULL
comma
id|h8_get_info
)paren
suffix:semicolon
id|request_region
c_func
(paren
id|h8_base
comma
l_int|8
comma
l_string|&quot;h8&quot;
)paren
suffix:semicolon
id|h8_alloc_queues
c_func
(paren
)paren
suffix:semicolon
id|h8_hw_init
c_func
(paren
)paren
suffix:semicolon
id|kernel_thread
c_func
(paren
id|h8_monitor_thread
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|h8_init
id|module_init
c_func
(paren
id|h8_init
)paren
suffix:semicolon
DECL|variable|h8_cleanup
id|module_exit
c_func
(paren
id|h8_cleanup
)paren
suffix:semicolon
DECL|function|h8_hw_init
r_static
r_void
id|__init
id|h8_hw_init
c_func
(paren
r_void
)paren
(brace
id|u_char
id|buf
(braket
id|H8_MAX_CMD_SIZE
)braket
suffix:semicolon
multiline_comment|/* set CPU speed to max for booting */
id|h8_set_cpu_speed
c_func
(paren
id|MHZ_230
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the H8&n;&t; */
id|h8_sync
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* activate interrupts */
multiline_comment|/* To clear conditions left by console */
id|h8_read_event_status
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Perform a conditioning read */
id|buf
(braket
l_int|0
)braket
op_assign
id|H8_DEVICE_CONTROL
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0xff
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0x0
suffix:semicolon
id|h8_q_cmd
c_func
(paren
id|buf
comma
l_int|3
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Turn on built-in and external mice, capture power switch */
id|buf
(braket
l_int|0
)braket
op_assign
id|H8_DEVICE_CONTROL
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x0
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|H8_ENAB_INT_PTR
op_or
id|H8_ENAB_EXT_PTR
op_or
multiline_comment|/*H8_DISAB_PWR_OFF_SW |*/
id|H8_ENAB_LOW_SPD_IND
suffix:semicolon
id|h8_q_cmd
c_func
(paren
id|buf
comma
l_int|3
comma
l_int|1
)paren
suffix:semicolon
id|h8_enabled
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|h8_get_info
r_static
r_int
id|h8_get_info
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|fpos
comma
r_int
id|length
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|h8_enabled
)paren
r_return
l_int|0
suffix:semicolon
id|p
op_assign
id|buf
suffix:semicolon
multiline_comment|/*&n;           0) Linux driver version (this will change if format changes)&n;           1) &n;           2) &n;           3)&n;           4)&n;&t;*/
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;%s &bslash;n&quot;
comma
id|driver_version
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buf
suffix:semicolon
macro_line|#else
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Called from console driver -- must make sure h8_enabled. */
DECL|function|h8_display_blank
r_int
id|h8_display_blank
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_H8_DISPLAY_BLANK
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|h8_enabled
)paren
r_return
l_int|0
suffix:semicolon
id|error
op_assign
id|h8_set_display_power_state
c_func
(paren
id|H8_STATE_STANDBY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
id|H8_SUCCESS
)paren
r_return
l_int|1
suffix:semicolon
id|h8_error
c_func
(paren
l_string|&quot;set display standby&quot;
comma
id|error
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called from console driver -- must make sure h8_enabled. */
DECL|function|h8_display_unblank
r_int
id|h8_display_unblank
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_H8_DISPLAY_BLANK
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|h8_enabled
)paren
r_return
l_int|0
suffix:semicolon
id|error
op_assign
id|h8_set_display_power_state
c_func
(paren
id|H8_STATE_READY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
id|H8_SUCCESS
)paren
r_return
l_int|1
suffix:semicolon
id|h8_error
c_func
(paren
l_string|&quot;set display ready&quot;
comma
id|error
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|h8_alloc_queues
id|h8_alloc_queues
c_func
(paren
r_void
)paren
(brace
id|h8_cmd_q_t
op_star
id|qp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|qp
op_assign
(paren
id|h8_cmd_q_t
op_star
)paren
id|kmalloc
c_func
(paren
(paren
r_sizeof
(paren
id|h8_cmd_q_t
)paren
op_star
id|H8_Q_ALLOC_AMOUNT
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qp
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;H8: could not allocate memory for command queue&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* add to the free queue */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|H8_Q_ALLOC_AMOUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* place each at front of freeq */
id|list_add
c_func
(paren
op_amp
id|qp
(braket
id|i
)braket
dot
id|link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Basic means by which commands are sent to the H8.&n; */
r_void
DECL|function|h8_q_cmd
id|h8_q_cmd
c_func
(paren
id|u_char
op_star
id|cmd
comma
r_int
id|cmd_size
comma
r_int
id|resp_size
)paren
(brace
id|h8_cmd_q_t
op_star
id|qp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* get cmd buf */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|list_empty
c_func
(paren
op_amp
id|h8_freeq
)paren
)paren
(brace
id|Dprintk
c_func
(paren
l_string|&quot;H8: need to allocate more cmd buffers&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|h8_alloc_queues
c_func
(paren
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* get first element from queue */
id|qp
op_assign
id|list_entry
c_func
(paren
id|h8_freeq.next
comma
id|h8_cmd_q_t
comma
id|link
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|qp-&gt;link
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* fill it in */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd_size
suffix:semicolon
id|i
op_increment
)paren
id|qp-&gt;cmdbuf
(braket
id|i
)braket
op_assign
id|cmd
(braket
id|i
)braket
suffix:semicolon
id|qp-&gt;ncmd
op_assign
id|cmd_size
suffix:semicolon
id|qp-&gt;nrsp
op_assign
id|resp_size
suffix:semicolon
multiline_comment|/* queue it at the end of the cmd queue */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* XXX this actually puts it at the start of cmd queue, bug? */
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_cmdq
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|h8_start_new_cmd
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|h8_start_new_cmd
id|h8_start_new_cmd
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|h8_cmd_q_t
op_star
id|qp
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h8_state
op_ne
id|H8_IDLE
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x1
)paren
id|Dprintk
c_func
(paren
l_string|&quot;h8_start_new_cmd: not idle&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|h8_actq
)paren
)paren
(brace
id|Dprintk
c_func
(paren
l_string|&quot;h8_start_new_cmd: inconsistency: IDLE with non-empty active queue!&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|h8_cmdq
)paren
)paren
(brace
id|Dprintk
c_func
(paren
l_string|&quot;h8_start_new_cmd: no command to dequeue&bslash;n&quot;
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;         * Take first command off of the command queue and put&n;         * it on the active queue.&n;         */
id|qp
op_assign
id|list_entry
c_func
(paren
id|h8_cmdq.next
comma
id|h8_cmd_q_t
comma
id|link
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|qp-&gt;link
)paren
suffix:semicolon
multiline_comment|/* XXX should this go to the end of the active queue? */
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_actq
)paren
suffix:semicolon
id|h8_state
op_assign
id|H8_XMIT
suffix:semicolon
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x1
)paren
id|Dprintk
c_func
(paren
l_string|&quot;h8_start_new_cmd: Starting a command&bslash;n&quot;
)paren
suffix:semicolon
id|qp-&gt;cnt
op_assign
l_int|1
suffix:semicolon
id|WRITE_CMD
c_func
(paren
id|qp-&gt;cmdbuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* Kick it off */
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|h8_send_next_cmd_byte
id|h8_send_next_cmd_byte
c_func
(paren
r_void
)paren
(brace
id|h8_cmd_q_t
op_star
id|qp
op_assign
id|list_entry
c_func
(paren
id|h8_actq.next
comma
id|h8_cmd_q_t
comma
id|link
)paren
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|cnt
op_assign
id|qp-&gt;cnt
suffix:semicolon
id|qp-&gt;cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x1
)paren
id|Dprintk
c_func
(paren
l_string|&quot;h8 sending next cmd byte 0x%x (0x%x)&bslash;n&quot;
comma
id|cnt
comma
id|qp-&gt;cmdbuf
(braket
id|cnt
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
)paren
(brace
id|WRITE_DATA
c_func
(paren
id|qp-&gt;cmdbuf
(braket
id|cnt
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|WRITE_CMD
c_func
(paren
id|qp-&gt;cmdbuf
(braket
id|cnt
)braket
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Synchronize H8 communications channel for command transmission.&n; */
r_void
DECL|function|h8_sync
id|h8_sync
c_func
(paren
r_void
)paren
(brace
id|u_char
id|buf
(braket
id|H8_MAX_CMD_SIZE
)braket
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|H8_SYNC
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|H8_SYNC_BYTE
suffix:semicolon
id|h8_q_cmd
c_func
(paren
id|buf
comma
l_int|2
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Responds to external interrupt. Reads event status word and &n; * decodes type of interrupt. &n; */
r_void
DECL|function|h8_read_event_status
id|h8_read_event_status
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x200
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: value 0x%x&bslash;n&quot;
comma
id|intrbuf.word
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;         * Power related items&n;         */
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_DC_CHANGE
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: DC_CHANGE&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* see if dc added or removed, set batt/dc flag, send event */
id|h8_set_event_mask
c_func
(paren
id|H8_MANAGE_BATTERY
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|h8_monitor_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_POWER_BUTTON
)paren
(brace
id|printk
c_func
(paren
"&quot;"
id|Power
r_switch
id|pressed
op_minus
id|please
id|wait
op_minus
id|preparing
id|to
id|power
id|off
"&bslash;"
id|n
"&quot;"
)paren
suffix:semicolon
id|h8_set_event_mask
c_func
(paren
id|H8_POWER_BUTTON
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|h8_monitor_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;         * Thermal related items&n;         */
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_THERMAL_THRESHOLD
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: THERMAL_THRESHOLD&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|h8_set_event_mask
c_func
(paren
id|H8_MANAGE_UTHERM
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|h8_monitor_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;         * nops -for now&n;         */
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_DOCKING_STATION_STATUS
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: DOCKING_STATION_STATUS&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* read_ext_status */
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_EXT_BATT_STATUS
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: EXT_BATT_STATUS&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_EXT_BATT_CHARGE_STATE
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: EXT_BATT_CHARGE_STATE&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_BATT_CHANGE_OVER
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: BATT_CHANGE_OVER&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_WATCHDOG
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: WATCHDOG&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* nop */
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_SHUTDOWN
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: SHUTDOWN&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* nop */
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_KEYBOARD
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: KEYBOARD&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* nop */
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_EXT_MOUSE_OR_CASE_SWITCH
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: EXT_MOUSE_OR_CASE_SWITCH&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* read_ext_status*/
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_INT_BATT_LOW
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: INT_BATT_LOW&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* post event, warn user */
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_INT_BATT_CHARGE_STATE
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: INT_BATT_CHARGE_STATE&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* nop - happens often */
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_INT_BATT_STATUS
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: INT_BATT_STATUS&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_INT_BATT_CHARGE_THRESHOLD
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: INT_BATT_CHARGE_THRESHOLD&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* nop - happens often */
)brace
r_if
c_cond
(paren
id|intrbuf.word
op_amp
id|H8_EXT_BATT_LOW
)paren
(brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_read_event_status: EXT_BATT_LOW&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*if no internal, post event, warn user */
multiline_comment|/* else nop */
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Function called when H8 has performed requested command.&n; */
r_void
DECL|function|h8_cmd_done
id|h8_cmd_done
c_func
(paren
id|h8_cmd_q_t
op_star
id|qp
)paren
(brace
multiline_comment|/* what to do */
r_switch
c_cond
(paren
id|qp-&gt;cmdbuf
(braket
l_int|0
)braket
)paren
(brace
r_case
id|H8_SYNC
suffix:colon
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x40000
)paren
id|printk
c_func
(paren
l_string|&quot;H8: Sync command done - byte returned was 0x%x&bslash;n&quot;
comma
id|qp-&gt;rcvbuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_RD_SN
suffix:colon
r_case
id|H8_RD_ENET_ADDR
suffix:colon
id|printk
c_func
(paren
l_string|&quot;H8: read Ethernet address: command done - address: %x - %x - %x - %x - %x - %x &bslash;n&quot;
comma
id|qp-&gt;rcvbuf
(braket
l_int|0
)braket
comma
id|qp-&gt;rcvbuf
(braket
l_int|1
)braket
comma
id|qp-&gt;rcvbuf
(braket
l_int|2
)braket
comma
id|qp-&gt;rcvbuf
(braket
l_int|3
)braket
comma
id|qp-&gt;rcvbuf
(braket
l_int|4
)braket
comma
id|qp-&gt;rcvbuf
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_RD_HW_VER
suffix:colon
r_case
id|H8_RD_MIC_VER
suffix:colon
r_case
id|H8_RD_MAX_TEMP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;H8: Max recorded CPU temp %d, Sys temp %d&bslash;n&quot;
comma
id|qp-&gt;rcvbuf
(braket
l_int|0
)braket
comma
id|qp-&gt;rcvbuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_RD_MIN_TEMP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;H8: Min recorded CPU temp %d, Sys temp %d&bslash;n&quot;
comma
id|qp-&gt;rcvbuf
(braket
l_int|0
)braket
comma
id|qp-&gt;rcvbuf
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_RD_CURR_TEMP
suffix:colon
id|h8_sync_channel
op_or_assign
id|H8_RD_CURR_TEMP
suffix:semicolon
id|xx.byte
(braket
l_int|0
)braket
op_assign
id|qp-&gt;rcvbuf
(braket
l_int|0
)braket
suffix:semicolon
id|xx.byte
(braket
l_int|1
)braket
op_assign
id|qp-&gt;rcvbuf
(braket
l_int|1
)braket
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|h8_sync_wait
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_RD_SYS_VARIENT
suffix:colon
r_case
id|H8_RD_PWR_ON_CYCLES
suffix:colon
id|printk
c_func
(paren
l_string|&quot; H8: RD_PWR_ON_CYCLES command done&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_RD_PWR_ON_SECS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;H8: RD_PWR_ON_SECS command done&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_RD_RESET_STATUS
suffix:colon
r_case
id|H8_RD_PWR_DN_STATUS
suffix:colon
r_case
id|H8_RD_EVENT_STATUS
suffix:colon
r_case
id|H8_RD_ROM_CKSM
suffix:colon
r_case
id|H8_RD_EXT_STATUS
suffix:colon
id|xx.byte
(braket
l_int|1
)braket
op_assign
id|qp-&gt;rcvbuf
(braket
l_int|0
)braket
suffix:semicolon
id|xx.byte
(braket
l_int|0
)braket
op_assign
id|qp-&gt;rcvbuf
(braket
l_int|1
)braket
suffix:semicolon
id|h8_sync_channel
op_or_assign
id|H8_GET_EXT_STATUS
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|h8_sync_wait
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_RD_USER_CFG
suffix:colon
r_case
id|H8_RD_INT_BATT_VOLT
suffix:colon
r_case
id|H8_RD_DC_INPUT_VOLT
suffix:colon
r_case
id|H8_RD_HORIZ_PTR_VOLT
suffix:colon
r_case
id|H8_RD_VERT_PTR_VOLT
suffix:colon
r_case
id|H8_RD_EEPROM_STATUS
suffix:colon
r_case
id|H8_RD_ERR_STATUS
suffix:colon
r_case
id|H8_RD_NEW_BUSY_SPEED
suffix:colon
r_case
id|H8_RD_CONFIG_INTERFACE
suffix:colon
r_case
id|H8_RD_INT_BATT_STATUS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;H8: Read int batt status cmd done - returned was %x %x %x&bslash;n&quot;
comma
id|qp-&gt;rcvbuf
(braket
l_int|0
)braket
comma
id|qp-&gt;rcvbuf
(braket
l_int|1
)braket
comma
id|qp-&gt;rcvbuf
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_RD_EXT_BATT_STATUS
suffix:colon
r_case
id|H8_RD_PWR_UP_STATUS
suffix:colon
r_case
id|H8_RD_EVENT_STATUS_MASK
suffix:colon
r_case
id|H8_CTL_EMU_BITPORT
suffix:colon
r_case
id|H8_DEVICE_CONTROL
suffix:colon
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x20000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;H8: Device control cmd done - byte returned was 0x%x&bslash;n&quot;
comma
id|qp-&gt;rcvbuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_CTL_TFT_BRT_DC
suffix:colon
r_case
id|H8_CTL_WATCHDOG
suffix:colon
r_case
id|H8_CTL_MIC_PROT
suffix:colon
r_case
id|H8_CTL_INT_BATT_CHG
suffix:colon
r_case
id|H8_CTL_EXT_BATT_CHG
suffix:colon
r_case
id|H8_CTL_MARK_SPACE
suffix:colon
r_case
id|H8_CTL_MOUSE_SENSITIVITY
suffix:colon
r_case
id|H8_CTL_DIAG_MODE
suffix:colon
r_case
id|H8_CTL_IDLE_AND_BUSY_SPDS
suffix:colon
id|printk
c_func
(paren
l_string|&quot;H8: Idle and busy speed command done&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_CTL_TFT_BRT_BATT
suffix:colon
r_case
id|H8_CTL_UPPER_TEMP
suffix:colon
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x10
)paren
(brace
id|XDprintk
c_func
(paren
l_string|&quot;H8: ctl upper thermal thresh cmd done - returned was %d&bslash;n&quot;
comma
id|qp-&gt;rcvbuf
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|qp-&gt;link
comma
op_amp
id|h8_freeq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_CTL_LOWER_TEMP
suffix:colon
r_case
id|H8_CTL_TEMP_CUTOUT
suffix:colon
r_case
id|H8_CTL_WAKEUP
suffix:colon
r_case
id|H8_CTL_CHG_THRESHOLD
suffix:colon
r_case
id|H8_CTL_TURBO_MODE
suffix:colon
r_case
id|H8_SET_DIAG_STATUS
suffix:colon
r_case
id|H8_SOFTWARE_RESET
suffix:colon
r_case
id|H8_RECAL_PTR
suffix:colon
r_case
id|H8_SET_INT_BATT_PERCENT
suffix:colon
r_case
id|H8_WRT_CFG_INTERFACE_REG
suffix:colon
r_case
id|H8_WRT_EVENT_STATUS_MASK
suffix:colon
r_case
id|H8_ENTER_POST_MODE
suffix:colon
r_case
id|H8_EXIT_POST_MODE
suffix:colon
r_case
id|H8_RD_EEPROM
suffix:colon
r_case
id|H8_WRT_EEPROM
suffix:colon
r_case
id|H8_WRT_TO_STATUS_DISP
suffix:colon
id|printk
c_func
(paren
l_string|&quot;H8: Write IO status display command done&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H8_DEFINE_SPC_CHAR
suffix:colon
r_case
id|H8_DEFINE_TABLE_STRING_ENTRY
suffix:colon
r_case
id|H8_PERFORM_EMU_CMD
suffix:colon
r_case
id|H8_EMU_RD_REG
suffix:colon
r_case
id|H8_EMU_WRT_REG
suffix:colon
r_case
id|H8_EMU_RD_RAM
suffix:colon
r_case
id|H8_EMU_WRT_RAM
suffix:colon
r_case
id|H8_BQ_RD_REG
suffix:colon
r_case
id|H8_BQ_WRT_REG
suffix:colon
r_case
id|H8_PWR_OFF
suffix:colon
id|printk
(paren
l_string|&quot;H8: misc command completed&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Retrieve the current CPU temperature and case temperature.  Provides&n; * the feedback for the thermal control algorithm.  Synchcronized via &n; * sleep() for priority so that no other actions in the process will take&n; * place before the data becomes available.&n; */
r_int
DECL|function|h8_get_curr_temp
id|h8_get_curr_temp
c_func
(paren
id|u_char
id|curr_temp
(braket
)braket
)paren
(brace
id|u_char
id|buf
(braket
id|H8_MAX_CMD_SIZE
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
id|H8_MAX_CMD_SIZE
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|H8_RD_CURR_TEMP
suffix:semicolon
id|h8_q_cmd
c_func
(paren
id|buf
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|h8_sync_channel
op_amp
id|H8_RD_CURR_TEMP
)paren
op_eq
l_int|0
)paren
(brace
id|sleep_on
c_func
(paren
op_amp
id|h8_sync_wait
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|h8_sync_channel
op_and_assign
op_complement
id|H8_RD_CURR_TEMP
suffix:semicolon
id|curr_temp
(braket
l_int|0
)braket
op_assign
id|xx.byte
(braket
l_int|0
)braket
suffix:semicolon
id|curr_temp
(braket
l_int|1
)braket
op_assign
id|xx.byte
(braket
l_int|1
)braket
suffix:semicolon
id|xx.word
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;H8: curr CPU temp %d, Sys temp %d&bslash;n&quot;
comma
id|curr_temp
(braket
l_int|0
)braket
comma
id|curr_temp
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|h8_get_max_temp
id|h8_get_max_temp
c_func
(paren
r_void
)paren
(brace
id|u_char
id|buf
(braket
id|H8_MAX_CMD_SIZE
)braket
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|H8_RD_MAX_TEMP
suffix:semicolon
id|h8_q_cmd
c_func
(paren
id|buf
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Assigns an upper limit to the value of the H8 thermal interrupt.&n; * As an example setting a value of 115 F here will cause the &n; * interrupt to trigger when the CPU temperature reaches 115 F.&n; */
r_static
r_void
DECL|function|h8_set_upper_therm_thold
id|h8_set_upper_therm_thold
c_func
(paren
r_int
id|thold
)paren
(brace
id|u_char
id|buf
(braket
id|H8_MAX_CMD_SIZE
)braket
suffix:semicolon
multiline_comment|/* write 0 to reinitialize interrupt */
id|buf
(braket
l_int|0
)braket
op_assign
id|H8_CTL_UPPER_TEMP
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x0
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0x0
suffix:semicolon
id|h8_q_cmd
c_func
(paren
id|buf
comma
l_int|3
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Do it for real */
id|buf
(braket
l_int|0
)braket
op_assign
id|H8_CTL_UPPER_TEMP
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x0
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|thold
suffix:semicolon
id|h8_q_cmd
c_func
(paren
id|buf
comma
l_int|3
comma
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|h8_get_upper_therm_thold
id|h8_get_upper_therm_thold
c_func
(paren
r_void
)paren
(brace
id|u_char
id|buf
(braket
id|H8_MAX_CMD_SIZE
)braket
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|H8_CTL_UPPER_TEMP
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0xff
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|h8_q_cmd
c_func
(paren
id|buf
comma
l_int|3
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The external status word contains information on keyboard controller,&n; * power button, changes in external batt status, change in DC state,&n; * docking station, etc. General purpose querying use.&n; */
r_int
DECL|function|h8_get_ext_status
id|h8_get_ext_status
c_func
(paren
id|u_char
id|stat_word
(braket
)braket
)paren
(brace
id|u_char
id|buf
(braket
id|H8_MAX_CMD_SIZE
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
id|H8_MAX_CMD_SIZE
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|H8_RD_EXT_STATUS
suffix:semicolon
id|h8_q_cmd
c_func
(paren
id|buf
comma
l_int|1
comma
l_int|2
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|h8_sync_channel
op_amp
id|H8_GET_EXT_STATUS
)paren
op_eq
l_int|0
)paren
(brace
id|sleep_on
c_func
(paren
op_amp
id|h8_sync_wait
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|h8_sync_channel
op_and_assign
op_complement
id|H8_GET_EXT_STATUS
suffix:semicolon
id|stat_word
(braket
l_int|0
)braket
op_assign
id|xx.byte
(braket
l_int|0
)braket
suffix:semicolon
id|stat_word
(braket
l_int|1
)braket
op_assign
id|xx.byte
(braket
l_int|1
)braket
suffix:semicolon
id|xx.word
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;H8: curr ext status %x,  %x&bslash;n&quot;
comma
id|stat_word
(braket
l_int|0
)braket
comma
id|stat_word
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Thread attached to task 0 manages thermal/physcial state of Alphabook. &n; * When a condition is detected by the interrupt service routine, the&n; * isr does a wakeup() on h8_monitor_wait.  The mask value is then&n; * screened for the appropriate action.&n; */
r_int
DECL|function|h8_monitor_thread
id|h8_monitor_thread
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
id|u_char
id|curr_temp
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*&n;         * Need a logic based safety valve here. During boot when this thread is&n;         * started and the thermal interrupt is not yet initialized this logic &n;         * checks the temperature and acts accordingly.  When this path is acted&n;         * upon system boot is painfully slow, however, the priority associated &n;         * with overheating is high enough to warrant this action.&n;         */
id|h8_get_curr_temp
c_func
(paren
id|curr_temp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;H8: Initial CPU temp: %d&bslash;n&quot;
comma
id|curr_temp
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curr_temp
(braket
l_int|0
)braket
op_ge
id|h8_uthermal_threshold
)paren
(brace
id|h8_set_event_mask
c_func
(paren
id|H8_MANAGE_UTHERM
)paren
suffix:semicolon
id|h8_manage_therm
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;                 * Arm the upper thermal limit of the H8 so that any temp in&n;                 * excess will trigger the thermal control mechanism.&n;                 */
id|h8_set_upper_therm_thold
c_func
(paren
id|h8_uthermal_threshold
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|sleep_on
c_func
(paren
op_amp
id|h8_monitor_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;h8_monitor_thread awakened, mask:%x&bslash;n&quot;
comma
id|h8_event_mask
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|h8_event_mask
op_amp
(paren
id|H8_MANAGE_UTHERM
op_or
id|H8_MANAGE_LTHERM
)paren
)paren
(brace
id|h8_manage_therm
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|h8_event_mask
op_amp
id|H8_POWER_BUTTON
)paren
(brace
id|h8_system_down
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * If an external DC supply is removed or added make &n;&t;&t; * appropriate CPU speed adjustments.&n;&t;&t; */
r_if
c_cond
(paren
id|h8_event_mask
op_amp
id|H8_MANAGE_BATTERY
)paren
(brace
id|h8_run_level_3_manage
c_func
(paren
id|H8_RUN
)paren
suffix:semicolon
id|h8_clear_event_mask
c_func
(paren
id|H8_MANAGE_BATTERY
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
multiline_comment|/* &n; * Function implements the following policy. When the machine is booted&n; * the system is set to run at full clock speed. When the upper thermal&n; * threshold is reached as a result of full clock a damping factor is &n; * applied to cool off the cpu.  The default value is one quarter clock&n; * (57 Mhz).  When as a result of this cooling a temperature lower by&n; * hmc_uthermal_window is reached, the machine is reset to a higher &n; * speed, one half clock (115 Mhz).  One half clock is maintained until&n; * the upper thermal threshold is again reached restarting the cycle.&n; */
r_int
DECL|function|h8_manage_therm
id|h8_manage_therm
c_func
(paren
r_void
)paren
(brace
id|u_char
id|curr_temp
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|h8_event_mask
op_amp
id|H8_MANAGE_UTHERM
)paren
(brace
multiline_comment|/* Upper thermal interrupt received, need to cool down. */
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;H8: Thermal threshold %d F reached&bslash;n&quot;
comma
id|h8_uthermal_threshold
)paren
suffix:semicolon
)brace
id|h8_set_cpu_speed
c_func
(paren
id|h8_udamp
)paren
suffix:semicolon
id|h8_clear_event_mask
c_func
(paren
id|H8_MANAGE_UTHERM
)paren
suffix:semicolon
id|h8_set_event_mask
c_func
(paren
id|H8_MANAGE_LTHERM
)paren
suffix:semicolon
multiline_comment|/* Check again in 30 seconds for CPU temperature */
id|h8_start_monitor_timer
c_func
(paren
id|H8_TIMEOUT_INTERVAL
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|h8_event_mask
op_amp
id|H8_MANAGE_LTHERM
)paren
(brace
multiline_comment|/* See how cool the system has become as a result&n;&t;&t;   of the reduction in speed. */
id|h8_get_curr_temp
c_func
(paren
id|curr_temp
)paren
suffix:semicolon
id|last_temp
op_assign
id|curr_temp
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|curr_temp
(braket
l_int|0
)braket
OL
(paren
id|h8_uthermal_threshold
op_minus
id|h8_uthermal_window
)paren
)paren
(brace
multiline_comment|/* System cooling has progressed to a point&n;&t;&t;&t;   that the CPU may be sped up. */
id|h8_set_upper_therm_thold
c_func
(paren
id|h8_uthermal_threshold
)paren
suffix:semicolon
id|h8_set_cpu_speed
c_func
(paren
id|h8_ldamp
)paren
suffix:semicolon
multiline_comment|/* adjustable */
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;H8: CPU cool, applying cpu_divisor: %d &bslash;n&quot;
comma
id|h8_ldamp
)paren
suffix:semicolon
)brace
id|h8_clear_event_mask
c_func
(paren
id|H8_MANAGE_LTHERM
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Not cool enough yet, check again in 30 seconds. */
id|h8_start_monitor_timer
c_func
(paren
id|H8_TIMEOUT_INTERVAL
)paren
suffix:semicolon
)brace
r_else
(brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Function conditions the value of global_rpb_counter before&n; * calling the primitive which causes the actual speed change.&n; */
r_void
DECL|function|h8_set_cpu_speed
id|h8_set_cpu_speed
c_func
(paren
r_int
id|speed_divisor
)paren
(brace
macro_line|#ifdef NOT_YET
multiline_comment|/*&n; * global_rpb_counter is consumed by alpha_delay() in determining just&n; * how much time to delay.  It is necessary that the number of microseconds&n; * in DELAY(n) be kept consistent over a variety of CPU clock speeds.&n; * To that end global_rpb_counter is here adjusted.&n; */
r_switch
c_cond
(paren
id|speed_divisor
)paren
(brace
r_case
l_int|0
suffix:colon
id|global_rpb_counter
op_assign
id|rpb-&gt;rpb_counter
op_star
l_int|2L
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|global_rpb_counter
op_assign
id|rpb-&gt;rpb_counter
op_star
l_int|4L
op_div
l_int|3L
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|global_rpb_counter
op_assign
id|rpb-&gt;rpb_counter
op_div
l_int|2L
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|global_rpb_counter
op_assign
id|rpb-&gt;rpb_counter
op_div
l_int|4L
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|global_rpb_counter
op_assign
id|rpb-&gt;rpb_counter
op_div
l_int|8L
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* &n;                 * This case most commonly needed for cpu_speed_divisor &n;                 * of 2 which is the value assigned by the firmware. &n;                 */
r_default
suffix:colon
id|global_rpb_counter
op_assign
id|rpb-&gt;rpb_counter
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#endif /* NOT_YET */
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;H8: Setting CPU speed to %d MHz&bslash;n&quot;
comma
id|speed_tab
(braket
id|speed_divisor
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Make the actual speed change */
id|lca_clock_fiddle
c_func
(paren
id|speed_divisor
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Gets value stored in rpb representing CPU clock speed and adjusts this&n; * value based on the current clock speed divisor.&n; */
id|u_long
DECL|function|h8_get_cpu_speed
id|h8_get_cpu_speed
c_func
(paren
r_void
)paren
(brace
id|u_long
id|speed
op_assign
l_int|0
suffix:semicolon
id|u_long
id|counter
suffix:semicolon
macro_line|#ifdef NOT_YET
id|counter
op_assign
id|rpb-&gt;rpb_counter
op_div
l_int|1000000L
suffix:semicolon
r_switch
c_cond
(paren
id|alphabook_get_clock
c_func
(paren
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
id|speed
op_assign
id|counter
op_star
l_int|2L
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|speed
op_assign
id|counter
op_star
l_int|4L
op_div
l_int|3L
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|speed
op_assign
id|counter
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|speed
op_assign
id|counter
op_div
l_int|2L
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|speed
op_assign
id|counter
op_div
l_int|4L
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|speed
op_assign
id|counter
op_div
l_int|8L
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|h8_debug
op_amp
l_int|0x8
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;H8: CPU speed current setting: %d MHz&bslash;n&quot;
comma
id|speed
)paren
suffix:semicolon
)brace
macro_line|#endif  /* NOT_YET */
r_return
id|speed
suffix:semicolon
)brace
r_static
r_void
DECL|function|h8_activate_monitor
id|h8_activate_monitor
c_func
(paren
r_int
r_int
id|unused
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|h8_monitor_timer_active
op_assign
l_int|0
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|h8_monitor_wait
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|h8_start_monitor_timer
id|h8_start_monitor_timer
c_func
(paren
r_int
r_int
id|secs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|h8_monitor_timer_active
)paren
r_return
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|h8_monitor_timer_active
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|h8_monitor_timer
)paren
suffix:semicolon
id|h8_monitor_timer.function
op_assign
id|h8_activate_monitor
suffix:semicolon
id|h8_monitor_timer.expires
op_assign
id|secs
op_star
id|HZ
op_plus
id|jiffies
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|h8_monitor_timer
)paren
suffix:semicolon
)brace
DECL|function|h8_set_event_mask
r_static
r_void
id|h8_set_event_mask
c_func
(paren
r_int
id|mask
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|h8_event_mask
op_or_assign
id|mask
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|h8_clear_event_mask
r_static
r_void
id|h8_clear_event_mask
c_func
(paren
r_int
id|mask
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|h8_event_mask
op_and_assign
(paren
op_complement
id|mask
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
eof
