multiline_comment|/*&n;** -----------------------------------------------------------------------------&n;**&n;**  Perle Specialix driver for Linux&n;**  Ported from existing RIO Driver for SCO sources.&n; *&n; *  (C) 1990 - 2000 Specialix International Ltd., Byfleet, Surrey, UK.&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *      This program is distributed in the hope that it will be useful,&n; *      but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *      GNU General Public License for more details.&n; *&n; *      You should have received a copy of the GNU General Public License&n; *      along with this program; if not, write to the Free Software&n; *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;**&n;**&t;Module&t;&t;: rioinit.c&n;**&t;SID&t;&t;: 1.3&n;**&t;Last Modified&t;: 11/6/98 10:33:43&n;**&t;Retrieved&t;: 11/6/98 10:33:49&n;**&n;**  ident @(#)rioinit.c&t;1.3&n;**&n;** -----------------------------------------------------------------------------&n;*/
macro_line|#ifdef SCCS_LABELS
DECL|variable|_rioinit_c_sccs_
r_static
r_char
op_star
id|_rioinit_c_sccs_
op_assign
l_string|&quot;@(#)rioinit.c&t;1.3&quot;
suffix:semicolon
macro_line|#endif
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/string.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#include &lt;linux/generic_serial.h&gt;
macro_line|#include &quot;linux_compat.h&quot;
macro_line|#include &quot;typdef.h&quot;
macro_line|#include &quot;pkt.h&quot;
macro_line|#include &quot;daemon.h&quot;
macro_line|#include &quot;rio.h&quot;
macro_line|#include &quot;riospace.h&quot;
macro_line|#include &quot;top.h&quot;
macro_line|#include &quot;cmdpkt.h&quot;
macro_line|#include &quot;map.h&quot;
macro_line|#include &quot;riotypes.h&quot;
macro_line|#include &quot;rup.h&quot;
macro_line|#include &quot;port.h&quot;
macro_line|#include &quot;riodrvr.h&quot;
macro_line|#include &quot;rioinfo.h&quot;
macro_line|#include &quot;func.h&quot;
macro_line|#include &quot;errors.h&quot;
macro_line|#include &quot;pci.h&quot;
macro_line|#include &quot;parmmap.h&quot;
macro_line|#include &quot;unixrup.h&quot;
macro_line|#include &quot;board.h&quot;
macro_line|#include &quot;host.h&quot;
macro_line|#include &quot;error.h&quot;
macro_line|#include &quot;phb.h&quot;
macro_line|#include &quot;link.h&quot;
macro_line|#include &quot;cmdblk.h&quot;
macro_line|#include &quot;route.h&quot;
macro_line|#include &quot;control.h&quot;
macro_line|#include &quot;cirrus.h&quot;
macro_line|#include &quot;rioioctl.h&quot;
macro_line|#include &quot;rio_linux.h&quot;
DECL|macro|bcopy
macro_line|#undef bcopy
DECL|macro|bcopy
mdefine_line|#define bcopy rio_pcicopy
r_int
id|RIOPCIinit
c_func
(paren
r_struct
id|rio_info
op_star
id|p
comma
r_int
id|Mode
)paren
suffix:semicolon
macro_line|#if 0
r_extern
r_int
id|rio_intr
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;**&t;Init time code.&n;*/
r_void
id|rioinit
c_func
(paren
id|p
comma
id|info
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_struct
id|RioHostInfo
op_star
id|info
suffix:semicolon
(brace
multiline_comment|/*&n;&t;** Multi-Host card support - taking the easy way out - sorry !&n;&t;** We allocate and set up the Host and Port structs when the&n;&t;** driver is called to &squot;install&squot; the first host.&n;&t;** We check for this first &squot;call&squot; by testing the RIOPortp pointer.&n;&t;*/
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;RIOPortp
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Allocating and setting up driver data structures&bslash;n&quot;
)paren
suffix:semicolon
id|RIOAllocDataStructs
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* allocate host/port structs */
id|RIOSetupDataStructs
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* setup topology structs */
)brace
id|RIOInitHosts
c_func
(paren
id|p
comma
id|info
)paren
suffix:semicolon
multiline_comment|/* hunt down the hardware */
id|RIOAllocateInterrupts
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* allocate interrupts */
id|RIOReport
c_func
(paren
id|p
)paren
suffix:semicolon
multiline_comment|/* show what we found */
)brace
multiline_comment|/*&n;** Initialise the Cards &n;*/
r_void
id|RIOInitHosts
c_func
(paren
id|p
comma
id|info
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_struct
id|RioHostInfo
op_star
id|info
suffix:semicolon
(brace
multiline_comment|/*&n;** 15.10.1998 ARG - ESIL 0762 part fix&n;** If there is no ISA card definition - we always look for PCI cards.&n;** As we currently only support one host card this lets an ISA card&n;** definition take precedence over PLUG and PLAY.&n;** No ISA card - we are PLUG and PLAY with PCI.&n;*/
multiline_comment|/*&n;&t;** Note - for PCI both these will be zero, that&squot;s okay because&n;&t;** RIOPCIInit() fills them in if a card is found.&n;&t;*/
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Ivec
op_assign
id|info-&gt;vector
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|PaddrP
op_assign
id|info-&gt;location
suffix:semicolon
multiline_comment|/*&n;&t;** Check that we are able to accomodate another host&n;&t;*/
r_if
c_cond
(paren
id|p-&gt;RIONumHosts
op_ge
id|RIO_HOSTS
)paren
(brace
id|p-&gt;RIOFailed
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;bus
op_amp
id|ISA_BUS
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;initialising card %d (ISA)&bslash;n&quot;
comma
id|p-&gt;RIONumHosts
)paren
suffix:semicolon
id|RIOISAinit
c_func
(paren
id|p
comma
id|p-&gt;mode
)paren
suffix:semicolon
)brace
r_else
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;initialising card %d (PCI)&bslash;n&quot;
comma
id|p-&gt;RIONumHosts
)paren
suffix:semicolon
id|RIOPCIinit
c_func
(paren
id|p
comma
id|RIO_PCI_DEFAULT_MODE
)paren
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Total hosts initialised so far : %d&bslash;n&quot;
comma
id|p-&gt;RIONumHosts
)paren
suffix:semicolon
macro_line|#ifdef FUTURE_RELEASE
r_if
c_cond
(paren
id|p-&gt;bus
op_amp
id|EISA_BUS
)paren
multiline_comment|/* EISA card */
id|RIOEISAinit
c_func
(paren
id|p
comma
id|RIO_EISA_DEFAULT_MODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;bus
op_amp
id|MCA_BUS
)paren
multiline_comment|/* MCA card */
id|RIOMCAinit
c_func
(paren
id|p
comma
id|RIO_MCA_DEFAULT_MODE
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;** go through memory for an AT host that we pass in the device info&n;** structure and initialise&n;*/
r_void
id|RIOISAinit
c_func
(paren
id|p
comma
id|mode
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_int
id|mode
suffix:semicolon
(brace
multiline_comment|/* XXX Need to implement this. */
macro_line|#if 0
id|p-&gt;intr_tid
op_assign
id|iointset
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Ivec
comma
(paren
r_int
(paren
op_star
)paren
(paren
)paren
)paren
id|rio_intr
comma
(paren
r_char
op_star
)paren
id|p-&gt;RIONumHosts
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Set interrupt handler, intr_tid = 0x%x&bslash;n&quot;
comma
id|p-&gt;intr_tid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIODoAT
c_func
(paren
id|p
comma
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|PaddrP
comma
id|mode
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_else
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIODoAT failed&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOFailed
op_increment
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/*&n;** RIODoAT :&n;**&n;** Map in a boards physical address, check that the board is there,&n;** test the board and if everything is okay assign the board an entry&n;** in the Rio Hosts structure.&n;*/
r_int
id|RIODoAT
c_func
(paren
id|p
comma
id|Base
comma
id|mode
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_int
id|Base
suffix:semicolon
r_int
id|mode
suffix:semicolon
(brace
mdefine_line|#define&t;FOUND&t;&t;1
mdefine_line|#define NOT_FOUND&t;0
id|caddr_t
id|cardAddr
suffix:semicolon
multiline_comment|/*&n;&t;** Check to see if we actually have a board at this physical address.&n;&t;*/
r_if
c_cond
(paren
(paren
id|cardAddr
op_assign
id|RIOCheckForATCard
c_func
(paren
id|Base
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;** Now test the board to see if it is working.&n;&t;&t;*/
r_if
c_cond
(paren
id|RIOBoardTest
c_func
(paren
id|Base
comma
id|cardAddr
comma
id|RIO_AT
comma
l_int|0
)paren
op_eq
id|RIO_SUCCESS
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;** Fill out a slot in the Rio host structure.&n;&t;&t;&t;*/
r_if
c_cond
(paren
id|RIOAssignAT
c_func
(paren
id|p
comma
id|Base
comma
id|cardAddr
comma
id|mode
)paren
)paren
(brace
r_return
id|FOUND
suffix:semicolon
)brace
)brace
id|RIOMapout
c_func
(paren
id|Base
comma
id|RIO_AT_MEM_SIZE
comma
id|cardAddr
)paren
suffix:semicolon
)brace
r_return
id|NOT_FOUND
suffix:semicolon
)brace
id|caddr_t
id|RIOCheckForATCard
c_func
(paren
id|Base
)paren
r_int
id|Base
suffix:semicolon
(brace
r_int
id|off
suffix:semicolon
r_struct
id|DpRam
op_star
id|cardp
suffix:semicolon
multiline_comment|/* (Points at the host) */
id|caddr_t
id|virtAddr
suffix:semicolon
r_int
r_char
id|RIOSigTab
(braket
l_int|24
)braket
suffix:semicolon
multiline_comment|/*&n;** Table of values to search for as prom signature of a host card&n;*/
id|strcpy
c_func
(paren
id|RIOSigTab
comma
l_string|&quot;JBJGPGGHINSMJPJR&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Hey! Yes, You reading this code! Yo, grab a load a this:&n;&t;**&n;&t;** IF the card is using WORD MODE rather than BYTE MODE&n;&t;** then it will occupy 128K of PHYSICAL memory area. So,&n;&t;** you might think that the following Mapin is wrong. Well,&n;&t;** it isn&squot;t, because the SECOND 64K of occupied space is an&n;&t;** EXACT COPY of the FIRST 64K. (good?), so, we need only&n;&t;** map it in in one 64K block.&n;&t;*/
r_if
c_cond
(paren
id|RIOMapin
c_func
(paren
id|Base
comma
id|RIO_AT_MEM_SIZE
comma
op_amp
id|virtAddr
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Couldn&squot;t map the board in!&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|caddr_t
)paren
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** virtAddr points to the DP ram of the system.&n;&t;** We now cast this to a pointer to a RIO Host,&n;&t;** and have a rummage about in the PROM.&n;&t;*/
id|cardp
op_assign
(paren
r_struct
id|DpRam
op_star
)paren
id|virtAddr
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|RIOSigTab
(braket
id|off
)braket
suffix:semicolon
id|off
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|RBYTE
c_func
(paren
id|cardp-&gt;DpSignature
(braket
id|off
)braket
)paren
op_amp
l_int|0xFF
)paren
op_ne
id|RIOSigTab
(braket
id|off
)braket
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;** Signature mismatch - card not at this address&n;&t;&t;&t;*/
id|RIOMapout
c_func
(paren
id|Base
comma
id|RIO_AT_MEM_SIZE
comma
id|virtAddr
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Couldn&squot;t match the signature 0x%x 0x%x!&bslash;n&quot;
comma
(paren
r_int
)paren
id|cardp
comma
id|off
)paren
suffix:semicolon
r_return
(paren
id|caddr_t
)paren
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;** If we get here then we must have found a valid board so return&n;&t;** its virtual address.&n;&t;*/
r_return
id|virtAddr
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/**&n;** RIOAssignAT :&n;**&n;** Fill out the fields in the p-&gt;RIOHosts structure now we know we know&n;** we have a board present.&n;**&n;** bits &lt; 0 indicates 8 bit operation requested,&n;** bits &gt; 0 indicates 16 bit operation.&n;*/
r_int
DECL|function|RIOAssignAT
id|RIOAssignAT
c_func
(paren
id|p
comma
id|Base
comma
id|virtAddr
comma
id|mode
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_int
id|Base
suffix:semicolon
id|caddr_t
id|virtAddr
suffix:semicolon
r_int
id|mode
suffix:semicolon
(brace
r_int
id|bits
suffix:semicolon
r_struct
id|DpRam
op_star
id|cardp
op_assign
(paren
r_struct
id|DpRam
op_star
)paren
id|virtAddr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Base
OL
id|ONE_MEG
)paren
op_logical_or
(paren
id|mode
op_amp
id|BYTE_ACCESS_MODE
)paren
)paren
id|bits
op_assign
id|BYTE_OPERATION
suffix:semicolon
r_else
id|bits
op_assign
id|WORD_OPERATION
suffix:semicolon
multiline_comment|/*&n;&t;** Board has passed its scrub test. Fill in all the&n;&t;** transient stuff.&n;&t;*/
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Caddr
op_assign
id|virtAddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|CardP
op_assign
(paren
r_struct
id|DpRam
op_star
)paren
id|virtAddr
suffix:semicolon
multiline_comment|/*&n;&t;** Revision 01 AT host cards don&squot;t support WORD operations,&n;&t;*/
r_if
c_cond
(paren
id|RBYTE
c_func
(paren
id|cardp-&gt;DpRevision
)paren
op_eq
l_int|01
)paren
id|bits
op_assign
id|BYTE_OPERATION
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Type
op_assign
id|RIO_AT
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Copy
op_assign
id|bcopy
suffix:semicolon
multiline_comment|/* set this later */
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Slot
op_assign
op_minus
l_int|1
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Mode
op_assign
id|SLOW_LINKS
op_or
id|SLOW_AT_BUS
op_or
id|bits
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Control
comma
id|BOOT_FROM_RAM
op_or
id|EXTERNAL_BUS_OFF
op_or
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Mode
op_or
id|INTERRUPT_DISABLE
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|ResetInt
comma
l_int|0xff
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Control
comma
id|BOOT_FROM_RAM
op_or
id|EXTERNAL_BUS_OFF
op_or
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Mode
op_or
id|INTERRUPT_DISABLE
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|ResetInt
comma
l_int|0xff
)paren
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|UniqueNum
op_assign
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Unique
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Unique
(braket
l_int|1
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Unique
(braket
l_int|2
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Unique
(braket
l_int|3
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Uniquenum 0x%x&bslash;n&quot;
comma
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|UniqueNum
)paren
suffix:semicolon
id|p-&gt;RIONumHosts
op_increment
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Tests Passed at 0x%x&bslash;n&quot;
comma
id|Base
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#if 0
macro_line|#ifdef FUTURE_RELEASE
r_int
id|RIOMCAinit
c_func
(paren
r_int
id|Mode
)paren
(brace
id|uchar
id|SlotNumber
suffix:semicolon
id|caddr_t
id|Caddr
suffix:semicolon
id|uint
id|Paddr
suffix:semicolon
id|uint
id|Ivec
suffix:semicolon
r_int
id|Handle
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;** Valid mode information for MCA cards&n;&t;** is only FAST LINKS&n;&t;*/
id|Mode
op_assign
(paren
id|Mode
op_amp
id|FAST_LINKS
)paren
ques
c_cond
id|McaTpFastLinks
suffix:colon
id|McaTpSlowLinks
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIOMCAinit(%d)&bslash;n&quot;
comma
id|Mode
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Check out each of the slots&n;&t;*/
r_for
c_loop
(paren
id|SlotNumber
op_assign
l_int|0
suffix:semicolon
id|SlotNumber
OL
id|McaMaxSlots
suffix:semicolon
id|SlotNumber
op_increment
)paren
(brace
multiline_comment|/*&n;&t;** Enable the slot we want to talk to&n;&t;*/
id|outb
c_func
(paren
id|McaSlotSelect
comma
id|SlotNumber
op_or
id|McaSlotEnable
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Read the ID word from the slot&n;&t;*/
r_if
c_cond
(paren
(paren
(paren
id|inb
c_func
(paren
id|McaIdHigh
)paren
op_lshift
l_int|8
)paren
op_or
id|inb
c_func
(paren
id|McaIdLow
)paren
)paren
op_eq
id|McaRIOId
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Potential MCA card in slot %d&bslash;n&quot;
comma
id|SlotNumber
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Card appears to be a RIO MCA card!&n;&t;&t;*/
id|RIOMachineType
op_or_assign
(paren
l_int|1
op_lshift
id|RIO_MCA
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Just check we haven&squot;t found too many wonderful objects&n;&t;&t;*/
r_if
c_cond
(paren
id|RIONumHosts
op_ge
id|RIO_HOSTS
)paren
(brace
id|Rprintf
c_func
(paren
id|RIOMesgTooManyCards
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;** McaIrqEnable contains the interrupt vector, and a card&n;&t;&t;** enable bit.&n;&t;&t;*/
id|Ivec
op_assign
id|inb
c_func
(paren
id|McaIrqEnable
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Ivec is %x&bslash;n&quot;
comma
id|Ivec
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|Ivec
op_amp
id|McaIrqMask
)paren
(brace
r_case
id|McaIrq9
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;IRQ9&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|McaIrq3
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;IRQ3&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|McaIrq4
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;IRQ4&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|McaIrq7
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;IRQ7&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|McaIrq10
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;IRQ10&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|McaIrq11
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;IRQ11&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|McaIrq12
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;IRQ12&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|McaIrq15
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;IRQ15&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;** If the card enable bit isn&squot;t set, then set it!&n;&t;&t;*/
r_if
c_cond
(paren
(paren
id|Ivec
op_amp
id|McaCardEnable
)paren
op_ne
id|McaCardEnable
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;McaCardEnable not set - setting!&bslash;n&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
id|McaIrqEnable
comma
id|Ivec
op_or
id|McaCardEnable
)paren
suffix:semicolon
)brace
r_else
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;McaCardEnable already set&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Convert the IRQ enable mask into something useful&n;&t;&t;*/
id|Ivec
op_assign
id|RIOMcaToIvec
(braket
id|Ivec
op_amp
id|McaIrqMask
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Find the physical address&n;&t;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;inb(McaMemory) is %x&bslash;n&quot;
comma
id|inb
c_func
(paren
id|McaMemory
)paren
)paren
suffix:semicolon
id|Paddr
op_assign
id|McaAddress
c_func
(paren
id|inb
c_func
(paren
id|McaMemory
)paren
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;MCA card has Ivec %d Addr %x&bslash;n&quot;
comma
id|Ivec
comma
id|Paddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Paddr
op_ne
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;** Tell the memory mapper that we want to talk to it&n;&t;&t;*/
id|Handle
op_assign
id|RIOMapin
c_func
(paren
id|Paddr
comma
id|RIO_MCA_MEM_SIZE
comma
op_amp
id|Caddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Handle
op_eq
op_minus
l_int|1
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Couldn&squot;t map %d bytes at %x&bslash;n&quot;
comma
id|RIO_MCA_MEM_SIZE
comma
id|Paddr
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Board mapped to vaddr 0x%x&bslash;n&quot;
comma
id|Caddr
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** And check that it is actually there!&n;&t;&t;*/
r_if
c_cond
(paren
id|RIOBoardTest
c_func
(paren
id|Paddr
comma
id|Caddr
comma
id|RIO_MCA
comma
id|SlotNumber
)paren
op_eq
id|RIO_SUCCESS
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Board has passed test&bslash;n&quot;
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Slot %d. Type %d. Paddr 0x%x. Caddr 0x%x. Mode 0x%x.&bslash;n&quot;
comma
id|SlotNumber
comma
id|RIO_MCA
comma
id|Paddr
comma
id|Caddr
comma
id|Mode
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;** Board has passed its scrub test. Fill in all the&n;&t;&t;&t;** transient stuff.&n;&t;&t;&t;*/
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Slot
op_assign
id|SlotNumber
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Ivec
op_assign
id|Ivec
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Type
op_assign
id|RIO_MCA
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Copy
op_assign
id|bcopy
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|PaddrP
op_assign
id|Paddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Caddr
op_assign
id|Caddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|CardP
op_assign
(paren
r_struct
id|DpRam
op_star
)paren
id|Caddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Mode
op_assign
id|Mode
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|ResetInt
comma
l_int|0xff
)paren
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|UniqueNum
op_assign
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|1
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|2
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|3
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|RIONumHosts
op_increment
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;** It failed the test, so ignore it.&n;&t;&t;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;TEST FAILED&bslash;n&quot;
)paren
suffix:semicolon
id|RIOMapout
c_func
(paren
id|Paddr
comma
id|RIO_MCA_MEM_SIZE
comma
id|Caddr
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Slot %d - Paddr zero!&bslash;n&quot;
comma
id|SlotNumber
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Slot %d NOT RIO&bslash;n&quot;
comma
id|SlotNumber
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;** Now we have checked all the slots, turn off the MCA slot selector&n;&t;*/
id|outb
c_func
(paren
id|McaSlotSelect
comma
l_int|0
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Slot %d NOT RIO&bslash;n&quot;
comma
id|SlotNumber
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_int
id|RIOEISAinit
c_func
(paren
r_int
id|Mode
)paren
(brace
r_static
r_int
id|EISADone
op_assign
l_int|0
suffix:semicolon
id|uint
id|Paddr
suffix:semicolon
r_int
id|PollIntMixMsgDone
op_assign
l_int|0
suffix:semicolon
id|caddr_t
id|Caddr
suffix:semicolon
id|ushort
id|Ident
suffix:semicolon
id|uchar
id|EisaSlot
suffix:semicolon
id|uchar
id|Ivec
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;** The only valid mode information for EISA hosts is fast or slow&n;&t;** links.&n;&t;*/
id|Mode
op_assign
(paren
id|Mode
op_amp
id|FAST_LINKS
)paren
ques
c_cond
id|EISA_TP_FAST_LINKS
suffix:colon
id|EISA_TP_SLOW_LINKS
suffix:semicolon
r_if
c_cond
(paren
id|EISADone
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIOEISAinit() - already done, return.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|EISADone
op_increment
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIOEISAinit()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** First check all cards to see if ANY are set for polled mode operation.&n;&t;** If so, set ALL to polled.&n;&t;*/
r_for
c_loop
(paren
id|EisaSlot
op_assign
l_int|1
suffix:semicolon
id|EisaSlot
op_le
id|RIO_MAX_EISA_SLOTS
suffix:semicolon
id|EisaSlot
op_increment
)paren
(brace
id|Ident
op_assign
(paren
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_PRODUCT_IDENT_HI
)paren
op_lshift
l_int|8
)paren
op_or
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_PRODUCT_IDENT_LO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Ident
op_eq
id|RIO_EISA_IDENT
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Found Specialix product&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_PRODUCT_NUMBER
)paren
op_ne
id|RIO_EISA_PRODUCT_CODE
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Not Specialix RIO - Product number %x&bslash;n&quot;
comma
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_PRODUCT_NUMBER
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* next slot */
)brace
multiline_comment|/*&n;&t;&t;** Its a Specialix RIO!&n;&t;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO Revision %d&bslash;n&quot;
comma
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_REVISION_NUMBER
)paren
)paren
suffix:semicolon
id|RIOMachineType
op_or_assign
(paren
l_int|1
op_lshift
id|RIO_EISA
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Just check we haven&squot;t found too many wonderful objects&n;&t;&t;*/
r_if
c_cond
(paren
id|RIONumHosts
op_ge
id|RIO_HOSTS
)paren
(brace
id|Rprintf
c_func
(paren
id|RIOMesgTooManyCards
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;** Ensure that the enable bit is set!&n;&t;&t;*/
id|OUTBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_ENABLE
comma
id|RIO_EISA_ENABLE_BIT
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** EISA_INTERRUPT_VEC contains the interrupt vector.&n;&t;&t;*/
id|Ivec
op_assign
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_INTERRUPT_VEC
)paren
suffix:semicolon
macro_line|#ifdef RIODEBUG
r_switch
c_cond
(paren
id|Ivec
op_amp
id|EISA_INTERRUPT_MASK
)paren
(brace
r_case
id|EISA_IRQ_3
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 3&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_4
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 4&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_5
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 5&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_6
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 6&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_7
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 7&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_9
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 9&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_10
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 10&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_11
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 11&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_12
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 12&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_14
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 14&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_IRQ_15
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA IRQ 15&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EISA_POLLED
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA POLLED&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_int|NULL
comma
id|DBG_INIT
op_or
id|DBG_FAIL
comma
l_string|&quot;Shagged interrupt number!&bslash;n&quot;
)paren
suffix:semicolon
id|Ivec
op_and_assign
id|EISA_CONTROL_MASK
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|Ivec
op_amp
id|EISA_INTERRUPT_MASK
)paren
op_eq
id|EISA_POLLED
)paren
(brace
id|RIOWillPoll
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* From EisaSlot loop */
)brace
)brace
)brace
multiline_comment|/*&n;&t;** Do it all again now we know whether to change all cards to polled&n;&t;** mode or not&n;&t;*/
r_for
c_loop
(paren
id|EisaSlot
op_assign
l_int|1
suffix:semicolon
id|EisaSlot
op_le
id|RIO_MAX_EISA_SLOTS
suffix:semicolon
id|EisaSlot
op_increment
)paren
(brace
id|Ident
op_assign
(paren
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_PRODUCT_IDENT_HI
)paren
op_lshift
l_int|8
)paren
op_or
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_PRODUCT_IDENT_LO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Ident
op_eq
id|RIO_EISA_IDENT
)paren
(brace
r_if
c_cond
(paren
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_PRODUCT_NUMBER
)paren
op_ne
id|RIO_EISA_PRODUCT_CODE
)paren
r_continue
suffix:semicolon
multiline_comment|/* next slot */
multiline_comment|/*&n;&t;&t;** Its a Specialix RIO!&n;&t;&t;*/
multiline_comment|/*&n;&t;&t;** Ensure that the enable bit is set!&n;&t;&t;*/
id|OUTBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_ENABLE
comma
id|RIO_EISA_ENABLE_BIT
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** EISA_INTERRUPT_VEC contains the interrupt vector.&n;&t;&t;*/
id|Ivec
op_assign
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_INTERRUPT_VEC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIOWillPoll
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;** If we are going to operate in polled mode, but this&n;&t;&t;&t;** board is configured to be interrupt driven, display&n;&t;&t;&t;** the message explaining the situation to the punter,&n;&t;&t;&t;** assuming we haven&squot;t already done so.&n;&t;&t;&t;*/
r_if
c_cond
(paren
op_logical_neg
id|PollIntMixMsgDone
op_logical_and
(paren
id|Ivec
op_amp
id|EISA_INTERRUPT_MASK
)paren
op_ne
id|EISA_POLLED
)paren
(brace
id|Rprintf
c_func
(paren
id|RIOMesgAllPolled
)paren
suffix:semicolon
id|PollIntMixMsgDone
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;** Ungraciously ignore whatever the board reports as its&n;&t;&t;&t;** interrupt vector...&n;&t;&t;&t;*/
id|Ivec
op_and_assign
op_complement
id|EISA_INTERRUPT_MASK
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;** ...and force it to dance to the poll tune.&n;&t;&t;&t;*/
id|Ivec
op_or_assign
id|EISA_POLLED
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;** Convert the IRQ enable mask into something useful (0-15)&n;&t;&t;*/
id|Ivec
op_assign
id|RIOEisaToIvec
c_func
(paren
id|Ivec
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA host in slot %d has Ivec 0x%x&bslash;n&quot;
comma
id|EisaSlot
comma
id|Ivec
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Find the physical address&n;&t;&t;*/
id|Paddr
op_assign
(paren
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_MEMORY_BASE_HI
)paren
op_lshift
l_int|24
)paren
op_or
(paren
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_MEMORY_BASE_LO
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;EISA card has Ivec %d Addr %x&bslash;n&quot;
comma
id|Ivec
comma
id|Paddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Paddr
op_eq
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Board in slot %d configured for address zero!&bslash;n&quot;
comma
id|EisaSlot
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;** Tell the memory mapper that we want to talk to it&n;&t;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;About to map EISA card &bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIOMapin
c_func
(paren
id|Paddr
comma
id|RIO_EISA_MEM_SIZE
comma
op_amp
id|Caddr
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Couldn&squot;t map %d bytes at %x&bslash;n&quot;
comma
id|RIO_EISA_MEM_SIZE
comma
id|Paddr
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Board mapped to vaddr 0x%x&bslash;n&quot;
comma
id|Caddr
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** And check that it is actually there!&n;&t;&t;*/
r_if
c_cond
(paren
id|RIOBoardTest
c_func
(paren
id|Paddr
comma
id|Caddr
comma
id|RIO_EISA
comma
id|EisaSlot
)paren
op_eq
id|RIO_SUCCESS
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Board has passed test&bslash;n&quot;
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Slot %d. Ivec %d. Type %d. Paddr 0x%x. Caddr 0x%x. Mode 0x%x.&bslash;n&quot;
comma
id|EisaSlot
comma
id|Ivec
comma
id|RIO_EISA
comma
id|Paddr
comma
id|Caddr
comma
id|Mode
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Board has passed its scrub test. Fill in all the&n;&t;&t;** transient stuff.&n;&t;&t;*/
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Slot
op_assign
id|EisaSlot
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Ivec
op_assign
id|Ivec
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Type
op_assign
id|RIO_EISA
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Copy
op_assign
id|bcopy
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|PaddrP
op_assign
id|Paddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Caddr
op_assign
id|Caddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|CardP
op_assign
(paren
r_struct
id|DpRam
op_star
)paren
id|Caddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Mode
op_assign
id|Mode
suffix:semicolon
multiline_comment|/*&n;&t;&t;** because the EISA prom is mapped into IO space, we&n;&t;&t;** need to copy the unqiue number into the memory area&n;&t;&t;** that it would have occupied, so that the download&n;&t;&t;** code can determine its ID and card type.&n;&t;&t;*/
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|0
)braket
comma
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_UNIQUE_NUM_0
)paren
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|1
)braket
comma
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_UNIQUE_NUM_1
)paren
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|2
)braket
comma
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_UNIQUE_NUM_2
)paren
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|3
)braket
comma
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_UNIQUE_NUM_3
)paren
)paren
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|UniqueNum
op_assign
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|1
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|2
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|RIONumHosts
)braket
dot
id|Unique
(braket
l_int|3
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|INBZ
c_func
(paren
id|EisaSlot
comma
id|EISA_INTERRUPT_RESET
)paren
suffix:semicolon
id|RIONumHosts
op_increment
suffix:semicolon
id|ret
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;** It failed the test, so ignore it.&n;&t;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;TEST FAILED&bslash;n&quot;
)paren
suffix:semicolon
id|RIOMapout
c_func
(paren
id|Paddr
comma
id|RIO_EISA_MEM_SIZE
comma
id|Caddr
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|RIOMachineType
op_amp
id|RIO_EISA
)paren
r_return
id|ret
op_plus
l_int|1
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifndef linux
mdefine_line|#define CONFIG_ADDRESS&t;0xcf8
mdefine_line|#define CONFIG_DATA&t;&t;0xcfc
mdefine_line|#define FORWARD_REG&t;&t;0xcfa
r_static
r_int
id|read_config
c_func
(paren
r_int
id|bus_number
comma
r_int
id|device_num
comma
r_int
id|r_number
)paren
(brace
r_int
r_int
id|cav
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
multiline_comment|/*&n;   Build config_address_value:&n;&n;      31        24 23        16 15      11 10  8 7        0 &n;      ------------------------------------------------------&n;      |1| 0000000 | bus_number | device # | 000 | register |&n;      ------------------------------------------------------&n;*/
id|cav
op_assign
id|r_number
op_amp
l_int|0xff
suffix:semicolon
id|cav
op_or_assign
(paren
(paren
id|device_num
op_amp
l_int|0x1f
)paren
op_lshift
l_int|11
)paren
suffix:semicolon
id|cav
op_or_assign
(paren
(paren
id|bus_number
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|cav
op_or_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* Enable bit */
id|outpd
c_func
(paren
id|CONFIG_ADDRESS
comma
id|cav
)paren
suffix:semicolon
id|val
op_assign
id|inpd
c_func
(paren
id|CONFIG_DATA
)paren
suffix:semicolon
id|outpd
c_func
(paren
id|CONFIG_ADDRESS
comma
l_int|0
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
id|write_config
c_func
(paren
id|bus_number
comma
id|device_num
comma
id|r_number
comma
id|val
)paren
(brace
r_int
r_int
id|cav
suffix:semicolon
multiline_comment|/*&n;   Build config_address_value:&n;&n;      31        24 23        16 15      11 10  8 7        0 &n;      ------------------------------------------------------&n;      |1| 0000000 | bus_number | device # | 000 | register |&n;      ------------------------------------------------------&n;*/
id|cav
op_assign
id|r_number
op_amp
l_int|0xff
suffix:semicolon
id|cav
op_or_assign
(paren
(paren
id|device_num
op_amp
l_int|0x1f
)paren
op_lshift
l_int|11
)paren
suffix:semicolon
id|cav
op_or_assign
(paren
(paren
id|bus_number
op_amp
l_int|0xff
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|cav
op_or_assign
l_int|0x80000000
suffix:semicolon
multiline_comment|/* Enable bit */
id|outpd
c_func
(paren
id|CONFIG_ADDRESS
comma
id|cav
)paren
suffix:semicolon
id|outpd
c_func
(paren
id|CONFIG_DATA
comma
id|val
)paren
suffix:semicolon
id|outpd
c_func
(paren
id|CONFIG_ADDRESS
comma
l_int|0
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* XXX Implement these... */
r_static
r_int
id|read_config
c_func
(paren
r_int
id|bus_number
comma
r_int
id|device_num
comma
r_int
id|r_number
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|write_config
c_func
(paren
r_int
id|bus_number
comma
r_int
id|device_num
comma
r_int
id|r_number
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_int
id|RIOPCIinit
c_func
(paren
id|p
comma
id|Mode
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_int
id|Mode
suffix:semicolon
(brace
mdefine_line|#define MAX_PCI_SLOT&t;&t;32
mdefine_line|#define RIO_PCI_JET_CARD&t;0x200011CB
r_static
r_int
id|slot
suffix:semicolon
multiline_comment|/* count of machine&squot;s PCI slots searched so far */
id|caddr_t
id|Caddr
suffix:semicolon
multiline_comment|/* Virtual address of the current PCI host card. */
r_int
r_char
id|Ivec
suffix:semicolon
multiline_comment|/* interrupt vector for the current PCI host */
r_int
r_int
id|Paddr
suffix:semicolon
multiline_comment|/* Physical address for the current PCI host */
r_int
id|Handle
suffix:semicolon
multiline_comment|/* Handle to Virtual memory allocated for current PCI host */
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Search for a RIO PCI card - start at slot %d&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Initialise the search status&n;&t;*/
id|p-&gt;RIOLastPCISearch
op_assign
id|RIO_FAIL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|slot
OL
id|MAX_PCI_SLOT
)paren
op_amp
(paren
id|p-&gt;RIOLastPCISearch
op_ne
id|RIO_SUCCESS
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Currently testing slot %d&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_config
c_func
(paren
l_int|0
comma
id|slot
comma
l_int|0
)paren
op_eq
id|RIO_PCI_JET_CARD
)paren
(brace
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Ivec
op_assign
l_int|0
suffix:semicolon
id|Paddr
op_assign
id|read_config
c_func
(paren
l_int|0
comma
id|slot
comma
l_int|0x18
)paren
suffix:semicolon
id|Paddr
op_assign
id|Paddr
op_minus
(paren
id|Paddr
op_amp
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* Mask off the io bit */
r_if
c_cond
(paren
(paren
id|Paddr
op_eq
l_int|0
)paren
op_logical_or
(paren
(paren
id|Paddr
op_amp
l_int|0xffff0000
)paren
op_eq
l_int|0xffff0000
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Goofed up slot&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* what! */
id|slot
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|PaddrP
op_assign
id|Paddr
suffix:semicolon
id|Ivec
op_assign
(paren
id|read_config
c_func
(paren
l_int|0
comma
id|slot
comma
l_int|0x3c
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;PCI Host at 0x%x, Intr %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|Paddr
comma
id|Ivec
)paren
suffix:semicolon
id|Handle
op_assign
id|RIOMapin
c_func
(paren
id|Paddr
comma
id|RIO_PCI_MEM_SIZE
comma
op_amp
id|Caddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|Handle
op_eq
op_minus
l_int|1
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Couldn&squot;t map %d bytes at 0x%x&bslash;n&quot;
comma
id|RIO_PCI_MEM_SIZE
comma
(paren
r_int
)paren
id|Paddr
)paren
suffix:semicolon
id|slot
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Ivec
op_assign
id|Ivec
op_plus
l_int|32
suffix:semicolon
id|p-&gt;intr_tid
op_assign
id|iointset
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Ivec
comma
(paren
r_int
(paren
op_star
)paren
(paren
)paren
)paren
id|rio_intr
comma
(paren
r_char
op_star
)paren
id|p-&gt;RIONumHosts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIOBoardTest
c_func
(paren
id|Paddr
comma
id|Caddr
comma
id|RIO_PCI
comma
l_int|0
)paren
op_eq
id|RIO_SUCCESS
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
(paren
l_string|&quot;Board has passed test&bslash;n&quot;
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
(paren
l_string|&quot;Paddr 0x%x. Caddr 0x%x. Mode 0x%x.&bslash;n&quot;
comma
id|Paddr
comma
id|Caddr
comma
id|Mode
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;** Board has passed its scrub test. Fill in all the&n;&t;&t;&t;&t;** transient stuff.&n;&t;&t;&t;&t;*/
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Slot
op_assign
l_int|0
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Ivec
op_assign
id|Ivec
op_plus
l_int|32
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Type
op_assign
id|RIO_PCI
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Copy
op_assign
id|rio_pcicopy
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|PaddrP
op_assign
id|Paddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Caddr
op_assign
id|Caddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|CardP
op_assign
(paren
r_struct
id|DpRam
op_star
)paren
id|Caddr
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Mode
op_assign
id|Mode
suffix:semicolon
macro_line|#if 0
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Control
comma
id|BOOT_FROM_RAM
op_or
id|EXTERNAL_BUS_OFF
op_or
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Mode
op_or
id|INTERRUPT_DISABLE
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|ResetInt
comma
l_int|0xff
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Control
comma
id|BOOT_FROM_RAM
op_or
id|EXTERNAL_BUS_OFF
op_or
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Mode
op_or
id|INTERRUPT_DISABLE
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|ResetInt
comma
l_int|0xff
)paren
suffix:semicolon
macro_line|#else
id|WBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|ResetInt
comma
l_int|0xff
)paren
suffix:semicolon
macro_line|#endif
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|UniqueNum
op_assign
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Unique
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|0
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Unique
(braket
l_int|1
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Unique
(braket
l_int|2
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|RBYTE
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|Unique
(braket
l_int|3
)braket
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Unique no 0x%x.&bslash;n&quot;
comma
id|p-&gt;RIOHosts
(braket
id|p-&gt;RIONumHosts
)braket
dot
id|UniqueNum
)paren
suffix:semicolon
id|p-&gt;RIOLastPCISearch
op_assign
id|RIO_SUCCESS
suffix:semicolon
id|p-&gt;RIONumHosts
op_increment
suffix:semicolon
)brace
)brace
id|slot
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slot
op_ge
id|MAX_PCI_SLOT
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;All %d PCI slots have tested for RIO cards !!!&bslash;n&quot;
comma
id|MAX_PCI_SLOT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** I don&squot;t think we want to do this anymore&n;&t;**&n;&n;&t;if (!p-&gt;RIOLastPCISearch == RIO_FAIL ) {&n;&t;&t;p-&gt;RIOFailed++;&n;&t;}&n;&n;&t;**&n;&t;*/
)brace
macro_line|#ifdef FUTURE_RELEASE
r_void
id|riohalt
c_func
(paren
r_void
)paren
(brace
r_int
id|host
suffix:semicolon
r_for
c_loop
(paren
id|host
op_assign
l_int|0
suffix:semicolon
id|host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|host
op_increment
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Stop host %d&bslash;n&quot;
comma
id|host
)paren
suffix:semicolon
(paren
r_void
)paren
id|RIOBoardTest
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|PaddrP
comma
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Caddr
comma
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Type
comma
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Slot
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#endif
DECL|variable|val
r_static
id|uchar
id|val
(braket
)braket
op_assign
(brace
macro_line|#ifdef VERY_LONG_TEST
l_int|0x00
comma
l_int|0x01
comma
l_int|0x02
comma
l_int|0x04
comma
l_int|0x08
comma
l_int|0x10
comma
l_int|0x20
comma
l_int|0x40
comma
l_int|0x80
comma
l_int|0xa5
comma
l_int|0xff
comma
l_int|0x5a
comma
l_int|0x00
comma
l_int|0xff
comma
l_int|0xc9
comma
l_int|0x36
comma
macro_line|#endif
l_int|0xff
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|macro|TEST_END
mdefine_line|#define&t;TEST_END sizeof(val)
multiline_comment|/*&n;** RAM test a board. &n;** Nothing too complicated, just enough to check it out.&n;*/
r_int
DECL|function|RIOBoardTest
id|RIOBoardTest
c_func
(paren
id|paddr
comma
id|caddr
comma
id|type
comma
id|slot
)paren
id|paddr_t
id|paddr
suffix:semicolon
id|caddr_t
id|caddr
suffix:semicolon
id|uchar
id|type
suffix:semicolon
r_int
id|slot
suffix:semicolon
(brace
r_struct
id|DpRam
op_star
id|DpRam
op_assign
(paren
r_struct
id|DpRam
op_star
)paren
id|caddr
suffix:semicolon
r_char
op_star
id|ram
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|size
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|op
comma
id|bank
suffix:semicolon
r_int
id|nbanks
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Reset host type=%d, DpRam=0x%x, slot=%d&bslash;n&quot;
comma
id|type
comma
(paren
r_int
)paren
id|DpRam
comma
id|slot
)paren
suffix:semicolon
id|RIOHostReset
c_func
(paren
id|type
comma
id|DpRam
comma
id|slot
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Scrub the memory. This comes in several banks:&n;&t;** DPsram1&t;- 7000h bytes&n;&t;** DPsram2&t;- 200h  bytes&n;&t;** DPsram3&t;- 7000h bytes&n;&t;** scratch&t;- 1000h bytes&n;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Setup ram/size arrays&bslash;n&quot;
)paren
suffix:semicolon
id|size
(braket
l_int|0
)braket
op_assign
id|DP_SRAM1_SIZE
suffix:semicolon
id|size
(braket
l_int|1
)braket
op_assign
id|DP_SRAM2_SIZE
suffix:semicolon
id|size
(braket
l_int|2
)braket
op_assign
id|DP_SRAM3_SIZE
suffix:semicolon
id|size
(braket
l_int|3
)braket
op_assign
id|DP_SCRATCH_SIZE
suffix:semicolon
id|ram
(braket
l_int|0
)braket
op_assign
(paren
r_char
op_star
)paren
op_amp
id|DpRam-&gt;DpSram1
(braket
l_int|0
)braket
suffix:semicolon
id|ram
(braket
l_int|1
)braket
op_assign
(paren
r_char
op_star
)paren
op_amp
id|DpRam-&gt;DpSram2
(braket
l_int|0
)braket
suffix:semicolon
id|ram
(braket
l_int|2
)braket
op_assign
(paren
r_char
op_star
)paren
op_amp
id|DpRam-&gt;DpSram3
(braket
l_int|0
)braket
suffix:semicolon
id|nbanks
op_assign
(paren
id|type
op_eq
id|RIO_PCI
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|nbanks
op_eq
l_int|4
)paren
id|ram
(braket
l_int|3
)braket
op_assign
(paren
r_char
op_star
)paren
op_amp
id|DpRam-&gt;DpScratch
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|nbanks
op_eq
l_int|3
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Memory: 0x%x(0x%x), 0x%x(0x%x), 0x%x(0x%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|ram
(braket
l_int|0
)braket
comma
id|size
(braket
l_int|0
)braket
comma
(paren
r_int
)paren
id|ram
(braket
l_int|1
)braket
comma
id|size
(braket
l_int|1
)braket
comma
(paren
r_int
)paren
id|ram
(braket
l_int|2
)braket
comma
id|size
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: 0x%x(0x%x), 0x%x(0x%x), 0x%x(0x%x), 0x%x(0x%x)&bslash;n&quot;
comma
(paren
r_int
)paren
id|ram
(braket
l_int|0
)braket
comma
id|size
(braket
l_int|0
)braket
comma
(paren
r_int
)paren
id|ram
(braket
l_int|1
)braket
comma
id|size
(braket
l_int|1
)braket
comma
(paren
r_int
)paren
id|ram
(braket
l_int|2
)braket
comma
id|size
(braket
l_int|2
)braket
comma
(paren
r_int
)paren
id|ram
(braket
l_int|3
)braket
comma
id|size
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** This scrub operation will test for crosstalk between&n;&t;** banks. TEST_END is a magic number, and relates to the offset&n;&t;** within the &squot;val&squot; array used by Scrub.&n;&t;*/
r_for
c_loop
(paren
id|op
op_assign
l_int|0
suffix:semicolon
id|op
OL
id|TEST_END
suffix:semicolon
id|op
op_increment
)paren
(brace
r_for
c_loop
(paren
id|bank
op_assign
l_int|0
suffix:semicolon
id|bank
OL
id|nbanks
suffix:semicolon
id|bank
op_increment
)paren
(brace
r_if
c_cond
(paren
id|RIOScrub
c_func
(paren
id|op
comma
(paren
id|BYTE
op_star
)paren
id|ram
(braket
id|bank
)braket
comma
id|size
(braket
id|bank
)braket
)paren
op_eq
id|RIO_FAIL
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: RIOScrub band %d, op %d failed&bslash;n&quot;
comma
id|bank
comma
id|op
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
)brace
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;Test completed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RIO_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n;** Scrub an area of RAM.&n;** Define PRETEST and POSTTEST for a more thorough checking of the&n;** state of the memory.&n;** Call with op set to an index into the above &squot;val&squot; array to determine&n;** which value will be written into memory.&n;** Call with op set to zero means that the RAM will not be read and checked&n;** before it is written.&n;** Call with op not zero, and the RAM will be read and compated with val[op-1]&n;** to check that the data from the previous phase was retained.&n;*/
r_int
DECL|function|RIOScrub
id|RIOScrub
c_func
(paren
id|op
comma
id|ram
comma
id|size
)paren
r_int
id|op
suffix:semicolon
id|BYTE
op_star
id|ram
suffix:semicolon
r_int
id|size
suffix:semicolon
(brace
r_int
id|off
suffix:semicolon
r_int
r_char
id|oldbyte
suffix:semicolon
r_int
r_char
id|newbyte
suffix:semicolon
r_int
r_char
id|invbyte
suffix:semicolon
r_int
r_int
id|oldword
suffix:semicolon
r_int
r_int
id|newword
suffix:semicolon
r_int
r_int
id|invword
suffix:semicolon
r_int
r_int
id|swapword
suffix:semicolon
r_if
c_cond
(paren
id|op
)paren
(brace
id|oldbyte
op_assign
id|val
(braket
id|op
op_minus
l_int|1
)braket
suffix:semicolon
id|oldword
op_assign
id|oldbyte
op_or
(paren
id|oldbyte
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
id|oldbyte
op_assign
id|oldword
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Tell the compiler we&squot;ve initilalized them. */
id|newbyte
op_assign
id|val
(braket
id|op
)braket
suffix:semicolon
id|newword
op_assign
id|newbyte
op_or
(paren
id|newbyte
op_lshift
l_int|8
)paren
suffix:semicolon
id|invbyte
op_assign
op_complement
id|newbyte
suffix:semicolon
id|invword
op_assign
id|invbyte
op_or
(paren
id|invbyte
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Check that the RAM contains the value that should have been left there&n;&t;** by the previous test (not applicable for pass zero)&n;&t;*/
r_if
c_cond
(paren
id|op
)paren
(brace
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|size
suffix:semicolon
id|off
op_increment
)paren
(brace
r_if
c_cond
(paren
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
op_ne
id|oldbyte
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Byte Pre Check 1: BYTE at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|oldbyte
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|size
suffix:semicolon
id|off
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
op_ne
id|oldword
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Word Pre Check: WORD at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|oldword
comma
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Word Pre Check: BYTE at offset 0x%x is %x BYTE at offset 0x%x is %x&bslash;n&quot;
comma
id|off
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
comma
id|off
op_plus
l_int|1
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t;** Now write the INVERSE of the test data into every location, using&n;&t;** BYTE write operations, first checking before each byte is written&n;&t;** that the location contains the old value still, and checking after&n;&t;** the write that the location contains the data specified - this is&n;&t;** the BYTE read/write test.&n;&t;*/
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|size
suffix:semicolon
id|off
op_increment
)paren
(brace
r_if
c_cond
(paren
id|op
op_logical_and
(paren
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
op_ne
id|oldbyte
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Byte Pre Check 2: BYTE at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|oldbyte
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
id|WBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
comma
id|invbyte
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
op_ne
id|invbyte
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Byte Inv Check: BYTE at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|invbyte
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;** now, use WORD operations to write the test value into every location,&n;&t;** check as before that the location contains the previous test value&n;&t;** before overwriting, and that it contains the data value written&n;&t;** afterwards.&n;&t;** This is the WORD operation test.&n;&t;*/
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|size
suffix:semicolon
id|off
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
op_ne
id|invword
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Word Inv Check: WORD at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|invword
comma
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Word Inv Check: BYTE at offset 0x%x is %x BYTE at offset 0x%x is %x&bslash;n&quot;
comma
id|off
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
comma
id|off
op_plus
l_int|1
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
op_assign
id|newword
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
op_ne
id|newword
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Post Word Check 1: WORD at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|newword
comma
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Post Word Check 1: BYTE at offset 0x%x is %x BYTE at offset 0x%x is %x&bslash;n&quot;
comma
id|off
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
comma
id|off
op_plus
l_int|1
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;** now run through the block of memory again, first in byte mode&n;&t;** then in word mode, and check that all the locations contain the&n;&t;** required test data.&n;&t;*/
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|size
suffix:semicolon
id|off
op_increment
)paren
(brace
r_if
c_cond
(paren
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
op_ne
id|newbyte
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Post Byte Check: BYTE at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|newbyte
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|size
suffix:semicolon
id|off
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
op_ne
id|newword
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Post Word Check 2: WORD at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|newword
comma
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: Post Word Check 2: BYTE at offset 0x%x is %x BYTE at offset 0x%x is %x&bslash;n&quot;
comma
id|off
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
comma
id|off
op_plus
l_int|1
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;** time to check out byte swapping errors&n;&t;*/
id|swapword
op_assign
id|invbyte
op_or
(paren
id|newbyte
op_lshift
l_int|8
)paren
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|size
suffix:semicolon
id|off
op_add_assign
l_int|2
)paren
(brace
id|WBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
comma
id|invbyte
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|ram
(braket
id|off
op_plus
l_int|1
)braket
comma
id|newbyte
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|size
suffix:semicolon
id|off
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
op_ne
id|swapword
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: SwapWord Check 1: WORD at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|swapword
comma
op_star
(paren
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
)paren
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: SwapWord Check 1: BYTE at offset 0x%x is %x BYTE at offset 0x%x is %x&bslash;n&quot;
comma
id|off
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
comma
id|off
op_plus
l_int|1
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
)paren
op_assign
op_complement
id|swapword
suffix:semicolon
)brace
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|size
suffix:semicolon
id|off
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
op_ne
id|newbyte
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: SwapWord Check 2: BYTE at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
comma
id|newbyte
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
op_plus
l_int|1
)braket
)paren
op_ne
id|invbyte
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: SwapWord Check 2: BYTE at offset 0x%x should have been=%x, was=%x&bslash;n&quot;
comma
id|off
op_plus
l_int|1
comma
id|invbyte
comma
id|RBYTE
c_func
(paren
id|ram
(braket
id|off
op_plus
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
op_star
(paren
(paren
id|ushort
op_star
)paren
op_amp
id|ram
(braket
id|off
)braket
)paren
op_assign
id|newword
suffix:semicolon
)brace
r_return
id|RIO_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n;** try to ensure that every host is either in polled mode&n;** or is in interrupt mode. Only allow interrupt mode if&n;** all hosts can interrupt (why?)&n;** and force into polled mode if told to. Patch up the&n;** interrupt vector &amp; salute The Queen when you&squot;ve done.&n;*/
r_void
DECL|function|RIOAllocateInterrupts
id|RIOAllocateInterrupts
c_func
(paren
id|p
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
(brace
r_int
id|Host
suffix:semicolon
multiline_comment|/*&n;&t;** Easy case - if we have been told to poll, then we poll.&n;&t;*/
r_if
c_cond
(paren
id|p-&gt;mode
op_amp
id|POLLED_MODE
)paren
(brace
id|RIOStopInterrupts
c_func
(paren
id|p
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** check - if any host has been set to polled mode, then all must be.&n;&t;*/
r_for
c_loop
(paren
id|Host
op_assign
l_int|0
suffix:semicolon
id|Host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|Host
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Type
op_ne
id|RIO_AT
)paren
op_logical_and
(paren
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Ivec
op_eq
id|POLLED
)paren
)paren
(brace
id|RIOStopInterrupts
c_func
(paren
id|p
comma
l_int|1
comma
id|Host
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|Host
op_assign
l_int|0
suffix:semicolon
id|Host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|Host
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Type
op_eq
id|RIO_AT
)paren
(brace
r_if
c_cond
(paren
(paren
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Ivec
op_minus
l_int|32
)paren
op_eq
l_int|0
)paren
(brace
id|RIOStopInterrupts
c_func
(paren
id|p
comma
l_int|2
comma
id|Host
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*&n;** something has decided that we can&squot;t be doing with these&n;** new-fangled interrupt thingies. Set everything up to just&n;** poll.&n;*/
r_void
DECL|function|RIOStopInterrupts
id|RIOStopInterrupts
c_func
(paren
id|p
comma
id|Reason
comma
id|Host
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_int
id|Reason
suffix:semicolon
r_int
id|Host
suffix:semicolon
(brace
macro_line|#ifdef FUTURE_RELEASE
r_switch
c_cond
(paren
id|Reason
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* forced into polling by rio_polled */
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* SCU has set &squot;Host&squot; into polled mode */
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* there aren&squot;t enough interrupt vectors for &squot;Host&squot; */
r_break
suffix:semicolon
)brace
macro_line|#endif
r_for
c_loop
(paren
id|Host
op_assign
l_int|0
suffix:semicolon
id|Host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|Host
op_increment
)paren
(brace
r_struct
id|Host
op_star
id|HostP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|Host
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|HostP-&gt;Type
)paren
(brace
r_case
id|RIO_AT
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t;** The AT host has it&squot;s interrupts disabled by clearing the&n;&t;&t;&t;&t;** int_enable bit.&n;&t;&t;&t;&t;*/
id|HostP-&gt;Mode
op_and_assign
op_complement
id|INTERRUPT_ENABLE
suffix:semicolon
id|HostP-&gt;Ivec
op_assign
id|POLLED
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef FUTURE_RELEASE
r_case
id|RIO_EISA
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t;** The EISA host has it&squot;s interrupts disabled by setting the&n;&t;&t;&t;&t;** Ivec to zero&n;&t;&t;&t;&t;*/
id|HostP-&gt;Ivec
op_assign
id|POLLED
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|RIO_PCI
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t;** The PCI host has it&squot;s interrupts disabled by clearing the&n;&t;&t;&t;&t;** int_enable bit, like a regular host card.&n;&t;&t;&t;&t;*/
id|HostP-&gt;Mode
op_and_assign
op_complement
id|RIO_PCI_INT_ENABLE
suffix:semicolon
id|HostP-&gt;Ivec
op_assign
id|POLLED
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef FUTURE_RELEASE
r_case
id|RIO_MCA
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t;** There&squot;s always one, isn&squot;t there?&n;&t;&t;&t;&t;** The MCA host card cannot have it&squot;s interrupts disabled.&n;&t;&t;&t;&t;*/
id|RIOPatchVec
c_func
(paren
id|HostP
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
)brace
)brace
macro_line|#if 0
multiline_comment|/*&n;** This function is called at init time to setup the data structures.&n;*/
r_void
id|RIOAllocDataStructs
c_func
(paren
id|p
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
(brace
r_int
id|port
comma
id|host
comma
id|tm
suffix:semicolon
id|p-&gt;RIOPortp
op_assign
(paren
r_struct
id|Port
op_star
)paren
id|sysbrk
c_func
(paren
id|RIO_PORTS
op_star
r_sizeof
(paren
r_struct
id|Port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;RIOPortp
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: No memory for port structures&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOFailed
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bzero
c_func
(paren
id|p-&gt;RIOPortp
comma
r_sizeof
(paren
r_struct
id|Port
)paren
op_star
id|RIO_PORTS
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: allocated and cleared memory for port structs&bslash;n&quot;
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;First RIO port struct @0x%x, size=0x%x bytes&bslash;n&quot;
comma
(paren
r_int
)paren
id|p-&gt;RIOPortp
comma
r_sizeof
(paren
r_struct
id|Port
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
id|RIO_PORTS
suffix:semicolon
id|port
op_increment
)paren
(brace
id|p-&gt;RIOPortp
(braket
id|port
)braket
dot
id|PortNum
op_assign
id|port
suffix:semicolon
id|p-&gt;RIOPortp
(braket
id|port
)braket
dot
id|TtyP
op_assign
op_amp
id|p-&gt;channel
(braket
id|port
)braket
suffix:semicolon
id|sreset
(paren
id|p-&gt;RIOPortp
(braket
id|port
)braket
dot
id|InUse
)paren
suffix:semicolon
multiline_comment|/* Let the first guy uses it */
id|p-&gt;RIOPortp
(braket
id|port
)braket
dot
id|portSem
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Let the first guy takes it */
id|p-&gt;RIOPortp
(braket
id|port
)braket
dot
id|ParamSem
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Let the first guy takes it */
id|p-&gt;RIOPortp
(braket
id|port
)braket
dot
id|timeout_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Let the first guy takes it */
)brace
id|p-&gt;RIOHosts
op_assign
(paren
r_struct
id|Host
op_star
)paren
id|sysbrk
c_func
(paren
id|RIO_HOSTS
op_star
r_sizeof
(paren
r_struct
id|Host
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;RIOHosts
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: No memory for host structures&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOFailed
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bzero
c_func
(paren
id|p-&gt;RIOHosts
comma
r_sizeof
(paren
r_struct
id|Host
)paren
op_star
id|RIO_HOSTS
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO-init: allocated and cleared memory for host structs&bslash;n&quot;
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;First RIO host struct @0x%x, size=0x%x bytes&bslash;n&quot;
comma
(paren
r_int
)paren
id|p-&gt;RIOHosts
comma
r_sizeof
(paren
r_struct
id|Host
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|host
op_assign
l_int|0
suffix:semicolon
id|host
OL
id|RIO_HOSTS
suffix:semicolon
id|host
op_increment
)paren
(brace
id|spin_lock_init
(paren
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|HostLock
)paren
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|timeout_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Let the first guy takes it */
)brace
multiline_comment|/*&n;&t;** check that the buffer size is valid, round down to the next power of&n;&t;** two if necessary; if the result is zero, then, hey, no double buffers.&n;&t;*/
r_for
c_loop
(paren
id|tm
op_assign
l_int|1
suffix:semicolon
id|tm
op_logical_and
id|tm
op_le
id|p-&gt;RIOConf.BufferSize
suffix:semicolon
id|tm
op_lshift_assign
l_int|1
)paren
suffix:semicolon
id|tm
op_rshift_assign
l_int|1
suffix:semicolon
id|p-&gt;RIOBufferSize
op_assign
id|tm
suffix:semicolon
id|p-&gt;RIOBufferMask
op_assign
id|tm
ques
c_cond
id|tm
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** this function gets called whenever the data structures need to be&n;** re-setup, for example, after a riohalt (why did I ever invent it?)&n;*/
r_void
id|RIOSetupDataStructs
c_func
(paren
id|p
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
(brace
r_int
id|host
comma
id|entry
comma
id|rup
suffix:semicolon
r_for
c_loop
(paren
id|host
op_assign
l_int|0
suffix:semicolon
id|host
OL
id|RIO_HOSTS
suffix:semicolon
id|host
op_increment
)paren
(brace
r_struct
id|Host
op_star
id|HostP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|LINKS_PER_UNIT
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|HostP-&gt;Topology
(braket
id|entry
)braket
dot
id|Unit
op_assign
id|ROUTE_DISCONNECT
suffix:semicolon
id|HostP-&gt;Topology
(braket
id|entry
)braket
dot
id|Link
op_assign
id|NO_LINK
suffix:semicolon
)brace
id|bcopy
c_func
(paren
l_string|&quot;HOST X&quot;
comma
id|HostP-&gt;Name
comma
l_int|7
)paren
suffix:semicolon
id|HostP-&gt;Name
(braket
l_int|5
)braket
op_assign
l_char|&squot;1&squot;
op_plus
id|host
suffix:semicolon
r_for
c_loop
(paren
id|rup
op_assign
l_int|0
suffix:semicolon
id|rup
OL
(paren
id|MAX_RUP
op_plus
id|LINKS_PER_UNIT
)paren
suffix:semicolon
id|rup
op_increment
)paren
(brace
r_if
c_cond
(paren
id|rup
OL
id|MAX_RUP
)paren
(brace
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|LINKS_PER_UNIT
suffix:semicolon
id|entry
op_increment
)paren
(brace
id|HostP-&gt;Mapping
(braket
id|rup
)braket
dot
id|Topology
(braket
id|entry
)braket
dot
id|Unit
op_assign
id|ROUTE_DISCONNECT
suffix:semicolon
id|HostP-&gt;Mapping
(braket
id|rup
)braket
dot
id|Topology
(braket
id|entry
)braket
dot
id|Link
op_assign
id|NO_LINK
suffix:semicolon
)brace
id|RIODefaultName
c_func
(paren
id|p
comma
id|HostP
comma
id|rup
)paren
suffix:semicolon
)brace
id|HostP-&gt;UnixRups
(braket
id|rup
)braket
dot
id|RupLock
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
r_int
DECL|function|RIODefaultName
id|RIODefaultName
c_func
(paren
id|p
comma
id|HostP
comma
id|UnitId
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_struct
id|Host
op_star
id|HostP
suffix:semicolon
id|uint
id|UnitId
suffix:semicolon
(brace
macro_line|#ifdef CHECK
id|CheckHost
c_func
(paren
id|Host
)paren
suffix:semicolon
id|CheckUnitId
c_func
(paren
id|UnitId
)paren
suffix:semicolon
macro_line|#endif
id|bcopy
c_func
(paren
l_string|&quot;UNKNOWN RTA X-XX&quot;
comma
id|HostP-&gt;Mapping
(braket
id|UnitId
)braket
dot
id|Name
comma
l_int|17
)paren
suffix:semicolon
id|HostP-&gt;Mapping
(braket
id|UnitId
)braket
dot
id|Name
(braket
l_int|12
)braket
op_assign
l_char|&squot;1&squot;
op_plus
(paren
id|HostP
op_minus
id|p-&gt;RIOHosts
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|UnitId
op_plus
l_int|1
)paren
OG
l_int|9
)paren
(brace
id|HostP-&gt;Mapping
(braket
id|UnitId
)braket
dot
id|Name
(braket
l_int|14
)braket
op_assign
l_char|&squot;0&squot;
op_plus
(paren
(paren
id|UnitId
op_plus
l_int|1
)paren
op_div
l_int|10
)paren
suffix:semicolon
id|HostP-&gt;Mapping
(braket
id|UnitId
)braket
dot
id|Name
(braket
l_int|15
)braket
op_assign
l_char|&squot;0&squot;
op_plus
(paren
(paren
id|UnitId
op_plus
l_int|1
)paren
op_mod
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
id|HostP-&gt;Mapping
(braket
id|UnitId
)braket
dot
id|Name
(braket
l_int|14
)braket
op_assign
l_char|&squot;1&squot;
op_plus
id|UnitId
suffix:semicolon
id|HostP-&gt;Mapping
(braket
id|UnitId
)braket
dot
id|Name
(braket
l_int|15
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|RIO_RELEASE
mdefine_line|#define RIO_RELEASE&t;&quot;Linux&quot;
DECL|macro|RELEASE_ID
mdefine_line|#define RELEASE_ID&t;&quot;1.0&quot;
r_int
DECL|function|RIOReport
id|RIOReport
c_func
(paren
id|p
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
(brace
r_char
op_star
id|RIORelease
op_assign
id|RIO_RELEASE
suffix:semicolon
r_char
op_star
id|RIORelID
op_assign
id|RELEASE_ID
suffix:semicolon
r_int
id|host
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIO : Release: %s ID: %s&bslash;n&quot;
comma
id|RIORelease
comma
id|RIORelID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;RIONumHosts
op_eq
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;&bslash;nNo Hosts configured&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|host
op_assign
l_int|0
suffix:semicolon
id|host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|host
op_increment
)paren
(brace
r_struct
id|Host
op_star
id|HostP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|HostP-&gt;Type
)paren
(brace
r_case
id|RIO_AT
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;AT BUS : found the card at 0x%x&bslash;n&quot;
comma
id|HostP-&gt;PaddrP
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** This function returns release/version information as used by ioctl() calls&n;** It returns a MAX_VERSION_LEN byte string, null terminated.&n;*/
r_char
op_star
DECL|function|OLD_RIOVersid
id|OLD_RIOVersid
c_func
(paren
r_void
)paren
(brace
r_static
r_char
id|Info
(braket
id|MAX_VERSION_LEN
)braket
suffix:semicolon
r_char
op_star
id|RIORelease
op_assign
id|RIO_RELEASE
suffix:semicolon
r_char
op_star
id|cp
suffix:semicolon
r_int
id|ct
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ct
op_assign
l_int|0
suffix:semicolon
id|RIORelease
(braket
id|ct
)braket
op_logical_and
id|ct
OL
id|MAX_VERSION_LEN
suffix:semicolon
id|ct
op_increment
)paren
id|Info
(braket
id|ct
)braket
op_assign
id|RIORelease
(braket
id|ct
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ct
op_ge
id|MAX_VERSION_LEN
)paren
(brace
id|Info
(braket
id|MAX_VERSION_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|Info
suffix:semicolon
)brace
id|Info
(braket
id|ct
op_increment
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
r_if
c_cond
(paren
id|ct
op_ge
id|MAX_VERSION_LEN
)paren
(brace
id|Info
(braket
id|MAX_VERSION_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|Info
suffix:semicolon
)brace
id|cp
op_assign
l_string|&quot;&quot;
suffix:semicolon
multiline_comment|/* Fill the RCS Id here */
r_while
c_loop
(paren
op_star
id|cp
op_logical_and
id|ct
OL
id|MAX_VERSION_LEN
)paren
id|Info
(braket
id|ct
op_increment
)braket
op_assign
op_star
id|cp
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ct
OL
id|MAX_VERSION_LEN
op_minus
l_int|1
)paren
id|Info
(braket
id|ct
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|Info
(braket
id|MAX_VERSION_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|Info
suffix:semicolon
)brace
DECL|variable|stVersion
r_static
r_struct
id|rioVersion
id|stVersion
suffix:semicolon
r_struct
id|rioVersion
op_star
DECL|function|RIOVersid
id|RIOVersid
c_func
(paren
r_void
)paren
(brace
id|strncpy
c_func
(paren
id|stVersion.version
comma
l_string|&quot;RIO driver for linux V1.0&quot;
comma
l_int|255
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|stVersion.buildDate
comma
id|__DATE__
comma
l_int|255
)paren
suffix:semicolon
r_return
op_amp
id|stVersion
suffix:semicolon
)brace
macro_line|#if 0
r_int
id|RIOMapin
c_func
(paren
id|paddr
comma
id|size
comma
id|vaddr
)paren
id|paddr_t
id|paddr
suffix:semicolon
r_int
id|size
suffix:semicolon
id|caddr_t
op_star
id|vaddr
suffix:semicolon
(brace
op_star
id|vaddr
op_assign
(paren
id|caddr_t
)paren
id|permap
c_func
(paren
(paren
r_int
)paren
id|paddr
comma
id|size
)paren
suffix:semicolon
r_return
(paren
(paren
r_int
)paren
op_star
id|vaddr
)paren
suffix:semicolon
)brace
r_void
id|RIOMapout
c_func
(paren
id|paddr
comma
id|size
comma
id|vaddr
)paren
id|paddr_t
id|paddr
suffix:semicolon
r_int
id|size
suffix:semicolon
id|caddr_t
id|vaddr
suffix:semicolon
(brace
)brace
macro_line|#endif
r_void
DECL|function|RIOHostReset
id|RIOHostReset
c_func
(paren
id|Type
comma
id|DpRamP
comma
id|Slot
)paren
id|uint
id|Type
suffix:semicolon
r_volatile
r_struct
id|DpRam
op_star
id|DpRamP
suffix:semicolon
id|uint
id|Slot
suffix:semicolon
(brace
multiline_comment|/*&n;&t;** Reset the Tpu&n;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIOHostReset: type 0x%x&quot;
comma
id|Type
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|Type
)paren
(brace
r_case
id|RIO_AT
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot; (RIO_AT)&bslash;n&quot;
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|DpRamP-&gt;DpControl
comma
id|BOOT_FROM_RAM
op_or
id|EXTERNAL_BUS_OFF
op_or
id|INTERRUPT_DISABLE
op_or
id|BYTE_OPERATION
op_or
id|SLOW_LINKS
op_or
id|SLOW_AT_BUS
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|DpRamP-&gt;DpResetTpu
comma
l_int|0xFF
)paren
suffix:semicolon
id|rio_udelay
(paren
l_int|3
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot;RIOHostReset: Don&squot;t know if it worked. Try reset again&bslash;n&quot;
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|DpRamP-&gt;DpControl
comma
id|BOOT_FROM_RAM
op_or
id|EXTERNAL_BUS_OFF
op_or
id|INTERRUPT_DISABLE
op_or
id|BYTE_OPERATION
op_or
id|SLOW_LINKS
op_or
id|SLOW_AT_BUS
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|DpRamP-&gt;DpResetTpu
comma
l_int|0xFF
)paren
suffix:semicolon
id|rio_udelay
(paren
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef FUTURE_RELEASE
r_case
id|RIO_EISA
suffix:colon
multiline_comment|/*&n;&t;** Bet this doesn&squot;t work!&n;&t;*/
id|OUTBZ
c_func
(paren
id|Slot
comma
id|EISA_CONTROL_PORT
comma
id|EISA_TP_RUN
op_or
id|EISA_TP_BUS_DISABLE
op_or
id|EISA_TP_SLOW_LINKS
op_or
id|EISA_TP_BOOT_FROM_RAM
)paren
suffix:semicolon
id|OUTBZ
c_func
(paren
id|Slot
comma
id|EISA_CONTROL_PORT
comma
id|EISA_TP_RESET
op_or
id|EISA_TP_BUS_DISABLE
op_or
id|EISA_TP_SLOW_LINKS
op_or
id|EISA_TP_BOOT_FROM_RAM
)paren
suffix:semicolon
id|suspend
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|OUTBZ
c_func
(paren
id|Slot
comma
id|EISA_CONTROL_PORT
comma
id|EISA_TP_RUN
op_or
id|EISA_TP_BUS_DISABLE
op_or
id|EISA_TP_SLOW_LINKS
op_or
id|EISA_TP_BOOT_FROM_RAM
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RIO_MCA
suffix:colon
id|WBYTE
c_func
(paren
id|DpRamP-&gt;DpControl
comma
id|McaTpBootFromRam
op_or
id|McaTpBusDisable
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|DpRamP-&gt;DpResetTpu
comma
l_int|0xFF
)paren
suffix:semicolon
id|suspend
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|DpRamP-&gt;DpControl
comma
id|McaTpBootFromRam
op_or
id|McaTpBusDisable
)paren
suffix:semicolon
id|WBYTE
c_func
(paren
id|DpRamP-&gt;DpResetTpu
comma
l_int|0xFF
)paren
suffix:semicolon
id|suspend
c_func
(paren
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|RIO_PCI
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot; (RIO_PCI)&bslash;n&quot;
)paren
suffix:semicolon
id|DpRamP-&gt;DpControl
op_assign
id|RIO_PCI_BOOT_FROM_RAM
suffix:semicolon
id|DpRamP-&gt;DpResetInt
op_assign
l_int|0xFF
suffix:semicolon
id|DpRamP-&gt;DpResetTpu
op_assign
l_int|0xFF
suffix:semicolon
id|rio_udelay
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* for (i=0; i&lt;6000; i++);  */
multiline_comment|/* suspend( 3 ); */
r_break
suffix:semicolon
macro_line|#ifdef FUTURE_RELEASE
r_default
suffix:colon
id|Rprintf
c_func
(paren
id|RIOMesgNoSupport
comma
id|Type
comma
id|DpRamP
comma
id|Slot
)paren
suffix:semicolon
r_return
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_INIT
comma
l_string|&quot; (UNKNOWN)&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
eof
