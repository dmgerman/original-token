multiline_comment|/*&n;** -----------------------------------------------------------------------------&n;**&n;**  Perle Specialix driver for Linux&n;**  Ported from existing RIO Driver for SCO sources.&n; *&n; *  (C) 1990 - 2000 Specialix International Ltd., Byfleet, Surrey, UK.&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *      This program is distributed in the hope that it will be useful,&n; *      but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *      GNU General Public License for more details.&n; *&n; *      You should have received a copy of the GNU General Public License&n; *      along with this program; if not, write to the Free Software&n; *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;**&n;**&t;Module&t;&t;: riotty.c&n;**&t;SID&t;&t;: 1.3&n;**&t;Last Modified&t;: 11/6/98 10:33:47&n;**&t;Retrieved&t;: 11/6/98 10:33:50&n;**&n;**  ident @(#)riotty.c&t;1.3&n;**&n;** -----------------------------------------------------------------------------&n;*/
macro_line|#ifdef SCCS_LABELS
DECL|variable|_riotty_c_sccs_
r_static
r_char
op_star
id|_riotty_c_sccs_
op_assign
l_string|&quot;@(#)riotty.c&t;1.3&quot;
suffix:semicolon
macro_line|#endif
DECL|macro|__EXPLICIT_DEF_H__
mdefine_line|#define __EXPLICIT_DEF_H__
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/string.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#include &lt;linux/generic_serial.h&gt;
macro_line|#include &quot;linux_compat.h&quot;
macro_line|#include &quot;rio_linux.h&quot;
macro_line|#include &quot;typdef.h&quot;
macro_line|#include &quot;pkt.h&quot;
macro_line|#include &quot;daemon.h&quot;
macro_line|#include &quot;rio.h&quot;
macro_line|#include &quot;riospace.h&quot;
macro_line|#include &quot;top.h&quot;
macro_line|#include &quot;cmdpkt.h&quot;
macro_line|#include &quot;map.h&quot;
macro_line|#include &quot;riotypes.h&quot;
macro_line|#include &quot;rup.h&quot;
macro_line|#include &quot;port.h&quot;
macro_line|#include &quot;riodrvr.h&quot;
macro_line|#include &quot;rioinfo.h&quot;
macro_line|#include &quot;func.h&quot;
macro_line|#include &quot;errors.h&quot;
macro_line|#include &quot;pci.h&quot;
macro_line|#include &quot;parmmap.h&quot;
macro_line|#include &quot;unixrup.h&quot;
macro_line|#include &quot;board.h&quot;
macro_line|#include &quot;host.h&quot;
macro_line|#include &quot;error.h&quot;
macro_line|#include &quot;phb.h&quot;
macro_line|#include &quot;link.h&quot;
macro_line|#include &quot;cmdblk.h&quot;
macro_line|#include &quot;route.h&quot;
macro_line|#include &quot;control.h&quot;
macro_line|#include &quot;cirrus.h&quot;
macro_line|#include &quot;rioioctl.h&quot;
macro_line|#include &quot;param.h&quot;
macro_line|#include &quot;list.h&quot;
macro_line|#include &quot;sam.h&quot;
macro_line|#if 0
r_static
r_void
id|ttyseth_pv
c_func
(paren
r_struct
id|Port
op_star
comma
r_struct
id|ttystatics
op_star
comma
r_struct
id|termios
op_star
id|sg
comma
r_int
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|RIOClearUp
c_func
(paren
r_struct
id|Port
op_star
id|PortP
)paren
suffix:semicolon
r_static
r_int
id|RIOShortCommand
c_func
(paren
r_struct
id|rio_info
op_star
id|p
comma
r_struct
id|Port
op_star
id|PortP
comma
r_int
id|command
comma
r_int
id|len
comma
r_int
id|arg
)paren
suffix:semicolon
r_extern
r_int
id|conv_vb
(braket
)braket
suffix:semicolon
multiline_comment|/* now defined in ttymgr.c */
r_extern
r_int
id|conv_bv
(braket
)braket
suffix:semicolon
multiline_comment|/* now defined in ttymgr.c */
multiline_comment|/*&n;** 16.09.1998 ARG - Fix to build riotty.k.o for Modular Kernel Support&n;**&n;** ep.def.h is necessary for Modular Kernel Support&n;** DO NOT place any kernel &squot;extern&squot;s after this line&n;** or this source file will not build riotty.k.o&n;*/
macro_line|#ifdef uLYNX
macro_line|#include &lt;ep.def.h&gt;
macro_line|#endif
macro_line|#ifdef NEED_THIS2
r_static
r_struct
id|old_sgttyb
DECL|variable|default_sg
id|default_sg
op_assign
(brace
id|B19200
comma
id|B19200
comma
multiline_comment|/* input and output speed */
l_char|&squot;H&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* erase char */
op_minus
l_int|1
comma
multiline_comment|/* 2nd erase char */
l_char|&squot;U&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* kill char */
id|ECHO
op_or
id|CRMOD
comma
multiline_comment|/* mode */
l_char|&squot;C&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* interrupt character */
l_char|&squot;&bslash;&bslash;&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* quit char */
l_char|&squot;Q&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* start char */
l_char|&squot;S&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* stop char */
l_char|&squot;D&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* EOF */
op_minus
l_int|1
comma
multiline_comment|/* brk */
(paren
id|LCRTBS
op_or
id|LCRTERA
op_or
id|LCRTKIL
op_or
id|LCTLECH
)paren
comma
multiline_comment|/* local mode word */
l_char|&squot;Z&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* process stop */
l_char|&squot;Y&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* delayed stop */
l_char|&squot;R&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* reprint line */
l_char|&squot;O&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* flush output */
l_char|&squot;W&squot;
op_minus
l_char|&squot;@&squot;
comma
multiline_comment|/* word erase */
l_char|&squot;V&squot;
op_minus
l_char|&squot;@&squot;
multiline_comment|/* literal next char */
)brace
suffix:semicolon
macro_line|#endif
r_extern
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_extern
r_void
id|rio_inc_mod_count
(paren
r_void
)paren
suffix:semicolon
r_int
DECL|function|riotopen
id|riotopen
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_register
id|uint
id|SysPort
suffix:semicolon
r_int
id|Modem
suffix:semicolon
r_int
id|repeat_this
op_assign
l_int|250
suffix:semicolon
r_struct
id|Port
op_star
id|PortP
suffix:semicolon
multiline_comment|/* pointer to the port structure */
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|func_enter
(paren
)paren
suffix:semicolon
multiline_comment|/* Make sure driver_data is NULL in case the rio isn&squot;t booted jet. Else gs_close&n;&t;   is going to oops.&n;&t;*/
id|tty-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
id|SysPort
op_assign
id|rio_minor
(paren
id|tty-&gt;device
)paren
suffix:semicolon
id|Modem
op_assign
id|rio_ismodem
(paren
id|tty-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;RIOFailed
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;System initialisation failed&bslash;n&quot;
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|ENXIO
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;port open SysPort %d (%s) (mapped:%d)&bslash;n&quot;
comma
id|SysPort
comma
id|Modem
ques
c_cond
l_string|&quot;Modem&quot;
suffix:colon
l_string|&quot;tty&quot;
comma
id|p-&gt;RIOPortp
(braket
id|SysPort
)braket
op_member_access_from_pointer
id|Mapped
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Validate that we have received a legitimate request.&n;&t;** Currently, just check that we are opening a port on&n;&t;** a host card that actually exists, and that the port&n;&t;** has been mapped onto a host.&n;&t;*/
r_if
c_cond
(paren
id|SysPort
op_ge
id|RIO_PORTS
)paren
(brace
multiline_comment|/* out of range ? */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Illegal port number %d&bslash;n&quot;
comma
id|SysPort
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|ENXIO
)paren
suffix:semicolon
id|func_exit
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** Grab pointer to the port stucture&n;&t;*/
id|PortP
op_assign
id|p-&gt;RIOPortp
(braket
id|SysPort
)braket
suffix:semicolon
multiline_comment|/* Get control struc */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;PortP: %p&bslash;n&quot;
comma
id|PortP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PortP-&gt;Mapped
)paren
(brace
multiline_comment|/* we aren&squot;t mapped yet! */
multiline_comment|/*&n;&t;&t;** The system doesn&squot;t know which RTA this port&n;&t;&t;** corresponds to.&n;&t;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;port not mapped into system&bslash;n&quot;
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|ENXIO
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|tty-&gt;driver_data
op_assign
id|PortP
suffix:semicolon
id|PortP-&gt;gs.tty
op_assign
id|tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PortP-&gt;gs.count
)paren
id|rio_inc_mod_count
(paren
)paren
suffix:semicolon
id|PortP-&gt;gs.count
op_increment
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;%d bytes in tx buffer&bslash;n&quot;
comma
id|PortP-&gt;gs.xmit_cnt
)paren
suffix:semicolon
id|retval
op_assign
id|gs_init_port
(paren
op_amp
id|PortP-&gt;gs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|PortP-&gt;gs.count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|PortP-&gt;gs.count
)paren
id|rio_dec_mod_count
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** If the host hasn&squot;t been booted yet, then &n;&t;** fail&n;&t;*/
r_if
c_cond
(paren
(paren
id|PortP-&gt;HostP-&gt;Flags
op_amp
id|RUN_STATE
)paren
op_ne
id|RC_RUNNING
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Host not running&bslash;n&quot;
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|ENXIO
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** If the RTA has not booted yet and the user has choosen to block&n;&t;** until the RTA is present then we must spin here waiting for&n;&t;** the RTA to boot.&n;&t;*/
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
(paren
id|PortP-&gt;HostP-&gt;Mapping
(braket
id|PortP-&gt;RupNum
)braket
dot
id|Flags
op_amp
id|RTA_BOOTED
)paren
)paren
(brace
r_if
c_cond
(paren
id|PortP-&gt;WaitUntilBooted
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting for RTA to boot&bslash;n&quot;
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|RIODelay
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
)paren
op_eq
id|RIO_FAIL
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;RTA EINTR in delay &bslash;n&quot;
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|repeat_this
op_decrement
op_le
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting for RTA to boot timeout&bslash;n&quot;
)paren
suffix:semicolon
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|FCLOSE
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|EINTR
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|PortP-&gt;HostP-&gt;Mapping
(braket
id|PortP-&gt;RupNum
)braket
dot
id|Flags
op_amp
id|RTA_BOOTED
)paren
)paren
(brace
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;RTA has been booted&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;RTA never booted&bslash;n&quot;
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|ENXIO
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#else
multiline_comment|/* I find the above code a bit hairy. I find the below code&n;           easier to read and shorter. Now, if it works too that would&n;&t;   be great... -- REW &n;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Checking if RTA has booted... &bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|PortP-&gt;HostP-&gt;Mapping
(braket
id|PortP-&gt;RupNum
)braket
dot
id|Flags
op_amp
id|RTA_BOOTED
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|PortP-&gt;WaitUntilBooted
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;RTA never booted&bslash;n&quot;
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/* Under Linux you&squot;d normally use a wait instead of this&n;&t;     busy-waiting. I&squot;ll stick with the old implementation for&n;&t;     now. --REW &n;&t;  */
r_if
c_cond
(paren
id|RIODelay
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
)paren
op_eq
id|RIO_FAIL
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;RTA_wait_for_boot: EINTR in delay &bslash;n&quot;
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|repeat_this
op_decrement
op_le
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting for RTA to boot timeout&bslash;n&quot;
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;RTA has been booted&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|tp
op_assign
id|PortP-&gt;TtyP
suffix:semicolon
multiline_comment|/* get tty struct */
macro_line|#endif
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
r_goto
id|bombout
suffix:semicolon
)brace
macro_line|#if 0
id|retval
op_assign
id|gs_init_port
c_func
(paren
op_amp
id|PortP-&gt;gs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|func_exit
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t;** If the port is in the final throws of being closed,&n;&t;** we should wait here (politely), waiting&n;&t;** for it to finish, so that it doesn&squot;t close us!&n;&t;*/
r_while
c_loop
(paren
(paren
id|PortP-&gt;State
op_amp
id|RIO_CLOSING
)paren
op_logical_and
op_logical_neg
id|p-&gt;RIOHalted
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting for RIO_CLOSING to go away&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|repeat_this
op_decrement
op_le
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting for not idle closed broken by signal&bslash;n&quot;
)paren
suffix:semicolon
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|FCLOSE
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINTR
suffix:semicolon
r_goto
id|bombout
suffix:semicolon
)brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIODelay
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
)paren
op_eq
id|RIO_FAIL
)paren
(brace
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINTR
suffix:semicolon
r_goto
id|bombout
suffix:semicolon
)brace
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|PortP-&gt;Mapped
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Port unmapped while closing!&bslash;n&quot;
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
r_goto
id|bombout
suffix:semicolon
)brace
multiline_comment|/*&n;** 15.10.1998 ARG - ESIL 0761 part fix&n;** RIO has it&squot;s own CTSFLOW and RTSFLOW flags in &squot;Config&squot; in the port structure,&n;** we need to make sure that the flags are clear when the port is opened.&n;*/
multiline_comment|/* Uh? Suppose I turn these on and then another process opens&n;&t;   the port again? The flags get cleared! Not good. -- REW */
r_if
c_cond
(paren
op_logical_neg
(paren
id|PortP-&gt;State
op_amp
(paren
id|RIO_LOPEN
op_or
id|RIO_MOPEN
)paren
)paren
)paren
(brace
id|PortP-&gt;Config
op_and_assign
op_complement
(paren
id|RIO_CTSFLOW
op_or
id|RIO_RTSFLOW
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|PortP-&gt;firstOpen
)paren
)paren
(brace
multiline_comment|/* First time ? */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;First open for this port&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;firstOpen
op_increment
suffix:semicolon
id|PortP-&gt;CookMode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* XXX RIOCookMode(tp); */
id|PortP-&gt;InUse
op_assign
id|NOT_INUSE
suffix:semicolon
multiline_comment|/* Tentative fix for bug PR27. Didn&squot;t work. */
multiline_comment|/* PortP-&gt;gs.xmit_cnt = 0; */
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef NEED_THIS
id|ttyseth
c_func
(paren
id|PortP
comma
id|tp
comma
(paren
r_struct
id|old_sgttyb
op_star
)paren
op_amp
id|default_sg
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Someone explain to me why this delay/config is&n;                   here. If I read the docs correctly the &quot;open&quot;&n;                   command piggybacks the parameters immediately. &n;&t;&t;   -- REW */
id|RIOParam
c_func
(paren
id|PortP
comma
id|OPEN
comma
id|Modem
comma
id|OK_TO_SLEEP
)paren
suffix:semicolon
multiline_comment|/* Open the port */
macro_line|#if 0
multiline_comment|/* This delay of 1 second was annoying. I removed it. -- REW */
id|RIODelay
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
op_star
l_int|10
)paren
suffix:semicolon
id|RIOParam
c_func
(paren
id|PortP
comma
id|CONFIG
comma
id|Modem
comma
id|OK_TO_SLEEP
)paren
suffix:semicolon
multiline_comment|/* Config the port */
macro_line|#endif
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** wait for the port to be not closed.&n;&t;&t;*/
r_while
c_loop
(paren
op_logical_neg
(paren
id|PortP-&gt;PortState
op_amp
id|PORT_ISOPEN
)paren
op_logical_and
op_logical_neg
id|p-&gt;RIOHalted
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting for PORT_ISOPEN-currently %x&bslash;n&quot;
comma
id|PortP-&gt;PortState
)paren
suffix:semicolon
multiline_comment|/*&n;** 15.10.1998 ARG - ESIL 0759&n;** (Part) fix for port being trashed when opened whilst RTA &quot;disconnected&quot;&n;** Take out the limited wait - now wait for ever or until user&n;** bangs us out.&n;**&n;&t;&t;&t;if (repeat_this -- &lt;= 0) {&n;&t;&t;&t;&t;rio_dprint(RIO_DEBUG_TTY, (&quot;Waiting for open to finish timed out.&bslash;n&quot;));&n;&t;&t;&t;&t;RIOPreemptiveCmd(p, PortP, FCLOSE ); &n;&t;&t;&t;&t;rio_spin_unlock_irqrestore(&amp;PortP-&gt;portSem, flags);&n;&t;&t;&t;&t;return -EINTR;&n;&t;&t;&t;}&n;**&n;*/
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIODelay
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
)paren
op_eq
id|RIO_FAIL
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting for open to finish broken by signal&bslash;n&quot;
)paren
suffix:semicolon
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|FCLOSE
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
id|bombout
suffix:colon
multiline_comment|/* &t;&t;&t;RIOClearUp( PortP ); */
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;PORT_ISOPEN found&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODEM_SUPPORT 
r_if
c_cond
(paren
id|Modem
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Modem - test for carrier&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** ACTION&n;&t;&t;** insert test for carrier here. -- ???&n;&t;&t;** I already see that test here. What&squot;s the deal? -- REW&n;&t;&t;*/
r_if
c_cond
(paren
(paren
id|PortP-&gt;gs.tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
op_logical_or
(paren
id|PortP-&gt;ModemState
op_amp
id|MSVR1_CD
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;open(%d) Modem carr on&bslash;n&quot;
comma
id|SysPort
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;tp-&gt;tm.c_state |= CARR_ON;&n;&t;&t;&t;wakeup((caddr_t) &amp;tp-&gt;tm.c_canq);&n;&t;&t;&t;*/
id|PortP-&gt;State
op_or_assign
id|RIO_CARR_ON
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|PortP-&gt;gs.open_wait
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* no carrier - wait for DCD */
(brace
multiline_comment|/*&n;&t;&t;&t;while (!(PortP-&gt;gs.tty-&gt;termios-&gt;c_state &amp; CARR_ON) &amp;&amp; &n;&t;&t;&t;       !(filp-&gt;f_flags &amp; O_NONBLOCK) &amp;&amp; !p-&gt;RIOHalted )&n;&t;&t;  */
r_while
c_loop
(paren
op_logical_neg
(paren
id|PortP-&gt;State
op_amp
id|RIO_CARR_ON
)paren
op_logical_and
op_logical_neg
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_logical_and
op_logical_neg
id|p-&gt;RIOHalted
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;open(%d) sleeping for carr on&bslash;n&quot;
comma
id|SysPort
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;PortP-&gt;gs.tty-&gt;termios-&gt;c_state |= WOPEN;&n;&t;&t;&t;&t;*/
id|PortP-&gt;State
op_or_assign
id|RIO_WOPEN
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|sleep
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|tp-&gt;tm.c_canqo
comma
id|TTIPRI
op_or
id|PCATCH
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t;** ACTION: verify that this is a good thing&n;&t;&t;&t;&t;&t;** to do here. -- ???&n;&t;&t;&t;&t;&t;** I think it&squot;s OK. -- REW&n;&t;&t;&t;&t;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;open(%d) sleeping for carr broken by signal&bslash;n&quot;
comma
id|SysPort
)paren
suffix:semicolon
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|FCLOSE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;&t;tp-&gt;tm.c_state &amp;= ~WOPEN;&n;&t;&t;&t;&t;&t;*/
id|PortP-&gt;State
op_and_assign
op_complement
id|RIO_WOPEN
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
macro_line|#endif
)brace
id|PortP-&gt;State
op_and_assign
op_complement
id|RIO_WOPEN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
r_goto
id|bombout
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Setting RIO_MOPEN&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;State
op_or_assign
id|RIO_MOPEN
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
multiline_comment|/*&n;&t;&t;** ACTION&n;&t;&t;** Direct line open - force carrier (will probably mean&n;&t;&t;** that sleeping Modem line fubar)&n;&t;&t;*/
id|PortP-&gt;State
op_or_assign
id|RIO_LOPEN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
r_goto
id|bombout
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;high level open done&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef STATS
id|PortP-&gt;Stat.OpenCnt
op_increment
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;** Count opens for port statistics reporting&n;&t;*/
r_if
c_cond
(paren
id|PortP-&gt;statsGather
)paren
id|PortP-&gt;opens
op_increment
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Returning from open&bslash;n&quot;
)paren
suffix:semicolon
id|func_exit
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** RIOClose the port.&n;** The operating system thinks that this is last close for the device.&n;** As there are two interfaces to the port (Modem and tty), we need to&n;** check that both are closed before we close the device.&n;*/
r_int
DECL|function|riotclose
id|riotclose
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
macro_line|#if 0
r_register
id|uint
id|SysPort
op_assign
id|dev
suffix:semicolon
r_struct
id|ttystatics
op_star
id|tp
suffix:semicolon
multiline_comment|/* pointer to our ttystruct */
macro_line|#endif
r_struct
id|Port
op_star
id|PortP
op_assign
id|ptr
suffix:semicolon
multiline_comment|/* pointer to the port structure */
r_int
id|deleted
op_assign
l_int|0
suffix:semicolon
r_int
r_try
op_assign
l_int|25
suffix:semicolon
r_int
id|repeat_this
op_assign
l_int|0xff
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|Modem
suffix:semicolon
r_int
id|rv
op_assign
l_int|0
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;port close SysPort %d&bslash;n&quot;
comma
id|PortP-&gt;PortNum
)paren
suffix:semicolon
multiline_comment|/* PortP = p-&gt;RIOPortp[SysPort]; */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Port is at address 0x%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|PortP
)paren
suffix:semicolon
multiline_comment|/* tp = PortP-&gt;TtyP;*/
multiline_comment|/* Get tty */
id|tty
op_assign
id|PortP-&gt;gs.tty
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TTY is at address 0x%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|tty
)paren
suffix:semicolon
id|Modem
op_assign
id|rio_ismodem
c_func
(paren
id|tty-&gt;device
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* What F.CKING cache? Even then, a higly idle multiprocessor,&n;&t;   system with large caches this won&squot;t work . Better find out when &n;&t;   this doesn&squot;t work asap, and fix the cause.  -- REW */
id|RIODelay
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
op_star
l_int|10
)paren
suffix:semicolon
multiline_comment|/* To flush the cache */
macro_line|#endif
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Setting this flag will make any process trying to open&n;&t;** this port block until we are complete closing it.&n;&t;*/
id|PortP-&gt;State
op_or_assign
id|RIO_CLOSING
suffix:semicolon
r_if
c_cond
(paren
(paren
id|PortP-&gt;State
op_amp
id|RIO_DELETED
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Close on deleted RTA&bslash;n&quot;
)paren
suffix:semicolon
id|deleted
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
id|RIOClearUp
c_func
(paren
id|PortP
)paren
suffix:semicolon
id|rv
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|close_end
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Clear bits&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** clear the open bits for this device&n;&t;*/
id|PortP-&gt;State
op_and_assign
(paren
id|Modem
ques
c_cond
op_complement
id|RIO_MOPEN
suffix:colon
op_complement
id|RIO_LOPEN
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** If the device was open as both a Modem and a tty line&n;&t;** then we need to wimp out here, as the port has not really&n;&t;** been finally closed (gee, whizz!) The test here uses the&n;&t;** bit for the OTHER mode of operation, to see if THAT is&n;&t;** still active!&n;&t;*/
r_if
c_cond
(paren
(paren
id|PortP-&gt;State
op_amp
(paren
id|RIO_LOPEN
op_or
id|RIO_MOPEN
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;** The port is still open for the other task -&n;&t;&t;** return, pretending that we are still active.&n;&t;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Channel %d still open !&bslash;n&quot;
comma
id|PortP-&gt;PortNum
)paren
suffix:semicolon
id|PortP-&gt;State
op_and_assign
op_complement
id|RIO_CLOSING
suffix:semicolon
r_if
c_cond
(paren
id|PortP-&gt;firstOpen
)paren
id|PortP-&gt;firstOpen
op_decrement
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Closing down - everything must go!&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;State
op_and_assign
op_complement
id|RIO_DYNOROD
suffix:semicolon
multiline_comment|/*&n;&t;** This is where we wait for the port&n;&t;** to drain down before closing. Bye-bye....&n;&t;** (We never meant to do this)&n;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Timeout 1 starts&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|deleted
)paren
r_while
c_loop
(paren
(paren
id|PortP-&gt;InUse
op_ne
id|NOT_INUSE
)paren
op_logical_and
op_logical_neg
id|p-&gt;RIOHalted
op_logical_and
(paren
id|PortP-&gt;TxBufferIn
op_ne
id|PortP-&gt;TxBufferOut
)paren
)paren
(brace
id|cprintf
c_func
(paren
l_string|&quot;Need to flush the ttyport&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|repeat_this
op_decrement
op_le
l_int|0
)paren
(brace
id|rv
op_assign
op_minus
id|EINTR
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting for not idle closed broken by signal&bslash;n&quot;
)paren
suffix:semicolon
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|FCLOSE
)paren
suffix:semicolon
r_goto
id|close_end
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Calling timeout to flush in closing&bslash;n&quot;
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIODelay_ni
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
op_star
l_int|10
)paren
op_eq
id|RIO_FAIL
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;RTA EINTR in delay &bslash;n&quot;
)paren
suffix:semicolon
id|rv
op_assign
op_minus
id|EINTR
suffix:semicolon
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_goto
id|close_end
suffix:semicolon
)brace
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
id|PortP-&gt;TxBufferIn
op_assign
id|PortP-&gt;TxBufferOut
op_assign
l_int|0
suffix:semicolon
id|repeat_this
op_assign
l_int|0xff
suffix:semicolon
id|PortP-&gt;InUse
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|PortP-&gt;State
op_amp
(paren
id|RIO_LOPEN
op_or
id|RIO_MOPEN
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;** The port has been re-opened for the other task -&n;&t;&t;** return, pretending that we are still active.&n;&t;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Channel %d re-open!&bslash;n&quot;
comma
id|PortP-&gt;PortNum
)paren
suffix:semicolon
id|PortP-&gt;State
op_and_assign
op_complement
id|RIO_CLOSING
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PortP-&gt;firstOpen
)paren
id|PortP-&gt;firstOpen
op_decrement
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
id|RIOClearUp
c_func
(paren
id|PortP
)paren
suffix:semicolon
r_goto
id|close_end
suffix:semicolon
)brace
multiline_comment|/* Can&squot;t call RIOShortCommand with the port locked. */
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIOShortCommand
c_func
(paren
id|p
comma
id|PortP
comma
id|CLOSE
comma
l_int|1
comma
l_int|0
)paren
op_eq
id|RIO_FAIL
)paren
(brace
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|FCLOSE
)paren
suffix:semicolon
r_goto
id|close_end
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|deleted
)paren
r_while
c_loop
(paren
r_try
op_logical_and
(paren
id|PortP-&gt;PortState
op_amp
id|PORT_ISOPEN
)paren
)paren
(brace
r_try
op_decrement
suffix:semicolon
r_if
c_cond
(paren
r_try
op_eq
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Run out of tries - force the bugger shut!&bslash;n&quot;
)paren
suffix:semicolon
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|FCLOSE
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Close: PortState:ISOPEN is %d&bslash;n&quot;
comma
id|PortP-&gt;PortState
op_amp
id|PORT_ISOPEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
id|RIOClearUp
c_func
(paren
id|PortP
)paren
suffix:semicolon
r_goto
id|close_end
suffix:semicolon
)brace
id|RIODelay_ni
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
)paren
suffix:semicolon
)brace
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Close: try was %d on completion&bslash;n&quot;
comma
r_try
)paren
suffix:semicolon
multiline_comment|/* RIOPreemptiveCmd(p, PortP, FCLOSE); */
multiline_comment|/*&n;** 15.10.1998 ARG - ESIL 0761 part fix&n;** RIO has it&squot;s own CTSFLOW and RTSFLOW flags in &squot;Config&squot; in the port structure,** we need to make sure that the flags are clear when the port is opened.&n;*/
id|PortP-&gt;Config
op_and_assign
op_complement
(paren
id|RIO_CTSFLOW
op_or
id|RIO_RTSFLOW
)paren
suffix:semicolon
macro_line|#ifdef STATS
id|PortP-&gt;Stat.CloseCnt
op_increment
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;** Count opens for port statistics reporting&n;&t;*/
r_if
c_cond
(paren
id|PortP-&gt;statsGather
)paren
id|PortP-&gt;closes
op_increment
suffix:semicolon
id|close_end
suffix:colon
multiline_comment|/* XXX: Why would a &quot;DELETED&quot; flag be reset here? I&squot;d have&n;&t;   thought that a &quot;deleted&quot; flag means that the port was&n;&t;   permanently gone, but here we can make it reappear by it&n;&t;   being in close during the &quot;deletion&quot;.&n;&t;*/
id|PortP-&gt;State
op_and_assign
op_complement
(paren
id|RIO_CLOSING
op_or
id|RIO_DELETED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PortP-&gt;firstOpen
)paren
id|PortP-&gt;firstOpen
op_decrement
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Return from close&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
multiline_comment|/*&n;** decide if we need to use the line discipline.&n;** This routine can return one of three values:&n;** COOK_RAW if no processing has to be done by the line discipline or the card&n;** COOK_WELL if the line discipline must be used to do the processing&n;** COOK_MEDIUM if the card can do all the processing necessary.&n;*/
r_int
DECL|function|RIOCookMode
id|RIOCookMode
c_func
(paren
r_struct
id|ttystatics
op_star
id|tp
)paren
(brace
multiline_comment|/*&n;&t;** We cant handle tm.c_mstate != 0 on SCO&n;&t;** We cant handle mapping&n;&t;** We cant handle non-ttwrite line disc.&n;&t;** We cant handle lflag XCASE&n;&t;** We can handle oflag OPOST &amp; (OCRNL, ONLCR, TAB3)&n;&t;*/
macro_line|#ifdef CHECK
id|CheckTtyP
c_func
(paren
id|tp
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|tp-&gt;tm.c_oflag
op_amp
id|OPOST
)paren
)paren
multiline_comment|/* No post processing */
r_return
id|COOK_RAW
suffix:semicolon
multiline_comment|/* Raw mode o/p */
r_if
c_cond
(paren
id|tp-&gt;tm.c_lflag
op_amp
id|XCASE
)paren
r_return
id|COOK_WELL
suffix:semicolon
multiline_comment|/* Use line disc */
r_if
c_cond
(paren
id|tp-&gt;tm.c_oflag
op_amp
op_complement
(paren
id|OPOST
op_or
id|ONLCR
op_or
id|OCRNL
op_or
id|TAB3
)paren
)paren
r_return
id|COOK_WELL
suffix:semicolon
multiline_comment|/* Use line disc for strange modes */
r_if
c_cond
(paren
id|tp-&gt;tm.c_oflag
op_eq
id|OPOST
)paren
multiline_comment|/* If only OPOST is set, do RAW */
r_return
id|COOK_RAW
suffix:semicolon
multiline_comment|/*&n;&t;** So, we need to output process!&n;&t;*/
r_return
id|COOK_MEDIUM
suffix:semicolon
)brace
r_static
r_void
DECL|function|RIOClearUp
id|RIOClearUp
c_func
(paren
id|PortP
)paren
r_struct
id|Port
op_star
id|PortP
suffix:semicolon
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;RIOHalted set&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Config
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Direct semaphore */
id|PortP-&gt;PortState
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;firstOpen
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;FlushCmdBodge
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;ModemState
op_assign
id|PortP-&gt;CookMode
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;Mapped
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;WflushFlag
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;MagicFlags
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;RxDataStart
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;TxBufferIn
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;TxBufferOut
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** Put a command onto a port.&n;** The PortPointer, command, length and arg are passed.&n;** The len is the length *inclusive* of the command byte,&n;** and so for a command that takes no data, len==1.&n;** The arg is a single byte, and is only used if len==2.&n;** Other values of len aren&squot;t allowed, and will cause&n;** a panic.&n;*/
DECL|function|RIOShortCommand
r_static
r_int
id|RIOShortCommand
c_func
(paren
r_struct
id|rio_info
op_star
id|p
comma
r_struct
id|Port
op_star
id|PortP
comma
r_int
id|command
comma
r_int
id|len
comma
r_int
id|arg
)paren
(brace
id|PKT
op_star
id|PacketP
suffix:semicolon
r_int
id|retries
op_assign
l_int|20
suffix:semicolon
multiline_comment|/* at 10 per second -&gt; 2 seconds */
r_int
r_int
id|flags
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;entering shortcommand.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CHECK
id|CheckPortP
c_func
(paren
id|PortP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
template_param
l_int|2
)paren
id|cprintf
c_func
(paren
(paren
l_string|&quot;STUPID LENGTH %d&bslash;n&quot;
comma
id|len
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|PortP-&gt;State
op_amp
id|RIO_DELETED
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Short command to deleted RTA ignored&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** If the port is in use for pre-emptive command, then wait for it to &n;&t;** be free again.&n;&t;*/
r_while
c_loop
(paren
(paren
id|PortP-&gt;InUse
op_ne
id|NOT_INUSE
)paren
op_logical_and
op_logical_neg
id|p-&gt;RIOHalted
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting for not in use (%d)&bslash;n&quot;
comma
id|retries
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retries
op_decrement
op_le
l_int|0
)paren
(brace
r_return
id|RIO_FAIL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|RIODelay_ni
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
)paren
op_eq
id|RIO_FAIL
)paren
(brace
r_return
id|RIO_FAIL
suffix:semicolon
)brace
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|PortP-&gt;State
op_amp
id|RIO_DELETED
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Short command to deleted RTA ignored&bslash;n&quot;
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|can_add_transmit
c_func
(paren
op_amp
id|PacketP
comma
id|PortP
)paren
op_logical_and
op_logical_neg
id|p-&gt;RIOHalted
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Waiting to add short command to queue (%d)&bslash;n&quot;
comma
id|retries
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retries
op_decrement
op_le
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;out of tries. Failing&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|RIODelay_ni
c_func
(paren
id|PortP
comma
id|HUNDRED_MS
)paren
op_eq
id|RIO_FAIL
)paren
(brace
r_return
id|RIO_FAIL
suffix:semicolon
)brace
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
id|RIO_FAIL
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** set the command byte and the argument byte&n;&t;*/
id|WBYTE
c_func
(paren
id|PacketP-&gt;data
(braket
l_int|0
)braket
comma
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|2
)paren
id|WBYTE
c_func
(paren
id|PacketP-&gt;data
(braket
l_int|1
)braket
comma
id|arg
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** set the length of the packet and set the command bit.&n;&t;*/
id|WBYTE
c_func
(paren
id|PacketP-&gt;len
comma
id|PKT_CMD_BIT
op_or
id|len
)paren
suffix:semicolon
id|add_transmit
c_func
(paren
id|PortP
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Count characters transmitted for port statistics reporting&n;&t;*/
r_if
c_cond
(paren
id|PortP-&gt;statsGather
)paren
id|PortP-&gt;txchars
op_add_assign
id|len
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
id|p-&gt;RIOHalted
ques
c_cond
id|RIO_FAIL
suffix:colon
op_complement
id|RIO_FAIL
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/*&n;** This is an ioctl interface. This is the twentieth century. You know what&n;** its all about.&n;*/
r_int
id|riotioctl
c_func
(paren
id|p
comma
id|dev
comma
id|cmd
comma
id|arg
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
id|dev_t
id|dev
suffix:semicolon
r_register
r_int
id|cmd
suffix:semicolon
r_register
id|caddr_t
id|arg
suffix:semicolon
(brace
r_register
r_struct
id|Port
op_star
id|PortP
suffix:semicolon
r_register
r_struct
id|ttystatics
op_star
id|tp
suffix:semicolon
r_int
id|current
suffix:semicolon
r_int
id|ParamSemIncremented
op_assign
l_int|0
suffix:semicolon
r_int
id|old_oflag
comma
id|old_cflag
comma
id|old_iflag
comma
id|changed
comma
id|oldcook
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|sio_regs
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* Here be magic */
r_int
id|vpix_cflag
suffix:semicolon
r_int
id|divisor
suffix:semicolon
r_int
id|baud
suffix:semicolon
id|uint
id|SysPort
op_assign
id|dev
suffix:semicolon
r_int
id|Modem
op_assign
id|rio_ismodem
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ioctl_processed
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;port ioctl SysPort %d command 0x%x argument 0x%x %s&bslash;n&quot;
comma
id|SysPort
comma
id|cmd
comma
id|arg
comma
id|Modem
ques
c_cond
l_string|&quot;Modem&quot;
suffix:colon
l_string|&quot;tty&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SysPort
op_ge
id|RIO_PORTS
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Bad port number %d&bslash;n&quot;
comma
id|SysPort
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|PortP
op_assign
id|p-&gt;RIOPortp
(braket
id|SysPort
)braket
suffix:semicolon
id|tp
op_assign
id|PortP-&gt;TtyP
suffix:semicolon
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef STATS
id|PortP-&gt;Stat.IoctlCnt
op_increment
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|PortP-&gt;State
op_amp
id|RIO_DELETED
)paren
(brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
id|RIOClearUp
c_func
(paren
id|PortP
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** Count ioctls for port statistics reporting&n;&t;*/
r_if
c_cond
(paren
id|PortP-&gt;statsGather
)paren
id|PortP-&gt;ioctls
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;** Specialix RIO Ioctl calls&n;&t;*/
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TCRIOTRIAD
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
id|PortP-&gt;State
op_or_assign
id|RIO_TRIAD_MODE
suffix:semicolon
r_else
id|PortP-&gt;State
op_and_assign
op_complement
id|RIO_TRIAD_MODE
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;** Normally, when istrip is set on a port, a config is&n;&t;&t;&t;** sent to the RTA instructing the CD1400 to do the&n;&t;&t;&t;** stripping. In TRIAD mode, the interrupt receive routine&n;&t;&t;&t;** must do the stripping instead, since it has to detect&n;&t;&t;&t;** an 8 bit function key sequence. If istrip is set with&n;&t;&t;&t;** TRIAD mode on(off), and 8 bit data is being read by&n;&t;&t;&t;** the port, the user then turns TRIAD mode off(on), the RTA&n;&t;&t;&t;** must be reconfigured (not) to do the stripping.&n;&t;&t;&t;** Hence we call RIOParam here.&n;&t;&t;&t;*/
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|RIOParam
c_func
(paren
id|PortP
comma
id|CONFIG
comma
id|Modem
comma
id|OK_TO_SLEEP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOTSTATE
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;tbusy/tstop monitoring %sabled&bslash;n&quot;
comma
id|arg
ques
c_cond
l_string|&quot;en&quot;
suffix:colon
l_string|&quot;dis&quot;
)paren
suffix:semicolon
multiline_comment|/* MonitorTstate = 0 ;*/
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|RIOParam
c_func
(paren
id|PortP
comma
id|CONFIG
comma
id|Modem
comma
id|OK_TO_SLEEP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOSTATE
suffix:colon
multiline_comment|/* current state of Modem input pins */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOSTATE&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|MGET
)paren
op_eq
id|RIO_FAIL
)paren
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOSTATE command failed&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;State
op_or_assign
id|RIO_BUSY
suffix:semicolon
id|current
op_assign
id|PortP-&gt;ModemState
suffix:semicolon
r_if
c_cond
(paren
id|copyout
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|current
comma
(paren
r_int
)paren
id|arg
comma
r_sizeof
(paren
id|current
)paren
)paren
op_eq
id|COPYFAIL
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Copyout failed&bslash;n&quot;
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|EFAULT
)paren
suffix:semicolon
)brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOMBIS
suffix:colon
multiline_comment|/* Set modem lines */
r_case
id|TCRIOMBIC
suffix:colon
multiline_comment|/* Clear modem lines */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOMBIS/TCRIOMBIC&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|TCRIOMBIS
)paren
(brace
id|uint
id|state
suffix:semicolon
id|state
op_assign
(paren
id|uint
)paren
id|arg
suffix:semicolon
id|PortP-&gt;ModemState
op_or_assign
(paren
id|ushort
)paren
id|state
suffix:semicolon
id|PortP-&gt;ModemLines
op_assign
(paren
id|ulong
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|MBIS
)paren
op_eq
id|RIO_FAIL
)paren
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOMBIS command failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|uint
id|state
suffix:semicolon
id|state
op_assign
(paren
id|uint
)paren
id|arg
suffix:semicolon
id|PortP-&gt;ModemState
op_and_assign
op_complement
(paren
id|ushort
)paren
id|state
suffix:semicolon
id|PortP-&gt;ModemLines
op_assign
(paren
id|ulong
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|RIOPreemptiveCmd
c_func
(paren
id|p
comma
id|PortP
comma
id|MBIC
)paren
op_eq
id|RIO_FAIL
)paren
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOMBIC command failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|PortP-&gt;State
op_or_assign
id|RIO_BUSY
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOXPON
suffix:colon
multiline_comment|/* set Xprint ON string */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOXPON&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copyin
c_func
(paren
(paren
r_int
)paren
id|arg
comma
(paren
id|caddr_t
)paren
id|PortP-&gt;Xprint.XpOn
comma
id|MAX_XP_CTRL_LEN
)paren
op_eq
id|COPYFAIL
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Copyin failed&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Xprint.XpOn
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|EFAULT
)paren
suffix:semicolon
)brace
id|PortP-&gt;Xprint.XpOn
(braket
id|MAX_XP_CTRL_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|PortP-&gt;Xprint.XpLen
op_assign
id|RIOStrlen
c_func
(paren
id|PortP-&gt;Xprint.XpOn
)paren
op_plus
id|RIOStrlen
c_func
(paren
id|PortP-&gt;Xprint.XpOff
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOXPOFF
suffix:colon
multiline_comment|/* set Xprint OFF string */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOXPOFF&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copyin
c_func
(paren
(paren
r_int
)paren
id|arg
comma
(paren
id|caddr_t
)paren
id|PortP-&gt;Xprint.XpOff
comma
id|MAX_XP_CTRL_LEN
)paren
op_eq
id|COPYFAIL
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Copyin failed&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Xprint.XpOff
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|EFAULT
)paren
suffix:semicolon
)brace
id|PortP-&gt;Xprint.XpOff
(braket
id|MAX_XP_CTRL_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|PortP-&gt;Xprint.XpLen
op_assign
id|RIOStrlen
c_func
(paren
id|PortP-&gt;Xprint.XpOn
)paren
op_plus
id|RIOStrlen
c_func
(paren
id|PortP-&gt;Xprint.XpOff
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOXPCPS
suffix:colon
multiline_comment|/* set Xprint CPS string */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOXPCPS&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|uint
)paren
id|arg
OG
id|p-&gt;RIOConf.MaxXpCps
op_logical_or
(paren
id|uint
)paren
id|arg
OL
id|p-&gt;RIOConf.MinXpCps
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;%d CPS out of range&bslash;n&quot;
comma
id|arg
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|PortP-&gt;Xprint.XpCps
op_assign
(paren
id|uint
)paren
id|arg
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOXPRINT
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOXPRINT&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copyout
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|PortP-&gt;Xprint
comma
(paren
r_int
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|Xprint
)paren
)paren
op_eq
id|COPYFAIL
)paren
(brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|EFAULT
)paren
suffix:semicolon
)brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOIXANYON
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOIXANYON&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Config
op_or_assign
id|RIO_IXANY
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOIXANYOFF
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOIXANYOFF&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Config
op_and_assign
op_complement
id|RIO_IXANY
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOIXONON
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOIXONON&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Config
op_or_assign
id|RIO_IXON
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOIXONOFF
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOIXONOFF&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Config
op_and_assign
op_complement
id|RIO_IXON
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;** 15.10.1998 ARG - ESIL 0761 part fix&n;** Added support for CTS and RTS flow control ioctls :&n;*/
r_case
id|TCRIOCTSFLOWEN
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOCTSFLOWEN&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Config
op_or_assign
id|RIO_CTSFLOW
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|RIOParam
c_func
(paren
id|PortP
comma
id|CONFIG
comma
id|Modem
comma
id|OK_TO_SLEEP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIOCTSFLOWDIS
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIOCTSFLOWDIS&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Config
op_and_assign
op_complement
id|RIO_CTSFLOW
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|RIOParam
c_func
(paren
id|PortP
comma
id|CONFIG
comma
id|Modem
comma
id|OK_TO_SLEEP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIORTSFLOWEN
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIORTSFLOWEN&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Config
op_or_assign
id|RIO_RTSFLOW
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|RIOParam
c_func
(paren
id|PortP
comma
id|CONFIG
comma
id|Modem
comma
id|OK_TO_SLEEP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TCRIORTSFLOWDIS
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;TCRIORTSFLOWDIS&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;Config
op_and_assign
op_complement
id|RIO_RTSFLOW
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|RIOParam
c_func
(paren
id|PortP
comma
id|CONFIG
comma
id|Modem
comma
id|OK_TO_SLEEP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* end ESIL 0761 part fix */
)brace
multiline_comment|/* Lynx IOCTLS */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCSETP
suffix:colon
r_case
id|TIOCSETN
suffix:colon
r_case
id|OTIOCSETP
suffix:colon
r_case
id|OTIOCSETN
suffix:colon
id|ioctl_processed
op_increment
suffix:semicolon
id|ttyseth
c_func
(paren
id|PortP
comma
id|tp
comma
(paren
r_struct
id|old_sgttyb
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCSETA
suffix:colon
r_case
id|TCSETAW
suffix:colon
r_case
id|TCSETAF
suffix:colon
id|ioctl_processed
op_increment
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;NON POSIX ioctl&bslash;n&quot;
)paren
suffix:semicolon
id|ttyseth_pv
c_func
(paren
id|PortP
comma
id|tp
comma
(paren
r_struct
id|termios
op_star
)paren
id|arg
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCSETAP
suffix:colon
multiline_comment|/* posix tcsetattr() */
r_case
id|TCSETAWP
suffix:colon
multiline_comment|/* posix tcsetattr() */
r_case
id|TCSETAFP
suffix:colon
multiline_comment|/* posix tcsetattr() */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;NON POSIX SYSV ioctl&bslash;n&quot;
)paren
suffix:semicolon
id|ttyseth_pv
c_func
(paren
id|PortP
comma
id|tp
comma
(paren
r_struct
id|termios
op_star
)paren
id|arg
comma
l_int|1
)paren
suffix:semicolon
id|ioctl_processed
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** If its any of the commands that require the port to be in the&n;&t;** non-busy state wait until all output has drained &n;&t;*/
r_if
c_cond
(paren
op_logical_neg
id|ioctl_processed
)paren
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TCSETAW
suffix:colon
r_case
id|TCSETAF
suffix:colon
r_case
id|TCSETA
suffix:colon
r_case
id|TCSBRK
suffix:colon
mdefine_line|#define OLD_POSIX (&squot;x&squot; &lt;&lt; 8)
mdefine_line|#define OLD_POSIX_SETA (OLD_POSIX | 2)
mdefine_line|#define OLD_POSIX_SETAW (OLD_POSIX | 3)
mdefine_line|#define OLD_POSIX_SETAF (OLD_POSIX | 4)
mdefine_line|#define NEW_POSIX ((&squot;i&squot; &lt;&lt; 24) | (&squot;X&squot; &lt;&lt; 16))
mdefine_line|#define NEW_POSIX_SETA (NEW_POSIX | 2)
mdefine_line|#define NEW_POSIX_SETAW (NEW_POSIX | 3)
mdefine_line|#define NEW_POSIX_SETAF (NEW_POSIX | 4)
r_case
id|OLD_POSIX_SETA
suffix:colon
r_case
id|OLD_POSIX_SETAW
suffix:colon
r_case
id|OLD_POSIX_SETAF
suffix:colon
r_case
id|NEW_POSIX_SETA
suffix:colon
r_case
id|NEW_POSIX_SETAW
suffix:colon
r_case
id|NEW_POSIX_SETAF
suffix:colon
macro_line|#ifdef TIOCSETP
r_case
id|TIOCSETP
suffix:colon
macro_line|#endif
r_case
id|TIOCSETD
suffix:colon
r_case
id|TIOCSETN
suffix:colon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;wait for non-BUSY, semaphore set&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;** Wait for drain here, at least as far as the double buffer&n;&t;&t;&t;** being empty.&n;&t;&t;&t;*/
multiline_comment|/* XXX Does the above comment mean that this has&n;&t;&t;&t;   still to be implemented? -- REW */
multiline_comment|/* XXX Is the locking OK together with locking&n;                           in txenable? (Deadlock?) -- REW */
id|RIOTxEnable
c_func
(paren
(paren
r_char
op_star
)paren
id|PortP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|old_cflag
op_assign
id|tp-&gt;tm.c_cflag
suffix:semicolon
id|old_iflag
op_assign
id|tp-&gt;tm.c_iflag
suffix:semicolon
id|old_oflag
op_assign
id|tp-&gt;tm.c_oflag
suffix:semicolon
id|oldcook
op_assign
id|PortP-&gt;CookMode
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
id|RIOClearUp
c_func
(paren
id|PortP
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|EIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|PortP-&gt;FlushCmdBodge
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;** If the port is locked, and it is reconfigured, we want&n;&t;** to restore the state of the tty structure so the change is NOT&n;&t;** made.&n;&t;*/
r_if
c_cond
(paren
id|PortP-&gt;Lock
)paren
(brace
id|tp-&gt;tm.c_iflag
op_assign
id|PortP-&gt;StoredTty.iflag
suffix:semicolon
id|tp-&gt;tm.c_oflag
op_assign
id|PortP-&gt;StoredTty.oflag
suffix:semicolon
id|tp-&gt;tm.c_cflag
op_assign
id|PortP-&gt;StoredTty.cflag
suffix:semicolon
id|tp-&gt;tm.c_lflag
op_assign
id|PortP-&gt;StoredTty.lflag
suffix:semicolon
id|tp-&gt;tm.c_line
op_assign
id|PortP-&gt;StoredTty.line
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NCC
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|tp-&gt;tm.c_cc
(braket
id|i
)braket
op_assign
id|PortP-&gt;StoredTty.cc
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;** If the port is set to store the parameters, and it is&n;&t;&t;** reconfigured, we want to save the current tty struct so it&n;&t;&t;** may be restored on the next open.&n;&t;&t;*/
r_if
c_cond
(paren
id|PortP-&gt;Store
)paren
(brace
id|PortP-&gt;StoredTty.iflag
op_assign
id|tp-&gt;tm.c_iflag
suffix:semicolon
id|PortP-&gt;StoredTty.oflag
op_assign
id|tp-&gt;tm.c_oflag
suffix:semicolon
id|PortP-&gt;StoredTty.cflag
op_assign
id|tp-&gt;tm.c_cflag
suffix:semicolon
id|PortP-&gt;StoredTty.lflag
op_assign
id|tp-&gt;tm.c_lflag
suffix:semicolon
id|PortP-&gt;StoredTty.line
op_assign
id|tp-&gt;tm.c_line
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NCC
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|PortP-&gt;StoredTty.cc
(braket
id|i
)braket
op_assign
id|tp-&gt;tm.c_cc
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
id|changed
op_assign
(paren
id|tp-&gt;tm.c_cflag
op_ne
id|old_cflag
)paren
op_logical_or
(paren
id|tp-&gt;tm.c_iflag
op_ne
id|old_iflag
)paren
op_logical_or
(paren
id|tp-&gt;tm.c_oflag
op_ne
id|old_oflag
)paren
suffix:semicolon
id|PortP-&gt;CookMode
op_assign
id|RIOCookMode
c_func
(paren
id|tp
)paren
suffix:semicolon
multiline_comment|/* Set new cooking mode */
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;RIOIoctl changed %d newcook %d oldcook %d&bslash;n&quot;
comma
id|changed
comma
id|PortP-&gt;CookMode
comma
id|oldcook
)paren
suffix:semicolon
macro_line|#ifdef MODEM_SUPPORT
multiline_comment|/*&n;&t;** kludge to force CARR_ON if CLOCAL set&n;&t;*/
r_if
c_cond
(paren
(paren
id|tp-&gt;tm.c_cflag
op_amp
id|CLOCAL
)paren
op_logical_or
(paren
id|PortP-&gt;ModemState
op_amp
id|MSVR1_CD
)paren
)paren
(brace
id|tp-&gt;tm.c_state
op_or_assign
id|CARR_ON
suffix:semicolon
id|wakeup
(paren
(paren
id|caddr_t
)paren
op_amp
id|tp-&gt;tm.c_canq
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
id|RIOClearUp
c_func
(paren
id|PortP
)paren
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|EIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** Re-configure if modes or cooking have changed&n;&t;*/
r_if
c_cond
(paren
id|changed
op_logical_or
id|oldcook
op_ne
id|PortP-&gt;CookMode
op_logical_or
(paren
id|ioctl_processed
)paren
)paren
(brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TTY
comma
l_string|&quot;Ioctl changing the PORT settings&bslash;n&quot;
)paren
suffix:semicolon
id|RIOParam
c_func
(paren
id|PortP
comma
id|CONFIG
comma
id|Modem
comma
id|OK_TO_SLEEP
)paren
suffix:semicolon
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOHalted
)paren
(brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|RIOClearUp
c_func
(paren
id|PortP
)paren
suffix:semicolon
id|pseterr
c_func
(paren
id|EIO
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;ttyseth -- set hardware dependant tty settings&n;*/
r_void
id|ttyseth
c_func
(paren
id|PortP
comma
id|s
comma
id|sg
)paren
r_struct
id|Port
op_star
id|PortP
suffix:semicolon
r_struct
id|ttystatics
op_star
id|s
suffix:semicolon
r_struct
id|old_sgttyb
op_star
id|sg
suffix:semicolon
(brace
r_struct
id|old_sgttyb
op_star
id|tsg
suffix:semicolon
r_struct
id|termios
op_star
id|tp
op_assign
op_amp
id|s-&gt;tm
suffix:semicolon
id|tsg
op_assign
op_amp
id|s-&gt;sg
suffix:semicolon
r_if
c_cond
(paren
id|sg-&gt;sg_flags
op_amp
(paren
id|EVENP
op_or
id|ODDP
)paren
)paren
(brace
id|tp-&gt;c_cflag
op_and_assign
id|PARENB
suffix:semicolon
r_if
c_cond
(paren
id|sg-&gt;sg_flags
op_amp
id|EVENP
)paren
(brace
r_if
c_cond
(paren
id|sg-&gt;sg_flags
op_amp
id|ODDP
)paren
(brace
id|tp-&gt;c_cflag
op_and_assign
id|V_CS7
suffix:semicolon
id|tp-&gt;c_cflag
op_and_assign
op_complement
id|PARENB
suffix:semicolon
)brace
r_else
(brace
id|tp-&gt;c_cflag
op_and_assign
id|V_CS7
suffix:semicolon
id|tp-&gt;c_cflag
op_and_assign
id|PARENB
suffix:semicolon
id|tp-&gt;c_cflag
op_and_assign
id|PARODD
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sg-&gt;sg_flags
op_amp
id|ODDP
)paren
(brace
id|tp-&gt;c_cflag
op_and_assign
id|V_CS7
suffix:semicolon
id|tp-&gt;c_cflag
op_and_assign
id|PARENB
suffix:semicolon
id|tp-&gt;c_cflag
op_and_assign
id|PARODD
suffix:semicolon
)brace
r_else
(brace
id|tp-&gt;c_cflag
op_and_assign
id|V_CS7
suffix:semicolon
id|tp-&gt;c_cflag
op_and_assign
id|PARENB
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Use ispeed as the desired speed.  Most implementations don&squot;t handle &n; * separate input and output speeds very well. If the RIO handles this, &n; * I will have to use separate sets of flags to store them in the &n; * Port structure.&n; */
r_if
c_cond
(paren
op_logical_neg
id|sg-&gt;sg_ospeed
)paren
id|sg-&gt;sg_ospeed
op_assign
id|sg-&gt;sg_ispeed
suffix:semicolon
r_else
id|sg-&gt;sg_ispeed
op_assign
id|sg-&gt;sg_ospeed
suffix:semicolon
r_if
c_cond
(paren
id|sg-&gt;sg_ispeed
OG
id|V_EXTB
)paren
id|sg-&gt;sg_ispeed
op_assign
id|V_EXTB
suffix:semicolon
r_if
c_cond
(paren
id|sg-&gt;sg_ispeed
OL
id|V_B0
)paren
id|sg-&gt;sg_ispeed
op_assign
id|V_B0
suffix:semicolon
op_star
id|tsg
op_assign
op_star
id|sg
suffix:semicolon
id|tp-&gt;c_cflag
op_assign
(paren
id|tp-&gt;c_cflag
op_amp
op_complement
id|V_CBAUD
)paren
op_or
id|conv_bv
(braket
(paren
r_int
)paren
id|sg-&gt;sg_ispeed
)braket
suffix:semicolon
)brace
multiline_comment|/*&n;&t;ttyseth_pv -- set hardware dependant tty settings using either the&n;&t;&t;&t;POSIX termios structure or the System V termio structure.&n;&t;&t;&t;&t;sysv = 0 =&gt; (POSIX):&t; struct termios *sg&n;&t;&t;&t;&t;sysv != 0 =&gt; (System V): struct termio *sg&n;*/
r_static
r_void
id|ttyseth_pv
c_func
(paren
id|PortP
comma
id|s
comma
id|sg
comma
id|sysv
)paren
r_struct
id|Port
op_star
id|PortP
suffix:semicolon
r_struct
id|ttystatics
op_star
id|s
suffix:semicolon
r_struct
id|termios
op_star
id|sg
suffix:semicolon
r_int
id|sysv
suffix:semicolon
(brace
r_int
id|speed
suffix:semicolon
r_int
r_char
id|csize
suffix:semicolon
r_int
r_char
id|cread
suffix:semicolon
r_int
r_int
id|lcr_flags
suffix:semicolon
r_int
id|ps
suffix:semicolon
r_if
c_cond
(paren
id|sysv
)paren
(brace
multiline_comment|/* sg points to a System V termio structure */
id|csize
op_assign
(paren
(paren
r_struct
id|termio
op_star
)paren
id|sg
)paren
op_member_access_from_pointer
id|c_cflag
op_amp
id|CSIZE
suffix:semicolon
id|cread
op_assign
(paren
(paren
r_struct
id|termio
op_star
)paren
id|sg
)paren
op_member_access_from_pointer
id|c_cflag
op_amp
id|CREAD
suffix:semicolon
id|speed
op_assign
id|conv_vb
(braket
(paren
(paren
r_struct
id|termio
op_star
)paren
id|sg
)paren
op_member_access_from_pointer
id|c_cflag
op_amp
id|V_CBAUD
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* sg points to a POSIX termios structure */
id|csize
op_assign
id|sg-&gt;c_cflag
op_amp
id|CSIZE
suffix:semicolon
id|cread
op_assign
id|sg-&gt;c_cflag
op_amp
id|CREAD
suffix:semicolon
id|speed
op_assign
id|conv_vb
(braket
id|sg-&gt;c_cflag
op_amp
id|V_CBAUD
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;sg.sg_ispeed
op_ne
id|speed
op_logical_or
id|s-&gt;sg.sg_ospeed
op_ne
id|speed
)paren
(brace
id|s-&gt;sg.sg_ispeed
op_assign
id|speed
suffix:semicolon
id|s-&gt;sg.sg_ospeed
op_assign
id|speed
suffix:semicolon
id|s-&gt;tm.c_cflag
op_assign
(paren
id|s-&gt;tm.c_cflag
op_amp
op_complement
id|V_CBAUD
)paren
op_or
id|conv_bv
(braket
(paren
r_int
)paren
id|s-&gt;sg.sg_ispeed
)braket
suffix:semicolon
)brace
)brace
macro_line|#endif
eof
