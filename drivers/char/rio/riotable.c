multiline_comment|/*&n;** -----------------------------------------------------------------------------&n;**&n;**  Perle Specialix driver for Linux&n;**  Ported from existing RIO Driver for SCO sources.&n; *&n; *  (C) 1990 - 2000 Specialix International Ltd., Byfleet, Surrey, UK.&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *      This program is distributed in the hope that it will be useful,&n; *      but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *      GNU General Public License for more details.&n; *&n; *      You should have received a copy of the GNU General Public License&n; *      along with this program; if not, write to the Free Software&n; *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;**&n;**&t;Module&t;&t;: riotable.c&n;**&t;SID&t;&t;: 1.2&n;**&t;Last Modified&t;: 11/6/98 10:33:47&n;**&t;Retrieved&t;: 11/6/98 10:33:50&n;**&n;**  ident @(#)riotable.c&t;1.2&n;**&n;** -----------------------------------------------------------------------------&n;*/
macro_line|#ifdef SCCS_LABELS
DECL|variable|_riotable_c_sccs_
r_static
r_char
op_star
id|_riotable_c_sccs_
op_assign
l_string|&quot;@(#)riotable.c&t;1.2&quot;
suffix:semicolon
macro_line|#endif
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/string.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#include &lt;linux/generic_serial.h&gt;
macro_line|#include &quot;linux_compat.h&quot;
macro_line|#include &quot;rio_linux.h&quot;
macro_line|#include &quot;typdef.h&quot;
macro_line|#include &quot;pkt.h&quot;
macro_line|#include &quot;daemon.h&quot;
macro_line|#include &quot;rio.h&quot;
macro_line|#include &quot;riospace.h&quot;
macro_line|#include &quot;top.h&quot;
macro_line|#include &quot;cmdpkt.h&quot;
macro_line|#include &quot;map.h&quot;
macro_line|#include &quot;riotypes.h&quot;
macro_line|#include &quot;rup.h&quot;
macro_line|#include &quot;port.h&quot;
macro_line|#include &quot;riodrvr.h&quot;
macro_line|#include &quot;rioinfo.h&quot;
macro_line|#include &quot;func.h&quot;
macro_line|#include &quot;errors.h&quot;
macro_line|#include &quot;pci.h&quot;
macro_line|#include &quot;parmmap.h&quot;
macro_line|#include &quot;unixrup.h&quot;
macro_line|#include &quot;board.h&quot;
macro_line|#include &quot;host.h&quot;
macro_line|#include &quot;error.h&quot;
macro_line|#include &quot;phb.h&quot;
macro_line|#include &quot;link.h&quot;
macro_line|#include &quot;cmdblk.h&quot;
macro_line|#include &quot;route.h&quot;
macro_line|#include &quot;control.h&quot;
macro_line|#include &quot;cirrus.h&quot;
macro_line|#include &quot;rioioctl.h&quot;
macro_line|#include &quot;param.h&quot;
macro_line|#include &quot;list.h&quot;
macro_line|#include &quot;sam.h&quot;
macro_line|#include &quot;protsts.h&quot;
multiline_comment|/*&n;** A configuration table has been loaded. It is now up to us&n;** to sort it out and use the information contained therein.&n;*/
r_int
DECL|function|RIONewTable
id|RIONewTable
c_func
(paren
id|p
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
(brace
r_int
id|Host
comma
id|Host1
comma
id|Host2
comma
id|NameIsUnique
comma
id|Entry
comma
id|SubEnt
suffix:semicolon
r_struct
id|Map
op_star
id|MapP
suffix:semicolon
r_struct
id|Map
op_star
id|HostMapP
suffix:semicolon
r_struct
id|Host
op_star
id|HostP
suffix:semicolon
r_char
op_star
id|cptr
suffix:semicolon
multiline_comment|/*&n;&t;** We have been sent a new table to install. We need to break&n;&t;** it down into little bits and spread it around a bit to see&n;&t;** what we have got.&n;&t;*/
multiline_comment|/*&n;&t;** Things to check:&n;&t;** (things marked &squot;xx&squot; aren&squot;t checked any more!)&n;&t;** (1)&t;That there are no booted Hosts/RTAs out there.&n;&t;** (2)&t;That the names are properly formed&n;&t;** (3)&t;That blank entries really are.&n;&t;** xx (4)&t;That hosts mentioned in the table actually exist. xx&n;&t;** (5)&t;That the IDs are unique (per host).&n;&t;** (6)&t;That host IDs are zero&n;&t;** (7)&t;That port numbers are valid&n;&t;** (8)&t;That port numbers aren&squot;t duplicated&n;&t;** (9)&t;That names aren&squot;t duplicated&n;&t;** xx (10) That hosts that actually exist are mentioned in the table. xx&n;&t;*/
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(1)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;RIOSystemUp
)paren
(brace
multiline_comment|/* (1) */
id|p-&gt;RIOError.Error
op_assign
id|HOST_HAS_ALREADY_BEEN_BOOTED
suffix:semicolon
r_return
id|EBUSY
suffix:semicolon
)brace
id|p-&gt;RIOError.Error
op_assign
id|NOTHING_WRONG_AT_ALL
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
op_minus
l_int|1
suffix:semicolon
id|p-&gt;RIOError.Other
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|Entry
op_assign
l_int|0
suffix:semicolon
id|Entry
OL
id|TOTAL_MAP_ENTRIES
suffix:semicolon
id|Entry
op_increment
)paren
(brace
id|MapP
op_assign
op_amp
id|p-&gt;RIOConnectTable
(braket
id|Entry
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|MapP-&gt;Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
op_eq
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(2)&bslash;n&quot;
)paren
suffix:semicolon
id|cptr
op_assign
id|MapP-&gt;Name
suffix:semicolon
multiline_comment|/* (2) */
id|cptr
(braket
id|MAX_NAME_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|cptr
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|bcopy
c_func
(paren
id|MapP-&gt;RtaUniqueNum
ques
c_cond
l_string|&quot;RTA&t;NN&quot;
suffix:colon
l_string|&quot;HOST NN&quot;
comma
id|MapP-&gt;Name
comma
l_int|8
)paren
suffix:semicolon
id|MapP-&gt;Name
(braket
l_int|5
)braket
op_assign
l_char|&squot;0&squot;
op_plus
id|Entry
op_div
l_int|10
suffix:semicolon
id|MapP-&gt;Name
(braket
l_int|6
)braket
op_assign
l_char|&squot;0&squot;
op_plus
id|Entry
op_mod
l_int|10
suffix:semicolon
)brace
r_while
c_loop
(paren
op_star
id|cptr
)paren
(brace
r_if
c_cond
(paren
op_star
id|cptr
l_char|&squot;~&squot;
)paren
(brace
id|p-&gt;RIOError.Error
op_assign
id|BAD_CHARACTER_IN_NAME
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
id|cptr
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t;** If the entry saved was a tentative entry then just forget&n;&t;&t;** about it.&n;&t;&t;*/
r_if
c_cond
(paren
id|MapP-&gt;Flags
op_amp
id|SLOT_TENTATIVE
)paren
(brace
id|MapP-&gt;HostUniqueNum
op_assign
l_int|0
suffix:semicolon
id|MapP-&gt;RtaUniqueNum
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(3)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MapP-&gt;RtaUniqueNum
op_logical_and
op_logical_neg
id|MapP-&gt;HostUniqueNum
)paren
(brace
multiline_comment|/* (3) */
r_if
c_cond
(paren
id|MapP-&gt;ID
op_logical_or
id|MapP-&gt;SysPort
op_logical_or
id|MapP-&gt;Flags
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;%s pretending to be empty but isn&squot;t&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|TABLE_ENTRY_ISNT_PROPERLY_NULL
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;!RIO: Daemon: test (3) passes&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(4)&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|Host
op_assign
l_int|0
suffix:semicolon
id|Host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|Host
op_increment
)paren
(brace
multiline_comment|/* (4) */
r_if
c_cond
(paren
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|UniqueNum
op_eq
id|MapP-&gt;HostUniqueNum
)paren
(brace
id|HostP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|Host
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;** having done the lookup, we don&squot;t really want to do&n;&t;&t;&t;&t;** it again, so hang the host number in a safe place&n;&t;&t;&t;&t;*/
id|MapP-&gt;Topology
(braket
l_int|0
)braket
dot
id|Unit
op_assign
id|Host
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|Host
op_ge
id|p-&gt;RIONumHosts
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RTA %s has unknown host unique number 0x%x&bslash;n&quot;
comma
id|MapP-&gt;Name
comma
id|MapP-&gt;HostUniqueNum
)paren
suffix:semicolon
id|MapP-&gt;HostUniqueNum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* MapP-&gt;RtaUniqueNum&t;= 0; */
multiline_comment|/* MapP-&gt;ID&t;&t;&t;= 0; */
multiline_comment|/* MapP-&gt;Flags&t;&t; = 0; */
multiline_comment|/* MapP-&gt;SysPort&t;&t; = 0; */
multiline_comment|/* MapP-&gt;Name[0]&t;&t; = 0; */
r_continue
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(5)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MapP-&gt;RtaUniqueNum
)paren
(brace
multiline_comment|/* (5) */
r_if
c_cond
(paren
op_logical_neg
id|MapP-&gt;ID
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIO: RTA %s has been allocated an ID of zero!&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|ZERO_RTA_ID
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MapP-&gt;ID
OG
id|MAX_RUP
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIO: RTA %s has been allocated an illegal ID %d&bslash;n&quot;
comma
id|MapP-&gt;Name
comma
id|MapP-&gt;ID
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|ID_NUMBER_OUT_OF_RANGE
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
r_for
c_loop
(paren
id|SubEnt
op_assign
l_int|0
suffix:semicolon
id|SubEnt
OL
id|Entry
suffix:semicolon
id|SubEnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|MapP-&gt;HostUniqueNum
op_eq
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|HostUniqueNum
op_logical_and
id|MapP-&gt;ID
op_eq
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|ID
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Dupl. ID number allocated to RTA %s and RTA %s&bslash;n&quot;
comma
id|MapP-&gt;Name
comma
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|Name
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|DUPLICATED_RTA_ID
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
id|p-&gt;RIOError.Other
op_assign
id|SubEnt
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t;** If the RtaUniqueNum is the same, it may be looking at both&n;&t;&t;&t;&t;** entries for a 16 port RTA, so check the ids&n;&t;&t;&t;&t;*/
r_if
c_cond
(paren
(paren
id|MapP-&gt;RtaUniqueNum
op_eq
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|RtaUniqueNum
)paren
op_logical_and
(paren
id|MapP-&gt;ID2
op_ne
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|ID
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RTA %s has duplicate unique number&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RTA %s has duplicate unique number&bslash;n&quot;
comma
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|Name
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|DUPLICATE_UNIQUE_NUMBER
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
id|p-&gt;RIOError.Other
op_assign
id|SubEnt
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(7a)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* (7a) */
r_if
c_cond
(paren
(paren
id|MapP-&gt;SysPort
op_ne
id|NO_PORT
)paren
op_logical_and
(paren
id|MapP-&gt;SysPort
op_mod
id|PORTS_PER_RTA
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;TTY Port number %d-RTA %s is not a multiple of %d!&bslash;n&quot;
comma
(paren
r_int
)paren
id|MapP-&gt;SysPort
comma
id|MapP-&gt;Name
comma
id|PORTS_PER_RTA
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|TTY_NUMBER_OUT_OF_RANGE
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(7b)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* (7b) */
r_if
c_cond
(paren
(paren
id|MapP-&gt;SysPort
op_ne
id|NO_PORT
)paren
op_logical_and
(paren
id|MapP-&gt;SysPort
op_ge
id|RIO_PORTS
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;TTY Port number %d for RTA %s is too big&bslash;n&quot;
comma
(paren
r_int
)paren
id|MapP-&gt;SysPort
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|TTY_NUMBER_OUT_OF_RANGE
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
r_for
c_loop
(paren
id|SubEnt
op_assign
l_int|0
suffix:semicolon
id|SubEnt
OL
id|Entry
suffix:semicolon
id|SubEnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|RtaUniqueNum
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(8)&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* (8) */
r_if
c_cond
(paren
(paren
id|MapP-&gt;SysPort
op_ne
id|NO_PORT
)paren
op_logical_and
(paren
id|MapP-&gt;SysPort
op_eq
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|SysPort
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RTA %s:same TTY port # as RTA %s (%d)&bslash;n&quot;
comma
id|MapP-&gt;Name
comma
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|Name
comma
(paren
r_int
)paren
id|MapP-&gt;SysPort
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|TTY_NUMBER_IN_USE
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
id|p-&gt;RIOError.Other
op_assign
id|SubEnt
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(9)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RIOStrCmp
c_func
(paren
id|MapP-&gt;Name
comma
id|p-&gt;RIOConnectTable
(braket
id|SubEnt
)braket
dot
id|Name
)paren
op_eq
l_int|0
op_logical_and
op_logical_neg
(paren
id|MapP-&gt;Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
)paren
(brace
multiline_comment|/* (9) */
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RTA name %s used twice&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|NAME_USED_TWICE
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
id|p-&gt;RIOError.Other
op_assign
id|SubEnt
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* (6) */
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: entering(6)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MapP-&gt;ID
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIO:HOST %s has been allocated ID that isn&squot;t zero!&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|HOST_ID_NOT_ZERO
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MapP-&gt;SysPort
op_ne
id|NO_PORT
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIO: HOST %s has been allocated port numbers!&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|HOST_SYSPORT_BAD
suffix:semicolon
id|p-&gt;RIOError.Entry
op_assign
id|Entry
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t;** wow! if we get here then its a goody!&n;&t;*/
multiline_comment|/*&n;&t;** Zero the (old) entries for each host...&n;&t;*/
r_for
c_loop
(paren
id|Host
op_assign
l_int|0
suffix:semicolon
id|Host
OL
id|RIO_HOSTS
suffix:semicolon
id|Host
op_increment
)paren
(brace
r_for
c_loop
(paren
id|Entry
op_assign
l_int|0
suffix:semicolon
id|Entry
OL
id|MAX_RUP
suffix:semicolon
id|Entry
op_increment
)paren
(brace
id|bzero
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Mapping
(braket
id|Entry
)braket
comma
r_sizeof
(paren
r_struct
id|Map
)paren
)paren
suffix:semicolon
)brace
id|bzero
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** Copy in the new table entries&n;&t;*/
r_for
c_loop
(paren
id|Entry
op_assign
l_int|0
suffix:semicolon
id|Entry
OL
id|TOTAL_MAP_ENTRIES
suffix:semicolon
id|Entry
op_increment
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RIONewTable: Copy table for Host entry %d&bslash;n&quot;
comma
id|Entry
)paren
suffix:semicolon
id|MapP
op_assign
op_amp
id|p-&gt;RIOConnectTable
(braket
id|Entry
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Now, if it is an empty slot ignore it!&n;&t;&t;*/
r_if
c_cond
(paren
id|MapP-&gt;HostUniqueNum
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t;** we saved the host number earlier, so grab it back&n;&t;&t;*/
id|HostP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|MapP-&gt;Topology
(braket
l_int|0
)braket
dot
id|Unit
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t;** If it is a host, then we only need to fill in the name field.&n;&t;&t;*/
r_if
c_cond
(paren
id|MapP-&gt;ID
op_eq
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Host entry found. Name %s&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
id|bcopy
c_func
(paren
id|MapP-&gt;Name
comma
id|HostP-&gt;Name
comma
id|MAX_NAME_LEN
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;** Its an RTA entry, so fill in the host mapping entries for it&n;&t;&t;** and the port mapping entries. Notice that entry zero is for&n;&t;&t;** ID one.&n;&t;&t;*/
id|HostMapP
op_assign
op_amp
id|HostP-&gt;Mapping
(braket
id|MapP-&gt;ID
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|MapP-&gt;Flags
op_amp
id|SLOT_IN_USE
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Rta entry found. Name %s&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;** structure assign, then sort out the bits we shouldn&squot;t have done&n;&t;&t;&t;*/
op_star
id|HostMapP
op_assign
op_star
id|MapP
suffix:semicolon
id|HostMapP-&gt;Flags
op_assign
id|SLOT_IN_USE
suffix:semicolon
r_if
c_cond
(paren
id|MapP-&gt;Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
id|HostMapP-&gt;Flags
op_or_assign
id|RTA16_SECOND_SLOT
suffix:semicolon
id|RIOReMapPorts
c_func
(paren
id|p
comma
id|HostP
comma
id|HostMapP
)paren
suffix:semicolon
)brace
r_else
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;TENTATIVE Rta entry found. Name %s&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|Entry
op_assign
l_int|0
suffix:semicolon
id|Entry
OL
id|TOTAL_MAP_ENTRIES
suffix:semicolon
id|Entry
op_increment
)paren
(brace
id|p-&gt;RIOSavedTable
(braket
id|Entry
)braket
op_assign
id|p-&gt;RIOConnectTable
(braket
id|Entry
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|Host
op_assign
l_int|0
suffix:semicolon
id|Host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|Host
op_increment
)paren
(brace
r_for
c_loop
(paren
id|SubEnt
op_assign
l_int|0
suffix:semicolon
id|SubEnt
OL
id|LINKS_PER_UNIT
suffix:semicolon
id|SubEnt
op_increment
)paren
(brace
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Topology
(braket
id|SubEnt
)braket
dot
id|Unit
op_assign
id|ROUTE_DISCONNECT
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Topology
(braket
id|SubEnt
)braket
dot
id|Link
op_assign
id|NO_LINK
suffix:semicolon
)brace
r_for
c_loop
(paren
id|Entry
op_assign
l_int|0
suffix:semicolon
id|Entry
OL
id|MAX_RUP
suffix:semicolon
id|Entry
op_increment
)paren
(brace
r_for
c_loop
(paren
id|SubEnt
op_assign
l_int|0
suffix:semicolon
id|SubEnt
OL
id|LINKS_PER_UNIT
suffix:semicolon
id|SubEnt
op_increment
)paren
(brace
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Mapping
(braket
id|Entry
)braket
dot
id|Topology
(braket
id|SubEnt
)braket
dot
id|Unit
op_assign
id|ROUTE_DISCONNECT
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Mapping
(braket
id|Entry
)braket
dot
id|Topology
(braket
id|SubEnt
)braket
dot
id|Link
op_assign
id|NO_LINK
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
(braket
l_int|0
)braket
)paren
(brace
id|bcopy
c_func
(paren
l_string|&quot;HOST 1&quot;
comma
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
comma
l_int|7
)paren
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
(braket
l_int|5
)braket
op_add_assign
id|Host
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;** Check that default name assigned is unique.&n;&t;&t;*/
id|Host1
op_assign
id|Host
suffix:semicolon
id|NameIsUnique
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|NameIsUnique
)paren
(brace
id|NameIsUnique
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|Host2
op_assign
l_int|0
suffix:semicolon
id|Host2
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|Host2
op_increment
)paren
(brace
r_if
c_cond
(paren
id|Host2
op_eq
id|Host
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|RIOStrCmp
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
comma
id|p-&gt;RIOHosts
(braket
id|Host2
)braket
dot
id|Name
)paren
op_eq
l_int|0
)paren
(brace
id|NameIsUnique
op_assign
l_int|0
suffix:semicolon
id|Host1
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|Host1
op_ge
id|p-&gt;RIONumHosts
)paren
id|Host1
op_assign
l_int|0
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
(braket
l_int|5
)braket
op_assign
l_char|&squot;1&squot;
op_plus
id|Host1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t;&t;** Rename host if name already used.&n;&t;&t;*/
r_if
c_cond
(paren
id|Host1
op_ne
id|Host
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Default name %s already used&bslash;n&quot;
comma
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
)paren
suffix:semicolon
id|bcopy
c_func
(paren
l_string|&quot;HOST 1&quot;
comma
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
comma
l_int|7
)paren
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
(braket
l_int|5
)braket
op_add_assign
id|Host1
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Assigning default name %s&bslash;n&quot;
comma
id|p-&gt;RIOHosts
(braket
id|Host
)braket
dot
id|Name
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** User process needs the config table - build it from first&n;** principles.&n;*/
r_int
DECL|function|RIOApel
id|RIOApel
c_func
(paren
id|p
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
(brace
r_int
id|Host
suffix:semicolon
r_int
id|link
suffix:semicolon
r_int
id|Rup
suffix:semicolon
r_int
id|Next
op_assign
l_int|0
suffix:semicolon
r_struct
id|Map
op_star
id|MapP
suffix:semicolon
r_struct
id|Host
op_star
id|HostP
suffix:semicolon
r_int
id|oldspl
suffix:semicolon
id|disable
c_func
(paren
id|oldspl
)paren
suffix:semicolon
multiline_comment|/* strange but true! */
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Generating a table to return to config.rio&bslash;n&quot;
)paren
suffix:semicolon
id|bzero
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|p-&gt;RIOConnectTable
(braket
l_int|0
)braket
comma
r_sizeof
(paren
r_struct
id|Map
)paren
op_star
id|TOTAL_MAP_ENTRIES
)paren
suffix:semicolon
r_for
c_loop
(paren
id|Host
op_assign
l_int|0
suffix:semicolon
id|Host
OL
id|RIO_HOSTS
suffix:semicolon
id|Host
op_increment
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Processing host %d&bslash;n&quot;
comma
id|Host
)paren
suffix:semicolon
id|HostP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|Host
)braket
suffix:semicolon
id|MapP
op_assign
op_amp
id|p-&gt;RIOConnectTable
(braket
id|Next
op_increment
)braket
suffix:semicolon
id|MapP-&gt;HostUniqueNum
op_assign
id|HostP-&gt;UniqueNum
suffix:semicolon
r_if
c_cond
(paren
(paren
id|HostP-&gt;Flags
op_amp
id|RUN_STATE
)paren
op_ne
id|RC_RUNNING
)paren
r_continue
suffix:semicolon
id|MapP-&gt;RtaUniqueNum
op_assign
l_int|0
suffix:semicolon
id|MapP-&gt;ID
op_assign
l_int|0
suffix:semicolon
id|MapP-&gt;Flags
op_assign
id|SLOT_IN_USE
suffix:semicolon
id|MapP-&gt;SysPort
op_assign
id|NO_PORT
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
l_int|0
suffix:semicolon
id|link
OL
id|LINKS_PER_UNIT
suffix:semicolon
id|link
op_increment
)paren
id|MapP-&gt;Topology
(braket
id|link
)braket
op_assign
id|HostP-&gt;Topology
(braket
id|link
)braket
suffix:semicolon
id|bcopy
c_func
(paren
id|HostP-&gt;Name
comma
id|MapP-&gt;Name
comma
id|MAX_NAME_LEN
)paren
suffix:semicolon
r_for
c_loop
(paren
id|Rup
op_assign
l_int|0
suffix:semicolon
id|Rup
OL
id|MAX_RUP
suffix:semicolon
id|Rup
op_increment
)paren
(brace
r_if
c_cond
(paren
id|HostP-&gt;Mapping
(braket
id|Rup
)braket
dot
id|Flags
op_amp
(paren
id|SLOT_IN_USE
op_or
id|SLOT_TENTATIVE
)paren
)paren
(brace
id|p-&gt;RIOConnectTable
(braket
id|Next
)braket
op_assign
id|HostP-&gt;Mapping
(braket
id|Rup
)braket
suffix:semicolon
r_if
c_cond
(paren
id|HostP-&gt;Mapping
(braket
id|Rup
)braket
dot
id|Flags
op_amp
id|SLOT_IN_USE
)paren
id|p-&gt;RIOConnectTable
(braket
id|Next
)braket
dot
id|Flags
op_or_assign
id|SLOT_IN_USE
suffix:semicolon
r_if
c_cond
(paren
id|HostP-&gt;Mapping
(braket
id|Rup
)braket
dot
id|Flags
op_amp
id|SLOT_TENTATIVE
)paren
id|p-&gt;RIOConnectTable
(braket
id|Next
)braket
dot
id|Flags
op_or_assign
id|SLOT_TENTATIVE
suffix:semicolon
r_if
c_cond
(paren
id|HostP-&gt;Mapping
(braket
id|Rup
)braket
dot
id|Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
id|p-&gt;RIOConnectTable
(braket
id|Next
)braket
dot
id|Flags
op_or_assign
id|RTA16_SECOND_SLOT
suffix:semicolon
id|Next
op_increment
suffix:semicolon
)brace
)brace
)brace
id|restore
c_func
(paren
id|oldspl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** config.rio has taken a dislike to one of the gross maps entries.&n;** if the entry is suitably inactive, then we can gob on it and remove&n;** it from the table.&n;*/
r_int
DECL|function|RIODeleteRta
id|RIODeleteRta
c_func
(paren
id|p
comma
id|MapP
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_struct
id|Map
op_star
id|MapP
suffix:semicolon
(brace
r_int
id|host
comma
id|entry
comma
id|port
comma
id|link
suffix:semicolon
r_int
id|SysPort
suffix:semicolon
r_struct
id|Host
op_star
id|HostP
suffix:semicolon
r_struct
id|Map
op_star
id|HostMapP
suffix:semicolon
r_struct
id|Port
op_star
id|PortP
suffix:semicolon
r_int
id|work_done
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Delete entry on host %x, rta %x&bslash;n&quot;
comma
id|MapP-&gt;HostUniqueNum
comma
id|MapP-&gt;RtaUniqueNum
)paren
suffix:semicolon
r_for
c_loop
(paren
id|host
op_assign
l_int|0
suffix:semicolon
id|host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|host
op_increment
)paren
(brace
id|HostP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
suffix:semicolon
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|HostP-&gt;HostLock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|HostP-&gt;Flags
op_amp
id|RUN_STATE
)paren
op_ne
id|RC_RUNNING
)paren
(brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|HostP-&gt;HostLock
comma
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|MAX_RUP
suffix:semicolon
id|entry
op_increment
)paren
(brace
r_if
c_cond
(paren
id|MapP-&gt;RtaUniqueNum
op_eq
id|HostP-&gt;Mapping
(braket
id|entry
)braket
dot
id|RtaUniqueNum
)paren
(brace
id|HostMapP
op_assign
op_amp
id|HostP-&gt;Mapping
(braket
id|entry
)braket
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Found entry offset %d on host %s&bslash;n&quot;
comma
id|entry
comma
id|HostP-&gt;Name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t;** Check all four links of the unit are disconnected&n;&t;&t;&t;&t;*/
r_for
c_loop
(paren
id|link
op_assign
l_int|0
suffix:semicolon
id|link
OL
id|LINKS_PER_UNIT
suffix:semicolon
id|link
op_increment
)paren
(brace
r_if
c_cond
(paren
id|HostMapP-&gt;Topology
(braket
id|link
)braket
dot
id|Unit
op_ne
id|ROUTE_DISCONNECT
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Entry is in use and cannot be deleted!&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|UNIT_IS_IN_USE
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|HostP-&gt;HostLock
comma
id|flags
)paren
suffix:semicolon
r_return
id|EBUSY
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t;&t;&t;** Slot has been allocated, BUT not booted/routed/&n;&t;&t;&t;&t;** connected/selected or anything else-ed&n;&t;&t;&t;&t;*/
id|SysPort
op_assign
id|HostMapP-&gt;SysPort
suffix:semicolon
r_if
c_cond
(paren
id|SysPort
op_ne
id|NO_PORT
)paren
(brace
r_for
c_loop
(paren
id|port
op_assign
id|SysPort
suffix:semicolon
id|port
OL
id|SysPort
op_plus
id|PORTS_PER_RTA
suffix:semicolon
id|port
op_increment
)paren
(brace
id|PortP
op_assign
id|p-&gt;RIOPortp
(braket
id|port
)braket
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Unmap port&bslash;n&quot;
)paren
suffix:semicolon
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|PortP-&gt;Mapped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|PortP-&gt;State
op_amp
(paren
id|RIO_MOPEN
op_or
id|RIO_LOPEN
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Gob on port&bslash;n&quot;
)paren
suffix:semicolon
id|PortP-&gt;TxBufferIn
op_assign
id|PortP-&gt;TxBufferOut
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* What should I do &n;&t;&t;&t;&t;&t;&t;&t;wakeup( &amp;PortP-&gt;TxBufferIn );&n;&t;&t;&t;&t;&t;&t;&t;wakeup( &amp;PortP-&gt;TxBufferOut);&n;&t;&t;&t;&t;&t;&t;&t;*/
id|PortP-&gt;InUse
op_assign
id|NOT_INUSE
suffix:semicolon
multiline_comment|/* What should I do &n;&t;&t;&t;&t;&t;&t;&t;wakeup( &amp;PortP-&gt;InUse );&n;&t;&t;&t;&t;&t;&t;&t;signal(PortP-&gt;TtyP-&gt;t_pgrp,SIGKILL);&n;&t;&t;&t;&t;&t;&t;&t;ttyflush(PortP-&gt;TtyP,(FREAD|FWRITE));&n;&t;&t;&t;&t;&t;&t;&t;*/
id|PortP-&gt;State
op_or_assign
id|RIO_CLOSING
op_or
id|RIO_DELETED
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;** For the second slot of a 16 port RTA, the&n;&t;&t;&t;&t;&t;&t;** driver needs to reset the changes made to&n;&t;&t;&t;&t;&t;&t;** the phb to port mappings in RIORouteRup.&n;&t;&t;&t;&t;&t;&t;*/
r_if
c_cond
(paren
id|PortP-&gt;SecondBlock
)paren
(brace
id|ushort
id|dest_unit
op_assign
id|HostMapP-&gt;ID
suffix:semicolon
id|ushort
id|dest_port
op_assign
id|port
op_minus
id|SysPort
suffix:semicolon
id|WORD
op_star
id|TxPktP
suffix:semicolon
id|PKT
op_star
id|Pkt
suffix:semicolon
r_for
c_loop
(paren
id|TxPktP
op_assign
id|PortP-&gt;TxStart
suffix:semicolon
id|TxPktP
op_le
id|PortP-&gt;TxEnd
suffix:semicolon
id|TxPktP
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t;&t;&t;&t;** *TxPktP is the pointer to the&n;&t;&t;&t;&t;&t;&t;&t;&t;** transmit packet on the host card.&n;&t;&t;&t;&t;&t;&t;&t;&t;** This needs to be translated into&n;&t;&t;&t;&t;&t;&t;&t;&t;** a 32 bit pointer so it can be&n;&t;&t;&t;&t;&t;&t;&t;&t;** accessed from the driver.&n;&t;&t;&t;&t;&t;&t;&t;&t;*/
id|Pkt
op_assign
(paren
id|PKT
op_star
)paren
id|RIO_PTR
c_func
(paren
id|HostP-&gt;Caddr
comma
id|RWORD
c_func
(paren
op_star
id|TxPktP
)paren
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Tx packet (%x) destination: Old %x:%x New %x:%x&bslash;n&quot;
comma
op_star
id|TxPktP
comma
id|Pkt-&gt;dest_unit
comma
id|Pkt-&gt;dest_port
comma
id|dest_unit
comma
id|dest_port
)paren
suffix:semicolon
id|WWORD
c_func
(paren
id|Pkt-&gt;dest_unit
comma
id|dest_unit
)paren
suffix:semicolon
id|WWORD
c_func
(paren
id|Pkt-&gt;dest_port
comma
id|dest_port
)paren
suffix:semicolon
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Port %d phb destination: Old %x:%x New %x:%x&bslash;n&quot;
comma
id|port
comma
id|PortP-&gt;PhbP-&gt;destination
op_amp
l_int|0xff
comma
(paren
id|PortP-&gt;PhbP-&gt;destination
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
id|dest_unit
comma
id|dest_port
)paren
suffix:semicolon
id|WWORD
c_func
(paren
id|PortP-&gt;PhbP-&gt;destination
comma
id|dest_unit
op_plus
(paren
id|dest_port
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
)brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Entry nulled.&bslash;n&quot;
)paren
suffix:semicolon
id|bzero
c_func
(paren
(paren
r_char
op_star
)paren
id|HostMapP
comma
r_sizeof
(paren
r_struct
id|Map
)paren
)paren
suffix:semicolon
id|work_done
op_increment
suffix:semicolon
)brace
)brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|HostP-&gt;HostLock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* XXXXX lock me up */
r_for
c_loop
(paren
id|entry
op_assign
l_int|0
suffix:semicolon
id|entry
OL
id|TOTAL_MAP_ENTRIES
suffix:semicolon
id|entry
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;RIOSavedTable
(braket
id|entry
)braket
dot
id|RtaUniqueNum
op_eq
id|MapP-&gt;RtaUniqueNum
)paren
(brace
id|bzero
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|p-&gt;RIOSavedTable
(braket
id|entry
)braket
comma
r_sizeof
(paren
r_struct
id|Map
)paren
)paren
suffix:semicolon
id|work_done
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;RIOConnectTable
(braket
id|entry
)braket
dot
id|RtaUniqueNum
op_eq
id|MapP-&gt;RtaUniqueNum
)paren
(brace
id|bzero
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|p-&gt;RIOConnectTable
(braket
id|entry
)braket
comma
r_sizeof
(paren
r_struct
id|Map
)paren
)paren
suffix:semicolon
id|work_done
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|work_done
)paren
r_return
l_int|0
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Couldn&squot;t find entry to be deleted&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|COULDNT_FIND_ENTRY
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
DECL|function|RIOAssignRta
r_int
id|RIOAssignRta
c_func
(paren
r_struct
id|rio_info
op_star
id|p
comma
r_struct
id|Map
op_star
id|MapP
)paren
(brace
r_int
id|host
suffix:semicolon
r_struct
id|Map
op_star
id|HostMapP
suffix:semicolon
r_char
op_star
id|sptr
suffix:semicolon
r_int
id|link
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Assign entry on host %x, rta %x, ID %d, Sysport %d&bslash;n&quot;
comma
id|MapP-&gt;HostUniqueNum
comma
id|MapP-&gt;RtaUniqueNum
comma
id|MapP-&gt;ID
comma
(paren
r_int
)paren
id|MapP-&gt;SysPort
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|MapP-&gt;ID
op_ne
(paren
id|ushort
)paren
op_minus
l_int|1
)paren
op_logical_and
(paren
(paren
r_int
)paren
id|MapP-&gt;ID
template_param
id|MAX_RUP
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Bad ID in map entry!&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|ID_NUMBER_OUT_OF_RANGE
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MapP-&gt;RtaUniqueNum
op_eq
l_int|0
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Rta Unique number zero!&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|RTA_UNIQUE_NUMBER_ZERO
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|MapP-&gt;SysPort
op_ne
id|NO_PORT
)paren
op_logical_and
(paren
id|MapP-&gt;SysPort
op_mod
id|PORTS_PER_RTA
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Port %d not multiple of %d!&bslash;n&quot;
comma
(paren
r_int
)paren
id|MapP-&gt;SysPort
comma
id|PORTS_PER_RTA
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|TTY_NUMBER_OUT_OF_RANGE
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|MapP-&gt;SysPort
op_ne
id|NO_PORT
)paren
op_logical_and
(paren
id|MapP-&gt;SysPort
op_ge
id|RIO_PORTS
)paren
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Port %d not valid!&bslash;n&quot;
comma
(paren
r_int
)paren
id|MapP-&gt;SysPort
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|TTY_NUMBER_OUT_OF_RANGE
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;    ** Copy the name across to the map entry.&n;    */
id|MapP-&gt;Name
(braket
id|MAX_NAME_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|sptr
op_assign
id|MapP-&gt;Name
suffix:semicolon
r_while
c_loop
(paren
op_star
id|sptr
)paren
(brace
r_if
c_cond
(paren
op_star
id|sptr
l_char|&squot;~&squot;
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Name entry contains non-printing characters!&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|BAD_CHARACTER_IN_NAME
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
id|sptr
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
id|host
op_assign
l_int|0
suffix:semicolon
id|host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|host
op_increment
)paren
(brace
r_if
c_cond
(paren
id|MapP-&gt;HostUniqueNum
op_eq
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|UniqueNum
)paren
(brace
r_if
c_cond
(paren
(paren
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Flags
op_amp
id|RUN_STATE
)paren
op_ne
id|RC_RUNNING
)paren
(brace
id|p-&gt;RIOError.Error
op_assign
id|HOST_NOT_RUNNING
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t;    ** Now we have a host we need to allocate an ID&n;&t;    ** if the the entry does not already have one.&n;&t;    */
r_if
c_cond
(paren
id|MapP-&gt;ID
op_eq
(paren
id|ushort
)paren
op_minus
l_int|1
)paren
(brace
r_int
id|nNewID
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Attempting to get a new ID for rta &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** The idea here is to allow RTA&squot;s to be assigned&n;&t;&t;** before they actually appear on the network.&n;&t;&t;** This allows the addition of RTA&squot;s without having&n;&t;&t;** to plug them in.&n;&t;&t;** What we do is:&n;&t;&t;**  - Find a free ID and allocate it to the RTA.&n;&t;&t;**  - If this map entry is the second half of a&n;&t;&t;**    16 port entry then find the other half and&n;&t;&t;**    make sure the 2 cross reference each other.&n;&t;&t;*/
r_if
c_cond
(paren
id|RIOFindFreeID
c_func
(paren
id|p
comma
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
comma
op_amp
id|nNewID
comma
l_int|NULL
)paren
op_ne
l_int|0
)paren
(brace
id|p-&gt;RIOError.Error
op_assign
id|COULDNT_FIND_ENTRY
suffix:semicolon
r_return
id|EBUSY
suffix:semicolon
)brace
id|MapP-&gt;ID
op_assign
(paren
id|ushort
)paren
id|nNewID
op_plus
l_int|1
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Allocated ID %d for this new RTA.&bslash;n&quot;
comma
id|MapP-&gt;ID
)paren
suffix:semicolon
id|HostMapP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Mapping
(braket
id|nNewID
)braket
suffix:semicolon
id|HostMapP-&gt;RtaUniqueNum
op_assign
id|MapP-&gt;RtaUniqueNum
suffix:semicolon
id|HostMapP-&gt;HostUniqueNum
op_assign
id|MapP-&gt;HostUniqueNum
suffix:semicolon
id|HostMapP-&gt;ID
op_assign
id|MapP-&gt;ID
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
l_int|0
suffix:semicolon
id|link
OL
id|LINKS_PER_UNIT
suffix:semicolon
id|link
op_increment
)paren
(brace
id|HostMapP-&gt;Topology
(braket
id|link
)braket
dot
id|Unit
op_assign
id|ROUTE_DISCONNECT
suffix:semicolon
id|HostMapP-&gt;Topology
(braket
id|link
)braket
dot
id|Link
op_assign
id|NO_LINK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MapP-&gt;Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
(brace
r_int
id|unit
suffix:semicolon
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|MAX_RUP
suffix:semicolon
id|unit
op_increment
)paren
r_if
c_cond
(paren
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Mapping
(braket
id|unit
)braket
dot
id|RtaUniqueNum
op_eq
id|MapP-&gt;RtaUniqueNum
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|unit
op_eq
id|MAX_RUP
)paren
(brace
id|p-&gt;RIOError.Error
op_assign
id|COULDNT_FIND_ENTRY
suffix:semicolon
r_return
id|EBUSY
suffix:semicolon
)brace
id|HostMapP-&gt;Flags
op_or_assign
id|RTA16_SECOND_SLOT
suffix:semicolon
id|HostMapP-&gt;ID2
op_assign
id|MapP-&gt;ID2
op_assign
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Mapping
(braket
id|unit
)braket
dot
id|ID
suffix:semicolon
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Mapping
(braket
id|unit
)braket
dot
id|ID2
op_assign
id|MapP-&gt;ID
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Cross referenced id %d to ID %d.&bslash;n&quot;
comma
id|MapP-&gt;ID
comma
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Mapping
(braket
id|unit
)braket
dot
id|ID
)paren
suffix:semicolon
)brace
)brace
id|HostMapP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Mapping
(braket
id|MapP-&gt;ID
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|HostMapP-&gt;Flags
op_amp
id|SLOT_IN_USE
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Map table slot for ID %d is already in use.&bslash;n&quot;
comma
id|MapP-&gt;ID
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|ID_ALREADY_IN_USE
suffix:semicolon
r_return
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t;    ** Assign the sys ports and the name, and mark the slot as&n;&t;    ** being in use.&n;&t;    */
id|HostMapP-&gt;SysPort
op_assign
id|MapP-&gt;SysPort
suffix:semicolon
r_if
c_cond
(paren
(paren
id|MapP-&gt;Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
op_eq
l_int|0
)paren
id|CCOPY
c_func
(paren
id|MapP-&gt;Name
comma
id|HostMapP-&gt;Name
comma
id|MAX_NAME_LEN
)paren
suffix:semicolon
id|HostMapP-&gt;Flags
op_assign
id|SLOT_IN_USE
op_or
id|RTA_BOOTED
suffix:semicolon
macro_line|#if NEED_TO_FIX
id|RIO_SV_BROADCAST
c_func
(paren
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|svFlags
(braket
id|MapP-&gt;ID
op_minus
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|MapP-&gt;Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
id|HostMapP-&gt;Flags
op_or_assign
id|RTA16_SECOND_SLOT
suffix:semicolon
id|RIOReMapPorts
c_func
(paren
id|p
comma
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
comma
id|HostMapP
)paren
suffix:semicolon
multiline_comment|/*&n;&t;    ** Adjust 2nd block of 8 phbs&n;&t;    */
r_if
c_cond
(paren
id|MapP-&gt;Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
id|RIOFixPhbs
c_func
(paren
id|p
comma
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
comma
id|HostMapP-&gt;ID
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HostMapP-&gt;SysPort
op_ne
id|NO_PORT
)paren
(brace
r_if
c_cond
(paren
id|HostMapP-&gt;SysPort
OL
id|p-&gt;RIOFirstPortsBooted
)paren
id|p-&gt;RIOFirstPortsBooted
op_assign
id|HostMapP-&gt;SysPort
suffix:semicolon
r_if
c_cond
(paren
id|HostMapP-&gt;SysPort
OG
id|p-&gt;RIOLastPortsBooted
)paren
id|p-&gt;RIOLastPortsBooted
op_assign
id|HostMapP-&gt;SysPort
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MapP-&gt;Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Second map of RTA %s added to configuration&bslash;n&quot;
comma
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Mapping
(braket
id|MapP-&gt;ID2
op_minus
l_int|1
)braket
dot
id|Name
)paren
suffix:semicolon
r_else
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;RTA %s added to configuration&bslash;n&quot;
comma
id|MapP-&gt;Name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|p-&gt;RIOError.Error
op_assign
id|UNKNOWN_HOST_NUMBER
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Unknown host %x&bslash;n&quot;
comma
id|MapP-&gt;HostUniqueNum
)paren
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
r_int
DECL|function|RIOReMapPorts
id|RIOReMapPorts
c_func
(paren
id|p
comma
id|HostP
comma
id|HostMapP
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_struct
id|Host
op_star
id|HostP
suffix:semicolon
r_struct
id|Map
op_star
id|HostMapP
suffix:semicolon
(brace
r_register
r_struct
id|Port
op_star
id|PortP
suffix:semicolon
id|uint
id|SubEnt
suffix:semicolon
id|uint
id|HostPort
suffix:semicolon
id|uint
id|SysPort
suffix:semicolon
id|ushort
id|RtaType
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef CHECK
id|CheckHostP
c_func
(paren
id|HostP
)paren
suffix:semicolon
id|CheckHostMapP
c_func
(paren
id|HostMapP
)paren
suffix:semicolon
macro_line|#endif
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Mapping sysport %d to id %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|HostMapP-&gt;SysPort
comma
id|HostMapP-&gt;ID
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** We need to tell the UnixRups which sysport the rup corresponds to&n;&t;*/
id|HostP-&gt;UnixRups
(braket
id|HostMapP-&gt;ID
op_minus
l_int|1
)braket
dot
id|BaseSysPort
op_assign
id|HostMapP-&gt;SysPort
suffix:semicolon
r_if
c_cond
(paren
id|HostMapP-&gt;SysPort
op_eq
id|NO_PORT
)paren
r_return
l_int|0
suffix:semicolon
id|RtaType
op_assign
id|GetUnitType
c_func
(paren
id|HostMapP-&gt;RtaUniqueNum
)paren
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Mapping sysport %d-%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|HostMapP-&gt;SysPort
comma
(paren
r_int
)paren
id|HostMapP-&gt;SysPort
op_plus
id|PORTS_PER_RTA
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** now map each of its eight ports&n;&t;*/
r_for
c_loop
(paren
id|SubEnt
op_assign
l_int|0
suffix:semicolon
id|SubEnt
OL
id|PORTS_PER_RTA
suffix:semicolon
id|SubEnt
op_increment
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;subent = %d, HostMapP-&gt;SysPort = %d&bslash;n&quot;
comma
id|SubEnt
comma
(paren
r_int
)paren
id|HostMapP-&gt;SysPort
)paren
suffix:semicolon
id|SysPort
op_assign
id|HostMapP-&gt;SysPort
op_plus
id|SubEnt
suffix:semicolon
multiline_comment|/* portnumber within system */
multiline_comment|/* portnumber on host */
id|HostPort
op_assign
(paren
id|HostMapP-&gt;ID
op_minus
l_int|1
)paren
op_star
id|PORTS_PER_RTA
op_plus
id|SubEnt
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;c1 p = %p, p-&gt;rioPortp = %p&bslash;n&quot;
comma
id|p
comma
id|p-&gt;RIOPortp
)paren
suffix:semicolon
id|PortP
op_assign
id|p-&gt;RIOPortp
(braket
id|SysPort
)braket
suffix:semicolon
macro_line|#if 0
id|PortP-&gt;TtyP
op_assign
op_amp
id|p-&gt;channel
(braket
id|SysPort
)braket
suffix:semicolon
macro_line|#endif
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Map port&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Point at all the real neat data structures&n;&t;&t;*/
id|rio_spin_lock_irqsave
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
id|PortP-&gt;HostP
op_assign
id|HostP
suffix:semicolon
id|PortP-&gt;Caddr
op_assign
id|HostP-&gt;Caddr
suffix:semicolon
multiline_comment|/*&n;&t;&t;** The PhbP cannot be filled in yet&n;&t;&t;** unless the host has been booted&n;&t;&t;*/
r_if
c_cond
(paren
(paren
id|HostP-&gt;Flags
op_amp
id|RUN_STATE
)paren
op_eq
id|RC_RUNNING
)paren
(brace
r_struct
id|PHB
op_star
id|PhbP
op_assign
id|PortP-&gt;PhbP
op_assign
op_amp
id|HostP-&gt;PhbP
(braket
id|HostPort
)braket
suffix:semicolon
id|PortP-&gt;TxAdd
op_assign
(paren
id|WORD
op_star
)paren
id|RIO_PTR
c_func
(paren
id|HostP-&gt;Caddr
comma
id|RWORD
c_func
(paren
id|PhbP-&gt;tx_add
)paren
)paren
suffix:semicolon
id|PortP-&gt;TxStart
op_assign
(paren
id|WORD
op_star
)paren
id|RIO_PTR
c_func
(paren
id|HostP-&gt;Caddr
comma
id|RWORD
c_func
(paren
id|PhbP-&gt;tx_start
)paren
)paren
suffix:semicolon
id|PortP-&gt;TxEnd
op_assign
(paren
id|WORD
op_star
)paren
id|RIO_PTR
c_func
(paren
id|HostP-&gt;Caddr
comma
id|RWORD
c_func
(paren
id|PhbP-&gt;tx_end
)paren
)paren
suffix:semicolon
id|PortP-&gt;RxRemove
op_assign
(paren
id|WORD
op_star
)paren
id|RIO_PTR
c_func
(paren
id|HostP-&gt;Caddr
comma
id|RWORD
c_func
(paren
id|PhbP-&gt;rx_remove
)paren
)paren
suffix:semicolon
id|PortP-&gt;RxStart
op_assign
(paren
id|WORD
op_star
)paren
id|RIO_PTR
c_func
(paren
id|HostP-&gt;Caddr
comma
id|RWORD
c_func
(paren
id|PhbP-&gt;rx_start
)paren
)paren
suffix:semicolon
id|PortP-&gt;RxEnd
op_assign
(paren
id|WORD
op_star
)paren
id|RIO_PTR
c_func
(paren
id|HostP-&gt;Caddr
comma
id|RWORD
c_func
(paren
id|PhbP-&gt;rx_end
)paren
)paren
suffix:semicolon
)brace
r_else
id|PortP-&gt;PhbP
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t;&t;** port related flags&n;&t;&t;*/
id|PortP-&gt;HostPort
op_assign
id|HostPort
suffix:semicolon
multiline_comment|/*&n;&t;&t;** For each part of a 16 port RTA, RupNum is ID - 1.&n;&t;&t;*/
id|PortP-&gt;RupNum
op_assign
id|HostMapP-&gt;ID
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|HostMapP-&gt;Flags
op_amp
id|RTA16_SECOND_SLOT
)paren
(brace
id|PortP-&gt;ID2
op_assign
id|HostMapP-&gt;ID2
op_minus
l_int|1
suffix:semicolon
id|PortP-&gt;SecondBlock
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|PortP-&gt;ID2
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;SecondBlock
op_assign
id|FALSE
suffix:semicolon
)brace
id|PortP-&gt;RtaUniqueNum
op_assign
id|HostMapP-&gt;RtaUniqueNum
suffix:semicolon
multiline_comment|/*&n;&t;&t;** If the port was already mapped then thats all we need to do.&n;&t;&t;*/
r_if
c_cond
(paren
id|PortP-&gt;Mapped
)paren
(brace
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
id|HostMapP-&gt;Flags
op_and_assign
op_complement
id|RTA_NEWBOOT
suffix:semicolon
id|PortP-&gt;State
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;Config
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Check out the module type - if it is special (read only etc.)&n;&t;&t;** then we need to set flags in the PortP-&gt;Config.&n;&t;&t;** Note: For 16 port RTA, all ports are of the same type.&n;&t;&t;*/
r_if
c_cond
(paren
id|RtaType
op_eq
id|TYPE_RTA16
)paren
(brace
id|PortP-&gt;Config
op_or_assign
id|p-&gt;RIOModuleTypes
(braket
id|HostP-&gt;UnixRups
(braket
id|HostMapP-&gt;ID
op_minus
l_int|1
)braket
dot
id|ModTypes
)braket
dot
id|Flags
(braket
id|SubEnt
op_mod
id|PORTS_PER_MODULE
)braket
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|SubEnt
OL
id|PORTS_PER_MODULE
)paren
id|PortP-&gt;Config
op_or_assign
id|p-&gt;RIOModuleTypes
(braket
id|LONYBLE
c_func
(paren
id|HostP-&gt;UnixRups
(braket
id|HostMapP-&gt;ID
op_minus
l_int|1
)braket
dot
id|ModTypes
)paren
)braket
dot
id|Flags
(braket
id|SubEnt
op_mod
id|PORTS_PER_MODULE
)braket
suffix:semicolon
r_else
id|PortP-&gt;Config
op_or_assign
id|p-&gt;RIOModuleTypes
(braket
id|HINYBLE
c_func
(paren
id|HostP-&gt;UnixRups
(braket
id|HostMapP-&gt;ID
op_minus
l_int|1
)braket
dot
id|ModTypes
)paren
)braket
dot
id|Flags
(braket
id|SubEnt
op_mod
id|PORTS_PER_MODULE
)braket
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;** more port related flags&n;&t;&t;*/
id|PortP-&gt;PortState
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;ModemLines
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;ModemState
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;CookMode
op_assign
id|COOK_WELL
suffix:semicolon
id|PortP-&gt;ParamSem
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;FlushCmdBodge
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;WflushFlag
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;MagicFlags
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;Lock
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;Store
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;FirstOpen
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;** handle the xprint issues&n;&t;&t;*/
macro_line|#ifdef XPRINT_SUPPORT
id|PortP-&gt;Xprint.XpActive
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;Xprint.XttyP
op_assign
op_amp
id|riox_tty
(braket
id|SysPort
)braket
suffix:semicolon
multiline_comment|/*&t;&t;&t;&t;TO&t;&t;&t;&t;FROM&t;&t;&t;MAXLEN */
id|RIOStrNCpy
c_func
(paren
id|PortP-&gt;Xprint.XpOn
comma
id|RIOConf.XpOn
comma
id|MAX_XP_CTRL_LEN
)paren
suffix:semicolon
id|RIOStrNCpy
c_func
(paren
id|PortP-&gt;Xprint.XpOff
comma
id|RIOConf.XpOff
comma
id|MAX_XP_CTRL_LEN
)paren
suffix:semicolon
id|PortP-&gt;Xprint.XpCps
op_assign
id|RIOConf.XpCps
suffix:semicolon
id|PortP-&gt;Xprint.XpLen
op_assign
id|RIOStrlen
c_func
(paren
id|PortP-&gt;Xprint.XpOn
)paren
op_plus
id|RIOStrlen
c_func
(paren
id|PortP-&gt;Xprint.XpOff
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t;** Buffers &squot;n things&n;&t;&t;*/
id|PortP-&gt;RxDataStart
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;Cor2Copy
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;Name
op_assign
op_amp
id|HostMapP-&gt;Name
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#ifdef STATS
id|bzero
c_func
(paren
(paren
id|caddr_t
)paren
op_amp
id|PortP-&gt;Stat
comma
r_sizeof
(paren
r_struct
id|RIOStats
)paren
)paren
suffix:semicolon
macro_line|#endif
id|PortP-&gt;statsGather
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;txchars
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;rxchars
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;opens
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;closes
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;ioctls
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|PortP-&gt;TxRingBuffer
)paren
id|bzero
c_func
(paren
id|PortP-&gt;TxRingBuffer
comma
id|p-&gt;RIOBufferSize
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|p-&gt;RIOBufferSize
)paren
(brace
id|PortP-&gt;TxRingBuffer
op_assign
id|sysbrk
c_func
(paren
id|p-&gt;RIOBufferSize
)paren
suffix:semicolon
id|bzero
c_func
(paren
id|PortP-&gt;TxRingBuffer
comma
id|p-&gt;RIOBufferSize
)paren
suffix:semicolon
)brace
id|PortP-&gt;TxBufferOut
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;TxBufferIn
op_assign
l_int|0
suffix:semicolon
id|PortP-&gt;Debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;** LastRxTgl stores the state of the rx toggle bit for this&n;&t;&t;** port, to be compared with the state of the next pkt received.&n;&t;&t;** If the same, we have received the same rx pkt from the RTA&n;&t;&t;** twice. Initialise to a value not equal to PHB_RX_TGL or 0.&n;&t;&t;*/
id|PortP-&gt;LastRxTgl
op_assign
op_complement
(paren
id|uchar
)paren
id|PHB_RX_TGL
suffix:semicolon
multiline_comment|/*&n;&t;&t;** and mark the port as usable&n;&t;&t;*/
id|PortP-&gt;Mapped
op_assign
l_int|1
suffix:semicolon
id|rio_spin_unlock_irqrestore
c_func
(paren
op_amp
id|PortP-&gt;portSem
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HostMapP-&gt;SysPort
OL
id|p-&gt;RIOFirstPortsMapped
)paren
id|p-&gt;RIOFirstPortsMapped
op_assign
id|HostMapP-&gt;SysPort
suffix:semicolon
r_if
c_cond
(paren
id|HostMapP-&gt;SysPort
OG
id|p-&gt;RIOLastPortsMapped
)paren
id|p-&gt;RIOLastPortsMapped
op_assign
id|HostMapP-&gt;SysPort
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|RIOChangeName
id|RIOChangeName
c_func
(paren
id|p
comma
id|MapP
)paren
r_struct
id|rio_info
op_star
id|p
suffix:semicolon
r_struct
id|Map
op_star
id|MapP
suffix:semicolon
(brace
r_int
id|host
suffix:semicolon
r_struct
id|Map
op_star
id|HostMapP
suffix:semicolon
r_char
op_star
id|sptr
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Change name entry on host %x, rta %x, ID %d, Sysport %d&bslash;n&quot;
comma
id|MapP-&gt;HostUniqueNum
comma
id|MapP-&gt;RtaUniqueNum
comma
id|MapP-&gt;ID
comma
(paren
r_int
)paren
id|MapP-&gt;SysPort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MapP-&gt;ID
OG
id|MAX_RUP
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Bad ID in map entry!&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|ID_NUMBER_OUT_OF_RANGE
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
id|MapP-&gt;Name
(braket
id|MAX_NAME_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|sptr
op_assign
id|MapP-&gt;Name
suffix:semicolon
r_while
c_loop
(paren
op_star
id|sptr
)paren
(brace
r_if
c_cond
(paren
op_star
id|sptr
l_char|&squot;~&squot;
)paren
(brace
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Name entry contains non-printing characters!&bslash;n&quot;
)paren
suffix:semicolon
id|p-&gt;RIOError.Error
op_assign
id|BAD_CHARACTER_IN_NAME
suffix:semicolon
r_return
id|EINVAL
suffix:semicolon
)brace
id|sptr
op_increment
suffix:semicolon
)brace
r_for
c_loop
(paren
id|host
op_assign
l_int|0
suffix:semicolon
id|host
OL
id|p-&gt;RIONumHosts
suffix:semicolon
id|host
op_increment
)paren
(brace
r_if
c_cond
(paren
id|MapP-&gt;HostUniqueNum
op_eq
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|UniqueNum
)paren
(brace
r_if
c_cond
(paren
(paren
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Flags
op_amp
id|RUN_STATE
)paren
op_ne
id|RC_RUNNING
)paren
(brace
id|p-&gt;RIOError.Error
op_assign
id|HOST_NOT_RUNNING
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MapP-&gt;ID
op_eq
l_int|0
)paren
(brace
id|CCOPY
c_func
(paren
id|MapP-&gt;Name
comma
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Name
comma
id|MAX_NAME_LEN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|HostMapP
op_assign
op_amp
id|p-&gt;RIOHosts
(braket
id|host
)braket
dot
id|Mapping
(braket
id|MapP-&gt;ID
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|HostMapP-&gt;RtaUniqueNum
op_ne
id|MapP-&gt;RtaUniqueNum
)paren
(brace
id|p-&gt;RIOError.Error
op_assign
id|RTA_NUMBER_WRONG
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
id|CCOPY
c_func
(paren
id|MapP-&gt;Name
comma
id|HostMapP-&gt;Name
comma
id|MAX_NAME_LEN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|p-&gt;RIOError.Error
op_assign
id|UNKNOWN_HOST_NUMBER
suffix:semicolon
id|rio_dprintk
(paren
id|RIO_DEBUG_TABLE
comma
l_string|&quot;Unknown host %x&bslash;n&quot;
comma
id|MapP-&gt;HostUniqueNum
)paren
suffix:semicolon
r_return
id|ENXIO
suffix:semicolon
)brace
eof
